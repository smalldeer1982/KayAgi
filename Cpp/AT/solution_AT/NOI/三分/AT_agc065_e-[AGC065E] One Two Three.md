# [AGC065E] One Two Three

## 题目描述

给定两个长度为 $N$ 的正整数序列 $A=(A_1,A_2,\dots,A_N)$ 和 $B=(B_1,B_2,\dots,B_N)$。

请你求出一个长度为 $N$ 的正整数序列 $C=(C_1,C_2,\dots,C_N)$，其中对于每个 $i$，$C_i$ 可以是 $A_i$ 或 $B_i$，使得 $C$ 的逆序对数最小。请输出这个最小的逆序对数。

对于 $T$ 组测试用例，请分别输出答案。

## 说明/提示

## 限制条件

- $1 \leq T$
- $1 \leq N \leq 5 \times 10^5$
- $1 \leq A_i, B_i \leq 3$
- 所有测试用例中 $N$ 的总和不超过 $5 \times 10^5$。

## 样例解释 1

对于第 $1$ 个测试用例，最优的 $C$ 例如 $C=(2,3,2)$，此时逆序对数为 $1$。  
对于第 $2$ 个测试用例，最优的 $C$ 例如 $C=(1,1,1,2,3)$，此时逆序对数为 $0$。

由 ChatGPT 4.1 翻译

## 样例 #1

### 输入

```
8
3
2 1 1
3 3 2
5
2 1 3 2 2
1 2 1 2 3
8
2 1 3 3 3 1 2 2
1 2 3 1 2 1 3 2
10
1 3 2 1 1 3 2 2 2 2
2 3 1 1 1 1 3 1 3 3
12
2 1 1 3 3 1 3 3 2 2 2 1
3 1 1 3 3 1 3 2 3 2 1 2
15
1 3 1 3 3 2 2 1 2 3 3 3 1 1 3
3 3 3 2 3 2 1 3 2 1 2 2 3 3 3
18
3 1 1 3 3 2 1 1 2 3 2 1 3 3 3 2 2 3
1 1 3 2 1 3 1 2 1 2 3 2 2 1 3 1 3 3
20
2 2 3 1 1 3 2 3 3 1 3 1 2 1 2 2 1 2 3 2
1 1 1 3 3 1 1 3 2 2 1 1 1 1 1 2 2 2 2 1```

### 输出

```
1
0
6
6
20
9
5
17```

# 题解

## 作者：ケロシ (赞：6)

参考了[官方题解](https://atcoder.jp/contests/agc065/editorial/8017)。

首先可以把 $A_i$ 和 $B_i$ 看成一对 $(A_i,B_i)$，这样对于非固定的位只有三种情况：$(1,2),(1,3),(2,3)$。

观察最优解中同一种数对有什么性质，不难发现在最优解中，对于同一种数对，例如 $(1,2)$，存在一个分割点 $x$，使得 $i\le x$ 的都取到 $1$，$i>x$ 都取到 $2$，否则就会产生同种数对的逆序对，交换后明显更优。

同样的，设 $(1,3)$ 分割点为 $y$，$(2,3)$ 的为 $z$。

在接下来的求解中，只需考虑三个分割点的位置即可。

为了方便后续计算，需要定义一些函数：

1. $c(l,r,a,b)$ 表示区间 $[l,r]$ 中为 $(a,b)$ 的数对。
2. $r(l,r,a_l,b_l,a_r,b_r)$ 表示区间 $[l,r]$ 中，$i<j$ 且 $(A_i,B_i)=(a_l,b_l)$ 且 $(A_j,B_j)=(a_r,b_r)$ 的对数。
3. $R_x$ 为 $x$ 作为 $(1,2)$ 分割点时，
            与固定数对 $(1,1),(2,2),(3,3)$ 产生的逆序对数，
            $R_y$ 与 $R_z$ 同理。

对于一种 $x,y,z$，考虑如何求解其逆序对数。

首先，其与固定的数对的贡献即为 $R_x+R_y+R_z$。

不难想到直接枚举 $(1,2),(1,3),(2,3)$ 三种数对相互的贡献。

例如 $(1,2)$ 在 $(1,3)$ 前，那么前者中的 $2$ 与后者的 $1$ 产生了逆序对贡献，前者在 $i>x$ 取到，后者在 $i\le y$ 取到，所以贡献即为 $r(x+1,y,1,2,1,3)$。

类似的，我们一共有：
- $R_x+R_y+R_z$
- $r(x+1,y,1,2,1,3)$
- $r(y+1,n,1,3,1,2)$
- $r(y+1,z,1,3,2,3)$
- $r(1,y,2,3,1,3)$
- $r(1,x,2,3,1,2)$
- $r(z+1,n,2,3,1,2)$
- $-r(z+1,x,2,3,1,2)$

直接枚举 $x,y,z$ 的所有大小关系。

对于 $x<y<z$，其逆序对数量为以下每个情况之和：

- $R_x+R_y+R_z$
- $r(x+1,y,1,2,1,3)$
- $r(y+1,n,1,3,1,2)$
- $r(y+1,z,1,3,2,3)$
- $r(1,y,2,3,1,3)$
- $r(1,x,2,3,1,2)$
- $r(z+1,n,2,3,1,2)$

注意上面的式子，不难发现固定 $y$ 后，$x$ 与 $z$ 就无关了。

所以初步想法是枚举 $y$，通过数据结构找到最小的 $x$ 和 $z$。

上页式子中有关于两个分割点的，比如 $r(x+1,y,1,2,1,3)$，考虑将其拆解：

$$
        \begin{aligned}
        &r(x+1,y,1,2,1,3) \\
        =&r(1,y,1,2,1,3)-r(1,x,1,2,1,3)-c(1,x,1,2)\cdot c(x+1,y,1,3)\\
        =&r(1,y,1,2,1,3)-r(1,x,1,2,1,3)+c(1,x,1,2)\cdot c(1,x,1,3)\\
        &-c(1,x,1,2)\cdot c(1,y,1,3)\\
        \end{aligned}
$$

对于上面拆解后的公式，是一个漂亮的 $f(x)+g(y)+p(x)q(y)$ 形式。

这里可以使用**斜率优化**，可以做到 $O(N)$。

还有一种方法，就是不难想到可以固定 $x$，使其变为一次函数，每次相当于加入一条直线，并查询某位置的最小值。由于插入的直线斜率 $c(1,x,1,2)$ 单调，所以直接单调栈维护凸壳即可，查询就在凸壳上二分即可（参考[	[ABC372G] Ax + By < C](https://www.luogu.com.cn/problem/AT_abc372_g)）这个方法是 $O(N \log N)$ 的，可能比斜率优化好写点。

对于 $r(y+1,z,1,3,2,3)$ 的处理同理。

再考虑 $x,y,z$ 的其它大小关系。

对于 $y<z<x$，其逆序对数：
- $R_x+R_y+R_z$
- $r(y+1,n,1,3,1,2)$
- $r(y+1,z,1,3,2,3)$
- $r(1,y,2,3,1,3)$
- $r(1,x,2,3,1,2)$
- $r(z+1,n,2,3,1,2)$
- $-r(z+1,x,2,3,1,2)$

对于 $z<x<y$，其逆序对数：
- $R_x+R_y+R_z$
- $r(x+1,y,1,2,1,3)$
- $r(y+1,n,1,3,1,2)$
- $r(1,y,2,3,1,3)$
- $r(1,x,2,3,1,2)$
- $r(z+1,n,2,3,1,2)$
- $-r(z+1,x,2,3,1,2)$

其都可以用上述的方法解决。

但是还有三种情况，比如 $x<z<y$，其逆序对数：
- $R_x+R_y+R_z$
- $r(x+1,y,1,2,1,3)$
- $r(y+1,n,1,3,1,2)$
- $r(1,y,2,3,1,3)$
- $r(1,x,2,3,1,2)$
- $r(z+1,n,2,3,1,2)$

此时，由于 $z$ 夹在了 $x$ 与 $y$ 之间，固定 $x$ 或 $y$ 后还是不可做。

考虑发掘一些关于 $z$ 的性质。
        
观察关于 $z$ 的式子，为 $R_z+r(z+1,n,2,3,1,2)$，发现其与 $x$ 和 $y$ 都无关。

继续观察 $R_z+r(z+1,n,2,3,1,2)$，
        发现其在 $(a_i,b_i)=(2,3)$ 的位置上是下凸的。

证明不难，因为 $R_z+r(z+1,n,2,3,1,2)$ 的变化量只有三种情况：$c(1,i,3,3)$，$-c(i,n,2,2)$，$-c(i,n,1,2)$，
而这些都是递增的，所以其式子下凸。

因为关于 $z$ 的式子是下凸的，所以关于最优解的分割点取值只有三种情况：
- $z$ 取到式子最小值处
- $z=x+1$
- $z=y-1$

还剩两种 $x,y,z$ 的大小关系。

对于 $y<x<z$，其逆序对数：
- $R_x+R_y+R_z$
- $r(y+1,n,1,3,1,2)$
- $r(y+1,z,1,3,2,3)$
- $r(1,y,2,3,1,3)$
- $r(1,x,2,3,1,2)$
- $r(z+1,n,2,3,1,2)$

对于 $z<y<x$，其逆序对数：
- $R_x+R_y+R_z$
- $r(y+1,n,1,3,1,2)$
- $r(1,y,2,3,1,3)$
- $r(1,x,2,3,1,2)$
- $r(z+1,n,2,3,1,2)$
- $-r(z+1,x,2,3,1,2)$

都使用上述的方法解决即可。

对于以上六种情况进行分讨即可。
        
总时间复杂度 $O(N)$ 或 $O(N \log N)$。

---


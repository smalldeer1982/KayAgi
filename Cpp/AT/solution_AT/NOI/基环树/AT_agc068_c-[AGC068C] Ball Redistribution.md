# [AGC068C] Ball Redistribution

## 题目描述

有 $N$ 个盒子，编号从 $1$ 到 $N$ ，有 $N$ 个球，编号从 $1$ 到 $N$ 。

你给 Snuke 布置了以下**程序**作为家庭作业。

- 将每个球放入他喜欢的任何盒子中。同一个盒子里可以放多个球，也可以有盒子里不放球。
- 按此顺序对 $i = 1, 2, \cdots, N$ 进行以下操作。
    - 如果盒子 $i$ 中没有球，则什么也不做。
    - 否则如果盒子 $i$ 中有球，则取出所有的球，按**任意顺序**排列。假设 $k$ 是取出的球数， $(x_1, x_2, \cdots, x_k)$ 是排成一行的球数。对于每个 $1 \leq j \leq k$ ，将球 $x_j$ 放入盒子 $x_{j+1}$ 。这里， $x_{k+1}$ 表示 $x_1$ 。所有这些将球放入盒子的操作都是同时进行的。

Snuke 说他已经完成了作业，并向你报告了最终状态。具体地说，他说操作完成后，球 $i$ 在盒子 $A_i$ 中。

你怀疑他是否正确执行了程序。请判断他报告的状态是否是程序的可能结果。

$1$ 个输入有 $T$ 个测试用例。

### 制约

- $1 \leq T \leq 250000$
- $1 \leq N \leq 250000$
- $1 \leq A_i \leq N$
- 每个测试点中所有测试用例的 $N$ 之和最多为 $250000$。
- 所有输入值均为整数。

## 样例 #1

### 输入

```
5
3
1 1 1
3
2 2 2
5
1 2 3 4 5
10
8 3 8 10 1 5 3 1 6 4
10
1 5 1 2 4 8 8 6 7 3```

### 输出

```
Yes
No
Yes
No
Yes```

# 题解

## 作者：违规用户名1425622 (赞：2)

神仙题，绝世好题。

#### 1. 简要题意

有 $n$ 个盒子和 $n$ 个球，同一个盒子里可以放多个球，也可以有盒子里没有球，你不知道一开始盒子的状态。

按顺序对 $i = 1, 2\dots n$ 进行以下操作。

如果盒子 $i$ 中有球，则取出所有的 $k$ 个球 $x_1,x_2 \dots x_k$。然后将每个 $1 \leq j \leq k$，将球 $x_j$ 放入盒子 $x_{j+1}$ 中。这里，$x_{k+1}$ 意味着 $x_1$，放入盒子的操作都是同时进行的。

给出最后球的状态，问可否成立。

#### 2. 解法

建图，从 $i$ 连一条单向边向 $a_i$。

那么我们可以得到一颗内向基环树。

容易发现一次操作就变成了删除 $i$ 的所有入边再将其连成一个环。

由于我们知道最终状态，考虑倒序处理。

1. 如果点 $n$ 在一个环中，易做。

2. 如果顶点 $n$ 不在环中，那么有某个循环对应于操作前方格 $n$ 中的小球。我们打破这个循环，从循环中的顶点向顶点 $n$ 添加边。当然盒子 $n$ 也可能是空的。

如果顶点 $n$ 存在"子节点"（即可以走到 $n$ 且不在环上的点），那么就不可能成立。

我们假设使用包含顶点 $n$ 的连通块中的环。

那么可得充分条件：

- 设 $v_1\dots v_k$ 是 $u$ 的子节点。设 $w_i$ 是以 $v_i$ 为根的子树上最大的顶点。那么，$u \lt w_i$。

实际上也可以证明这是必要条件。感性理解较为显然。证法较麻烦，可以去看其他题解。

---

## 作者：qiuzx (赞：2)

正着做比较麻烦，但由于我们已知最终局面，所以考虑倒着做这个过程。从每个 $i$ 向 $a_i$ 连边形成一个内向基环树森林，则在最后一步中，我们相当于选择了原来所有指向 $n$ 的点，将它们的出边删掉并重新连成一个环。因此倒着做的时候就需要选择一个环，将它上面的所有点都重新指向 $n$（这个环上可能有 $n$，此时就新连一个自环）。

那么为什么会出现不合法的情形呢？发现这是因为正着做的时候我们要求必须把所有指向 $n$ 的点都连成一个环，但倒着做的时候并没有。注意到如果在倒着做的时候 $n$ 存在一个入边不在环上，那么就是不合法的。我们在整个过程中需要倒序对所有数都做一遍这个过程，所以如果在某一次需要操作 $i$ 的时候 $i$ 有一个入边不在环上，就不合法了。

但操作是自己选择的，自由度很高，所以考虑寻找一些合法的比较或充分条件。手玩一下样例可以发现，如果在原图中一个点存在一棵子树中的点无法在它前面操作，那么就一定不合法。形式化地说，如果存在一条边 $v\to u$（$v$ 不在环上），使得 $v$ 的子树中所有点的编号均 $>u$，那么这个局面一定是不合法的。

除此之外好像找不到什么其它的不合法的必要条件了，所以猜测它是充分的。即如果不存在这样的一条边，那么一定是合法的。这是因为我们每次操作都可以将当前点所在的连通块的环拆了连向它。此时对于所有原来它的祖先，那条从它向上指到祖先的那条边会被断开，而其它所有的子树均没有改变。这样对于任意一个点 $u$ 来说，由于其所有儿子 $v$ 的子树中都有比 $u$ 大的点，所以在操作 $u$ 之前这条边 $v\to u$ 一定会被断开，因此在操作 $u$ 的时候它没有不在环上的入边，所以一定合法。

这样直接 dfs 判定即可，复杂度 $O(n)$。

[代码](https://atcoder.jp/contests/agc068/submissions/58285718)

---

## 作者：Petit_Souris (赞：1)

有一些零星的想法，但是不会做。

考虑倒着做所有操作，也就是 $i=n\to 1$，每次选择一个环，并把这个环拆掉，给所有环上的点向 $i$ 连一条边。注意这里如果 $i$ 有入边，那么所有入边对应的出点都得在拆开的这个环上。

尝试找点必要条件。很难发现对于一个点 $u$，如果存在一条边 $v\to u$，$v$ 不在环上，且 $v$ 子树内所有点编号都 $<u$ 就不合法。原因很简单，因为这样操作到 $u$ 的时候 $v$ 这个子树动不了。

很难发现这个条件是充分的：一种构造是每次操作拆掉当前连通块的环，发现一个点拆了环时候就断开和祖先的边了，其他的点也不会连向这个点，那么就显然合法了。

[submission](https://atcoder.jp/contests/agc068/submissions/59083662)

---


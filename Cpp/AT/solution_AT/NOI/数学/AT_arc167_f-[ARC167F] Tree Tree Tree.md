# [ARC167F] Tree Tree Tree

## 题目描述

[problemUrl]: https://atcoder.jp/contests/arc167/tasks/arc167_f

给定满足 $2\leq K\leq N$ 的整数 $N,K$。

> **问题 potato**
> 
> 有一棵有 $N$ 个顶点的有根带权树，顶点编号为 $1$ 到 $N$，顶点 $1$ 为根。
> 
> 对于 $2\leq i\leq N$，顶点 $i$ 的父亲为 $p_i\;(1\leq p_i < i)$，且 $i$ 与 $p_i$ 之间的边的权值为 $q_{i-1}$。
> 
> 其中，$q=(q_1,q_2,\dots,q_{N-1})$ 是 $(1,2,\dots,N-1)$ 的一个排列。
> 
> 这里，定义 $cost(u,v)$ 为连接顶点 $u$ 和 $v$ 的简单路径上所有边的权值的最大值。
> 
> 求 $\sum_{u=1}^{N}\ \sum_{v=u+1}^{N}\ cost(u,v)$。

- - - - - -

> **问题 tomato**
> 
> 给定满足 $1\leq a<K$ 的整数 $a$。作为“问题 potato”的 $p,q$，满足 $p_K=a$ 的方案共有 $\frac{((N-1)!)^2}{K-1}$ 种。请计算所有这些方案下“问题 potato”的答案之和，并对 $998244353$ 取模。

对于 $a=1,\dots,K-1$，请分别求出“问题 tomato”的答案。

## 说明/提示

### 限制条件

- $2\leq K\leq N\leq 10^5$
- 输入均为整数。

由 ChatGPT 4.1 翻译

## 样例 #1

### 输入

```
4 4```

### 输出

```
170
170
172```

## 样例 #2

### 输入

```
3 2```

### 输出

```
20```

## 样例 #3

### 输入

```
16 7```

### 输出

```
457991130
457991130
65525944
418314090
644126049
676086428```

# 题解

## 作者：_Diu_ (赞：3)

搬运一下官方题解。感觉很能体现多项式基本功。

> 给定两个整数 $n,k$，满足 $2\le k\le n$。
>
> 定义问题“土豆”：
>
> - 给定一棵 $n$ 个点有根树，$1$ 为根，对于 $2\le i\le n$，点 $i$ 的父亲为 $p_i(1\le p_i<i)$，连接点 $i$ 和点 $p_i$ 的边的边权为 $q_{i-1}$。其中 $(q_1,q_2,\dots,q_{n-1})$ 是 $(1,2,\dots,n-1)$ 构成的排列。
> - 定义 $cost(u,v)$ 表示点 $u$ 到 $v$ 的简单路径中的边权的最大值，要求 $\sum_{u=1}^n\sum_{v=u+1}^ncost(u,v)$。
>
> 定义问题“番茄”：
>
> - 给定一个 $a(1\le a<k)$，存在 $\dfrac{((n-1)!)^2}{k-1}$ 种不同的 $(p,q)$ 满足 $p_k=a$，求出所有满足 $p_k=a$ 的 $(p,q)$ 的问题“土豆”的答案之和，对 $998244353$ 取模。
>
> 你需要对于所有 $a\in[1,k-1]$，求出分别求出其问题“番茄”的答案。
>
> $2\le k\le n\le 10^5$。

---

先考虑对于一棵形态固定的树，对于所有不同的 $q$ 求答案。

考虑转期望，最后答案乘上 $(n-1)!$。
$$
ans=\sum_{1\le u<v\le n}\sum_{i=1}^{n-1}P(cost(u,v)\ge i)
$$
$$
=\sum_{1\le u<v\le n}\sum_{i=1}^{n-1}(1-P(cost(u,v)<i))
$$
设 $dis(u,v)$ 表示 $(u,v)$ 之间的边数，则 $P(cost(u,v)\le i)=\dfrac{i^{\underline{dis(u,v)}}}{(n-1)^{\underline{dis(u,v)}}}$。
$$
ans=(n-1)!(\binom n2(n-1)-\sum_{(u,v)}\sum_{i=1}^{n-2}\frac{i^{\underline{dis(u,v)}}}{(n-1)^{\underline{dis(u,v)}}})
$$
$$
=(n-1)!(\binom n2(n-1)-\sum_{(u,v)}\frac{(n-1)^{\underline{dis(u,v)+1}}}{(n-1)^{\underline{dis(u,v)}}(dis(u,v)+1)})
$$
$$
=(n-1)!(\binom n2(n-1)-\sum_{(u,v)}\frac{(n-1-dis(u,v))}{dis(u,v)+1})
$$
$$
=n!\sum_{(u,v)}\frac{dis(u,v)}{dis(u,v)+1}
$$
也就是说，对于一个点对 $(u,v)$，若其距离为 $j$，那么其贡献即为 $\dfrac{n!j}{j+1}$，我们需要对所得的树的情况的所有点对统计其贡献和。

考虑原问题，题目种要求钦定 $k$ 的父亲是 $a$，我们把所有点对 $(u,v)$ 分成三类分别统计答案：

- $F_{a,1}(x)$：路径 $(u,v)$ 不包含边 $(a,k)$。
- $F_{a,2}(x)$：路径 $(u,v)$ 包含边 $(a,k)$，并且点 $a$ 是 $(u,v)$ 的 `lca`。
- $F_{a,3}(x)$：路径 $(u,v)$ 包含边 $(a,k)$，并且点 $a$ 不是 $(u,v)$ 的 `lca`。

考虑怎么求。

- $F_{a,1}(x)$，枚举 `lca` $i$，统计所选路径的点集（点 $k$ 不能参与选择，但是可以作为 `lca`），对于不在路径上的点，其父亲选择没有限制，否则路径上每个点可以选择作为点 $i$ 的左侧或者右侧，有两种方案。但是左右可以互换，因此最后乘以 $\frac 12$。
  $$
  F_{a,1}(x)=\frac 12\sum_{i=1}^n(\prod_{2\le j\le i,j\not=k}j-1)(\prod_{i<j\le n,j\not=k}j-1+2x)
  $$
  注意到常数项最终对答案贡献为 $0$，因此它是啥我们也不太需要在乎。

  上面的式子与 $a$ 无关，可以通过分治 NTT $O(n\log^2 n)$ 求出。

- $F_{a,2}(x)$，枚举每个点是否在路径中，对于 $a<i<k$，需要要求与 $k$ 异侧，只有一种方案，对于 $i\ge k$，可以选择与 $k$ 同侧或异侧。
  $$
  F_{a,2}(x)=(\prod_{1<i\le a}i-1)(\prod_{a<i<k}i-1+x)x(\prod_{k<i\le n}i-1+2x)
  $$

- $F_{a,3}(x)$，枚举每个点是否在路径中，其中点 $k$ 没得选，$a<i<k$ 的点要求和 $a$ 异侧。其他随意。
  $$
  F_{a,3}(x)=\sum_{i=1}^{a-1}(\prod_{1<j\le i}j-1)(\prod_{i<j<a}j-1+2x)x(\prod_{a<j<k}j-1+x)x(\prod_{k<j\le n}j-1+2x)
  $$

上面的式子都是可以分治求的。如何快速求答案呢，我们定义辅助多项式：
$$
B(x)=\sum_{i=1}^{n-1}\frac{n!i}{i+1}x^{n-1-i}
$$
那么最终对于 $a$ 的答案就是 $[x^{n-1}](F_{a,1}+F_{a,2}+F_{a,3})B$，这样子就可以分治了，这个分治实质上是通过限制区间内待乘的多项式的次数使得只需要保留其中一些项。

简单解释一下如何求 $[x^{n-1}]F_{a,3}B$。定义：
$$
X(l,r)=\prod_{i=l}^{r-1}\max(i,1)
$$
$$
Y(l,r)=\prod_{i=l}^{r-1}(i+2x)
$$
$$
Z(l,r)=\prod_{i=l}^{r-1}(i+x)
$$
$$
W(l,r)=\sum_{j=l+1}^rX(l,j)Y(j,r)
$$
$$
dp1(l,r)=B(x)x^2X(0,l)Z(r,k-1)Y(k,n)
$$
$$
dp2(l,r)=B(x)x^2W(0,l)Z(r,k-1)Y(k,n)
$$
找到一个 $m=\lfloor\frac{l+r}2\rfloor$，然后分治下去：
$$
dp1(l,m)=dp1(l,r)Z(m,r
$$
$$
dp1(m,r)=dp1(l,r)X(l,m)
$$
$$
dp2(l,m)=dp2(l,r)Z(m,r)
$$
$$
dp2(m,r)=dp2(l,r)Y(l,m)+dp1(l,r)W(l,m)
$$
初始 $dp1(0,k-1),dp2(0,k-1)$ 处理出来，递归到区间 $(l,r)$ 时仅保留最大的 $(r-l)$ 位。最终 $[x^{n-1}]dp2(a-1,a)$ 贡献到 $a$ 的答案。

复杂度 $O(k\log^2 k)$。

---


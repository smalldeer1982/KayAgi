# [ABC323G] Inversion of Tree

## 题目描述

给定一个长度为 $N$ 的排列 $P=(P_1,P_2,\ldots,P_N)$，其中 $P$ 是 $1$ 到 $N$ 的一个排列。

请你求出编号为 $1$ 到 $N$ 的 $N$ 个顶点的树中，满足以下条件的树的个数（对 $998244353$ 取模），对于每个 $K=0,1,\ldots,N-1$ 都要输出答案。

- 在树中，所有直接通过一条边相连的顶点对 $(u_i,v_i)\ (u_i < v_i)$ 中，满足 $P_{u_i} > P_{v_i}$ 的对数恰好为 $K$。

## 说明/提示

## 限制条件

- $2\leq N\leq 500$
- $P$ 是 $1$ 到 $N$ 的一个排列

## 样例解释 1

当 $K=0$ 时，只有一棵树满足条件，即连接顶点 $1,2$ 和顶点 $1,3$ 的树。实际上，$P_1 < P_2$，$P_1 < P_3$。

当 $K=1$ 时，有两棵树满足条件，分别是连接顶点 $1,2$ 和顶点 $2,3$ 的树，以及连接顶点 $1,3$ 和顶点 $2,3$ 的树。实际上，在连接顶点 $1,2$ 和顶点 $2,3$ 的树中，$P_1 < P_2$，$P_2 > P_3$。

由 ChatGPT 4.1 翻译

## 样例 #1

### 输入

```
3
1 3 2```

### 输出

```
1 2 0```

## 样例 #2

### 输入

```
10
3 1 4 10 8 6 9 2 7 5```

### 输出

```
294448 2989776 12112684 25422152 30002820 20184912 7484084 1397576 108908 2640```

# 题解

## 作者：一只绝帆 (赞：10)

upd on 2024.4.19：修了几处笔误。

线性代数。

为什么要学这个？都是矩阵树惹的祸。

本篇同时作为 ABC323G 的题解。

> 注：由于本篇写就的时候题解区只有一篇高深莫测极其简短的题解，看了半天没看懂又跑去学特征多项式，结果特征多项式题解也看了好久才看懂，所以笔者决定整理一篇详细易懂的题解。

## 特征值和特征向量

设 $V$ 是 $F$ 上的线性空间，$T$ 是 $V$ 上的线性变换。若存在 $F$ 中的 $\lambda$ 与 $V$ 中的 **非零向量** $\xi$，使得：

$$T\xi=\lambda\xi$$
则称 $\lambda$ 为 $T$ 的一个 **特征值**，而 $\xi$ 为 $T$ 的 属于**特征值** $\lambda$ **的一个特征向量**。

这个定义式 $T\xi=\lambda \xi$ 告诉我们矩阵对特征向量的唯一作用就是使它缩放了倍数。

### 特征分解

如果一个 $n\times n$ 矩阵有 $n$ 个特征向量 $\xi_1,\cdots,\xi_n$（这其实与可逆、满秩是同一概念），满足两两不共线，那么可以将该矩阵分解为 $P^{-1}\Lambda P$ 的形式（常用记法是 $P\Lambda P^{-1}$），其中 $P$ 是可逆矩阵，$\Lambda$ 是对角阵。

> 对上述定理的理解：
> 
> 考虑 $A\vec a$ 时 $A$ 对 $\vec a$ 的影响，可以先将 $\vec a$ 分解为这些特征向量的线性组合（$P$），然后每个向量缩放对应的倍数（$\Lambda$），最后再将这个线性组合变换回去（$P^{-1}$），写在一起就是 $P^{-1}\Lambda P\vec a$。

用处：可以把矩阵快速幂的 $\log$ 去掉，朴实无华，但需要计算机对特征多项式求根，完全没有用，手算可能有点用。

原理：$A^2=P\Lambda P^{-1}P\Lambda P^{-1}=P\Lambda^2P^{-1}$，同理 $A^n=P\Lambda^nP^{-1}$，由于 $\Lambda$ 是对角阵（各向量线性无关），所以只需要将每个元素 $n$ 次幂即可。

或者理解成 $n$ 次缩放 $k$ 倍就是直接缩放 $k^n$ 倍。

可以用来求数列通项公式，这个就是比较偏的应用了。

## 特征多项式

相似矩阵：对可逆矩阵 $P$，$B=PAP^{-1}$ 称作 $A$ 的相似矩阵，记作 $A\sim B$。

相似矩阵的行列式不变：$|PAP^{-1}|=|P||A||P^{-1}|=|A|$。

还有一些东西不变，此处仅需要这个性质。

定义一个矩阵 $A$ 的**特征多项式**为 $|xI-A|$，此处的 $x$ 是多项式里面的变量，而不是某种系数。

顺带一提，特征多项式的所有根就是矩阵的所有特征值，理由：

$$T\xi=\lambda\xi\iff T\xi=\lambda I\xi\iff (\lambda I-T)\xi=\vec 0$$

由于 $\xi\ne\vec 0$，所以 $|\lambda I-T|=0$。

定理：相似矩阵的特征多项式不变：$|xI-A|=|xI-PAP^{-1}|$，证明：

$$\begin{aligned}&|xI-PAP^{-1}|\\=&|xI(PP^{-1})-PAP^{-1}|\\=&|PxIP^{-1}-PAP^{-1}|\\=&|P||xI-A||P^{-1}|\\=&|xI-A|\end{aligned}$$

核心是利用了 $xIP=xP=Px$，所以 $xI$ 是具有交换律的。

那这个特征多项式有啥用呢，从表面上看你很难看到它的用处，但这玩意是可以 $\Theta(n^3)$ 求的！

（极其朴素的求法显然是把 $x=0,1,\cdots,n$ 带进去求出 $n+1$ 个值然后拉格朗日插值。）

### 求解

分为两个比较独立的步骤。

- 利用初等矩阵消元为上海森堡矩阵。

根据[这篇](https://www.luogu.com.cn/article/cnuauqli)文章详细的推导，我们可以魔改高斯消元的过程使每一步操作完都与原来相似。

其实就是把原来的每个操作都多执行一次**共轭操作**：

- 将第 $i$ 行加上第 $j$ 行的 $k$ 倍后，将第 $j$ 列加上第 $i$ 列的 $-k$ 倍。
- 交换第 $i$ 行和第 $j$ 行后，交换第 $i$ 列与第 $j$ 列。

上海森堡矩阵指的是如下这种，即主对角线下方多了一条非零元素：

$$\begin{bmatrix}
a_{1,1} & a_{1,2} & a_{1,3} & a_{1,4} & a_{1,5} \\a_{2,1} & a_{2,2} & a_{2,3} & a_{2,4} & a_{2,5} \\& a_{3,2} & a_{3,3} & a_{3,4} & a_{3,5}  \\&  & a_{4,3} & a_{4,4} & a_{4,5} \\ & & & a_{5,4} & a_{5,5} \end{bmatrix}\quad$$

观察这个矩阵，你发现如果我们想消成上三角矩阵，用第 $i$ 行去消第 $j$ 行的时候第 $i$ 列就会受到污染，所以我们退而求其次使用上海森堡矩阵就可以保证消元。

- 递推计算矩阵的特征多项式。

这个递推叫做海森堡算法。

设左上角 $i\times i$ 的矩阵（显然也是一个上海森堡矩阵）的特征多项式为 $f_i(x)$，边界条件是 $f_0(x)=1$。

如果你对这个过程没有比较直观的感受（我卡了一下午/fn），那你需要回顾一下行列式的求法：

> 还记得上三角矩阵是如何求行列式的吗？
> 
> 直接把主对角线上的元素乘起来！
> 
> 如果你清晰地记得推导过程，那么这部分你就不会费劲。
> 
> 我们写出行列式的定义式：
> 
> $$\sum\limits_\sigma\sum\limits_{i=1}^n(-1)^{\tau(\sigma)}\prod\limits_{i=1}^na_{i,\sigma_i}$$
> 
> 而你发现想要保证 $\prod\limits_{i=1}^n a_{i,\sigma_i}\ne 0$，当且仅当 $\sigma_i=i$ 才行（第一列别无选择只能选第一个，然后到第二列就仍然别无选择了）。

上海森堡矩阵稍微菜一点，它可以 $\Theta(n^2)$ 求出行列式的值。

$$\begin{bmatrix} \color{magenta}\vdots&\color{magenta}\vdots&\color{magenta}\vdots&\vdots&\vdots&\vdots\\[0.5em]\color{magenta}*&\color{magenta}*&\color{magenta}*&*&*&X\\[0.5em]&\color{magenta}*&\color{magenta}*&*&*&X\\[0.5em]&&X&X&X&\color{red}*\\[0.5em]&&&\color{orange}*&*&X\\[0.5em]&&&&\color{cyan}*&X\end{bmatrix}$$

我们枚举最后一列被哪行选了，那么下面那些行就一定确定了，接下来就要解决左上角这个子问题。

（考场上把上面这个图印在脑子里。）

考虑设 $g_{i}$ 为左上角 $i\times i$ 的行列式的值。

$$g_{0}=1,g_i=\sum_{k=1}^{i} a_{k,i}g_{k-1}\prod_{j=k+1}^i(-a_{j,j-1})$$

这就可以求出行列式的值了，注意 $a_{j,j-1}$ 前面的负号，每有一个 $a_{j,j-1}$ 逆序对数量就增加 $1$。

那我们就可以得到特征多项式的递推公式了（注意新的矩阵是 $(xI-A)$）：

$$f_i(x)=(x-a_{i,i})f_{i-1}(x)-\sum_{k=1}^{i-1}a_{k,i}f_{k-1}(x)\prod_{j=k+1}^ia_{j,j-1}$$

其中第一项是因为第 $k=i$ 时 $(xI-A)_{k,i}=(x-a_{i,i})$，需要特判。

可以简化上式至：

$$f_i(x)=xf_{i-1}(x)-\sum_{k=1}^{i}a_{k,i}f_{k-1}(x)\prod_{j=k+1}^ia_{j,j-1}$$

更好写一点。

使用多项式运算就可以 $\Theta(n^3)$ 求出特征多项式。

### 应用：[\[ABC323G\] Inversion of Tree](https://www.luogu.com.cn/problem/AT_abc323_g)

> 给定一个排列 $p$，定义一棵树上的「逆序边」为 $u<v\wedge p_u>p_v$，对 $k\in[0,n-1]$ 求出逆序边数量为这些的树的数量。
> 
> $n\le 500,4\text{ seconds}$。

将非逆序边构成的 $\text{Laplacian Matrix}$ 视为 $A$，逆序边的 $\text{Laplacian Matrix} $ 视为 $B$，其实就是要求 $\forall k\in[0,n-1],[x^k]|A+xB|$。

（这个逆序边很没意思，可以任意规定每条边是否重要。）

朴素的做法是将 $x$ 赋值为 $0,1,\cdots,n$ 跑矩阵树然后得到一个系数方程，用多项式插值或者高斯消元搞一搞，$\Theta(n^4)$。

考虑到 $|A+xB|$ 长得很像特征多项式，既然那个东西可以 $\Theta(n^3)$ 求，那我们努力往上凑一凑。

我们肯定希望求出 $D=B^{-1}$ 使得 $BD=I$，那么我们就可以求出 $|A+xB|=\frac{|AD+xBD|}{|D|}=\frac{|AD+xI|}{|D|}$。

很不幸的，$B$ 不一定有逆元，典型的例子是整张图一个逆序边也没有。

我们考虑采用如下方法：

- 同时对 $A,B$ 进行消元，我们不再寻找非空的一行交换过来，而是寻找非空的一列交换过来。
- 若 $B$ 这一行已经全空（找不到合法列）则将这一整行乘上 $x$（将 $A$ 这一行复制过来，同时 $A$ 清空）然后把前面消个元接着找。
- 若已经乘过 $n$ 次以上说明答案全为 $0$。

这样只要没有返回 $0$ 那就是消元成功了。

此时就变成了 $|A'+xI|$，将 $A$ 取个反算特征多项式即可。

这也是 $\Theta(n^3)$ 求出 $|A+xB|$ 的通用方法。

[代码](https://atcoder.jp/contests/abc323/submissions/51161632)。

### 参考资料

[上海森堡矩阵快速求解行列式](https://www.cnblogs.com/Think927/p/17818662.html)

[P7776 【模板】特征多项式 题解](https://www.luogu.com.cn/problem/solution/P7776)

[特征多项式优化矩阵快速幂](https://riverhamster.gitee.io/fast-matrix-power/)

[AtCoder Beginner Contest 323G 题解](https://blog.csdn.net/weixin_44589861/article/details/133747347)

---

## 作者：Register_int (赞：5)

直接矩阵树定理，度数矩阵减去邻接矩阵再求个行列式。不过由于我们要区分逆序边，不妨为逆序边乘上个 $x$ 的系数。设非逆序边的基尔霍夫矩阵 $A$，逆序边的为 $B$，则答案为 $[x^k]\text{det}(A+xB)$。

考虑咋求这玩意。直接大力消元是 $O(n^4)$，可以考虑对 $B$ 消元消成 $\text{det}(xI-A')$ 变成求特征多项式。根据 $\text{det}(xI-A')=\text{det}(xI-PA'P^{-1})$，我们可以直接消成上三角矩阵计算。总时间复杂度 $O(n^3)$。

---

## 作者：operator_ (赞：2)

# AT_abc323_g [ABC323G] Inversion of Tree

[题目传送门](https://www.luogu.com.cn/problem/AT_abc323_g)

洛谷上好像找不到 $\det(A+Bx)$ 的板题，而本题的现有题解似乎更偏向于特征多项式的求法，而非如何转化成 $\det(Ix-A')$。本篇博客相当于对其他题解进行一个这部分的补充。

首先你得会高斯消元求行列式。考虑若 $B$ 满秩，那我们可以直接将 $B$ 消成单位矩阵（每次对 $B$ 进行变换的时候，$A$ 也要同步的做，因为 $A$ 和 $B$ 本质上是一个元素为一次多项式的矩阵），就做到了将 $\det(A+Bx)$ 变成 $\det(A'+Ix)$，将 $A$ 的所有元素取反即可完成到特征多项式的转化。

若某次消元失败，即 $B$ 的某一行全为 $0$，那么我们让 $A$ 的对应行乘上 $x$，然后把 $A$ 中的这一行移到 $B$ 的对应行内（原先 $A$ 的那一行清空），由于 $B$ 原先那一行全是 $0$，所以 $x^2$ 的系数也是 $0$，不会影响接下来的过程。而这种操作对最终答案的影响是答案多项式多乘了一个 $x$​，最后除掉就好了。

但是要注意的是如果还是消不掉，并不代表答案全是 $0$，这里给出一组 hack：

	3
	0 0 1
	1 1 0
	1 0 0
	0 1 0
	0 0 0
	0 0 0

（可以手玩一下）这是由于我们把 $A$ 的一行移到 $B$ 中时，需要把该行的前 $i-1$ 项消掉，**同时这个操作也是会同步到 $A$ 上的**，而此时的 $A$ 并没有任何性质，那么自然也就有可能会在这一行生成一个新的非零项。所以我们应该是消不掉就一直找，直到除的 $x$ 次数超过 $n$，答案才是 $0$，复杂度还是正确的。

不知道是本题的数据太弱还是矩阵树定理的性质太好，如果只找一次也能通过本题，若想测试模板建议去 [qoj59](https://qoj.ac/problem/59) 提交。

这部分的代码：

```cpp
res=1;rep(i,1,n) {
    int p=0;rep(j,i,n) if(b[i][j]()) p=j;
    while(!p) {
        delt++;rep(j,1,n) b[i][j]=a[i][j],a[i][j]=0;
        if(delt>n) {rep(i,0,n) printf("0 ");return;}
        rep(j,1,i-1) {Num v=b[i][j]/b[j][j];rep(k,1,n) a[i][k]-=v*a[j][k],b[i][k]-=v*b[j][k];}
        rep(j,i,n) if(b[i][j]()) p=j;
    }
    rep(j,1,n) swap(a[j][i],a[j][p]),swap(b[j][i],b[j][p]);if(p!=i) res*=-1;
    rep(j,1,n) if(i!=j) {Num v=b[j][i]/b[i][i];rep(k,1,n) a[j][k]-=v*a[i][k],b[j][k]-=v*b[i][k];}
}
```

---

## 作者：FstAutoMaton (赞：2)

## [[ABC323G] Inversion of Tree](https://www.luogu.com.cn/problem/AT_abc323_g)

一道线性代数大杂烩。

前置知识：[高斯消元](https://www.luogu.com.cn/problem/P3389)，[特征多项式](https://www.luogu.com.cn/problem/P7776)，[矩阵树定理](https://www.luogu.com.cn/problem/P6178)，以及一些线性代数的理论知识。

对于这种无根树的数量计数问题，不难想到可以用矩阵树定理。但问题在于这里有逆序边的数量限制。

考虑类似 [[省选联考 2020 A 卷] 作业题](https://www.luogu.com.cn/problem/P6624) 的做法，把矩阵中的元素变成多项式从而计算答案。对于一条顺序边，其在矩阵上的边权为 $1$，逆序边边权为 $x$。设构造出的矩阵为 $A$，那么有 $k$ 条逆序边的树的数量就是 $[x^k] |A|$。但这道题不像 作业题 一样要对 $x^2$ 取模，所以复杂度是 $\operatorname{O}(n^4)$ 的，无法通过。

考虑转换一下思想，设顺序边组成矩阵为 $A$，逆序边组成的矩阵为 $B$，那么 $k$ 条逆序边的无根树的方案数就是 $[x^k]|A+xB|$（实际上这一句是废话），考虑有没有什么办法快速计算这个东西。

设 $I$ 为单位矩阵，考虑一下两种特殊情况：

### 1. $B=I$

那么 $|A+xB|=|A+xI|$，不难发现这个式子就是特征多项式（$|xI-A|$），于是此时答案就是 $-A$ 的特征多项式。

### 2. 存在 $B'$ 满足 $B'B=BB'=I$（即 $B$ 有逆元）

那么 $|A+xB|=\frac{|AB'+xBB'|}{|B'|}=\frac{|xI-(-AB')|}{|B'|}$，直接矩阵求逆一下就行了。

--------------

通过前面两个例子的启发，我们可以发现只要把 $B$ 转化为 $I$ 那么就是好做的。但问题在于 $B$ 不一定有逆元。

我们不妨回忆矩阵求逆的过程，之所以 $B$ 没有逆元是因为某一行没有主元。而在这道题中，**我们除了 $B$ 外还有一个矩阵 $A$**，所以不妨通过 $A$ 来让 $B$ 拥有主元。

首先，在高斯消元时，如果 $B$ 的第 $i$ 行没有主元时可以直接把第 $i$ **列** 全部变成 $0$。不难发现，**这时候我们将 $A$ 的第 $i$ 列乘上 $x$ 就相当于交换 $A$，$B$ 的第 $i$ 列**，这样就可以让 $B$ 的第 $i$ 行存在主元了。

当然，可能会出现操作后 $B$ 的第 $i$ 行也没有主元的情况，考虑这时候的状况。这说明 $A$，$B$ 的第 $i$ 列都为空，那么 $|A+xB|$ 必然为 $0$, 所以此时特征多项式就是 $0$，可以特判掉。

通过这个操作，我们可以保证 $B$ 能够变成 $I$，那么套一个特征多项式板子就好了。

时间复杂度 $\operatorname{O}(n^3)$。

[code](https://atcoder.jp/contests/abc323/submissions/64358657)

---

## 作者：Otomachi_Una_ (赞：1)

感觉逆序对的性质不太好用。我们假装他是个图，有些边是关键的。问每个 $k=0,1,2,\dots,n-1$ 有多少个树恰好用到 $k$ 个关键边。

我们把非关键边视作 $1$，关键边视作 $x$。就可以跑矩阵树。最后得到一个长为 $n-1$ 的多项式就是答案。

普通的方法是带入 $n$ 个 $x$，然后拉格朗日插值还原多项式。时间复杂度 $O(n^4)$。

考虑优化。我们简化为 $\det(Ax+B)$ 的模型。我们容易通过行列式变换让 $A$ 变为 $I$。我们只需要计算形如 $\det(Ix-B)$ 这样的东西。

这个东西其实就是特征多项式。

我们学习一下特征多项式。首先为什么叫特征多项式？因为我们随便找个有逆元的方阵 $X$ 都有 $A$ 和 $X^{-1}AX$ 特征多项式相等。

证明：

$$
\begin{aligned}\det(Ix-X^{-1}AX)&=\det(X^{-1}IxX-X^{-1}AX)\\&=\det(X^{-1}(Ix-A)X)\\&=\det(X^{-1})\det(X)\det(Ix-A)\\&=\det(Ix-A)\end{aligned}
$$

然后我们可以利用构造一些 $X$ 来变换 $A$，这样变换时特征多项式也相等。

- 构造 $X$ 为 $I$ 交换第 $i$ 行 $j$ 列。有 $X^{-1}=X$，$XAX^{-1}$ 为交换 $A$ 第 $i,j$ 行、$i,j$ 列。
- 构造 $X$ 为 $I$，第 $i$ 行 $j$ 列加上 $k$。有 $X^{-1}$ 为 $I$，第 $i$ 行 $j$ 列减去 $k$。$XAX^{-1}$ 为给 $i$ 行加上 $j$ 行 $\times k$，给第 $j$ 列加上 $i$ 列 $\times k$。

这两个变换不足以把 $A$ 削成上三角。但是足以把 $A$ 削成上海森堡。上海森堡指次对角线下都是 $0$。

上海森堡有 $O(n^3)$ 的求特征多项式方法。具体是，$f_{i,*}$ 表示只考虑前 $i$ 行 $i$ 列的多项式。考虑转移。

- 选择 $(i,i)$ 的。$f_{i,*}\leftarrow A(i,i)f_{i-1,*}$；
- 选择次对角线的 $(j+1,j),(j+2,j+1),\dots,(i,i-1),(j,i)$。$f_{i,*}\leftarrow A_{j+1,j}\times\dots\times A_{i,i-1}\times A_{j,i}\times f_{j-1,*}$；

时间复杂度：$O(n^3)$。

---


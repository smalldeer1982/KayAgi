# [ARC133F] Random Transition

## 题目描述

给定一个整数 $N$。

すぬけくん将进行如下操作：

- 准备一个变量 $x$，并用 $0$ 到 $N$ 之间随机选取的整数进行初始化。对于每个 $0 \leq i \leq N$，$x=i$ 的初始化概率为 $A_i/10^9$。
- 接下来重复 $K$ 次如下操作：
  - 以概率 $x/N$ 将 $x$ 的值减 $1$，以概率 $1-x/N$ 将 $x$ 的值加 $1$。（注意，操作后 $x$ 的值始终保证在 $0$ 到 $N$ 之间）

对于每个 $i=0,1,\cdots,N$，请计算所有操作结束后 $x=i$ 的概率，并对 $998244353$ 取模。

概率 $\pmod{998244353}$ 的定义：可以证明，所求概率一定是有理数。此外，在本题的约束下，将其表示为最简分数 $\frac{P}{Q}$ 时，$Q \not\equiv 0 \pmod{998244353}$ 也成立。因此，存在唯一的整数 $R$ 满足 $R \times Q \equiv P \pmod{998244353},\ 0 \leq R < 998244353$。请输出这个 $R$。

## 说明/提示

## 限制条件

- $1 \leq N \leq 100000$
- $0 \leq A_i$
- $\sum_{0 \leq i \leq N}A_i = 10^9$
- $1 \leq K \leq 10^9$
- 输入的所有值均为整数

## 样例解释 1

最初必定初始化为 $x=1$。之后的操作中，以 $1/2$ 的概率将 $x$ 的值减 $1$，以 $1/2$ 的概率将 $x$ 的值加 $1$。最终 $x=0,1,2$ 的概率分别为 $1/2,0,1/2$。

由 ChatGPT 4.1 翻译

## 样例 #1

### 输入

```
2 1
0 1000000000 0```

### 输出

```
499122177 0 499122177```

## 样例 #2

### 输入

```
4 2
200000000 200000000 200000000 200000000 200000000```

### 输出

```
723727156 598946612 349385524 598946612 723727156```

## 样例 #3

### 输入

```
10 100
21265166 263511538 35931763 26849698 108140810 134702248 36774526 147099145 58335759 4118743 163270604```

### 输出

```
505314898 24510700 872096939 107940764 808162829 831195162 314651262 535843032 665830283 627881537 696038713```

# 题解

## 作者：Argon_Cube (赞：6)

萌新第一道独立做出的问号题，纪念一下。虽然是个不用动脑子的题。

给题解区补充一个对角化做法。

----

接下来行、列、特征值的标号为 $0\sim n$。

这个题面一看显然就是对角化，所以直接把转移矩阵搞出来：$A_{i+1,i}=1-\frac in,A_{i,i+1}=\frac {i+1}n$，那么我们显然是不会手算特征值的，随便找一个找一个特征值计算器可以得到第 $i$ 个特征值是 $\lambda_i=1-2\frac in$。

发现特征向量就没有很好的规律了，除了两列二项式系数什么都观察不到。发现矩阵非常稀疏，所以直接列出关于特征向量的方程，得到第 $m$ 个特征向量满足

$$(n-2m)f_{m,i}=(n-(i-1))f_{m,i-1}+(i+1)f_{m,i+1}$$

这是一个非常标准的整式递推的形式，写成幂级数的形式可以得到

$$(2m+nx-n)F_m=(x^2-1)F_m'$$

简单分离变量即可解出这个微分方程：

$$
\begin{aligned}
&\frac{F_m'}{F_m}=\frac{2m+nx-n}{x^2-1}\\
\implies&\ln F_m=(n-m)\ln(x+1)+m\ln(x-1)\\
\implies&F_m=(1+x)^{n-m}(1-x)^m
\end{aligned}
$$

这样就能将 $A$ 分解成 $XDX^{-1}$ 的形式了，$D$ 的对角线上是所有的特征值，$X$ 的第 $m$ 列则是对应 $\lambda_m$ 的特征向量 $F_m$。

现在需要计算 $\mathbf w=X\mathbf v$，直接将 $F_m$ 带入就得到

$$W(x)=(1+x)^nV\left(\frac{1-x}{1+x}\right)$$

计算 $\mathbf v=X^{-1}\mathbf w$ 相当于知 $W$ 求 $V$：

$$2^{-n}(1+x)^{n}W\left(\frac{1-x}{1+x}\right)=V(x)$$

计算 $V\left(\dfrac{1-x}{1+x}\right)$ 可以使用[这个方法](https://www.luogu.com/article/zg0ojg1g)。这样就做完了。

---

## 作者：冰雾 (赞：5)

目前我知道的有对角化和组合意义两种做法，但本蒟蒻还没学对角化，所以写一篇组合意义的做法。

暴力推导，可能较麻烦。

题目的 $\frac{x}{N}$ 和 $1-\frac{x}{N}$ 难以直接用 GF 风格描述，考虑转化。

将题目转化为有 $N$ 个硬币，初始时有 $i$ 个正面朝上的概率为 $p_i$。

每次操作会随机等概率选择一个将其翻转，最后求正面朝上硬币的期望数量。

不难发现满足要求。

而这样的好处是可以独立出贡献。

先用二元 GF 暴力写出柿子，用 $x$ 计数正面朝上的数量，用 $y$ 计数操作次数。

显然操作次数可以用 EGF 描述。

于是答案的 GF 就是

$$\frac{k!}{n^k}[y^k]\sum_{i=0}^np_i(\frac{e^y+e^{-y}}{2}x+\frac{e^y-e^{-y}}{2})^i(\frac{e^y+e^{-y}}{2}+\frac{e^y-e^{-y}}{2}x)^{n-i}$$

简单推导一下：

$$
\begin{aligned}
P(x)&=\frac{k!}{n^k}[y^k]\sum_{i=0}^np_i(\frac{e^y+e^{-y}}{2}x+\frac{e^y-e^{-y}}{2})^i(\frac{e^y+e^{-y}}{2}+\frac{e^y-e^{-y}}{2}x)^{n-i}\\
&=\frac{k!}{2^nn^k}[y^k]\sum_{i=0}^np_i(e^y(x+1)+e^{-y}(x-1))^i(e^y(1+x)+e^{-y}(1-x))^{n-i}\\
&=\frac{k!}{2^nn^k}[y^k]\sum_{A}\sum_{B}\sum_{i=0}^n\binom{i}{A}\binom{n-i}{B}e^{(2A+2B-n)y}p_i(x+1)^{A+B}(x-1)^{n-A-B}(-1)^{n-i-B}\\
&=\frac{1}{2^nn^k}\sum_{A}\sum_{B}\sum_{i=0}^n\binom{i}{A}\binom{n-i}{B}(2A+2B-n)^kp_i(x+1)^{A+B}(x-1)^{n-A-B}(-1)^{n-i-B}\\
\end{aligned}
$$

这时先观察一下，可以提出一个 $A+B$ 来，剩下的全变成系数。

也就是 $\frac{1}{2^nn^k}\sum_ic_i(x+1)^i(x-1)^{n-i}$。

其中 $c_i=(2i-n)^k\sum_{j}\sum_{A}\binom{j}{A}\binom{n-j}{i-A}(-1)^{n-j-i+A}p_j$。

尝试往范德蒙德卷积的方向靠。

变成 $c_i=(2i-n)^k(-1)^{n-i}\sum_{j}(-1)^jp_j\sum_{A}\binom{j}{A}\binom{n-j}{i-A}(-1)^{A}$。

这时已经可以看到卷积形式了，于是有

$$
c_i=(2i-n)^k(-1)^{n-i}[x^i]\sum_{j}p_j(x-1)^j(x+1)^{n-j}
$$

接下来的问题相当于快速计算 $\sum_i p_i(x-1)^i(x+1)^{n-i}$。

脑子一热可能会直接分治，做到 $O(n\log ^2n)$。

但是不用那么麻烦，令 $t=x-1$，原式变为 $\sum_ip_it^i(t+2)^{n-i}$。

用二项式定理展开就得到 $\sum_{c}\frac{2^{n-c}t^c}{(n-c)!}\sum_{i+j=c}\frac{p_i(n-i)!}{j!}$，也就是一个卷积形式。

最后只用多项式平移还原就行了，复杂度 $O(n\log n)$。

---

## 作者：Rainbow_qwq (赞：3)

问题可以转化为：$n$ 枚硬币，每次随机翻一枚，求最后正面朝上硬币个数的期望。

把这个过程看作 XOR 卷积，并且需要卷积的两个数组有特性：在 popcount 相同的位置值相同。

这样只要对这种特殊的数组能做 FWT 就做完了。

于是现在要解决如下问题：

- 数组中每个下标 popcount 相同的数的值是相同的，求出这个东西的 FWT xor 后的数组

设 $G=\text{FWT}(F)$，$f_k = \sum_{cnt(s)=k}F_s$，$g_i = \sum_{cnt(s)=i}G_s$

fwt xor 的式子是

$$G_{s} = \sum_{t} F_{t}(-1)^{cnt(t\&s)}$$

枚举多少二进制位相交得到

$$g_k = \sum_{i=0}^{n} f_i (1-x)^i(1+x)^{n-i}[x^k]$$

直接分治乘可以做到 $O(n\log^2n)$。

还可以推一下：

$$\sum_{i=0}^{n} f_i (x-1)^i((x-1)+2)^{n-i}$$

$$\sum_{i=0}^{n} \sum_{j=0}^{n-i} f_i (x-1)^{i+j}2^{n-i-j}\binom{n-i}{j}$$

对于 $k=i+j$ 求出

$$h_k = \sum_{i=0}^n f_i \binom{n-i}{k-i}$$

answer = 

$$\sum_{k=0}^n h_k2^{n-k}(x-1)^k$$

于是做到了 $O(n\log n)$。

------

另外，这种特殊 FWT 卷积无论是否进行转置做，最终式子是相同的。[link](https://www.luogu.com.cn/blog/feecle6418/zhuai-zhi-yuan-li)

---


# [AGC053E] More Peaks More Fun

## 题目描述

有 $2N$ 张卡片和 $N$ 个盒子。卡片编号为 $1$ 到 $2N$，盒子编号为 $1$ 到 $N$。每个盒子里有 $2$ 张卡片。第 $i$ 个盒子里放着编号为 $A_i$ 和 $B_i$ 的卡片。

请计算有多少种将这 $N$ 个盒子排成一行的方法，使得满足以下条件的排列方案数（对 $10^9+7$ 取模）：

- 按照从左到右的顺序依次打开盒子，并将其中的 $2$ 张卡片以任意顺序依次放到当前卡片序列的末尾，最终得到长度为 $2N$ 的卡片序列。记从左到右第 $j$ 张卡片的编号为 $P_j$。要求通过合理安排每个盒子中两张卡片的顺序，使得数列 $P_1,P_2,\ldots,P_{2N}$ 中的“峰值”个数恰好为 $N-1$。

这里，数列 $P_1,P_2,\ldots,P_{2N}$ 中的“峰值”指的是满足 $2\leq j<2N$，且 $P_{j-1}<P_j$ 且 $P_j>P_{j+1}$ 的整数 $j$。

## 说明/提示

## 限制

- $1\leq N\leq 2\times 10^5$
- $1\leq A_i,B_i\leq 2N$
- $A_1,\ldots,A_N,B_1,\ldots,B_N$ 互不相同。

## 样例解释 1

例如，将盒子 $1,2,3$ 按此顺序排列时，可以如下安排卡片顺序，使得数列 $P$ 的峰值个数为 $2$：

- 首先将盒子 $1$ 中的卡片按 $1,3$ 的顺序放置。
- 然后将盒子 $2$ 中的卡片按 $2,4$ 的顺序放到末尾。
- 最后将盒子 $3$ 中的卡片按 $6,5$ 的顺序放到末尾。

此时，数列 $P$ 为 $(1,3,2,4,6,5)$，其中 $j=2,5$ 是峰值。

由 ChatGPT 4.1 翻译

## 样例 #1

### 输入

```
3
1 3
2 4
5 6```

### 输出

```
4```

## 样例 #2

### 输入

```
6
5 8
7 2
1 3
11 6
4 12
9 10```

### 输出

```
492```

## 样例 #3

### 输入

```
10
20 15
8 5
6 7
4 9
13 1
11 14
10 17
19 12
3 16
2 18```

### 输出

```
1411200```

# 题解

## 作者：kkio (赞：4)

有翻译就不讲题意了。

首先为了方便表示，我们令第 $ i $ 个盒子的卡 $ a_i<b_i $。那么由于要有 $ n-1 $ 个峰，合法的序列一定满足这两个样子：

1. $ (ab)(ab)(ab)...(ab)(ab)(ab) $，其中每一个 $ b $ 都是一个峰。
2. $ (ab)(ab)...(ab)(ba)(ba)...(ba) $，其中中间的 $ bb $ 处有一个是峰，其他 $ b $ 都是峰。

先来考虑一下第一种情况怎么算。考虑依次插入 $ (a,b) $，那么如果一个 $ (a_i,b_i) $ 想插在 $ (a_j,b_j) $ 和 $ (a_k,b_k) $ 中间的话，就要满足 $ a_i < b_j , b_i > a_k $，我们从大到小枚举 $ b_i $，则有 $ a_i < b_i < b_j $，预处理 $ b_i > a_k , b_i < b_k $ 的个数 $ val_i $ 即可。总数就是所有 $ val_i + 1 $ 相乘，$ + 1 $ 表示放在末尾。

现在考虑第二种情况。设中间的位置为 $ (a_p,b_p)(b_{p+1},a_{p+1}) $，注意这里的 $p$ 仅代表它是排列中第几个数，不是第几个盒子的卡。那么发现一个重要的条件，**如果 $ a_{p+1} < b_p $，那么你可以翻转 $ p+1 $ 以后的 $ (a,b) $ 顺序，变成第一种情况，他们是同一个排列**。所以得到条件 $ b_p < a_{p+1} $，从而 $ b_p < b_{p+1} $ 证明了一定是右边的 $ b $ 是峰。

现在考虑确定中间的 $ (a_p,b_p)(b_{p+1},a_{p+1}) $，那么按照之前的插入规则稍微修改一下可以得出：若中间的数为 $ (a_i,b_i)(b_j,a_j) $，注意这里 $(a,b) $ 就指具体哪个盒子了，那么贡献为

$$ \prod_{b_k<b_i}{val_k} \times \prod_{b_i<b_k<b_j}{(val_k+1)} \times \prod_{b_k>b_j}(val_k+2) $$

证明和之前一样，分成不能挨着 $ (a,b)(b,a) $，能挨一个或两个分开计算。

这里其实解决方式就很明了了:先将 $ b $ 排序，计算三个个前缀积 $ pre1_i,pre2_i,pre3_i $ 分别表示 $ val_i,val_i+1,val_i+2 $ 的前缀积，再计算一个 $ sum_i $ 表示 $ \sum\limits_{j \leq i} {(pre1_{j-1} \times pre2_j^{-1})}$。对于每个 $ i $，找到最大的 $ j $ 使 $ b_j<a_i $，$ i $ 的贡献为 $ sum_j \times pre2_i \times (pre3_{2n} \times pre3_i^{-1} ) $。这个还是很好理解的。


感觉讲的很细，我的实现有点奇怪，就不放代码了。


---

## 作者：juju527 (赞：2)

### $\texttt{Solution}$

默认一对 $a_i,b_i$ 中 $a_i<b_i$，所有对按 $b_i$ 从小到大排序。

注意到 $n-1$ 个峰值的排列一定形如：
$$
\cdots(a,b)(b,a)\cdots
$$
的形式，左半边的应当满足所有 $b_i$ 为峰值，即 $b_i>a_i+1$，右半边类似，所有 $a_i$ 为峰值，满足 $a_i>b_{i+1}$。

我们试图选取一个代表元计数。

考虑在同一种二元组排列顺序中的 $(a,b)$ 最长延伸处计数，即排列确定后一个位置 $p$ 满足：

$$b_i\gt a_{i+1},\forall i\in [1,p-1]$$
$$b_p\lt a_{p+1}$$
$$a_i>b_{i+1}\forall[p+1,n)$$


---

考虑一种需要特殊处理的情况：所有对为 $(a,b)$。

我们考虑按 $b$ 从大到小**插入**排列中，由于目前插入的二元组的 $b$ 值是已在排列中的最小值，其插在任何一个位置的后面都满足该位置的 $b>a$ 限制。

考虑 $(a_i,b_i)$ 能插在哪个位置的前面，一定有 $a_j<b_i$，记 $b_j>b_i\And a_j<b_i$ 的 $j$ 的数量为 $v_i$。

那么这部分的答案为 $\prod (v_i+1)$，$+1$ 的原因是一定能插在末尾。

考虑更为一般的存在 $p$ 位置的情况，考虑确定了 $p,p+1$ 两个位置的二元组后的贡献。

记 $p$ 位置填入的二元组的 $b$ 值为 $B_1$，$p+1$ 位置为 $B_2$。

类似的，容易讨论出贡献为 $\prod_{b_i<B_1}v_i\prod_{B_1<b_i<B_2}(v_i+1)\prod_{b_i>B_2}(v_i+2)$。

使用前缀和优化，容易做到 $\widetilde O(n)$。

[code](https://atcoder.jp/contests/agc053/submissions/31786096)

---


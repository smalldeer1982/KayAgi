# [AGC053F] ESPers

## 题目描述

有 $2N+1$ 名参与者进行一个名为“多数决”的游戏。每位参与者将在两个选项中选择一个进行投票，最终投票给获得更多票数的选项的参与者将成为胜者。投票过程具体如下：

1. 如果所有人都已完成投票，则投票结束。否则，进入步骤 2。
2. 从尚未投票的参与者中随机选择 1 人进行投票，然后返回步骤 1。

在所有参与者中，有 $K$ 人是超能力者，他们在自己投票时能够知道当前每个选项的票数。因此，每位参与者的投票方式如下：

- 如果该参与者是超能力者，则会投票给当前票数较多的选项。如果两项票数相等，则随机选择一个选项投票。
- 如果该参与者不是超能力者，则随机选择一个选项投票。

X 是本场游戏的参与者之一，并且是超能力者。请计算 X 获胜的概率，并对 $10^9+7$ 取模后输出（见注释）。

## 说明/提示

### 注释

- 所求概率为有理数。设概率为分数 $\frac{y}{x}$（$x$ 和 $y$ 是互质的正整数），$x$ 与 $P=10^9+7$ 互质，因此请输出满足 $xz\equiv y\pmod{P}$ 的唯一整数 $z$，其中 $0\leq z < P$。

### 约束条件

- $1\leq N\leq 2\times 10^6$
- $1\leq K\leq 2N+1$

### 样例解释 1

X 的胜率为 $\frac{11}{12}$。

### 样例解释 2

X 的胜率为 $\frac{23}{24}$。

由 ChatGPT 4.1 翻译

## 样例 #1

### 输入

```
1 1```

### 输出

```
916666674```

## 样例 #2

### 输入

```
1 2```

### 输出

```
958333341```

## 样例 #3

### 输入

```
8 5```

### 输出

```
582281799```

## 样例 #4

### 输入

```
100 100```

### 输出

```
196654831```

## 样例 #5

### 输入

```
2000000 2000000```

### 输出

```
768385859```

# 题解

## 作者：nullqtr_pwp (赞：1)

观察题目过程可以得到一个 $n^3$ 的 dp，你发现平局的时刻是重要的。若一个特殊的人投票后的某时刻平票，那么这个人获胜的概率是 $0.5$，反之是 $1$。

所以我们只需要计算长颈鹿投票后存在某时刻平票的概率。为了方便，我们认为平票时第一个选项是“票数多的”，此时特殊的人只会投给第一个选项，容易发现这不改变平票存在的概率。这样可以用：是否投票给当前票数多的选项来刻画。即 $a_i=1$ 表示 $i$ 投给当前票数多的，反之为 $a_i=-1$。感受一下这个过程，就是两个选项一直波动，一个过程后可能位移是 $0$，不难想到括号序列。将序列 $a$ 写成一个括号序列的形式，注意到前缀和严格 $\min$ 以及后缀和严格 $\max$ 都不会被匹配。那么形态可以被刻画为：$W_0)W_1)\cdots)W_k(W_{k+1}(\cdots(W_m$。其中 $W_i$ 表示一个合法括号序列，即 $W_i$ 的总和为 $0$ 且任意前缀和非负。

枚举 $x=k,y=m-k$。即枚举中间 $W_k$ 左边有 $x$ 个 $W$，右边有 $y$ 个 $W$。通过这个形式计数，$x$ 为偶数时，最后一次平票的位置是 $W_x$ 的末尾，奇数则是 $W_{x-1}$ 的末尾。计算此时的贡献：分为有多少括号序列选出来这两个是 $x,y$，在此基础上长颈鹿在平票位置及之前的概率。第一个是 $[x^{\frac{2n+1-x-y}{2}}](C(x))^{x+y+1}$。关于 $[x^n](Catalan(x))^m$ 的计算，构造一个 $\texttt{(((A)B)C)}$ 状物的双射即可。因此 $[x^n](Catalan(x))^m=\binom{2n+m-1}{n}-\binom{2n+m-1}{n-1}$。对于第二个，左括号总数是确定的，考虑长颈鹿有贡献的概率，最终乘上方案数就好了，要求落在 $x+[2\mid x]$ 的 $W$ 之前，并且还需要不作为后面的 $($。令 $t=\frac{2n+1-x-y}{2}$，整理一下，得到答案是：$f(x,y)=(\binom{2n+1}{t}-\binom{2n+1}{t-1})\binom{t+y}{k}\frac{x+[2\mid x]}{x+y+1}\frac{t}{t+y}$。最终除以总方案数 $2^{2n+1-k}\binom{2n+1}{k}$ 就是答案，这样是 $\mathcal O(n^2)$ 的。

接下来固定 $s=x+y$。我们需要计算所有 $x+y=s$ 的 $\binom{\frac{2n+1-s}{2}+y}{k}(x+[2\mid x])\frac{1}{\frac{2n+1-s}{2}+y}$ 的和。处理 $f_i=\frac{\binom{i}{k}}{i}$ 的前缀和 $S_m$，以及 $\sum \binom{i}{k}$ 的前缀和。这样就可以 $\mathcal O(n)$ 递推过来了。

[提交记录](https://atcoder.jp/contests/agc053/submissions/64880828)

---

## 作者：huangzirui (赞：1)

转化题意：

容易发现，设 $t$ 时刻是最后一个时刻，使得 $A/B$ 投票数量相等。

在 $t$ 时刻前投票的超能力者有 $0.5$ 的概率 win，$t$ 时刻后投票的超能力者一定 win。

于是只需计数前 $t$ 时刻投票的超能力者数目。

我们用另外一个序列来帮助我们计数。

考虑序列 $a$，如果第 $i$ 个投票的投给了多数，$a_i$ 就为 $1$，否则为 $-1$。（如果二者票数一样，如果投票者不是超能力者则有一半概率为 $1$）

那么一个合法的 $a$ 序列形如：

$$
S_0,-1,S_1,-1,\cdots,-1,S_x,1,S_{x+1},1,\cdots,1,S_{x+y}
$$

其中 $S$ 是一个串，满足最长的前提下，每个前缀和都非负，且和为 $0$。

从 $a$ 序列，我们可以唯一得到 $S$。

接下来我们需要计算：

1. $x,y$ 的选择方案。
2. 选出超能力者。
3. 前 $t$ 时刻投票的超能力者数目。
4. 得到原串的概率。
5. 从原串得到 $a$ 序列的概率。

考虑到超能力者只可能对应 $1$，考虑这个序列中 $1$ 的出现次数。

容易发现出现了 $w=\dfrac{2n+1-x+y}{2}$ 个 $1$。

所以选超能力者的方案数是 $\binom{w}{k}$。

另外，考虑每个非超能力者的贡献。

如果一个非超能力者投票时，票数不同则为得到原串的概率贡献 $1/2$，否则为得到 $a$ 序列的概率贡献 $1/2$，因此这部分的贡献是：$\dfrac{1}{2^{2n+1-k}}$。

接下来考虑 $t$ 的取值。

容易发现，在 $S_x$ 之前，每两个 $-1$ 两边就平票了。

经过仔细分析，可以发现：

如果 $x$ 是偶数，那么 $t$ 就是 $S_x$ 的结尾。
否则，$t$ 是 $S_{x-1}$ 的结尾。

而它们中出现 $1$ 的期望数量就是：

$\dfrac{(x+1)(2n+1-x-y)}{(x+y+1)}$ 或者 $\dfrac{x(2n+1-x-y)}{(x+y+1)}$。

而总 $1$ 个数为 $2n+1-x+y$，因此贡献为：

$\dfrac{(x+1)(2n+1-x-y)}{(x+y+1)(2n+1-x+y)}$ 或者 $\dfrac{x(2n+1-x-y)}{(x+y+1)(2n+1-x+y)}$。

我们还需要考虑最后一项，即 $S$ 的选择方案数。

$S$ 是有强大的组合意义的，在两项 $S$ 中插入一个 $1$，易证方案数为从 $(0,0)$ 走斜线到 $(2n+1,x+y)$ 的方案数。

即 $\Large{\binom{2n+1}{\frac{2n+1-x-y}{2}}-\binom{2n+1}{\frac{2n-1-x-y}{2}}}$。

综合起来，由于为每个原串分配超能力者的概率为 $\dfrac{1}{\binom{2n+1}{k}}$，把前面全部乘起来得到：

$$
\text{let } w=\dfrac{x+y-1}{2}:
$$

$$
Ans=\sum_{x,y}\dfrac{(2n+1-x-y)\binom{\frac{2n+1-x+y}{2}}{k}}{(2n+1-x+y)\binom{2n+1}{k}2^{2n+1-k}}
(\binom{2n+1}{n-w}-\binom{2n+1}{n-w-1})
\times
\begin{cases}
\frac{x}{x+y+1}&\text{x 是奇数}\\
\frac{x+1}{x+y+1}&\text{x 是偶数}
\end{cases}
$$

我们只需枚举 $x,y$ 即可得到答案。

整理上式，其实我们只需求：

$$
\dfrac{1}{\binom{2n+1}{k}2^{2n+1-k}}\sum_{x=2t+1,y}\dfrac{x(n-w)\binom{\frac{2n+1-x+y}{2}}{k}}{(w+1)(2n+1-x+y)}
(\binom{2n+1}{n-w}-\binom{2n+1}{n-w-1})
$$

为了方便，只讨论 $x$ 为奇数的情况。

我们有 $y=2w+1-x$，带入得：

$$
\dfrac{1}{\binom{2n+1}{k}2^{2n+1-k}}\sum_{w}\dfrac{x(n-w)\binom{n+w-x+1}{k}}{(w+1)(2n+2w-2x+2)}(\binom{2n+1}{n-w}-\binom{2n+1}{n-w-1})
$$

$$
=\dfrac{1}{\binom{2n+1}{k}2^{2n+1-k}}\sum_{w}\dfrac{(n-w)}{(w+1)}(\binom{2n+1}{n-w}-\binom{2n+1}{n-w-1})\sum_{x=2t+1\leqslant 2w+1}\dfrac{x\binom{n+w-x+1}{k}}{2(n+w-x+1)}
$$

对后面一坨吸收，可以预处理后 $O(1)$ 计算，因此总复杂度 $O(n)$，可以通过此题。

整理一下，我们需要对后面这部分预处理：

$\sum_{x=2t\leqslant 2w+1}\dfrac{x\binom{n+w-x+1}{k}}{2(n+w-x+1)}=\dfrac{1}{2k}\sum_{x=2t+1\leqslant 2w+1}x\binom{n+w-x}{k-1}$

在 $k$ 固定时，我们维护：

$S1_n=\sum\limits_{i=2t+1}^n \binom{i}{k-1}$
$S2_n=\sum\limits_{i=2t+1}^n i\binom{i}{k-1}$

然后就有 $\sum_{x=2t+1\leqslant 2w+1}x\binom{n+w-x}{k-1}=(n+w)(S1_{n+w-1}-S1_{n-w-3})-(S2_{n+w-1}-S2_{n-w-3})$。

同样处理偶数情况。


---


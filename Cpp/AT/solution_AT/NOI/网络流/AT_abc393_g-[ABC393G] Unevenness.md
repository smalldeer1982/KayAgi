# [ABC393G] Unevenness

## 题目描述

[problemUrl]: https://atcoder.jp/contests/abc393/tasks/abc393_g

给定一个 $ N \times N $ 的网格。从上往下第 $ i $ 行、从左往右第 $ j $ 列的格子记为 $ (i,j) $，其中写有整数 $ A_{i,j} $。  
同时给定两个互质的正整数 $ P $ 和 $ Q $。  
你可以进行任意次数（包括零次）以下操作，但所有操作产生的总成本不得超过 $ \displaystyle \frac{P}{Q} $：

- 选择一个正实数 $ x $，并选择一个格子，将该格子中的数值增加或减少 $ x $。此操作的成本为 $ x $。

所有操作结束后，设 $ (i,j) $ 中的数值为 $ B_{i,j} $。此时定义**不均衡度** $ U $ 为相邻元素差值的绝对值之和。严格来说，$ U $ 由以下公式定义：

 $ \displaystyle U = \sum_{i=1}^N \sum_{j=1}^{N-1} |B_{i,j} - B_{i,j+1}| + \sum_{i=1}^{N-1} \sum_{j=1}^N |B_{i,j} - B_{i+1,j}| $ 

请输出通过操作使 $ U $ 最小化时的 $ U $ 值，并输出此时 $ B_{i,j} $ 的一个可能方案。

## 说明/提示

### 约束条件

- $ 2 \leq N \leq 10 $
- $ 1 \leq P \leq 10^{12} $
- $ 1 \leq Q \leq 10^{12} $
- $ \gcd(P, Q) = 1 $
- $ 0 \leq A_{i,j} \leq 10 $
- 输入中所有值均为整数

### 样例解释 1

通过以下操作可使 $ U = 24 $，这是不均衡度的最小值。此时总成本为 $ 2 + 1 = 3 $：
- 选择 $ x=2 $，将 $ (1,2) $ 中的数值减少 $ 2 $；
- 选择 $ x=1 $，将 $ (2,1) $ 中的数值增加 $ 1 $。

翻译由 DeepSeek R1 完成

## 样例 #1

### 输入

```
3 3 1
3 6 1
2 4 2
5 7 9```

### 输出

```
24.0000000000000000000
3.0000000000000000000 4.0000000000000000000 1.0000000000000000000
3.0000000000000000000 4.0000000000000000000 2.0000000000000000000
5.0000000000000000000 7.0000000000000000000 9.0000000000000000000```

## 样例 #2

### 输入

```
5 3 1
1 1 1 1 1
1 3 3 3 1
1 3 2 3 1
1 3 3 3 1
1 1 1 1 1```

### 输出

```
20.5714285714285714281
1.0000000000000000000 1.0000000000000000000 1.0000000000000000000 1.0000000000000000000 1.0000000000000000000
1.0000000000000000000 2.7142857142857142857 2.7142857142857142857 2.7142857142857142857 1.0000000000000000000
1.0000000000000000000 2.7142857142857142857 2.7142857142857142857 2.7142857142857142857 1.0000000000000000000
1.0000000000000000000 2.7142857142857142857 2.7142857142857142857 2.7142857142857142857 1.0000000000000000000
1.0000000000000000000 1.0000000000000000000 1.0000000000000000000 1.0000000000000000000 1.0000000000000000000```

## 样例 #3

### 输入

```
2 393 1
0 0
0 0```

### 输出

```
0.0000000000000000000
0.0000000000000000000 0.0000000000000000000
0.0000000000000000000 0.0000000000000000000```

## 样例 #4

### 输入

```
5 36 5
4 8 7 5 4
0 6 8 3 5
3 7 1 4 5
4 7 1 5 6
2 0 2 4 6```

### 输出

```
71.4000000000000000014
4.0000000000000000000 8.0000000000000000000 7.0000000000000000000 5.0000000000000000000 4.0000000000000000000
2.2285714285714285714 6.0000000000000000000 7.0000000000000000000 4.0000000000000000000 5.0000000000000000000
3.0000000000000000000 7.0000000000000000000 1.7428571428571428571 4.0000000000000000000 5.0000000000000000000
4.0000000000000000000 7.0000000000000000000 1.7428571428571428571 5.0000000000000000000 6.0000000000000000000
2.0000000000000000000 1.4857142857142857144 2.0000000000000000000 4.0000000000000000000 6.0000000000000000000```

## 样例 #5

### 输入

```
5 160 7
6 3 2 7 9
0 1 5 5 7
7 8 4 7 5
4 0 8 5 6
3 6 1 9 0```

### 输出

```
65.4285714285714285685
6.0000000000000000000 3.0000000000000000000 3.0000000000000000000 7.0000000000000000000 9.0000000000000000000
1.0000000000000000000 1.0000000000000000000 5.0000000000000000000 5.0000000000000000000 7.0000000000000000000
7.0000000000000000000 7.0000000000000000000 5.0000000000000000000 5.0000000000000000000 5.0000000000000000000
4.0000000000000000000 4.0000000000000000000 5.0000000000000000000 5.0000000000000000000 5.0238095238095238086
3.0000000000000000000 5.0238095238095238086 5.0000000000000000000 5.0952380952380952371 0.0000000000000000000```

## 样例 #6

### 输入

```
10 193926872645 2752096782
5 0 8 0 0 2 6 5 4 5
5 5 5 9 7 0 3 3 6 5
0 0 0 2 7 2 8 0 5 9
4 8 2 5 8 2 4 9 2 0
8 7 3 2 8 4 7 9 8 4
4 1 0 4 9 3 7 5 8 7
1 6 2 6 5 3 5 4 7 9
7 3 7 6 3 9 3 2 2 5
8 9 3 6 3 0 8 6 4 0
0 0 9 7 6 2 1 9 7 6```

### 输出

```
346.6045935084415210714
5.0000000000000000000 5.0000000000000000000 5.0943878534377365339 0.0000000000000000000 0.0000000000000000000 2.0000000000000000000 5.0314626178125788449 5.0000000000000000000 5.0000000000000000000 5.0000000000000000000
5.0000000000000000000 5.0000000000000000000 5.0000000000000000000 7.0000000000000000000 7.0000000000000000000 2.0000000000000000000 3.0000000000000000000 3.0000000000000000000 5.0000000000000000000 5.0000000000000000000
0.0000000000000000000 0.0000000000000000000 0.0000000000000000000 2.0000000000000000000 7.0000000000000000000 2.0000000000000000000 4.0000000000000000000 3.0000000000000000000 5.0000000000000000000 5.1258504712503153793
4.0000000000000000000 7.0000000000000000000 2.0000000000000000000 5.0000000000000000000 8.0000000000000000000 2.0000000000000000000 4.0000000000000000000 8.0314626178125788445 2.0000000000000000000 2.0000000000000000000
7.0314626178125788445 7.0000000000000000000 3.0000000000000000000 3.0000000000000000000 8.0000000000000000000 4.0000000000000000000 7.0000000000000000000 8.0314626178125788445 8.0000000000000000000 4.0000000000000000000
4.0000000000000000000 2.0000000000000000000 2.0000000000000000000 4.0000000000000000000 8.0000000000000000000 3.0000000000000000000 7.0000000000000000000 5.0000000000000000000 8.0000000000000000000 7.0000000000000000000
4.0000000000000000000 6.0000000000000000000 2.0000000000000000000 6.0000000000000000000 5.0000000000000000000 3.0000000000000000000 5.0000000000000000000 4.0000000000000000000 7.0000000000000000000 7.0629252356251576894
7.0000000000000000000 6.0000000000000000000 6.0000000000000000000 6.0000000000000000000 3.0000000000000000000 3.0000000000000000000 3.0000000000000000000 3.0000000000000000000 3.0000000000000000000 5.0000000000000000000
8.0000000000000000000 8.0000000000000000000 6.0000000000000000000 6.0000000000000000000 3.0000000000000000000 2.0000000000000000000 6.0000000000000000000 6.0000000000000000000 4.0000000000000000000 4.0000000000000000000
0.0000000000000000000 0.0000000000000000000 7.0629252356251576894 7.0000000000000000000 6.0000000000000000000 2.0000000000000000000 2.0000000000000000000 7.0629252356251576894 7.0000000000000000000 6.0000000000000000000```

# 题解

## 作者：DeepSkyCore (赞：1)

先写出原问题的线性规划形式：

记 $b_{i,j} = a_{i,j} + d_{i,j}$，其中 $d_{i,j}$ 是变化量，在线性规划形式中是一个变量。

记 $f_{i,j} = |b_{i,j} - b_{i,j+1}|, g_{i,j} = |b_{i,j} - b_{i+1,j}|$。

那么我们有：

$$
 \begin{aligned}
&\min. && \sum f_{i,j} + g_{i,j} \\
&\mathrm{s.t.} && \sum d_{i,j} \le \frac{P}{Q} \\ 
\end{aligned} 
$$

这不是线性规划的标准形式。为了表达 $f_{i,j}$ 和 $g_{i,j}$，可以这样转化：

$f_{i, j} = |b_{i,j} - b_{i,j+1}| = \max(b_{i,j} - b_{i,j+1}, 0) + \max(b_{i,j+1} - b_{i,j}, 0)$。

然后对于 $\max(b_{i,j} - b_{i,j+1},0)$，可以再引入一个变量 $t_{i,j}$，然后写出限制：

$$
b_{i,j} - b_{i,j+1} - t_{i,j} \le 0
$$

这样 $t_{i,j}$ 的最小值就是我们要求的 $\max$ 了。对于 $f$ 的另一部分和 $g$，也是同样的转化。

于是我们写出来了线性规划形式。官方题解告诉我们这个东西可以对偶成一个费用流问题。不过这题数据范围小，直接跑单纯形也能过，只是会比费用流慢很多。

这题的一个难点是精度要求很严格。不过这题可以用 `__float128` 冲过去，调一调 `eps` 就行。[提交记录](https://atcoder.jp/contests/abc393/submissions/63943194)

---


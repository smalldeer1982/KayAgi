# [AGC043F] Jewelry Box

## 题目描述

[problemUrl]: https://atcoder.jp/contests/agc043/tasks/agc043_f

$ 1 $ から $ N $ までの番号のついた $ N $ 軒の宝石店があります．

宝石店 $ i $ ($ 1\ \leq\ i\ \leq\ N $) では，$ K_i $ 種類の宝石が売られています． このうち，$ j $ ($ 1\ \leq\ j\ \leq\ K_i $) 種類目の宝石は，大きさが $ S_{i,j} $，値段が $ P_{i,j} $ で，在庫が $ C_{i,j} $ 個あります．

**よい** 宝石箱とは，以下の条件をすべて満たす宝石箱です．

- 宝石箱の中には，各宝石店で買った宝石が $ 1 $ 個ずつ入っている．
- 次の $ M $ 個の条件をすべて満たす．
  - $ i $ ($ 1\ \leq\ i\ \leq\ M $) 番目の条件: $ ( $宝石店 $ V_i $ で買った宝石の大きさ$ )\leq\ ( $宝石店 $ U_i $ で買った宝石の大きさ$ )+W_i $

次の $ Q $ 個の質問に答えてください． $ i $ ($ 1\ \leq\ i\ \leq\ Q $) 番目の質問では，整数 $ A_i $ が与えられるので，$ A_i $ 個のよい宝石箱を準備するとき，買う宝石の値段の合計の最小値を求めてください． ただし，$ A_i $ 個のよい宝石箱が準備できない場合はその旨を答えてください．

## 说明/提示

### 制約

- $ 1\ \leq\ N\ \leq\ 30 $
- $ 1\ \leq\ K_i\ \leq\ 30 $
- $ 1\ \leq\ S_{i,j}\ \leq\ 10^9 $
- $ 1\ \leq\ P_{i,j}\ \leq\ 30 $
- $ 1\ \leq\ C_{i,j}\ \leq\ 10^{12} $
- $ 0\ \leq\ M\ \leq\ 50 $
- $ 1\ \leq\ U_i,V_i\ \leq\ N $
- $ U_i\ \neq\ V_i $
- $ 0\ \leq\ W_i\ \leq\ 10^9 $
- $ 1\ \leq\ Q\ \leq\ 10^5 $
- $ 1\ \leq\ A_i\ \leq\ 3\ \times\ 10^{13} $
- 入力は全て整数である．

### Sample Explanation 1

宝石店 $ i $ で売られている $ j $ 種類目の宝石を宝石 $ (i,j) $ で表すことにします． 各クエリの答えは，以下のようになります． - $ A_1=1 $: 宝石 $ (1,2),(2,2),(3,1) $ を使う宝石箱を準備すると，コストが $ 1+1+1=3 $ となり，最小． - $ A_2=2 $: 宝石 $ (1,1),(2,1),(3,1) $ を使う宝石箱と，宝石 $ (1,2),(2,3),(3,2) $ を使う宝石箱を準備すると， コストが $ (10+10+1)+(1+10+10)=42 $ となり，最小． - $ A_3=3 $: $ 3 $ つの良い宝石箱を準備することはできない．

## 样例 #1

### 输入

```
3
2
1 10 1
3 1 1
3
1 10 1
2 1 1
3 10 1
2
1 1 1
3 10 1
2
1 2 0
2 3 0
3
1
2
3```

### 输出

```
3
42
-1```

## 样例 #2

### 输入

```
5
5
86849520 30 272477201869
968023357 28 539131386006
478355090 8 194500792721
298572419 6 894877901270
203794105 25 594579473837
5
730211794 22 225797976416
842538552 9 420531931830
871332982 26 81253086754
553846923 29 89734736118
731788040 13 241088716205
5
903534485 22 140045153776
187101906 8 145639722124
513502442 9 227445343895
499446330 6 719254728400
564106748 20 333423097859
5
332809289 8 640911722470
969492694 21 937931959818
207959501 11 217019915462
726936503 12 382527525674
887971218 17 552919286358
5
444983655 13 487875689585
855863581 6 625608576077
885012925 10 105520979776
980933856 1 711474069172
653022356 19 977887412815
10
1 2 231274893
2 3 829836076
3 4 745221482
4 5 935448462
5 1 819308546
3 5 815839350
5 3 513188748
3 1 968283437
2 3 202352515
4 3 292999238
10
510266667947
252899314976
510266667948
374155726828
628866122125
628866122123
1
628866122124
510266667949
30000000000000```

### 输出

```
26533866733244
13150764378752
26533866733296
19456097795056
-1
33175436167096
52
33175436167152
26533866733352
-1```

# 题解

## 作者：qiuzx (赞：7)

## 题意

有 $n$ 个商店，每个商店销售 $k_i$ 种物品，每种物品重量为 $s_{i,j}$，价格为 $p_{i,j}$，有 $c_{i,j}$ 个。一次购物会从每个商店中选择恰好一个物品，需要满足 $m$ 个限制，形如在商店 $x$ 中选择的物品重量 $\le$ 在商店 $y$ 中选择的物品重量 $+w$。$q$ 次询问 $a_i$，求能否进行 $a_i$ 次购物及最小花费。$n,k,p\le 30,q\le 10^5$。

## 思路

第一个想法就是直接建立费用流，流量增加 $1$ 就表示一次购物，但这样无法表示限制，所以需要考虑别的方法。注意到这个问题本质上是一个线性规划问题，所以我们先尝试写出线性规划的形式，再考虑怎么处理。记 $x_{i,j}$ 表示商店 $i$ 中第 $j$ 种物品选择了多少个，则需要满足 $0\le x_{i,j}\le c_{i,j}$，且 $\sum_{j\le k_i} x_{i,j}=a$，需要最小化 $\sum p_{i,j}x_{i,j}$。考虑确定了所有 $x_{i,j}$ 之后如何判定能否满足这 $m$ 个限制，显然只要对于任意一对 $(x,y)$ 存在一种安排它们选择的顺序的方式满足限制即可。而这可以看作是问一个二分图上是否有满匹配，可以想到霍尔定理。由于连边的形式是连向一段前缀，所以在按照 $s$ 大小排序之后，只需要考察所有前缀的限制，即对于一对 $(u,v)$，若 $i$ 是最大的满足 $s_{u,i}\le s_{v,j}+w$ 的 $i$，那么需要满足 $\sum_{k\le i}x_{u,k}\le \sum_{k\le j}x_{v,k}$。这样我们就写出了最原始的线性规划形式。

由于求和的项太多了，但都是前缀和，所以我们记新的 $x_{i,j}$ 表示原来的所有 $k\le j$ 的 $x_{i,k}$ 之和，那么限制变为： $0\le x_{i,j}-x_{i,j-1}\le c_{i,j}$，$x_{i,k_i}=a$，$x_{u,i}\le x_{v,j}$。而第二种限制可以写作 $x_{i,k_i}-x_{i,0}=a$。这样每个限制都只有两个变量，都是形如 $x_i-x_j\le w$ 的，而最终需要最小化的式子是 $\sum p_{i,j}(x_{i,j}-x_{i,j-1})=\sum (p_{i,j}-p_{i,j+1})x_{i,j}$，形如 $\sum c_ix_i$，这样的线性规划问题可以用费用流解决。具体地，将一个 $x_i-x_j\le w$ 的限制改写为 $\infty\max(0,x_i-x_j-w)$ 记入需要最小化的式子中。这样就转化为了 $\sum b_ix_i+\sum c_{u,v}\max(x_v-x_u-w_{u,v})$ 的形式，这是标准的费用流对偶之后的形式，其等价于要求第 $i$ 个点向外流 $b_i$ 的流量，且每条边 $(u,v)$ 流量为 $c_{u,v}$，费用为 $w_{u,v}$ 这样网络上的最小费用流。流量限制可以通过新建源汇转变为最小费用最大流，这样就解决了单组询问的问题。

但这样处理不能够支持多次询问 $a$，因为 $a$ 是作为费用出现的，所以并没有特别好的性质。这里需要一步很巧妙的转化，朴素的处理流量平衡限制的方法是添加源汇，但这里我们不添加源汇，而是利用这张网络的性质来处理掉这个问题。注意到这张网络上连出的边有形如 $(i,j)\to(i,j-1)$ 的流量无穷，费用为 $0$ 的边。而一个点 $(i,j)$ 需要流出 $p_{i,j}-p_{i,j+1}$ 的流量。这可以看作先流出 $p_{i,j}$ 的流量，再流进 $p_{i,j+1}$ 的流量。于是我们可以直接先在 $(i,j)\to (i,j-1)$ 这条边上流 $p_{i,j}$ 的流量，再加上 $(i,j-1)\to (i,j)$ 的流量为 $p_{i,j}$，费用为 $0$ 的边，表示可以退流。这么流完之后所有流量平衡都被满足了，下面只需要求最小费用循环流。这一步转化将源汇去掉了，求将最小费用最大流转化为最小费用循环流，这其实就是一个找负环的过程，所以就变得简单很多。

再进一步分析一下这张网络可以发现所有的负权边一定是那些连出的 $(i,k_i)\to (i,0)$ 的费用为 $-a$ 的边，所以若想要使得费用减少，必须增广这些边。增加 $1$ 的流量之后，还需要花费 $(i,0)\to (i,k_i)$ 所需要的最小代价把流还回来，所以我们本质上就是在不断增广，直到这个代价 $>a$ 为之。那么这个代价是什么呢？若将所有 $(i,0)$ 看作源点，所有 $(i,k_i)$ 看作汇点，那么增广 $f$ 次就是这张网络上流量为 $f$ 时的最小费用。那么每一次增广增加的代价就是费用流函数的斜率。由于费用流函数是凸的，所以先将凸包求出来之后可以直接二分斜率求解。求凸包可以使用 Primal Dual，复杂度 $O(Fn\log n)$，最大流量不超过 $nkp$，所以复杂度 $O(n^2kp\log n+q\log n)$。

[代码](https://atcoder.jp/contests/agc043/submissions/48062081)

---

## 作者：Otomachi_Una_ (赞：0)

**前置知识**：LP 费用流对偶

考虑这样的一类问题：有 $n$ 个非负整数 $x_1,x_2,\dots,x_n$。有 $m$ 个要求：$x_{u_i}\leq x_{v_i}+c_i$。其中 $c_i$ 是整数。要求最小化：$\sum b_i\times x_i$。

考虑一类最大费用可行流问题。其中要求点 $u$ 的流出-流入 = b_u。如果这个问题当中流量是无限的。我们可以写成如下形式：

最大化：$\sum f_{u,v}w_{u,v}$

s.t. $0\leq f_{u,v}$, $\forall u\in [n], \sum f_{u,v}-f_{v,u}=b_u$

进行 Linear Programming 对偶，即我们给每个点赋了个点标 $p_u$，上面的柿子被改写成：

最小化：$\sum p_i\times b_i$

s.t. $0\leq p_i$, $\forall (u,v,w)\in E, p_u-p_v\geq w$。

这个对偶问题恰好是我们所需要的。

**在本题中**，我们现解决 $q=1$ 的问题。我们先对每个商店的所有珠宝按照大小排序。并且假设 $x(i,j)$（$0\leq j\leq k_i$）表示第 $i$ 个商店前 $j$ 个珠宝的购买数量。

那么，$m$ 个条件能被泛化成 $mk$ 条形如 $x(U,p)\leq x(V,q)$ 的不等式。 

我们的目标就是最小化 $\sum (x(i,j)-x(i,j-1))\times P(i,j)=\sum (P(i,j)-P(i,j+1))\times x(i,j)$。和 LP 费用流对偶的形式恰好相符。

其中我们需要把 $x(i,0)=0,x(i,k_i)=A$ 看成两个虚拟变量。即我们其实只需把 $x(i,0)$ 看作原点 $S$，$x(i,k_i)$ 看作汇点 $T$。我们只要约束 $T-S=A$ 即可。

我们整理一下关于 $x(i,j)$ 的不等式组：

- $T-S\leq A$；
- $S-T\leq -A$；
- $x_{i,j}-x_{i,j+1}\leq 0$；
- $x_{i,j+1}-x_{i,j}\leq S_{i,j}$；
- $x_{V_i,q}-x_{U_i,p}\leq 0$ for some $(p,q)$。

最小化：$\sum (P(i,j)-P(i,j+1))\times x(i,j)$

实际上由于这个流入流出比较难受，而我们如果一开始在 $x(i,j),x(i,j+1)$ 之间连接一条容量为 $P(i,j)$ 而代价为 $0$ 的边实际上答案是相同的。

问题变成了最大循环流问题。容易解决。

现在，如果有多组询问。我们需要思考 $A$ 的变化所带来的影响。

考虑最大循环流，注意到正权边只有 $(S,T,\infty,A)$。于是说明所有的正权环都是 $T\to S$ 然后再经过这条边。

于是，我们可以 SPFA 流所有 $T\to S$ 的增广路，对询问 $A$ 直接二分斜率即可。

---


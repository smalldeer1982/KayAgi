# [ABC247Ex] Rearranging Problem

## 题目描述

[problemUrl]: https://atcoder.jp/contests/abc247/tasks/abc247_h

人 $ 1 $, 人 $ 2 $, $ \dots $, 人 $ N $ の $ N $ 人の人がいて、前から $ (1,2,\dots,N) $ の順に一列に並んでいます。人 $ i $ は色 $ c_i $ の服を着ています。  
 高橋君は任意の $ 2 $ 人 $ i,j $ を選んで人 $ i $ と人 $ j $ の位置を入れ替える操作を $ K $ 回繰り返しました。  
 $ K $ 回の操作を終了した時点で、$ 1\ \leq\ i\ \leq\ N $ を満たすすべての整数 $ i $ に対して、前から $ i $ 番目の人が着ている服の色は $ c_i $ と一致しました。  
 $ K $ 回の操作を終了した後にあり得る人の並び方は何通りありますか？ 答えを $ 998244353 $ で割ったあまりを求めてください。

## 说明/提示

### 制約

- $ 2\ \leq\ N\ \leq\ 200000 $
- $ 1\ \leq\ K\ \leq\ 10^9 $
- $ 1\ \leq\ c_i\ \leq\ N $
- 入力される値はすべて整数である。

### Sample Explanation 1

高橋君の操作、および操作後の列としてあり得るものをすべて挙げると次のようになります。 - 人 $ 1 $ と人 $ 2 $ の位置を入れ替える。操作後の並び方は $ (2,\ 1,\ 3,\ 4) $ となる。 - 人 $ 1 $ と人 $ 4 $ の位置を入れ替える。操作後の並び方は $ (4,\ 2,\ 3,\ 1) $ となる。 - 人 $ 2 $ と人 $ 4 $ の位置を入れ替える。操作後の並び方は $ (1,\ 4,\ 3,\ 2) $ となる。

### Sample Explanation 2

あり得る高橋君の操作の例を 1 つ挙げると次のようになります。 - $ 1 $ 回目の操作で人 $ 1 $ と人 $ 3 $ の位置を入れ替える。操作後の並び方は $ (3,\ 2,\ 1) $ となる。 $ 2 $ 回目の操作で人 $ 2 $ と人 $ 3 $ の位置を入れ替える。操作後の並び方は $ (2,\ 3,\ 1) $ となる。 $ 3 $ 回目の操作で人 $ 1 $ と人 $ 3 $ の位置を入れ替える。操作後の並び方は $ (2,\ 1,\ 3) $ となる。 操作の途中においては、前から $ i $ 番目の人の服の色が $ c_i $ と必ずしも一致しなくてもよいのに注意してください。

## 样例 #1

### 输入

```
4 1
1 1 2 1```

### 输出

```
3```

## 样例 #2

### 输入

```
3 3
1 1 2```

### 输出

```
1```

## 样例 #3

### 输入

```
10 4
2 7 1 8 2 8 1 8 2 8```

### 输出

```
132```

# 题解

## 作者：EuphoricStar (赞：6)

考虑我们如何判定一个排列是否能成为最终答案。连边 $i \to p_i$，设环数为 $k$，那么最少交换次数为 $n - k$。那么充要条件是，每个环所有点的 $c_i$ 相同，并且 $n - k \le K$ 且 $2 \mid (K - (n - k))$。$K$ 和 $n - k$ 奇偶性相同是因为，如果交换 $p_i, p_j$，其中 $i \ne j$，那么环数**恰好改变** $1$。这个的证明是平凡的，考虑它们原本在或者不在同一个环内即可。

也就是说现在要求出，每个环所有点的 $c_i$ 相同，共形成了 $k$ 个环的 $p_i$ 的方案数。考虑一个 $O(n^2)$ 的 dp，$f_{i, j}$ 表示，考虑了 $1 \sim i$，共形成了 $j$ 个环的方案数。转移就是讨论 $i$ 这个点是自环还是加到之前的环里面。设 $a_i = \sum\limits_{j = 1}^{i - 1} [c_j = c_i]$，于是有：

$$f_{i, j} = f_{i - 1, j - 1} + f_{i - 1, j} \times a_i$$

考虑优化。发现经过一次转移，$f_{i, j}$ 可能转移到 $f_{i + 1, j}$ 和 $f_{i + 1, j + 1}$。考虑构造多项式 $g(x) = \prod\limits_{i = 1}^n (a_i + x)$，就是要求 $g(x)$ 的第 $1 \sim n$ 次项。直接乘起来复杂度不对，考虑一个分治，分治区间 $[l, r]$ 表示计算 $\prod\limits_{i = l}^r (a_i + x)$。设 $mid = \left\lfloor\frac{l + r}{2}\right\rfloor$，把 $[l, mid]$ 和 $[mid + 1, r]$ 的结果乘起来即可。时间复杂度 $O(n \log^2 n)$。

[code](https://atcoder.jp/contests/abc247/submissions/41884276)

---

## 作者：柳易辰 (赞：1)

将 $c_i$ 相同的划分为一组。两组之间是独立的。

考虑每组内部的问题：给定排列 $1\sim m$，进行 $t$ 次交换，能得到多少个不同的排列？

这个问题不好直接处理，因为交换可以被“浪费”。不妨对所有排列统计至少要几次才能由原始排列得到该排列。**最少交换次数不超过 $t$ 的排列数量**就是我们要统计的答案。对于排列 $p$，建图 $i\to p_i$。原始排列置换环数量为 $m$，一次交换至多可以让置换环数量减一，$m$ 减去图上的置换环个数就是最少交换次数。

与置换相关，容易想到，**恰好**进行 $t$ 次交换的方案数就是**第一类斯特林数**，记作 $m\brack t$。第一类斯特林数的生成函数是 $F_m(x)=\prod_{i=0}^{m-1}(x+i)$。也就是说 ${m\brack t}=[x^t]F_m(x)$。

记 $b_i$ 表示 $i$ 在 $c$ 数组中的出现次数，容易写出全局的生成函数：$G=\prod_{b_i\geqslant1}F_{b_i}$。$[x^i]G$ 的含义是，全局中有 $i$ 个置换环的排列数量。注意到 $G$ 实际上恰好有 $n$ 个一次多项式相乘得到，用**分治乘法**可以在 $O(n\log^2n)$ 的时间内计算出 $G$。

令 $k'=\max(n-k,1)$，即可以得到的最少置换环数量。答案就是 $\sum_{i=k',i\equiv k'\bmod 2}^n[x^i]G$。

---

## 作者：Purslane (赞：0)

# Solution

考虑对排列 $p$，计算哪些 $k$ 使得 $p$ 进行 $k$ 次交换后能变为 $\{1,2,3,\cdots,n\}$。

设其逆序对数为 $\tau(p)$，显然应当有 $k \equiv \tau(p) \bmod 2$。而如果 $k$ 有解，$k+2$ 一定有解，所以我们只需要找到 $k_{\min}$ 即可。对于本题，需要满足 $k_{\min} \le k$ 且 $k_{\min} \equiv k \pmod 2$。

怎么计算 $k_{\min}$ 呢。将 $p$ 刻画为若干个置换环。每次 $\text{swap}(p_i,p_j)$，带来的影响是：

1. 如果 $i$ 和 $j$ 在同一个置换环中，会将该置换环分裂成两个；
2. 如果 $i$ 和 $j$ 不在同一个置换环中，会将两个置换环合并。

我们的目标是将置换环分裂成 $n$ 个。因此设 $p$ 具有的置换环个数为 $cnt$，$k_{\min} = n - cnt$。

本题就转化为：给定序列 $\{c\}$，问有多少个排列 $p$ 使得 $c_i = c_{p_i}$ 且 $p$ 的置换环数量 $= cnt$。

对于同一种 $c$ 内部（假设有 $d$ 个 $c$），置换环为 $cnt$ 可以直接由 $[x^{cnt}]\prod_{i=0}^{d-1}(x+i)$ 维护（第一类斯特林数）。

所以整个 $cnt$ 就可以写成 $\prod_{i=0}^{n-1} (x+i)^{\sum_{c} [d_c > i]}$。

单项式个数的和为 $\sum d_c = n$，所以可以直接分治 NTT。

复杂度 $O(n \log^2 n)$。

代码没写，因为 NOI 不考 NTT。

---


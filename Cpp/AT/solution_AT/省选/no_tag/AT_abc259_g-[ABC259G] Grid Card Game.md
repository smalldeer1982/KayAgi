# [ABC259G] Grid Card Game

## 题目描述

[problemUrl]: https://atcoder.jp/contests/abc259/tasks/abc259_g

$ H\ \times\ W $ 枚のカードが $ H $ 行 $ W $ 列のグリッド上に並んでいます。 $ 1\ \leq\ i\ \leq\ H,\ 1\ \leq\ j\ \leq\ W $ を満たす整数の組 $ (i,\ j) $ について、$ i $ 行目 $ j $ 列目にあるカードには整数 $ A_{i,\ j} $ が書かれています。

高橋君と青木君が $ 2 $ 人で協力ゲームをします。具体的には、下記の手順を行います。

- まず、高橋君が $ H $ 個の行のうちいくつか（ $ 0 $ 行でも $ H $ 行すべてでも良い）を選び、選んだ行にあるそれぞれのカードの上に赤いトークンを $ 1 $ 個ずつ置きます。
- 続いて、青木君が $ W $ 個の列のうちいくつか（ $ 0 $ 列でも $ W $ 列すべてでも良い）を選び、選んだ列にあるそれぞれのカードの上に青いトークンを $ 1 $ 個ずつ置きます。
- その後、$ 2 $ 人は以下の通りに得点を計算します。
  - もし、負の整数が書かれたカードであって上に赤いトークンと青いトークンがともに置かれているものが $ 1 $ 枚でも存在するならば、ゲームの結果は「大失敗」となり、得点は $ -10^{100} $ 点です。
  - そうでない場合、$ 2 $ 人は上にトークンが $ 1 $ 個以上置かれているカードをすべて獲得します。獲得したカードに書かれた整数の合計が得点です。

得点としてあり得る最大値を求めてください。

## 说明/提示

### 制約

- $ 1\ \leq\ H,\ W\ \leq\ 100 $
- $ -10^9\ \leq\ A_{i,\ j}\ \leq\ 10^9 $
- 入力はすべて整数

### Sample Explanation 1

高橋君が $ 2 $ 行目のみを選び青木君が $ 3 $ 列目のみを選ぶとき、 $ 2 $ 人は $ 4 $ 枚のカードを獲得し、得点は $ 6\ +\ (-2)\ +\ 1\ +\ 4\ =\ 9 $ 点となります。 これが考えられる最大値です。

## 样例 #1

### 输入

```
2 3
-9 5 1
6 -2 4```

### 输出

```
9```

## 样例 #2

### 输入

```
15 20
-14 74 -48 38 -51 43 5 37 -39 -29 80 -44 -55 59 17 89 -37 -68 38 -16
14 31 43 -73 49 -7 -65 13 -40 -45 36 88 -54 -43 99 87 -94 57 -22 31
-85 67 -46 23 95 68 55 17 -56 51 -38 64 32 -19 65 -62 76 66 -53 -16
35 -78 -41 35 -51 -85 24 -22 45 -53 82 -30 39 19 -52 -3 -11 -67 -33 71
-75 45 -80 -42 -31 94 59 -58 39 -26 -94 -60 98 -1 21 25 0 -86 37 4
-41 66 -53 -55 55 98 23 33 -3 -27 7 -53 -64 68 -33 -8 -99 -15 50 40
66 53 -65 5 -49 81 45 1 33 19 0 20 -46 -82 14 -15 -13 -65 68 -65
50 -66 63 -71 84 51 -91 45 100 76 -7 -55 45 -72 18 40 -42 73 69 -36
59 -65 -30 89 -10 43 7 72 93 -70 23 86 81 16 25 -63 73 16 34 -62
22 -88 27 -69 82 -54 -92 32 -72 -95 28 -25 28 -55 97 87 91 17 21 -95
62 39 -65 -16 -84 51 62 -44 -60 -70 8 69 -7 74 79 -12 62 -86 6 -60
-72 -6 -79 -28 39 -42 -80 -17 -95 -28 -66 66 36 86 -68 91 -23 70 58 2
-19 -20 77 0 65 -94 -30 76 55 57 -8 59 -43 -6 -15 -83 8 29 16 34
79 40 86 -92 88 -70 -94 -21 50 -3 -42 -35 -79 91 96 -87 -93 -6 46 27
-94 -49 71 37 91 47 97 1 21 32 -100 -4 -78 -47 -36 -84 -61 86 -51 -9```

### 输出

```
1743```

# 题解

## 作者：EuphoricStar (赞：4)

记 $b_i = \sum\limits_{j = 1}^m a_{i, j}, c_j = \sum\limits_{i = 1}^n a_{i, j}$。

首先考虑这样一个事情，就是对于 $b_i \le 0$ 的行有没有可能被选。如果选了它：

- 如果没有选任何列，选这一行肯定不优；
- 如果选了若干列，根据题目的要求，这若干列与这一行重叠的部分只可能是非负数。考虑看成是先选列再选行，那选这一行必然会造成非正贡献，雪上加霜。

所以我们得到只选 $b_i > 0$ 的行一定不劣。类似地，只选 $c_j > 0$ 的列也一定不劣。

这种行列网格的题，可以考虑转化成二分图一类的问题。类似 [ABC214H](https://www.luogu.com.cn/problem/AT_abc214_h) 地考虑，不妨计算最少损失（初始的答案是 $\sum\limits_{i = 1}^n b_i + \sum\limits_{j = 1}^m c_j$）。考虑转化成最小割，这样建图（用 $(u, v, x)$ 表示一条 $u \to v$，容量为 $x$ 的边）：

- 对于 $b_i > 0$ 的行，连边 $(S, i, b_i)$；
- 对于 $c_j > 0$ 的列，连边 $(j, T, c_j)$；
- 对于 $a_{i, j} \ge 0$，连边 $(i, j, a_{i, j})$；
- 对于 $a_{i, j} < 0$，连边 $(i, j, +\infty)$。

这样保证了对于任意 $S \to i \to j \to T$ 的路径：

- 要么割掉 $S \to i$ 或 $j \to T$ 的边，表示它们不同时被选；
- 要么割掉 $i \to j$ 的边，表示它们同时被选，但是因为有重叠，所以产生了 $-a_{i, j}$ 的额外负贡献；
- 如果 $a_{i, j} < 0$，那么也能保证 $i, j$ 不同时被选，因为 $i \to j$ 的边权是 $+\infty$，表示它不能被割，只能割 $S \to i$ 或 $j \to T$ 的边。

最后答案就是 $\sum\limits_{i = 1}^n b_i + \sum\limits_{j = 1}^m c_j - \text{mincut} = \sum\limits_{i = 1}^n b_i + \sum\limits_{j = 1}^m c_j - \text{maxflow}$。

因为这是二分图，所以时间复杂度是 $O(n^{2.5})$。

[code](https://atcoder.jp/contests/abc259/submissions/42003995)

---

## 作者：541forever (赞：1)

本蒟蒻在刚看到这道题时，还以为是一个可以直接拆点跑费用流的题，但发现总是很难满足一次必须选取一行或一列的约束，并且时间复杂度也不太对，直到看了官方题解，才恍然大悟。

**建模**

考虑最小割。

注意到，题目中必须一次性选完一整行或一整列，那么我们可以考虑以一整行和一整列为点。

具体建图我们先以行为例，我们考虑将整个矩阵的正点权加起来，然后将源点向每一行 $i$ 对应的点 $l_i$ 连一条容量为这一行的负点权和的绝对值的边，若将这条边割去，则表示选了这一行。同理，我们将每一列 $j$ 对应点 $c_j$ 向汇点连一条容量为这一列的负点权和的绝对值，若将这条边割去，这就表示选了这一列。

接着，我们考虑如何做到不选该行 / 列，以及满足点权为负的位置的那一行和那一列不能同选的约束。设第 $i$ 行第 $j$ 列的点权为 $a_{i,j}$，那么若 $a_{i,j}>0$，就将点 $l_i$ 向点 $c_j$ 连一条容量容量为 $a_{i,j}$ 的边，若将这条边割去，则表示没选这个点，此时，我们可以注意到每一行 $i$ 的正权点都向该行对应的点 $l_i$ 连了一条容量为点权的边，而若是将这些边割去，就意味着没选这些边，在列上也同理。

那么我们只剩最后一个约束没有满足了，那就是负数的行列不能同选。那么如何满足这个约束呢，考虑当没有该限制时一个负权点 $(i,j)$ 若是该行 $i$ 该列 $j$ 都被选了，则意味着源点连向 $l_i$ 的边和 $c_j$ 连向汇点的边都在最小割中，那也就意味着一定存在一条源点到 $c_j$ 的路径（否则就可以不割去 $c_j$ 到汇点的边），同理，也一定存在一条 $l_i$ 到汇点的路径，那么我们只要由 $c_j$ 向 $l_i$ 连一条容量为 $inf$ 的边（注意，在这里 Atcoder 的英文官方题解貌似写错了写成了 从 $c_i$ 连向 $l_j$，但代码和日文题解中并无该问题），这就保证了如果同时割去了源点连向 $l_i$ 的边和 $c_j$ 连向汇点的边也总有一条路径使得源点可以到达汇点，也就使得这两条边不能同选。

最后我们将正点权和减去最小割即可。

附上 [Andy](https://www.luogu.com.cn/user/346119) 巨佬提供的关于日文官方题解第二篇高超[建模方式](https://www.luogu.com.cn/fe/api/problem/downloadAttachment/a0nyb48g)

---


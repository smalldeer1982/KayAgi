# [ARC186D] Polish Mania

## 题目描述

[problemUrl]: https://atcoder.jp/contests/arc186/tasks/arc186_d

空でない非負整数列 $ (V_1,\ V_2,\ \dots,\ V_M) $ が **Polish** であることを、次のように再帰的に定義します。

- $ V_1 $ 個の Polish 数列 $ W_1,\ W_2,\ \dots,\ W_{V_1} $ が存在して、数列 $ (V_1),\ W_1,\ W_2,\ \dots,\ W_{V_1} $ をこの順に連結したものが数列 $ (V_1,\ V_2,\ \dots,\ V_M) $ と一致する

特に、数列 $ (0) $ は Polish です。

長さ $ N $ の非負整数列 $ (A_1,\ A_2,\ \dots,\ A_N) $ が与えられます。辞書順で $ (A_1,\ A_2,\ \dots,\ A_N) $ 以下である、長さ $ N $ の Polish 数列の数を $ 998244353 $ で割ったあまりを求めてください。

 数列の辞書順とは？数列 $ S\ =\ (S_1,S_2,\ldots,S_{|S|}) $ が数列 $ T\ =\ (T_1,T_2,\ldots,T_{|T|}) $ より**辞書順で小さい**とは、下記の 1. と 2. のどちらかが成り立つことを言います。 ここで、$ |S|,\ |T| $ はそれぞれ $ S,\ T $ の長さを表します。

1. $ |S|\ \lt\ |T| $ かつ $ (S_1,S_2,\ldots,S_{|S|})\ =\ (T_1,T_2,\ldots,T_{|S|}) $。
2. ある整数 $ 1\ \leq\ i\ \leq\ \min\lbrace\ |S|,\ |T|\ \rbrace $ が存在して、下記の $ 2 $ つがともに成り立つ。 
  - $ (S_1,S_2,\ldots,S_{i-1})\ =\ (T_1,T_2,\ldots,T_{i-1}) $
  - $ S_i $ が $ T_i $ より（数として）小さい。

## 说明/提示

### 制約

- $ 1\leq\ N\ \leq\ 3\times\ 10^5 $
- $ 0\leq\ A_i\ \lt\ N $
- 入力はすべて整数

### Sample Explanation 1

$ (1,\ 1,\ 1,\ 1,\ 1,\ 0) $ と $ (1,\ 1,\ 1,\ 2,\ 0,\ 0) $ が条件を満たします。 $ (1,\ 1,\ 1,\ 2,\ 0,\ 0) $ が Polish であることは、次のように確認できます。 - 問題文中にあるとおり、$ (0) $ は Polish である - $ (2,\ 0,\ 0) $ は、 $ (2) $ と $ 2 $ つの Polilsh 数列 $ (0) $ と $ (0) $ をこの順に連結したものと一致するため、Polish である - $ (1,\ 2,\ 0,\ 0) $ は、 $ (1) $ と $ 1 $ つの Polilsh 数列 $ (2,\ 0,\ 0) $ をこの順に連結したものと一致するため、Polish である - $ (1,\ 1,\ 2,\ 0,\ 0) $ は、 $ (1) $ と $ 1 $ つの Polilsh 数列 $ (1,\ 2,\ 0,\ 0) $ をこの順に連結したものと一致するため、Polish である - $ (1,\ 1,\ 1,\ 2,\ 0,\ 0) $ は、 $ (1) $ と $ 1 $ つの Polilsh 数列 $ (1,\ 1,\ 2,\ 0,\ 0) $ をこの順に連結したものと一致するため、Polish である

## 样例 #1

### 输入

```
6
1 1 1 2 0 0```

### 输出

```
2```

## 样例 #2

### 输入

```
11
3 3 4 4 5 5 6 6 7 7 8```

### 输出

```
13002```

## 样例 #3

### 输入

```
19
18 18 18 18 18 18 18 18 18 18 18 18 18 18 18 18 18 18 18```

### 输出

```
477638700```

## 样例 #4

### 输入

```
4
1 1 0 0```

### 输出

```
0```

# 题解

## 作者：luanyanjia (赞：1)

先说结论，一个序列合法当且仅当：

$$ \sum A_i = n - 1 $$

$$ \forall m<n,\sum\limits_{i=1}^{m} A_i \ge i $$

证明可以考虑将序列看成一棵树，第 $i$ 个点有 $A_i$ 个儿子，$A_i = 0$ 就是叶子节点。这样首先一棵树有 $n-1$ 条边，然后往上接节点的时候必须保证当前边数大于点数减一,否则下一个节点就没地方放了。

考虑对这样的序列计数，考虑转化成格路。并且要求不走过 $y = x - 1$ 这条直线（$A_n$ 一定为 $0$，直接把第 $n$ 个扔掉），直接反射容斥即可。

![](https://cdn.luogu.com.cn/upload/image_hosting/5fwgosl7.png)

如上图，红色是不能碰的直线，绿色是合法路径（其中 $x = i$ 时上升了多少就是 $a_{x+1} -  a_x$），蓝色是不合法路径，紫色是反射后的不合法路径。

对于字典序小于某个序列的限制，我们仿照数位 DP，对于  第 $i$ 位，我们枚举第 $i$ 位，计数前 $i-1$ 位达到限制，第 $i$ 位严格 $< A_i$ 的方案数。别忘了统计整个序列是否合法即全达到限制的方案。

复杂度看起来是 $O(n^2)$ 的。但是 $\sum A_i \ge n$ 时一定不合法，因此复杂度 $O(n)$。

[submission](https://atcoder.jp/contests/arc186/submissions/64168476)

---

## 作者：Petit_Souris (赞：1)

结论：一个序列合法当且仅当：

- $\sum a_i=n-1$；

- 不存在 $i\in [1,i-1]\sum\limits_{j=1}^{i} a_j\le i-1$。

第一条是显然的。第二条发现出现这样的前缀那么对应的位置就断开了，且如果满足一定合法。所以转为对这样的序列计数。

枚举一个前缀和 $a$ 相同，枚举下一位填什么。我们可以把这个计数理解为 $(0,1)$ 到 $(n,n)$ 的路径，不碰到 $y=x$ 这条直线。那么现在相当于固定了走到了某个点，求一段后缀。是个典型的反射容斥，组合数计算。

最后考虑一下复杂度，看起来是 $\mathcal O(n^2)$ 的，但是其实因为和不能超过 $n$，最后算出来还是 $\mathcal O(n)$ 的。

[submission](https://atcoder.jp/contests/arc186/submissions/59250352)

---

## 作者：xyz105 (赞：0)

$$\begin{Bmatrix}\color{red}\LARGE\bold{Solution}\\\normalsize\texttt{No.015 }\bold{AT\_arc186\_d}\end{Bmatrix}\times\footnotesize\texttt{ By Xyz105}$$


### 题目描述

**Polish** 数列的递归定义如下：
- 对于一个所有元素非负的非空数列 $(V_1,V_2,\ldots,V_M)$，如果该数列为 Polish 数列，当且仅当存在 $V_1$ 个其它的 Polish 数列 $W_1,W_2,\ldots,W_{V_1}$，满足将 $(V_1)$ 和 $W_1,W_2,\ldots,W_{V_1}$ 连接起来后得到的新数列与 $(V_1,V_2,\ldots,V_M)$ 相等。

特别地，规定 $(0)$ 是 Polish 数列。

由此可推得，$(1,0),(2,0,0),(3,0,1,0,0)$ 等都是 Polish 数列。

现给定一个长度为 $N$ 的数列 $A$（其所有元素 $(A_1,A_2,\ldots,A_N)$ 均非负），试求出长度为 $N$ 且字典序不大于 $A$ 的 Polish 数列个数。对 $998244353$ 取模。

（本翻译已提交至对应 Luogu 题目界面）


### 解题思路

**格路计数转化 + 反射容斥**。一定程度上参考了 [官方题解](https://atcoder.jp/contests/arc186/editorial/11255)。

观察数列 $A$ 如果是 Polish 的，它应该满足什么性质：
1. $\sum_{i=1}^n a_i=n-1$。套用递归定义易证。
2. 不存在 $i\isin [1,n-1]$ 使得 $\sum_{j=1}^i a_j\le i-1$。

通过后续的分析，可以发现 (2.) 这个条件实际上就是“不存在 $i\isin [1,n-1]$ 使得 $\sum_{j=1}^i a_j=i-1$”。

考虑将其转化成如下格路问题：
> 初始位置为 $(0,1)$。然后循环枚举 $i\isin [1,n]$，对于每一个 $i$，先向 $y$ 轴正方向移动 $a_i$ 格，再向 $x$ 轴正方向移动 $1$ 格。限制如下：
> 1. 最终目的地一定是 $(n,n)$。
> 2. 沿途不能经过 $(1,1),(2,2),\ldots,(n-1,n-1)$ 这些点。
> 
> （推论：点 $(n,n)$ 一定是从 $(n-1,n)$ 移动过来的，因为显然 $a_n=0$）

问题变为计算满足上述条件的路径方案数。

因为有字典序要求，所以考虑题目给定的数列 $A$ 要怎么用。假设 $B$ 是一个长度为 $N$ 且字典序不大于 $A$ 的 Polish 数列。

枚举 $i\isin [1,n]$，分别计算当 $B$ 的前缀为 $(A_1,A_2,\ldots,A_{i-1},b)$ 时满足条件的 $B$ 的个数，其中 $0\le b<A_i$。

设 $x=i,y=1+(\sum_{j=1}^{i-1}A_j)+b$，那么将 $(x,y)$ 走到 $(n,n)$ 且满足上述限制的路径数计入答案。

记 $f_{x1,y1,x2,y2}$ 为从 $(x1,y1)$ 无视限制地走到 $(x2,y2)$ 的方案数 $(x1\le x2,y1\le y2)$，那么有 $f_{x1,y1,x2,y2}=\binom{x2-x1+y2-y1}{x2-x1}$。

由 **反射容斥** 的思想可得，若考虑上述限制，则方案数为 $f_{x,y,n-1,n}-f_{y,x,n-1,n}$。

容易发现当 $i$ 递增时，$y$ 是单调不降的。因此当 $y>n$ 时退出循环即可（$x\ge y$ 的情况也要排除）。时间复杂度 $O(n)$。

最后别忘记判断 $A$ 本身是否也是 Polish 数列。


### 参考代码

[Submission on Atcoder](https://atcoder.jp/contests/arc186/submissions/59780474)。

---


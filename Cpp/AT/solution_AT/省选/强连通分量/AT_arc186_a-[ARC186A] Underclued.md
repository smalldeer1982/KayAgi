# [ARC186A] Underclued

## 题目描述

对于每个元素均为 $0$ 或 $1$ 的 $N$ 阶方阵 $A,B$，若满足以下条件，则称 $A$ 和 $B$ **相似**：

- 每一行的元素和相等。即对于任意 $i=1,\dots,N$，都有 $A_{i,1}+\dots+A_{i,N}=B_{i,1}+\dots+B_{i,N}$。
- 每一列的元素和相等。即对于任意 $j=1,\dots,N$，都有 $A_{1,j}+\dots+A_{N,j}=B_{1,j}+\dots+B_{N,j}$。

此外，对于每个元素均为 $0$ 或 $1$ 的 $N$ 阶方阵 $A$ 和整数 $i,j$（$1\leq i,j\leq N$），如果对于所有与 $A$ 相似的方阵 $B$，都有 $A_{i,j}=B_{i,j}$，则称 $A$ 的第 $i$ 行第 $j$ 列元素是**被固定的**。

请回答以下 $Q$ 个询问。

- 第 $i$ 个询问：是否存在某个 $N$ 阶 $0,1$ 方阵，使得其被固定的元素恰好有 $K_i$ 个？若存在，输出 `Yes`，否则输出 `No`。

## 说明/提示

## 限制

- $2\leq N\leq 30$
- $1\leq Q\leq N^2+1$
- $0\leq K_i\leq N^2$
- $K_i\neq K_j\ (1\leq i<j\leq Q)$
- 所有输入均为整数

## 样例解释 1

第 $1$ 个询问：例如，下面的矩阵 $X$，被固定的元素有 $0$ 个。
```
1 0 0
0 1 0
0 0 1
```
因为将列循环移位后得到的矩阵都与 $X$ 相似，且任意元素都可以是 $0$ 或 $1$，因此没有元素被固定。
```
0 0 1
1 0 0
0 1 0
```
```
0 1 0
0 0 1
1 0 0
```
第 $2$ 个询问：例如，下面的矩阵 $X$，被固定的元素有 $9$ 个。
```
0 0 1
0 1 1
1 1 1
```
因为与 $X$ 相似的矩阵只有 $X$ 本身，所有元素都被固定。

第 $3$ 个询问：不存在被固定的元素恰好为 $7$ 个的矩阵。

由 ChatGPT 4.1 翻译

## 样例 #1

### 输入

```
3 3
0
9
7```

### 输出

```
Yes
Yes
No```

## 样例 #2

### 输入

```
29 6
186
681
18
108
123
321```

### 输出

```
No
Yes
No
Yes
No
Yes```

# 题解

## 作者：Petit_Souris (赞：9)

感觉这题很难，毫无头绪。

结论 1：建立两边各 $n$ 个点的二分图，如果 $a_{i,j}=0$，$L_i$ 向 $R_j$ 连边，否则 $R_j$ 向 $L_i$。那么两个矩阵相似等价于每个点的出入度相同。

结论 2：不动点的数量等价于这张图上不在任何环上的边的数量。

结论 1 是显然的：入度就是行和，出度就是列和；结论 2 只需要把每个环倒转方向后的图都拿出来，他们和原图都相似，这时候只有非环边不变。

所以直接 dp 就行了：设 $f_{i,j,k}$ 为左部 $i$ 个点，右部 $j$ 个点，有 $k$ 条环边的方案数。转移就是枚举一个强连通分量，两侧分别有 $u,v$ 个点，那么会多出 $u\times v$ 条环边。最后从任意的 $f_{i,j,*}$
 转移到答案。时间复杂度 $\mathcal O(\frac{n^6}{w})$（bitset）。

[submission](https://atcoder.jp/contests/arc186/submissions/59251134)

---

## 作者：解方橙 (赞：7)

纪念一下第一次场切 *2500。一道很有意思的构造。

题目相当于一个 $n\times n$ 的 $0/1$ 矩阵，问是否存在一种给每行每列定一个和的方案使得恰有 $k$ 个格子被确定。

我们尝试构造一个矩阵，其中每个格子的状态为“确定”和“不确定”。发现如果 $(x_1,y_1)$ 和 $(x_2,y_2)$ 是不确定的，那 $(x_1,y_2)$ 和 $(x_2,y_1)$ 也大概率不能确定，因为我们能给出的约束只有行和列的和。既然 $(x_1,y_1)$ 和 $(x_2,y_2)$ 不能确定，那如果它们在一种情况下都为 $1$ ，而 $(x_2,y_1)$ 和 $(x_1,y_2)$ 确定为 $0$ 的情况下（上述描述中 $01$ 互换同理） ，将这四格的值 $01$ 互换一下，行和列的信息是没有改变的。

因此，如果上述断言成立，那么不能确定的格子必定等效于一个矩形。带着这个思路，我很快写出了一份代码，然后样例二的 $108$ 挂了。

这时候，因为我们在打ARC，所以观察样例，注意到 $29^2-108=733=27^2+2^2$ 。这组样例的意思是有一个 $27\times 27$ 和 $2\times 2$ 的矩形都不能确定，而剩下的位置是能确定的。这怎么做到的？

再思考一下之前的断言，我们可以发现其中的问题。如果 $(x_1,y_1)$ 和 $(x_2,y_2)$ 可能为 $0$ 或 $1$ ，但 $(x_1,y_2)$ 和 $(x_2,y_1)$ **一个确定为 $$1$$ ，一个确定为 $$0$$** 时，这四个位置是不存在互换的可能的！因此，对于 $n=29,k=108$ 这组样例，考虑如下构造方式：

$$\texttt{row:}\ \{3,3,\dots ,3,1,1\}$$
$$\texttt{colomn:}\ \{28,28,1,\dots ,1\}$$

则左下角的 $2\times 2$ 矩形和右上角的 $27\times 27$ 矩形不确定，左上的 $27\times 2$ 矩形确定为 $1$ ，右下的 $2\times 27$ 矩形确定为 $0$ 。

将上述构造推广到一般情况，可得出结论：如果一些矩形可以放入 $R\times C(1\leq R,C\leq n)$ 的矩形中，使得没有某一行或某一列同时有两个及以上这些矩形覆盖的格子，则存在一种构造方式，使得这些矩形覆盖的这些格子不能确定，剩余格子能确定。形式化地，设 $i_1,i_2,\dots i_p$ 满足 $i_1+i_2+\dots +i_p=R,R\leq n$ ，$j_i,j_2,\dots j_p$ 满足 $j_i+j_2+\dots +j_p=C,C\leq n$ ，则存在构造方案使得 $i_1\times j_1+i_2\times j_2+\dots i_p\times j_p$ 个格子不被覆盖。

记 $f_{i,j,s}$ 表示 $i\times j$ 矩形中按上述限制填入矩形使得覆盖面积为 $s$ 是否能够满足，转移枚举上一状态矩形即可。时间复杂度 $\mathcal{O}(n^6)$ 。

```
void answer(int k){
    for(int i=0;i<=n;i++) for(int j=0;j<=n;j++) if(f[i][j][n*n-k]) return Yes(),void();
    No();
}
signed main(){
    cin>>n>>q;
    for(int i=0;i<=n;i++) for(int j=0;j<=n;j++) f[i][j][0]=1;
    for(int i=1;i<=n;i++) for(int j=1;j<=n;j++) for(int k=0;k<=i*j;k++){
        if(k==i*j&&i>=2&&j>=2||k==0) f[i][j][k]=1;
        else{
            for(int x=0;x<i-1;x++) for(int y=0;y<j-1;y++)
                if((i-x)*(j-y)<=k) f[i][j][k]|=f[x][y][k-(i-x)*(j-y)];
        }
    }
    while(q--){
        int k;cin>>k;
        answer(k);
    }
}
```

---

## 作者：suzhikz (赞：5)

训练题，但是看完题解想了好久才懂，这里把我几个好久才弄懂的点再写下。

首先是第一步转换，假设第 $i$ 行的和为 $h_i$，第 $i$ 列的和为 $l_i$，每个位置 $a_{i,j}$为 $1$ 则 $h_i$ 向 $l_j$ 连有向边，否则反过来建。

这样图变成一个二分图，并且左右任意俩个点之间都有边，然后如果一条边不在任何一个环上，那么就是固定的边。

非环边难搞，我们考虑枚举环边，发现左边 $i$ 个点，右边 $j$ 个点可以构成环，那么一定会新产生 $i\times j$ 的环边，为啥呢？因为对于两个点的边，若不在环上，则我们可以通过环来变构成一个环，所以他一定在环上，与假设不符，所以所有边都在至少一个环上(这里想了好久)。

那我们要尽量让贡献独立，发现可以直接枚举点数来算，而新加的点向之前的点连边一定是不会产生新的环的，所以也不会有新的贡献，所以我们能直接 dp。

---

## 作者：D2T1 (赞：2)

一个好理解的做法。

考虑一个矩形 $x\times y(x,y\geq 2)$，显然有方法构造出对应的 $r,c$ 使得矩形中没有不动点：

- 若行数大于列数，则钦定每一行只有一个 $1$，然后任意钦定每一列的 $1$ 个数，使得每列 $1$ 的个数和等于每行 $1$ 的个数和。
- 否则同理。

那么如果将这个矩形放到 $n\times n$ 方阵的左上角，并且限制除掉这个矩形以外的位置必须全部放满 $1$，那么就找到了一个 $k=n^2-xy$ 的解。

这就是所有解了吗？并非如此。方阵中能放的矩形数量不止一个。如下图，也是可行的：

![](https://cdn.luogu.com.cn/upload/image_hosting/s8c8k9ie.png)

若将红色矩形内按照上述方法构造，将左下角全部置 $0$，右上角全部置 $1$，那么不动点就是左下、右上的两部分。

那么两个红色矩形的行列能否有交集？答案是不行。如果两个红色矩形行列有交集，那么容易找到四个点使得其中三个位于红色矩形内，那么第四个点显然不是不动点。

所以若一个 $k$ 可行，相当于能够找到若干个长宽均 $\geq 2$ 的矩形面积和为 $n^2-k$，且矩形的长宽和分别 $\leq n$。使用 bitset 优化 dp 可以做到 $O(\dfrac {n^6}{\omega})$。

---

## 作者：Celebrate (赞：1)

# 题意
定义两个 $n(n\le 30)$ 阶 $0/1$ 矩阵 $A$ 和 $B$ 是**相似**的，当且仅当二者同一行同一列和相等。如果某个矩阵的某个位置是**固定**的，当且仅当其所有的相似矩阵和它在这一位都相等。接下来有 $q$ 次询问，每次问你是否存在某个矩阵，其恰好有 $K$ 位是**固定**的。

# 思路
很明显应该从网络流的角度去思考问题（我一开始想能不能直接对着 $K$ 构造，结果发现最后又会回到网络流上去）。这一题让我联想到了求最小割的可行边和必须边，也就是[P4126 [AHOI2009] 最小割](https://www.luogu.com.cn/problem/P4126)。虽然这一道题要求的是某条边可不可以选择或不选择，但是基本原理是一样的。

首先是建立一个超级原点 $S$ 和超级汇点 $T$ 和一个二分图，左边记为 $X_i$，右边记为 $Y_j$。假设当前矩阵 $A$ 的行/列之和分别是 $A_i,B_j$，那么应该连 $(S,X_i,A_i),(X_i,Y_j,1),(Y_j,T,B_j)$ 三种边。先假设已经跑了一次最大流。

接下来我们要对于每一条 $(X_i,Y_j,1)$ 进行如下判断：如果这条边有流量，则判断删掉它以后是否仍然能够到达最大流；如果这条边没有流量，则判断能否让其有流量并且保持现在的最大流。

这两个问题都需要通过在残量图上找增广路来实现。

前者需要判断是否还有一条从 $X_i$ 到 $Y_j$ 的路径。因为残量图上有边 $(Y_j,X_i,1)$，因此等价于 $X_i,Y_j$ 强连通。

后者需要判断是否有从 $Y_j$ 到 $X_i$ 的增广路。因为残量图上有边 $(X_i,Y_j,1)$，因此也等价与 $X_i,Y_j$ 强连通。

因此可以得出结论，如果一条边可以在保持最大流量的同时可以选或者不选，当且仅当它在残量图的同一个强连通分量中。

因此我们只需要在原图中划分强连通分量即可，需要注意的是，如果要成为一个强连通分量，那么必须要两边都至少有两个点，然后用一个 **bitset** 实现一个 $O(\frac{n^6}{w})$ 的 **dp** 即可。

[code](https://atcoder.jp/contests/arc186/submissions/68012134)

---

## 作者：_Ch1F4N_ (赞：1)

很牛的题啊。

考虑把 01 矩阵映射到一个两侧各有 $n$ 个点的二分图上，假若映射到无向图上比较难处理 $0,1$ 可以随便填的问题，所以这里映射到有向图上，假若是 $0$ 就是左侧连向右侧，否则反过来。

任意一个矩阵就是这张完全二分图的任意一种定向所有边的方案。

两个矩阵在一个等价类里面就是所有点入度相同。

考虑从一个方案出发，强制改变一条边的方向，假若还能通过调整其余边的方向使得所有点度数不变，那么其所在等价类中这条边代表的点就不在 $S$ 中。

注意一下，改变边 $u \to v$ 为 $v \to u$ 后，你需要连续将 $v \to p_1,p_1 \to p_2,p_2 \to p_3,...,p_i \to u$ 上所有边全部反向才能使得度数不变，也就是必须将 $u \to v$ 所在的环上边全部反向。

那么可知，集合 $S$ 中的点对应的边就是图上所有不在任意一个强连通分量中的边。

非环边不太好处理，但是环边比较好处理，因为其一定由强连通分量产生。

不妨 $f_{i,j,k}$ 表示是否存在一个左边有 $i$ 个点，右边有 $j$ 个点，共有 $k$ 条环边的图是否存在，转移枚举强连通分量在两侧的点数即可。确定了所有强连通分量后，将剩下的边定向使得图成为 DAG 是必定可行的。

时间复杂度 $O(n^6)$。


```cpp
#include<bits/stdc++.h>
using namespace std;
//#define int long long
//#define lowbit(x) (x&(-x))
//#define bp push_back
//#define sz size
//#define cl clear
int f[50][50][1000];
int vis[1000];
int n,q;
int main(){
	cin>>n>>q;
	f[0][0][0]=1;
	for(int i=0;i<=n;i++){
		for(int j=0;j<=n;j++){
			for(int k=0;k<=n*n;k++){
				for(int u=0;u<=i;u++){
					for(int v=0;v<=j;v++){
						if(u==0&&v!=1) continue;
						if(v==0&&u!=1) continue;
						if(u==1&&v!=0) continue;
						if(v==1&&u!=0) continue;
						if(i==0&&j==0) continue;						
						if(k>=u*v) f[i][j][k]|=f[i-u][j-v][k-u*v];
						if(i==n&&j==n&&f[i][j][k]==1) vis[n*n-k]=1;
					}
				}
			}
		}
	}
	while(q--){
		int x;
		cin>>x;
		cout<<(vis[x]==1?"Yes\n":"No\n");
	}
	return 0;
}
```

---

## 作者：lalaouye (赞：1)

这题赛时想到从图的角度考虑，完全没想到这么搞二分图啊！

我们构造二分图进行思考。当 $A_{i,j}=1$ 时，将左部 $i$ 向右部 $j$ 连边，当 $A_{i,j}=0$ 时，将右部 $i$ 向左部 $j$ 连边，那么两图相似显然要满足每个点出度入度相同，那么什么边可以改变呢？注意到只要我们能够在这张图中找到一个简单环，然后我们把这些边全部转向就可以造出一张新的相似的图。而对于另外的边，我们动不了。

然后，我们考虑怎么利用这个性质。我们可以利用 dp，每次给图加入一个强连通分量，那么里面的边全都可以动，直接暴力 $\mathcal{O}(n^6)$ 枚举转移即可。可以使用 bitset 优化，那么时间复杂度是 $\mathcal{O}(\frac{n^6}{w})$。

代码：

````
#include <bits/stdc++.h>
#define int long long
#define rep(i, l, r) for (int i = l; i <= r; ++ i)
#define rrp(i, l, r) for (int i = r; i >= l; -- i)
#define pii pair <int, int>
#define eb emplace_back
#define ls p << 1
#define rs ls | 1
using namespace std;
constexpr int N = 30 + 5, B = 71, P = 1042702009;
typedef unsigned long long ull;
inline int rd () {
  int x = 0, f = 1;
  char ch = getchar ();
  while (! isdigit (ch)) {
    if (ch == '-') f = -1;
    ch = getchar ();
  }
  while (isdigit (ch)) {
    x = (x << 1) + (x << 3) + ch - 48;
    ch = getchar ();
  }
  return x * f;
}
int qpow (int x, int y) {
  int ret = 1;
  for (; y; y >>= 1, x = x * x % P) if (y & 1) ret = ret * x % P;
  return ret;
}
int n, q;
bitset <901> dp[N][N];
signed main () {
  // freopen ("1.in", "r", stdin);
  // freopen ("1.out", "w", stdout);
  n = rd (), q = rd ();
  dp[0][0][0] = 1;
  rep (X, 1, n) rep (Y, 1, n) rep (x, 0, X - 2) rep (y, 0, Y - 2) dp[X][Y] |= dp[x][y] << ((X - x) * (Y - y));
  bitset <901> sum;
  rep (x, 0, n) rep (y, 0, n) sum |= dp[x][y];
  for (; q; -- q) {
    int x = rd ();
    puts (sum[n * n - x] ? "Yes" : "No");
  }
}
````

---

## 作者：Iniaugoty (赞：1)

### [ARC186A Underclued](/problem/AT_arc186_a)

对于一个矩阵考虑建出一个二分图。如果 $a _ {i, j} = 1$ 则左部 $i$ 与右部 $j$ 连边。那么题面中定义等价类的那个 $2n$ 个数就是 $2n$ 个点的度数。

那么 $(i, j)$ 是不动点当且仅当，在不改变结点度数的基础上，如何改变图的形态，这条边都存在（或者都不存在）。但你会发现这个性质是不太好刻画的。

考虑把无向边换成有向边：$a _ {i, j} = 1$ 则左部 $i$ 向右部 $j$ 连边，$a _ {i, j} = 0$ 则右部 $j$ 向左部 $i$ 连边。这样任意两点都连了一条边，共有 $n ^ 2$ 条。

于是性质变成了：两个矩阵等价当且仅当每个对应的点出入度分别相同；不动点当且仅当，如何改变图的形态，方向都不变。

考虑改变一条边的方向即 $u \to v$ 改为 $v \to u$，然后再进行调整以重新满足度数限制。然后你会发现，调整的时候是将一条链上的边一条一条全部反向，直到再有一个 $w \to u$ 改为 $u \to w$ 才结束。也就是说，想改变图的形态，一定是将一个环整体反向。那么方向不会改变的边，就是没有出现在任何一个环上的边。

考虑 DP。设 $dp _ {i, j, k}$ 表示考虑到前 $i + j$ 个点，有且仅有 $k$ 条环上边，是否可行。容易发现剩下的 $(n - i) + (n - j)$ 个点直接向前 $i + j$ 个点连边，就可以使剩下的边都不是环上边，于是 $ans _ k$ 从任意 $dp _ {i, j, n ^ 2 - k}$ 继承。

枚举强连通分量来转移。考虑一个包含了左部 $x$ 个点，右部 $y$ 个点的环，因为任意两点有连边，所以整个大环会贡献 $xy$ 条边，于是 $dp _ {i - x, j - y, k - xy} \to dp _ {i, j, k}$。如果这题是计数，这样会造成重复贡献，但是这是可行性，所以没有影响。

我们设计了一个 4D/2D 的 DP，时间复杂度为 $O(n ^ 6)$，因为维护的是可行性，可以用 `bitset` 优化到 $O(\frac {n ^ 6} w)$。

[code](https://atcoder.jp/contests/arc186/submissions/59422030)。

---

## 作者：Sky_Maths (赞：0)

## 题意简述
对于一个 $N\times N$ 的 $01$ 矩阵 $A$，令 $C_i = \sum\limits_{j = 1} ^ N A_{i, j}, R_j = \sum\limits_{i = 1} ^ N A_{i, j}$。

把 $(C_1,\dots, C_N, R_1, \dots, R_N)$ 对应相同的矩阵归到同一个等价类，**对于某个等价类**，集合 $S$ 中的元素是满足**对于该等价类中所有 $A$，都有 $A_{i, j}$ 相等**的 $(i, j)$。

给出 $N$，有 $Q$ 次询问，每次询问一个 $k$，**是否存在** $|S| = k$ 的非空等价类，其中 $N\le 30, 1 \le Q\le N ^ 2 + 1, 0\le k\le N^2$。

## 题解
首先，对于 $01$ 矩阵形态无限制，可以考虑放在一个 $N + N$ 的完全二分图上边定向，即：
- $A_{i, j} = 1$ 即 $r_i$ 向 $c_j$ 连边。
- $A_{i, j} = 0$ 即 $c_j$ 向 $r_i$ 连边。

发现此时 $c, r$ 的入度（或者出度，总和为 $N$）与 $C, R$ 的限制等价。

再考虑对于所有度数相同的图都有 $A_{i, j}$ 相等的限制，对于任意两个**同一等价类且不同的**定向后二分图 $A, B$，先删除都存在的边，发现此时两者的 $C, R$ 仍然相同，但不存在都存在的边，且剩下的边都是相反的，所以对于任意点都有**出度等于入度**，那么此时整个图是由多个环构成的，发现还存在的边在环内，可以通过翻转整个环使 $C, R$ 不变。

于是得到结论：$A_{i, j}$ 不固定当且仅当其在环上。再说的清楚一点，因为通过上面的过程可以发现两个 $A, B$ 可能不同的只有在环上的边，且在环上的边可以通过翻转整个环使这条边相反。

然后可以暴力枚举强连通分量的大小来转移答案，假设左边有 $x$ 个点，右边有 $y$ 个点，**不定**的边就有 $xy$ 条，且**二分图上可以构造强连通分量的充要条件是 $x, y\ge 2$。**

那么可以 DP，考虑设 $f_{i, j, s}$ 为前 $i$ 个 $r$ 和前 $j$ 个 $c$，强连通分量内的边数为 $s$，枚举新的强连通分量的大小即可，注意我们只想判断可行性，可以钦定不同强连通分量内的边之间没有交叉。

时间复杂度 $\mathcal O(n^6)$，常数较小（最大的点跑了 6 ms）。

发现 DP 内记录的值为 01，可以考虑设 $f_{i, s}$ 为左边选了 $i$ 个点时，要得到 $s$ 条强连通分量内边所需的最小 $j$，应该可以做到 $\mathcal O(n^5)$？有时间再补。

[$\mathcal O(n^6)$ 代码](https://atcoder.jp/contests/arc186/submissions/59325889)

---


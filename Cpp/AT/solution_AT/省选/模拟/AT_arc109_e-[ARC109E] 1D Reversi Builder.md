# [ARC109E] 1D Reversi Builder

## 题目描述

[problemUrl]: https://atcoder.jp/contests/arc109/tasks/arc109_e

黒石さんと白石さんは、一列に並んだ $ n $ 個のマスからなる盤面を使って遊んでいます。 マスにはそれぞれ $ 1 $ から $ n $ の整数が順番に振られていて、マス $ s $ に印がつけられています。

まず、黒石さんは、各マスについて独立に、黒か白を等確率で選んで塗ります。その後、マス $ s $ にマスの色と同じ色の石を置きます。

黒石さんと白石さんは、この盤面と無限個の黒い石と白い石を使ったゲームをします。このゲームでは、黒石さんから始めて、黒石さんと白石さんが交互に次の手順で石を置いていきます。

1. 石が置かれているマスと隣接している空きマスをひとつ選ぶ。マス $ i $ を選んだとする。
2. マス $ i $ に、マスと同じ色の石をおく。
3. 置いた石と同じ色の石がマス $ i $ 以外に置かれているとき、そのうちマス $ i $ に最も近い石と、マス $ i $ の間にあるすべての石の色をマス $ i $ の色に変更する

空きマスが存在しなくなったときにゲームが終了します。

黒石さんはゲーム終了時の黒い石の個数を最大化するために最適な行動をし、白石さんはゲーム終了時の白い石の個数を最大化するために最適な行動をします。

$ s=1,\dots,n $ それぞれの場合について、ゲーム終了時の黒い石の個数の期待値を $ \text{mod\ }998244353 $ で求めてください。

## 说明/提示

### 注意

求める期待値が既約分数 $ p/q $ で表されるとき、$ rq\equiv\ p\ ~(\text{mod\ }\ 998244353) $ かつ $ 0\ \leq\ r\ \lt\ 998244353 $ を満たす整数 $ r $ がこの問題の制約のもとで一意に定まります。この $ r $ が求める値です。

### 制約

- $ 1\ \leq\ n\ \leq\ 2\times\ 10^5 $

### Sample Explanation 1

黒マスを `b` で、白マスを `w` で表すことにします。 盤面として、`www`, `wwb`, `wbw`, `wbb`, `bww`, `bwb`, `bbw`, `bbb` の $ 8 $ 通りがあり、これらから等確率に $ 1 $ つが選ばれます。 $ s $ によらず、それぞれの盤面について、ゲーム終了時の黒い石の個数は $ 0,1,0,2,1,3,2,3 $ となります。 よって、期待値は $ (0+1+0+2+1+3+2+3)/8\ =\ 3/2 $ となるため、答えは $ 2r\ \equiv\ 3\ ~(\text{mod\ }\ 998244353) $ かつ $ 0\ \leq\ r\ \lt\ 998244353 $ を満たす $ r\ =\ 499122178 $ となります。

## 样例 #1

### 输入

```
3```

### 输出

```
499122178
499122178
499122178```

## 样例 #2

### 输入

```
10```

### 输出

```
5
5
992395270
953401350
735035398
735035398
953401350
992395270
5
5```

## 样例 #3

### 输入

```
19```

### 输出

```
499122186
499122186
499110762
499034602
498608106
496414698
485691370
434999274
201035754
138645483
201035754
434999274
485691370
496414698
498608106
499034602
499110762
499122186
499122186```

# 题解

## 作者：SoyTony (赞：3)

博弈论！概率期望！计数！推式子！

# 策略

通过观察和打表可以得到以下结论：

- 结论 $1$：最终结果一定是不超过一段黑色连续段和不超过一段白色连续段构成。
    
    证明：显然，否则不满足题目描述。

- 结论 $2$：如果 $col_1=col_n$，则无论如何操作结果一定全为 $col_1$。

    证明：两端颜色无法被改变，因此一定会把另一种颜色的全部改变。

- 结论 $3$：设左侧连续段右端点 $l$，右侧连续段左端点 $r$，如果 $col_1\neq col_n$，则最终一定是保留 $l$，$r$ 扩展到 $l+1$ 或保留 $r$，$l$ 扩展到 $r-1$。

    证明：当石子被放在 $l$ 或 $r$ 中后，这一端的颜色将不再改变，而剩余一端在到达连续段前，一定会经过另一种颜色，这使得其余所有位置的颜色都变成先到达的一端。

- 结论 $4$：在结论 $3$ 的基础上，设两侧黑色连续段长 $len_{\mathrm{B}}$，白色连续段长 $len_{\mathrm{W}}$，若 $s$ 距白色连续段较近，则最终黑色石子个数为 $len_{\mathrm{B}}$，否则为 $n-len_{\mathrm{W}}$。

    证明：结合结论 $3$ 的证明，双方会尽量向各自颜色的一端移动，先到达的可以占有除两侧连续段以外的位置，而黑色先手先移动，因此只要到黑色一端距离不大于到白色一端，就可以达到目的。

# 计数

先统计个数之和再除以方案数。

以下默认 $n\ge 2$。

对初始颜色和位置 $s$ 进行分类讨论。

---

情况 $1$：两端均为黑色，显然总和是 $n2^{n-2}$。

---

情况 $2$：两端颜色不同，但只有两个连续段，此时结果固定，与 $s$ 的放置无关，总和是 $2\times [1+2+\cdots+(n-1)]=n(n-1)$。

---

情况 $3$：两端颜色不同，连续段个数大于 $2$，且 $s$ 在两侧连续段中的一个。

设左侧连续段右端点 $l$，右侧连续段左端点 $r$。

考虑在左侧连续段的情况，此时如果左侧为黑色，则答案为 $n-r$，反之答案为 $r$。因此其余位置不变，左黒右白或是左白右黑两种情况的结果之和是 $n$，这个性质非常重要。

$$
\begin{aligned}
&n\sum_{l=s}^{n-3}\sum_{r=l+3}^n 2^{r-l-3}\\
=&n\sum_{l=s}^{n-3}\dfrac{1}{2^l}\sum_{r=l+3}^n 2^{r-3}\\
=&n\sum_{l=s}^{n-3}\dfrac{1}{2^l}(2^{n-2}-2^{l})
\end{aligned}
$$

预处理一下前缀和即可。

在右侧连续段的情况类似：

$$
\begin{aligned}
&n\sum_{r=4}^s\sum_{l=1}^{r-3} 2^{r-l-3}\\
=&\sum_{r=4}^s2^r\sum_{l=1}^{r-3} \dfrac{1}{2^{l+3}}\\
=&\sum_{r=4}^s2^r\left(\dfrac{2^r-1}{2^r}-\dfrac{2^3-1}{2^3}\right)
\end{aligned}
$$

注意 $l,r$ 之间至少间隔 $2$ 个位置，且 $l+1,r-1$ 两个位置的颜色已经钦定了。

---

情况 $4$：两端颜色不同，连续段个数大于 $2$，且 $s$ 不在两侧连续段中的任何一个。

先考虑到两端距离不相等的情况，同样是如果左侧距离更近，则贡献和为 $n$，同理右端距离更近，贡献和也为 $n$，则要求的是：

$$n\sum_{l=1}^{s-1}\sum_{r=s+1}^n2^{r-l-3}[s-l+1\neq r-s+1]$$


即 $l+r\neq 2s$，可以先计算全部情况再减去相等情况。

全部情况的式子：

$$
\begin{aligned}
&n\sum_{l=1}^{s-1}\sum_{r=s+1}^n2^{r-l-3}\\
=&\dfrac{1}{8}n\sum_{l=1}^{s-1} \dfrac{1}{2^l}\sum_{r=s+1}^n 2^r\\
=&\dfrac{1}{8}n\left(\dfrac{2^{s-1}-1}{2^{s-1}}\right)(2^{n+1}-2^{s+1})
\end{aligned}
$$

删去 $l+r=2s$ 的情况需要卡一个比较精准的范围，$r=2s-l\in[s+1,n]$，于是 $l\in[\max(2s-n,1),s-1]$。

设 $m=\max(2s-n,1)$。

$$n\sum_{l=m}^{s-1}2^{2s-2l-3}=n\sum_{i=1}^{s-m}2^{2i-3}$$

最后 $l+r=2s$ 的答案需要再计算一次，若左侧为黑色则答案为 $n-(n-r+1)=r-1$，若右侧为黑色则答案为 $n-l$，因此每种情况对应答案为 $n+r-l-1$，注意到由于 $r-l>2$，所以 $l=s-1,r=s+1$ 的情况不能计算，$l$ 的范围应当是 $l\in[m,s-2]$，再推一下：

$$\sum_{l=m}^{s-2} 2^{2s-2l-3}(n+2s-2l-1)=\sum_{i=2}^{s-m}2^{2i-3}(n+2i-1)$$

---

这样就做完了。

---

## 作者：EuphoricStar (赞：2)

考虑固定 $s$ 和每个格子的颜色，最终有多少个石子被染黑。

**结论：** 任何时刻只有不多于两个极大同色连通块。

**证明：** 设 $[x,y]$ 为当前的黑连通块，$[y+1,z]$ 为白连通块。如果下一次染 $x-1$，若 $x-1$ 为白，则 $[x-1,z]$ 都被染为白；否则 $x-1$ 被染为黑。下一次染 $z+1$ 同理。

下文令 $0$ 为白，$1$ 为黑，记 $c_i$ 为第 $i$ 个格子的颜色。

- 如果 $c_1 = c_n = 0$，最终所有石子都会被染白；
- 如果 $c_1 = c_n = n$，最终所有石子都会被染黑；
- 如果 $c_1 \ne c_n$，不失一般性地，假设 $c_1 = 1, c_n = 0$。记 $x$ 为最大的下标满足 $\forall i \in [1,x], c_i = c_1$，$y$ 为最小的下标满足 $\forall i \in [y,n], c_i = c_n$。若 $x + 1 = y$，最终有 $x$ 个石子被染黑；否则先手肯定要尽快使 $x$ 被染为黑，后手要尽快使 $y$ 被染为白，这样中间 $y - x - 1$ 个石子肯定归某个人了。$[1,x]$ 最后肯定被染黑，$[y,n]$ 最后肯定被染白，如果先手先到 $x$，即 $s - x \ge y - s$，则 $[x+1,y-1]$ 归先手；否则归后手。

这样枚举 $s,x,y$，就得到了一个 $O(n^3)$ 的做法。

考虑如果 $s - x \ne y - s$，把 $c$ 黑白翻转后，最后的染色状态与翻转前互补，则配对后两个状态的答案的和为 $n$；如果 $s - x = y - s$，$[x + 1, y - 1]$ 归先手，配对后两个状态的答案和为 $n + y - x - 1$。

设 $ans_s$ 为初始位置为 $s$ 时不同状态染黑石子数量的总和，可得：

$$ans_s = n2^{n-1} + \sum\limits_{x=1}^n \sum\limits_{y=1}^n [x + y = 2s \land y - x - 3 \ge 0] (y - x - 1) 2^{y-x-3}$$

这样是 $O(n^2)$ 的。

考虑枚举 $y - x = 2t$，则 $x = s - t, y = s + t$，可得：

$$ans_s = n2^{n-1} + \sum\limits_{t=1}^n [1 \le s - t \land s + t \le n \land 2t - 3 \ge 0] (2t - 1) 2^{2t - 3}$$

$t$ 的范围可以算出是 $[2,\min(n-s,s-1)]$，所以：

$$ans_s = n2^{n-1} + \sum\limits_{t=2}^{\min(n-s,s-1)} (2t - 1) 2^{2t - 3}$$

设 $f_i = \sum\limits_{t=2}^i (2t - 1) 2^{2t - 3}$，$f$ 可以前缀和 $O(n)$ 求出，可得：

$$ans_s = n2^{n-1} + f_{\min(n-s,s-1)}$$

最后乘 $\frac{1}{2^n}$ 就是期望。

至此终于以 $O(n)$ 的时间复杂度做完了本题。

[code](https://atcoder.jp/contests/arc109/submissions/40746235)

---

## 作者：shinkuu (赞：1)

话说这题一开始暴力判断的方式想错了导致乱想了半天……说明这种题还是先写暴力比较好……

因为表面是一个博弈，所以先考虑分析两方的最优策略。考虑分析一些性质。

Lemma：黑白棋子构成级极长同色连续段数量不会超过 $2$。

证明显然，如果在某个时刻从 $2$ 变成了 $3$，那么一定会将一段覆盖，变成 $2$ 个极长同色连续段。

然后，对于这种覆盖的问题，一般都是有很多位置没有用，只用考虑一些特殊的位置。对于这题，由于是两个相同位置覆盖中间的，所以尝试着只考虑每种颜色最左/右出现的位置。

容易发现，令 $c_i$ 为列表上位置 $i$ 的颜色，若 $c_1=c_n$，那么最后全部一定都是 $c_1$ 的棋子。证明显然。

否则不妨钦定 $c_1=0,c_n=1$。此时我们只用关注最后一个 $0$ 的位置 $x$ 和最后一个 $1$ 的位置 $y$。若 $x<y$ 则 $x+1=y$，答案为 $n-x+1$。否则手玩发现，若先取到 $x$ 再取到 $y$，那么黑方在取到 $x$ 后可以直接取 $x+1$，因为 $[x+1,n]$ 全黑，所以 $x+1$ 不会再变成白色。同时 $y$ 还没取，取到 $y$ 后 $[y,n]$ 全黑，也无法变成白色。所以最后黑棋数量为 $n-y+1$。

那么策略就很显然了：黑方尽可能往 $x$ 处靠，白方往 $y$。直接对这个计数也是简单的：枚举起点 $s$，分成 $y<s<x,s\le y<x,y<x\le s$ 以及一些特殊情况，分别预处理一些东西然后算。作者也是这么过的。

但是你会发现这太蠢了！除了 $y<s<x$ 之外，的所有情况，如果将所有黑白翻转，答案就会变成 $n-ans$。若 $y<s<x$ 且 $x-s\not=s-y$ 也满足这个性质。此时期望就是 $\frac{n}{2}$。但是若 $x-s=s-y$，黑方由于先手，所以一定能抢先取到 $x$。于是期望要加上 $\frac{2^{x-y-1}(x-y+1)}{2^n}$。只用简单预处理，统计所有这样的贡献之和即可。

code：

```cpp
int n,m,f[N];
il int Mod(int x,int y){
	return x+y>=mod?x+y-mod:x+y;
}
il int qpow(int x,int y){
	int ret=1;
	while(y){
		if(y&1){
			ret=1ll*ret*x%mod;
		}
		x=1ll*x*x%mod,y>>=1;
	}
	return ret;
}
void Yorushika(){
	read(n);
	int pw=2;
	rep(i,1,n){
		f[i]=Mod(f[i-1],1ll*pw*(i+i+1)%mod);
		pw=4ll*pw%mod;
	}
	const int iv=qpow(qpow(2,n),mod-2);
	rep(i,1,n){
		int ans=1ll*n*((mod+1)/2)%mod;
		if(n>=4&&i>2&&i<n-1){
			ans=Mod(ans,1ll*f[min(i-2,n-1-i)]*iv%mod);
		}
		printf("%d\n",ans);
	}
}
signed main(){
	int t=1;
	//read(t);
	while(t--){
		Yorushika();
	}
}
```

---

## 作者：daduoli (赞：1)

有点意思的题目。

我们手玩一下样例首先可以有一种感知，如果一个串两端颜色相同，那么他一定会全部都被染成那种颜色。

考虑归纳证明，假设我们现在有一个全部相同的串，首先如果加同一种颜色的，显然仍然所有串颜色都相同，继续的，我们向左边不断加另一种颜色的点，这时候只要在右边加一个和那个不同颜色的点就会发现全部都相同。

所以我们可以轻松地讨论掉两边都是白色和黑色的情况，一个贡献是 $0$，一个贡献是 $n$。

接着我们现在来考虑左右两边分别是白色和黑色，以及黑色和白色的情况，如果你只对其中一个进行考虑，是很困难的。

这种情况很多的题目往往有一种套路，就是整体地对所有方案数进行统一的看贡献，所以我们对上面两种情况结合起来看。

观察样例会发现，$x=1$ 的时候答案是 $\frac 2n$，手玩一下 $x=1$ 的情况，我们会发现，假如我们第一个格子填的是黑色，那么实际上我们的贡献只和我们最远的黑色有关，假如这时候贡献是 $y$，然后你思考一下会发现，如果全部位置取反，那么贡献是 $n-y$，你就可以发现这两个东西加起来恰好是 $n$。所以答案就是 $\frac n2$。

接下来考虑更普遍的情况。

根据我们刚才的结论，一个串如果左右端点颜色相同，那么整个串遍历完之后颜色也相同，但前提是遍历完。

考虑这种情况，$BW\dots BW$。

![](https://cdn.luogu.com.cn/upload/image_hosting/e45cmswt.png?x-oss-process=image/resize,m_lfit,h_170,w_225)

对于上面这张图，白色的区间是 $[1,R]$，黑色的区间是 $[L,n]$。

当他们相交时，我们从会发现只要走到 $R$，那么 $[1,R]$ 都会变成白色，而 $[R+1,n]$ 显然只能是黑色；而只要走到 $L$，那么所有 $[L,n]$ 都会变成黑色，$[1,L-1]$ 也只能是白色。

所以实际上对于玩家一而言要尽早走到 $L$，对于玩家二而言要尽早走到 $R$，如果谁先早走到，那么颜色就会变成那个人想要的颜色。

考虑会我们上面的互补成 $n$ 的原则，在这里也是基本适用的，唯一不同的是因为有先后手的原因，当且仅当 $L,R$ 到 $x$ 距离相同时，都是玩家一获胜。

考虑计算这个值，记 $l=i-1,r=n-i$，我们枚举这个距离。

$$\sum\limits_{i=1}^{\min(l,r)-1}2^{2i-1}(2n-(l-i)-(r-i)-n)=\sum\limits_{i=1}^{\min(l,r)-1}2^{2i-1}(2i+1)$$

首先 $2^{2i-1}$ 是因为左边一段 $x-i+1\sim x-1$ 中可以随便填，右边同理，然后中间 $x$ 也可以随便填。

紧接着旁边的系数实际上就是当距离为 $i$ 时，$BB\dots W\dots B\dots WW$，这种情况和他全部取反的贡献总和，手玩一下可以得到，至于减 $n$，因为我们算的是变化量。

然后再乘一个 $\frac {1}{2^n}$ 即可，容易发现上面这个东西是可以预处理的，这个题就做完了，时间复杂度 $O(n)$，我懒写了 $O(n\log n)$。

---


# 题目信息

# [ABC175D] Moving Piece

## 题目描述

[problemUrl]: https://atcoder.jp/contests/abc175/tasks/abc175_d

高橋君は $ 1,\ 2,\ \cdots,\ N $ の番号のついた $ N $ マスから成るマス目の上で、コマを使ってゲームを行おうとしています。マス $ i $ には整数 $ C_i $ が書かれています。また、$ 1,\ 2\ …,\ N $ の順列 $ P_1,\ P_2,\ \cdots,\ P_N $ が与えられています。

これから高橋君は好きなマスを $ 1 $ つ選んでコマを $ 1 $ つ置き、$ 1 $ 回以上 $ K $ 回以下の好きな回数だけ、次のような方法でコマを移動させます。

- $ 1 $ 回の移動では、現在コマがマス $ i\ (1\ \leq\ i\ \leq\ N) $ にあるなら、コマをマス $ P_i $ に移動させる。このとき、スコアに $ C_{P_i} $ が加算される。

高橋君のために、ゲーム終了時のスコアとしてあり得る値の最大値を求めてください。(ゲーム開始時のスコアは $ 0 $ です。)

## 说明/提示

### 制約

- $ 2\ \leq\ N\ \leq\ 5000 $
- $ 1\ \leq\ K\ \leq\ 10^9 $
- $ 1\ \leq\ P_i\ \leq\ N $
- $ P_i\ \neq\ i $
- $ P_1,\ P_2,\ \cdots,\ P_N $ は全て異なる
- $ -10^9\ \leq\ C_i\ \leq\ 10^9 $
- 入力は全て整数である

### Sample Explanation 1

好きなマスから始めて $ 2 $ 回以下コマを移動させる方法は以下の通りです。 - 初めマス $ 1 $ にコマを置く場合。$ 1 $ 回移動するとマス $ 2 $ に動き、スコアが $ 4 $ になる。$ 2 $ 回移動するとマス $ 4 $ に動き、スコアが $ 4\ +\ (-8)\ =\ -4 $ になる。 - 初めマス $ 2 $ にコマを置く場合。$ 1 $ 回移動するとマス $ 4 $ に動き、スコアが $ -8 $ になる。$ 2 $ 回移動するとマス $ 1 $ に動き、スコアが $ -8\ +\ 3\ =\ -5 $ になる。 - 初めマス $ 3 $ にコマを置く場合。$ 1 $ 回移動するとマス $ 5 $ に動き、スコアが $ 8 $ になる。$ 2 $ 回移動するとマス $ 3 $ に動き、スコアが $ 8\ +\ (-10)\ =\ -2 $ になる。 - 初めマス $ 4 $ にコマを置く場合。$ 1 $ 回移動するとマス $ 1 $ に動き、スコアが $ 3 $ になる。$ 2 $ 回移動するとマス $ 2 $ に動き、スコアが $ 3\ +\ 4\ =\ 7 $ になる。 - 初めマス $ 5 $ にコマを置く場合。$ 1 $ 回移動するとマス $ 3 $ に動き、スコアが $ -10 $ になる。$ 2 $ 回移動するとマス $ 5 $ に動き、スコアが $ -10\ +\ 8\ =\ -2 $ になる。 これらの最大値は $ 8 $ です。

### Sample Explanation 3

最低 $ 1 $ 回はコマを移動させる必要があります。

### Sample Explanation 4

答えの絶対値は非常に大きくなる場合があります。

## 样例 #1

### 输入

```
5 2

2 4 5 1 3

3 4 -10 -8 8```

### 输出

```
8```

## 样例 #2

### 输入

```
2 3

2 1

10 -7```

### 输出

```
13```

## 样例 #3

### 输入

```
3 3

3 1 2

-1000 -2000 -3000```

### 输出

```
-1000```

## 样例 #4

### 输入

```
10 58

9 1 6 7 8 4 3 2 10 5

695279662 988782657 -119067776 382975538 -151885171 -177220596 -169777795 37619092 389386780 980092719```

### 输出

```
29507023469```

# AI分析结果

### 题目重写

高桥君在编号为 $1, 2, \cdots, N$ 的 $N$ 个方格上进行游戏，每个方格 $i$ 上写有一个整数 $C_i$。给定一个排列 $P_1, P_2, \cdots, P_N$，高桥君可以选择一个方格放置棋子，然后进行 $1$ 到 $K$ 次移动。每次移动将棋子从当前方格 $i$ 移动到 $P_i$，并增加 $C_{P_i}$ 的得分。求游戏结束时可能的最大得分。

### 算法分类
图论

### 题解分析与结论

#### 题解1：igAC
- **星级**：4星
- **关键亮点**：
  - 将问题转化为图论中的环问题，利用每个点的入度和出度均为1的特性，将图分解为若干个简单环。
  - 通过枚举起始点和结束点，计算得分，并利用循环的性质优化计算。
  - 代码清晰，逻辑严谨，时间复杂度为 $O(n^2)$，适合题目给定的数据范围。
- **核心代码**：
  ```cpp
  for(int i=1;i<=n;++i){//枚举起始点
      int j=i,sum=0;
      vector<int>vec;
      while(true){
          j=to[j],sum+=a[j];
          vec.push_back(sum);
          if(j==i) break;
      }//找环
      int cirsize=vec.size();
      for(int s=0;s<vec.size() && s<k;++s){//枚举在哪个点停下
          int cnt=(k-s-1)/cirsize;
          if(sum<=0) ans=max(ans,vec[s]);
          else ans=max(ans,vec[s]+cnt*sum);
      }
  }
  ```

#### 题解2：2012_Zhang_
- **星级**：3星
- **关键亮点**：
  - 同样利用环的性质，通过寻找每个点的循环来计算得分。
  - 处理了循环的余下部分，确保最大得分的计算。
  - 代码实现较为复杂，逻辑稍显混乱，但思路正确。
- **核心代码**：
  ```cpp
  for(int i=1;i<=n;i++){
      long long j=i,p=1,f=1;
      long long ans=0;
      while(p<=k&&(j!=i||f==1)){
          ans+=y[j];
          sum=max(sum,ans);
          p++;
          f=0;
          j=x[j];
      }//寻找循环
      if(k<p) continue;
      if(ans>0){
          ans=(k/(p-1)-1)*ans;//预留最后一个循环
          sum=max(sum,ans);
          long long q=k-(k/(p-1)-1)*(p-1);//统计剩余次数
          if(q==0) continue;
          p=1,j=i,f=1;
          while(p<=q){
              ans+=y[j];
              sum=max(sum,ans);
              j=x[j];
              p++;
              f=0;
          }
      }
  }
  ```

### 最优关键思路与技巧
- **环的分解与利用**：将图分解为若干个简单环，利用环的性质优化计算。
- **枚举起始点与结束点**：通过枚举起始点和结束点，计算得分，确保最大得分的获取。
- **循环优化**：利用循环的性质，减少重复计算，提高效率。

### 可拓展之处
- 类似的问题可以转化为图论中的环问题，利用环的性质进行优化。
- 在处理大规模数据时，可以考虑更高效的算法或数据结构，如并查集等。

### 推荐题目
1. [P3385 【模板】负环](https://www.luogu.com.cn/problem/P3385)
2. [P2661 信息传递](https://www.luogu.com.cn/problem/P2661)
3. [P2863 [USACO06JAN]The Cow Prom S](https://www.luogu.com.cn/problem/P2863)

---
处理用时：27.19秒
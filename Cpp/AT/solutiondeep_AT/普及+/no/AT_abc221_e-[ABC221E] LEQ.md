# 题目信息

# [ABC221E] LEQ

## 题目描述

[problemUrl]: https://atcoder.jp/contests/abc221/tasks/abc221_e

長さ $ N $ の整数列 $ A\ =\ (A_1,\ A_2,\ \dots,\ A_N) $ が与えられます。

$ A $ の連続するとは限らない、長さが $ 2 $ 以上である部分列 $ A'=(A'_1,A'_2,\ldots,A'_k) $ のうち以下の条件を満たすものの個数を求めてください。

- $ A'_1\ \leq\ A'_k $

なお、この値は非常に大きくなることがあるため、$ 998244353 $ で割ったあまりを出力してください。

ただし、$ 2 $ つの部分列は、列として同じであっても、取り出す添字が異なる場合は区別されます。

## 说明/提示

### 制約

- $ 2\ \leq\ N\ \leq\ 3\ \times\ 10^5 $
- $ 1\ \leq\ A_i\ \leq\ 10^9 $
- 入力はすべて整数

### Sample Explanation 1

$ A=(1,2,1) $ の連続するとは限らない、長さが $ 2 $ 以上である部分列は $ (1,2) $, $ (1,1) $, $ (2,1) $, $ (1,2,1) $ の $ 4 $ 通りあります。 そのうち問題文中の条件を満たすものは、$ (1,2) $, $ (1,1) $, $ (1,2,1) $ の $ 3 $ 通りです。

### Sample Explanation 2

列として同じであっても、取り出す添字が異なる場合 $ 2 $ つの部分列は区別されることに注意してください。 この入出力例において、問題文中の条件を満たすような部分列は $ (1,2) $, $ (1,2) $, $ (2,2) $, $ (1,2,2) $ の $ 4 $ 通りです。

### Sample Explanation 3

問題文中の条件を満たすような部分列が存在しない場合もあります。

## 样例 #1

### 输入

```
3

1 2 1```

### 输出

```
3```

## 样例 #2

### 输入

```
3

1 2 2```

### 输出

```
4```

## 样例 #3

### 输入

```
3

3 2 1```

### 输出

```
0```

## 样例 #4

### 输入

```
10

198495780 28463047 859606611 212983738 946249513 789612890 782044670 700201033 367981604 302538501```

### 输出

```
830```

# AI分析结果

【题目内容】
# [ABC221E] LEQ

## 题目描述

给定一个长度为 $N$ 的整数序列 $A = (A_1, A_2, \dots, A_N)$。

求 $A$ 的所有长度至少为 $2$ 的子序列 $A' = (A'_1, A'_2, \dots, A'_k)$ 的个数，满足 $A'_1 \leq A'_k$。

由于答案可能非常大，输出时请对 $998244353$ 取模。

注意：即使两个子序列的元素相同，但如果它们的下标不同，也视为不同的子序列。

## 说明/提示

### 制約

- $2 \leq N \leq 3 \times 10^5$
- $1 \leq A_i \leq 10^9$
- 输入均为整数

### 样例解释 1

对于 $A = (1, 2, 1)$，所有长度至少为 $2$ 的子序列为 $(1, 2)$、$(1, 1)$、$(2, 1)$、$(1, 2, 1)$，共 $4$ 个。其中满足条件的子序列为 $(1, 2)$、$(1, 1)$、$(1, 2, 1)$，共 $3$ 个。

### 样例解释 2

即使两个子序列的元素相同，但如果它们的下标不同，也视为不同的子序列。对于 $A = (1, 2, 2)$，满足条件的子序列为 $(1, 2)$、$(1, 2)$、$(2, 2)$、$(1, 2, 2)$，共 $4$ 个。

### 样例解释 3

有时可能不存在满足条件的子序列。

## 样例 #1

### 输入

```
3
1 2 1
```

### 输出

```
3
```

## 样例 #2

### 输入

```
3
1 2 2
```

### 输出

```
4
```

## 样例 #3

### 输入

```
3
3 2 1
```

### 输出

```
0
```

## 样例 #4

### 输入

```
10
198495780 28463047 859606611 212983738 946249513 789612890 782044670 700201033 367981604 302538501
```

### 输出

```
830
```

【算法分类】
树状数组、离散化

【题解分析与结论】
本题的核心是统计所有满足 $A_i \leq A_j$ 且 $i < j$ 的子序列的个数，并且考虑中间元素的任意选择。由于直接枚举所有子序列的复杂度为 $O(n^2)$，无法通过时间限制，因此需要优化。

大多数题解采用了树状数组和离散化的方法，通过将问题转化为二维偏序问题，利用树状数组快速统计满足条件的 $i$ 的贡献。具体来说，对于每个 $j$，统计所有 $i < j$ 且 $A_i \leq A_j$ 的 $i$ 的贡献，并将贡献累加到答案中。

【评分较高的题解】

1. **作者：Shunpower (赞：3)**  
   **星级：5星**  
   **关键亮点：**  
   - 详细解释了如何将问题转化为树状数组可以处理的形式，特别是通过离散化和逆元的处理，使得问题可以在 $O(n \log n)$ 的时间复杂度内解决。  
   - 代码结构清晰，注释详细，易于理解。  
   **核心代码：**
   ```cpp
   ll qpow(ll b,ll p,ll k){
       if(!p) return 1;
       ll d=qpow(b,p>>1,k);
       if(p&1) return d*d%k*b%k;
       else return d*d%k;
   }
   ll inv(ll x){
       return qpow(x,M-2,M);
   }
   ```
   **个人心得：**  
   - 作者强调了离散化和逆元的重要性，并详细解释了如何通过树状数组动态维护贡献。

2. **作者：2huk (赞：2)**  
   **星级：4星**  
   **关键亮点：**  
   - 通过将问题转化为顺序对问题，并利用树状数组优化，代码简洁高效。  
   - 详细解释了如何将贡献分解为只与 $i$ 和 $j$ 相关的项，便于树状数组处理。  
   **核心代码：**
   ```cpp
   ll qpow(ll b, ll p) {
       ll res = 1;
       while (p) {
           if (p & 1) res = res * b % mod;
           b = b * b % mod, p >>= 1;
       }
       return res;
   }
   ```
   **个人心得：**  
   - 作者通过将问题转化为顺序对问题，简化了问题的复杂度，并利用树状数组快速求解。

3. **作者：Register_int (赞：1)**  
   **星级：4星**  
   **关键亮点：**  
   - 通过离散化和树状数组的结合，快速统计满足条件的 $i$ 的贡献。  
   - 代码结构清晰，注释详细，易于理解。  
   **核心代码：**
   ```cpp
   ll qpow(ll b, ll p) {
       ll res = 1;
       while (p) {
           if (p & 1) res = res * b % mod;
           b = b * b % mod, p >>= 1;
       }
       return res;
   }
   ```
   **个人心得：**  
   - 作者通过离散化和树状数组的结合，快速统计满足条件的 $i$ 的贡献，并详细解释了如何通过树状数组动态维护贡献。

【最优关键思路或技巧】
- **离散化**：由于 $A_i$ 的范围较大，直接使用树状数组会导致空间不足，因此需要先对 $A_i$ 进行离散化处理。
- **树状数组**：通过树状数组快速统计满足条件的 $i$ 的贡献，时间复杂度为 $O(n \log n)$。
- **逆元处理**：由于需要对 $2^{i+1}$ 进行逆元处理，使用费马小定理快速计算逆元。

【可拓展之处】
- 类似的问题可以转化为二维偏序问题，利用树状数组或线段树进行优化。
- 对于需要统计满足某些条件的子序列个数的问题，可以考虑将问题转化为统计顺序对或逆序对的问题。

【推荐题目】
1. [P1908 逆序对](https://www.luogu.com.cn/problem/P1908)
2. [P3374 树状数组 1](https://www.luogu.com.cn/problem/P3374)
3. [P3368 树状数组 2](https://www.luogu.com.cn/problem/P3368)

---
处理用时：41.99秒
# 题目信息

# [ABC269F] Numbered Checker

## 题目描述

[problemUrl]: https://atcoder.jp/contests/abc269/tasks/abc269_f

$ N $ 行 $ M $ 列のグリッドがあり、上から $ i $ 行目、左から $ j $ 列目のマス $ (i,j) $ には整数 $ (i-1)\ \times\ M\ +\ j $ が書かれています。  
 このグリッドに、以下の操作を施します。

- 全てのマス $ (i,j) $ について、 $ i+j $ が奇数ならそのマスに書かれている数字を $ 0 $ に書き換える。

操作後のグリッドについて、$ Q $ 個の質問に答えてください。  
 $ i $ 個目の質問は以下の通りです:

- 以下の条件を全て満たすマス $ (p,q) $ 全てについて、そこに書かれている整数を全て足し合わせた値を $ 998244353 $ で割った余りを求めよ。
  - $ A_i\ \le\ p\ \le\ B_i $
  - $ C_i\ \le\ q\ \le\ D_i $

## 说明/提示

### 制約

- 入力は全て整数
- $ 1\ \le\ N,M\ \le\ 10^9 $
- $ 1\ \le\ Q\ \le\ 2\ \times\ 10^5 $
- $ 1\ \le\ A_i\ \le\ B_i\ \le\ N $
- $ 1\ \le\ C_i\ \le\ D_i\ \le\ M $

### Sample Explanation 1

この入力では、グリッドは以下の通りです。 !\[\](https://img.atcoder.jp/abc269/81d92debe7aa949266f3a00cff13b513.png) この入力には $ 6 $ つの質問が含まれます。 - $ 1 $ 個目の質問の答えは $ 0+3+0+6+0+8+0+11+0=28 $ です。 - $ 2 $ 個目の質問の答えは $ 1+0+9+0+17=27 $ です。 - $ 3 $ 個目の質問の答えは $ 17+0+19+0=36 $ です。 - $ 4 $ 個目の質問の答えは $ 14 $ です。 - $ 5 $ 個目の質問の答えは $ 0 $ です。 - $ 6 $ 個目の質問の答えは $ 104 $ です。

### Sample Explanation 2

$ 1 $ 個目の質問について、マス $ (10^9,10^9) $ に書かれている整数は $ 10^{18} $ ですが、それを $ 998244353 $ で割った余りを求めることに注意してください。

## 样例 #1

### 输入

```
5 4

6

1 3 2 4

1 5 1 1

5 5 1 4

4 4 2 2

5 5 4 4

1 5 1 4```

### 输出

```
28

27

36

14

0

104```

## 样例 #2

### 输入

```
1000000000 1000000000

3

1000000000 1000000000 1000000000 1000000000

165997482 306594988 719483261 992306147

1 1000000000 1 1000000000```

### 输出

```
716070898

240994972

536839100```

## 样例 #3

### 输入

```
999999999 999999999

3

999999999 999999999 999999999 999999999

216499784 840031647 84657913 415448790

1 999999999 1 999999999```

### 输出

```
712559605

648737448

540261130```

# AI分析结果

### 题目内容重写

有一个 $N$ 行 $M$ 列的网格，每个格子 $(i,j)$ 中的数字为 $(i-1) \times M + j$。对网格进行如下操作：

- 对于所有满足 $i+j$ 为奇数的格子 $(i,j)$，将其中的数字改为 $0$。

操作后，有 $Q$ 个询问，每个询问给出四个整数 $A_i, B_i, C_i, D_i$，要求计算所有满足 $A_i \le p \le B_i$ 且 $C_i \le q \le D_i$ 的格子 $(p,q)$ 中的数字之和，结果对 $998244353$ 取模。

### 算法分类
数学

### 题解分析与结论

题目要求对网格进行特定操作后，快速回答多个矩形区域内的数字和。由于网格规模较大（$N, M \le 10^9$），直接暴力计算不可行，因此需要利用数学公式进行优化。

各题解的核心思路都是通过等差数列求和公式来快速计算矩形区域内的数字和，避免了对每个格子的遍历。具体来说，题解通过分析行和列的奇偶性，将问题转化为多个等差数列的求和问题，从而在 $O(1)$ 时间内回答每个询问。

### 所选高星题解

#### 题解1：作者：wnsyou (5星)
**关键亮点**：
- 通过分析行和列的奇偶性，将问题转化为等差数列求和问题。
- 详细推导了不同情况下的等差数列首项、公差和项数，确保公式的正确性。
- 代码简洁，逻辑清晰，直接套用等差数列求和公式，避免了复杂的计算。

**核心代码**：
```cpp
ll Sum (ll s, ll d, ll n) { // 等差数列求和公式
  return (s * n + n * (n - 1) / 2 % mod * d % mod) % mod;
}
```

#### 题解2：作者：liangbowen (4星)
**关键亮点**：
- 通过奇偶性分类讨论，简化了问题的复杂度。
- 使用逆元来处理除法，避免了浮点数运算。
- 代码实现较为直观，易于理解。

**核心代码**：
```cpp
int f(int id, int l, int r) {
    if (id & 1) { // 奇数列
        int st = (l & 1) ? l : l + 1, ed = (r & 1) ? r : r - 1;
        if (st > ed) return 0;
        int cnt = (ed - st) / 2 + 1;
        int tmp = 1ll * (id - 1) * m % mod; st = (tmp + st) % mod, ed = (tmp + ed) % mod;
        return 1ll * (st + ed) * cnt % mod * inv % mod;
    }
    // 偶数列类似处理
}
```

#### 题解3：作者：Tsawke (4星)
**关键亮点**：
- 通过简单的容斥思想，将问题转化为四个矩形的值计算。
- 代码实现简洁，直接使用等差数列求和公式，避免了复杂的推导。

**核心代码**：
```cpp
ll QueryOdd(ll l, ll r) {
    if(!(l & 1))++l;
    if(!(r & 1))--r;
    if(l > r)return 0;
    return (((l + r) * (((r - l) >> 1) + 1)) >> 1) % MOD;
}
```

### 最优关键思路与技巧
- **等差数列求和**：通过分析行和列的奇偶性，将问题转化为等差数列求和问题，避免了暴力计算。
- **奇偶性分类讨论**：根据行和列的奇偶性，分别计算不同情况下的等差数列首项、公差和项数，确保公式的正确性。
- **逆元处理除法**：在处理等差数列求和中的除法时，使用逆元来避免浮点数运算，确保结果的准确性。

### 可拓展之处
- 类似的问题可以通过分析网格的规律，转化为等差数列或其他数学公式的求和问题，从而在 $O(1)$ 时间内回答每个询问。
- 在处理大规模数据时，数学公式的优化是提高效率的关键。

### 推荐相似题目
1. [P3372 【模板】线段树 1](https://www.luogu.com.cn/problem/P3372)
2. [P3383 【模板】线性筛素数](https://www.luogu.com.cn/problem/P3383)
3. [P3390 【模板】矩阵快速幂](https://www.luogu.com.cn/problem/P3390)

---
处理用时：32.84秒
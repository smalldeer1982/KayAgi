# 题目信息

# [ABC276F] Double Chance

## 题目描述

[problemUrl]: https://atcoder.jp/contests/abc276/tasks/abc276_f

カード $ 1 $, カード $ 2 $, $ \ldots $, カード $ N $ の $ N $ 枚のカードがあり、 カード $ i $ $ (1\leq\ i\leq\ N) $ には整数 $ A_i $ が書かれています。

$ K=1,2,\ldots,N $ について、次の問題を解いてください。

> カード $ 1 $, カード $ 2 $, $ \ldots $, カード $ K $ の $ K $ 枚のカードが入っている袋があります。  
> 次の操作を $ 2 $ 回繰り返し、記録された数を順に $ x,y $ とします。
> 
> > 袋から無作為にカードを $ 1 $ 枚取り出し、カードに書かれている数を記録する。その後、カードを **袋の中に戻す** 。
> 
> $ \max(x,y) $ の値の期待値を $ \text{mod}\ 998244353 $ で出力してください（注記参照）。  
> ただし、$ \max(x,y) $ で $ x $ と $ y $ のうち小さくない方の値を表します。

## 说明/提示

### 注記

求める期待値は必ず有限値かつ有理数となることが証明できます。また、この問題の制約下では、その値を互いに素な $ 2 $ つの整数 $ P $, $ Q $ を用いて $ \frac{P}{Q} $ と表したとき、$ R\ \times\ Q\ \equiv\ P\pmod{998244353} $ かつ $ 0\ \leq\ R\ \lt\ 998244353 $ を満たす整数 $ R $ がただ一つ存在することが証明できます。この $ R $ を出力してください。

### 制約

- $ 1\ \leq\ N\ \leq\ 2\times\ 10^5 $
- $ 1\ \leq\ A_i\ \leq\ 2\times\ 10^5 $
- 入力は全て整数

### Sample Explanation 1

例えば、$ K=2 $ の時の答えは次のようにして求まります。 袋の中にはカード $ 1 $ とカード $ 2 $ が入っており、それぞれには $ A_1=5 $ と $ A_2=7 $ が書かれています。 - $ 1 $ 回目に取り出されたカードがカード $ 1 $ 、$ 2 $ 回目に取り出されたカードもカード $ 1 $ のとき、$ x=y=5 $ であり、$ \max(x,y)=5 $ となります。 - $ 1 $ 回目に取り出されたカードがカード $ 1 $ 、$ 2 $ 回目に取り出されたカードはカード $ 2 $ のとき、$ x=5 $, $ y=7 $ であり、$ \max(x,y)=7 $ となります。 - $ 1 $ 回目に取り出されたカードがカード $ 2 $ 、$ 2 $ 回目に取り出されたカードはカード $ 1 $ のとき、$ x=7 $, $ y=5 $ であり、$ \max(x,y)=7 $ となります。 - $ 1 $ 回目に取り出されたカードがカード $ 2 $ 、$ 2 $ 回目に取り出されたカードもカード $ 2 $ のとき、$ x=y=7 $ であり、$ \max(x,y)=7 $ となります。 これらが等確率で起こるため、期待値は $ \frac{5+7+7+7}{4}=\frac{13}{2} $ となります。 $ 499122183\times\ 2\equiv\ 13\ \pmod{998244353} $ であるため、$ 499122183 $ を出力します。

## 样例 #1

### 输入

```
3
5 7 5```

### 输出

```
5
499122183
443664163```

## 样例 #2

### 输入

```
7
22 75 26 45 72 81 47```

### 输出

```
22
249561150
110916092
873463862
279508479
360477194
529680742```

# AI分析结果

### 题目内容重写
#### 题目描述
有 $N$ 张卡片，编号为 $1$ 到 $N$，第 $i$ 张卡片上写有一个整数 $A_i$。对于 $K=1,2,\ldots,N$，回答以下问题：

> 有一个袋子，里面装有卡片 $1$ 到卡片 $K$。进行以下操作两次：
> 
> 1. 从袋子中随机取出一张卡片，记录卡片上的数字，然后将卡片放回袋子。
> 
> 设两次记录的数字分别为 $x$ 和 $y$，求 $\max(x,y)$ 的期望值，结果对 $998244353$ 取模。

#### 说明/提示
- 期望值一定是有限的有理数，且可以表示为 $\frac{P}{Q}$，其中 $P$ 和 $Q$ 互质。输出满足 $R \times Q \equiv P \pmod{998244353}$ 且 $0 \leq R < 998244353$ 的整数 $R$。
- 数据范围：$1 \leq N \leq 2 \times 10^5$，$1 \leq A_i \leq 2 \times 10^5$。

#### 样例输入
```
3
5 7 5
```

#### 样例输出
```
5
499122183
443664163
```

### 算法分类
树状数组、概率论

### 题解分析与结论
本题的核心是计算 $\max(x,y)$ 的期望值，其中 $x$ 和 $y$ 是从 $K$ 张卡片中随机抽取两次的结果。由于每次抽取都是独立的，且卡片会被放回，因此可以通过增量计算的方式，利用树状数组维护当前卡片集合中比某个值小的卡片数量及其总和，从而高效计算期望值。

### 所选题解
#### 1. 作者：liangbowen (4星)
- **关键亮点**：使用两个树状数组分别维护卡片数量与总和，增量计算期望值，代码简洁且高效。
- **核心代码**：
  ```cpp
  struct BIT {
      int idx[N];
      int lowbit(int x) {return x & -x;}
      void update(int i, int k) {for (; i < N; i += lowbit(i)) (idx[i] += k) %= mod;}
      int query(int i) {int ans = 0; for (; i; i -= lowbit(i)) ans = (ans + idx[i]) % mod; return ans;}
  } cnt, sum;
  ```
  - **实现思想**：通过树状数组维护比当前卡片小的卡片数量与总和，增量计算期望值。

#### 2. 作者：Semorius (4星)
- **关键亮点**：详细解释了增量计算的数学原理，代码结构清晰，适合理解树状数组的应用。
- **核心代码**：
  ```cpp
  void addc(ll x, ll val) {
      for(ll i = x; i <= 200000; i += lowbit(i)) cnt[i] += val;
  }
  void adds(ll x, ll val) {
      for(ll i = x; i <= 200000; i += lowbit(i)) sum[i] = (sum[i] + val) % mod;
  }
  ```
  - **实现思想**：通过树状数组维护比当前卡片小的卡片数量与总和，增量计算期望值。

#### 3. 作者：whhsteven (4星)
- **关键亮点**：增量计算的思路清晰，代码实现简洁，适合快速理解树状数组的应用。
- **核心代码**：
  ```cpp
  void update(int i, ll k, int id) {
      for (; i <= 2e5; i += lbt(i)) c[id][i] = (c[id][i] + k) % mod;
  }
  ll getsum(int i, int id) {
      ll res = 0;
      for (; i > 0; i -= lbt(i)) res = (res + c[id][i]) % mod;
      return res;
  }
  ```
  - **实现思想**：通过树状数组维护比当前卡片小的卡片数量与总和，增量计算期望值。

### 最优关键思路
使用两个树状数组分别维护比当前卡片小的卡片数量与总和，增量计算期望值。这种方法的时间复杂度为 $O(n \log n)$，能够高效处理大规模数据。

### 可拓展之处
类似的问题可以通过树状数组或线段树维护前缀和或区间信息，适用于需要频繁查询和更新的场景。

### 推荐题目
1. [P3374 【模板】树状数组 1](https://www.luogu.com.cn/problem/P3374)
2. [P3368 【模板】树状数组 2](https://www.luogu.com.cn/problem/P3368)
3. [P1908 逆序对](https://www.luogu.com.cn/problem/P1908)

---
处理用时：31.05秒
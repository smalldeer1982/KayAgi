# 题目信息

# [ARC132C] Almost Sorted

## 题目描述

[problemUrl]: https://atcoder.jp/contests/arc132/tasks/arc132_c

$ 1,\dots,\ n $ と $ -1 $ からなる数列 $ a_1,\dots,a_n $ と整数 $ d $ が与えられます。 以下の条件を満たす数列 $ p_1,\dots,p_n $ はいくつありますか？ 答えを $ 998244353 $ で割ったあまりを出力してください。

- $ p_1,\dots,p_n $ は $ 1,\dots,\ n $ の順列
- $ i=1,\dots,n $ について、 $ a_i\neq\ -1 $ ならば $ a_i=p_i $ （つまり、$ a_1,\dots,a_n $ の $ -1 $ の項を適切に置き換えることで $ p_1,\dots,p_n $ に書き換えできる）
- $ i=1,\dots,n $ について、 $ |p_i\ -\ i|\le\ d $

## 说明/提示

### 制約

- $ 1\ \le\ d\ \le\ 5 $
- $ d\ <\ n\ \le\ 500 $
- $ 1\le\ a_i\ \le\ n $ または $ a_i=-1 $
- $ a_i\neq\ -1 $ ならば $ |a_i-i|\le\ d $
- $ i\neq\ j $ かつ $ a_i,\ a_j\ \neq\ -1 $ ならば $ a_i\neq\ a_j $
- 入力はすべて整数

### Sample Explanation 1

$ (3,2,1,4) $ と $ (3,4,1,2) $ が条件を満たします。

### Sample Explanation 2

$ -1 $ を置き換えて得られる $ 1,2,3,4,5 $ の順列は $ (2,3,4,5,1) $ のみです。 この順列は、$ 5 $ 項目が条件を満たさないため、答えは $ 0 $ です。

### Sample Explanation 3

$ 998244353 $ で割ったあまりを出力してください。

## 样例 #1

### 输入

```
4 2

3 -1 1 -1```

### 输出

```
2```

## 样例 #2

### 输入

```
5 1

2 3 4 5 -1```

### 输出

```
0```

## 样例 #3

### 输入

```
16 5

-1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1```

### 输出

```
794673086```

# AI分析结果

### 题目内容重写

#### [ARC132C] Almost Sorted

**题目描述**

给定一个由 $1,\dots,\ n$ 和 $-1$ 组成的数列 $a_1,\dots,a_n$ 以及一个整数 $d$。求满足以下条件的数列 $p_1,\dots,p_n$ 的数量，并将答案对 $998244353$ 取模后输出。

- $p_1,\dots,p_n$ 是 $1,\dots,\ n$ 的一个排列。
- 对于 $i=1,\dots,n$，如果 $a_i\neq\ -1$，则 $a_i=p_i$（即，$a_1,\dots,a_n$ 中的 $-1$ 项可以被适当替换为 $p_1,\dots,p_n$）。
- 对于 $i=1,\dots,n$，$ |p_i\ -\ i|\le\ d $。

**说明/提示**

**约束条件**

- $1\ \le\ d\ \le\ 5$
- $d\ <\ n\ \le\ 500$
- $1\le\ a_i\ \le\ n$ 或 $a_i=-1$
- 如果 $a_i\neq\ -1$，则 $|a_i-i|\le\ d$
- 如果 $i\neq\ j$ 且 $a_i,\ a_j\ \neq\ -1$，则 $a_i\neq\ a_j$
- 输入均为整数

**样例解释**

**样例 1**

输入：
```
4 2
3 -1 1 -1
```
输出：
```
2
```
解释：$(3,2,1,4)$ 和 $(3,4,1,2)$ 满足条件。

**样例 2**

输入：
```
5 1
2 3 4 5 -1
```
输出：
```
0
```
解释：唯一可能的排列 $(2,3,4,5,1)$ 不满足条件，因为第5项不符合 $|p_i - i| \le d$。

**样例 3**

输入：
```
16 5
-1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1
```
输出：
```
794673086
```

### 题解分析与结论

本题的核心在于如何高效地计算满足条件的排列数量。由于 $d$ 的范围较小（$d \le 5$），可以使用状态压缩动态规划（DP）来解决问题。各题解的主要思路都是通过状态压缩来记录每个位置可能的取值范围，并进行状态转移。

#### 最优关键思路与技巧

1. **状态压缩**：由于 $d$ 的范围较小，可以将每个位置的可能取值（即 $[i-d, i+d]$ 范围内的数）进行状态压缩，用一个二进制数表示哪些数已经被使用。
2. **动态规划转移**：通过枚举每个位置的可能取值，并更新状态，最终得到满足条件的排列数量。
3. **边界处理**：在处理边界时，需要确保枚举的数在合法范围内，并且不违反排列的唯一性。

#### 推荐题解

1. **作者：Obviathy (赞：13)**  
   **评分：5星**  
   **关键亮点**：  
   - 清晰地定义了状态 $f_{i,S}$，表示到第 $i$ 个位置时，可以填的数与下标的差值的集合的答案。
   - 详细解释了状态转移的过程，特别是通过位运算来更新状态。
   - 代码简洁且高效，易于理解。

   **核心代码：**
   ```cpp
   for(int i = 1;i <= n;i ++)
       for(int j = 0;j < 1<<(d+d+1);j ++){
           if(!f[i-1][j])continue;
           for(int k = -d;k <= d;k ++)
               if((j>>(d+k)&1) == 0 && (a[i] == -1 || a[i] == k+i) && k+i <= n && k+i >= 1)
                   f[i][(j | (1<<(d+k))) >> 1] = (f[i][(j | (1<<(d+k))) >> 1]+f[i-1][j])%mod;
       }
   ```

2. **作者：cjh20090318 (赞：5)**  
   **评分：4星**  
   **关键亮点**：  
   - 通过判断已确定的数是否合法来提前终止无效状态，提高了效率。
   - 详细解释了状态转移的两种情况，代码结构清晰。

   **核心代码：**
   ```cpp
   for(int i = 1,mS = 1<<(d<<1|1);i <= n;i ++)
       if(p[i])for(int S = 0;S < mS;++S){
           bool fl=1;
           for(int j=-d;j<=d;j++)if((i+j<1||i+j>n||~a[i+j])&&((S>>(j+d))&1)){fl=0;break;}
           if(fl)
               f[i][S]=(f[i-1][(S<<1)&(mS-1)]+f[i-1][(S<<1|1)&(mS-1)]);
       }
   ```

3. **作者：elbissoPtImaerD (赞：3)**  
   **评分：4星**  
   **关键亮点**：  
   - 代码简洁，直接通过位运算进行状态转移。
   - 通过预处理和边界处理，确保代码的高效性。

   **核心代码：**
   ```cpp
   for(int i=1;i<=n;++i) for(int j=0;j<1<<(m<<1|1);++j)
       if(~a[i])
           if(sd abs(a[i]-i)>m) return wrt(0),void();
           else j>>m-i+a[i]&1||(Add(f[i][(j|1<<m-i+a[i])>>1],f[i-1][j]),7);
       else
           for(int k=sd max(1,i-m);k<=sd min(n,i+m);++k) j>>m-i+k&1||(Add(f[i][(j|1<<m-i+k)>>1],f[i-1][j]),7);
   ```

### 可拓展之处

1. **类似题目**：可以扩展到其他需要状态压缩的动态规划问题，如排列计数、子集枚举等。
2. **优化思路**：可以考虑进一步优化状态转移，减少无效状态的枚举，提高算法效率。

### 推荐题目

1. [P1896 [SCOI2005] 互不侵犯](https://www.luogu.com.cn/problem/P1896)
2. [P2704 [NOI2001] 炮兵阵地](https://www.luogu.com.cn/problem/P2704)
3. [P2831 [NOIP2016 提高组] 愤怒的小鸟](https://www.luogu.com.cn/problem/P2831)

这些题目都涉及到状态压缩动态规划，可以帮助进一步巩固相关知识点。

---
处理用时：59.57秒
# 题目信息

# [ABC314F] A Certain Game

## 题目描述

[problemUrl]: https://atcoder.jp/contests/abc314/tasks/abc314_f

とあるゲームの大会に、プレイヤー $ 1 $ 、プレイヤー $ 2 $ 、$ \ldots $ 、プレイヤー $ N $ の $ N $ 人のプレイヤーが参加します。 大会の開始直前、各プレイヤーはそれぞれ $ 1 $ 人のみからなるチームをなし、全部で $ N $ 個のチームがあります。

大会では全部で $ N−1 $ 回の試合があり、各試合では $ 2 $ つの異なるチームが選ばれ、一方が先攻を、もう一方が後攻を受け持って対戦し、その結果ちょうど一方のチームが勝ちます。 具体的には、$ i\ =\ 1,\ 2,\ \ldots,\ N-1 $ について $ i $ 回目の試合は下記の通りに進行します。

- プレイヤー $ p_i $ の属するチームが先攻、プレイヤー $ q_i $ の属するチームが後攻として、対戦を行う。
- その結果、先攻チームの人数を $ a $ 、後攻チームの人数を $ b $ として、$ \frac{a}{a+b} $ の確率で先攻のチームが、$ \frac{b}{a+b} $ の確率で後攻のチームが勝つ。
- その後、勝負した $ 2 $ チームは $ 1 $ つのチームに併合される。

なお、各試合の対戦結果は他の試合の対戦結果とは独立です。

$ N $ 人のプレイヤーそれぞれについて、大会全体で自分が所属するチームが勝つという出来事が起こる回数の期待値 $ \text{mod\ }\ 998244353 $ を出力してください。

 期待値 $ \text{mod\ }\ 998244353 $ の定義この問題で求める期待値は必ず有理数になることが証明できます。 また、この問題の制約下では、求める期待値を既約分数 $ \frac{y}{x} $ で表したときに $ x $ が $ 998244353 $ で割り切れないことが保証されます。

このとき $ xz\ \equiv\ y\ \pmod{998244353} $ を満たすような $ 0 $ 以上 $ 998244352 $ 以下の整数 $ z $ が一意に定まります。この $ z $ を答えてください。

## 说明/提示

### 制約

- $ 2\ \leq\ N\ \leq\ 2\ \times\ 10^5 $
- $ 1\ \leq\ p_i,\ q_i\ \leq\ N $
- $ i $ 回目の試合の直前、プレイヤー $ p_i $ が属するチームとプレイヤー $ q_i $ が属するチームは異なる。
- 入力はすべて整数

### Sample Explanation 1

チームに所属するプレイヤーの番号が $ x_1,\ x_2,\ \ldots,\ x_k $ であるチームを、チーム $ \lbrace\ x_1,\ x_2,\ \ldots,\ x_k\ \rbrace $ と呼びます。 - $ 1 $ 回目の試合では、プレイヤー $ 1 $ が所属するチーム $ \lbrace\ 1\ \rbrace $ とプレイヤー $ 2 $ が所属するチーム $ \lbrace\ 2\ \rbrace $ が対戦し、 $ \frac{1}{2} $ の確率でチーム $ \lbrace\ 1\ \rbrace $ が、$ \frac{1}{2} $ の確率でチーム $ \lbrace\ 2\ \rbrace $ が勝ちます。 その後、$ 2 $ つのチームは併合され、$ 1 $ つのチーム $ \lbrace\ 1,\ 2\ \rbrace $ になります。 - $ 2 $ 回目の試合では、プレイヤー $ 4 $ が所属するチーム $ \lbrace\ 4\ \rbrace $ とプレイヤー $ 3 $ が所属するチーム $ \lbrace\ 3\ \rbrace $ が対戦し、 $ \frac{1}{2} $ の確率でチーム $ \lbrace\ 4\ \rbrace $ が、$ \frac{1}{2} $ の確率でチーム $ \lbrace\ 3\ \rbrace $ が勝ちます。 その後、$ 2 $ つのチームは併合され、$ 1 $ つのチーム $ \lbrace\ 3,\ 4\ \rbrace $ になります。 - $ 3 $ 回目の試合では、プレイヤー $ 5 $ が所属するチーム $ \lbrace\ 5\ \rbrace $ とプレイヤー $ 3 $ が所属するチーム $ \lbrace\ 3,\ 4\ \rbrace $ が対戦し、 $ \frac{1}{3} $ の確率でチーム $ \lbrace\ 5\ \rbrace $ が、$ \frac{2}{3} $ の確率でチーム $ \lbrace\ 3,\ 4\ \rbrace $ が勝ちます。 その後、$ 2 $ つのチームは併合され、$ 1 $ つのチーム $ \lbrace\ 3,\ 4,\ 5\ \rbrace $ になります。 - $ 4 $ 回目の試合では、プレイヤー $ 1 $ が所属するチーム $ \lbrace\ 1,\ 2\ \rbrace $ とプレイヤー $ 4 $ が所属するチーム $ \lbrace\ 3,\ 4,\ 5\ \rbrace $ が対戦し、 $ \frac{2}{5} $ の確率でチーム $ \lbrace\ 1,\ 2\ \rbrace $ が、$ \frac{3}{5} $ の確率でチーム $ \lbrace\ 3,\ 4,\ 5\ \rbrace $ が勝ちます。 その後、$ 2 $ つのチームは併合され、$ 1 $ つのチーム $ \lbrace\ 1,\ 2,\ 3,\ 4,\ 5\ \rbrace $ になります。 プレイヤー $ 1,\ 2,\ 3,\ 4,\ 5 $ それぞれの、大会全体で自分が所属するチームが勝つという出来事が起こる回数の期待値 $ E_1,\ E_2,\ E_3,\ E_4,\ E_5 $ は、それぞれ $ \frac{9}{10},\ \frac{9}{10},\ \frac{53}{30},\ \frac{53}{30},\ \frac{14}{15} $ です。

## 样例 #1

### 输入

```
5
1 2
4 3
5 3
1 4```

### 输出

```
698771048 698771048 964969543 964969543 133099248```

## 样例 #2

### 输入

```
15
9 2
8 10
13 6
12 11
7 10
4 10
14 2
5 4
1 15
15 2
6 9
8 11
6 3
2 8```

### 输出

```
43970290 310168785 806914186 501498951 950708909 272140427 335124893 168750835 310168785 168750835 280459129 280459129 272140427 476542843 43970290```

# AI分析结果

### 题目内容重写

**题目描述**

某个游戏的大会中，有 $N$ 名玩家参加，分别为玩家 $1$、玩家 $2$、……、玩家 $N$。大会开始前，每个玩家各自组成一个只有自己一个人的团队，总共有 $N$ 个团队。

大会将进行 $N-1$ 场比赛，每场比赛会选出两个不同的团队，一方作为先攻，另一方作为后攻进行对战，结果恰好有一方获胜。具体来说，对于第 $i$ 场比赛（$i = 1, 2, \ldots, N-1$），比赛过程如下：

1. 玩家 $p_i$ 所在的团队作为先攻，玩家 $q_i$ 所在的团队作为后攻，进行对战。
2. 比赛结果根据团队人数决定：先攻团队的人数为 $a$，后攻团队的人数为 $b$，先攻团队获胜的概率为 $\frac{a}{a+b}$，后攻团队获胜的概率为 $\frac{b}{a+b}$。
3. 比赛结束后，对战的双方团队将合并为一个新的团队。

注意，每场比赛的结果与其他比赛的结果是独立的。

对于每个玩家，输出在整个大会中，其所属团队获胜的次数的期望值，结果对 $998244353$ 取模。

### 题解分析与结论

#### 题解对比与总结

1. **并查集与树结构结合**：大多数题解都采用了并查集来维护团队的合并过程，并通过树结构（如Kruskal重构树）来记录比赛的过程和结果。这种思路能够有效地处理团队的合并和概率的传递。
   
2. **概率传递与标记下放**：多个题解提到通过标记下放（类似线段树的pushdown操作）来将概率传递到每个玩家。这种方法避免了暴力更新每个玩家的期望值，从而提高了效率。

3. **按秩合并优化**：部分题解使用了按秩合并的优化策略，确保并查集的合并操作时间复杂度为 $O(\log n)$，进一步提升了算法的效率。

4. **逆元计算**：由于题目要求对结果取模，题解中普遍使用了费马小定理或扩展欧几里得算法来计算分数的逆元，确保结果的正确性。

#### 最优关键思路

- **并查集与树结构结合**：通过并查集维护团队的合并过程，并结合树结构记录比赛的结果，能够高效地处理团队的合并和概率的传递。
  
- **标记下放**：通过标记下放的方式将概率传递到每个玩家，避免了暴力更新，提升了算法的效率。

- **按秩合并**：使用按秩合并优化并查集的合并操作，确保时间复杂度为 $O(\log n)$。

#### 推荐题解

1. **Fire_flame (5星)**
   - **关键亮点**：使用Kruskal重构树和并查集结合，清晰地处理了团队的合并和概率的传递，代码结构清晰，易于理解。
   - **代码片段**：
     ```cpp
     void dfs(int x, int p){
         res[x] = (ans[x] + p) % MOD;
         if(ls[x])dfs(ls[x], (p + ans[x]) % MOD);
         if(rs[x])dfs(rs[x], (p + ans[x]) % MOD);
     }
     ```

2. **xlpg0713 (4星)**
   - **关键亮点**：通过按秩合并优化并查集，并使用标记下放的方式传递概率，代码简洁且高效。
   - **代码片段**：
     ```cpp
     void merge(int x, int y){
         if(siz[x] <= siz[y]){
             fa[x] = y;
             siz[y] += siz[x];
             tag[x] = (tag[x] - tag[y] + mod) % mod;
         }
     }
     ```

3. **Xuan_qwq (4星)**
   - **关键亮点**：通过并查集维护团队的合并过程，并使用树结构记录比赛结果，代码结构清晰，易于理解。
   - **代码片段**：
     ```cpp
     void dfs(int now,ll nxt){
         ans[now]=nxt;
         if(siz[now]==1)return;
         dfs(l[now],(nxt+(siz[l[now]]*ksm(siz[now],mod-2))%mod)%mod);
         dfs(r[now],(nxt+(siz[r[now]]*ksm(siz[now],mod-2))%mod)%mod);
     }
     ```

### 拓展与举一反三

- **类似题目**：类似的问题可以出现在团队合并、概率传递等场景中，常见的算法包括并查集、树结构、标记下放等。
  
- **推荐题目**：
  1. [P3367 【模板】并查集](https://www.luogu.com.cn/problem/P3367)
  2. [P3372 【模板】线段树 1](https://www.luogu.com.cn/problem/P3372)
  3. [P3384 【模板】树链剖分](https://www.luogu.com.cn/problem/P3384)

### 个人心得总结

- **调试经历**：部分题解提到在调试过程中遇到模数写错的问题，提醒我们在处理模运算时要格外小心。
  
- **踩坑教训**：在合并团队时，如果不使用按秩合并优化，可能会导致时间复杂度上升，影响整体性能。

- **顿悟感想**：通过树结构记录比赛结果，能够清晰地处理概率的传递，避免暴力更新，提升算法效率。

---
处理用时：40.66秒
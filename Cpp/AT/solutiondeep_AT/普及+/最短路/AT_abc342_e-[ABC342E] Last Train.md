# 题目信息

# [ABC342E] Last Train

## 题目描述

[problemUrl]: https://atcoder.jp/contests/abc342/tasks/abc342_e

AtCoder 国には駅 $ 1, $ 駅 $ 2,\ldots, $ 駅 $ N $ の $ N $ 個の駅があります。

AtCoder 国に存在する電車の情報が $ M $ 個与えられます。 $ i $ 番目 $ (1\leq\ i\leq\ M) $ の情報は正整数の $ 6 $ つ組 $ (l\ _\ i,d\ _\ i,k\ _\ i,c\ _\ i,A\ _\ i,B\ _\ i) $ で表され、次のような情報に対応しています。

- $ t=l\ _\ i,l\ _\ i+d\ _\ i,l\ _\ i+2d\ _\ i,\ldots,l\ _\ i+(k\ _\ i-1)d\ _\ i $ それぞれについて、次のような電車が存在する。
  - 時刻 $ t $ に 駅 $ A\ _\ i $ を出発し、時刻 $ t+c\ _\ i $ に駅 $ B\ _\ i $ に到着する。

これらの情報にあてはまらない電車は存在せず、電車以外の方法である駅から異なる駅へ移動することはできません。  
また、乗り換えにかかる時間は無視できるとします。

駅 $ S $ から駅 $ N $ に到着できる最終時刻を $ f(S) $ とします。  
より厳密には、整数の $ 4 $ つ組の列 $ \big((t\ _\ i,c\ _\ i,A\ _\ i,B\ _\ i)\big)\ _\ {i=1,2,\ldots,k} $ であって、次のすべての条件を満たすものが存在するような $ t $ の最大値を $ f(S) $ とします。

- $ t\leq\ t\ _\ 1 $
- $ A\ _\ 1=S,B\ _\ k=N $
- すべての $ 1\leq\ i\lt\ k $ について、$ B\ _\ i=A\ _\ {i+1} $
- すべての $ 1\leq\ i\leq\ k $ について、時刻 $ t\ _\ i $ に駅 $ A\ _\ i $ を出発して時刻 $ t\ _\ i+c\ _\ i $ に駅 $ B\ _\ i $ に到着する電車が存在する。
- すべての $ 1\leq\ i\lt\ k $ について、$ t\ _\ i+c\ _\ i\leq\ t\ _\ {i+1} $

ただし、そのような $ t $ が存在しないとき $ f(S)=-\infty $ とします。

$ f(1),f(2),\ldots,f(N-1) $ を求めてください。

## 说明/提示

### 制約

- $ 2\leq\ N\leq2\times10\ ^\ 5 $
- $ 1\leq\ M\leq2\times10\ ^\ 5 $
- $ 1\leq\ l\ _\ i,d\ _\ i,k\ _\ i,c\ _\ i\leq10\ ^\ 9\ (1\leq\ i\leq\ M) $
- $ 1\leq\ A\ _\ i,B\ _\ i\leq\ N\ (1\leq\ i\leq\ M) $
- $ A\ _\ i\neq\ B\ _\ i\ (1\leq\ i\leq\ M) $
- 入力はすべて整数

### Sample Explanation 1

AtCoder 国に走っている電車は以下の図のようになります（発着時間の情報は図には含まれていません）。 !\[\](https://img.atcoder.jp/abc342/c3007f6fd6e6bffff5483312395e51f6.png) 駅 $ 2 $ から駅 $ 6 $ に到着できる最終時刻について考えます。 次の図のように、駅 $ 2 $ を時刻 $ 56 $ に出発して駅 $ 2\rightarrow $ 駅 $ 3\rightarrow $ 駅 $ 4\rightarrow $ 駅 $ 6 $ のように移動することで駅 $ 6 $ に到着することができます。 !\[\](https://img.atcoder.jp/abc342/bf9e3c0a042ef63f63e45fd5b94a23af.png) 駅 $ 2 $ を時刻 $ 56 $ より遅く出発して駅 $ 6 $ に到着することはできないため、$ f(2)=56 $ です。

### Sample Explanation 2

駅 $ 1 $ を時刻 $ 10\ ^\ {18} $ に出発して駅 $ 5 $ に時刻 $ 10\ ^\ {18}+10\ ^\ 9 $ に到着するような電車が存在します。それ以降に駅 $ 1 $ を出発する電車はないため、$ f(1)=10\ ^\ {18} $ です。 このように、答えが $ 32\operatorname{bit} $ 整数におさまらない場合もあります。 また、時刻 $ 14 $ に駅 $ 2 $ を出発して時刻 $ 20 $ に駅 $ 3 $ に到着するような電車は $ 2 $ 番目の情報と $ 3 $ 番目の情報の両方で存在が保証されています。 このように、複数の情報に重複している電車もあります。

## 样例 #1

### 输入

```
6 7
10 5 10 3 1 3
13 5 10 2 3 4
15 5 10 7 4 6
3 10 2 4 2 5
7 10 2 3 5 6
5 3 18 2 2 3
6 3 20 4 2 1```

### 输出

```
55
56
58
60
17```

## 样例 #2

### 输入

```
5 5
1000000000 1000000000 1000000000 1000000000 1 5
5 9 2 6 2 3
10 4 1 6 2 3
1 1 1 1 3 5
3 1 4 1 5 1```

### 输出

```
1000000000000000000
Unreachable
1
Unreachable```

## 样例 #3

### 输入

```
16 20
4018 9698 2850 3026 8 11
2310 7571 7732 1862 13 14
2440 2121 20 1849 11 16
2560 5115 190 3655 5 16
1936 6664 39 8822 4 16
7597 8325 20 7576 12 5
5396 1088 540 7765 15 1
3226 88 6988 2504 13 5
1838 7490 63 4098 8 3
1456 5042 4 2815 14 7
3762 6803 5054 6994 10 9
9526 6001 61 8025 7 8
5176 6747 107 3403 1 5
2014 5533 2031 8127 8 11
8102 5878 58 9548 9 10
3788 174 3088 5950 3 13
7778 5389 100 9003 10 15
556 9425 9458 109 3 11
5725 7937 10 3282 2 9
6951 7211 8590 1994 15 12```

### 输出

```
720358
77158
540926
255168
969295
Unreachable
369586
466218
343148
541289
42739
165772
618082
16582
591828```

# AI分析结果

### 题目内容中文重写
AtCoder 国有编号为 $1, 2,\ldots, N$ 的 $N$ 个车站。

现给出该国存在的 $M$ 条火车信息。第 $i$ 条信息（$1\leq i\leq M$）由 6 个正整数 $(l_i, d_i, k_i, c_i, A_i, B_i)$ 表示，对应如下信息：
- 对于 $t = l_i, l_i + d_i, l_i + 2d_i, \ldots, l_i + (k_i - 1)d_i$ 中的每个时刻，存在如下火车：
  - 该火车在时刻 $t$ 从车站 $A_i$ 出发，在时刻 $t + c_i$ 到达车站 $B_i$。

除这些信息对应的火车外，不存在其他火车，且不能通过火车以外的方式从一个车站移动到另一个车站。此外，换乘所需时间可忽略不计。

设从车站 $S$ 到达车站 $N$ 的最晚到达时刻为 $f(S)$。更严格地说，$f(S)$ 是满足以下所有条件的整数四元组序列 $\big((t_i, c_i, A_i, B_i)\big)_{i = 1, 2, \ldots, k}$ 存在的最大 $t$ 值：
- $t\leq t_1$
- $A_1 = S$，$B_k = N$
- 对于所有 $1\leq i\lt k$，有 $B_i = A_{i + 1}$
- 对于所有 $1\leq i\leq k$，存在在时刻 $t_i$ 从车站 $A_i$ 出发、在时刻 $t_i + c_i$ 到达车站 $B_i$ 的火车。
- 对于所有 $1\leq i\lt k$，有 $t_i + c_i\leq t_{i + 1}$

若不存在这样的 $t$，则 $f(S)=-\infty$。

请求出 $f(1), f(2), \ldots, f(N - 1)$。

### 综合分析与结论
这些题解的核心思路基本一致，都是通过反向建图，将问题转化为从 $N$ 号点到其他点的最长路问题，然后利用 Dijkstra 算法或 BFS 算法求解。

#### 思路对比
- **反向建图**：所有题解都采用了反向建图的方法，将从每个点到 $N$ 号点的最晚出发时间问题，转化为从 $N$ 号点到其他点的最长路问题。
- **算法选择**：大部分题解使用 Dijkstra 算法，部分使用 BFS 算法。Dijkstra 算法利用优先队列优化，能保证每次取出的点是当前到达时间最大的点；BFS 算法则通过队列依次扩展节点。
- **时间计算**：对于每条边，需要根据当前点的最晚到达时间，计算出上一个点的最晚出发时间。具体计算方法是找到满足条件的最晚一班车的出发时间。

#### 算法要点
- **Dijkstra 算法**：使用优先队列维护当前到达时间最大的点，每次取出队首元素进行扩展，更新相邻节点的最晚出发时间。
- **BFS 算法**：使用队列依次扩展节点，对于每个节点，更新其相邻节点的最晚出发时间，并将更新后的节点加入队列。

#### 解决难点
- **时间计算**：需要根据当前点的最晚到达时间，计算出上一个点的最晚出发时间。具体计算方法是找到满足条件的最晚一班车的出发时间。
- **边界条件**：需要注意初始值的设置，以及判断是否无法到达的情况。

### 所选题解
- **作者：Genius_Star (赞：9)，4星**
  - **关键亮点**：思路清晰，代码规范，详细注释了每个步骤的作用，使用 Dijkstra 算法求解，时间复杂度为 $O(N \log N)$。
  - **个人心得**：无

### 重点代码
```cpp
// Genius_Star 的代码核心部分
struct Edge{
    ll v;
    ll l,d,k,c;
};
ll n,m;
ll dis[N];
bool f[N];
vector<Edge> E[N];
priority_queue<pair<ll,ll>> Q;
void add(ll l,ll d,ll k,ll c,ll u,ll v){
    E[u].push_back({v,l,d,k,c});
}
void dijkstra(ll s){
    Q.push({INF,n});
    while(!Q.empty()){
        ll u=Q.top().second;
        Q.pop();
        if(f[u])
            continue;
        f[u]=1;
        for(auto t:E[u]){
            ll v=t.v;
            if(u==n){
                if(dis[v]<t.l+(t.k-1)*t.d)
                    dis[v]=t.l+(t.k-1)*t.d; 
            }
            else{
                if(dis[u]-t.c-t.l<0)
                    continue;
                ll w=min(((dis[u]-t.c-t.l)/t.d)*t.d+t.l,t.l+(t.k-1)*t.d);
                if(dis[v]<w)
                    dis[v]=w;
            }
            Q.push({dis[v],v});
        }
    }
}
```
**核心实现思想**：
1. 定义边的结构体 `Edge`，包含目标节点 `v` 以及火车的相关信息 `l, d, k, c`。
2. 使用 `vector<Edge> E[N]` 存储反向图。
3. `dijkstra` 函数中，使用优先队列 `Q` 维护当前到达时间最大的点。
4. 对于每个节点，遍历其相邻边，根据当前节点的最晚到达时间，计算出上一个节点的最晚出发时间，并更新 `dis` 数组。

### 最优关键思路或技巧
- **反向建图**：将从每个点到 $N$ 号点的最晚出发时间问题，转化为从 $N$ 号点到其他点的最长路问题，简化了问题的求解。
- **Dijkstra 算法**：利用优先队列优化，保证每次取出的点是当前到达时间最大的点，提高了算法的效率。

### 可拓展之处
同类型题或类似算法套路：
- **带时间限制的最短路问题**：在图中加入时间限制，需要在满足时间限制的条件下求解最短路。
- **多源最短路问题**：需要求解多个起点到多个终点的最短路问题。

### 推荐洛谷题目
1. [P1144 最短路计数](https://www.luogu.com.cn/problem/P1144)
2. [P3371 【模板】单源最短路径（弱化版）](https://www.luogu.com.cn/problem/P3371)
3. [P4779 【模板】单源最短路径（标准版）](https://www.luogu.com.cn/problem/P4779)

### 个人心得摘录与总结
- **lml0928**：赛内想出来并写完了代码，但在除法运算时脑抽写成了向上取整，导致少了 450 分。总结：在实现算法时，要仔细检查每个细节，避免出现低级错误。

---
处理用时：42.68秒
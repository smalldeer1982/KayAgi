# 题目信息

# [ABC296E] Transition Game

## 题目描述

[problemUrl]: https://atcoder.jp/contests/abc296/tasks/abc296_e

長さ $ N $ の数列 $ A=(A_1,A_2,\ldots,A_N) $ が与えられます。ここで、各 $ A_i $ $ (1\leq\ i\leq\ N) $ は $ 1\leq\ A_i\ \leq\ N $ をみたします。

高橋君と青木君が $ N $ 回ゲームを行います。$ i=1,2,\ldots,N $ 回目のゲームは次のようにして行われます。

1. 青木君が正整数 $ K_i $ を指定する。
2. 青木君の指定した $ K_i $ を聞いた後、高橋君は $ 1 $ 以上 $ N $ 以下の整数 $ S_i $ を選び、黒板に書く。
3. その後、 $ K_i $ 回次の操作を繰り返す。
  
  
  - 黒板に $ x $ が書かれているとき、それを消し、$ A_x $ を新しく書く。

$ K_i $ 回の操作の後で黒板に書かれている整数が $ i $ ならば $ i $ 回目のゲームは高橋君の勝ち、そうでないならば青木君の勝ちとなります。  
ここで、$ K_i,S_i $ は $ i=1,2,\ldots,N $ に対して独立に選ぶ事ができます。

両者が、自身が勝つために最善の行動をとったとき、$ N $ 回のゲームのうち高橋君が勝つ回数を求めてください。

## 说明/提示

### 制約

- $ 1\leq\ N\leq\ 2\times\ 10^5 $
- $ 1\leq\ A_i\leq\ N $
- 入力はすべて整数

### Sample Explanation 1

$ 1 $ 回目のゲームにおいて、青木君が $ K_1=2 $ を指定したとき、高橋君は $ S_1 $ として、$ 1,2,3 $ のいずれを選んでも勝つことはできません。 例えば、高橋君が最初に黒板に $ S_1=1 $ と書いたとすると、$ 2 $ 回の操作で黒板に書かれている数は順に $ 1\to\ 2(=A_1) $ 、$ 2\to\ 2(=A_2) $ と変化し、 最終的に黒板に書かれている数は $ 2(\neq\ 1) $ であるため、青木君の勝ちとなります。 一方、$ 2,3 $ 回目のゲームにおいては、青木君の指定した $ K_i $ の値によらず、高橋君はそれぞれ $ 2,3 $ を最初に黒板に書くことで勝つ事ができます。 よって、両者が、自分が勝つために最善の行動をとったとき、高橋君が勝つゲームは $ 2,3 $ 回目の $ 2 $ 回であるため、$ 2 $ を出力します。

### Sample Explanation 2

$ 1 $ 回目のゲームにおいて、高橋君は、青木君が指定した $ K_1 $ が奇数のときは $ 2 $、偶数のときは $ 1 $ を最初に黒板に書く事で勝つ事ができます。 同様に $ 2 $ 回目のゲームにおいても勝つ方法が存在するため、$ 1,2 $ 回目のゲームのいずれでも高橋君は勝利する事ができ、$ 2 $ が答えとなります。

## 样例 #1

### 输入

```
3
2 2 3```

### 输出

```
2```

## 样例 #2

### 输入

```
2
2 1```

### 输出

```
2```

# AI分析结果



# [ABC296E] Transition Game

## 题目描述

给定长度为 $N$ 的数列 $A=(A_1,A_2,\ldots,A_N)$，其中每个元素满足 $1\leq A_i\leq N$。

高桥君与青木君进行 $N$ 轮游戏，第 $i$ 轮流程如下：
1. 青木君指定正整数 $K_i$
2. 高桥君选择初始值 $S_i$（$1\leq S_i\leq N$）
3. 执行 $K_i$ 次操作：将当前值 $x$ 替换为 $A_x$
4. 最终结果为 $i$ 时高桥君胜，否则青木君胜

求双方采取最优策略时，高桥君获胜的最大轮数。

## 算法分类
图论（基环树/环检测）

---

## 题解综合分析

### 核心思路
将问题建模为有向图（$i \rightarrow A_i$），形成内向基环树森林。高桥君获胜的充要条件是目标点 $i$ 在环上，此时无论青木君如何设置 $K_i$，高桥君都能选择合适的初始值 $S_i$ 使得经过任意步数后命中目标。

### 解决难点
1. **环的判定**：采用拓扑排序剥离非环节点，剩余节点必在环上
2. **最优策略理解**：青木君会试图设置无法达成目标的 $K_i$，而环结构能保证存在无限多满足条件的步长

---

## 精选题解（评分≥4星）

### 题解1（fengqiao17，★★★★☆）
**亮点**：
- 使用拓扑排序统计非环节点数
- 清晰注释与队列操作演示
- 时间复杂度 $O(N)$

**关键代码**：
```cpp
int kahn(int n) {
    int ans = 0;
    for (int i = 1; i <= n; i++) 
        if (cnt[i] == 0) q.push(i);
    while (!q.empty()) {
        int o = q.front(); q.pop();
        ans++;
        if (--cnt[a[o]] == 0) q.push(a[o]);
    }
    return ans; 
}
// 输出 n - kahn(n)
```

### 题解2（Register_int，★★★★★）
**亮点**：
- 极致简洁的实现（仅18行）
- 直接操作入度数组，省去显式建图
- 完美处理自环情况

**关键代码**：
```cpp
void toposort() {
    queue<int> q;
    for(int i=1;i<=n;i++) if(!deg[i]) q.push(i);
    while(!q.empty()) {
        int u = q.front(); q.pop();
        if(!--deg[a[u]]) q.push(a[u]);
    }
}
// 统计deg[i]>0的节点数
```

---

## 关键技巧总结
1. **拓扑判环法**：通过不断剥离入度为0的节点，剩余节点必构成环
2. **内向基环树性质**：每个节点出度恰为1，确保拓扑后非环节点完全消除
3. **逆向思维**：计算不可行节点数，用总数相减得到环节点数

---

## 拓展应用
同类问题推荐：
1. [P2661 信息传递](https://www.luogu.com.cn/problem/P2661) - 最小环检测
2. [P3533 巡逻](https://www.luogu.com.cn/problem/P3533) - 基环树动态规划 
3. [P5022 旅行](https://www.luogu.com.cn/problem/P5022) - 基环树遍历

---

## 调试心得摘录
"当目标点不在环上时，令 $K$ 趋近无穷大必然无法命中" —— Melo_DDD  
（要点：环结构保证了周期性的可达性，非环节点最终会陷入环但无法回溯）

---
处理用时：51.32秒
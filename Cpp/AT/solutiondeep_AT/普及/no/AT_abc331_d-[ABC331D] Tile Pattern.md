# 题目信息

# [ABC331D] Tile Pattern

## 题目描述

[problemUrl]: https://atcoder.jp/contests/abc331/tasks/abc331_d

縦横 $ 10^9 $ マスのグリッドがあります。上から $ i\ +\ 1 $ 行目、左から $ j\ +\ 1 $ 列目 $ (0\ \leq\ i,\ j\ \lt\ 10^9) $ にあるマスを $ (i,\ j) $ と呼びます。(通常と異なる index の割り当て方に注意してください。)  
 各マスは黒マスか白マスのいずれかです。マス $ (i,\ j) $ の色は文字 $ P[i\ \bmod\ N][j\ \bmod\ N] $ によって表されて、`B` ならばマス $ (i,\ j) $ は黒マス、`W` ならば白マスです。ここで $ a\ \bmod\ b $ は $ a $ を $ b $ で割った余りを意味します。

$ Q $ 個のクエリが与えられるので順に処理してください。  
 各クエリでは $ 4 $ つの整数 $ A,\ B,\ C,\ D $ が与えられるので、$ (A,\ B) $ を左上隅、$ (C,\ D) $ を右下隅とする長方形領域に含まれる黒マスの個数を求めてください。

## 说明/提示

### 制約

- $ 1\ \leq\ N\ \leq\ 1000 $
- $ P[i][j] $ は `W` または `B`
- $ 1\ \leq\ Q\ \leq\ 2\ \times\ 10^5 $
- $ 0\ \leq\ A\ \leq\ C\ \lt\ 10^9 $
- $ 0\ \leq\ B\ \leq\ D\ \lt\ 10^9 $
- $ N,\ Q,\ A,\ B,\ C,\ D $ は全て整数
 
### Sample Explanation 1

グリッドの左上部分を図示すると次の図のようになります。 !\[image\](https://img.atcoder.jp/abc331/2c3ff3c4018817a0839f1fbe0e7c431d.jpg) $ 1 $ 番目のクエリについて、$ (1,\ 2) $ を左上隅、$ (3,\ 4) $ を右下隅とする長方形領域は図の赤い枠線に囲まれた部分で、領域に含まれる黒マスの個数は $ 4 $ 個です。 $ 2 $ 番目のクエリについて、$ (0,\ 3) $ を左上隅、$ (4,\ 5) $ を右下隅とする長方形領域は図の青い枠線に囲まれた部分で、領域に含まれる黒マスの個数は $ 7 $ 個です。

## 样例 #1

### 输入

```
3 2

WWB

BBW

WBW

1 2 3 4

0 3 4 5```

### 输出

```
4

7```

## 样例 #2

### 输入

```
10 5

BBBWWWBBBW

WWWWWBBBWB

BBBWBBWBBB

BBBWWBWWWW

WWWWBWBWBW

WBBWBWBBBB

WWBBBWWBWB

WBWBWWBBBB

WBWBWBBWWW

WWWBWWBWWB

5 21 21 93

35 35 70 43

55 72 61 84

36 33 46 95

0 0 999999999 999999999```

### 输出

```
621

167

44

344

500000000000000000```

# AI分析结果



### 题目内容
#### [ABC331D] Tile Pattern

##### 题目描述  
有一个 $10^9 \times 10^9$ 的网格。网格的每个格子颜色由 $n \times n$ 的基准图案 $P$ 周期性平铺得到。具体来说，格子 $(i,j)$ 的颜色由 $P[i \bmod n][j \bmod n]$ 决定（索引从 0 开始）。  
给定 $Q$ 个查询，每个查询给出矩形区域的左上角 $(A,B)$ 和右下角 $(C,D)$，要求计算该区域内黑色格子（标记为 'B'）的数量。  

##### 输入格式  
- 第一行输入 $n$ 和 $Q$  
- 接下来 $n$ 行输入基准图案 $P$  
- 接下来 $Q$ 行每行四个整数 $A,B,C,D$  

##### 输出格式  
输出每个查询的结果  

##### 样例输入  
```
3 2
WWB
BBW
WBW
1 2 3 4
0 3 4 5
```

##### 样例输出  
```
4
7
```

---

### 算法分类  
**前缀和**

---

### 题解分析与结论  
**核心思路**：  
1. **二维前缀和**预处理基准图案 $P$ 的黑格数量。  
2. 将大矩形分解为：  
   - 完整的 $n \times n$ 区块（重复平铺部分）  
   - 右侧不完整的列余数块  
   - 下方不完整的行余数块  
   - 右下角余数块  
3. 通过公式组合各部分贡献，利用容斥原理计算最终结果。  

**解决难点**：  
- 余数部分的边界处理需要仔细推导  
- 大数除法取模时的数学关系需准确建模  

---

### 精选题解  
#### 1. wmrqwq（★★★★☆）  
**关键亮点**：  
- 使用二维前缀和公式清晰分解区块贡献  
- 代码中通过 `f(x,y)` 函数统一计算任意点 $(x,y)$ 的前缀和  
- 处理余数部分时采用分块乘法，逻辑简洁  

**核心代码**：  
```cpp
long long f(long long x, long long y) {
    if (x <= n && y <= n) return sum[x][y];
    return (x/n)*(y/n)*sum[n][n] + (y/n)*sum[x%n][n] + (x/n)*sum[n][y%n] + sum[x%n][y%n];
}
// 查询时利用容斥：f(C,D)-f(A-1,D)-f(C,B-1)+f(A-1,B-1)
```

#### 2. Phartial（★★★★★）  
**关键亮点**：  
- 坐标从 0 开始处理，直接映射基准图案索引  
- 预处理时先按行后按列累计前缀和，减少边界判断  
- 数学公式推导严谨，余数部分计算无冗余  

**核心代码**：  
```cpp
LL Q(int x, int y) {
    if (x < 0 || y < 0) return 0;
    return s[n-1][n-1]*(x/n)*(y/n) + s[n-1][y%n]*(x/n) + s[x%n][n-1]*(y/n) + s[x%n][y%n];
}
// 查询时同样使用容斥公式
```

---

### 关键思路总结  
1. **二维前缀和优化**：预处理基准图案的二维前缀和数组，用于快速计算任意子矩阵的黑格数量。  
2. **分块贡献计算**：将大矩形分解为完整区块、行余数、列余数、角落余数四部分，分别计算贡献后合并。  
3. **数学建模**：利用整数除法求完整区块数，模运算求余数部分，通过乘积关系组合各部分结果。  

---

### 拓展练习  
1. [P2004 领地选择](https://www.luogu.com.cn/problem/P2004)  
   - 二维前缀和最值应用  
2. [P2280 激光炸弹](https://www.luogu.com.cn/problem/P2280)  
   - 二维前缀和配合滑动窗口  
3. [P3397 地毯](https://www.luogu.com.cn/problem/P3397)  
   - 二维差分与前缀和的转换应用  

---

### 心得摘录  
> "调试时画图辅助理解余数区块的切割方式，特别是当行列余数同时存在时，容易漏算角落的小块。" —— 来自题解中的调试经验  
> "发现将坐标统一平移+1处理（如从0-index改为1-index）可以显著减少边界条件的判断。" —— 坐标处理技巧

---
处理用时：54.17秒
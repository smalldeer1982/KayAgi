# 题目信息

# [ABC338D] Island Tour

## 题目描述

[problemUrl]: https://atcoder.jp/contests/abc338/tasks/abc338_d

AtCoder 諸島は $ N $ 個の島からなり、これらの島々は $ N $ 本の橋によって結ばれています。 島には $ 1 $ から $ N $ までの番号が付けられていて、$ i\ (1\leq\ i\leq\ N-1) $ 本目の橋は島 $ i $ と島 $ i+1 $ を、$ N $ 本目の橋は島 $ N $ と島 $ 1 $ を双方向に結んでいます。 橋を渡る以外に島の間を行き来する方法は存在しません。

AtCoder 諸島では、島 $ X_1 $ から始めて島 $ X_2,X_3,\dots,X_M $ を順に訪れる**ツアー**が定期的に催行されています。 移動の過程で訪れる島とは別の島を経由することもあり、ツアー中に橋を通る回数の合計がツアーの**長さ**と定義されます。

厳密には、**ツアー**とは以下の条件を全て満たす $ l+1 $ 個の島の列 $ a_0,a_1,\dots,a_l $ のことであり、その**長さ** は $ l $ として定義されます。

- 全ての $ j\ (0\leq\ j\leq\ l-1) $ について、島 $ a_j $ と島 $ a_{j+1} $ は橋で直接結ばれている
- ある $ 0\ ＝\ y_1\ <\ y_2\ <\ \dots\ <\ y_M\ =\ l $ が存在して、全ての $ k\ (1\leq\ k\leq\ M) $ について $ a_{y_k}\ =\ X_k $

財政難に苦しむ AtCoder 諸島では、維持費削減のため橋を $ 1 $ 本封鎖することになりました。 封鎖する橋をうまく選んだとき、ツアーの長さの最小値がいくつになるか求めてください。

## 说明/提示

### 制約

- $ 3\leq\ N\ \leq\ 2\times\ 10^5 $
- $ 2\leq\ M\ \leq\ 2\times\ 10^5 $
- $ 1\leq\ X_k\leq\ N $
- $ X_k\neq\ X_{k+1}\ (1\leq\ k\leq\ M-1) $
- 入力は全て整数

### Sample Explanation 1

\- $ 1 $ 本目の橋を封鎖した場合：通る島の列として $ (a_0,a_1,a_2)=(1,3,2) $ を取ることで島 $ 1,3,2 $ を順に訪れることができ、長さ $ 2 $ のツアーが催行できます。これより短いツアーは存在しません。 - $ 2 $ 本目の橋を封鎖した場合：通る島の列として $ (a_0,a_1,a_2,a_3)=(1,3,1,2) $ を取ることで島 $ 1,3,2 $ を順に訪れることができ、長さ $ 3 $ のツアーが催行できます。これより短いツアーは存在しません。 - $ 3 $ 本目の橋を封鎖した場合：通る島の列として $ (a_0,a_1,a_2,a_3)=(1,2,3,2) $ を取ることで島 $ 1,3,2 $ を順に訪れることができ、長さ $ 3 $ のツアーが催行できます。これより短いツアーは存在しません。 よって、封鎖する橋をうまく選んだときのツアーの長さの最小値は $ 2 $ です。 以下の図は左から順に橋 $ 1,2,3 $ を封鎖した場合を表し、数字の書かれた丸が島、丸同士を結ぶ線が橋、青い矢印が最短のツアーの経路を表します。 !\[\](https://img.atcoder.jp/abc338/ad4a27665d9da939ab495acd3d05181a.png)

### Sample Explanation 2

$ X_1,X_2,\dots,X_M $ の中に同じ島が複数回現れることもあります。

## 样例 #1

### 输入

```
3 3
1 3 2```

### 输出

```
2```

## 样例 #2

### 输入

```
4 5
2 4 2 4 2```

### 输出

```
8```

## 样例 #3

### 输入

```
163054 10
62874 19143 77750 111403 29327 56303 6659 18896 64175 26369```

### 输出

```
390009```

# AI分析结果

### 题目内容重写
AtCoder 诸岛由 $N$ 个岛屿组成，这些岛屿通过 $N$ 座桥连接。岛屿编号为 $1$ 到 $N$，第 $i$ 座桥（$1 \leq i \leq N-1$）连接岛屿 $i$ 和 $i+1$，第 $N$ 座桥连接岛屿 $N$ 和 $1$。除了通过桥之外，没有其他方式在岛屿之间移动。

AtCoder 诸岛定期举办从岛屿 $X_1$ 开始，依次访问岛屿 $X_2, X_3, \dots, X_M$ 的**旅游**。在移动过程中，可能会经过其他岛屿，旅游的**长度**定义为旅游过程中经过的桥的总次数。

严格来说，**旅游**是一个满足以下条件的 $l+1$ 个岛屿的序列 $a_0, a_1, \dots, a_l$，其**长度**定义为 $l$：

- 对于所有 $j$（$0 \leq j \leq l-1$），岛屿 $a_j$ 和 $a_{j+1}$ 直接通过桥连接。
- 存在 $0 = y_1 < y_2 < \dots < y_M = l$，使得对于所有 $k$（$1 \leq k \leq M$），$a_{y_k} = X_k$。

由于财政困难，AtCoder 诸岛决定封锁一座桥以减少维护费用。请选择封锁的桥，使得旅游的长度最小，并输出这个最小值。

### 题解分析与结论
该题目要求在一个环形图中，删除一条边后，使得按给定顺序访问一系列节点的路径长度最小。题解主要思路是通过差分或线段树等数据结构，计算删除每条边后对路径长度的影响，最终选择影响最小的边。

#### 关键思路与技巧
1. **差分优化**：通过差分数组记录删除每条边后路径长度的变化，最后通过前缀和计算每条边的总影响。
2. **路径选择**：对于每对相邻节点，计算两条路径的长度差，并根据路径选择更新差分数组。
3. **最小化影响**：最终选择影响最小的边，输出最短路径长度。

### 评分较高的题解
#### 1. 作者：spfa_ (4星)
- **关键亮点**：使用差分优化，详细解释了路径选择的两种情况，并通过差分数组快速计算每条边的影响。
- **代码实现**：
  ```cpp
  void add(int l, int r, int k) { c[l] += k, c[r+1] -= k; }
  ```
  通过差分数组 `c` 记录区间加操作，最后通过前缀和计算每条边的总影响。

#### 2. 作者：yyrwlj (4星)
- **关键亮点**：详细解释了路径选择的两种情况，并通过差分数组快速计算每条边的影响，代码简洁清晰。
- **代码实现**：
  ```cpp
  if (d1[i] < d2[i]) {
      d[x[i]] += tmp;
      if (x[i] < x[i + 1]) d[x[i + 1]] -= tmp;
      else { d[1] += tmp; d[x[i + 1]] -= tmp; }
  }
  ```
  通过差分数组 `d` 记录路径选择的影响，最后通过前缀和计算每条边的总影响。

#### 3. 作者：__Dist__ (4星)
- **关键亮点**：使用差分优化，详细解释了路径选择的两种情况，并通过差分数组快速计算每条边的影响，代码简洁清晰。
- **代码实现**：
  ```cpp
  auto add = [&] (int from, int to, int num) {
      if (from <= to) { v[from + 1] += num; v[to + 1] -= num; }
      else { v[from + 1] += num; v[n + 1] -= num; v[1] += num; v[to + 1] -= num; }
  };
  ```
  通过差分数组 `v` 记录路径选择的影响，最后通过前缀和计算每条边的总影响。

### 推荐题目
1. [P3372 【模板】线段树 1](https://www.luogu.com.cn/problem/P3372) - 线段树基础题，适合练习区间修改与查询。
2. [P3368 【模板】树状数组 1](https://www.luogu.com.cn/problem/P3368) - 树状数组基础题，适合练习区间修改与查询。
3. [P3384 【模板】树链剖分](https://www.luogu.com.cn/problem/P3384) - 树链剖分基础题，适合练习树上路径的修改与查询。

### 个人心得
- **调试经历**：在处理环形图的差分时，需要注意区间跨过环的起点和终点的情况，避免遗漏或重复计算。
- **顿悟感想**：通过差分数组可以高效地处理区间加操作，尤其是在需要频繁进行区间修改和单点查询的场景中，差分数组的优势非常明显。

---
处理用时：41.66秒
# 题目信息

# [ABC345E] Colorful Subsequence

## 题目描述

[problemUrl]: https://atcoder.jp/contests/abc345/tasks/abc345_e

$ N $ 個のボールが左右一列に並んでいます。  
左から $ i $ $ (1\leq\ i\leq\ N) $ 番目のボールは色 $ C_i $ で、価値は $ V_i $ です。

高橋君はこの列から **ちょうど** $ K $ 個のボールを取り除いたうえで、 残ったボールを元の順番で並べたときに同じ色のボールが隣り合わないようにしたいと考えています。 また、その条件のもとで、列に残ったボールの価値の総和をなるべく大きくしたいと考えています。

高橋君が、残ったボールの列において同じ色のボールが隣り合わないように $ K $ 個のボールを取り除くことができるか判定し、 できる場合は列に残ったボールの価値の総和としてあり得る最大の値を求めてください。

## 说明/提示

### 制約

- $ 1\leq\ K\ <\ N\leq\ 2\times\ 10^5 $
- $ K\leq\ 500 $
- $ 1\leq\ C_i\leq\ N $
- $ 1\leq\ V_i\leq\ 10^9 $
- 入力はすべて整数

### Sample Explanation 1

左から、$ 3,5 $ 番目のボールを取り除くと、残ったボールは左から順に色 $ 1,3,1 $ であるため、 どの隣り合う $ 2 $ つのボールの色も異なり、条件をみたしています。 このとき、列に残ったボールの価値の和は $ V_1+V_2+V_4=1+5+4=10 $ です。 他にも $ 5 $ つのボールから $ 2 $ つのボールを取り除く方法であって、同じ色のボールが隣り合わないようにできるものは存在しますが、 $ 3,5 $ 番目のボールを取り除いた時に残ったボールの価値の和は最大となります。 よって、$ 10 $ を出力します。

### Sample Explanation 2

どのようにボールを $ 1 $ つ取り除いても色 $ 1 $ のボールが隣り合ってしまいます。 よって、 $ -1 $ を出力します。

### Sample Explanation 3

必ずちょうど $ K $ 個のボールを取り除く必要があることに注意してください。

## 样例 #1

### 输入

```
5 2
1 1
3 5
3 3
1 4
1 2```

### 输出

```
10```

## 样例 #2

### 输入

```
3 1
1 10
1 10
1 10```

### 输出

```
-1```

## 样例 #3

### 输入

```
3 1
1 1
2 2
3 3```

### 输出

```
5```

# AI分析结果



0. **题目翻译**

# [ABC345E] 彩色子序列

## 题目描述

[problemUrl]: https://atcoder.jp/contests/abc345/tasks/abc345_e

$ N $ 个球排成一列。  
左数第 $ i $ $ (1\leq\ i\leq\ N) $ 个球的颜色是 $ C_i $，价值是 $ V_i $。

高桥君需要从这列球中**恰好**移除 $ K $ 个球，使得剩下的球按原顺序排列时，相邻的球颜色不同。同时，在满足条件的前提下，他希望剩余球的总价值尽可能大。

请判断是否存在满足条件的移除方式，如果存在则输出最大总价值，否则输出 $ -1 $。

## 说明/提示

### 数据范围

- $ 1\leq\ K\ <\ N\leq\ 2\times\ 10^5 $
- $ K\leq\ 500 $
- $ 1\leq\ C_i\leq\ N $
- $ 1\leq\ V_i\leq\ 10^9 $
- 输入均为整数

### 样例解释 1

移除第 3、5 号球后，剩余球颜色为 $ 1,3,1 $，满足相邻颜色不同。此时总价值为 $ 1+5+4=10 $。其他移除方式无法获得更大值，故输出 $ 10 $。

### 样例解释 2

无论移除哪个球，都会存在相邻的 $ 1 $ 号颜色球，输出 $ -1 $。

### 样例解释 3

必须恰好移除 $ K $ 个球（即使不移除也能满足条件也要强制移除）。

---

1. **唯一算法分类**  
**线性DP**

---

2. **综合分析与结论**  
**核心思路**：设计动态规划状态 $ f(i,j) $ 表示前 $ i $ 个球保留 $ j $ 个且保留第 $ i $ 个球时的最大价值。通过维护**颜色差异的最优解**和**次优解**，实现 $ O(NK) $ 时间复杂度的转移。

**关键难点**：
- 颜色冲突约束下的高效状态转移
- 处理必须恰好删除 $ K $ 个球的边界条件

**解决方案**：
- 为每个状态维护最大值和次大值，记录对应颜色
- 滚动数组优化空间复杂度
- 在序列末尾添加虚拟球处理边界情况

**可视化设计**：
- 动态绘制二维DP表格，高亮当前处理的球编号和保留数量
- 用不同颜色标记最优解（金色）和次优解（银色）
- 当检测到颜色冲突时，触发红色闪烁提示
- 音效设计：转移成功时播放金币音效，冲突时播放警示音

---

3. **题解清单 (≥4星)**  
**Phartial（5星）**  
- 亮点：滚动数组优化 + 双极值维护
- 代码简洁，时间复杂度严格 $ O(NK) $

**KingPowers（4.5星）**  
- 亮点：虚拟末尾球处理边界情况
- 状态转移设计巧妙，代码可读性高

**Liyunze123（4星）**  
- 亮点：详细状态转移分析
- 包含初始化注意事项和 long long 提醒

---

4. **最优思路与代码实现**  
**核心技巧**：维护双极值结构体，记录最大值及其颜色：

```cpp
struct MaxSec {
    ll mx, id, sec;
    void insert(ll x, int p) {
        if (id == p) mx = max(mx, x);
        else if (x > mx) {
            sec = mx;
            mx = x;
            id = p;
        } else if (x > sec) sec = x;
    }
    ll query(int p) { return (p == id) ? sec : mx; }
};
```

**完整代码（Phartial 解法）**：
```cpp
#include <algorithm>
#include <iostream>
using namespace std;
using LL = long long;
const int kN = 2e5 + 1;

int n, k, c[kN], a[kN];
LL f[kN];

int main() {
  ios_base::sync_with_stdio(0), cin.tie(0);
  cin >> n >> k;
  for (int i = 1; i <= n; ++i) cin >> c[i] >> a[i];
  fill_n(f + 1, n, -1e18);
  for (int j = 1; j <= n - k; ++j) {
    LL m = f[j - 1], _m = -1e18;
    int cm = c[j - 1];
    for (int i = j; i <= j + k; ++i) {
      LL _f = f[i];
      if (c[i] != cm) {
        f[i] = m + a[i];
        if (_f >= m) _m = m, m = _f, cm = c[i];
        else if (_f > _m) _m = _f;
      } else {
        f[i] = _m + a[i];
        if (_f > m) m = _f;
      }
    }
  }
  LL ans = -1;
  for (int i = n - k; i <= n; ++i) ans = max(ans, f[i]);
  cout << (ans < 0 ? -1 : ans);
}
```

---

5. **同类型题推荐**  
- [CF118D - Caesar's Legions](https://codeforces.com/problemset/problem/118/D)（线性DP+双计数约束）
- [LeetCode 1155. 掷骰子的N种方法](https://leetcode.cn/problems/number-of-dice-rolls-with-target-sum/)（带模数约束的线性DP）
- [洛谷P1273 有线电视网](https://www.luogu.com.cn/problem/P1273)（树形DP结合线性特性）

---

6. **可视化与游戏化设计**  
**像素风格实现**：
- 使用 16 色调色板，DP 矩阵用 8x8 像素块表示
- 转移动画：当前球从左到右扫描，保留数量从上到下更新
- 音效触发规则：
  - 成功转移：8-bit 上升音阶（频率 523Hz）
  - 颜色冲突：短促噪音（频率 200Hz）
  - 更新最优解：金币收集音效

**AI 演示模式**：
```javascript
function autoPlay() {
  let step = 0;
  const timer = setInterval(() => {
    if (step >= n) clearInterval(timer);
    updateDP(step++); // 模拟DP更新
    renderCanvas();   // 重绘像素矩阵
  }, 300);
}
```

---

7. **调试心得摘录**  
> "最初忘记滚动数组会导致 MLE，后来发现只需保留前一列状态。次优解维护需要严格颜色判等，漏掉一个判断就会 WA。" —— Phartial

> "添加虚拟球后，所有合法解必须包含该球，巧妙规避了末尾边界问题。" —— KingPowers

---

**通过上述分析，本题的核心在于动态规划的状态设计与双极值优化技巧，配合精细的颜色冲突处理，最终在严格的复杂度限制下完成高效求解。**

---
处理用时：89.10秒
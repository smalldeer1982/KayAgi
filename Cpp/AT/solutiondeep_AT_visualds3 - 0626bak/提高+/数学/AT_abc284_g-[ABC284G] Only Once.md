# 题目信息

# [ABC284G] Only Once

## 题目描述

[problemUrl]: https://atcoder.jp/contests/abc284/tasks/abc284_g

$ 1 $ 以上 $ N $ 以下の整数からなる長さ $ N $ の数列 $ A\ =\ (A_1,A_2,\dots,A_N) $ および整数 $ i\ (1\leq\ i\ \leq\ N) $ に対して、 長さ $ 10^{100} $ の数列 $ B_i=(B_{i,1},B_{i,2},\dots,B_{i,10^{100}}) $ を以下のように定義します。

- $ B_{i,1}=i $
- $ B_{i,j+1}=A_{B_{i,j}}\ (1\leq\ j\ <\ 10^{100}) $
 
また、$ S_i $ を「数列 $ B_i $ のなかでちょうど $ 1 $ 度だけ出てくる数の種類数」と定義します。 より厳密には、$ S_i $ は「$ B_{i,j}=k $ を満たす $ j\ (1\leq\ j\leq\ 10^{100}) $ がちょうど $ 1 $ つであるような $ k $ の数」です。

整数 $ N $ が与えられます。数列 $ A $ として考えられるものは $ N^N $ 通りありますが、それら全てに対して $ \displaystyle\ \sum_{i=1}^{N}\ S_i $ を求め、 その総和を $ M $ で割った余りを答えてください。

## 说明/提示

### 制約

- $ 1\leq\ N\ \leq\ 2\times\ 10^5 $
- $ 10^8\leq\ M\ \leq\ 10^9 $
- $ N,M $ は整数
 
### Sample Explanation 1

例として、$ A=(2,3,3,4) $ の場合を考えます。 - $ i=1 $ のとき : $ B_1=(1,2,3,3,3,\dots) $ となるから、$ 1 $ 度だけ出てくる数は $ 1,2 $ の $ 2 $ つで、$ S_1=2 $ - $ i=2 $ のとき : $ B_2=(2,3,3,3,\dots) $ となるから、$ 1 $ 度だけ出てくる数は $ 2 $ のみで、$ S_2=1 $ - $ i=3 $ のとき : $ B_3=(3,3,3,\dots) $ となるから、$ 1 $ 度だけ出てくる数は存在せず、$ S_3=0 $ - $ i=4 $ のとき : $ B_4=(4,4,4,\dots) $ となるから、$ 1 $ 度だけ出てくる数は存在せず、$ S_4=0 $ よって、$ \displaystyle\ \sum_{i=1}^{N}\ S_i=2+1+0+0=3 $ です。 他の $ 255 $ 通りの $ A $ に対しても同様に $ \displaystyle\ \sum_{i=1}^{N}\ S_i $ を計算したうえで、 $ 256 $ 通り全ての総和をとると $ 624 $ になります。

### Sample Explanation 3

総和を $ M $ で割った余りを出力してください。

## 样例 #1

### 输入

```
4 100000000```

### 输出

```
624```

## 样例 #2

### 输入

```
7 1000000000```

### 输出

```
5817084```

## 样例 #3

### 输入

```
2023 998244353```

### 输出

```
737481389```

## 样例 #4

### 输入

```
100000 353442899```

### 输出

```
271798911```

# AI分析结果



## 算法分类
组合数学

## 题解思路与解决难点
该题的核心在于将问题转化为基环树结构，利用排列数和幂次快速计算所有可能链结构的贡献。关键步骤如下：

1. **对称性转换**：每个节点的贡献相同，总答案为单个节点贡献的n倍。
2. **链结构分析**：对于链长l，其贡献为排列数A(n-1, l-1)（选择链节点的方式数）乘以n^{n-l}（剩余节点的自由选择方式）再乘l*(l-1)/2（链上每个位置的可能贡献之和）。
3. **递推优化**：通过预处理n的幂次和排列数的递推计算，将时间复杂度优化至O(n)。

## 关键公式推导
总答案公式：
$$
\text{ans} = n \times \sum_{l=1}^{n} \frac{l(l-1)}{2} \times A(n-1, l-1) \times n^{n-l}
$$
其中A(n-1, l-1)为排列数，表示从n-1个元素中选l-1个的排列方式。

## 题解评分
1. **zac2010（5星）**  
   - 思路清晰，代码简洁，直接应用推导公式。
   - 预处理幂次和排列数，O(n)时间复杂度。
   - 代码可读性强，容易理解和实现。

2. **joke3579（4星）**  
   - 正确应用排列数和快速幂，代码简洁。
   - 缺乏详细注释，但逻辑清晰。

3. **DaiRuiChen007（3星）**  
   - 公式推导存在错误，代码预处理方式导致错误结果。
   - 不推荐参考。

## 最优代码实现
```cpp
#include <bits/stdc++.h>
using namespace std;

int main() {
    int n, m;
    scanf("%d%d", &n, &m);
    vector<int> pn(n + 1);
    pn[0] = 1;
    for (int i = 1; i <= n; i++) 
        pn[i] = 1LL * pn[i - 1] * n % m;
    int ans = 0, a = 1;
    for (int l = 1; l <= n; l++) {
        ans = (ans + 1LL * a * pn[n - l] % m * (1LL * l * (l - 1) / 2 % m)) % m;
        a = 1LL * a * (n - l) % m;
    }
    printf("%lld\n", 1LL * ans * n % m);
    return 0;
}
```

## 同类型题目套路
- **基环树结构计数**：常通过排列组合分析链与环的结构。
- **对称性简化**：利用对称性将总问题转化为单点问题。
- **递推与预处理**：快速计算排列数和幂次，避免重复计算。

## 推荐题目
1. [P3977 [TJOI2015]棋盘](https://www.luogu.com.cn/problem/P3977)  
2. [P4921 [MtOI2018]情侣？给我烧了！](https://www.luogu.com.cn/problem/P4921)  
3. [P4099 [HEOI2013]SAO](https://www.luogu.com.cn/problem/P4099)  

## 可视化算法演示
### 核心数学过程动画方案
- **步骤分解**：  
  1. **初始化**：展示n=4的节点，初始链长为0。  
  2. **选择链节点**：逐步添加节点到链上，计算排列数A(n-1, l-1)。  
  3. **计算剩余节点**：显示n^{n-l}的幂次计算。  
  4. **贡献求和**：高亮当前链长的贡献l*(l-1)/2，并累加到总答案。  

- **颜色标记**：  
  - 当前链节点用绿色标记。  
  - 自由选择节点用蓝色标记。  
  - 当前计算部分用红色边框突出。  

- **步进控制**：用户可调整速度或单步执行，观察每个链长的贡献计算过程。

### 复古像素风格设计
- **8位像素UI**：使用16色调色板，节点用像素方块表示，链生长时播放经典音效。  
- **背景音乐**：循环播放8位风格背景音乐，计算完成时播放胜利音效。  
- **自动演示**：AI自动遍历所有链长，动态显示公式各部分的数值变化。  

通过交互式动画，直观展示组合数与幂次的计算逻辑，帮助理解基环树结构的数学推导。

---
处理用时：277.20秒
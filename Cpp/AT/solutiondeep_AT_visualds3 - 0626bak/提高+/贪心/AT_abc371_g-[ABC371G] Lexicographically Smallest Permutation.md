# 题目信息

# [ABC371G] Lexicographically Smallest Permutation

## 题目描述

[problemUrl]: https://atcoder.jp/contests/abc371/tasks/abc371_g

$ (1,2,\ldots,N) $ の並べ替え $ P=(P\ _\ 1,P\ _\ 2,\ldots,P\ _\ N),A=(A\ _\ 1,A\ _\ 2,\ldots,A\ _\ N) $ が与えられます。

あなたは、次の操作を $ 0 $ 回以上好きな回数行うことができます。

- $ i=1,2,\ldots,N $ に対して**一斉に** $ A\ _\ i $ を $ A\ _\ {P\ _\ i} $ で置き換える。
 
得られる $ A $ としてありえるもののうち、辞書順で最小のものを出力してください。

 辞書順の大小とは？ 長さ $ N $ の列 $ A=(A\ _\ 1,A\ _\ 2,\ldots,A\ _\ N),B=(B\ _\ 1,B\ _\ 2,\ldots,B\ _\ N) $ について、辞書順で $ A $ が $ B $ より小さいとは、次のことが成り立つことをいいます。

- ある整数 $ i\ (1\leq\ i\leq\ N) $ が存在し、$ A\ _\ i\lt\ B\ _\ i $ が成り立ち、$ 1\leq\ j\lt\ i $ を満たすすべての整数 $ j $ に対して $ A\ _\ j=B\ _\ j $ が成り立つ。

## 说明/提示

### 制約

- $ 1\leq\ N\leq2\times10\ ^\ 5 $
- $ 1\leq\ P\ _\ i\leq\ N\ (1\leq\ i\leq\ N) $
- $ P\ _\ i\neq\ P\ _\ j\ (1\leq\ i\lt\ j\leq\ N) $
- $ 1\leq\ A\ _\ i\leq\ N\ (1\leq\ i\leq\ N) $
- $ A\ _\ i\neq\ A\ _\ j\ (1\leq\ i\lt\ j\leq\ N) $
- 入力はすべて整数
 
### Sample Explanation 1

はじめ、$ A=(4,3,1,6,2,5) $ です。 ここから操作を繰り返すと、以下のようになります。 - $ A=(1,4,2,5,3,6) $ となる。 - $ A=(2,1,3,6,4,5) $ となる。 - $ A=(3,2,4,5,1,6) $ となる。 - $ A=(4,3,1,6,2,5) $ となる。 以降、$ 4 $ 回操作を行うたびにもとの $ A $ に戻ります。 よって、このうち辞書順で最小である `1 4 2 5 3 6` を出力してください。

### Sample Explanation 2

$ 1 $ 度も操作をしなくても構いません。

## 样例 #1

### 输入

```
6

3 1 5 6 2 4

4 3 1 6 2 5```

### 输出

```
1 4 2 5 3 6```

## 样例 #2

### 输入

```
8

3 5 8 7 2 6 1 4

1 2 3 4 5 6 7 8```

### 输出

```
1 2 3 4 5 6 7 8```

## 样例 #3

### 输入

```
26

24 14 4 20 15 19 16 11 23 22 12 18 21 3 6 8 26 2 25 7 13 1 5 9 17 10

15 3 10 1 13 19 22 24 20 4 14 23 7 26 25 18 11 6 9 12 2 21 5 16 8 17```

### 输出

```
4 1 22 18 20 13 14 6 15 11 3 26 2 12 5 23 9 10 25 24 7 17 16 21 19 8```

# AI分析结果



### 【题解思路与算法要点】

**核心问题**：通过置换操作使数组字典序最小，关键在置换环结构与操作次数的同余约束。

**算法要点**：
1. **置换环分解**：将排列P分解为多个不相交的环。
2. **贪心选择策略**：对每个环，选择最小元素作为起点，但需满足与先前环的模数约束。
3. **同余条件维护**：记录每个环操作次数的模约束，确保后续环的选择不冲突。

**解决难点**：
- **模数爆炸**：直接维护LCM会导致数值过大，采用质因数分解或环长种类限制优化。
- **高效冲突检查**：通过预处理环长因数，或利用环长种类数O(√n)性质，减少检查次数。

---

### 【题解评分 (≥4星)】

1. **rui_er (5星)**  
   - **亮点**：质因数分解预处理，维护每个质因子幂次约束，避免高精度运算，复杂度O(n log n)。
   - **代码清晰度**：模块化分解，预处理因数加速检查。

2. **lnw143 (4.5星)**  
   - **亮点**：利用环长种数O(√n)性质，暴力枚举可行解，实际运行高效。
   - **实践性**：代码简洁，直接枚举环内候选。

3. **Union_Find (4星)**  
   - **亮点**：分解环长质因数后维护约束，通过模数互质性剪枝。
   - **优化点**：代码稍复杂，但核心思路清晰。

---

### 【最优思路提炼】

1. **置换环贪心**：每个环选择最小元素作为起点，前提是操作次数满足模约束。
2. **质因数约束维护**：将环长分解为质因子幂次，记录每个幂次的模约束，避免大数运算。
3. **冲突检查优化**：枚举环内所有可能起点，快速验证是否与已有约束冲突。

**关键代码片段（rui_er）**：
```cpp
rep(i, 1, n) {
    if(!vis[i]) {
        vector<int> cyc;
        // 分解环
        for(int u = i; !vis[u]; u = p[u]) cyc.push_back(u);
        int len = cyc.size();
        // 枚举环内起点s，检查约束
        rep(s, 0, len-1) {
            bool ok = true;
            for(int d : divs[len]) { // 预处理因数
                if(req[d] != -1 && s % d != req[d]) ok = false;
            }
            if(ok) steps = min_arg(a[cyc[s]]);
        }
        // 更新约束
        for(int d : divs[len]) req[d] = steps % d;
    }
}
```

---

### 【同类型题目推荐】

1. **洛谷 P1969**：任务调度（置换环+贪心）
2. **CF1294E**：通过行置换使矩阵字典序最小
3. **AT_arc154_c**：循环位移后字典序最小

---

### 【可视化设计：贪心过程演示】

**动画方案**：
1. **置换环绘制**：Canvas绘制多个颜色环，节点显示数值。
2. **候选高亮**：当前环内候选起点闪烁，显示对应数值。
3. **约束冲突提示**：若选择冲突，显示红色警示并播放错误音效。
4. **自动模式**：AI按贪心策略自动选择，步进展示决策过程。

**复古像素风格**：
- **元素**：8-bit风格置换环，节点为像素方块，数值用点阵字体。
- **音效**：选择时播放“哔”声，冲突时“嗡”声，背景FC音乐循环。

---

### 【总结】

通过分解置换环并维护模约束，实现高效贪心选择。rui_er的质因数预处理法最优，适合大规模数据。可视化可通过复古像素动画直观展示环结构、候选选择与约束冲突，增强学习沉浸感。

---
处理用时：72.40秒
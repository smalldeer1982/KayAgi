# 题目信息

# [ARC186C] Ball and Box

## 题目描述

[problemUrl]: https://atcoder.jp/contests/arc186/tasks/arc186_c

球橋さんと箱木さんはボールと箱を使ったゲームをします。

最初、球橋さんは $ M $ 種類のボールをそれぞれ $ 10^{100} $ 個ずつ持っていて、 箱木さんは $ 10^{100} $ 円持っています。 また、$ N $ 個の箱があり、$ i $ 番目の箱の容量は $ V_i $ で、値段は $ P_i $ 円です。ゲーム中、箱木さんはいつでも好きな箱を買うことができます。

このゲームでは、ゲームが終わるまで以下の操作を繰り返します。

1. 球橋さんはボールを $ 1 $ つ選び、箱木さんに渡す。
2. 箱木さんは渡されたボールを受け取るか、受け取らずにゲームを終えるかを選ぶ。
3. ボールを受け取った場合、箱木さんは購入済みの箱を $ 1 $ つ選び、受け取ったボールを入れる。
4. ボールを入れた箱が以下の条件を満たしている場合、箱木さんは $ 1 $ 円をもらう。そうでない場合、ゲームを終える。
  - 箱の中のボールの個数は、その箱の容量以下である。
  - 箱の中のボールの種類は、すべて同じである。

球橋さんは、ゲーム終了時の箱木さんの所持金がなるべく少なくなるための最適な行動をし、反対に、箱木さんはなるべく多くなるための最適な行動をします。 ゲームを通して、箱木さんの所持金はいくら増えますか？

ただし、両者ともにすべての情報が公開されているとします。特に、球橋さんは、それぞれの箱について、容量と値段、どの種類のボールがいくつ入っているかを見ることができます。 また、箱木さんの初期の所持金は十分多く、お金が足りなくて箱が買えなくなることはないことに注意してください。

$ 1 $ つの入力ファイルにつき、$ T $ 個のテストケースを解いてください。

## 说明/提示

### 制約

- $ 1\le\ T,N,M\le\ 3\times\ 10^5 $
- $ 1\le\ V_i,P_i\ \le\ 10^9 $
- $ T $ 個のテストケースに対する $ N $ の総和は $ 3\times\ 10^5 $ 以下
- 入力はすべて整数

### Sample Explanation 1

最初のテストケースでは $ 2 $ 種類のボールと $ 3 $ つの箱を使います。 $ 2 $ 種類のボールをそれぞれ白のボールと黒のボールと呼び、$ i $ 種類目の箱を箱 $ i $ と呼ぶことにします。 このテストケースについて、所持金が $ 2 $ 円増えるゲームの進み方の例を示します。 1. 球橋さんが白のボールを選び、渡す。 2. 箱木さんはボールを受け取り、箱 $ 2 $ を $ 1 $ 円で買って白のボールを入れる。 - 箱 $ 2 $ には白のボールが $ 1 $ 個入っている。これは条件を満たしているため、箱木さんは $ 1 $ 円をもらう。 3. 球橋さんが白のボールを選び、渡す。 4. 箱木さんはボールを受け取り、箱 $ 2 $ に白のボールを入れる。 - 箱 $ 2 $ には白のボールが $ 2 $ 個入っている。これは条件を満たしているため、箱木さんは $ 1 $ 円をもらう。 5. 球橋さんが黒のボールを選び、渡す。 6. 箱木さんはボールを受け取り、箱 $ 3 $ を $ 1 $ 円で買って黒のボールを入れる。 - 箱 $ 3 $ には黒のボールが $ 1 $ 個入っている。これは条件を満たしているため、箱木さんは $ 1 $ 円をもらう。 7. 球橋さんが白のボールを選び、渡す。 8. 箱木さんはボールを受け取り、箱 $ 2 $ に白のボールを入れる。 - 箱 $ 2 $ には白のボールが $ 3 $ 個入っている。これは条件を満たしているため、箱木さんは $ 1 $ 円をもらう。 9. 球橋さんが白のボールを選び、渡す。 10. 箱木さんは受け取らずにゲームを終えることを選ぶ。 最終的に、箱 $ 2 $ には白のボールが $ 3 $ 個、箱 $ 3 $ には黒のボールが $ 1 $ 個入っています。 合計で $ 2 $ 円使って $ 4 $ 円もらったので、所持金は $ 2 $ 円増えました。 $ 2 $ つめのテストケースでは、球橋さんは、箱木さんにお金を稼がせないような行動ができます。

## 样例 #1

### 输入

```
3
3 2
1 1000000000
3 1
3 1
1 300000
1000000000 1
10 4
22 5
26 45
72 21
47 39
97 2
75 35
82 24
17 46
32 22
28 67```

### 输出

```
2
0
28```

# AI分析结果



### 综合分析与结论

#### 核心思路与贪心策略
该题本质是博弈论中的最优化问题，需结合双方策略确定最终收益。核心贪心策略如下：
1. **初始策略**：箱木必须购买至少 m 个箱子（每种颜色各一个），此时每个箱子放 1 个球。
2. **攻击策略**：球桥会持续攻击容量最小的箱子，迫使箱木不断购买新箱子。
3. **收益结构**：最终状态为前 m-1 个容量最大的箱子各放 1 个球，其余箱子装满。

#### 解决难点与关键点
1. **正确性验证**：需证明最优解必然满足分界条件：所有装满的箱子容量 ≤ 未装满的箱子容量。
2. **高效计算**：需快速维护分界点前后的收益值，涉及前缀和与动态选择最小代价的数据结构。

#### 算法步骤
1. **排序预处理**：将箱子按容量升序排列。
2. **前缀和计算**：预处理每个位置前装满箱子的收益。
3. **后缀维护**：使用优先队列动态维护分界点后最小 P_i 之和。
4. **枚举分界点**：遍历所有可能的分界位置，计算最大收益。

---

### 题解清单（≥4星）

#### 1. Claire0918（4.5星）
- **亮点**：清晰的预处理与堆维护，代码简洁高效。
- **关键代码**：优先队列动态维护最小 P_i 之和，结合前缀和枚举分界点。
- **心得**：强调分界点后箱子的选择逻辑和 m=1 的特判处理。

#### 2. chaeminter2467（4星）
- **亮点**：权值线段树处理动态区间前 m-1 小值，适合大数据场景。
- **关键代码**：动态开点线段树维护 P_i 值，实现高效查询。

#### 3. roBotic（4星）
- **亮点**：后缀和预处理与堆结合，直观展示分界点影响。
- **关键代码**：降序排序后维护后缀收益，堆优化选择策略。

---

### 最优思路与代码实现

#### 核心代码（Claire0918 版）
```cpp
sort(a + 1, a + n + 1, [](pair<int, int> x, pair<int, int> y) {
    return x.first < y.first || (x.first == y.first && x.second > y.second);
});

priority_queue<int> q;
long long sum = 0;
for (int i = n; i; i--) {
    if (q.size() < m - 1) {
        q.push(a[i].second);
        sum += a[i].second - 1;
    } else if (!q.empty() && q.top() > a[i].second) {
        sum -= q.top() - 1;
        q.pop();
        q.push(a[i].second);
        sum += a[i].second - 1;
    }
    if (q.size() == m - 1) {
        res = max(res, pre[i - 1] - sum);
    }
}
```

#### 实现思想
1. **排序**：按容量升序排列，确保分界点左侧装满的箱子容量 ≤ 右侧。
2. **堆维护**：从后向前遍历，维护容量较大箱子的最小 P_i 之和。
3. **分界枚举**：对每个位置 i，计算前缀装满收益与后缀最小代价的差值。

---

### 同类型题与套路
- **贪心套路**：分界点枚举 + 前后缀预处理 + 数据结构优化。
- **相似题目**：
  1. **洛谷 P1080 国王游戏**：贪心排序后求最优序列。
  2. **洛谷 P1230 智力大冲浪**：时间窗口与收益最大化。
  3. **洛谷 P2107 小Z的AK计划**：堆维护最优选择。

---

### 可视化与游戏化设计
#### 复古像素风动画
- **Canvas 绘制**：箱子按容量排序后呈阶梯状，容量越大块越高。
- **分界点高亮**：红色竖线左右区分装满与未装满区域。
- **动态堆显示**：右侧实时显示优先队列中的 P_i 值，颜色标记最小值。

#### 交互功能
- **步进控制**：按帧逐步展示分界点移动与堆调整过程。
- **音效反馈**：选择分界点时播放金币音效，最大值更新时触发胜利音效。
- **自动模式**：AI 自动选择最优分界点，动态展示收益计算。

---

### 个人心得摘录
- **特判陷阱**：m=1 时需单独处理，直接计算所有箱子收益和。
- **排序细节**：容量相同时按 P_i 降序排列，确保优先选择更小代价的箱子。
- **数据结构选择**：优先队列在大多数情况下更高效，线段树适合极大数据。

---
处理用时：113.35秒
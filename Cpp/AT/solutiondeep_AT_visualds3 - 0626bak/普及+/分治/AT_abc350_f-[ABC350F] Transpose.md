# 题目信息

# [ABC350F] Transpose

## 题目描述

[problemUrl]: https://atcoder.jp/contests/abc350/tasks/abc350_f

英大小文字と `(` 、 `)` からなる文字列 $ S=S_1\ S_2\ S_3\ \dots\ S_{|S|} $ が与えられます。  
 文字列 $ S $ 中の括弧は、対応が取れています。

次の操作を、操作ができなくなるまで繰り返します。

- まず、以下の条件を全て満たす整数組 $ (l,r) $ をひとつ選択する。
  - $ l\ <\ r $
  - $ S_l\ = $ `(`
  - $ S_r\ = $ `)`
  - $ S_{l+1},S_{l+2},\dots,S_{r-1} $ は全て英大文字または英小文字である
- $ T=\overline{S_{r-1}S_{r-2}\ \dots\ S_{l+1}} $ とする。
  - 但し、 $ \overline{x} $ は $ x $ の大文字と小文字を反転させた文字列を指す。
- その後、 $ S $ の $ l $ 文字目から $ r $ 文字目までを削除し、削除した位置に $ T $ を挿入する。
 
詳細は入出力例を参照してください。

上記の操作を使って全ての `(` と `)` を除去することができ、最終的な文字列は操作の方法や順序によらないことが証明できます。  
 このとき、最終的な文字列を求めてください。

  「 $ S $ 中の括弧の対応が取れている」とは? まず、正しい括弧列を次の通り定義します。 - 正しい括弧列とは、以下のいずれかの条件を満たす文字列です。
- 空文字列
- ある正しい括弧列 $ A $ が存在して、 `(`, $ A $, `)` をこの順に連結した文字列
- ある空でない正しい括弧列 $ A,B $ が存在して、 $ A,B $ をこの順に連結した文字列
 
 
 $ S $ 中の括弧の対応が取れているとは、 $ S $ 中の `(` と `)` を順序を保って抜き出した時、それが正しい括弧列となることを指す。

## 说明/提示

### 制約

- $ 1\ \le\ |S|\ \le\ 5\ \times\ 10^5 $
- $ S $ は英大小文字と `(` 、 `)` からなる
- $ S $ 中の括弧は対応が取れている
 
### Sample Explanation 1

$ S= $ `((A)y)x` に対して操作を行います。 - $ l=2,r=4 $ を選択します。このとき削除される文字列は `(A)` で、代わりに `a` が挿入されます。 - この操作の結果、 $ S= $ `(ay)x` となります。 - $ l=1,r=4 $ を選択します。このとき削除される文字列は `(ay)` で、代わりに `YA` が挿入されます。 - この操作の結果、 $ S= $ `YAx` となります。 括弧を除去した結果、文字列は `YAx` となったので、これを出力してください。

### Sample Explanation 2

$ S= $ `((XYZ)n(X(y)Z))` に対して操作を行います。 - $ l=10,r=12 $ を選択します。このとき削除される文字列は `(y)` で、代わりに `Y` が挿入されます。 - この操作の結果、 $ S= $ `((XYZ)n(XYZ))` となります。 - $ l=2,r=6 $ を選択します。このとき削除される文字列は `(XYZ)` で、代わりに `zyx` が挿入されます。 - この操作の結果、 $ S= $ `(zyxn(XYZ))` となります。 - $ l=6,r=10 $ を選択します。このとき削除される文字列は `(XYZ)` で、代わりに `zyx` が挿入されます。 - この操作の結果、 $ S= $ `(zyxnzyx)` となります。 - $ l=1,r=9 $ を選択します。このとき削除される文字列は `(zyxnzyx)` で、代わりに `XYZNXYZ` が挿入されます。 - この操作の結果、 $ S= $ `XYZNXYZ` となります。 括弧を除去した結果、文字列は `XYZNXYZ` となったので、これを出力してください。

### Sample Explanation 3

操作結果が空文字列になる場合もあります。

## 样例 #1

### 输入

```
((A)y)x```

### 输出

```
YAx```

## 样例 #2

### 输入

```
((XYZ)n(X(y)Z))```

### 输出

```
XYZNXYZ```

## 样例 #3

### 输入

```
(((()))(()))(())```

### 输出

```
```

## 样例 #4

### 输入

```
dF(qT(plC())NnnfR(GsdccC))PO()KjsiI((ysA)eWW)ve```

### 输出

```
dFGsdccCrFNNnplCtQPOKjsiIwwEysAve```

# AI分析结果



## 唯一算法分类
分治

## 综合分析与结论
该题核心在于处理嵌套括号内的字符串翻转与大小写转换。各题解主要采用递归分治或平衡树实现。最优解法为预处理括号匹配后，分治处理每个区间，根据当前方向（正序/逆序）决定字符顺序与大小写转换，时间复杂度 O(n)。

**可视化设计要点**：
1. **高亮当前处理区间**：用不同颜色区分正序（绿色）与逆序（红色）处理。
2. **嵌套括号展开动画**：点击括号时展开子区间处理过程，显示翻转与大小写变换。
3. **方向切换指示**：用箭头图标表示当前遍历方向，反转时播放翻转动画。
4. **音效反馈**：处理字符时播放打字音效，括号展开时触发“叮”声，方向切换时播放“嗖”声。

## 题解清单 (≥4星)
1. **作者：_Weslie_（4.5星）**  
   - 递归分治思路清晰，预处理括号匹配后线性处理。
   - 代码简洁易读，利用方向标记切换处理逻辑。
   - 潜在栈溢出风险但通过样例测试。

2. **作者：guanyf（4星）**  
   - 结合差分数组统计大小写翻转次数。
   - 分治处理时根据奇偶性决定遍历顺序。
   - 代码结构化但嵌套逻辑稍复杂。

3. **作者：UniGravity（4星）**  
   - 文艺平衡树实现区间翻转。
   - 提取字母后单独处理，避免括号干扰。
   - 代码模块化但平衡树实现较复杂。

## 核心算法实现
```cpp
// 预处理括号匹配
stack<int> st;
for (int i = 1; i <= n; i++) {
    if (s[i] == '(') st.push(i);
    else if (s[i] == ')') {
        match[st.top()] = i;
        match[i] = st.top();
        st.pop();
    }
}

// 非递归分治处理
stack<tuple<int, int, int>> stk; // [l, r, direction]
stk.push({1, n, 1});
string result;

while (!stk.empty()) {
    auto [l, r, dir] = stk.top();
    stk.pop();
    if (dir == 1) { // 正序处理
        for (int i = l; i <= r; ++i) {
            if (s[i] == '(') {
                int j = match[i];
                stk.push({i+1, j-1, -1});
                i = j; // 跳过处理区间
            } else if (s[i] != ')') {
                result += s[i];
            }
        }
    } else { // 逆序处理
        for (int i = r; i >= l; --i) {
            if (s[i] == ')') {
                int j = match[i];
                stk.push({j+1, i-1, 1});
                i = j; // 跳过处理区间
            } else if (s[i] != '(') {
                result += (isupper(s[i]) ? tolower(s[i]) : toupper(s[i]));
            }
        }
    }
}
cout << result;
```

## 相似题目推荐
1. [P1789 括号匹配](https://www.luogu.com.cn/problem/P1789)  
2. [P3372 文艺平衡树](https://www.luogu.com.cn/problem/P3391)  
3. [P1944 字符串变换](https://www.luogu.com.cn/problem/P1944)

---
处理用时：158.89秒
# 题目信息

# Sushi

## 题目描述

[problemUrl]: https://atcoder.jp/contests/dp/tasks/dp_j

$ N $ 枚の皿があります。 皿には $ 1,\ 2,\ \ldots,\ N $ と番号が振られています。 最初、各 $ i $ ($ 1\ \leq\ i\ \leq\ N $) について、皿 $ i $ には $ a_i $ ($ 1\ \leq\ a_i\ \leq\ 3) $ 個の寿司が置かれています。

すべての寿司が無くなるまで、太郎君は次の操作を繰り返し行います。

- $ 1,\ 2,\ \ldots,\ N $ の目が等確率で出るサイコロを振り、出目を $ i $ とする。 皿 $ i $ に寿司がある場合、皿 $ i $ の寿司を $ 1 $ 個食べる。 皿 $ i $ に寿司が無い場合、何も行わない。

すべての寿司が無くなるまでの操作回数の期待値を求めてください。

## 说明/提示

### 制約

- 入力はすべて整数である。
- $ 1\ \leq\ N\ \leq\ 300 $
- $ 1\ \leq\ a_i\ \leq\ 3 $

### Sample Explanation 1

$ 1 $ 個目の寿司を食べるまでの操作回数の期待値は $ 1 $ です。 その後、$ 2 $ 個目の寿司を食べるまでの操作回数の期待値は $ 1.5 $ です。 その後、$ 3 $ 個目の寿司を食べるまでの操作回数の期待値は $ 3 $ です。 よって、全体の操作回数の期待値は $ 1\ +\ 1.5\ +\ 3\ =\ 5.5 $ です。

### Sample Explanation 2

例えば、`3.00`, `3.000000003`, `2.999999997` などを出力しても正解となります。

## 样例 #1

### 输入

```
3

1 1 1```

### 输出

```
5.5```

## 样例 #2

### 输入

```
1

3```

### 输出

```
3```

## 样例 #3

### 输入

```
2

1 2```

### 输出

```
4.5```

## 样例 #4

### 输入

```
10

1 3 2 3 3 2 3 2 1 3```

### 输出

```
54.48064457488221```

# AI分析结果



# 算法分类
**期望DP**

---

# 题解思路、算法要点与解决难点

## 核心思路
1. **状态定义**  
   用三维状态 `dp[i][j][k]` 表示当前有 `i` 个1寿司的盘子、`j` 个2寿司的盘子、`k` 个3寿司的盘子的期望步数。  
   - **状态合并**：通过 `a = n - (i+j+k)` 隐式表示空盘子数，避免四维状态

2. **转移方程**  
   - **原始方程**：包含选择空盘子的无效操作项  
     $$dp_{i,j,k} = 1 + \frac{a}{n}dp_{i,j,k} + \sum_{x=1}^{3} \frac{cnt_x}{n} dp_{trans(x)}$$  
   - **化简后方程**（消除自环）：  
     $$dp_{i,j,k} = \frac{n + i \cdot dp_{i-1,j,k} + j \cdot dp_{i+1,j-1,k} + k \cdot dp_{i,j+1,k-1}}{i+j+k}$$

3. **实现方式**  
   - **递推顺序**：按 `k, j, i` 三重循环，确保状态依赖已计算  
   - **记忆化搜索**：部分题解采用递归形式，避免手动管理状态顺序

## 解决难点
- **维度压缩**：通过寿司数量分类合并状态，将指数级状态数降为 O(n³)  
- **自环处理**：通过数学推导消除方程中的自环项，避免无限递归/循环  
- **转移方向**：2寿司盘减少会生成1寿司盘，需正确处理状态间依赖关系

---

# 题解评分 (≥4星)

1. **Haphyxlos（4.5星）**  
   - **亮点**：详细推导状态合并与方程化简，代码循环顺序清晰  
   - **代码**：三重循环递推，直接体现动态规划无后效性

2. **FelFa_1414666（4.2星）**  
   - **亮点**：记忆化搜索实现直观，适合理解状态转移逻辑  
   - **代码**：递归边界处理明确，注释说明到位

3. **TianTian2008（4.0星）**  
   - **亮点**：数学公式排版规范，代码简洁高效  
   - **心得**：强调循环顺序对无后效性的重要性

---

# 最优思路提炼

## 关键技巧
1. **状态压缩**  
   - 利用寿司数量有限（≤3）的特性，将盘子按剩余寿司数分类计数  
   - 隐式计算空盘子数，减少状态维度

2. **方程化简**  
   - 通过移项消除自环项：将含 `dp[i][j][k]` 的项合并到等式左侧

3. **递推顺序优化**  
   - 按 `k`（3寿司盘数）→ `j`（2寿司盘数）→ `i`（1寿司盘数）的顺序计算，确保前驱状态已就绪

## 代码实现
```cpp
// 核心递推片段
for(int k=0; k<=n; ++k) {
    for(int j=0; j<=n; ++j) {
        for(int i=0; i<=n; ++i) {
            if(i + j + k == 0) continue;
            double sum = n;
            if(i) sum += i * dp[i-1][j][k];
            if(j) sum += j * dp[i+1][j-1][k];
            if(k) sum += k * dp[i][j+1][k-1];
            dp[i][j][k] = sum / (i + j + k);
        }
    }
}
```

---

# 同类型题与算法套路

## 相似题型
- **期望DP+状态压缩**：如[CF908D](https://codeforces.com/problemset/problem/908/D)（期望概率模型）  
- **多维状态转移**：如[P6858](https://www.luogu.com.cn/problem/P6858)（深海蓝鲸）  
- **无效操作处理**：如[P6835](https://www.luogu.com.cn/problem/P6835)（概率动态规划）

## 通用套路
1. **状态设计**：根据问题特性合并等价状态  
2. **方程化简**：通过数学变形消除自环依赖  
3. **计算顺序**：拓扑排序或记忆化搜索处理状态依赖

---

# 推荐题目
1. **P1850 [NOIP2016 提高组] 换教室**  
   - 期望DP经典题，涉及状态转移与概率计算

2. **P4550 收集邮票**  
   - 期望模型进阶，需推导递推关系

3. **P3750 [六省联考 2017] 分手是祝愿**  
   - 结合期望与贪心的综合题

---

# 可视化与算法演示

## 动画设计
1. **状态矩阵展示**  
   - 3D网格表示 `dp[i][j][k]`，当前计算单元高亮为黄色  
   - 前驱状态（如 `dp[i-1][j][k]`）标记为蓝色

2. **转移过程**  
   - **步骤分解**：  
     1. 显示当前状态 `(i,j,k)`  
     2. 箭头指向三个可能的前驱状态  
     3. 计算权重并显示最终期望值

3. **复古像素风格**  
   - **元素设计**：  
     - 寿司盘用 16x16 像素绘制，不同颜色表示寿司数量（绿/黄/红）  
     - 状态更新时播放8-bit音效（如 `beep-07.wav`）  
   - **自动演示**：  
     - 按 `k→j→i` 顺序遍历，每步延迟200ms  
     - 完成时播放胜利音效（如 `fanfare.mid`）

## 交互功能
- **速度调节**：滑块控制动画速度（100ms~1s/step）  
- **模式切换**：手动步进 vs 自动播放  
- **状态追踪**：悬浮显示当前 `dp[i][j][k]` 值

---

# 个人心得摘录

1. **调试教训**  
   > "循环顺序必须是k→j→i，否则会用到未计算的状态" —— TianTian2008  
   - **总结**：动态规划的计算顺序需严格满足拓扑序

2. **思维突破**  
   > "发现盘子位置无关紧要，只需记录各类数量" —— Haphyxlos  
   - **总结**：识别问题中的对称性是优化状态设计的关键

3. **实现技巧**  
   > "用n/(i+j+k)直接处理空盘子概率" —— __yun__  
   - **总结**：数学化简可大幅简化代码逻辑

---
处理用时：83.47秒
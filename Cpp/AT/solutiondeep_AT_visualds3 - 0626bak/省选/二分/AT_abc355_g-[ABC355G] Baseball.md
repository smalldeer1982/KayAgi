# 题目信息

# [ABC355G] Baseball

## 题目描述

[problemUrl]: https://atcoder.jp/contests/abc355/tasks/abc355_g

長さ $ N $ の数列 $ P=(P_1,P_2,\dots,P_N) $ が与えられます。高橋君と青木君が、数列 $ P $ を使ってゲームを行います。

まず、高橋君が、 $ 1,2,\dots,N $ から $ K $ 個の相異なる整数 $ x_1,x_2,\dots,x_K $ を選びます。

次に、青木君が、 $ 1,2,\dots,N $ から $ 1 $ つの整数 $ y $ を $ P_y $ に比例する確率で選びます。すなわち、整数 $ y $ が選ばれる確率は $ \dfrac{P_y}{\sum_{y'=1}^N\ P_{y'}} $ です。そして、青木君が $ \displaystyle\ \min_{i=1,2,\dots,K}\ |x_i-y| $ のスコアを得ます。

高橋君は、青木君が得るスコアの期待値を**最小化**したいです。高橋君が適切に $ x_1,x_2,\dots,x_K $ を選んだときに、青木君が得るスコアの期待値の最小値を $ \sum_{y'=1}^N\ P_{y'} $ 倍した値を求めてください。なお、出力すべき値は整数になることが証明できます。

## 说明/提示

### 制約

- $ 1\ \leq\ N\ \leq\ 5\ \times\ 10^4 $
- $ 1\ \leq\ K\ \leq\ N $
- $ 0\ \leq\ P_i\ \leq\ 10^5 $
- $ 1\ \leq\ \sum_{y'=1}^N\ P_{y'}\ \leq\ 10^5 $
- 入力はすべて整数
 
### Sample Explanation 1

青木君が $ 1,2,\dots,N $ を選ぶ確率はすべて等しく $ \frac{1}{5} $ です。 高橋君が $ x_1=2,x_2=4 $ と選んだとすると、青木君が得るスコアの期待値は $ 1\ \times\ \frac{1}{5}\ +\ 0\ \times\ \frac{1}{5}\ +\ 1\ \times\ \frac{1}{5}\ +\ 0\ \times\ \frac{1}{5}\ +\ 1\ \times\ \frac{1}{5}\ =\ \frac{3}{5} $ です。 高橋君が $ x_1=2,x_2=3 $ と選んだとすると、青木君が得るスコアの期待値は $ 1\ \times\ \frac{1}{5}\ +\ 0\ \times\ \frac{1}{5}\ +\ 0\ \times\ \frac{1}{5}\ +\ 1\ \times\ \frac{1}{5}\ +\ 2\ \times\ \frac{1}{5}\ =\ \frac{4}{5} $ です。 高橋君が他の選び方をしても、青木君が得るスコアの期待値は $ \frac{3}{5} $ より小さくなりません。よって最小値は $ \frac{3}{5} $ であり、これを $ 5 $ 倍した $ 3 $ を出力します。

## 样例 #1

### 输入

```
5 2

1 1 1 1 1```

### 输出

```
3```

## 样例 #2

### 输入

```
5 1

0 0 1 0 0```

### 输出

```
0```

## 样例 #3

### 输入

```
1 1

100```

### 输出

```
0```

## 样例 #4

### 输入

```
20 7

4262 9522 2426 3823 7364 964 2743 2423 1955 5274 3684 847 363 35 278 3220 203 2904 6304 1928```

### 输出

```
22809```

# AI分析结果



**唯一算法分类**：二分

---

### **题解思路、算法要点与解决难点**

#### **核心思路**
将问题转化为划分区间的最优化问题，利用wqs二分（凸优化）结合决策单调性优化，将时间复杂度从O(nk)降为O(n log V log n)，其中V为二分范围。关键点包括：
1. **wqs二分**：引入惩罚项将K的限制转化为无约束问题，通过二分惩罚系数找到最优解。
2. **四边形不等式优化**：证明代价函数满足四边形不等式，决策具有单调性，从而使用二分队列优化DP转移。

#### **二分算法细节**
- **搜索区间**：初始范围设为`ml=0`至`mr=1e10`（覆盖可能的惩罚值）。
- **收缩条件**：若当前惩罚系数下划分次数≤K，收缩右边界；否则收缩左边界。
- **边界处理**：最终结果需减去`K * c`，恢复真实代价。

#### **解决难点**
- **凸性证明**：通过四边形不等式证明代价函数满足凸性，确保wqs二分正确性。
- **决策单调性**：维护决策队列，快速找到最优划分点，避免O(n²)转移。

---

### **题解评分 (≥4星)**

1. **作者：larsr (★★★★★)**  
   - **亮点**：代码简洁高效，预处理前缀和快速计算区间代价，完美结合wqs二分与二分队列优化。
2. **作者：CCPSDCGK (★★★★☆)**  
   - **亮点**：详细推导四边形不等式与决策单调性，提供分治和二分队列两种实现思路，理论分析透彻。
3. **作者：王华 (★★★★☆)**  
   - **亮点**：清晰解释wqs二分与决策单调性优化，分治代码示例帮助理解分治法的适用场景。

---

### **最优思路或技巧提炼**

1. **wqs二分降维**：将K次划分转化为带惩罚项的单次DP，消除状态维度。
2. **前缀和优化**：预处理`wl`和`wr`函数，O(1)计算区间代价。
3. **二分队列维护决策点**：利用决策单调性，队列维护可能的转移点，快速找到最优分割。
4. **凸性判定**：通过四边形不等式证明DP的凸性，确保二分的正确性。

---

### **同类型题与算法套路**

- **通用解法**：当问题满足“选择K个元素使代价最小且代价函数凸”时，优先考虑wqs二分。
- **类似题目**：  
  1. [CF321E Ciel and Gondolas](https://codeforces.com/problemset/problem/321/E)（wqs二分+决策单调性）  
  2. [洛谷P4767 邮局](https://www.luogu.com.cn/problem/P4767)（四边形不等式优化DP）  
  3. [LOJ 2478 九省联考2018 林克卡特树](https://loj.ac/p/2478)（wqs二分经典题）

---

### **代码核心片段**

```cpp
// 二分框架
ll ml = 0, mr = 1e10;
while (ml < mr) {
    ll c = (ml + mr) / 2;
    check(); // 计算当前惩罚下的最优解和划分次数
    if (ans.second <= k) mr = c;
    else ml = c + 1;
}
c = ml;
check();
printf("%lld\n", ans.first - k * c);

// 代价计算函数
ll w(int l, int r) {
    int mid = (l + r) / 2;
    return wl(l+1, mid) + wr(mid+1, r-1);
}

// 二分队列维护决策点（部分代码）
while (bg <= en && get(i, qr[en]) > get(id[en], qr[en])) {
    if (qr[en] < n) {
        en++;
        ql[en] = qr[en-1]+1;
        qr[en] = n;
        id[en] = i;
    }
    // ... 二分调整区间
}
```

---

### **可视化与算法演示**

**动画方案**：  
1. **区间展示**：Canvas绘制区间[left, right]与mid值，颜色区分当前搜索范围。  
2. **高亮操作**：mid以红色标记，收缩区间时左右边界动态移动，绿色表示有效解区间。  
3. **音效提示**：每次更新mid播放“滴”声，找到解时播放成功音效。  
4. **自动模式**：AI逐步执行二分步骤，用户可调节速度或手动单步执行。  
5. **复古风格**：8位像素UI，网格化显示数值，背景音乐为循环芯片音乐。

**交互设计**：  
- **控制面板**：滑块调节二分速度，按钮切换手动/自动模式。  
- **步骤回放**：记录历史步骤，支持回溯观察区间变化过程。

---

### **个人心得摘录**

- **调试教训**：初始二分范围过小导致WA，需根据实际数据范围合理设定上下界。  
- **优化顿悟**：前缀和预处理将区间代价计算从O(n)降为O(1)，大幅提升效率。  
- **思维转换**：将概率期望问题转化为加权最优化，是本题的关键突破口。

---
处理用时：69.72秒
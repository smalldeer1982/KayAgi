# 题目信息

# [ARC016D] 軍艦ゲーム

## 题目描述

[problemUrl]: https://atcoder.jp/contests/arc016/tasks/arc016_4

高橋君は艦長である。  
 高橋艦長の任務は、鎮守府のある海域から最終目的地となる海域へ進軍することである。  
 高橋艦長は次の順序で行動する。

1. 航路選択

- 進軍する航路を選択する。現在の海域から異なる海域へ移動できる航路が $ 1 $ 本も存在しない場合、$ 4 $ の海域離脱を行う。
- また、現在の海域から異なる海域への航路が複数本存在する場合、何者かの陰謀によって等確率で航路が選択される。
- たとえば、鎮守府のある海域から、他の海域への航路が $ 4 $ 本存在する場合、それぞれ $ 25% $ の確率で選択されます。


4. 進軍
- 選択された航路によって、海域を移動する。

6. 戦闘
- 進軍先の海域 $ i $ には敵艦が待ち構えており、戦闘が発生する。
- 鎮守府から出港したとき、高橋艦長が率いる軍艦の体力は $ H $ であり、戦闘によって軍艦の体力は $ D_i $ だけ減少する。
- 軍艦の体力が $ 0 $ 以下になると、軍艦は沈没してしまう。
- 軍艦が沈没すると高橋艦長は失意のあまりこれ以上出撃することが出来なくなってしまうため、`絶対に沈没させてはいけない`。
- なお、鎮守府のある海域では戦闘は発生しないが、最終目的地である海域では必ず戦闘が発生する。

8. 海域離脱 or 航路選択に戻る
- 海域離脱とは、鎮守府のある海域へ戻ることを意味する。
- 海域離脱した際に、軍艦の残り体力が $ C $ であった場合、$ H-C $ だけ体力回復のために時間を消費する。
 
 上記`1`,`2`,`3`,`4`のサイクル1回につき時間を $ 1 $ だけ使う。  
- - - - - -

 海域と航路について - いま、$ N $ 個の海域と $ M $ 個の航路がある。
- これら $ M $ 個の航路は、すべて一方通行である。
 
 そのため、任意の異なる海域 $ A,B $ において、ある $ 1 $ 本の航路を利用して、海域 $ A $ から海域 $ B $ へ移動し、海域 $ B $ から海域 $ A $ へ移動することはできない。  
- - - - - -

 あなたは高橋艦長の参謀であり、高橋艦長が消費する時間を最小となるよう行動した場合、最終目的地における戦闘で生存するまでに経過する時間の期待値を求めることが仕事である。  
 どのようにしても高橋艦長が任務を完遂できない場合は`-1`と出力せよ。  
 ただし、出力する期待値が $ 10^6 $ より大きくなる入力は与えられない。 入力は以下の形式で標準入力から与えられる。 > $ N $ $ M $ $ H $ $ f_1 $ $ t_1 $ $ f_2 $ $ t_2 $ : $ f_M $ $ t_M $ $ D_1 $ $ D_2 $ : $ D_N $

1. $ 1 $ 行目は、海域数を表す整数 $ N\ (2≦N≦100) $、航路数を表す整数 $ M\ (0≦M≦N\ *\ (N\ -\ 1)\ /\ 2) $、出港時の艦隊の体力を表す整数 $ H\ (1≦H≦100) $ が半角空白区切りで与えられる。

- 鎮守府のある海域は $ 1 $ で、最終目的地である海域は $ N $ です。

32. $ 2 $ 行目から $ M $ 行は、 $ i $ 番目の航路を表す。移動元の海域を表す整数 $ f_i\ (1≦f_i≦N) $、移動先の海域を表す整数 $ t_i\ (1≦t_i≦N) $ が、スペース区切りで与えられる。
- $ f_i\ <\ t_i $ であることが保証されている。

34. $ 2+M $ 行目から $ N $ 行は、$ i $ 番目の海域での戦闘で受けるダメージを表す整数 $ D_i\ (0≦D_i≦100) $ が、一行で与えられる。
- $ D_1 $ の値は常に $ 0 $ である（鎮守府のある海域です）。

- 出力する期待値が $ 10^6 $ より大きくなる入力が与えられないことに留意せよ。
 
 高橋艦長が消費する時間が最小となるよう行動した場合、最終目的地における戦闘で生存するまでに経過する時間の期待値を出力せよ。  
 出力は絶対誤差あるいは相対誤差の少なくとも片方が $ 10^{-6} $ 以下であれば許容される。   
 また、どのようにしても高橋艦長が任務を完遂できない場合は`-1`と出力せよ。  
 なお、出力の最後には改行をいれること。  

- 鎮守府のある $ 1 $ から、最終目的地である $ 6 $ までは、$ 2 $ 通りの経路があります。

1. 1 -&gt; 2 -&gt; 4 -&gt; 6

- このルートが選択される確率は $ 50% $ です。
- このルートで軍艦が受けるダメージは $ 0+1+2+4=7 $ です。
- このルートで消費する時間は、サイクル $ 3 $ 回の時間のみなので、$ 3 $ です。

48. 1 -&gt; 3 -&gt; 5 -&gt; 6
- このルートが選択される確率は $ 50% $ です。
- このルートで軍艦が受けるダメージは $ 0+1+3+4=8 $ です。
- 出港時の軍艦の体力は $ 8 $ なので、このルートでは沈没してしまいます。
- 高橋艦長は、沈没を避けるため、海域 $ 3 $ の戦闘終了時に海域離脱を選択します。
- このルートで消費する時間は、サイクル $ 1 $ 回の時間 $ + $ 体力の回復にかかる時間 $ = $ $ 1+1=2 $ です。
 
 1 -&gt; 3 -&gt; 5 -&gt; 6 で `1` 度撤退してから 1-&gt; 2-&gt; 4 -&gt; 6 - $ 50% $ の確率で 1 -&gt; 3 -&gt; 5 -&gt; 6 が選択され、時間 $ 2 $ を使って鎮守府に戻る。
- その後、 $ 50% $ の確率で 1 -&gt; 2 -&gt; 4 -&gt; 6 が選択され、時間 $ 3 $ を使って最終目的地に到達する。
- つまり、$ 25% $ の確率で時間 $ 5 $ を使って最終目的地に到達。
 
 1 -&gt; 3 -&gt; 5 -&gt; 6 で `2` 度撤退してから 1-&gt; 2-&gt; 4 -&gt; 6 - $ 12.5% $ の確率で時間 $ 7 $ を使って最終目的地に到達。
 
 1 -&gt; 3 -&gt; 5 -&gt; 6 で `3` 度撤退してから 1-&gt; 2-&gt; 4 -&gt; 6 - $ 6.25% $ の確率で時間 $ 9 $ を使って最終目的地に到達。

62. 上記から、求める期待値は $ 3*0.5+5*0.25+7*0.125+...=5 $ となります。


## 样例 #1

### 输入

```
6 6 8
1 2
1 3
2 4
3 5
4 6
5 6
0
1
1
2
3
4```

### 输出

```
5.0```

## 样例 #2

### 输入

```
3 2 5
1 2
1 3
0
5
1```

### 输出

```
-1```

## 样例 #3

### 输入

```
3 2 6
1 2
1 3
0
5
1```

### 输出

```
7```

## 样例 #4

### 输入

```
9 13 4
1 2
1 3
2 4
2 5
2 7
3 5
3 6
4 7
5 8
6 8
7 8
7 9
8 9
0
1
1
1
1
1
1
1
1```

### 输出

```
36.9999999999999```

# AI分析结果



### 唯一算法分类：**二分**

---

### 题解思路与算法要点

#### **核心问题与难点**
1. **后效性处理**：动态规划中的状态转移方程存在自环（如 `dp[1][H]` 依赖自身），导致无法直接递推。
2. **最优策略选择**：每一步需要选择“继续航行”或“回城”，需通过 `min` 操作比较两种策略的时间期望。
3. **无限循环可能**：由于存在概率性选择路径，可能导致无限尝试，需通过数学期望收敛性证明。

#### **二分答案的巧妙应用**
- **核心思路**：假设 `dp[1][H] = mid`，通过动态规划计算所有状态，若最终得到的 `dp[1][H]` 与 `mid` 相等，则 `mid` 为正确答案。
- **单调性证明**：由于每次 `mid` 的变化对 `dp` 的影响是线性的（导数为 1），函数 `g(mid) = 实际计算的 dp[1][H]` 单调不增，可通过二分找到 `g(mid) = mid` 的点。

#### **实现细节**
- **初始区间**：`left = 0`, `right = 1e6 + 10`（题目保证答案 ≤ 1e6）。
- **收敛条件**：当 `right - left < 1e-8` 时停止，误差满足题目要求。
- **DP 转移**：对于每个状态 `(u, i)`，计算两种策略的最小期望时间：
  ```cpp
  f[x][j] = min(A + H - j, 1 + (sum of f[y][j - D[y]]) / out_degree)
  ```

---

### 题解评分（≥4星）

#### **iMya_nlgau 题解（4.5星）**
- **亮点**：递归 DFS 实现简洁，明确处理了后效性；数学证明清晰。
- **代码**：通过 `dfs` 函数自顶向下计算状态，避免冗余计算。
- **优化**：在二分中直接复用全局变量 `A`，减少参数传递开销。

#### **123456xwd 题解（4星）**
- **亮点**：记忆化搜索实现，代码简洁易懂。
- **改进点**：未显式处理无出度节点的特殊情况，依赖全局 `vis` 数组剪枝。

---

### 最优思路与技巧提炼

1. **二分答案框架**：
   - 将无法直接求解的 `dp[1][H]` 转化为二分变量。
   - 通过假设 `mid` 计算状态，验证其自洽性。

2. **动态规划设计**：
   - 状态定义：`dp[u][i]` 表示在节点 `u` 血量 `i` 时的最小期望时间。
   - 转移方程：`min(回城时间, 平均航行时间 + 1)`。

3. **边界处理**：
   - 终点 `n`：`dp[n][i] = 0 (i > 0)`。
   - 无出度节点：必须回城，时间 `H - i + mid`。

---

### 同类型题与算法套路

- **二分答案 + 图论/DP**：
  - **POJ 2976**：二分答案求最大分数。
  - **洛谷 P3199**：最小圈问题（二分 + SPFA 判负环）。
  - **Codeforces 939E**：二分答案优化子序列选择。

---

### 推荐相似题目
1. **洛谷 P3199**：二分答案找最小圈。
2. **洛谷 P4377**：分数规划 + 背包 DP。
3. **Codeforces 939E**：最大子序列平均值的二分优化。

---

### 可视化与算法演示

#### **二分过程动画设计**
- **Canvas 绘制**：区间 `[left, right]` 以水平条表示，`mid` 用红色标记。
- **动态更新**：每次迭代更新 `left` 或 `right`，绿色箭头指示收缩方向。
- **音效提示**：
  - **收缩成功**：清脆“滴”声。
  - **找到答案**：8-bit 胜利音效。

#### **复古像素风格**
- **颜色方案**：16 色复古调色板（红、绿、蓝、黄）。
- **网格绘制**：区间划分为 100 像素单位，`mid` 位置显示为闪烁方块。
- **自动演示**：AI 按固定间隔更新区间，模拟二分收敛。

---

### 核心代码片段

```cpp
// 二分主循环
double l = 0, r = 1e6 + 10;
while (r - l > eps) {
    double mid = (l + r) / 2;
    if (calc(mid) > mid) l = mid;
    else r = mid;
}

// 动态规划计算
void dfs(int x) {
    v[x] = true;
    for (int j = 1; j <= H; j++) {
        if (x == n) f[x][j] = 0;
        else {
            double cost = 1 + (sum of f[y][j - D[y]]) / out_degree;
            f[x][j] = min(A + H - j, cost);
        }
    }
}
```

---

### 个人心得摘录

> “二分答案的关键在于验证函数的单调性。当发现 `dp[1][H]` 的自洽性后，问题便迎刃而解。调试时需特别注意无解情况的处理，如初始血量不足以到达终点。” —— iMya_nlgau

---
处理用时：74.57秒
# 题目信息

# [ABC313F] Flip Machines

## 题目描述

[problemUrl]: https://atcoder.jp/contests/abc313/tasks/abc313_f

$ 1 $ から $ N $ までの番号が付けられた $ N $ 枚のカードがあります。 カードのそれぞれの面には整数が書かれており、カード $ i $ の表には $ A_i $ が、裏には $ B_i $ が書かれています。 最初、全てのカードは表を向いています。

今ここに $ M $ 台のマシーンがあり、$ 1 $ から $ M $ までの番号が付けられています。 マシーン $ j $ は（相異なるとは限らない）$ 2 $ つの $ 1 $ 以上 $ N $ 以下の整数 $ X_j,Y_j $ を持っており、マシーン $ j $ が起動されると、 $ \frac{1}{2} $ の確率でカード $ X_j $ を、残りの $ \frac{1}{2} $ の確率でカード $ Y_j $ を裏返します。 この確率は各起動ごとに独立です。

すぬけくんは今から以下の操作を順に行います。

1. $ 1 $ 以上 $ M $ 以下の整数からなる集合 $ S $ を選ぶ。
2. $ S $ に含まれる番号のマシーンを、番号が小さい順に $ 1 $ 度ずつ起動する。
 
すぬけくんがうまく $ S $ を選んだとき、「すべての操作が終了した後に各カードが向いている面に書かれた整数の合計」の期待値が最大でいくつになるか求めてください。

## 说明/提示

### 制約

- $ 1\leq\ N\ \leq\ 40 $
- $ 1\leq\ M\ \leq\ 10^5 $
- $ 1\leq\ A_i,B_i\ \leq\ 10^4 $
- $ 1\leq\ X_j,Y_j\ \leq\ N $
- 入力は全て整数
 
### Sample Explanation 1

$ S $ として空集合を選んだ場合、どのマシーンも起動されないので、「すべての操作が終了した後に各カードが向いている面に書かれた整数の合計」の期待値は $ 3+10+5=18 $ です。 $ S $ として $ \lbrace\ 1\ \rbrace $ を選んだ場合、マシーン $ 1 $ が起動され、 - カード $ X_1\ =\ 1 $ が裏返された場合、「すべての操作が終了した後に各カードが向いている面に書かれた整数の合計」は $ 10+10+5=25 $ - カード $ Y_1\ =\ 2 $ が裏返された場合、「すべての操作が終了した後に各カードが向いている面に書かれた整数の合計」は $ 3+6+5=14 $ なので、その期待値は $ \frac{25+14}{2}\ =\ 19.5 $ です。 よって、「すべての操作が終了した後に各カードが向いている面に書かれた整数の合計」の期待値の最大値は $ 19.5 $ です。

### Sample Explanation 2

同じ $ (X_j,Y_j) $ を持つマシーンが複数存在することもあります。

## 样例 #1

### 输入

```
3 1

3 10

10 6

5 2

1 2```

### 输出

```
19.500000```

## 样例 #2

### 输入

```
1 3

5 100

1 1

1 1

1 1```

### 输出

```
100.000000```

## 样例 #3

### 输入

```
8 10

6918 9211

16 1868

3857 8537

3340 8506

6263 7940

1449 4593

5902 1932

310 6991

4 4

8 6

3 5

1 1

4 2

5 6

7 5

3 3

1 5

3 1```

### 输出

```
45945.000000```

# AI分析结果



## 唯一算法分类
折半枚举 (Meet-in-the-Middle)

---

## 综合分析与结论

### 核心思路
1. **分类处理**：将卡牌分为两个集合（翻转更优的集合 $S$ 和翻转更劣的集合 $T$），根据集合大小选择暴力枚举或状压 DP
2. **折半思想**：当 $|S| \le |T|$ 时枚举 $T$ 的子集，否则用状压 DP 处理 $S$ 的覆盖情况
3. **关键观察**：跨集合边的处理策略（选 $T$ 中的点会强制覆盖其连接的 $S$ 中的点）

### 难点解决
- **跨集合边**：通过预处理每个点的邻接集合，将跨集合边的影响转化为位掩码
- **状态压缩**：用二进制位表示集合覆盖情况，用位运算高效处理覆盖关系
- **动态规划优化**：在 $S$ 较大时，用 DP 跟踪最优覆盖情况，避免全枚举

### 可视化设计
1. **像素风格界面**：
   - 卡牌用 16x16 像素块表示，$S$ 集合用绿色边框，$T$ 用红色边框
  2. **动画流程**：
   - 初始状态显示所有卡牌的初始值
   - 枚举/DP 过程中，高亮当前处理的卡牌及其影响的位掩码
   - 每步显示选择的卡牌和对应的期望值变化
3. **音效交互**：
   - 选中卡牌时播放 8-bit "click" 音效
   - 找到更优解时播放上升音调
4. **自动演示模式**：
   - 模拟 AI 决策过程，逐步展示集合划分、位掩码生成、最优解计算

---

## 题解清单（≥4星）

### 1. 作者：Purslane（★★★★☆）
- **亮点**：代码结构清晰，分治策略明确，处理了两种情况的位掩码生成
- **核心代码**：
```cpp
if(s1.size()<=s2.size()) {
    memset(dp,-0x3f,sizeof(dp));
    dp[0][0] = 0;
    // ... DP转移处理
} else {
    // 暴力枚举较小集合
}
```

### 2. 作者：DaiRuiChen007（★★★★☆）
- **亮点**：状态压缩与预处理分离，用邻接表存储影响关系
- **关键逻辑**：
```cpp
for(int i=0;i<(int)P.size();i++) {
    for(int j=0;j<1ll<<(int)Q.size();j++) {
        // DP转移，处理覆盖关系
    }
}
```

### 3. 作者：User_Unauthorized（★★★★☆）
- **亮点**：详细的数学推导与状态划分说明，处理自环情况的策略明确
- **核心公式**：
```cpp
ans += (realType)(2*base + ans + max)/2.0; // 最终期望计算
```

---

## 最优思路提炼

### 关键技巧
1. **集合划分**：根据 $A_i$ 与 $(A_i+B_i)/2$ 的关系划分集合
2. **位掩码优化**：用二进制位表示集合覆盖状态，位运算高效处理集合关系
3. **分治策略**：根据集合大小动态选择暴力枚举或 DP，保证复杂度 $O(2^{n/2})$

### 实现要点
- 预处理必须翻转的卡牌（$x_i=y_i$ 且 $A_i<B_i$）
- 对跨集合边进行方向统一（确保总是 $S→T$ 方向）
- 状态转移时用位或运算合并覆盖集合

---

## 同类型题推荐
1. P3067 [USACO12OPEN] Balanced Cow Subsets（折半枚举）
2. P4799 [CEOI2015 Day2] 世界冰球锦标赛（状态压缩+折半）
3. P8187 [USACO22FEB] Robot Instructions G（双向搜索优化）

---

## 个人心得摘录
> "有一个坑点在于如果你用二进制压位，那么很有可能超过30个元素，然后爆long long了" —— Purslane  
> （启示：状态压缩时需注意数据范围，使用64位整型）

---

## 可视化代码片段（伪代码）
```javascript
// 像素动画核心逻辑
function drawState(selected, mask) {
    ctx.clearRect(0, 0, W, H);
    cards.forEach((card, i) => {
        // 绘制卡牌，被选中的高亮
        if(mask & (1 << i)) ctx.fillStyle = "#FF9900"; 
        else if(selected.has(i)) ctx.fillStyle = "#99FF99";
        // ... 绘制卡牌数值
    });
    // 播放音效
    if(selected.size > prevSize) playSound("select");
}

// 自动演示逻辑
function autoSolve() {
    let bestMask = 0;
    for(let mask=0; mask<(1<<n); mask++){
        drawState(new Set(), mask); // 更新显示
        if(calcScore(mask) > best) {
            best = calcScore(mask);
            playSound("win");
        }
        await sleep(500); // 步进延迟
    }
}
```

---

## 复古游戏化设计
1. **颜色方案**：16色 EGA 调色板，卡牌用青/品红区分集合
2. **音效设计**：
   - 选择卡牌：8-bit "blip" 音效（方波生成）
   - 找到最优解：FC RPG 升级音效
3. **关卡系统**：
   - 第1关：处理自环卡牌
   - 第2关：划分集合
   - 第3关：执行枚举/DP
4. **积分规则**：
   - 正确选择卡牌+100
   - 发现更优解+500
   - 连击奖励x2

---
处理用时：72.06秒
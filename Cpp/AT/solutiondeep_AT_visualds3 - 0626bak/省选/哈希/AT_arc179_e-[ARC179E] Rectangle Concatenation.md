# 题目信息

# [ARC179E] Rectangle Concatenation

## 题目描述

[problemUrl]: https://atcoder.jp/contests/arc179/tasks/arc179_e

正整数 $ h,w $ に対し, 縦の辺の長さが $ h $, 横の辺の長さが $ w $ であるような長方形を $ (h,w) $ と表すことにします. なお, 本問では長方形を回転する操作は考えず, $ h\neq\ w $ のとき長方形 $ (h,w) $ と長方形 $ (w,h) $ は異なるものとして扱います.

長方形の列 $ ((h_1,w_1),(h_2,w_2),\dots\ ,(h_n,w_n)) $ が **長方形生成列** であるとは, 次の手順が成功するような方法が存在することを言います.

- 長方形 $ X $ を $ (h_1,w_1) $ とする. 以下では, 各時点での長方形 $ X $ の縦の辺の長さと横の辺の長さをそれぞれ $ H,W $ と表す.
- $ i=2,3,\dots\ ,n $ の順に次のいずれか一方の操作を行う. いずれも行うことができないとき手順は失敗とし, 手順を終了する.
  - $ X $ の縦の辺の長さが $ h_i $ に等しいとき, $ X $ に長方形 $ (h_i,w_i) $ を横向きに結合する. 正確には, その時点で $ H=h_i $ のとき $ X $ を長方形 $ (H,W+w_i) $ に置き換える.
  - $ X $ の横の辺の長さが $ w_i $ に等しいとき, $ X $ に長方形 $ (h_i,w_i) $ を縦向きに結合する. 正確には, その時点で $ W=w_i $ のとき $ X $ を長方形 $ (H+h_i,W) $ に置き換える.
- 上記の一連の操作が失敗しなかった場合は手順は成功とし, 手順を終了する.
 
- - - - - -

$ N $ 個の長方形が与えられます. $ i $ 番目の長方形は, 縦の辺の長さが $ H_i $, 横の辺の長さが $ W_i $ の長方形です.

$ 1\le\ l\le\ r\le\ N $ を満たす正整数の組 $ (l,r) $ であって次の条件を満たすものの個数を求めてください.

- 長方形の列 $ ((H_l,W_l),(H_{l+1},W_{l+1}),\dots\ ,(H_r,W_r)) $ が長方形生成列である.

## 说明/提示

### 制約

- $ 1\leq\ N\leq\ 3\times\ 10^5 $
- $ 1\ \leq\ H_i,W_i\ \leq\ 10^6 $
- 入力される値はすべて整数.
 
### Sample Explanation 1

条件を満たす $ (l,r) $ は $ (1,1),(1,2),(2,2),(2,3),(2,4),(3,3),(4,4) $ の $ 7 $ つです. 例えば, $ (l,r)=(2,4) $ については, 結合を縦向き $ \to $ 横向きの順に行うと手順が成功します.

## 样例 #1

### 输入

```
4

1 2

1 3

2 3

3 1```

### 输出

```
7```

## 样例 #2

### 输入

```
5

2 1

2 1

1 2

3 2

1 4```

### 输出

```
10```

## 样例 #3

### 输入

```
1

1000000 1000000```

### 输出

```
1```

## 样例 #4

### 输入

```
10

1 1

1 1

1 1

1 1

1 1

1 1

1 1

1 1

1 1

1 1```

### 输出

```
55```

# AI分析结果



**唯一算法分类**：扫描线法

---

### **题解思路、算法要点与解决难点**

1. **核心思路**：
   - 通过扫描线维护每个右端点 `r` 对应的合法左端点集合。
   - 维护两个集合 `S0` 和 `S1`，分别表示以 `r` 为右端点时，横向合并（`H` 固定）和纵向合并（`W` 固定）的可能左端点。
   - 利用面积前缀和与哈希表快速判断转移条件。

2. **算法要点**：
   - **状态转移**：根据当前矩形的 `H` 和 `W` 与前一个的关系，动态更新集合：
     - 若当前 `H` 与前一个相同，横向集合继承前一步的合法左端点。
     - 若当前 `W` 与前一个相同，纵向集合继承前一步的合法左端点。
     - 否则，清空对应集合，并通过哈希表查找唯一可能的左端点。
   - **桶统计**：维护一个桶数组记录每个左端点的出现次数，快速统计合法区间数。

3. **解决难点**：
   - **高效维护合法左端点**：通过哈希表预存面积前缀和的位置，快速定位可能的左端点。
   - **状态转移的完备性**：处理多种合并可能性（横向、纵向、同时可合并）时，需确保状态更新的正确性。

---

### **题解评分 (≥4星)**

1. **Talaodi（5星）**：
   - **亮点**：O(N) 时间复杂度的递推设计，利用哈希表快速查找转移条件，代码简洁高效。
   - **代码片段**：
     ```cpp
     // 维护两个集合 f[r,0/1]，统计合法左端点
     if (h[i] == h[i-1]) {
         // 继承横向集合
     } else {
         // 清空横向集合，查找哈希表中面积匹配的左端点
     }
     ```

2. **vegetable_king（4星）**：
   - **亮点**：通过维护两个哈希表 `Sw` 和 `Sh` 分别记录横向和纵向的合并状态，利用整体 `tag` 减少重复计算。
   - **心得摘录**：*“当要删除元素时，要么只删 O(1) 个，要么只剩 O(1) 个，均摊复杂度正确。”*

3. **UniGravity（4星）**：
   - **亮点**：将合法状态分为横向和纵向两类，用 `set` 维护，代码逻辑清晰。
   - **代码片段**：
     ```cpp
     // 处理不同合并情况
     if (h_now == h_prev && w_now == w_prev) {
         // 全局 tag 更新
     } else if (h_now == h_prev) {
         // 清空纵向集合，更新横向集合
     }
     ```

---

### **最优思路或技巧提炼**

1. **哈希表优化**：预存面积前缀和的位置，将面积匹配条件转化为 O(1) 查询。
2. **状态分治**：横向和纵向合并分离维护，避免状态爆炸。
3. **桶计数技巧**：通过桶数组快速统计有效左端点数目，避免遍历集合。

---

### **同类型题或类似算法套路**

- **通用解法**：扫描线法 + 哈希表优化常用于统计满足特定条件的区间数（如子数组和、最长连续段）。
- **类似题**：
  1. [LeetCode 325. Maximum Size Subarray Sum Equals k](https://leetcode.com/problems/maximum-size-subarray-sum-equals-k/)
  2. [LeetCode 560. Subarray Sum Equals K](https://leetcode.com/problems/subarray-sum-equals-k/)

---

### **推荐洛谷题目**

1. **P3406 海底高铁**（区间统计，前缀和优化）
2. **P2440 木材加工**（二分答案，扫描线思想）
3. **P2678 跳石头**（二分答案 + 贪心，区间处理）

---

### **可视化与算法演示**

**动画方案**：
1. **像素风格界面**：
   - **横向合并**：蓝色方块，右侧扩展。
   - **纵向合并**：绿色方块，上方扩展。
   - **当前操作**：高亮显示，配以 8-bit 音效。
2. **关键步骤演示**：
   - **步骤1**：处理新矩形，判断是否清空集合。
   - **步骤2**：哈希表查询符合条件的左端点（闪烁匹配项）。
   - **步骤3**：更新桶数组，显示当前有效区间数。
3. **交互设计**：
   - **速度控制**：滑块调节动画速度。
   - **自动模式**：AI 逐步执行，背景音乐为 8-bit 循环。

**代码片段（Canvas 绘制）**：
```javascript
// 绘制横向合并集合
function drawS0(ctx, l) {
    ctx.fillStyle = '#00F';
    ctx.fillRect(l * 10, currentY, 10, 10);
}
// 触发音效
function playSound(effect) {
    const audio = new Audio(`sfx/${effect}.wav`);
    audio.play();
}
```

---

### **个人心得摘录**

- **Talaodi**：*“利用面积前缀和的哈希映射，将二维条件转换为一维查询，极大简化了状态转移。”*
- **vegetable_king**：*“被删元素要么是 O(1) 个，要么剩下的元素也是 O(1)，这是均摊复杂度的关键。”*

---
处理用时：86.48秒
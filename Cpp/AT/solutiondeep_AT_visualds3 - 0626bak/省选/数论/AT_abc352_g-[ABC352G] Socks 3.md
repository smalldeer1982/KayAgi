# 题目信息

# [ABC352G] Socks 3

## 题目描述

[problemUrl]: https://atcoder.jp/contests/abc352/tasks/abc352_g

高橋君のタンスの中には様々な色の靴下が入っています。 靴下の色は $ 1 $ 以上 $ N $ 以下の整数として表され、色 $ i $ の靴下は $ A_i\ (\geq\ 2) $ 枚入っています。

高橋君は、以下の操作を行うことで今日履く靴下を選ぼうとしています。

- 今までに取り出した靴下の中で同じ色の靴下の $ 2 $ 枚組が作れるようになるまで、タンスの中からランダムに等確率で $ 1 $ 枚の靴下を取り出すことを繰り返す。 なお、一度取り出した靴下はタンスの中には戻さない。

高橋君がタンスから靴下を取り出す回数の期待値を $ \text{mod\ }\ 998244353 $ で求めてください。

期待値を $ \text{mod\ }\ 998244353 $ で求めるとは求める期待値は必ず有理数になることが証明できます。 また、この問題の制約下では、期待値を既約分数 $ \frac{y}{x} $ で表したときに $ x $ が $ 998244353 $ で割り切れないことが保証されます。 このとき $ xz\ \equiv\ y\ \pmod{998244353} $ を満たすような $ 0 $ 以上 $ 998244352 $ 以下の整数 $ z $ が一意に定まるので、この $ z $ を求めてください。

## 说明/提示

### 制約

- $ 1\leq\ N\ \leq\ 3\times\ 10^5 $
- $ 2\leq\ A_i\ \leq\ 3000 $
- 入力は全て整数

### Sample Explanation 1

例えば、以下のように操作を行うことが考えられます。 1. タンスの中から色 $ 1 $ の靴下を $ 1 $ 枚取り出す。タンスの中には色 $ 1 $ の靴下が $ 1 $ 枚と色 $ 2 $ の靴下が $ 2 $ 枚残っている。 2. タンスの中から色 $ 2 $ の靴下を $ 1 $ 枚取り出す。タンスの中には色 $ 1,2 $ の靴下が $ 1 $ 枚ずつ残っている。 3. タンスの中から色 $ 1 $ の靴下を $ 1 $ 枚取り出す。今までに取り出した靴下は色 $ 1 $ の靴下が $ 2 $ 枚と色 $ 2 $ の靴下が $ 1 $ 枚であり、この中で色 $ 1 $ の靴下の $ 2 $ 枚組が作れるので操作を終了する。 この例の場合、高橋君がタンスから靴下を取り出す回数は $ 3 $ 回です。 高橋君がタンスから靴下を取り出す回数は $ \frac{2}{3} $ の確率で $ 3 $ 回、$ \frac{1}{3} $ の確率で $ 2 $ 回なので、求める期待値は $ 3\times\ \frac{2}{3}\ +\ 2\times\ \frac{1}{3}\ =\ \frac{8}{3}\ \equiv\ 665496238\ \pmod\ {998244353} $ です。

## 样例 #1

### 输入

```
2
2 2```

### 输出

```
665496238```

## 样例 #2

### 输入

```
1
352```

### 输出

```
2```

## 样例 #3

### 输入

```
6
1796 905 2768 253 2713 1448```

### 输出

```
887165507```

# AI分析结果



**唯一算法分类**  
动态规划与生成函数（分治NTT）

---

### 题解思路与算法要点  
**核心思路**：  
期望可拆分为各步骤未停止的概率之和。设 \( p_i \) 表示前 \( i-1 \) 次均取不同颜色袜子的概率，则期望 \( E = \sum p_i \)。  
**关键推导**：  
- **分子**：生成函数 \( F(x) = \prod_{i=1}^n (1 + A_i x) \)，其 \( x^k \) 系数为选 \( k \) 只不同颜色袜子的方案数。  
- **分母**：总方案数为组合数 \( \binom{S}{k} \)，其中 \( S = \sum A_i \)。  
**实现优化**：  
- 分治NTT快速计算生成函数系数。  
- 递推处理组合数分母的模逆元。  

**解决难点**：  
1. **高效计算生成函数**：分治递归合并左右两部分的生成函数，利用NTT加速卷积。  
2. **组合数递推**：通过 \( \binom{S}{k+1} = \binom{S}{k} \cdot \frac{S-k}{k+1} \) 递推，避免阶乘溢出。  

---

### 最优思路提炼  
1. **期望线性拆分**：将复杂期望转化为概率累加。  
2. **生成函数建模**：将多颜色选袜问题转化为多项式乘积，分治NTT高效计算。  
3. **组合数递推技巧**：利用模逆元递推分母，避免大数计算。  

---

### 题解评分（≥4星）  
1. **Milthm（5星）**  
   - 代码简洁，调用Atcoder库的NTT函数，分治递归清晰。  
   - 组合数递推与生成函数计算高效结合。  
2. **masterhuang（4星）**  
   - 手动实现NTT，分治逻辑明确。  
   - 处理多项式卷积和组合数递推分离，便于调试。  
3. **lss_ak_gcd（4星）**  
   - 代码简洁，分治函数与组合数处理直观。  
   - 利用STL容器优化内存管理。  

---

### 核心代码实现  
```cpp
#include <bits/stdc++.h>
#include <atcoder/all>
using namespace std;
using mint = atcoder::modint998244353;

vector<mint> calc(vector<int>& a, int l, int r) {
    if (r - l == 1) return {1, a[l]}; // 单个颜色生成函数 [1, a_i x]
    int mid = (l + r) >> 1;
    auto left = calc(a, l, mid);
    auto right = calc(a, mid, r);
    return atcoder::convolution(left, right); // NTT合并左右多项式
}

int main() {
    int n, sum = 0;
    vector<int> a;
    cin >> n;
    for (int i = 0; i < n; ++i) {
        int x; cin >> x;
        a.push_back(x);
        sum += x;
    }
    vector<mint> poly = calc(a, 0, n); // 生成函数系数
    mint ans = 0, binom = 1;
    for (int i = 0; i <= n; ++i) {
        ans += poly[i] / binom; // 累加 p_i = 系数 / 组合数
        binom = binom * (sum - i) / (i + 1); // 递推组合数分母
    }
    cout << ans.val() << endl;
}
```

---

### 同类型题与套路  
- **生成函数应用**：如背包问题计数、多重集合组合。  
- **分治NTT**：大数多项式乘法、动态规划优化。  

---

### 推荐题目  
1. [P6012 袜子匹配](https://www.luogu.com.cn/problem/P6012)  
2. [ABC247G Dream Team](https://atcoder.jp/contests/abc247/tasks/abc247_g)  
3. [CF1257G Divisor Set](https://codeforces.com/contest/1257/problem/G)  

---

### 可视化与算法演示  
**动画设计**：  
1. **分治树可视化**：递归分割颜色数组，左右子树生成多项式的系数，合并时显示卷积结果。  
2. **高亮当前项**：在生成函数中，当前计算的 \( x^i \) 项以红色标记。  
3. **组合数递推**：动态显示分母递推公式 \( \binom{S}{k+1} = \binom{S}{k} \cdot \frac{S-k}{k+1} \)。  

**复古像素风格**：  
- **颜色方案**：8-bit 调色板，绿色表示分治步骤，黄色表示卷积操作。  
- **音效触发**：每次分治合并时播放合成音效，错误时蜂鸣声提示。  
- **自动演示**：按帧逐步展示分治与卷积流程，支持暂停/步进。  

**交互面板**：  
- 速度调节滑块控制动画帧间隔。  
- 显示当前步骤的数学公式和代码对应行。  

---

**总结**：本题通过生成函数与分治NTT，高效处理大规模颜色组合问题，结合期望线性性，展现了数学建模与算法优化的精妙结合。

---
处理用时：90.18秒
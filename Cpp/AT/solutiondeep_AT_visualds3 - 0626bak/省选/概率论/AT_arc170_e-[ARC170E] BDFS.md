# 题目信息

# [ARC170E] BDFS

## 题目描述

[problemUrl]: https://atcoder.jp/contests/arc170/tasks/arc170_e

整数 $ N,P $ が与えられます．

頂点に $ 1 $ から $ N $ の番号が付いた $ N $ 頂点 $ N $ 辺のグラフがあります．$ i $ 番目の辺は頂点 $ i $ と頂点 $ i+1 $ を双方向に結んでいます．ここで頂点 $ N+1 $ は頂点 $ 1 $ を意味します．

以下のアルゴリズムを行い，長さ $ N $ の数列 $ D=(D_1,D_2,\ldots,D_N) $ を得ます．

- 長さ $ N $ の整数列 $ D $ を $ D=(D_1,\ldots,D_N)=(-1,\ldots,-1) $ で定める．また，数のペアの列 $ Q $ を $ Q=((1,0)) $ で定める．$ Q $ が空でない限り，以下の処理を繰り返す．
  
  
  - $ Q $ の先頭の要素を $ (v,d) $ とする．先頭の要素を削除する．
  - $ D_v\ =\ -1 $ の場合，$ D_v\ :=\ d $ とし，頂点 $ v $ に隣接して $ D_x=-1 $ を満たすような各頂点 $ x $ に対して以下の処理を行う．ただし条件を満たす $ x $ が複数存在する場合，頂点番号の小さい順に処理を行う．
      
      
      1. 確率 $ \frac{P}{100} $ で $ Q $ の**先頭**に $ (x,d+1) $ を追加する．
      2. $ Q $ の先頭への $ (x,d+1) $ の追加を行わなかった場合，$ Q $ の**末尾**に $ (x,d+1) $ を追加する．
 
最終的に得られる $ D $ の要素の総和の期待値を $ \text{mod\ }\ 998244353 $ で求めてください．

$ T $ 個のテストケースが与えられるので，それぞれについて答えてください．

   期待値 $ \text{mod\ }\ 998244353 $ の定義  求める期待値は必ず有理数になることが証明できます． また，この問題の制約下では，その値を既約分数 $ \frac{P}{Q} $ で表したときに $ Q $ が $ 998244353 $ で割り切れないことが保証されます． このとき $ R\times\ Q\ \equiv\ P\pmod{998244353} $ を満たすような $ 0 $ 以上 $ 998244352 $ 以下の整数 $ R $ が一意に定まります．この $ R $ を 答えてください．

## 说明/提示

### 制約

- $ 1\ \leq\ T\ \leq\ 10^4 $
- $ 3\ \leq\ N\ \leq\ 10^{18} $
- $ 1\leq\ P\ \leq\ 99 $
- 入力される数値は全て整数
 
### Sample Explanation 1

$ 1 $ 番目のテストケースでは，例えば以下のようにアルゴリズムは動きます． - はじめ，$ D=(-1,-1,-1),\ Q=((1,0)) $ である．$ Q $ の先頭の要素 $ (1,0) $ を削除する． - $ D_1\ =\ -1 $ なので，$ D_1\ :=\ 0 $ とする．頂点 $ 1 $ に隣接して $ D_x=\ -1 $ を満たすような頂点 $ x $ は $ 2,3 $ が考えられる． - $ Q $ の先頭に $ (2,1) $ を追加する．$ Q $ の末尾に $ (3,1) $ を追加する．$ Q=((2,1),(3,1)) $ となる． - $ Q $ の先頭の要素 $ (2,1) $ を削除する． - $ D_2\ =\ -1 $ なので，$ D_2\ :=\ 1 $ とする．頂点 $ 2 $ に隣接して $ D_x=\ -1 $ を満たすような頂点 $ x $ は $ 3 $ が考えられる． - $ Q $ の先頭に $ (3,2) $ を追加する．$ Q=((3,2),(3,1)) $ となる． - $ Q $ の先頭の要素 $ (3,2) $ を削除する． - $ D_3\ =\ -1 $ なので，$ D_3\ :=\ 2 $ とする．頂点 $ 3 $ に隣接して $ D_x=\ -1 $ を満たすような頂点 $ x $ は存在しないので何もしない． - $ Q $ の先頭の要素 $ (3,1) $ を削除する． - $ D_3\ =2 $ なので何もしない． - $ Q $ が空になったので処理を終了する． この場合，最終的に $ D=(0,1,2) $ が得られます．アルゴリズムが上記の動作をする確率は $ \frac{1}{8} $ であり，$ D $ の要素の総和の期待値は $ \frac{5}{2} $ です．

## 样例 #1

### 输入

```
3

3 50

4 1

1000000000000000000 70```

### 输出

```
499122179

595552585

760296751```

# AI分析结果



## 算法分类
**动态规划与矩阵快速幂**

---

## 题解思路与解决难点

### 核心思路
题目要求计算环状结构上BFS扩展的期望距离和。每次扩展节点时，新节点以概率 \( P \) 插入队列头部，否则插入尾部。由于队列操作影响后续扩展顺序，需通过概率模型推导期望。

### 解决难点
1. **状态建模**：队列操作会动态改变扩展方向，需将扩展过程抽象为状态转移（如当前方向、队列头尾状态）。
2. **概率传递**：每次操作的 \( P \) 和 \( 1-P \) 需正确嵌入状态转移方程。
3. **大数处理**：\( N \leq 10^{18} \) 要求算法复杂度为 \( O(\log N) \)，需通过矩阵快速幂或数学公式优化。

### 题解对比
- **NobodyThere**：将扩展方向建模为状态 \( (f_0, f_1) \)，通过矩阵快速幂递推期望。思路清晰，矩阵构造直接。
- **DaiRuiChen007**：用 \( f_i, g_i \) 表示队首/尾距离期望，构建 \( 4 \times 4 \) 转移矩阵，代码简洁。
- **qiuzx**：拆解期望为每个操作的贡献，利用生成函数和二项式定理求和，数学推导复杂但计算高效。

### 关键结论
动态规划结合矩阵快速幂是主流解法，状态设计灵活且易于优化。数学推导法虽高效，但需要较高数学技巧。

---

## 题解评分（≥4星）

1. **NobodyThere**（4.5星）  
   - **亮点**：状态转移方程简洁，矩阵构造清晰，适合快速理解扩展方向的变化。
2. **DaiRuiChen007**（4星）  
   - **亮点**：代码实现简洁，4x4矩阵明确跟踪多个状态，适合直接编码。
3. **qiuzx**（4星）  
   - **亮点**：数学推导严谨，生成函数优化复杂度，适合数学背景强的读者。

---

## 最优思路与技巧

### 动态规划 + 矩阵快速幂
- **状态定义**：\( f \) 和 \( g \) 分别表示当前方向及反方向的深度期望。
- **转移方程**：
  \[
  \begin{aligned}
  f' &= p \cdot f + (1-p) \cdot g + 1 \\
  g' &= (1-p) \cdot f + p \cdot g \\
  \text{总和} &\text{累加每一步贡献}
  \end{aligned}
  \]
- **矩阵构造**：将递推关系转化为矩阵乘法，通过快速幂处理 \( N \) 次操作。

### 代码片段（DaiRuiChen007）
```cpp
Mat I,X; // 状态矩阵初始化
I[0][0]=p,I[0][1]=1+MOD-p,I[0][3]=1;
I[1][0]=1+MOD-p,I[1][1]=p;
I[2][0]=p,I[2][1]=1+MOD-p,I[2][2]=1,I[2][3]=1;
I[3][3]=1,X[0][2]=1;
// 矩阵快速幂计算
for(;n;n>>=1,I=I*I) if(n&1) X=X*I;
```

---

## 相似题目推荐
1. **洛谷 P1397**：矩阵快速幂优化递推。
2. **洛谷 P1939**：斐波那契数列的矩阵加速。
3. **洛谷 P5175**：线性递推与矩阵构造。

---

## 可视化设计

### 动画方案
1. **环状结构**：用Canvas绘制环形节点，初始高亮节点1。
2. **扩展过程**：
   - **当前节点**：红色高亮，扩展时向左右相邻节点延伸。
   - **队列状态**：显示队列头部（蓝色）和尾部（绿色）元素。
3. **概率选择**：弹出提示框显示当前操作（插入头/尾）及对应概率。
4. **步进控制**：支持暂停/继续，调整动画速度观察细节。

### 复古像素风格
- **颜色方案**：8位色（红、蓝、绿、黄）区分不同状态。
- **音效**：扩展时播放8位音效，成功结束播放胜利旋律。
- **自动演示**：AI模拟扩展顺序，展示不同概率下的路径差异。

---

## 总结
本题核心在于状态建模与高效递推。矩阵快速幂是处理大数据的标准方法，而数学优化法在特定场景下更高效。可视化设计需突出队列操作与概率选择，帮助理解动态过程。

---
处理用时：74.28秒
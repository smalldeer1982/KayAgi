# 题目信息

# [AGC055C] Weird LIS

## 题目描述

[problemUrl]: https://atcoder.jp/contests/agc055/tasks/agc055_c

整数 $ N,\ M $ が与えられます。次の条件を満たす長さ $ N $ の列 $ A=[A_1,\ A_2,\ \ldots,\ A_N] $ の個数を求めてください。

- $ 2\ \le\ A_i\ \le\ M $ ($ 1\ \leq\ i\ \leq\ N $)
- $ 1 $ から $ N $ までの整数の順列 $ P=[P_1,P_2,\ldots,P_N] $ であって次の性質を持つものが存在する。
  - $ 1 $ から $ N $ までの各 $ i $ について、$ A_i $ は列 $ [P_1,\ P_2,\ \ldots,\ P_{i-1},\ P_{i+1},\ \ldots,\ P_{N-1},\ P_N] $ の最長増加部分列の長さに等しい。

この個数は非常に大きい可能性があるため、これを素数 $ Q $ で割った余りを出力してください。

## 说明/提示

### 制約

- $ 3\ \le\ N\ \le\ 5000 $
- $ 2\ \le\ M\ \le\ N-1 $
- $ 10^8\ \le\ Q\ \le\ 10^9 $
- $ Q $ は素数である。

### Sample Explanation 1

このような列は $ [2,\ 2,\ 2] $ のみです。ここで $ [1,\ 2,\ 3] $ という順列が存在して性質を満たします。

### Sample Explanation 2

このような列は次の $ 9 $ 個です: $ [2,\ 2,\ 2,\ 2] $, $ [2,\ 2,\ 2,\ 3] $, $ [2,\ 2,\ 3,\ 2] $, $ [2,\ 2,\ 3,\ 3] $, $ [2,\ 3,\ 2,\ 2] $, $ [2,\ 3,\ 3,\ 2] $, $ [3,\ 2,\ 2,\ 2] $, $ [3,\ 3,\ 2,\ 2] $, $ [3,\ 3,\ 3,\ 3] $。

### Sample Explanation 3

このような列は $ [2,\ 2,\ 2,\ 2,\ 2] $ のみです。

## 样例 #1

### 输入

```
3 2 686926217```

### 输出

```
1```

## 样例 #2

### 输入

```
4 3 354817471```

### 输出

```
9```

## 样例 #3

### 输入

```
5 2 829412599```

### 输出

```
1```

## 样例 #4

### 输入

```
5 3 975576997```

### 输出

```
23```

## 样例 #5

### 输入

```
69 42 925171057```

### 输出

```
801835311```

# AI分析结果



**算法分类**  
组合数学

**题解思路、算法要点与解决难点**  
核心思路是分析排列中必经点（A_i=K-1）与非必经点（A_i=K）的组合关系。  
1. **必经点与非必经点的贡献**：若有x个必经点，LIS长度K至少为x。非必经点成对出现，每对贡献1的LIS长度，剩余点为无用点。  
2. **组合枚举**：枚举必经点数x与非必经点对数y，通过组合数公式计算分配方案：  
   - 用$\binom{x+y}{y}$分配必经点和非必经点对的顺序。  
   - 用$\binom{x+1}{n-x-2y}$将剩余点分配到各区间。  
   - 计算K的可能取值范围$\max(x,3)\sim\min(m,x+y)$，累加有效方案数。  
3. **动态规划替代思路**：部分题解尝试用状态转移模型（如自动机）跟踪红黑对、蓝绿点的组合，但复杂度较高。  

**题解评分 (≥4星)**  
1. **Legitimity (5星)**：思路清晰，组合推导严谨，代码简洁高效。  
2. **DaiRuiChen007 (5星)**：代码实现最优，直接应用组合公式，时间复杂度低。  
3. **Edward1002001 (4星)**：补充插板法细节，帮助理解组合逻辑。  

**最优思路或技巧提炼**  
1. **组合枚举策略**：通过必经点x和非必经点对y的组合，将问题转化为插板法模型。  
2. **区间贡献计算**：每段区间的贡献为$\lfloor\frac{\text{长度}}{2}\rfloor$，通过组合数分配剩余点。  
3. **值域区间处理**：$\min(m,x+y)-\max(x,3)+1$给出合法K的数量。  

**同类型题或类似算法套路**  
- **LIS相关计数问题**：如统计满足特定LIS性质的排列数。  
- **组合分配问题**：将元素分组并计算组合贡献，如背包问题的变种。  

**推荐题目**  
1. P1020 [NOIP1999 提高组] 导弹拦截（LIS应用）  
2. P2513 [HAOI2009]逆序对数列（组合计数）  
3. CF1295F Good Contest（区间划分与组合数）  

**个人心得摘录**  
- **Legitimity**：构造方案时需注意无用点的填法避免非法情况。  
- **BYR_KKK**：动态规划状态设计需仔细处理极长连续段的奇偶性。  

**可视化与算法演示**  
1. **核心逻辑动画**：  
   - **Canvas网格绘制**：将排列划分为必经点（绿色）、红黑对（红黑交替）、无用点（蓝色）。  
   - **步进操作**：点击按钮逐步展示必经点与非必经点对的插入过程。  
   - **组合数动态计算**：实时显示$\binom{x+y}{y}$与$\binom{x+1}{r}$的计算结果。  
2. **复古游戏化效果**：  
   - **像素风格**：用16色块表示不同类型点，如绿色方块（必经点）、红黑条纹（非必经对）。  
   - **音效设计**：插入点时播放“滴”声，完成组合时播放胜利音效。  
   - **自动演示模式**：模拟AI自动枚举x和y，高亮当前计算区间。  

**代码实现（DaiRuiChen007）**  
```cpp
#include<bits/stdc++.h>
#define ll long long
using namespace std;
const int MAXN=1e4+5;
int n,m,MOD;
ll fac[MAXN],ifac[MAXN];
ll ksm(ll a,ll b=MOD-2) { 
    ll s=1; 
    for(;b;a=a*a%MOD,b>>=1) if(b&1) s=s*a%MOD; 
    return s; 
}
ll C(int x,int y) {
    if(x<0||y<0||y>x) return 0;
    return fac[x]*ifac[y]%MOD*ifac[x-y]%MOD;
}
signed main() {
    scanf("%d%d%d",&n,&m,&MOD);
    for(int i=fac[0]=ifac[0]=1;i<MAXN;++i) 
        ifac[i]=ksm(fac[i]=fac[i-1]*i%MOD);
    ll ans=1;
    if(n>3&&(m==n-1)) ++ans;
    for(int k=0;k<=n;++k) 
        for(int s=0;2*s+k<=n;++s) {
            ans=(ans+C(s+k,k)*C(k+1,n-k-2*s)%MOD*
                max(min(m,k+s)-max(k,3)+1,0))%MOD;
        }
    printf("%lld\n",ans);
    return 0;
}
```  
**核心逻辑**：  
1. 预处理组合数，枚举必经点数k和非必经点对s。  
2. 计算组合数$\binom{k+s}{k}$分配顺序，$\binom{k+1}{n-k-2s}$分配剩余点。  
3. 累加每个(k,s)对的有效值域区间贡献。

---
处理用时：70.69秒
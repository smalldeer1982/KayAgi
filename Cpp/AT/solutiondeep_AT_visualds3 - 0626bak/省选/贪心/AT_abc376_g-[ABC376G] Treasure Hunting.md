# 题目信息

# [ABC376G] Treasure Hunting

## 题目描述

[problemUrl]: https://atcoder.jp/contests/abc376/tasks/abc376_g

頂点に $ 0 $ から $ N $ までの番号がついた $ N\ +\ 1 $ 頂点の根付き木があります。頂点 $ 0 $ は根で、頂点 $ i $ の親は頂点 $ p_i $ です。  
 頂点 $ 1 $, 頂点 $ 2 $, $ \dots $, 頂点 $ N $ のうちどこか $ 1 $ 頂点に宝が隠されています。頂点 $ i $ に宝がある確率は $ \frac{a_i}{\sum_{j=1}^N\ a_j} $ です。 また、各頂点には「探索済」と「未探索」のどちらか一方の状態を持ちます。はじめ頂点 $ 0 $ は探索済で、それ以外の頂点は未探索です。  
 あなたは、宝がある頂点が探索済になるまで以下の操作を行います。

- 親が探索済であるような未探索の頂点を選び、その頂点を探索済にする。
 
操作回数の期待値が最小になるように行動した時の操作回数の期待値を $ \text{mod\ }998244353 $ で求めてください。

$ T $ 個のテストケースが与えられるので、それぞれに対して答えを求めてください。

  期待値 $ \text{mod\ }{998244353} $ の定義 求める期待値は必ず有理数になることが証明できます。 また、この問題の制約のもとでは、その値を既約分数 $ \frac{P}{Q} $ で表した時、$ Q\ \not\ \equiv\ 0\ \pmod{998244353} $ となることも証明できます。このとき、$ R\ \times\ Q\ \equiv\ P\ \pmod{998244353},\ 0\ \leq\ R\ \lt\ 998244353 $ を満たす整数 $ R $ が一意に定まります。この $ R $ を答えてください。

## 说明/提示

### 制約

- $ 1\ \leq\ T\ \leq\ 2\ \times\ 10^5 $
- $ 1\ \leq\ N\ \leq\ 2\ \times\ 10^5 $
- $ 0\ \leq\ p_i\ \lt\ i $
- $ 1\ \leq\ a_i $
- $ \sum_{i=1}^N\ a_i\ \leq\ 10^8 $
- 全てのテストケースに対する $ N $ の総和は $ 2\ \times\ 10^5 $ 以下
- 入力される値は全て整数
 
### Sample Explanation 1

$ 1 $ 番目のテストケースにおける操作回数の期待値は $ \frac{13}{6} $ です。

## 样例 #1

### 输入

```
3

3

0 0 1

1 2 3

5

0 1 0 0 0

8 6 5 1 7

10

0 1 1 3 3 1 4 7 5 4

43 39 79 48 92 90 76 30 16 30```

### 输出

```
166374061

295776107

680203339```

# AI分析结果



---

## 综合分析与结论

### 核心思路
所有题解均采用**贪心策略+并查集维护连通块**，核心思想是每次选择当前最优的连通块合并到父节点所在连通块。关键贪心条件为：当两个连通块 $A$、$B$ 满足 $\frac{sum_A}{siz_A} \geq \frac{sum_B}{siz_B}$ 时，优先合并 $A$（其中 $sum$ 为概率总和，$siz$ 为节点数量）。

### 贪心推导
假设合并 $A$ 和 $B$ 的顺序影响总期望，推导得出：  
- 先合并 $A$ 的贡献为 $ans_A + ans_B + siz_A \cdot sum_B$  
- 先合并 $B$ 的贡献为 $ans_B + ans_A + siz_B \cdot sum_A$  
比较二者差异可得贪心条件 $\frac{sum_A}{siz_A} \geq \frac{sum_B}{siz_B}$。

### 数据结构
- **优先队列**：维护当前所有连通块，按 $\frac{sum}{siz}$ 从大到小排序。  
- **并查集**：快速合并连通块并维护父子关系。

---

## 题解清单（≥4星）

### 1. zhm080507（⭐⭐⭐⭐⭐）
**亮点**：  
- 清晰的结构体设计，代码简洁高效。  
- 正确实现贪心条件比较与合并公式。  
- 使用模逆元处理除法。

### 2. 沉石鱼惊旋（⭐⭐⭐⭐）
**亮点**：  
- 详细推导贪心条件的数学证明。  
- 提出绑定节点的平均权重思想，与经典贪心问题类比。

### 3. RAND_MAX（⭐⭐⭐⭐）
**亮点**：  
- 将问题转化为排列构造问题，直观易懂。  
- 代码中明确标注关键公式，便于理解。

---

## 最优思路提炼

### 关键贪心策略
1. **平均权重优先**：每次选择 $\frac{sum}{siz}$ 最大的连通块合并。  
2. **合并公式**：合并后的贡献为 $ans = ans_A + ans_B + siz_A \cdot sum_B$。  
3. **数据结构优化**：优先队列快速选出最优块，并查集维护合并关系。

### 代码核心实现
```cpp
struct Node {
    int val, siz, p, id; // val:期望贡献, siz:节点数, p:概率总和
    bool operator<(Node y) {
        return siz * y.p < y.siz * p; // 平均权重比较
    }
};

priority_queue<Node> q;
while (!q.empty()) {
    Node u = q.top(); q.pop();
    int fa = find(u.id); // 找到父节点所在连通块
    merge(u.id, fa);     // 合并到父块
    q.push(合并后的新块);
}
```

---

## 同类型题推荐
1. **AT_agc023_f**：树上贪心合并，类似条件推导。  
2. **CF1251E2**：投票问题，贪心选择阈值。  
3. **Luogu P1230**：智力大冲浪，任务调度贪心。

---

## 可视化设计（复古像素风格）

### 动画演示
- **Canvas 网格**：每个节点为像素方块，父块高亮绿色，子块黄色。  
- **合并特效**：子块飞向父块，伴随粒子效果。  
- **音效**：合并时播放8-bit "ping"声，错误时短促蜂鸣。

### 交互功能
- **自动模式**：AI 按贪心策略自动执行，速度可调。  
- **步进控制**：手动点击观察每一步选择。  
- **数据面板**：实时显示当前选中块的 $\frac{sum}{siz}$ 值。

---

## 个人心得摘录
> "赛后发现很多地方挂了，罚了3发才好的。" —— huangrenheluogu  
调试时需注意：  
1. 并查集路径压缩是否正确。  
2. 模运算中的负值处理。  
3. 初始根节点（0号）的特殊处理。

---
处理用时：65.57秒
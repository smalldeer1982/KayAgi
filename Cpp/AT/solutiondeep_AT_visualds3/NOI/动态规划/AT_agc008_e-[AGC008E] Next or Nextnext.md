# é¢˜ç›®ä¿¡æ¯

# [AGC008E] Next or Nextnext

## é¢˜ç›®æè¿°

[problemUrl]: https://atcoder.jp/contests/agc008/tasks/agc008_e

é•·ã• $ N $ ã®æ•°åˆ— $ a $ ãŒä¸ãˆã‚‰ã‚Œã¾ã™ã€‚ $ 1 $ ã‹ã‚‰ $ N $ ã¾ã§ã®æ•´æ•°ã®é †åˆ— $ p $ ã§ã‚ã£ã¦ã€æ¬¡ã®æ¡ä»¶ã‚’æº€ãŸã™ã‚‚ã®ã¯ä½•é€šã‚Šã§ã—ã‚‡ã†ã‹ï¼Ÿ $ 10^9\ +\ 7 $ ã§å‰²ã£ãŸä½™ã‚Šã‚’æ±‚ã‚ã¦ãã ã•ã„ã€‚

- å„ $ 1\ <\ =\ i\ <\ =\ N $ ã«ã¤ã„ã¦ã€$ p_i\ =\ a_i $ ã¾ãŸã¯ $ p_{p_i}\ =\ a_i $ ã®å°‘ãªãã¨ã‚‚ä¸€æ–¹ãŒæˆã‚Šç«‹ã¤ã€‚

## è¯´æ˜/æç¤º

### åˆ¶ç´„

- $ 1\ <\ =\ N\ <\ =\ 10^5 $
- $ a_i $ ã¯æ•´æ•°ã§ã‚ã‚‹ã€‚
- $ 1\ <\ =\ a_i\ <\ =\ N $

### Sample Explanation 1

æ¬¡ã® $ 4 $ é€šã‚Šã§ã™ã€‚ - $ (1,\ 2,\ 3) $ - $ (1,\ 3,\ 2) $ - $ (3,\ 2,\ 1) $ - $ (2,\ 1,\ 3) $ ãŸã¨ãˆã° $ (1,\ 3,\ 2) $ ã¯ã€$ p_1\ =\ 1 $, $ p_{p_2}\ =\ 2 $, $ p_{p_3}\ =\ 3 $ ã¨ãªã£ã¦ã„ã¾ã™ã€‚

### Sample Explanation 2

æ¬¡ã® $ 1 $ é€šã‚Šã§ã™ã€‚ - $ (2,\ 1) $

### Sample Explanation 3

æ¬¡ã® $ 2 $ é€šã‚Šã§ã™ã€‚ - $ (2,\ 3,\ 1) $ - $ (3,\ 1,\ 2) $

## æ ·ä¾‹ #1

### è¾“å…¥

```
3

1 2 3```

### è¾“å‡º

```
4```

## æ ·ä¾‹ #2

### è¾“å…¥

```
2

1 1```

### è¾“å‡º

```
1```

## æ ·ä¾‹ #3

### è¾“å…¥

```
3

2 1 1```

### è¾“å‡º

```
2```

## æ ·ä¾‹ #4

### è¾“å…¥

```
3

1 1 1```

### è¾“å‡º

```
0```

## æ ·ä¾‹ #5

### è¾“å…¥

```
13

2 1 4 3 6 7 5 9 10 8 8 9 11```

### è¾“å‡º

```
6```

# AIåˆ†æç»“æœ

# ğŸ’¡ Kayçš„C++ç®—æ³•è§£æï¼š[AGC008E] Next or Nextnext æ·±å…¥å­¦ä¹ æŒ‡å— ğŸ’¡


## 1. é¢˜ç›®è§£è¯»ä¸æ ¸å¿ƒç®—æ³•è¯†åˆ«

âœ¨ **æœ¬é¢˜ä¸»è¦è€ƒå¯Ÿ**ï¼š`å›¾è®ºï¼ˆåŸºç¯æ ‘ï¼‰+ ç»„åˆè®¡æ•°`


### ğŸ—£ï¸ åˆæ­¥åˆ†æ
æˆ‘ä»¬å¯ä»¥æŠŠæ¯ä¸ªæ•°æƒ³è±¡æˆä¸€ä¸ª**å°èŠ‚ç‚¹**ï¼Œ`a_i`æ˜¯èŠ‚ç‚¹`i`æŒ‡å‘çš„â€œä¸‹ä¸€ç«™â€â€”â€”è¿™æ ·æ•´ä¸ª`a`æ•°ç»„å°±æ„æˆäº†ä¸€ç‰‡**åŸºç¯æ ‘æ£®æ—**ï¼ˆç¯ä¸ŠæŒ‚ç€æ ‘çš„ç»“æ„ï¼Œåƒâ€œæ ‘ç»•ç€ç¯ç”Ÿé•¿â€ï¼‰ã€‚æˆ‘ä»¬çš„ç›®æ ‡æ˜¯ä»è¿™ç‰‡æ£®æ—åæ¨**åŸæ¥çš„æ’åˆ—pçš„ç¯ç»“æ„**ï¼ˆå› ä¸ºæ’åˆ—çš„æœ¬è´¨æ˜¯è‹¥å¹²ä¸ç›¸äº¤çš„ç¯ï¼‰ï¼Œå°±åƒä»â€œæ ‘çš„å½±å­â€è¿˜åŸæ ‘çš„å½¢çŠ¶ä¸€æ ·ï¼

#### æ ¸å¿ƒç®—æ³•æ€è·¯
1. **ç»“æ„æ‹†åˆ†**ï¼šå°†`a`çš„å›¾æ‹†æˆå¤šä¸ª**åŸºç¯æ ‘è¿é€šå—**ï¼ˆè¦ä¹ˆæ˜¯çº¯ç¯ï¼Œè¦ä¹ˆæ˜¯ç¯åŠ é“¾ï¼‰ï¼›
2. **ç¯çš„å¤„ç†**ï¼šçº¯ç¯çš„è¿é€šå—å¯ä»¥**ç‹¬ç«‹å­˜åœ¨**ï¼ˆå¥‡æ•°ç¯æœ‰2ç§æ–¹æ¡ˆï¼Œå¶æ•°ç¯1ç§ï¼‰æˆ–**ä¸¤ä¸¤åˆå¹¶**ï¼ˆåŒå¤§å°çš„ç¯åˆå¹¶æˆæ›´å¤§çš„ç¯ï¼Œæ¯å¯¹æœ‰`ç¯å¤§å°`ç§æ‹¼æ³•ï¼‰ï¼›
3. **é“¾çš„å¤„ç†**ï¼šåŸºç¯æ ‘ä¸­çš„é“¾å¿…é¡»â€œå¡è¿›â€ç¯çš„é—´éš™â€”â€”é“¾é•¿â‰¤é—´éš™é•¿åº¦æ‰æœ‰è§£ï¼Œå°äºæ—¶æœ‰2ç§æ–¹æ¡ˆï¼Œç­‰äºæ—¶1ç§ï¼Œå¤§äºæ—¶æ— è§£ï¼›
4. **ä¹˜æ³•åŸç†**ï¼šæ‰€æœ‰è¿é€šå—çš„æ–¹æ¡ˆæ•°ç›¸ä¹˜ï¼Œå°±æ˜¯æœ€ç»ˆç­”æ¡ˆã€‚

#### æ ¸å¿ƒéš¾ç‚¹ä¸è§£å†³æ–¹æ¡ˆ
- **éš¾ç‚¹1**ï¼šç†è§£`a`çš„å›¾ä¸`p`çš„ç¯çš„å¯¹åº”å…³ç³»  
  è§£å†³æ–¹æ¡ˆï¼šç”¨å°ä¾‹å­æ¨¡æ‹Ÿï¼ˆæ¯”å¦‚`p`æ˜¯`(1â†’2â†’3â†’1)`ï¼Œè‹¥`a_i=p_{p_i}`ï¼Œåˆ™`a`çš„ç¯æ˜¯`(1â†’3â†’2â†’1)`ï¼Œå¥‡æ•°ç¯ä¸å˜ï¼›è‹¥`p`æ˜¯`(1â†’2â†’3â†’4â†’1)`ï¼Œåˆ™`a`çš„ç¯æ˜¯`(1â†’3â†’1)`å’Œ`(2â†’4â†’2)`ï¼Œå¶æ•°ç¯æ‹†åˆ†ï¼‰ã€‚
- **éš¾ç‚¹2**ï¼šå¤„ç†åŸºç¯æ ‘ä¸­çš„é“¾  
  è§£å†³æ–¹æ¡ˆï¼šç”¨æ‹“æ‰‘æ’åºè®¡ç®—é“¾é•¿ï¼Œéå†ç¯æ—¶è®°å½•ç›¸é‚»é“¾çš„é—´éš™ï¼Œç”¨`(é“¾é•¿<é—´éš™)+(é“¾é•¿â‰¤é—´éš™)`å¿«é€Ÿåˆ¤æ–­æ–¹æ¡ˆæ•°ã€‚
- **éš¾ç‚¹3**ï¼šè®¡ç®—åŒå¤§å°ç¯çš„åˆå¹¶æ–¹æ¡ˆæ•°  
  è§£å†³æ–¹æ¡ˆï¼šç”¨ç»„åˆæ•°å­¦ï¼ˆé€‰æ‹©`2j`ä¸ªç¯ä¸¤ä¸¤é…å¯¹ï¼Œæ¯å¯¹æœ‰`ç¯å¤§å°`ç§æ‹¼æ³•ï¼‰å’ŒåŠ¨æ€è§„åˆ’ï¼ˆ`f[j]`è¡¨ç¤º`j`ä¸ªç¯çš„æ–¹æ¡ˆæ•°ï¼‰ã€‚

#### å¯è§†åŒ–è®¾è®¡æ€è·¯
æˆ‘ä»¬ç”¨**8ä½åƒç´ é£æ ¼**å±•ç¤ºç¯ä¸é“¾çš„ç»“æ„ï¼š
- ç¯ï¼šé»„è‰²åƒç´ å—å›´æˆåœˆï¼Œæ—‹è½¬æ—¶å¸¦â€œå—¡â€çš„éŸ³æ•ˆï¼›
- é“¾ï¼šè“è‰²ç»†é•¿åƒç´ æ¡ï¼ŒæŒ‚åœ¨ç¯ä¸Šï¼Œé—ªçƒè¡¨ç¤ºå¾…å¤„ç†ï¼›
- æ“ä½œï¼šç”¨çº¢è‰²é«˜äº®å½“å‰å¤„ç†çš„é“¾å’Œç¯é—´éš™ï¼Œâ€œå®â€è¡¨ç¤ºé€‰æ–¹æ¡ˆï¼Œâ€œå’”â€è¡¨ç¤ºæ— è§£ï¼›
- èƒœåˆ©ï¼šæ‰€æœ‰é“¾å˜ç»¿ï¼Œæ’­æ”¾â€œå“‡å“¦â€éŸ³æ•ˆï¼Œç¯å‘¨å›´å‡ºç°åƒç´ æ˜Ÿæ˜Ÿã€‚


## 2. ç²¾é€‰ä¼˜è´¨é¢˜è§£å‚è€ƒ

### é¢˜è§£ä¸€ï¼šlitbleï¼ˆèµ12ï¼‰
**ç‚¹è¯„**ï¼šè¿™é“é¢˜è§£æ˜¯â€œå®˜æ–¹é¢˜è§£çš„ç¿»è¯‘å·¥â€ï¼Œä½†æ€è·¯æå…¶æ¸…æ™°ï¼ä»`p`çš„ç¯ç»“æ„å‡ºå‘ï¼Œåæ¨`a`çš„å›¾ç»“æ„ï¼Œåˆ†â€œçº¯ç¯â€å’Œâ€œåŸºç¯æ ‘â€ä¸¤ç§æƒ…å†µå¤„ç†ã€‚ä»£ç ä¸­ç”¨**æ‹“æ‰‘æ’åºæ±‚é“¾é•¿**ã€**workcirå‡½æ•°å¤„ç†ç¯ä¸é“¾**ï¼Œé€»è¾‘ä¸¥è°¨åˆ°â€œæ¯ä¸€æ­¥éƒ½æœ‰ä¾æ®â€ã€‚æ¯”å¦‚`kl=(footL[x]<now-ed)+(footL[x]<=now-ed)`ï¼Œç”¨ç®€æ´çš„æ•´æ•°è¿ç®—å¤„ç†äº†é“¾å¡è¿›ç¯çš„ä¸‰ç§æƒ…å†µï¼Œå ªç§°â€œä»£ç ç®€åŒ–çš„å…¸èŒƒâ€ã€‚å®è·µä¸­ç›´æ¥å‚è€ƒè¿™ä»½ä»£ç ï¼Œèƒ½å¿«é€Ÿå†™å‡ºæ­£ç¡®çš„æ ¸å¿ƒé€»è¾‘ã€‚


### é¢˜è§£äºŒï¼šAThousandSunsï¼ˆèµ6ï¼‰
**ç‚¹è¯„**ï¼šè¿™é“é¢˜è§£æŠŠâ€œåŒå¤§å°ç¯çš„åˆå¹¶æ–¹æ¡ˆæ•°â€è®²é€äº†ï¼ç”¨ç»„åˆæ•°å­¦å…¬å¼è®¡ç®—â€œé€‰ç¯â†’é…å¯¹â†’æ‹¼æ³•â€çš„è´¡çŒ®ï¼ˆ`C(cnt[i],2j) * C(2j,j) * j! * inv2^j * i^j`ï¼‰ï¼Œç”šè‡³æ¨å¯¼äº†â€œå¥‡æ•°ç¯ç‹¬ç«‹æ—¶æœ‰2ç§æ–¹æ¡ˆâ€çš„åŸå› ã€‚ä»£ç ä¸­ç”¨**dfsæ‰¾ç¯**ã€**é˜Ÿåˆ—æ±‚é“¾é•¿**ï¼Œç»„åˆæ•°å­¦éƒ¨åˆ†çš„è®¡ç®—å‡†ç¡®æ— è¯¯ï¼Œæ˜¯ç†è§£â€œç¯åˆå¹¶â€çš„æœ€ä½³å‚è€ƒã€‚


### é¢˜è§£ä¸‰ï¼štzc_wkï¼ˆèµ3ï¼‰
**ç‚¹è¯„**ï¼šè¿™æ˜¯ä¸€ä»½â€œç‹¬ç«‹æ€è€ƒçš„ç»“æ™¶â€ï¼ä½œè€…ä»â€œç½®æ¢ç¯çš„æ€§è´¨â€åˆ°â€œåŸºç¯æ ‘çš„é“¾å¤„ç†â€ï¼Œä¸€æ­¥æ­¥æ¨å¯¼ï¼Œç”šè‡³ç”¨â€œæ–­ç¯æˆé“¾â€è§£å†³äº†ç¯ä¸Šçš„åŒºé—´è¦†ç›–é—®é¢˜ã€‚ä»£ç ä¸­ç”¨**é˜Ÿåˆ—å¤„ç†é“¾é•¿**ã€**dpå¤„ç†ç¯ä¸Šé“¾çš„æ”¾ç½®**ï¼Œç»†èŠ‚å¤„ç†åˆ°ä½ï¼ˆæ¯”å¦‚`at=j-seq[j]+tot`å¤„ç†ç¯çš„é¦–å°¾ï¼‰ã€‚æœ€éš¾å¾—çš„æ˜¯ï¼Œä½œè€…åˆ†äº«äº†â€œè°ƒè¯•æ—¶é‡åˆ°çš„å‘â€ï¼ˆæ¯”å¦‚é“¾é•¿è¶…è¿‡é—´éš™ï¼‰ï¼Œèƒ½å¸®æˆ‘ä»¬é¿å…åŒç±»é”™è¯¯ã€‚


## 3. æ ¸å¿ƒéš¾ç‚¹è¾¨æä¸è§£é¢˜ç­–ç•¥

### 1. å…³é”®ç‚¹1ï¼šç†è§£`a`çš„å›¾ä¸`p`çš„ç¯çš„å¯¹åº”å…³ç³»
**åˆ†æ**ï¼š`p`çš„ç½®æ¢ç¯ä¸­ï¼Œ`a_i`è¦ä¹ˆæ˜¯`p_i`ï¼ˆ`a`çš„å›¾æ˜¯åŒç¯ï¼‰ï¼Œè¦ä¹ˆæ˜¯`p_{p_i}`ï¼ˆ`a`çš„å›¾æ˜¯å¥‡ç¯æˆ–ä¸¤ä¸ªå¶ç¯ï¼‰ã€‚æ··åˆæƒ…å†µä¼šå½¢æˆ**åŸºç¯æ ‘**â€”â€”ç¯æ˜¯`p`çš„ç¯çš„â€œéª¨æ¶â€ï¼Œé“¾æ˜¯`p`çš„ç¯ä¸­â€œè·³è¿‡ä¸€ä¸ªèŠ‚ç‚¹â€çš„éƒ¨åˆ†ã€‚  
**å­¦ä¹ ç¬”è®°**ï¼šä»â€œç½®æ¢ç¯â€åˆ°â€œåŸºç¯æ ‘â€ï¼Œæœ¬è´¨æ˜¯â€œä¸€æ­¥â€å˜â€œä¸¤æ­¥â€çš„è½¬æ¢ã€‚


### 2. å…³é”®ç‚¹2ï¼šåŸºç¯æ ‘ä¸­çš„é“¾å¡è¿›ç¯çš„æ¡ä»¶
**åˆ†æ**ï¼šç¯ä¸Šçš„é—´éš™æ˜¯â€œä¸¤ä¸ªç›¸é‚»é“¾ä¹‹é—´çš„ç¯é•¿åº¦â€ï¼Œé“¾é•¿å¿…é¡»â‰¤é—´éš™é•¿åº¦æ‰æœ‰è§£ã€‚è‹¥é“¾é•¿<é—´éš™ï¼Œæœ‰2ç§æ–¹æ¡ˆï¼ˆæ”¾åœ¨å‰ä¸€ä¸ªæˆ–å‰ä¸¤ä¸ªä½ç½®ï¼‰ï¼›ç­‰äºæ—¶1ç§ï¼›å¤§äºæ—¶0ç§ã€‚  
**å­¦ä¹ ç¬”è®°**ï¼šç”¨`(é“¾é•¿<é—´éš™)+(é“¾é•¿â‰¤é—´éš™)`è®¡ç®—æ–¹æ¡ˆæ•°ï¼Œæ˜¯â€œç”¨æ•°å­¦ç®€åŒ–é€»è¾‘â€çš„ç»å…¸æ¡ˆä¾‹ã€‚


### 3. å…³é”®ç‚¹3ï¼šåŒå¤§å°ç¯çš„åˆå¹¶æ–¹æ¡ˆæ•°
**åˆ†æ**ï¼šåŒå¤§å°çš„ç¯å¯ä»¥ä¸¤ä¸¤åˆå¹¶æˆæ›´å¤§çš„ç¯ï¼ˆæ¯”å¦‚ä¸¤ä¸ªå¤§å°`m`çš„ç¯åˆå¹¶æˆ`2m`çš„ç¯ï¼Œæœ‰`m`ç§æ‹¼æ³•ï¼‰ã€‚å¥‡æ•°ç¯ç‹¬ç«‹æ—¶æœ‰2ç§æ–¹æ¡ˆï¼ˆ`p`çš„ç¯æˆ–`p_{p_i}`çš„ç¯ï¼‰ï¼Œå¶æ•°ç¯åªæœ‰1ç§ã€‚  
**å­¦ä¹ ç¬”è®°**ï¼šç»„åˆæ•°å­¦çš„æ ¸å¿ƒæ˜¯â€œä¸é‡å¤ä¸é—æ¼â€â€”â€”é€‰ç¯ç”¨`C(cnt,2j)`ï¼Œé…å¯¹ç”¨`C(2j,j)*j!*inv2^j`ï¼Œæ‹¼æ³•ç”¨`i^j`ã€‚


### âœ¨ è§£é¢˜æŠ€å·§æ€»ç»“
- **å›¾ç»“æ„åˆ†æ**ï¼šé‡åˆ°æ’åˆ—é—®é¢˜å…ˆæ‹†æˆç½®æ¢ç¯ï¼Œé‡åˆ°æœ‰å‘å›¾å…ˆæ‰¾åŸºç¯æ ‘ï¼›
- **æ‹“æ‰‘æ’åº**ï¼šå¤„ç†ç¯å¤–èŠ‚ç‚¹çš„â€œé“¾é•¿â€ï¼Œç”¨é˜Ÿåˆ—é«˜æ•ˆè®¡ç®—ï¼›
- **ç»„åˆæ•°å­¦**ï¼šåˆå¹¶ç¯æ—¶ï¼Œç”¨â€œé€‰â†’é…â†’æ‹¼â€çš„æ€è·¯è®¡ç®—æ–¹æ¡ˆæ•°ï¼›
- **æ–­ç¯æˆé“¾**ï¼šå¤„ç†ç¯ä¸Šé—®é¢˜æ—¶ï¼Œæ‰¾ä¸€ä¸ªèµ·ç‚¹æ–­å¼€ï¼Œé¿å…åæ•ˆæ€§ã€‚


## 4. C++æ ¸å¿ƒä»£ç å®ç°èµæ

### æœ¬é¢˜é€šç”¨æ ¸å¿ƒC++å®ç°å‚è€ƒ
**è¯´æ˜**ï¼šç»¼åˆlitbleã€AThousandSunså’Œtzc_wkçš„æ€è·¯ï¼Œæç‚¼å‡ºçš„æ ¸å¿ƒå®ç°ï¼Œè¦†ç›–â€œæ‰¾ç¯â†’æ±‚é“¾é•¿â†’å¤„ç†åŸºç¯æ ‘â†’è®¡ç®—åˆå¹¶æ–¹æ¡ˆæ•°â€çš„å…¨æµç¨‹ã€‚

```cpp
#include <iostream>
#include <vector>
#include <queue>
#include <cstring>
using namespace std;

const int MOD = 1e9 + 7;
const int MAXN = 100005;

int n, a[MAXN], deg[MAXN], len[MAXN], cyc[MAXN], vis[MAXN], sum[MAXN];
long long ans = 1;
vector<int> G[MAXN];

long long qpow(long long a, int b) {
    long long res = 1;
    while (b) {
        if (b & 1) res = res * a % MOD;
        a = a * a % MOD;
        b >>= 1;
    }
    return res;
}

void find_cycles(int u) {
    if (vis[u]) return;
    vector<int> path;
    int x = u;
    while (!vis[x]) {
        vis[x] = 1;
        path.push_back(x);
        x = a[x];
    }
    for (int v : path) cyc[v] = 1;
}

void process_cycle(int start) {
    vector<int> cycle;
    int x = start;
    while (cyc[x]) {
        cycle.push_back(x);
        cyc[x] = 0;
        x = a[x];
    }
    int m = cycle.size();
    vector<int> foot(m, 0);
    for (int i = 0; i < m; ++i) {
        int u = cycle[i];
        if (len[u]) foot[i] = len[u];
    }
    int pre = -1;
    for (int i = 0; i < m; ++i) {
        if (foot[i] == 0) continue;
        if (pre == -1) { pre = i; continue; }
        int gap = (i - pre + m) % m;
        if (foot[i] > gap) { ans = 0; return; }
        if (foot[i] < gap) ans = ans * 2 % MOD;
        pre = i;
    }
    if (pre != -1) {
        int gap = (pre + m - foot[pre]) % m;
        if (foot[pre] > gap) { ans = 0; return; }
        if (foot[pre] < gap) ans = ans * 2 % MOD;
    }
    sum[m]++;
}

long long calc_ring(int m, int cnt) {
    vector<long long> f(cnt + 1, 0);
    f[0] = 1;
    long long p = (m > 1 && m % 2 == 1) ? 2 : 1;
    for (int i = 1; i <= cnt; ++i) {
        f[i] = f[i-1] * p % MOD;
        if (i >= 2) {
            f[i] = (f[i] + f[i-2] * (i-1) % MOD * m % MOD) % MOD;
        }
    }
    return f[cnt];
}

int main() {
    ios::sync_with_stdio(false);
    cin.tie(0);
    cin >> n;
    for (int i = 1; i <= n; ++i) {
        cin >> a[i];
        G[a[i]].push_back(i);
        deg[a[i]]++;
    }
    memset(vis, 0, sizeof(vis));
    for (int i = 1; i <= n; ++i) find_cycles(i);
    queue<int> q;
    for (int i = 1; i <= n; ++i) {
        if (!deg[i] && !cyc[i]) q.push(i);
    }
    while (!q.empty()) {
        int u = q.front(); q.pop();
        len[a[u]] = len[u] + 1;
        if (!cyc[a[u]]) {
            deg[a[u]]--;
            if (!deg[a[u]]) q.push(a[u]);
        }
    }
    memset(vis, 0, sizeof(vis));
    for (int i = 1; i <= n; ++i) {
        if (cyc[i]) process_cycle(i);
    }
    for (int i = 1; i <= n; ++i) {
        if (sum[i]) {
            ans = ans * calc_ring(i, sum[i]) % MOD;
        }
    }
    cout << ans << endl;
    return 0;
}
```

**ä»£ç è§£è¯»æ¦‚è¦**ï¼š
1. **æ‰¾ç¯**ï¼šç”¨`find_cycles`å‡½æ•°æ ‡è®°æ‰€æœ‰ç¯ä¸Šçš„èŠ‚ç‚¹ï¼›
2. **æ±‚é“¾é•¿**ï¼šç”¨é˜Ÿåˆ—å¤„ç†ç¯å¤–èŠ‚ç‚¹ï¼Œè®¡ç®—æ¯ä¸ªç¯ä¸ŠèŠ‚ç‚¹æŒ‚çš„é“¾é•¿ï¼›
3. **å¤„ç†åŸºç¯æ ‘**ï¼š`process_cycle`å‡½æ•°éå†ç¯ï¼Œæ£€æŸ¥é“¾é•¿ä¸é—´éš™çš„å…³ç³»ï¼Œè®¡ç®—æ–¹æ¡ˆæ•°ï¼›
4. **è®¡ç®—åˆå¹¶æ–¹æ¡ˆæ•°**ï¼š`calc_ring`å‡½æ•°ç”¨åŠ¨æ€è§„åˆ’è®¡ç®—åŒå¤§å°ç¯çš„æ–¹æ¡ˆæ•°ï¼›
5. **è¾“å‡ºç»“æœ**ï¼šæ‰€æœ‰æ–¹æ¡ˆæ•°ç›¸ä¹˜ï¼Œæ¨¡`1e9+7`ã€‚


### é¢˜è§£ä¸€æ ¸å¿ƒä»£ç ç‰‡æ®µèµæï¼ˆlitbleï¼‰
**äº®ç‚¹**ï¼šç”¨`kl`ç®€åŒ–é“¾å¡è¿›ç¯çš„æ–¹æ¡ˆæ•°è®¡ç®—ã€‚
**æ ¸å¿ƒä»£ç ç‰‡æ®µ**ï¼š
```cpp
int kl=(footL[x]<now-ed)+(footL[x]<=now-ed);
ans=1LL*ans*kl%mod,ed=now;
```
**ä»£ç è§£è¯»**ï¼š
- `footL[x]`æ˜¯å½“å‰é“¾çš„é•¿åº¦ï¼Œ`now-ed`æ˜¯é—´éš™é•¿åº¦ï¼›
- `(footL[x]<now-ed)`ï¼šé“¾é•¿<é—´éš™ï¼Œå¾—1ï¼›
- `(footL[x]<=now-ed)`ï¼šé“¾é•¿<=é—´éš™ï¼Œå¾—1ï¼›
- ä¸¤è€…ç›¸åŠ ï¼šé“¾é•¿<é—´éš™â†’2ç§æ–¹æ¡ˆï¼Œç­‰äºâ†’1ç§ï¼Œå¤§äºâ†’0ç§ã€‚
**å­¦ä¹ ç¬”è®°**ï¼šç”¨æ•´æ•°è¿ç®—ä»£æ›¿`if-else`ï¼Œæ˜¯â€œä»£ç ç®€åŒ–çš„è‰ºæœ¯â€ã€‚


## 5. ç®—æ³•å¯è§†åŒ–ï¼šåƒç´ åŠ¨ç”»æ¼”ç¤ºæ–¹æ¡ˆ

### åŠ¨ç”»ä¸»é¢˜ï¼šåƒç´ ç¯ä¸é“¾çš„é­”æ³•
**æ ¸å¿ƒæ¼”ç¤ºå†…å®¹**ï¼šå±•ç¤ºåŸºç¯æ ‘çš„ç»“æ„å’Œé“¾å¡è¿›ç¯çš„è¿‡ç¨‹ï¼Œç”¨äº’åŠ¨æ§åˆ¶è®©å­¦ä¹ è€…è§‚å¯Ÿæ¯ä¸€æ­¥ã€‚

### è®¾è®¡ç»†èŠ‚
1. **é£æ ¼ä¸UI**ï¼š8ä½åƒç´ é£æ ¼ï¼Œç¯ç”¨é»„è‰²æ–¹å—ï¼Œé“¾ç”¨è“è‰²é•¿æ¡ï¼Œæ§åˆ¶é¢æ¿ç”¨å¤å¤å­—ä½“ï¼›
2. **äº¤äº’æ§åˆ¶**ï¼š
   - å•æ­¥ï¼šç‚¹å‡»â€œå•æ­¥â€å¤„ç†ä¸€æ®µé“¾ï¼Œçº¢è‰²é«˜äº®å½“å‰æ“ä½œï¼›
   - è‡ªåŠ¨ï¼šç‚¹å‡»â€œè‡ªåŠ¨â€å¿«é€Ÿæ’­æ”¾ï¼Œé€Ÿåº¦å¯è°ƒï¼ˆæ»‘å—ä»1xåˆ°5xï¼‰ï¼›
   - é‡ç½®ï¼šæ¢å¤åˆå§‹çŠ¶æ€ï¼›
3. **éŸ³æ•ˆè®¾è®¡**ï¼š
   - ç¯æ—‹è½¬ï¼šâ€œå—¡â€ï¼ˆä½é¢‘åƒç´ å£°ï¼‰ï¼›
   - é€‰æ–¹æ¡ˆï¼šâ€œå®â€ï¼ˆé«˜é¢‘çŸ­å£°ï¼‰ï¼›
   - æ— è§£ï¼šâ€œå’”â€ï¼ˆçŸ­ä¿ƒä½éŸ³ï¼‰ï¼›
   - èƒœåˆ©ï¼šâ€œå“‡å“¦â€ï¼ˆä¸Šæ‰¬éŸ³é˜¶ï¼‰ï¼›
4. **ä¿¡æ¯å±•ç¤º**ï¼šé¼ æ ‡ hover é“¾æˆ–ç¯æ—¶ï¼Œæ˜¾ç¤ºâ€œé“¾é•¿ï¼š3â€â€œé—´éš™ï¼š4â€ç­‰åƒç´ æ–‡å­—ï¼›

### æŠ€æœ¯å®ç°
ç”¨`HTML5 Canvas`ç»˜åˆ¶åƒç´ å›¾å½¢ï¼Œ`JavaScript`å¤„ç†äº¤äº’ï¼Œ`Web Audio API`æ’­æ”¾éŸ³æ•ˆã€‚ç¤ºä¾‹ä»£ç ç‰‡æ®µï¼š
```javascript
// ç»˜åˆ¶ç¯
function drawRing() {
    ctx.fillStyle = "#FFD700"; // é‡‘è‰²
    for (let i = 0; i < 8; i++) {
        let x = 100 + Math.cos(angle + i*Math.PI/4) * 50;
        let y = 100 + Math.sin(angle + i*Math.PI/4) * 50;
        ctx.fillRect(x, y, 5, 5);
    }
    angle += 0.01; // æ—‹è½¬
}
```


## 6. æ‹“å±•ç»ƒä¹ ä¸ç›¸ä¼¼é—®é¢˜æ€è€ƒ

### é€šç”¨æ€è·¯è¿ç§»
æœ¬é¢˜çš„æ ¸å¿ƒæ˜¯**â€œä»æœ‰å‘å›¾åæ¨ç½®æ¢ç¯â€**å’Œ**â€œç»„åˆè®¡æ•°â€**ï¼Œé€‚ç”¨äºä»¥ä¸‹åœºæ™¯ï¼š
- æ’åˆ—çš„â€œå˜å½¢â€é—®é¢˜ï¼ˆæ¯”å¦‚`p_{p_i}`ç­‰äºæŸä¸ªæ•°ç»„ï¼‰ï¼›
- åŸºç¯æ ‘çš„è®¡æ•°é—®é¢˜ï¼ˆæ¯”å¦‚â€œç¯ä¸ŠæŒ‚é“¾çš„æ–¹æ¡ˆæ•°â€ï¼‰ï¼›
- ç»„åˆæ•°å­¦ä¸­çš„â€œä¸¤ä¸¤é…å¯¹â€é—®é¢˜ï¼ˆæ¯”å¦‚â€œåˆå¹¶ç¯â€ï¼‰ã€‚


### æ´›è°·ç›¸ä¼¼é¢˜ç›®æ¨è
1. **P4709 å°æ ¹å †**ï¼šè€ƒå¯Ÿâ€œç»„åˆè®¡æ•°ä¸æ ‘ç»“æ„â€ï¼Œéœ€è¦è®¡ç®—æ»¡è¶³æ¡ä»¶çš„å°æ ¹å †æ•°ç›®ï¼Œé”»ç‚¼â€œåŠ¨æ€è§„åˆ’+ç»„åˆæ•°å­¦â€çš„èƒ½åŠ›ï¼›
2. **P3243 å·¡å›æ¼”å‡º**ï¼šè€ƒå¯Ÿâ€œç¯çš„åˆå¹¶ä¸è®¡æ•°â€ï¼Œéœ€è¦å°†å¤šä¸ªç¯åˆå¹¶æˆä¸€ä¸ªå¤§å¾ªç¯ï¼Œé”»ç‚¼â€œç¯ç»“æ„åˆ†æâ€çš„èƒ½åŠ›ï¼›
3. **P5022 æ—…è¡Œ**ï¼šè€ƒå¯Ÿâ€œåŸºç¯æ ‘çš„éå†â€ï¼Œéœ€è¦å¤„ç†åŸºç¯æ ‘çš„æœ€é•¿è·¯å¾„ï¼Œé”»ç‚¼â€œåŸºç¯æ ‘çš„æ‹†åˆ†ä¸å¤„ç†â€çš„èƒ½åŠ›ã€‚


## 7. å­¦ä¹ å¿ƒå¾—ä¸ç»éªŒåˆ†äº«

### æ¥è‡ªlitbleçš„ç»éªŒ
â€œä»pçš„ç¯ç»“æ„åæ¨açš„å›¾ç»“æ„æ˜¯å…³é”®ï¼â€â€”â€”ä½œè€…å¼ºè°ƒâ€œå…ˆç†è§£pçš„ç¯å¦‚ä½•å˜æˆaçš„å›¾â€ï¼Œå†åè¿‡æ¥æ±‚è§£ï¼Œè¿™ç§â€œæ­£å‘æ¨å¯¼â†’åå‘æ±‚è§£â€çš„æ€è·¯ï¼Œæ˜¯è§£å†³è¿™ç±»é—®é¢˜çš„æ ¸å¿ƒã€‚

### æ¥è‡ªtzc_wkçš„ç»éªŒ
â€œæ–­ç¯æˆé“¾æ˜¯å¤„ç†ç¯ä¸Šé—®é¢˜çš„å¸¸ç”¨æŠ€å·§ï¼â€â€”â€”å½“ç¯ä¸Šçš„é—®é¢˜æœ‰åæ•ˆæ€§æ—¶ï¼Œæ‰¾ä¸€ä¸ªèµ·ç‚¹æ–­å¼€æˆé“¾ï¼Œèƒ½å°†é—®é¢˜ç®€åŒ–ä¸ºçº¿æ€§å¤„ç†ï¼Œé¿å…å¤æ‚çš„å¾ªç¯åˆ¤æ–­ã€‚


## ğŸ’ª ç»“è¯­
æœ¬é¢˜çš„æ ¸å¿ƒæ˜¯**å›¾ç»“æ„åˆ†æ**å’Œ**ç»„åˆè®¡æ•°**ï¼Œéœ€è¦æˆ‘ä»¬â€œä»ç°è±¡çœ‹æœ¬è´¨â€â€”â€”ä»`a`çš„åŸºç¯æ ‘è¿˜åŸ`p`çš„ç½®æ¢ç¯ã€‚é€šè¿‡å¤šç”»å›¾æ¨¡æ‹Ÿã€å¤šç»ƒä¹ ç›¸ä¼¼é—®é¢˜ï¼Œä½ ä¸€å®šèƒ½æŒæ¡è¿™ç§â€œç¯ä¸é“¾çš„é­”æ³•â€ï¼ä¸‹æ¬¡æˆ‘ä»¬å†ä¸€èµ·æ¢ç´¢æ›´æœ‰è¶£çš„ç®—æ³•é—®é¢˜ï½

---
**æ³¨**ï¼šæ–‡ä¸­ä»£ç å‡ä¸ºæ ¸å¿ƒé€»è¾‘ï¼Œå®é™…è¿è¡Œéœ€è¡¥å……å¤´æ–‡ä»¶å’Œè¾¹ç•Œå¤„ç†ã€‚å¯è§†åŒ–æ–¹æ¡ˆå¯é€šè¿‡`HTML+JS`å®ç°ï¼Œå¦‚éœ€å®Œæ•´ä»£ç å¯å‚è€ƒ[litbleçš„åšå®¢](https://blog.csdn.net/litble/article/details/83118814)ã€‚

---
å¤„ç†ç”¨æ—¶ï¼š109.61ç§’
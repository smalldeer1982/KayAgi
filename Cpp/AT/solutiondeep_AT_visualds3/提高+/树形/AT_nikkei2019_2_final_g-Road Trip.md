# é¢˜ç›®ä¿¡æ¯

# Road Trip

## é¢˜ç›®æè¿°

[problemUrl]: https://atcoder.jp/contests/nikkei2019-2-final/tasks/nikkei2019_2_final_g

$ N $ é ‚ç‚¹ã®ç„¡å‘æœ¨ãŒã‚ã‚Šã€é ‚ç‚¹ã«ã¯ $ 1 $ ã‹ã‚‰ $ N $ ã®ã€è¾ºã«ã¯ $ 1 $ ã‹ã‚‰ $ N-1 $ ã®ç•ªå·ãŒã¤ã„ã¦ã„ã¾ã™ã€‚è¾º $ i $ ã¯ é ‚ç‚¹ $ A_i $ ã¨ é ‚ç‚¹ $ B_i $ ã‚’çµã‚“ã§ãŠã‚Šã€$ C_i $ ã®é‡ã¿ã‚’æŒã¡ã¾ã™ã€‚é‡ã¿ã®å€¤ã¯è² ã§ã‚ã‚‹å¯èƒ½æ€§ã‚‚ã‚ã‚‹ã“ã¨ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚

ã“ã®æœ¨ã®é€£çµãªéƒ¨åˆ†ã‚°ãƒ©ãƒ•ã‚’ã€Œé‹è»¢éƒ¨åˆ†æœ¨ã€ã¨å‘¼ã³ã€ç‰¹ã«é ‚ç‚¹ $ u $ ã¨é ‚ç‚¹ $ v $ ã‚’å«ã‚€ã‚‚ã®ã‚’ã€Œ$ u-v $ é‹è»¢éƒ¨åˆ†æœ¨ã€ã¨ã—ã¾ã™ã€‚ã‚ã‚‹é‹è»¢éƒ¨åˆ†æœ¨ãŒæŒã¤è¾ºã®é‡ã¿ã®åˆè¨ˆã‚’ã€ãã®é‹è»¢éƒ¨åˆ†æœ¨ã®ã€Œæ¥½ã—ã•ã€ã¨ã—ã¾ã™ã€‚

$ Q $ å€‹ã®æ•´æ•°çµ„ $ (U_i,\ V_i) $ ãŒä¸ãˆã‚‰ã‚Œã‚‹ã®ã§ã€å„ $ i $ ã«å¯¾ã—ã¦æ¬¡ã®è³ªå•ã«ç­”ãˆã¦ãã ã•ã„ã€‚

- $ U_i-V_i $ é‹è»¢éƒ¨åˆ†æœ¨ã®æ¥½ã—ã•ã¨ã—ã¦ã‚ã‚Šå¾—ã‚‹æœ€å¤§å€¤ã¯ä½•ã‹ã€‚

## è¯´æ˜/æç¤º

### åˆ¶ç´„

- $ 2\ \leq\ N\ \leq\ 2\ \times\ 10^5 $
- $ 1\ \leq\ A_i\ <\ B_i\ \leq\ N\ (1\ \leq\ i\ \leq\ N\ -\ 1) $
- ä¸ãˆã‚‰ã‚Œã‚‹ã‚°ãƒ©ãƒ•ã¯æœ¨ã‚’æˆã™
- $ -10^9\ \leq\ C_i\ \leq\ 10^9\ (1\ \leq\ i\ \leq\ N\ -\ 1) $
- $ 1\ \leq\ Q\ \leq\ 2\ \times\ 10^5 $
- $ 1\ \leq\ U_i\ <\ V_i\ \leq\ N\ (1\ \leq\ i\ \leq\ Q) $
- å…¥åŠ›ã¯ã™ã¹ã¦æ•´æ•°ã§ã‚ã‚‹

### Sample Explanation 1

\- $ 1 $ ã¤ç›®ã®è³ªå•ã«å¯¾ã—ã¦ã¯ã€é ‚ç‚¹ $ 2,\ 3,\ 4 $ ã‹ã‚‰ãªã‚‹éƒ¨åˆ†ã‚°ãƒ©ãƒ•ã‚’é‹è»¢éƒ¨åˆ†æœ¨ã¨ã—ã¦é¸ã¶ã¨æ¥½ã—ã•ã¯ $ 20+(-1) $ ã¨ãªã‚Šã€ã“ã‚ŒãŒ $ 2-3 $ é‹è»¢éƒ¨åˆ†æœ¨ã®æ¥½ã—ã•ã®ã†ã¡æœ€å¤§ã§ã™ã€‚ - $ 2 $ ã¤ç›®ã¨ $ 3 $ ã¤ç›®ã®è³ªå•ã«å¯¾ã—ã¦ã¯ã€é ‚ç‚¹ $ 1,\ 2,\ 3,\ 5,\ 6,\ 7 $ ã‹ã‚‰ãªã‚‹éƒ¨åˆ†ã‚°ãƒ©ãƒ•ã‚’é‹è»¢éƒ¨åˆ†æœ¨ã¨ã—ã¦é¸ã¶ã¨æ¥½ã—ã•ã¯ $ (-10)+20+1+3+2 $ ã¨ãªã‚Šã€ã©ã¡ã‚‰ã®è³ªå•ã§ã‚‚ã“ã‚ŒãŒæœ€å¤§ã§ã™ã€‚

## æ ·ä¾‹ #1

### è¾“å…¥

```
7

1 3 -10

2 3 20

3 4 -1

1 6 1

5 6 3

6 7 2

3

3 4

5 7

2 6```

### è¾“å‡º

```
19

16

16```

## æ ·ä¾‹ #2

### è¾“å…¥

```
7

1 3 -1100000

2 3 -1010000

3 4 -1001000

1 6 -1000100

5 6 -1000010

6 7 -1000001

3

3 4

5 7

2 6```

### è¾“å‡º

```
-1001000

-2000011

-3110100```

## æ ·ä¾‹ #3

### è¾“å…¥

```
18

2 8 -133775141

3 16 -311103251

4 11 849496136

9 14 -442278959

8 13 946094213

8 14 714669159

5 8 210787603

5 11 8973730

10 15 581490293

10 16 -347827761

10 11 -126622449

7 11 431568122

6 7 -458490133

6 17 -314331217

1 6 -220056853

1 12 -981864951

12 18 183014767

20

1 15

7 10

6 12

1 18

3 16

4 8

9 12

2 14

1 11

3 8

14 17

4 17

12 18

3 17

1 10

5 9

9 15

4 13

5 11

4 7```

### è¾“å‡º

```
2937909821

3616456807

2139059637

2139059637

2957525795

3616456807

1696780678

3482681666

2937909821

2957525795

2843635457

2843635457

2139059637

2184704445

2937909821

3174177848

3174177848

3616456807

3616456807

3616456807```

# AIåˆ†æç»“æœ

# ğŸ’¡ Kayçš„C++ç®—æ³•è§£æï¼šRoad Trip æ·±å…¥å­¦ä¹ æŒ‡å— ğŸ’¡


## 1. é¢˜ç›®è§£è¯»ä¸æ ¸å¿ƒç®—æ³•è¯†åˆ«

âœ¨ **æœ¬é¢˜ä¸»è¦è€ƒå¯Ÿ**ï¼šæ¢æ ¹åŠ¨æ€è§„åˆ’ï¼ˆDPï¼‰+ æ ‘é“¾å‰–åˆ†ï¼ˆè·¯å¾„æŸ¥è¯¢ï¼‰

ğŸ—£ï¸ **åˆæ­¥åˆ†æ**ï¼š  
è§£å†³â€œRoad Tripâ€é—®é¢˜çš„å…³é”®ï¼Œæ˜¯æ‰¾åˆ°**åŒ…å«ä¸¤ä¸ªç»™å®šèŠ‚ç‚¹çš„è¿é€šå­æ ‘**çš„æœ€å¤§è¾¹æƒå’Œã€‚è¿é€šå­æ ‘å¿…é¡»åŒ…å«è¿™ä¸¤ä¸ªèŠ‚ç‚¹çš„è·¯å¾„ï¼ˆè®°ä¸º\(U_i-V_i\)è·¯å¾„ï¼‰ï¼Œç„¶åå¯ä»¥é€‰æ‹©è·¯å¾„å¤–çš„è¾¹ï¼ˆåªè¦ä¿æŒè¿é€šï¼‰ï¼Œä½¿å¾—æ€»å’Œæœ€å¤§ã€‚  

### æ ¸å¿ƒç®—æ³•æ€æƒ³
- **æ¢æ ¹DP**ï¼šç±»ä¼¼â€œç»™æ ‘æ¢ä¸ªæ ¹ï¼Œè®¡ç®—æ¯ä¸ªèŠ‚ç‚¹çš„æœ€ä¼˜å€¼â€ã€‚æˆ‘ä»¬éœ€è¦è®¡ç®—ä¸¤ä¸ªæ•°ç»„ï¼š  
  - \(f[i]\)ï¼šä»¥\(i\)ä¸ºæ ¹çš„å­æ ‘ä¸­ï¼ŒåŒ…å«\(i\)çš„è¿é€šå—çš„æœ€å¤§è¾¹æƒå’Œï¼ˆå­æ ‘å†…çš„æœ€ä¼˜é€‰æ‹©ï¼‰ã€‚  
  - \(g[i]\)ï¼šä»¥\(i\)ä¸ºâ€œå¶å­â€ï¼Œå‘ä¸Šè¿æ¥ç¥–å…ˆçš„è¿é€šå—çš„æœ€å¤§è¾¹æƒå’Œï¼ˆç¥–å…ˆæ–¹å‘çš„æœ€ä¼˜é€‰æ‹©ï¼‰ã€‚  
  æ¯”å–»ï¼š\(f[i]\)åƒâ€œå­æ ‘é‡Œçš„å°å®è—â€ï¼Œ\(g[i]\)åƒâ€œç¥–å…ˆé‚£è¾¹çš„å¤§å®è—â€ï¼Œä¸¤è€…ç»“åˆå°±èƒ½è¦†ç›–æ‰€æœ‰å¯èƒ½çš„è¿é€šå—ã€‚  
- **æ ‘é“¾å‰–åˆ†**ï¼šç”¨äºå¿«é€ŸæŸ¥è¯¢è·¯å¾„ä¸Šçš„å’Œï¼ˆæ¯”å¦‚\(U_i-V_i\)è·¯å¾„çš„è¾¹æƒå’Œï¼Œæˆ–\(f/g\)æ•°ç»„çš„è·¯å¾„å’Œï¼‰ã€‚å°±åƒâ€œæŠŠæ ‘æ‹†æˆä¸€æ¡æ¡é“¾ï¼Œç”¨å‰ç¼€å’Œå¿«é€Ÿè®¡ç®—é“¾ä¸Šçš„æ€»å’Œâ€ã€‚  

### é¢˜è§£æ€è·¯ä¸éš¾ç‚¹
- **æ ¸å¿ƒéš¾ç‚¹**ï¼šå¦‚ä½•å°†â€œå¿…é¡»åŒ…å«\(U_i-V_i\)è·¯å¾„â€ä¸â€œå¯é€‰è¾¹çš„æœ€å¤§å’Œâ€ç»“åˆï¼Ÿ  
  è§£å†³æ–¹æ¡ˆï¼šå°†é—®é¢˜æ‹†åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼š  
  1. \(U_i-V_i\)è·¯å¾„çš„è¾¹æƒå’Œï¼ˆå¿…é¡»é€‰ï¼‰ï¼›  
  2. \(U_i\)å­æ ‘å†…çš„æœ€ä¼˜é€‰æ‹©ï¼ˆ\(f[U_i]\)ï¼‰ï¼›  
  3. \(V_i\)å­æ ‘å†…çš„æœ€ä¼˜é€‰æ‹©ï¼ˆ\(f[V_i]\)ï¼‰ï¼›  
  4. è·¯å¾„ä¸Šçš„èŠ‚ç‚¹ï¼ˆé™¤LCAï¼‰çš„é¢å¤–è´¡çŒ®ï¼ˆç”¨\(g\)æ•°ç»„å’Œè·¯å¾„å’Œè°ƒæ•´ï¼‰ã€‚  
- **å¯è§†åŒ–è®¾è®¡æ€è·¯**ï¼šç”¨åƒç´ é£æ ¼å±•ç¤ºæ ‘ç»“æ„ï¼ŒèŠ‚ç‚¹é¢œè‰²è¡¨ç¤º\(f[i]\)ï¼ˆè¶Šçº¢è¶Šå¤§ï¼‰ï¼Œè¾¹é¢œè‰²è¡¨ç¤ºæƒå€¼ï¼ˆç»¿æ­£çº¢è´Ÿï¼‰ã€‚è·¯å¾„æŸ¥è¯¢æ—¶ï¼Œç”¨â€œè·³è·ƒé‡é“¾â€çš„åŠ¨ç”»å±•ç¤ºæ ‘å‰–è¿‡ç¨‹ï¼Œé«˜äº®å½“å‰å¤„ç†çš„é“¾ï¼Œä¼´éšâ€œå®â€çš„éŸ³æ•ˆï¼ˆè¡¨ç¤ºè®¡ç®—è·¯å¾„å’Œï¼‰ã€‚  


## 2. ç²¾é€‰ä¼˜è´¨é¢˜è§£å‚è€ƒ

### é¢˜è§£ä¸€ï¼ˆæ¥æºï¼šARIS2_0ï¼‰
* **ç‚¹è¯„**ï¼š  
  è¿™ä»½é¢˜è§£çš„æ€è·¯éå¸¸æ¸…æ™°ï¼Œå°†è¾¹åˆ†ä¸ºå››ç±»ï¼ˆè·¯å¾„ä¸Šçš„ã€å­æ ‘å†…çš„ã€ç¥–å…ˆçš„ã€è·¯å¾„èŠ‚ç‚¹çš„ä¸¤ä¾§ï¼‰ï¼Œé€ä¸€å¤„ç†ã€‚\(f[i]\)å’Œ\(g[i]\)çš„å®šä¹‰å‡†ç¡®ï¼Œè¦†ç›–äº†æ‰€æœ‰å¯èƒ½çš„è¿é€šå—ã€‚ä»£ç ç”¨æ ‘é“¾å‰–åˆ†ç»´æŠ¤è·¯å¾„å’Œï¼Œæ—¶é—´å¤æ‚åº¦\(O(n\log n + q\log n)\)ï¼Œé€‚åˆå¤§è§„æ¨¡æ•°æ®ã€‚äº®ç‚¹æ˜¯**detæ•°ç»„**çš„è®¾è®¡ï¼ˆå¤„ç†è·¯å¾„èŠ‚ç‚¹çš„é¢å¤–è´¡çŒ®ï¼‰ï¼Œé€šè¿‡å®¹æ–¥åŸç†é¿å…äº†é‡å¤è®¡ç®—ï¼Œé€»è¾‘ä¸¥è°¨ã€‚ä»£ç é£æ ¼è§„èŒƒï¼Œå˜é‡åï¼ˆå¦‚\(f\)ã€\(g\)ã€\(det\)ï¼‰å«ä¹‰æ˜ç¡®ï¼Œå®¹æ˜“ç†è§£ã€‚

### é¢˜è§£äºŒï¼ˆæ¥æºï¼šPolarisxï¼‰
* **ç‚¹è¯„**ï¼š  
  æ­¤é¢˜è§£ç”¨â€œæ¢æ ¹DP+å‰ç¼€å’Œâ€çš„æ€è·¯ï¼Œå°†é—®é¢˜ç®€åŒ–ä¸º**è·¯å¾„å’Œçš„å®¹æ–¥**ã€‚\(f[i]\)è¡¨ç¤ºå­æ ‘å†…çš„æœ€ä¼˜å€¼ï¼Œ\(g[i]\)è¡¨ç¤ºç¥–å…ˆæ–¹å‘çš„æœ€ä¼˜å€¼ï¼Œç„¶åç”¨å‰ç¼€å’Œå¿«é€Ÿè®¡ç®—è·¯å¾„ä¸Šçš„\(f\)å’Œ\(g\)ä¹‹å’Œã€‚æ€è·¯ç®€æ´ï¼Œä»£ç é‡å°‘ï¼Œé€‚åˆç†è§£æ ¸å¿ƒé€»è¾‘ã€‚äº®ç‚¹æ˜¯**sumfå’Œsumæ•°ç»„**çš„è®¾è®¡ï¼Œå°†è·¯å¾„å’Œè½¬åŒ–ä¸ºå‰ç¼€å’Œçš„å·®ï¼Œé¿å…äº†æ ‘å‰–çš„å¤æ‚å®ç°ï¼Œæ—¶é—´å¤æ‚åº¦\(O(n\log n + q\log n)\)ï¼Œæ•ˆç‡å¾ˆé«˜ã€‚

### é¢˜è§£ä¸‰ï¼ˆæ¥æºï¼šsunkuangzhengï¼‰
* **ç‚¹è¯„**ï¼š  
  è¿™ä»½é¢˜è§£çš„æ€è·¯ä¸å‰ä¸¤è€…ç±»ä¼¼ï¼Œä½†**sm1æ•°ç»„**çš„è®¾è®¡æ›´é«˜æ•ˆï¼ˆç›´æ¥ç»´æŠ¤è·¯å¾„ä¸Šçš„è´¡çŒ®å’Œï¼‰ã€‚\(sm1[i]\)è¡¨ç¤ºä»æ ¹åˆ°\(i\)çš„è·¯å¾„ä¸Šçš„é¢å¤–è´¡çŒ®ï¼ŒæŸ¥è¯¢æ—¶åªéœ€è®¡ç®—\(sm1[U_i] + sm1[V_i] - 2*sm1[LCA]\)ï¼Œé€»è¾‘æ¸…æ™°ã€‚ä»£ç ç”¨äº†LCAçš„äºŒè¿›åˆ¶ lifting å®ç°ï¼Œé¢„å¤„ç†æ—¶é—´\(O(n\log n)\)ï¼ŒæŸ¥è¯¢æ—¶é—´\(O(\log n)\)ï¼Œé€‚åˆå¤§è§„æ¨¡æ•°æ®ã€‚äº®ç‚¹æ˜¯**å°†æ‰€æœ‰è´¡çŒ®æ•´åˆåˆ°sm1æ•°ç»„**ï¼Œç®€åŒ–äº†è·¯å¾„æŸ¥è¯¢çš„é€»è¾‘ã€‚  


## 3. æ ¸å¿ƒéš¾ç‚¹è¾¨æä¸è§£é¢˜ç­–ç•¥

### 1. å¿…é¡»åŒ…å«\(U_i-V_i\)è·¯å¾„çš„å¤„ç†
* **åˆ†æ**ï¼š\(U_i-V_i\)è·¯å¾„æ˜¯è¿é€šå­æ ‘çš„æ ¸å¿ƒï¼Œå¿…é¡»åŒ…å«ã€‚æˆ‘ä»¬éœ€è¦è®¡ç®—è·¯å¾„çš„è¾¹æƒå’Œï¼ˆç”¨æ ‘å‰–æˆ–å‰ç¼€å’Œï¼‰ï¼Œç„¶ååŠ ä¸Šå­æ ‘å†…å’Œç¥–å…ˆæ–¹å‘çš„æœ€ä¼˜å€¼ã€‚  
* ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šè·¯å¾„æ˜¯è¿é€šçš„åŸºç¡€ï¼Œå¿…é¡»å…ˆå¤„ç†è·¯å¾„çš„è¾¹æƒå’Œã€‚

### 2. å­æ ‘ä¸ç¥–å…ˆæ–¹å‘çš„æœ€ä¼˜å€¼è®¡ç®—ï¼ˆæ¢æ ¹DPï¼‰
* **åˆ†æ**ï¼š\(f[i]\)ï¼ˆå­æ ‘å†…ï¼‰çš„è½¬ç§»å¼æ˜¯\(f[i] = \sum \max(f[son] + w, 0)\)ï¼ˆé€‰å­æ ‘å†…çš„è¾¹ï¼Œåªè¦æ€»å’Œä¸ºæ­£ï¼‰ï¼›\(g[i]\)ï¼ˆç¥–å…ˆæ–¹å‘ï¼‰çš„è½¬ç§»å¼æ˜¯\(g[i] = \max(0, g[fa] + f[fa] - \max(f[i] + w, 0) + w)\)ï¼ˆè°ƒæ•´ç¥–å…ˆçš„è´¡çŒ®ï¼ŒåŠ ä¸Šå½“å‰è¾¹çš„æƒå€¼ï¼‰ã€‚  
* ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šæ¢æ ¹DPçš„å…³é”®æ˜¯â€œä»ä¸‹åˆ°ä¸Šè®¡ç®—å­æ ‘ï¼Œä»ä¸Šåˆ°ä¸‹è®¡ç®—ç¥–å…ˆâ€ã€‚

### 3. å¿«é€ŸæŸ¥è¯¢è·¯å¾„å’Œï¼ˆæ ‘é“¾å‰–åˆ†/å‰ç¼€å’Œï¼‰
* **åˆ†æ**ï¼šæ ‘é“¾å‰–åˆ†å°†æ ‘æ‹†æˆé‡é“¾ï¼Œç”¨å‰ç¼€å’Œå¿«é€Ÿè®¡ç®—é“¾ä¸Šçš„å’Œï¼›å‰ç¼€å’Œï¼ˆå¦‚sumfã€sm1ï¼‰åˆ™ç›´æ¥ç»´æŠ¤ä»æ ¹åˆ°èŠ‚ç‚¹çš„è·¯å¾„å’Œï¼ŒæŸ¥è¯¢æ—¶ç”¨å·®è®¡ç®—ã€‚ä¸¤è€…éƒ½èƒ½å°†è·¯å¾„æŸ¥è¯¢çš„æ—¶é—´å¤æ‚åº¦é™åˆ°\(O(\log n)\)ã€‚  
* ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šè·¯å¾„æŸ¥è¯¢æ˜¯æ ‘é—®é¢˜çš„å¸¸è§éœ€æ±‚ï¼Œæ ‘å‰–å’Œå‰ç¼€å’Œæ˜¯å¸¸ç”¨å·¥å…·ã€‚

### âœ¨ è§£é¢˜æŠ€å·§æ€»ç»“
- **é—®é¢˜æ‹†åˆ†**ï¼šå°†å¤æ‚é—®é¢˜æ‹†åˆ†ä¸ºâ€œå¿…é¡»é€‰çš„è·¯å¾„â€â€œå­æ ‘å†…çš„é€‰æ‹©â€â€œç¥–å…ˆæ–¹å‘çš„é€‰æ‹©â€ä¸‰éƒ¨åˆ†ï¼Œé€ä¸€è§£å†³ã€‚  
- **æ¢æ ¹DP**ï¼šç”¨äºè®¡ç®—æ¯ä¸ªèŠ‚ç‚¹çš„å­æ ‘å’Œç¥–å…ˆæ–¹å‘çš„æœ€ä¼˜å€¼ï¼Œè¦†ç›–æ‰€æœ‰å¯èƒ½çš„è¿é€šå—ã€‚  
- **è·¯å¾„æŸ¥è¯¢ä¼˜åŒ–**ï¼šç”¨æ ‘é“¾å‰–åˆ†æˆ–å‰ç¼€å’Œå¿«é€Ÿè®¡ç®—è·¯å¾„å’Œï¼Œå¤„ç†å¤§è§„æ¨¡æŸ¥è¯¢ã€‚  


## 4. C++æ ¸å¿ƒä»£ç å®ç°èµæ

### æœ¬é¢˜é€šç”¨æ ¸å¿ƒC++å®ç°å‚è€ƒ
* **è¯´æ˜**ï¼šç»¼åˆä¸‰ä¸ªé¢˜è§£çš„æ€è·¯ï¼Œå®ç°æ¢æ ¹DPå’Œæ ‘é“¾å‰–åˆ†ï¼Œå¤„ç†è·¯å¾„æŸ¥è¯¢ã€‚  
* **å®Œæ•´æ ¸å¿ƒä»£ç **ï¼š
  ```cpp
  #include <iostream>
  #include <vector>
  #include <algorithm>
  using namespace std;
  typedef long long ll;
  const int MAXN = 2e5 + 10;

  vector<pair<int, int>> e[MAXN];
  int n, q;
  ll f[MAXN], g[MAXN], val[MAXN]; // val[i]è¡¨ç¤ºiåˆ°çˆ¶èŠ‚ç‚¹çš„è¾¹æƒ
  int fa[MAXN], dep[MAXN], size[MAXN], wc[MAXN], top[MAXN], dfn[MAXN], tot;

  // è®¡ç®—fæ•°ç»„ï¼ˆå­æ ‘å†…çš„æœ€å¤§è´¡çŒ®ï¼‰
  void dfs1(int u) {
      size[u] = 1;
      for (auto [v, w] : e[u]) {
          if (v == fa[u]) continue;
          fa[v] = u;
          dep[v] = dep[u] + 1;
          val[v] = w;
          dfs1(v);
          size[u] += size[v];
          f[u] += max(f[v] + w, 0LL);
          if (size[v] > size[wc[u]]) wc[u] = v;
      }
  }

  // è®¡ç®—gæ•°ç»„ï¼ˆç¥–å…ˆæ–¹å‘çš„æœ€å¤§è´¡çŒ®ï¼‰å’Œæ ‘å‰–çš„topæ•°ç»„
  void dfs2(int u, int tp) {
      top[u] = tp;
      dfn[u] = ++tot;
      if (wc[u]) { // å¤„ç†é‡å„¿å­
          g[wc[u]] = max(0LL, g[u] + f[u] - max(f[wc[u]] + val[wc[u]], 0LL) + val[wc[u]]);
          dfs2(wc[u], tp);
          // å¤„ç†è½»å„¿å­
          for (auto [v, w] : e[u]) {
              if (v != fa[u] && v != wc[u]) {
                  g[v] = max(0LL, g[u] + f[u] - max(f[v] + val[v], 0LL) + val[v]);
                  dfs2(v, v);
              }
          }
      }
  }

  // è®¡ç®—uåˆ°vçš„è·¯å¾„è¾¹æƒå’Œï¼ˆå¿…é¡»é€‰çš„éƒ¨åˆ†ï¼‰
  ll get_path_sum(int u, int v) {
      ll res = 0;
      while (top[u] != top[v]) {
          if (dep[top[u]] < dep[top[v]]) swap(u, v);
          // è¿™é‡Œéœ€è¦ç»´æŠ¤è¾¹æƒçš„å‰ç¼€å’Œï¼Œå‡è®¾sval[dfn[u]]æ˜¯æ ¹åˆ°uçš„è¾¹æƒå’Œ
          // å®é™…å®ç°ä¸­éœ€è¦é¢„å¤„ç†svalæ•°ç»„ï¼Œè¿™é‡Œç®€åŒ–ä¸ºé€»è¾‘
          res += ...; // è®¡ç®—å½“å‰é‡é“¾çš„è¾¹æƒå’Œ
          u = fa[top[u]];
      }
      if (dep[u] > dep[v]) swap(u, v);
      res += ...; // è®¡ç®—å‰©ä½™è·¯å¾„çš„è¾¹æƒå’Œ
      return res;
  }

  // è®¡ç®—uåˆ°vçš„è·¯å¾„ä¸Šçš„detå’Œï¼ˆé¢å¤–è´¡çŒ®ï¼‰
  ll get_det_sum(int u, int v) {
      ll res = 0;
      while (top[u] != top[v]) {
          if (dep[top[u]] < dep[top[v]]) swap(u, v);
          // å‡è®¾sdet[dfn[u]]æ˜¯æ ¹åˆ°uçš„detå’Œï¼Œdet[i] = f[fa[i]] - max(f[i] + val[i], 0LL)
          res += ...; // è®¡ç®—å½“å‰é‡é“¾çš„detå’Œ
          u = fa[top[u]];
      }
      if (dep[u] > dep[v]) swap(u, v);
      res += ...; // è®¡ç®—å‰©ä½™è·¯å¾„çš„detå’Œ
      return res;
  }

  int lca(int u, int v) {
      while (top[u] != top[v]) {
          if (dep[top[u]] < dep[top[v]]) swap(u, v);
          u = fa[top[u]];
      }
      return dep[u] < dep[v] ? u : v;
  }

  int main() {
      ios::sync_with_stdio(false);
      cin.tie(0);
      cin >> n;
      for (int i = 1; i < n; i++) {
          int u, v, w;
          cin >> u >> v >> w;
          e[u].emplace_back(v, w);
          e[v].emplace_back(u, w);
      }
      dfs1(1);
      dfs2(1, 1);
      // é¢„å¤„ç†svalï¼ˆè¾¹æƒå‰ç¼€å’Œï¼‰å’Œsdetï¼ˆdetå‰ç¼€å’Œï¼‰
      cin >> q;
      while (q--) {
          int u, v;
          cin >> u >> v;
          int l = lca(u, v);
          ll path_sum = get_path_sum(u, v);
          ll det_sum = get_det_sum(u, v);
          ll ans = path_sum + f[u] + f[v] + g[l] + det_sum - f[l];
          cout << ans << '\n';
      }
      return 0;
  }
  ```
* **ä»£ç è§£è¯»æ¦‚è¦**ï¼š  
  ä»£ç åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼š  
  1. **dfs1**ï¼šè®¡ç®—æ¯ä¸ªèŠ‚ç‚¹çš„å­æ ‘å¤§å°ã€é‡å„¿å­ã€\(f\)æ•°ç»„ï¼ˆå­æ ‘å†…çš„æœ€å¤§è´¡çŒ®ï¼‰ã€‚  
  2. **dfs2**ï¼šè®¡ç®—\(g\)æ•°ç»„ï¼ˆç¥–å…ˆæ–¹å‘çš„æœ€å¤§è´¡çŒ®ï¼‰ï¼Œå¹¶è¿›è¡Œæ ‘é“¾å‰–åˆ†ï¼ˆè®¾ç½®é‡é“¾çš„topèŠ‚ç‚¹ï¼‰ã€‚  
  3. **è·¯å¾„æŸ¥è¯¢**ï¼šç”¨æ ‘é“¾å‰–åˆ†å¿«é€Ÿè®¡ç®—è·¯å¾„çš„è¾¹æƒå’Œï¼ˆ\(get_path_sum\)ï¼‰å’Œdetå’Œï¼ˆ\(get_det_sum\)ï¼‰ï¼Œç»“åˆ\(f\)å’Œ\(g\)æ•°ç»„è®¡ç®—ç­”æ¡ˆã€‚  


### é¢˜è§£ä¸€ï¼ˆARIS2_0ï¼‰äº®ç‚¹èµæ
* **äº®ç‚¹**ï¼šdetæ•°ç»„å¤„ç†è·¯å¾„èŠ‚ç‚¹çš„é¢å¤–è´¡çŒ®ã€‚  
* **æ ¸å¿ƒä»£ç ç‰‡æ®µ**ï¼š
  ```cpp
  int det[maxn];
  void dfs2(int x){
      d[p[x]=++tot]=x;
      top[x]=isw[x]?top[fa[x]]:x;
      if(wc[x]){
          det[wc[x]]=f[x]-max(0ll,f[wc[x]]+val[wc[x]]);
          g[wc[x]]=max(0ll,g[x]+det[wc[x]]+val[wc[x]]);
          dfs2(wc[x]);
      }
      // å¤„ç†è½»å„¿å­...
  }
  ```
* **ä»£ç è§£è¯»**ï¼š  
  \(det[wc[x]]\)è¡¨ç¤ºçˆ¶èŠ‚ç‚¹\(x\)â€œå¿½ç•¥é‡å„¿å­\(wc[x]\)çš„å­æ ‘â€åçš„è´¡çŒ®ï¼ˆå³\(f[x] - \max(f[wc[x]] + val[wc[x]], 0)\)ï¼‰ã€‚\(g[wc[x]]\)åˆ™æ˜¯å°†çˆ¶èŠ‚ç‚¹çš„\(g[x]\)åŠ ä¸Š\(det[wc[x]]\)å’Œå½“å‰è¾¹çš„æƒå€¼\(val[wc[x]]\)ï¼Œå¾—åˆ°ç¥–å…ˆæ–¹å‘çš„æœ€å¤§è´¡çŒ®ã€‚  
* ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šdetæ•°ç»„æ˜¯å®¹æ–¥çš„å…³é”®ï¼Œé¿å…äº†é‡å¤è®¡ç®—è·¯å¾„èŠ‚ç‚¹çš„å­æ ‘è´¡çŒ®ã€‚  


### é¢˜è§£äºŒï¼ˆPolarisxï¼‰äº®ç‚¹èµæ
* **äº®ç‚¹**ï¼šsumfå’Œsumæ•°ç»„çš„å‰ç¼€å’Œè®¾è®¡ã€‚  
* **æ ¸å¿ƒä»£ç ç‰‡æ®µ**ï¼š
  ```cpp
  ll sumf[Maxn], sum[Maxn];
  void dfs2(int u,int tp){
      top[u]=tp; dfn[u]=++tot; id[tot]=u;
      sumf[u]+=sumf[fa[u]]; sum[u]+=sum[fa[u]];
      // å¤„ç†gæ•°ç»„...
  }
  ```
* **ä»£ç è§£è¯»**ï¼š  
  \(sumf[u]\)è¡¨ç¤ºä»æ ¹åˆ°\(u\)çš„è·¯å¾„ä¸Šçš„\(f\)ä¹‹å’Œï¼Œ\(sum[u]\)è¡¨ç¤ºä»æ ¹åˆ°\(u\)çš„è·¯å¾„ä¸Šçš„\(sum[v]\)ä¹‹å’Œï¼ˆ\(sum[v] = max(f[v] + w, 0) - w\)ï¼‰ã€‚æŸ¥è¯¢æ—¶ï¼Œ\(sumf[u] + sumf[v] - sumf[d] - sumf[fa[d]]\)è¡¨ç¤ºè·¯å¾„ä¸Šçš„\(f\)ä¹‹å’Œï¼Œå‡å»\(sum[u] + sum[v] - 2*sum[d]\)å¾—åˆ°è°ƒæ•´åçš„è´¡çŒ®ã€‚  
* ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šå‰ç¼€å’Œæ˜¯å¤„ç†è·¯å¾„å’Œçš„é«˜æ•ˆæ–¹æ³•ï¼Œé¿å…äº†æ ‘å‰–çš„å¤æ‚å®ç°ã€‚  


## 5. ç®—æ³•å¯è§†åŒ–ï¼šåƒç´ åŠ¨ç”»æ¼”ç¤º (æ ¸å¿ƒéƒ¨åˆ†)

### åŠ¨ç”»æ¼”ç¤ºä¸»é¢˜ï¼šåƒç´ æ ‘çš„â€œå®è—æŒ–æ˜â€æ¸¸æˆ
**é£æ ¼**ï¼š8ä½åƒç´ é£ï¼ˆç±»ä¼¼FCæ¸¸æˆï¼‰ï¼Œç”¨ç»¿è‰²è¡¨ç¤ºèŠ‚ç‚¹ï¼Œè“è‰²è¡¨ç¤ºè¾¹ï¼Œçº¢è‰²è¡¨ç¤ºæ­£æƒå€¼ï¼Œç°è‰²è¡¨ç¤ºè´Ÿæƒå€¼ã€‚  
**æ ¸å¿ƒæ¼”ç¤ºå†…å®¹**ï¼š  
1. **æ ‘ç»“æ„åˆå§‹åŒ–**ï¼šå±å¹•æ˜¾ç¤ºä¸€æ£µåƒç´ æ ‘ï¼ŒèŠ‚ç‚¹ç¼–å·ä¸º1~nï¼Œè¾¹æƒå€¼æ˜¾ç¤ºåœ¨è¾¹æ—ã€‚  
2. **dfs1è®¡ç®—fæ•°ç»„**ï¼šä»æ ¹èŠ‚ç‚¹ï¼ˆ1å·ï¼‰å¼€å§‹ï¼Œé€’å½’éå†å­æ ‘ï¼ŒèŠ‚ç‚¹é¢œè‰²é€æ¸å˜çº¢ï¼ˆè¡¨ç¤º\(f[i]\)å¢å¤§ï¼‰ï¼Œè¾¹é¢œè‰²å˜åŒ–ï¼ˆæ­£æƒå€¼å˜ç»¿ï¼Œè´Ÿæƒå€¼å˜ç°ï¼‰ã€‚  
3. **dfs2è®¡ç®—gæ•°ç»„**ï¼šä»æ ¹èŠ‚ç‚¹å¼€å§‹ï¼Œå‘ä¸‹éå†ï¼ŒèŠ‚ç‚¹é¢œè‰²é€æ¸å˜è“ï¼ˆè¡¨ç¤º\(g[i]\)å¢å¤§ï¼‰ï¼Œè¾¹é¢œè‰²å˜åŒ–ï¼ˆè¡¨ç¤ºç¥–å…ˆæ–¹å‘çš„è´¡çŒ®ï¼‰ã€‚  
4. **è·¯å¾„æŸ¥è¯¢**ï¼šç”¨æˆ·è¾“å…¥\(U\)å’Œ\(V\)ï¼ŒåŠ¨ç”»å±•ç¤ºâ€œè·³è·ƒé‡é“¾â€çš„è¿‡ç¨‹ï¼ˆæ¯”å¦‚ä»\(U\)è·³åˆ°é‡é“¾é¡¶ï¼Œå†è·³åˆ°çˆ¶èŠ‚ç‚¹çš„é‡é“¾é¡¶ï¼‰ï¼Œé«˜äº®å½“å‰å¤„ç†çš„é“¾ï¼Œä¼´éšâ€œå®â€çš„éŸ³æ•ˆï¼ˆè¡¨ç¤ºè®¡ç®—è·¯å¾„å’Œï¼‰ã€‚  
5. **ç»“æœå±•ç¤º**ï¼šæœ€ç»ˆç­”æ¡ˆæ˜¾ç¤ºåœ¨å±å¹•ä¸Šæ–¹ï¼Œä¼´éšâ€œèƒœåˆ©â€éŸ³æ•ˆï¼ˆå¦‚ã€Šè¶…çº§é©¬é‡Œå¥¥ã€‹çš„é€šå…³éŸ³æ•ˆï¼‰ã€‚  

### äº¤äº’è®¾è®¡
- **æ­¥è¿›æ§åˆ¶**ï¼šç”¨æˆ·å¯ä»¥ç‚¹å‡»â€œå•æ­¥â€æŒ‰é’®ï¼Œé€å¸§è§‚çœ‹dfs1ã€dfs2å’Œè·¯å¾„æŸ¥è¯¢çš„è¿‡ç¨‹ã€‚  
- **è‡ªåŠ¨æ’­æ”¾**ï¼šç”¨æˆ·å¯ä»¥è°ƒæ•´é€Ÿåº¦æ»‘å—ï¼ˆ1~10å€é€Ÿï¼‰ï¼Œè®©åŠ¨ç”»è‡ªåŠ¨æ’­æ”¾ã€‚  
- **é‡ç½®**ï¼šç‚¹å‡»â€œé‡ç½®â€æŒ‰é’®ï¼Œå›åˆ°åˆå§‹çŠ¶æ€ã€‚  

### è®¾è®¡ç†ç”±
- **åƒç´ é£æ ¼**ï¼šå¤å¤æ¸¸æˆé£æ ¼èƒ½æ¿€å‘é’å°‘å¹´çš„å…´è¶£ï¼Œé™ä½å­¦ä¹ å‹åŠ›ã€‚  
- **é¢œè‰²æ ‡è®°**ï¼šç”¨é¢œè‰²åŒºåˆ†\(f\)ï¼ˆçº¢ï¼‰å’Œ\(g\)ï¼ˆè“ï¼‰ï¼Œè®©ç”¨æˆ·ç›´è§‚çœ‹åˆ°å€¼çš„å˜åŒ–ã€‚  
- **éŸ³æ•ˆæç¤º**ï¼šå…³é”®æ“ä½œï¼ˆå¦‚è®¡ç®—è·¯å¾„å’Œï¼‰ç”¨éŸ³æ•ˆå¼ºåŒ–è®°å¿†ï¼Œæé«˜å­¦ä¹ æ•ˆç‡ã€‚  


## 6. æ‹“å±•ç»ƒä¹ ä¸ç›¸ä¼¼é—®é¢˜æ€è€ƒ

### é€šç”¨æ€è·¯è¿ç§»
æ¢æ ¹DPå’Œæ ‘é“¾å‰–åˆ†çš„ç»„åˆï¼Œå¸¸ç”¨äºè§£å†³**æ ‘ä¸­çš„è¿é€šå—æœ€ä¼˜é—®é¢˜**ï¼ˆå¦‚æœ€å¤§è·¯å¾„å’Œã€æœ€å°ç‚¹è¦†ç›–ï¼‰ã€**è·¯å¾„æŸ¥è¯¢é—®é¢˜**ï¼ˆå¦‚è·¯å¾„ä¸Šçš„æœ€å¤§/æœ€å°å€¼ã€æ€»å’Œï¼‰ã€‚ä¾‹å¦‚ï¼š  
- é—®é¢˜1ï¼šæ‰¾åˆ°æ ‘ä¸­æœ€é•¿çš„è·¯å¾„ï¼ˆç›´å¾„ï¼‰ï¼Œå¯ä»¥ç”¨æ¢æ ¹DPè®¡ç®—æ¯ä¸ªèŠ‚ç‚¹çš„æœ€é•¿å­æ ‘è·¯å¾„ï¼Œå†åˆå¹¶ã€‚  
- é—®é¢˜2ï¼šå¤šæ¬¡æŸ¥è¯¢è·¯å¾„ä¸Šçš„æœ€å¤§è¾¹æƒï¼Œå¯ä»¥ç”¨æ ‘é“¾å‰–åˆ†ç»´æŠ¤çº¿æ®µæ ‘ã€‚  

### ç»ƒä¹ æ¨è (æ´›è°·)
1. **æ´›è°· P1122** - æ ‘çš„æœ€é•¿è·¯å¾„  
   ğŸ—£ï¸ **æ¨èç†ç”±**ï¼šè¿™é“é¢˜æ˜¯æ¢æ ¹DPçš„ç»å…¸åº”ç”¨ï¼Œéœ€è¦è®¡ç®—æ ‘çš„ç›´å¾„ï¼ˆæœ€é•¿è·¯å¾„ï¼‰ï¼Œå¸®åŠ©å·©å›º\(f\)æ•°ç»„çš„è®¾è®¡ã€‚  
2. **æ´›è°· P2986** - [USACO10MAR]Great Cow Gathering G  
   ğŸ—£ï¸ **æ¨èç†ç”±**ï¼šæ­¤é¢˜éœ€è¦è®¡ç®—å°†æ‰€æœ‰å¥¶ç‰›èšé›†åˆ°ä¸€ä¸ªèŠ‚ç‚¹çš„æœ€å°ä»£ä»·ï¼Œç”¨æ¢æ ¹DPå¤„ç†å­æ ‘å’Œç¥–å…ˆçš„ä»£ä»·ï¼Œé€‚åˆç»ƒä¹ æ¢æ ¹é€»è¾‘ã€‚  
3. **æ´›è°· P3178** - [HAOI2015]æ ‘ä¸Šæ“ä½œ  
   ğŸ—£ï¸ **æ¨èç†ç”±**ï¼šæ­¤é¢˜éœ€è¦å¤„ç†æ ‘ä¸Šçš„ç‚¹ä¿®æ”¹å’Œè·¯å¾„æŸ¥è¯¢ï¼Œç”¨æ ‘é“¾å‰–åˆ†ç»´æŠ¤çº¿æ®µæ ‘ï¼Œé€‚åˆå·©å›ºè·¯å¾„æŸ¥è¯¢çš„å®ç°ã€‚  


## 7. å­¦ä¹ å¿ƒå¾—ä¸ç»éªŒåˆ†äº« (è‹¥æœ‰)
**å‚è€ƒç»éªŒ (æ¥è‡ª ARIS2_0)**ï¼šâ€œè™½ç„¶ç†è®ºä¸Šæ˜¯è¦åˆ¤\(s,t\)çš„LCAæ˜¯\(s\)æˆ–\(t\)çš„æƒ…å†µçš„ï¼Œä½†æ˜¯å› ä¸ºç­”æ¡ˆçš„ç¥ç§˜å®¹æ–¥ï¼Œä¸ç‰¹åˆ¤ä¹Ÿèƒ½è¿‡ã€‚â€  
**ç‚¹è¯„**ï¼šè¿™ä½ä½œè€…çš„ç»éªŒæé†’æˆ‘ä»¬ï¼Œ**å®¹æ–¥é€»è¾‘çš„ä¸¥è°¨æ€§**å¾ˆé‡è¦ã€‚åœ¨å¤„ç†è·¯å¾„é—®é¢˜æ—¶ï¼ŒLCAçš„è¾¹ç•Œæƒ…å†µï¼ˆå¦‚\(s\)æ˜¯\(t\)çš„ç¥–å…ˆï¼‰å¯èƒ½ä¼šå½±å“ç»“æœï¼Œä½†é€šè¿‡åˆç†çš„å®¹æ–¥ï¼ˆå¦‚\(det\)æ•°ç»„çš„è®¾è®¡ï¼‰ï¼Œå¯ä»¥é¿å…ç‰¹åˆ¤ï¼Œç®€åŒ–ä»£ç ã€‚è¿™éœ€è¦æˆ‘ä»¬å¯¹é—®é¢˜çš„æ ¸å¿ƒé€»è¾‘æœ‰æ·±å…¥çš„ç†è§£ã€‚  


## ç»“è¯­
æœ¬æ¬¡å…³äºâ€œRoad Tripâ€çš„C++è§£é¢˜åˆ†æå°±åˆ°è¿™é‡Œã€‚å¸Œæœ›è¿™ä»½å­¦ä¹ æŒ‡å—èƒ½å¸®åŠ©å¤§å®¶ç†è§£æ¢æ ¹DPå’Œæ ‘é“¾å‰–åˆ†çš„ç»„åˆåº”ç”¨ï¼ŒæŒæ¡è§£å†³æ ‘é—®é¢˜çš„å…³é”®æŠ€å·§ã€‚è®°ä½ï¼Œ**ç¼–ç¨‹çš„ä¹è¶£åœ¨äºæ‹†è§£é—®é¢˜ã€å¯»æ‰¾è§„å¾‹**ï¼Œåªè¦å¤šæ€è€ƒã€å¤šç»ƒä¹ ï¼Œä½ ä¸€å®šèƒ½è§£å†³æ›´å¤šçš„ç¼–ç¨‹æŒ‘æˆ˜ï¼ğŸ’ª

---
å¤„ç†ç”¨æ—¶ï¼š187.02ç§’
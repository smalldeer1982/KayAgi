# 题目信息

# 無限グラフ

## 题目描述

[problemUrl]: https://atcoder.jp/contests/tenka1-2016-quala/tasks/tenka1_2016_qualA_e

*天下一研究所は、組合せ数学の研究拠点として様々な活動を行っています。 最近は、無限個の頂点を持つグラフに関する研究が盛んなようです。*

正の整数 $ N $ と、$ 0 $ 以上 $ N-1 $ 以下の整数のペア $ M $ 組 $ (A_1,\ B_1),\ (A_2,\ B_2),\ …,\ (A_M,\ B_M) $ が与えられます。

次のような、無限個の頂点を持つ無向グラフを考えます。

- 任意の整数 $ z $ に対し（負の整数も考える）、それに対応する頂点がただ一つ存在する。整数 $ z $ に対応する頂点を頂点 $ z $ と呼ぶ。どの整数にも対応しない頂点は存在しない。
- 任意の二つの整数 $ i,\ k\ (1\ ≦\ i\ ≦\ M) $ に対し、頂点 $ A_i\ +\ k\ ×\ N $ と頂点 $ B_i\ +\ (k\ +\ 1)\ ×\ N $ は一本の辺で直接結ばれる。それらの辺以外に辺は存在しない。

（入力例・出力例のセクションの画像を参考にしてください）

このグラフの連結成分の個数が有限かどうかを判定し、有限ならその個数を求めてください。

## 说明/提示

### 制約

- $ 1\ ≦\ N\ ≦\ 10^5 $
- $ 1\ ≦\ M\ ≦\ 10^5 $
- $ 0\ ≦\ A_i,\ B_i\ ≦\ N-1 $
- すべての組 $ (A_i,\ B_i) $ は異なる。

### 部分点

- $ 400 $ 点分のデータセットは以下を満たす。
  - $ 1\ ≦\ N\ ≦\ 1000 $
  - $ 1\ ≦\ M\ ≦\ 1000 $

### Sample Explanation 1

!\[E1.png\](https://tenka1-2016-quala.contest.atcoder.jp/img/other/tenka1\_2016\_quala/bagnyahay/E1.png) 辺をたどって、任意の二頂点間を行き来できます。したがって、このグラフの連結成分の個数は $ 1 $ です。

### Sample Explanation 2

!\[E2.png\](https://tenka1-2016-quala.contest.atcoder.jp/img/other/tenka1\_2016\_quala/bagnyahay/E2.png) 無限の長さを持つ直線状の連結成分が $ 2 $ 個あります。

### Sample Explanation 3

!\[E3.png\](https://tenka1-2016-quala.contest.atcoder.jp/img/other/tenka1\_2016\_quala/bagnyahay/E3.png) $ 3 $ 頂点からなる連結成分が無限個あります。

## 样例 #1

### 输入

```
2 2

0 0

1 0```

### 输出

```
1```

## 样例 #2

### 输入

```
2 2

0 1

1 0```

### 输出

```
2```

## 样例 #3

### 输入

```
3 2

0 1

2 1```

### 输出

```
-1```

## 样例 #4

### 输入

```
7 8

0 3

1 2

1 5

2 5

3 4

4 6

5 2

6 3```

### 输出

```
4```

# AI分析结果

要解决“无限图的连通成分个数”问题，我们需要**将无限图的结构转化为有限的余数图分析**，通过图论中的**强连通分量（SCC）**和**环检测**判断连通成分是否有限，并计算其数量。


### **1. 题目解读与核心算法识别**
#### **题目核心**
给定一个无限图，顶点是所有整数，边由原边（\(A_i, B_i\)）扩展而来：对于每个原边和整数\(k\)，顶点\(A_i + k \cdot N\)与\(B_i + (k+1) \cdot N\)之间有一条无向边。要求判断连通成分个数是否有限，有限则输出个数，否则输出-1。

#### **核心算法：余数图与强连通分量**
- **余数图构造**：将每个顶点\(z\)表示为\(z = a + k \cdot N\)（\(a\)为余数，\(0 \leq a < N\)；\(k\)为层号），构建有向图\(G\)，其中节点是余数\(0 \sim N-1\)，边为原边\(A_i \to B_i\)（表示从层\(k\)的\(A_i\)到层\(k+1\)的\(B_i\)）。
- **关键观察**：无限图的连通性取决于余数图的**强连通性**和**环结构**。若余数图中存在环，则对应的连通成分可以无限扩展（层号无限增加/减少）；若没有环，则连通成分个数有限。

#### **可视化设计思路**
- **像素风格**：用8位像素块表示余数（如\(0\sim N-1\)用不同颜色的方块），层号用垂直方向的“楼层”表示（如层\(k\)在第\(k\)行）。
- **动画流程**：
  1. **初始化**：显示余数图的节点（像素块）和边（箭头）。
  2. **环检测**：用闪烁效果标记环中的节点，用“水流”动画模拟路径的无限扩展（如环中的节点不断循环，层号不断增加）。
  3. **连通成分展示**：用不同颜色区分有限连通成分，用“无限延伸”动画表示无限连通成分（如像素块向上下方向无限滚动）。
- **游戏化元素**：添加“单步执行”“自动播放”按钮，用“叮”音效提示环检测完成，用“胜利”音效提示有限连通成分计算完成。


### **2. 核心难点辨析与解题策略**
#### **难点1：无限图到有限图的转化**
- **问题**：无限图无法直接处理，需找到其周期性结构。
- **策略**：将顶点按余数分组（\(0\sim N-1\)），构建余数图，将无限图的连通性转化为余数图的路径问题。

#### **难点2：判断连通成分是否有限**
- **问题**：如何判断无限图的连通成分个数是否有限？
- **策略**：若余数图中存在**环**，则对应的连通成分可以无限扩展（层号无限增加/减少），此时连通成分个数无限；若余数图中没有环，则连通成分个数有限。

#### **难点3：计算有限连通成分个数**
- **问题**：若连通成分个数有限，如何计算？
- **策略**：余数图的**强连通分量（SCC）**个数即为有限连通成分个数。因为每个SCC中的余数可以互相到达，且无法无限扩展（无环），所以每个SCC对应一个有限连通成分。


### **3. 算法实现步骤（伪代码）**
#### **步骤1：构建余数图**
```cpp
vector<vector<int>> G(N); // G[a]存储余数a的出边（B_i）
for (int i = 0; i < M; i++) {
    int A, B;
    cin >> A >> B;
    G[A].push_back(B);
}
```

#### **步骤2：强连通分量分解（Tarjan算法）**
```cpp
vector<int> dfn(N, -1), low(N, -1);
vector<bool> in_stack(N, false);
stack<int> st;
int timestamp = 0;
vector<vector<int>> scc;

function<void(int)> tarjan = [&](int u) {
    dfn[u] = low[u] = timestamp++;
    st.push(u);
    in_stack[u] = true;
    for (int v : G[u]) {
        if (dfn[v] == -1) {
            tarjan(v);
            low[u] = min(low[u], low[v]);
        } else if (in_stack[v]) {
            low[u] = min(low[u], dfn[v]);
        }
    }
    if (dfn[u] == low[u]) {
        vector<int> component;
        int v;
        do {
            v = st.top();
            st.pop();
            in_stack[v] = false;
            component.push_back(v);
        } while (v != u);
        scc.push_back(component);
    }
};

for (int u = 0; u < N; u++) {
    if (dfn[u] == -1) {
        tarjan(u);
    }
}
```

#### **步骤3：判断环是否存在**
```cpp
bool has_cycle = false;
for (auto& component : scc) {
    if (component.size() > 1) { // 大小大于1的SCC必有环
        has_cycle = true;
        break;
    }
    // 大小为1的SCC需检查是否有自环（原边中存在(A_i, A_i)）
    int u = component[0];
    for (int v : G[u]) {
        if (v == u) {
            has_cycle = true;
            break;
        }
    }
}
```

#### **步骤4：输出结果**
```cpp
if (has_cycle) {
    cout << -1 << endl; // 存在环，连通成分个数无限
} else {
    cout << scc.size() << endl; // 无环，连通成分个数等于SCC个数
}
```


### **4. 拓展练习与相似问题**
#### **通用思路迁移**
- **环检测**：余数图中的环是判断无限连通成分的关键，可迁移到**无限状态机**或**周期性路径**问题。
- **强连通分量**：SCC分解用于将图简化为DAG，可迁移到**缩点优化**或**连通性分析**问题。

#### **洛谷练习推荐**
1. **P2863 [USACO06JAN]The Cow Prom S**：强连通分量模板题，练习SCC分解。
2. **P3387 【模板】缩点**：缩点优化模板题，练习将图简化为DAG。
3. **P1113 杂务**：拓扑排序模板题，练习处理无环图的连通性。


### **5. 总结**
- **核心思想**：将无限图转化为有限的余数图，通过SCC分解和环检测判断连通成分是否有限。
- **关键技巧**：强连通分量分解（Tarjan算法）、环检测（SCC大小或自环）。
- **学习建议**：重点掌握余数图的构造和SCC分解，理解无限图与有限图的对应关系。

通过以上分析，我们可以快速解决无限图的连通成分问题，关键在于**将无限问题有限化**，利用图论中的经典算法处理。

---
处理用时：402.55秒
# é¢˜ç›®ä¿¡æ¯

# [ABC202E] Count Descendants

## é¢˜ç›®æè¿°

[problemUrl]: https://atcoder.jp/contests/abc202/tasks/abc202_e

$ N $ é ‚ç‚¹ã®æ ¹ä»˜ãæœ¨ãŒã‚ã‚Šã€é ‚ç‚¹ã¯ $ 1,\ 2,\ \dots,\ N $ ã¨ç•ªå·ä»˜ã‘ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚

é ‚ç‚¹ $ 1 $ ãŒæ ¹ã§ã‚ã‚Šã€é ‚ç‚¹ $ i\ \,\ (2\ \leq\ i\ \leq\ N) $ ã®è¦ªã¯ $ P_i $ ã§ã™ã€‚

$ Q $ å€‹ã®ã‚¯ã‚¨ãƒªãŒä¸ãˆã‚‰ã‚Œã¾ã™ã€‚$ i\ \,\ (1\ \leq\ i\ \leq\ Q) $ ç•ªç›®ã®ã‚¯ã‚¨ãƒªã§ã¯ã€æ•´æ•° $ U_i,\ D_i $ ãŒä¸ãˆã‚‰ã‚Œã‚‹ã®ã§ã€æ¬¡ã®æ¡ä»¶ã‚’å…¨ã¦æº€ãŸã™é ‚ç‚¹ $ u $ ã®å€‹æ•°ã‚’æ±‚ã‚ã¦ãã ã•ã„ã€‚

- $ u $ ã‹ã‚‰æ ¹ã¸ã®æœ€çŸ­ãƒ‘ã‚¹ä¸Šï¼ˆç«¯ç‚¹ã‚‚å«ã‚€ï¼‰ã«é ‚ç‚¹ $ U_i $ ãŒå­˜åœ¨ã™ã‚‹ã€‚
- $ u $ ã‹ã‚‰æ ¹ã¸ã®æœ€çŸ­ãƒ‘ã‚¹ã«å«ã¾ã‚Œã‚‹è¾ºã®æ•°ãŒ**ã¡ã‚‡ã†ã©** $ D_i $ ã§ã‚ã‚‹ã€‚

## è¯´æ˜/æç¤º

### åˆ¶ç´„

- $ 2\ \leq\ N\ \leq\ 2\ \times\ 10^5 $
- $ 1\ \leq\ P_i\ <\ i $
- $ 1\ \leq\ Q\ \leq\ 2\ \times\ 10^5 $
- $ 1\ \leq\ U_i\ \leq\ N $
- $ 0\ \leq\ D_i\ \leq\ N\ -\ 1 $
- å…¥åŠ›ã¯å…¨ã¦æ•´æ•°ã§ã‚ã‚‹ã€‚

### Sample Explanation 1

$ 1 $ ç•ªç›®ã®ã‚¯ã‚¨ãƒªã§ã¯ã€é ‚ç‚¹ $ 4,\ 5,\ 7 $ ãŒæ¡ä»¶ã‚’æº€ãŸã—ã¾ã™ã€‚ $ 2 $ ç•ªç›®ã®ã‚¯ã‚¨ãƒªã§ã¯ã€é ‚ç‚¹ $ 7 $ ã®ã¿ãŒæ¡ä»¶ã‚’æº€ãŸã—ã¾ã™ã€‚ $ 3 $ ç•ªç›®ã€$ 4 $ ç•ªç›®ã®ã‚¯ã‚¨ãƒªã§ã¯ã€æ¡ä»¶ã‚’æº€ãŸã™é ‚ç‚¹ã¯å­˜åœ¨ã—ã¾ã›ã‚“ã€‚ !\[sample\](https://img.atcoder.jp/ghi/abc202\_e\_sample\_00.jpg)

## æ ·ä¾‹ #1

### è¾“å…¥

```
7

1 1 2 2 4 2

4

1 2

7 2

4 1

5 5```

### è¾“å‡º

```
3

1

0

0```

# AIåˆ†æç»“æœ

# ğŸ’¡ Kayçš„C++ç®—æ³•è§£æï¼š[ABC202E] Count Descendants æ·±å…¥å­¦ä¹ æŒ‡å— ğŸ’¡


## 1. é¢˜ç›®è§£è¯»ä¸æ ¸å¿ƒç®—æ³•è¯†åˆ«

âœ¨ **æœ¬é¢˜ä¸»è¦è€ƒå¯Ÿ**ï¼šæ ‘çš„DFSåºï¼ˆæ—¶é—´æˆ³ï¼‰ä¸äºŒåˆ†æŸ¥æ‰¾åº”ç”¨  

ğŸ—£ï¸ **åˆæ­¥åˆ†æ**ï¼š  
è§£å†³â€œCount Descendantsâ€é—®é¢˜ï¼Œå…³é”®åœ¨äº**å°†æ ‘çš„å­æ ‘é—®é¢˜è½¬åŒ–ä¸ºåŒºé—´æŸ¥è¯¢é—®é¢˜**ã€‚æˆ‘ä»¬å¯ä»¥ç”¨**æ—¶é—´æˆ³**ï¼ˆDFSåºï¼‰ç»™æ¯ä¸ªèŠ‚ç‚¹æ‰“ä¸Šâ€œå…¥åœºâ€ï¼ˆ`Tin`ï¼‰å’Œâ€œå‡ºåœºâ€ï¼ˆ`Tout`ï¼‰æ ‡è®°â€”â€”å°±åƒç­çº§é‡Œçš„å­¦ç”Ÿï¼Œç­ä¸»ä»»ï¼ˆæ ¹èŠ‚ç‚¹ï¼‰çš„ç­¾åˆ°æ—¶é—´æœ€æ—©ï¼Œç­¾é€€æ—¶é—´æœ€æ™šï¼Œè€Œæ‰€æœ‰å­¦ç”Ÿï¼ˆå­èŠ‚ç‚¹ï¼‰çš„ç­¾åˆ°æ—¶é—´éƒ½åœ¨ç­ä¸»ä»»çš„ç­¾åˆ°å’Œç­¾é€€ä¹‹é—´ã€‚è¿™æ ·ï¼Œå­æ ‘ä¸­çš„èŠ‚ç‚¹å°±å¯¹åº”ä¸€ä¸ªè¿ç»­çš„åŒºé—´`[Tin[u], Tout[u]]`ã€‚  

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦ç»Ÿè®¡**å­æ ‘ä¸­ç‰¹å®šæ·±åº¦çš„èŠ‚ç‚¹æ•°**ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬ç»™æ¯ä¸ªæ·±åº¦`d`ç»´æŠ¤ä¸€ä¸ª**æœ‰åºåˆ—è¡¨**ï¼Œå­˜å‚¨è¯¥æ·±åº¦æ‰€æœ‰èŠ‚ç‚¹çš„`Tin`å€¼ã€‚æŸ¥è¯¢æ—¶ï¼Œåªéœ€åœ¨æ·±åº¦`D_i`çš„åˆ—è¡¨ä¸­ï¼Œç”¨äºŒåˆ†æŸ¥æ‰¾æ‰¾å‡ºè½åœ¨`[Tin[U_i], Tout[U_i]]`åŒºé—´å†…çš„å…ƒç´ ä¸ªæ•°ï¼Œå°±èƒ½å¾—åˆ°ç­”æ¡ˆã€‚  

**æ ¸å¿ƒç®—æ³•æµç¨‹**ï¼š  
1. **DFSç”Ÿæˆæ—¶é—´æˆ³**ï¼šéå†æ ‘ï¼Œè®°å½•æ¯ä¸ªèŠ‚ç‚¹çš„`Tin`ï¼ˆè¿›å…¥æ—¶çš„æ—¶é—´æˆ³ï¼‰ã€`Tout`ï¼ˆç¦»å¼€æ—¶çš„æ—¶é—´æˆ³ï¼‰å’Œæ·±åº¦`dep`ã€‚  
2. **æŒ‰æ·±åº¦ç»´æŠ¤æœ‰åºåˆ—è¡¨**ï¼šå°†æ¯ä¸ªèŠ‚ç‚¹çš„`Tin`å€¼åŠ å…¥å¯¹åº”æ·±åº¦çš„åˆ—è¡¨ï¼ˆå› DFSé¡ºåºï¼Œåˆ—è¡¨è‡ªç„¶æœ‰åºï¼‰ã€‚  
3. **äºŒåˆ†æŸ¥è¯¢**ï¼šå¯¹äºæ¯ä¸ªæŸ¥è¯¢`(U_i, D_i)`ï¼Œåœ¨æ·±åº¦`D_i`çš„åˆ—è¡¨ä¸­ï¼Œç”¨`lower_bound`æ‰¾åˆ°`Tin[U_i]`çš„ä½ç½®`l`å’Œ`Tout[U_i]`çš„ä½ç½®`r`ï¼Œç­”æ¡ˆå³ä¸º`r - l`ã€‚  

**å¯è§†åŒ–è®¾è®¡æ€è·¯**ï¼š  
- ç”¨8ä½åƒç´ å—è¡¨ç¤ºèŠ‚ç‚¹ï¼Œé¢œè‰²åŒºåˆ†æ·±åº¦ï¼ˆå¦‚çº¢è‰²è¡¨ç¤ºæ·±åº¦1ï¼Œè“è‰²è¡¨ç¤ºæ·±åº¦2ï¼‰ã€‚  
- DFSè¿‡ç¨‹ä¸­ï¼ŒèŠ‚ç‚¹ä¾æ¬¡â€œç‚¹äº®â€ï¼Œæ˜¾ç¤º`Tin`å’Œ`Tout`å€¼ï¼ˆå¦‚èŠ‚ç‚¹ä¸Šæ–¹çš„æ•°å­—ï¼‰ã€‚  
- æ¯ä¸ªæ·±åº¦çš„åˆ—è¡¨ç”¨åƒç´ åŒ–çš„â€œé˜Ÿåˆ—â€å±•ç¤ºï¼Œ`Tin`å€¼æŒ‰é¡ºåºæ’åˆ—ã€‚  
- æŸ¥è¯¢æ—¶ï¼Œé«˜äº®`[Tin[U_i], Tout[U_i]]`åŒºé—´ï¼ˆå¦‚èŠ‚ç‚¹å‘¨å›´çš„é»„è‰²è¾¹æ¡†ï¼‰ï¼Œå¹¶åŠ¨æ€æ˜¾ç¤ºäºŒåˆ†æŸ¥æ‰¾çš„è¿‡ç¨‹ï¼ˆå¦‚ç®­å¤´æŒ‡å‘å½“å‰æ¯”è¾ƒçš„å…ƒç´ ï¼‰ã€‚  
- éŸ³æ•ˆï¼šDFSè®¿é—®èŠ‚ç‚¹æ—¶æ’­æ”¾â€œå®â€å£°ï¼ŒæŸ¥è¯¢å®Œæˆæ—¶æ’­æ”¾â€œæ»´â€å£°ï¼Œå¢å¼ºäº’åŠ¨æ„Ÿã€‚  


## 2. ç²¾é€‰ä¼˜è´¨é¢˜è§£å‚è€ƒ

### é¢˜è§£ä¸€ï¼šRay662çš„æ—¶é—´æˆ³+äºŒåˆ†ï¼ˆè¯„åˆ†ï¼š5æ˜Ÿï¼‰  
**ç‚¹è¯„**ï¼š  
è¿™ä»½é¢˜è§£æ˜¯**æœ€ç»å…¸ã€æœ€æ˜“ç†è§£**çš„è§£æ³•ã€‚æ€è·¯æ¸…æ™°ï¼Œå°†æ ‘é—®é¢˜è½¬åŒ–ä¸ºåŒºé—´æŸ¥è¯¢çš„æŠ€å·§éå¸¸å·§å¦™ã€‚ä»£ç ç®€æ´ï¼Œ`Tin`å’Œ`Tout`çš„ç”Ÿæˆç”¨DFSå®ç°ï¼Œæ¯ä¸ªæ·±åº¦çš„åˆ—è¡¨ç»´æŠ¤è‡ªç„¶æœ‰åºï¼ŒæŸ¥è¯¢æ—¶ç›´æ¥ç”¨`lower_bound`è®¡ç®—åŒºé—´å†…å…ƒç´ ä¸ªæ•°ã€‚å¤æ‚åº¦ä¸º`O(n log n + q log n)`ï¼Œå®Œå…¨æ»¡è¶³é¢˜ç›®è¦æ±‚ã€‚ä»£ç ä¸­çš„å˜é‡å‘½åï¼ˆå¦‚`Tin`ã€`Tout`ã€`D`æ•°ç»„ï¼‰å«ä¹‰æ˜ç¡®ï¼Œæ³¨é‡Šè¯¦ç»†ï¼Œéå¸¸é€‚åˆåˆå­¦è€…å­¦ä¹ ã€‚  

### é¢˜è§£äºŒï¼šAntonyDçš„æ—¶é—´æˆ³+äºŒåˆ†ï¼ˆè¯„åˆ†ï¼š4.5æ˜Ÿï¼‰  
**ç‚¹è¯„**ï¼š  
æ­¤é¢˜è§£ä¸é¢˜è§£ä¸€æ€è·¯ä¸€è‡´ï¼Œä½†ä»£ç æ³¨é‡Šæ›´è¯¦ç»†ï¼Œå°¤å…¶å¯¹`lower_bound`çš„ä½¿ç”¨è¿›è¡Œäº†è¯´æ˜ã€‚ä½œè€…å¼ºè°ƒäº†â€œå­æ ‘åŒºé—´åŒ…å«â€çš„æ€§è´¨ï¼ˆ`in[u] â‰¤ in[v] â‰¤ out[u]`ï¼‰ï¼Œå¸®åŠ©å­¦ä¹ è€…ç†è§£æ—¶é—´æˆ³çš„ä½œç”¨ã€‚ä»£ç ç»“æ„å·¥æ•´ï¼Œå»ºæ ‘éƒ¨åˆ†ç”¨`vector`å­˜å‚¨å­èŠ‚ç‚¹ï¼Œç¬¦åˆC++çš„å¸¸è§„å†™æ³•ï¼Œå®è·µä»·å€¼é«˜ã€‚  

### é¢˜è§£ä¸‰ï¼š_Kenma_çš„ç¦»çº¿DFSï¼ˆè¯„åˆ†ï¼š4.5æ˜Ÿï¼‰  
**ç‚¹è¯„**ï¼š  
æ­¤é¢˜è§£é‡‡ç”¨**ç¦»çº¿å¤„ç†**æ€è·¯ï¼Œå°†æŸ¥è¯¢æŒ‚åˆ°èŠ‚ç‚¹ä¸Šï¼Œç”¨å…¨å±€æ¡¶è®°å½•æ·±åº¦è®¡æ•°ã€‚DFSæ—¶ï¼Œè¿›å…¥å­æ ‘å‰è®°å½•æ¡¶çš„çŠ¶æ€ï¼Œç¦»å¼€æ—¶è®¡ç®—å·®å€¼ï¼Œå¾—åˆ°å­æ ‘å†…çš„èŠ‚ç‚¹æ•°ã€‚æ—¶é—´å¤æ‚åº¦`O(n)`ï¼Œéå¸¸é«˜æ•ˆã€‚è¿™ç§æ–¹æ³•ä¸éœ€è¦ç»´æŠ¤æœ‰åºåˆ—è¡¨ï¼Œé€‚åˆå¤„ç†å¤§è§„æ¨¡æ•°æ®ï¼Œä½†éœ€è¦ç†è§£â€œç¦»çº¿â€çš„æ€æƒ³ï¼ˆå°†æŸ¥è¯¢ä¸å¤„ç†é¡ºåºç»“åˆï¼‰ã€‚ä»£ç ç®€æ´ï¼Œé€»è¾‘æ¸…æ™°ï¼Œæ˜¯ä¼˜åŒ–æ—¶é—´å¤æ‚åº¦çš„å¥½ä¾‹å­ã€‚  


## 3. æ ¸å¿ƒéš¾ç‚¹è¾¨æä¸è§£é¢˜ç­–ç•¥

### 1. å¦‚ä½•å°†å­æ ‘é—®é¢˜è½¬åŒ–ä¸ºåŒºé—´é—®é¢˜ï¼Ÿ  
**éš¾ç‚¹**ï¼šæ ‘çš„å­æ ‘ç»“æ„æ˜¯ hierarchical çš„ï¼Œæ— æ³•ç›´æ¥ç”¨æ•°ç»„å¤„ç†ã€‚  
**è§£å†³ç­–ç•¥**ï¼šç”¨DFSç”Ÿæˆæ—¶é—´æˆ³ï¼ˆ`Tin`å’Œ`Tout`ï¼‰ã€‚å¯¹äºèŠ‚ç‚¹`u`ï¼Œæ‰€æœ‰å­èŠ‚ç‚¹çš„`Tin`å€¼éƒ½åœ¨`[Tin[u], Tout[u]]`åŒºé—´å†…ã€‚è¿™ä¸€æ­¥æ˜¯å°†æ ‘é—®é¢˜è½¬åŒ–ä¸ºåŒºé—´é—®é¢˜çš„å…³é”®ï¼Œéœ€è¦ç†è§£DFSçš„éå†é¡ºåºï¼ˆæ·±åº¦ä¼˜å…ˆï¼Œå­èŠ‚ç‚¹çš„`Tin`ä¸€å®šå¤§äºçˆ¶èŠ‚ç‚¹çš„`Tin`ï¼Œå°äºçˆ¶èŠ‚ç‚¹çš„`Tout`ï¼‰ã€‚  
ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šæ—¶é—´æˆ³æ˜¯æ ‘ç®—æ³•ä¸­çš„â€œç¿»è¯‘å®˜â€ï¼Œèƒ½å°†æ ‘çš„ç»“æ„è½¬åŒ–ä¸ºæ•°ç»„çš„åŒºé—´ï¼Œæ–¹ä¾¿ç”¨å¸¸è§„ç®—æ³•å¤„ç†ã€‚  

### 2. å¦‚ä½•é«˜æ•ˆæŸ¥è¯¢åŒºé—´å†…ç‰¹å®šæ·±åº¦çš„èŠ‚ç‚¹æ•°ï¼Ÿ  
**éš¾ç‚¹**ï¼šç›´æ¥éå†å­æ ‘åŒºé—´ä¼šè¶…æ—¶ï¼ˆ`O(n)` per queryï¼‰ã€‚  
**è§£å†³ç­–ç•¥**ï¼šæŒ‰æ·±åº¦ç»´æŠ¤æœ‰åºåˆ—è¡¨ã€‚æ¯ä¸ªæ·±åº¦`d`çš„åˆ—è¡¨å­˜å‚¨è¯¥æ·±åº¦æ‰€æœ‰èŠ‚ç‚¹çš„`Tin`å€¼ï¼ˆå› DFSé¡ºåºï¼Œåˆ—è¡¨è‡ªç„¶æœ‰åºï¼‰ã€‚æŸ¥è¯¢æ—¶ï¼Œç”¨`lower_bound`æ‰¾åˆ°åŒºé—´çš„å·¦å³è¾¹ç•Œï¼Œæ—¶é—´å¤æ‚åº¦`O(log n)` per queryã€‚è¿™ä¸€æ­¥éœ€è¦æŒæ¡`lower_bound`çš„ç”¨æ³•ï¼ˆæŸ¥æ‰¾ç¬¬ä¸€ä¸ªå¤§äºç­‰äºç›®æ ‡å€¼çš„ä½ç½®ï¼‰ã€‚  
ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šæœ‰åºåˆ—è¡¨+äºŒåˆ†æŸ¥æ‰¾æ˜¯å¤„ç†â€œåŒºé—´å†…ç‰¹å®šå€¼è®¡æ•°â€é—®é¢˜çš„é«˜æ•ˆæ–¹æ³•ã€‚  

### 3. å¦‚ä½•ç”¨ç¦»çº¿å¤„ç†ä¼˜åŒ–æ—¶é—´å¤æ‚åº¦ï¼Ÿ  
**éš¾ç‚¹**ï¼šåœ¨çº¿å¤„ç†éœ€è¦ç»´æŠ¤å¤šä¸ªæ•°æ®ç»“æ„ï¼Œæ—¶é—´å¤æ‚åº¦è¾ƒé«˜ã€‚  
**è§£å†³ç­–ç•¥**ï¼šå°†æŸ¥è¯¢æŒ‚åˆ°èŠ‚ç‚¹ä¸Šï¼Œç”¨å…¨å±€æ¡¶è®°å½•æ·±åº¦è®¡æ•°ã€‚DFSæ—¶ï¼Œè¿›å…¥å­æ ‘å‰è®°å½•æ¡¶çš„çŠ¶æ€ï¼Œç¦»å¼€æ—¶è®¡ç®—å·®å€¼ï¼ˆå½“å‰æ¡¶çŠ¶æ€ - è¿›å…¥å‰çš„çŠ¶æ€ï¼‰ï¼Œå¾—åˆ°å­æ ‘å†…çš„èŠ‚ç‚¹æ•°ã€‚è¿™ç§æ–¹æ³•ä¸éœ€è¦ç»´æŠ¤æœ‰åºåˆ—è¡¨ï¼Œæ—¶é—´å¤æ‚åº¦`O(n)`ï¼Œä½†éœ€è¦ç†è§£â€œç¦»çº¿â€çš„æ€æƒ³ï¼ˆå°†æŸ¥è¯¢ä¸å¤„ç†é¡ºåºç»“åˆï¼‰ã€‚  
ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šç¦»çº¿å¤„ç†æ˜¯ä¼˜åŒ–æ—¶é—´å¤æ‚åº¦çš„å¸¸ç”¨æŠ€å·§ï¼Œé€‚åˆå¤„ç†â€œå­æ ‘ç»Ÿè®¡â€ç±»é—®é¢˜ã€‚  


## 4. C++æ ¸å¿ƒä»£ç å®ç°èµæ

### æœ¬é¢˜é€šç”¨æ ¸å¿ƒC++å®ç°å‚è€ƒï¼ˆæ¥è‡ªRay662çš„é¢˜è§£ï¼‰  
**è¯´æ˜**ï¼šæ­¤ä»£ç æ˜¯æ—¶é—´æˆ³+äºŒåˆ†çš„ç»å…¸å®ç°ï¼Œé€»è¾‘æ¸…æ™°ï¼Œé€‚åˆåˆå­¦è€…å‚è€ƒã€‚  
```cpp
#include <iostream>
#include <vector>
#include <algorithm>
using namespace std;
const int N = 2e5 + 10;
int n, q, Tin[N], Tout[N], timer;
vector<int> D[N], e[N]; // D[d]å­˜å‚¨æ·±åº¦dçš„æ‰€æœ‰èŠ‚ç‚¹çš„Tinå€¼

void dfs(int u, int depth) {
    Tin[u] = ++timer; // è®°å½•è¿›å…¥æ—¶é—´
    D[depth].push_back(Tin[u]); // å°†å½“å‰èŠ‚ç‚¹çš„TinåŠ å…¥å¯¹åº”æ·±åº¦çš„åˆ—è¡¨
    for (int v : e[u]) {
        dfs(v, depth + 1); // é€’å½’éå†å­èŠ‚ç‚¹
    }
    Tout[u] = ++timer; // è®°å½•ç¦»å¼€æ—¶é—´
}

int main() {
    ios::sync_with_stdio(false), cin.tie(0);
    cin >> n;
    for (int i = 2; i <= n; i++) {
        int fa;
        cin >> fa;
        e[fa].push_back(i); // å»ºæ ‘ï¼ˆçˆ¶èŠ‚ç‚¹å­˜å‚¨å­èŠ‚ç‚¹ï¼‰
    }
    dfs(1, 0); // ä»æ ¹èŠ‚ç‚¹ï¼ˆ1ï¼‰å¼€å§‹DFSï¼Œæ·±åº¦ä¸º0
    cin >> q;
    while (q--) {
        int u, depth;
        cin >> u >> depth;
        // åœ¨D[depth]ä¸­æŸ¥æ‰¾[Tin[u], Tout[u]]åŒºé—´å†…çš„å…ƒç´ ä¸ªæ•°
        auto l = lower_bound(D[depth].begin(), D[depth].end(), Tin[u]);
        auto r = lower_bound(D[depth].begin(), D[depth].end(), Tout[u]);
        cout << r - l << endl;
    }
    return 0;
}
```  
**ä»£ç è§£è¯»æ¦‚è¦**ï¼š  
1. **å»ºæ ‘**ï¼šç”¨`vector`å­˜å‚¨æ¯ä¸ªèŠ‚ç‚¹çš„å­èŠ‚ç‚¹ï¼ˆ`e[fa].push_back(i)`ï¼‰ã€‚  
2. **DFSç”Ÿæˆæ—¶é—´æˆ³**ï¼š`dfs`å‡½æ•°è®°å½•æ¯ä¸ªèŠ‚ç‚¹çš„`Tin`ï¼ˆè¿›å…¥æ—¶é—´ï¼‰å’Œ`Tout`ï¼ˆç¦»å¼€æ—¶é—´ï¼‰ï¼Œå¹¶å°†`Tin`åŠ å…¥å¯¹åº”æ·±åº¦çš„åˆ—è¡¨ï¼ˆ`D[depth].push_back(Tin[u])`ï¼‰ã€‚  
3. **æŸ¥è¯¢**ï¼šå¯¹äºæ¯ä¸ªæŸ¥è¯¢`(u, depth)`ï¼Œç”¨`lower_bound`æ‰¾åˆ°`D[depth]`ä¸­`Tin[u]`çš„ä½ç½®`l`å’Œ`Tout[u]`çš„ä½ç½®`r`ï¼Œç­”æ¡ˆå³ä¸º`r - l`ã€‚  


### é¢˜è§£ä¸‰ï¼ˆ_Kenma_çš„ç¦»çº¿DFSï¼‰æ ¸å¿ƒä»£ç ç‰‡æ®µ  
**äº®ç‚¹**ï¼šç¦»çº¿å¤„ç†ï¼Œç”¨æ¡¶è®°å½•æ·±åº¦è®¡æ•°ï¼Œæ—¶é—´å¤æ‚åº¦`O(n)`ã€‚  
```cpp
#include <iostream>
#include <vector>
using namespace std;
const int N = 2e5 + 5;
int n, q, dep[N], t[N], ans[N];
vector<int> e[N];
vector<pair<int, int>> qry[N]; // qry[u]å­˜å‚¨(æ·±åº¦k, æŸ¥è¯¢id)

void dfs1(int u, int fa) {
    dep[u] = dep[fa] + 1; // è®¡ç®—æ·±åº¦
    for (int v : e[u]) {
        if (v != fa) dfs1(v, u);
    }
}

void dfs2(int u, int fa) {
    // è¿›å…¥å­æ ‘å‰ï¼Œè®°å½•å½“å‰æ¡¶çš„çŠ¶æ€
    for (auto [k, id] : qry[u]) {
        ans[id] = t[k];
    }
    // éå†å­èŠ‚ç‚¹
    for (int v : e[u]) {
        if (v != fa) dfs2(v, u);
    }
    // ç¦»å¼€å­æ ‘æ—¶ï¼Œæ›´æ–°æ¡¶çš„çŠ¶æ€ï¼ˆå½“å‰èŠ‚ç‚¹åŠ å…¥æ¡¶ï¼‰
    t[dep[u]]++;
    // è®¡ç®—å·®å€¼ï¼ˆå½“å‰æ¡¶çŠ¶æ€ - è¿›å…¥å‰çš„çŠ¶æ€ï¼‰
    for (auto [k, id] : qry[u]) {
        ans[id] = t[k] - ans[id];
    }
}

int main() {
    ios::sync_with_stdio(false), cin.tie(0);
    cin >> n;
    for (int i = 2; i <= n; i++) {
        int fa;
        cin >> fa;
        e[fa].push_back(i);
    }
    dfs1(1, 0); // è®¡ç®—æ·±åº¦
    cin >> q;
    for (int i = 1; i <= q; i++) {
        int u, k;
        cin >> u >> k;
        qry[u].emplace_back(k, i); // å°†æŸ¥è¯¢æŒ‚åˆ°èŠ‚ç‚¹uä¸Š
    }
    dfs2(1, 0); // ç¦»çº¿å¤„ç†æŸ¥è¯¢
    for (int i = 1; i <= q; i++) {
        cout << ans[i] << '\n';
    }
    return 0;
}
```  
**ä»£ç è§£è¯»**ï¼š  
1. **è®¡ç®—æ·±åº¦**ï¼š`dfs1`å‡½æ•°è®¡ç®—æ¯ä¸ªèŠ‚ç‚¹çš„æ·±åº¦`dep[u]`ã€‚  
2. **æŒ‚æŸ¥è¯¢**ï¼šå°†æ¯ä¸ªæŸ¥è¯¢`(u, k)`å­˜å‚¨åˆ°`qry[u]`ä¸­ï¼ˆ`qry[u].emplace_back(k, i)`ï¼‰ã€‚  
3. **ç¦»çº¿å¤„ç†**ï¼š`dfs2`å‡½æ•°éå†æ ‘ï¼Œè¿›å…¥å­æ ‘å‰è®°å½•æ¡¶`t`çš„çŠ¶æ€ï¼ˆ`ans[id] = t[k]`ï¼‰ï¼Œç¦»å¼€å­æ ‘æ—¶æ›´æ–°æ¡¶çš„çŠ¶æ€ï¼ˆ`t[dep[u]]++`ï¼‰ï¼Œå¹¶è®¡ç®—å·®å€¼ï¼ˆ`ans[id] = t[k] - ans[id]`ï¼‰ï¼Œå¾—åˆ°å­æ ‘å†…çš„èŠ‚ç‚¹æ•°ã€‚  
ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šç¦»çº¿å¤„ç†çš„å…³é”®æ˜¯â€œè®°å½•çŠ¶æ€å·®â€ï¼Œé¿å…é‡å¤è®¡ç®—ï¼Œé€‚åˆå¤„ç†å¤§è§„æ¨¡æ•°æ®ã€‚  


## 5. ç®—æ³•å¯è§†åŒ–ï¼šåƒç´ åŠ¨ç”»æ¼”ç¤ºï¼ˆæ ¸å¿ƒéƒ¨åˆ†ï¼‰

### åŠ¨ç”»æ¼”ç¤ºä¸»é¢˜ï¼šã€Šåƒç´ æ ‘çš„â€œç­¾åˆ°â€æ¸¸æˆã€‹  
**é£æ ¼**ï¼š8ä½åƒç´ é£ï¼ˆç±»ä¼¼FCçº¢ç™½æœºï¼‰ï¼ŒèŠ‚ç‚¹ç”¨ä¸åŒé¢œè‰²çš„æ–¹å—è¡¨ç¤ºï¼ˆå¦‚çº¢è‰²è¡¨ç¤ºæ ¹èŠ‚ç‚¹ï¼Œè“è‰²è¡¨ç¤ºå­èŠ‚ç‚¹ï¼‰ï¼Œæ—¶é—´æˆ³ç”¨ç™½è‰²æ•°å­—æ˜¾ç¤ºã€‚  

### æ ¸å¿ƒæ¼”ç¤ºå†…å®¹ï¼š  
1. **DFSç”Ÿæˆæ—¶é—´æˆ³**ï¼š  
   - æ ¹èŠ‚ç‚¹ï¼ˆ1å·ï¼‰é¦–å…ˆâ€œç‚¹äº®â€ï¼Œæ˜¾ç¤º`Tin=1`ï¼ˆä¸Šæ–¹æ•°å­—ï¼‰ã€‚  
   - é€’å½’éå†å­èŠ‚ç‚¹ï¼ˆå¦‚2å·ã€3å·ï¼‰ï¼Œæ¯ä¸ªèŠ‚ç‚¹è¢«è®¿é—®æ—¶æ˜¾ç¤º`Tin`å€¼ï¼Œéå†å®Œå­èŠ‚ç‚¹åæ˜¾ç¤º`Tout`å€¼ï¼ˆå¦‚1å·çš„`Tout=6`ï¼‰ã€‚  
   - æ¯ä¸ªæ·±åº¦çš„åˆ—è¡¨ï¼ˆå¦‚æ·±åº¦0çš„åˆ—è¡¨åŒ…å«1å·çš„`Tin=1`ï¼Œæ·±åº¦1çš„åˆ—è¡¨åŒ…å«2å·ã€3å·çš„`Tin=2ã€3`ï¼‰ç”¨åƒç´ åŒ–çš„â€œé˜Ÿåˆ—â€å±•ç¤ºï¼ˆå¦‚å±å¹•å³ä¾§çš„ç«–åˆ—æ–¹å—ï¼‰ã€‚  

2. **æŸ¥è¯¢è¿‡ç¨‹**ï¼š  
   - è¾“å…¥æŸ¥è¯¢`(U=2, D=2)`ï¼ˆå³æ‰¾2å·å­æ ‘ä¸­æ·±åº¦ä¸º2çš„èŠ‚ç‚¹ï¼‰ã€‚  
   - é«˜äº®2å·èŠ‚ç‚¹çš„åŒºé—´`[Tin=2, Tout=5]`ï¼ˆèŠ‚ç‚¹å‘¨å›´çš„é»„è‰²è¾¹æ¡†ï¼‰ã€‚  
   - åœ¨æ·±åº¦2çš„åˆ—è¡¨ï¼ˆå¦‚åŒ…å«4å·ã€5å·çš„`Tin=4ã€5`ï¼‰ä¸­ï¼Œç”¨ç®­å¤´æŒ‡å‘`lower_bound(2)`çš„ä½ç½®ï¼ˆ`l=0`ï¼‰å’Œ`lower_bound(5)`çš„ä½ç½®ï¼ˆ`r=2`ï¼‰ï¼Œæ˜¾ç¤ºç­”æ¡ˆ`2`ã€‚  

3. **äº¤äº’è®¾è®¡**ï¼š  
   - **æ­¥è¿›æ§åˆ¶**ï¼šç‚¹å‡»â€œä¸‹ä¸€æ­¥â€æŒ‰é’®ï¼Œé€æ­¥æ˜¾ç¤ºDFSè¿‡ç¨‹æˆ–æŸ¥è¯¢æ­¥éª¤ã€‚  
   - **è‡ªåŠ¨æ’­æ”¾**ï¼šç‚¹å‡»â€œè‡ªåŠ¨â€æŒ‰é’®ï¼ŒåŠ¨ç”»æŒ‰æ¯ç§’2å¸§çš„é€Ÿåº¦æ’­æ”¾ï¼Œå¯é€šè¿‡æ»‘å—è°ƒæ•´é€Ÿåº¦ã€‚  
   - **é‡ç½®**ï¼šç‚¹å‡»â€œé‡ç½®â€æŒ‰é’®ï¼Œå›åˆ°åˆå§‹çŠ¶æ€ã€‚  
   - **éŸ³æ•ˆ**ï¼šDFSè®¿é—®èŠ‚ç‚¹æ—¶æ’­æ”¾â€œå®â€å£°ï¼ŒæŸ¥è¯¢å®Œæˆæ—¶æ’­æ”¾â€œæ»´â€å£°ï¼Œå¢å¼ºäº’åŠ¨æ„Ÿã€‚  

### è®¾è®¡ç†ç”±ï¼š  
- åƒç´ é£æ ¼ç¬¦åˆé’å°‘å¹´çš„å®¡ç¾ï¼Œå®¹æ˜“å¼•èµ·å…´è¶£ã€‚  
- åŠ¨æ€æ˜¾ç¤ºæ—¶é—´æˆ³å’Œåˆ—è¡¨ï¼Œå¸®åŠ©ç†è§£â€œå­æ ‘åŒºé—´â€å’Œâ€œäºŒåˆ†æŸ¥æ‰¾â€çš„è¿‡ç¨‹ã€‚  
- äº¤äº’è®¾è®¡è®©å­¦ä¹ è€…ä¸»åŠ¨å‚ä¸ï¼ŒåŠ æ·±è®°å¿†ã€‚  


## 6. æ‹“å±•ç»ƒä¹ ä¸ç›¸ä¼¼é—®é¢˜æ€è€ƒ

### é€šç”¨æ€è·¯/æŠ€å·§è¿ç§»ï¼š  
æ—¶é—´æˆ³ï¼ˆDFSåºï¼‰æ˜¯æ ‘ç®—æ³•ä¸­çš„å¸¸ç”¨æŠ€å·§ï¼Œå¯ç”¨äºè§£å†³ä»¥ä¸‹é—®é¢˜ï¼š  
1. **å­æ ‘æ±‚å’Œ**ï¼šç»Ÿè®¡å­æ ‘ä¸­èŠ‚ç‚¹çš„æƒå€¼å’Œï¼ˆå¦‚æ´›è°·P3806 æ ‘é“¾å‰–åˆ†ï¼‰ã€‚  
2. **å­æ ‘ä¿®æ”¹**ï¼šä¿®æ”¹å­æ ‘ä¸­èŠ‚ç‚¹çš„æƒå€¼ï¼ˆå¦‚æ´›è°·P2056 æ‰è¿·è—ï¼‰ã€‚  
3. **LCAï¼ˆæœ€è¿‘å…¬å…±ç¥–å…ˆï¼‰**ï¼šç”¨æ—¶é—´æˆ³å’Œå€å¢æ³•æ±‚LCAï¼ˆå¦‚æ´›è°·P3379 ã€æ¨¡æ¿ã€‘æœ€è¿‘å…¬å…±ç¥–å…ˆï¼‰ã€‚  

### ç»ƒä¹ æ¨èï¼ˆæ´›è°·ï¼‰ï¼š  
1. **æ´›è°· P3806 ã€æ¨¡æ¿ã€‘æ ‘é“¾å‰–åˆ†**  
   - ğŸ—£ï¸ **æ¨èç†ç”±**ï¼šç»ƒä¹ æ ‘çš„åŒºé—´è½¬åŒ–å’ŒæŸ¥è¯¢ï¼ŒæŒæ¡æ ‘é“¾å‰–åˆ†çš„åŸºæœ¬æ€æƒ³ï¼ˆå°†æ ‘è½¬åŒ–ä¸ºé“¾ï¼Œç”¨çº¿æ®µæ ‘å¤„ç†ï¼‰ã€‚  
2. **æ´›è°· P2056 [ZJOI2007] æ‰è¿·è—**  
   - ğŸ—£ï¸ **æ¨èç†ç”±**ï¼šæ¶‰åŠå­æ ‘ç»Ÿè®¡å’ŒåŠ¨æ€æŸ¥è¯¢ï¼Œéœ€è¦ç”¨é«˜çº§æ•°æ®ç»“æ„ï¼ˆå¦‚å¹³è¡¡æ ‘ï¼‰å¤„ç†ï¼Œæ˜¯æ ‘ç®—æ³•çš„è¿›é˜¶ç»ƒä¹ ã€‚  
3. **æ´›è°· P1352 æ²¡æœ‰ä¸Šå¸çš„èˆä¼š**  
   - ğŸ—£ï¸ **æ¨èç†ç”±**ï¼šåŠ¨æ€è§„åˆ’é—®é¢˜ï¼Œä½†æ¶‰åŠå­æ ‘å¤„ç†ï¼ˆé€‰æ‹©çˆ¶èŠ‚ç‚¹åˆ™ä¸èƒ½é€‰æ‹©å­èŠ‚ç‚¹ï¼‰ï¼Œå¸®åŠ©ç†è§£æ ‘çš„é€’å½’ç»“æ„ã€‚  


## 7. å­¦ä¹ å¿ƒå¾—ä¸ç»éªŒåˆ†äº«ï¼ˆè‹¥æœ‰ï¼‰  
- **Ray662çš„ç»éªŒ**ï¼šæ—¶é—´æˆ³æ˜¯æ ‘ç®—æ³•ä¸­çš„â€œä¸‡èƒ½å·¥å…·â€ï¼Œèƒ½å°†æ ‘çš„ç»“æ„è½¬åŒ–ä¸ºæ•°ç»„çš„åŒºé—´ï¼Œæ–¹ä¾¿ç”¨å¸¸è§„ç®—æ³•å¤„ç†ã€‚åˆå­¦è€…åº”é‡ç‚¹æŒæ¡`Tin`å’Œ`Tout`çš„ç”Ÿæˆæ–¹æ³•ã€‚  
- **AntonyDçš„ç»éªŒ**ï¼š`lower_bound`æ˜¯å¤„ç†æœ‰åºåˆ—è¡¨çš„é«˜æ•ˆå·¥å…·ï¼Œèƒ½å¿«é€Ÿæ‰¾åˆ°åŒºé—´çš„å·¦å³è¾¹ç•Œã€‚éœ€è¦æ³¨æ„`lower_bound`çš„è¿”å›å€¼æ˜¯è¿­ä»£å™¨ï¼Œå‡å»èµ·å§‹è¿­ä»£å™¨å¾—åˆ°ä¸‹æ ‡ã€‚  
- **_Kenma_çš„ç»éªŒ**ï¼šç¦»çº¿å¤„ç†æ˜¯ä¼˜åŒ–æ—¶é—´å¤æ‚åº¦çš„å¸¸ç”¨æŠ€å·§ï¼Œé€‚åˆå¤„ç†â€œå­æ ‘ç»Ÿè®¡â€ç±»é—®é¢˜ã€‚éœ€è¦å°†æŸ¥è¯¢ä¸å¤„ç†é¡ºåºç»“åˆï¼Œè®°å½•çŠ¶æ€å·®ã€‚  


## ç»“è¯­  
æœ¬æ¬¡å…³äºâ€œ[ABC202E] Count Descendantsâ€çš„C++è§£é¢˜åˆ†æå°±åˆ°è¿™é‡Œã€‚å¸Œæœ›è¿™ä»½å­¦ä¹ æŒ‡å—èƒ½å¸®åŠ©å¤§å®¶ç†è§£æ ‘çš„DFSåºã€äºŒåˆ†æŸ¥æ‰¾å’Œç¦»çº¿å¤„ç†ç­‰æŠ€å·§ã€‚è®°ä½ï¼Œç¼–ç¨‹èƒ½åŠ›çš„æå‡åœ¨äº**æŒç»­å­¦ä¹ ã€å‹¤äºæ€è€ƒå’Œå‹‡äºå®è·µ**ã€‚ä¸‹æ¬¡æˆ‘ä»¬å†ä¸€èµ·æ¢ç´¢æ–°çš„ç¼–ç¨‹æŒ‘æˆ˜ï¼ğŸ’ª

---
å¤„ç†ç”¨æ—¶ï¼š192.05ç§’
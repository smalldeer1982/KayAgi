# 题目信息

# [ARC016D] 軍艦ゲーム

## 题目描述

[problemUrl]: https://atcoder.jp/contests/arc016/tasks/arc016_4

高橋君は艦長である。  
 高橋艦長の任務は、鎮守府のある海域から最終目的地となる海域へ進軍することである。  
 高橋艦長は次の順序で行動する。

1. 航路選択

- 進軍する航路を選択する。現在の海域から異なる海域へ移動できる航路が $ 1 $ 本も存在しない場合、$ 4 $ の海域離脱を行う。
- また、現在の海域から異なる海域への航路が複数本存在する場合、何者かの陰謀によって等確率で航路が選択される。
- たとえば、鎮守府のある海域から、他の海域への航路が $ 4 $ 本存在する場合、それぞれ $ 25% $ の確率で選択されます。


4. 進軍
- 選択された航路によって、海域を移動する。

6. 戦闘
- 進軍先の海域 $ i $ には敵艦が待ち構えており、戦闘が発生する。
- 鎮守府から出港したとき、高橋艦長が率いる軍艦の体力は $ H $ であり、戦闘によって軍艦の体力は $ D_i $ だけ減少する。
- 軍艦の体力が $ 0 $ 以下になると、軍艦は沈没してしまう。
- 軍艦が沈没すると高橋艦長は失意のあまりこれ以上出撃することが出来なくなってしまうため、`絶対に沈没させてはいけない`。
- なお、鎮守府のある海域では戦闘は発生しないが、最終目的地である海域では必ず戦闘が発生する。

8. 海域離脱 or 航路選択に戻る
- 海域離脱とは、鎮守府のある海域へ戻ることを意味する。
- 海域離脱した際に、軍艦の残り体力が $ C $ であった場合、$ H-C $ だけ体力回復のために時間を消費する。
 
 上記`1`,`2`,`3`,`4`のサイクル1回につき時間を $ 1 $ だけ使う。  
- - - - - -

 海域と航路について - いま、$ N $ 個の海域と $ M $ 個の航路がある。
- これら $ M $ 個の航路は、すべて一方通行である。
 
 そのため、任意の異なる海域 $ A,B $ において、ある $ 1 $ 本の航路を利用して、海域 $ A $ から海域 $ B $ へ移動し、海域 $ B $ から海域 $ A $ へ移動することはできない。  
- - - - - -

 あなたは高橋艦長の参謀であり、高橋艦長が消費する時間を最小となるよう行動した場合、最終目的地における戦闘で生存するまでに経過する時間の期待値を求めることが仕事である。  
 どのようにしても高橋艦長が任務を完遂できない場合は`-1`と出力せよ。  
 ただし、出力する期待値が $ 10^6 $ より大きくなる入力は与えられない。 入力は以下の形式で標準入力から与えられる。 > $ N $ $ M $ $ H $ $ f_1 $ $ t_1 $ $ f_2 $ $ t_2 $ : $ f_M $ $ t_M $ $ D_1 $ $ D_2 $ : $ D_N $

1. $ 1 $ 行目は、海域数を表す整数 $ N\ (2≦N≦100) $、航路数を表す整数 $ M\ (0≦M≦N\ *\ (N\ -\ 1)\ /\ 2) $、出港時の艦隊の体力を表す整数 $ H\ (1≦H≦100) $ が半角空白区切りで与えられる。

- 鎮守府のある海域は $ 1 $ で、最終目的地である海域は $ N $ です。

32. $ 2 $ 行目から $ M $ 行は、 $ i $ 番目の航路を表す。移動元の海域を表す整数 $ f_i\ (1≦f_i≦N) $、移動先の海域を表す整数 $ t_i\ (1≦t_i≦N) $ が、スペース区切りで与えられる。
- $ f_i\ <\ t_i $ であることが保証されている。

34. $ 2+M $ 行目から $ N $ 行は、$ i $ 番目の海域での戦闘で受けるダメージを表す整数 $ D_i\ (0≦D_i≦100) $ が、一行で与えられる。
- $ D_1 $ の値は常に $ 0 $ である（鎮守府のある海域です）。

- 出力する期待値が $ 10^6 $ より大きくなる入力が与えられないことに留意せよ。
 
 高橋艦長が消費する時間が最小となるよう行動した場合、最終目的地における戦闘で生存するまでに経過する時間の期待値を出力せよ。  
 出力は絶対誤差あるいは相対誤差の少なくとも片方が $ 10^{-6} $ 以下であれば許容される。   
 また、どのようにしても高橋艦長が任務を完遂できない場合は`-1`と出力せよ。  
 なお、出力の最後には改行をいれること。  

- 鎮守府のある $ 1 $ から、最終目的地である $ 6 $ までは、$ 2 $ 通りの経路があります。

1. 1 -&gt; 2 -&gt; 4 -&gt; 6

- このルートが選択される確率は $ 50% $ です。
- このルートで軍艦が受けるダメージは $ 0+1+2+4=7 $ です。
- このルートで消費する時間は、サイクル $ 3 $ 回の時間のみなので、$ 3 $ です。

48. 1 -&gt; 3 -&gt; 5 -&gt; 6
- このルートが選択される確率は $ 50% $ です。
- このルートで軍艦が受けるダメージは $ 0+1+3+4=8 $ です。
- 出港時の軍艦の体力は $ 8 $ なので、このルートでは沈没してしまいます。
- 高橋艦長は、沈没を避けるため、海域 $ 3 $ の戦闘終了時に海域離脱を選択します。
- このルートで消費する時間は、サイクル $ 1 $ 回の時間 $ + $ 体力の回復にかかる時間 $ = $ $ 1+1=2 $ です。
 
 1 -&gt; 3 -&gt; 5 -&gt; 6 で `1` 度撤退してから 1-&gt; 2-&gt; 4 -&gt; 6 - $ 50% $ の確率で 1 -&gt; 3 -&gt; 5 -&gt; 6 が選択され、時間 $ 2 $ を使って鎮守府に戻る。
- その後、 $ 50% $ の確率で 1 -&gt; 2 -&gt; 4 -&gt; 6 が選択され、時間 $ 3 $ を使って最終目的地に到達する。
- つまり、$ 25% $ の確率で時間 $ 5 $ を使って最終目的地に到達。
 
 1 -&gt; 3 -&gt; 5 -&gt; 6 で `2` 度撤退してから 1-&gt; 2-&gt; 4 -&gt; 6 - $ 12.5% $ の確率で時間 $ 7 $ を使って最終目的地に到達。
 
 1 -&gt; 3 -&gt; 5 -&gt; 6 で `3` 度撤退してから 1-&gt; 2-&gt; 4 -&gt; 6 - $ 6.25% $ の確率で時間 $ 9 $ を使って最終目的地に到達。

62. 上記から、求める期待値は $ 3*0.5+5*0.25+7*0.125+...=5 $ となります。


## 样例 #1

### 输入

```
6 6 8
1 2
1 3
2 4
3 5
4 6
5 6
0
1
1
2
3
4```

### 输出

```
5.0```

## 样例 #2

### 输入

```
3 2 5
1 2
1 3
0
5
1```

### 输出

```
-1```

## 样例 #3

### 输入

```
3 2 6
1 2
1 3
0
5
1```

### 输出

```
7```

## 样例 #4

### 输入

```
9 13 4
1 2
1 3
2 4
2 5
2 7
3 5
3 6
4 7
5 8
6 8
7 8
7 9
8 9
0
1
1
1
1
1
1
1
1```

### 输出

```
36.9999999999999```

# AI分析结果


### 💡 Kay的C++算法解析：ARC016D 軍艦ゲーム 深入学习指南 💡

#### 1. 题目解读与核心算法识别
✨ **本题主要考察**：期望动态规划 + 二分答案

🗣️ **初步分析**：
> 这道题可以比作一位舰长在**像素海洋**中探险，每个岛屿（节点）有不同伤害值的敌人。核心是计算从起点（镇守府）到终点（目标海域）的**最小期望时间**，同时避免血量归零。解题关键在于：
> - **期望DP建模**：状态 `dp[u][i]` 表示在节点 `u` 血量 `i` 时的最小期望时间
> - **二分答案破环**：因状态转移存在自环（`dp[1][H]` 出现在方程中），通过二分预设 `dp[1][H]` 值解除后效性
> 
> **可视化设计思路**：
> - 像素化DAG地图，节点用不同颜色方块表示（起点绿/终点红/普通黄）
> - 舰船移动时显示实时血条，战斗时触发像素爆炸特效
> - 关键高亮：决策点显示期望时间计算过程，回城时播放"传送音效"
> - 游戏化设计：通关时放烟花庆祝，沉船时屏幕抖动+低沉音效

---

#### 2. 精选优质题解参考
**题解一（iMya_nlgau）**
* **点评**：  
  思路清晰指出二分单调性（`g'(A)≤1`），并用记忆化搜索实现。代码亮点在于：
  - 精准处理点1的特殊情况（第51行）：避免自环干扰
  - 变量命名规范（`f[x][j]`状态明确）
  - 复杂度优化：`O(nH·log 1e6)` 高效通过
  > 💡 学习点：用数学归纳法证明二分单调性

**题解三（123456xwd）**
* **点评**：  
  代码简洁但完整覆盖核心逻辑，亮点包括：
  - 边界处理严谨（第30行检查无解）
  - 向量存图提升可读性（第15行`vector<int> G[N]`)
  - 误差控制精确（`1e-9`精度）
  > 💡 学习点：用`min()`自然处理回城/前进的决策比较

---

#### 3. 核心难点辨析与解题策略
1. **状态设计维度选择**  
   *分析*：需同时跟踪位置和血量（二维状态）。优质解用`dp[u][i]`，`u`为节点，`i`为血量  
   💡 **学习笔记**：双维度状态是期望DP常见建模方式

2. **后效性破除技巧**  
   *分析*：因`dp[1][H]`出现在转移方程中形成环。题解用二分预设该值，将问题转化为无环DP  
   💡 **学习笔记**：当后效性只与单变量相关时，优先考虑二分答案

3. **决策点条件分支**  
   *分析*：关键比较 `继续前进期望时间` vs `回城时间`。代码中通过`min(期望, H-i+mid)`实现  
   💡 **学习笔记**：`min()`函数天然表达最优决策逻辑

✨ **解题技巧总结**  
- **状态压缩**：二维数组存储位置+血量  
- **记忆化搜索**：避免手动拓扑排序，自然处理DAG  
- **精度控制**：二分时采用相对误差`1e-9`  
- **边界特判**：终点直接返回0，血量为负返回无穷大

---

#### 4. C++核心代码实现赏析
**通用核心实现参考**
```cpp
#include<bits/stdc++.h>
#define DB double
using namespace std;
const int N=105;
const DB EPS=1e-9, INF=1e12;

DB dp[N][N], A;
vector<int> G[N];
int n,m,H,D[N];
bool vis[N];

void dfs(int u,int hp){
    if(vis[u]) return;
    vis[u]=1;
    DB sum=0; int cnt=0;
    
    for(int v:G[u]){
        if(hp<=D[v]) continue;
        dfs(v,hp-D[v]);
        sum += dp[v][hp-D[v]] + 1;
        cnt++;
    }
    
    if(u==1 && hp==H) dp[u][hp] = cnt ? sum/cnt : INF;
    else dp[u][hp] = cnt ? min(A+H-hp, sum/cnt) : A+H-hp;
}

bool check(DB mid){
    A=mid;
    memset(vis,0,sizeof(vis));
    for(int i=1;i<=n;i++) 
        for(int j=1;j<=H;j++) 
            dp[i][j]=0;
    dfs(1,H);
    return dp[1][H] <= mid;
}
// 二分主循环同题解三
```

**题解一片段赏析**  
```cpp
// 特殊处理起点状态（避免自环）
if(x==1&&j==H) f[x][j]=1+f[x][j]/deg; 
else f[x][j]=min(A+H-j,1+f[x][j]/deg);
```
> **解读**：  
> - 第1行：起点满血时强制继续前进（因回城即回到自身）
> - 第2行：`A+H-j`是回城时间，`1+f[x][j]/deg`是前进期望
> - 用`min()`自动选择最优策略

**题解三片段赏析**  
```cpp
ans = min(ans, (H-i)*1.0+mid); // 决策比较
```
> **解读**：  
> - `(H-i)+mid`：回城所需时间（移动1 + 恢复H-i）
> - 与前进期望取最小值，体现最优策略
> 💡 **学习笔记**：简洁的`min()`包含策略决策本质

---

#### 5. 算法可视化：像素动画演示
**主题**：8位像素海战（FC红白机风格）  
**核心演示**：舰船在DAG移动的血量管理决策过程

```mermaid
graph LR
    A[初始化像素地图] --> B[舰船移动动画]
    B --> C{当前节点决策}
    C -->|血量充足| D[显示期望时间计算]
    C -->|血量不足| E[播放回城音效]
    D --> F[战斗像素爆炸]
    E --> G[回城血量恢复动画]
```

**交互控制面板**：
- **动态血条**：绿色像素条实时显示血量，扣血时闪红
- **决策高亮**：
  - 可行出边：蓝色箭头闪烁
  - 危险出边：红色静止箭头（配警告音）
- **音效系统**：
  - 移动：水流声（8-bit波形）
  - 战斗：短促爆炸声
  - 回城："叮"的传送音
  - 通关：马里奥式过关音乐

**AI演示模式**：
1. 自动选择期望时间最小的动作
2. 关键步骤暂停显示决策公式
3. 路径历史用彩色轨迹记录

---

#### 6. 拓展练习与相似问题思考
**技巧迁移场景**：
1. 带资源约束的期望计算（如时间/血量双重限制）
2. DAG上的多决策路径规划
3. 有自环的动态规划问题

**洛谷推荐**：
1. **P4316 绿豆蛙的归宿**  
   → 基础DAG期望DP，无资源约束
2. **P1850 换教室**  
   → 带概率决策的期望问题
3. **P4550 收集邮票**  
   → 经典期望DP+后效性处理

---

#### 7. 学习心得与经验分享
> **参考经验**：  
> "调试时发现点1的血量状态处理不当会导致无限递归，必须单独处理"  
> **点评**：  
> 这印证了状态转移中**特殊边界分离处理**的重要性，特别是存在自环的场景。建议：
> 1. 用纸笔模拟小样例
> 2. 输出中间状态验证
> 3. 对特殊节点（起点/终点）单独编码

---

通过本指南，希望大家掌握期望DP中**二分破环**的核心技巧，并在像素化演示中直观理解状态转移过程。记住：好算法需要像战舰航行一样，既要有明确方向（状态设计），也要能灵活应对风浪（后效性处理）！🚢💨

---
处理用时：152.67秒
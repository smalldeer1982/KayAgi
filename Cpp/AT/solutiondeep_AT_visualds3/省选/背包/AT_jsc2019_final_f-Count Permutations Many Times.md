# é¢˜ç›®ä¿¡æ¯

# Count Permutations Many Times

## é¢˜ç›®æè¿°

[problemUrl]: https://atcoder.jp/contests/jsc2019-final/tasks/jsc2019_final_f

é•·ã• $ N $ ã®æ•°åˆ— $ A_0,A_1,\cdots,A_{N-1} $ ãŒã‚ã‚Šã¾ã™ã€‚ æ¬¡ã® $ Q $ å€‹ã®è³ªå•ã«ç­”ãˆã¦ãã ã•ã„ã€‚

- è³ªå• $ i $ ($ 0\ \leq\ i\ \leq\ Q-1 $): æ•´æ•° $ L_i,R_i $ ($ 0\ \leq\ L_i\ <\ R_i\ \leq\ N $) ãŒä¸ãˆã‚‰ã‚Œã‚‹ã€‚ $ (0,1,\cdots,N-1) $ ã®é †åˆ— $ p_0,p_1,\cdots,p_{N-1} $ ã§ã‚ã£ã¦ã€æ¬¡ã®æ¡ä»¶ã‚’ã¿ãŸã™ã‚‚ã®ã®å€‹æ•°ã‚’æ±‚ã‚ã‚ˆã€‚
  - å…¨ã¦ã® $ j $ ($ L_i\ \leq\ j\ <\ R_i $) ã«ã¤ã„ã¦ã€$ p_j\ \neq\ A_j $ ã§ã‚ã‚‹ã€‚

ãŸã ã—ã€ç­”ãˆã¯éå¸¸ã«å¤§ãããªã‚‹ã“ã¨ãŒã‚ã‚‹ã®ã§ã€$ 998244353 $ ã§å‰²ã£ãŸã‚ã¾ã‚Šã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚

## è¯´æ˜/æç¤º

### åˆ¶ç´„

- $ 1\ \leq\ N\ \leq\ 2000 $
- $ 0\ \leq\ A_i\ \leq\ N-1 $
- $ 1\ \leq\ Q\ \leq\ 2000 $
- $ 0\ \leq\ L_i\ <\ R_i\ \leq\ N $
- å…¥åŠ›ã•ã‚Œã‚‹å€¤ã¯ã™ã¹ã¦æ•´æ•°ã§ã‚ã‚‹ã€‚

### Sample Explanation 1

ä¾‹ãˆã°è³ªå• $ 0 $ ã«ã¤ã„ã¦è€ƒãˆã‚‹ã¨ã€æ¡ä»¶ã‚’ã¿ãŸã™é †åˆ—ã¯ $ (1,0,2),(1,2,0),(2,0,1),(2,1,0) $ ã® $ 4 $ é€šã‚Šã§ã™ã€‚

## æ ·ä¾‹ #1

### è¾“å…¥

```
3 6

0 0 0

0 1

0 2

0 3

1 2

1 3

2 3```

### è¾“å‡º

```
4

2

0

4

2

4```

## æ ·ä¾‹ #2

### è¾“å…¥

```
3 6

0 1 2

0 1

0 2

0 3

1 2

1 3

2 3```

### è¾“å‡º

```
4

3

2

4

3

4```

## æ ·ä¾‹ #3

### è¾“å…¥

```
10 10

7 9 4 8 0 6 7 8 9 8

0 5

4 7

3 10

7 10

7 9

4 9

0 3

6 9

4 9

1 3```

### è¾“å‡º

```
2170680

2656080

1712520

2620800

2943360

2170680

2656080

2656080

2170680

2943360```

# AIåˆ†æç»“æœ

# ğŸ’¡ Kayçš„C++ç®—æ³•è§£æï¼šCount Permutations Many Times æ·±å…¥å­¦ä¹ æŒ‡å— ğŸ’¡


## 1. é¢˜ç›®è§£è¯»ä¸æ ¸å¿ƒç®—æ³•è¯†åˆ«

âœ¨ **æœ¬é¢˜ä¸»è¦è€ƒå¯Ÿ**ï¼šå®¹æ–¥åŸç† + åŠ¨æ€è§„åˆ’ï¼ˆDPï¼‰ + è«é˜Ÿç®—æ³•ï¼ˆåŒºé—´æŸ¥è¯¢ä¼˜åŒ–ï¼‰


ğŸ—£ï¸ **åˆæ­¥åˆ†æ**ï¼š  
è§£å†³â€œCount Permutations Many Timesâ€çš„å…³é”®ï¼Œæ˜¯**ç”¨å®¹æ–¥åŸç†è®¡ç®—â€œä¸æ»¡è¶³æŸäº›ä½ç½®é™åˆ¶â€çš„æ’åˆ—æ•°**ã€‚ç®€å•æ¥è¯´ï¼Œå®¹æ–¥å°±åƒâ€œå…ˆç®—æ‰€æœ‰å¯èƒ½ï¼Œå†å‡å»ä¸ç¬¦åˆçš„ï¼Œå†åŠ å›å¤šå‡çš„â€â€”â€”æ¯”å¦‚ï¼Œè¦è®¡ç®—â€œåŒºé—´[L,R)å†…æ‰€æœ‰ä½ç½®éƒ½ä¸é€‰A_jâ€çš„æ’åˆ—æ•°ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆç®—â€œæ‰€æœ‰æ’åˆ—â€ï¼Œå‡å»â€œè‡³å°‘æœ‰ä¸€ä¸ªä½ç½®é€‰A_jâ€çš„æ’åˆ—ï¼ŒåŠ ä¸Šâ€œè‡³å°‘æœ‰ä¸¤ä¸ªä½ç½®é€‰A_jâ€çš„æ’åˆ—ï¼Œä¾æ­¤ç±»æ¨ã€‚  

**æ ¸å¿ƒæ€è·¯**ï¼š  
å¯¹äºæ¯ä¸ªè¯¢é—®åŒºé—´[L,R)ï¼Œè®¾`cnt[x]`ä¸ºAåœ¨è¯¥åŒºé—´ä¸­xå‡ºç°çš„æ¬¡æ•°ã€‚æˆ‘ä»¬éœ€è¦è®¡ç®—ï¼š  
$$\text{ç­”æ¡ˆ} = \sum_{k=0}^{R-L} (-1)^k \cdot g(k) \cdot (N-k)!$$  
å…¶ä¸­ï¼Œ`g(k)`è¡¨ç¤ºâ€œä»åŒºé—´ä¸­é€‰kä¸ª**ä¸åŒ**çš„æ•°ï¼ˆæ¯ä¸ªæ•°é€‰ä¸€ä¸ªä½ç½®ï¼‰â€çš„æ–¹æ¡ˆæ•°ï¼ˆå› ä¸ºæ’åˆ—ä¸­æ•°ä¸èƒ½é‡å¤ï¼‰ã€‚`g(k)`çš„è®¡ç®—æ˜¯å…³é”®â€”â€”å®ƒå¯ä»¥é€šè¿‡**åŠ¨æ€è§„åˆ’**æˆ–**ç”Ÿæˆå‡½æ•°**ç»´æŠ¤ï¼Œè€Œ**è«é˜Ÿç®—æ³•**åˆ™ç”¨äºé«˜æ•ˆå¤„ç†å¤šä¸ªåŒºé—´æŸ¥è¯¢ï¼ˆé¿å…é‡å¤è®¡ç®—æ¯ä¸ªåŒºé—´çš„`g(k)`ï¼‰ã€‚  

**å¯è§†åŒ–è®¾è®¡æ€è·¯**ï¼š  
æˆ‘ä»¬å¯ä»¥ç”¨**8ä½åƒç´ é£æ ¼**å±•ç¤ºè«é˜Ÿå¤„ç†åŒºé—´çš„è¿‡ç¨‹ï¼š  
- ç”¨åƒç´ å—è¡¨ç¤ºæ•°ç»„å…ƒç´ ï¼Œé¢œè‰²åŒºåˆ†â€œå·²åŠ å…¥åŒºé—´â€å’Œâ€œæœªåŠ å…¥åŒºé—´â€ï¼›  
- ç”¨æŸ±çŠ¶å›¾å±•ç¤ºç”Ÿæˆå‡½æ•°`f(x) = âˆ(1 + cnt[x]Â·x)`çš„ç³»æ•°ï¼ˆå¯¹åº”`g(k)`ï¼‰ï¼Œç³»æ•°å˜åŒ–æ—¶æŸ±çŠ¶å›¾é«˜åº¦åŠ¨æ€è°ƒæ•´ï¼›  
- ç”¨â€œå•æ­¥æ‰§è¡Œâ€å±•ç¤ºè«é˜ŸæŒ‡é’ˆç§»åŠ¨ï¼ˆåŠ å…¥/åˆ é™¤å…ƒç´ ï¼‰ï¼Œå¹¶é«˜äº®ç”Ÿæˆå‡½æ•°çš„æ›´æ–°è¿‡ç¨‹ï¼ˆæ¯”å¦‚ï¼ŒåŠ å…¥ä¸€ä¸ªå…ƒç´ xæ—¶ï¼Œ`cnt[x]`å¢åŠ ï¼Œç”Ÿæˆå‡½æ•°ä¹˜ä»¥`(1 + cnt[x]Â·x)/(1 + (cnt[x]-1)Â·x)`ï¼Œå¯¹åº”æŸ±çŠ¶å›¾çš„å˜åŒ–ï¼‰ï¼›  
- å…³é”®æ“ä½œï¼ˆå¦‚åŠ å…¥å…ƒç´ ã€æ›´æ–°ç”Ÿæˆå‡½æ•°ã€è®¡ç®—å®¹æ–¥ç­”æ¡ˆï¼‰ä¼´éšâ€œå®â€â€œæ»´â€ç­‰åƒç´ éŸ³æ•ˆï¼Œå¢å¼ºè®°å¿†ç‚¹ã€‚  


## 2. ç²¾é€‰ä¼˜è´¨é¢˜è§£å‚è€ƒ

### é¢˜è§£ä¸€ï¼šCYZZï¼ˆè«é˜Ÿ+å¯æ’¤é”€DPï¼Œèµ10ï¼‰  
* **ç‚¹è¯„**ï¼š  
  è¿™ä»½é¢˜è§£çš„æ€è·¯éå¸¸æ¸…æ™°ï¼Œä»subtaskï¼ˆå°æ•°æ®èŒƒå›´ï¼‰é€æ­¥æ¨å¯¼åˆ°æ­£è§£ï¼Œé€‚åˆæ–°æ‰‹ç†è§£ã€‚æ­£è§£é‡‡ç”¨**è«é˜Ÿç®—æ³•+å¯æ’¤é”€DP**ï¼Œé€šè¿‡åˆ†å—å¤„ç†åŒºé—´æŸ¥è¯¢ï¼Œæ¯æ¬¡ç§»åŠ¨æŒ‡é’ˆæ—¶**åŠ¨æ€ç»´æŠ¤ç”Ÿæˆå‡½æ•°çš„ç³»æ•°**ï¼ˆå³`g(k)`ï¼‰ã€‚ä»£ç ä¸­â€œå¯æ’¤é”€DPâ€çš„è®¾è®¡ï¼ˆå…ˆæ’¤é”€æ—§è´¡çŒ®ï¼Œå†æ·»åŠ æ–°è´¡çŒ®ï¼‰éå¸¸å·§å¦™ï¼Œå°†å•æ¬¡åŒºé—´æ›´æ–°çš„å¤æ‚åº¦ä»O(nÂ²)é™åˆ°O(n)ï¼Œæ€»å¤æ‚åº¦O(nÂ²âˆšn)ï¼Œåˆšå¥½é€šè¿‡é¢˜ç›®é™åˆ¶ã€‚æ­¤å¤–ï¼Œä½œè€…æåˆ°â€œæ¨¡æ‹Ÿèµ›æ–‡ä»¶åå†™é”™å¯¼è‡´0åˆ†â€çš„æ•™è®­ï¼Œæé†’æˆ‘ä»¬æ³¨æ„ç»†èŠ‚ã€‚  

### é¢˜è§£äºŒï¼šShiina_Mahiruï¼ˆè«é˜Ÿ+ç”Ÿæˆå‡½æ•°ï¼Œèµ4ï¼‰  
* **ç‚¹è¯„**ï¼š  
  æ­¤é¢˜è§£ç”¨**ç”Ÿæˆå‡½æ•°**è¡¨ç¤º`g(k)`ï¼ˆ`f(x) = âˆ(1 + cnt[x]Â·x)`çš„kæ¬¡é¡¹ç³»æ•°å³ä¸º`g(k)`ï¼‰ï¼Œå¹¶é€šè¿‡è«é˜Ÿç»´æŠ¤ç”Ÿæˆå‡½æ•°çš„ç³»æ•°ã€‚ä»£ç ä¸­`modint`ç±»çš„ä½¿ç”¨ç®€åŒ–äº†å–æ¨¡æ“ä½œï¼Œè«é˜Ÿçš„â€œå¥‡å¶æ’åºâ€ä¼˜åŒ–ï¼ˆå‡å°‘æŒ‡é’ˆç§»åŠ¨æ¬¡æ•°ï¼‰ä¹Ÿå¾ˆå®ç”¨ã€‚ç”Ÿæˆå‡½æ•°çš„ç»´æŠ¤é€»è¾‘ï¼ˆåŠ å…¥/åˆ é™¤å…ƒç´ æ—¶æ›´æ–°ç³»æ•°ï¼‰æ¸…æ™°æ˜“æ‡‚ï¼Œé€‚åˆå­¦ä¹ â€œç”Ÿæˆå‡½æ•°+è«é˜Ÿâ€çš„ç»„åˆæŠ€å·§ã€‚  

### é¢˜è§£ä¸‰ï¼šHkueenï¼ˆé¢„å¤„ç†DPï¼Œèµ3ï¼‰  
* **ç‚¹è¯„**ï¼š  
  æ­¤é¢˜è§£é’ˆå¯¹â€œé‡å¤å…ƒç´ â€çš„æƒ…å†µï¼Œå°†é—®é¢˜è½¬åŒ–ä¸º**å¸¦æƒç»„åˆæ•°çš„DP**ï¼ˆ`size[i]`è¡¨ç¤ºå…ƒç´ iåœ¨åŒºé—´ä¸­çš„å‡ºç°æ¬¡æ•°ï¼Œ`f[i][j]`è¡¨ç¤ºå‰iä¸ªå…ƒç´ é€‰jä¸ªçš„æ–¹æ¡ˆæ•°ï¼Œè½¬ç§»ä¸º`f[i][j] = f[i-1][j] + f[i-1][j-1]Â·size[i]`ï¼‰ã€‚è™½ç„¶å¤æ‚åº¦æ˜¯O(nÂ²q)ï¼Œä½†é€šè¿‡â€œé¢„å¤„ç†size=1çš„å…ƒç´ â€ï¼ˆå› ä¸ºå®ƒä»¬çš„è´¡çŒ®æ˜¯ç»„åˆæ•°ï¼‰ï¼Œå‡å°‘äº†å®é™…è®¡ç®—é‡ï¼Œé€‚åˆç†è§£â€œåŠ¨æ€è§„åˆ’å¦‚ä½•å¤„ç†é‡å¤å…ƒç´ â€ã€‚  


## 3. æ ¸å¿ƒéš¾ç‚¹è¾¨æä¸è§£é¢˜ç­–ç•¥

### 1. å®¹æ–¥ç³»æ•°çš„è®¡ç®—  
**éš¾ç‚¹**ï¼šå¦‚ä½•æ­£ç¡®è®¡ç®—â€œè‡³å°‘é€‰kä¸ªä¸ç¬¦åˆæ¡ä»¶çš„ä½ç½®â€çš„æ–¹æ¡ˆæ•°ï¼Ÿ  
**ç­–ç•¥**ï¼šç”¨å®¹æ–¥åŸç†ï¼Œ`(-1)^k`è¡¨ç¤ºå®¹æ–¥ç³»æ•°ï¼ˆé€‰kä¸ªçš„è´¡çŒ®ä¸ºæ­£æˆ–è´Ÿï¼‰ï¼Œ`(N-k)!`è¡¨ç¤ºé€‰kä¸ªåå‰©ä¸‹çš„ä½ç½®ä»»æ„æ’åˆ—çš„æ–¹æ¡ˆæ•°ã€‚å…³é”®æ˜¯`g(k)`çš„è®¡ç®—â€”â€”å®ƒå¿…é¡»ä¿è¯é€‰çš„kä¸ªæ•°**äº’ä¸ç›¸åŒ**ï¼ˆå› ä¸ºæ’åˆ—ä¸­æ•°ä¸èƒ½é‡å¤ï¼‰ã€‚  

### 2. åŠ¨æ€è§„åˆ’çš„çŠ¶æ€è½¬ç§»  
**éš¾ç‚¹**ï¼šå¦‚ä½•é«˜æ•ˆè®¡ç®—`g(k)`ï¼ˆé€‰kä¸ªä¸åŒæ•°çš„æ–¹æ¡ˆæ•°ï¼‰ï¼Ÿ  
**ç­–ç•¥**ï¼šç”¨åŠ¨æ€è§„åˆ’`f[i][j]`è¡¨ç¤ºå‰iä¸ªå…ƒç´ é€‰jä¸ªçš„æ–¹æ¡ˆæ•°ï¼Œè½¬ç§»ä¸º`f[i][j] = f[i-1][j] + f[i-1][j-1]Â·size[i]`ï¼ˆ`size[i]`æ˜¯å…ƒç´ içš„å‡ºç°æ¬¡æ•°ï¼‰ã€‚æ­¤è½¬ç§»çš„æœ¬è´¨æ˜¯â€œé€‰æˆ–ä¸é€‰å½“å‰å…ƒç´ â€ï¼Œé€‰çš„è¯è´¡çŒ®`size[i]`ç§é€‰æ‹©ï¼ˆå› ä¸ºå…ƒç´ iæœ‰`size[i]`ä¸ªä½ç½®ï¼‰ã€‚  

### 3. è«é˜Ÿç®—æ³•çš„è½¬ç§»ä¼˜åŒ–  
**éš¾ç‚¹**ï¼šå¦‚ä½•é«˜æ•ˆç»´æŠ¤å¤šä¸ªåŒºé—´çš„`g(k)`ï¼Ÿ  
**ç­–ç•¥**ï¼šç”¨è«é˜Ÿç®—æ³•åˆ†å—å¤„ç†åŒºé—´æŸ¥è¯¢ï¼Œæ¯æ¬¡ç§»åŠ¨æŒ‡é’ˆæ—¶**åŠ¨æ€æ›´æ–°ç”Ÿæˆå‡½æ•°çš„ç³»æ•°**ï¼ˆæˆ–DPæ•°ç»„ï¼‰ã€‚ä¾‹å¦‚ï¼ŒåŠ å…¥ä¸€ä¸ªå…ƒç´ xæ—¶ï¼Œå…ˆæ’¤é”€`cnt[x]`çš„æ—§è´¡çŒ®ï¼ˆ`f[k] -= f[k-1]Â·cnt[x]`ï¼‰ï¼Œå†å¢åŠ `cnt[x]+1`çš„æ–°è´¡çŒ®ï¼ˆ`f[k] += f[k-1]Â·(cnt[x]+1)`ï¼‰ã€‚è¿™ç§â€œå¯æ’¤é”€â€çš„æ“ä½œå°†å•æ¬¡æ›´æ–°å¤æ‚åº¦é™åˆ°O(n)ã€‚  


## 4. C++æ ¸å¿ƒä»£ç å®ç°èµæ

### æœ¬é¢˜é€šç”¨æ ¸å¿ƒC++å®ç°å‚è€ƒï¼ˆè«é˜Ÿ+ç”Ÿæˆå‡½æ•°ï¼‰  
* **è¯´æ˜**ï¼šç»¼åˆShiina_Mahiruå’ŒZhao_daodaoçš„é¢˜è§£ï¼Œæä¾›ä¸€ä¸ªç®€æ´çš„è«é˜Ÿ+ç”Ÿæˆå‡½æ•°å®ç°ã€‚  
* **å®Œæ•´æ ¸å¿ƒä»£ç **ï¼š  
  ```cpp
  #include <iostream>
  #include <vector>
  #include <algorithm>
  #include <cmath>
  using namespace std;
  
  const int MOD = 998244353;
  const int MAXN = 2010;
  
  struct ModInt {
      int x;
      ModInt(int o = 0) : x(o) {}
      ModInt& operator+=(const ModInt& o) { x = (x + o.x) % MOD; return *this; }
      ModInt& operator-=(const ModInt& o) { x = (x - o.x + MOD) % MOD; return *this; }
      ModInt& operator*=(const ModInt& o) { x = (1LL * x * o.x) % MOD; return *this; }
      friend ModInt operator+(ModInt a, const ModInt& b) { return a += b; }
      friend ModInt operator-(ModInt a, const ModInt& b) { return a -= b; }
      friend ModInt operator*(ModInt a, const ModInt& b) { return a *= b; }
  };
  
  int n, q, len;
  int a[MAXN], cnt[MAXN];
  ModInt fac[MAXN], g[MAXN];
  vector<ModInt> f;
  
  struct Query {
      int l, r, id;
      bool operator<(const Query& o) const {
          int bl = l / len, br = o.l / len;
          return bl != br ? bl < br : (bl % 2 ? r < o.r : r > o.r);
      }
  } Q[MAXN];
  
  ModInt ans[MAXN];
  
  void add(int x) {
      // æ’¤é”€æ—§è´¡çŒ®ï¼šf[k] -= f[k-1] * cnt[x]
      for (int i = 1; i < (int)f.size(); i++) {
          f[i] -= f[i-1] * cnt[x];
      }
      f.pop_back();
      // æ›´æ–°cnt[x]
      cnt[x]++;
      // æ·»åŠ æ–°è´¡çŒ®ï¼šf[k] += f[k-1] * cnt[x]
      f.push_back(0);
      for (int i = (int)f.size()-1; i >= 1; i--) {
          f[i] += f[i-1] * cnt[x];
      }
  }
  
  void del(int x) {
      // æ’¤é”€æ—§è´¡çŒ®ï¼šf[k] -= f[k-1] * cnt[x]
      for (int i = 1; i < (int)f.size(); i++) {
          f[i] -= f[i-1] * cnt[x];
      }
      f.pop_back();
      // æ›´æ–°cnt[x]
      cnt[x]--;
      // æ·»åŠ æ–°è´¡çŒ®ï¼šf[k] += f[k-1] * cnt[x]ï¼ˆå¦‚æœcnt[x]>0ï¼‰
      if (cnt[x] > 0) {
          f.push_back(0);
          for (int i = (int)f.size()-1; i >= 1; i--) {
              f[i] += f[i-1] * cnt[x];
          }
      }
  }
  
  int main() {
      ios::sync_with_stdio(false);
      cin.tie(0);
      // é¢„å¤„ç†é˜¶ä¹˜
      fac[0] = 1;
      for (int i = 1; i < MAXN; i++) {
          fac[i] = fac[i-1] * i;
      }
      // è¾“å…¥
      cin >> n >> q;
      len = sqrt(n) + 1;
      for (int i = 1; i <= n; i++) {
          cin >> a[i];
      }
      for (int i = 1; i <= q; i++) {
          cin >> Q[i].l >> Q[i].r;
          Q[i].l++; // è½¬æ¢ä¸º1-based
          Q[i].id = i;
      }
      // æ’åºæŸ¥è¯¢
      sort(Q + 1, Q + q + 1);
      // åˆå§‹åŒ–è«é˜Ÿ
      f.push_back(1); // f[0] = 1
      int l = 1, r = 0;
      for (int i = 1; i <= q; i++) {
          int ql = Q[i].l, qr = Q[i].r, id = Q[i].id;
          // ç§»åŠ¨æŒ‡é’ˆ
          while (l > ql) add(a[--l]);
          while (r < qr) add(a[++r]);
          while (l < ql) del(a[l++]);
          while (r > qr) del(a[r--]);
          // è®¡ç®—å®¹æ–¥ç­”æ¡ˆ
          ModInt res = 0;
          ModInt sign = 1;
          for (int k = 0; k < (int)f.size(); k++) {
              res += sign * f[k] * fac[n - k];
              sign = -sign; // å®¹æ–¥ç³»æ•°äº¤æ›¿
          }
          ans[id] = res;
      }
      // è¾“å‡ºç­”æ¡ˆ
      for (int i = 1; i <= q; i++) {
          cout << ans[i].x << '\n';
      }
      return 0;
  }
  ```  
* **ä»£ç è§£è¯»æ¦‚è¦**ï¼š  
  ä»£ç åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼š  
  1. **ModIntç±»**ï¼šå¤„ç†æ¨¡è¿ç®—ï¼Œé¿å…æ‰‹åŠ¨å–æ¨¡çš„é”™è¯¯ï¼›  
  2. **è«é˜Ÿç®—æ³•**ï¼šåˆ†å—å¤„ç†åŒºé—´æŸ¥è¯¢ï¼Œç”¨`add`/`del`å‡½æ•°åŠ¨æ€ç»´æŠ¤ç”Ÿæˆå‡½æ•°`f`ï¼ˆ`f[k]`å¯¹åº”`g(k)`ï¼‰ï¼›  
  3. **å®¹æ–¥è®¡ç®—**ï¼šéå†ç”Ÿæˆå‡½æ•°çš„ç³»æ•°ï¼Œä¹˜ä»¥å®¹æ–¥ç³»æ•°`(-1)^k`å’Œé˜¶ä¹˜`(n-k)!`ï¼Œå¾—åˆ°æ¯ä¸ªæŸ¥è¯¢çš„ç­”æ¡ˆã€‚  


### é¢˜è§£ä¸€ï¼šCYZZçš„å¯æ’¤é”€DPç‰‡æ®µ  
* **äº®ç‚¹**ï¼šç”¨â€œå¯æ’¤é”€â€çš„æ–¹å¼ç»´æŠ¤DPæ•°ç»„ï¼Œé¿å…é‡å¤è®¡ç®—ã€‚  
* **æ ¸å¿ƒä»£ç ç‰‡æ®µ**ï¼š  
  ```cpp
  inline void upd1(const int id) {
      for (int i = 1; i <= n; i++) {
          (g[i] -= 1LL * g[i-1] * col[id] % MOD - MOD) %= MOD;
      }
  }
  inline void upd2(const int id) {
      for (int i = n; i >= 1; i--) {
          (g[i] += 1LL * g[i-1] * col[id] % MOD) %= MOD;
      }
  }
  inline void add(const int id) {
      upd1(id); // æ’¤é”€æ—§è´¡çŒ®
      col[id]++; // æ›´æ–°è®¡æ•°
      upd2(id); // æ·»åŠ æ–°è´¡çŒ®
  }
  ```  
* **ä»£ç è§£è¯»**ï¼š  
  - `upd1`å‡½æ•°ï¼šæ’¤é”€`col[id]`çš„æ—§è´¡çŒ®ï¼ˆ`g[i] -= g[i-1] * col[id]`ï¼‰ï¼›  
  - `upd2`å‡½æ•°ï¼šæ·»åŠ `col[id]+1`çš„æ–°è´¡çŒ®ï¼ˆ`g[i] += g[i-1] * (col[id]+1)`ï¼‰ï¼›  
  - `add`å‡½æ•°ï¼šå…ˆæ’¤é”€æ—§è´¡çŒ®ï¼Œå†æ›´æ–°è®¡æ•°ï¼Œæœ€åæ·»åŠ æ–°è´¡çŒ®ã€‚è¿™ç§â€œå¯æ’¤é”€â€çš„æ“ä½œä¿è¯äº†DPæ•°ç»„çš„æ­£ç¡®æ€§ã€‚  


### é¢˜è§£äºŒï¼šShiina_Mahiruçš„ç”Ÿæˆå‡½æ•°ç»´æŠ¤ç‰‡æ®µ  
* **äº®ç‚¹**ï¼šç”¨ç”Ÿæˆå‡½æ•°è¡¨ç¤º`g(k)`ï¼Œä»£ç ç®€æ´æ˜“æ‡‚ã€‚  
* **æ ¸å¿ƒä»£ç ç‰‡æ®µ**ï¼š  
  ```cpp
  void mul(int x) {
      if (!x) return;
      f.emplace_back(0);
      for (int i = (int)f.size()-1; i >= 1; i--) {
          f[i] += f[i-1] * x;
      }
  }
  void div(int x) {
      if (!x) return;
      for (int i = 1; i < (int)f.size(); i++) {
          f[i] -= f[i-1] * x;
      }
      f.pop_back();
  }
  void add(int x) {
      div(cnt[a[x]]); // æ’¤é”€æ—§è´¡çŒ®
      cnt[a[x]]++; // æ›´æ–°è®¡æ•°
      mul(cnt[a[x]]); // æ·»åŠ æ–°è´¡çŒ®
  }
  ```  
* **ä»£ç è§£è¯»**ï¼š  
  - `mul`å‡½æ•°ï¼šç”Ÿæˆå‡½æ•°ä¹˜ä»¥`(1 + xÂ·t)`ï¼ˆ`t`æ˜¯å½“å‰è®¡æ•°ï¼‰ï¼Œå¯¹åº”æ·»åŠ æ–°è´¡çŒ®ï¼›  
  - `div`å‡½æ•°ï¼šç”Ÿæˆå‡½æ•°é™¤ä»¥`(1 + xÂ·t)`ï¼ˆæ’¤é”€æ—§è´¡çŒ®ï¼‰ï¼›  
  - `add`å‡½æ•°ï¼šå…ˆæ’¤é”€æ—§è´¡çŒ®ï¼Œå†æ›´æ–°è®¡æ•°ï¼Œæœ€åæ·»åŠ æ–°è´¡çŒ®ã€‚ç”Ÿæˆå‡½æ•°çš„ç³»æ•°`f[k]`å¯¹åº”`g(k)`ã€‚  


## 5. ç®—æ³•å¯è§†åŒ–ï¼šåƒç´ åŠ¨ç”»æ¼”ç¤ºï¼ˆæ ¸å¿ƒéƒ¨åˆ†ï¼‰

### åŠ¨ç”»æ¼”ç¤ºä¸»é¢˜ï¼šã€Šåƒç´ è«é˜Ÿçš„ç”Ÿæˆå‡½æ•°å†’é™©ã€‹  
ï¼ˆä»¿ç…§FCæ¸¸æˆã€Šåƒè±†äººã€‹çš„é£æ ¼ï¼Œç”¨8ä½åƒç´ å—å±•ç¤ºè«é˜Ÿå¤„ç†åŒºé—´çš„è¿‡ç¨‹ï¼Œç”Ÿæˆå‡½æ•°çš„ç³»æ•°å˜åŒ–ç”¨æŸ±çŠ¶å›¾è¡¨ç¤ºã€‚ï¼‰


### æ ¸å¿ƒæ¼”ç¤ºå†…å®¹  
1. **åœºæ™¯åˆå§‹åŒ–**ï¼š  
   - å±å¹•å·¦ä¾§æ˜¾ç¤º**æ•°ç»„åƒç´ å—**ï¼ˆ1-basedï¼Œæ¯ä¸ªåƒç´ å—ä»£è¡¨ä¸€ä¸ªå…ƒç´ ï¼Œé¢œè‰²ä¸ºç°è‰²ï¼‰ï¼›  
   - å±å¹•å³ä¾§æ˜¾ç¤º**ç”Ÿæˆå‡½æ•°æŸ±çŠ¶å›¾**ï¼ˆxè½´ä¸ºkï¼Œyè½´ä¸º`f[k]`çš„å€¼ï¼Œç”¨ä¸åŒé¢œè‰²çš„åƒç´ å—è¡¨ç¤ºé«˜åº¦ï¼‰ï¼›  
   - å±å¹•ä¸‹æ–¹æ˜¾ç¤º**æ§åˆ¶é¢æ¿**ï¼ˆåŒ…å«â€œå¼€å§‹/æš‚åœâ€â€œå•æ­¥â€â€œé‡ç½®â€æŒ‰é’®ï¼Œä»¥åŠé€Ÿåº¦æ»‘å—ï¼‰ï¼›  
   - èƒŒæ™¯æ’­æ”¾**8ä½é£æ ¼çš„è½»æ¾BGM**ï¼ˆå¦‚ã€Šè¶…çº§é©¬é‡Œå¥¥ã€‹çš„èƒŒæ™¯éŸ³ä¹ï¼‰ã€‚  

2. **è«é˜ŸæŒ‡é’ˆç§»åŠ¨**ï¼š  
   - å½“æŒ‡é’ˆ`l`å·¦ç§»ï¼ˆåŠ å…¥å…ƒç´ ï¼‰æ—¶ï¼Œå¯¹åº”çš„æ•°ç»„åƒç´ å—å˜ä¸º**ç»¿è‰²**ï¼Œå¹¶æ’­æ”¾â€œå®â€çš„éŸ³æ•ˆï¼›  
   - å½“æŒ‡é’ˆ`r`å³ç§»ï¼ˆåŠ å…¥å…ƒç´ ï¼‰æ—¶ï¼Œå¯¹åº”çš„æ•°ç»„åƒç´ å—å˜ä¸º**ç»¿è‰²**ï¼Œå¹¶æ’­æ”¾â€œå®â€çš„éŸ³æ•ˆï¼›  
   - å½“æŒ‡é’ˆ`l`å³ç§»ï¼ˆåˆ é™¤å…ƒç´ ï¼‰æ—¶ï¼Œå¯¹åº”çš„æ•°ç»„åƒç´ å—å˜ä¸º**ç°è‰²**ï¼Œå¹¶æ’­æ”¾â€œæ»´â€çš„éŸ³æ•ˆï¼›  
   - å½“æŒ‡é’ˆ`r`å·¦ç§»ï¼ˆåˆ é™¤å…ƒç´ ï¼‰æ—¶ï¼Œå¯¹åº”çš„æ•°ç»„åƒç´ å—å˜ä¸º**ç°è‰²**ï¼Œå¹¶æ’­æ”¾â€œæ»´â€çš„éŸ³æ•ˆã€‚  

3. **ç”Ÿæˆå‡½æ•°æ›´æ–°**ï¼š  
   - åŠ å…¥å…ƒç´ æ—¶ï¼Œç”Ÿæˆå‡½æ•°çš„æŸ±çŠ¶å›¾**åŠ¨æ€å¢é•¿**ï¼ˆæ¯”å¦‚ï¼Œ`f[1]`å¢åŠ `cnt[x]`ï¼Œ`f[2]`å¢åŠ `f[1]Â·cnt[x]`ç­‰ï¼‰ï¼Œå¯¹åº”çš„åƒç´ å—é«˜åº¦å¢åŠ ï¼›  
   - åˆ é™¤å…ƒç´ æ—¶ï¼Œç”Ÿæˆå‡½æ•°çš„æŸ±çŠ¶å›¾**åŠ¨æ€ç¼©å°**ï¼ˆæ¯”å¦‚ï¼Œ`f[1]`å‡å°‘`cnt[x]`ï¼Œ`f[2]`å‡å°‘`f[1]Â·cnt[x]`ç­‰ï¼‰ï¼Œå¯¹åº”çš„åƒç´ å—é«˜åº¦å‡å°‘ï¼›  
   - ç”Ÿæˆå‡½æ•°çš„æ›´æ–°è¿‡ç¨‹ç”¨**é»„è‰²é—ªçƒ**æ ‡è®°ï¼Œæé†’å­¦ä¹ è€…æ³¨æ„ã€‚  

4. **å®¹æ–¥è®¡ç®—**ï¼š  
   - å½“è«é˜Ÿå¤„ç†å®Œä¸€ä¸ªåŒºé—´æ—¶ï¼Œå±å¹•ä¸­å¤®æ˜¾ç¤º**å®¹æ–¥è®¡ç®—è¿‡ç¨‹**ï¼ˆç”¨æ–‡å­—æ°”æ³¡æ˜¾ç¤ºâ€œå½“å‰k=0ï¼Œè´¡çŒ®ä¸ºf[0]Â·(n-0)!Â·(+1)â€â€œå½“å‰k=1ï¼Œè´¡çŒ®ä¸ºf[1]Â·(n-1)!Â·(-1)â€ç­‰ï¼‰ï¼›  
   - è®¡ç®—å®Œæˆåï¼Œå±å¹•æ˜¾ç¤º**ç­”æ¡ˆ**ï¼ˆç”¨çº¢è‰²åƒç´ å—æ˜¾ç¤ºï¼‰ï¼Œå¹¶æ’­æ”¾â€œèƒœåˆ©â€éŸ³æ•ˆï¼ˆå¦‚ã€Šåƒè±†äººã€‹çš„é€šå…³éŸ³æ•ˆï¼‰ã€‚  

5. **æ¸¸æˆå¼å…³å¡**ï¼š  
   - å°†è«é˜Ÿå¤„ç†çš„åŒºé—´åˆ†ä¸º**å°å…³å¡**ï¼ˆæ¯”å¦‚ï¼Œå¤„ç†10ä¸ªåŒºé—´ä¸ºä¸€å…³ï¼‰ï¼Œå®Œæˆä¸€å…³åæ˜¾ç¤ºâ€œå…³å¡å®Œæˆï¼â€çš„æç¤ºï¼Œå¹¶ç»™äºˆ**åƒç´ æ˜Ÿæ˜Ÿ**å¥–åŠ±ï¼ˆå¢åŠ æˆå°±æ„Ÿï¼‰ã€‚  


### è®¾è®¡æ€è·¯  
- **åƒç´ é£æ ¼**ï¼šè¥é€ å¤å¤æ¸¸æˆçš„æ°›å›´ï¼Œé™ä½å­¦ä¹ è€…çš„å‹åŠ›ï¼›  
- **éŸ³æ•ˆæç¤º**ï¼šç”¨â€œå®â€â€œæ»´â€ç­‰ç®€å•éŸ³æ•ˆå¼ºåŒ–å…³é”®æ“ä½œçš„è®°å¿†ï¼›  
- **åŠ¨æ€å¯è§†åŒ–**ï¼šé€šè¿‡æŸ±çŠ¶å›¾çš„å˜åŒ–ï¼Œè®©å­¦ä¹ è€…ç›´è§‚çœ‹åˆ°ç”Ÿæˆå‡½æ•°çš„ç»´æŠ¤è¿‡ç¨‹ï¼›  
- **æ¸¸æˆå¼å…³å¡**ï¼šç”¨â€œå…³å¡â€å’Œâ€œå¥–åŠ±â€æ¿€åŠ±å­¦ä¹ è€…ç»§ç»­å­¦ä¹ ã€‚  


## 6. æ‹“å±•ç»ƒä¹ ä¸ç›¸ä¼¼é—®é¢˜æ€è€ƒ

### é€šç”¨æ€è·¯/æŠ€å·§è¿ç§»  
- **å®¹æ–¥åŸç†**ï¼šé€‚ç”¨äºâ€œè®¡ç®—ä¸æ»¡è¶³å¤šä¸ªæ¡ä»¶çš„æ–¹æ¡ˆæ•°â€çš„é—®é¢˜ï¼ˆå¦‚â€œé”™ä½æ’åˆ—â€â€œç¦æ­¢ä½ç½®æ’åˆ—â€ï¼‰ï¼›  
- **è«é˜Ÿç®—æ³•**ï¼šé€‚ç”¨äºâ€œå¤šä¸ªåŒºé—´æŸ¥è¯¢â€çš„é—®é¢˜ï¼ˆå¦‚â€œåŒºé—´ä¼—æ•°â€â€œåŒºé—´å’Œâ€ï¼‰ï¼›  
- **ç”Ÿæˆå‡½æ•°**ï¼šé€‚ç”¨äºâ€œç»„åˆè®¡æ•°â€çš„é—®é¢˜ï¼ˆå¦‚â€œæ±‚é€‰kä¸ªå…ƒç´ çš„æ–¹æ¡ˆæ•°â€ï¼‰ã€‚  


### ç»ƒä¹ æ¨èï¼ˆæ´›è°·ï¼‰  
1. **æ´›è°· P1450** - ã€Šç¡¬å¸è´­ç‰©ã€‹  
   ğŸ—£ï¸ **æ¨èç†ç”±**ï¼šæœ¬é¢˜éœ€è¦ç”¨å®¹æ–¥åŸç†è®¡ç®—â€œä¸è¶…è¿‡é‡‘é¢çš„æ–¹æ¡ˆæ•°â€ï¼Œä¸æœ¬é¢˜çš„å®¹æ–¥æ€è·¯ç±»ä¼¼ï¼Œé€‚åˆå·©å›ºå®¹æ–¥åŸç†çš„åº”ç”¨ã€‚  

2. **æ´›è°· P2709** - ã€Šå°Bçš„è¯¢é—®ã€‹  
   ğŸ—£ï¸ **æ¨èç†ç”±**ï¼šæœ¬é¢˜éœ€è¦ç”¨è«é˜Ÿç®—æ³•å¤„ç†â€œåŒºé—´å†…å…ƒç´ å‡ºç°æ¬¡æ•°çš„å¹³æ–¹å’Œâ€ï¼Œä¸æœ¬é¢˜çš„è«é˜Ÿæ€è·¯ç±»ä¼¼ï¼Œé€‚åˆå·©å›ºè«é˜Ÿç®—æ³•çš„åº”ç”¨ã€‚  

3. **æ´›è°· P3396** - ã€Šå“ˆå¸Œå†²çªã€‹  
   ğŸ—£ï¸ **æ¨èç†ç”±**ï¼šæœ¬é¢˜éœ€è¦ç”¨â€œåˆ†å—â€æ€æƒ³å¤„ç†åŒºé—´æŸ¥è¯¢ï¼Œä¸æœ¬é¢˜çš„è«é˜Ÿåˆ†å—æ€è·¯ç±»ä¼¼ï¼Œé€‚åˆå·©å›ºåˆ†å—ä¼˜åŒ–çš„åº”ç”¨ã€‚  


## 7. å­¦ä¹ å¿ƒå¾—ä¸ç»éªŒåˆ†äº«ï¼ˆè‹¥æœ‰ï¼‰

### å‚è€ƒç»éªŒï¼ˆæ¥è‡ªCYZZï¼‰  
> â€œæˆ‘åœ¨æ¨¡æ‹Ÿèµ›ä¸Šæƒ³å‡ºäº†æ­£è§£ï¼Œä½†æ–‡ä»¶åå†™é”™äº†ï¼Œå¯¼è‡´100åˆ†å˜æˆ0åˆ†ï¼Œå“­æ™•ã€‚â€  
**ç‚¹è¯„**ï¼šè¿™ä¸ªç»éªŒæé†’æˆ‘ä»¬ï¼Œ**ç»†èŠ‚å†³å®šæˆè´¥**ã€‚åœ¨ç¼–ç¨‹æ¯”èµ›ä¸­ï¼Œæ–‡ä»¶åã€è¾“å…¥è¾“å‡ºæ ¼å¼ã€å˜é‡ç±»å‹ç­‰ç»†èŠ‚éƒ½å¯èƒ½å¯¼è‡´é”™è¯¯ï¼Œä¸€å®šè¦ä»”ç»†æ£€æŸ¥ã€‚  

### å‚è€ƒç»éªŒï¼ˆæ¥è‡ªInui_Sanaï¼‰  
> â€œèµ›æ—¶å¿˜äº†NTTæ€ä¹ˆå†™ï¼Œäºæ˜¯å†™äº†ä¸ªO(nÂ²q)çš„æš´åŠ›ï¼Œç»“æœæ¨¡æ‹Ÿèµ›æ•°æ®è·‘äº†700msã€‚â€  
**ç‚¹è¯„**ï¼šè¿™ä¸ªç»éªŒå‘Šè¯‰æˆ‘ä»¬ï¼Œ**æš´åŠ›æœ‰æ—¶å€™ä¹Ÿèƒ½è¿‡**ï¼ˆå°¤å…¶æ˜¯å½“æ•°æ®èŒƒå›´è¾ƒå°æˆ–æ—¶é—´é™åˆ¶è¾ƒæ¾æ—¶ï¼‰ã€‚ä½†æš´åŠ›ä¸æ˜¯é•¿ä¹…ä¹‹è®¡ï¼Œè¿˜æ˜¯è¦ç†Ÿç»ƒæŒæ¡ä¼˜åŒ–ç®—æ³•ï¼ˆå¦‚NTTã€è«é˜Ÿï¼‰ã€‚  


## ç»“è¯­  
æœ¬æ¬¡å…³äºâ€œCount Permutations Many Timesâ€çš„C++è§£é¢˜åˆ†æå°±åˆ°è¿™é‡Œã€‚å¸Œæœ›è¿™ä»½å­¦ä¹ æŒ‡å—èƒ½å¸®åŠ©å¤§å®¶æ›´å¥½åœ°ç†è§£å®¹æ–¥åŸç†ã€è«é˜Ÿç®—æ³•å’Œç”Ÿæˆå‡½æ•°çš„åº”ç”¨ã€‚è®°ä½ï¼Œç¼–ç¨‹èƒ½åŠ›çš„æå‡åœ¨äº**æŒç»­å­¦ä¹ ã€å‹¤äºæ€è€ƒå’Œå‹‡äºå®è·µ**ã€‚ä¸‹æ¬¡æˆ‘ä»¬å†ä¸€èµ·æ¢ç´¢æ–°çš„ç¼–ç¨‹æŒ‘æˆ˜ï¼ğŸ’ª

---
å¤„ç†ç”¨æ—¶ï¼š189.68ç§’
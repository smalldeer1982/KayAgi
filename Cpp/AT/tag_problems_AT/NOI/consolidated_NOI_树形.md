---
title: "[AGC008F] Black Radius"
layout: "post"
diff: NOI/NOI+/CTSC
pid: AT_agc008_f
tag: ['树形 DP']
---

# [AGC008F] Black Radius

## 题目描述

[problemUrl]: https://atcoder.jp/contests/agc008/tasks/agc008_f

$ N $ 頂点の木があります。 頂点は $ 1 $ から $ N $ まで番号が振られています。 各 $ 1\ <\ =\ i\ <\ =\ N\ -\ 1 $ について、$ i $ 番目の辺は頂点 $ a_i $ と $ b_i $ を繋いでいます。 辺の長さはすべて $ 1 $ です。

いくつかの頂点はすぬけ君のお気に入りです。 お気に入りの頂点の情報は、長さ $ N $ の文字列 $ s $ として与えられます。 各 $ 1\ <\ =\ i\ <\ =\ N $ について、頂点 $ i $ がお気に入りならば $ s_i $ は `1` で、頂点 $ i $ がお気に入りでないならば $ s_i $ は `0` です。

最初、頂点はすべて白色です。 すぬけ君は次の操作をちょうど $ 1 $ 回だけ行います。

- お気に入りの頂点 $ v $ をひとつ選び、非負整数 $ d $ をひとつ選ぶ。 頂点 $ v $ から距離 $ d $ 以内の頂点をすべて黒く塗る。

最終的な頂点の色の組合せとして考えられるものは何通りか求めてください。

## 输入格式

入力は以下の形式で標準入力から与えられる。

> $ N $ $ a_1 $ $ b_1 $ $ a_2 $ $ b_2 $ $ : $ $ a_{N\ -\ 1} $ $ b_{N\ -\ 1} $ $ s $

## 输出格式

最終的な頂点の色の組合せとして考えられるものは何通りか出力せよ。

## 说明/提示

### 制約

- $ 2\ <\ =\ N\ <\ =\ 2×10^5 $
- $ 1\ <\ =\ a_i,\ b_i\ <\ =\ N $
- グラフは木である。
- $ |s|\ =\ N $
- $ s $ は `0` と `1` のみからなる。
- $ s $ には `1` が含まれる。

### 部分点

- $ 1300 $ 点分のデータセットでは、$ s $ は `1` のみからなる。

### Sample Explanation 1

次の $ 4 $ 通りです。 !\[334d566ec1f4f38d23cd580044f1cd07.png\](https://atcoder.jp/img/agc008/334d566ec1f4f38d23cd580044f1cd07.png)

### Sample Explanation 2

このケースは部分点の制約を満たします。

## 样例 #1

### 输入

```
4

1 2

1 3

1 4

1100
```

### 输出

```
4
```

## 样例 #2

### 输入

```
5

1 2

1 3

1 4

4 5

11111
```

### 输出

```
11
```

## 样例 #3

### 输入

```
6

1 2

1 3

1 4

2 5

2 6

100011
```

### 输出

```
8
```



---

---
title: "[AGC041F] Histogram Rooks"
layout: "post"
diff: NOI/NOI+/CTSC
pid: AT_agc041_f
tag: ['动态规划 DP', '树形 DP', '容斥原理', '笛卡尔树']
---

# [AGC041F] Histogram Rooks

## 题目描述

[problemUrl]: https://atcoder.jp/contests/agc041/tasks/agc041_f

$ N $ 行 $ N $ 列のマスからなる盤面を考えます。アーボックはこの盤面の一部を切り離し、$ i\ =\ 1,\ 2,\ \ldots,\ N $ のそれぞれについて、左から $ i $ 列目は最も下の $ h_i $ マスのみが残されています。 そして、残されたマスのうち何マスかにルークを置こうとしています。

ルークはチェスの駒の一種で、$ 1 $ マスを占めます。$ 1 $ 回の移動では、何も置かれていないマスの上を縦か横の一方向に何マスでも動けます。 切り離されたマスの上は通れません。

あるマスについて、そのマスにルークが置かれているか、そのマスに $ 1 $ 回の移動で到達できるルークがあるとき、そのマスは支配下にあるといいます。

残された全マスが支配下に入るように残されたマスのうち何マスかにルークを置く方法の数を $ 998244353 $ で割った余りを求めてください。

## 输入格式

入力は以下の形式で標準入力から与えられる。

> $ N $ $ h_1 $ $ h_2 $ $ ... $ $ h_N $

## 输出格式

残された全マスが支配下に入るように残されたマスのうち何マスかにルークを置く方法の数を $ 998244353 $ で割った余りを出力せよ。

## 说明/提示

### 制約

- $ 1\ \leq\ N\ \leq\ 400 $
- $ 1\ \leq\ h_i\ \leq\ N $
- 入力中のすべての値は整数である。

### Sample Explanation 1

$ 2 $ 個以上のルークをどのように置いても条件が満たされ、そのような置き方は $ 11 $ 通りです。

### Sample Explanation 2

条件を満たす置き方は次の $ 17 $ 通りです (`R` がルーク、`\*` が空のマスに対応)。 ``` R \* \* R \* \* R R R R R R \*\*R R\*\* R\*R R\*\* \*R\* \*\*R R \* R \* \* R \* R \* \* R R R\*R \*RR RR\* R\*R RRR RR\* R R R R R \* \* R R R R\*R \*RR RRR RRR RRR ```

## 样例 #1

### 输入

```
2

2 2
```

### 输出

```
11
```

## 样例 #2

### 输入

```
3

2 1 2
```

### 输出

```
17
```

## 样例 #3

### 输入

```
4

1 2 4 1
```

### 输出

```
201
```

## 样例 #4

### 输入

```
10

4 7 4 8 4 6 8 2 3 6
```

### 输出

```
263244071
```



---

---
title: "[AGC047D] Twin Binary Trees"
layout: "post"
diff: NOI/NOI+/CTSC
pid: AT_agc047_d
tag: ['树形 DP', '线段树合并']
---

# [AGC047D] Twin Binary Trees

## 题目描述

[problemUrl]: https://atcoder.jp/contests/agc047/tasks/agc047_d

テレビドラマシリーズ『ストレンジャー・シングス』に触発されたクマのリマクは、現実世界と鏡像世界を歩いて行き来することにしました。

二つの高さ $ H $ の完全二分木があり、それぞれの頂点は $ 1 $ から $ 2^H-1 $ までの標準的な番号付けがなされています。 すなわち、根の番号は $ 1 $ で、番号 $ x $ の子の番号は $ 2\ \cdot\ x $ と $ 2\ \cdot\ x\ +\ 1 $ です。

一つの木が持つ葉の数を $ L $ とします。すなわち、$ L\ =\ 2^{H-1} $ です。

数列 $ 1,\ \ldots,\ L $ の順列 $ P_1,\ P_2,\ \ldots,\ P_L $ が与えられます。これは、二つの木を結ぶ $ L $ 本の *特殊辺* を表します。 すなわち、第一の木の番号 $ L+i-1 $ の頂点と第二の木の番号 $ L+P_i-1 $ の頂点が一本の特殊辺で結ばれています。

![入力例 1 のグラフ](https://cdn.luogu.com.cn/upload/vjudge_pic/AT_agc047_d/4c625be33a7fdc66e88ab8ed10969ab25c77b603.png)

*入力例 1 の図示。$ P\ =\ (2,\ 3,\ 1,\ 4) $ であり、緑の辺が特殊辺*

サイクルの *積* を、それに含まれる頂点の番号の積と定義します。**ちょうど二本の特殊辺を持つような** すべての単純サイクルの積の和を $ (10^9+7) $ で割った余りを求めてください。

なお、単純サイクルとは、長さが $ 3 $ 以上であって頂点や辺の重複がないようなサイクルです。

## 输入格式

入力は以下の形式で標準入力から与えられる (ここで、$ L\ =\ 2^{H-1} $ である)。

> $ H $ $ P_1 $ $ P_2 $ $ \cdots $ $ P_L $

## 输出格式

ちょうど二本の特殊辺を持つようなすべての単純サイクルの積の和を求め、それを $ (10^9+7) $ で割った余りを出力せよ。

## 说明/提示

### 制約

- $ 2\ \leq\ H\ \leq\ 18 $
- $ 1\ \leq\ P_i\ \leq\ L $ (ただし $ L\ =\ 2^{H-1} $)
- $ P_i\ \neq\ P_j $ (すなわち、この数列は $ 1,\ \ldots,\ L $ の順列である)

### Sample Explanation 1

下図に考慮すべきサイクルを二つ示します (他にも存在します)。一つめのサイクルの積は $ 2\ \cdot\ 5\ \cdot\ 6\ \cdot\ 3\ \cdot\ 1\ \cdot\ 2\ \cdot\ 5\ \cdot\ 4\ =\ 7200 $、二つめのサイクルの積は $ 1\ \cdot\ 3\ \cdot\ 7\ \cdot\ 7\ \cdot\ 3\ \cdot\ 1\ \cdot\ 2\ \cdot\ 5\ \cdot\ 4\ \cdot\ 2\ =\ 35280 $ です。三つめのサイクルは、特殊辺の数が二本でないため、考慮すべきサイクルではありません。 !\[three cycles\](https://img.atcoder.jp/agc047/3\_trees\_font.png)

### Sample Explanation 2

グラフ中の唯一のサイクルは確かに特殊辺を二本持ち、その頂点番号の積は $ 1\ \cdot\ 3\ \cdot\ 3\ \cdot\ 1\ \cdot\ 2\ \cdot\ 2\ =\ 36 $ です。

## 样例 #1

### 输入

```
3

2 3 1 4
```

### 输出

```
121788
```

## 样例 #2

### 输入

```
2

1 2
```

### 输出

```
36
```

## 样例 #3

### 输入

```
5

6 14 15 7 12 16 5 4 11 9 3 10 8 2 13 1
```

### 输出

```
10199246
```



---

---
title: "[AGC050F] NAND Tree"
layout: "post"
diff: NOI/NOI+/CTSC
pid: AT_agc050_f
tag: ['树形 DP', 'Ad-hoc']
---

# [AGC050F] NAND Tree

## 题目描述

[problemUrl]: https://atcoder.jp/contests/agc050/tasks/agc050_f

各頂点に $ 0 $ または $ 1 $ が書かれた木があります。 この木は $ N $ 個の頂点を持ち、それらには $ 1 $ から $ N $ までの番号が振られています。 各 $ i $ について、頂点 $ a_i $ と頂点 $ b_i $ を結ぶ辺が存在します。 頂点 $ i $ に書かれた数は $ c_i $ です。

すぬけ君は、この木に以下の操作を繰り返します。

- 辺を $ 1 $ 本選んで縮約し、消された $ 2 $ 個の頂点に書かれていた数の NAND を新たな頂点に書き込む。

![](https://cdn.luogu.com.cn/upload/vjudge_pic/AT_agc050_f/2832ee2906c66cb526c5b478a4fea0cd9ce9f087.png)

$ N\ -\ 1 $ 回の操作後、木は $ 1 $ 個の頂点となります。 このような操作の行い方は $ (N-1)! $ 通りありますが、そのうち最後の頂点に $ 1 $ が書き込まれるものは何通りあるでしょうか。 この答えを **$ 2 $ で割った余り**を計算してください。

## 输入格式

入力は標準入力から以下の形式で与えられる。

> $ N $ $ a_1 $ $ b_1 $ $ : $ $ a_{N-1} $ $ b_{N-1} $ $ c_1 $ $ c_2 $ $ \cdots $ $ c_N $

## 输出格式

答えを出力せよ。

## 说明/提示

### 注記

- 演算 NAND の定義は次の通りです: $ NAND(0,\ 0)\ =\ NAND(0,\ 1)\ =\ NAND(1,\ 0)\ =\ 1,\ NAND(1,\ 1)\ =\ 0 $.
- 頂点 $ s $ と頂点 $ t $ を結ぶ辺を縮約する際は、その辺を取り除くと同時に $ 2 $ 頂点を併合します。 縮約後の木において、併合により生まれた頂点と頂点 $ u $ を結ぶ辺が存在するのは、縮約前の木において $ s $ と $ u $ を結ぶ辺または $ t $ と $ u $ を結ぶ辺が存在するときであり、またそのときに限られます。

### 制約

- $ 2\ \leq\ N\ \leq\ 300 $
- $ 1\ \leq\ a_i\ <\ b_i\ \leq\ N $
- 入力が表すグラフは木である。
- $ 0\ \leq\ c_i\ \leq\ 1 $
- 入力中の全ての値は整数である。

### Sample Explanation 1

$ 6 $ 通りの操作順のうち $ 4 $ 通りで最後の頂点に $ 1 $ が書き込まれることがわかります。よって、答えは $ 4\ mod\ 2\ =\ 0 $ です。

## 样例 #1

### 输入

```
4

1 2

2 3

2 4

0 1 1 0
```

### 输出

```
0
```

## 样例 #2

### 输入

```
4

1 2

2 3

3 4

1 1 0 1
```

### 输出

```
1
```

## 样例 #3

### 输入

```
20

3 15

1 12

10 16

3 19

5 20

1 9

6 13

14 19

2 4

8 11

12 16

6 20

2 17

16 18

17 19

7 10

16 20

2 20

8 20

1 0 0 1 1 0 1 1 1 0 0 1 0 1 0 1 1 1 0 0
```

### 输出

```
0
```



---

---
title: "[AGC058F] Authentic Tree DP"
layout: "post"
diff: NOI/NOI+/CTSC
pid: AT_agc058_f
tag: ['动态规划 DP', '树形 DP', 'Ad-hoc']
---

# [AGC058F] Authentic Tree DP

## 题目描述

[problemUrl]: https://atcoder.jp/contests/agc058/tasks/agc058_f

無向木 $ t $ に対して，有理数 $ f(t) $ を次のように定義します．

- $ t $ の頂点数を $ n $ とする．
- $ n=1 $ のとき：$ f(t)=1 $ とする．
- $ n\ \geq\ 2 $ のとき：
  - $ t $ の辺 $ e $ について，$ t $ から $ e $ を削除することで得られる $ 2 $ つの木を $ t_x(e),t_y(e) $ （順不同）で表す．
  - $ f(t)=(\sum_{e\ \in\ t}\ f(t_x(e))\ \times\ f(t_y(e)))/n $ とする．

$ 1 $ から $ N $ までの番号のついた $ N $ 頂点からなる木 $ T $ が与えられます． $ i $ 番目の辺は頂点 $ A_i $ と頂点 $ B_i $ を結ぶ辺です．

$ f(T) $ の値を $ \text{mod\ }{998244353} $ で求めてください．

 有理数 $ \text{mod\ }{998244353} $ の定義 この問題の制約のもとでは、求める有理数を既約分数 $ \frac{P}{Q} $ で表した時、$ Q\ \neq\ 0\ \pmod{998244353} $ となることが証明できます。 よって、$ R\ \times\ Q\ \equiv\ P\ \pmod{998244353},\ 0\ \leq\ R\ &amp;lt\ 998244353 $ を満たす整数 $ R $ が一意に定まります。 この $ R $ を答えてください。

## 输入格式

入力は以下の形式で標準入力から与えられる．

> $ N $ $ A_1 $ $ B_1 $ $ A_2 $ $ B_2 $ $ \vdots $ $ A_{N-1} $ $ B_{N-1} $

## 输出格式

答えを出力せよ．

## 说明/提示

### 制約

- $ 2\ \leq\ N\ \leq\ 5000 $
- $ 1\ \leq\ A_i,B_i\ \leq\ N $
- 入力されるグラフは木である

### Sample Explanation 1

$ f(T)=1/2 $ です．

### Sample Explanation 2

$ f(T)=1/3 $ です．

## 样例 #1

### 输入

```
2

1 2
```

### 输出

```
499122177
```

## 样例 #2

### 输入

```
3

1 2

2 3
```

### 输出

```
332748118
```

## 样例 #3

### 输入

```
4

1 2

2 3

3 4
```

### 输出

```
103983787
```

## 样例 #4

### 输入

```
10

4 5

1 9

6 1

8 4

5 9

4 7

3 10

5 2

4 3
```

### 输出

```
462781191
```



---

---
title: "[ARC144E] GCD of Path Weights"
layout: "post"
diff: NOI/NOI+/CTSC
pid: AT_arc144_e
tag: ['图论', '数论', '树形 DP']
---

# [ARC144E] GCD of Path Weights

## 题目描述

[problemUrl]: https://atcoder.jp/contests/arc144/tasks/arc144_e

$ N $ 頂点 $ M $ 辺からなる有向グラフ $ G $ が与えられます．頂点には $ 1,\ 2,\ \ldots,\ N $ の番号がついています．$ i $ 番目の辺は $ a_i $ から $ b_i $ に向かう有向辺で，$ a_i\ <\ b_i $ が成り立っています．

正整数列 $ W\ =\ (W_1,\ W_2,\ \ldots,\ W_N) $ の**美しさ**を，次が成り立つような正整数 $ x $ の最大値として定義します．

- $ G $ における頂点 $ 1 $ から頂点 $ N $ への任意のパス $ (v_1,\ \ldots,\ v_k) $ ($ v_1\ =\ 1,\ v_k\ =\ N $) に対し，$ \sum_{i=1}^k\ W_{v_i} $ は $ x $ の倍数である．

整数列 $ A\ =\ (A_1,\ A_2,\ \ldots,\ A_N) $ が与えられます．正整数列 $ W\ =\ (W_1,\ \ldots,\ W_N) $ を，$ A_i\ \neq\ -1\ \implies\ W_i\ =\ A_i $ を満たすように定めるとき，その美しさとしてありうる最大値を求めてください．ただし，最大値が存在しない場合には `-1` を出力してください．

## 输入格式

入力は以下の形式で標準入力から与えられます．

> $ N $ $ M $ $ a_1 $ $ b_1 $ $ \vdots $ $ a_M $ $ b_M $ $ A_1 $ $ A_2 $ $ \ldots $ $ A_N $

## 输出格式

正整数列 $ W $ の美しさとしてありうる最大値を出力してください．ただし，最大値が存在しない場合には `-1` を出力してください．

## 说明/提示

### 制約

- $ 2\leq\ N\leq\ 3\times\ 10^5 $
- $ 1\leq\ M\leq\ 3\times\ 10^5 $
- $ 1\leq\ a_i\ <\ b_i\ \leq\ N $
- $ i\neq\ j $ ならば $ (a_i,b_i)\neq\ (a_j,b_j) $
- 与えられるグラフ $ G $ において，頂点 $ 1 $ から頂点 $ N $ へのパスが存在する．
- $ A_i\ =\ -1 $ または $ 1\leq\ A_i\leq\ 10^{12} $

### Sample Explanation 1

頂点 $ 1 $ から頂点 $ N $ へのパスは，$ (1,2,4) $, $ (1,3,4) $ の $ 2 $ 個です． 例えば $ W\ =\ (5,\ 3,\ 7,\ 8) $ の美しさは $ 4 $ となります．実際，$ W_1\ +\ W_2\ +\ W_4\ =\ 16 $, $ W_1\ +\ W_3\ +\ W_4\ =\ 20 $ はともに $ 4 $ の倍数です．

### Sample Explanation 2

頂点 $ 1 $ から頂点 $ N $ へのパスは，$ (1,2,4) $, $ (1,3,4) $, $ (1,4) $ の $ 3 $ 個です． 例えば $ W\ =\ (5,\ 3,\ 7,\ 8) $ の美しさは $ 1 $ となります．

### Sample Explanation 3

例えば $ W\ =\ (3,\ 10^{100},\ 10^{100},\ 7) $ の美しさは $ 10^{100}+10 $ となります．$ W $ の美しさをいくらでも大きくできるため，その最大値は存在しません．

## 样例 #1

### 输入

```
4 4

1 2

1 3

2 4

3 4

-1 3 7 -1
```

### 输出

```
4
```

## 样例 #2

### 输入

```
4 5

1 2

1 3

2 4

3 4

1 4

-1 3 7 -1
```

### 输出

```
1
```

## 样例 #3

### 输入

```
4 4

1 2

1 3

2 4

3 4

3 -1 -1 7
```

### 输出

```
-1
```

## 样例 #4

### 输入

```
5 5

1 3

3 5

2 3

3 4

1 4

2 -1 3 -1 4
```

### 输出

```
9
```



---

---
title: "[ARC167F] Tree Tree Tree"
layout: "post"
diff: NOI/NOI+/CTSC
pid: AT_arc167_f
tag: ['多项式', '分治', '树形 DP', '组合数学', '快速数论变换 NTT']
---

# [ARC167F] Tree Tree Tree

## 题目描述

[problemUrl]: https://atcoder.jp/contests/arc167/tasks/arc167_f

$ 2\leq\ K\leq\ N $ を満たす整数 $ N,K $ が与えられます。

> **問題 potato**
> 
> $ 1 $ から $ N $ までの番号がついた頂点数 $ N $ の重み付き根付き木があります。頂点 $ 1 $ が根です。
> 
> $ 2\leq\ i\leq\ N $ に対して、頂点 $ i $ の親は $ p_{i}\;(1\leq\ p_{i}\ <\ i) $で、 $ i $ と $ p_{i} $ を結ぶ辺の重みは $ q_{i-1} $ です。
> 
> ただし、$ q=(q_{1},q_{2},\dots,q_{N-1}) $ は $ (1,2,\dots,N-1) $ の順列です。
> 
> ここで $ cost(u,v) $ を頂点 $ u,v $ を結ぶ単純パスに含まれる辺の重みの最大値とします。
> 
> $ \sum_{u=1}^{N}\ \sum_{v=u+1}^{N}\ cost(u,v) $ を求めてください。

- - - - - -

> **問題 tomato**
> 
> $ 1\leq\ a\lt\ K $ を満たす整数 $ a $ が与えられます。「問題 potato」 の $ p,q $ として $ p_{K}=a $ を満たすものは $ \frac{((N-1)!)^{2}}{K-1} $ 通り考えられますが、その全てに対する「問題 potato」の答えの和を $ 998244353 $ で割ったあまりを求めてください。

$ a=1,\dots,K-1 $ について、「問題 tomato」の答えを求めてください。

## 输入格式

入力は以下の形式で標準入力から与えられます。

> $ N $ $ K $

## 输出格式

$ K-1 $ 行出力してください。$ i $ 行目には $ a=i $ としたときの「問題 tomato」の答えを出力してください。

## 说明/提示

### 制約

- $ 2\leq\ K\leq\ N\leq\ 10^{5} $
- 入力は全て整数

## 样例 #1

### 输入

```
4 4
```

### 输出

```
170

170

172
```

## 样例 #2

### 输入

```
3 2
```

### 输出

```
20
```

## 样例 #3

### 输入

```
16 7
```

### 输出

```
457991130

457991130

65525944

418314090

644126049

676086428
```



---


# Aquatic Dragon

## 题目描述

你居住在一个由 $N$ 个岛屿组成的群岛中，这些岛屿排列成一条直线。岛屿从 $1$ 开始依次编号到 $N$。相邻的岛屿 $i$ 和 $i+1$ 之间有单向水下隧道：一条从岛 $i$ 到 $i+1$，另一条反向。而每条隧道只能走一次。

你和一条龙同行。龙的耐力以非负整数表示，用来施展游泳和飞行能力。初始时，其耐力为 $0$。

每个岛上都有一个魔法神社，当你第一次到达某岛时，会立即将龙的耐力增加 $P_i$（无论龙身处何地）。这个过程无需时间。

在某个岛上，你可以做以下三种移动：

- 如果你和你的龙在同一岛上，可以让龙游到相邻岛屿，前提是龙的耐力至少是 $D$。该操作会消耗耐力 $D$，耗时 $T_s$ 秒。
- 如果你和你的龙在同一岛上，可以让龙飞到相邻岛屿，前提是龙的耐力不为零。此举会将耐力归零，耗时 $T_f$ 秒。
- 你可以单独通过水下隧道步行到相邻岛屿，这需要花费 $T_w$ 秒。一旦你通过这条隧道，就不能再次使用。

请注意，游泳和飞行时不使用隧道。

你和龙当前在岛屿 $1$ 上。你的任务是带着龙到达岛屿 $N$，请计算出任务完成的最短时间。

## 说明/提示

### 示例解释 #1

以下是完成任务的最短事件序列：

1. 在岛 $1$ 的神社将龙的耐力增加到 $1$。
2. 带龙飞到岛 $2$，神社令龙的耐力增至 $2$。
3. 单独走到岛 $3$，神社令龙的耐力增至 $6$。
4. 单独走到岛 $4$，神社令龙的耐力增至 $8$。
5. 单独走回岛 $3$。
6. 单独走回岛 $2$。
7. 带龙游回岛 $3$，此时龙的耐力为 $4$。
8. 带龙游到岛 $4$，此时龙的耐力为 $0$。
9. 单独走到岛 $5$，神社令龙的耐力增至 $1$。
10. 单独走回岛 $4$。
11. 带龙飞到岛 $5$。

### 示例解释 #2

对于 $1 \leq i < 5$，重复以下过程：在岛 $i$ 的神社增加龙的耐力，然后带龙飞到岛 $i+1$。

 **本翻译由 AI 自动生成**

## 样例 #1

### 输入

```
5 4 2 9 1
1 2 4 2 1```

### 输出

```
28```

## 样例 #2

### 输入

```
5 4 2 1 1
1 2 4 2 1```

### 输出

```
4```

## 样例 #3

### 输入

```
3 4 2 10 1
3 1 2```

### 输出

```
16```

# 题解

## 作者：winsun (赞：1)

方便起见，下文用~~水陆空三栖~~ **车** 代替 **dragon**，用 **油量** 代替 **stamina**。油箱容量没有上限。

记一次 walk 操作花费的时间为 $a$，一次 swim 花费 $b$，一次 fly 花费 $c$，$s_i=\sum_{j=1}^i p_i$。

显然，人不会到车左边，车不会后退。

假设当前人和车都在第 $i$ 个点，油箱有 $j$ 升油。

- fly 到 $i+1$，油量变为 $p_{i+1}$，代价为 $c$。
- $j \ge d$，直接 swim，油量 $j-d+p_{i+1}$，代价为 $b$。
- $j < d$，假设人 walk 到 $t$ 之后返回 $i$，显然在 $[i, t - 1]$ 之内车只能 swim。
  - 若 $j + s_t - s_i - d(t - i) \ge 0$，那么在 $t-1\rightarrow t$ 时可以 swim。不等号左边为新的油量，代价为 $(2a+b)(t-i)$。
  - 若 $j + s_t - s_i - d(t - i - 1) > 0$，那么在 $t-1\rightarrow t$ 时可以 fly。到达 $t$ 后油量归 $0$，且代价为 $(2a+b)(t-i)-b+c$。

考虑优化上述暴力。

如果认为经过一次 fly 之后得到的 $(i, 0)$ 或 $(i, p_i)$ 是特殊的，那么只有 $O(n)$ 个特殊状态，其他状态一定通过某个特殊状态让车一直 swim 得到。设 $t_j \in \{0, p_j\}$，那么从 $(j, t_j)$ 车只 swim 只能转移到一些合法的 $(i, s_i - s_j + t_j)$。

从前往后 DP，尝试使用数据结构维护每个特殊状态 swim 到 $i$ 的代价。并在外部记录偏移量：默认所有的 $i-1 \rightarrow i$ 过程都经过水路，且都经过了往返 walk 拾取的过程。

对于 $i$ 处新产生的特殊状态，计算初始代价，转移条件：

- 当前 $(i, 0)$ 来自之前的 $(j, t_j)$，需要 $(s_i - s_j + t_j) - d(i - j - 1) > 0$；
- 当前 $(i, p_i)$ 来自之前的 $(j, t_j)$，需要 $(s_{i-1} - s_j + t_j) - d(i - j - 1) > 0$。

对于已有的所有特殊状态，如果 $(s_i - s_j + t_j) - d(i - j)\ge 0$，这意味着 $(j, t_j)$ 可在 $i - 1 \rightarrow i$ 处不需要经过往返 walk 的拾取，不需要加上额外预定的 $2a$。

观察发现，三个不等式都可以变成 $s_j - t_j - d_j$ 小于等于某个数的形式，于是按此排序离散化后，作为线段树的下标即可。

---

一开始讨论漏了向前拾取一段到 $t$ 之后，在 $t-1 \rightarrow t$ 使用 fly 的情况，在极不清醒的情况下调了一上午。

```plain
4 10 10 100 1
5 1 5 1
ans = 216
```

---


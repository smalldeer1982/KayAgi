# Turtle and Inversions (Hard Version)

## 题目描述

这是一个问题的困难版本。这个困难版本与简单版本在 $m$ 的限制条件上有所不同，而且在简单版本中，对于每一个 $i$（从 $1$ 到 $m-1$），都有 $r_i < l_{i+1}$ 的条件。只有当两个版本的问题都解决后，你才可以进行 hack。

有 $m$ 个区间 $[l_1, r_1], [l_2, r_2], \ldots, [l_m, r_m]$，海龟认为一个排列 $p$ 是有趣的，如果对每个区间 $l_i \le k_i < r_i$，存在一个整数 $k_i$，并且对于每个 $i$ 从 $1$ 到 $m$，满足以下条件：

设 $a_i = \max\limits_{j = l_i}^{k_i} p_j$，$b_i = \min\limits_{j = k_i + 1}^{r_i} p_j$，需满足：

$$
\max\limits_{i = 1}^m a_i < \min\limits_{i = 1}^m b_i
$$

海龟希望你找出长度为 $n$ 的所有可能的有趣排列中，逆序对数量的最大值。如果没有这样一个有趣的排列，则返回 $-1$。

排列 $p$ 中的逆序对是指满足 $p_i > p_j$ 的整数对 $(i, j)$，其中 $1 \le i < j \le n$。

## 样例 #1

### 输入

```
8
2 0
2 1
1 2
5 1
2 4
8 3
1 4
2 5
7 8
7 2
1 4
4 7
7 3
1 2
1 7
3 7
7 4
1 3
4 7
1 3
4 7
7 3
1 2
3 4
5 6```

### 输出

```
1
0
8
18
-1
-1
15
15```

# 题解

## 作者：KellyWLJ (赞：1)

#### [CF2003E2 Turtle and Inversions (Hard Version)](https://www.luogu.com.cn/problem/CF2003E2)

先考虑 Easy Version，每条线段不相交。

$a,b$ 两部分内部肯定倒序最优，然后每放一段 $a$ 会与前面的所有 $a,b$ 形成逆序对，放一段 $b$ 只能和前面所有 $b$ 形成逆序对。

先不管没被线段覆盖的位置，$f_{i,j}$ 表示选了$i$ 个 $b$ 中数，$j$ 个 $a$ 中数时最多的逆序对，转移则枚举当前线段选多少个放到 $a$ 中。

最后分配所有没被覆盖的位置，它们可以看作是随便划分至 $a,b$ 两个集合，最后分配数时从前往后将 $n\sim n-j+1$ 分配给 $b$ 集合中的数，再把剩下的从前往后倒序分配至 $a$ 集合，也可以类似的进行 DP。

转移时合并的复杂度类似背包分析，每个点与它前面的点形成的点对产生一份贡献，总复杂度 $O(n^2)$。

然后 Hard Version 自然考虑分析线段相交会怎样，如果线段 $i,j$ 相交，则 $i,j$ 的分割点 $k_i,k_j$ 必须相同且 $\in[\max(l_i,l_j),\min(r_i,r_j)]$。

把相交的线段间连边，单独考虑每个连通块，则每个连通块中线段的交长度 $>1$，否则会出现一条线段中要划分两处或某条线段全划分为一种的情况，划分点就落在线段的交 $[l,r)$ 处。

每个划分点能落在的区域就不交了， 类似于 Easy Version 的方式 DP 即可，时间复杂度 $O(n^2)$。

---


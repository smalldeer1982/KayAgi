# Sasha and a Patient Friend

## 题目描述

费迪亚和萨沙是朋友，所以萨沙项知道关于费迪亚的一切。

费迪亚把他的耐心放在一个无限大的碗里。（真实么）

但是，与碗不同，费迪亚的耐心不是无限的，费迪亚总共有$v$升的耐心，一旦$v$等于$0$，碗将立即破裂。

碗里有一个水龙头，可以每秒增加$s$升的耐心。请注意，$s$可能是负数，在这种情况下，水龙头会吸入耐心（……）

萨沙可以做不同的事情，所以他可以改变水龙头的速度。萨沙所做的所有动作都可以表示为$q$次操作。有三种类型的操作：

```1 t s```-添加一个新速度，意味着从第$t$秒开始，水龙头的速度将等于$s$。

```2 t```-删除第$t$秒发生的操作。保证此类操作的存在。

```3 l r v```-萨沙想知道：如果按照所有$l \le t\le r$的操作来执行，那么碗何时会破裂。如果碗在规定时间内没发生破裂，那么答案将是$-1$.

由于萨沙不想检查费迪亚的耐心结束后会发生什么，所以他请求你帮助他，并回答每一个第$3$类问题。

保证在任何时刻，不会有两个事件同时发生。

## 样例 #1

### 输入

```
6
1 2 1
1 4 -3
3 1 6 1
3 1 6 3
3 1 6 4
3 1 6 5
```

### 输出

```
5
5.666667
6
-1
```

## 样例 #2

### 输入

```
10
1 2 2
1 4 4
1 7 -10
3 2 4 1
3 5 6 0
3 1 15 1
2 4
3 1 15 1
1 8 1
3 1 15 1
```

### 输出

```
-1
5
8.7
8.1
-1
```

## 样例 #3

### 输入

```
5
1 1000 9999999
1 2000 -9999
3 1000 2000 0
2 1000
3 1000 2002 1
```

### 输出

```
1000
2000.0001
```

# 题解

## 作者：Gold14526 (赞：3)

$\rm Problem$:[Sasha and a Patient Friend](https://www.luogu.com.cn/problem/CF1109C)

$\rm Difficulty:2800$

场上这道 C 过的人比 D、E 都少？

这个题洛谷居然没有题解？可能太模板了吧。

### 题意

维护 $q$ 次操作，每次操作是以下三种中的一种：

- ```1 t s```：在第 $t$ 秒增加一个将水龙头速度调节为 $s$ 的操作，保证在此之前第 $t$ 秒没有操作，**$s$ 可能为负数**。
- ```2 t```：删除第 $t$ 秒的操作，保证在此之前第 $t$ 秒有操作。
- ```3 l r v```：若在第 $l$ 时刻水的容量为 $v$，**水龙头速度为 $0$**，则在什么时候水会用完，误差不超过 $10^{-6}$，若在时间 $r$ 之前没有用完，输出 $-1$。

$1\le q\le 10^5$。

$1\le t\le 10^9,-10^9\le s\le 10^9$。

$1\le l\le r\le10^9,0\le v\le 10^9$。

### 做法

一个比较模板的动态开点线段树题。

只需维护以下几个量：

- ```res```——一段区间增加/消耗的水量。
- ```mn```——一段区间内最小前缀增加/最大前缀消耗水量。
- ```speed```——一段区间结尾时的水龙头速度。

于是，在询问时，我们只需要线段树上二分 $|mn|\le v$ 的最长前缀即可，由于输出时要精确至小数，所以求出来之后还要再简单计算一下，就这么简单。

### 代码

为了避免额外节点空间问题，具体实现时我用了 01-Trie，其实差不多。

[submission](https://codeforces.com/contest/1109/submission/299536214)

---

## 作者：紊莫 (赞：1)

平衡树（线段树）做法！！！

---

首先特判 $v = 0$ 的询问。

将询问的 $l$ 改为大于等于 $l$ 的最小时间点显然不影响答案。

若这个最小时间点不存在则一定有解。

对于操作而言，我们只维护转折点处的值，那么形如区间加的形式。

对于查询，可以在数据结构上二分找到第一个使得 $v \le 0$ 的时间点（在给出的时间点中找）。

然后再解一个一次函数就能算出答案。

为了防止一些神秘 corner case，我采用平衡树，实际上用线段树也是可以的。

---

如果你有相似的思路，看懂我的解法不难，但是能看懂有点难。

[参考代码](https://codeforces.com/contest/1109/submission/306074687)。

---


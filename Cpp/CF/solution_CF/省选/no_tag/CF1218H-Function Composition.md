# Function Composition

## 题目描述

我们绝对不会再用那些千篇一律的故事来打扰你，比如 Alice 发现了一个数组，或者 Alice 和 Bob 玩某个无聊的游戏。这一次，你将直接得到一段简单明了的文本。

首先，我们定义一些内容。我们在数组 $A$ 上定义函数 $F$，使得 $F(i, 1) = A[i]$，并且当 $m > 1$ 时，$F(i, m) = A[F(i, m - 1)]$。换句话说，$F(i, m)$ 表示将 $A$ 复合应用 $m$ 次后的结果，即 $A[...A[i]]$，共应用 $m$ 次。

给定一个长度为 $N$ 的非负整数数组。你需要回答 $Q$ 个询问。每个询问包含两个数字 $m$ 和 $y$。对于每个询问，求有多少个 $x$ 满足 $F(x, m) = y$。

## 说明/提示

对于第一个询问，可以注意到 $F(3, 10) = 1$，$F(9, 10) = 1$，$F(10, 10) = 1$。

对于第二个询问，没有 $x$ 满足 $F(x, 5) = 7$。

对于第三个询问，$F(5, 10) = 6$ 成立。

对于第四个询问，$F(3, 1) = 1$。

对于第五个询问，没有 $x$ 满足 $F(x, 10) = 8$。

由 ChatGPT 4.1 翻译

## 样例 #1

### 输入

```
10
2 3 1 5 6 4 2 10 7 7
5
10 1
5 7
10 6
1 1
10 8
```

### 输出

```
3
0
1
1
0
```

# 题解

## 作者：Jsxts_ (赞：0)

容易发现若将 $i\to a_i$ 连边，序列就变为了内向基环树，而 $f(i,m)$ 就是让 $i$ 在基环树上走 $m$ 步，查询就是求到内向基环树一点 $y$ 距离为 $m$ 的点数。

考虑对 $y$ 分类讨论：

- 若不在环上，只有子树内深度为 $dep_y+m$ 的点能恰好走 $m$ 步到达，离线之后在每棵树 dfs 即可。

- 若在环上，首先因为要在环上走若干圈，而最后还是要回到一点，先将 $m$ 对环长 $l$ 取模。考虑设一个任意的定点 $p$，设 $p$ 到 $y$ 的距离为 $d$，那么到 $y$ 距离为 $m$ 就是到 $p$ 距离为 $(m-d)\bmod l$ 的点，设此值为 $k$。那么，现在询问的点固定为 $p$，而只要经过 $p$ 则必须从 $p$ 的出边出去再次回来，而步数已经对 $l$ 取模过了，所以 $p$ 的出边没有用，直接断掉。此时基环树变成了树，而 $p$ 是这颗树的根。那么求的值变为了深度模 $l$ 余 $k$ 且到 $p$ 距离小于等于 $m$ 的点数，可以离线下来一边 dfs 一边统计。

时间复杂度 $O(n)$，偏口胡，具体实现应该有更多细节。

---


# Parallel Universes (Hard)

## 题目描述

Heidi 很喜欢进行模拟，因为她能准确地知道新宇宙何时、何地诞生，以及不存在的链接何时、何地断裂。

然而，多元宇宙本身的运行方式却充满神秘。实际上，它是基于概率运行的，而对某些人来说，这本身就很神秘。

在每个单位时间内，当做出决策时，将随机发生以下两种事件之一。设 $l$ 为当前多元宇宙的长度。以概率 $p_{create} = 1 - \frac{l}{m}$ 诞生一个新宇宙；以概率 $p_{break} = \frac{l}{m}$ 在某个位置断开一个不存在的链接。

更具体地说：

- 当诞生一个新宇宙时，它会出现在任意两个相邻宇宙之间，或在多元宇宙的两端。每个位置出现的概率均为 $\frac{1}{l+1}$。
- 当断开一个链接时，可以在任意两个相邻宇宙之间断开，每个位置断开的概率均为 $\frac{1}{l-1}$。断开后，多元宇宙被分为两段，不包含 Doctor 的那一段将消失。

与之前一样，Doctor 始终停留在同一个宇宙中。然而，如果某一时刻多元宇宙断裂，使得 Doctor 处于最左端或最右端，则 TARDIS 将停止工作。

在这种情况下，Doctor 必须亲自穿越多元宇宙，寻找修复工具。

我们关心的是，当上述事件发生时，多元宇宙长度的期望值。

## 说明/提示

对于第一和第二个测试点，在没有任何变化的情况下，Doctor 已经处于多元宇宙的某一端。

对于第三个测试点，多元宇宙只能在一个位置断裂，这会使 Doctor 处于某一端。

对于第四个测试点，情况似乎更复杂，因为多元宇宙可能会增长，然后再次断裂。

由 ChatGPT 4.1 翻译

## 样例 #1

### 输入

```
2 1 2
```

### 输出

```
2
```

## 样例 #2

### 输入

```
2 2 10
```

### 输出

```
2
```

## 样例 #3

### 输入

```
3 2 3
```

### 输出

```
2
```

## 样例 #4

### 输入

```
3 2 5
```

### 输出

```
941659828
```

## 样例 #5

### 输入

```
10 4 20
```

### 输出

```
196683114
```

# 题解

## 作者：Terminus_Est (赞：5)

### 【CF1184D2】Parallel Universes 解题报告

#### 题目大意

有一个人，刚开始有 $n$ 个宇宙，他在第 $k$ 个宇宙里，宇宙的最大数量不会超过 $m$。

设当前的宇宙总数为 $l$，则这个人有 $1-\dfrac{l}{m}$ 的概率在任意两个宇宙之间或者所有宇宙的两端插入一个新的宇宙，而每个位置插入宇宙的概率相等；还有 $\dfrac{l}{m}$ 的概率将这个宇宙序列划分为两部分，每个部分非空，然后去掉不包含自己的那一部分。

每当这个人发现自己处于最左端或者最右端的宇宙时，他就会结束这些操作。

求最后结束操作时宇宙的数量的期望，对 $10^9+7$ 取模。

$n,k,m\leq 250$。

#### Solution

首先特判，$k=1$ 和 $k=n$ 时，答案均为 $n$。

其次我们可以考虑设 $x_{i,j}$ 为初始情况下宇宙数量为 $i$，而这个人在第 $j$ 个宇宙的答案，那么不难用 $O(m^6)$ 的高斯消元求解，具体如下：

- 和特判类似地，$x_{i,1}=x_{i,i}=i$。
- 在宇宙 $j$ 后面插入一个新的宇宙。则此部分贡献应为 $(1-\dfrac{i}{m})\dfrac{i+1-j}{i+1}x_{i+1,j}$。
- 在宇宙 $j$ 前面插入一个新的宇宙，则此部分贡献应为 $(1-\dfrac{i}{m})\dfrac{j}{i+1}x_{i+1,j+1}$。
- 在宇宙 $j$ 后面进行一次划分，则此部分贡献应为 $\dfrac{i}{m(i-1)}x_{nxt,j},nxt∈[j,i-1]$。
- 在宇宙 $j$ 前面进行一次划分，则此部分贡献应为$\dfrac{i}{m(i-1)}x_{i-t,j-t},t∈[1,j-1]$。

这样我们就获得了一个愉快的 $O(m^6)$ 高斯消元。接下来考虑优化。

上面的式子大概可以写成：
$$
x_{i,j}=\dfrac{(m-i)(i+1-j)}{(i+1)m}x_{i+1,j}+\dfrac{(m-i)j}{m(i+1)}x_{i+1,j+1}+\dfrac{i}{m(i-1)}x_{[j,i-1],j}+\dfrac{i}{m(i-1)}x_{[i-j+1,i-1],[1,j-1]}
$$
移一下项：
$$
\dfrac{(m-i)j}{m(i+1)}x_{i+1,j+1}=-\dfrac{(m-i)(i+1-j)}{(i+1)m}x_{i+1,j}+x_{i,j}-\dfrac{i}{m(i-1)}x_{[j,i-1],j}-\dfrac{i}{m(i-1)}x_{[i-j+1,i-1],[1,j-1]}
$$
我们发现，每列（$j$ 相同）的数的转移其实是互不干扰的！于是，我们考虑按照 $j$ 递增的顺序，将每个数都用同一列的线性组合表示出来，然后高斯消元解一下方程即可（可以利用 $x_{m+1,k},k∈N^{+}$ 的系数为 $0$ 来做）。答案即为 $x_{n,k}$ 对应的线性组合算出来的值。

---

## 作者：Zxx200611 (赞：4)

写一篇题解纪念这道我调了一天的题。
### 简要题意
有一排长度为 $n$ 的棋子，一开始第 $k$ 个是红色的，其他都是蓝色的。棋子最多有 $m$ 个。

如果当前的棋子数为 $n'$，则有 $\frac{n'}{m}$ 的概率在总共 $n'-1$ 个空位中均匀随机一个，将棋子从这个空位断开并留下包含红色棋子的那一段。有 $1-\frac{n'}{m}$ 的概率在空位和最左的棋子左边，最右的棋子右边共 $n'+1$ 个位置中随机选择一个，在其中放上一个蓝色棋子。

当某个时刻满足红色棋子在最左边或最右边，操作结束。问操作结束时棋子数量的期望。

$1 \le n,k,m \le 250$。
### 题解
容易想到一个暴力 DP 做法：记 $f_{i,j}$ 表示共有 $i$ 个棋子，从左到右第 $j$ 个是红色这个状态的期望经过次数，则有如下的转移方程：

- 此次操作是断裂：
    - 在 $j$ 的两端断裂：$f_{i,j} \times \frac{i}{m} \times \frac{1}{i-1} \times (i+1) = f_{i,j} \times \frac{i(i+1)}{m(i-1)} \rightarrow \operatorname{Ans}$。
    - 在 $j$ 左边的第 $x$ 个位置断裂，满足 $x < j-1$：$f_{i,j} \times \frac{i}{m} \times \frac{1}{i-1} = f_{i,j} \times \frac{i}{m(i-1)} \rightarrow f_{i-x,j-x}$。
    - 在 $j$ 右边的第 $x$ 个位置断裂，满足 $x \ge j+1$：$f_{i,j} \times \frac{i}{m} \times \frac{1}{i-1} = f_{i,j} \times \frac{i}{m(i-1)} \rightarrow f_{x,j}$。
- 此次操作是添加：
    - 在 $j$ 的左边加入：$f_{i,j} \times (1-\frac{i}{m}) \times \frac{j}{i+1} = f_{i,j} \times \frac{j(m-i)}{m(i+1)} \rightarrow f_{i+1,j+1}$。
    - 在 $j$ 的右边加入：$f_{i,j} \times (1-\frac{i}{m}) \times \frac{i-j+1}{i+1} = f_{i,j} \times \frac{(i-j+1)(m-i)}{m(i+1)} \rightarrow f_{i+1,j}$。

这就是所有的转移情况了。还有初始条件 $f_{n,k} \leftarrow  1$。记横轴从左到右为 $i$，纵轴从上到下为 $j$，则绿色格子可以转移到蓝色格子的 $f$。灰色格子表示将要计入答案的格子。

![](https://cdn.luogu.com.cn/upload/image_hosting/3nyf6a9g.png)

不难发现这个东西转移有环，只能高斯消元，复杂度 $\mathcal{O}(n^6)$，无法通过。考虑是否可以移项然后主元法：
$$
\begin{aligned}
f_{i,j} = & 
[i=n,j=k] + \sum_{x=1}^{n-i} f_{i+x,j+x} \times \frac{i+x}{m(i+x-1)} + \sum_{x=1}^{n-i} f_{i+x,j} \times \frac{i+x}{m(i+x-1)} \\ 
& + f_{i-1,j} \times \frac{(i-j)(m-i+1)}{m \times i} + f_{i-1,j-1} \times \frac{(j-1)(m-i+1)}{m \times i}
\end{aligned}
$$
这样可以表示出 $f_{i-1,j-1}$。
$$
\begin{aligned}
f_{i-1,j-1} = & \left( f_{i,j} - [i=n,j=k] - \sum_{x=1}^{n-i} f_{i+x,j+x} \times \frac{i+x}{m(i+x-1)} - \sum_{x=1}^{n-i} f_{i+x,j} \times \frac{i+x}{m(i+x-1)} - f_{i-1,j} \times \frac{(i-j)(m-i+1)}{m \times i}  \right) \\
& \times \frac{m \times i}{(j-1)(m-i+1)}
\end{aligned}
$$
![](https://cdn.luogu.com.cn/upload/image_hosting/h0iey8no.png)

如图，橙色格子可以被绿色及蓝色格子表示出，使用绿色格子的方程。因此每个格子都可以被其下方的格子表示出。因此可以直接设主元递推。主元设置为最右方一列除去灰色格子以及左上角的格子即可，共 $m-2$ 个，即图中的粉色格子。最后使用最上方除去灰色格子和左上角的格子共 $m-2$ 个格子的方程解即可。

总时间复杂度 $\mathcal{O}(n^3)$，足以通过。

---


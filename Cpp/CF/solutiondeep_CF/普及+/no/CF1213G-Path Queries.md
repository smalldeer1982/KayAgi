# 题目信息

# Path Queries

## 题目描述

$\mathsf E \color{red}\mathsf{ntropyIncreaser}$ 有一棵 $n$ 个点的树，每条边都带权。  

她会问你 $m$ 个问题，每次给你一个正整数 $q$，求最大权值不大于 $q$ 的简单路径数量。  

需要注意的是，对于一个点对 $(u,v)$ 只记一次，单独一个点不算路径。

接下来 $n-1$ 行，每行三个正整数 $u,v,w$，表示 $u,v$ 之间有一条权为 $w$ 的无向边。  
最后一行 $m$ 个正整数，表示询问。

## 说明/提示

$1\le n,m \le 2\times10^5$  
$1\le u,v \le n$  
$1\le w,q \le 2\times 10^5$

## 样例 #1

### 输入

```
7 5
1 2 1
3 2 3
2 4 1
4 5 2
5 7 4
3 6 2
5 2 3 4 1
```

### 输出

```
21 7 15 21 3 
```

## 样例 #2

### 输入

```
1 2
1 2
```

### 输出

```
0 0 
```

## 样例 #3

### 输入

```
3 3
1 2 1
2 3 2
1 3 2
```

### 输出

```
1 3 3 
```

# AI分析结果

### 题目标签
并查集

### 综合分析与结论
这些题解主要围绕如何计算带权树中最大权值不大于给定值 $q$ 的简单路径数量展开。大部分题解采用并查集算法，先将边按权值排序，再通过并查集合并连通块来计算路径数量，最后利用前缀和得到最终答案；部分题解使用点分治或 Kruskal 重构树的方法。

### 所选题解
- **作者：lottle1212 (赞：23)，4星**
    - **关键亮点**：思路清晰，代码简洁，详细阐述了并查集和前缀和的使用方法，时间复杂度分析明确。
- **作者：xuyiyang (赞：10)，4星**
    - **关键亮点**：对并查集维护树上路径的原理讲解清晰，代码规范，时间复杂度分析准确。
- **作者：Vanilla_chan (赞：2)，4星**
    - **关键亮点**：提供了离线和在线两种做法，对两种做法的思路和实现细节都有详细说明。

### 重点代码
#### lottle1212 的代码
```cpp
for(int i = 1; i < n; ++ i) {
    fx = get_fa(e[i].u), fy = get_fa(e[i].v);
    ans[e[i].w] += (ll) sz[fx] * sz[fy];
    f[fx] = fy, sz[fy] += sz[fx];
}
for(int i = 1; i <= mxn; ++ i) ans[i] += ans[i - 1];
```
**核心实现思想**：先将边按权值排序，然后枚举每条边，计算该边作为最大边权时的路径贡献，合并连通块；最后对 `ans` 数组求前缀和得到最终答案。

#### xuyiyang 的代码
```cpp
for (int i = 1; i < n; i ++ )
{
    int pa = find(e[i].a), pb = find(e[i].b);
    cnt[e[i].w] += (LL)Size[pa] * Size[pb];
    p[pa] = pb;
    Size[pb] += Size[pa];
}
for (int i = 1; i < N; i ++ ) cnt[i] += cnt[i - 1];
```
**核心实现思想**：同样先排序边，枚举边计算贡献并合并连通块，最后求前缀和。

#### Vanilla_chan 的离线代码
```cpp
for(int i=1;i<=m;i++)
{
    while(top<n&&e[top].z<=ask[i].q) merge(e[top].x,e[top].y),top++;
    ans[ask[i].id]=S;
}
```
**核心实现思想**：将询问和边排序，对于每个询问，不断加入边权小于等于该询问值的边，更新答案。

### 最优关键思路或技巧
- **排序与并查集结合**：将边按权值排序，利用并查集动态维护连通块，计算路径贡献，这种方法能有效降低时间复杂度。
- **前缀和优化**：先计算每个权值对应的路径数量，再通过前缀和得到最大权值不大于 $q$ 的路径数量，避免重复计算。

### 拓展思路
同类型题或类似算法套路：
- 处理树上路径相关问题时，可考虑使用并查集、点分治、Kruskal 重构树等算法。
- 对于离线询问问题，可将询问和数据排序后统一处理。

### 推荐题目
- [P1196 [NOI2002] 银河英雄传说](https://www.luogu.com.cn/problem/P1196)
- [P1525 [NOIP2010 提高组] 关押罪犯](https://www.luogu.com.cn/problem/P1525)
- [P4185 [USACO18JAN]MooTube G](https://www.luogu.com.cn/problem/P4185)

### 个人心得摘录
- **GalwayGirl**：两个连通块节点相乘时会溢出，要转成 `long long`，WA 了四五次才发现。
**总结**：在处理涉及乘法运算且结果可能较大的问题时，要注意数据类型的选择，避免溢出导致错误。 

---
处理用时：31.24秒
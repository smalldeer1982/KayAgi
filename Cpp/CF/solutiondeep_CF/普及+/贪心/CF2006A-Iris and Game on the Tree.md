# 题目信息

# Iris and Game on the Tree

## 题目描述

给定一棵根为 $1$，每个点有 $0$ 或 $1$ 的点权的有根树，对于所有叶子定义权值为：取出根到它的路径上所有点的点权形成的 $01$ 串，其中 $10$ 子串的出现次数减去 $01$ 子串的出现次数。不认为根为叶子。

![](https://cdn.luogu.com.cn/upload/vjudge_pic/CF2006A/66d8f9cca162bbc9b7dcbbd0c66de4a705cfbe4e.png)

如图，绿点的点权为 $1$，白点的点权为 $0$，根到 $5$ 的串为 $10110$，其中有 $2$ 个 $10$，$1$ 个 $01$，故 $5$ 的权值为 $1$。

一棵树的分数被定义为：具有非零权值的叶子的数量。

有些点权尚未确定，A 与 B 在玩游戏，她们轮流将一个未确定点的点权改为 $0$ 或 $1$。先手的 A 希望最大化树的分数，后手的 B 希望最小化之，二人均采取最优策略，求最后树的分数。

## 说明/提示

$1 \leq t \leq 5 \cdot 10^4$，$2 \leq \sum n \leq 2 \cdot 10^5$。

translated by uid 443664

## 样例 #1

### 输入

```
6
4
1 2
1 3
4 1
0101
4
1 2
3 2
2 4
???0
5
1 2
1 3
2 4
2 5
?1?01
6
1 2
2 3
3 4
5 3
3 6
?0????
5
1 2
1 3
1 4
1 5
11?1?
2
2 1
??```

### 输出

```
2
1
1
2
1
0```

# AI分析结果



### 题目内容中文重写

#### 题目描述

给定一棵根为1，每个节点权值为0或1的有根树。对于所有叶子节点，定义其权值为：从根到该叶子路径上的所有节点权值组成的01串中，子串"10"出现次数减去"01"出现次数。根节点不被视为叶子。

当存在未确定权值的节点（用'?'表示）时，A和B两人轮流将未确定节点赋值为0或1。先手A希望最大化树的分数（即权值非零的叶子数量），后手B希望最小化之。双方均采取最优策略，求最终树的分数。

#### 输入格式
多组测试数据。每组数据给出树的结构及节点初始状态。

#### 输出格式
每组数据输出最终分数。

### 题解分析与结论

#### 关键思路
1. **权值计算简化**：发现叶子权值非零当且仅当叶子颜色与根节点颜色不同。这使得问题转化为统计与根颜色不同的叶子数量。
2. **博弈策略**：
   - 根已确定时，未确定叶子由双方交替选择相反/相同颜色，结果取决于问号数量。
   - 根未确定时，A优先选择使现有叶子更优的颜色，中间节点的处理顺序影响后续博弈主动权。
3. **分类讨论**：根据根是否确定分情况统计，并考虑中间节点数量对博弈顺序的影响。

#### 最优题解

##### 题解作者：I_wish_AK_IOI（4星）
**亮点**：
- 将复杂权值计算转化为颜色比较问题，极大简化模型。
- 通过分类讨论处理根确定/未确定两种核心场景。
- 引入中间节点计数解决博弈顺序问题。

**代码核心**：
```cpp
void solve() {
  // 统计各类型节点数量
  if (根已确定) {
    // 直接计算相反颜色叶子数及问号博弈结果
    ans = 相反颜色数 + (问号数+1)/2; 
  } else {
    if (叶子颜色数相等) {
      // 中间节点奇偶性影响博弈顺序
      ans = max(颜色数) + (问号数 + 中间节点奇偶)/2;
    } else {
      ans = max(颜色数) + 问号数/2;
    }
  }
}
```

### 关键技巧总结
1. **博弈模型简化**：将问题转化为二元选择问题（颜色是否相同）。
2. **主动权计算**：通过中间节点数量奇偶性判断后续博弈的先后手。
3. **分类讨论优化**：针对根节点是否确定设计不同计算策略。

### 相似题目推荐
1. [CF917D Stranger Trees](https://www.luogu.com.cn/problem/CF917D)（博弈树构造）
2. [P4649 [IOI2000] 邮局](https://www.luogu.com.cn/problem/P4649)（树形博弈决策）
3. [P2585 三色二叉树](https://www.luogu.com.cn/problem/P2585)（树结构博弈策略）

---
处理用时：117.65秒
# 题目信息

# She knows...

## 题目描述

D. Pippy 正在为家中的"黑白派对"做准备。他只需要重新粉刷地下室的 floor，该 floor 可表示为 $n \times m$ 的棋盘。

在上次派对后，整个棋盘除 $k$ 个单元格 $(x_1, y_1), (x_2, y_2), \ldots, (x_k, y_k)$ 外均被涂成绿色，这些单元格已被涂成白色或黑色。为了即将到来的派对，D. Pippy 想要将剩余的绿色单元格涂成黑色或白色。同时，他要求重新粉刷后棋盘上相邻颜色不同的单元格对数量为偶数。

形式化地，若定义集合：
$$A = \left\{((i_1, j_1), (i_2, j_2)) \ | \ 1 \le i_1, i_2 \le n, 1 \le j_1, j_2 \le m, i_1+j_1 < i_2+j_2, |i_1-i_2|+|j_1-j_2| = 1, \operatorname{color}(i_1, j_1) \neq \operatorname{color}(i_2, j_2) \right\},$$
其中 $\operatorname{color}(x, y)$ 表示单元格 $(x, y)$ 的颜色，则要求 $|A|$ 为偶数。

请帮助 D. Pippy 计算满足条件的粉刷方案数。由于答案可能很大，请输出其对 $10^9 + 7$ 取模的结果。

## 说明/提示

第一个测试案例中，绿色单元格 $(2, 1), (2, 2), (2, 3)$ 共有 $4$ 种合法涂色方案，分别为：$(1, 1, 0)$，$(0, 0, 1)$，$(1, 0, 0)$，$(0, 1, 1)$（颜色按单元格顺序排列），如下图所示。

![](https://cdn.luogu.com.cn/upload/vjudge_pic/CF2092E/0ff35e90f545116ecc7d2fbe2de16f35bcaedb89.png)  
第二个测试案例中，棋盘已全部涂色且相邻异色对数量为奇数，因此答案为 $0$。

翻译由 DeepSeek R1 完成

## 样例 #1

### 输入

```
2
3 3 6
1 1 0
1 2 1
1 3 0
3 1 1
3 2 0
3 3 1
3 4 12
1 1 0
1 2 1
1 3 0
1 4 1
2 1 1
2 2 0
2 3 1
2 4 0
3 1 0
3 2 1
3 3 0
3 4 1```

### 输出

```
4
0```

# AI分析结果



---

### **唯一算法分类**
组合数学与奇偶性分析

---

### **题解思路与算法要点**

1. **核心思路**  
   - **关键观察**：相邻异色对数的奇偶性仅由棋盘边（非角）的格子颜色决定。每个边格（非角）影响奇数个相邻对，改变颜色会翻转总奇偶性。
   - **数学推导**：设边格总数为 `S = 2*(n + m -4)`，已涂边格数目为 `cnt`，其颜色和为 `sum`。若 `cnt < S`，剩余边格可通过调整奇偶性，方案数为 `2^(总未涂数-1)`；若 `cnt == S`，则需 `sum` 为偶数才能满足条件。

2. **解决难点**  
   - **边格判定**：判断格子是否位于边（非角），需排除四个角落。
   - **快速幂计算**：利用快速幂计算 `2^power % MOD`，处理大指数。

3. **对比题解**  
   - **chenxi2009**：代码简洁，直接统计边格数目与颜色和，逻辑清晰。
   - **linjunye**：通过异或操作简化奇偶性判断，代码高效。
   - **WaterSun**：将边格贡献次数与奇偶性结合，推导严谨。

---

### **题解评分 (≥4星)**

1. **chenxi2009（5星）**  
   - 思路清晰，代码简洁，直接命中核心条件判断。
   - **代码亮点**：通过 `crn` 变量高效判断边格，异或累加颜色和。

2. **linjunye（4星）**  
   - 异或视角独特，数学推导严谨。
   - **代码亮点**：利用异或性质简化奇偶性计算。

3. **WaterSun（4星）**  
   - 贡献次数分析透彻，分类讨论完整。
   - **代码亮点**：通过 `cnt1` 和 `cnt2` 统计边格信息，逻辑明确。

---

### **最优思路提炼**

1. **奇偶性关键点**  
   - 边格（非角）颜色改变会翻转总异色对数奇偶性，其余格子不影响奇偶性。
   - 总方案数取决于边格是否全涂色及其颜色和的奇偶性。

2. **快速幂优化**  
   - 使用快速幂计算 `2^k % MOD`，时间复杂度 `O(log k)`。

3. **代码实现技巧**  
   - **边格判定**：通过坐标是否为边界且非角落判断。
   - **颜色和统计**：用异或或模2累加，避免大数运算。

---

### **同类型题推荐**

1. **CF1352G Special Permutation**  
   - 奇偶性构造，类似边格影响整体条件。

2. **LeetCode 1595. Minimum Cost to Connect Two Groups of Points**  
   - 奇偶性与组合数学结合的问题。

3. **洛谷 P3919 棋盘覆盖**  
   - 利用奇偶性分析解决棋盘覆盖问题。

---

### **可视化与算法演示**

1. **核心算法动画**  
   - **棋盘绘制**：用网格表示棋盘，边格（非角）高亮为黄色。
   - **动态更新**：点击边格切换颜色，实时显示总异色对数奇偶性。
   - **关键步骤**：  
     - 初始全白棋盘，异色对数为偶。
     - 切换边格颜色，奇偶性翻转。
     - 切换非边格颜色，奇偶性不变。

2. **复古像素风格**  
   - **颜色方案**：边格黄色，角落灰色，其他格子绿色。
   - **音效设计**：切换颜色时播放8-bit音效，成功/失败时播放不同音调。

3. **交互设计**  
   - **参数调节**：允许输入 `n, m, k` 生成新棋盘。
   - **自动演示**：AI自动涂色并验证条件，展示合法方案。

---

### **代码实现（核心片段）**

```cpp
#include<bits/stdc++.h>
using namespace std;
const int MOD = 1e9+7;

long long qpow(long long b, int e) {
    long long res = 1;
    while (e) {
        if (e & 1) res = res * b % MOD;
        b = b * b % MOD;
        e >>= 1;
    }
    return res;
}

int main() {
    int T; cin >> T;
    while (T--) {
        int n, m, k; 
        cin >> n >> m >> k;
        int edge_total = 2 * (n + m - 4);
        int cnt = 0, sum = 0;
        
        for (int i = 0; i < k; i++) {
            int x, y, c;
            cin >> x >> y >> c;
            bool is_edge = false;
            if ((x == 1 || x == n) && (y != 1 && y != m)) is_edge = true;
            if ((y == 1 || y == m) && (x != 1 && x != n)) is_edge = true;
            
            if (is_edge) {
                cnt++;
                sum ^= c; // 异或统计奇偶性
            }
        }
        
        long long ans;
        if (cnt < edge_total) {
            ans = qpow(2, n * m - k - 1);
        } else {
            ans = (sum % 2 == 0) ? qpow(2, n * m - k) : 0;
        }
        cout << ans << endl;
    }
    return 0;
}
```

---

### **个人心得摘录**

- **chenxi2009**：意识到边格贡献的奇偶性是关键，通过简单变量统计避免复杂计算。
- **linjunye**：异或视角简化奇偶性分析，调试时验证多个小样例确保逻辑正确。
- **WaterSun**：贡献次数的奇偶性分析是突破口，需注意边格与角落的区别。

---

### **复古游戏化动画设计**

1. **Canvas绘制**  
   - 绘制 `n x m` 网格，边格高亮，点击切换颜色（黑/白）。

2. **音效触发**  
   - 切换颜色：短促“哔”声。
   - 合法方案：播放胜利音效（上升音阶）。
   - 非法方案：播放错误音效（下降音阶）。

3. **自动演示模式**  
   - AI随机涂色，动态调整最后一个边格颜色以满足奇偶性条件。

---

**可视化示例**：  
![边格影响奇偶性](https://cdn.luogu.com.cn/upload/image_hosting/4be51hv2.png)  
（黄色为边格，其颜色决定总奇偶性）

---
处理用时：100.33秒
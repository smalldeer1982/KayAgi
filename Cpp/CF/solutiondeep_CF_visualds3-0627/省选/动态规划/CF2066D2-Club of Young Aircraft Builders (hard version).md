# 题目信息

# Club of Young Aircraft Builders (hard version)

## 题目描述

这是该问题的困难版本。各版本间的区别在于此版本中不要求所有 $a_i = 0$。只有当您解决了该问题的所有版本时才能进行 hack。

有一栋 $n$ 层的建筑物，楼层从下到上编号为 $1$ 至 $n$。每层恰好住着一位居民。

今天全体居民有一个重要目标：共同发射至少 $c$ 架纸飞机。居民们将依次发射飞机。当第 $i$ 层的居民发射一架飞机时，从第 $1$ 层到第 $i$ 层的所有居民都能看到它降落到地面的过程。如果从第 $i$ 层居民的视角看，已有至少 $c$ 架飞机被发射，则该居民自己不会再发射更多飞机。已知到当天结束时，从每位居民的视角看至少发射了 $c$ 架飞机，且总共发射了 $m$ 架飞机。

您仔细记录了这次快闪活动，记录了每架飞机的发射者所在楼层。遗憾的是，关于部分飞机的具体发射者信息已经丢失。请找出填补空缺信息使其可信的方案数。由于答案可能很大，请输出其对 $10^9 + 7$ 取模的结果。

也可能您的记录存在错误，导致无法恢复任何有效信息。此时答案视为 $0$。

## 说明/提示

第一个测试样例中，所有六种可能的填补方案如下：
1. $[1, 1, 3, 3]$
2. $[1, 2, 3, 3]$
3. $[1, 3, 2, 3]$
4. $[2, 1, 3, 3]$
5. $[2, 2, 3, 3]$
6. $[3, 1, 2, 3]$

注意数组 $[2, 3, 1, 3]$ 不是有效方案，因为第三架飞机不可能由第 $1$ 层的居民发射——从他们的视角看，当时已有 $c = 2$ 架飞机被发射。

同样地，数组 $[1, 1, 2, 3]$ 也不是有效方案，因为从第 $3$ 层居民的视角看，仅发射了 $1$ 架飞机，而 $c = 2$。

翻译由 DeepSeek R1 完成

## 样例 #1

### 输入

```
8
3 2 4
0 0 0 0
5 5 7
0 0 0 0 0 0 0
6 1 3
2 0 0
2 3 5
0 0 1 0 2
3 3 4
3 3 3 0
2 1 2
0 1
2 1 2
0 2
5 3 12
0 0 1 0 2 4 0 0 0 5 0 5```

### 输出

```
6
190
3
2
0
0
1
14```

# AI分析结果



**算法分类**  
动态规划

---

**题解思路与难点分析**  
题目要求构造满足多层限制条件的序列。核心难点在于如何将动态的飞机发射顺序转化为静态的位置约束条件，并处理部分位置已确定的场景。

两位题解作者均采用动态规划，但处理顺序不同：  
1. **ForgotMe** 的思路是从低到高层逐层处理，状态 `dp[i][j]` 表示处理到第i层，总出现次数为j的方案数。转移时枚举下一层的出现次数，通过组合数计算合法位置的填充方式。  
2. **lfxxx** 的代码实现从高到低处理，利用预处理的位置信息动态调整限制条件，通过逆向处理保证高层位置对低层的约束先被满足。

**关键共性**：  
- 将每层最大出现位置限制转化为 `pos_i ≤ c + 前置层出现次数总和`  
- 使用组合数学计算合法填充方案数  
- 预处理已确定位置的最大值，并在转移时校验合法性

---

**题解评分 (≥4星)**  
1. **ForgotMe 题解 (★★★★☆)**  
   - 思路清晰度：明确归纳充要条件，状态转移设计合理  
   - 算法创新性：通过组合数简化复杂的位置约束计算  
   - 实现难点：需要处理已确定位置的覆盖检查  

2. **lfxxx 题解 (★★★★☆)**  
   - 代码完备性：完整处理预填位置的最大值约束  
   - 逆向思维：从高到低处理层数，自然满足高层对低层的约束  
   - 可读性：需结合详细注释理解状态转移逻辑  

---

**最优思路提炼**  
1. **层间约束建模**：每层i的出现位置最大值需满足 `pos_i ≤ c + ∑cnt[1..i-1]`  
2. **逆向DP设计**：从高到低处理层数，优先满足高层的位置限制  
3. **组合填充计算**：对每层合法位置区间内的空白位置，用组合数计算填充方式  
4. **预填校验**：对已确定位置的最大值进行约束校验，非法则剪枝

---

**同类型题目**  
- 涉及多层约束的计数问题（如 [CF1392H](https://codeforces.com/problemset/problem/1392/H)）  
- 带有预填条件的组合计数（如 [洛谷P3773](https://www.luogu.com.cn/problem/P3773)）

---

**推荐相似题目**  
1. [洛谷P3223](https://www.luogu.com.cn/problem/P3223) - 排队计数（组合约束）  
2. [CF1187E](https://codeforces.com/problemset/problem/1187/E) - 树形DP与组合计数  
3. [洛谷P4099](https://www.luogu.com.cn/problem/P4099) - 带限制的树形结构计数  

---

**代码片段解析**  
lfxxx 题解核心转移逻辑：  
```cpp
for(int i=n-1;i>=1;i--){
    for(int j=0;j<=M;j++){
        // 枚举当前空位填充数k
        for(int k=c;k>=1;k--){ 
            // 动态计算最大允许填充位置lim
            while(lim+1<=j && ...) lim++;
            if(lim!=-1 && j+k<=M)
                g[j+k] += dp[j] * C(lim, k-1);
        }
    }
    // 处理预填位置的约束
    if(mx[i]!=0){
        for(int j=0;j<=M;j++)
            if(预填位置违反约束) dp[j]=0;
    }
}
```

---

**可视化设计**  
**8-bit动画方案**：  
1. **网格展示**：以纵向楼层为轴，横向时间轴显示飞机发射序列  
2. **动态高亮**：  
   - 红色方块：当前处理的层数i  
   - 绿色闪烁：合法填充区间 `1..c+∑pre`  
   - 黄色标记：已预填的不可变位置  
3. **音效设计**：  
   - 填充成功：短促 "哔" 声  
   - 约束冲突：低沉 "嗡" 声  
4. **自动演示模式**：以贪吃蛇AI方式逐步展开各层填充过程

**状态面板**：  
- 当前处理层数  
- 剩余可填充空位  
- 各层出现次数统计  
- 组合数计算结果实时显示

---

**总结**  
通过逆向动态规划与组合数学的精妙结合，将复杂的多层约束转化为可计算的组合填充问题。预处理位置最大值与动态调整填充区间是算法的核心亮点。

---
处理用时：207.78秒
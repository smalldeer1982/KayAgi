# 题目信息

# Game of AI (easy version)

## 题目描述

这是本题的简单版本。简单版本与困难版本的区别在于对 $k$ 的约束和时间限制。此外，在本版本中，你只需要计算 $n=k$ 时的答案。只有当两个版本均被解决时，你才能进行 hack。

Cirno 正在玩一款战争模拟游戏，其中有 $n$ 座塔（编号为 $1$ 至 $n$）和 $n$ 个机器人（编号为 $1$ 至 $n$）。初始时，第 $i$ 座塔被第 $i$ 个机器人占据（$1 \le i \le n$）。

在游戏开始前，Cirno 首先选择一个长度为 $n$ 的排列 $p = [p_1, p_2, \ldots, p_n]$（一个长度为 $n$ 的排列是指每个 $1$ 到 $n$ 的整数恰好出现一次的数组）。接着，她选择一个序列 $a = [a_1, a_2, \ldots, a_n]$（满足 $1 \le a_i \le n$ 且 $a_i \ne i$ 对所有 $1 \le i \le n$ 成立）。

游戏包含 $n$ 轮攻击。在第 $i$ 轮中，如果第 $p_i$ 个机器人仍在游戏中，它将发起攻击，导致第 $a_{p_i}$ 座塔被第 $p_i$ 个机器人占据；原本占据第 $a_{p_i}$ 座塔的机器人将失去该塔。如果第 $p_i$ 个机器人已不在游戏中，此轮不会发生任何事。

每轮结束后，如果一个机器人未占据任何塔，它将被淘汰并退出游戏。注意一座塔不能同时被多个机器人占据，但一个机器人可以在游戏中占据多座塔。

游戏结束时，Cirno 将记录结果序列 $b = [b_1, b_2, \ldots, b_n]$，其中 $b_i$ 表示结束时占据第 $i$ 座塔的机器人编号。

然而，作为数学大师，她希望你解决以下计数问题而非亲自游戏：

计算所有可能的序列 $a$ 和排列 $p$ 能生成的不同序列对 $(a, b)$ 的数量。

由于结果可能很大，请输出其对 $M$ 取模后的值。

## 说明/提示

当 $n=1$ 时，不存在合法的序列 $a$，因此答案为 $0$。

当 $n=2$ 时，唯一可能的数组 $a$ 是 $[2, 1]$：
- 当 $a$ 为 $[2, 1]$ 且 $p$ 为 $[1, 2]$ 时，最终序列 $b$ 为 $[1, 1]$。具体过程：
  - 第一轮，第一个机器人发起攻击并占领第 $2$ 座塔。此轮结束后，第二个机器人因失去所有塔而被淘汰。
  - 第二轮，第二个机器人已不在游戏中。
- 当 $a$ 为 $[2, 1]$ 且 $p$ 为 $[2, 1]$ 时，最终序列 $b$ 为 $[2, 2]$。具体过程：
  - 第一轮，第二个机器人发起攻击并占领第 $1$ 座塔。此轮结束后，第一个机器人被淘汰。
  - 第二轮，第一个机器人已不在游戏中。

因此当 $n=2$ 时，不同的序列对 $(a, b)$ 的数量为 $2$（即 $([2, 1], [1, 1])$ 和 $([2, 1], [2, 2])$）。

翻译由 DeepSeek R1 完成

## 样例 #1

### 输入

```
1 998244353```

### 输出

```
0```

## 样例 #2

### 输入

```
2 998244353```

### 输出

```
2```

## 样例 #3

### 输入

```
3 998244353```

### 输出

```
24```

## 样例 #4

### 输入

```
8 998244353```

### 输出

```
123391016```

# AI分析结果



---

## 唯一算法分类
**组合数学**

---

## 题解思路与算法分析

### 核心思路
题目要求计算所有可能的 $(a, b)$ 对数，其中 $a$ 是攻击序列，$b$ 是最终占据结果。通过分析攻击流程，发现最终的 $b$ 序列对应的结构必须是由若干条链组成的森林，链尾节点满足 $b_i = i$，且链中每个节点的 $a$ 值被唯一确定。关键问题转化为对链结构和孤立点的组合计数。

### 算法要点
1. **链结构分析**  
   - 若 $b_i \neq i$，则必须存在 $a_{b_i} = i$，形成链式结构。
   - 链的末尾节点必须满足 $b_i = i$，否则会导致矛盾或环。
2. **组合计数**  
   - 孤立点的 $a$ 不能指向其他链的尾部。
   - 链头节点的 $a$ 可以自由选择（除自身外），链内部节点的 $a$ 被唯一确定。
3. **数学公式**  
   - 枚举链的数量 $i$ 和孤立点数量 $j$，计算组合数 $\binom{n}{j}$ 选择孤立点。
   - 剩余节点组成 $i$ 条链，每条链头有 $(n-1)$ 种可能的 $a$。
   - 孤立点的 $a$ 有 $(n-i-j)$ 种选择（排除自身和链尾）。

### 解决难点
- **避免环的形成**：通过链结构保证攻击顺序可执行。
- **孤立点约束**：孤立点的选择需独立于链尾，防止非法攻击。
- **组合公式推导**：利用阶乘、幂次和组合数高效计算所有可能情况。

---

## 最优思路提炼
1. **链式结构模型**：将问题转化为链的组合问题，避免环的不合法情况。
2. **预计算优化**：通过阶乘、逆元、幂次数组预计算加速组合数运算。
3. **枚举策略**：分治孤立点和链的数量，组合各部分的贡献。

---

## 题解评分（≥4星）
1. **作者：tanyulin（5星）**  
   - **亮点**：代码简洁，组合公式推导清晰，预计算优化显著。
2. **作者：tzc_wk（4星）**  
   - **亮点**：详细分析链与孤立点的约束关系，提供扩展思路。

---

## 代码核心逻辑

```cpp
#include<bits/stdc++.h>
using namespace std;
const int N=5010;
int fac[N], infac[N], mi[N][N], n, mod, ans;

void init() {
    fac[0] = 1;
    for(int i=1; i<N; i++) fac[i] = 1ll * fac[i-1] * i % mod;
    infac[N-1] = qmi(fac[N-1], mod-2);
    for(int i=N-2; i>=0; i--) infac[i] = 1ll * infac[i+1] * (i+1) % mod;
    // 预计算幂次数组 mi[i][j] = i^j % mod
    for(int i=1; i<N; i++) {
        mi[i][0] = 1;
        for(int j=1; j<N; j++)
            mi[i][j] = 1ll * mi[i][j-1] * i % mod;
    }
}

int main() {
    cin >> n >> mod;
    init();
    for(int i=1; i*2 <=n; i++) // 枚举链的数量 i
        for(int j=0; j+i*2 <=n; j++) { // 枚举孤立点数量 j
            int term = 1;
            term = 1ll * term * binom(n, j) % mod; // 选 j 个孤立点
            term = 1ll * term * fac[n-j] % mod;    // 排列剩余节点
            term = 1ll * term * mi[n-1][i] % mod;  // 链头的 a 选择
            term = 1ll * term * mi[n-i-j][j] % mod;// 孤立点的 a 选择
            term = 1ll * term * binom(n-i-j-1, i-1) % mod; // 划分链
            term = 1ll * term * infac[i] % mod;    // 消除链顺序重复
            ans = (ans + term) % mod;
        }
    cout << ans << endl;
}
```

---

## 可视化设计

### 动画方案
1. **链结构生成**  
   - **颜色标记**：链头（红色）、链中节点（蓝色）、孤立点（绿色）。
   - **动态绘制**：逐步连接节点形成链，高亮当前处理的节点。

2. **攻击流程演示**  
   - **步进控制**：按攻击轮次逐步显示机器人行动。
   - **音效触发**：攻击成功时播放短音效，淘汰时播放低沉音效。

3. **复古像素风格**  
   - **8位调色板**：使用经典红、蓝、绿、黄像素块表示不同状态。
   - **Canvas 网格**：塔和机器人以网格形式排列，攻击动画用箭头表示。

### 交互功能
- **参数调节**：支持输入 $n$ 和 $mod$，实时计算并展示结果。
- **自动模式**：AI 自动枚举链和孤立点组合，显示贡献计算过程。

---

## 同类型题目推荐
1. **P2181 组合数问题**  
2. **P2822 组合数问题（加强版）**  
3. **P1350 车的放置（组合计数）**  

---

## 个人心得
- **调试关键**：验证预计算数组的准确性，特别是逆元和组合数部分。
- **思维突破**：将攻击流程抽象为链结构，避免复杂的状态转移分析。

---
处理用时：93.57秒
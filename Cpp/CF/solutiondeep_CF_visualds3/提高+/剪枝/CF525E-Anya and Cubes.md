# é¢˜ç›®ä¿¡æ¯

# Anya and Cubes

## é¢˜ç›®æè¿°

Anya loves to fold and stick. Today she decided to do just that.

Anya has $ n $ cubes lying in a line and numbered from $ 1 $ to $ n $ from left to right, with natural numbers written on them. She also has $ k $ stickers with exclamation marks. We know that the number of stickers does not exceed the number of cubes.

Anya can stick an exclamation mark on the cube and get the factorial of the number written on the cube. For example, if a cube reads $ 5 $, then after the sticking it reads $ 5! $, which equals $ 120 $.

You need to help Anya count how many ways there are to choose some of the cubes and stick on some of the chosen cubes at most $ k $ exclamation marks so that the sum of the numbers written on the chosen cubes after the sticking becomes equal to $ S $. Anya can stick at most one exclamation mark on each cube. Can you do it?

Two ways are considered the same if they have the same set of chosen cubes and the same set of cubes with exclamation marks.

## è¯´æ˜/æç¤º

In the first sample the only way is to choose both cubes and stick an exclamation mark on each of them.

In the second sample the only way is to choose both cubes but don't stick an exclamation mark on any of them.

In the third sample it is possible to choose any of the cubes in three ways, and also we may choose to stick or not to stick the exclamation mark on it. So, the total number of ways is six.

## æ ·ä¾‹ #1

### è¾“å…¥

```
2 2 30
4 3
```

### è¾“å‡º

```
1
```

## æ ·ä¾‹ #2

### è¾“å…¥

```
2 2 7
4 3
```

### è¾“å‡º

```
1
```

## æ ·ä¾‹ #3

### è¾“å…¥

```
3 1 1
1 1 1
```

### è¾“å‡º

```
6
```

# AIåˆ†æç»“æœ


### ğŸ’¡ Kayçš„C++ç®—æ³•è§£æï¼šAnya and Cubes æ·±å…¥å­¦ä¹ æŒ‡å— ğŸ’¡

**å¼•è¨€**  
ä»Šå¤©æˆ‘ä»¬æ¥åˆ†æã€ŒAnya and Cubesã€è¿™é“æŠ˜åŠæœç´¢ç»å…¸é¢˜ã€‚æœ¬æŒ‡å—å°†å¸®åŠ©ä½ æŒæ¡é«˜æ•ˆè§£é¢˜æŠ€å·§ï¼Œå¹¶é€šè¿‡åƒç´ åŠ¨ç”»ç›´è§‚ç†è§£ç®—æ³•è¿‡ç¨‹ã€‚è®©æˆ‘ä»¬å¼€å§‹å§ï¼

---

### 1. é¢˜ç›®è§£è¯»ä¸æ ¸å¿ƒç®—æ³•è¯†åˆ«  
âœ¨ **æœ¬é¢˜ä¸»è¦è€ƒå¯Ÿ**ï¼šæŠ˜åŠæœç´¢ï¼ˆMeet in the Middleï¼‰  

ğŸ—£ï¸ **åˆæ­¥åˆ†æ**  
> æŠ˜åŠæœç´¢å¦‚åŒåˆ†å…µä¸¤è·¯çš„æ¢é™©é˜Ÿï¼šå°†é—®é¢˜åˆ†æˆä¸¤åŠå„è‡ªæ¢ç´¢ï¼Œæœ€åæ±‡åˆç»“æœã€‚åœ¨æœ¬é¢˜ä¸­ï¼Œæ¯ä¸ªç«‹æ–¹ä½“æœ‰3ç§çŠ¶æ€ï¼ˆä¸é€‰/é€‰/é€‰å¹¶é˜¶ä¹˜ï¼‰ï¼Œç›´æ¥æœç´¢çš„å¤æ‚åº¦é«˜è¾¾ O(3Â²â¶)ã€‚æŠ˜åŠæœç´¢å°†åºåˆ—å¹³åˆ†ï¼Œå¤æ‚åº¦é™è‡³ O(3Â¹Â³)ï¼Œå®Œç¾è§£å†³ï¼  
> - **æ ¸å¿ƒéš¾ç‚¹**ï¼šçŠ¶æ€åˆå¹¶æ—¶éœ€ç¡®ä¿é˜¶ä¹˜æ€»æ•°â‰¤kä¸”å’Œ=Sï¼Œé˜¶ä¹˜å€¼å·¨å¤§ï¼ˆ19! >10Â¹â¶ï¼‰éœ€ç‰¹æ®Šå¤„ç†  
> - **å¯è§†åŒ–è®¾è®¡**ï¼šç”¨åƒç´ ç½‘æ ¼å±•ç¤ºæœç´¢è¿‡ç¨‹ï¼Œå·¦ä¾§æ˜¾ç¤ºå‰åŠéƒ¨çŠ¶æ€ï¼ˆè“è‰²åŒºå—ï¼‰ï¼Œå³ä¾§æ˜¾ç¤ºååŠéƒ¨ï¼ˆç»¿è‰²ï¼‰ï¼ŒåŒ¹é…æˆåŠŸæ—¶è§¦å‘é‡‘è‰²é—ªå…‰ã€‚8-bitéŸ³æ•ˆï¼šé€‰æ‹©æ—¶"æ»´"å£°ï¼Œé˜¶ä¹˜æ—¶"å’”åš“"å£°ï¼ŒåŒ¹é…æˆåŠŸæ’­æ”¾èƒœåˆ©æ—‹å¾‹  

---

### 2. ç²¾é€‰ä¼˜è´¨é¢˜è§£å‚è€ƒ  
**é¢˜è§£ä¸€ï¼ˆliangbowenï¼‰**  
* **ç‚¹è¯„**ï¼šæ€è·¯æ¸…æ™°å¦‚åœ°å›¾å¯¼èˆªï¼Œä»çŠ¶æ€å®šä¹‰ï¼ˆmapå­˜å‚¨é˜¶ä¹˜æ•°â†’å’Œâ†’æ–¹æ¡ˆæ•°ï¼‰åˆ°è¾¹ç•Œå¤„ç†ï¼ˆé˜¶ä¹˜æº¢å‡ºæ£€æŸ¥ï¼‰å±‚å±‚é€’è¿›ã€‚ä»£ç è§„èŒƒï¼šå˜é‡å`fac`ã€`mid`å«ä¹‰æ˜ç¡®ï¼Œé€’å½’è¾¹ç•Œä¸¥è°¨ã€‚äº®ç‚¹åœ¨äºé˜¶ä¹˜è®¡ç®—çš„é˜²æº¢å‡ºæŠ€å·§ï¼šç”¨`if (mul > s / i)`æ›¿ä»£ä¹˜æ³•æ¯”è¾ƒï¼Œé¿å…long longæº¢å‡º  

**é¢˜è§£äºŒï¼ˆå²šé›ªï¼‰**  
* **ç‚¹è¯„**ï¼šç®—æ³•æœ‰æ•ˆæ€§çªå‡ºï¼Œåˆ©ç”¨C++11çš„`unordered_map`å®ç°O(1)æŸ¥è¯¢ï¼Œæ¯”æ™®é€šmapå¿«3å€ã€‚ä»£ç ç®€æ´æœ‰åŠ›ï¼Œé¢„å¤„ç†é˜¶ä¹˜æ•°ç»„é¿å…é‡å¤è®¡ç®—ã€‚äº®ç‚¹ï¼šçŠ¶æ€åˆå¹¶å¾ªç¯`for i in 0..k-used`ç²¾å‡†æ§åˆ¶é˜¶ä¹˜æ€»æ•°ï¼Œå®è·µä»·å€¼å¯ç›´æ¥ç”¨äºç«èµ›  

**é¢˜è§£ä¸‰ï¼ˆForgotDream_CHNï¼‰**  
* **ç‚¹è¯„**ï¼šè§£é¢˜ç­–ç•¥ç›´å‡»è¦å®³ï¼Œå¼ºè°ƒå…³é”®å‰ªæâ€”â€”ä»…å½“aáµ¢â‰¤18æ‰è€ƒè™‘é˜¶ä¹˜ï¼ˆ19!>10Â¹â¶ï¼‰ã€‚ä»£ç ç»“æ„å¦‚æ•™ç§‘ä¹¦èˆ¬è§„æ•´ï¼Œå‡½æ•°åˆ†å·¥æ˜ç¡®ã€‚äº®ç‚¹ï¼šå®Œæ•´é”™è¯¯å¤„ç†é“¾ï¼Œé¿å…æ— æ•ˆè®¡ç®—æå‡æ•ˆç‡  

---

### 3. æ ¸å¿ƒéš¾ç‚¹è¾¨æä¸è§£é¢˜ç­–ç•¥  
1. **çŠ¶æ€ç©ºé—´çˆ†ç‚¸**  
   * **åˆ†æ**ï¼šç›´æ¥æœç´¢O(3â¿)ä¸å¯è¡Œ â†’ æŠ˜åŠæœç´¢åˆ†æ²»å¤„ç†  
   * ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼š"åˆ†æ²»æ˜¯åº”å¯¹æŒ‡æ•°å¢é•¿çš„é“¶å¼¹"  

2. **é˜¶ä¹˜å€¼ä¸æº¢å‡º**  
   * **åˆ†æ**ï¼š19! >10Â¹â¶ â†’ ä»…å¤„ç†aáµ¢â‰¤18ï¼Œè®¡ç®—æ—¶ç”¨é™¤æ³•é˜²æº¢å‡º  
   * ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼š"é¢„é˜²æº¢å‡ºè¦åƒæ£€æŸ¥å®‰å…¨å¸¦"  

3. **çŠ¶æ€åˆå¹¶å¤æ‚åº¦**  
   * **åˆ†æ**ï¼šéœ€æ»¡è¶³ sum_left + sum_right = S ä¸” fact_left + fact_right â‰¤ k  
   * ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼š"å“ˆå¸Œè¡¨æ˜¯çŠ¶æ€åŒ¹é…çš„æ—¶å…‰æœº"  

âœ¨ **è§£é¢˜æŠ€å·§æ€»ç»“**  
- **åˆ†æ²»ç­–ç•¥**ï¼šå°†åºåˆ—å¹³åˆ†ä¸¤åŠç‹¬ç«‹å¤„ç†ï¼ˆå¤æ‚åº¦å¼€å¹³æ–¹æ ¹ï¼‰  
- **æ•°æ®ç»“æ„ä¼˜åŒ–**ï¼šç”¨`unordered_map`æ›¿ä»£`map`ï¼ŒæŸ¥è¯¢ä»O(log n)é™è‡³O(1)  
- **è¾¹ç•Œé˜²å¾¡**ï¼šé˜¶ä¹˜å‰æ£€æŸ¥aáµ¢â‰¤18ï¼Œè®¡ç®—ä¸­å®æ—¶é˜²æº¢å‡º  

---

### 4. C++æ ¸å¿ƒä»£ç å®ç°èµæ  
**é€šç”¨æ ¸å¿ƒå®ç°**ï¼ˆç»¼åˆè‡ªä¼˜è´¨é¢˜è§£ï¼‰ï¼š  
```cpp
#include <iostream>
#include <unordered_map>
using namespace std;
typedef long long LL;

int n, k, mid;
LL s, ans, a[30], fac[20];
unordered_map<LL, LL> mp[30]; // mp[i][sum] = æ–¹æ¡ˆæ•°

void dfs1(int pos, LL sum, int used) {
    if (used > k || sum > s) return;
    if (pos > mid) { mp[used][sum]++; return; }
    dfs1(pos+1, sum, used);                     // ä¸é€‰
    dfs1(pos+1, sum + a[pos], used);             // é€‰ä¸é˜¶ä¹˜
    if (a[pos] <= 18)                            // å…³é”®å‰ªæï¼
        dfs1(pos+1, sum + fac[a[pos]], used+1); // é€‰ä¸”é˜¶ä¹˜
}

void dfs2(int pos, LL sum, int used) {
    if (used > k || sum > s) return;
    if (pos > n) {
        for (int i = 0; i <= k - used; i++)  // çŠ¶æ€åˆå¹¶é­”æ³•
            if (mp[i].count(s - sum)) 
                ans += mp[i][s - sum];
        return;
    }
    dfs2(pos+1, sum, used);
    dfs2(pos+1, sum + a[pos], used);
    if (a[pos] <= 18)
        dfs2(pos+1, sum + fac[a[pos]], used+1);
}

int main() {
    // é¢„å¤„ç†é˜¶ä¹˜è¡¨ï¼ˆ1~18ï¼‰
    fac[0] = 1;
    for (int i = 1; i <= 18; i++) 
        fac[i] = fac[i-1] * i;
    
    cin >> n >> k >> s;
    mid = n / 2;  // æŠ˜åŠåˆ†ç•Œç‚¹
    for (int i = 1; i <= n; i++) cin >> a[i];
    
    dfs1(1, 0, 0);   // å‰åŠæœç´¢
    dfs2(mid+1, 0, 0); // ååŠæœç´¢+åˆå¹¶
    cout << ans;
}
```

**åˆ†é¢˜è§£äº®ç‚¹èµæ**ï¼š  
1. **liangbowençš„é˜¶ä¹˜é˜²æº¢å‡º**  
   ```cpp
   // é¿å…æº¢å‡ºçš„ç²¾å·§è®¾è®¡
   LL safe_factorial(int x) {
       LL res = 1;
       for (int i = 1; i <= x; i++) {
           if (res > s / i) return -1; // æº¢å‡ºé¢„åˆ¤
           res *= i;
       }
       return res;
   }
   ```
   * **å­¦ä¹ ç¬”è®°**ï¼šç”¨é™¤æ³•æ›¿ä»£ä¹˜æ³•æ¯”è¾ƒï¼Œè§„é¿æº¢å‡ºé£é™©

2. **å²šé›ªçš„unordered_mapå®æˆ˜**  
   ```cpp
   // O(1)æŸ¥è¯¢çš„å“ˆå¸Œè¡¨
   unordered_map<LL, LL> M[30]; 
   void merge_states() {
       for (int i = 0; i <= k - used; i++)
           ans += M[i][s - sum]; // é—ªç”µèˆ¬å¿«é€Ÿ
   }
   ```
   * **å­¦ä¹ ç¬”è®°**ï¼šC++11çš„unordered_mapæ˜¯æ€§èƒ½åˆ©å™¨

---

### 5. ç®—æ³•å¯è§†åŒ–ï¼šåƒç´ åŠ¨ç”»æ¼”ç¤º  
**ä¸»é¢˜**ï¼šæŠ˜åŠæœç´¢å¤§å†’é™©ï¼ˆ8-bitå¤å¤é£ï¼‰  

**æ ¸å¿ƒæ¼”ç¤ºæµç¨‹**ï¼š  
1. **åœºæ™¯åˆå§‹åŒ–**  
   - å±å¹•åˆ†å‰²ä¸ºè“/ç»¿åŒåŒºï¼Œç«‹æ–¹ä½“åŒ–ä¸ºåƒç´ æ–¹å—  
   - æ§åˆ¶é¢æ¿ï¼šé€Ÿåº¦æ»‘å—/å•æ­¥æ‰§è¡Œ/é‡ç½®æŒ‰é’®  
   - èƒŒæ™¯éŸ³ä¹ï¼š8-bitå¾ªç¯æ—‹å¾‹  

2. **æœç´¢è¿‡ç¨‹åŠ¨æ€æ¼”ç¤º**  
   | æ­¥éª¤               | è§†è§‰è¡¨ç°                     | éŸ³æ•ˆ       |
   |--------------------|------------------------------|------------|
   | é€‰æ‹©ç«‹æ–¹ä½“         | æ–¹å—å˜é»„é—ªçƒ                 | "æ»´"å£°     |
   | åº”ç”¨é˜¶ä¹˜           | çº¢è‰²!ç¬¦å·å¼¹å‡º+æ•°å­—å˜å½¢åŠ¨ç”»    | "å’”åš“"å£°   |
   | çŠ¶æ€å­˜å‚¨           | å·¦ä¾§è“è‰²è¡¨æ ¼å®æ—¶æ›´æ–°æ•°æ®      | å†™å…¥éŸ³æ•ˆ   |

3. **çŠ¶æ€åŒ¹é…**ï¼ˆé«˜æ½®éƒ¨åˆ†ï¼‰  
   - å½“å³åŒºæœç´¢å®Œæˆï¼šè§¦å‘é‡‘è‰²è„‰å†²æ³¢æ‰«å‘å·¦åŒº  
   - åŒ¹é…æˆåŠŸï¼šè“ç»¿åŒºå—ç¢°æ’å‡ºé‡‘è‰²æ˜Ÿå…‰ï¼Œæ˜¾ç¤º`ans += count`  
   - èƒœåˆ©æ¡ä»¶ï¼šæ’­æ”¾ã€Šè¶…çº§é©¬é‡Œå¥¥ã€‹è¿‡å…³æ—‹å¾‹  

**æŠ€æœ¯å®ç°è¦ç‚¹**ï¼š  
```javascript
// ä¼ªä»£ç ï¼šç»˜åˆ¶æœç´¢çŠ¶æ€
function drawState(cubes, used, sum) {
    for (let i = 0; i < cubes.length; i++) {
        const color = getCubeColor(cubes[i].state); // ç°/è“/çº¢
        drawPixelCube(x, y, color); 
        if (cubes[i].factorial) drawExclamation(x, y);
    }
    drawInfoPanel(`å·²ç”¨é˜¶ä¹˜:${used} å½“å‰å’Œ:${sum}`);
}
```

---

### 6. æ‹“å±•ç»ƒä¹ ä¸ç›¸ä¼¼é—®é¢˜  
**é€šç”¨æŠ€å·§è¿ç§»**ï¼š  
æŠ˜åŠæœç´¢è¿˜å¯ç”¨äºï¼š  
1. è¶…å¤§èƒŒåŒ…é—®é¢˜ï¼ˆnâ‰¤40çš„01èƒŒåŒ…ï¼‰  
2. å­é›†å’Œå˜å½¢ï¼ˆå¦‚LeetCode 494 ç›®æ ‡å’Œï¼‰  
3. å›¾è®ºè·¯å¾„è®¡æ•°ï¼ˆåˆ†æ²»å¤„ç†è·¯å¾„æ®µï¼‰  

**æ´›è°·æ¨è**ï¼š  
1. P4799 [CEOI2015]å†°çƒä¸–é”¦èµ›  
   â†’ æŠ˜åŠæœç´¢æ¨¡æ¿é¢˜ï¼Œå¼ºåŒ–çŠ¶æ€åˆå¹¶  
2. P3067 [USACO12OPEN]å¹³è¡¡çš„ç‰›ç¾¤  
   â†’ è¿›é˜¶çŠ¶æ€è®¾è®¡ï¼Œå­¦ä¹ bitsetä¼˜åŒ–  
3. P5194 [USACO05DEC]Scales  
   â†’ å‰ªæè‰ºæœ¯å®æˆ˜ï¼ŒåŸ¹å…»ä¼˜åŒ–æ€ç»´  

---

### 7. å­¦ä¹ å¿ƒå¾—ä¸ç»éªŒåˆ†äº«  
> **æ¥è‡ªliangbowençš„è°ƒè¯•ç»éªŒ**ï¼š  
> "å½“é˜¶ä¹˜è®¡ç®—å¡ä½æ—¶ï¼Œæˆ‘å‘ç°ç”¨`if (res > S / i)`æ›¿ä»£ä¹˜æ³•æ¯”è¾ƒï¼Œè§£å†³äº†90%çš„è¾¹ç•Œé—®é¢˜"  
>  
> **Kayç‚¹è¯„**ï¼š  
> è°ƒè¯•æ—¶è¦åƒä¾¦æ¢èˆ¬æ•é”ï¼š  
> 1. ä¼˜å…ˆæ£€æŸ¥è¾¹ç•Œå€¼ï¼ˆ0/æœ€å¤§å€¼ï¼‰  
> 2. æ•°å€¼è¿ç®—è­¦æƒ•æº¢å‡ºï¼ˆç”¨é™¤æ³•é˜²ä¹˜æ³•æº¢å‡ºï¼‰  
> 3. æŠ˜åŠæœç´¢ä¸­ï¼ŒçŠ¶æ€åˆå¹¶æ˜¯å¸¸è§é”™è¯¯ç‚¹  

---

**ç»“è¯­**  
é€šè¿‡æœ¬æ¬¡åˆ†æï¼Œç›¸ä¿¡å¤§å®¶å·²æŒæ¡æŠ˜åŠæœç´¢çš„ç²¾é«“ã€‚è®°ä½ï¼šåˆ†æ²»æ˜¯åŒ–æŒ‡æ•°ä¸ºå¯èƒ½çš„é­”æ³•ï¼Œè€Œç»†èŠ‚å¤„ç†å†³å®šæˆè´¥ã€‚ä¸‹æ¬¡é‡åˆ°éš¾é¢˜æ—¶ï¼Œä¸å¦¨ç”»ä¸ªåƒç´ è‰å›¾è¾…åŠ©æ€è€ƒå“¦ï¼ğŸš€  

> å¯è§†åŒ–ä»£ç ç¤ºä¾‹ï¼š[GitHubé“¾æ¥]  
> ç®—æ³•åŠ¨ç”»ä½“éªŒï¼š[åœ¨çº¿æ¼”ç¤º]  
> Kayçš„ç¼–ç¨‹å°è´´å£«ï¼š`unordered_map`æŸ¥è¯¢æ¯”`map`å¿«3å€ï¼Œç«èµ›é¦–é€‰ï¼

---
å¤„ç†ç”¨æ—¶ï¼š173.02ç§’
# é¢˜ç›®ä¿¡æ¯

# Optimal Partition

## é¢˜ç›®æè¿°

You are given an array $ a $ consisting of $ n $ integers. You should divide $ a $ into continuous non-empty subarrays (there are $ 2^{n-1} $ ways to do that).

Let $ s=a_l+a_{l+1}+\ldots+a_r $ . The value of a subarray $ a_l, a_{l+1}, \ldots, a_r $ is:

- $ (r-l+1) $ if $ s>0 $ ,
- $ 0 $ if $ s=0 $ ,
- $ -(r-l+1) $ if $ s<0 $ .

 What is the maximum sum of values you can get with a partition?

## è¯´æ˜/æç¤º

Test case $ 1 $ : one optimal partition is $ [1, 2] $ , $ [-3] $ . $ 1+2>0 $ so the value of $ [1, 2] $ is $ 2 $ . $ -3<0 $ , so the value of $ [-3] $ is $ -1 $ . $ 2+(-1)=1 $ .

Test case $ 2 $ : the optimal partition is $ [0, -2, 3] $ , $ [-4] $ , and the sum of values is $ 3+(-1)=2 $ .

## æ ·ä¾‹ #1

### è¾“å…¥

```
5
3
1 2 -3
4
0 -2 3 -4
5
-1 -2 3 -1 -1
6
-1 2 -3 4 -5 6
7
1 -1 -1 1 -1 -1 1```

### è¾“å‡º

```
1
2
1
6
-1```

# AIåˆ†æç»“æœ

# ğŸ’¡ Kayçš„C++ç®—æ³•è§£æï¼šOptimal Partition æ·±å…¥å­¦ä¹ æŒ‡å— ğŸ’¡


## 1. é¢˜ç›®è§£è¯»ä¸æ ¸å¿ƒç®—æ³•è¯†åˆ«

âœ¨ **æœ¬é¢˜ä¸»è¦è€ƒå¯Ÿ**ï¼šåŠ¨æ€è§„åˆ’ï¼ˆDPï¼‰ç»“åˆçº¿æ®µæ ‘/æ ‘çŠ¶æ•°ç»„ä¼˜åŒ–  

ğŸ—£ï¸ **åˆæ­¥åˆ†æ**ï¼š  
è§£å†³ã€ŒOptimal Partitionã€çš„å…³é”®ï¼Œæ˜¯ç”¨**åŠ¨æ€è§„åˆ’**å®šä¹‰ã€Œå‰iä¸ªå…ƒç´ çš„æœ€å¤§ä»·å€¼ã€ï¼Œå†é€šè¿‡**çº¿æ®µæ ‘/æ ‘çŠ¶æ•°ç»„**å°†åŸæœ¬O(nÂ²)çš„è½¬ç§»ä¼˜åŒ–åˆ°O(n log n)ã€‚  

ç®€å•æ¥è¯´ï¼ŒåŠ¨æ€è§„åˆ’ï¼ˆDPï¼‰åƒã€Œæ­ç§¯æœ¨ã€â€”â€”æˆ‘ä»¬ç”¨`dp[i]`è¡¨ç¤ºå‰iä¸ªå…ƒç´ çš„æœ€å¤§ä»·å€¼ï¼Œç„¶åé€šè¿‡ä¹‹å‰çš„`dp[j]`ï¼ˆj<iï¼‰æ¥æ¨å¯¼`dp[i]`ã€‚ä½†ç›´æ¥æšä¸¾jä¼šè¶…æ—¶ï¼Œæ‰€ä»¥éœ€è¦**æŒ‰å‰ç¼€å’Œçš„å¤§å°å…³ç³»æ‹†åˆ†è½¬ç§»æ–¹ç¨‹**ï¼Œç”¨æ•°æ®ç»“æ„å¿«é€Ÿæ‰¾åˆ°æ‰€éœ€çš„æœ€å¤§å€¼ã€‚  

### æ ¸å¿ƒæ€è·¯æ‹†è§£  
1. **çŠ¶æ€å®šä¹‰**ï¼š`dp[i]` = å‰iä¸ªå…ƒç´ çš„æœ€å¤§ä»·å€¼ã€‚  
2. **è½¬ç§»æ–¹ç¨‹**ï¼š  
   è®¾å‰ç¼€å’Œ`s[i] = a[1]+a[2]+â€¦+a[i]`ï¼Œåˆ™å­æ•°ç»„`[j+1,i]`çš„å’Œä¸º`s[i]-s[j]`ã€‚æ ¹æ®å’Œçš„æ­£è´Ÿï¼Œè½¬ç§»åˆ†ä¸ºä¸‰ç±»ï¼š  
   - è‹¥`s[i] > s[j]`ï¼šä»·å€¼ä¸º`i-j`ï¼Œæ•…`dp[i] = max(dp[j]-j) + i`ï¼›  
   - è‹¥`s[i] = s[j]`ï¼šä»·å€¼ä¸º0ï¼Œæ•…`dp[i] = max(dp[j])`ï¼›  
   - è‹¥`s[i] < s[j]`ï¼šä»·å€¼ä¸º`-(i-j)`ï¼Œæ•…`dp[i] = max(dp[j]+j) - i`ã€‚  
3. **ä¼˜åŒ–å…³é”®**ï¼šç”¨çº¿æ®µæ ‘/æ ‘çŠ¶æ•°ç»„ç»´æŠ¤ä¸‰ä¸ªå€¼çš„æœ€å¤§å€¼â€”â€”`dp[j]-j`ï¼ˆå‰ç¼€æœ€å¤§ï¼‰ã€`dp[j]`ï¼ˆå•ç‚¹æœ€å¤§ï¼‰ã€`dp[j]+j`ï¼ˆåç¼€æœ€å¤§ï¼‰ï¼Œä»è€Œå¿«é€ŸæŸ¥è¯¢è½¬ç§»æ‰€éœ€çš„æœ€å¤§å€¼ã€‚  

### å¯è§†åŒ–è®¾è®¡æ€è·¯  
æˆ‘ä»¬å°†ç”¨**FCçº¢ç™½æœºé£æ ¼çš„åƒç´ åŠ¨ç”»**æ¼”ç¤ºç®—æ³•æµç¨‹ï¼š  
- å±å¹•å·¦ä¾§å±•ç¤ºæ•°ç»„`a`å’Œå‰ç¼€å’Œ`s`çš„åƒç´ å—ï¼ˆä¸åŒé¢œè‰²åŒºåˆ†æ­£è´Ÿï¼‰ï¼›  
- ä¸­é—´åŒºåŸŸåŠ¨æ€æ˜¾ç¤º`dp`æ•°ç»„çš„å˜åŒ–ï¼ˆé«˜äº®å½“å‰è®¡ç®—çš„`dp[i]`ï¼‰ï¼›  
- å³ä¾§ç”¨åƒç´ åŒ–çš„ã€Œçº¿æ®µæ ‘ã€å›¾æ ‡å±•ç¤ºæ•°æ®ç»“æ„çš„æŸ¥è¯¢/æ›´æ–°æ“ä½œï¼ˆæ¯”å¦‚æŸ¥è¯¢`dp[j]-j`çš„å‰ç¼€æœ€å¤§æ—¶ï¼Œçº¿æ®µæ ‘å›¾æ ‡ä¼šé—ªçƒå¯¹åº”åŒºé—´ï¼‰ï¼›  
- å…³é”®æ“ä½œï¼ˆå¦‚æŸ¥è¯¢ã€æ›´æ–°ï¼‰ä¼´éš8ä½éŸ³æ•ˆï¼ˆæ¯”å¦‚æŸ¥è¯¢æ˜¯ã€Œå®ã€ï¼Œæ›´æ–°æ˜¯ã€Œå’”ã€ï¼‰ï¼Œå®Œæˆæ—¶æ’­æ”¾ã€Œèƒœåˆ©ã€éŸ³æ•ˆã€‚  


## 2. ç²¾é€‰ä¼˜è´¨é¢˜è§£å‚è€ƒ

ä¸ºå¤§å®¶ç­›é€‰äº†3ä»½æ€è·¯æ¸…æ™°ã€ä»£ç é«˜æ•ˆçš„ä¼˜è´¨é¢˜è§£ï¼š


### é¢˜è§£ä¸€ï¼šAngueiï¼ˆèµï¼š14ï¼‰  
* **ç‚¹è¯„**ï¼š  
  è¿™ä»½é¢˜è§£æ˜¯ã€Œæ ‡å‡†è§£æ³•ã€çš„å…¸èŒƒâ€”â€”æ€è·¯æ¨å¯¼æå…¶æ¸…æ™°ï¼Œå°†è½¬ç§»æ–¹ç¨‹æ‹†åˆ†ä¸ºä¸‰ç±»åï¼Œç›´æ¥ç”¨**ä¸‰æ£µçº¿æ®µæ ‘**åˆ†åˆ«ç»´æŠ¤`dp[j]-j`ã€`dp[j]`ã€`dp[j]+j`çš„æœ€å¤§å€¼ã€‚ä»£ç ç»“æ„å·¥æ•´ï¼Œå˜é‡å‘½åè§„èŒƒï¼ˆå¦‚`SegTree`ç»“æ„ä½“å°è£…çº¿æ®µæ ‘æ“ä½œï¼‰ï¼Œè¾¹ç•Œå¤„ç†ä¸¥è°¨ï¼ˆæ¯”å¦‚å‰ç¼€å’Œç¦»æ•£åŒ–æ—¶å¤„ç†`s[0]=0`çš„æƒ…å†µï¼‰ã€‚  
  äº®ç‚¹ï¼šå°†å¤æ‚çš„è½¬ç§»é—®é¢˜æ‹†è§£ä¸ºæ•°æ®ç»“æ„çš„ã€ŒåŒºé—´æŸ¥è¯¢+å•ç‚¹æ›´æ–°ã€ï¼Œå®Œç¾ä½“ç°äº†ã€ŒDPä¼˜åŒ–=çŠ¶æ€å®šä¹‰+æ•°æ®ç»“æ„ã€çš„æ ¸å¿ƒæ€æƒ³ã€‚


### é¢˜è§£äºŒï¼šI_am_Acceptedï¼ˆèµï¼š8ï¼‰  
* **ç‚¹è¯„**ï¼š  
  æ­¤é¢˜è§£ç”¨**ä¸¤ä¸ªæ ‘çŠ¶æ•°ç»„ï¼ˆBITï¼‰+ä¸€ä¸ªæ¡¶**æ›¿ä»£äº†ä¸‰æ£µçº¿æ®µæ ‘ï¼Œæ›´é«˜æ•ˆï¼ˆæ ‘çŠ¶æ•°ç»„å¸¸æ•°æ›´å°ï¼‰ã€‚å…¶ä¸­ï¼ŒBIT1ç»´æŠ¤`dp[j]-j`çš„å‰ç¼€æœ€å¤§ï¼ŒBIT2ç»´æŠ¤`dp[j]+j`çš„åç¼€æœ€å¤§ï¼Œæ¡¶ç»´æŠ¤`dp[j]`çš„å•ç‚¹æœ€å¤§ã€‚ä»£ç é£æ ¼ç®€æ´ï¼Œå¤§é‡ä½¿ç”¨`ckmx`ï¼ˆå³`max`ï¼‰å®ç®€åŒ–ä»£ç ï¼Œé€‚åˆç«èµ›åœºæ™¯ã€‚  
  äº®ç‚¹ï¼šç”¨æ ‘çŠ¶æ•°ç»„ä¼˜åŒ–åç¼€æŸ¥è¯¢ï¼ˆé€šè¿‡ã€Œåå‘æ˜ å°„ã€å°†åç¼€æŸ¥è¯¢è½¬åŒ–ä¸ºå‰ç¼€æŸ¥è¯¢ï¼‰ï¼Œæ˜¯å¯¹æ•°æ®ç»“æ„çš„çµæ´»è¿ç”¨ã€‚


### é¢˜è§£ä¸‰ï¼šJjy123ï¼ˆèµï¼š4ï¼‰  
* **ç‚¹è¯„**ï¼š  
  æ­¤é¢˜è§£çš„ä»£ç æ˜¯ã€Œè¸©å‘åçš„ç»“æ™¶ã€â€”â€”ä½œè€…æåˆ°è°ƒè¯•äº†4å°æ—¶ï¼Œä¸»è¦é—®é¢˜é›†ä¸­åœ¨**ç¦»æ•£åŒ–çš„æ­£ç¡®æ€§**å’Œ**çº¿æ®µæ ‘çš„è¾¹ç•Œå¤„ç†**ã€‚ä»£ç é€»è¾‘ä¸é¢˜è§£ä¸€ä¸€è‡´ï¼Œä½†æ›´æ³¨é‡ç»†èŠ‚ï¼ˆæ¯”å¦‚ç”¨`stable_sort`ä¿æŒç¦»æ•£åŒ–çš„ç¨³å®šæ€§ï¼‰ã€‚è™½ç„¶è¿‡ç¨‹æ›²æŠ˜ï¼Œä½†è¿™ä»½é¢˜è§£èƒ½è®©æˆ‘ä»¬æ›´æ·±åˆ»åœ°ç†è§£ã€Œç¦»æ•£åŒ–ã€å’Œã€Œçº¿æ®µæ ‘åˆå§‹åŒ–ã€çš„é‡è¦æ€§ã€‚  
  äº®ç‚¹ï¼šä½œè€…çš„è°ƒè¯•ç»éªŒæé†’æˆ‘ä»¬â€”â€”**åŠ¨æ€è§„åˆ’çš„ä¼˜åŒ–é—®é¢˜ï¼Œç»†èŠ‚å†³å®šæˆè´¥**ã€‚


## 3. æ ¸å¿ƒéš¾ç‚¹è¾¨æä¸è§£é¢˜ç­–ç•¥

### 1. è½¬ç§»æ–¹ç¨‹çš„æ‹†åˆ†ï¼šä»O(nÂ²)åˆ°O(n log n)  
- **éš¾ç‚¹**ï¼šç›´æ¥æšä¸¾jä¼šè¶…æ—¶ï¼Œå¦‚ä½•å°†è½¬ç§»æ–¹ç¨‹è½¬åŒ–ä¸ºå¯å¿«é€ŸæŸ¥è¯¢çš„å½¢å¼ï¼Ÿ  
- **ç­–ç•¥**ï¼šå°†è½¬ç§»æ–¹ç¨‹ä¸­çš„ã€Œi-jã€ã€Œj-iã€æ‹†åˆ†ä¸ºã€Œä¸iç›¸å…³ã€å’Œã€Œä¸jç›¸å…³ã€çš„ä¸¤éƒ¨åˆ†ï¼ˆå¦‚`dp[j]-j + i`ï¼‰ï¼Œè¿™æ ·åªéœ€ç»´æŠ¤ã€Œä¸jç›¸å…³ã€éƒ¨åˆ†çš„æœ€å¤§å€¼ï¼Œå†ç»“åˆiè®¡ç®—å³å¯ã€‚  
- ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šæ‹†åˆ†è½¬ç§»æ–¹ç¨‹æ˜¯DPä¼˜åŒ–çš„å…³é”®â€”â€”å°†ã€Œä¾èµ–jçš„éƒ¨åˆ†ã€å’Œã€Œä¾èµ–içš„éƒ¨åˆ†ã€åˆ†ç¦»ï¼Œæ‰èƒ½ç”¨æ•°æ®ç»“æ„å¿«é€ŸæŸ¥è¯¢ã€‚


### 2. å‰ç¼€å’Œçš„ç¦»æ•£åŒ–ï¼šå¤„ç†å¤§æ•°é—®é¢˜  
- **éš¾ç‚¹**ï¼šå‰ç¼€å’Œ`s[i]`å¯èƒ½å¾ˆå¤§ï¼ˆå¦‚n=5e5ï¼Œa[i]=1e9æ—¶ï¼Œs[i]å¯è¾¾5e14ï¼‰ï¼Œæ— æ³•ç›´æ¥ä½œä¸ºæ•°ç»„ä¸‹æ ‡ã€‚  
- **ç­–ç•¥**ï¼šå°†æ‰€æœ‰å‰ç¼€å’Œæ’åºã€å»é‡ï¼Œæ˜ å°„åˆ°1~mçš„è¿ç»­æ•´æ•°ï¼ˆmä¸ºä¸åŒå‰ç¼€å’Œçš„æ•°é‡ï¼‰ï¼Œè¿™å°±æ˜¯ã€Œç¦»æ•£åŒ–ã€ã€‚  
- ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šç¦»æ•£åŒ–æ˜¯å¤„ç†ã€Œå¤§èŒƒå›´æ•°å€¼ã€çš„å¸¸ç”¨æŠ€å·§ï¼Œæ ¸å¿ƒæ˜¯ã€Œç”¨ç›¸å¯¹å¤§å°æ›¿ä»£ç»å¯¹å¤§å°ã€ã€‚


### 3. æ•°æ®ç»“æ„çš„é€‰æ‹©ï¼šçº¿æ®µæ ‘vsæ ‘çŠ¶æ•°ç»„  
- **éš¾ç‚¹**ï¼šå¦‚ä½•é€‰æ‹©åˆé€‚çš„æ•°æ®ç»“æ„ç»´æŠ¤æœ€å¤§å€¼ï¼Ÿ  
- **ç­–ç•¥**ï¼š  
  - çº¿æ®µæ ‘ï¼šæ”¯æŒä»»æ„åŒºé—´çš„æŸ¥è¯¢/æ›´æ–°ï¼ŒåŠŸèƒ½æ›´å…¨ï¼ˆå¦‚é¢˜è§£ä¸€ç”¨ä¸‰æ£µçº¿æ®µæ ‘ï¼‰ï¼›  
  - æ ‘çŠ¶æ•°ç»„ï¼šä»…æ”¯æŒå‰ç¼€/åç¼€æŸ¥è¯¢ï¼Œä½†å¸¸æ•°æ›´å°ï¼ˆå¦‚é¢˜è§£äºŒç”¨ä¸¤ä¸ªæ ‘çŠ¶æ•°ç»„ï¼‰ã€‚  
- ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šæ ¹æ®éœ€æ±‚é€‰æ‹©æ•°æ®ç»“æ„â€”â€”å¦‚æœéœ€è¦çµæ´»çš„åŒºé—´æ“ä½œï¼Œé€‰çº¿æ®µæ ‘ï¼›å¦‚æœåªéœ€è¦å‰ç¼€/åç¼€æŸ¥è¯¢ï¼Œé€‰æ ‘çŠ¶æ•°ç»„ã€‚


### âœ¨ è§£é¢˜æŠ€å·§æ€»ç»“  
1. **é—®é¢˜æ‹†åˆ†**ï¼šå°†å¤æ‚çš„è½¬ç§»æ–¹ç¨‹æ‹†åˆ†ä¸ºã€Œä¸iç›¸å…³ã€å’Œã€Œä¸jç›¸å…³ã€çš„ä¸¤éƒ¨åˆ†ï¼Œä¸ºæ•°æ®ç»“æ„ä¼˜åŒ–é“ºè·¯ï¼›  
2. **ç¦»æ•£åŒ–**ï¼šå¤„ç†å¤§èŒƒå›´æ•°å€¼æ—¶ï¼Œç”¨ã€Œç›¸å¯¹å¤§å°ã€æ›¿ä»£ã€Œç»å¯¹å¤§å°ã€ï¼›  
3. **æ•°æ®ç»“æ„å°è£…**ï¼šå°†çº¿æ®µæ ‘/æ ‘çŠ¶æ•°ç»„å°è£…ä¸ºç»“æ„ä½“ï¼Œæé«˜ä»£ç å¯è¯»æ€§å’Œå¤ç”¨æ€§ï¼›  
4. **è¾¹ç•Œå¤„ç†**ï¼šæ³¨æ„å‰ç¼€å’Œ`s[0]=0`çš„æƒ…å†µï¼ˆå¯¹åº”ç©ºæ•°ç»„çš„åˆå§‹çŠ¶æ€ï¼‰ã€‚


## 4. C++æ ¸å¿ƒä»£ç å®ç°èµæ

### æœ¬é¢˜é€šç”¨æ ¸å¿ƒC++å®ç°å‚è€ƒ  
* **è¯´æ˜**ï¼šç»¼åˆé¢˜è§£ä¸€çš„æ€è·¯ï¼Œç”¨ä¸‰æ£µçº¿æ®µæ ‘ç»´æŠ¤æœ€å¤§å€¼ï¼Œæ˜¯æœ€æ˜“ç†è§£çš„æ ‡å‡†å®ç°ã€‚  

```cpp
#include <iostream>
#include <vector>
#include <algorithm>
#include <map>
using namespace std;
typedef long long ll;

const ll INF = 1e18;

struct SegTree {
    vector<ll> tree;
    int n;
    SegTree(int size) : n(size), tree(4 * size, -INF) {}
    void update(int pos, ll val) { update(1, 1, n, pos, val); }
    ll query(int l, int r) { return query(1, 1, n, l, r); }
private:
    void update(int node, int l, int r, int pos, ll val) {
        if (l == r) { tree[node] = max(tree[node], val); return; }
        int mid = (l + r) / 2;
        if (pos <= mid) update(2*node, l, mid, pos, val);
        else update(2*node+1, mid+1, r, pos, val);
        tree[node] = max(tree[2*node], tree[2*node+1]);
    }
    ll query(int node, int l, int r, int ql, int qr) {
        if (qr < l || r < ql) return -INF;
        if (ql <= l && r <= qr) return tree[node];
        int mid = (l + r) / 2;
        return max(query(2*node, l, mid, ql, qr),
                   query(2*node+1, mid+1, r, ql, qr));
    }
};

int main() {
    ios::sync_with_stdio(false); cin.tie(0);
    int T; cin >> T;
    while (T--) {
        int n; cin >> n;
        vector<ll> a(n+1), s(n+1);
        for (int i=1; i<=n; i++) {
            cin >> a[i];
            s[i] = s[i-1] + a[i];
        }
        // ç¦»æ•£åŒ–å‰ç¼€å’Œ
        vector<ll> vs = s;
        sort(vs.begin(), vs.end());
        vs.erase(unique(vs.begin(), vs.end()), vs.end());
        map<ll, int> mp;
        for (int i=0; i<vs.size(); i++) mp[vs[i]] = i+1; // æ˜ å°„åˆ°1~m
        int m = vs.size();
        // åˆå§‹åŒ–ä¸‰æ£µçº¿æ®µæ ‘ï¼šç»´æŠ¤dp[j]-jã€dp[j]ã€dp[j]+j
        SegTree t1(m), t2(m), t3(m);
        t1.update(mp[0], 0 - 0); // dp[0] = 0ï¼Œå¯¹åº”j=0
        t2.update(mp[0], 0);
        t3.update(mp[0], 0 + 0);
        vector<ll> dp(n+1, -INF);
        for (int i=1; i<=n; i++) {
            int pos = mp[s[i]];
            // è½¬ç§»1ï¼šs[i] > s[j] â†’ max(dp[j]-j) + i
            ll v1 = t1.query(1, pos-1) + i;
            // è½¬ç§»2ï¼šs[i] = s[j] â†’ max(dp[j])
            ll v2 = t2.query(pos, pos);
            // è½¬ç§»3ï¼šs[i] < s[j] â†’ max(dp[j]+j) - i
            ll v3 = t3.query(pos+1, m) - i;
            dp[i] = max({v1, v2, v3});
            // æ›´æ–°ä¸‰æ£µçº¿æ®µæ ‘
            t1.update(pos, dp[i] - i);
            t2.update(pos, dp[i]);
            t3.update(pos, dp[i] + i);
        }
        cout << dp[n] << endl;
    }
    return 0;
}
```

* **ä»£ç è§£è¯»æ¦‚è¦**ï¼š  
  1. è¯»å–è¾“å…¥å¹¶è®¡ç®—å‰ç¼€å’Œ`s`ï¼›  
  2. ç¦»æ•£åŒ–å‰ç¼€å’Œ`s`ï¼Œå°†å…¶æ˜ å°„åˆ°1~mçš„è¿ç»­æ•´æ•°ï¼›  
  3. åˆå§‹åŒ–ä¸‰æ£µçº¿æ®µæ ‘ï¼Œåˆ†åˆ«ç»´æŠ¤`dp[j]-j`ã€`dp[j]`ã€`dp[j]+j`çš„æœ€å¤§å€¼ï¼›  
  4. éå†æ¯ä¸ªiï¼ŒæŸ¥è¯¢ä¸‰æ£µçº¿æ®µæ ‘å¾—åˆ°è½¬ç§»çš„ä¸‰ä¸ªå¯èƒ½å€¼ï¼Œå–æœ€å¤§å€¼ä½œä¸º`dp[i]`ï¼›  
  5. æ›´æ–°çº¿æ®µæ ‘ï¼Œå°†`dp[i]`çš„ç›¸å…³å€¼å­˜å…¥å¯¹åº”ä½ç½®ã€‚


### é¢˜è§£ä¸€æ ¸å¿ƒç‰‡æ®µèµæï¼ˆAngueiï¼‰  
* **äº®ç‚¹**ï¼šç”¨ç»“æ„ä½“å°è£…çº¿æ®µæ ‘ï¼Œä»£ç æ¨¡å—åŒ–ã€‚  
* **æ ¸å¿ƒä»£ç ç‰‡æ®µ**ï¼š  
  ```cpp
  struct SegTree {
    vector<ll> a;
    SegTree(int n) : a((n + 1) * 4, -1e18) {}
    void build(int o, int l, int r) {
        if (l == r) return;
        int mid = (l + r)/2;
        build(2*o, l, mid); build(2*o+1, mid+1, r);
        a[o] = max(a[2*o], a[2*o+1]);
    }
    ll query(int o, int l, int r, int L, int R) {
        if (L <= l && r <= R) return a[o];
        int mid = (l + r)/2;
        ll res = -1e18;
        if (L <= mid) res = max(res, query(2*o, l, mid, L, R));
        if (R > mid) res = max(res, query(2*o+1, mid+1, r, L, R));
        return res;
    }
    void change(int o, int l, int r, int x, ll val) {
        if (l == r) { a[o] = max(a[o], val); return; }
        int mid = (l + r)/2;
        if (x <= mid) change(2*o, l, mid, x, val);
        else change(2*o+1, mid+1, r, x, val);
        a[o] = max(a[2*o], a[2*o+1]);
    }
  };
  ```
* **ä»£ç è§£è¯»**ï¼š  
  è¿™ä¸ª`SegTree`ç»“æ„ä½“å°è£…äº†çº¿æ®µæ ‘çš„`build`ï¼ˆåˆå§‹åŒ–ï¼‰ã€`query`ï¼ˆåŒºé—´æŸ¥è¯¢ï¼‰ã€`change`ï¼ˆå•ç‚¹æ›´æ–°ï¼‰æ“ä½œã€‚çº¿æ®µæ ‘çš„æ¯ä¸ªèŠ‚ç‚¹å­˜å‚¨å¯¹åº”åŒºé—´çš„æœ€å¤§å€¼ï¼Œ`change`æ“ä½œä¼šæ›´æ–°èŠ‚ç‚¹å€¼å¹¶å‘ä¸Šåˆå¹¶ï¼Œ`query`æ“ä½œä¼šå‘ä¸‹é€’å½’æŸ¥è¯¢åŒºé—´æœ€å¤§å€¼ã€‚  
* ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šç»“æ„ä½“å°è£…æ˜¯å†™å¥½æ•°æ®ç»“æ„çš„å…³é”®â€”â€”å°†æ“ä½œé›†ä¸­åœ¨ä¸€èµ·ï¼Œé¿å…ä»£ç é‡å¤ï¼Œæé«˜å¯è¯»æ€§ã€‚


### é¢˜è§£äºŒæ ¸å¿ƒç‰‡æ®µèµæï¼ˆI_am_Acceptedï¼‰  
* **äº®ç‚¹**ï¼šç”¨æ ‘çŠ¶æ•°ç»„ä¼˜åŒ–åç¼€æŸ¥è¯¢ï¼Œå¸¸æ•°æ›´å°ã€‚  
* **æ ¸å¿ƒä»£ç ç‰‡æ®µ**ï¼š  
  ```cpp
  void add(bool T, int x, int y) {
      while (x <= lim) {
          ckmx(c[T][x], y);
          x += lowbit(x);
      }
  }
  int que(int T, int x) {
      int res = -inf;
      while (x) {
          ckmx(res, c[T][x]);
          x -= lowbit(x);
      }
      return res;
  }
  ```
* **ä»£ç è§£è¯»**ï¼š  
  `add`å‡½æ•°ç”¨äºæ›´æ–°æ ‘çŠ¶æ•°ç»„ï¼š`T=0`ç»´æŠ¤`dp[j]-j`ï¼ˆå‰ç¼€æœ€å¤§ï¼‰ï¼Œ`T=1`ç»´æŠ¤`dp[j]+j`ï¼ˆé€šè¿‡ã€Œåå‘æ˜ å°„ã€è½¬åŒ–ä¸ºå‰ç¼€æŸ¥è¯¢ï¼‰ã€‚`que`å‡½æ•°ç”¨äºæŸ¥è¯¢å‰ç¼€æœ€å¤§å€¼ã€‚æ ‘çŠ¶æ•°ç»„çš„æ ¸å¿ƒæ˜¯`lowbit`æ“ä½œï¼Œé€šè¿‡äºŒè¿›åˆ¶ä½å¿«é€Ÿå®šä½çˆ¶èŠ‚ç‚¹ã€‚  
* ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šæ ‘çŠ¶æ•°ç»„çš„ä¼˜åŠ¿æ˜¯ã€Œå¿«ã€â€”â€”ä»£ç çŸ­ã€å¸¸æ•°å°ï¼Œé€‚åˆéœ€è¦é¢‘ç¹å‰ç¼€æŸ¥è¯¢çš„åœºæ™¯ã€‚


## 5. ç®—æ³•å¯è§†åŒ–ï¼šåƒç´ åŠ¨ç”»æ¼”ç¤º (æ ¸å¿ƒéƒ¨åˆ†)

### åŠ¨ç”»æ¼”ç¤ºä¸»é¢˜  
**ã€Œåƒç´ æ¢é™©å®¶ã€æ‰¾å®è—**â€”â€”ç”¨FCé£æ ¼çš„åƒç´ ç”»é¢ï¼Œæ¼”ç¤ºDPä¼˜åŒ–çš„è¿‡ç¨‹ï¼š  

### è®¾è®¡æ€è·¯  
é‡‡ç”¨8ä½åƒç´ é£æ ¼ï¼ˆä»¿ã€Šè¶…çº§é©¬é‡Œå¥¥ã€‹ï¼‰ï¼Œå°†æ•°ç»„å…ƒç´ ã€å‰ç¼€å’Œã€DPæ•°ç»„ã€çº¿æ®µæ ‘ç”¨åƒç´ å—è¡¨ç¤ºï¼Œç»“åˆéŸ³æ•ˆå’Œäº¤äº’ï¼Œè®©ç®—æ³•ã€ŒåŠ¨èµ·æ¥ã€ã€‚


### åŠ¨ç”»å¸§æ­¥éª¤ä¸äº¤äº’å…³é”®ç‚¹  
1. **åœºæ™¯åˆå§‹åŒ–**ï¼š  
   - å±å¹•å·¦ä¾§ï¼šæ•°ç»„`a`ç”¨å½©è‰²åƒç´ å—å±•ç¤ºï¼ˆçº¢è‰²=è´Ÿæ•°ï¼Œç»¿è‰²=æ­£æ•°ï¼Œç°è‰²=0ï¼‰ï¼›  
   - ä¸­é—´åŒºåŸŸï¼š`dp`æ•°ç»„ç”¨è“è‰²åƒç´ å—å±•ç¤ºï¼Œå½“å‰è®¡ç®—çš„`dp[i]`é«˜äº®ä¸ºé»„è‰²ï¼›  
   - å³ä¾§ï¼šä¸‰æ£µçº¿æ®µæ ‘ç”¨åƒç´ å›¾æ ‡å±•ç¤ºï¼ˆåˆ†åˆ«å¯¹åº”`dp[j]-j`ã€`dp[j]`ã€`dp[j]+j`ï¼‰ï¼›  
   - åº•éƒ¨æ§åˆ¶é¢æ¿ï¼šã€Œå¼€å§‹/æš‚åœã€ã€Œå•æ­¥ã€ã€Œé‡ç½®ã€æŒ‰é’®ï¼Œé€Ÿåº¦æ»‘å—ï¼ˆ1~5å€é€Ÿï¼‰ã€‚  

2. **ç®—æ³•å¯åŠ¨**ï¼š  
   - åˆå§‹çŠ¶æ€ï¼š`dp[0]=0`ï¼Œçº¿æ®µæ ‘ä¸­`mp[0]`ä½ç½®è¢«æ ‡è®°ä¸ºç»¿è‰²ï¼ˆè¡¨ç¤ºå·²æ›´æ–°ï¼‰ï¼›  
   - æ’­æ”¾8ä½èƒŒæ™¯éŸ³ä¹ï¼ˆå¦‚ã€Šè¶…çº§é©¬é‡Œå¥¥ã€‹çš„åˆå§‹æ—‹å¾‹ï¼‰ã€‚  

3. **æ ¸å¿ƒæ­¥éª¤æ¼”ç¤º**ï¼š  
   - **è®¡ç®—`dp[i]`**ï¼š  
     1. é«˜äº®å½“å‰iå¯¹åº”çš„æ•°ç»„å…ƒç´ å’Œå‰ç¼€å’Œ`s[i]`ï¼›  
     2. çº¿æ®µæ ‘å›¾æ ‡é—ªçƒå¯¹åº”åŒºé—´ï¼ˆå¦‚æŸ¥è¯¢`dp[j]-j`çš„å‰ç¼€æœ€å¤§æ—¶ï¼Œç¬¬ä¸€æ£µçº¿æ®µæ ‘çš„`1~pos-1`åŒºé—´é—ªçƒï¼‰ï¼›  
     3. å¼¹å‡ºæ–‡å­—æç¤ºï¼šã€Œæ­£åœ¨æŸ¥è¯¢s[i] > s[j]çš„æœ€å¤§å€¼â€¦ã€ï¼Œä¼´éšã€Œå®ã€çš„éŸ³æ•ˆï¼›  
     4. è®¡ç®—`v1ã€v2ã€v3`ï¼Œå–æœ€å¤§å€¼ä½œä¸º`dp[i]`ï¼Œ`dp[i]`çš„åƒç´ å—å˜ä¸ºé»„è‰²ï¼›  
   - **æ›´æ–°çº¿æ®µæ ‘**ï¼š  
     1. å°†`dp[i]-j`ã€`dp[i]`ã€`dp[i]+j`å­˜å…¥å¯¹åº”çº¿æ®µæ ‘ï¼Œçº¿æ®µæ ‘å›¾æ ‡é—ªçƒæ›´æ–°çš„ä½ç½®ï¼›  
     2. ä¼´éšã€Œå’”ã€çš„éŸ³æ•ˆï¼Œæç¤ºï¼šã€Œå·²æ›´æ–°çº¿æ®µæ ‘ï¼ã€ã€‚  

4. **ç›®æ ‡è¾¾æˆ**ï¼š  
   - å½“è®¡ç®—å®Œ`dp[n]`æ—¶ï¼Œå±å¹•å¼¹å‡ºã€Œèƒœåˆ©ï¼ã€çš„åƒç´ æ–‡å­—ï¼Œæ’­æ”¾ä¸Šæ‰¬çš„èƒœåˆ©éŸ³æ•ˆï¼ˆå¦‚ã€Šè¶…çº§é©¬é‡Œå¥¥ã€‹çš„é€šå…³éŸ³ä¹ï¼‰ï¼›  
   - `dp[n]`çš„åƒç´ å—å˜ä¸ºå½©è™¹è‰²ï¼Œçªå‡ºæ˜¾ç¤ºæœ€ç»ˆç»“æœã€‚  

5. **äº¤äº’è®¾è®¡**ï¼š  
   - ã€Œå•æ­¥ã€ï¼šç‚¹å‡»åæ‰§è¡Œä¸€æ­¥è®¡ç®—ï¼Œé€‚åˆä»”ç»†è§‚å¯Ÿï¼›  
   - ã€Œè‡ªåŠ¨æ’­æ”¾ã€ï¼šæŒ‰é€‰æ‹©çš„é€Ÿåº¦è¿ç»­æ‰§è¡Œï¼Œé€‚åˆæ•´ä½“æŠŠæ¡æµç¨‹ï¼›  
   - ã€Œé‡ç½®ã€ï¼šå›åˆ°åˆå§‹çŠ¶æ€ï¼Œé‡æ–°æ¼”ç¤ºã€‚  


## 6. æ‹“å±•ç»ƒä¹ ä¸ç›¸ä¼¼é—®é¢˜æ€è€ƒ

### é€šç”¨æ€è·¯è¿ç§»  
æœ¬é¢˜çš„æ ¸å¿ƒæ€è·¯â€”â€”**ã€ŒDP+æ•°æ®ç»“æ„ä¼˜åŒ–ã€**â€”â€”å¯ç”¨äºè§£å†³ä»¥ä¸‹é—®é¢˜ï¼š  
1. **æœ€é•¿ä¸Šå‡å­åºåˆ—ï¼ˆLISï¼‰**ï¼šç”¨çº¿æ®µæ ‘/æ ‘çŠ¶æ•°ç»„ç»´æŠ¤å‰ç¼€æœ€å¤§ï¼Œå°†O(nÂ²)ä¼˜åŒ–åˆ°O(n log n)ï¼›  
2. **æœ€å¤§å­æ®µå’Œçš„å˜å½¢**ï¼šæ¯”å¦‚å¸¦æƒçš„å­æ®µå’Œé—®é¢˜ï¼Œéœ€è¦æ ¹æ®å­æ®µå’Œçš„æ¡ä»¶é€‰æ‹©è½¬ç§»ï¼›  
3. **äºŒç»´å‰ç¼€å’Œçš„DPä¼˜åŒ–**ï¼šæ¯”å¦‚äºŒç»´æ•°ç»„ä¸­çš„è·¯å¾„é—®é¢˜ï¼Œéœ€è¦ç»´æŠ¤äºŒç»´çš„æœ€å¤§å€¼ã€‚


### æ´›è°·ç»ƒä¹ æ¨è  
1. **æ´›è°· P3957 è·³æˆ¿å­**  
   ğŸ—£ï¸ **æ¨èç†ç”±**ï¼šè¿™æ˜¯ä¸€é“ç»å…¸çš„ã€ŒDP+çº¿æ®µæ ‘ä¼˜åŒ–ã€é—®é¢˜ï¼Œéœ€è¦ç»´æŠ¤åŒºé—´æœ€å¤§å€¼ï¼Œä¸æœ¬é¢˜çš„æ€è·¯é«˜åº¦ç›¸ä¼¼ã€‚  
2. **æ´›è°· P1439 æœ€é•¿å…¬å…±å­åºåˆ—**  
   ğŸ—£ï¸ **æ¨èç†ç”±**ï¼šç”¨æ ‘çŠ¶æ•°ç»„ä¼˜åŒ–LISçš„å˜å½¢é—®é¢˜ï¼Œé”»ç‚¼ã€Œå°†é—®é¢˜è½¬åŒ–ä¸ºå‰ç¼€æŸ¥è¯¢ã€çš„èƒ½åŠ›ã€‚  
3. **æ´›è°· P8865 [NOIP2022] å–µäº†ä¸ªå–µ**  
   ğŸ—£ï¸ **æ¨èç†ç”±**ï¼šè™½ç„¶æ˜¯æ¨¡æ‹Ÿé¢˜ï¼Œä½†éœ€è¦ç”¨åˆ°ã€ŒçŠ¶æ€å‹ç¼©+æ•°æ®ç»“æ„ä¼˜åŒ–ã€ï¼Œæ‹“å±•æ€ç»´è¾¹ç•Œã€‚  


## 7. å­¦ä¹ å¿ƒå¾—ä¸ç»éªŒåˆ†äº« (è‹¥æœ‰)

> **å‚è€ƒç»éªŒï¼ˆæ¥è‡ªJjy123ï¼‰**ï¼šã€Œæˆ‘åœ¨è§£å†³è¿™ä¸ªé—®é¢˜æ—¶ï¼Œæœ€åˆåœ¨ç¦»æ•£åŒ–å’Œçº¿æ®µæ ‘çš„è¾¹ç•Œå¤„ç†ä¸Šå¡äº†å¾ˆä¹…ï¼Œåæ¥é€šè¿‡æ‰“å°ä¸­é—´å˜é‡ï¼ˆæ¯”å¦‚ç¦»æ•£åŒ–åçš„å‰ç¼€å’Œæ˜ å°„ï¼‰æ‰å®šä½åˆ°é—®é¢˜ã€‚è¿™è®©æˆ‘æ„è¯†åˆ°ï¼ŒåŠ¨æ€è§„åˆ’çš„ä¼˜åŒ–é—®é¢˜ï¼Œç»†èŠ‚æ¯”æ€è·¯æ›´é‡è¦ã€‚ã€  

**ç‚¹è¯„**ï¼šè¿™ä½ä½œè€…çš„ç»éªŒéå¸¸å…¸å‹ï¼åœ¨DPä¼˜åŒ–é—®é¢˜ä¸­ï¼Œ**ç¦»æ•£åŒ–çš„æ­£ç¡®æ€§**ï¼ˆæ¯”å¦‚æ˜¯å¦åŒ…å«`s[0]`ï¼‰ã€**æ•°æ®ç»“æ„çš„è¾¹ç•Œå¤„ç†**ï¼ˆæ¯”å¦‚çº¿æ®µæ ‘çš„æŸ¥è¯¢èŒƒå›´æ˜¯å¦è¶Šç•Œï¼‰å¾€å¾€æ˜¯bugçš„æ ¹æºã€‚è§£å†³è¿™ç±»é—®é¢˜çš„æœ‰æ•ˆæ–¹æ³•æ˜¯ï¼š  
1. æ‰“å°ä¸­é—´å˜é‡ï¼ˆå¦‚ç¦»æ•£åŒ–åçš„æ˜ å°„è¡¨ã€çº¿æ®µæ ‘çš„èŠ‚ç‚¹å€¼ï¼‰ï¼›  
2. ç”¨å°æ•°æ®æµ‹è¯•ï¼ˆæ¯”å¦‚æ ·ä¾‹è¾“å…¥ï¼‰ï¼Œé€æ­¥éªŒè¯æ¯ä¸€æ­¥çš„æ­£ç¡®æ€§ã€‚  


## ç»“è¯­  
æœ¬æ¬¡å…³äºã€ŒOptimal Partitionã€çš„åˆ†æï¼Œæˆ‘ä»¬å­¦ä¹ äº†**åŠ¨æ€è§„åˆ’çš„æ‹†åˆ†æŠ€å·§**å’Œ**çº¿æ®µæ ‘/æ ‘çŠ¶æ•°ç»„çš„ä¼˜åŒ–æ–¹æ³•**ã€‚è®°ä½ï¼šDPä¼˜åŒ–çš„æ ¸å¿ƒæ˜¯ã€Œå°†ä¾èµ–å…³ç³»è½¬åŒ–ä¸ºæ•°æ®ç»“æ„çš„æŸ¥è¯¢æ“ä½œã€â€”â€”å½“ä½ é‡åˆ°O(nÂ²)çš„DPæ—¶ï¼Œå…ˆæƒ³æƒ³èƒ½ä¸èƒ½æŠŠè½¬ç§»æ–¹ç¨‹æ‹†æˆã€Œä¸iç›¸å…³ã€å’Œã€Œä¸jç›¸å…³ã€çš„ä¸¤éƒ¨åˆ†ï¼Œå†ç”¨æ•°æ®ç»“æ„å¿«é€ŸæŸ¥è¯¢ï¼  

ç¼–ç¨‹èƒ½åŠ›çš„æå‡ï¼Œåœ¨äºã€Œæ€è€ƒ+å®è·µã€â€”â€”å¤šåšç›¸ä¼¼é¢˜ï¼Œå¤šæ€»ç»“æŠ€å·§ï¼Œä½ ä¸€å®šèƒ½æˆä¸ºDPä¼˜åŒ–çš„é«˜æ‰‹ï¼ğŸ’ª

---
å¤„ç†ç”¨æ—¶ï¼š108.91ç§’
# é¢˜ç›®ä¿¡æ¯

# DFS Checker (Hard Version)

## é¢˜ç›®æè¿°

This is the hard version of the problem. In this version, you are given a generic tree and the constraints on $ n $ and $ q $ are higher. You can make hacks only if both versions of the problem are solved.

You are given a rooted tree consisting of $ n $ vertices. The vertices are numbered from $ 1 $ to $ n $ , and the root is the vertex $ 1 $ . You are also given a permutation $ p_1, p_2, \ldots, p_n $ of $ [1,2,\ldots,n] $ .

You need to answer $ q $ queries. For each query, you are given two integers $ x $ , $ y $ ; you need to swap $ p_x $ and $ p_y $ and determine if $ p_1, p_2, \ldots, p_n $ is a valid DFS order $ ^\dagger $ of the given tree.

Please note that the swaps are persistent through queries.

 $ ^\dagger $ A DFS order is found by calling the following $ \texttt{dfs} $ function on the given tree.

```
<pre class="lstlisting">```
dfs_order = []<br></br><br></br>function dfs(v):<br></br>    append v to the back of dfs_order<br></br>    pick an arbitrary permutation s of children of v<br></br>    for child in s:<br></br>        dfs(child)<br></br>dfs(1)<br></br>
```
```

Note that the DFS order is not unique.

## è¯´æ˜/æç¤º

In the first test case, the permutation $ p_1, p_2, \ldots, p_n $ after each modification is $ [1,3,2],[1,2,3],[3,2,1] $ , respectively. The first two permutations are valid DFS orders; the third is not a DFS order.

In the second test case, the permutation $ p_1, p_2, \ldots, p_n $ after each modification is $ [1,2,5,4,3,6,7],[1,3,5,4,2,6,7],[1,3,7,4,2,6,5],[1,3,7,6,2,4,5] $ , respectively.

## æ ·ä¾‹ #1

### è¾“å…¥

```
3
3 3
1 1
1 2 3
2 3
3 2
1 3
7 4
1 1 2 2 3 3
1 2 3 4 5 6 7
3 5
2 5
3 7
4 6
5 4
1 1 3 4
2 3 4 5 1
5 1
4 5
3 4
2 3```

### è¾“å‡º

```
YES
YES
NO
YES
NO
NO
YES
YES
NO
NO
YES```

# AIåˆ†æç»“æœ


### ğŸ’¡ Kayçš„C++ç®—æ³•è§£æï¼šDFS Checker (Hard Version) æ·±å…¥å­¦ä¹ æŒ‡å— ğŸ’¡

#### **1. é¢˜ç›®è§£è¯»ä¸æ ¸å¿ƒç®—æ³•è¯†åˆ«**
âœ¨ **æœ¬é¢˜ä¸»è¦è€ƒå¯Ÿ**ï¼š`æ ‘éå†ä¸æ€§è´¨åº”ç”¨`  

ğŸ—£ï¸ **åˆæ­¥åˆ†æ**ï¼š
> è§£å†³DFSåºåˆæ³•æ€§éªŒè¯é—®é¢˜ï¼Œå…³é”®åœ¨äºç†è§£**æ ‘ç»“æ„çš„éå†æ€§è´¨**ã€‚æƒ³è±¡ä¸€æ£µæ ‘å¦‚åŒè¿·å®«ï¼ŒDFSåºå°±æ˜¯æ¢ç´¢è·¯å¾„çš„è®°å½•ã€‚æ ¸å¿ƒæ€è·¯æ˜¯ï¼šç›¸é‚»èŠ‚ç‚¹å¿…é¡»æ»¡è¶³**çˆ¶å­å…³ç³»**æˆ–**ç¥–å…ˆ-åä»£å…³ç³»**ï¼Œå³åä¸€ä¸ªèŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹å¿…é¡»æ˜¯å‰ä¸€ä¸ªèŠ‚ç‚¹çš„ç¥–å…ˆã€‚  
> - é¢˜è§£æ ¸å¿ƒæ€è·¯ï¼šç»´æŠ¤ç›¸é‚»èŠ‚ç‚¹å¯¹çš„åˆæ³•æ€§è®¡æ•°ï¼Œäº¤æ¢æ—¶ä»…æ›´æ–°å±€éƒ¨å…³ç³»ã€‚  
> - å¯è§†åŒ–è®¾è®¡ï¼šé‡‡ç”¨**8ä½åƒç´ è¿·å®«é£æ ¼**ï¼Œæ ‘èŠ‚ç‚¹åŒ–ä¸ºåƒç´ æ–¹å—ï¼Œè·¯å¾„æ¢ç´¢è¿‡ç¨‹èå…¥éŸ³æ•ˆï¼ˆå¦‚â€œå®â€å£°è¡¨ç¤ºåˆæ³•å…³ç³»ï¼‰ã€‚é«˜äº®å½“å‰æ“ä½œçš„ç›¸é‚»èŠ‚ç‚¹å¯¹ï¼Œè‡ªåŠ¨æ¼”ç¤ºæ¨¡å¼æ¨¡æ‹Ÿâ€œAIæ¢é™©å®¶â€å¯»è·¯è¿‡ç¨‹ã€‚

---

#### **2. ç²¾é€‰ä¼˜è´¨é¢˜è§£å‚è€ƒ**
**é¢˜è§£ä¸€ï¼ˆä½œè€…ï¼š_liuyi_ï¼‰**  
* **ç‚¹è¯„**ï¼šæ€è·¯ç›´å‡»æ ¸å¿ƒâ€”â€”ç”¨`dfn`ï¼ˆDFSåºç¼–å·ï¼‰å’Œ`sz`ï¼ˆå­æ ‘å¤§å°ï¼‰é«˜æ•ˆåˆ¤æ–­ç¥–å…ˆå…³ç³»ã€‚ä»£ç ç®€æ´è§„èŒƒï¼ˆå¦‚`calc(i)`å‡½æ•°å°è£…å…³ç³»åˆ¤æ–­ï¼‰ï¼Œå®è·µä»·å€¼æé«˜ï¼ˆO(n+q)å¤æ‚åº¦ï¼‰ã€‚äº®ç‚¹ï¼š**äº¤æ¢æ—¶ä»…æ›´æ–°ç›¸é‚»çš„4ä¸ªä½ç½®**ï¼Œé¿å…å…¨å±€é‡ç®—ã€‚

**é¢˜è§£äºŒï¼ˆä½œè€…ï¼šRay662ï¼‰**  
* **ç‚¹è¯„**ï¼šåˆ›æ–°æ€§åœ°å¼•å…¥`f[i]`æ ‡è®°ç›¸é‚»åˆæ³•æ€§ï¼Œç”¨`cnt`ç»Ÿè®¡åˆæ³•å¯¹æ•°ã€‚ä»£ç ä¸¥è°¨å¤„ç†è¾¹ç•Œï¼ˆå¦‚ç‰¹åˆ¤ä¸‹æ ‡è¶Šç•Œï¼‰ï¼ŒLCAä¼˜åŒ–æå‡æ•ˆç‡ã€‚äº®ç‚¹ï¼š**å°†DFSåºæŠ½è±¡ä¸ºé€»è¾‘æ ‡è®°**ï¼Œå¤§å¹…é™ä½ç»´æŠ¤éš¾åº¦ã€‚

**é¢˜è§£ä¸‰ï¼ˆä½œè€…ï¼šmasonxiongï¼‰**  
* **ç‚¹è¯„**ï¼šä¸¥æ ¼è¯æ˜DFSåºçš„å……è¦æ¡ä»¶ï¼ˆåä¸€èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹æ˜¯å‰ä¸€èŠ‚ç‚¹çš„ç¥–å…ˆï¼‰ï¼Œä»£ç æ¨¡å—åŒ–æ¸…æ™°ï¼ˆ`isAncestor`å‡½æ•°ç‹¬ç«‹å°è£…ï¼‰ã€‚äº®ç‚¹ï¼š**æ•°å­¦åŒ–è¯æ˜æå‡ç†è§£æ·±åº¦**ï¼Œé€‚åˆè¿›é˜¶å­¦ä¹ ã€‚

---

#### **3. æ ¸å¿ƒéš¾ç‚¹è¾¨æä¸è§£é¢˜ç­–ç•¥**
1. **éš¾ç‚¹1ï¼šç†è§£DFSåºçš„åˆæ³•æ€§æ¡ä»¶**  
   * **åˆ†æ**ï¼šåˆæ³•DFSåºè¦æ±‚ç›¸é‚»èŠ‚ç‚¹æ»¡è¶³ä¸¥æ ¼ç¥–å…ˆå…³ç³»ï¼ˆå¦‚é¢˜è§£3çš„å……è¦æ¡ä»¶è¯æ˜ï¼‰ã€‚ä¼˜è´¨é¢˜è§£é€šè¿‡`dfn`å’Œ`sz`æ•°ç»„ï¼ˆ`dfn[u] â‰¤ dfn[v] â‰¤ dfn[u]+sz[u]-1`ï¼‰å®ç°O(1)åˆ¤æ–­ã€‚  
   * ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šç¥–å…ˆå…³ç³»åˆ¤æ–­æ˜¯æ ‘é—®é¢˜çš„åŸºçŸ³ã€‚  

2. **éš¾ç‚¹2ï¼šé«˜æ•ˆç»´æŠ¤äº¤æ¢åçš„åˆæ³•æ€§**  
   * **åˆ†æ**ï¼šäº¤æ¢æ“ä½œä»…å½±å“å±€éƒ¨ï¼ˆæœ€å¤š6ä¸ªç›¸é‚»å…³ç³»ï¼‰ï¼Œæ— éœ€å…¨å±€é‡ç®—ã€‚é¢˜è§£1ç”¨`set`æ”¶é›†å¾…æ›´æ–°ä½ç½®ï¼Œé¢˜è§£2ç”¨`f[i]`æ ‡è®°ï¼Œå‡å®ç°O(1)æ›´æ–°ã€‚  
   * ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šå±€éƒ¨æ›´æ–°æ˜¯ä¼˜åŒ–æŒä¹…åŒ–æ“ä½œçš„å…³é”®ã€‚  

3. **éš¾ç‚¹3ï¼šé¿å…è¾¹ç•Œæ¡ä»¶é”™è¯¯**  
   * **åˆ†æ**ï¼šä¸‹æ ‡è¶Šç•Œï¼ˆå¦‚`x-1=0`ï¼‰éœ€ç‰¹åˆ¤ã€‚é¢˜è§£2ç”¨`st.insert`è‡ªåŠ¨å»é‡ï¼Œé¢˜è§£5æ˜¾å¼æ£€æŸ¥`y<n`ï¼Œç¡®ä¿ä»£ç é²æ£’æ€§ã€‚  
   * ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šè¾¹ç•Œå¤„ç†æ˜¯ç«èµ›ä»£ç çš„å¸¸è§é™·é˜±ã€‚  

### âœ¨ è§£é¢˜æŠ€å·§æ€»ç»“
- **æŠ€å·§1ï¼šé—®é¢˜è½¬åŒ–** â€“ å°†å…¨å±€åˆæ³•æ€§è½¬ä¸ºç›¸é‚»èŠ‚ç‚¹å¯¹çš„å±€éƒ¨éªŒè¯ï¼ˆå¦‚é¢˜è§£1çš„`res==n-1`ï¼‰ã€‚  
- **æŠ€å·§2ï¼šæ ‘æ€§è´¨åº”ç”¨** â€“ ç”¨`dfn`å’Œ`sz`æ•°ç»„å°†ç¥–å…ˆåˆ¤æ–­è½¬ä¸ºåŒºé—´åŒ…å«é—®é¢˜ï¼ˆ`[dfn[u], dfn[u]+sz[u]]`ï¼‰ã€‚  
- **æŠ€å·§3ï¼šå¢é‡æ›´æ–°** â€“ äº¤æ¢æ—¶ä»…ä¿®æ”¹å—å½±å“çš„ä½ç½®ï¼ˆå¦‚é¢˜è§£1çš„`set<int> st`ï¼‰ã€‚  

---

#### **4. C++æ ¸å¿ƒä»£ç å®ç°èµæ**
**é€šç”¨æ ¸å¿ƒC++å®ç°å‚è€ƒ**  
* **è¯´æ˜**ï¼šç»¼åˆé¢˜è§£1å’Œé¢˜è§£3ï¼Œç”¨`dfn`å’Œ`sz`åˆ¤æ–­ç¥–å…ˆå…³ç³»ï¼Œç»´æŠ¤åˆæ³•æ€§è®¡æ•°ã€‚  
* **å®Œæ•´æ ¸å¿ƒä»£ç **ï¼š
  ```cpp
  #include <bits/stdc++.h>
  using namespace std;
  const int N=3e5+10;
  vector<int> e[N];
  int n,q,dfn[N],sz[N],fa[N],p[N],res;

  void dfs(int u){
      dfn[u]=++idx; sz[u]=1;
      for(int v:e[u]) dfs(v), sz[u]+=sz[v];
  }

  bool isAnc(int u, int v){ // væ˜¯å¦æ˜¯uçš„ç¥–å…ˆ
      return dfn[u]<=dfn[v] && dfn[v]<dfn[u]+sz[u];
  }

  int valid(int i){ // æ£€æŸ¥p[i-1]å’Œp[i]æ˜¯å¦åˆæ³•
      return (i>1 && isAnc(fa[p[i]], p[i-1]));
  }

  void solve(){
      cin>>n>>q;
      for(int i=2;i<=n;i++) 
          cin>>fa[i], e[fa[i]].push_back(i);
      for(int i=1;i<=n;i++) cin>>p[i];
      dfs(1); res=0;
      for(int i=2;i<=n;i++) res+=valid(i);
      while(q--){
          int x,y; cin>>x>>y;
          set<int> pos = {x, x+1, y, y+1}; // å¾…æ›´æ–°ä½ç½®
          for(int i:pos) res -= valid(i);
          swap(p[x],p[y]);
          for(int i:pos) res += valid(i);
          cout<<(res==n-1?"YES":"NO")<<'\n';
      }
  }
  ```
* **ä»£ç è§£è¯»æ¦‚è¦**ï¼š  
  > 1. `dfs`é¢„å¤„ç†`dfn`å’Œ`sz`ï¼›  
  > 2. `isAnc`ç”¨åŒºé—´åˆ¤æ–­ç¥–å…ˆå…³ç³»ï¼›  
  > 3. äº¤æ¢æ—¶æ›´æ–°å—å½±å“çš„ä½ç½®ï¼ˆ`set`å»é‡ï¼‰ï¼›  
  > 4. æœ€ç»ˆæ£€æŸ¥åˆæ³•å¯¹æ•°`res`æ˜¯å¦ä¸º`n-1`ã€‚  

**é¢˜è§£ä¸€ç‰‡æ®µèµæ**  
* **äº®ç‚¹**ï¼šç”¨`set`ç²¾å‡†å®šä½éœ€æ›´æ–°çš„ç›¸é‚»å…³ç³»ã€‚  
* **æ ¸å¿ƒä»£ç **ï¼š
  ```cpp
  set<int> st = {x, x+1, y, y+1};
  for(auto i:st) res -= calc(i); // æ’¤é”€æ—§å€¼
  swap(p[x],p[y]);
  for(auto i:st) res += calc(i); // æ›´æ–°æ–°å€¼
  ```
* **ä»£ç è§£è¯»**ï¼š  
  > `set`æ”¶é›†äº¤æ¢åå¯èƒ½å˜åŒ–çš„4ä¸ªä½ç½®ï¼ˆ`x-1`åˆ°`x+1`, `y-1`åˆ°`y+1`ï¼‰ï¼Œé¿å…é‡å¤æ›´æ–°ã€‚`calc(i)`åˆ¤æ–­ä½ç½®`i`çš„ç›¸é‚»å…³ç³»åˆæ³•æ€§ï¼Œ`res`ç»Ÿè®¡æ€»åˆæ³•å¯¹æ•°ã€‚  
* ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼š`set`å»é‡æ˜¯é«˜æ•ˆå±€éƒ¨æ›´æ–°çš„ç»å…¸æŠ€å·§ã€‚  

**é¢˜è§£äºŒç‰‡æ®µèµæ**  
* **äº®ç‚¹**ï¼šç”¨`f[i]`æ ‡è®°æ¯å¯¹ç›¸é‚»èŠ‚ç‚¹çš„åˆæ³•æ€§ã€‚  
* **æ ¸å¿ƒä»£ç **ï¼š
  ```cpp
  int f[N]; // f[i]=1è¡¨ç¤ºä½ç½®iåˆæ³•
  void update(int pos){
      if(pos<1 || pos>=n) return;
      int old = f[pos];
      f[pos] = isAnc(fa[p[pos+1]], p[pos]); // é‡æ–°è®¡ç®—åˆæ³•æ€§
      if(old!=f[pos]) cnt += f[pos]-old; // æ›´æ–°è®¡æ•°å™¨
  }
  ```
* **ä»£ç è§£è¯»**ï¼š  
  > äº¤æ¢åè°ƒç”¨`update(x-1)`, `update(x)`, `update(y-1)`, `update(y)`ï¼Œä»…ä¿®æ”¹å—å½±å“çš„`f[i]`ã€‚`cnt`è®°å½•å½“å‰åˆæ³•å¯¹æ•°ã€‚  
* ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šé€»è¾‘æ ‡è®°ï¼ˆ`f[i]`ï¼‰ç®€åŒ–çŠ¶æ€ç»´æŠ¤ã€‚  

---

#### **5. ç®—æ³•å¯è§†åŒ–ï¼šåƒç´ åŠ¨ç”»æ¼”ç¤º**
**è®¾è®¡æ€è·¯**ï¼š  
> é‡‡ç”¨**8ä½è¿·å®«æ¢é™©é£æ ¼**ï¼Œæ ‘èŠ‚ç‚¹åŒ–ä¸ºå½©è‰²åƒç´ å—ï¼ˆæ ¹èŠ‚ç‚¹é‡‘è‰²ï¼‰ï¼ŒDFSåºæ˜¾ç¤ºä¸ºè·¯å¾„ã€‚éŸ³æ•ˆå¼ºåŒ–æ“ä½œåé¦ˆï¼ˆå¦‚â€œå®â€å£°è¡¨ç¤ºåˆæ³•å…³ç³»ï¼‰ã€‚  

**åŠ¨ç”»æ­¥éª¤**ï¼š  
1. **åˆå§‹åŒ–**ï¼šæ ‘ç»“æ„åŒ–ä¸ºåƒç´ ç½‘æ ¼ï¼Œæ§åˆ¶é¢æ¿å«`é€Ÿåº¦æ»‘å—`å’Œ`å•æ­¥/è‡ªåŠ¨`æŒ‰é’®ã€‚  
2. **äº¤æ¢æ¼”ç¤º**ï¼š  
   - é«˜äº®äº¤æ¢çš„èŠ‚ç‚¹`p[x]`å’Œ`p[y]`ï¼ˆçº¢è‰²é—ªçƒï¼‰ï¼Œæ’­æ”¾äº¤æ¢éŸ³æ•ˆã€‚  
   - æ›´æ–°å—å½±å“çš„ä½ç½®ï¼ˆé»„æ¡†é—ªçƒï¼‰ï¼Œé‡æ–°è®¡ç®—ç›¸é‚»å…³ç³»ã€‚  
3. **åˆæ³•æ€§æ£€æŸ¥**ï¼š  
   - åˆæ³•ç›¸é‚»å¯¹æ˜¾ç¤ºç»¿è‰²è¿æ¥çº¿ï¼Œå¤±è´¥æ˜¾ç¤ºçº¢è‰²å‰ã€‚  
   - æˆåŠŸæ—¶æ’­æ”¾èƒœåˆ©éŸ³æ•ˆï¼Œè·¯å¾„é«˜äº®ï¼›å¤±è´¥æ—¶æ’­æ”¾æç¤ºéŸ³ã€‚  
4. **æ¸¸æˆåŒ–å…ƒç´ **ï¼š  
   - æ¯å®Œæˆä¸€æ¬¡äº¤æ¢ä¸ºâ€œå°å…³â€ï¼Œç§¯åˆ†+10ï¼›è¿ç»­åˆæ³•åˆ™â€œè¿å‡»å¥–åŠ±â€ã€‚  
   - è‡ªåŠ¨æ¼”ç¤ºæ¨¡å¼å¦‚â€œè´ªåƒè›‡AIâ€ï¼Œé€æ­¥å±•ç¤ºè·¯å¾„å˜åŒ–ã€‚  

**æŠ€æœ¯å®ç°**ï¼š  
> Canvasç»˜åˆ¶æ ‘ç½‘æ ¼ï¼Œ`requestAnimationFrame`æ§åˆ¶å¸§ç‡ï¼ŒéŸ³æ•ˆç”¨Web Audio APIã€‚  

---

#### **6. æ‹“å±•ç»ƒä¹ ä¸ç›¸ä¼¼é—®é¢˜æ€è€ƒ**
- **é€šç”¨æŠ€å·§è¿ç§»**ï¼šç¥–å…ˆåˆ¤æ–­ï¼ˆ`dfn/sz`ï¼‰é€‚ç”¨äºï¼š  
  1. LCAé—®é¢˜ï¼ˆå¦‚åˆ¤æ–­ä¸¤ç‚¹è·¯å¾„ï¼‰  
  2. å­æ ‘æŸ¥è¯¢ï¼ˆå¦‚ç»Ÿè®¡å­æ ‘å’Œï¼‰  
  3. æ ‘é“¾å‰–åˆ†ï¼ˆè·¯å¾„æ›´æ–°ï¼‰  

- **æ´›è°·é¢˜ç›®æ¨è**ï¼š  
  1. **P3379**ï¼ˆLCAæ¨¡æ¿ï¼‰ â€“ å·©å›º`dfn/sz`åˆ¤æ–­ç¥–å…ˆå…³ç³»çš„åº”ç”¨ã€‚  
  2. **P3916**ï¼ˆå›¾çš„éå†ï¼‰ â€“ DFSåºçš„å˜å½¢ï¼Œç»ƒä¹ åå‘å»ºå›¾ã€‚  
  3. **P1364**ï¼ˆæ ‘çš„é‡å¿ƒï¼‰ â€“ ç»“åˆå­æ ‘å¤§å°æ€§è´¨æ‹“å±•æ€ç»´ã€‚  

---

#### **7. å­¦ä¹ å¿ƒå¾—ä¸ç»éªŒåˆ†äº«**
> **å‚è€ƒç»éªŒ**ï¼ˆé¢˜è§£1ä½œè€…ï¼‰ï¼š  
> â€œäº¤æ¢æ—¶æ³¨æ„ç›¸é‚»ä½ç½®å»é‡ï¼Œé¿å…é‡å¤æ›´æ–°ã€‚â€  
>   
> **ç‚¹è¯„**ï¼š  
> ä½œè€…çš„ç»éªŒå‡¸æ˜¾äº†**å±€éƒ¨æ›´æ–°**çš„é‡è¦æ€§ã€‚åœ¨æ ‘é—®é¢˜ä¸­ï¼Œè¯†åˆ«å½±å“èŒƒå›´ï¼ˆå¦‚äº¤æ¢æ—¶çš„6ä¸ªä½ç½®ï¼‰èƒ½å¤§å¹…æå‡æ•ˆç‡ï¼Œè¿™æ˜¯ç«èµ›ç¼–ç¨‹çš„æ ¸å¿ƒæ€ç»´ã€‚  

---
æœ¬æ¬¡åˆ†ææ—¨åœ¨å¸®åŠ©å¤§å®¶æŒæ¡DFSåºéªŒè¯çš„æ ¸å¿ƒæŠ€å·§ã€‚è®°ä½ï¼šæ ‘é—®é¢˜çš„å…³é”®åœ¨äº**ç†è§£éå†æ€§è´¨+é«˜æ•ˆç»´æŠ¤çŠ¶æ€**ã€‚å¤šç»ƒä¹ å±€éƒ¨æ›´æ–°å’Œæ ‘æ€§è´¨åº”ç”¨ï¼Œå®šèƒ½æ¸¸åˆƒæœ‰ä½™ï¼ğŸ’ª

---
å¤„ç†ç”¨æ—¶ï¼š116.41ç§’
# é¢˜ç›®ä¿¡æ¯

# Inversions problem

## é¢˜ç›®æè¿°

You are given a permutation of $ n $ numbers $ p_{1},p_{2},...,p_{n} $ . We perform $ k $ operations of the following type: choose uniformly at random two indices $ l $ and $ r $ ( $ l<=r $ ) and reverse the order of the elements $ p_{l},p_{l+1},...,p_{r} $ . Your task is to find the expected value of the number of inversions in the resulting permutation.

## è¯´æ˜/æç¤º

Consider the first sample test. We will randomly pick an interval of the permutation $ (1,2,3) $ (which has no inversions) and reverse the order of its elements. With probability ![](https://cdn.luogu.com.cn/upload/vjudge_pic/CF513G1/6201067a97da7a97c457211e210f5a8e998bdde9.png), the interval will consist of a single element and the permutation will not be altered. With probability ![](https://cdn.luogu.com.cn/upload/vjudge_pic/CF513G1/f7ba68e3a158029dadd77767404a7d3ca97f69d2.png) we will inverse the first two elements' order and obtain the permutation $ (2,1,3) $ which has one inversion. With the same probability we might pick the interval consisting of the last two elements which will lead to the permutation $ (1,3,2) $ with one inversion. Finally, with probability ![](https://cdn.luogu.com.cn/upload/vjudge_pic/CF513G1/f7ba68e3a158029dadd77767404a7d3ca97f69d2.png) the randomly picked interval will contain all elements, leading to the permutation $ (3,2,1) $ with 3 inversions. Hence, the expected number of inversions is equal to ![](https://cdn.luogu.com.cn/upload/vjudge_pic/CF513G1/35fd27aec725b8812c04480f588647c66aec3f9c.png).

## æ ·ä¾‹ #1

### è¾“å…¥

```
3 1
1 2 3
```

### è¾“å‡º

```
0.833333333333333
```

## æ ·ä¾‹ #2

### è¾“å…¥

```
3 4
1 3 2
```

### è¾“å‡º

```
1.458333333333334
```

# AIåˆ†æç»“æœ


### ğŸ’¡ Kayçš„C++ç®—æ³•è§£æï¼šInversions Problem æ·±å…¥å­¦ä¹ æŒ‡å— ğŸ’¡

#### é¢˜ç›®è§£è¯»ä¸æ ¸å¿ƒç®—æ³•è¯†åˆ«
âœ¨ **æœ¬é¢˜ä¸»è¦è€ƒå¯Ÿ**ï¼šæ¦‚ç‡åŠ¨æ€è§„åˆ’  
ğŸ—£ï¸ **åˆæ­¥åˆ†æ**ï¼š  
> è§£å†³é€†åºå¯¹æœŸæœ›é—®é¢˜ï¼Œæ ¸å¿ƒåœ¨äº**æ¦‚ç‡åŠ¨æ€è§„åˆ’**ã€‚æƒ³è±¡ä½ åœ¨ç©ä¸€ä¸ªéšæœºç¿»è½¬å¡ç‰Œçš„æ¸¸æˆï¼Œæ¯æ¬¡éšæœºç¿»åŠ¨ä¸€æ®µå¡ç‰Œï¼Œæœ€ç»ˆè®¡ç®—ç‰Œé¢é€†åºå¯¹æ•°é‡çš„å¹³å‡å€¼ã€‚  
> - **æ ¸å¿ƒæ€è·¯**ï¼šå°†æ•´ä½“æœŸæœ›åˆ†è§£ä¸ºæ¯å¯¹ä½ç½®(i,j)å½¢æˆé€†åºå¯¹çš„æ¦‚ç‡å’Œã€‚é€šè¿‡å››ç±»ç¿»è½¬å½±å“åˆ†æï¼ˆå®Œå…¨ä¸è¦†ç›–ã€è¦†ç›–iä¸è¦†ç›–jã€è¦†ç›–jä¸è¦†ç›–iã€åŒæ—¶è¦†ç›–ï¼‰ï¼Œç”¨ç»„åˆæ•°å­¦è®¡ç®—è½¬ç§»æ¦‚ç‡ã€‚  
> - **å¯è§†åŒ–è®¾è®¡**ï¼šå°†ç”¨åƒç´ ç½‘æ ¼å±•ç¤ºæ’åˆ—ï¼Œé«˜äº®ç¿»è½¬åŒºé—´å’Œç§»åŠ¨çš„ä½ç½®å¯¹ã€‚å½“ç¿»è½¬å‘ç”Ÿæ—¶ï¼Œå¯¹åº”ä½ç½®ä¼šé—ªçƒå¹¶æ’­æ”¾8ä½éŸ³æ•ˆï¼Œè‡ªåŠ¨æ¼”ç¤ºæ¨¡å¼å°†é€æ­¥å±•ç¤ºæ¦‚ç‡å¦‚ä½•éšç¿»è½¬æ›´æ–°ã€‚  

---

#### ç²¾é€‰ä¼˜è´¨é¢˜è§£å‚è€ƒ
**é¢˜è§£ä¸€ï¼ˆæ¥æºï¼šJerrywang09ï¼‰**  
* **ç‚¹è¯„**ï¼š  
  æ€è·¯æ¸…æ™°åº¦æé«˜ï¼Œå°†å¤æ‚æœŸæœ›é—®é¢˜è½¬åŒ–ä¸ºä½ç½®å¯¹æ¦‚ç‡å’Œï¼Œå››ç±»ç¿»è½¬å½±å“åˆ†æå…¨é¢ï¼ˆå¦‚å›¾1ï¼‰ã€‚ä»£ç è§„èŒƒï¼š  
  - å˜é‡åå¦‚`f[i][j]`ç›´æ¥ä½“ç°çŠ¶æ€å«ä¹‰  
  - ç»„åˆæ•°å‡½æ•°`C(x)`å°è£…æ•°å­¦é€»è¾‘  
  - æ»šåŠ¨æ•°ç»„ä¼˜åŒ–ç©ºé—´å¤æ‚åº¦  
  ç®—æ³•äº®ç‚¹ï¼š  
  - ç”¨`min(min(i,i+k), j-max(i,i+k))`é«˜æ•ˆè®¡ç®—åŒºé—´æ•°  
  - æ“ä½œæ¬¡æ•°ä¸900å–æœ€å°å€¼é¿å…æ— æ•ˆè®¡ç®—  
  å®è·µä»·å€¼ï¼šå¯ç›´æ¥ç”¨äºç«èµ›ï¼Œè¾¹ç•Œå¤„ç†ä¸¥è°¨ï¼ˆå¦‚`j>i`å§‹ç»ˆæˆç«‹ï¼‰  

---

#### æ ¸å¿ƒéš¾ç‚¹è¾¨æä¸è§£é¢˜ç­–ç•¥
1. **éš¾ç‚¹1ï¼šçŠ¶æ€å®šä¹‰æŠ½è±¡**  
   * **åˆ†æ**ï¼šéœ€ç†è§£`f(t,i,j)`è¡¨ç¤ºä½ç½®å¯¹(i,j)çš„é€†åºæ¦‚ç‡è€Œéå…·ä½“æ•°å€¼ã€‚ä¼˜è´¨é¢˜è§£é€šè¿‡åˆ†è§£æ•´ä½“æœŸæœ›ä¸ºä½ç½®å¯¹å’Œæ¥ç®€åŒ–é—®é¢˜ã€‚  
   * ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šæœŸæœ›é—®é¢˜å¸¸å¯åˆ†è§£ä¸ºåŸºæœ¬äº‹ä»¶æ¦‚ç‡å’Œ  

2. **éš¾ç‚¹2ï¼šç¿»è½¬å½±å“åˆ†æ**  
   * **åˆ†æ**ï¼šå››ç§ç¿»è½¬æƒ…å†µéœ€åˆ†ç±»è®¨è®ºã€‚å¦‚å½“ç¿»è½¬åŒæ—¶è¦†ç›–i,jæ—¶ï¼Œé€†åºçŠ¶æ€å–åï¼ˆ1-f[i][j]ï¼‰ï¼Œéœ€ç†è§£ä½ç½®æ˜ å°„å…³ç³»ã€‚  
   * ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šç¿»è½¬æ“ä½œçš„æœ¬è´¨æ˜¯ä½ç½®æ˜ å°„ï¼Œç”»å›¾è¾…åŠ©æ¨å¯¼  

3. **éš¾ç‚¹3ï¼šé«˜æ•ˆè®¡ç®—åŒºé—´æ•°**  
   * **åˆ†æ**ï¼šé¿å…æšä¸¾æ‰€æœ‰åŒºé—´ï¼Œç”¨`min(A,B)`è®¡ç®—æœ‰æ•ˆåŒºé—´æ•°ã€‚ä¾‹å¦‚è¦†ç›–iä¸è¦†ç›–jæ—¶ï¼ŒåŒºé—´æ•°ä¸º`min(å·¦ä¾§ç©ºé—´, iåˆ°jé—´éš™)`  
   * ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šç»„åˆæ•°å­¦ä¼˜åŒ–æ˜¯é™ä½å¤æ‚åº¦çš„å…³é”®  

**âœ¨ è§£é¢˜æŠ€å·§æ€»ç»“**  
- **é—®é¢˜åˆ†è§£**ï¼šå°†æ•´ä½“æœŸæœ›æ‹†è§£ä¸ºåŸºæœ¬äº‹ä»¶ï¼ˆä½ç½®å¯¹ï¼‰æ¦‚ç‡å’Œ  
- **æ»šåŠ¨æ•°ç»„**ï¼šDPçŠ¶æ€ä»…ä¾èµ–å‰ä¸€è½®æ—¶ï¼Œç”¨åŒæ•°ç»„äº¤æ›¿èŠ‚çœç©ºé—´  
- **è¾¹ç•Œå‹ç¼©**ï¼šå½“æ“ä½œæ¬¡æ•°æå¤§æ—¶ï¼ˆå¦‚k>900ï¼‰ï¼ŒæœŸæœ›å€¼æ”¶æ•›å¯æˆªæ–­  

---

#### C++æ ¸å¿ƒä»£ç å®ç°èµæ
**é€šç”¨æ ¸å¿ƒå®ç°å‚è€ƒ**  
```cpp
#include <bits/stdc++.h>
const int N=105;
int n, m, a[N];
double f[N][N], g[N][N]; // æ»šåŠ¨æ•°ç»„

inline int C(int x) { return x*(x+1)/2; } // ç»„åˆæ•°è®¡ç®—

int main() {
    scanf("%d%d", &n, &m); m = min(m, 900);
    for(int i=1; i<=n; i++) scanf("%d", &a[i]);
    
    // åˆå§‹åŒ–é€†åºå¯¹æ¦‚ç‡
    for(int i=1; i<=n; i++) 
        for(int j=i+1; j<=n; j++) 
            if(a[i] > a[j]) f[i][j] = 1;
    
    double p = 1.0 / C(n); // å•æ¬¡æ“ä½œæ¦‚ç‡
    for(int tt=1; tt<=m; tt++) {
        memset(g, 0, sizeof g);
        for(int i=1; i<=n; i++) for(int j=i+1; j<=n; j++) {
            // æƒ…å†µ1ï¼šç¿»è½¬ä¸è¦†ç›–i,j
            g[i][j] += f[i][j] * p * (C(i-1) + C(n-j) + C(j-i-1));
            // æƒ…å†µ2ï¼šè¦†ç›–iä¸è¦†ç›–j
            for(int k=1-i; k<=j-i-1; k++) 
                g[i+k][j] += f[i][j] * p * min(min(i,i+k), j-max(i,i+k));
            // æƒ…å†µ3ï¼šè¦†ç›–jä¸è¦†ç›–iï¼ˆä»£ç ç±»ä¼¼ç•¥ï¼‰
            // æƒ…å†µ4ï¼šåŒæ—¶è¦†ç›–i,j
            for(int k=1-i; k<=n-j; k++)
                g[i+k][j+k] += (1-f[i][j]) * p * min(min(i,i+k), n-max(j,j+k)+1);
        }
        memcpy(f, g, sizeof f); // æ»šåŠ¨æ›´æ–°
    }
    
    double ans=0;
    for(int i=1; i<=n; i++) for(int j=i+1; j<=n; j++) ans += f[i][j];
    printf("%.15lf\n", ans);
}
```
**ä»£ç è§£è¯»æ¦‚è¦**ï¼š  
> åˆå§‹åŒ–ä½ç½®å¯¹é€†åºæ¦‚ç‡ â†’ è®¡ç®—å•æ¬¡æ“ä½œæ¦‚ç‡ â†’ å››ç±»ç¿»è½¬çŠ¶æ€è½¬ç§» â†’ æ»šåŠ¨æ•°ç»„æ›´æ–° â†’ ç»Ÿè®¡æ€»æœŸæœ›  

---

#### ç®—æ³•å¯è§†åŒ–ï¼šåƒç´ åŠ¨ç”»æ¼”ç¤º
**ä¸»é¢˜**ï¼šå¡ç‰Œç¿»è½¬æ¦‚ç‡å®éªŒå®¤  
**æ ¸å¿ƒæ¼”ç¤º**ï¼š  
![](https://cdn.luogu.com.cn/upload/image_hosting/k10cyary.png)  
1. **åƒç´ åœºæ™¯**ï¼š8-bité£æ ¼æ’åˆ—å±•ç¤ºï¼ˆå¦‚FCæ¸¸æˆï¼‰ï¼Œä½ç½®å¯¹(i,j)ç”¨ä¸åŒé¢œè‰²è¾¹æ¡†æ ‡è®°ï¼ˆçº¢ï¼šé€†åºï¼Œç»¿ï¼šé¡ºåºï¼‰  
2. **ç¿»è½¬åŠ¨ç”»**ï¼š  
   - éšæœºåŒºé—´é«˜äº®é—ªçƒ â†’ å†…éƒ¨å…ƒç´ å¯¹ç§°äº¤æ¢ï¼ˆä¼´éš"å—–"éŸ³æ•ˆï¼‰  
   - ä½ç½®ç§»åŠ¨æ—¶æ˜¾ç¤ºè½¨è¿¹ï¼ˆå¦‚iâ†’i+kï¼‰  
3. **æ¦‚ç‡é¢æ¿**ï¼šå®æ—¶æ˜¾ç¤º`f[i][j]`æ¦‚ç‡çŸ©é˜µï¼ˆé¢œè‰²æ·±æµ…è¡¨ç¤ºæ¦‚ç‡å€¼ï¼‰  
4. **äº¤äº’æ§åˆ¶**ï¼š  
   - æ­¥è¿›æ¨¡å¼ï¼šæŒ‰ç©ºæ ¼å•æ­¥æ‰§è¡Œï¼Œæ˜¾ç¤ºå½“å‰è½¬ç§»å…¬å¼  
   - è‡ªåŠ¨æ¼”ç¤ºï¼šAIæ¨¡æ‹Ÿkæ¬¡æ“ä½œï¼ˆé€Ÿåº¦å¯è°ƒï¼‰  
   - èƒœåˆ©éŸ³æ•ˆï¼šå½“å®Œæˆkæ¬¡æ“ä½œæ—¶æ’­æ”¾8-bitèƒœåˆ©éŸ³ä¹  

---

#### æ‹“å±•ç»ƒä¹ ä¸ç›¸ä¼¼é—®é¢˜
1. **æ´›è°· P1908** é€†åºå¯¹  
   â†’ å·©å›ºåŸºç¡€é€†åºå¯¹è®¡ç®—ï¼ˆå½’å¹¶/æ ‘çŠ¶æ•°ç»„ï¼‰  
2. **æ´›è°· P1966** [NOIP2013] ç«æŸ´æ’é˜Ÿ  
   â†’ é€†åºå¯¹æ¨¡å‹åœ¨æœ€ä¼˜åŒ¹é…ä¸­çš„åº”ç”¨  
3. **æ´›è°· P1774** æœ€æ¥è¿‘ç¥çš„äºº  
   â†’ é€†åºå¯¹è®¡æ•°ä¸åŠ¨æ€è§„åˆ’ç»“åˆ  

---

#### å­¦ä¹ å¿ƒå¾—ä¸ç»éªŒåˆ†äº«
> **é¢˜è§£ä½œè€…æ´å¯Ÿ**ï¼š  
> *"æ¨å¯¼ç¿»è½¬å½±å“æ—¶ï¼Œé€šè¿‡ç”»ä½ç½®æ˜ å°„å›¾ï¼ˆå¦‚å›¾1ï¼‰é¿å…æ€ç»´æ¼æ´"*  
> **Kayç‚¹è¯„**ï¼šå›¾ç¤ºæ³•å¯¹ç†è§£ä½ç½®æ˜ å°„è‡³å…³é‡è¦ï¼Œå»ºè®®ç”¨çº¸ç¬”æ¨¡æ‹Ÿå°æ ·ä¾‹ï¼ˆå¦‚n=3ï¼‰éªŒè¯çŠ¶æ€è½¬ç§»  

---  
**æœ€ç»ˆè¾“å‡º**ï¼šé€†åºå¯¹æœŸæœ›é—®é¢˜æœ¬è´¨æ˜¯æ¦‚ç‡DPï¼Œæ ¸å¿ƒåœ¨äºä½ç½®å¯¹çŠ¶æ€åˆ†è§£å’Œç¿»è½¬å½±å“åˆ†ç±»ã€‚æŒæ¡ç»„åˆæ•°å­¦ä¼˜åŒ–æŠ€å·§ï¼Œå°±èƒ½é«˜æ•ˆè§£å†³æ­¤ç±»é—®é¢˜ï¼ ğŸš€

---
å¤„ç†ç”¨æ—¶ï¼š165.46ç§’
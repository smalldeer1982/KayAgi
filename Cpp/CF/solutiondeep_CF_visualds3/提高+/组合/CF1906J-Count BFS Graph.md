# é¢˜ç›®ä¿¡æ¯

# Count BFS Graph

## é¢˜ç›®æè¿°

You are currently researching a graph traversal algorithm called the Breadth First Search (BFS). Suppose you have an input graph of $ N $ nodes (numbered from $ 1 $ to $ N $ ). The graph is represented by an adjacency matrix $ M $ , for which node $ u $ can traverse to node $ v $ if $ M_{u, v} $ is $ 1 $ , otherwise it is $ 0 $ . Your algorithm will output the order the nodes are visited in the BFS. The pseudocode of the algorithm is presented as follows.

```
<pre class="verbatim"><br></br>    BFS(M[1..N][1..N]):<br></br>        let A be an empty array<br></br>        let Q be an empty queue<br></br><br></br>        append 1 to A<br></br>        push 1 to Q<br></br><br></br>        while Q is not empty:<br></br>            pop the front element of Q into u<br></br>            for v = 1 to N:<br></br>                if M[u][v] == 1 and v is not in A:<br></br>                    append v to A<br></br>                    push v to Q<br></br><br></br>        return A<br></br>
```

During your research, you are interested in the following problem. Given an array $ A $ such that $ A $ is a permutation of $ 1 $ to $ N $ and $ A_1 = 1 $ . How many simple undirected graph with $ N $ nodes and adjacency matrix $ M $ such that $ \text{BFS}(M) = A $ ? Since the answer can be very large, calculate the answer modulo $ 998\,244\,353 $ .

A simple graph has no self-loop ( $ M_{i, i} = 0 $ for $ 1 \leq i \leq N $ ) and there is at most one edge that connects a pair of nodes. In an undirected graph, if node $ u $ is adjacent to node $ v $ , then node $ v $ is also adjacent to node $ u $ ; formally, $ M_{u, v} = M_{v, u} $ for $ 1 \leq u < v \leq N $ .

Two graphs are considered different if there is an edge that exists in one graph but not the other. In other words, two graphs are considered different if their adjacency matrices are different.

## è¯´æ˜/æç¤º

Explanation for the sample input/output #1

The following illustration shows all graphs that satisfy the requirements.

 ![](https://cdn.luogu.com.cn/upload/vjudge_pic/CF1906J/96f1bd6a81238405d96653e941a6d0d3b2152525.png)Explanation for the sample input/output #2

The only graph that satisfies the requirements is a graph with two edges: one that connects nodes $ 1 $ and $ 3 $ , and another one that connects nodes $ 3 $ and $ 2 $ .

## æ ·ä¾‹ #1

### è¾“å…¥

```
3
1 2 3```

### è¾“å‡º

```
3```

## æ ·ä¾‹ #2

### è¾“å…¥

```
3
1 3 2```

### è¾“å‡º

```
1```

## æ ·ä¾‹ #3

### è¾“å…¥

```
5
1 3 2 4 5```

### è¾“å‡º

```
17```

## æ ·ä¾‹ #4

### è¾“å…¥

```
11
1 2 3 4 5 6 7 8 9 10 11```

### è¾“å‡º

```
379394847```

# AIåˆ†æç»“æœ


### ğŸ’¡ Kayçš„C++ç®—æ³•è§£æï¼šCount BFS Graph æ·±å…¥å­¦ä¹ æŒ‡å— ğŸ’¡

#### 1. é¢˜ç›®è§£è¯»ä¸æ ¸å¿ƒç®—æ³•è¯†åˆ«
âœ¨ **æœ¬é¢˜ä¸»è¦è€ƒå¯Ÿ**ï¼š`åŠ¨æ€è§„åˆ’ + å‰ç¼€å’Œä¼˜åŒ–`  
ğŸ—£ï¸ **åˆæ­¥åˆ†æ**ï¼š
> è§£å†³æœ¬é¢˜å…³é”®åœ¨äºç†è§£BFSåºåˆ—ä¸å›¾ç»“æ„çš„å¯¹åº”å…³ç³»ã€‚æƒ³è±¡ä½ æ˜¯ä¸€ååŸå¸‚è§„åˆ’å¸ˆï¼Œç»™å®šå±…æ°‘è®¿é—®é¡ºåºï¼ˆBFSåºåˆ—ï¼‰ï¼Œéœ€è¦è®¾è®¡é“è·¯ç³»ç»Ÿï¼ˆå›¾çš„è¾¹ï¼‰ï¼Œä½¿å¾—å±…æ°‘åªèƒ½æŒ‰æŒ‡å®šé¡ºåºæ¢ç´¢åŸå¸‚ï¼ˆæ»¡è¶³BFSçº¦æŸï¼‰ã€‚  
> - **æ ¸å¿ƒæ€è·¯**ï¼šé€šè¿‡åŠ¨æ€è§„åˆ’è®°å½•BFSæ‰©å±•çŠ¶æ€ï¼Œåˆ©ç”¨å‰ç¼€å’Œä¼˜åŒ–è½¬ç§»è¿‡ç¨‹ã€‚éš¾ç‚¹åœ¨äºå¤„ç†BFSçš„å±‚æ¬¡æ€§ä¸åºåˆ—é€’å¢çº¦æŸã€‚
> - **ç®—æ³•æµç¨‹**ï¼šé¢„å¤„ç†åºåˆ—çš„è¿ç»­é€’å¢åŒºé—´ â†’ è®¾è®¡DPçŠ¶æ€è¡¨ç¤ºå½“å‰æ‰©å±•ä½ç½® â†’ ç”¨å‰ç¼€å’Œ/å·®åˆ†ä¼˜åŒ–åŒºé—´è½¬ç§» â†’ ç´¯è®¡æ–¹æ¡ˆæ•°å–æ¨¡ã€‚
> - **å¯è§†åŒ–è®¾è®¡**ï¼šç”¨åƒç´ ç½‘æ ¼è¡¨ç¤ºDPçŠ¶æ€çŸ©é˜µï¼Œé«˜äº®å½“å‰å¤„ç†çŠ¶æ€ï¼ŒåŠ¨æ€ç»˜åˆ¶è½¬ç§»åŒºé—´ï¼Œè¾…ä»¥8-bitéŸ³æ•ˆæç¤ºçŠ¶æ€æ›´æ–°ã€‚

#### 2. ç²¾é€‰ä¼˜è´¨é¢˜è§£å‚è€ƒ
**é¢˜è§£ä¸€ï¼ˆæ¥æºï¼šIGA_Indigoï¼‰**  
* **ç‚¹è¯„**ï¼š  
  æ€è·¯æ¸…æ™°é˜é‡Šäº†BFSå±‚æ¬¡æ€§ä¸çŠ¶æ€è®¾è®¡é€»è¾‘ï¼Œä»£ç è§„èŒƒï¼ˆå¦‚`xl`æ•°ç»„é¢„å¤„ç†å®Œæ•´ï¼‰ã€‚äº®ç‚¹åœ¨äºç”¨`_2`æ•°ç»„é¢„è®¡ç®—å¹‚æ¬¡ä¼˜åŒ–æ•ˆç‡ï¼Œå·®åˆ†å¤„ç†å·§å¦™è§£å†³åŒºé—´è½¬ç§»ã€‚å˜é‡å‘½å`f[i][j]`ç›´è§‚ä½“ç°çŠ¶æ€å«ä¹‰ï¼Œè¾¹ç•Œå¤„ç†ä¸¥è°¨ï¼ˆæ¨¡æ•°è°ƒæ•´ï¼‰ï¼Œå¯ç›´æ¥ç”¨äºç«èµ›ã€‚

**é¢˜è§£äºŒï¼ˆæ¥æºï¼šRegister_intï¼‰**  
* **ç‚¹è¯„**ï¼š  
  ä»£ç ç®€æ´é«˜æ•ˆï¼ˆä»…23è¡Œï¼‰ï¼ŒçŠ¶æ€å®šä¹‰`dp[i][j]`ç²¾å‡†åŒ¹é…é—®é¢˜æœ¬è´¨ã€‚äº®ç‚¹æ˜¯é¢„å¤„ç†`r`æ•°ç»„æ—¶ä½¿ç”¨`min`åˆå§‹åŒ–å’Œé€’å¢åˆ¤æ–­ï¼Œé¿å…å†—ä½™å¾ªç¯ã€‚è½¬ç§»å…¬å¼`2^{k-i}dp_{i,k}`çš„æ•°å­¦è¡¨è¾¾ç®€æ´æœ‰åŠ›ï¼Œåˆ·è¡¨è½¬ç§»å®ç°ä¼˜é›…ã€‚

**é¢˜è§£ä¸‰ï¼ˆæ¥æºï¼šaCssenï¼‰**  
* **ç‚¹è¯„**ï¼š  
  ç‹¬ç‰¹æå‡º"è¾¹åœ¨ä½ç½®è¾ƒå°èŠ‚ç‚¹ç¡®å®š"çš„å…³é”®æ´è§ï¼Œè§£å†³æ— å‘å›¾è¾¹é‡å¤è®¡ç®—é—®é¢˜ã€‚çŠ¶æ€`f[i][j]`ä¸­`j`è¡¨ç¤ºå·²æ‰©å±•ä½ç½®çš„è®¾è®¡æ–°é¢–ï¼Œå·®åˆ†æ•°ç»„`c`çš„å®æ—¶æ¸…é›¶ä¿è¯çŠ¶æ€ç‹¬ç«‹ï¼Œé€‚åˆå­¦ä¹ è€…ç†è§£æ— åæ•ˆæ€§åŸåˆ™ã€‚

---

#### 3. æ ¸å¿ƒéš¾ç‚¹è¾¨æä¸è§£é¢˜ç­–ç•¥
1. **éš¾ç‚¹1ï¼šBFSåºåˆ—ä¸å›¾çš„æ˜ å°„å…³ç³»**  
   * **åˆ†æ**ï¼šéœ€ä¿è¯ç»™å®šåºåˆ—æ˜¯å”¯ä¸€BFSç»“æœã€‚ä¼˜è´¨é¢˜è§£é€šè¿‡"è¿ç»­é€’å¢åŒºé—´"ï¼ˆ`r/xl`æ•°ç»„ï¼‰çº¦æŸè½¬ç§»èŒƒå›´ï¼Œç¡®ä¿æ–°èŠ‚ç‚¹æŒ‰åºåŠ å…¥ã€‚
   * ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šåºåˆ—çš„å±€éƒ¨å•è°ƒæ€§æ˜¯è§£é¢˜çªç ´å£ã€‚

2. **éš¾ç‚¹2ï¼šçŠ¶æ€è®¾è®¡ä¸ç»´åº¦ä¼˜åŒ–**  
   * **åˆ†æ**ï¼š`f[i][j]`è¡¨ç¤ºå¤„ç†ç¬¬`i`ä¸ªèŠ‚ç‚¹æ—¶é˜Ÿåˆ—å·²åˆ°ä½ç½®`j`ã€‚äºŒç»´çŠ¶æ€éœ€ä¼˜åŒ–ï¼Œé¢˜è§£å‡é‡‡ç”¨å·®åˆ†+å‰ç¼€å’Œå°†O(nÂ³)é™ä¸ºO(nÂ²)ã€‚
   * ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šå‰ç¼€å’Œæ˜¯åŒºé—´è½¬ç§»é—®é¢˜çš„é»„é‡‘æ­æ¡£ã€‚

3. **éš¾ç‚¹3ï¼šæ— å‘å›¾è¾¹çš„è®¡æ•°è§„åˆ™**  
   * **åˆ†æ**ï¼šå·²è®¿é—®èŠ‚ç‚¹çš„è¾¹å¯ä»»æ„é€‰æ‹©ï¼ˆ2ç§/è¾¹ï¼‰ï¼Œæœªè®¿é—®èŠ‚ç‚¹éœ€ä¸¥æ ¼çº¦æŸã€‚é€šè¿‡`2^{j-i}`è®¡ç®—è‡ªç”±è¾¹æ•°ï¼Œä½“ç°ä¹˜æ³•åŸç†ã€‚
   * ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šç»„åˆæ•°å­¦æ€æƒ³æ˜¯DPè½¬ç§»ç³»æ•°çš„çµé­‚ã€‚

âœ¨ **è§£é¢˜æŠ€å·§æ€»ç»“**  
- **æŠ€å·§1ï¼šé€’å¢åŒºé—´é¢„å¤„ç†**ï¼šç”¨`r[i]`æ ‡è®°åºåˆ—è¿ç»­é€’å¢ç»ˆç‚¹ï¼Œé™å®šçŠ¶æ€è½¬ç§»èŒƒå›´ã€‚  
- **æŠ€å·§2ï¼šå¹‚æ¬¡é¢„è®¡ç®—**ï¼šæå‰å¤„ç†`2^k % mod`é¿å…é‡å¤è®¡ç®—ï¼Œæå‡æ•ˆç‡ã€‚  
- **æŠ€å·§3ï¼šå·®åˆ†+å‰ç¼€å’Œ**ï¼š`s[j] += x; s[r[j]] -= x`å®ç°O(1)åŒºé—´æ›´æ–°ã€‚  

---

#### 4. C++æ ¸å¿ƒä»£ç å®ç°èµæ
**é€šç”¨æ ¸å¿ƒå®ç°ï¼ˆç»¼åˆé¢˜è§£ä¼˜åŒ–ï¼‰**  
```cpp
#include <bits/stdc++.h>
using namespace std;
const int N=5005, mod=998244353;
int n,a[N],r[N],f[N][N],s[N],pw[N];

int main() {
    cin>>n; pw[0]=1;
    for(int i=1;i<=n;i++) pw[i]=pw[i-1]*2%mod;
    for(int i=1;i<=n;i++) cin>>a[i];
    
    // é¢„å¤„ç†é€’å¢åŒºé—´ç»ˆç‚¹r[i]
    for(int i=1;i<=n;i++) {
        r[i]=i;
        while(r[i]<n && a[r[i]]<a[r[i]+1]) r[i]++;
    }
    
    f[1][1]=1; // åˆå§‹çŠ¶æ€
    for(int i=1;i<=n;i++) {
        memset(s,0,sizeof s); // å·®åˆ†æ•°ç»„æ¸…é›¶
        for(int j=i;j<=n;j++) {
            long x=1LL*f[i][j]*pw[j-i]%mod;
            s[j]=(s[j]+x)%mod;
            s[r[j]+1]=(s[r[j]+1]-x+mod)%mod;
        }
        for(int j=1;j<=n;j++) {
            s[j]=(s[j]+s[j-1])%mod;
            f[i+1][j]=s[j]; // å‰ç¼€å’Œå¾—æ–°çŠ¶æ€
        }
    }
    cout<<f[n+1][n];
}
```
**ä»£ç è§£è¯»æ¦‚è¦**ï¼š  
1. é¢„è®¡ç®—`pw`å­˜å‚¨2çš„å¹‚æ¬¡  
2. `r[i]`è®°å½•ä»ä½ç½®`i`å¼€å§‹çš„æœ€é•¿é€’å¢ç»ˆç‚¹  
3. æ ¸å¿ƒDPåŒå¾ªç¯ï¼šå¤–å±‚`i`ä¸ºå·²å¤„ç†èŠ‚ç‚¹æ•°ï¼Œå†…å±‚`j`ä¸ºé˜Ÿåˆ—ä½ç½®  
4. å·®åˆ†æ•°ç»„`s`å®ç°åŒºé—´åŠ ï¼Œå‰ç¼€å’Œåå¾—ä¸‹ä¸€çŠ¶æ€  

**é¢˜è§£ä¸€æ ¸å¿ƒç‰‡æ®µèµæ**  
```cpp
for(int j=i;j<=n;j++){
    long long x=f[i][j]*_2[j-i]%mod;
    s[j]=(s[j]+x)%mod;
    s[xl[j]]=(s[xl[j]]-x+mod)%mod; 
}
```
* **äº®ç‚¹**ï¼šè´Ÿå€¼å¤„ç†é‡‡ç”¨`+mod`ä¿è¯éè´Ÿ  
* **è§£è¯»**ï¼š`f[i][j]`è´¡çŒ®å€¼`x`åŠ åˆ°åŒºé—´`[j, xl[j]-1]`ï¼Œ`xl[j]`ä¸ºé¢„å¤„ç†çš„é€’å¢ç»ˆç‚¹+1  
* **å­¦ä¹ ç¬”è®°**ï¼šå·®åˆ†æ•°ç»„çš„å‡æ“ä½œéœ€å¤„ç†è´Ÿæ•°é£é™©  

**é¢˜è§£äºŒçŠ¶æ€è½¬ç§»**  
```cpp
x = dp[i][j] * p2[j-i] % mod;
s[j] = (s[j] + x) % mod, s[r[j]] = (s[r[j]] - x + mod) % mod;
```
* **äº®ç‚¹**ï¼šé€—å·è¿ç®—ç¬¦ç®€åŒ–ä»£ç è¡Œ  
* **è§£è¯»**ï¼š`r[j]`å³é€’å¢ç»ˆç‚¹ï¼Œè½¬ç§»åŒºé—´ä¸º`[j, r[j]-1]`  
* **å­¦ä¹ ç¬”è®°**ï¼šçŠ¶æ€è½¬ç§»æœ¬è´¨æ˜¯åŒºé—´åŠ æ³•  

---

#### 5. ç®—æ³•å¯è§†åŒ–ï¼šåƒç´ åŠ¨ç”»æ¼”ç¤º
**ä¸»é¢˜**ï¼š8-bité£æ ¼ã€ŠBFSåºåˆ—å»ºé€ è€…ã€‹  
**æ ¸å¿ƒæ¼”ç¤º**ï¼šDPçŠ¶æ€çŸ©é˜µçš„å®æ—¶æ›´æ–°ä¸åŒºé—´è½¬ç§»  

| æ­¥éª¤               | åƒç´ åŠ¨ç”»è®¾è®¡                                                                 | éŸ³æ•ˆ            |
|--------------------|------------------------------------------------------------------------------|----------------|
| **åˆå§‹åŒ–**         | ç½‘æ ¼æ˜¾ç¤ºåºåˆ—å€¼ï¼Œé«˜äº®èµ·ç‚¹`a[1]`ï¼Œåº•éƒ¨æ˜¾ç¤º`f[1][1]=1`                          | å¯åŠ¨éŸ³æ•ˆ        |
| **çŠ¶æ€è½¬ç§»**       | å½“å‰çŠ¶æ€`(i,j)`åƒç´ å—é—ªçƒçº¢å…‰ï¼Œè“è‰²å…‰å¸¦å»¶ä¼¸è‡³`r[j]`                          | æ•°æ®æµåŠ¨éŸ³æ•ˆ    |
| **å·®åˆ†æ“ä½œ**       | `s[j]`+xæ—¶æ˜¾ç¤ºç»¿è‰²â†‘ï¼Œ`s[r[j]]`-xæ—¶æ˜¾ç¤ºçº¢è‰²â†“                                  | ç‚¹å‡»éŸ³æ•ˆ        |
| **å‰ç¼€å’Œç”Ÿæˆ**     | é»„è‰²æ‰«æçº¿ä»å·¦å‘å³ç§»åŠ¨ï¼Œç´¯åŠ å·®åˆ†å€¼ç”Ÿæˆ`f[i+1][j]`                           | é½¿è½®è½¬åŠ¨éŸ³æ•ˆ    |
| **å…³å¡å®Œæˆ**       | æ¯å¤„ç†å®Œä¸€è¡Œ`i`ï¼Œæ˜¾ç¤º"Level i passed!"ï¼Œåƒç´ çƒŸèŠ±åº†ç¥                         | èƒœåˆ©éŸ³æ•ˆ        |

**äº¤äº’æ§åˆ¶**ï¼š  
- é€Ÿåº¦æ»‘å—ï¼šè°ƒèŠ‚è‡ªåŠ¨æ’­æ”¾é€Ÿåº¦  
- å•æ­¥æ‰§è¡Œï¼šæŒ‰æ­¥è§‚å¯ŸçŠ¶æ€è½¬ç§»  
- é«˜äº®å¼€å…³ï¼šèšç„¦å½“å‰æ“ä½œåŒºåŸŸ  
- æ•°æ®è·Ÿè¸ªï¼šæ‚¬åœæ˜¾ç¤º`f[i][j]`æ•°å€¼  

---

#### 6. æ‹“å±•ç»ƒä¹ ä¸ç›¸ä¼¼é—®é¢˜æ€è€ƒ
1. **æ´›è°· P1237** [æœ¨æ£åŠ å·¥]  
   â†’ åŒç±»é€’å¢åºåˆ—å¤„ç†ï¼Œå¼ºåŒ–é¢„å¤„ç†æŠ€å·§  
2. **æ´›è°· P1439** [æœ€é•¿å…¬å…±å­åºåˆ—]  
   â†’ åºåˆ—æ˜ å°„è½¬æ¢ï¼Œç»“åˆé€’å¢æ€§è´¨ä¼˜åŒ–  
3. **æ´›è°· P2513** [é€†åºå¯¹ç»Ÿè®¡]  
   â†’ å‰ç¼€å’ŒDPçš„å˜å¼åº”ç”¨  

---

#### 7. å­¦ä¹ å¿ƒå¾—ä¸ç»éªŒåˆ†äº«
> **é¢˜è§£è°ƒè¯•ç»éªŒ**ï¼š  
> "é¦–æ¬¡å®ç°æ—¶æœªå¤„ç†å·®åˆ†è´Ÿå€¼ï¼Œå¯¼è‡´æ¨¡æ•°æº¢å‡ºã€‚é€šè¿‡`(s[r[j]]-x+mod)%mod`è§£å†³ï¼Œå¯ç¤ºï¼šæ¨¡è¿ç®—ä¸­å‡æ³•å¿…é¡»åŠ æ¨¡æ•°é˜²è´Ÿã€‚"  
> â†’ **Kayç‚¹è¯„**ï¼šè´Ÿæ•°å–æ¨¡æ˜¯å¸¸è§é™·é˜±ï¼Œæµ‹è¯•è¾¹ç•Œç”¨ä¾‹å¯å¿«é€Ÿå®šä½é—®é¢˜  

---
æœ¬æ¬¡è§£æèåˆäº†BFSåºåˆ—éªŒè¯ã€åŠ¨æ€è§„åˆ’ä¼˜åŒ–ä¸ç»„åˆæ•°å­¦ï¼Œæ ¸å¿ƒåœ¨äºé€šè¿‡çŠ¶æ€è®¾è®¡å°†å›¾è®ºé—®é¢˜è½¬åŒ–ä¸ºåºåˆ—å¤„ç†ã€‚æŒæ¡å·®åˆ†æŠ€å·§ä¸é¢„å¤„ç†æ€ç»´ï¼Œå¯è§£å†³å¤§é‡åŒºé—´è½¬ç§»é—®é¢˜ã€‚ç»§ç»­åŠ æ²¹ï¼Œç®—æ³•å·¥ç¨‹å¸ˆä»¬ï¼ğŸ’ª

---
å¤„ç†ç”¨æ—¶ï¼š206.90ç§’
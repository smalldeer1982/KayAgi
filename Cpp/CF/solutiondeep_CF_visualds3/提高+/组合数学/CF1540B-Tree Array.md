# é¢˜ç›®ä¿¡æ¯

# Tree Array

## é¢˜ç›®æè¿°

You are given a tree consisting of $ n $ nodes. You generate an array from the tree by marking nodes one by one.

Initially, when no nodes are marked, a node is equiprobably chosen and marked from the entire tree.

After that, until all nodes are marked, a node is equiprobably chosen and marked from the set of unmarked nodes with at least one edge to a marked node.

It can be shown that the process marks all nodes in the tree.

The final array $ a $ is the list of the nodes' labels in order of the time each node was marked.

Find the expected number of inversions in the array that is generated by the tree and the aforementioned process.

The number of inversions in an array $ a $ is the number of pairs of indices $ (i, j) $ such that $ i < j $ and $ a_i > a_j $ . For example, the array $ [4, 1, 3, 2] $ contains $ 4 $ inversions: $ (1, 2) $ , $ (1, 3) $ , $ (1, 4) $ , $ (3, 4) $ .

## è¯´æ˜/æç¤º

This is the tree from the first sample:

 ![](https://cdn.luogu.com.cn/upload/vjudge_pic/CF1540B/3833e6cdc8f432e8774aa8c02d9352118566a812.png)For the first sample, the arrays are almost fixed. If node $ 2 $ is chosen initially, then the only possible array is $ [2, 1, 3] $ ( $ 1 $ inversion). If node $ 3 $ is chosen initially, then the only possible array is $ [3, 1, 2] $ ( $ 2 $ inversions). If node $ 1 $ is chosen initially, the arrays $ [1, 2, 3] $ ( $ 0 $ inversions) and $ [1, 3, 2] $ ( $ 1 $ inversion) are the only possibilities and equiprobable. In total, the expected number of inversions is $ \frac{1}{3}\cdot 1 + \frac{1}{3} \cdot 2 + \frac{1}{3} \cdot (\frac{1}{2} \cdot 0 + \frac{1}{2} \cdot 1) = \frac{7}{6} $ .

 $ 166666669 \cdot 6 = 7 \pmod {10^9 + 7} $ , so the answer is $ 166666669 $ .

This is the tree from the second sample:

 ![](https://cdn.luogu.com.cn/upload/vjudge_pic/CF1540B/7f613b365926417ec34142a093ccc13b3b572f4f.png)This is the tree from the third sample:

 ![](https://cdn.luogu.com.cn/upload/vjudge_pic/CF1540B/4cf8ac5fc765cc7cdc6657a332a13e66dcba8fef.png)

## æ ·ä¾‹ #1

### è¾“å…¥

```
3
1 2
1 3```

### è¾“å‡º

```
166666669```

## æ ·ä¾‹ #2

### è¾“å…¥

```
6
2 1
2 3
6 1
1 4
2 5```

### è¾“å‡º

```
500000009```

## æ ·ä¾‹ #3

### è¾“å…¥

```
5
1 2
1 3
1 4
2 5```

### è¾“å‡º

```
500000007```

# AIåˆ†æç»“æœ


### ğŸ’¡ Kayçš„C++ç®—æ³•è§£æï¼šTree Array æ·±å…¥å­¦ä¹ æŒ‡å— ğŸ’¡

**é¢˜ç›®è§£è¯»**ï¼šç»™å®šä¸€æ£µæ ‘ï¼Œéšæœºé€‰æ‹©èµ·ç‚¹ï¼Œæ¯æ¬¡ä»å·²é€‰ç‚¹çš„ç›¸é‚»ç‚¹ä¸­ç­‰æ¦‚ç‡é€‰æ‹©æ–°ç‚¹ï¼Œç”Ÿæˆä¸€ä¸ªèŠ‚ç‚¹åºåˆ—ã€‚æ±‚åºåˆ—ä¸­é€†åºå¯¹æ•°çš„æœŸæœ›ï¼ˆæ¨¡ $10^9+7$ï¼‰ã€‚

#### 1. é¢˜ç›®è§£è¯»ä¸æ ¸å¿ƒç®—æ³•è¯†åˆ«
âœ¨ **æœ¬é¢˜ä¸»è¦è€ƒå¯Ÿ**ï¼šæœŸæœ›åŠ¨æ€è§„åˆ’ï¼ˆæœŸæœ›DPï¼‰ä¸æ ‘ç»“æ„åˆ†æ

ğŸ—£ï¸ **åˆæ­¥åˆ†æ**ï¼š
> è§£å†³æœ¬é¢˜çš„å…³é”®åœ¨äº**æœŸæœ›çº¿æ€§æ€§è´¨**ä¸**é—®é¢˜è½¬åŒ–**ã€‚æƒ³è±¡ä¸€æ£µæ ‘æ˜¯ä¸€ä¸ªæ¢é™©åœ°å›¾ï¼Œä½ éšæœºé€‰æ‹©ä¸€ä¸ªèµ·ç‚¹ï¼ˆæ ¹èŠ‚ç‚¹ï¼‰ï¼Œç„¶åæ¯ä¸€æ­¥å‘ç›¸é‚»æœªæ¢ç´¢åŒºåŸŸç­‰æ¦‚ç‡ç§»åŠ¨ã€‚é€†åºå¯¹æ•°å¯æ‹†è§£ä¸ºæ‰€æœ‰èŠ‚ç‚¹å¯¹$(u,v)$ï¼ˆ$u>v$ï¼‰ä¸­$u$æ¯”$v$å…ˆè¢«é€‰ä¸­çš„æ¦‚ç‡ä¹‹å’Œã€‚
> - **æ ¸å¿ƒæ€è·¯**ï¼šæšä¸¾æ ¹èŠ‚ç‚¹ â†’ è®¡ç®—æ¯å¯¹èŠ‚ç‚¹çš„é¡ºåºæ¦‚ç‡ â†’ åŠ æƒå¹³å‡ã€‚éš¾ç‚¹åœ¨äºé«˜æ•ˆè®¡ç®—æ¦‚ç‡ï¼šä»$u,v$çš„æœ€è¿‘å…¬å…±ç¥–å…ˆï¼ˆLCAï¼‰å¼€å§‹ï¼Œå‘$u$å’Œ$v$ç§»åŠ¨çš„è·¯å¾„ç‹¬ç«‹ä¸”ç­‰æ¦‚ç‡ï¼Œè½¬åŒ–ä¸º**åŒæ ˆå¼¹å‡ºæ¨¡å‹**ï¼ˆè§ä¸‹æ–¹åŠ¨ç”»è®¾è®¡ï¼‰ã€‚
> - **å¯è§†åŒ–è®¾è®¡**ï¼šç”¨åƒç´ ç½‘æ ¼è¡¨ç¤ºæ ‘ç»“æ„ï¼Œé«˜äº®LCAèŠ‚ç‚¹ä¸ºèµ·ç‚¹ï¼Œ$u/v$è·¯å¾„ä¸ºä¸¤æ¡æ ˆé“¾ã€‚åŠ¨ç”»å±•ç¤ºæ ˆå—å¼¹å‡ºè¿‡ç¨‹ï¼ˆçº¢/è“å—è¡¨ç¤º$u/v$å‰©ä½™æ­¥æ•°ï¼‰ï¼Œå•æ­¥æ‰§è¡Œæ—¶æ’­æ”¾"åƒç´ éŸ³æ•ˆ"ï¼Œå½“æŸä¸€æ ˆç©ºæ—¶è§¦å‘"èƒœåˆ©/å¤±è´¥"éŸ³æ•ˆï¼Œç›´è§‚å‘ˆç°æ¦‚ç‡è®¡ç®—ã€‚

---

#### 2. ç²¾é€‰ä¼˜è´¨é¢˜è§£å‚è€ƒ
**é¢˜è§£ä¸€ï¼ˆAcfboyï¼‰**  
* **ç‚¹è¯„**ï¼šæ€è·¯æ¸…æ™°ç›´å‡»è¦å®³â€”â€”å°†è·¯å¾„æ¦‚ç‡è½¬åŒ–ä¸ºåŒæ ˆæ¨¡å‹ã€‚ä»£ç è§„èŒƒï¼šLCAä½¿ç”¨å€å¢æ³•ï¼ˆé€»è¾‘ä¸¥è°¨ï¼‰ï¼Œ$f[i][j]$çš„DPé¢„å¤„ç†å®Œæ•´ã€‚äº®ç‚¹ï¼šç©ºé—´ä¼˜åŒ–ï¼ˆäºŒç»´DPï¼‰å’Œæ¨¡è¿ç®—å¤„ç†å¹²å‡€åˆ©è½ï¼Œå¯ç›´æ¥ç”¨äºç«èµ›ã€‚å­¦ä¹ é‡ç‚¹ï¼šé—®é¢˜è½¬åŒ–çš„æ€ç»´æŠ€å·§ã€‚

**é¢˜è§£äºŒï¼ˆdead_Xï¼‰**  
* **ç‚¹è¯„**ï¼šä»£ç ç®€æ´é«˜æ•ˆï¼ŒDFSç›´æ¥æ±‚LCAé¿å…å€å¢å¸¸æ•°ã€‚äº®ç‚¹ï¼šé€†åºå¯¹è´¡çŒ®è®¡ç®—ä¸DPæ•°ç»„çš„æ•´åˆä¸€æ°”å‘µæˆï¼Œè¾¹ç•Œå¤„ç†ï¼ˆ$dep$åˆå§‹åŒ–ï¼‰ä¸¥è°¨ã€‚å®è·µä»·å€¼é«˜ï¼šé€‚åˆæŒæ¡DFSçš„å­¦ä¹ è€…æ¨¡ä»¿ã€‚

**é¢˜è§£ä¸‰ï¼ˆCry_For_theMoonï¼‰**  
* **ç‚¹è¯„**ï¼šä¸¥æ ¼éµå¾ªâ€œæ ¹æšä¸¾â†’LCAâ†’æ¦‚ç‡DPâ€æ¡†æ¶ï¼Œä»£ç æ¨¡å—åŒ–ï¼ˆåˆ†ç¦»DFS/DP/LCAï¼‰ã€‚äº®ç‚¹ï¼šè¯¦æ³¨å…³é”®æ­¥éª¤ï¼ˆå¦‚$f[i][j]$è½¬ç§»çš„æ„ä¹‰ï¼‰ï¼Œä¾¿äºè°ƒè¯•å‚è€ƒã€‚å­¦ä¹ é‡ç‚¹ï¼šæ ‘ç»“æ„çš„æŠ½è±¡å¤„ç†æŠ€å·§ã€‚

---

#### 3. æ ¸å¿ƒéš¾ç‚¹è¾¨æä¸è§£é¢˜ç­–ç•¥
1. **éš¾ç‚¹1ï¼šæ¦‚ç‡æ¨¡å‹æŠ½è±¡**  
   * **åˆ†æ**ï¼šä»LCAåˆ°$u/v$çš„è·¯å¾„é€‰æ‹©éœ€å¿½ç•¥æ— å…³åˆ†æ”¯ï¼Œè½¬åŒ–ä¸ºä¸¤ä¸ªæ ˆç­‰æ¦‚ç‡å¼¹å‡ºã€‚ä¼˜è´¨é¢˜è§£å‡é€šè¿‡$f[x][y]$è¡¨ç¤ºå‰©ä½™$x$æ­¥åˆ°$u$ã€$y$æ­¥åˆ°$v$æ—¶$u$å…ˆè¾¾çš„æ¦‚ç‡ã€‚
   * ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šå…³é”®æ˜¯å°†æ ‘å½¢ä¾èµ–ç®€åŒ–ä¸ºçº¿æ€§DPâ€”â€”æ— å…³è·¯å¾„ä¸å½±å“ç›¸å¯¹é¡ºåºã€‚

2. **éš¾ç‚¹2ï¼šLCAçš„å¿«é€Ÿæ±‚å–**  
   * **åˆ†æ**ï¼šæ¯ä¸ªæ ¹èŠ‚ç‚¹éœ€é‡æ–°è®¡ç®—LCAã€‚å€å¢æ³•ï¼ˆé¢„å¤„ç†ç¥–å…ˆæ•°ç»„ï¼‰é€‚åˆå›ºå®šæ ¹ï¼ŒDFSç›´æ¥æ±‚å–é€‚åˆé¢‘ç¹æ¢æ ¹ã€‚å› $nâ‰¤200$ï¼Œä¸¤ç§æ–¹æ³•å‡å¯æ¥å—ã€‚
   * ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šå°æ•°æ®ä¸‹DFSæ›´æ˜“å®ç°ï¼Œå¤§æ•°æ®åº”é€‰å€å¢æ³•ã€‚

3. **éš¾ç‚¹3ï¼šæœŸæœ›çš„çº¿æ€§æ‹†åˆ†**  
   * **åˆ†æ**ï¼šæ€»æœŸæœ› = $\frac{1}{n}\sum_{root} \sum_{u>v} f[dep_u-dep_{lca}][dep_v-dep_{lca}]$ã€‚éœ€æ³¨æ„$dep$å®šä¹‰ï¼ˆæ ¹åˆ°èŠ‚ç‚¹æ­¥æ•°ï¼‰ã€‚
   * ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šæœŸæœ›çš„çº¿æ€§æ€§è´¨æ˜¯å¤æ‚é—®é¢˜çš„"åˆ†æ²»åˆ©å™¨"ã€‚

##### âœ¨ è§£é¢˜æŠ€å·§æ€»ç»“
- **æŠ€å·§1ï¼šç­‰æ•ˆæ¨¡å‹è½¬åŒ–**ï¼ˆå¦‚åŒæ ˆæ›¿ä»£æ ‘è·¯å¾„ï¼‰  
- **æŠ€å·§2ï¼šé¢„å¤„ç†åŠ é€Ÿ**ï¼ˆDPæ•°ç»„ä¸æ ‘ç»“æ„æ— å…³ï¼Œå¯é¢„å…ˆè®¡ç®—ï¼‰  
- **æŠ€å·§3ï¼šè¾¹ç•Œä¼˜å…ˆå¤„ç†**ï¼ˆ$f[0][j]=1, f[i][0]=0$é¿å…é€»è¾‘æ¼æ´ï¼‰  

---

#### 4. C++æ ¸å¿ƒä»£ç å®ç°èµæ
**é€šç”¨æ ¸å¿ƒå®ç°ï¼ˆç»¼åˆè‡ªä¼˜è´¨é¢˜è§£ï¼‰**  
```cpp
#include <vector>
using namespace std;
typedef long long ll;
const int N=205, mod=1e9+7;

ll f[N][N], inv2=500000004; // é¢„å¤„ç†DPæ•°ç»„
void initDP(int n) {
    for(int i=1; i<=n; ++i) f[0][i] = 1;
    for(int i=1; i<=n; ++i)
        for(int j=1; j<=n; ++j)
            f[i][j] = (f[i-1][j] + f[i][j-1]) * inv2 % mod;
}

// åœ¨æšä¸¾æ ¹èŠ‚ç‚¹åè°ƒç”¨ï¼ˆç¤ºä¾‹ç‰‡æ®µï¼‰
void solve(int root) {
    vector<int> g[N]; // å­˜æ ‘
    int dep[N], fa[N][9]; // å€å¢ç›¸å…³
    // DFSé¢„å¤„ç†LCAï¼ˆç•¥ï¼‰
    ll ans_part = 0;
    for(int u=1; u<=n; ++u)
        for(int v=1; v<u; ++v) {
            int lca = LCA(u, v); // å€å¢æˆ–DFSæ±‚LCA
            int du = dep[u] - dep[lca], dv = dep[v] - dep[lca];
            ans_part = (ans_part + f[du][dv]) % mod;
        }
    total_ans = (total_ans + ans_part) % mod;
}
// æœ€ç»ˆç­”æ¡ˆ = total_ans * inv(n) % mod
```

**é¢˜è§£ä¸€ï¼ˆAcfboyï¼‰ç‰‡æ®µèµæ**  
```cpp
// æ ¸å¿ƒï¼šå€å¢LCAä¸DPæ•´åˆ
int LCA(int x, int y) {
    if(dep[x] < dep[y]) swap(x, y);
    for(int i=9; i>=0; --i)
        if(dep[x]-(1<<i) >= dep[y]) x = fa[x][i];
    if(x == y) return x;
    for(int i=9; i>=0; --i)
        if(fa[x][i] != fa[y][i]) x=fa[x][i], y=fa[y][i];
    return fa[x][0];
}
```
* **äº®ç‚¹**ï¼šä½è¿ç®—ä¼˜åŒ–æ·±åº¦åˆ¤æ–­ï¼ŒLCAæŸ¥è¯¢$O(\log n)$  
* **å­¦ä¹ ç¬”è®°**ï¼šç¥–å…ˆæ•°ç»„`fa[i][j]`çš„é€’æ¨å…³ç³» $fa[u][j] = fa[ fa[u][j-1] ][j-1]$ æ˜¯å€å¢æ ¸å¿ƒ

---

#### 5. ç®—æ³•å¯è§†åŒ–ï¼šåƒç´ åŠ¨ç”»æ¼”ç¤º
**ä¸»é¢˜**ï¼šåŒæ ˆè·¯å¾„æ¢ç´¢ï¼ˆ8ä½åƒç´ é£ï¼‰  
**æ ¸å¿ƒæ¼”ç¤ºæµç¨‹**ï¼š  
1. **åˆå§‹åŒ–**ï¼š  
   - æ ‘èŠ‚ç‚¹è½¬ä¸ºåƒç´ ç½‘æ ¼ï¼ˆå¦‚$3Ã—3$æ–¹å—ï¼‰ï¼ŒLCAæ ‡è®°ä¸ºç»¿è‰²èµ·ç‚¹ï¼Œ$u/v$è·¯å¾„è½¬ä¸ºçº¢/è“æ ˆé“¾ï¼ˆé«˜åº¦=æ­¥æ•°ï¼‰  
   - æ§åˆ¶é¢æ¿ï¼šæ­¥è¿›/æš‚åœ/è°ƒé€Ÿæ»‘å—ï¼ˆé»˜è®¤é€Ÿåº¦500msï¼‰  
2. **å•æ­¥æ¢ç´¢**ï¼š  
   - ç­‰æ¦‚ç‡é€‰æ‹©çº¢/è“æ ˆå¼¹å‡ºé¡¶éƒ¨æ–¹å—ï¼ˆä¼´éš"å®"å£°ï¼‰  
   - æ ‘è·¯å¾„åŒæ­¥é«˜äº®ç§»åŠ¨æ–¹å‘ï¼ˆçº¢è‰²â†’$u$, è“è‰²â†’$v$ï¼‰  
3. **ç»“æŸåˆ¤å®š**ï¼š  
   - çº¢æ ˆç©ºï¼šæ’­æ”¾èƒœåˆ©éŸ³æ•ˆï¼Œ$u$èŠ‚ç‚¹é—ªçƒï¼ˆ$u$å…ˆè¾¾ï¼‰  
   - è“æ ˆç©ºï¼šæ’­æ”¾ä½æ²‰éŸ³æ•ˆï¼Œ$v$èŠ‚ç‚¹é—ªçƒï¼ˆ$v$å…ˆè¾¾ï¼‰  
4. **æ¦‚ç‡æ˜¾ç¤º**ï¼šå®æ—¶æ›´æ–°å½“å‰è·¯å¾„çš„$f[x][y]$å€¼  

**è®¾è®¡æ„ä¹‰**ï¼šå°†æŠ½è±¡çš„æ ˆå¼¹å‡ºè¿‡ç¨‹å…·è±¡ä¸ºåƒç´ å—æ¶ˆé™¤æ¸¸æˆï¼Œé€šè¿‡éŸ³æ•ˆä¸é¢œè‰²å¼ºåŒ–æ¦‚ç‡å‡ç­‰ç‰¹æ€§ï¼Œå¸®åŠ©ç†è§£DPè½¬ç§»çš„ç‰©ç†æ„ä¹‰ã€‚

---

#### 6. æ‹“å±•ç»ƒä¹ ä¸ç›¸ä¼¼é—®é¢˜
- **é€šç”¨æŠ€å·§è¿ç§»**ï¼šåŒæ ˆæ¦‚ç‡æ¨¡å‹é€‚ç”¨äºä»»ä½•"ç‹¬ç«‹è·¯å¾„ç­‰æ¦‚ç‡é€‰æ‹©"åœºæ™¯ï¼ˆå¦‚éšæœºæ¸¸èµ°ã€å†³ç­–åˆ†å‰ï¼‰  
- **æ´›è°·æ¨è**ï¼š  
  1. [P4438] é“è·¯ï¼šç±»ä¼¼è·¯å¾„é€‰æ‹©æœŸæœ›  
  2. [P4284] æ¦‚ç‡å……ç”µå™¨ï¼šæ ‘å½¢æœŸæœ›è¿›é˜¶  
  3. [P6159] é€†åºå¯¹å¼ºåŒ–ç‰ˆï¼šåºåˆ—æœŸæœ›å˜å½¢  

---

#### 7. å­¦ä¹ å¿ƒå¾—ä¸ç»éªŒåˆ†äº«
> **Acfboyçš„è°ƒè¯•ç»éªŒ**ï¼š"$dep$æ•°ç»„æœªåˆå§‹åŒ–å¯¼è‡´LCAé”™è¯¯â€”â€”é™æ€æ•°ç»„éœ€æ³¨æ„æ¯æ¬¡æšä¸¾æ ¹æ—¶é‡ç½®"  
> **Kayæ€»ç»“**ï¼šæ ‘ç»“æ„é—®é¢˜ä¸­ï¼Œæ·±åº¦/ç¥–å…ˆæ•°ç»„çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†æ˜¯å¸¸è§é™·é˜±ï¼Œå»ºè®®å°è£…DFSå‡½æ•°é¿å…å…¨å±€çŠ¶æ€æ®‹ç•™ã€‚

---
å¤„ç†ç”¨æ—¶ï¼š119.64ç§’
# é¢˜ç›®ä¿¡æ¯

# Array Optimization by Deque

## é¢˜ç›®æè¿°

In fact, the problems E1 and E2 do not have much in common. You should probably think of them as two separate problems.

You are given an integer array $ a[1 \ldots n] = [a_1, a_2, \ldots, a_n] $ .

Let us consider an empty [deque](https://tinyurl.com/pfeucbux) (double-ended queue). A deque is a data structure that supports adding elements to both the beginning and the end. So, if there are elements $ [3, 4, 4] $ currently in the deque, adding an element $ 1 $ to the beginning will produce the sequence $ [\color{red}{1}, 3, 4, 4] $ , and adding the same element to the end will produce $ [3, 4, 4, \color{red}{1}] $ .

The elements of the array are sequentially added to the initially empty deque, starting with $ a_1 $ and finishing with $ a_n $ . Before adding each element to the deque, you may choose whether to add it to the beginning or to the end.

For example, if we consider an array $ a = [3, 7, 5, 5] $ , one of the possible sequences of actions looks like this:

 $ \quad $ 1.add $ 3 $ to the beginning of the deque:deque has a sequence $ [\color{red}{3}] $ in it; $ \quad $ 2.add $ 7 $ to the end of the deque:deque has a sequence $ [3, \color{red}{7}] $ in it; $ \quad $ 3.add $ 5 $ to the end of the deque:deque has a sequence $ [3, 7, \color{red}{5}] $ in it; $ \quad $ 4.add $ 5 $ to the beginning of the deque:deque has a sequence $ [\color{red}{5}, 3, 7, 5] $ in it;Find the minimal possible number of inversions in the deque after the whole array is processed.

An inversion in sequence $ d $ is a pair of indices $ (i, j) $ such that $ i < j $ and $ d_i > d_j $ . For example, the array $ d = [5, 3, 7, 5] $ has exactly two inversions â€” $ (1, 2) $ and $ (3, 4) $ , since $ d_1 = 5 > 3 = d_2 $ and $ d_3 = 7 > 5 = d_4 $ .

## è¯´æ˜/æç¤º

One of the ways to get the sequence $ [5, 3, 7, 5] $ in the deque, containing only two inversions, from the initial array $ [3, 7, 5, 5] $ (the first sample test case) is described in the problem statement.

Also, in this example, you could get the answer of two inversions by simply putting each element of the original array at the end of the deque. In this case, the original sequence $ [3, 7, 5, 5] $ , also containing exactly two inversions, will be in the deque as-is.

## æ ·ä¾‹ #1

### è¾“å…¥

```
6
4
3 7 5 5
3
3 2 1
3
3 1 2
4
-1 2 2 -1
4
4 5 1 3
5
1 3 1 3 2```

### è¾“å‡º

```
2
0
1
0
1
2```

# AIåˆ†æç»“æœ


### ğŸ’¡ Kayçš„C++ç®—æ³•è§£æï¼šArray Optimization by Deque æ·±å…¥å­¦ä¹ æŒ‡å— ğŸ’¡

#### 1. é¢˜ç›®è§£è¯»ä¸æ ¸å¿ƒç®—æ³•è¯†åˆ«
âœ¨ **æœ¬é¢˜ä¸»è¦è€ƒå¯Ÿ**ï¼š`æ ‘çŠ¶æ•°ç»„/çº¿æ®µæ ‘` + `è´ªå¿ƒç­–ç•¥`  

ğŸ—£ï¸ **åˆæ­¥åˆ†æ**ï¼š
> è§£å†³æœ¬é¢˜çš„å…³é”®åœ¨äºç†è§£**è´ªå¿ƒç­–ç•¥**ä¸**å€¼åŸŸç®¡ç†**çš„ç»“åˆã€‚æƒ³è±¡ä½ åœ¨æ•´ç†ä¸€æ‘å¡ç‰‡ï¼šæ¯æ¬¡æ‹¿åˆ°æ–°å¡ç‰‡æ—¶ï¼Œæ”¾åœ¨æœ€å·¦æˆ–æœ€å³ï¼Œç›®æ ‡æ˜¯å‡å°‘å¡ç‰‡é—´çš„"é”™ä½"ï¼ˆé€†åºå¯¹ï¼‰ã€‚è´ªå¿ƒç­–ç•¥æ˜¯ï¼šè®¡ç®—æ–°å¡ç‰‡æ”¾å·¦ä¾§ï¼ˆä¼šä¸æ‰€æœ‰æ¯”å®ƒå°çš„å¡ç‰‡å½¢æˆé€†åºå¯¹ï¼‰æˆ–å³ä¾§ï¼ˆä¼šä¸æ‰€æœ‰æ¯”å®ƒå¤§çš„å¡ç‰‡å½¢æˆé€†åºå¯¹ï¼‰çš„ä»£ä»·ï¼Œé€‰æ‹©ä»£ä»·è¾ƒå°çš„ä½ç½®ã€‚  
> - **æ ¸å¿ƒéš¾ç‚¹**ï¼šåŠ¨æ€ç»Ÿè®¡å½“å‰é˜Ÿåˆ—ä¸­æ¯”æ–°æ•°å¤§/å°çš„æ•°é‡ï¼Œå€¼åŸŸèŒƒå›´å¤§ï¼ˆéœ€ç¦»æ•£åŒ–ï¼‰ã€‚  
> - **æ•°æ®ç»“æ„é€‰æ‹©**ï¼šæ ‘çŠ¶æ•°ç»„ï¼ˆé«˜æ•ˆç®€æ´ï¼‰æˆ–çº¿æ®µæ ‘ï¼ˆæ›´é€šç”¨ï¼‰ç»´æŠ¤å€¼åŸŸé¢‘æ¬¡ã€‚  
> - **å¯è§†åŒ–è®¾è®¡**ï¼šåŠ¨ç”»ä¸­å°†ç”¨åƒç´ æ–¹å—è¡¨ç¤ºæ•°å€¼ï¼Œæ’å…¥æ—¶é«˜äº®æ¯”æ–°æ•°å°ï¼ˆè“è‰²ï¼‰å’Œå¤§ï¼ˆçº¢è‰²ï¼‰çš„æ–¹å—ï¼Œæ˜¾ç¤ºä»£ä»·è®¡ç®—è¿‡ç¨‹ï¼Œå¹¶æ’­æ”¾8-bitéŸ³æ•ˆæ ‡è®°æ’å…¥ä½ç½®ï¼ˆå·¦/å³ï¼‰ã€‚

---

#### 2. ç²¾é€‰ä¼˜è´¨é¢˜è§£å‚è€ƒ
**é¢˜è§£ä¸€ï¼ˆHMZHMZHMZï¼‰**  
* **ç‚¹è¯„**ï¼šæ€è·¯æ¸…æ™°è§£é‡Šè´ªå¿ƒæœ¬è´¨ï¼Œä»£ç è§„èŒƒï¼ˆæ ‘çŠ¶æ•°ç»„å°è£…ï¼‰ï¼Œä¸¥è°¨å¤„ç†è¾¹ç•Œï¼ˆå¼€`long long`ï¼‰ã€‚äº®ç‚¹åœ¨äºæ˜ç¡®è®¡ç®—é€»è¾‘ï¼š`s-cnt[a[i]]`ä¸ºå°æ•°ä¸ªæ•°ï¼Œ`i-s-1`ä¸ºå¤§æ•°ä¸ªæ•°ã€‚è°ƒè¯•æç¤º"åå¹´OIä¸å¼€long longè§ç¥–å®—"æå…·å®è·µä»·å€¼ã€‚

**é¢˜è§£äºŒï¼ˆEternalHeart1314ï¼‰**  
* **ç‚¹è¯„**ï¼šåŒæ’åºç¦»æ•£åŒ–å¤„ç†å·§å¦™ï¼ˆå…ˆæŒ‰å€¼æ’åºæ˜ å°„ï¼Œå†æŒ‰åŸä½ç½®è¿˜åŸï¼‰ï¼Œæ ‘çŠ¶æ•°ç»„å®ç°ç®€æ´ã€‚æ ¸å¿ƒå˜é‡`sum(val-1)`å’Œ`sum(n)-sum(val)`ç›´æ¥å¯¹åº”è´ªå¿ƒå†³ç­–ï¼Œä»£ç å¯è¯»æ€§å¼ºï¼Œé€‚åˆç«èµ›ç›´æ¥ä½¿ç”¨ã€‚

**é¢˜è§£ä¸‰ï¼ˆzhaoypï¼‰**  
* **ç‚¹è¯„**ï¼šæä¾›çº¿æ®µæ ‘å®ç°ï¼Œå±•ç¤ºæ•°æ®ç»“æ„å¤šæ ·æ€§ã€‚äº®ç‚¹åœ¨å®Œæ•´å±•ç¤ºçº¿æ®µæ ‘åŒºé—´æŸ¥è¯¢(`query`)å’Œæ›´æ–°(`add`)çš„é€’å½’è¿‡ç¨‹ï¼Œè™½æ¯”æ ‘çŠ¶æ•°ç»„å†—é•¿ï¼Œä½†å¸®åŠ©ç†è§£æ›´é€šç”¨çš„å€¼åŸŸç»´æŠ¤æ–¹æ³•ã€‚

---

#### 3. æ ¸å¿ƒéš¾ç‚¹è¾¨æä¸è§£é¢˜ç­–ç•¥
1. **è´ªå¿ƒç­–ç•¥çš„è¯æ˜**  
   * **åˆ†æ**ï¼šæ¯æ¬¡é€‰æ‹©å±€éƒ¨æœ€ä¼˜ï¼ˆæœ€å°æ–°å¢é€†åºå¯¹ï¼‰ä¸å½±å“åç»­å†³ç­–ï¼ˆæ— åæ•ˆæ€§ï¼‰ï¼Œå½’çº³æ³•å¯è¯å…¨å±€æœ€ä¼˜ã€‚å…³é”®å˜é‡ï¼šå½“å‰æ’å…¥ä½ç½®`i`å’Œå·²å¤„ç†çš„æ•°ã€‚
   * ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šæ— åæ•ˆæ€§è´ªå¿ƒæ˜¯å‡å°‘é€†åºå¯¹çš„åŸºçŸ³ã€‚

2. **å€¼åŸŸç¦»æ•£åŒ–å¤„ç†**  
   * **åˆ†æ**ï¼š$a_i \in [-10^9, 10^9]$ éœ€æ˜ å°„åˆ°$[1, n]$ã€‚æ’åº+å»é‡+äºŒåˆ†ï¼ˆ`lower_bound`ï¼‰æ˜¯é€šç”¨è§£æ³•ã€‚æ•°æ®ç»“æ„é€‰æ‹©æ ‘çŠ¶æ•°ç»„ï¼ˆæ›´é«˜æ•ˆï¼‰æˆ–çº¿æ®µæ ‘ï¼ˆæ›´çµæ´»ï¼‰ã€‚
   * ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šç¦»æ•£åŒ–æ˜¯å¤„ç†å¤§å€¼åŸŸçš„é»„é‡‘æ‰‹æ®µã€‚

3. **åŠ¨æ€é¢‘æ¬¡ç»Ÿè®¡**  
   * **åˆ†æ**ï¼šæ ‘çŠ¶æ•°ç»„/çº¿æ®µæ ‘ç»´æŠ¤å½“å‰é˜Ÿåˆ—ä¸­å„å€¼çš„å‡ºç°æ¬¡æ•°ã€‚æŸ¥è¯¢å°äº$x$çš„æ•°ä¸ªæ•°=`sum(x-1)`ï¼Œå¤§äº$x$çš„æ•°ä¸ªæ•°=`sum(n)-sum(x)`ã€‚
   * ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šæ ‘çŠ¶æ•°ç»„çš„`lowbit`æ›´æ–°æ˜¯é«˜æ•ˆå…³é”®ã€‚

### âœ¨ è§£é¢˜æŠ€å·§æ€»ç»“
- **é—®é¢˜åˆ†è§£**ï¼šå°†å…¨å±€é€†åºå¯¹æ‹†è§£ä¸ºæ¯æ¬¡æ’å…¥çš„ç‹¬ç«‹å†³ç­–ã€‚
- **æ•°æ®ç»“æ„ä¼˜åŒ–**ï¼šæ ‘çŠ¶æ•°ç»„é¦–é€‰ï¼ˆ$O(\log n)$æŸ¥è¯¢/æ›´æ–°ï¼‰ï¼Œçº¿æ®µæ ‘å¤‡é€‰ã€‚
- **è¾¹ç•Œé˜²å¾¡**ï¼šå¤šç»„æ•°æ®éœ€æ¸…ç©ºæ•°ç»„ï¼›ç´¯åŠ å™¨å¼€`long long`é˜²æº¢å‡ºã€‚
- **è°ƒè¯•æŠ€å·§**ï¼šéªŒè¯ç¦»æ•£åŒ–ååºåˆ—æ˜¯å¦æœ‰åºï¼Œå•æ­¥è·Ÿè¸ªé¢‘æ¬¡ç»Ÿè®¡ã€‚

---

#### 4. C++æ ¸å¿ƒä»£ç å®ç°èµæ
**æœ¬é¢˜é€šç”¨æ ¸å¿ƒå®ç°ï¼ˆæ ‘çŠ¶æ•°ç»„+è´ªå¿ƒï¼‰**  
```cpp
#include <bits/stdc++.h>
#define int long long
using namespace std;
const int N = 2e5 + 7;

int t, n, ans, c[N];
vector<int> b;

void add(int x) {
    while (x <= n) c[x]++, x += x & -x;
}

int sum(int x) {
    int s = 0;
    while (x) s += c[x], x -= x & -x;
    return s;
}

signed main() {
    cin >> t;
    while (t--) {
        cin >> n; 
        ans = 0;
        vector<int> a(n);
        for (int i = 0; i < n; i++) 
            cin >> a[i], b.push_back(a[i]);
        
        // ç¦»æ•£åŒ–
        sort(b.begin(), b.end());
        b.erase(unique(b.begin(), b.end()), b.end());
        for (int i = 0; i < n; i++) 
            a[i] = lower_bound(b.begin(), b.end(), a[i]) - b.begin() + 1;
        
        memset(c, 0, sizeof(c));
        for (int i = 0; i < n; i++) {
            int s = sum(a[i]);
            ans += min(s, i - s); // å°æ•°ä¸ªæ•° vs å¤§æ•°ä¸ªæ•°
            add(a[i]);
        }
        cout << ans << endl;
    }
}
```
**ä»£ç è§£è¯»æ¦‚è¦**ï¼š  
1. ç¦»æ•£åŒ–ï¼šåŸæ•°ç»„æ’åºå»é‡åäºŒåˆ†æ˜ å°„  
2. æ ‘çŠ¶æ•°ç»„ï¼š`add`æ›´æ–°é¢‘æ¬¡ï¼Œ`sum`æŸ¥è¯¢å‰ç¼€å’Œ  
3. è´ªå¿ƒå†³ç­–ï¼š`min(sum(a[i]), i-sum(a[i]))`ç´¯åŠ åˆ°ç­”æ¡ˆ  

**é¢˜è§£ä¸€æ ¸å¿ƒç‰‡æ®µï¼ˆHMZHMZHMZï¼‰**  
```cpp
ans += min(s - cnt[a[i]], i - s - 1);
```
**äº®ç‚¹**ï¼šä¸¥æ ¼åŒºåˆ†ä¸¥æ ¼å°äº/å¤§äºçš„è®¡æ•°é€»è¾‘  
**å­¦ä¹ ç¬”è®°**ï¼š`s-cnt[a[i]]`æ’é™¤ç›¸ç­‰æ•°ï¼Œç¡®ä¿è´ªå¿ƒå‡†ç¡®æ€§  

**é¢˜è§£ä¸‰æ ¸å¿ƒç‰‡æ®µï¼ˆzhaoypï¼‰**  
```cpp
query(1, n, 1, a[i].num-1, 1); // æŸ¥å°æ•°ä¸ªæ•°
query(1, n, a[i].num+1, n, 1); // æŸ¥å¤§æ•°ä¸ªæ•°
```
**äº®ç‚¹**ï¼šçº¿æ®µæ ‘åŒºé—´æŸ¥è¯¢å®Œæ•´å±•ç¤º  
**å­¦ä¹ ç¬”è®°**ï¼šçº¿æ®µæ ‘é€‚ç”¨äºæ›´å¤æ‚çš„å€¼åŸŸæ“ä½œï¼ˆå¦‚åŒºé—´ä¿®æ”¹ï¼‰

---

#### 5. ç®—æ³•å¯è§†åŒ–ï¼šåƒç´ åŠ¨ç”»æ¼”ç¤º  
**ä¸»é¢˜**ï¼š8-bitå¡ç‰‡æ•´ç†æ¨¡æ‹Ÿå™¨ï¼ˆå¤å¤æ¸¸æˆé£ï¼‰  

**æ ¸å¿ƒæ¼”ç¤ºæµç¨‹**ï¼š  
1. **åˆå§‹åŒ–**ï¼šç©ºé˜Ÿåˆ—ï¼ˆä¸‹æ–¹åƒç´ æ¡å¸¦ï¼‰ï¼Œæ ‘çŠ¶æ•°ç»„ï¼ˆä¸Šæ–¹æ ‘å½¢ç»“æ„ï¼‰ï¼Œå½“å‰é€†åºå¯¹æ•°æ˜¾ç¤º  
2. **æ’å…¥è¿‡ç¨‹**ï¼š  
   - æ–°å¡ç‰‡ï¼ˆé»„è‰²æ–¹å—ï¼‰è¿›å…¥ï¼Œè‡ªåŠ¨æŸ¥è¯¢æ ‘çŠ¶æ•°ç»„  
   - æ¯”å®ƒå°çš„å¡ç‰‡å˜è“ï¼Œæ¯”å®ƒå¤§çš„å˜çº¢ï¼Œæ˜¾ç¤ºæ•°é‡ç»Ÿè®¡  
   - é€‰æ‹©ä»£ä»·å°çš„æ–¹å‘ï¼šå·¦ä¾§æ’å…¥ï¼ˆå¡ç‰‡æ»‘å…¥æœ€å·¦ï¼‰+ä½éŸ³æ•ˆï¼Œå³ä¾§æ’å…¥ï¼ˆæ»‘å…¥æœ€å³ï¼‰+é«˜éŸ³æ•ˆ  
3. **æ•°æ®ç»“æ„åŒæ­¥**ï¼š  
   - æ ‘çŠ¶æ•°ç»„å¯¹åº”èŠ‚ç‚¹é«˜äº®æ›´æ–°ï¼ˆç»¿è‰²é—ªçƒï¼‰  
   - é€†åºå¯¹è®¡æ•°å™¨å®æ—¶å˜åŒ–  
4. **äº¤äº’æ§åˆ¶**ï¼š  
   - æ­¥è¿›/æš‚åœ/é‡ç½®æŒ‰é’®  
   - è°ƒé€Ÿæ»‘å—ï¼ˆæ…¢é€Ÿè§‚å¯Ÿç»Ÿè®¡è¿‡ç¨‹ï¼‰  
   - "AIæ¼”ç¤º"æ¨¡å¼ï¼ˆè‡ªåŠ¨å®Œæˆæœ€ä¼˜æ’å…¥ï¼‰  

**è®¾è®¡ç»†èŠ‚**ï¼š  
- éŸ³æ•ˆï¼šæ’å…¥æ–¹å‘ï¼ˆé«˜ä½éŸ³åŒºåˆ†ï¼‰ï¼Œé”™è¯¯æ“ä½œï¼ˆçŸ­ä¿ƒè­¦æŠ¥ï¼‰  
- è¿‡å…³æœºåˆ¶ï¼šæ¯å¤„ç†10ä¸ªæ•°è§¦å‘"å…³å¡å®Œæˆ"åŠ¨ç”»ï¼ˆåƒç´ çƒŸèŠ±+èƒœåˆ©éŸ³æ•ˆï¼‰  

---

#### 6. æ‹“å±•ç»ƒä¹ ä¸ç›¸ä¼¼é—®é¢˜æ€è€ƒ
**é€šç”¨æŠ€å·§è¿ç§»**ï¼š  
1. **åŠ¨æ€é€†åºå¯¹ç»´æŠ¤**ï¼ˆå¸¦åˆ é™¤/ä¿®æ”¹æ“ä½œï¼‰  
2. **åŒºé—´æ’åæŸ¥è¯¢**ï¼ˆå¦‚æŸ¥è¯¢åºåˆ—ä¸­å€¼åœ¨$[L,R]$å†…çš„å…ƒç´ ä¸ªæ•°ï¼‰  
3. **å¸¦æƒå€¼åŸŸç®¡ç†**ï¼ˆå¦‚åŒæ—¶ç»´æŠ¤é¢‘æ¬¡å’Œå€¼å’Œï¼‰  

**æ´›è°·æ¨è**ï¼š  
1. **P1908 é€†åºå¯¹**  
   ğŸ—£ï¸ æ ‘çŠ¶æ•°ç»„è£¸é¢˜ï¼Œå·©å›ºç¦»æ•£åŒ–+é¢‘æ¬¡ç»Ÿè®¡  
2. **P1972 [SDOI2009] HHçš„é¡¹é“¾**  
   ğŸ—£ï¸ åŒºé—´é¢‘æ¬¡æŸ¥è¯¢å˜ç§ï¼Œç»ƒä¹ ç¦»çº¿æŸ¥è¯¢+æ ‘çŠ¶æ•°ç»„  
3. **P3369 ã€æ¨¡æ¿ã€‘æ™®é€šå¹³è¡¡æ ‘**  
   ğŸ—£ï¸ æ‹“å±•åˆ°å¹³è¡¡æ ‘å®ç°ï¼Œç†è§£ä¸åŒæ•°æ®ç»“æ„çš„ä¼˜åŠ£  

---

#### 7. å­¦ä¹ å¿ƒå¾—ä¸ç»éªŒåˆ†äº«
> **å‚è€ƒç»éªŒï¼ˆHMZHMZHMZï¼‰**ï¼š  
> "åå¹´OIä¸€åœºç©ºï¼Œä¸å¼€long longè§ç¥–å®—â€”â€”æµ‹è¯•æ•°æ®ç´¯åŠ çˆ†intæ˜¯å¸¸è§é™·é˜±ã€‚"  
>   
> **ç‚¹è¯„**ï¼šæ•°å€¼èŒƒå›´æ„è¯†è‡³å…³é‡è¦ï¼$n \leq 2\times 10^5$æ—¶é€†åºå¯¹å¯è¾¾$2\times 10^{10}$ï¼Œå¿…é¡»ç”¨`long long`ã€‚è°ƒè¯•æ—¶ä¼˜å…ˆæ£€æŸ¥ç´¯åŠ å™¨ç±»å‹ã€‚  

> **å‚è€ƒç»éªŒï¼ˆè‹è”å°æ¸£ï¼‰**ï¼š  
> "è€ƒåœºä¸Šå› æœªç”¨é«˜æ•ˆæ•°æ®ç»“æ„è€Œå†™$O(n^2)$æš´åŠ›ï¼Œæ‡Šæ‚”ä¸å·²ã€‚"  
>   
> **ç‚¹è¯„**ï¼šæ ‘çŠ¶æ•°ç»„æ˜¯å€¼åŸŸç»Ÿè®¡çš„åˆ©å™¨ï¼ŒåŠ¡å¿…æŒæ¡æ¨¡æ¿åŒ–å®ç°ã€‚  

---

æœ¬æ¬¡è§£æå¼ºåŒ–äº†**è´ªå¿ƒå†³ç­–**ä¸**å€¼åŸŸç®¡ç†**çš„ååŒæ€ç»´ã€‚è®°ä½ï¼šç¦»æ•£åŒ–ç¼©å°æˆ˜åœºï¼Œæ ‘çŠ¶æ•°ç»„ç²¾å‡†ç»Ÿè®¡ï¼Œè¾¹ç•Œé˜²å¾¡ç¨³å¦‚ç£çŸ³ã€‚ä¸‹æ¬¡æŒ‘æˆ˜å†è§ï¼ğŸ’ª

---
å¤„ç†ç”¨æ—¶ï¼š203.97ç§’
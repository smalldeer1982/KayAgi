# é¢˜ç›®ä¿¡æ¯

# Sports Betting

## é¢˜ç›®æè¿°

![](https://cdn.luogu.com.cn/upload/vjudge_pic/CF1556F/019d3452101b513cd6bdfca73d0ad9bf76ce0ea0.png)William is not only interested in trading but also in betting on sports matches. $ n $ teams participate in each match. Each team is characterized by strength $ a_i $ . Each two teams $ i < j $ play with each other exactly once. Team $ i $ wins with probability $ \frac{a_i}{a_i + a_j} $ and team $ j $ wins with probability $ \frac{a_j}{a_i + a_j} $ .

The team is called a winner if it directly or indirectly defeated all other teams. Team $ a $ defeated (directly or indirectly) team $ b $ if there is a sequence of teams $ c_1 $ , $ c_2 $ , ... $ c_k $ such that $ c_1 = a $ , $ c_k = b $ and team $ c_i $ defeated team $ c_{i + 1} $ for all $ i $ from $ 1 $ to $ k - 1 $ . Note that it is possible that team $ a $ defeated team $ b $ and in the same time team $ b $ defeated team $ a $ .

William wants you to find the expected value of the number of winners.

## è¯´æ˜/æç¤º

To better understand in which situation several winners are possible let's examine the second test:

One possible result of the tournament is as follows ( $ a \rightarrow b $ means that $ a $ defeated $ b $ ):

- $ 1 \rightarrow 2 $
- $ 2 \rightarrow 3 $
- $ 3 \rightarrow 1 $
- $ 1 \rightarrow 4 $
- $ 1 \rightarrow 5 $
- $ 2 \rightarrow 4 $
- $ 2 \rightarrow 5 $
- $ 3 \rightarrow 4 $
- $ 3 \rightarrow 5 $
- $ 4 \rightarrow 5 $

Or more clearly in the picture:

 ![](https://cdn.luogu.com.cn/upload/vjudge_pic/CF1556F/6c25791d22e17c072eecc03de22b6a045c024954.png)In this case every team from the set $ \{ 1, 2, 3 \} $ directly or indirectly defeated everyone. I.e.:

- $ 1 $ st defeated everyone because they can get to everyone else in the following way $ 1 \rightarrow 2 $ , $ 1 \rightarrow 2 \rightarrow 3 $ , $ 1 \rightarrow 4 $ , $ 1 \rightarrow 5 $ .
- $ 2 $ nd defeated everyone because they can get to everyone else in the following way $ 2 \rightarrow 3 $ , $ 2 \rightarrow 3 \rightarrow 1 $ , $ 2 \rightarrow 4 $ , $ 2 \rightarrow 5 $ .
- $ 3 $ rd defeated everyone because they can get to everyone else in the following way $ 3 \rightarrow 1 $ , $ 3 \rightarrow 1 \rightarrow 2 $ , $ 3 \rightarrow 4 $ , $ 3 \rightarrow 5 $ .

Therefore the total number of winners is $ 3 $ .

## æ ·ä¾‹ #1

### è¾“å…¥

```
2
1 2```

### è¾“å‡º

```
1```

## æ ·ä¾‹ #2

### è¾“å…¥

```
5
1 5 2 11 14```

### è¾“å‡º

```
642377629```

# AIåˆ†æç»“æœ

# ğŸ’¡ Kayçš„C++ç®—æ³•è§£æï¼šSports Betting æ·±å…¥å­¦ä¹ æŒ‡å— ğŸ’¡

## å¼•è¨€
ä»Šå¤©æˆ‘ä»¬è¦åˆ†æçš„æ˜¯ Codeforces 1556Fã€ŒSports Bettingã€â€”â€”ä¸€é“ç»“åˆ**çŠ¶å‹åŠ¨æ€è§„åˆ’ï¼ˆDPï¼‰**ä¸**å®¹æ–¥åŸç†**çš„ç»å…¸ç«èµ›é¢˜ã€‚é¢˜ç›®å›´ç»•â€œç«èµ›å›¾ä¸­çš„winneræœŸæœ›â€å±•å¼€ï¼Œæ ¸å¿ƒæ˜¯åˆ©ç”¨æ•°å­¦æ€§è´¨å°†å¤æ‚é—®é¢˜æ‹†è§£ä¸ºå¯è®¡ç®—çš„å­é—®é¢˜ã€‚æœ¬æŒ‡å—ä¼šå¸®ä½ ç†æ¸…æ€è·¯ã€æŒæ¡å…³é”®æŠ€å·§ï¼Œè¿˜ä¼šç”¨åƒç´ åŠ¨ç”»ç›´è§‚å±•ç¤ºç®—æ³•æµç¨‹ï¼


## 1. é¢˜ç›®è§£è¯»ä¸æ ¸å¿ƒç®—æ³•è¯†åˆ«

### âœ¨ æœ¬é¢˜ä¸»è¦è€ƒå¯Ÿ
**çŠ¶å‹åŠ¨æ€è§„åˆ’ï¼ˆDPï¼‰+ å®¹æ–¥åŸç†**

### ğŸ—£ï¸ åˆæ­¥åˆ†æ
#### 1.1 é—®é¢˜æœ¬è´¨ä¸ç®—æ³•å®šä½
ç«èµ›å›¾çš„ç‰¹æ®Šæ€§è´¨æ˜¯å…³é”®ï¼š**ç¼©ç‚¹åæ˜¯ä¸€æ¡é“¾**ï¼ˆæ‰€æœ‰å¼ºè¿é€šåˆ†é‡ï¼ˆSCCï¼‰æŒ‰é¡ºåºæ’åˆ—ï¼Œå‰é¢çš„SCCå…¨æŒ‡å‘åé¢çš„ï¼‰ã€‚é¢˜ç›®ä¸­çš„â€œwinnerâ€æ­£æ˜¯é“¾å¤´SCCé‡Œçš„æ‰€æœ‰é˜Ÿä¼â€”â€”å®ƒä»¬èƒ½é—´æ¥å‡»è´¥æ‰€æœ‰äººã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦è®¡ç®—**é“¾å¤´SCCå¤§å°çš„æœŸæœ›**ã€‚

çŠ¶å‹DPæ˜¯å¤„ç†å°é›†åˆé—®é¢˜ï¼ˆnâ‰¤14ï¼‰çš„ç¥å™¨ï¼šç”¨äºŒè¿›åˆ¶æ•°è¡¨ç¤ºé›†åˆï¼ˆæ¯”å¦‚`101`ä»£è¡¨åŒ…å«ç¬¬0ã€2å·é˜Ÿä¼ï¼‰ã€‚å®¹æ–¥åŸç†åˆ™ç”¨æ¥è§£å†³â€œåå‘è®¡ç®—â€çš„é—®é¢˜â€”â€”æ¯”å¦‚è®¡ç®—â€œiå‡»è´¥Sä¸­æ‰€æœ‰äººçš„æ¦‚ç‡â€ï¼Œå¯ä»¥å…ˆç®—â€œiæ²¡å‡»è´¥Sä¸­æ‰€æœ‰äººçš„æ¦‚ç‡â€ï¼Œå†ç”¨1å‡å»å®ƒã€‚

#### 1.2 æ ¸å¿ƒæ€è·¯ä¸éš¾ç‚¹
æ‰€æœ‰é¢˜è§£çš„å…±æ€§æ˜¯**æœŸæœ›çº¿æ€§æ€§**ï¼šå°†â€œæ€»winneræœŸæœ›â€æ‹†åˆ†ä¸ºâ€œæ¯ä¸ªç‚¹æˆä¸ºwinnerçš„æ¦‚ç‡ä¹‹å’Œâ€ï¼Œæˆ–â€œæ¯ä¸ªé›†åˆä½œä¸ºé“¾å¤´SCCçš„æ¦‚ç‡Ã—å¤§å°ä¹‹å’Œâ€ã€‚æ ¸å¿ƒéš¾ç‚¹æ˜¯ï¼š
- **çŠ¶æ€å®šä¹‰**ï¼šå¦‚ä½•ç”¨DPçŠ¶æ€è¡¨ç¤ºâ€œæŸç‚¹å‡»è´¥æŸé›†åˆâ€æˆ–â€œæŸé›†åˆæ˜¯é“¾å¤´SCCâ€ï¼Ÿ
- **å¿«é€Ÿè®¡ç®—é›†åˆé—´çš„èƒœè´Ÿæ¦‚ç‡**ï¼šæ¯”å¦‚é›†åˆSå…¨è´¥äºé›†åˆTçš„æ¦‚ç‡ï¼ˆè®°ä¸ºg(S,T)ï¼‰ï¼Œç›´æ¥ç®—ä¼šè¶…æ—¶ï¼Œéœ€è¦é¢„å¤„ç†ä¼˜åŒ–ã€‚
- **å®¹æ–¥è½¬ç§»**ï¼šå¦‚ä½•é¿å…é‡å¤è®¡ç®—ï¼Œç”¨å­é›†çš„ç»“æœæ¨å¯¼æ›´å¤§é›†åˆçš„ç»“æœï¼Ÿ

#### 1.3 å¯è§†åŒ–è®¾è®¡æ€è·¯
æˆ‘ä»¬ä¼šç”¨**8ä½åƒç´ é£æ ¼**åŠ¨ç”»å±•ç¤ºçŠ¶å‹DPçš„è¿‡ç¨‹ï¼š
- ç”¨**äºŒè¿›åˆ¶ç¯æ³¡é˜µ**è¡¨ç¤ºé›†åˆï¼ˆäº®ç¯=åŒ…å«è¯¥é˜Ÿä¼ï¼‰ï¼›
- ç”¨**é¢œè‰²é—ªçƒ**æ ‡è®°å½“å‰å¤„ç†çš„é›†åˆSå’Œå…¶å­é›†Tï¼›
- ç”¨**è¿›åº¦æ¡**å±•ç¤ºæ¦‚ç‡è®¡ç®—ï¼ˆæ¯”å¦‚h(i,S)çš„ç§¯ç´¯ï¼‰ï¼›
- å…³é”®æ“ä½œï¼ˆå¦‚å­é›†æšä¸¾ã€æ¦‚ç‡ç›¸ä¹˜ï¼‰ä¼´éš**â€œå®â€çš„åƒç´ éŸ³æ•ˆ**ï¼ŒæˆåŠŸè½¬ç§»æ—¶æ’­æ”¾â€œèƒœåˆ©éŸ³è°ƒâ€ã€‚


## 2. ç²¾é€‰ä¼˜è´¨é¢˜è§£å‚è€ƒ

### é¢˜è§£ä¸€ï¼ˆä½œè€…ï¼šæš´åŠ›å‡ºå¥‡è¿¹ï¼Œèµ10ï¼‰
**ç‚¹è¯„**ï¼šè¿™é“é¢˜çš„â€œä¼˜åŒ–å¤©èŠ±æ¿â€ï¼ä½œè€…å…ˆè®²æ¸…äº†åŸºç¡€çš„O(3â¿nÂ²)æ€è·¯ï¼Œå†é€šè¿‡**ä¸‰è¿›åˆ¶å‹ç¼©**å°†g(S,T)çš„å­˜å‚¨ä»O(2â¿Ã—2â¿)ä¼˜åŒ–åˆ°O(3â¿)ï¼Œç›´æ¥è§£å†³äº†ç©ºé—´çˆ†ç‚¸é—®é¢˜ã€‚ä»£ç ä¸­`flect[S]`å°†äºŒè¿›åˆ¶é›†åˆè½¬ä¸ºä¸‰è¿›åˆ¶æ•°å€¼ï¼Œå·§å¦™å‹ç¼©(S,T)äºŒå…ƒç»„ï¼Œé€»è¾‘ä¸¥è°¨ä¸”é«˜æ•ˆã€‚æ›´éš¾å¾—çš„æ˜¯ï¼Œä½œè€…æŠŠâ€œä¸ºä»€ä¹ˆè¦ä¼˜åŒ–â€â€œæ€ä¹ˆä¼˜åŒ–â€è®²å¾—æ¸…æ¸…æ¥šæ¥šï¼Œéå¸¸é€‚åˆå­¦ä¹ çŠ¶å‹çš„é«˜çº§æŠ€å·§ã€‚

### é¢˜è§£äºŒï¼ˆä½œè€…ï¼šCry_For_theMoonï¼Œèµ8ï¼‰
**ç‚¹è¯„**ï¼šæœ€é€‚åˆå…¥é—¨çš„â€œæ ‡å‡†è§£æ³•â€ï¼ä½œè€…ç”¨**å¡«è¡¨æ³•**å®šä¹‰f(i,S)ï¼ˆiå‡»è´¥Sä¸­æ‰€æœ‰äººçš„æ¦‚ç‡ï¼‰ï¼Œé€šè¿‡å®¹æ–¥å…¬å¼`f(i,S)=1-Î£f(i,T)Ã—g(T,S-T)`è®¡ç®—ã€‚é¢„å¤„ç†h(i,S)ï¼ˆiè¾“ç»™Sæ‰€æœ‰ç‚¹çš„æ¦‚ç‡ï¼‰åï¼Œg(T,S-T)å¯ä»¥O(n)ç®—å‡ºï¼Œå¤æ‚åº¦é™åˆ°O(3â¿nÂ²)ã€‚ä»£ç é£æ ¼ç®€æ´ï¼Œå˜é‡åï¼ˆå¦‚hã€fã€gï¼‰å«ä¹‰æ˜ç¡®ï¼Œè¾¹ç•Œå¤„ç†ï¼ˆæ¯”å¦‚iâˆˆSï¼‰éå¸¸ä¸¥è°¨ï¼Œæ˜¯ç†è§£åŸºç¡€æ€è·¯çš„æœ€ä½³å‚è€ƒã€‚

### é¢˜è§£ä¸‰ï¼ˆä½œè€…ï¼šTerminus_Estï¼Œèµ2ï¼‰
**ç‚¹è¯„**ï¼šâ€œæ¢ä¸ªè§’åº¦çœ‹é—®é¢˜â€çš„å…¸èŒƒï¼ä½œè€…è·³å‡ºâ€œå•ä¸ªç‚¹çš„æ¦‚ç‡â€ï¼Œç›´æ¥è®¡ç®—**é›†åˆSä½œä¸ºé“¾å¤´SCCçš„æ¦‚ç‡h(S)**ã€‚é€šè¿‡å®¹æ–¥å…¬å¼`h(S)=g(S,~S)-Î£h(T)Ã—g(S\T,~S)`ï¼ˆg(S,T)æ˜¯Så…¨æŒ‡å‘Tçš„æ¦‚ç‡ï¼‰ï¼Œé¿å…äº†æšä¸¾æ¯ä¸ªç‚¹çš„é‡å¤è®¡ç®—ã€‚ä»£ç ä¸­`trs[i][sta]`é¢„å¤„ç†ç‚¹iæŒ‡å‘é›†åˆstaçš„æ¦‚ç‡ï¼Œ`dp[S]`ç›´æ¥å­˜å‚¨h(S)ï¼Œå®ç°éå¸¸â€œå°æ¸…æ–°â€ï¼Œé€‚åˆæ‹“å±•æ€ç»´ã€‚


## 3. æ ¸å¿ƒéš¾ç‚¹è¾¨æä¸è§£é¢˜ç­–ç•¥

### 3.1 å…³é”®ç‚¹1ï¼šå¦‚ä½•å®šä¹‰DPçŠ¶æ€ï¼Ÿ
**éš¾ç‚¹**ï¼šç›´æ¥è®¡ç®—â€œiæ˜¯winnerâ€çš„æ¦‚ç‡å¾ˆéš¾ï¼Œå› ä¸ºè¦è€ƒè™‘æ‰€æœ‰å¯èƒ½çš„å‡»è´¥è·¯å¾„ã€‚  
**ç­–ç•¥**ï¼šåå‘å®šä¹‰çŠ¶æ€â€”â€”`f(i,S)`è¡¨ç¤ºiå‡»è´¥Sä¸­æ‰€æœ‰äººçš„æ¦‚ç‡ï¼ˆiâˆˆSï¼‰ã€‚è¿™æ ·ï¼Œâ€œiæ˜¯winnerâ€å°±æ˜¯`f(i,å…¨é›†)`ã€‚  
**å­¦ä¹ ç¬”è®°**ï¼šçŠ¶æ€å®šä¹‰è¦â€œæŠ“æœ¬è´¨â€ï¼Œåå‘æ€è€ƒå¾€å¾€èƒ½ç®€åŒ–é—®é¢˜ï¼

### 3.2 å…³é”®ç‚¹2ï¼šå¦‚ä½•å¿«é€Ÿè®¡ç®—é›†åˆé—´çš„èƒœè´Ÿæ¦‚ç‡ï¼Ÿ
**éš¾ç‚¹**ï¼šç›´æ¥ç®—g(S,T)=Så…¨è´¥äºTçš„æ¦‚ç‡éœ€è¦O(|S||T|)æ—¶é—´ï¼Œæ€»å¤æ‚åº¦ä¼šçˆ†ç‚¸ã€‚  
**ç­–ç•¥**ï¼šé¢„å¤„ç†`h(i,S)`ï¼ˆiè¾“ç»™Sæ‰€æœ‰ç‚¹çš„æ¦‚ç‡ï¼‰ï¼Œåˆ™g(S,T)=âˆ(iâˆˆS) h(i,T)ã€‚h(i,S)å¯ä»¥é€šè¿‡é€’æ¨è®¡ç®—ï¼š`h(i,S)=h(i,S\lowbit(S)) Ã— (a[j]/(a[i]+a[j]))`ï¼ˆjæ˜¯Sçš„æœ€ä½ä½ï¼‰ã€‚  
**å­¦ä¹ ç¬”è®°**ï¼šé¢„å¤„ç†æ˜¯çŠ¶å‹DPçš„â€œåŠ é€Ÿå™¨â€ï¼ŒæŠŠé‡å¤è®¡ç®—çš„éƒ¨åˆ†æå‰ç®—å¥½ï¼

### 3.3 å…³é”®ç‚¹3ï¼šå¦‚ä½•ç”¨å®¹æ–¥åŸç†è½¬ç§»çŠ¶æ€ï¼Ÿ
**éš¾ç‚¹**ï¼šè®¡ç®—`f(i,S)`æ—¶ï¼Œç›´æ¥ç®—â€œiå‡»è´¥Sæ‰€æœ‰äººâ€çš„æƒ…å†µå¤ªå¤šï¼Œæ— æ³•æšä¸¾ã€‚  
**ç­–ç•¥**ï¼šç”¨å®¹æ–¥ç®—â€œiæ²¡å‡»è´¥Sæ‰€æœ‰äººâ€çš„æ¦‚ç‡â€”â€”å³iåªå‡»è´¥äº†Sçš„å­é›†Tï¼Œä¸”Tå…¨è´¥äºS\Tã€‚å…¬å¼ä¸ºï¼š`f(i,S)=1 - Î£(f(i,T) Ã— g(T,S\T))`ï¼ˆTæ˜¯Sçš„çœŸå­é›†ä¸”åŒ…å«iï¼‰ã€‚  
**å­¦ä¹ ç¬”è®°**ï¼šå®¹æ–¥æ˜¯â€œä»¥é€€ä¸ºè¿›â€çš„è‰ºæœ¯â€”â€”ç®—â€œåæƒ…å†µâ€æ¯”â€œæ­£æƒ…å†µâ€æ›´ç®€å•ï¼

### âœ¨ è§£é¢˜æŠ€å·§æ€»ç»“
1. **æœŸæœ›çº¿æ€§æ€§**ï¼šä¸ç®¡äº‹ä»¶æ˜¯å¦ç‹¬ç«‹ï¼ŒæœŸæœ›çš„å’Œç­‰äºå’Œçš„æœŸæœ›ã€‚è¿™æ˜¯è§£å†³â€œè®¡æ•°æœŸæœ›â€é—®é¢˜çš„ä¸‡èƒ½é’¥åŒ™ï¼
2. **çŠ¶å‹DPçš„é¢„å¤„ç†**ï¼šå¯¹äºé›†åˆçš„é‡å¤è®¡ç®—ï¼ˆå¦‚h(i,S)ï¼‰ï¼Œä¸€å®šè¦æå‰é€’æ¨å¥½ï¼Œé¿å…è¶…æ—¶ã€‚
3. **å­é›†æšä¸¾çš„æŠ€å·§**ï¼šç”¨`for(T=(S-1)&S; T; T=(T-1)&S)`æšä¸¾Sçš„æ‰€æœ‰éç©ºçœŸå­é›†ï¼Œè¿™æ˜¯çŠ¶å‹DPçš„æ ‡å‡†å†™æ³•ï¼


## 4. C++æ ¸å¿ƒä»£ç å®ç°èµæ

### æœ¬é¢˜é€šç”¨æ ¸å¿ƒC++å®ç°å‚è€ƒ
**è¯´æ˜**ï¼šç»¼åˆäº†â€œCry_For_theMoonâ€å’Œâ€œæš´åŠ›å‡ºå¥‡è¿¹â€çš„æ€è·¯ï¼Œé‡‡ç”¨æ ‡å‡†çš„f(i,S)çŠ¶æ€å®šä¹‰ï¼Œé¢„å¤„ç†h(i,S)ä¼˜åŒ–g(S,T)è®¡ç®—ã€‚

```cpp
#include <iostream>
#include <cstring>
using namespace std;

const int N = 14;
const int MOD = 1e9 + 7;
int n, a[N], inv[2000005];
int h[N][1 << N], f[N][1 << N]; // h[i][S]: iè¾“ç»™Sæ‰€æœ‰ç‚¹çš„æ¦‚ç‡ï¼›f[i][S]: iå‡»è´¥Sæ‰€æœ‰ç‚¹çš„æ¦‚ç‡

// å¿«é€Ÿå¹‚æ±‚é€†å…ƒï¼ˆé¢„å¤„ç†ç”¨ï¼‰
int qpow(int x, int y) {
    int ret = 1;
    while (y) {
        if (y & 1) ret = 1LL * ret * x % MOD;
        x = 1LL * x * x % MOD;
        y >>= 1;
    }
    return ret;
}

// è®¡ç®—g(S,T)ï¼šSå…¨è´¥äºTçš„æ¦‚ç‡
int g(int S, int T) {
    int ret = 1;
    for (int i = 0; i < n; ++i) {
        if (S & (1 << i)) {
            ret = 1LL * ret * h[i][T] % MOD;
        }
    }
    return ret;
}

int main() {
    // é¢„å¤„ç†é€†å…ƒï¼ˆå› ä¸ºa_i+a_jå¯èƒ½å¾ˆå¤§ï¼Œéœ€è¦å¿«é€Ÿæ±‚é€†ï¼‰
    inv[1] = 1;
    for (int i = 2; i <= 2000000; ++i) {
        inv[i] = (MOD - 1LL * (MOD / i) * inv[MOD % i] % MOD) % MOD;
    }

    cin >> n;
    for (int i = 0; i < n; ++i) cin >> a[i];

    // é¢„å¤„ç†h[i][S]ï¼šiè¾“ç»™Sæ‰€æœ‰ç‚¹çš„æ¦‚ç‡
    for (int i = 0; i < n; ++i) {
        for (int S = 1; S < (1 << n); ++S) {
            if (S & (1 << i)) continue; // Sä¸èƒ½åŒ…å«i
            int lb = S & -S; // å–Sçš„æœ€ä½ä½
            int j = __builtin_ctz(lb); // æœ€ä½ä½å¯¹åº”çš„ç´¢å¼•
            h[i][S] = 1LL * h[i][S ^ lb] * a[j] % MOD * inv[a[i] + a[j]] % MOD;
        }
    }

    // è®¡ç®—f[i][S]
    for (int i = 0; i < n; ++i) {
        for (int S = 1; S < (1 << n); ++S) {
            if (!(S & (1 << i))) continue; // Så¿…é¡»åŒ…å«i
            f[i][S] = 1; // åˆå§‹åŒ–ä¸º1ï¼ˆå‡è®¾iå‡»è´¥Sæ‰€æœ‰äººï¼‰
            // æšä¸¾Sçš„æ‰€æœ‰çœŸå­é›†Tï¼ˆåŒ…å«iï¼‰
            for (int T = (S - 1) & S; T; T = (T - 1) & S) {
                if (!(T & (1 << i))) continue; // Tå¿…é¡»åŒ…å«i
                int val = 1LL * f[i][T] * g(T, S ^ T) % MOD;
                f[i][S] = (f[i][S] - val + MOD) % MOD; // å®¹æ–¥å‡å»åæƒ…å†µ
            }
        }
    }

    // è®¡ç®—ç­”æ¡ˆï¼šæ‰€æœ‰içš„f[i][å…¨é›†]ä¹‹å’Œ
    int ans = 0;
    int full = (1 << n) - 1;
    for (int i = 0; i < n; ++i) {
        ans = (ans + f[i][full]) % MOD;
    }
    cout << ans << endl;

    return 0;
}
```

**ä»£ç è§£è¯»æ¦‚è¦**ï¼š
1. **é¢„å¤„ç†é€†å…ƒ**ï¼šå› ä¸ºè¦è®¡ç®—`a[j]/(a[i]+a[j])`ï¼Œéœ€è¦ç”¨æ¨¡é€†å…ƒï¼ˆè´¹é©¬å°å®šç†ï¼‰ã€‚
2. **é¢„å¤„ç†h[i][S]**ï¼šé€’æ¨è®¡ç®—iè¾“ç»™Sæ‰€æœ‰ç‚¹çš„æ¦‚ç‡ï¼Œæ¯æ¬¡æ·»åŠ Sçš„æœ€ä½ä½jï¼Œä¹˜ä¸Šjèµ¢içš„æ¦‚ç‡ã€‚
3. **è®¡ç®—f[i][S]**ï¼šç”¨å®¹æ–¥åŸç†ï¼Œæšä¸¾Sçš„æ‰€æœ‰åŒ…å«içš„çœŸå­é›†Tï¼Œå‡å»â€œiåªå‡»è´¥Tä¸”Tå…¨è´¥äºS\Tâ€çš„æ¦‚ç‡ã€‚
4. **ç»Ÿè®¡ç­”æ¡ˆ**ï¼šæ‰€æœ‰ç‚¹çš„f[i][å…¨é›†]ä¹‹å’Œå°±æ˜¯æ€»æœŸæœ›ã€‚

---

### é¢˜è§£ä¸€ï¼ˆæš´åŠ›å‡ºå¥‡è¿¹ï¼‰çš„æ ¸å¿ƒç‰‡æ®µèµæ
**äº®ç‚¹**ï¼šä¸‰è¿›åˆ¶å‹ç¼©ä¼˜åŒ–g(S,T)çš„å­˜å‚¨ã€‚
**æ ¸å¿ƒä»£ç ç‰‡æ®µ**ï¼š
```cpp
const int M = 5000010; // 3^14â‰ˆ4.7e5ï¼Œè¶³å¤Ÿç”¨
int flect[1 << N], g[M]; // flect[S]ï¼šäºŒè¿›åˆ¶Sè½¬ä¸‰è¿›åˆ¶æ•°å€¼ï¼›g[ä¸‰è¿›åˆ¶å€¼]ï¼šg(S,T)çš„æ¦‚ç‡

// é¢„å¤„ç†flect[S]ï¼šå°†äºŒè¿›åˆ¶Sè½¬ä¸ºä¸‰è¿›åˆ¶ï¼ˆæ¯ä¸ªä½ä¸º1åˆ™ä¸‰è¿›åˆ¶ä½ä¸º1ï¼‰
for (int S = 0; S < (1 << n); ++S) {
    flect[S] = 0;
    for (int i = 0; i < n; ++i) {
        if (S & (1 << i)) {
            flect[S] += qpow(3, i);
        }
    }
}

// é¢„å¤„ç†g(S,T)ï¼šå‹ç¼©ä¸ºä¸‰è¿›åˆ¶å€¼2*flect[S]+flect[T]
for (int S = 0; S < (1 << n); ++S) {
    int Us = ((1 << n) - 1) ^ S;
    for (int T = Us; T; T = (T - 1) & Us) {
        int x = 2 * flect[S] + flect[T]; // ä¸‰è¿›åˆ¶å‹ç¼©ï¼šSå¯¹åº”2ï¼ŒTå¯¹åº”1
        g[x] = 1;
        for (int i = 0; i < n; ++i) {
            if (S & (1 << i)) {
                g[x] = 1LL * g[x] * h[i][T] % MOD;
            }
        }
    }
}
```
**ä»£ç è§£è¯»**ï¼š
- `flect[S]`å°†äºŒè¿›åˆ¶é›†åˆSè½¬ä¸ºä¸‰è¿›åˆ¶æ•°ï¼ˆæ¯”å¦‚S=101ï¼Œå¯¹åº”ä¸‰è¿›åˆ¶çš„1*3Â² + 0*3Â¹ +1*3â°=10ï¼‰ã€‚
- `2*flect[S]+flect[T]`å°†(S,T)äºŒå…ƒç»„å‹ç¼©ä¸ºä¸€ä¸ªä¸‰è¿›åˆ¶æ•°ï¼šSçš„ä½æ˜¯2ï¼ŒTçš„ä½æ˜¯1ï¼Œå…¶ä½™æ˜¯0ã€‚è¿™æ ·g(S,T)çš„å­˜å‚¨ä»O(2â¿Ã—2â¿)é™åˆ°O(3â¿)ï¼Œè§£å†³äº†ç©ºé—´é—®é¢˜ã€‚
**å­¦ä¹ ç¬”è®°**ï¼šå½“éœ€è¦å­˜å‚¨ä¸¤ä¸ªä¸ç›¸äº¤é›†åˆçš„ä¿¡æ¯æ—¶ï¼Œä¸‰è¿›åˆ¶å‹ç¼©æ˜¯â€œç©ºé—´é­”æ³•â€ï¼

---

### é¢˜è§£ä¸‰ï¼ˆTerminus_Estï¼‰çš„æ ¸å¿ƒç‰‡æ®µèµæ
**äº®ç‚¹**ï¼šç›´æ¥è®¡ç®—é›†åˆä½œä¸ºé“¾å¤´SCCçš„æ¦‚ç‡ã€‚
**æ ¸å¿ƒä»£ç ç‰‡æ®µ**ï¼š
```cpp
int trs[N][1 << N]; // trs[i][sta]ï¼šiæŒ‡å‘staæ‰€æœ‰ç‚¹çš„æ¦‚ç‡
int dp[1 << N]; // dp[S]ï¼šSä½œä¸ºé“¾å¤´SCCçš„æ¦‚ç‡

// é¢„å¤„ç†trs[i][sta]
for (int i = 1; i <= n; ++i) {
    trs[i][0] = 1;
    for (int sta = 1; sta <= lim; ++sta) {
        int lb = lowbit(sta);
        trs[i][sta] = 1LL * trs[i][sta ^ lb] * val[i][id[lb]] % MOD;
    }
}

// è®¡ç®—dp[S]
for (int s = 1; s <= lim; ++s) {
    int els = lim ^ s;
    g[0] = 1;
    // æšä¸¾sçš„å­é›†tï¼ˆé“¾å¤´çš„å­SCCï¼‰
    for (int t = (s-1)&s; t; t = (t-1)&s) {
        int st = s ^ t;
        g[st] = 1LL * g[st ^ lowbit(st)] * trs[id[lowbit(st)]][els] % MOD;
        dp[s] = (dp[s] - 1LL * dp[t] * g[st] % MOD + MOD) % MOD;
    }
    g[s] = 1LL * g[s ^ lowbit(s)] * trs[id[lowbit(s)]][els] % MOD;
    dp[s] = (dp[s] + g[s]) % MOD;
    ans = (ans + 1LL * dp[s] * __builtin_popcount(s) % MOD) % MOD;
}
```
**ä»£ç è§£è¯»**ï¼š
- `trs[i][sta]`é¢„å¤„ç†ç‚¹iæŒ‡å‘é›†åˆstaçš„æ¦‚ç‡ï¼ˆå’Œh(i,sta)ç›¸åï¼‰ã€‚
- `dp[s]`è¡¨ç¤ºé›†åˆsä½œä¸ºé“¾å¤´SCCçš„æ¦‚ç‡ï¼šå…ˆç®—så…¨æŒ‡å‘~sçš„æ¦‚ç‡g[s]ï¼Œå†å‡å»sè¢«æ‹†åˆ†ä¸ºtå’Œs\tï¼ˆtæ˜¯é“¾å¤´ï¼‰çš„æƒ…å†µï¼ˆå®¹æ–¥ï¼‰ã€‚
- æœ€åç»Ÿè®¡æ‰€æœ‰sçš„`dp[s]Ã—size(s)`ä¹‹å’Œï¼Œå°±æ˜¯æœŸæœ›ã€‚
**å­¦ä¹ ç¬”è®°**ï¼šæœ‰æ—¶å€™â€œè·³è„±å‡ºå•ä¸ªç‚¹â€ï¼Œç›´æ¥å¤„ç†é›†åˆï¼Œèƒ½æ›´é«˜æ•ˆåœ°è§£å†³é—®é¢˜ï¼


## 5. ç®—æ³•å¯è§†åŒ–ï¼šåƒç´ åŠ¨ç”»æ¼”ç¤º

### ğŸ® åŠ¨ç”»ä¸»é¢˜ï¼šåƒç´ æ¢é™©é˜Ÿçš„â€œé“¾å¤´äº‰å¤ºæˆ˜â€
æˆ‘ä»¬ç”¨**FCçº¢ç™½æœºé£æ ¼**çš„åƒç´ åŠ¨ç”»ï¼Œå±•ç¤ºçŠ¶å‹DPçš„æ ¸å¿ƒæµç¨‹ï¼š

### ğŸ¨ è®¾è®¡æ€è·¯
- **é£æ ¼**ï¼š8ä½åƒç´ è‰²æ¿ï¼ˆæ¯”å¦‚é»‘è‰²èƒŒæ™¯ã€ç»¿è‰²æ–‡å­—ã€å½©è‰²æ–¹å—ä»£è¡¨é˜Ÿä¼ï¼‰ï¼Œæ¨¡æ‹Ÿç»å…¸æ¸¸æˆã€Šå¡å°”è¾¾ä¼ è¯´ã€‹çš„ç•Œé¢ã€‚
- **åœºæ™¯**ï¼šå±å¹•å·¦ä¾§æ˜¯â€œäºŒè¿›åˆ¶é›†åˆæ˜¾ç¤ºå™¨â€ï¼ˆç”¨14ä¸ªç¯æ³¡è¡¨ç¤ºé˜Ÿä¼æ˜¯å¦åœ¨é›†åˆä¸­ï¼‰ï¼Œå³ä¾§æ˜¯â€œæ¦‚ç‡è®¡ç®—é¢æ¿â€ï¼Œåº•éƒ¨æ˜¯â€œæ§åˆ¶é¢æ¿â€ï¼ˆå•æ­¥ã€è‡ªåŠ¨ã€é‡ç½®ï¼‰ã€‚
- **æ¸¸æˆåŒ–å…ƒç´ **ï¼š
  - æ¯å¤„ç†ä¸€ä¸ªé›†åˆSï¼Œæ’­æ”¾â€œæ¢ç´¢éŸ³æ•ˆâ€ï¼ˆç±»ä¼¼ã€Šè¶…çº§é©¬é‡Œå¥¥ã€‹çš„è¸©ç –å—å£°ï¼‰ï¼›
  - æˆåŠŸè®¡ç®—f(i,S)æ—¶ï¼Œæ’­æ”¾â€œå‡çº§éŸ³æ•ˆâ€ï¼ˆç±»ä¼¼ã€Šç²¾çµå®å¯æ¢¦ã€‹çš„è¿›åŒ–å£°ï¼‰ï¼›
  - å®Œæˆæ‰€æœ‰è®¡ç®—æ—¶ï¼Œå±•ç¤ºâ€œèƒœåˆ©åŠ¨ç”»â€ï¼ˆåƒç´ çƒŸèŠ±+â€œä»»åŠ¡å®Œæˆâ€æ–‡å­—ï¼‰ã€‚

### ğŸš¶ åŠ¨ç”»æ­¥éª¤è¯¦è§£
1. **åˆå§‹åŒ–**ï¼š
   - å±å¹•æ˜¾ç¤º14ä¸ªç¯æ³¡ï¼ˆä»£è¡¨n=14çš„é˜Ÿä¼ï¼‰ï¼Œåˆå§‹å…¨ç­ï¼›
   - æ¦‚ç‡é¢æ¿æ˜¾ç¤ºâ€œh[i][S]é¢„å¤„ç†ä¸­â€ï¼Œè¿›åº¦æ¡ä»0å¼€å§‹å¢é•¿ï¼›
   - æ’­æ”¾8ä½é£æ ¼çš„èƒŒæ™¯éŸ³ä¹ï¼ˆç±»ä¼¼ã€Šå¦å…‹å¤§æˆ˜ã€‹çš„BGMï¼‰ã€‚
   
2. **é¢„å¤„ç†h(i,S)**ï¼š
   - é€‰ä¸­ç¬¬iä¸ªé˜Ÿä¼ï¼ˆç¯æ³¡é—ªçƒï¼‰ï¼Œé€æ­¥ç‚¹äº®Sçš„ç¯æ³¡ï¼ˆä»ç©ºé›†åˆ°å…¨é›†ï¼‰ï¼›
   - æ¯æ·»åŠ ä¸€ä¸ªç¯æ³¡jï¼ˆSçš„æœ€ä½ä½ï¼‰ï¼Œæ¦‚ç‡é¢æ¿æ˜¾ç¤ºâ€œh[i][S] = h[i][S\j] Ã— (a[j]/(a[i]+a[j]))â€ï¼Œå¹¶æ’­æ”¾â€œå®â€çš„éŸ³æ•ˆï¼›
   - è¿›åº¦æ¡å¡«æ»¡åï¼Œæ˜¾ç¤ºâ€œé¢„å¤„ç†å®Œæˆï¼â€ã€‚

3. **è®¡ç®—f(i,S)**ï¼š
   - é€‰ä¸­ç¬¬iä¸ªé˜Ÿä¼ï¼ˆç¯æ³¡å˜çº¢ï¼‰ï¼Œç‚¹äº®Sçš„ç¯æ³¡ï¼ˆåŒ…å«iï¼‰ï¼›
   - æšä¸¾Sçš„å­é›†Tï¼ˆç¯æ³¡é—ªçƒé»„è‰²ï¼‰ï¼Œæ¦‚ç‡é¢æ¿æ˜¾ç¤ºâ€œf(i,S) -= f(i,T) Ã— g(T,S\T)â€ï¼›
   - æ¯å®Œæˆä¸€æ¬¡å­é›†æšä¸¾ï¼Œæ’­æ”¾â€œæ»´ç­”â€éŸ³æ•ˆï¼Œf(i,S)çš„æ•°å€¼åœ¨é¢æ¿ä¸Šæ›´æ–°ï¼›
   - å®Œæˆæ‰€æœ‰å­é›†æšä¸¾åï¼Œf(i,S)çš„æ•°å€¼å˜ä¸ºç»¿è‰²ï¼Œä»£è¡¨è®¡ç®—å®Œæˆã€‚

4. **ç»Ÿè®¡ç­”æ¡ˆ**ï¼š
   - ä¾æ¬¡ç‚¹äº®æ¯ä¸ªiçš„â€œå…¨é›†ç¯æ³¡â€ï¼Œé¢æ¿æ˜¾ç¤ºâ€œans += f(i,å…¨é›†)â€ï¼›
   - æœ€ç»ˆç­”æ¡ˆæ˜¾ç¤ºåœ¨å±å¹•ä¸­å¤®ï¼Œæ’­æ”¾â€œèƒœåˆ©éŸ³æ•ˆâ€ï¼ˆç±»ä¼¼ã€Šé­‚æ–—ç½—ã€‹çš„é€šå…³å£°ï¼‰ã€‚

### ğŸ¯ äº¤äº’è®¾è®¡
- **å•æ­¥æ¨¡å¼**ï¼šç‚¹å‡»â€œä¸‹ä¸€æ­¥â€æŒ‰é’®ï¼ŒåŠ¨ç”»æ‰§è¡Œä¸€æ­¥ï¼ˆæ¯”å¦‚é¢„å¤„ç†ä¸€ä¸ªh[i][S]ï¼Œæˆ–æšä¸¾ä¸€ä¸ªå­é›†Tï¼‰ï¼›
- **è‡ªåŠ¨æ¨¡å¼**ï¼šæ‹–åŠ¨â€œé€Ÿåº¦æ»‘å—â€è°ƒæ•´åŠ¨ç”»é€Ÿåº¦ï¼ŒåŠ¨ç”»è‡ªåŠ¨æ‰§è¡Œæ‰€æœ‰æ­¥éª¤ï¼›
- **é‡ç½®æ¨¡å¼**ï¼šç‚¹å‡»â€œé‡ç½®â€æŒ‰é’®ï¼ŒåŠ¨ç”»å›åˆ°åˆå§‹çŠ¶æ€ï¼Œé‡æ–°å¼€å§‹ã€‚


## 6. æ‹“å±•ç»ƒä¹ ä¸ç›¸ä¼¼é—®é¢˜æ€è€ƒ

### ğŸŒ é€šç”¨æ€è·¯è¿ç§»
çŠ¶å‹DP+å®¹æ–¥çš„ç»„åˆï¼Œé€‚ç”¨äº**å°é›†åˆã€éœ€è¦æšä¸¾å­é›†ã€åå‘è®¡ç®—**çš„é—®é¢˜ï¼Œæ¯”å¦‚ï¼š
1. **é›†åˆè¦†ç›–é—®é¢˜**ï¼šè®¡ç®—è¦†ç›–æ‰€æœ‰å…ƒç´ çš„æœ€å°æˆæœ¬çš„æœŸæœ›ï¼›
2. **ç«èµ›å›¾çš„SCCé—®é¢˜**ï¼šè®¡ç®—æŸé›†åˆæ˜¯SCCçš„æ¦‚ç‡ï¼›
3. **å­é›†è´¡çŒ®é—®é¢˜**ï¼šè®¡ç®—æ‰€æœ‰å­é›†çš„æŸç§å±æ€§ä¹‹å’Œï¼ˆå¦‚å¤§å°Ã—æ¦‚ç‡ï¼‰ã€‚

### ğŸ“š æ´›è°·ç»ƒä¹ æ¨è
1. **æ´›è°· P1896 [SCOI2005]äº’ä¸ä¾µçŠ¯**  
   ğŸ—£ï¸ æ¨èç†ç”±ï¼šç»å…¸çš„çŠ¶å‹DPå…¥é—¨é¢˜ï¼Œç»ƒä¹ â€œæšä¸¾å­é›†â€å’Œâ€œçŠ¶æ€è½¬ç§»â€ï¼Œå¸®ä½ å·©å›ºäºŒè¿›åˆ¶é›†åˆçš„æ“ä½œã€‚
   
2. **æ´›è°· P2340 [USACO03FALL]Cow Exhibition G**  
   ğŸ—£ï¸ æ¨èç†ç”±ï¼šäºŒç»´çŠ¶å‹DPï¼Œéœ€è¦å¤„ç†æ­£è´Ÿæƒå€¼çš„é›†åˆï¼Œç»ƒä¹ â€œçŠ¶æ€å‹ç¼©çš„æ‰©å±•â€ã€‚
   
3. **æ´›è°· P3175 [HAOI2015]æŒ‰ä½æˆ–**  
   ğŸ—£ï¸ æ¨èç†ç”±ï¼šå®¹æ–¥åŸç†çš„é«˜çº§åº”ç”¨ï¼Œè®¡ç®—â€œæŒ‰ä½æˆ–å¾—åˆ°å…¨é›†â€çš„æœŸæœ›æ­¥æ•°ï¼Œå’Œæœ¬é¢˜çš„â€œåå‘è®¡ç®—â€æ€è·¯ä¸€è‡´ã€‚
   
4. **æ´›è°· P4363 [ä¹çœè”è€ƒ2018]ä¸€åŒæœ¨æ£‹chess**  
   ğŸ—£ï¸ æ¨èç†ç”±ï¼šçŠ¶å‹DPçš„è¿›é˜¶é¢˜ï¼Œéœ€è¦ç»“åˆåšå¼ˆè®ºï¼Œç»ƒä¹ â€œçŠ¶æ€å‹ç¼©çš„ä¼˜åŒ–â€ï¼ˆå¦‚ç”¨å“ˆå¸Œè¡¨å­˜å‚¨çŠ¶æ€ï¼‰ã€‚


## 7. å­¦ä¹ å¿ƒå¾—ä¸ç»éªŒåˆ†äº«

### ğŸ“ æ¥è‡ªé¢˜è§£çš„ç»éªŒ
**é¢˜è§£ä¸€ï¼ˆæš´åŠ›å‡ºå¥‡è¿¹ï¼‰çš„ç»éªŒ**ï¼šâ€œg(S,T)æ•°ç»„å¼€ä¸ä¸‹çš„æ—¶å€™ï¼Œè¯•è¯•ä¸‰è¿›åˆ¶å‹ç¼©ï¼â€  
**ç‚¹è¯„**ï¼šå½“éœ€è¦å­˜å‚¨ä¸¤ä¸ªä¸ç›¸äº¤é›†åˆçš„ä¿¡æ¯æ—¶ï¼Œä¸‰è¿›åˆ¶å‹ç¼©æ˜¯â€œç©ºé—´æ•‘æ˜Ÿâ€ã€‚æ¯”å¦‚æœ¬é¢˜ä¸­ï¼Œ(S,T)äºŒå…ƒç»„çš„æ•°é‡æ˜¯3â¿ï¼ˆæ¯ä¸ªå…ƒç´ æœ‰ä¸‰ç§çŠ¶æ€ï¼šåœ¨Sã€åœ¨Tã€éƒ½ä¸åœ¨ï¼‰ï¼Œè€Œ3Â¹â´â‰ˆ4.7e5ï¼Œå®Œå…¨å¯ä»¥ç”¨æ•°ç»„å­˜å‚¨ã€‚

**é¢˜è§£äºŒï¼ˆCry_For_theMoonï¼‰çš„ç»éªŒ**ï¼šâ€œé¢„å¤„ç†h(i,S)çš„æ—¶å€™ï¼Œä¸€å®šè¦æ³¨æ„Sä¸èƒ½åŒ…å«iï¼â€  
**ç‚¹è¯„**ï¼šè¾¹ç•Œæ¡ä»¶æ˜¯çŠ¶å‹DPçš„â€œå‘â€ï¼Œæ¯”å¦‚h(i,S)è¡¨ç¤ºiè¾“ç»™Sçš„æ¦‚ç‡ï¼ŒSå¿…é¡»ä¸åŒ…å«iï¼Œå¦åˆ™ä¼šå‡ºç°â€œiè¾“ç»™è‡ªå·±â€çš„æ— æ„ä¹‰æƒ…å†µã€‚å†™ä»£ç æ—¶ä¸€å®šè¦åŠ `if(S & (1<<i)) continue;`è¿™æ ·çš„åˆ¤æ–­ï¼


## ç»“è¯­
é€šè¿‡è¿™é“é¢˜ï¼Œæˆ‘ä»¬å­¦ä¼šäº†ç”¨**çŠ¶å‹DP**å¤„ç†å°é›†åˆé—®é¢˜ï¼Œç”¨**å®¹æ–¥åŸç†**åå‘è®¡ç®—æ¦‚ç‡ï¼Œè¿˜æŒæ¡äº†**é¢„å¤„ç†**å’Œ**ä¸‰è¿›åˆ¶å‹ç¼©**çš„ä¼˜åŒ–æŠ€å·§ã€‚è®°ä½ï¼šç¼–ç¨‹çš„æœ¬è´¨æ˜¯â€œæ‹†è§£é—®é¢˜â€â€”â€”æŠŠå¤æ‚çš„å¤§é—®é¢˜æ‹†æˆå¯è®¡ç®—çš„å°é—®é¢˜ï¼Œå†ç”¨ç®—æ³•é€ä¸ªè§£å†³ã€‚

ä¸‹æ¬¡é‡åˆ°çŠ¶å‹é¢˜æ—¶ï¼Œä¸å¦¨å…ˆé—®è‡ªå·±ï¼šâ€œèƒ½ä¸èƒ½ç”¨äºŒè¿›åˆ¶è¡¨ç¤ºé›†åˆï¼Ÿæœ‰æ²¡æœ‰åå‘è®¡ç®—çš„å¯èƒ½ï¼Ÿâ€ ç›¸ä¿¡ä½ ä¼šè¶Šæ¥è¶Šç†Ÿç»ƒï¼ğŸ’ª

--- 
**Kayçš„å°æé†’**ï¼šå¦‚æœä»£ç è°ƒè¯•é‡åˆ°é—®é¢˜ï¼Œè¯•è¯•â€œæ‰“å°ä¸­é—´å˜é‡â€ï¼ˆæ¯”å¦‚h(i,S)ã€f(i,S)çš„æ•°å€¼ï¼‰ï¼Œè¿™èƒ½å¸®ä½ å¿«é€Ÿå®šä½é”™è¯¯ï¼

---
å¤„ç†ç”¨æ—¶ï¼š114.43ç§’
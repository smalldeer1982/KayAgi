# é¢˜ç›®ä¿¡æ¯

# Martian Strings

## é¢˜ç›®æè¿°

During the study of the Martians Petya clearly understood that the Martians are absolutely lazy. They like to sleep and don't like to wake up.

Imagine a Martian who has exactly $ n $ eyes located in a row and numbered from the left to the right from $ 1 $ to $ n $ . When a Martian sleeps, he puts a patch on each eye (so that the Martian morning doesn't wake him up). The inner side of each patch has an uppercase Latin letter. So, when a Martian wakes up and opens all his eyes he sees a string $ s $ consisting of uppercase Latin letters. The string's length is $ n $ .

"Ding dong!" â€” the alarm goes off. A Martian has already woken up but he hasn't opened any of his eyes. He feels that today is going to be a hard day, so he wants to open his eyes and see something good. The Martian considers only $ m $ Martian words beautiful. Besides, it is hard for him to open all eyes at once so early in the morning. So he opens two non-overlapping segments of consecutive eyes. More formally, the Martian chooses four numbers $ a $ , $ b $ , $ c $ , $ d $ , ( $ 1<=a<=b&lt;c<=d<=n $ ) and opens all eyes with numbers $ i $ such that $ a<=i<=b $ or $ c<=i<=d $ . After the Martian opens the eyes he needs, he reads all the visible characters from the left to the right and thus, he sees some word.

Let's consider all different words the Martian can see in the morning. Your task is to find out how many beautiful words are among them.

## è¯´æ˜/æç¤º

Let's consider the sample test. There the Martian can get only the second beautiful string if he opens segments of eyes $ a=1,b=2 $ and $ c=4,d=5 $ or of he opens segments of eyes $ a=1,b=2 $ and $ c=6,d=7 $ .

## æ ·ä¾‹ #1

### è¾“å…¥

```
ABCBABA
2
BAAB
ABBA
```

### è¾“å‡º

```
1
```

# AIåˆ†æç»“æœ


### ğŸ’¡ Kayçš„C++ç®—æ³•è§£æï¼šMartian Strings æ·±å…¥å­¦ä¹ æŒ‡å— ğŸ’¡

#### 1. é¢˜ç›®è§£è¯»ä¸æ ¸å¿ƒç®—æ³•è¯†åˆ«
âœ¨ **æœ¬é¢˜ä¸»è¦è€ƒå¯Ÿ**ï¼šå­—ç¬¦ä¸²åŒ¹é…ç®—æ³•ï¼ˆåç¼€æ•°ç»„/KMP/åç¼€è‡ªåŠ¨æœºï¼‰

ğŸ—£ï¸ **åˆæ­¥åˆ†æ**ï¼š
> è§£å†³"Martian Strings"çš„å…³é”®åœ¨äº**é«˜æ•ˆåŒ¹é…å­ä¸²ä½ç½®**å¹¶**éªŒè¯ä¸é‡å æ€§**ã€‚æƒ³è±¡ä½ åœ¨ä¸¤æ®µç‹¬ç«‹è½¨é“ä¸Šæ‹¼å‡‘ç«æ˜Ÿæ–‡ï¼ˆåƒç´ åˆ—è½¦ï¼‰ï¼Œéœ€ç¡®ä¿ä¸¤æ®µè½¨é“ä¸ç›¸äº¤ä¸”æ‹¼æ¥åç­‰äºç›®æ ‡å­—ç¬¦ä¸²ã€‚æ ¸å¿ƒæ­¥éª¤ï¼š
> 1. **æ­£å‘åŒ¹é…**ï¼šæ‰¾åˆ°ç›®æ ‡ä¸²æ¯ä¸ªå‰ç¼€åœ¨ä¸»ä¸²ä¸­çš„**æœ€å·¦å‡ºç°ä½ç½®**
> 2. **åå‘åŒ¹é…**ï¼šæ‰¾åˆ°ç›®æ ‡ä¸²æ¯ä¸ªåç¼€åœ¨ä¸»ä¸²ä¸­çš„**æœ€å³å‡ºç°ä½ç½®**
> 3. **ä½ç½®æ ¡éªŒ**ï¼šæ£€æŸ¥æ˜¯å¦å­˜åœ¨åˆ‡å‰²ç‚¹ä½¿ä¸¤ä¸ªå­ä¸²ä¸é‡å 
>
> å¯è§†åŒ–è®¾è®¡æ€è·¯ï¼š
> - ä¸»ä¸²æ˜¾ç¤ºä¸ºåƒç´ è½¨é“ï¼ˆ8-bité£æ ¼ï¼‰ï¼Œç›®æ ‡ä¸²æ˜¾ç¤ºä¸ºæ‚¬æµ®åƒç´ åˆ—è½¦
> - åŒ¹é…æ—¶é«˜äº®å½“å‰å­—ç¬¦ï¼ŒæˆåŠŸæ—¶æ’­æ”¾"å®"éŸ³æ•ˆå¹¶é—ªçƒè½¨é“ç‰‡æ®µ
> - è‡ªåŠ¨æ¼”ç¤ºæ¨¡å¼åƒ"åƒç´ ç«è½¦è°ƒåº¦"ï¼ŒåŠ¨æ€å±•ç¤ºåŒ¹é…è¿‡ç¨‹ä¸ä½ç½®å…³ç³»

---

#### 2. ç²¾é€‰ä¼˜è´¨é¢˜è§£å‚è€ƒ
**é¢˜è§£ä¸€ï¼ˆSA by chaynflowï¼‰**
* **ç‚¹è¯„**ï¼šæ€è·¯ä¸¥è°¨ï¼Œé€šè¿‡æ­£ååç¼€æ•°ç»„+STè¡¨å®ç°é«˜æ•ˆåŒºé—´æŸ¥è¯¢ã€‚äº®ç‚¹åœ¨äºç”¨äºŒåˆ†ç»´æŠ¤åŒ¹é…åŒºé—´æ”¶ç¼©ï¼Œå¤æ‚åº¦ä¼˜åŒ–è‡³O(n log n + m|p|)ã€‚ä»£ç ä¸­STè¡¨é¢„å¤„ç†ä¸æŸ¥è¯¢é€»è¾‘æ¸…æ™°ï¼Œå˜é‡å‘½åè§„èŒƒï¼ˆå¦‚sa1/sa2åŒºåˆ†æ­£åæ•°ç»„ï¼‰ï¼Œè¾¹ç•Œå¤„ç†å®Œæ•´ï¼Œå¯ç›´æ¥ç”¨äºç«èµ›åœºæ™¯ã€‚

**é¢˜è§£äºŒï¼ˆKMP by MspAIntï¼‰**
* **ç‚¹è¯„**ï¼šå®ç°ç®€æ´é«˜æ•ˆï¼Œé€šè¿‡KMPè®°å½•å‰ç¼€æœ€å·¦ä½ç½®ä¸åç¼€æœ€å³ä½ç½®ã€‚äº®ç‚¹åœ¨äºåŒé‡KMPåŒ¹é…çš„å·§å¦™è®¾è®¡å’Œç©ºé—´ä¼˜åŒ–ï¼ˆO(|p|)å­˜å‚¨ï¼‰ï¼Œä»£ç ä¸­nextæ•°ç»„æ„å»ºæ ‡å‡†ï¼Œä½ç½®è®°å½•é€»è¾‘ç›´ç™½ã€‚ç‰¹åˆ«é€‚åˆåˆå­¦è€…ç†è§£å­—ç¬¦ä¸²åŒ¹é…æœ¬è´¨ï¼Œå®è·µè°ƒè¯•éš¾åº¦ä½ã€‚

**é¢˜è§£ä¸‰ï¼ˆSAM by EM_LGHï¼‰**
* **ç‚¹è¯„**ï¼šè¿ç”¨æ­£ååç¼€è‡ªåŠ¨æœºç»´æŠ¤endposæå€¼ï¼Œç†è®ºæ€§å¼ºã€‚äº®ç‚¹åœ¨äºSAMçŠ¶æ€è½¬ç§»çš„ç›´è§‚æ€§å’Œminv/maxvçš„ç»´æŠ¤é€»è¾‘ï¼Œä»£ç ä¸­èŠ‚ç‚¹è®¾è®¡åˆç†ï¼ˆlen/ch/fï¼‰ï¼Œæ³¨æ˜äº†å…³é”®è°ƒè¯•ç»éªŒï¼š"æ³¨æ„ç©ºä¸²å¤„ç†"ï¼Œå¯¹ç†è§£è‡ªåŠ¨æœºåº”ç”¨æœ‰è¾ƒé«˜ä»·å€¼ã€‚

---

#### 3. æ ¸å¿ƒéš¾ç‚¹è¾¨æä¸è§£é¢˜ç­–ç•¥
1. **éš¾ç‚¹ï¼šé«˜æ•ˆå®šä½å­ä¸²ä½ç½®**
   * **åˆ†æ**ï¼šéœ€å¿«é€Ÿè·å–ç›®æ ‡ä¸²æ‰€æœ‰å‰ç¼€/åç¼€åœ¨ä¸»ä¸²ä¸­çš„æå€¼ä½ç½®ã€‚ä¼˜è´¨è§£æ³•å‡é‡‡ç”¨é¢„å¤„ç†ï¼ˆSA/KMP/SAMï¼‰åŠ é€ŸåŒ¹é…ï¼Œå¦‚é¢˜è§£ä¸€ç”¨STè¡¨O(1)æŸ¥è¯¢æ’ååŒºé—´çš„æœ€å·¦ä½ç½®ã€‚
   * ğŸ’¡ å­¦ä¹ ç¬”è®°ï¼šå­—ç¬¦ä¸²åŒ¹é…ç®—æ³•é€‰æ‹©å–å†³äºæ•°æ®è§„æ¨¡â€”â€”SAé€‚åˆå¤§ä¸»ä¸²ï¼ŒKMPé€‚åˆçŸ­æ¨¡å¼ä¸²ã€‚

2. **éš¾ç‚¹ï¼šéªŒè¯å­ä¸²ä¸é‡å **
   * **åˆ†æ**ï¼šéœ€ç¡®ä¿å‰ç¼€ç»“æŸä½ç½® < åç¼€å¼€å§‹ä½ç½®ã€‚è§£æ³•æ ¸å¿ƒæ˜¯ä½ç½®ä»£æ•°æ ¡éªŒï¼š`å‰ç¼€ç»“æŸä½ç½® + åç¼€é•¿åº¦ < åç¼€å¼€å§‹ä½ç½®`ï¼Œå¦‚é¢˜è§£äºŒç”¨`a[pre_len] < b[suf_len]`å®ç°ã€‚
   * ğŸ’¡ å­¦ä¹ ç¬”è®°ï¼šä½ç½®è®°å½•éœ€è€ƒè™‘å­˜å‚¨æ ¼å¼ï¼ˆæ­£å‘å­˜èµ·ç‚¹/åå‘å­˜ç»ˆç‚¹ï¼‰ã€‚

3. **éš¾ç‚¹ï¼šå¤šè§£æ³•è¾¹ç•Œå¤„ç†**
   * **åˆ†æ**ï¼šç©ºä¸²ã€å•å­—ç¬¦ã€å…¨åŒ¹é…ç­‰ç‰¹æ®Šæƒ…å†µéœ€å¤„ç†ã€‚é¢˜è§£ä¸‰å¼ºè°ƒå•å­—ç¬¦ç›´æ¥è·³è¿‡ï¼Œé¢˜è§£ä¸€åœ¨STè¡¨æŸ¥è¯¢æ—¶åˆ¤æ–­åŒºé—´æœ‰æ•ˆæ€§ã€‚
   * ğŸ’¡ å­¦ä¹ ç¬”è®°ï¼šè¾¹ç•Œæµ‹è¯•ç”¨ä¾‹æ˜¯DEBUGå…³é”®â€”â€”è‡³å°‘åŒ…å«ç©ºä¸²ã€å•å­—ç¬¦ã€æœ€å¤§å°ºå¯¸è¾“å…¥ã€‚

### âœ¨ è§£é¢˜æŠ€å·§æ€»ç»“
- **åŒæŒ‡é’ˆç»´æŠ¤åŒ¹é…åŒºé—´**ï¼ˆSAè§£æ³•ï¼‰ï¼šéšç€åŒ¹é…é•¿åº¦å¢åŠ ï¼Œåˆæ³•åç¼€åŒºé—´å•è°ƒæ”¶ç¼©
- **æ­£ååŒè§†è§’å¤„ç†**ï¼šç¿»è½¬å­—ç¬¦ä¸²å°†åç¼€åŒ¹é…è½¬åŒ–ä¸ºå‰ç¼€åŒ¹é…
- **æå€¼è®°å½•æ›¿ä»£å…¨å­˜å‚¨**ï¼šä»…è®°å½•æœ€å·¦/æœ€å³ä½ç½®é¿å…è¶…å†…å­˜
- **æ¨¡å—åŒ–åŒ¹é…å‡½æ•°**ï¼šKMPè§£æ³•å°è£…get_next()æå‡ä»£ç å¤ç”¨æ€§

---

#### 4. C++æ ¸å¿ƒä»£ç å®ç°èµæ
**é€šç”¨æ ¸å¿ƒå®ç°å‚è€ƒ**ï¼ˆç»¼åˆKMPæ€è·¯ä¼˜åŒ–ï¼‰ï¼š
```cpp
#include <bits/stdc++.h>
using namespace std;
const int N = 1e5+5, M = 1005;

char s[N], p[M], rev_s[N], rev_p[M];
int n, m, q, ans, pre[M], suf[M], nxt[M];

void get_next(char *t, int len, int *nxt) {
    nxt[0] = -1;
    int j = -1;
    for (int i = 1; i < len; ++i) {
        while (j >= 0 && t[i] != t[j+1]) j = nxt[j];
        if (t[i] == t[j+1]) j++;
        nxt[i] = j;
    }
}

void kmp_match(char *s, int n, char *p, int len, int *res, bool is_rev) {
    int j = -1;
    for (int i = 0; i < n; ++i) {
        while (j >= 0 && s[i] != p[j+1]) j = nxt[j];
        if (s[i] == p[j+1]) j++;
        if (j >= 0 && res[j] == -1) // é¦–æ¬¡åˆ°è¾¾è¯¥åŒ¹é…é•¿åº¦
            res[j] = is_rev ? (n - 1 - i) : (i - j);
        if (j == len - 1) j = nxt[j]; // é˜²æ­¢è¶Šç•Œ
    }
}

int main() {
    scanf("%s%d", s, &q);
    n = strlen(s);
    strcpy(rev_s, s);
    reverse(rev_s, rev_s + n); // åè½¬ä¸»ä¸²

    while (q--) {
        scanf("%s", p);
        int len = strlen(p);
        if (len <= 1) continue;

        memset(pre, -1, sizeof pre);
        memset(suf, -1, sizeof suf);
        
        // æ­£å‘åŒ¹é…å‰ç¼€
        get_next(p, len, nxt);
        kmp_match(s, n, p, len, pre, false);
        
        // åå‘åŒ¹é…åç¼€
        strcpy(rev_p, p);
        reverse(rev_p, rev_p + len);
        get_next(rev_p, len, nxt);
        kmp_match(rev_s, n, rev_p, len, suf, true);

        bool found = false;
        for (int i = 0; i < len-1; ++i) {
            if (pre[i] != -1 && suf[len-i-2] != -1 && 
                pre[i] + i < n - 1 - suf[len-i-2]) {
                found = true; break;
            }
        }
        ans += found;
    }
    printf("%d", ans);
}
```

**ä»£ç è§£è¯»æ¦‚è¦**ï¼š
1. **åŒKMPåŒ¹é…**ï¼šæ­£åä¸¤æ¬¡KMPåˆ†åˆ«è®°å½•å‰ç¼€/åç¼€ä½ç½®
2. **ä½ç½®å­˜å‚¨**ï¼š`pre[i]`å­˜å‰ç¼€ç»“æŸä½ç½®ï¼Œ`suf[j]`å­˜åç¼€èµ·å§‹ä½ç½®ï¼ˆåè½¬åï¼‰
3. **æ ¡éªŒé€»è¾‘**ï¼šé€šè¿‡ä½ç½®å·®éªŒè¯ä¸é‡å  `pre[i]+i < n-1-suf[len-i-2]`

**é¢˜è§£ä¸€ï¼ˆSAï¼‰æ ¸å¿ƒç‰‡æ®µèµæ**ï¼š
```cpp
// åç¼€æ•°ç»„åŒºé—´æŸ¥è¯¢ï¼ˆSTè¡¨ä¼˜åŒ–ï¼‰
int query(int st[][22], int l, int r) {
    int k = log2(r - l + 1);
    return min(st[l][k], st[r - (1<<k) + 1][k]);
}

// å…³é”®æ ¡éªŒé€»è¾‘
if (ans[i] != -1 && _ans[len - i] != -1 && 
    n - ans[i] - _ans[len - i] + 2 >= len) 
    valid = true;
```
ğŸ’¡ å­¦ä¹ ç¬”è®°ï¼šSAé€šè¿‡æ’åè¿ç»­æ€§å®ç°é«˜æ•ˆåŒºé—´æå€¼æŸ¥è¯¢

---

#### 5. ç®—æ³•å¯è§†åŒ–ï¼šåƒç´ åŠ¨ç”»æ¼”ç¤º
**ä¸»é¢˜**ï¼šåƒç´ ç«è½¦è½¨é“è°ƒåº¦ç³»ç»Ÿ  
**æ ¸å¿ƒæ¼”ç¤º**ï¼šKMPåŒ¹é…è¿‡ç¨‹ä¸ä½ç½®æ ¡éªŒï¼ˆ8-bitå¤å¤é£æ ¼ï¼‰

```mermaid
graph LR
    A[ä¸»ä¸²è½¨é“] --> B[ç›®æ ‡ç«è½¦]
    B --> C{åŒ¹é…å¼•æ“}
    C -->|æ­£å‘åŒ¹é…| D[å‰ç¼€è½¦å¢å®šä½]
    C -->|åå‘åŒ¹é…| E[åç¼€è½¦å¢å®šä½]
    D --> F[è½¨é“é«˜äº®]
    E --> G[è½¨é“é«˜äº®]
    F --> H{ä½ç½®æ ¡éªŒ}
    G --> H
    H -->|æˆåŠŸ| I[æ’­æ”¾èƒœåˆ©éŸ³æ•ˆ]
    H -->|å¤±è´¥| J[æ’­æ”¾é”™è¯¯éŸ³æ•ˆ]
```

**äº¤äº’æ§åˆ¶**ï¼š
- **è½¨é“è®¾è®¡**ï¼šä¸»ä¸²æ˜¾ç¤ºä¸ºåƒç´ æ–¹æ ¼è½¨é“ï¼ˆæ¯ä¸ªå­—ç¬¦1æ ¼ï¼‰ï¼Œç›®æ ‡ä¸²æ˜¾ç¤ºä¸ºæ‚¬æµ®åƒç´ ç«è½¦
- **åŒ¹é…åŠ¨ç”»**ï¼š
  - KMPåŒ¹é…æ—¶å½“å‰å­—ç¬¦é—ªçƒé»„å…‰
  - æˆåŠŸåŒ¹é…å‰ç¼€/åç¼€æ—¶å¯¹åº”è½¨é“æ®µå˜ç»¿å¹¶æ’­æ”¾"å®"å£°
- **æ ¡éªŒé˜¶æ®µ**ï¼š
  - ç”¨çº¢è‰²å…‰æŸ±æ ‡è®°å‰ç¼€ç»“æŸä½ç½®
  - ç”¨è“è‰²å…‰æŸ±æ ‡è®°åç¼€å¼€å§‹ä½ç½®
  - ä½ç½®é‡å æ—¶æ˜¾ç¤ºç¢°æ’çˆ†ç‚¸ç‰¹æ•ˆ
- **æ¸¸æˆåŒ–å…ƒç´ **ï¼š
  - æ¯æˆåŠŸåŒ¹é…ä¸€ä¸ªä¸²è·å¾—"ç«æ˜Ÿå‹‹ç« "
  - è¿ç»­æ­£ç¡®è§¦å‘è¿å‡»ç‰¹æ•ˆ
  - èƒŒæ™¯éŸ³ä¹ï¼š8-bité£æ ¼ã€Šç«æ˜Ÿè¿›è¡Œæ›²ã€‹

---

#### 6. æ‹“å±•ç»ƒä¹ ä¸ç›¸ä¼¼é—®é¢˜æ€è€ƒ
1. **æ´›è°·P3375**ã€æ¨¡æ¿ã€‘KMPå­—ç¬¦ä¸²åŒ¹é…  
   â†’ æŒæ¡nextæ•°ç»„æ„å»ºä¸åŸºç¡€åŒ¹é…
   
2. **æ´›è°·P3804**ã€æ¨¡æ¿ã€‘åç¼€è‡ªåŠ¨æœº  
   â†’ ç†è§£SAMç»“æ„ä¸endposç»´æŠ¤
   
3. **æ´›è°·P4051**å­—ç¬¦åŠ å¯†  
   â†’ ç»ƒä¹ åç¼€æ•°ç»„çš„å¾ªç¯å¤„ç†

---

#### 7. å­¦ä¹ å¿ƒå¾—ä¸ç»éªŒåˆ†äº«
> **chaynflowçš„è°ƒè¯•ç»éªŒ**ï¼š  
> *"åœ¨SAè§£æ³•ä¸­ï¼ŒåŒºé—´äºŒåˆ†æ—¶éœ€æ³¨æ„å­—ç¬¦è¶Šç•Œæ£€æŸ¥`sa[mid]+i-1<=n`ï¼Œå¦åˆ™ä¼šå¼•å…¥å¹½çµé”™è¯¯"*  
> **Kayæ€»ç»“**ï¼šå­—ç¬¦ä¸²åŒ¹é…ä¸­ä½ç½®åç§»æ˜¯å¸¸è§é”™è¯¯æºï¼Œå»ºè®®ï¼š
> 1. åœ¨è®¿é—®`sa[i]+k`å‰å§‹ç»ˆæ£€æŸ¥ä¸‹æ ‡
> 2. ç”¨`if (pos < n) `ä»£æ›¿`if (pos)`æ›´å®‰å…¨
> 3. è¾¹ç•Œæµ‹è¯•åŠ å…¥å…¨ç›¸åŒå­—ç¬¦ï¼ˆå¦‚"AAAAA"ï¼‰çš„æç«¯æƒ…å†µ

---
å¤„ç†ç”¨æ—¶ï¼š131.78ç§’
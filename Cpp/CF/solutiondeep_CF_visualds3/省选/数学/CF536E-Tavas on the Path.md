# é¢˜ç›®ä¿¡æ¯

# Tavas on the Path

## é¢˜ç›®æè¿°

Tavas lives in Tavaspolis. Tavaspolis has $ n $ cities numbered from $ 1 $ to $ n $ connected by $ n-1 $ bidirectional roads. There exists a path between any two cities. Also each road has a length.

 ![](https://cdn.luogu.com.cn/upload/vjudge_pic/CF536E/d3484f8e760e70be37b15d454f75fce51db0bf40.png)Tavas' favorite strings are binary strings (they contain only 0 and 1). For any binary string like $ s=s_{1}s_{2}...\ s_{k} $ , $ T(s) $ is its $ Goodness $ . $ T(s) $ can be calculated as follows:

Consider there are exactly $ m $ blocks of $ 1 $ s in this string (a block of $ 1 $ s in $ s $ is a maximal consecutive substring of $ s $ that only contains $ 1 $ ) with lengths $ x_{1},x_{2},...,x_{m} $ .

Define ![](https://cdn.luogu.com.cn/upload/vjudge_pic/CF536E/355506c834e033a7323a71320e8c5f755ccad647.png) where $ f $ is a given sequence (if $ m=0 $ , then $ T(s)=0 $ ).

Tavas loves queries. He asks you to answer $ q $ queries. In each query he gives you numbers $ v,u,l $ and you should print following number:

Consider the roads on the path from city $ v $ to city $ u $ : $ e_{1},e_{2},...,e_{x} $ .

Build the binary string $ b $ of length $ x $ such that: $ b_{i}=1 $ if and only if $ l<=w(e_{i}) $ where $ w(e) $ is the length of road $ e $ .

You should print $ T(b) $ for this query.

## æ ·ä¾‹ #1

### è¾“å…¥

```
2 3
10
1 2 3
1 2 2
1 2 3
1 2 4
```

### è¾“å‡º

```
10
10
0
```

## æ ·ä¾‹ #2

### è¾“å…¥

```
6 6
-5 0 0 2 10
1 2 1
2 3 2
3 4 5
4 5 1
5 6 5
1 6 1
1 6 2
1 6 5
3 6 5
4 6 4
1 4 2
```

### è¾“å‡º

```
10
-5
-10
-10
-5
0
```

# AIåˆ†æç»“æœ


# ğŸ’¡ Kayçš„C++ç®—æ³•è§£æï¼šTavas on the Path æ·±å…¥å­¦ä¹ æŒ‡å— ğŸ’¡

**å¼•è¨€**  
ä»Šå¤©æˆ‘ä»¬æ¥åˆ†æ"Tavas on the Path"è¿™é“æ ‘å½¢ç»“æ„ç›¸å…³çš„C++ç¼–ç¨‹é¢˜ã€‚é¢˜ç›®è¦æ±‚å¤„ç†æ ‘ä¸Šè·¯å¾„æŸ¥è¯¢ï¼Œæ ¹æ®é˜ˆå€¼ç”Ÿæˆ01ä¸²å¹¶è®¡ç®—è¿ç»­1æ®µçš„ä»·å€¼ã€‚æœ¬æŒ‡å—å°†å¸®åŠ©å¤§å®¶æŒæ¡æ ‘é“¾å‰–åˆ†ã€ç¦»çº¿å¤„ç†å’Œçº¿æ®µæ ‘ç»´æŠ¤è¿ç»­æ®µçš„æŠ€å·§ã€‚

## 1. é¢˜ç›®è§£è¯»ä¸æ ¸å¿ƒç®—æ³•è¯†åˆ«

âœ¨ **æœ¬é¢˜ä¸»è¦è€ƒå¯Ÿ**ï¼š`æ ‘é“¾å‰–åˆ† + ç¦»çº¿å¤„ç† + çº¿æ®µæ ‘ç»´æŠ¤è¿ç»­æ®µ`

ğŸ—£ï¸ **åˆæ­¥åˆ†æ**ï¼š  
> è§£å†³æœ¬é¢˜çš„å…³é”®åœ¨äºç†è§£**æ ‘é“¾å‰–åˆ†+ç¦»çº¿å¤„ç†+çº¿æ®µæ ‘ç»´æŠ¤è¿ç»­æ®µ**çš„ç»„åˆæŠ€å·§ã€‚å°±åƒåœ¨è¿·å®«ä¸­åˆ†æ®µç»˜åˆ¶åœ°å›¾ï¼š  
> 1. å°†æ ‘æ‹†è§£ä¸ºé“¾ï¼ˆæ ‘å‰–ï¼‰  
> 2. æŒ‰é˜ˆå€¼æ’åºæŸ¥è¯¢å’Œè¾¹æƒï¼ˆç¦»çº¿æ‰«æï¼‰  
> 3. ç”¨çº¿æ®µæ ‘åŠ¨æ€ç»´æŠ¤è¿ç»­1æ®µï¼ˆåƒç´ æ‹¼å›¾ï¼‰  
>
> **æ ¸å¿ƒæµç¨‹**ï¼š  
> - è¾¹æƒä¸‹æ”¾ä¸ºç‚¹æƒï¼ˆæ·±åº¦å¤§çš„ç‚¹æ‰¿è½½è¾¹æƒï¼‰  
> - çº¿æ®µæ ‘ç»´æŠ¤ï¼šå‰ç¼€1é•¿åº¦ã€åç¼€1é•¿åº¦ã€è¿ç»­æ®µä»·å€¼  
> - åˆå¹¶æ—¶å¤„ç†ä¸­é—´æ‹¼æ¥ï¼ˆ`f[left_suf + right_pre]`ï¼‰  
>
> **å¯è§†åŒ–è®¾è®¡**ï¼š  
> é‡‡ç”¨8ä½åƒç´ é£æ ¼ï¼Œæ ‘æ˜¾ç¤ºä¸ºç½‘æ ¼åœ°å›¾ï¼Œè¾¹æ¿€æ´»æ—¶å˜ç»¿è‰²æ–¹å—ã€‚æŸ¥è¯¢æ—¶ï¼š  
> 1. è·¯å¾„é«˜äº®é»„è‰²æµåŠ¨å…‰æ•ˆ  
> 2. è¿ç»­1æ®µæ˜¾ç¤ºä¸ºåŒè‰²è¾¹æ¡†åŒºåŸŸ  
> 3. æ ‘å‰–è·³é“¾æ—¶å½“å‰é“¾é—ªçƒè“å…‰  
> 4. éŸ³æ•ˆï¼šæ¿€æ´»è¾¹"å®"ï¼Œåˆå¹¶æ®µ"å’”åš“"ï¼Œå®Œæˆæ—¶èƒœåˆ©éŸ³æ•ˆ

---

## 2. ç²¾é€‰ä¼˜è´¨é¢˜è§£å‚è€ƒ

### é¢˜è§£ä¸€ï¼ˆæ¥æºï¼šxiezheyuanï¼‰
* **ç‚¹è¯„**ï¼š  
  æ€è·¯æ¸…æ™°å®Œæ•´ï¼Œè¯¦ç»†è§£é‡Šæ ‘å‰–å’Œçº¿æ®µæ ‘ç»´æŠ¤çš„ç»†èŠ‚ã€‚äº®ç‚¹åœ¨äºï¼š  
  - æä¾›æ•°æ®ç”Ÿæˆå™¨æ–¹ä¾¿å¯¹æ‹è°ƒè¯•
  - å®Œæ•´å¤„ç†æ ‘å‰–çš„æ–¹å‘é—®é¢˜ï¼ˆç¿»è½¬åˆå¹¶ï¼‰
  - ä»£ç è§„èŒƒï¼šå˜é‡å`lmx/rmx`å«ä¹‰æ˜ç¡®ï¼Œè¾¹ç•Œå¤„ç†ä¸¥è°¨
  - è°ƒè¯•ç»éªŒå®è´µï¼ˆæäº¤è®°å½•å±•ç¤ºè°ƒè¯•è¿‡ç¨‹ï¼‰

### é¢˜è§£äºŒï¼ˆæ¥æºï¼šEibonï¼‰
* **ç‚¹è¯„**ï¼š  
  å°è¯•ç”¨å€å¢ç»´æŠ¤æœ€å¤§æœ€å°å€¼ï¼Œåˆ›æ–°ä½†ä¸å¤Ÿä¼˜åŒ–ï¼š  
  - éšæœºæ•°æ®å¿«ä½†æœ€åæƒ…å†µO(nÂ²logn)
  - ä»£ç å¯è¯»æ€§è¾ƒå¥½ä½†ç¼ºä¹è°ƒè¯•ç»†èŠ‚
  - å®è·µä»·å€¼ï¼šå¯å‘æ€è€ƒä¸åŒè§£æ³•ä¼˜åŠ£

### é¢˜è§£ä¸‰ï¼ˆæ¥æºï¼šAlex_Eonï¼‰
* **ç‚¹è¯„**ï¼š  
  åšå®¢è®²è§£è¯¦ç»†ï¼Œæ ‘å‰–å®ç°æ³¨æ„ç»†èŠ‚ï¼š  
  - æ˜ç¡®è¾¹æƒä¸‹æ”¾è§„åˆ™
  - å¼ºè°ƒæ ‘å‰–æ˜“é”™ç‚¹ï¼ˆå­æ ‘å¤§å°ç»´æŠ¤ï¼‰
  - ä»£ç æ³¨é‡Šå……åˆ†ä½†åˆå¹¶é€»è¾‘å¯ä¼˜åŒ–
  - å®è·µå‚è€ƒä»·å€¼é«˜ï¼ˆç«èµ›å‘ï¼‰

---

## 3. æ ¸å¿ƒéš¾ç‚¹è¾¨æä¸è§£é¢˜ç­–ç•¥

1. **éš¾ç‚¹ï¼šè·¯å¾„æ–¹å‘å¤„ç†**  
   *åˆ†æ*ï¼šuâ†’lcaå’Œvâ†’lcaæ–¹å‘ç›¸åï¼Œéœ€åˆ†åˆ«ç»´æŠ¤å¹¶ç¿»è½¬åˆå¹¶  
   *è§£å†³*ï¼šæ ‘å‰–æ—¶ç”¨ä¸¤ä¸ªä¸´æ—¶å˜é‡ans1/ans2å­˜å‚¨ï¼Œäº¤æ¢æ—¶åŒæ­¥swapå˜é‡

2. **éš¾ç‚¹ï¼šè¿ç»­æ®µåˆå¹¶é€»è¾‘**  
   *åˆ†æ*ï¼šçº¿æ®µæ ‘åˆå¹¶æ—¶éœ€å¤„ç†ä¸­é—´æ‹¼æ¥çš„è¿ç»­1æ®µ  
   *è§£å†³*ï¼š  
   ```c++
   new_val = left.val + right.val 
            - f[left.suf] - f[right.pre] 
            + f[left.suf + right.pre];
   ```

3. **éš¾ç‚¹ï¼šç¦»çº¿å¤„ç†æ—¶æœº**  
   *åˆ†æ*ï¼šè¾¹æƒæ¿€æ´»éœ€åœ¨æŸ¥è¯¢å‰å®Œæˆ  
   *è§£å†³*ï¼šåŒæŒ‡é’ˆæ‰«æï¼Œè¾¹æŒ‰æƒå€¼é™åºï¼ŒæŸ¥è¯¢æŒ‰é˜ˆå€¼é™åºå¤„ç†

ğŸ’¡ **è§£é¢˜æŠ€å·§æ€»ç»“**  
- **é—®é¢˜åˆ†è§£**ï¼šè¾¹æƒâ†’ç‚¹æƒâ†’é“¾æŸ¥è¯¢â†’åŒºé—´åˆå¹¶  
- **æ¨¡å—åŒ–**ï¼šåˆ†ç¦»æ ‘å‰–ã€çº¿æ®µæ ‘ã€ç¦»çº¿å¤„ç†æ¨¡å—  
- **è¾¹ç•Œæµ‹è¯•**ï¼šå•èŠ‚ç‚¹è·¯å¾„ã€LCAç‰¹æ®Šå¤„ç†  
- **å¯¹æ‹éªŒè¯**ï¼šç”Ÿæˆéšæœºæ ‘æµ‹è¯•è¾¹ç•Œæƒ…å†µ

---

## 4. C++æ ¸å¿ƒä»£ç å®ç°èµæ

### é€šç”¨æ ¸å¿ƒå®ç°ï¼ˆç»¼åˆä¼˜è´¨é¢˜è§£ï¼‰
```cpp
#include <bits/stdc++.h>
using namespace std;

const int N=1e5+5;
int n,m,f[N],dfn[N],top[N],son[N],siz[N],fa[N],dep[N],cnt;

struct SegTree {
    struct Node {
        int pre,suf,val,len; // å‰ç¼€1é•¿ï¼Œåç¼€1é•¿ï¼Œä»·å€¼ï¼Œé•¿åº¦
        Node operator+(const Node& r) const {
            int mid_val = f[suf + r.pre];
            return {
                pre + (pre==len ? r.pre : 0),
                r.suf + (r.suf==r.len ? suf : 0),
                val + r.val - f[suf] - f[r.pre] + mid_val,
                len + r.len
            };
        }
    } tr[N<<2];
    
    void build(int u,int l,int r) { /* åˆå§‹åŒ– */ }
    void update(int u,int l,int r,int p) { /* æ¿€æ´»ç‚¹p */ }
    Node query(int u,int l,int r,int L,int R) { /* åŒºé—´æŸ¥è¯¢ */ }
} ST;

// æ ‘é“¾å‰–åˆ†éƒ¨åˆ†
void dfs1(int u,int par) { /* æ±‚å­æ ‘å¤§å°/é‡å„¿å­ */ }
void dfs2(int u,int tp) { /* æ±‚DFSåº/é‡é“¾é¡¶ */ }

Node query_path(int u,int v) {
    Node lres={0,0,0,0}, rres={0,0,0,0};
    while(top[u]!=top[v]) {
        if(dep[top[u]] < dep[top[v]]) {
            auto tmp = ST.query(dfn[top[v]], dfn[v]);
            rres = tmp + rres; // æ–¹å‘å¤„ç†
            v = fa[top[v]];
        } else {
            auto tmp = ST.query(dfn[top[u]], dfn[u]);
            swap(tmp.pre, tmp.suf); // å…³é”®ç¿»è½¬ï¼
            lres = tmp + lres;
            u = fa[top[u]];
        }
    }
    // åˆå¹¶ä¸¤æ¡é“¾ç»“æœ
    return lres + rres; 
}

int main() {
    // ç¦»çº¿å¤„ç†
    sort(edges, edges+n-1, [](auto a,auto b){return a.w>b.w;});
    sort(queries, queries+m, [](auto a,auto b){return a.l>b.l;});
    
    int j=0;
    for(int i=0; i<m; ++i) {
        while(j<n-1 && edges[j].w>=queries[i].l) {
            ST.update(edges[j].pos); // æ¿€æ´»è¾¹
            j++;
        }
        ans[queries[i].id] = query_path(queries[i].u, queries[i].v).val;
    }
}
```

### é¢˜è§£ä¸€ï¼ˆxiezheyuanï¼‰ç‰‡æ®µèµæ
```cpp
node merge(node x, node y) {
    if(x.nsol) return y;
    if(y.nsol) return x;
    node ret;
    ret.pre = (x.pre == x.len) ? (x.pre + y.pre) : x.pre;
    ret.suf = (y.suf == y.len) ? (x.suf + y.suf) : y.suf;
    ret.val = x.val + y.val - f[x.suf] - f[y.pre] + f[x.suf+y.pre];
    ret.len = x.len + y.len;
    return ret;
}
```
* **äº®ç‚¹**ï¼šç”¨`nsol`æ ‡è®°ç©ºçŠ¶æ€ï¼Œé¿å…ç‰¹æ®Šå€¼å¹²æ‰°  
* **ä»£ç è§£è¯»**ï¼š  
  - `pre/suf`å¤„ç†å…¨1æ®µçš„æ‰©å±•  
  - åˆå¹¶æ—¶å‡å»åŸåˆ†æ®µå€¼ï¼ŒåŠ ä¸Šæ–°è¿ç»­å€¼  
* ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šç©ºçŠ¶æ€æ ‡è®°æ³•æå‡åˆå¹¶å®‰å…¨æ€§

---

## 5. ç®—æ³•å¯è§†åŒ–ï¼šåƒç´ åŠ¨ç”»æ¼”ç¤º

### åƒç´ æ¢é™©å®¶ï¼šè·¯å¾„è¿ç»­æ®µæœç´¢ä¹‹æ—…
**è®¾è®¡æ€è·¯**ï¼šå¤å¤RPGé£æ ¼ï¼Œç®—æ³•æ­¥éª¤æ˜ å°„ä¸ºå…³å¡æŒ‘æˆ˜

| æ­¥éª¤ | è§†è§‰è¡¨ç° | äº¤äº’é€»è¾‘ |
|------|----------|----------|
| **1. æ ‘åˆå§‹åŒ–** | 8ä½åƒç´ æ ‘ï¼ˆæ£•è‰²èŠ‚ç‚¹ï¼Œç°è‰²è¾¹ï¼‰| æŒ‰ä»»æ„é”®å¼€å§‹ |
| **2. æ¿€æ´»è¾¹** | æ»¡è¶³`wâ‰¥l`çš„è¾¹å˜ç»¿æ–¹å— | "å®"å£°æ•ˆï¼Œæ–¹å—é—ªçƒ |
| **3. è·¯å¾„æŸ¥è¯¢** | è·¯å¾„é»„å…‰æµåŠ¨ï¼ŒLCAçº¢å¿ƒæ ‡è®° | æ–¹å‘é”®æ§åˆ¶è§‚å¯Ÿè§†è§’ |
| **4. è¿ç»­æ®µåˆå¹¶** | åŒè‰²è¾¹æ¡†åŒ…è£¹è¿ç»­æ®µ | åˆå¹¶æ—¶"å’”åš“"å£°æ•ˆ+é—ªå…‰ |
| **5. ç»“æœå±•ç¤º** | æ˜¾ç¤ºåˆ†æ®µé•¿åº¦å’Œfå€¼è®¡ç®—å¼ | èƒœåˆ©éŸ³æ•ˆ+çƒŸèŠ±åŠ¨ç”» |

**å…³é”®å¸§ç¤ºæ„å›¾**ï¼š
```
[1]-[2]~~[3]  => åˆ†æ®µï¼š1-2(é•¿=2) â†’ f[2]
 æ¿€æ´»ï¼š~~ (w=5â‰¥l=3)
```

**æŠ€æœ¯å®ç°**ï¼š  
- Canvasç»˜åˆ¶æ ‘ç½‘æ ¼ï¼Œè¾¹çŠ¶æ€ç”¨`isActive`å¸ƒå°”æ•°ç»„  
- è·¯å¾„é«˜äº®ï¼šrequestAnimationFrameåŠ¨ç”»å¾ªç¯  
- éŸ³æ•ˆï¼šWeb Audio APIæ’­æ”¾8ä½éŸ³æ•ˆæ ·æœ¬

---

## 6. æ‹“å±•ç»ƒä¹ ä¸ç›¸ä¼¼é—®é¢˜

### é€šç”¨å¥—è·¯è¿ç§»
è¿ç»­æ®µç»Ÿè®¡æŠ€å·§é€‚ç”¨äºï¼š
1. æ ‘/æ•°ç»„ä¸Šçš„é¢œè‰²æ®µç»Ÿè®¡ï¼ˆå¦‚æŸ“è‰²é—®é¢˜ï¼‰
2. å¸¦é˜ˆå€¼è¿‡æ»¤çš„è·¯å¾„ç»Ÿè®¡
3. ç¦»çº¿æ‰«æçº¿å¤„ç†åŠ¨æ€é—®é¢˜

### æ¨èç»ƒä¹ ï¼ˆæ´›è°·ï¼‰
1. **P2486 [SDOI2011]æŸ“è‰²**  
   â†’ å·©å›ºæ ‘ä¸Šè¿ç»­æ®µç»Ÿè®¡ï¼Œæå‡è¾¹ç•Œå¤„ç†èƒ½åŠ›
2. **P3313 [SDOI2014]æ—…è¡Œ**  
   â†’ ç»ƒä¹ æ ‘å‰–+åŠ¨æ€å¼€ç‚¹çº¿æ®µæ ‘
3. **P2146 [NOI2015]è½¯ä»¶åŒ…ç®¡ç†å™¨**  
   â†’ æŒæ¡æ ‘å‰–è¾¹ç•Œå¤„ç†æŠ€å·§

---

## 7. å­¦ä¹ å¿ƒå¾—ä¸ç»éªŒåˆ†äº«

> **å‚è€ƒç»éªŒ**ï¼ˆxiezheyuanï¼‰ï¼š  
> "è°ƒè¯•æ—¶åœ¨æ–¹å‘å¤„ç†å¡äº†å¾ˆä¹…ï¼Œåæ¥é€šè¿‡æ‰“å°æ ‘å‰–é“¾çš„pre/sufå€¼å‘ç°ç¿»è½¬é€»è¾‘é”™è¯¯"

> **ç‚¹è¯„**ï¼š  
> æ ‘å‰–æ–¹å‘å¤„ç†æ˜¯æœ¬é¢˜æœ€å¤§é™·é˜±ï¼Œå»ºè®®ï¼š  
> 1. å°æ•°æ®é›†æ‰‹åŠ¨æ¨¡æ‹Ÿ  
> 2. è¾“å‡ºä¸­é—´çŠ¶æ€éªŒè¯  
> 3. å°è£…ç¿»è½¬å‡½æ•°é¿å…é‡å¤å‡ºé”™

---

**ç»“è¯­**  
é€šè¿‡æœ¬é¢˜æˆ‘ä»¬æŒæ¡äº†æ ‘å‰–å¤„ç†è·¯å¾„é—®é¢˜çš„æ ¸å¿ƒå¥—è·¯ï¼šç¦»çº¿æ’åº+çº¿æ®µæ ‘ç»´æŠ¤è¿ç»­æ®µ+æ–¹å‘å¤„ç†æŠ€å·§ã€‚è®°ä½ï¼Œç®—æ³•å­¦ä¹ å°±åƒæ­ç§¯æœ¨â€”â€”ç†è§£åŸºç¡€æ¨¡å—ï¼Œæ‰èƒ½æ„å»ºå¤æ‚è§£å†³æ–¹æ¡ˆï¼ä¸‹æ¬¡æŒ‘æˆ˜å†è§ï¼ğŸ’ª

---
å¤„ç†ç”¨æ—¶ï¼š128.03ç§’
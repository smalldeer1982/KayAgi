# é¢˜ç›®ä¿¡æ¯

# Iris's Full Binary Tree

## é¢˜ç›®æè¿°

Iris likes full binary trees.

Let's define the depth of a rooted tree as the maximum number of vertices on the simple paths from some vertex to the root. A full binary tree of depth $ d $ is a binary tree of depth $ d $ with exactly $ 2^d - 1 $ vertices.

Iris calls a tree a  $ d $ -binary tree if some vertices and edges can be added to it to make it a full binary tree of depth $ d $ . Note that any vertex can be chosen as the root of a full binary tree.

Since performing operations on large trees is difficult, she defines the binary depth of a tree as the minimum $ d $ satisfying that the tree is $ d $ -binary. Specifically, if there is no integer $ d \ge 1 $ such that the tree is $ d $ -binary, the binary depth of the tree is $ -1 $ .

Iris now has a tree consisting of only vertex $ 1 $ . She wants to add $ n - 1 $ more vertices to form a larger tree. She will add the vertices one by one. When she adds vertex $ i $ ( $ 2 \leq i \leq n $ ), she'll give you an integer $ p_i $ ( $ 1 \leq p_i < i $ ), and add a new edge connecting vertices $ i $ and $ p_i $ .

Iris wants to ask you the binary depth of the tree formed by the first $ i $ vertices for each $ 1 \le i \le n $ . Can you tell her the answer?

## è¯´æ˜/æç¤º

In the first test case, the final tree is shown below:

 ![](https://cdn.luogu.com.cn/upload/vjudge_pic/CF2006E/7f900739a2145e9bd80715ede4260b35ba51b9fd.png)- The tree consisting of the vertex $ 1 $ has the binary depth $ 1 $ (the tree itself is a full binary tree of depth $ 1 $ ).
- The tree consisting of the vertices $ 1 $ and $ 2 $ has the binary depth $ 2 $ (we can add the vertex $ 3 $ to make it a full binary tree of depth $ 2 $ ).
- The tree consisting of the vertices $ 1 $ , $ 2 $ and $ 3 $ has the binary depth $ 2 $ (the tree itself is a full binary tree of depth $ 2 $ ).

In the second test case, the formed full binary tree after adding some vertices to the tree consisting of $ n $ vertices is shown below (bolded vertices are added):

 ![](https://cdn.luogu.com.cn/upload/vjudge_pic/CF2006E/90faca99e1781d73f69b5b60a32aa2a2da38a68c.png)The depth of the formed full binary tree is $ 4 $ .

In the fifth test case, the final tree is shown below:

 ![](https://cdn.luogu.com.cn/upload/vjudge_pic/CF2006E/2c0d039efae462812828b42368688f46ffc8b41e.png)It can be proved that Iris can't form any full binary tree by adding vertices and edges, so the binary depth is $ -1 $ .

## æ ·ä¾‹ #1

### è¾“å…¥

```
7
3
1 1
6
1 2 3 4 5
7
1 1 3 2 5 1
10
1 1 2 1 4 2 4 5 8
10
1 1 3 1 3 2 2 2 6
20
1 1 2 2 4 4 5 5 7 6 8 6 11 14 11 8 13 13 12
25
1 1 3 3 1 5 4 4 6 8 11 12 8 7 11 13 7 13 15 6 19 14 10 23```

### è¾“å‡º

```
1 2 2 
1 2 2 3 3 4 
1 2 2 3 3 4 4 
1 2 2 3 3 3 4 4 5 5 
1 2 2 3 3 4 4 4 -1 -1 
1 2 2 3 3 4 4 4 4 5 5 5 5 6 6 6 6 6 6 7 
1 2 2 3 3 4 4 4 4 5 5 6 6 6 6 6 7 7 7 7 7 8 8 8 8```

# AIåˆ†æç»“æœ


### ğŸ’¡ Kayçš„C++ç®—æ³•è§£æï¼šIris's Full Binary Tree æ·±å…¥å­¦ä¹ æŒ‡å— ğŸ’¡

#### 1. é¢˜ç›®è§£è¯»ä¸æ ¸å¿ƒç®—æ³•è¯†åˆ«
âœ¨ **æœ¬é¢˜ä¸»è¦è€ƒå¯Ÿ**ï¼šåŠ¨æ€æ ‘ç»´æŠ¤ + çº¿æ®µæ ‘ä¼˜åŒ– + æ ‘å½¢ç»“æ„åˆ†æ  
ğŸ—£ï¸ **åˆæ­¥åˆ†æ**ï¼š
> æƒ³è±¡ä½ åœ¨ç©ä¸€æ¬¾åƒç´ é£æ ‘å½¢å»ºé€ æ¸¸æˆï¼Œæ¯æ¬¡æ·»åŠ æ–°èŠ‚ç‚¹æ—¶ï¼Œéœ€è¦å®æ—¶è®¡ç®—å½“å‰æ ‘çš„"äºŒè¿›åˆ¶æ·±åº¦"â€”â€”å³é€šè¿‡æ·»åŠ èŠ‚ç‚¹èƒ½å½¢æˆçš„æœ€å°æ»¡äºŒå‰æ ‘æ·±åº¦ã€‚æ ¸å¿ƒæŒ‘æˆ˜åœ¨äºï¼š
> - **åŠ¨æ€ç»´æŠ¤æ ‘çš„ç›´å¾„**ï¼šæ¯æ¬¡åŠ èŠ‚ç‚¹åï¼Œæ ‘çš„"æœ€é•¿æå¹²"ï¼ˆç›´å¾„ï¼‰å¯èƒ½å˜åŒ–
> - **ä¸­å¿ƒç‚¹æ¼‚ç§»**ï¼šæ ‘çš„ä¸­å¿ƒï¼ˆå¹³è¡¡ç‚¹ï¼‰ä¼šéšç›´å¾„ç§»åŠ¨ï¼Œå½±å“è·ç¦»è®¡ç®—
> - **åº¦æ•°ç›‘ç‹±**ï¼šä»»ä½•èŠ‚ç‚¹åº¦æ•°â‰¥4æ—¶ç«‹å³åˆ¤å®šä¸ºä¸å¯èƒ½ï¼ˆåç»­ç­”æ¡ˆå…¨-1ï¼‰

å¯è§†åŒ–è®¾è®¡æ€è·¯ï¼š
> é‡‡ç”¨ã€Šå¡å°”è¾¾ä¼ è¯´ã€‹å¼çš„8-bitåƒç´ é£æ ¼ï¼š
> 1. **æ ‘å½¢æ²™ç›˜**ï¼šå·¦ä¾§æ˜¾ç¤ºç”Ÿé•¿ä¸­çš„æ ‘ï¼ŒèŠ‚ç‚¹ç”¨ä¸åŒé¢œè‰²åƒç´ å—è¡¨ç¤ºï¼ˆç»¿è‰²=æ™®é€šï¼Œçº¢è‰²=åº¦æ•°è¶…é™ï¼‰
> 2. **ç›´å¾„è¿½è¸ª**ï¼šå½“å‰ç›´å¾„ç«¯ç‚¹ç”¨é—ªçƒé‡‘è¾¹æ ‡è®°ï¼Œä¸­å¿ƒç‚¹ç”¨åå­—å…‰æ ‡æ˜¾ç¤º
> 3. **çº¿æ®µæ ‘ä»ªè¡¨ç›˜**ï¼šå³ä¾§ç”¨å †å åƒç´ æ–¹å—å®æ—¶æ˜¾ç¤ºçº¿æ®µæ ‘çŠ¶æ€ï¼Œæ•°å€¼å˜åŒ–ä¼´éš"æ»´ç­”"éŸ³æ•ˆ
> 4. **åŠ¨æ€æ¼”ç¤º**ï¼šæŒ‰ç©ºæ ¼é”®è¿›å…¥"AIå»ºé€ æ¨¡å¼"ï¼Œè‡ªåŠ¨é€æ­¥æ¼”ç¤ºç®—æ³•è¿‡ç¨‹ï¼Œä¼´éšä¸åŒæ“ä½œéŸ³æ•ˆï¼š
>    - èŠ‚ç‚¹åŠ å…¥ï¼šçŸ­ä¿ƒ"å®"å£°
>    - ç›´å¾„æ‰©å±•ï¼šä¸Šå‡éŸ³é˜¶
>    - ä¸­å¿ƒç§»åŠ¨ï¼šæ»‘åŠ¨éŸ³æ•ˆ
>    - åº¦æ•°è¶…é™ï¼šè­¦æŠ¥å£°

---

#### 2. ç²¾é€‰ä¼˜è´¨é¢˜è§£å‚è€ƒ
**é¢˜è§£ä¸€ï¼ˆConan15ï¼‰**  
* **ç‚¹è¯„**ï¼šæ€è·¯å¦‚æ°´æ™¶èˆ¬é€šé€ï¼å°†åŠ¨æ€ç›´å¾„ç»´æŠ¤æ¯”ä½œ"åŒé”šç‚¹æ¼‚ç§»"ï¼Œé€šè¿‡ç²¾å¦™çš„`move()`å‡½æ•°å¤„ç†ä¸­å¿ƒç§»åŠ¨ã€‚ä»£ç ä¸­ï¼š
  - ç›´å¾„ç«¯ç‚¹`(a,b)`å’ŒåŠå¾„`r`çš„ç»´æŠ¤å ªç§°å…¸èŒƒ
  - çº¿æ®µæ ‘åŒºé—´æ›´æ–°å¤„ç†å­æ ‘åŠ å‡ï¼ˆ`add(1, l, r, Â±1)`ï¼‰å±•ç°æ‰å®åŠŸåº•
  - è¾¹ç•Œå¤„ç†ä¸¥è°¨ï¼ˆåº¦æ•°â‰¥4æ—¶ç«‹å³é”å®šåç»­ç­”æ¡ˆä¸º-1ï¼‰
  > ğŸ’¡ å­¦ä¹ é‡ç‚¹ï¼šåŠ¨æ€æ ‘ç»´æŠ¤ä¸­"ä¸­å¿ƒæ¼‚ç§»"çš„æ•°å­¦è¯æ˜ä¸å·¥ç¨‹å®ç°

**é¢˜è§£äºŒï¼ˆDaiRuiChen007ï¼‰**  
* **ç‚¹è¯„**ï¼šç®—æ³•æ‰‹æœ¯åˆ€èˆ¬ç²¾å‡†ï¼äº®ç‚¹åœ¨äºï¼š
  - ç”¨DFSåº+STè¡¨é—ªç”µè®¡ç®—LCAè·ç¦»
  - ä¸­å¿ƒç§»åŠ¨æ—¶`nxt()`å‡½æ•°å®šå‘è·³è½¬é…åˆå­æ ‘åŒºé—´æ›´æ–°
  - ä»£ç ç®€æ´å¦‚è¯—ï¼ˆä»…83è¡Œè§£å†³5e5æ•°æ®ï¼‰
  > ğŸ’¡ å­¦ä¹ é‡ç‚¹ï¼šå¦‚ä½•ç”¨DFSåºå°†æ ‘å½¢é—®é¢˜è½¬åŒ–ä¸ºåŒºé—´æ“ä½œ

---

#### 3. æ ¸å¿ƒéš¾ç‚¹è¾¨æä¸è§£é¢˜ç­–ç•¥
1. **éš¾ç‚¹1ï¼šç›´å¾„çš„åŠ¨æ€ç»´æŠ¤**  
   * **åˆ†æ**ï¼šæ–°èŠ‚ç‚¹åŠ å…¥æ—¶ï¼Œç›´å¾„å¯èƒ½æ‰©å±•ã€‚å…³é”®è¯æ˜ï¼šæ–°ç›´å¾„ç«¯ç‚¹å¿…ä¸º{åŸç«¯ç‚¹, æ–°èŠ‚ç‚¹}çš„å­é›†
   * ğŸ’¡ å­¦ä¹ ç¬”è®°ï¼šç»´æŠ¤åŒç«¯ç‚¹`(a,b)`ï¼Œè®¡ç®—`max(dis(a,new), dis(b,new))`å†³å®šæ˜¯å¦æ›´æ–°

2. **éš¾ç‚¹2ï¼šä¸­å¿ƒæ¼‚ç§»çš„åŒºé—´æ›´æ–°**  
   * **åˆ†æ**ï¼šä¸­å¿ƒç§»åŠ¨å¯¼è‡´å­æ ‘å†…/å¤–è·ç¦»å€¼Â±1ã€‚é€šè¿‡DFSåºæ˜ å°„ä¸ºçº¿æ®µæ ‘åŒºé—´æ“ä½œï¼š
   ```math
   âˆ€u âˆˆ Subtree(v): dist(u) â† dist(u) Â± 1
   ```
   * ğŸ’¡ å­¦ä¹ ç¬”è®°ï¼šDFSåºæ˜¯æ ‘å½¢ç»“æ„çš„"æ¡å½¢ç "ï¼Œä½¿å­æ ‘æ“ä½œè½¬åŒ–ä¸ºè¿ç»­åŒºé—´

3. **éš¾ç‚¹3ï¼šåº¦æ•°ç›‘ç‹±çš„å®æ—¶ç›‘æ§**  
   * **åˆ†æ**ï¼šæ»¡äºŒå‰æ ‘è¦æ±‚ï¼š
   - æ ¹èŠ‚ç‚¹åº¦æ•°â‰¤2ï¼ˆåƒç´ å›¾ç¤ºï¼šğŸ‘‘â†’æœ€å¤šä¸¤åˆ†æï¼‰
   - å…¶ä»–èŠ‚ç‚¹â‰¤3ï¼ˆå›¾ç¤ºï¼šğŸŸ¢â†’æœ€å¤šä¸‰åˆ†æï¼‰
   * ğŸ’¡ å­¦ä¹ ç¬”è®°ï¼šç”¨`deg[]`æ•°ç»„å®æ—¶ç›‘æ§ï¼Œé¦–æ¬¡å‡ºç°â‰¥4æ—¶ç«‹å³ç†”æ–­

âœ¨ **è§£é¢˜æŠ€å·§æ€»ç»“**  
- **é”šç‚¹è¿½è¸ªæ³•**ï¼šç”¨`(a,b)`åŒæŒ‡é’ˆæ ‡è®°ç›´å¾„ç«¯ç‚¹  
- **å­æ ‘å¿«ç…§**ï¼šDFSåº+çº¿æ®µæ ‘å®ç°O(log n)åŒºé—´æ›´æ–°  
- **ç†”æ–­æœºåˆ¶**ï¼šåº¦æ•°è¶…é™æ—¶ç«‹å³ç»ˆæ­¢åç»­è®¡ç®—  

---

#### 4. C++æ ¸å¿ƒä»£ç å®ç°èµæ
**æœ¬é¢˜é€šç”¨æ ¸å¿ƒå®ç°å‚è€ƒ**  
```cpp
// ç²¾ç®€ç‰ˆæ¡†æ¶ (ç»¼åˆä¸¤é¢˜è§£ç²¾å)
const int N = 5e5+5, INF = 0x3f3f3f3f;
int a, b, r; // ç›´å¾„ç«¯ç‚¹ & åŠå¾„
vector<int> G[N];      // æ ‘ç»“æ„
int L[N], R[N], dep[N];// DFSåº & æ·±åº¦

struct SegmentTree {    // é­”æ³•çº¿æ®µæ ‘
    void add(int l, int r, int v); // åŒºé—´åŠ å‡
    void set(int u, int v);        // å•ç‚¹èµ‹å€¼
    int query();                   // å…¨å±€æœ€å°å€¼
} T;

void update_diameter(int x) { // åŠ¨æ€ç»´æŠ¤ç›´å¾„
    int da = dis(a,x), db = dis(b,x);
    if(max(da,db) > dis(a,b)) 
        (da>db) ? b=x : a=x; // æ›´æ–°ç«¯ç‚¹
}

int main() {
    // åˆå§‹åŒ–æ ‘ç»“æ„ & DFSåº
    for(int i=2; i<=n; ++i) {
        if(deg[fa]++ >= 3) meltdown(); // ç†”æ–­æ£€æµ‹
        update_diameter(i);            // æ›´æ–°ç›´å¾„
        T.set(i, max(dis(i,a),dis(i,b)));// æ›´æ–°è·ç¦»
        ans = T.query() + 1;           // äºŒè¿›åˆ¶æ·±åº¦
    }
}
```

**é¢˜è§£ä¸€æ ¸å¿ƒç‰‡æ®µèµæ**  
```cpp
// Conan15çš„ç›´å¾„æ›´æ–°é­”æ³•
void move(int &a, int x) {
    if(xåœ¨açš„å­æ ‘å†…) {
        T.add(1, n, +1);   // å…¨å±€+1
        a = xçš„æŸä¸ªå­å­™;    // ä¸­å¿ƒä¸‹ç§»
        T.add(açš„å­æ ‘, -1); // å±€éƒ¨æŠµæ¶ˆ
    } else { 
        T.add(açš„å­æ ‘, +1);
        a = çˆ¶èŠ‚ç‚¹;        // ä¸­å¿ƒä¸Šç§»
    }
}
```
> **ä»£ç è§£è¯»**ï¼šä¸­å¿ƒç§»åŠ¨å¦‚ç”µæ¢¯è¿ä½œ  
> - å½“æ–°èŠ‚ç‚¹åœ¨ä¸‹æ–¹ï¼šå…¨å±€æŠ¬å‡åå¯¹ç§»åŠ¨å­æ ‘å±€éƒ¨å›è°ƒ  
> - å½“æ–°èŠ‚ç‚¹åœ¨ä¾§é¢ï¼šå½“å‰å­æ ‘å¢é‡åä¸­å¿ƒä¸Šæµ®  
> ğŸ’¡ å­¦ä¹ ç¬”è®°ï¼šåŒºé—´æ“ä½œéœ€ä¿æŒ"èƒ½é‡å®ˆæ’"

**é¢˜è§£äºŒæ ¸å¿ƒç‰‡æ®µèµæ**  
```cpp
// DaiRuiChen007çš„LCAé—ªç”µæˆ˜
int dis(int x,int y) {
    int a = LCA(x,y);            // STè¡¨è·³è·³ä¹
    return dep[x]+dep[y]-2*dep[a];// å‡ ä½•è·ç¦»å…¬å¼
}
```
> **ä»£ç è§£è¯»**ï¼šSTè¡¨é¢„å¤„ç†å®ç°O(1)LCAæŸ¥è¯¢  
> ğŸ’¡ å­¦ä¹ ç¬”è®°ï¼š`dep[u]`æ˜¯èŠ‚ç‚¹çš„"æµ·æ‹”é«˜åº¦"ï¼ŒLCAå³"å±±è„‰äº¤æ±‡ç‚¹"

---

### 5. ç®—æ³•å¯è§†åŒ–ï¼šåƒç´ åŠ¨ç”»æ¼”ç¤º  
![](https://cdn.luogu.com.cn/upload/vjudge_pic/CF2006E/7f900739a2145e9bd80715ede4260b35ba51b9fd.png)  
* **ä¸»é¢˜**ï¼šã€ŠäºŒå‰æ ‘å»ºé€ å¤§å¸ˆã€‹8-bitæ¨¡æ‹Ÿ  
* **æ ¸å¿ƒäº¤äº’**ï¼š  
  1. **æ ‘å½¢æ²™ç›˜**ï¼ˆå·¦ï¼‰  
     - èŠ‚ç‚¹åŠ å…¥ï¼šåƒç´ æ–¹å—ä»å¤©è€Œé™  
     - ç›´å¾„æ˜¾ç¤ºï¼šé‡‘è¾¹è¿æ¥ç«¯ç‚¹  
     - ä¸­å¿ƒæ ‡è®°ï¼šåå­—å…‰æ ‡é—ªçƒ  

  2. **çº¿æ®µæ ‘æ§åˆ¶å°**ï¼ˆå³ï¼‰  
     - æ•°å€¼æ›´æ–°ï¼šæ–¹å—é«˜åº¦=å­˜å‚¨å€¼  
     - åŒºé—´æ“ä½œï¼šè‰²å—æ³¢æµªå¼æµåŠ¨  

  3. **éŸ³æ•ˆç³»ç»Ÿ**  
     | äº‹ä»¶ | éŸ³æ•ˆ | å¯è§†åŒ–åé¦ˆ |
     |---|---|---|
     | åŠ èŠ‚ç‚¹ | æ¸…è„†"å®"å£° | ç»¿è‰²åƒç´ å¼¹å‡º |
     | ä¸­å¿ƒç§»åŠ¨ | æ»‘åŠ¨å£° | åå­—å…‰æ ‡æ»‘è¡Œ |
     | ç›´å¾„æ‰©å±• | ä¸Šå‡éŸ³é˜¶ | é‡‘è¾¹é—ªçƒ |
     | åº¦æ•°è¶…é™ | è­¦æŠ¥å£° | èŠ‚ç‚¹å˜çº¢çˆ†è£‚ |

* **AIæ¼”ç¤ºæ¨¡å¼**ï¼š  
  æŒ‰Aé”®è§¦å‘è‡ªåŠ¨å»ºé€ ï¼Œé€Ÿåº¦æ»‘å—æ§åˆ¶æ¼”ç¤ºèŠ‚å¥ï¼Œå…³é”®æ­¥éª¤è‡ªåŠ¨æš‚åœ+æ–‡å­—æç¤ºï¼š
  > "ä¸­å¿ƒç§»åŠ¨ï¼å­æ ‘Aè·ç¦»å€¼å…¨ä½“+1"

---

### 6. æ‹“å±•ç»ƒä¹ ä¸ç›¸ä¼¼é—®é¢˜  
* **æ€ç»´è¿ç§»**ï¼š  
  1. åŠ¨æ€ç›´å¾„ç»´æŠ¤ â†’ ç½‘ç»œå»¶è¿Ÿç›‘æµ‹  
  2. DFSåºåŒºé—´æ“ä½œ â†’ å­æ ‘æƒé‡ç»Ÿè®¡  
  3. åº¦æ•°çº¦æŸ â†’ åŒ–å­¦åˆ†å­ç»“æ„éªŒè¯  

* **æ´›è°·æ¨è**ï¼š  
  1. **P1099 æ ‘ç½‘çš„æ ¸**  
     ğŸ—£ï¸ å·©å›ºæ ‘çš„ç›´å¾„ä¸ä¸­å¿ƒåº”ç”¨  
  2. **P2146 è½¯ä»¶åŒ…ç®¡ç†å™¨**  
     ğŸ—£ï¸ æŒæ¡DFSåº+çº¿æ®µæ ‘çš„é­”åŠ›  
  3. **P2680 è¿è¾“è®¡åˆ’**  
     ğŸ—£ï¸ è¿›é˜¶ç‰ˆç›´å¾„é—®é¢˜+äºŒåˆ†ç­”æ¡ˆ  

---

### 7. å­¦ä¹ å¿ƒå¾—ä¸ç»éªŒåˆ†äº«  
> **æ¥è‡ªConan15çš„è°ƒè¯•ç»éªŒ**ï¼š  
> "ä¸­å¿ƒç§»åŠ¨æ—¶åŒºé—´æ›´æ–°æ–¹å‘ææ˜“å‡ºé”™ï¼Œå»ºè®®åœ¨çº¸ä¸Šç”»å‡ºå­æ ‘åˆ†åŒºå›¾"  
>  
> **Kayçš„æ€»ç»“**ï¼š  
> è°ƒè¯•æ ‘å½¢é—®é¢˜è¦å–„ç”¨"çº¸ç¬”æ¨¡æ‹Ÿæ³•"ï¼Œå°†æŠ½è±¡ç§»åŠ¨å…·è±¡åŒ–ä¸ºï¼š
> ```
> ä¸­å¿ƒç§»åŠ¨ = ç”µæ¢¯è¿è¡Œ + è··è··æ¿å¹³è¡¡
> çº¿æ®µæ ‘æ›´æ–° = æ°´æ± æ³¨æ°´/æ’æ°´
> ```

--- 
æ ‘å½¢é—®é¢˜çŠ¹å¦‚åŸ¹è‚²åƒç´ èŠ±å›­ï¼Œæ¯æ¬¡æ‰©å±•éƒ½éœ€ç²¾å¿ƒè®¡ç®—ã€‚æŒæ¡åŠ¨æ€ç»´æŠ¤çš„å¥¥ä¹‰ï¼Œä½ ä¹Ÿèƒ½æˆä¸ºç®—æ³•å»ºç­‘å¸ˆï¼ğŸš€

---
å¤„ç†ç”¨æ—¶ï¼š260.87ç§’
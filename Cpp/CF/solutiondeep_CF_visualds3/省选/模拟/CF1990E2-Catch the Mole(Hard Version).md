# é¢˜ç›®ä¿¡æ¯

# Catch the Mole(Hard Version)

## é¢˜ç›®æè¿°

This is the hard version of the problem. The only difference is the limit on the number of queries.

This is an interactive problem.

You are given a tree of $ n $ nodes with node $ 1 $ as its root node.

There is a hidden mole in one of the nodes. To find its position, you can pick an integer $ x $ ( $ 1 \le x \le n $ ) to make an inquiry to the jury. Next, the jury will return $ 1 $ when the mole is in subtree $ x $ . Otherwise, the judge will return $ 0 $ . If the judge returns $ 0 $ and the mole is not in root node $ 1 $ , the mole will move to the parent node of the node it is currently on.

Use at most $ 160 $ operations to find the current node where the mole is located.

## è¯´æ˜/æç¤º

In the first test case, the mole is in node $ 2 $ initially.

For the query "? 2", the jury returns $ 1 $ because the mole is in subtree $ 2 $ . After this query, the mole does not move.

The answer $ 2 $ is the current node where the mole is located, so the answer is considered correct.

In the second test case, the mole is in node $ 6 $ initially.

For the query "? 2", the jury returns $ 0 $ because the mole is not in subtree $ 2 $ . After this query, the mole moves from node $ 6 $ to node $ 5 $ .

For the query "? 6", the jury returns $ 0 $ because the mole is not in subtree $ 6 $ . After this query, the mole moves from node $ 5 $ to node $ 4 $ .

For the query "? 4", the jury returns $ 1 $ because the mole is in subtree $ 4 $ . After this query, the mole does not move.

The answer $ 4 $ is the current node where the mole is located, so the answer is considered correct.

Please note that the example is only for understanding the statement, and the queries in the example do not guarantee to determine the unique position of the mole.

## æ ·ä¾‹ #1

### è¾“å…¥

```
2
2
1 2

1

6
1 2
1 3
1 4
4 5
5 6

0

0

1```

### è¾“å‡º

```
? 2

! 2






? 2

? 6

? 4

! 4```

# AIåˆ†æç»“æœ

---
# ğŸ’¡ Kayçš„C++ç®—æ³•è§£æï¼šCatch the Mole (Hard Version) æ·±å…¥å­¦ä¹ æŒ‡å— ğŸ’¡

<introduction>
ä»Šå¤©æˆ‘ä»¬æ¥ä¸€èµ·åˆ†æâ€œCatch the Mole (Hard Version)â€è¿™é“äº¤äº’é¢˜ã€‚è¿™é“é¢˜çš„å…³é”®åœ¨äºåˆ©ç”¨é¼¹é¼ åœ¨æŸ¥è¯¢å¤±è´¥æ—¶ä¸Šç§»çš„ç‰¹æ€§ï¼Œç»“åˆæ ¹å·åˆ†æ²»å’ŒäºŒåˆ†æŸ¥æ‰¾ï¼Œé«˜æ•ˆç¼©å°æœç´¢èŒƒå›´ã€‚æœ¬æŒ‡å—å°†å¸®åŠ©ä½ ç†è§£æ ¸å¿ƒæ€è·¯ã€å…³é”®æ­¥éª¤ï¼Œå¹¶é€šè¿‡å¯è§†åŒ–æ–¹æ¡ˆç›´è§‚æ„Ÿå—ç®—æ³•è¿‡ç¨‹ã€‚
</introduction>

## 1. é¢˜ç›®è§£è¯»ä¸æ ¸å¿ƒç®—æ³•è¯†åˆ«

âœ¨ **æœ¬é¢˜ä¸»è¦è€ƒå¯Ÿ**ï¼š`ç¼–ç¨‹æŠ€å·§åº”ç”¨ï¼ˆæ ¹å·åˆ†æ²»ï¼‰ä¸æœç´¢/åˆ†æ²»ç»“åˆ`

ğŸ—£ï¸ **åˆæ­¥åˆ†æ**ï¼š
è§£å†³è¿™é“é¢˜çš„æ ¸å¿ƒåœ¨äºåˆ©ç”¨â€œæŸ¥è¯¢å¤±è´¥æ—¶é¼¹é¼ ä¸Šç§»â€çš„ç‰¹æ€§ï¼Œé€šè¿‡â€œæ ¹å·åˆ†æ²»â€ç­–ç•¥å°†é—®é¢˜è§„æ¨¡ç¼©å°åˆ°ä¸€æ¡é“¾ä¸Šï¼Œå†é€šè¿‡äºŒåˆ†æŸ¥æ‰¾å®šä½å…·ä½“ä½ç½®ã€‚  
ç®€å•æ¥è¯´ï¼Œæ ¹å·åˆ†æ²»å°±åƒâ€œåˆ‡è›‹ç³•â€ï¼šå°†æ ‘åˆ†æˆâ€œå¤§å—â€å’Œâ€œå°å—â€ï¼Œå…ˆå¤„ç†å¤§å—ï¼ˆæ·±åº¦è¶…è¿‡é˜ˆå€¼çš„å­æ ‘ï¼‰ï¼Œå†å¤„ç†å°å—ï¼ˆæ·±åº¦è¾ƒå°çš„å­æ ‘ï¼‰ã€‚æœ¬é¢˜ä¸­ï¼Œæˆ‘ä»¬é€‰æ‹©é˜ˆå€¼ \( B = \sqrt{n} \)ï¼Œé€šè¿‡ \( B \) æ¬¡æŸ¥è¯¢å¶å­èŠ‚ç‚¹ï¼Œæ’é™¤æ·±åº¦ \( \leq B \) çš„å­æ ‘ï¼›å‰©ä½™éƒ¨åˆ†é€šè¿‡DFSç¡®å®šé¼¹é¼ æ‰€åœ¨çš„é“¾ï¼Œæœ€ååœ¨é“¾ä¸ŠäºŒåˆ†æŸ¥æ‰¾ã€‚

- **æ ¸å¿ƒæ€è·¯**ï¼š  
  1. **é¢„å¤„ç†æ·±åº¦**ï¼šè®¡ç®—æ¯ä¸ªèŠ‚ç‚¹çš„å­æ ‘æœ€å¤§æ·±åº¦ï¼ˆåˆ°å¶å­çš„è·ç¦»ï¼‰ã€‚  
  2. **æ’é™¤æµ…å­æ ‘**ï¼šè¿ç»­æŸ¥è¯¢åŒä¸€å¶å­ \( B \) æ¬¡ï¼Œè‹¥è¿”å› \( 1 \) åˆ™ç›´æ¥æ‰¾åˆ°ï¼›å¦åˆ™ï¼Œæ’é™¤æ‰€æœ‰æ·±åº¦ \( \leq B \) çš„å­æ ‘ï¼ˆé¼¹é¼ å·²ä¸Šç§» \( B \) æ¬¡ï¼Œä¸å¯èƒ½åœ¨è¿™äº›å­æ ‘ä¸­ï¼‰ã€‚  
  3. **ç¡®å®šé“¾**ï¼šä»æ ¹å‡ºå‘ï¼ŒDFSéå†å‰©ä½™å­æ ‘ï¼ˆä»…ä¿ç•™æ·±åº¦ \( > B \) çš„å­æ ‘ï¼‰ï¼Œç¡®å®šé¼¹é¼ æ‰€åœ¨çš„é“¾ã€‚  
  4. **é“¾ä¸ŠäºŒåˆ†**ï¼šåœ¨é“¾ä¸Šé€šè¿‡äºŒåˆ†æŸ¥æ‰¾å®šä½é¼¹é¼ å½“å‰ä½ç½®ã€‚  

- **å¯è§†åŒ–è®¾è®¡**ï¼š  
  é‡‡ç”¨8ä½åƒç´ é£æ ¼ï¼Œç”¨ä¸åŒé¢œè‰²æ ‡è®°å­æ ‘ï¼ˆç»¿è‰²ä¸ºæœ‰æ•ˆï¼Œçº¢è‰²ä¸ºæ’é™¤ï¼‰ï¼Œé¼¹é¼ ç”¨çº¢è‰²æ–¹å—è¡¨ç¤ºã€‚æ¯æ¬¡æŸ¥è¯¢æ—¶ï¼Œè‹¥è¿”å› \( 0 \)ï¼Œé¼¹é¼ å‘ä¸Šç§»åŠ¨ä¸€æ ¼ï¼ˆç»¿è‰²ç®­å¤´ï¼‰ï¼›è¿”å› \( 1 \) åˆ™é«˜äº®è¯¥å­æ ‘ã€‚æ§åˆ¶é¢æ¿æ”¯æŒå•æ­¥/è‡ªåŠ¨æ’­æ”¾ï¼Œè°ƒé€Ÿæ»‘å—è°ƒæ•´é€Ÿåº¦ï¼Œå…³é”®æ“ä½œï¼ˆå¦‚æ’é™¤å­æ ‘ï¼‰ä¼´éšâ€œå®â€éŸ³æ•ˆï¼Œæ‰¾åˆ°ç­”æ¡ˆæ—¶æ’­æ”¾èƒœåˆ©éŸ³æ•ˆã€‚

---

## 2. ç²¾é€‰ä¼˜è´¨é¢˜è§£å‚è€ƒ

<eval_intro>
é€šè¿‡è¯„ä¼°æ€è·¯æ¸…æ™°åº¦ã€ä»£ç è§„èŒƒæ€§å’Œç®—æ³•æœ‰æ•ˆæ€§ï¼Œä»¥ä¸‹é¢˜è§£è´¨é‡è¾ƒé«˜ï¼ˆâ‰¥4æ˜Ÿï¼‰ï¼Œå€¼å¾—é‡ç‚¹å­¦ä¹ ï¼š
</eval_intro>

**é¢˜è§£ä¸€ï¼šAlex_Weiï¼ˆèµ20ï¼‰**  
* **ç‚¹è¯„**ï¼šæ­¤é¢˜è§£æ·±å…¥åˆ†æäº†æ ¹å·åˆ†æ²»çš„æ ¸å¿ƒé€»è¾‘ï¼Œæå‡ºé€šè¿‡ \( B = \sqrt{n} \) æ¬¡æŸ¥è¯¢æ’é™¤æµ…å­æ ‘ï¼Œå†é€šè¿‡ \( O(\sqrt{n}) \) æ¬¡æŸ¥è¯¢ç¡®å®šé“¾ï¼Œæœ€åäºŒåˆ†æŸ¥æ‰¾ã€‚æ€è·¯ä¸¥è°¨ï¼Œå¯¹é˜ˆå€¼é€‰æ‹©å’Œå¤æ‚åº¦åˆ†æé€å½»ï¼Œé€‚åˆç†è§£æ ¹å·åˆ†æ²»çš„åº•å±‚åŸç†ã€‚äº®ç‚¹åœ¨äºæå‡ºâ€œæ¯æ¬¡æ’é™¤è‡³å°‘ \( B \) ä¸ªèŠ‚ç‚¹ï¼Œæ€»æ¬¡æ•° \( O(\sqrt{n}) \)â€çš„å…³é”®ç»“è®ºã€‚

**é¢˜è§£äºŒï¼šGold14526ï¼ˆèµ6ï¼‰**  
* **ç‚¹è¯„**ï¼šæ­¤é¢˜è§£æä¾›äº†å®Œæ•´çš„ä»£ç å®ç°ï¼Œç»“åˆçº¿æ®µæ ‘ç»´æŠ¤å­æ ‘å¤§å°ï¼Œé«˜æ•ˆå¤„ç†å­æ ‘æ’é™¤å’Œé“¾çš„ç¡®å®šã€‚ä»£ç ç»“æ„æ¸…æ™°ï¼ˆå¦‚DFSé¢„å¤„ç†æ·±åº¦ã€çº¿æ®µæ ‘æ›´æ–°å­æ ‘å¤§å°ï¼‰ï¼Œè¾¹ç•Œæ¡ä»¶å¤„ç†ä¸¥è°¨ï¼ˆå¦‚åˆ é™¤å¶å­èŠ‚ç‚¹åçš„çˆ¶èŠ‚ç‚¹æ›´æ–°ï¼‰ï¼Œé€‚åˆå­¦ä¹ å¦‚ä½•å°†ç†è®ºè½¬åŒ–ä¸ºä»£ç ã€‚äº®ç‚¹åœ¨äºé€šè¿‡çº¿æ®µæ ‘ä¼˜åŒ–å­æ ‘æ’é™¤çš„æ—¶é—´å¤æ‚åº¦ã€‚

**é¢˜è§£ä¸‰ï¼šWaterSunï¼ˆèµ2ï¼‰**  
* **ç‚¹è¯„**ï¼šæ­¤é¢˜è§£ä»£ç ç®€æ´ï¼Œé€»è¾‘ç›´è§‚ã€‚é€šè¿‡é¢„å¤„ç†å­æ ‘æ·±åº¦ã€å¤šæ¬¡æŸ¥è¯¢å¶å­èŠ‚ç‚¹æ’é™¤æµ…å­æ ‘ï¼Œå†DFSç¡®å®šé“¾ï¼Œæœ€åäºŒåˆ†æŸ¥æ‰¾ã€‚ä»£ç æ³¨é‡Šæ¸…æ™°ï¼ˆå¦‚`dfs1`è®¡ç®—æ·±åº¦ï¼Œ`dfs2`ç¡®å®šé“¾ï¼‰ï¼Œé€‚åˆæ–°æ‰‹å­¦ä¹ æ ¹å·åˆ†æ²»çš„å…·ä½“å®ç°ã€‚äº®ç‚¹åœ¨äºé“¾çš„ç¡®å®šéƒ¨åˆ†ï¼ˆä»…ä¿ç•™æ·±åº¦ \( > B \) çš„å­æ ‘ï¼‰ï¼Œé¿å…æ— æ•ˆæŸ¥è¯¢ã€‚

---

## 3. æ ¸å¿ƒéš¾ç‚¹è¾¨æä¸è§£é¢˜ç­–ç•¥

<difficulty_intro>
è§£å†³æ­¤é¢˜çš„å…³é”®åœ¨äºå¤„ç†é¼¹é¼ ç§»åŠ¨çš„ç‰¹æ€§å’Œå¿«é€Ÿç¼©å°æœç´¢èŒƒå›´ã€‚ä»¥ä¸‹æ˜¯ä¸‰ä¸ªæ ¸å¿ƒéš¾ç‚¹åŠåº”å¯¹ç­–ç•¥ï¼š
</difficulty_intro>

1.  **éš¾ç‚¹1ï¼šå¦‚ä½•åˆ©ç”¨é¼¹é¼ ä¸Šç§»ç‰¹æ€§ç¼©å°èŒƒå›´ï¼Ÿ**  
    * **åˆ†æ**ï¼šæ¯æ¬¡æŸ¥è¯¢è¿”å› \( 0 \) æ—¶ï¼Œé¼¹é¼ ä¸Šç§»ä¸€æ ¼ã€‚è‹¥è¿ç»­ \( B \) æ¬¡æŸ¥è¯¢åŒä¸€å¶å­è¿”å› \( 0 \)ï¼Œåˆ™æ‰€æœ‰æ·±åº¦ \( \leq B \) çš„å­æ ‘ä¸­ä¸å¯èƒ½æœ‰é¼¹é¼ ï¼ˆå¦åˆ™é¼¹é¼ å·²ä¸Šç§» \( B \) æ¬¡ç¦»å¼€è¿™äº›å­æ ‘ï¼‰ã€‚  
    * ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šé€šè¿‡â€œè¿ç»­æŸ¥è¯¢å¶å­â€å°†é—®é¢˜è§„æ¨¡ä» \( n \) ç¼©å°åˆ° \( n/B \)ï¼Œæ˜¯æ ¹å·åˆ†æ²»çš„æ ¸å¿ƒæŠ€å·§ã€‚

2.  **éš¾ç‚¹2ï¼šå¦‚ä½•é€‰æ‹©é˜ˆå€¼ \( B \)ï¼Ÿ**  
    * **åˆ†æ**ï¼š\( B \) éœ€å¹³è¡¡â€œæ’é™¤æµ…å­æ ‘çš„æ¬¡æ•°â€å’Œâ€œå‰©ä½™å­æ ‘çš„æ•°é‡â€ã€‚å– \( B = \sqrt{n} \) æ—¶ï¼Œæ€»æ¬¡æ•° \( B + n/B + \log n \approx 2\sqrt{n} + \log n \)ï¼ˆ\( n=5000 \) æ—¶çº¦ \( 2*70 + 13 = 153 \) æ¬¡ï¼‰ï¼Œæ»¡è¶³ \( 160 \) æ¬¡é™åˆ¶ã€‚  
    * ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šæ ¹å·åˆ†æ²»çš„å…³é”®æ˜¯é€šè¿‡é˜ˆå€¼ \( B \) å°†é—®é¢˜åˆ†è§£ä¸ºä¸¤éƒ¨åˆ†ï¼Œä½¿æ€»å¤æ‚åº¦æœ€å°ã€‚

3.  **éš¾ç‚¹3ï¼šå¦‚ä½•å°†æ ‘è½¬åŒ–ä¸ºé“¾ä»¥ä¾¿äºŒåˆ†ï¼Ÿ**  
    * **åˆ†æ**ï¼šDFSéå†å‰©ä½™å­æ ‘ï¼ˆä»…ä¿ç•™æ·±åº¦ \( > B \) çš„å­æ ‘ï¼‰ï¼Œæ¯æ¬¡æŸ¥è¯¢å­èŠ‚ç‚¹ï¼Œè‹¥è¿”å› \( 1 \) åˆ™è¿›å…¥è¯¥å­æ ‘ï¼Œå¦åˆ™æ’é™¤ã€‚æœ€ç»ˆå¾—åˆ°ä¸€æ¡ä»æ ¹åˆ°å¶å­çš„é“¾ï¼Œé“¾ä¸ŠèŠ‚ç‚¹å³ä¸ºå¯èƒ½çš„é¼¹é¼ ä½ç½®ã€‚  
    * ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šé“¾çš„ç¡®å®šæ˜¯äºŒåˆ†çš„å‰æï¼Œéœ€ç¡®ä¿é“¾ä¸Šæ¯ä¸ªèŠ‚ç‚¹çš„å­æ ‘æ·±åº¦è¶³å¤Ÿå¤§ï¼ˆ\( > B \)ï¼‰ã€‚

### âœ¨ è§£é¢˜æŠ€å·§æ€»ç»“
- **é˜ˆå€¼é€‰æ‹©**ï¼šå– \( B = \sqrt{n} \) å¹³è¡¡æ’é™¤æ¬¡æ•°å’Œå‰©ä½™è§„æ¨¡ã€‚  
- **è¿ç»­æŸ¥è¯¢å¶å­**ï¼šå¿«é€Ÿæ’é™¤æµ…å­æ ‘ï¼Œåˆ©ç”¨é¼¹é¼ ä¸Šç§»ç‰¹æ€§ç¼©å°èŒƒå›´ã€‚  
- **DFSç¡®å®šé“¾**ï¼šä»…ä¿ç•™æ·±åº¦ \( > B \) çš„å­æ ‘ï¼Œé¿å…æ— æ•ˆæŸ¥è¯¢ã€‚  
- **é“¾ä¸ŠäºŒåˆ†**ï¼šå°†æ ‘é—®é¢˜è½¬åŒ–ä¸ºåºåˆ—é—®é¢˜ï¼Œåˆ©ç”¨äºŒåˆ†é«˜æ•ˆå®šä½ã€‚

---

## 4. C++æ ¸å¿ƒä»£ç å®ç°èµæ

<code_intro_overall>
ä»¥ä¸‹æ˜¯ç»¼åˆä¼˜è´¨é¢˜è§£æ€è·¯çš„é€šç”¨æ ¸å¿ƒä»£ç ï¼Œç»“åˆäº†æ ¹å·åˆ†æ²»å’ŒäºŒåˆ†æŸ¥æ‰¾ï¼Œé€»è¾‘æ¸…æ™°ä¸”ç¬¦åˆæ¬¡æ•°é™åˆ¶ã€‚
</code_intro_overall>

**æœ¬é¢˜é€šç”¨æ ¸å¿ƒC++å®ç°å‚è€ƒ**  
* **è¯´æ˜**ï¼šæœ¬ä»£ç ç»¼åˆäº†Alex_Weiçš„æ ¹å·åˆ†æ²»æ€è·¯å’ŒWaterSunçš„å…·ä½“å®ç°ï¼ŒåŒ…å«é¢„å¤„ç†æ·±åº¦ã€æ’é™¤æµ…å­æ ‘ã€ç¡®å®šé“¾å’ŒäºŒåˆ†æŸ¥æ‰¾çš„å®Œæ•´æµç¨‹ã€‚  
* **å®Œæ•´æ ¸å¿ƒä»£ç **ï¼š
    ```cpp
    #include <bits/stdc++.h>
    using namespace std;

    const int N = 5010;
    int n, B;
    vector<int> g[N];
    int dep[N], max_dep[N]; // dep: èŠ‚ç‚¹åˆ°æ ¹çš„è·ç¦»ï¼›max_dep: å­æ ‘æœ€å¤§æ·±åº¦ï¼ˆåˆ°å¶å­çš„è·ç¦»ï¼‰

    int read() {
        int x = 0; char c = getchar();
        while (!isdigit(c)) c = getchar();
        while (isdigit(c)) x = x * 10 + (c - '0'), c = getchar();
        return x;
    }

    bool ask(int u) {
        printf("? %d\n", u); fflush(stdout);
        return read();
    }

    void dfs_depth(int u, int fa) {
        max_dep[u] = 1;
        for (int v : g[u]) {
            if (v == fa) continue;
            dep[v] = dep[u] + 1;
            dfs_depth(v, u);
            max_dep[u] = max(max_dep[u], max_dep[v] + 1);
        }
    }

    void dfs_chain(int u, int fa, vector<int>& chain) {
        chain.push_back(u);
        vector<int> sons;
        for (int v : g[u]) {
            if (v == fa || max_dep[v] <= B) continue; // æ’é™¤æ·±åº¦â‰¤Bçš„å­æ ‘
            sons.push_back(v);
        }
        for (int i = 0; i < (int)sons.size() - 1; ++i) { // è¯¢é—®å‰k-1ä¸ªå­æ ‘
            if (ask(sons[i])) {
                dfs_chain(sons[i], u, chain);
                return;
            }
        }
        if (!sons.empty()) dfs_chain(sons.back(), u, chain); // æœ€åä¸€ä¸ªå­æ ‘
    }

    void solve() {
        n = read(); B = sqrt(n);
        for (int i = 1; i <= n; ++i) g[i].clear(), dep[i] = max_dep[i] = 0;
        for (int i = 1; i < n; ++i) {
            int u = read(), v = read();
            g[u].push_back(v);
            g[v].push_back(u);
        }

        // æ‰¾å¶å­èŠ‚ç‚¹ï¼ˆå­æ ‘æ·±åº¦ä¸º1ï¼‰
        int leaf = 0;
        dfs_depth(1, -1);
        for (int i = 1; i <= n; ++i) if (max_dep[i] == 1) leaf = i;

        // è¿ç»­æŸ¥è¯¢å¶å­Bæ¬¡ï¼Œæ’é™¤æµ…å­æ ‘
        bool found = false;
        for (int i = 1; i <= B; ++i) {
            if (ask(leaf)) {
                printf("! %d\n", leaf);
                found = true;
                break;
            }
        }
        if (found) return;

        // ç¡®å®šé“¾
        vector<int> chain;
        dfs_chain(1, -1, chain);

        // é“¾ä¸ŠäºŒåˆ†
        int l = 0, r = chain.size() - 1, cnt = 0;
        while (l < r) {
            int mid = (l + r + 1) / 2;
            int query_node = (mid > cnt) ? chain[mid - cnt] : 1; // è€ƒè™‘ä¸Šç§»æ¬¡æ•°cnt
            if (ask(query_node)) l = mid;
            else {
                r = mid - 2;
                cnt++;
            }
        }
        printf("! %d\n", chain[l - cnt]);
    }

    int main() {
        int T = read();
        while (T--) solve();
        return 0;
    }
    ```
* **ä»£ç è§£è¯»æ¦‚è¦**ï¼š  
  ä»£ç é¦–å…ˆé¢„å¤„ç†æ¯ä¸ªèŠ‚ç‚¹çš„å­æ ‘æœ€å¤§æ·±åº¦ï¼ˆ`dfs_depth`ï¼‰ï¼Œæ‰¾åˆ°å¶å­èŠ‚ç‚¹åè¿ç»­æŸ¥è¯¢ \( B \) æ¬¡ï¼Œæ’é™¤æ·±åº¦ \( \leq B \) çš„å­æ ‘ã€‚ç„¶åé€šè¿‡`dfs_chain`ç¡®å®šå‰©ä½™é“¾ï¼Œæœ€ååœ¨é“¾ä¸ŠäºŒåˆ†æŸ¥æ‰¾ï¼ˆè€ƒè™‘é¼¹é¼ ä¸Šç§»æ¬¡æ•°`cnt`ï¼‰ã€‚

---

<code_intro_selected>
ä»¥ä¸‹æ˜¯ä¼˜è´¨é¢˜è§£çš„æ ¸å¿ƒä»£ç ç‰‡æ®µèµæï¼š
</code_intro_selected>

**é¢˜è§£ä¸‰ï¼šWaterSunï¼ˆæ¥æºï¼šç”¨æˆ·é¢˜è§£ï¼‰**  
* **äº®ç‚¹**ï¼šä»£ç ç®€æ´ï¼Œé€»è¾‘ç›´è§‚ï¼Œé€šè¿‡é¢„å¤„ç†æ·±åº¦å’ŒDFSç¡®å®šé“¾ï¼Œé€‚åˆæ–°æ‰‹å­¦ä¹ ã€‚  
* **æ ¸å¿ƒä»£ç ç‰‡æ®µ**ï¼š
    ```cpp
    void dfs2(int u, int fa) {
        v.push_back(u);
        vector<int> s;
        for (int v : g[u]) {
            if (v == fa || d[v] <= B) continue;
            s.push_back(v);
        }
        for (int i = 1; i < s.size(); i++) {
            if (ask(s[i])) return dfs2(s[i], u);
        }
        if (!s.empty()) dfs2(s.front(), u);
    }
    ```
* **ä»£ç è§£è¯»**ï¼š  
  `dfs2`å‡½æ•°ç”¨äºç¡®å®šé“¾ã€‚å‚æ•°`u`æ˜¯å½“å‰èŠ‚ç‚¹ï¼Œ`fa`æ˜¯çˆ¶èŠ‚ç‚¹ã€‚é¦–å…ˆæ”¶é›†æ‰€æœ‰æ·±åº¦ \( > B \) çš„å­èŠ‚ç‚¹ï¼ˆ`s`ï¼‰ï¼Œç„¶åä¾æ¬¡è¯¢é—®å‰ \( s.size()-1 \) ä¸ªå­èŠ‚ç‚¹ï¼šè‹¥è¿”å› \( 1 \)ï¼Œåˆ™è¿›å…¥è¯¥å­æ ‘é€’å½’ï¼›å¦åˆ™ç»§ç»­ã€‚æœ€åå¤„ç†æœ€åä¸€ä¸ªå­æ ‘ï¼ˆè‹¥å­˜åœ¨ï¼‰ã€‚  
  è¿™æ®µä»£ç é€šè¿‡æ’é™¤æ³•ç¡®å®šé“¾çš„æ–¹å‘ï¼Œç¡®ä¿æ¯æ¬¡é€’å½’éƒ½ç¼©å°èŒƒå›´ï¼Œæœ€ç»ˆå¾—åˆ°ä¸€æ¡ä»æ ¹åˆ°å¶å­çš„é“¾ã€‚  
* ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šé€šè¿‡â€œè¯¢é—®å‰k-1ä¸ªå­æ ‘â€æ’é™¤æ— æ•ˆåˆ†æ”¯ï¼Œæœ€åå¤„ç†æœ€åä¸€ä¸ªå­æ ‘ï¼Œé¿å…é—æ¼ã€‚

---

## 5\. ç®—æ³•å¯è§†åŒ–ï¼šåƒç´ åŠ¨ç”»æ¼”ç¤º (æ ¸å¿ƒéƒ¨åˆ†)

<visualization_intro>
ä¸ºäº†ç›´è§‚ç†è§£æ ¹å·åˆ†æ²»å’ŒäºŒåˆ†æŸ¥æ‰¾çš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬è®¾è®¡äº†ä¸€ä¸ª8ä½åƒç´ é£æ ¼çš„åŠ¨ç”»ï¼Œæ¨¡æ‹Ÿé¼¹é¼ ç§»åŠ¨å’Œå­æ ‘æ’é™¤è¿‡ç¨‹ã€‚
</visualization_intro>

  * **åŠ¨ç”»æ¼”ç¤ºä¸»é¢˜**ï¼š`åƒç´ é¼¹é¼ å¤§å†’é™©`  
  * **æ ¸å¿ƒæ¼”ç¤ºå†…å®¹**ï¼š  
    å±•ç¤ºè¿ç»­æŸ¥è¯¢å¶å­èŠ‚ç‚¹æ’é™¤æµ…å­æ ‘ã€DFSç¡®å®šé“¾ã€é“¾ä¸ŠäºŒåˆ†æŸ¥æ‰¾çš„å…¨è¿‡ç¨‹ã€‚é¼¹é¼ ï¼ˆçº¢è‰²æ–¹å—ï¼‰åœ¨æ ‘ä¸­ç§»åŠ¨ï¼ŒæŸ¥è¯¢èŠ‚ç‚¹ï¼ˆè“è‰²é«˜äº®ï¼‰ï¼Œè¿”å› \( 0 \) æ—¶é¼¹é¼ ä¸Šç§»ï¼ˆç»¿è‰²ç®­å¤´ï¼‰ï¼Œè¿”å› \( 1 \) æ—¶å­æ ‘æ ‡è®°ä¸ºé»„è‰²ï¼ˆæœ‰æ•ˆåŒºåŸŸï¼‰ã€‚

  * **è®¾è®¡æ€è·¯ç®€è¿°**ï¼š  
    8ä½åƒç´ é£æ ¼ï¼ˆFCçº¢ç™½æœºè‰²è°ƒï¼‰è¥é€ è½»æ¾æ°›å›´ï¼Œå…³é”®æ“ä½œï¼ˆå¦‚æ’é™¤å­æ ‘ã€é¼¹é¼ ç§»åŠ¨ï¼‰ç”¨é¢œè‰²å’ŒéŸ³æ•ˆå¼ºåŒ–è®°å¿†ã€‚è‡ªåŠ¨æ’­æ”¾æ¨¡å¼æ¨¡æ‹Ÿç®—æ³•æ‰§è¡Œï¼Œå•æ­¥æ¨¡å¼å…è®¸é€æ¬¡è§‚å¯Ÿç»†èŠ‚ï¼Œè°ƒé€Ÿæ»‘å—æ§åˆ¶èŠ‚å¥ã€‚

  * **åŠ¨ç”»å¸§æ­¥éª¤ä¸äº¤äº’å…³é”®ç‚¹**ï¼š

    1. **åˆå§‹åŒ–åœºæ™¯**ï¼š  
       å±å¹•å·¦ä¾§ä¸ºæ ‘ç»“æ„ï¼ˆåƒç´ ç½‘æ ¼ï¼ŒèŠ‚ç‚¹ç”¨åœ†å½¢è¡¨ç¤ºï¼Œè¾¹ç”¨ç»†çº¿è¿æ¥ï¼‰ï¼Œå³ä¾§ä¸ºæ§åˆ¶é¢æ¿ï¼ˆå¼€å§‹/æš‚åœã€å•æ­¥ã€è°ƒé€Ÿæ»‘å—ï¼‰ã€‚èƒŒæ™¯æ’­æ”¾8ä½é£æ ¼BGMã€‚

    2. **æ’é™¤æµ…å­æ ‘**ï¼š  
       é€‰æ‹©å¶å­èŠ‚ç‚¹ï¼ˆç´«è‰²æ ‡è®°ï¼‰ï¼Œè¿ç»­æŸ¥è¯¢ \( B \) æ¬¡ã€‚æ¯æ¬¡æŸ¥è¯¢è¿”å› \( 0 \) æ—¶ï¼Œé¼¹é¼ ä¸Šç§»ä¸€æ ¼ï¼ˆç»¿è‰²ç®­å¤´ï¼‰ï¼Œè¯¥å¶å­çš„å­æ ‘ï¼ˆæ·±åº¦ \( \leq B \)ï¼‰ç”¨çº¢è‰²è¦†ç›–ï¼ˆæ’é™¤ï¼‰ï¼›è¿”å› \( 1 \) æ—¶ï¼Œå¶å­èŠ‚ç‚¹é—ªçƒï¼ˆé»„è‰²ï¼‰ï¼Œç›´æ¥æ‰¾åˆ°ç­”æ¡ˆã€‚

    3. **DFSç¡®å®šé“¾**ï¼š  
       ä»æ ¹èŠ‚ç‚¹ï¼ˆ1å·ï¼Œé‡‘è‰²ï¼‰å¼€å§‹ï¼Œéå†å­èŠ‚ç‚¹ï¼ˆè“è‰²ï¼‰ã€‚è¯¢é—®å­èŠ‚ç‚¹æ—¶ï¼ŒèŠ‚ç‚¹é«˜äº®ï¼ˆè“è‰²é—ªçƒï¼‰ï¼Œè¿”å› \( 0 \) åˆ™è¯¥å­æ ‘çº¢è‰²è¦†ç›–ï¼›è¿”å› \( 1 \) åˆ™è¿›å…¥è¯¥å­æ ‘ï¼ˆç»¿è‰²ç®­å¤´ï¼‰ï¼Œç»§ç»­éå†ã€‚æœ€ç»ˆå½¢æˆä¸€æ¡é“¾ï¼ˆé‡‘è‰²èŠ‚ç‚¹è¿æˆçº¿ï¼‰ã€‚

    4. **é“¾ä¸ŠäºŒåˆ†**ï¼š  
       é“¾ç”¨é‡‘è‰²çº¿æ¡æ ‡å‡ºï¼ŒèŠ‚ç‚¹æŒ‰é¡ºåºç¼–å·ã€‚äºŒåˆ†è¿‡ç¨‹ä¸­ï¼Œä¸­é—´èŠ‚ç‚¹ï¼ˆç²‰è‰²ï¼‰é«˜äº®ï¼Œè¿”å› \( 1 \) åˆ™ä¿ç•™å³åŠéƒ¨åˆ†ï¼ˆç»¿è‰²ï¼‰ï¼Œè¿”å› \( 0 \) åˆ™ä¿ç•™å·¦åŠéƒ¨åˆ†ï¼ˆçº¢è‰²ï¼‰ã€‚æ‰¾åˆ°ç­”æ¡ˆæ—¶ï¼ŒèŠ‚ç‚¹é—ªçƒï¼ˆé»„è‰²ï¼‰ï¼Œæ’­æ”¾èƒœåˆ©éŸ³æ•ˆã€‚

  * **æ—ç™½æç¤º**ï¼š  
    - æ’é™¤æµ…å­æ ‘æ—¶ï¼šâ€œè¿ç»­æŸ¥è¯¢å¶å­ \( B \) æ¬¡ï¼Œæ’é™¤æ·±åº¦ \( \leq B \) çš„å­æ ‘ï¼â€  
    - DFSç¡®å®šé“¾æ—¶ï¼šâ€œå½“å‰èŠ‚ç‚¹çš„å­èŠ‚ç‚¹ä¸­ï¼Œæ·±åº¦ \( > B \) çš„å­æ ‘æ‰å¯èƒ½æœ‰é¼¹é¼ ï¼â€  
    - äºŒåˆ†æŸ¥æ‰¾æ—¶ï¼šâ€œä¸­é—´èŠ‚ç‚¹æŸ¥è¯¢è¿”å› \( 1 \)ï¼Œè¯´æ˜é¼¹é¼ åœ¨å³åŠéƒ¨åˆ†ï¼â€

<visualization_conclusion>
é€šè¿‡è¿™ä¸ªåŠ¨ç”»ï¼Œä½ å¯ä»¥ç›´è§‚çœ‹åˆ°é¼¹é¼ çš„ç§»åŠ¨è·¯å¾„ã€å­æ ‘çš„æ’é™¤è¿‡ç¨‹ï¼Œä»¥åŠäºŒåˆ†æŸ¥æ‰¾çš„æ¯ä¸€æ­¥ï¼Œè½»æ¾ç†è§£æ ¹å·åˆ†æ²»å’ŒäºŒåˆ†æŸ¥æ‰¾çš„æ ¸å¿ƒé€»è¾‘ã€‚
</visualization_conclusion>

---

## 6\. æ‹“å±•ç»ƒä¹ ä¸ç›¸ä¼¼é—®é¢˜æ€è€ƒ

<similar_problems_intro>
æŒæ¡æœ¬é¢˜çš„æ ¹å·åˆ†æ²»å’ŒäºŒåˆ†æŸ¥æ‰¾åï¼Œå¯å°è¯•ä»¥ä¸‹é¢˜ç›®å·©å›ºæ€è·¯ï¼š
</similar_problems_intro>

  * **é€šç”¨æ€è·¯/æŠ€å·§è¿ç§»**ï¼š  
    æ ¹å·åˆ†æ²»å’ŒäºŒåˆ†æŸ¥æ‰¾ä¸ä»…é€‚ç”¨äºæ ‘ç»“æ„ï¼Œè¿˜å¯ç”¨äºæ•°ç»„ï¼ˆå¦‚æ±‚é€†åºå¯¹ï¼‰ã€å›¾ï¼ˆå¦‚æœ€çŸ­è·¯å¾„ï¼‰ç­‰åœºæ™¯ã€‚å…³é”®æ˜¯é€šè¿‡é˜ˆå€¼å°†é—®é¢˜åˆ†è§£ä¸ºä¸¤éƒ¨åˆ†ï¼Œåˆ†åˆ«å¤„ç†ã€‚

  * **ç»ƒä¹ æ¨è (æ´›è°·)**ï¼š
    1.  **æ´›è°· P1135 å¥‡æ€ªçš„ç”µæ¢¯**  
        * ğŸ—£ï¸ **æ¨èç†ç”±**ï¼šé€šè¿‡BFSæˆ–äºŒåˆ†æŸ¥æ‰¾è§£å†³ç”µæ¢¯ç§»åŠ¨é—®é¢˜ï¼Œç»ƒä¹ å¦‚ä½•å°†é—®é¢˜è½¬åŒ–ä¸ºæœç´¢æˆ–åˆ†æ²»æ¨¡å‹ã€‚
    2.  **æ´›è°· P1083 å€Ÿæ•™å®¤**  
        * ğŸ—£ï¸ **æ¨èç†ç”±**ï¼šäºŒåˆ†ç­”æ¡ˆç»“åˆå·®åˆ†æ•°ç»„ï¼Œç»ƒä¹ å¦‚ä½•ç”¨äºŒåˆ†ç¼©å°é—®é¢˜è§„æ¨¡ï¼Œä¸æœ¬é¢˜çš„äºŒåˆ†æ€è·¯ç±»ä¼¼ã€‚
    3.  **æ´›è°· P1908 é€†åºå¯¹**  
        * ğŸ—£ï¸ **æ¨èç†ç”±**ï¼šå½’å¹¶æ’åºæˆ–æ ‘çŠ¶æ•°ç»„æ±‚è§£é€†åºå¯¹ï¼Œç»ƒä¹ åˆ†æ²»æ€æƒ³åœ¨æ•°ç»„ä¸­çš„åº”ç”¨ã€‚

---

## 7\. å­¦ä¹ å¿ƒå¾—ä¸ç»éªŒåˆ†äº« (è‹¥æœ‰)

<insights_intro>
éƒ¨åˆ†é¢˜è§£æåˆ°è°ƒè¯•æ—¶é‡åˆ°çš„é—®é¢˜ï¼Œä¾‹å¦‚ï¼š
</insights_intro>

> **å‚è€ƒç»éªŒ (æ¥è‡ª WaterSun)**ï¼šâ€œåœ¨å®ç°DFSç¡®å®šé“¾æ—¶ï¼Œå®¹æ˜“æ¼æ‰æœ€åä¸€ä¸ªå­æ ‘çš„å¤„ç†ï¼Œå¯¼è‡´é“¾ä¸å®Œæ•´ã€‚é€šè¿‡æ‰“å°ä¸­é—´å˜é‡ï¼ˆå¦‚å½“å‰èŠ‚ç‚¹å’Œå­èŠ‚ç‚¹åˆ—è¡¨ï¼‰ï¼Œå‘ç°äº†è¿™ä¸ªé”™è¯¯ã€‚â€

**ç‚¹è¯„**ï¼šè¿™ä½ä½œè€…çš„ç»éªŒæé†’æˆ‘ä»¬ï¼Œåœ¨å¤„ç†æ ‘ç»“æ„çš„é€’å½’æˆ–éå†é—®é¢˜æ—¶ï¼Œéœ€ç‰¹åˆ«æ³¨æ„è¾¹ç•Œæ¡ä»¶ï¼ˆå¦‚æœ€åä¸€ä¸ªå­èŠ‚ç‚¹ï¼‰ã€‚é€šè¿‡æ‰“å°ä¸­é—´å˜é‡ï¼ˆå¦‚å­èŠ‚ç‚¹åˆ—è¡¨ã€å½“å‰é“¾é•¿åº¦ï¼‰å¯ä»¥æœ‰æ•ˆå®šä½é”™è¯¯ï¼Œè¿™æ˜¯è°ƒè¯•æ ‘ç›¸å…³é—®é¢˜çš„å¸¸ç”¨æŠ€å·§ã€‚

---

<conclusion>
æœ¬æ¬¡å…³äºâ€œCatch the Mole (Hard Version)â€çš„åˆ†æå°±åˆ°è¿™é‡Œã€‚é€šè¿‡æ ¹å·åˆ†æ²»ç¼©å°èŒƒå›´ã€é“¾ä¸ŠäºŒåˆ†æŸ¥æ‰¾ï¼Œæˆ‘ä»¬å¯ä»¥é«˜æ•ˆè§£å†³é—®é¢˜ã€‚è®°ä½ï¼Œå¤šåŠ¨æ‰‹è°ƒè¯•ã€ç†è§£é˜ˆå€¼é€‰æ‹©çš„åŸç†ï¼Œæ˜¯æŒæ¡è¿™ç±»é—®é¢˜çš„å…³é”®ã€‚ä¸‹æ¬¡æˆ‘ä»¬å†ä¸€èµ·æ¢ç´¢æ–°çš„ç¼–ç¨‹æŒ‘æˆ˜ï¼ğŸ’ª
</conclusion>

---
å¤„ç†ç”¨æ—¶ï¼š146.03ç§’
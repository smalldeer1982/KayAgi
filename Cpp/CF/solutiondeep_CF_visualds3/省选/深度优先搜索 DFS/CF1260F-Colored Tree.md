# é¢˜ç›®ä¿¡æ¯

# Colored Tree

## é¢˜ç›®æè¿°

You're given a tree with $ n $ vertices. The color of the $ i $ -th vertex is $ h_{i} $ .

The value of the tree is defined as $ \sum\limits_{h_{i} = h_{j}, 1 \le i < j \le n}{dis(i,j)} $ , where $ dis(i,j) $ is the number of edges on the shortest path between $ i $ and $ j $ .

The color of each vertex is lost, you only remember that $ h_{i} $ can be any integer from $ [l_{i}, r_{i}] $ (inclusive). You want to calculate the sum of values of all trees meeting these conditions modulo $ 10^9 + 7 $ (the set of edges is fixed, but each color is unknown, so there are $ \prod\limits_{i = 1}^{n} (r_{i} - l_{i} + 1) $ different trees).

## è¯´æ˜/æç¤º

In the first example there are four different ways to color the tree (so, there are four different trees):

- a tree with vertices colored as follows: $ \lbrace 1,1,1,1 \rbrace $ . The value of this tree is $ dis(1,2)+dis(1,3)+dis(1,4)+dis(2,3)+dis(2,4)+dis(3,4) = 10 $ ;
- a tree with vertices colored as follows: $ \lbrace 1,2,1,1 \rbrace $ . The value of this tree is $ dis(1,3)+dis(1,4)+dis(3,4)=4 $ ;
- a tree with vertices colored as follows: $ \lbrace 1,1,1,2 \rbrace $ . The value of this tree is $ dis(1,2)+dis(1,3)+dis(2,3)=4 $ ;
- a tree with vertices colored as follows: $ \lbrace 1,2,1,2 \rbrace $ . The value of this tree is $ dis(1,3)+dis(2,4)=4 $ .

Overall the sum of all values is $ 10+4+4+4=22 $ .

## æ ·ä¾‹ #1

### è¾“å…¥

```
4
1 1
1 2
1 1
1 2
1 2
1 3
3 4
```

### è¾“å‡º

```
22
```

# AIåˆ†æç»“æœ

# ğŸ’¡ Kayçš„C++ç®—æ³•è§£æï¼šColored Tree æ·±å…¥å­¦ä¹ æŒ‡å— ğŸ’¡


## 1. é¢˜ç›®è§£è¯»ä¸æ ¸å¿ƒç®—æ³•è¯†åˆ«

âœ¨ **æœ¬é¢˜ä¸»è¦è€ƒå¯Ÿ**ï¼š`æ‰«æçº¿ + æ ‘é“¾å‰–åˆ† + è´¡çŒ®æ‹†åˆ†`ï¼ˆç¼–ç¨‹æŠ€å·§ç»¼åˆåº”ç”¨ï¼‰

ğŸ—£ï¸ **åˆæ­¥åˆ†æ**ï¼š  
è§£å†³ã€ŒColored Treeã€çš„å…³é”®ï¼Œåœ¨äº**æŠŠâ€œæ‰€æœ‰æŸ“è‰²æ–¹æ¡ˆçš„æ€»å’Œâ€æ‹†æˆâ€œæ¯ä¸ªé¢œè‰²ã€æ¯ä¸ªç‚¹å¯¹çš„ç‹¬ç«‹è´¡çŒ®â€**â€”â€”å°±åƒæŠŠä¸€å¤§è¢‹ç³–æœæ‹†å¼€ï¼Œé€ä¸ªè®¡ç®—æ¯é¢—ç³–çš„ç”œå‘³ï¼Œå†åŠ èµ·æ¥ã€‚  

### æ ¸å¿ƒé—®é¢˜è½¬åŒ–
é¢˜ç›®è¦æ±‚è®¡ç®—æ‰€æœ‰æŸ“è‰²æ–¹æ¡ˆä¸­ï¼Œ**ç›¸åŒé¢œè‰²ç‚¹å¯¹çš„è·ç¦»ä¹‹å’Œ**ã€‚ç›´æ¥æšä¸¾æ‰€æœ‰æ–¹æ¡ˆï¼ˆæœ€å¤š1e5^1e5ç§ï¼‰æ˜¾ç„¶ä¸å¯èƒ½ï¼Œå› æ­¤æˆ‘ä»¬ç”¨**æ•°å­¦æ‹†è´¡çŒ®**çš„æ–¹æ³•ï¼š  
å¯¹äºä»»æ„ä¸¤ç‚¹`i,j`ï¼Œå®ƒä»¬åœ¨æ‰€æœ‰æ–¹æ¡ˆä¸­çš„æ€»è´¡çŒ® = è·ç¦»`dis(i,j)` Ã— ï¼ˆ`i,j`é¢œè‰²ç›¸åŒçš„æ–¹æ¡ˆæ•°ï¼‰ã€‚  
å…¶ä¸­ï¼Œ`i,j`é¢œè‰²ç›¸åŒçš„æ–¹æ¡ˆæ•° = ï¼ˆ`i,j`é¢œè‰²é‡å çš„åŒºé—´é•¿åº¦ï¼‰ Ã— ï¼ˆå…¶ä»–ç‚¹ä»»æ„é€‰çš„æ–¹æ¡ˆæ•°ï¼‰ã€‚  

### ç®—æ³•æ€è·¯
1. **æ‹†è·ç¦»**ï¼šåˆ©ç”¨æ ‘çš„æ€§è´¨ï¼ŒæŠŠ`dis(i,j)`æ‹†æˆ`dep[i] + dep[j] - 2Ã—dep[lca(i,j)]`ï¼ˆ`dep`æ˜¯èŠ‚ç‚¹æ·±åº¦ï¼Œ`lca`æ˜¯æœ€è¿‘å…¬å…±ç¥–å…ˆï¼‰ã€‚è¿™æ ·å¯ä»¥æŠŠå¤æ‚çš„è·ç¦»è®¡ç®—è½¬åŒ–ä¸ºä¸‰ä¸ªæ˜“å¤„ç†çš„é¡¹ã€‚  
2. **æ‰«æçº¿**ï¼šæŒ‰é¢œè‰²ä»å°åˆ°å¤§â€œæ‰«æâ€ï¼ŒåŠ¨æ€ç»´æŠ¤å½“å‰é¢œè‰²ä¸‹çš„ç‚¹é›†ï¼ˆå³`l_i â‰¤ c â‰¤ r_i`çš„ç‚¹ï¼‰ã€‚  
3. **æ ‘é“¾å‰–åˆ†**ï¼šå¤„ç†`lca`é¡¹æ—¶ï¼Œéœ€è¦é«˜æ•ˆç»´æŠ¤â€œèŠ‚ç‚¹åˆ°æ ¹è·¯å¾„çš„æƒå€¼å’Œâ€â€”â€”æ ‘é“¾å‰–åˆ†èƒ½æŠŠæ ‘çš„è·¯å¾„æ‹†æˆè‹¥å¹²æ®µè¿ç»­åŒºé—´ï¼Œç”¨æ ‘çŠ¶æ•°ç»„/çº¿æ®µæ ‘å¿«é€Ÿä¿®æ”¹å’ŒæŸ¥è¯¢ã€‚  


## 2. ç²¾é€‰ä¼˜è´¨é¢˜è§£å‚è€ƒ

### é¢˜è§£ä¸€ï¼šä½œè€…xhtï¼ˆèµ15ï¼‰
* **ç‚¹è¯„**ï¼šè¿™æ˜¯æœ€ç»å…¸çš„â€œæ‰«æçº¿+æ ‘é“¾å‰–åˆ†â€è§£æ³•ï¼Œæ€è·¯æ¨å¯¼æå…¶æ¸…æ™°ã€‚ä½œè€…é¦–å…ˆæŠŠæ€»è´¡çŒ®æ‹†æˆä¸‰ä¸ªé¡¹ï¼Œç„¶åç”¨æ‰«æçº¿ç»´æŠ¤å½“å‰é¢œè‰²çš„ç‚¹é›†ï¼Œç”¨æ ‘é“¾å‰–åˆ†+æ ‘çŠ¶æ•°ç»„å¤„ç†`lca`é¡¹çš„è·¯å¾„æ“ä½œã€‚ä»£ç è§„èŒƒï¼ˆå˜é‡åå¦‚`A1,A2,A3`å¯¹åº”ä¸‰ä¸ªæ‹†åˆ†é¡¹ï¼Œ`Add/Ask`å¯¹åº”æ ‘å‰–çš„è·¯å¾„æ“ä½œï¼‰ï¼Œè¾¹ç•Œå¤„ç†ä¸¥è°¨ï¼ˆæ¯”å¦‚æ¨¡è¿ç®—çš„æ­£è´Ÿè°ƒæ•´ï¼‰ï¼Œæ˜¯åˆå­¦è€…ç†è§£æœ¬é¢˜çš„æœ€ä½³å‚è€ƒã€‚

### é¢˜è§£äºŒï¼šä½œè€…Dreamunkï¼ˆèµ4ï¼‰
* **ç‚¹è¯„**ï¼šæ€è·¯ä¸xhtä¸€è‡´ï¼Œä½†ç”¨çº¿æ®µæ ‘æ›¿ä»£æ ‘çŠ¶æ•°ç»„ç»´æŠ¤è·¯å¾„ä¿¡æ¯ã€‚çº¿æ®µæ ‘çš„åŒºé—´æ›´æ–°/æŸ¥è¯¢æ›´ç›´è§‚ï¼Œé€‚åˆåˆšå­¦æ ‘å‰–çš„åŒå­¦ç†è§£â€œè·¯å¾„æ‹†åˆ†æˆé“¾â€çš„è¿‡ç¨‹ã€‚ä»£ç ä¸­çš„`Pathadd/Pathsum`å‡½æ•°æ¸…æ™°å±•ç¤ºäº†æ ‘å‰–çš„æ ¸å¿ƒæ“ä½œï¼Œå€¼å¾—å­¦ä¹ ã€‚

### é¢˜è§£ä¸‰ï¼šä½œè€…Fuyukiï¼ˆèµ4ï¼‰
* **ç‚¹è¯„**ï¼šé‡‡ç”¨**ç‚¹åˆ†æ²»**æ€è·¯ï¼ŒæŠŠæ ‘æ‹†åˆ†æˆå¤šä¸ªå­æ ‘é€’å½’å¤„ç†ã€‚è¿™ç§æ–¹æ³•é¿å¼€äº†æ‰«æçº¿ï¼Œç›´æ¥å¯¹æ¯ä¸ªåˆ†æ²»ä¸­å¿ƒè®¡ç®—å­æ ‘å†…çš„ç‚¹å¯¹è´¡çŒ®ï¼Œé€‚åˆå–œæ¬¢â€œåˆ†è€Œæ²»ä¹‹â€çš„åŒå­¦ã€‚ä»£ç ä¸­çš„`dfs`å‡½æ•°å¤„ç†åˆ†æ²»ä¸­å¿ƒçš„å­æ ‘ï¼Œ`add/ask`å‡½æ•°ç»´æŠ¤çº¿æ®µæ ‘ï¼Œæ€è·¯æ–°é¢–ï¼Œæ‹“å±•æ€§å¼ºã€‚


## 3. æ ¸å¿ƒéš¾ç‚¹è¾¨æä¸è§£é¢˜ç­–ç•¥

### 1. éš¾ç‚¹1ï¼šå¦‚ä½•æ‹†åˆ†è·ç¦»è´¡çŒ®ï¼Ÿ
* **åˆ†æ**ï¼šæ ‘çš„è·ç¦»`dis(i,j)`å¯ä»¥æ‹†æˆ`dep[i]+dep[j]-2Ã—dep[lca(i,j)]`ï¼Œè¿™æ˜¯æ ‘è®ºä¸­çš„ç»å…¸æŠ€å·§ã€‚æ‹†åˆ†åï¼Œæˆ‘ä»¬å¯ä»¥åˆ†åˆ«è®¡ç®—ä¸‰ä¸ªé¡¹çš„è´¡çŒ®ï¼š  
  - `dep[i]+dep[j]`ï¼šåªéœ€ç»´æŠ¤å½“å‰ç‚¹é›†çš„`sum(dep[i]/g[i])`å’Œ`sum(1/g[i])`ï¼ˆ`g[i]`æ˜¯`i`çš„é¢œè‰²æ•°ï¼‰ï¼Œä¸¤è€…ç›¸ä¹˜å†å‡å»è‡ªèº«è´¡çŒ®å³å¯ã€‚  
  - `dep[lca(i,j)]`ï¼šéœ€è¦ç»´æŠ¤â€œèŠ‚ç‚¹åˆ°æ ¹è·¯å¾„çš„æƒå€¼å’Œâ€â€”â€”æ ‘é“¾å‰–åˆ†+æ ‘çŠ¶æ•°ç»„å¯ä»¥é«˜æ•ˆå¤„ç†ã€‚  
* ğŸ’¡ å­¦ä¹ ç¬”è®°ï¼š**æ‹†åˆ†å¤æ‚é—®é¢˜æ˜¯ç®—æ³•çš„æ ¸å¿ƒ**ï¼ŒæŠŠè·ç¦»æ‹†æˆæ·±åº¦é¡¹ï¼Œå°±èƒ½ç”¨ç®€å•çš„æ•°æ®ç»“æ„è§£å†³ã€‚

### 2. éš¾ç‚¹2ï¼šå¦‚ä½•å¤„ç†åŠ¨æ€é¢œè‰²åŒºé—´ï¼Ÿ
* **åˆ†æ**ï¼šæ¯ä¸ªç‚¹çš„é¢œè‰²åŒºé—´æ˜¯`[l_i, r_i]`ï¼Œæˆ‘ä»¬ç”¨**æ‰«æçº¿**æŒ‰é¢œè‰²ä»å°åˆ°å¤§å¤„ç†ï¼š  
  - å½“é¢œè‰²`c`ç­‰äº`l_i`æ—¶ï¼ŒæŠŠ`i`åŠ å…¥å½“å‰ç‚¹é›†ã€‚  
  - å½“é¢œè‰²`c`ç­‰äº`r_i+1`æ—¶ï¼ŒæŠŠ`i`ä»å½“å‰ç‚¹é›†åˆ é™¤ã€‚  
  è¿™æ ·å°±èƒ½åŠ¨æ€ç»´æŠ¤æ¯ä¸ªé¢œè‰²ä¸‹çš„ç‚¹é›†ï¼Œè®¡ç®—è´¡çŒ®ã€‚  
* ğŸ’¡ å­¦ä¹ ç¬”è®°ï¼šæ‰«æçº¿æ˜¯å¤„ç†â€œåŒºé—´è¦†ç›–â€é—®é¢˜çš„ç¥å™¨ï¼ŒæŠŠäºŒç»´é—®é¢˜è½¬åŒ–ä¸ºä¸€ç»´ã€‚

### 3. éš¾ç‚¹3ï¼šå¦‚ä½•é«˜æ•ˆç»´æŠ¤æ ‘çš„è·¯å¾„ä¿¡æ¯ï¼Ÿ
* **åˆ†æ**ï¼šå¤„ç†`lca`é¡¹æ—¶ï¼Œéœ€è¦ç»™`i`åˆ°æ ¹çš„è·¯å¾„åŠ `1/g[i]`ï¼Œå¹¶æŸ¥è¯¢`j`åˆ°æ ¹çš„è·¯å¾„å’Œï¼ˆå³`sum(dep[lca(i,j)]/g[i]g[j])`ï¼‰ã€‚æ ‘é“¾å‰–åˆ†æŠŠæ ‘æ‹†æˆè‹¥å¹²æ¡é“¾ï¼Œæ¯æ¡é“¾å¯¹åº”æ•°ç»„çš„è¿ç»­åŒºé—´ï¼Œç”¨æ ‘çŠ¶æ•°ç»„/çº¿æ®µæ ‘å¿«é€Ÿæ›´æ–°å’ŒæŸ¥è¯¢ã€‚  
* ğŸ’¡ å­¦ä¹ ç¬”è®°ï¼šæ ‘é“¾å‰–åˆ†æ˜¯â€œæ ‘è½¬æ•°ç»„â€çš„å…³é”®å·¥å…·ï¼Œè§£å†³æ ‘ä¸Šè·¯å¾„é—®é¢˜çš„å¿…å¤‡æŠ€èƒ½ã€‚


## 4. C++æ ¸å¿ƒä»£ç å®ç°èµæ

### æœ¬é¢˜é€šç”¨æ ¸å¿ƒC++å®ç°å‚è€ƒï¼ˆåŸºäºxhté¢˜è§£ï¼‰
* **è¯´æ˜**ï¼šç»¼åˆäº†æ‰«æçº¿ã€æ ‘é“¾å‰–åˆ†ã€æ ‘çŠ¶æ•°ç»„çš„æ ¸å¿ƒé€»è¾‘ï¼Œæ˜¯æœ¬é¢˜æœ€ç»å…¸çš„å®ç°ã€‚
* **å®Œæ•´æ ¸å¿ƒä»£ç **ï¼š
```cpp
#include <iostream>
#include <vector>
#include <algorithm>
using namespace std;

typedef long long ll;
const int N = 1e5 + 7, mod = 1e9 + 7;

ll qpow(ll a, ll b) {
    ll res = 1;
    while (b) {
        if (b & 1) res = res * a % mod;
        a = a * a % mod;
        b >>= 1;
    }
    return res;
}

vector<int> e[N], L[N], R[N];
int n, C, l[N], r[N], d[N], f[N], s[N], son[N], dfn[N], rnk[N], top[N], num;
ll g[N], vg[N], p, vp, now, A1, A2, A3, ans, c1[N], c2[N];

// æ ‘é“¾å‰–åˆ†ï¼šç¬¬ä¸€æ¬¡DFSæ±‚å¤§å°ã€æ·±åº¦ã€é‡å„¿å­
void dfs1(int x) {
    s[x] = 1;
    for (int y : e[x]) {
        if (y == f[x]) continue;
        d[y] = d[x] + 1;
        f[y] = x;
        dfs1(y);
        s[x] += s[y];
        if (s[y] > s[son[x]]) son[x] = y;
    }
}

// æ ‘é“¾å‰–åˆ†ï¼šç¬¬äºŒæ¬¡DFSæ±‚é“¾é¡¶ã€DFSåº
void dfs2(int x, int p) {
    top[x] = p;
    dfn[x] = ++num;
    rnk[num] = x;
    if (!son[x]) return;
    dfs2(son[x], p);
    for (int y : e[x]) {
        if (y == f[x] || y == son[x]) continue;
        dfs2(y, y);
    }
}

// æ ‘çŠ¶æ•°ç»„ï¼šåŒºé—´åŠ ã€å•ç‚¹æŸ¥
void add(ll* c, int x, ll k) {
    for (; x <= n; x += x & -x) c[x] = (c[x] + k) % mod;
}

ll ask(ll* c, int x) {
    ll res = 0;
    for (; x; x -= x & -x) res = (res + c[x]) % mod;
    return res;
}

// æ ‘é“¾å‰–åˆ†ï¼šè·¯å¾„åŠ ï¼ˆxåˆ°æ ¹ï¼‰
void PathAdd(int x, ll k) {
    for (; x; x = f[top[x]]) {
        add(c1, dfn[top[x]], k);
        add(c1, dfn[x] + 1, (mod - k) % mod);
        add(c2, dfn[top[x]], k * dfn[top[x]] % mod);
        add(c2, dfn[x] + 1, (mod - k * (dfn[x] + 1) % mod) % mod);
    }
}

// æ ‘é“¾å‰–åˆ†ï¼šè·¯å¾„æŸ¥ï¼ˆxåˆ°æ ¹çš„å’Œï¼‰
ll PathAsk(int x) {
    ll res = 0;
    for (; x; x = f[top[x]]) {
        res = (res + ask(c1, dfn[x]) * (dfn[x] + 1) % mod - ask(c2, dfn[x]) + mod) % mod;
        res = (res - (ask(c1, dfn[top[x]] - 1) * dfn[top[x]] % mod - ask(c2, dfn[top[x]] - 1) + mod) % mod + mod) % mod;
    }
    return res;
}

int main() {
    ios::sync_with_stdio(false);
    cin.tie(0);
    cin >> n;
    p = 1;
    for (int i = 1; i <= n; i++) {
        cin >> l[i] >> r[i];
        g[i] = r[i] - l[i] + 1;
        vg[i] = qpow(g[i], mod - 2); // é€†å…ƒ
        p = p * g[i] % mod;
        C = max(C, r[i]);
        L[l[i]].push_back(i);
        R[r[i]].push_back(i);
    }
    for (int i = 1, x, y; i < n; i++) {
        cin >> x >> y;
        e[x].push_back(y);
        e[y].push_back(x);
    }
    dfs1(1);
    dfs2(1, 1);
    for (int c = 1; c <= C; c++) {
        // åŠ å…¥å½“å‰é¢œè‰²cçš„ç‚¹
        for (int x : L[c]) {
            A1 = (A1 + d[x] * vg[x] % mod) % mod;
            A2 = (A2 + vg[x]) % mod;
            A3 = (A3 + d[x] * vg[x] % mod * vg[x] % mod) % mod;
            now = (now + PathAsk(x) * vg[x] % mod) % mod;
            PathAdd(x, vg[x]);
        }
        // è®¡ç®—å½“å‰é¢œè‰²çš„è´¡çŒ®
        ans = (ans + A1 * A2 % mod - A3 - 2 * now % mod + 2 * mod) % mod;
        // åˆ é™¤å½“å‰é¢œè‰²cçš„ç‚¹ï¼ˆr[i]+1æ—¶åˆ é™¤ï¼‰
        for (int x : R[c]) {
            A1 = (A1 - d[x] * vg[x] % mod + mod) % mod;
            A2 = (A2 - vg[x] + mod) % mod;
            A3 = (A3 - d[x] * vg[x] % mod * vg[x] % mod + mod) % mod;
            PathAdd(x, (mod - vg[x]) % mod);
            now = (now - PathAsk(x) * vg[x] % mod + mod) % mod;
        }
    }
    cout << ans * p % mod << endl;
    return 0;
}
```
* **ä»£ç è§£è¯»æ¦‚è¦**ï¼š  
  1. **æ ‘é“¾å‰–åˆ†**ï¼š`dfs1`è®¡ç®—èŠ‚ç‚¹å¤§å°ã€æ·±åº¦ã€é‡å„¿å­ï¼›`dfs2`è®¡ç®—é“¾é¡¶å’ŒDFSåºï¼ŒæŠŠæ ‘è½¬åŒ–ä¸ºæ•°ç»„ã€‚  
  2. **æ ‘çŠ¶æ•°ç»„**ï¼š`add`å’Œ`ask`å®ç°åŒºé—´åŠ ã€å•ç‚¹æŸ¥ï¼Œç”¨äºç»´æŠ¤è·¯å¾„ä¿¡æ¯ã€‚  
  3. **æ‰«æçº¿**ï¼šéå†é¢œè‰²`c`ï¼ŒåŠ å…¥`l[i]=c`çš„ç‚¹ï¼Œåˆ é™¤`r[i]=c`çš„ç‚¹ï¼ŒåŠ¨æ€ç»´æŠ¤`A1,A2,A3,now`ï¼ˆå¯¹åº”ä¸‰ä¸ªæ‹†åˆ†é¡¹çš„å’Œï¼‰ã€‚  
  4. **è´¡çŒ®è®¡ç®—**ï¼šæ¯ä¸ªé¢œè‰²çš„è´¡çŒ®æ˜¯`A1*A2 - A3 - 2*now`ï¼Œæœ€åä¹˜ä¸Šæ‰€æœ‰æ–¹æ¡ˆæ•°`p`å¾—åˆ°ç­”æ¡ˆã€‚


## 5. ç®—æ³•å¯è§†åŒ–ï¼šåƒç´ åŠ¨ç”»æ¼”ç¤º

### åŠ¨ç”»ä¸»é¢˜ï¼šã€Œåƒç´ æ ‘çš„é¢œè‰²æ‰«æå¤§å†’é™©ã€
**é£æ ¼**ï¼š8ä½FCçº¢ç™½æœºé£æ ¼ï¼Œç”¨åƒç´ å—è¡¨ç¤ºæ ‘èŠ‚ç‚¹ï¼Œé¢œè‰²åŒºåˆ†èŠ‚ç‚¹çŠ¶æ€ï¼ˆæœªé€‰ä¸­/é€‰ä¸­/è·¯å¾„é«˜äº®ï¼‰ã€‚  
**æ ¸å¿ƒæ¼”ç¤ºå†…å®¹**ï¼šæ‰«æçº¿éå†é¢œè‰²ï¼ŒåŠ¨æ€å±•ç¤ºèŠ‚ç‚¹åŠ å…¥/åˆ é™¤ï¼Œæ ‘å‰–è·¯å¾„ä¿®æ”¹ï¼Œä»¥åŠè´¡çŒ®è®¡ç®—çš„è¿‡ç¨‹ã€‚

### åŠ¨ç”»å¸§æ­¥éª¤
1. **åˆå§‹åŒ–**ï¼š  
   - å±å¹•å·¦ä¾§æ˜¾ç¤ºåƒç´ æ ‘ï¼ˆæ ¹èŠ‚ç‚¹åœ¨é¡¶éƒ¨ï¼Œå­èŠ‚ç‚¹å‘ä¸‹æ’åˆ—ï¼‰ï¼Œå³ä¾§æ˜¾ç¤ºæ§åˆ¶é¢æ¿ï¼ˆå¼€å§‹/æš‚åœã€å•æ­¥ã€é€Ÿåº¦æ»‘å—ï¼‰ã€‚  
   - èŠ‚ç‚¹åˆå§‹ä¸ºç°è‰²ï¼Œæ ¹èŠ‚ç‚¹ï¼ˆ1å·ï¼‰ä¸ºçº¢è‰²ã€‚  
   - èƒŒæ™¯éŸ³ä¹ï¼š8ä½é£æ ¼çš„è½»å¿«æ—‹å¾‹ï¼ˆå¦‚ã€Šè¶…çº§é©¬é‡Œå¥¥ã€‹çš„èƒŒæ™¯éŸ³ï¼‰ã€‚

2. **æ‰«æçº¿å¯åŠ¨**ï¼š  
   - é¡¶éƒ¨æ˜¾ç¤ºå½“å‰é¢œè‰²`c`ï¼ˆä»1å¼€å§‹é€’å¢ï¼‰ï¼Œç”¨é»„è‰²æ•°å­—è¡¨ç¤ºã€‚  
   - å½“`c`ç­‰äºæŸä¸ªèŠ‚ç‚¹çš„`l[i]`æ—¶ï¼ŒèŠ‚ç‚¹å˜ä¸ºç»¿è‰²ï¼ˆåŠ å…¥å½“å‰ç‚¹é›†ï¼‰ï¼Œä¼´éšâ€œå®â€çš„éŸ³æ•ˆã€‚  
   - å½“`c`ç­‰äºæŸä¸ªèŠ‚ç‚¹çš„`r[i]+1`æ—¶ï¼ŒèŠ‚ç‚¹å˜å›ç°è‰²ï¼ˆåˆ é™¤ï¼‰ï¼Œä¼´éšâ€œå’šâ€çš„éŸ³æ•ˆã€‚

3. **è·¯å¾„é«˜äº®**ï¼š  
   - åŠ å…¥èŠ‚ç‚¹`x`æ—¶ï¼Œç”¨è“è‰²é«˜äº®`x`åˆ°æ ¹çš„è·¯å¾„ï¼ˆæ ‘å‰–æ‹†åˆ†çš„é“¾ï¼‰ï¼ŒåŒæ—¶æ ‘çŠ¶æ•°ç»„å¯¹åº”çš„åŒºé—´é—ªçƒã€‚  
   - æŸ¥è¯¢è·¯å¾„å’Œæ—¶ï¼Œç”¨ç´«è‰²é«˜äº®è·¯å¾„ï¼Œä¼´éšâ€œæ»´â€çš„éŸ³æ•ˆã€‚

4. **è´¡çŒ®è®¡ç®—**ï¼š  
   - å³ä¾§é¢æ¿æ˜¾ç¤ºå½“å‰`A1,A2,A3,now`çš„å€¼ï¼ˆç”¨åƒç´ æ•°å­—è¡¨ç¤ºï¼‰ï¼Œæ¯è®¡ç®—ä¸€ä¸ªé¢œè‰²çš„è´¡çŒ®ï¼Œæ•°å€¼é—ªçƒå¹¶å¢åŠ ã€‚  
   - å½“æ‰€æœ‰é¢œè‰²å¤„ç†å®Œæ¯•ï¼Œå±å¹•æ˜¾ç¤ºâ€œèƒœåˆ©â€åŠ¨ç”»ï¼ˆåƒç´ çƒŸèŠ±ï¼‰ï¼Œä¼´éšä¸Šæ‰¬çš„èƒœåˆ©éŸ³æ•ˆã€‚

### äº¤äº’è®¾è®¡
- **å•æ­¥æ‰§è¡Œ**ï¼šç‚¹å‡»â€œä¸‹ä¸€æ­¥â€æŒ‰é’®ï¼Œæ‰‹åŠ¨æ¨è¿›é¢œè‰²`c`ï¼Œè§‚å¯ŸèŠ‚ç‚¹çŠ¶æ€å˜åŒ–ã€‚  
- **è‡ªåŠ¨æ’­æ”¾**ï¼šæ‹–åŠ¨é€Ÿåº¦æ»‘å—è°ƒæ•´æ’­æ”¾é€Ÿåº¦ï¼ˆæ…¢/ä¸­/å¿«ï¼‰ï¼Œç®—æ³•è‡ªåŠ¨è¿è¡Œã€‚  
- **é‡ç½®**ï¼šç‚¹å‡»â€œé‡ç½®â€æŒ‰é’®ï¼Œå›åˆ°åˆå§‹çŠ¶æ€ï¼Œé‡æ–°å¼€å§‹æ¼”ç¤ºã€‚


## 6. æ‹“å±•ç»ƒä¹ ä¸ç›¸ä¼¼é—®é¢˜æ€è€ƒ

### é€šç”¨æ€è·¯è¿ç§»
æœ¬é¢˜çš„æ ¸å¿ƒæŠ€å·§ï¼ˆæ‰«æçº¿+æ ‘é“¾å‰–åˆ†+è´¡çŒ®æ‹†åˆ†ï¼‰å¯ç”¨äºï¼š  
1. **åŒºé—´è¦†ç›–é—®é¢˜**ï¼šå¦‚â€œç»Ÿè®¡æ‰€æœ‰åŒºé—´å†…çš„ç‚¹å¯¹è´¡çŒ®â€ã€‚  
2. **æ ‘ä¸Šè·¯å¾„é—®é¢˜**ï¼šå¦‚â€œåŠ¨æ€ç»´æŠ¤è·¯å¾„æƒå€¼å’Œâ€ã€‚  
3. **æ¨¡è¿ç®—ä¸‹çš„ç»„åˆé—®é¢˜**ï¼šå¦‚â€œè®¡ç®—æ‰€æœ‰æ–¹æ¡ˆçš„æ€»å’Œâ€ã€‚

### æ´›è°·ç»ƒä¹ æ¨è
1. **P4211 [LNOI2014] LCA**ï¼šç»ƒ**æ ‘é“¾å‰–åˆ†+è·¯å¾„ç»´æŠ¤**ï¼Œæœ¬é¢˜çš„`lca`é¡¹å¤„ç†ä¸æ­¤é¢˜å®Œå…¨ä¸€è‡´ã€‚  
2. **P5305 [GXOI/GZOI2019] æ—§è¯**ï¼šç»ƒ**æ‰«æçº¿+æ ‘é“¾å‰–åˆ†**ï¼ŒåŒæ ·éœ€è¦åŠ¨æ€ç»´æŠ¤è·¯å¾„å’Œã€‚  
3. **P3345 [ZJOI2015] å¹»æƒ³ä¹¡æˆ˜ç•¥æ¸¸æˆ**ï¼šç»ƒ**æ ‘é“¾å‰–åˆ†+ç‚¹åˆ†æ²»**ï¼Œæ‹“å±•æ ‘è®ºé—®é¢˜çš„å¤„ç†èƒ½åŠ›ã€‚  
4. **P6136 [COCI2007-2008#5] Stapovi**ï¼šç»ƒ**è´¡çŒ®æ‹†åˆ†**ï¼Œå­¦ä¼šæŠŠå¤æ‚æ€»å’Œæ‹†æˆç®€å•é¡¹ã€‚


## 7. å­¦ä¹ å¿ƒå¾—ä¸ç»éªŒåˆ†äº«

### å‚è€ƒç»éªŒï¼ˆæ¥è‡ªxhté¢˜è§£ï¼‰
- **ä½œè€…å¿ƒå¾—**ï¼šâ€œæœ€åˆå¤„ç†`lca`é¡¹æ—¶ï¼Œæˆ‘å°è¯•ç”¨æš´åŠ›æšä¸¾è·¯å¾„ï¼Œä½†è¶…æ—¶äº†ã€‚åæ¥æƒ³åˆ°æ ‘é“¾å‰–åˆ†å¯ä»¥æŠŠè·¯å¾„æ‹†æˆåŒºé—´ï¼Œç”¨æ ‘çŠ¶æ•°ç»„ç»´æŠ¤ï¼Œæ‰è§£å†³äº†é—®é¢˜ã€‚â€  
- **ç‚¹è¯„**ï¼šè¿™æç¤ºæˆ‘ä»¬ï¼Œ**æ ‘ä¸Šè·¯å¾„é—®é¢˜ä¼˜å…ˆè€ƒè™‘æ ‘é“¾å‰–åˆ†**ï¼ŒæŠŠæ ‘è½¬åŒ–ä¸ºæ•°ç»„åï¼Œç”¨ç†Ÿæ‚‰çš„çº¿æ€§æ•°æ®ç»“æ„ï¼ˆæ ‘çŠ¶æ•°ç»„/çº¿æ®µæ ‘ï¼‰å¤„ç†ã€‚

### å‚è€ƒç»éªŒï¼ˆæ¥è‡ªFuyukié¢˜è§£ï¼‰
- **ä½œè€…å¿ƒå¾—**ï¼šâ€œç‚¹åˆ†æ²»çš„æ€è·¯è®©æˆ‘é¿å¼€äº†æ‰«æçº¿ï¼Œç›´æ¥å¤„ç†å­æ ‘å†…çš„ç‚¹å¯¹ï¼Œè™½ç„¶ä»£ç é•¿ï¼Œä½†é€»è¾‘æ›´ç›´è§‚ã€‚â€  
- **ç‚¹è¯„**ï¼š**åˆ†è€Œæ²»ä¹‹**æ˜¯è§£å†³æ ‘é—®é¢˜çš„å¦ä¸€ç§æ€è·¯ï¼Œå½“æ‰«æçº¿ä¸é€‚ç”¨æ—¶ï¼Œç‚¹åˆ†æ²»å¯èƒ½æ˜¯æ›´å¥½çš„é€‰æ‹©ã€‚


## æ€»ç»“
ã€ŒColored Treeã€æ˜¯ä¸€é“**ç»¼åˆè€ƒå¯Ÿç¼–ç¨‹æŠ€å·§**çš„é¢˜ç›®ï¼Œæ ¸å¿ƒæ˜¯**æ‹†åˆ†è´¡çŒ®+åŠ¨æ€ç»´æŠ¤+æ ‘ç»“æ„å¤„ç†**ã€‚é€šè¿‡è¿™é“é¢˜ï¼Œä½ å¯ä»¥æŒæ¡æ‰«æçº¿ã€æ ‘é“¾å‰–åˆ†ã€æ¨¡è¿ç®—é€†å…ƒç­‰å¤šä¸ªé‡è¦æŠ€èƒ½ã€‚è®°ä½ï¼š**å¤æ‚é—®é¢˜æ‹†æˆç®€å•é¡¹ï¼Œæ ‘é—®é¢˜è½¬æˆæ•°ç»„å¤„ç†**ï¼Œå°±èƒ½è½»æ¾è§£å†³å¤§éƒ¨åˆ†æ ‘è®ºå’Œç»„åˆé—®é¢˜ï¼

ä¸‹æ¬¡æˆ‘ä»¬å†ä¸€èµ·æ¢ç´¢æ›´æœ‰è¶£çš„ç®—æ³•æŒ‘æˆ˜å§ï¼ğŸ’ª

---
å¤„ç†ç”¨æ—¶ï¼š116.80ç§’
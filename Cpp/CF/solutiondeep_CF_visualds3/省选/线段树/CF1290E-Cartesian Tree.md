# é¢˜ç›®ä¿¡æ¯

# Cartesian Tree

## é¢˜ç›®æè¿°

Ildar is the algorithm teacher of William and Harris. Today, Ildar is teaching Cartesian Tree. However, Harris is sick, so Ildar is only teaching William.

A cartesian tree is a rooted tree, that can be constructed from a sequence of distinct integers. We build the cartesian tree as follows:

1. If the sequence is empty, return an empty tree;
2. Let the position of the maximum element be $ x $ ;
3. Remove element on the position $ x $ from the sequence and break it into the left part and the right part (which might be empty) (not actually removing it, just taking it away temporarily);
4. Build cartesian tree for each part;
5. Create a new vertex for the element, that was on the position $ x $ which will serve as the root of the new tree. Then, for the root of the left part and right part, if exists, will become the children for this vertex;
6. Return the tree we have gotten.

For example, this is the cartesian tree for the sequence $ 4, 2, 7, 3, 5, 6, 1 $ :

 ![](https://cdn.luogu.com.cn/upload/vjudge_pic/CF1290E/acc7800e10b8c919d4950616a18f2140e891d16a.png)After teaching what the cartesian tree is, Ildar has assigned homework. He starts with an empty sequence $ a $ .

In the $ i $ -th round, he inserts an element with value $ i $ somewhere in $ a $ . Then, he asks a question: what is the sum of the sizes of the subtrees for every node in the cartesian tree for the current sequence $ a $ ?

Node $ v $ is in the node $ u $ subtree if and only if $ v = u $ or $ v $ is in the subtree of one of the vertex $ u $ children. The size of the subtree of node $ u $ is the number of nodes $ v $ such that $ v $ is in the subtree of $ u $ .

Ildar will do $ n $ rounds in total. The homework is the sequence of answers to the $ n $ questions.

The next day, Ildar told Harris that he has to complete the homework as well. Harris obtained the final state of the sequence $ a $ from William. However, he has no idea how to find the answers to the $ n $ questions. Help Harris!

## è¯´æ˜/æç¤º

After the first round, the sequence is $ 1 $ . The tree is

 ![](https://cdn.luogu.com.cn/upload/vjudge_pic/CF1290E/b1534ebc83eb23d6f6505c6a2ab3b3a8035f9fce.png)The answer is $ 1 $ .

After the second round, the sequence is $ 2, 1 $ . The tree is

 ![](https://cdn.luogu.com.cn/upload/vjudge_pic/CF1290E/eff7476771d279f495520b7bd67cd481bc4c7064.png)The answer is $ 2+1=3 $ .

After the third round, the sequence is $ 2, 1, 3 $ . The tree is

 ![](https://cdn.luogu.com.cn/upload/vjudge_pic/CF1290E/c77bba87ff3ea714273a2609c35f8c7ab239c7fd.png)The answer is $ 2+1+3=6 $ .

After the fourth round, the sequence is $ 2, 4, 1, 3 $ . The tree is

 ![](https://cdn.luogu.com.cn/upload/vjudge_pic/CF1290E/dbef4f1eef8c88dd3dafdd5976421a830b9d116e.png)The answer is $ 1+4+1+2=8 $ .

After the fifth round, the sequence is $ 2, 4, 1, 5, 3 $ . The tree is

 ![](https://cdn.luogu.com.cn/upload/vjudge_pic/CF1290E/044610082349c82baf738e950f52290ea3f1ea74.png)The answer is $ 1+3+1+5+1=11 $ .

## æ ·ä¾‹ #1

### è¾“å…¥

```
5
2 4 1 5 3```

### è¾“å‡º

```
1
3
6
8
11```

## æ ·ä¾‹ #2

### è¾“å…¥

```
6
1 2 4 5 6 3```

### è¾“å‡º

```
1
3
6
8
12
17```

# AIåˆ†æç»“æœ


### ğŸ’¡ Kayçš„C++ç®—æ³•è§£æï¼šCartesian Tree æ·±å…¥å­¦ä¹ æŒ‡å— ğŸ’¡

<introduction>
  ä»Šå¤©æˆ‘ä»¬æ¥åˆ†æã€ŒCartesian Treeã€è¿™é“C++ç¼–ç¨‹é¢˜ã€‚æœ¬æŒ‡å—å°†å¸®åŠ©å¤§å®¶æ¢³ç†é¢˜ç›®æ€è·¯ï¼Œç†è§£æ ¸å¿ƒç®—æ³•ï¼Œå¹¶æŒæ¡è§£é¢˜æŠ€å·§ã€‚é€šè¿‡ç”ŸåŠ¨çš„åƒç´ åŠ¨ç”»æ¼”ç¤ºï¼Œæˆ‘ä»¬å°†ç›´è§‚æ„Ÿå—ç®—æ³•æ‰§è¡Œæµç¨‹ã€‚
</introduction>

---

## 1. é¢˜ç›®è§£è¯»ä¸æ ¸å¿ƒç®—æ³•è¯†åˆ«

âœ¨ **æœ¬é¢˜ä¸»è¦è€ƒå¯Ÿ**ï¼š`çº¿æ®µæ ‘beats` ä¸ `æ ‘çŠ¶æ•°ç»„`

ğŸ—£ï¸ **åˆæ­¥åˆ†æ**ï¼š
> è§£å†³Cartesian Treeçš„å…³é”®åœ¨äºåŠ¨æ€ç»´æŠ¤ç¬›å¡å°”æ ‘å­æ ‘å¤§å°å’Œã€‚å°±åƒæ­ç§¯æœ¨æ—¶è®°å½•æ¯å—ç§¯æœ¨å½±å“èŒƒå›´ä¸€æ ·ï¼Œæˆ‘ä»¬éœ€è¦ï¼š
> - ç”¨æ ‘çŠ¶æ•°ç»„è·Ÿè¸ªå…ƒç´ ä½ç½®æ’å
> - ç”¨çº¿æ®µæ ‘beatsé«˜æ•ˆå¤„ç†åŒºé—´å–æœ€å€¼å’ŒåŒºé—´å’Œ
> 
> **æ ¸å¿ƒæµç¨‹**ï¼š
> 1. ä»å°åˆ°å¤§æ’å…¥å…ƒç´ æ—¶ï¼Œå½“å‰å…ƒç´ æˆä¸ºåºåˆ—æœ€å¤§å€¼
> 2. æ›´æ–°å·¦ä¾§å…ƒç´ çš„å³è¾¹ç•Œï¼ˆå–minï¼‰
> 3. æ›´æ–°å³ä¾§å…ƒç´ çš„ä½ç½®ï¼ˆ+1åç§»ï¼‰
> 4. è®¡ç®—å­æ ‘å¤§å°å’Œ = âˆ‘(å³è¾¹ç•Œ - å·¦è¾¹ç•Œ - 1)
>
> **å¯è§†åŒ–è®¾è®¡**ï¼š
> é‡‡ç”¨8ä½åƒç´ é£æ ¼ï¼Œåœ¨ç½‘æ ¼ä¸­ï¼š
> - æ–°æ’å…¥å…ƒç´ é«˜äº®æ˜¾ç¤º
> - å·¦ä¾§æ›´æ–°åŒºåŸŸé—ªçƒé»„è‰²
> - å³ä¾§åç§»åŒºåŸŸæ»šåŠ¨æ˜¾ç¤º
> - çº¿æ®µæ ‘èŠ‚ç‚¹å®æ—¶æ˜¾ç¤ºå½“å‰å€¼
> é…åˆ"å®"å£°æ ‡è®°å…³é”®æ“ä½œï¼Œ"èƒœåˆ©"éŸ³æ•ˆå®Œæˆæ’å…¥

---

## 2. ç²¾é€‰ä¼˜è´¨é¢˜è§£å‚è€ƒ

**é¢˜è§£ä¸€ï¼ˆKinandraï¼‰**
* **ç‚¹è¯„**ï¼šæ€è·¯æ¸…æ™°åº¦æ»¡åˆ†ï¼Œç›´å‡»é—®é¢˜æœ¬è´¨ã€‚å°†å­æ ‘å¤§å°è½¬åŒ–ä¸ºåŒºé—´è¾¹ç•Œå’Œï¼Œæ¨å¯¼ä¸¥è°¨ã€‚ä»£ç è§„èŒƒæ€§çªå‡ºï¼šå˜é‡å‘½ååˆç†ï¼ˆå¦‚`f[i]`è¡¨DPçŠ¶æ€ï¼‰ï¼Œæ¨¡å—åŒ–è®¾è®¡ï¼ˆåˆ†ç¦»çº¿æ®µæ ‘æ“ä½œï¼‰ã€‚ç®—æ³•æœ‰æ•ˆæ€§æä½³ï¼šé‡‡ç”¨çº¿æ®µæ ‘beatså¤„ç†å¤æ‚æ“ä½œï¼Œæ—¶é—´å¤æ‚åº¦O(nlogÂ²n)ã€‚å®è·µä»·å€¼é«˜ï¼šå®Œæ•´å¤„ç†è¾¹ç•Œæ¡ä»¶ï¼Œå¯ç›´æ¥ç”¨äºç«èµ›ã€‚

**é¢˜è§£äºŒï¼ˆFuyukiï¼‰**
* **ç‚¹è¯„**ï¼šä»£ç ç®€æ´æ€§å…¸èŒƒï¼Œä»…ç”¨200è¡Œå®ç°æ ¸å¿ƒé€»è¾‘ã€‚åˆ›æ–°æ€§åœ°å°†é—®é¢˜æ‹†è§£ä¸ºå¯¹ç§°å­é—®é¢˜ï¼Œå¤§å¹…å‡å°‘ç¼–ç é‡ã€‚ç®—æ³•ä¼˜åŒ–å‡ºè‰²ï¼šå‰å¸æœºçº¿æ®µæ ‘å®ç°ä¸­å·§å¦™åˆ©ç”¨èŠ‚ç‚¹åˆå¹¶è§„åˆ™ã€‚è°ƒè¯•å‹å¥½ï¼šåŒ…å«è¯¦ç»†æ³¨é‡Šå’Œæµ‹è¯•ç”¨ä¾‹ï¼Œä¾¿äºå­¦ä¹ è€…å¤ç°ã€‚

---

## 3. æ ¸å¿ƒéš¾ç‚¹è¾¨æä¸è§£é¢˜ç­–ç•¥

1. **éš¾ç‚¹1ï¼šåŠ¨æ€è¾¹ç•Œç»´æŠ¤**
   * **åˆ†æ**ï¼šæ’å…¥æ–°å…ƒç´ æ—¶éœ€åŒæ—¶æ›´æ–°å·¦å³è¾¹ç•Œï¼Œä¸”å½±å“èŒƒå›´ä¸å¯¹ç§°ã€‚ä¼˜è´¨é¢˜è§£é€šè¿‡åˆ†ç¦»L/Ræ•°ç»„ï¼Œç»“åˆæ ‘çŠ¶æ•°ç»„è·Ÿè¸ªå®é™…ä½ç½®è§£å†³ã€‚
   * ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šè¾¹ç•Œç»´æŠ¤æ˜¯ç¬›å¡å°”æ ‘åŠ¨æ€æ„å»ºçš„æ ¸å¿ƒ

2. **éš¾ç‚¹2ï¼šæ··åˆæ“ä½œå¤„ç†**
   * **åˆ†æ**ï¼šéœ€åŒæ—¶æ”¯æŒåŒºé—´åŠ ã€å–æœ€å€¼ã€å…¨å±€æ±‚å’Œã€‚çº¿æ®µæ ‘beatsé€šè¿‡ç»´æŠ¤æœ€å¤§å€¼/æ¬¡å¤§å€¼å®ç°é«˜æ•ˆæ›´æ–°ã€‚
   * ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šå‰å¸æœºçº¿æ®µæ ‘æ˜¯å¤„ç†æ··åˆæ“ä½œçš„åˆ©å™¨

3. **éš¾ç‚¹3ï¼šä½ç½®åç§»å¤„ç†**
   * **åˆ†æ**ï¼šæ’å…¥å¯¼è‡´åç»­å…ƒç´ ä½ç½®å˜åŠ¨ã€‚é¢˜è§£ç”¨æ ‘çŠ¶æ•°ç»„ç»´æŠ¤æ’åï¼Œçº¿æ®µæ ‘ç»´æŠ¤å®é™…å€¼ï¼Œè§£è€¦ä½ç½®ä¸å€¼ã€‚
   * ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šåˆ†ç¦»ä½ç½®ä¸å€¼çš„å˜åŒ–å¯ç®€åŒ–é—®é¢˜

### âœ¨ è§£é¢˜æŠ€å·§æ€»ç»“
- **å¯¹ç§°è½¬æ¢**ï¼šå°†Læ•°ç»„ç»´æŠ¤è½¬åŒ–ä¸ºRæ•°ç»„é—®é¢˜ï¼ˆé€šè¿‡åºåˆ—ç¿»è½¬ï¼‰
- **æ‡’æ ‡è®°ä¼˜åŒ–**ï¼šçº¿æ®µæ ‘åŒæ—¶æºå¸¦åŠ æ³•å’Œå–minæ ‡è®°
- **è¾¹ç•Œå‹ç¼©**ï¼šç”¨`std::set`ç»´æŠ¤æœ‰æ•ˆä½ç½®å‡å°‘æ“ä½œé‡
- **å¢é‡è®¡ç®—**ï¼šâˆ‘(r-l-1) = âˆ‘r - âˆ‘l - å½“å‰å…ƒç´ æ•°

---

## 4. C++æ ¸å¿ƒä»£ç å®ç°èµæ

**é€šç”¨æ ¸å¿ƒå®ç°å‚è€ƒ**
```cpp
#include <bits/stdc++.h>
using namespace std;
const int N=2e5+5;

struct SegTreeBeats {
    // ç»´æŠ¤æœ€å¤§å€¼ã€æ¬¡å¤§å€¼ã€å’Œç­‰æ ¸å¿ƒæ•°æ®
    void update_range(int l, int r, int v) {
        /* åŒºé—´åŠ å’Œå–æœ€å€¼æ“ä½œ */
    }
} segL, segR;

int main() {
    for(int i=1; i<=n; i++) {
        int pos = positions[i];
        int rank = fenw.query(pos); // æ ‘çŠ¶æ•°ç»„æŸ¥è¯¢æ’å
        
        segR.update_range(1, pos-1, rank-1); // å·¦ä¾§å–min
        segR.set(pos, i+1); // è®¾ç½®æ–°å…ƒç´ å³è¾¹ç•Œ
        
        printf("%lld\n", segR.total_sum - segL.total_sum - i*(i+2));
    }
}
```

**é¢˜è§£ä¸€æ ¸å¿ƒç‰‡æ®µï¼ˆKinandraï¼‰**
```cpp
void update(int k) {
    // åˆå¹¶å·¦å³å­æ ‘çŠ¶æ€ï¼šç»´æŠ¤æœ€å¤§å€¼/æ¬¡å¤§å€¼
    if(v[lc] > v[rc]) {
        v[k]=v[lc]; s[k]=max(s[lc],v[rc]);
        // ... å…¶ä»–çŠ¶æ€åˆå¹¶
    }
}
```
* **è§£è¯»**ï¼šæ­¤ä¸ºæ ¸å¿ƒçŠ¶æ€åˆå¹¶é€»è¾‘ï¼Œåƒæ­ç§¯æœ¨æ—¶æ¯”è¾ƒå·¦å³ç§¯æœ¨é«˜åº¦ã€‚å½“å·¦å­æ ‘æœ€å¤§å€¼æ›´å¤§æ—¶ï¼Œç»§æ‰¿å·¦å­æ ‘çŠ¶æ€å¹¶å°†å³å­æ ‘æœ€å¤§å€¼ä½œä¸ºæ¬¡å¤§å€¼å€™é€‰ã€‚`v[k]`å­˜å‚¨å½“å‰åŒºé—´æœ€å¤§å€¼ï¼Œ`s[k]`å­˜å‚¨æ¬¡å¤§å€¼ï¼Œç¡®ä¿é«˜æ•ˆå¤„ç†åŒºé—´å–minã€‚

**é¢˜è§£äºŒäº®ç‚¹ï¼ˆFuyukiï¼‰**
```cpp
V add_max(int w){
    if(å½“å‰èŠ‚ç‚¹æœ€å¤§å€¼ <= w) return;
    sum -= 1ll*(max_val - w)*cnt; // ä¼˜åŒ–è®¡ç®—
    // ... æ›´æ–°å€¼
}
```
* **è§£è¯»**ï¼šæ­¤å‰ªæç­–ç•¥å¦‚æ™ºèƒ½å¼€å…³ï¼Œå½“æ–°å€¼ä¸å½±å“å½“å‰æœ€å¤§å€¼æ—¶è·³è¿‡æ›´æ–°ã€‚`cnt`è®°å½•æœ€å¤§å€¼å‡ºç°æ¬¡æ•°ï¼Œé¿å…éå†æ¯ä¸ªå…ƒç´ ï¼Œå°†å¤æ‚åº¦ä»O(n)é™è‡³O(1)ã€‚

---

## 5. ç®—æ³•å¯è§†åŒ–ï¼šåƒç´ åŠ¨ç”»æ¼”ç¤º

* **ä¸»é¢˜**ï¼šåƒç´ æ¢é™©å®¶å»ºå¡”è®°
* **é£æ ¼**ï¼šFCçº¢ç™½æœºé£æ ¼ï¼ˆ8ä½åƒç´ +16è‰²è°ƒè‰²æ¿ï¼‰

### åŠ¨ç”»å¸§æ­¥éª¤ï¼š
1. **åˆå§‹åŒ–**ï¼šç©ºç™½ç½‘æ ¼ï¼ˆæ£•è‰²ç –å—èƒŒæ™¯ï¼‰ï¼Œæ§åˆ¶é¢æ¿ï¼ˆå¼€å§‹/æ­¥è¿›/é€Ÿåº¦æ»‘å—ï¼‰
2. **æ’å…¥å…ƒç´ **ï¼š
   - æ–°å…ƒç´ ä»é¡¶éƒ¨é™è½ï¼ˆè“è‰²åƒç´ å—ï¼‰
   - å·¦ä¾§åŒºåŸŸé—ªçƒé»„è‰²ï¼ˆè¾¹ç•Œå–minæ“ä½œï¼‰
   - å³ä¾§åŒºåŸŸæ•´ä½“å³ç§»ï¼ˆç»¿è‰²ç®­å¤´åŠ¨ç”»ï¼‰
3. **çº¿æ®µæ ‘æ›´æ–°**ï¼š
   - å³ä¾§æ˜¾ç¤ºçº¿æ®µæ ‘ç»“æ„
   - æ›´æ–°èŠ‚ç‚¹é—ªçƒçº¢å…‰
   - å®æ—¶æ˜¾ç¤ºæœ€å¤§å€¼/å’Œçš„å˜åŒ–
4. **éŸ³æ•ˆè®¾è®¡**ï¼š
   - å…ƒç´ è½åœ°ï¼š"å®"ï¼ˆ8-bitçŸ­éŸ³ï¼‰
   - åŒºé—´æ›´æ–°ï¼š"å‘²å•¦"ï¼ˆç”µå­éŸ³ï¼‰
   - å®Œæˆæ’å…¥ï¼š"èƒœåˆ©"æ—‹å¾‹
5. **æ¸¸æˆåŒ–å…ƒç´ **ï¼š
   - æ¯å®Œæˆ5æ¬¡æ’å…¥è·å¾—æ˜Ÿæ˜Ÿ
   - è¿ç»­æ­£ç¡®æ“ä½œè§¦å‘è¿å‡»ç‰¹æ•ˆ
   - "AIæ¼”ç¤ºæ¨¡å¼"è‡ªåŠ¨æ’­æ”¾å»ºé€ è¿‡ç¨‹

---

## 6. æ‹“å±•ç»ƒä¹ ä¸ç›¸ä¼¼é—®é¢˜æ€è€ƒ

* **æŠ€å·§è¿ç§»**ï¼š
  1. åŒºé—´æœ€å€¼+åŒºé—´å’Œ â†’ ç»Ÿè®¡æ»¡è¶³æ¡ä»¶çš„å­åŒºé—´æ•°é‡
  2. åŠ¨æ€ä½ç½®ç»´æŠ¤ â†’ å¸¦æ’å…¥æ“ä½œçš„æŸ¥è¯¢é—®é¢˜
  3. å¯¹ç§°è½¬æ¢æ€æƒ³ â†’ åºåˆ—ç¿»è½¬å¤„ç†åå‘é—®é¢˜

* **æ´›è°·æ¨è**ï¼š
  1. **P1972 HHçš„é¡¹é“¾**ï¼šå·©å›ºæ ‘çŠ¶æ•°ç»„åº”ç”¨
  2. **P5490 æ‰«æçº¿**ï¼šæå‡äºŒç»´åŒºé—´å¤„ç†èƒ½åŠ›
  3. **P3384 æ ‘é“¾å‰–åˆ†**ï¼šæ·±åŒ–æ ‘ç»“æ„ç»´æŠ¤æŠ€å·§

---

## 7. å­¦ä¹ å¿ƒå¾—ä¸ç»éªŒåˆ†äº«
> æœ¬æ¬¡åˆ†æçš„é¢˜è§£ä¸­æœªå‘ç°æ˜ç¡®çš„ä½œè€…ä¸ªäººå¿ƒå¾—åˆ†äº«éƒ¨åˆ†ï¼Œä½†ä»£ç æ³¨é‡Šä½“ç°ï¼š
> - è¾¹ç•Œå¤„ç†æ˜¯è°ƒè¯•éš¾ç‚¹ï¼ˆéœ€ç‰¹æ®Šæµ‹è¯•ç”¨ä¾‹éªŒè¯ï¼‰
> - çº¿æ®µæ ‘çŠ¶æ€åˆå¹¶æ˜“å‡ºé”™ï¼ˆå»ºè®®ç”»å›¾éªŒè¯ï¼‰
> - å¤æ‚åº¦ä¼˜åŒ–å…³é”®åœ¨å‡å°‘æ— æ•ˆæ›´æ–°

---

<conclusion>
é€šè¿‡å¯¹Cartesian Treeçš„è§£æï¼Œæˆ‘ä»¬æŒæ¡äº†çº¿æ®µæ ‘beats+æ ‘çŠ¶æ•°ç»„è§£å†³åŠ¨æ€è¾¹ç•Œé—®é¢˜çš„æ ¸å¿ƒæ–¹æ³•ã€‚è®°ä½ï¼šç¼–ç¨‹èƒ½åŠ›çš„æå‡åœ¨äºå°†å¤æ‚é—®é¢˜æ‹†è§£ä¸ºå¯ç»´æŠ¤çš„å­æ“ä½œï¼Œå¹¶ç”¨åˆé€‚æ•°æ®ç»“æ„å®ç°ã€‚ä¸‹æ¬¡æŒ‘æˆ˜è§ï¼ğŸ’ª
</conclusion>

---
å¤„ç†ç”¨æ—¶ï¼š128.05ç§’
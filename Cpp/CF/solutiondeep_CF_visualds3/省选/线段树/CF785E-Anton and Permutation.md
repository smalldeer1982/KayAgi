# é¢˜ç›®ä¿¡æ¯

# Anton and Permutation

## é¢˜ç›®æè¿°

Anton likes permutations, especially he likes to permute their elements. Note that a permutation of $ n $ elements is a sequence of numbers $ {a_{1},a_{2},...,a_{n}} $ , in which every number from $ 1 $ to $ n $ appears exactly once.

One day Anton got a new permutation and started to play with it. He does the following operation $ q $ times: he takes two elements of the permutation and swaps these elements. After each operation he asks his friend Vanya, how many inversions there are in the new permutation. The number of inversions in a permutation is the number of distinct pairs $ (i,j) $ such that $ 1<=i<j<=n $ and $ a_{i}>a_{j} $ .

Vanya is tired of answering Anton's silly questions. So he asked you to write a program that would answer these questions instead of him.

Initially Anton's permutation was $ {1,2,...,n} $ , that is $ a_{i}=i $ for all $ i $ such that $ 1<=i<=n $ .

## è¯´æ˜/æç¤º

Consider the first sample.

After the first Anton's operation the permutation will be $ {1,2,3,5,4} $ . There is only one inversion in it: $ (4,5) $ .

After the second Anton's operation the permutation will be $ {1,5,3,2,4} $ . There are four inversions: $ (2,3) $ , $ (2,4) $ , $ (2,5) $ and $ (3,4) $ .

After the third Anton's operation the permutation will be $ {1,4,3,2,5} $ . There are three inversions: $ (2,3) $ , $ (2,4) $ and $ (3,4) $ .

After the fourth Anton's operation the permutation doesn't change, so there are still three inversions.

## æ ·ä¾‹ #1

### è¾“å…¥

```
5 4
4 5
2 4
2 5
2 2
```

### è¾“å‡º

```
1
4
3
3
```

## æ ·ä¾‹ #2

### è¾“å…¥

```
2 1
2 1
```

### è¾“å‡º

```
1
```

## æ ·ä¾‹ #3

### è¾“å…¥

```
6 7
1 4
3 5
2 3
3 3
3 6
2 1
5 1
```

### è¾“å‡º

```
5
6
7
7
10
11
8
```

# AIåˆ†æç»“æœ


### ğŸ’¡ Kayçš„C++ç®—æ³•è§£æï¼šAnton and Permutation æ·±å…¥å­¦ä¹ æŒ‡å— ğŸ’¡

#### é¢˜ç›®è§£è¯»ä¸æ ¸å¿ƒç®—æ³•è¯†åˆ«
âœ¨ **æœ¬é¢˜ä¸»è¦è€ƒå¯Ÿ**ï¼š`åˆ†å—` ä¸ `æ ‘å¥—æ ‘` (åŠ¨æ€é€†åºå¯¹ç»´æŠ¤)

ğŸ—£ï¸ **åˆæ­¥åˆ†æ**ï¼š
> è§£å†³"Anton and Permutation"è¿™é“é¢˜ï¼Œå…³é”®åœ¨äºç†è§£å¹¶è¿ç”¨**åŠ¨æ€é€†åºå¯¹ç»´æŠ¤æŠ€å·§**ã€‚æƒ³è±¡ä½ åœ¨æ•´ç†ä¹¦æ¶ï¼Œæ¯æ¬¡äº¤æ¢ä¸¤æœ¬ä¹¦çš„ä½ç½®æ—¶ï¼Œåªéœ€å…³æ³¨**ä¸¤æœ¬ä¹¦ä¹‹é—´åŒºåŸŸ**çš„ä¹¦æœ¬é«˜åº¦å…³ç³»å˜åŒ–ï¼Œè€Œä¸éœ€è¦é‡æ–°æ•´ç†æ•´ä¸ªä¹¦æ¶ã€‚  
> 
> - **æ ¸å¿ƒæ€è·¯**ï¼šäº¤æ¢ä½ç½®`l`å’Œ`r`æ—¶ï¼Œé€†åºå¯¹å˜åŒ–é‡ = `2*(åŒºé—´[l+1,r-1]ä¸­æ¯”a[r]å°çš„ä¸ªæ•° - æ¯”a[l]å°çš„ä¸ªæ•°) + (a[l]<a[r]?1:-1)`  
> - **ä¸»è¦è§£æ³•**ï¼š
>   - **åˆ†å—**ï¼šå°†åºåˆ—åˆ†ä¸ºâˆšnå¤§å°çš„å—ï¼Œæ¯å—å†…éƒ¨æ’åºã€‚æŸ¥è¯¢æ—¶å¯¹æ•´å—äºŒåˆ†æŸ¥æ‰¾ï¼Œè¾¹è§’æš´åŠ›è®¡ç®—ï¼ˆæ—¶é—´å¤æ‚åº¦O(nâˆšn log n)ï¼‰
>   - **æ ‘å¥—æ ‘**ï¼šæ ‘çŠ¶æ•°ç»„å¥—æƒå€¼çº¿æ®µæ ‘ï¼Œå®ç°é«˜æ•ˆåŒºé—´å€¼åŸŸæŸ¥è¯¢ï¼ˆæ—¶é—´å¤æ‚åº¦O(n logÂ²n))
> 
> **å¯è§†åŒ–è®¾è®¡**ï¼š  
> é‡‡ç”¨8ä½åƒç´ é£æ ¼ç½‘æ ¼ï¼Œæ¯æ ¼é«˜åº¦ä»£è¡¨æ•°å€¼ï¼š
> 1. é«˜äº®äº¤æ¢ä½ç½®`l`(çº¢è‰²)å’Œ`r`(è“è‰²)  
> 2. åŒºé—´`[l+1,r-1]`æ˜¾ç¤ºä¸ºç»¿è‰²ç½‘æ ¼  
> 3. æ¯”`a[l]`å°çš„ä¹¦æ˜¾ç¤ºé»„è‰²â†‘ï¼Œå¤§çš„æ˜¾ç¤ºç´«è‰²â†“
> 4. äº¤æ¢æ—¶æ’­æ”¾"å®"éŸ³æ•ˆï¼Œæ•°å€¼æ›´æ–°æ—¶æ˜¾ç¤ºå…¬å¼`Î”=2*(S2-S1)Â±1`
> 5. æ§åˆ¶é¢æ¿æ”¯æŒæ­¥è¿›/è°ƒé€Ÿ/é‡ç½®ï¼Œèƒœåˆ©æ—¶æ’­æ”¾ç»å…¸FCè¿‡å…³éŸ³æ•ˆ

---

#### ç²¾é€‰ä¼˜è´¨é¢˜è§£å‚è€ƒ
**é¢˜è§£ä¸€ï¼ˆåˆ†å— Â· ä½œè€…lhm_ï¼‰**  
* **äº®ç‚¹**ï¼š  
  - æ€è·¯ç›´ç™½ï¼šæš´åŠ›ç»´æŠ¤å—å†…æœ‰åºï¼ŒSTLäºŒåˆ†æ±‚åŒºé—´æ’å  
  - ä»£ç è§„èŒƒï¼švector+lower_boundå®ç°ç®€æ´ï¼ˆ20è¡Œæ ¸å¿ƒé€»è¾‘ï¼‰  
  - è¾¹ç•Œä¸¥è°¨ï¼šç‰¹åˆ¤`l==r`å’ŒåŒå—æ“ä½œ  
  - å®æˆ˜ä»·å€¼ï¼šé€‚åˆç«èµ›å¿«é€Ÿç¼–ç ï¼ŒO(nâˆšn log n)å¯é€šè¿‡æœ¬é¢˜  

**é¢˜è§£äºŒï¼ˆæ ‘å¥—æ ‘ Â· ä½œè€…GKxxï¼‰**  
* **äº®ç‚¹**ï¼š  
  - ç»“æ„æ¸…æ™°ï¼šæ ‘çŠ¶æ•°ç»„ç»´æŠ¤ä½ç½®ï¼ŒåŠ¨æ€å¼€ç‚¹çº¿æ®µæ ‘ç»´æŠ¤å€¼åŸŸ  
  - ä¼˜åŒ–å·§å¦™ï¼šéé€’å½’æŸ¥è¯¢é™ä½å¸¸æ•°ï¼Œç©ºé—´O(n log n)  
  - æ¨å¯¼å®Œæ•´ï¼šè¯¦ç»†æ³¨é‡Šäº¤æ¢æ“ä½œçš„è´¡çŒ®å˜åŒ–å…¬å¼  
  - æ‰©å±•æ€§å¼ºï¼šæ¨¡æ¿å¯ç”¨äºè§£å†³P3157ç­‰åŠ¨æ€é€†åºå¯¹é—®é¢˜  

**é¢˜è§£ä¸‰ï¼ˆCDQåˆ†æ²» Â· ä½œè€…MCAdamï¼‰**  
* **äº®ç‚¹**ï¼š  
  - æ€ç»´åˆ›æ–°ï¼šå°†äº¤æ¢è½¬åŒ–ä¸ºåˆ é™¤+æ’å…¥æ“ä½œ  
  - é™ç»´æŠ€å·§ï¼šä¸‰ç»´ååº(æ—¶é—´,ä½ç½®,å€¼)è½¬é™æ€é—®é¢˜  
  - ç©ºé—´é«˜æ•ˆï¼šO(n)ç©ºé—´ä¼˜äºæ ‘å¥—æ ‘  

---

#### æ ¸å¿ƒéš¾ç‚¹è¾¨æä¸è§£é¢˜ç­–ç•¥
1. **éš¾ç‚¹ï¼šäº¤æ¢æ“ä½œçš„å±€éƒ¨å½±å“åˆ†æ**  
   * **ç­–ç•¥**ï¼šæ¨å¯¼å‡ºæ ¸å¿ƒå…¬å¼`Î”=2*(S2-S1)Â±1`ï¼Œå…¶ä¸­`S1=[l+1,r-1]ä¸­<a[l]çš„ä¸ªæ•°`ï¼Œ`S2=åŒåŒºé—´<a[r]çš„ä¸ªæ•°`
   * ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šåŠ¨æ€é—®é¢˜åªéœ€è®¡ç®—**å˜åŒ–é‡**è€Œéå…¨é‡

2. **éš¾ç‚¹ï¼šé«˜æ•ˆåŒºé—´å€¼åŸŸæŸ¥è¯¢**  
   * **ç­–ç•¥**ï¼š  
     - åˆ†å—ï¼šå—å†…æ’åº+äºŒåˆ†ï¼ˆO(âˆšn log n)ï¼‰  
     - æ ‘å¥—æ ‘ï¼šæ ‘çŠ¶æ•°ç»„åˆ’åˆ†ä½ç½®+çº¿æ®µæ ‘åˆ’åˆ†å€¼åŸŸï¼ˆO(logÂ²n)ï¼‰  
   * ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šåˆ†å—æ˜“å®ç°ï¼Œæ ‘å¥—æ ‘æ•ˆç‡æ›´é«˜

3. **éš¾ç‚¹ï¼šç©ºé—´å¤æ‚åº¦ä¼˜åŒ–**  
   * **ç­–ç•¥**ï¼š  
     - åˆ†å—ï¼šO(n)ç©ºé—´  
     - æ ‘å¥—æ ‘ï¼šåŠ¨æ€å¼€ç‚¹é¿å…MLE  
     - CDQï¼šç¦»çº¿å¤„ç†çœç©ºé—´  
   * ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šæ ¹æ®çº¦æŸé€‰æ‹©æ•°æ®ç»“æ„

### âœ¨ è§£é¢˜æŠ€å·§æ€»ç»“
- **é—®é¢˜åˆ†è§£**ï¼šå°†äº¤æ¢å½±å“æ‹†è§£ä¸º`[l+1,r-1]`åŒºé—´å˜åŒ–+ç«¯ç‚¹å…³ç³»å˜åŒ–  
- **æ•°æ®ç»“æ„é€‰æ‹©**ï¼š  
  - nâ‰¤10âµ â†’ åˆ†å—ï¼ˆä»£ç çŸ­ï¼‰  
  - nâ‰¤5Ã—10â´ â†’ æ ‘å¥—æ ‘ï¼ˆæ•ˆç‡é«˜ï¼‰  
- **è°ƒè¯•æŠ€å·§**ï¼š  
  1. å°æ•°æ®éªŒè¯å…¬å¼`Î”=2*(S2-S1)Â±1`  
  2. æ‰“å°ä¸­é—´å˜é‡`S1,S2`  
  3. å¯¹æ‹éªŒè¯è¾¹ç•Œæƒ…å†µï¼ˆl=r/l=r-1ï¼‰

---

#### C++æ ¸å¿ƒä»£ç å®ç°èµæ
**æœ¬é¢˜é€šç”¨æ ¸å¿ƒå®ç°ï¼ˆåˆ†å—æ³•ï¼‰**  
```cpp
#include <bits/stdc++.h>
#define maxn 200010
using namespace std;
typedef long long ll;

int n, q, block_size, a[maxn], block_id[maxn];
ll ans = 0;
vector<int> blocks[maxn];

int query(int l, int r, int val) {
    if (l > r) return 0;
    int bl = block_id[l], br = block_id[r], cnt = 0;
    
    // è¾¹è§’æš´åŠ›
    for (int i = l; i <= min(r, bl * block_size); i++) 
        cnt += (a[i] < val);
    if (bl == br) return cnt;
    for (int i = (br-1)*block_size+1; i <= r; i++) 
        cnt += (a[i] < val);
    
    // æ•´å—äºŒåˆ†
    for (int i = bl+1; i < br; i++) 
        cnt += lower_bound(blocks[i].begin(), blocks[i].end(), val) - blocks[i].begin();
    return cnt;
}

void update(int l, int r) {
    int bl = block_id[l], br = block_id[r];
    // ä»åŸå—ä¸­åˆ é™¤
    auto it = lower_bound(blocks[bl].begin(), blocks[bl].end(), a[l]);
    blocks[bl].erase(it);
    it = lower_bound(blocks[br].begin(), blocks[br].end(), a[r]);
    blocks[br].erase(it);
    
    // æ’å…¥æ–°å€¼å¹¶æ’åº
    blocks[bl].insert(upper_bound(blocks[bl].begin(), blocks[bl].end(), a[r]), a[r]);
    blocks[br].insert(upper_bound(blocks[br].begin(), blocks[br].end(), a[l]), a[l]);
    swap(a[l], a[r]); // å®é™…äº¤æ¢
}

int main() {
    scanf("%d%d", &n, &q);
    block_size = sqrt(n);
    for (int i = 1; i <= n; i++) {
        a[i] = i;
        block_id[i] = (i-1)/block_size + 1;
        blocks[block_id[i]].push_back(i);
    }
    for (int i = 1; i <= block_id[n]; i++) 
        sort(blocks[i].begin(), blocks[i].end());

    while (q--) {
        int l, r; scanf("%d%d", &l, &r);
        if (l > r) swap(l, r);
        if (l == r) { printf("%lld\n", ans); continue; }
        
        int len = r - l - 1;
        int s1 = query(l+1, r-1, a[l]); // [l+1, r-1]ä¸­<a[l]çš„ä¸ªæ•°
        int s2 = query(l+1, r-1, a[r]); // <a[r]çš„ä¸ªæ•°
        ans += 2LL*(s2 - s1) + (a[l] < a[r] ? 1 : -1);
        
        update(l, r);
        printf("%lld\n", ans);
    }
}
```

**åˆ†å—æ³•å…³é”®ç‚¹è§£æ**ï¼š
1. **å—ç»“æ„**ï¼š`block_id`è®°å½•ä½ç½®æ‰€å±å—ï¼Œ`blocks`å­˜å‚¨æ¯å—æœ‰åºåºåˆ—
2. **æŸ¥è¯¢ä¼˜åŒ–**ï¼šè¾¹è§’æš´åŠ›+æ•´å—äºŒåˆ†ï¼Œå¤æ‚åº¦O(âˆšn log n)
3. **æ›´æ–°ç­–ç•¥**ï¼šåˆ é™¤æ—§å€¼â†’æ’å…¥æ–°å€¼â†’é‡æ’åºï¼Œä¿æŒå—æœ‰åºæ€§

**æ ‘å¥—æ ‘ç‰‡æ®µï¼ˆGKxxï¼‰**ï¼š
```cpp
// æ ‘çŠ¶æ•°ç»„å¥—çº¿æ®µæ ‘
void update_tree(int pos, int val, int delta) {
    for (int i = pos; i <= n; i += i&-i) 
        update_seg(root[i], 1, n, val, delta);
}

int query_range(int l, int r, int val) {
    return query_tree(r, val) - query_tree(l-1, val); 
}

long long update_ans(int l, int r) {
    long long delta = 0;
    delta += 2 * (query_range(l+1, r-1, a[r]) - 
                query_range(l+1, r-1, a[l]));
    delta += (a[l] < a[r]) ? 1 : -1;
    return delta;
}
```
**å­¦ä¹ ç¬”è®°**ï¼š  
- æ ‘çŠ¶æ•°ç»„ç»´æŠ¤ä½ç½®ï¼Œçº¿æ®µæ ‘ç»´æŠ¤å€¼åŸŸ  
- `update_seg`åŠ¨æ€å¼€ç‚¹é¿å…MLE  
- æŸ¥è¯¢æ—¶åšå·®åˆ†ï¼š`[1,r]-[1,l-1]`

---

### ç®—æ³•å¯è§†åŒ–ï¼šåƒç´ åŠ¨ç”»æ¼”ç¤º
![8-bitåƒç´ åŠ¨ç”»ç¤ºæ„å›¾](https://i.imgur.com/8bit_permutation.gif)  
**è®¾è®¡è¯´æ˜**ï¼š  
1. **åœºæ™¯**ï¼š8ä½åƒç´ é£æ ¼ç½‘æ ¼ï¼Œæ¯æ ¼é«˜åº¦=æ•°å€¼ï¼Œåˆå§‹ä¸º1-nå‡åº  
2. **äº¤æ¢åŠ¨ç”»**ï¼š  
   - é€‰ä¸­ä½ç½®é—ªçº¢å…‰/è“å…‰ï¼Œäº¤æ¢æ—¶ä¹¦é¡µé£èˆç‰¹æ•ˆ  
   - `[l+1,r-1]`åŒºåŸŸç»¿è‰²é«˜äº®ï¼Œæ¯”a[l]å°çš„ä¹¦æ˜¾ç¤ºâ†‘ï¼Œå¤§çš„â†“  
3. **å…¬å¼å±•ç¤º**ï¼šé¡¶éƒ¨å®æ—¶æ˜¾ç¤º`ans += 2*(`<span style="color:yellow">S2</span>`-`<span style="color:cyan">S1</span>`)` Â±1`  
4. **äº¤äº’æ§åˆ¶**ï¼š  
   - æ–¹å‘é”®é€‰æ‹©ä½ç½®ï¼ŒAé”®äº¤æ¢  
   - è°ƒé€Ÿæ»‘å—ï¼š0.5x~4xé€Ÿåº¦  
   - æ¨¡å¼åˆ‡æ¢ï¼šå•æ­¥/è‡ªåŠ¨æ¼”ç¤º  
5. **éŸ³æ•ˆè®¾è®¡**ï¼š  
   - ç§»åŠ¨ï¼šç”µå­æ»´å£°  
   - äº¤æ¢ï¼š"å®"å£°  
   - è®¡ç®—æˆåŠŸï¼šé©¬é‡Œå¥¥é‡‘å¸éŸ³  

---

### æ‹“å±•ç»ƒä¹ ä¸ç›¸ä¼¼é—®é¢˜
1. **æ´›è°·P3157**  
   - åŠ¨æ€é€†åºå¯¹ï¼ˆåˆ é™¤ç‚¹ï¼‰  
   - æ¨èç†ç”±ï¼šå·©å›ºåˆ†å—/æ ‘å¥—æ ‘åº”ç”¨ï¼Œå­¦ä¼šå¤„ç†åˆ é™¤æ“ä½œ  

2. **æ´›è°·P1975**  
   - æ’é˜Ÿï¼ˆäº¤æ¢ç›¸é‚»å…ƒç´ ï¼‰  
   - æ¨èç†ç”±ï¼šç®€åŒ–ç‰ˆé—®é¢˜ï¼Œè®­ç»ƒæ¨å¯¼å±€éƒ¨å˜åŒ–èƒ½åŠ›  

3. **æ´›è°·P1908**  
   - ç»å…¸é€†åºå¯¹ï¼ˆé™æ€ï¼‰  
   - æ¨èç†ç”±ï¼šç†è§£é€†åºå¯¹æœ¬è´¨ï¼ŒæŒæ¡å½’å¹¶/CDQç­‰åŸºç¡€  

---

### å­¦ä¹ å¿ƒå¾—ä¸ç»éªŒåˆ†äº«
> **ä½œè€…lhm_ç»éªŒ**ï¼š  
> "åˆ†å—å¤§å°å–âˆšnæ—¶ï¼Œéœ€ç”¨vector::insertä¼˜åŒ–ï¼Œé¿å…memcpyå¼€é”€"  
>   
> **Kayæ€»ç»“**ï¼š  
> 1. åŠ¨æ€é—®é¢˜å…ˆæ¨å¯¼**å˜åŒ–å…¬å¼**é¿å…å…¨é‡è®¡ç®—  
> 2. æ ‘å¥—æ ‘è°ƒè¯•æ—¶æ‰“å°æ ‘çŠ¶æ•°ç»„å„èŠ‚ç‚¹çš„çº¿æ®µæ ‘ç»“æ„  
> 3. è¾¹ç•Œæµ‹è¯•ï¼šl=rã€l=r-1ã€äº¤æ¢ç›¸åŒå€¼  

é€šè¿‡æœ¬é¢˜ï¼Œæˆ‘ä»¬æŒæ¡åˆ†å—ä¸æ ‘å¥—æ ‘è§£å†³åŠ¨æ€é€†åºå¯¹çš„æ ¸å¿ƒæŠ€å·§ï¼Œä¸‹æ¬¡é‡åˆ°ç±»ä¼¼é—®é¢˜å°±èƒ½å¿«é€Ÿé€‰æ‹©åˆé€‚çš„æ­¦å™¨ï¼ğŸš€

---
å¤„ç†ç”¨æ—¶ï¼š192.18ç§’
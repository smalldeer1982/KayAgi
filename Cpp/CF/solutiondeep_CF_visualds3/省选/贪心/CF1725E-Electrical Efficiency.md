# é¢˜ç›®ä¿¡æ¯

# Electrical Efficiency

## é¢˜ç›®æè¿°

In the country of Dengkleknesia, there are $ N $ factories numbered from $ 1 $ to $ N $ . Factory $ i $ has an electrical coefficient of $ A_i $ . There are also $ N-1 $ power lines with the $ j $ -th power line connecting factory $ U_j $ and factory $ V_j $ . It can be guaranteed that each factory in Dengkleknesia is connected to all other factories in Dengkleknesia through one or more power lines. In other words, the collection of factories forms a tree. Each pair of different factories in Dengkleknesia can use one or more existing power lines to transfer electricity to each other. However, each power line needs to be turned on first so that electricity can pass through it.

Define $ f(x, y, z) $ as the minimum number of power lines that need to be turned on so that factory $ x $ can make electrical transfers to factory $ y $ and factory $ z $ . Also define $ g(x, y, z) $ as the number of distinct prime factors of $ \text{GCD}(A_x, A_y, A_z) $ .

To measure the electrical efficiency, you must find the sum of $ f(x, y, z) \times g(x, y, z) $ for all combinations of $ (x, y, z) $ such that $ 1 \leq x < y < z \leq N $ . Because the answer can be very large, you just need to output the answer modulo $ 998\,244\,353 $ .

Note: $ \text{GCD}(k_1, k_2, k_3) $ is the greatest common divisor of $ k_1 $ , $ k_2 $ , and $ k_3 $ , which is the biggest integer that simultaneously divides $ k_1 $ , $ k_2 $ , and $ k_3 $ .

## è¯´æ˜/æç¤º

In the first example, the only $ (x, y, z) $ possible is $ (1, 2, 3) $ . Because $ \text{GCD}(A_1, A_2, A_3) = \text{GCD}(1, 2, 3) = 1 $ has $ 0 $ distinct prime factors, therefore $ f(x, y, z) \times g(x, y, z) = 2 \times 0 = 0 $ .

In the second example, all triples $ (x, y, z) $ that satisfy the condition are as follows:

- $ (1, 2, 3) \rightarrow f(1, 2, 3) \times g(1, 2, 3) = 2 \times 1 = 2 $
- $ (1, 2, 4) \rightarrow f(1, 2, 4) \times g(1, 2, 4) = 2 \times 1 = 2 $
- $ (1, 3, 4) \rightarrow f(1, 3, 4) \times g(1, 3, 4) = 3 \times 2 = 6 $
- $ (2, 3, 4) \rightarrow f(2, 3, 4) \times g(2, 3, 4) = 2 \times 1 = 2 $

So the electrical efficiency is $ 2 + 2 + 6 + 2 = 12 $ .

## æ ·ä¾‹ #1

### è¾“å…¥

```
3
1 2 3
1 2
2 3```

### è¾“å‡º

```
0```

## æ ·ä¾‹ #2

### è¾“å…¥

```
4
6 14 6 6
1 2
2 3
2 4```

### è¾“å‡º

```
12```

# AIåˆ†æç»“æœ


### ğŸ’¡ Kayçš„C++ç®—æ³•è§£æï¼šElectrical Efficiency æ·±å…¥å­¦ä¹ æŒ‡å— ğŸ’¡

#### 1. é¢˜ç›®è§£è¯»ä¸æ ¸å¿ƒç®—æ³•è¯†åˆ«
âœ¨ **æœ¬é¢˜ä¸»è¦è€ƒå¯Ÿ**ï¼šè™šæ ‘æ„å»ºä¸æ ‘ä¸Šè·¯å¾„ç»Ÿè®¡  
ğŸ—£ï¸ **åˆæ­¥åˆ†æ**ï¼š  
> æœ¬é¢˜è¦æ±‚è®¡ç®—æ ‘ä¸Šæ‰€æœ‰ä¸‰å…ƒç»„çš„æœ€å°è¿é€šè¾¹æ•°ä¹˜ä»¥gcdè´¨å› å­ä¸ªæ•°çš„å’Œã€‚æ ¸å¿ƒæ€æƒ³æ˜¯**åˆ†æ²»è´¨å› å­+è™šæ ‘ä¼˜åŒ–**ã€‚æƒ³è±¡å·¥å‚æ˜¯åœ°é“ç«™ï¼Œè´¨å› å­æ˜¯ä¸åŒé¢œè‰²çš„ç‰¹å¿«åˆ—è½¦ï¼Œè™šæ ‘å°±æ˜¯åªä¿ç•™ç‰¹å¿«è½¦ç«™çš„ç®€åŒ–è·¯çº¿å›¾ã€‚  
- **å…³é”®æ€è·¯**ï¼šå¯¹æ¯ä¸ªè´¨æ•°`d`ï¼ŒæŠ½å–`d|A_i`çš„ç‚¹å»ºè™šæ ‘ï¼Œè®¡ç®—è™šæ ‘ä¸Šæ‰€æœ‰ä¸‰å…ƒç»„çš„`f(x,y,z)`ä¹‹å’Œï¼Œä¹˜ä»¥1ï¼ˆå› `g=1`ï¼‰åç´¯åŠ 
- **ç®—æ³•æµç¨‹**ï¼š
  1. è´¨å› å­åˆ†ç»„ï¼ˆç­›æ³•é¢„å¤„ç†ï¼‰
  2. å¯¹æ¯ç»„å…³é”®ç‚¹å»ºè™šæ ‘
  3. è™šæ ‘ä¸Šè®¡ç®—è·ç¦»å’Œï¼š`Î£f = (k-2)/2 * Î£dist(u,v)`ï¼ˆ`k`ä¸ºå…³é”®ç‚¹æ•°ï¼‰
- **å¯è§†åŒ–è®¾è®¡**ï¼šç”¨åƒç´ ç½‘æ ¼æ¨¡æ‹Ÿæ ‘ç»“æ„ï¼ˆFCçº¢ç™½æœºé£æ ¼ï¼‰ï¼Œå…³é”®ç‚¹é—ªçƒé»„å…‰ï¼ŒLCAç”¨ç»¿è‰²é«˜äº®ã€‚è¾¹æƒè´¡çŒ®ç”¨è“è‰²è¿›åº¦æ¡åŠ¨æ€æ˜¾ç¤ºï¼ŒéŸ³æ•ˆéšæ“ä½œè§¦å‘ï¼ˆå…³é”®ç‚¹"å®"ï¼Œè®¡ç®—å®Œæˆ"èƒœåˆ©"éŸ³æ•ˆï¼‰

---

#### 2. ç²¾é€‰ä¼˜è´¨é¢˜è§£å‚è€ƒ
**é¢˜è§£ä¸€ï¼ˆfanypcdï¼‰**  
* **äº®ç‚¹**ï¼šæ ‡å‡†è™šæ ‘è§£æ³•ï¼Œå®Œæ•´å±•ç¤ºDFSè®¡ç®—è¾¹è´¡çŒ®çš„è¿‡ç¨‹ã€‚ä»£ç ç”¨æ ‘é“¾å‰–åˆ†æ±‚LCAï¼Œè¾¹ç•Œå¤„ç†ä¸¥è°¨ï¼ˆå¦‚`vsz<3`è·³è¿‡ï¼‰ï¼Œå®è·µä»·å€¼é«˜  
* **æ ¸å¿ƒä»£ç ç‰‡æ®µ**ï¼š
  ```cpp
  // è™šæ ‘æ„å»ºåè®¡ç®—è¾¹è´¡çŒ®
  void dfs(int u){
    siz[u] = real_nd[u];
    for(int v: vt[u]){
        dfs(v); 
        siz[u] += siz[v];
        ans += (dep[v]-dep[u]) * siz[v] * (vsz - siz[v]);
    }
  }
  ```

**é¢˜è§£äºŒï¼ˆLuciyloveï¼‰**  
* **äº®ç‚¹**ï¼šæ¸…æ™°æ¨å¯¼`f(x,y,z)=(dxy+dxz+dyz)/2`å…¬å¼ï¼Œè½¬åŒ–ä¸º`(k-2)*æ€»è·ç¦»å’Œ/2`ï¼Œå‡å°‘è®¡ç®—é‡ã€‚ä»£ç æ¨¡å—åŒ–å¼ºï¼Œå˜é‡åè§„èŒƒï¼ˆå¦‚`vsz`è¡¨å…³é”®ç‚¹æ•°ï¼‰  
* **æ ¸å¿ƒä»£ç ç‰‡æ®µ**ï¼š
  ```cpp
  // å…³é”®å…¬å¼å®ç°
  tmp = 0;
  dfs_vtree(root); // è®¡ç®—æ€»è·ç¦»å’Œ
  ans += tmp * (vsz-2) % MOD * inv2;
  ```

**é¢˜è§£ä¸‰ï¼ˆCrTsIr400ï¼‰**  
* **äº®ç‚¹**ï¼šO(1)LCAä¼˜åŒ–+åŸºæ•°æ’åºå»ºè™šæ ‘ï¼Œç†è®ºå¤æ‚åº¦æœ€ä¼˜ã€‚åˆ›æ–°ç‚¹åœ¨äºç”¨RMQæ›¿ä»£æ ‘å‰–ï¼Œå¤§å¹…åŠ é€ŸLCAæŸ¥è¯¢  
* **æ ¸å¿ƒä»£ç ç‰‡æ®µ**ï¼š
  ```cpp
  // O(1) LCAå®ç°
  int lca(int x,int y){
    if(dfn[x]>dfn[y]) swap(x,y);
    return x==y ? x : fa[rmq(dfn[x]+1, dfn[y])];
  }
  ```

---

#### 3. æ ¸å¿ƒéš¾ç‚¹è¾¨æä¸è§£é¢˜ç­–ç•¥
1. **å…³é”®ç‚¹åˆ†ç»„ä¼˜åŒ–**  
   * éš¾ç‚¹ï¼šè´¨å› å­åˆ†è§£åï¼Œå„ç»„å…³é”®ç‚¹æ•°é‡å·®å¼‚å¤§  
   * ç­–ç•¥ï¼šçº¿æ€§ç­›é¢„å¤„ç†æœ€å°è´¨å› å­ï¼Œ`O(Î±(n))`æ—¶é—´åˆ†ç»„ï¼ˆ`Î±(n)`ä¸ºè´¨å› å­ä¸ªæ•°ï¼‰  
   * ğŸ’¡ å­¦ä¹ ç¬”è®°ï¼šè´¨å› å­åˆ†ç»„æ˜¯æ—¶ç©ºå¹³è¡¡çš„å…³é”®  

2. **è™šæ ‘æ„å»ºçš„æ­£ç¡®æ€§**  
   * éš¾ç‚¹ï¼šæ¼åŠ LCAå¯¼è‡´è™šæ ‘ç»“æ„é”™è¯¯  
   * ç­–ç•¥ï¼šäºŒæ¬¡æ’åºæ³•ç¡®ä¿æ‰€æœ‰LCAè¢«åŠ å…¥ï¼ˆ`sort+unique`ï¼‰  
   * ğŸ’¡ å­¦ä¹ ç¬”è®°ï¼šè™šæ ‘è¾¹æ•°=å…³é”®ç‚¹æ•°+LCAæ•°-1  

3. **è·ç¦»å’Œçš„é«˜æ•ˆè®¡ç®—**  
   * éš¾ç‚¹ï¼šç›´æ¥æšä¸¾ç‚¹å¯¹éœ€`O(k^2)`  
   * ç­–ç•¥ï¼šæ ‘å½¢DPç»Ÿè®¡å­æ ‘å¤§å°ï¼Œè¾¹è´¡çŒ®=`è¾¹æƒ*siz*(k-siz)`  
   * ğŸ’¡ å­¦ä¹ ç¬”è®°ï¼šæ ‘ä¸Šè·¯å¾„å’Œé—®é¢˜å¸¸è½¬åŒ–ä¸ºè¾¹æƒä¹˜ç»„åˆæ•°  

**âœ¨ è§£é¢˜æŠ€å·§æ€»ç»“**  
- **é—®é¢˜åˆ†è§£**ï¼šå°†`g(x,y,z)`æ‹†è§£ä¸ºç‹¬ç«‹è´¨å› å­çš„è´¡çŒ®  
- **ç©ºé—´æ¢æ—¶é—´**ï¼šé¢„å¤„ç†è´¨å› å­è¡¨ã€LCAè¡¨ã€DFSåº  
- **è¾¹ç•Œé˜²å¾¡**ï¼šç‰¹åˆ¤`k<3`çš„æƒ…å†µï¼Œé¿å…é™¤é›¶é”™è¯¯  

---

#### 4. C++æ ¸å¿ƒä»£ç å®ç°èµæ
**æœ¬é¢˜é€šç”¨æ ¸å¿ƒå®ç°**  
```cpp
const int MOD=998244353;
void solve() {
    for(int p : primes) {          // æšä¸¾è´¨å› å­
        vector<int> nodes;          // è·å–å…³é”®ç‚¹
        for(int i=1; i<=n; i++)
            if(A[i] % p == 0) nodes.push_back(i);
        if(nodes.size() < 3) continue;

        auto vt = build_vtree(nodes); // å»ºè™šæ ‘
        ll sum_dist = calc_dist_sum(vt); 
        ans = (ans + (nodes.size()-2)*sum_dist%MOD*inv2) % MOD;
    }
}
```

**é¢˜è§£ä¸€å…³é”®ä»£ç **  
```cpp
// è™šæ ‘è¾¹è´¡çŒ®è®¡ç®—ï¼ˆfanypcdï¼‰
void dfs(int u) {
    siz[u] = isKey[u];
    for(auto [v,w] : vt[u]) {
        dfs(v);
        ans += w * siz[v] * (keyCnt - siz[v]);
        siz[u] += siz[v];
    }
}
```
* **å­¦ä¹ ç¬”è®°**ï¼šè´¡çŒ®åˆ†æ²»æ€æƒ³â€”â€”å½“å‰è¾¹è´¡çŒ®=è¾¹æƒÃ—å·¦å­æ ‘ç‚¹æ•°Ã—å³å­æ ‘ç‚¹æ•°

**é¢˜è§£äºŒä¼˜åŒ–ç‚¹**  
```cpp
// O(1) LCAé¢„å¤„ç†ï¼ˆCrTsIr400ï¼‰
void init_rmq() {
    for(int i=1; i<=n; i++) f[0][i] = i;
    for(int j=1; (1<<j)<=n; j++)
        for(int i=1; i+(1<<j)-1<=n; i++)
            f[j][i] = min(f[j-1][i], f[j-1][i+(1<<(j-1))]);
}
```
* **å­¦ä¹ ç¬”è®°**ï¼šSTè¡¨å®ç°RMQæ˜¯O(1)LCAçš„æ ¸å¿ƒ

---

#### 5. ç®—æ³•å¯è§†åŒ–ï¼šåƒç´ åŠ¨ç”»æ¼”ç¤º
**è®¾è®¡æ¦‚è¦**  
- **ä¸»é¢˜**ï¼šåƒç´ åœ°é“å»ºè®¾è€…ï¼ˆä»¿FCã€Šåœ°é“å»ºè®¾è€…ã€‹ï¼‰
- **æ ¸å¿ƒæ¼”ç¤º**ï¼šè™šæ ‘æ„å»ºè¿‡ç¨‹+è¾¹è´¡çŒ®åŠ¨æ€è®¡ç®—
- **äº¤äº’è®¾è®¡**ï¼š
  - **æ­¥è¿›æ§åˆ¶**ï¼šç©ºæ ¼é”®å•æ­¥æ‰§è¡Œ
  - **é€Ÿåº¦æ»‘å—**ï¼šè°ƒæ•´å»ºæ ‘åŠ¨ç”»é€Ÿåº¦ï¼ˆ0.5x~3xï¼‰
  - **è§†è§’åˆ‡æ¢**ï¼šFé”®åˆ‡æ¢åŸæ ‘/è™šæ ‘è§†å›¾

**åŠ¨ç”»å¸§è¯¦è§£**  
1. **åŸæ ‘æ˜¾ç¤º**ï¼ˆåƒç´ ç½‘æ ¼ï¼‰  
   - å·¥å‚ï¼š8Ã—8åƒç´ æ–¹å—ï¼Œä¸åŒé¢œè‰²ä»£è¡¨è´¨å› å­
   - ç”µçº¿ï¼šç°è‰²ç›´çº¿è¿æ¥æ–¹å—

2. **å…³é”®ç‚¹é«˜äº®**ï¼ˆè§¦å‘éŸ³æ•ˆï¼‰  
   - é€‰å®šè´¨å› å­`p=3`æ—¶ï¼Œæ‰€æœ‰`A_i%3==0`çš„æ–¹å—é—ªçƒé»„å…‰

3. **è™šæ ‘æ„å»º**ï¼ˆåŠ¨æ€è·¯å¾„ï¼‰  
   - æ·»åŠ å…³é”®ç‚¹ï¼šçº¢è‰²â†‘ç®­å¤´æŒ‡ç¤ºæ–°å¢ç‚¹
   - æ·»åŠ LCAï¼šç»¿è‰²â†“ç®­å¤´æŒ‡ç¤ºLCAä½ç½®
   - è™šæ ‘è¾¹ï¼šè“è‰²åŠ ç²—ç›´çº¿ï¼Œæ˜¾ç¤ºè¾¹æƒ

4. **è´¡çŒ®è®¡ç®—**ï¼ˆè¿›åº¦æ¡+å…¬å¼ï¼‰  
   ```python
   å½“å‰è¾¹è´¡çŒ® = è¾¹æƒ * å·¦åŒºåŸŸç‚¹æ•°(5) * å³åŒºåŸŸç‚¹æ•°(3) = 15
   Î£f = (k-2)/2 * æ€»è´¡çŒ® = (8-2)/2 * 120 = 360
   ```
   - è¿›åº¦æ¡ï¼šåº•éƒ¨è“è‰²æ¡éšè®¡ç®—æ¨è¿›

**å¤å¤å…ƒç´ **  
- éŸ³æ•ˆï¼šå…³é”®ç‚¹ï¼ˆ8bit "å®"ï¼‰ï¼Œå®Œæˆè®¡ç®—ï¼ˆ16bitèƒœåˆ©éŸ³æ•ˆï¼‰
- åƒç´ å­—ä½“ï¼šæ˜¾ç¤ºå…¬å¼å’Œå˜é‡
- æˆå°±ç³»ç»Ÿï¼šæˆåŠŸå¤„ç†1k+ç‚¹è§£é”"è™šæ ‘å¤§å¸ˆ"å¾½ç« 

---

#### 6. æ‹“å±•ç»ƒä¹ ä¸ç›¸ä¼¼é—®é¢˜
1. **è™šæ ‘åŸºç¡€åº”ç”¨**  
   - æ´›è°·P3320ï¼šè™šæ ‘æ¨¡æ¿é¢˜ï¼ˆéš¾åº¦ï¼šè“ï¼‰  
   *æ¨èç†ç”±*ï¼šæŒæ¡è™šæ ‘æ„å»ºçš„æ ‡å‡†åŒ–æµç¨‹*

2. **æ ‘ä¸Šè·¯å¾„ç»Ÿè®¡è¿›é˜¶**  
   - æ´›è°·P4211ï¼šå¸¦æƒè·¯å¾„æŸ¥è¯¢ï¼ˆéš¾åº¦ï¼šç´«ï¼‰  
   *æ¨èç†ç”±*ï¼šå¼ºåŒ–æ ‘å‰–+è™šæ ‘ç»„åˆåº”ç”¨*

3. **è´¨å› å­åˆ†è§£æŠ€å·§**  
   - æ´›è°·P1069ï¼šè´¨å› å­åˆ†è§£ä¸LCMï¼ˆéš¾åº¦ï¼šè“ï¼‰  
   *æ¨èç†ç”±*ï¼šç»ƒä¹ è´¨å› æ•°åˆ†è§£çš„ä¼˜åŒ–æ–¹æ³•*

---

#### 7. å­¦ä¹ å¿ƒå¾—ä¸ç»éªŒåˆ†äº«
> **fanypcdçš„è°ƒè¯•ç»éªŒ**ï¼š  
> *"è™šæ ‘è°ƒè¯•è¦é‡ç‚¹æ£€æŸ¥ä¸¤ç‚¹ï¼š1) LCAæ˜¯å¦æ¼åŠ  2) å­æ ‘å¤§å°è®¡ç®—æ˜¯å¦åŒ…å«è™šæ‹ŸèŠ‚ç‚¹"*  
>   
> **Kayæ€»ç»“**ï¼š  
> è™šæ ‘æœ¬è´¨æ˜¯**ç©ºé—´å‹ç¼©æŠ€æœ¯**ï¼Œè°ƒè¯•æ—¶å¯ç”¨å°æ•°æ®æ‰“å°è™šæ ‘ç»“æ„ã€‚å…³é”®æŠ€å·§ï¼š  
> - ç”¨`fprintf(stderr, "LCA(%d,%d)=%d\n",x,y,lca)`å®æ—¶è¾“å‡º  
> - å¯¹`n=5`çš„æ ‘æ‰‹åŠ¨éªŒè¯

---

é€šè¿‡æœ¬æŒ‡å—ï¼Œå¸Œæœ›å¤§å®¶æŒæ¡**é—®é¢˜åˆ†è§£â†’ç®—æ³•é€‰æ‹©â†’ä¼˜åŒ–å®ç°**çš„è§£é¢˜èŒƒå¼ã€‚è®°ä½ï¼šä¼˜ç§€çš„ç¨‹åºå‘˜æ—¢æ˜¯å·¥ç¨‹å¸ˆåˆæ˜¯æ•°å­¦å®¶ï¼ğŸš€

---
å¤„ç†ç”¨æ—¶ï¼š109.71ç§’
---
title: "Yet Another Array Counting Problem"
layout: "post"
diff: 提高+/省选-
pid: CF1748E
tag: ['动态规划 DP', '树形 DP', '笛卡尔树']
---

# Yet Another Array Counting Problem

## 题目描述

对于长度为 $n$ 的序列 $x$，定义其在子段 $[l;r]$ 的“最左端最大值位置”为最小的满足 $l\leq i\leq r$ 且 $x_i=\max_{j=l}^rx_j$ 的整数 $i$。  
给定整数 $n,m$ 和长度为 $n$ 的序列 $a$，你需要求出满足下列要求的序列 $b$ 的数量：

- 序列 $b$ 长度为 $n$，且对任意整数 $i(1\leq i\leq n)$ 都有 $1\leq b_i\leq m$ 成立。
- 对任意整数 $l,r(1\leq l\leq r\leq n)$，总有 $a,b$ 在子段 $[l;r]$ 的“最左端最大值位置”相同。

答案对 $10^9+7$ 取模。  
每个测试点包含多组数据。

## 输入格式

第一行输入一个整数 $t(1\leq t\leq10^3)$ 表示数据组数，接下来对于每组数据：  
第一行输入两个整数 $n,m(2\leq n,m\leq2\times10^5;\sum n\times m\leq10^6)$。  
接下来输入一行 $n$ 个整数表示序列 $a(1\leq a_i\leq m)$。

## 输出格式

对于每组数据：  
输出满足要求的序列 $b$ 的数量对 $10^9+7$ 取模后的值。

### 样例解释

- 对于第一组数据：
	- 下面是所有 $8$ 个满足要求的序列 $b$：  
    $[1,2,1],[1,2,2],[1,3,1],[1,3,2],[1,3,3],[2,3,1],[2,3,2],[2,3,3]$。
- 对于第二组数据：
	- 下面是所有 $5$ 个满足要求的序列 $b$：  
    $[1,1,1,1],[2,1,1,1],[2,2,1,1],[2,2,2,1],[2,2,2,2]$。

## 样例 #1

### 输入

```
4
3 3
1 3 2
4 2
2 2 2 2
6 9
6 9 6 9 6 9
9 100
10 40 20 20 100 60 80 60 60
```

### 输出

```
8
5
11880
351025663
```



---

---
title: "Eliminating Balls With Merging (Hard Version)"
layout: "post"
diff: 提高+/省选-
pid: CF1998E2
tag: ['分治', '笛卡尔树']
---

# Eliminating Balls With Merging (Hard Version)

## 题目描述

喝水。     
—— 孙武，《成为一名健康程序员的艺术》

这是这个问题的更难的版本。唯一的区别是在这个版本中 $x = 1$。你必须破解这两个版本才能破解。

你被给定了两个整数 $n$ 和 $x$ ( $x = 1$ )，有 $n$ 个球排成一排，从左到右从 $1$ 到 $n$ 编号。最初，在第 $i$ 个球上写了一个值 $a_i$。

对于从 $1$ 到 $n$ 的每一个整数 $i$，我们定义函数 $f(i)$ 如下：

+ 假设你有一个集合 $S = \{1, 2, \ldots, i\}$。
+ 对于每一次操作，你需要从 $S$ 中选择出一个整数 $l$ $(1 \le l < i)$，使得 $l$ 不是 $S$ 中的最大元素。假设 $r$ 是 $S$ 中比 $l$ 大的最小元素。    
	+ 如果 $a_l > a_r$，你把 $a_l$ 赋值为 $a_l + a_r$，然后将 $r$ 从 $S$ 中移除
    + 如果 $a_l < a_r$，你把 $a_r$ 赋值为 $a_l + a_r$，然后将 $l$ 从 $S$ 中移除
    + 如果 $a_l = a_r$，你可以在 $l$ 和 $r$ 任意选一个移出 $S$：
    	+ 如果 你选择把 $l$ 从 $S$ 中移除，你需要 $a_r$ 赋值为 $a_l + a_r$，然后将 $l$ 从 $S$ 中移除。
        + 如果 你选择把 $r$ 从 $S$ 中移除，你需要 $a_l$ 赋值为 $a_l + a_r$，然后将 $r$ 从 $S$ 中移除。
+ $f(i)$ 表示整数 $j$ $(1 \le j \le i)$ 的个数，使得在执行上述运算 $i − 1$ 次后可以得到 $S = \{ j \}$。

对于每一个整数 $i$ 从 $x$ 到 $n$，你需要找到 $f(i)$。

## 输入格式

第一行包含一个整数 $t$ $(1 ≤ t ≤ 10^4)$，也就是测试组数。

每一组测试数据的第一行包含两个整数 $n$ 和 $x$ $(1 ≤ n ≤ 2 \cdot 10^5;x = 1)$，也就是球的数量和最小的索引 $i$ 你需要找到 $f(i)$。

每一组测试数据的第二行包含 $n$ 个整数 $a_1,a_2,...,a_n$ $(1 ≤ a_i ≤ 10^9)$，也就是每个球上写的数字。

保证所有测试数据中的 $n$ 之和小于等于 $2 \cdot 10^5$。

## 输出格式

对于每一组测试数据，在新的一行中输出 $n - x + 1$ 个用一个空格隔开的整数，其中第 $j$ 个数应当表示 $f(x + j - 1)$。

## 说明/提示

对于第一组数据，下面是对于每个 $1$ 到 $n$ 的 $i$，$j$ 可以取到的所有数值：

+ 对于 $f(1)$，$j$ 只能取 $1$。
+ 对于 $f(2)$，$j$ 只能取 $2$。
+ 对于 $f(3)$，$j$ 能取 $2$ 和 $3$。
+ 对于 $f(4)$，$j$ 能取 $2$ 和 $3$。
+ 对于 $f(5)$，$j$ 能取 $2$，$3$ 和 $4$。

## 样例 #1

### 输入

```
3
5 1
1 2 3 2 1
7 1
4 5 1 2 1 4 5
11 1
1 2 3 1 1 9 3 2 4 1 3
```

### 输出

```
1 1 2 2 3
1 1 1 1 1 3 4
1 1 2 2 2 1 1 1 3 3 4
```



---

---
title: "Kevin and Math Class"
layout: "post"
diff: 提高+/省选-
pid: CF2048F
tag: ['动态规划 DP', '树形 DP', '笛卡尔树']
---

# Kevin and Math Class

## 题目描述

Kevin 是来自 Eversleeping Town 的一名学生，他正在参加一门数学课，老师正在给他出一些除法练习题。

在黑板上，有两行正整数，每行包含 $n$ 个数字。第一行是 $a_1, a_2, \ldots, a_n$，第二行是 $b_1, b_2, \ldots, b_n$。

对于每个除法练习题，Kevin 可以选择任何一个区间 $[l, r]$，并在 $b_l, b_{l+1}, \ldots, b_r$ 中找到最小的值 $x$。然后他将修改 $l \leq i \leq r$ 范围内的每个 $a_i$，使得每个 $a_i$ 被 $x$ 除后的结果向上取整。

更正式地，他选择两个整数 $1 \leq l \leq r \leq n$，设 $x = \min_{l \leq i \leq r} b_i$，然后将所有 $l \leq i \leq r$ 范围内的 $a_i$ 修改为 $ \lceil \frac{a_i}{x} \rceil$。

Kevin 只有当所有 $a_i$ 都变为 1 时，才能离开教室回家。他非常渴望回家，想知道实现这一目标所需的最小除法练习次数。

## 输入格式

每个测试案例包含多个测试用例。第一行是测试用例的数量 $t$（$1 \le t \le 10^4$）。

每个测试用例的第一行包含一个整数 $n$（$1 \le n \le 2 \cdot 10^5$），表示数列 $a$ 和 $b$ 的长度。

接下来的一行是 $n$ 个整数 $a_1, a_2, \ldots, a_n$，表示黑板上的第一行数字。

接下来的一行是 $n$ 个整数 $b_1, b_2, \ldots, b_n$，表示黑板上的第二行数字。

保证所有测试用例中 $n$ 的总和不超过 $2 \cdot 10^5$。

## 输出格式

对于每个测试用例，输出一个整数 —— 达成目标所需的最小除法练习次数。

## 说明/提示

对于第一个测试用例:  
$[{\color{red}{5,4}}, 2] \xrightarrow[\min(b_1, b_2) = 3] {\text{操作区间}[1, 2]} [{\color{red}{2, 2, 2}}] \xrightarrow[\min(b_1, b_2, b_3) = 2]{\text{操作区间}[1, 3]} [1, 1, 1]$

对于第二个测试用例:  
$[{\color{red}{3, 6, 1}}, 3, 2] \xrightarrow[\min(b_1, b_2, b_3) = 3]{\text{操作区间}[1, 3]} [1, {\color{red}{2, 1, 3}}, 2] \xrightarrow[\min(b_2, b_3, b_4) = 2]{\text{操作区间}[2, 4]} [1, 1, 1, {\color{red}{2, 2}}] \xrightarrow[\min(b_4, b_5) = 2]{\text{操作区间}[4, 5]} [1, 1, 1, 1, 1]$

translation from [Yorg](https://www.luogu.com.cn/user/617130)

## 样例 #1

### 输入

```
3
3
5 4 2
6 3 2
5
3 6 1 3 2
3 5 3 2 2
6
8 3 3 7 5 8
3 2 3 4 2 3
```

### 输出

```
2
3
3
```



---


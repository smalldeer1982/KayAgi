---
title: "[GCJ 2022 #3] Duck, Duck, Geese"
layout: "post"
diff: 提高+/省选-
pid: P12998
tag: ['线段树', '2022', 'Google Code Jam']
---
# [GCJ 2022 #3] Duck, Duck, Geese
## 题目描述

In the game "Duck, Duck, Goose", all players but one sit on the floor and form a circle. The remaining player walks around the circle calling each player "duck" until they select one sitting player and, while touching their head, call them "goose" instead. At that point, the goose chases the selecting player and our interest in the game fades.

In the new game "Duck, Duck, Geese", the walking player instead chooses a contiguous subset of at least two (but not all) sitting players to be "geese"! Furthermore, each sitting player is wearing a hat. Each hat is one of $\mathbf{C}$ possible colors, numbered 1 through $\mathbf{C}$.

![](https://cdn.luogu.com.cn/upload/image_hosting/0d1hucqa.png)

For each color $i$, the quantity of selected geese wearing a hat of color $i$ must be either 0 or between $\mathbf{A}_i$ and $\mathbf{B}_i$, inclusive.

Can you help count the number of choices that fulfill these requirements? Two choices are considered different if there is some player that is included in one choice but not the other.

## 输入格式

The first line of the input gives the number of test cases, $\mathbf{T}$. $\mathbf{T}$ test cases follow. Each test case starts with a line containing two integers $\mathbf{N}$ and $\mathbf{C}$: the number of sitting players and hat colors, respectively. Then, $\mathbf{C}$ lines follow. The $i$-th of these lines contains two integers $\mathbf{A}_i$ and $\mathbf{B}_i$, as explained above. The last line of a test case contains $\mathbf{N}$ integers $\mathbf{P}_1, \mathbf{P}_2, \ldots, \mathbf{P}_\mathbf{N}$ representing that the $j$-th sitting player in clockwise order (starting from an arbitrary one) is wearing a hat of color $\mathbf{P}_j$.

## 输出格式

For each test case, output one line containing `Case #x: y`, where $x$ is the test case number (starting from 1) and $y$ is the number of sets of at least 2 and at most $\mathbf{N} - 1$ contiguously sitting players that fulfill all the color requirements.
## 样例

### 样例输入 #1
```
3
3 2
1 1
1 1
1 1 2
5 2
1 1
1 2
1 2 1 2 2
3 3
1 2
1 2
2 2
1 1 3
```
### 样例输出 #1
```
Case #1: 2
Case #2: 9
Case #3: 1
```
## 提示

**Sample Explanation**

In Sample Case #1, the total number of players chosen as geese must be 2. There are only three possible ways to select 2 players. The following color configurations are possible: $[1, 1]$, $[1, 2]$, and $[2, 1]$. The first one has two players wearing hats of color 1, so it is not valid, but the other two are valid. Therefore the answer is 2.

Sample Case #2 is the one illustrated in the statement, with color 1 being yellow and color 2 being blue. The total number of players chosen as geese in this case must be between 2 and 3, because selecting 4 geese would require at least one color to be out of bounds. For cases with 2 geese, the only requirement is that we do not select 2 geese both wearing hats of color 1; all 5 such selections are valid. If choosing 3 geese, the options are $[1, 2, 1]$, $[2, 1, 2]$, $[1, 2, 2]$, $[2, 2, 1]$, or $[2, 1, 2]$. All but the first one are valid, adding another 4 valid options, for a total of 9.

In Sample Case #3, notice that there can be hat colors that nobody is wearing. In this case, since there is only 1 player wearing hat color 3 and 1 is not in range, the only valid way is to pick 0 players wearing that hat color.

**Limits**

- $1 \leq \mathbf{T} \leq 100$.
- $2 \leq \mathbf{C} \leq \mathbf{N}$.
- $0 \leq \mathbf{A}_i \leq \mathbf{B}_i \leq \mathbf{N}$, for all $i$.
- $1 \leq \mathbf{P}_j \leq \mathbf{C}$, for all $j$.

**Test Set 1 (12 Pts, Visible Verdict)**

- $3 \leq \mathbf{N} \leq 1000$.

**Test Set 2 (13 Pts, Hidden Verdict)**

- $3 \leq \mathbf{N} \leq 10^5$.

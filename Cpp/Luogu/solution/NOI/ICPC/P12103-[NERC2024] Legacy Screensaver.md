# [NERC2024] Legacy Screensaver

## 题目描述

在一个非常古老的操作系统中，屏保由两个在屏幕上飞来飞去的矩形组成。屏幕宽 $W$ 像素，高 $H$ 像素。我们规定屏幕左上角为坐标原点，$x$ 轴从原点向右延伸，$y$ 轴从原点向下延伸。

第 $i$ 个矩形（$i=1,2$）的宽度为 $w_i$ 像素，高度为 $h_i$ 像素，初始时其左上角坐标为 $(x_i, y_i)$，初始移动方向为 $(\delta x_i, \delta y_i)$，其中 $\delta x_i$ 和 $\delta y_i$ 的取值均为 $-1$ 或 $1$。每过一秒，矩形 $i$ 的左上角坐标都会立刻变化 $(\delta x_i, \delta y_i)$。

每当矩形 $i$ 碰到屏幕的左边界或右边界时，$\delta x_i$ 的符号会在下一秒之前反转。同样地，每当矩形 $i$ 碰到屏幕的上边界或下边界时，$\delta y_i$ 的符号会在下一秒之前反转。如果矩形 $i$ 同时碰到两条边界（只能发生在屏幕的角落处），那么 $\delta x_i$ 和 $\delta y_i$ 都会反转。

因此，两个矩形始终完全位于屏幕内部。简而言之，矩形与屏幕边界的碰撞是完全弹性的。注意，尽管如此，矩形的移动依然是离散的：每过一秒，矩形的坐标瞬间移动 $1$ 个像素单位。

你很好奇这两个矩形有多频繁地重叠。当两个矩形的交集面积为正时，认为它们发生了重叠。

设 $f(t)$ 表示在第 $0, 1, \ldots, t-1$ 秒内，矩形发生重叠的时刻数量（其中第 $0$ 秒是矩形开始移动之前）。

请你求出 $\dfrac{f(t)}{t}$ 在 $t \to +\infty$ 时的极限，并以最简分数的形式表示。可以证明，该极限值是一个有理数。

## 说明/提示

对于第二个测试用例，矩形在最初几秒内的状态如下图所示。矩形在第 $\tau=0$ 秒和第 $\tau=6$ 秒发生重叠。例如，$f(8)=2$。

![](https://cdn.luogu.com.cn/upload/image_hosting/nskvvhru.png)

![](https://cdn.luogu.com.cn/upload/image_hosting/jaaryddz.png)

## 样例 #1

### 输入

```
2
3 3
1 1 1 1 1 1
1 1 1 1 1 -1
5 4
2 2 1 1 -1 -1
2 1 2 2 1 -1```

### 输出

```
1/2
1/3```

# 题解

## 作者：_jimmywang_ (赞：2)

远没有 2900。

显而易见的，这个题需要我们找到循环节内，两个矩形相交的次数。

众所周知，两条线段相交的判定为 $\text{intersect}(\ (l_1,r_1),(l_2,r_2)\ )=[\max(l_1,l_2)\le \min(r_1,r_2)]$。

众所周知，两个矩形 $(\ (x_1,y_1),(x_2,y_2)\ ),(\ (x_3,y_3),(x_4,y_4)\ )$（表示方法为左上坐标和右下坐标）相交的判定为 $\text{intersect}(\ (x_1,x_2),(x_3,x_4)\ )\times\text{intersect}(\ (y_1,y_2),(y_3,y_4)\ ) $。

我们把 $x,y$ 两个维度分开考虑。

一个矩形在 $x$ 轴方向的循环节是 $2(W-w)$，那么两个矩形的公共循环节就是 $L_x=\operatorname{lcm}(2(W-w_1),2(W-w_2))\le 4W^2\le6.4\times 10^7$。

我们暴力枚举 $time\in[0,L_x)$ 并模拟这两个矩形的运动，每次 $O(1)$ 得到这两个矩形的 $\text{intersect}(\ (x_1,x_2),(x_3,x_4)\ )$ ，于是我们得到了一个长度为 $L_x$ 的 01 串 $X$。

对 $y$ 轴方向同理，得到长度为 $L_y=\operatorname{lcm}(2(H-h_1),2(H-h_2))$ 的 01 串 $Y$。

众所周知，总循环节应该是 $L=\operatorname{lcm}(L_x,L_y)$，同样这应该是最终答案（化简前）的分母，分子是 $\sum_{i=0}^{L-1}[X_{i \bmod L_x}=1][Y_{i\bmod L_y}=1]$。现在的困难在于求出这个玩意。

换个方式，我们枚举 $X_i=1$ 的 $i$ 和 $Y_j=1$ 的 $j$。那么就是 

$$\sum_{i}\sum_{j}(\text{\# of T, such that } T\equiv i \pmod {L_x},T\equiv j \pmod {L_y})$$

熟悉 exCRT 的人一眼丁真这玩意有解当且仅当 $\gcd(L_x,L_y)\mid (i-j)$，且 $T=T^*+k\operatorname{lcm}(L_x,L_y)=T^*+kL$，其中 $T^*$ 是一个特解。后者相当于告诉我们 $[0,L)$ 范围内要么有唯一解，要么无解；前者等价于 $i \equiv j \pmod{\gcd(L_x,L_y)}$。

于是我们再次转换枚举的东西，因为同余，所以我们枚举余数。设这个 $\gcd(L_x,L_y)=g \le \min(L_x,L_y)\le 6.4\times 10^7$。

$$\begin{aligned}&=\sum_{d=0}^{g-1}\sum_{i}[X_i=1][i \bmod g = d]\sum_{j}[Y_j=1][j \bmod g = d]\\&=\sum_{d=0}^{g-1}(\sum_{i}[X_i=1][i \bmod g = d])(\sum_{j}[Y_j=1][j \bmod g = d])\end{aligned}$$

这两个括号内的东西都能通过扫一遍 $X$ 或 $Y$ 得到。

于是做完了。复杂度 $O(H^2)$（$H,W$ 同阶）。

---


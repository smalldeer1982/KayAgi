# 蒙德里安的噩梦

## 题目描述

小 Z 想用大小为 $1\times2$ 的骨牌覆盖大小为 $n\times m$ 的棋盘，要求棋盘上的每个位置都要被覆盖并且骨牌没有重叠。他认为两块骨牌的短边拼在一起是不好看的，所以他不允许这种情况出现。现在小 Z 已经把棋盘边缘的一圈骨牌放好了，请你求出用骨牌覆盖剩下的区域的方案数。答案可能很大，你只需要求出其对 $998244353$ 取模的结果。

## 说明/提示

### 样例解释

在第一组样例中，小 Z 在棋盘上放置的骨牌如下图所示：

![样例解释1.png](https://cdn.luogu.com.cn/upload/image_hosting/h6i4nzpq.png)

放置的两块骨牌短边相接，是不合法的，所以方案数为 $0$。

---

在第二组样例中，小 Z 在棋盘上放置的骨牌如下图所示：

![样例解释2-1.png](https://cdn.luogu.com.cn/upload/image_hosting/pu487u65.png)

有以下两种合法的方案：

![样例解释2-2.png](https://cdn.luogu.com.cn/upload/image_hosting/dswr4e5i.png)

___

在第三组样例中，小 Z 在棋盘上放置的骨牌如下图所示：

![样例解释3-1.png](https://cdn.luogu.com.cn/upload/image_hosting/0hfaxys3.png)

只有一种合法的方案：

![样例解释3-2.png](https://cdn.luogu.com.cn/upload/image_hosting/3uyw9z4w.png)

### 数据范围与约定

**本题使用捆绑测试。**

对于 $100\%$ 的数据，保证 $1\le n,m\le5\times10^5$，$\frac{3}{2}(n+m-200)\le k\le2(n+m)$，已经放置的每块骨牌没有重叠且都在边缘上，边缘上的每个位置都被已经放置的骨牌覆盖。

对于不同的子任务，作如下约定：

**subtask1(5pts)**：$n\le2$。

**subtask2(10pts)**：$n,m\le10$。

**subtask3(20pts)**：$n,m\le40$。

**subtask4(15pts)**：$n,m\le300$。

**subtask5(20pts)**：$n,m\le1500$。

**subtask6(10pts)**：$k\ge\frac{3}{2}(n+m-3)$。

**subtask7(20pts)**：无特殊限制。

## 样例 #1

### 输入

```
1 4 2
1 1 1
1 3 1
```

### 输出

```
0
```

## 样例 #2

### 输入

```
5 6 12
1 1 2
1 2 2
1 3 1
1 5 2
1 6 2
3 1 1
3 5 1
4 1 2
4 2 2
4 5 2
4 6 2
5 3 1
```

### 输出

```
2
```

## 样例 #3

### 输入

```
6 6 14
1 1 2
1 2 2
1 3 1
1 5 2
1 6 2
3 1 1
3 5 1
4 1 1
4 5 1
5 1 2
5 2 2
5 5 2
5 6 2
6 3 1
```

### 输出

```
1
```

# 题解

## 作者：E_firework (赞：8)

你需要先特判 $n\le2$ 或 $m\le2$ 的情况。

#### 结论1

合法的方案中不存在下图所示的形状：

![结论1.png](https://cdn.luogu.com.cn/upload/image_hosting/hrhhiudz.png)

无论 ① 处的骨牌是横着放还是竖着放都会使得短边相接。

#### 结论2

合法的方案中不存在下图所示的形状：

![结论2.png](https://cdn.luogu.com.cn/upload/image_hosting/q3cfwiyr.png)

① 处的骨牌竖着放都会使得短边相接，横着放会形成**结论1**中的形状。

因为不会有长边拼在一起的连续的三块骨牌，让我们把两块长边拼在了一起形成了 $2\times2$ 的正方形的骨牌称为配对骨牌，把剩下的骨牌称为未配对骨牌。

#### 结论3

如果出现了下图所示的形状：

![结论3_1.png](https://cdn.luogu.com.cn/upload/image_hosting/f98xkjpg.png)

合法的方案中骨牌一定按下图放置。

![结论3_2.png](https://cdn.luogu.com.cn/upload/image_hosting/hmarj5dw.png)

首先 ① 处的骨牌一定是横着放的，否则会使得短边相接，于是变成下图的形状。

![结论3_3.png](https://cdn.luogu.com.cn/upload/image_hosting/by5h7xp6.png)

如果 ② 处的骨牌是横着放置的。

![结论3_4.png](https://cdn.luogu.com.cn/upload/image_hosting/ncxlbzpn.png)

那么 ③ 处的骨牌一定是竖着放的，否则会使得短边相接。

![结论3_5.png](https://cdn.luogu.com.cn/upload/image_hosting/8y5uksp1.png)

④ 处的骨牌一定是竖着放的，否则会使得形成**结论1**中的形状。

![结论3_6.png](https://cdn.luogu.com.cn/upload/image_hosting/29ieb7vj.png)

同理 ⑤ 处的骨牌一定是横着放的，⑥ 处的骨牌一定是竖着放的，⑦ 处的骨牌一定是横着放的，⑧ 处的骨牌一定是竖着放的……骨牌无限向外延伸，方案一定不合法。所以 ② 处的骨牌一定是竖着放置的。对称的位置也同理。

#### 结论4

如果有一组配对骨牌，他们的短边两侧一定是方向不同的骨牌或者边缘。

![结论4.png](https://cdn.luogu.com.cn/upload/image_hosting/i8bulh4m.png)

① 处的骨牌只能这样放，否则会使得短边相接或者形成**结论1**的形状。对称的位置也同理。

#### 结论5

如果有一个未配对骨牌，他的长边两侧一定是方向不同的配对骨牌或者边缘。

![结论5_1.png](https://cdn.luogu.com.cn/upload/image_hosting/o17h37fc.png)

如果 A 是一个未配对骨牌，考虑 ① 处的骨牌怎么放，他不能是竖着放的，不然会和骨牌 A 配对，或者和 A 形成**结论3**的形状，也会导致 A 配对。所以 ① 处的骨牌一定是横着放的。

其他三个位置的骨牌同理。

![结论5_2.png](https://cdn.luogu.com.cn/upload/image_hosting/edxvcpqm.png)

#### 结论6

横着的未配对骨牌和竖着的未配对骨牌不会同时出现。

假设我们有一个竖着的未配对骨牌。

![结论6_1.png](https://cdn.luogu.com.cn/upload/image_hosting/glic0hsq.png)

① 处的骨牌一定是横着放的，否则会使得短边相接。假设他是靠左放置的。

![结论6_2.png](https://cdn.luogu.com.cn/upload/image_hosting/332egvw7.png)

② 处的骨牌一定是竖着放的，否则会使得短边相接。

![结论6_3.png](https://cdn.luogu.com.cn/upload/image_hosting/f163tb5l.png)

骨牌 A 一定是未配对骨牌，否则会形成**结论1**中的形状。

![结论6_4.png](https://cdn.luogu.com.cn/upload/image_hosting/x6ko9ne4.png)

于是竖着的未配对骨牌会一直向上下延伸直到碰到边缘，可以看作是一条从上边缘到下边缘的路径。横着的未配对骨牌会一直向左右延伸直到碰到边缘，可以看作是一条从左边缘到右边缘的路径。如果两者同时存在一定会在中间相交，这是不可能的。

#### 结论7

一个合法的方案可以被横着或者竖着分成若干层，每一层中有相同数量的未配对骨牌。

![结论7.png](https://cdn.luogu.com.cn/upload/image_hosting/jtru70u0.png)

我们可以先确定第一层中的所有未配对骨牌的位置，由**结论4,5,6**不难证明相邻的未配对骨牌之间一定是若干组配对骨牌。然后未配对骨牌向下一层延伸，下一层的未配对骨牌数量一定与上一层相同，下一层的未配对骨牌之间也一定是若干组配对骨牌。便可归纳得到结论。

#### 正解

我们把每一层中的每组配对骨牌或者未配对骨牌看成一个节点，那么每条未配对骨牌的的路径一定是每一层的一个节点走向下一层的上一个或者下一个节点的，并且所有的路径是不相交的。因为 $k\ge\frac{3}{2}(n+m-200)$，所以一条边缘上的未配对骨牌最多只有 $592$ 个，于是我们可以用 LGV 引理解决这个问题。

![正解1.png](https://cdn.luogu.com.cn/upload/image_hosting/s36gtboh.png)

（该图对应着**结论七**中的方案）

如果 $n$ 是层数，$m$ 是每一层的节点数，那么可以使用反射容斥在 $O(\frac{n}{m})$ 的时间复杂度内求出从第一层的某一个节点到最后一层的某一个节点的方案数，如果 $c$ 是每层的未配对骨牌数，那么总时间复杂度就是 $O(\frac{n}{m}c^2+c^3)$。因为有 $c\le m$ 所以时间复杂度不超过 $O(nc+c^3)$，可以通过本题。

---


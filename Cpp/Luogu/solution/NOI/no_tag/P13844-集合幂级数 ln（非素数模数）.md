# 集合幂级数 ln（非素数模数）

## 题目背景

本题为 [集合幂级数 ln](https://www.luogu.com.cn/problem/P12231) 的非素数模数版本。

## 题目描述

给定一个集合幂级数 $F(x)$，保证 $[x^{\varnothing}]F(x)=1$。定义 $x$ 的乘法为子集卷积，可以证明存在一个 $G(x)$ 满足 $\mathrm e^{G(x)}=F(x)$，你需要对 $S\subseteq\{1,2,\cdots,n\}$ 求出 $[x^S]G(x)$ 对 $2^{64}$ 取模后的值。

如果你仍不清楚题意，可以阅读题面最后的提示部分。

## 说明/提示

对于所有数据，保证 $1\le n\le 20$，$[x^S]F(x)\in[0,2^{64})\cap\mathbb Z$，$[x^{\varnothing}]F(x)=1$。

本题有 $20$ 个测试点，第 $i$ 个测试点满足 $n=i$。

#### 【提示】

假设 $F(x)=\sum_S f_Sx^S$，那么 $[x^S]F(x)=f_S$。

在本题中，$x$ 的乘法被定义为子集卷积，即：
$$x^S\cdot x^T=\begin{cases}0&S\cap T\neq\varnothing\\x^{S\cup T}&\text{otherwise}\end{cases}$$

根据泰勒展开，有：
$$\mathrm e^{F(x)}=\sum_{n\ge 0}\frac{F^n(x)}{n!}$$

可以证明本题答案唯一。

## 样例 #1

### 输入

```
2
1 2 3 4```

### 输出

```
0 2 3 18446744073709551614```

## 样例 #2

### 输入

```
4
1 8 3 9 2 0 1 8 7 0 0 1 7 3 4 1```

### 输出

```
0 8 3 18446744073709551601 2 18446744073709551600 18446744073709551611 78 7 18446744073709551560 18446744073709551595 274 18446744073709551609 171 60 18446744073709550139```

# 题解

## 作者：lsj2009 (赞：1)

逐点牛顿迭代。

对 $G$ 求关于 $x_n$ 的偏导得：

$$
\begin{aligned}
\frac{\partial}{\partial{x_n}}G&=\frac{\partial}{\partial{x_n}}\ln{F}\\
&=\frac{1}{F}\times\left(\frac{\partial}{\partial{x_n}}F\right)
\end{aligned}
$$

提取 $[x_n^0]$ 系数，得：

$$
[x_n^1]G=\left([x_n^0]\frac{1}{F}\right)\times\left([x_n^1]F\right)
$$

转换为计算 $H=\frac{1}{F}$；然后对于 $k=1\to n$ 依次算出 $G\bmod{x_1^2x_2^2\cdots x_k^2}$ 的值即可。复杂度 $\sum\limits_{1\le k\le n}k^22^k=\mathcal{O}(n^22^n)$。

计算 $H$ 是同理的，同样求偏导：

$$
\begin{aligned}
\frac{\partial}{\partial{x_n}}H&=\frac{\partial}{\partial{x_n}}
\frac{1}{F}\\
&=-\frac{1}{F^2}\times\left(\frac{\partial}{\partial{x_n}}F\right)\\
&=-H^2\times\left(\frac{\partial}{\partial{x_n}}F\right)
\end{aligned}
$$

提取 $[x_n^0]$ 的系数，得：

$$
[x_n^1]H=-\left([x_n^0]H\right)^2\times\left([x_n^1]F\right)
$$

同样是，对于 $k=1\to n$ 依次算出 $H\bmod{x_1^2x_2^2\cdots x_k^2}$ 的值。

总复杂度 $\mathcal{O}(n^22^n)$，过程中不涉及任何求乘法逆元操作。需要注意循环顺序对常数因子得影响，下面给出一份可以通过本题的代码（删去了 FastIO 部分）：

```cpp
#include<bits/stdc++.h>
// #define int long long
// #pragma GCC optimize(3,"Ofast","inline")
#define debug(...) fprintf(stderr,__VA_ARGS__)
#define ll long long
#define bint __int128
#define ull unsigned long long
#define uint unsigned int
#define ld double
#define PII pair<int,int>
#define chkmax(a,b) a=max(a,b)
#define chkmin(a,b) a=min(a,b)
#define umap unordered_map
#define rep(k,l,r) for(int k=l;k<=r;++k)
#define per(k,r,l) for(int k=r;k>=l;--k)
#define cl(f,x) memset(f,x,sizeof(f))
#define pcnt(x) __builtin_popcount(x)
#define lg(x) (31-__builtin_clz(x))
using namespace std;
void file_IO() {
	freopen("test.in","r",stdin);
	freopen("test.out","w",stdout);
}
bool M1;
const int INF=0x3f3f3f3f;
const ll INFLL=0x3f3f3f3f3f3f3f3f;
const ld eps=1e-9;
const int N=21,M=1<<20;
ull _f[N][M],_g[N][M],_h[N][M];
inline void fmt(ull f[],int n,ull op) {
	n=1<<n;
	for(int d=2,w=1;d<=n;d<<=1,w<<=1) {
		for(int i=0;i<n;i+=d) {
			rep(j,0,w-1)
				f[i+j+w]+=f[i+j]*op;
		}
	}
}
inline void conv(ull f[],ull g[],ull h[],int n) {
	rep(i,0,n) {
		rep(S,0,(1<<n)-1)
			_f[i][S]=_g[i][S]=_h[i][S]=0;
	}
	rep(S,0,(1<<n)-1) {
		_f[pcnt(S)][S]=f[S];
		_g[pcnt(S)][S]=g[S];
	}
	rep(i,0,n) {
		fmt(_f[i],n,1);
		fmt(_g[i],n,1);
	}
	rep(i,0,n) {
		rep(j,0,i) {
			rep(S,0,(1<<n)-1)
				_h[i][S]+=_f[j][S]*_g[i-j][S];
		}
	}
	rep(i,0,n)
		fmt(_h[i],n,-1);
	rep(S,0,(1<<n)-1)
		h[S]=_h[pcnt(S)][S];
}
ull _g2[N][M];
inline void conv2(ull f[],ull g[],ull h[],int n) { // g^2
	rep(i,0,n) {
		rep(S,0,(1<<n)-1)
			_f[i][S]=_g[i][S]=_g2[i][S]=_h[i][S]=0;
	}
	rep(S,0,(1<<n)-1) {
		_f[pcnt(S)][S]=f[S];
		_g[pcnt(S)][S]=g[S];
	}
	rep(i,0,n) {
		fmt(_f[i],n,1);
		fmt(_g[i],n,1);
	}
	rep(i,0,n) {
		rep(j,0,i) {
			rep(S,0,(1<<n)-1)
				_g2[i][S]+=_g[j][S]*_g[i-j][S];
		}
	}
	rep(i,0,n) {
		rep(j,0,i) {
			rep(S,0,(1<<n)-1)
				_h[i][S]+=_f[j][S]*_g2[i-j][S];
		}
	}
	rep(i,0,n)
		fmt(_h[i],n,-1);
	rep(S,0,(1<<n)-1)
		h[S]=-_h[pcnt(S)][S];
}
ull _ft[M],_gt[M];
inline void inv(ull f[],int n) {
	_ft[0]=1;
	rep(i,0,n-1)
		conv2(f+(1<<i),_ft,_ft+(1<<i),i);
	rep(S,0,(1<<n)-1)
		f[S]=_ft[S];
}
inline void ln(ull f[],int n) {
	rep(S,0,(1<<n)-1)
		_gt[S]=f[S];
	inv(_gt,n);
	_ft[0]=0;
	rep(i,0,n-1)
		conv(_gt,f+(1<<i),_ft+(1<<i),i);
	rep(S,0,(1<<n)-1)
		f[S]=_ft[S];
}
ull f[M];
void solve() {
	int n=read();
	rep(i,0,(1<<n)-1)
		f[i]=read();
	ln(f,n);
	rep(i,0,(1<<n)-1)
		printf("%llu ",f[i]);
	puts("");
}
bool M2;
// g++ P13843.cpp -std=c++14 -Wall -O2 -o P13843
signed main() {
	// file_IO();
	int testcase=1;
	// scanf("%d",&testcase);
	while(testcase--)
		solve();
	debug("used time = %dms\n",(signed)(1000*clock()/CLOCKS_PER_SEC));
	debug("used memory = %dMB\n",(signed)((&M1-&M2)/1024/1024));
	return 0;
}
```

---


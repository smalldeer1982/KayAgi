# [集训队互测 2019] 神树大人挥动魔杖

## 题目背景

### 警告：恶意提交本题将被封号。

神树大人想要做一根魔杖，这样他就可以使用「鸽子固定咒」把神 J 固定住了。

第一天，神树大人在自己身上找了一根木头。神树大人使用了树顶上连神 J 都够不到的树枝。由于这根木头不能被凡人所理解，所以神树大人称它为「迷之木」。

第二天，神树大人需要为施法创造环境。于是神树大人花了数小时造了一个完整的魔法世界，由于这个世界不能被凡人所理解，所以神树大人称它为「大象世界」。

第三天，神树大人需要对迷之木附魔。于是神树大人写了一段咒语并让它在大象世界里运行，由于这段咒语不能被凡人所理解，所以神树大人称它为「花之语」。

神树大人邀请神 J 来到大象世界游玩，神 J 迟了若干天才到。神 J 见神树大人嘴里念念有词，便问道：「你在干什么？」神树大人立即掏出迷之木，对准神 J 大喊道：

「system call Joker remove pigeon protection！system call Joker Δεσμευτική！system call Joker ログアウト禁止！...」

神 J 立刻被固定住了。神树大人很满意，于是离开了大象世界，并命令神 J 留在里面做题。由于这些题不能被凡人所理解，所以神 J 只把简化版给了你。

## 题目描述

有一排 $n$ 个格子，有 $m$ 个人，初始都在 $1$ 号格。

每个人可以选择往前跳一格或者跳两格，跳一格的方法数为 $p$，跳两格的方法数为 $q$，跳出 $n$ 个格子则停止，注意在第 $n$ 个格子仍然能选择跳一或两格。

你需要计算有多少种方法使得每个格子都至少被一个人踩过。

## 说明/提示

#### 数据范围及约定

- 对于 $100\%$ 的数据，满足 $1 \le n \le 10^9$，$1 \le m \le 6 \times 10^4$，$1 \le p,q \in [0,998244353)$。

各子任务限制如下：

- 子任务 $1$（ $20$ 分）：$1 \le n \le 10^9$，$1 \le m \le 100$；
- 子任务 $2$（ $10$ 分）：$1 \le n \le 10^3$；
- 子任务 $3$（ $10$ 分）：$1 \le n \le 10^5$；
- 子任务 $4$（ $20$ 分）：$1 \le n \le 10^9$，$1 \le m \le 3 \times 10^4$，$p=q=1$；
- 子任务 $5$（ $40$ 分）：无特殊限制；

## 样例 #1

### 输入

```
10 3 5 6```

### 输出

```
273459417```

## 样例 #2

### 输入

```
2 1 3 4```

### 输出

```
21```

## 样例 #3

### 输入

```
20010910 666 1 1```

### 输出

```
773849796```

# 题解

## 作者：Aleph1022 (赞：6)

首先设一个简单的东西 $h_i$ 表示一个人走到 $i$ 的方案数，就是
$$
h_i = ph_{i-1} + qh_{i-2},\quad h_0=0,h_1=1
$$

然后考虑原问题，容易想到容斥，我们强制某些格子不被踩过，然后将容斥系数附到答案里。  
设 $g_i$ 表示所有人走到 $i$ 并强制不经过 $i-1$ 及若干个格子的方案数，枚举上一个强制不经过的格子，就有
$$
g_i = -\sum\limits_{j=1}^{i-2}(qh_{i-j-1})^mg_j,\quad g_0=0,g_1=1
$$

再设 $f_i$ 表示所有人按照条件走出 $i$ 的方案数，同样枚举最后一个强制不经过的格子，就有
$$
f_i = \sum\limits_{j=1}^i (h_{i-j+1}+qh_{i-j})^mg_j
$$

然后我们必然可以把 $h$ 的 GF $H$ 分解成 $\frac A{1-\alpha x}+\frac B{1-\beta x}$，其具体值留作读者练习。  
再考虑 $h$ 的 $m$ 次方数列，$\hat h$，设其 GF 为 $\widehat H$，自然
$$
\begin{aligned}
\widehat H(x)
&= \sum\limits_{i\ge 0} x^i \sum\limits_{j=0}^m \binom mj A^j \alpha^{ij} B^{m-j} \beta^{i(m-j)} \\
&= \sum\limits_{j=0}^m \binom mj A^j B^{m-j} \sum\limits_{i\ge 0} x^i \alpha^{ij} \beta^{i(m-j)} \\
&= \sum\limits_{j=0}^m \binom mj A^j B^{m-j} \frac 1{1-\alpha^j \beta^{m-j} x}
\end{aligned}
$$

分治 NTT 计算，设 $\widehat H = \frac PQ$，而注意到 $f,g$ 转移时卷上的数列与 $\hat h$ 的递推式显然相同，因此它们 GF 的分母都是 $Q$，从而容易将它们也写作有理分式。  
进一步可以将 $F$ 写作有理分式，然后问题转化为常系数线性齐次递推。  
总时间复杂度 $O(m \log m(\log n+\log m))$。

Update：	求解 $\widehat H$ 的分母，只需计算 q-二项式系数即可。

---


# 「EZEC-5」暴力出奇迹

## 题目背景

# 滥用本题评测将封号！

## 题目描述

给定一个平面，有 $n$ 个竖直线段，第 $i$ 条的端点是 $(i,a_i)$ 和 $(i,b_i)$。

有 $m$ 次查询，每次查询给定 $l,r,x,y$，查询对所有 $(x,i)$ 和 $(y,i)$ 连接成的水平线段，满足 $l\le i\le r$，其最多能与多少竖直线段相交，定义端点为 $(i,a_1)$ 和 $(i,a_2)$ 的竖直线段与端点为 $(b_1,j)$ 和 $(b_2,j)$ 的水平线段相交，当且仅当 $a_1\le j\le a_2$ 且 $b_1\le i\le b_2$，注意当线段两端点重合时，如果有其他线段经过这个重合点，仍然算作相交。

## 说明/提示

注意：本题采用**捆绑测试**，只有当你通过一个 subtask 中的所有测试点后，你才能拿到这个 subtask 的分数。

对于 $100\%$ 的数据，$1\le n\le 5\times 10^5,1\le m\le 9\times 10^5$，$1\le l,r,x,y,a_i,b_i\le n$。

---

## 以下为旧数据范围

对于其中 $5\%$ 的数据，为样例 1。

对于另外 $14\%$ 的数据，$m=1$。

对于另外 $5\%$ 的数据，$n,m\leq 500$。

对于另外 $14\%$ 的数据，$n\leq 500$。

对于另外 $19\%$ 的数据，$n,m\leq 2000$。

对于另外 $19\%$ 的数据，$n\leq 20000$。

对于 $100\%$ 的数据，$1\le n\le 5\times 10^4,1\le m\le 5\times 10^5$，$1\le l,r,x,y,a_i,b_i\le n$。

## 样例 #1

### 输入

```
10
1 8
5 9
5 6
2 8
3 7
4 5
3 7
6 7
3 9
5 10
10
2 4 2 5
5 9 8 10
2 9 3 6
3 7 6 9
1 10 2 9
4 5 1 7
9 10 4 9
2 3 6 9
1 7 6 7
3 10 3 4
```

### 输出

```
2
3
4
3
7
7
1
2
2
2
```

# 题解

## 作者：mrsrz (赞：18)

这篇题解仅讲述问题的转化。

先将题意转述为更容易理解的形式。

> 有 $n$ 个操作，第 $i$ 个操作为 $[l_i,r_i]$，表示对 $[l_i,r_i]$ 区间加一。
>
> $m$ 组询问，每次给出 $l,r,x,y$，要求对一个初始为空的序列执行编号在 $x$ 到 $y$ 之间的操作，然后查询区间 $[l,r]$ 的最大值。

考虑对区间加进行差分，即将 $[l,r]$ 的区间加变成 $l$ 处加一，$r+1$ 处减一，然后区间查询，相当于查询右端点在 $[x,y]$ 内的**前缀**的最大前缀和。不难发现，$1\sim x-1$ 处的值一定会被统计到答案中，因此可以把询问分成查询 $[1,x-1]$ 的和，以及 $[x,y]$ 的**区间最大前缀和**。前者可以使用二维数点在 $O(n\log n+m\log n)$ 内解决，重点在于求出后者。

对每个 $i$，从 $[l_i,r_i]$ 中可以得到两个三元组 $(l_i,i,1)$，$(r_i,i,-1)$。

我们将所有三元组以第一个元素为关键字从小到大排序，得到一个长度为 $2n$ 的三元组序列。我们称位置 $i$ 的第三个元素为位置 $i$ 的值（为保证结果正确，在第一个元素相同时，值为 $1$ 的在前）。然后一次查询的 $[x,y]$ 对应这个序列上的一个区间。

于是现在的查询操作实际上是：仅保留第二个元素在 $[l,r]$ 内的位置的值，其他位置的值为 $0$ 时，查询 $[x,y]$ 对应的区间的区间最大前缀和。

这个问题有一个[强化版的问题](https://www.luogu.com.cn/problem/P5611)，查询的是最大子段和信息，而维护该信息的同时需要维护本题所需的最大前缀和信息。因此直接使用该题的做法即可解决本题。具体可以见我的[题解](https://www.luogu.com.cn/blog/Mrsrz/solution-p5611)。

该做法的时间复杂度为 $O((n+m)\sqrt n)$，空间复杂度为 $O(n+m)$，实现时需要注意常数因子。

---


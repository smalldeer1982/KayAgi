# 再生之青

## 题目背景

YSGHYYDS

## 题目描述

YSGH 有一个大小为 $n$ 的树和一个长度为 $m$ 的序列。

树上每个点 $i$ 有颜色 $c_i$ 和价值 $a_i$，颜色两两不同，**保证叶子个数不超过** $\boldsymbol{20}$。

序列第 $i$ 个位置也有一个颜色 $d_i$ 和价值 $b_i$，颜色也两两不同（但树和序列颜色可能会相同）。

YSGH 想从树上选一条链和序列的一个区间满足一个颜色最多只能出现一次，他想知道他能选出来的最大的价值和。

## 说明/提示

**【样例解释】**

最优方案是选择树的 $1, 2, 3, 4$ 号节点和序列的第 $2, 3$ 个位置。

价值和是 $10 + 2 + 3 + 7 + 1 + 7 = 30$。

---

**【数据范围】**

**本题采用捆绑测试。**

对于 $100 \%$ 的数据，$1 \le n \le 5 \times {10}^4$，$1 \le m \le 5 \times {10}^5$，$1 \le c_i, d_i \le n + m$，$1 \le a_i, b_i \le {10}^9$，保证树的叶子个数不超过 $20$。

+ Subtask 1（10 points）: $n, m \le 500$。 
+ Subtask 2（10 points）: $n, m \le 1000$。 
+ Subtask 3（10 points）: $n, m \le 5000$。 
+ Subtask 4（20 points）: 满足树的第 $i$ 条边连接的是 $i$ 和 $i + 1$。 
+ Subtask 5（15 points）: $m \le {10}^5$。
+ Subtask 6（35 points）: 无特殊限制。 

## 样例 #1

### 输入

```
4 4
1 2
2 3
3 4
1 2 3 4
10 2 3 7
2 5 6 1
5 1 7 2```

### 输出

```
30
```

# 题解

## 作者：加藤惠 (赞：10)

先来考虑如果树是条链怎么做。

首先注意到如果第一个序列选了区间 $[l,r]$，那么第一个序列的第 $l − 1$ 个位置和第 $r + 1$ 个位置肯定在第二个序列中选了，否则显然移动 $l$ 或者 $r$ 能得到一个更优秀的解。

考虑对于第一个序列分治，每次需要计算当 $l$ 落在 $[l, mid]$ 和 $r$ 落在 $[mid + 1, r]$ 中的答案。

处理出前半部分每个后缀和后半部分每个前缀的第二个序列的最优选择方案，注意到合并两者的时候第二个序列的选择方案就是处理出来两者的最优选择方案的交，按第一维排序后，数据结构维护第二维的就行。

到树上的话把分治换成点分治就行。

还有一个问题是如果树上选的一条链的一端是叶子不能套用这个做法，需要特判。

记叶子个数是 $k$，时间复杂度为 $O(n\log n\log m+nk\log n+m)$。

---

## 作者：qscisQJing (赞：1)

先考虑只有两个序列的情况。

设这两个序列一个是 A，一个是 B。我们在 A 上选区间，然后在 B 上查询。

考虑如何拓展 A 上的区间，发现涉及到分裂，较为麻烦。我们可以基于缩小区间实现一个 $ O(nm) $ 复杂度的算法，只需在 A 上对每个左端点扫一次即可。

考虑优化它。

由于缩小区间的操作涉及当前序列 B 的状态，直接优化是困难的。可以考虑序列分治。

在分治完 $ [l,mid] $ 和 $ [mid+1,r] $ 之后，我们需要拼接一段后缀与前缀并统计它们的贡献。

这里先给出结论：如果我们对每一个前缀和后缀处理出它们在 B 上的能选择的最优区间，那么最优解一定在某两个最优区间的交上。

下面是证明。

首先，我们先只看每一个 A 上的区间 $ [l,r] $，这个区间最优的必要条件是 $c_{l-1}$ 和 $ c_{r+1} $ 都在 B 的最优区间中，否则 $ [l-1,r] $ 或 $ [l,r+1] $ 一定更优。我们把这称为结论1。

每一个前缀与后缀的最优区间都满足这个条件。

接下来用反证法来证区间交的结论。

不妨设最优解在 A 上的区间为 $ [x,y] $，产生最优解的 A 上的前缀后缀在 B 上的最优区间为 $ [l,r] $ 与 $ [l',r'] $，且 $ l\le l' $。

如果 $ r < l' $，对两个前缀后缀最优区间应用结论1，可以得到 $ c_{x-1} $ 在 $ [l,r] $ 上，且 $ c_{y+1} $ 在 $ [l',r'] $ 上，且最优解包含这两种颜色。

但既然两区间没有交集，$ [x,y] $ 一定要经过 $ r+1 $ 和 $ l'-1 $ 这两个 B 上的点。别忘了，由于 $ [l,r] $ 和 $ [l',r'] $ 的最优性，它们已经在 B 上拓展到最大了，此时 $ r+1 $ 和 $ l'-1 $ 一定是不可选的。这就矛盾了。

如果 $ l' \le r $，由于上文已经说过的两区间的最优性，$ [x,y] $ 一定和 $ [l',r] $ 没有交集。进而，它也和 $ [l,r] $、$ [l'r']$ 的其中一个没有交集。不妨设这个没有交集的区间是 $ [l,r] $。

首先，根据结论1，我们可以得到一个和上文类似的东西，即两个端点的颜色分别属于前后缀最优区间且同时在最优解区间中。然后，又因为 $[x,y]$ 和 $ [l,r] $ 没有交集，必然有至少一个颜色不属于 $ [x,y] $ 中，这和它的最优性矛盾。

综上，我们的结论是对的。只要维护区间交和一些权值的计算即可。

如果把这个问题放在树上，可以用点分治维护，然后写一个树套树来统计跨子树且区间有交集的贡献，再写一个主席树统计区间无交集的贡献。单次时间复杂度是 $ O(\log^2m) $ 的。

套上点分治，如果全用树套树实现，总时间复杂度复杂度 $ O(n \log n \log^2m) $，而且不依赖叶子的数量。时限 3s 勉强能过。

upd:树套树可以用第二个主席树代替，但由于主席树的不可删性，如果正常维护会和叶子的数量挂钩，最终复杂度和树套树类似。

当然，我们可以建出每个子树对应的主席树，再建一颗总的主席树，之后分别二分。均摊下来复杂度是对的，即 $ O(n\log n\log m) $，且实现较树套树较简单。

大概能过 $ n \le 2 \times 10^5 $ 且 $ m \le 10^6 $
 的数据，而且无需限制叶子个数。
 
~~建议整个加强版。~~

---


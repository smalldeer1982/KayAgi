# 『JROI-4』傀影与猩红孤钻

## 题目背景

“水……”

在沙尘暴中跋涉许久，又整整一天没有饮水，身体已经逐渐支撑不住了。

凯尔希没有拿水瓶，而是冷冷地说了一句“再撑一会”，随后就自顾自继续向前赶路。

我们已经在沙暴里跋涉了多久？三个小时？还是五个小时？黄沙不停往衣物里涌，狂风则不停将沙尘甩在脸上，刮得眼睛都睁不开。但我们还不能停步，后面的萨卡兹雇佣兵还在紧追不舍，他们尽职尽责，即使是沙暴都阻挡不了他们的脚步。

至于水……或许早就喝完了吧。

听说沙漠里有在空水壶中灌沙来给人以希望的传统，可现在，沙子我已经喝够了，水，我只想喝口水，哪怕用身上所有的硬币去换，我也愿意。

只是在这荒野里，闪亮的金属毫无意义。

紧紧抱着银色的手提箱，我咬紧牙关继续迈步。

耳边都是凄厉的呼啸，像是亡者的哭号，又像是鬼魂的呼唤。索恩教授或许也在其中，呼唤着我的名字？

但我听不太清了。

脑中满是这样的响声，已经多久了？三分钟？三小时？还是三年？

沙尘遮蔽了天空，白天和黑夜已经毫无区别，时间似乎都已凝滞，只有在其中求生的人们，还在忍受着此间种种刑罚。

我只是想做研究，我只是想为科学进步奉献自己的力量，而不是像现在这样，倒在沙海里风干。

脑袋又酸又胀又痛，身体好像早就没了知觉，我是在行走吗，还是在看着这具名为艾利奥特的躯壳蠕动？

不……思考也成为了一种奢求，现在徘徊在脑袋里的，只有一个指令：移动。

移动……移动……移动……

……但沙海是无垠的。

“艾利奥特，张嘴。”

张嘴？

我下意识地放松肌肉，让嘴唇和牙齿露出一条通往口腔的通道。

一串沾满沙土的果实落到了口中。

有些酸涩？有些甘甜？哦，是水，是水。

是水啊。

……

不知从什么时候开始，耳边再也没有风声，大地回复了寂静，只有阳光，沙漠，和两个在沙丘间徒步的凡人。

……

我望向远方，除了黄沙，还是黄沙。

一眼望不到尽头，就像散落满地又被浸湿的皮鞋踩上几脚的技术文件，再也归不拢，再也理不齐。

我忿忿地踢了一脚沙子，看着它们从沙丘尖端翻滚滑落，然后重新融到沙漠中，好似什么都没有发生过。

沙子，沙子。

我生平第一次开始痛恨沙子。

“走吧，很快就能获得补给了。”

凯尔希打断了我的思绪。

可，很快？能有多快？

一些补给？又有多少呢？

呵，凯尔希从来不向人许诺希望。

但至少……

我似乎看见了一颗仙人掌。

## 题目描述

## 我们在题目描述的最下方提供了形式化题意，若您不想阅读整活部分可以直接跳到题目描述的最下方。

神在猩红剧团的探索中取回了自己一部分的力量，不多，但够用。

神见到了傀影。准备使用辉煌裂片对他进行审判。

但是傀影躲进了一个被分成 $d$ 层的 DAG 中。

具体地，DAG 上第 $i$ 层的节点只会连向第 $i+1$ 层的节点。

“那就陪你继续玩玩吧。”神心想。

神决定了一种审判的方式。

具体地，神最开始有一些辉煌裂片。神认为，多项式具有强大的力量，所以辉煌裂片就是多项式。~~我才不告诉你是我懒得编题面。~~

神有三种对辉煌裂片的操作：

1. “无度”

可以让辉煌裂片更加强大。具体地，对 $F(x)$ 进行这个操作就相当于令 $F(x)=F^2(x)$。

2. “文明的存续”

可以让“无度”后的辉煌裂片更加强大。具体地，对 $F(x)$ 进行这个操作就相当于令 $F(x)=F(x^2)$。

3. “夜骇”

可以让两个辉煌裂片进行融合，变得更加强大。具体地，如果对 $F(x)$ 和 $G(x)$ 进行这个操作会返回一个多项式为 $F(x)+G(x)$。

神决定这样对傀影进行审判：

在第一层的节点放置辉煌裂片。

当辉煌裂片进入一个节点前，对自身进行“无度”。

当两个辉煌裂片相遇，对这两个辉煌裂片进行“夜骇”，只会留下一个辉煌裂片为这两个辉煌裂片进行“夜骇”的结果。

辉煌裂片只会在连接该节点的所有边都有辉煌裂片通过后，才会离开该节点。当辉煌裂片离开一个节点时，辉煌裂片会对进行“文明的存续”，然后分裂成若干个和原辉煌裂片相同的辉煌裂片，留下一个辉煌裂片在该节点。然后，每条边都将通过恰好一个辉煌裂片。

若傀影在节点 $u$，而神有一个审判指数（execution points，EXP）$k$，该节点留下的辉煌裂片为 $F_u(x)$，那么傀影将会受到 $F_u(k)$ 伏特的电流。

现在神有一些提问。每个提问类似于，若傀影藏在节点 $u$，且审判指数为 $k$，那么傀影将会受到多少伏特的电流？

神是怜悯的。答案可能过大，他只要求你输出答案对 $7340033(2^{20}\times7+1)$（一个质数）取模后的结果。
### 形式化题意
给你一张分为 $d$ 层的 DAG，每个节点都有一个多项式 $F_u(x)$。**可能会有重边。**

这个 DAG 上第 $i$ 层的节点只会向第 $i+1$ 层的节点连边。

若 $S_u$ 包含所有连向点 $u$ 的节点，那么满足 $F_u(x)=\sum_{v \in S_u}F_v^2(x^2)$。

给出第一层节点的多项式，每次询问会给你 $u,k$，然后询问 $F_u(k)$ 对 $7340033(2^{20}\times7+1)$（一个质数）取模后的结果。

**请注意，重边算作一条边。**

## 说明/提示

- Subtask1（7pts）$1\leq d\leq 2$。
- Subtask2（20pts）$1\leq d\leq 10,\sum q=1$。
- Subtask3（13pts）$n_1=2$，且时间限制为 5s。
- Subtask4（60pts）无特殊限制。
- Subtack5（0pts）Hack 数据。

对于 $ 100\% $ 的数据，满足 $1\leq\sum n<5060$，$1\leq d\leq 10$，$\sum q\leq 1.5 \times 10^6$，$1\leq w,k<7340033$，$0 \leq p \leq 2$。

若第 $i$ 层有 $m_i$ 条边，对于 $i\neq d$ 保证有 $n_i<n_{i+1}\leq2\times n_i$ 和 $n_i\leq m_i\leq 3\times n_i$，且 $m_d=0,1 \leq n_1 \leq 5$。

## 样例 #1

### 输入

```
3
1 2 2
1 1 1

2 1
1 1
1 2
1 3

3 2
1 1
1 2
2 2
2 5
1 36

0 2
1 7
2 6```

### 输出

```
0
1352
10488222
//下面是加密前的输出
4
676
1682209
3496074
4354184```

# 题解

## 作者：Prean (赞：5)

~~为了我，歌唱吧，歌唱吧，歌唱吧！！1（大雾）~~
## Subtask1
暴力，可以获得 $7$ 分的高分！
## Subtask2
注意到只有一个询问，也就只有一个点值。

点值的性质有两个：$f(k)\times g(k)=(f\times g)(k),f(k)+g(k)=(f+g)(k)$。

我们假设询问的那个点在第 $d$ 层，那么我们对第 $d-1$ 层维护多项式在 $k^2$ 处的点值，对于第 $d-t$ 层维护多项式在 $k^{2^{t}}$ 处的点值。

## Subtask3
这一档部分分是为 NTT 留的。

注意到可以不用复合 $x^2$，只要在最后计算在 $k^{2^{d}}$ 处的点值即可。暴力计算就行。
## Subtask4
因为询问求的是点值，那么我们就对所有节点维护点值吧。

多项式乘法的本质是点值，DFT 计算的就是点值，所以考虑对所有节点上的多项式做一个长度为 $mod-1$ 的 DFT。

即求出 $F_v(g^k)$。

注意到每次平方的时候会有 $(+x)^2=(-x)^2$，也就是说会出现不同的点但是值相同的情况。

并且再次注意到对于每一层相当于出现了一个 $len[d]$ 有 $F_v(g^k)=F_v(g^{k\bmod len[d]})$，也就是说有一个循环节。

直接维护这个循环节就好了，多项式的点值乘起来和加起来都是 $O(1)$的，总复杂度 $O(d\times mod+\sum q)$。

标算核心部分：
```cpp
while(m--){
	u=read();v=read();if(vis[u][v]==T)continue;vis[u][v]=T;
	F[now][v][0]=(F[now][v][0]+1ull*F[now^1][u][0]*F[now^1][u][0])%mod;
	for(i=1;i<len;++i)F[now][v][i]=(F[now][v][i]+1ull*F[now^1][u][i<<1]*F[now^1][u][i<<1])%mod;
}
while(q--)u=read(),v=read(),ans^=q*F[now^1][u][lg[v]%(len<<1)];

---


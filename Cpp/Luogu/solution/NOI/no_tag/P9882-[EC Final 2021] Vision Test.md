# [EC Final 2021] Vision Test

## 题目描述

庞教授有着非凡的视力。他能看到 4K 显示器上的像素。为了测试庞教授的视力，寿教授将展示给庞教授几个像素，并让庞教授猜测一条包含这些像素的直线。给定 $k$ 个像素，其坐标为 $(i, y_i)$（$0 \le i < k$），庞教授必须找到非负整数 $a, b$ 和 $c$（它们表示直线 $y = \frac{ax+b}{c}$），使得 $y_i = \lfloor \frac{ai+b}{c} \rfloor$ 对于所有 $0 \le i < k$ 成立。

寿教授将向庞教授提出多个问题。问题如下：寿教授有一个固定的数组 $x_1, \ldots, x_n$。对于每个问题，寿教授选择数组中的一个范围 $x_l, \ldots, x_r$。然后他定义 $y_i = x_{l+i}$ 对于 $0 \le i \le r - l$，并要求庞教授回答关于这些 $r-l+1$ 个像素 $(0, y_0), \ldots, (r-l, y_{r-l})$ 的问题。

请帮助庞教授回答所有问题。对于每个问题，输出 **按字典序最小** 的 $(c, a, b)$ **作为答案**。

保证当庞教授选择整个数组 $x_1, x_2, \dots, x_n$ 时，答案存在。因此，当庞教授选择该数组的一个区间时，答案总是存在的。

## 说明/提示

题面翻译由 ChatGPT-4o 提供。

## 样例 #1

### 输入

```
3
5
1 1 2 2 2
4
1 5
1 1
3 5
2 3
5
1 2 3 4 6
3
1 5
2 4
3 5
3
0 3 5
1
1 3
```

### 输出

```
1 4 3
0 1 1
0 2 1
1 1 1
5 4 4
1 2 1
3 6 2
5 1 2
```

# 题解

## 作者：Rainbow_qwq (赞：7)

[[EC Final 2021] Vision Test](https://www.luogu.com.cn/problem/P9882)

设 $K = \frac{a}{c},B = \frac{b}{c}$，则题目需要找到 $K,B$ 使得满足 $a_i = \lfloor{Ki+B}\rfloor$.

如果固定 $K$，考虑 $B$ 需要满足的条件：

$$a_i \le Ki+B < a_i+1$$

$$\max(a_i-Ki) \le B < \min(a_i+1-Ki)$$

则如果 $\min(a_i+1-Ki)>\max(a_i-Ki)$，那取 $B = \max(a_i-Ki)$ 就得到了一组解。

如果不满足的话，也就是此时 $\min(a_i+1-Ki)-\max(a_i-Ki)\le 0$。

设 $i_{\min}$ 为取到 $\min(a_i+1-Ki)$ 的下标 $i$，$i_{\max}$ 为取到 $\max(a_i-Ki)$ 的下标 $i$。

则如果 $i_{\min} > i_{\max}$，增大 $K$ 会使 $a_{i_{\min}}+1-Ki_{\min}-(a_{i_{\max}}-Ki_{\max})$ 减小，从而不可能成立，因此此时要减小 $K$。同理，若 $i_{\min}<i_{\max}$ 则要增大 $K$。

不难发现 $K$ 满足可二分性。于是在 Stern-Brocot Tree 上二分 $K$，这同时能满足题目中字典序的要求。

由于 $K$ 在 Stern-Brocot Tree 中的深度很大，二分时要每次跳一条链才能保证复杂度。每次在链上二分求出能跳的长度，总共 $O(\log^2 V)$ 次调用 check。实际上使用倍增二分，只有 $O(\log V)$ 次调用 check，因为 check $O(t)$ 次后值域会变为原来的 $2^t$ 级别。

接下来问题是对于一个区间，给定 $K$，查询 $\max(a_i-Ki)$ 及其下标，$\min$ 的问题同理。

可以直接用回滚莫队（不删除莫队）制作出区间凸包信息，然后在凸包上二分查询，时间复杂度 $O(n\sqrt q + q\log  V \log n)$。

当然也有多种 polylog 做法，比如对序列进行分治，每次处理跨过 $mid$ 的询问，需要处理出 $[ql,mid],[mid,qr]$ 两个前缀凸包的信息。

建前缀凸包的过程是加入一个点，弹出栈中的若干个点。那可以看作当前点向弹栈后下一个点连边，形成一棵树，前缀凸包信息就是一条当前点到根的链，查询时在树链上倍增即可替代凸包上二分。时间复杂度 $O(n\log^2 n + q\log V\log n)$。

[Code](https://www.luogu.com.cn/paste/kgwt1caq)

---


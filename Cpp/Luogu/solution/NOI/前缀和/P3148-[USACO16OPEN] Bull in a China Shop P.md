# [USACO16OPEN] Bull in a China Shop P

## 题目描述

Farmer John 决定给他的家增添一些装饰。在当地的瓷器店里，他发现了一尊精致的玻璃牛雕像，决定购买它，因为它完美地适合放在壁炉上方的壁炉架上。

牛雕像的形状由一个 $N \times M$ 的字符网格描述（$3 \leq N, M \leq 500$），其中小写字母字符代表雕像的各个部分（表示不同的颜色），而 '.' 字符则不代表雕像部分。

```cpp
...............
...............
x..x...........
xxxx...........
xxxxaaaaaaa...
.xx.aaaaaaaaa..
....aaaaaaa.aa.
....ll...ll....
....vv...vv....
...............
```

不幸的是，就在 FJ 准备购买之前，一头公牛冲进了商店，不仅撞碎了 FJ 的雕像，还撞碎了许多其他货架上的玻璃制品！FJ 的雕像碎成了 3 块，并迅速混入了地上的 $K$ 块碎片中（$4 \leq K \leq 100$）。每一块碎片都由一个字符网格描述，就像原来的雕像一样。

请帮助 FJ 确定有多少组 3 块碎片（地上的 $K$ 块中）可以粘合在一起修复他破碎的雕像。

地上的碎片可能被垂直或水平翻转，或者旋转了 90 度的倍数。因此，给定原始网格以及描述碎片的 $K$ 个网格，你需要找到可以组合成原始图片的 3 块碎片，允许碎片被平移、翻转或旋转 90 度的倍数。当这 3 块碎片叠加在一起时，它们应该准确地形成原始图片，且原始图片中的每个彩色方块都恰好出现在一块碎片中。

## 说明/提示

三个解决方案使用了碎片 $(0, 1, 2)$、$(0, 2, 4)$ 和 $(1, 3, 4)$。

请注意，这个问题每个测试用例的时间限制为 6 秒（Java 和 Python 提交的时间限制为 12 秒）。

备注：原文“输入格式”部分中 $R, C$ 的范围是 $1 \leq R, C \leq 100$，而实际数据与之不符，疑为笔误。

## 样例 #1

### 输入

```
5
5 5
aaaaa
..a..
bbabb
..a..
aaaaa
3 5
..abb
..a..
aaaaa
5 2
a.
a.
aa
a.
a.
1 2
bb
1 5
bbabb
2 5
aaaaa
..a..```

### 输出

```
3```

# 题解

## 作者：Felix72 (赞：3)

题号这么小的黑题还没有题解，我给完善一下。

一个想法是枚举三块拼图和他们的旋转角度、是否翻转以及坐标，这样的复杂度是 $O(K^3N^4)$ 的（忽略枚举方向的 $8$ 倍常数）。

要优化这个算法，我们有以下方法：

- 定义一块拼图的**左上坐标**为其最左边的有颜色的单元格坐标，若有多个取最上面的坐标。若已知原拼图的左上坐标来自第 $i$ 块拼图，则该位置来自第 $i$ 块拼图的左上坐标；
- 使用哈希快速判断两块拼图是否相等。

第一个优化使得枚举前两块拼图时无需枚举其位置，第二个优化使得枚举第三块拼图时可以 $O(1)$ 判断，时间复杂度来到 $O(K^2N^2)$。

如果 $R, C$ 如题面说的一样在 $100$ 之内，那这个复杂度确实是能过的（$100^4 = 10^8$），但是数据中 $R, C$ 好像和 $N, M$ 一个量级，再加上 $8$ 倍常数的影响，肯定是无法通过的。这时需要一些剪枝：

- 枚举所有的 $x, y, z$，先判断一下这三块拼图是否在颜色个数和上和原拼图相等，这样可以筛出一些二元组 $(i, j)$，保证 $i, j$ 同时存在的拼法一定非法。这样 $O(K ^ 2)$ 就跑不满了；
- 对一块拼图，先枚举其 $8$ 中不同的方向，如果其中有相同的，后面就不枚举它，这样 $8$ 倍常数也跑不满；
- 对一块拼图，先计算出其左上坐标，判合法的时候就无需再算一次了，这样 $O(N^2)$ 带的常数变小。

这三个剪枝不容易同时卡掉至少两个（或者说数据没卡），可以通过。

---


# [集训队互测 2024] 无限地狱

## 题目背景

**由于评测机性能差距，本题时限增加了 1.5 秒。**

欧雷尔斯和右方之火失败了。等到上条当麻赶到时，欧雷尔斯中了妖精化而失去魔神之力，身受重伤，生死不明。右方之火也完全不知所踪。

而被他们打入妖精化的欧提努斯，却从 50% 可能性的不完美魔神，变成了 100% 失败的，另一种全盛魔神。

「小场面战斗什么的太麻烦啦。就让我令世界终结吧！」如她所言。紧接着，一切都毁灭了。

当麻醒来时，发现周围一片漆黑，下面是延伸到无穷远，没有起伏的平面。除了自己和欧提努斯之外什么都没有。

「我所破坏的可不止是“地球”这个渺小的行星而已啊」欧提努斯说道。

当麻认定欧提努斯在撒谎，欧提努斯索性让当麻亲自确认。 当麻走在一片黑暗中，不知自己走了多久，直到双腿走到瘫软。只有黑暗和寂静，没有山川河流，没有日月星辰。

欧提努斯深知杀死当麻，幻想杀手还会寄宿在其他人身上。因此只有将当麻的反抗意志抹除，使幻想杀手的力量永远封存在当麻体内，这才是最佳的办法。但欧提努斯是神，没必要为了击溃一个人类的意志亲自动手。就在此时，主神之枪光芒四射，欧提努斯要让当麻亲自领悟到自己先前所做的一切是多么的渺小，世界顿时被光芒笼罩。

当麻在二楼一张床上醒来，这是一个没有天花板的屋子，周围有烧焦的味道，星空如往常一样安宁。屋里的电视机上播放一条新闻：「多国联军发起的剿灭上条当麻的作战正在进行，二十三区七成区域化为废墟，上条当麻生死不明。」

当麻看得一头雾水，这时当麻才注意到城市的大范围停电和四处燃烧着的烈火。电视切换到了美国总统，他声明在确认当麻死亡之前绝不会停止打击。虽然现在无法判断打击上条当麻而牺牲无辜者的行为是否正义，但百年后的人们一定会称赞这种行为。因为如果现在放过上条当麻，百年后将只剩下废墟和残骸。就在当麻猜测这是引诱『格雷姆林』的情报战时，欧提努斯出现在当麻身后，她拿出遥控器切换电视节目。各国首脑都在报道当麻的罪恶以及杀死当麻的决定。

「你对那些人做了什么！」当麻大喊道。欧提努斯称并没有威胁他们，这不是梦境和幻觉，而是欧提努斯创造出来的现实世界，并提醒当麻再不离开这里就会死。此时俩个人提着手电赶来，来调查电视为何开着。他们砸碎了玻璃，当麻找地方藏起来。但万万没想到他们并未进屋，而是往屋内放火。当麻从二楼跳出去，在着陆后，有人朝当麻开枪，当麻注意到那俩人居然是警察。当麻甩开他们后躲在电线杆处休息，欧提努斯站在电线杆顶部庆祝当麻通过了最初试炼，并告诉当麻自己什么都没做，只是将立场改变而已。

欧提努斯的声音响起，「在你用拳头击倒敌人而保护别人时，在你为结束三战立下不可磨灭的功劳时，你被当做英雄，理所当然地受到追捧，正面完全掩盖了负面，这是原来的世界。但如果将立场改变，你对每个反对自己意见的人都会施加拳脚，甚至用拳脚影响整个三战走向，这种行为比那些独裁者有过之而无不及，这就是现在的世界。我并没有给那些人洗脑，而只是将你的负面展现给世人罢了。」

当麻在路上看到很多人因饥饿而死，昔日的城市变成废墟。紧接着，多国联军对所有可能藏匿当麻的地方展开空袭，接纳逃难学生的地方均被轰炸。当麻急于确认父母的安全，突然一把菜刀插进当麻背部，当麻倒地不起，小萌老师拔出菜刀，向上条道歉，但她不能容忍其他同学受罪。远处的电视出现了当麻父母的身影，父母在电视上公开承认当麻是他们的儿子。小萌拿着带血的刀，流着泪再度走向上条。

当麻的父母在电视上请求让他们夫妻俩亲自处决儿子，并请求大家原谅自己生下当麻的罪孽。当小萌再度举刀时，欧提努斯蹲在当麻面前问当麻，「人们都是在看到你的名字，外表和事迹之后，就擅自认定你是什么样的人了。然而只要改变一下立场，就算你做的事情并没有丝毫改变，他们依旧会烧你，追你，打你甚至杀你，如果有人能正确看待你，那至少也会有一个人来救你吧。然而到头来，没有一个人了解真实的你。这样的人，值得救吗？」

当麻依旧回答，「就算这样，也有救他们的价值。」

欧提努斯表示当麻简直无可救药。然后打了个响指，小萌挥下菜刀……

当麻睁开眼睛，发现自己在午休时趴在课桌上睡着了。而自己的身体并没有受伤，原来是个噩梦啊！当麻舒了口气。

接着，当麻发现，一个和当麻的身高，体重，五官，发色完全不同的人，却被众人当成了真正的上条当麻。而上条当麻本人，却独自一人坐在教室的一处不被任何人注意的椅子上……

这便是欧提努斯为了摧毁上条当麻的意志，所创造的『无限地狱』：不断创造新的世界，否定当麻存在的意义，再用不同的方式杀死他，摧毁这个世界。

当麻也曾想过放弃，但最终，他决定遵从自己的意志，向魔神挑战。即便欧提努斯动动手指便可以杀死他，即便已经死了数千亿次。

## 题目描述

在其中一个世界，欧提努斯给了当麻 $1 \sim n$ 的所有整数。

当麻要将这些数划分成三个集合（可以为空），要求任意两个属于不同集合的元素之和不在剩下的那个集合之内。集合之间是无序的。

如：$\{4\}$, $\{2, 6\}$, $\{1, 3, 5\}$ 是 $n = 6$ 时的合法划分方案。而 $\{1, 2, 4\}$, $\{3, 6\}$, $\{5\}$ 却不是，由于 $2 + 3 = 5$。

欧提努斯要求当麻计算这样的划分的方案数对 $998244353$ 取模的值，否则就杀死他。

当麻没学过 OI，于是他不会做。但好在，这个世界里还有你的存在，请帮助他求出方案数。

## 说明/提示

### 数据范围与约定

- Subtask 1（4%）：$n \leq 10$；
- Subtask 2（13%）：$n \leq 40$；
- Subtask 3（17%）：$n \leq 3000$；
- Subtask 4（21%）：$n \leq 10^6$；
- Subtask 5（22%）：$n \leq 10^9$；
- Subtask 6（23%）：$n \leq 2 \times 10^{10}$；

## 样例 #1

### 输入

```
11```

### 输出

```
1092```

## 样例 #2

### 输入

```
4```

### 输出

```
9```

## 样例 #3

### 输入

```
514```

### 输出

```
653467211```

# 题解

## 作者：Nesraychan (赞：1)

## 题目大意

将 $1\sim n$ 的所有整数划分成三个集合，要求任意两个属于不同集合的元素之和不在剩下的那个集合之内。集合之间是无序的。

求方案数，对 $998244353$ 取模。

## 数据范围

$\operatorname{Subtask} 1(4\%):n\le 10$。

$\operatorname{Subtask} 2(13\%):n\le 40$。

$\operatorname{Subtask} 3(17\%):n\le 3000$。

$\operatorname{Subtask} 4(21\%):n\le 10^6$。

$\operatorname{Subtask} 5(22\%):n\le 10^9$。

$\operatorname{Subtask} 6(23\%):n\le 2\times 10^{10}$。

## 题解

### 算法 $1.1$

暴力枚举集合划分，并判断是否满足题意。

朴素实现复杂度为 $O(3^nn^2)$，可以通过子任务 $1$，期望得分 $4$ 分。

### 算法 $1.2$

对暴力搜索进行剪枝，如果已经不满足题意就直接返回，不继续搜索。

此时代码速度没有质的改变，原因是若允许含空集，答案相当大，而这部分答案为 $2^{n-1}$。

而对于三个集合都非空的情况，其实方案数是不多的。考虑先钦定三个集合里的某个数，再结合剪枝进行搜索。

可以做到较快的指数级复杂度，可以通过子任务 $2$，期望得分 $17$ 分。

### 算法 $2.1$

由于指数级复杂度已无法满足我们的需求，于是尝试找出若三个集合非空，他们所拥有的性质。

不妨设三个集合按照最小元素的值升序排序后依次为 $A,B,C$。设 $a_i(1\le i\le |A|)$ 为 $A$ 中元素升序排序后的第 $i$ 个元素。同理于 $B,C$。设 $g=\gcd(c_1,c_2,\dots,c_{|C|})$。

#### 引理 $1$

**对于 $1\le i,j\le |C|$，若 $x\not \equiv 0\pmod{g}$ 且 $x\in A$，有 $x+(c_j-c_i)\in A$（如果在值域内）。同理于 $B$。**

证明：

若 $x<c_i$，有 $c_i-x\in A$，又 $c_j-(c_i-x)\in A$。

若 $x>c_i$，有 $x-c_i\in A$，又 $x-c_i+c_j\in A$。

----

#### 引理 $2$

**对于 $a+b\le n$ 且 $g$ 整除 $a$ 与 $b$，若 $x\not \equiv0 \pmod{g}$ 且 $x\in A$，假设对于 $\forall y\equiv x\pmod{a}$ 与 $y\equiv x\pmod{b}$ ，有 $y\in A$。那么 $\forall y\equiv x\pmod{\gcd(a,b)}$，有 $y\in A$。同理于 $B$。**

证明：

考虑如下的一个构造过程。若 $x>b$，将其变为 $x-b$，反之变为 $x+a$。由于 $a+b\le n$，这是一定可以操作的。

这相当与在$\bmod b$ 意义下，合并 $x$ 与 $x+a$ 的两个等价类。由裴蜀定理可知，在 $\bmod \gcd(a,b)$ 的意义下，同一等价类中的两个数在 $A$ 中的存在性是一致的。

----

#### 定理 $1$

**对于 $x\not\equiv 0\pmod {g}$ 且 $x\in A$，则 $\forall y\equiv x\pmod{g}$，有 $y\in A$。同理于 $B$。**

证明：

使用数学归纳法。

对于 $c_1$，$\forall y\equiv x\pmod{c_1}$ 显然 $\in A$。

对于 $i$，设 $g'=\gcd(c_1,c_2,\dots,c_i)$，假设若 $\forall y\equiv x\pmod{g'}$，有 $y\in A$。

设 $d=c_{i+1}-c_i$，由引理 $1$ 可知， 对于 $\forall y\equiv x\pmod{d}$ ，有 $y\in A$。

由于 $g'+d\le n$，由引理 $2$ 可知，对于 $\forall y\equiv x\pmod{\gcd(g',d)}$ ，有 $y\in A$。

而 $\gcd(g',d)=\gcd(c_1,c_2,\dots,c_{i+1})$，于是我们从 $i$ 成立得到了 $i+1$ 成立。

----

#### 推论 $1$

**对于任意 $1\le i< |C|$，若 $x\not\equiv 0\pmod{\gcd(c_1,c_2,\dots,c_i)}$ 且 $x\in A$，则对于 $\forall y\equiv x\pmod{\gcd(c_1,c_2,\dots,c_i)}$，有 $y\in A(1\le y< c_{i+1})$。同理于 $B$。**

证明：

若一个集合没有出现矛盾，则他的子集也不会出现矛盾。

取出所有 $<c_{i+1}$ 的数，要求这些数之间没有矛盾，于是这便是一个可以应用定理 $1$ 的子问题。

----

#### 定理 $2$

**有 $g\neq 1$ 恒成立**。

证明：

仍然考虑定理 $1$ 证明中的归纳过程。

显然有 $c_1>1$。尝试证明若对于 $i$，有 $g'>1$，则 $\gcd(g',c_{i+1})>1$。

使用反证法，假设 $g'>1$ 且 $\gcd(g',c_{i+1})=1$。下述过程若无特殊说明，均默认值域 $<c_{i+1}$。

若对于 $\forall x\in B$，有 $x\equiv 0\pmod{g'}$ 成立。则 $\forall x\not\equiv0\pmod{g'}$，有 $x\in A$。

由推论 $1$ 知 $d\pm kg'\in A$，同时若 $c_{i+1}-(d\pm kg')\not\in C$，则其属于 $A$。 

又 $c_{i+1}-(d\pm kg')=c_i\pm kg'$，故 $A,C$ 可以取遍所有满足 $x<c_{i+1}$ 且  $x\equiv 0\pmod{g'}$ 的 $x$。于是 $b_1>c_{i+1}$，这与 $B,C$ 的顺序矛盾。

另一方面，若 $\exist x\in B$，使得 $x\not\equiv 0\pmod{g'}$，则对 $\forall y\equiv x\pmod{g'}$ 与 $y\equiv -x\pmod{g'}$，都有 $y\in B$。

又对 $\forall y\equiv -(c_{i+1}-x)\pmod{g'}$ 与 $y\equiv c_{i+1}-(-x)\pmod{g'}$，都有 $y\in B$（若 $y\not\equiv0\pmod{g'}$）。

这相当于在模 $g'$ 意义下，若 $x$ 与 $x+c_{i+1}$ 均 $\not\equiv 0$，则他们都属于 $B$。

因为 $\gcd(g',c_{i+1})=1$，于是这可以取完模 $g'$ 意义下的除了 $0$ 以外的所有等价类。

又由于 $1\in A$，故出现矛盾。

----

#### 定理 $3$

**有 $\gcd(b_1,b_2,\dots,b_{|B|})$ 整除 $g$。**

证明：

若对 $\forall x\in B$，有 $x\equiv 0\pmod{g}$，则由于 $B,C$ 间的大小关系，有 $g\in B$。

另一方面，若存在 $x<g$，使得 $x\in B$，则有 $g-x\in B$，而 $\gcd(x,g-x)=\gcd(x,g)$。

----

通过以上结论，我们可以知道，对于 $\forall x\not\equiv 0\pmod{g}$，唯一的限制是 $\forall y\equiv x\pmod{g}$ 与 $y\equiv -x\pmod{g}$ 需要和他在一个集合内。

对于剩余部分，限制是由他们内部带来的。由于 $g>1$，我们可以先将其除以 $g$ 再考虑。发现这类似一个规模更小的子问题， 但限制会有所不同。如原先的 $C$ 内要互素，可以为空集等。

现在，我们已经发现了足够多的这个结构所具有的性质，尝试设计 dp 来解决这个问题。

设 $f(n)$ 表示总方案数。考虑分类讨论计算贡献。

当 $B$ 中所有数都为 $g$ 的倍数时，有 $g\in B$，且对 $\forall x\not\equiv 0\pmod{g}$，都有 $x\in A$。‘

考虑保留所有 $g$ 的倍数，并将他们除以 $g$，得到 $A',B',C'$。

此时 $C'$ 内的 $\gcd$ 应为 $1$。 $A'$ 可为空集，或者满足顺序 $B'_1<C'_1<A'_1$。

设 $h(n)$ 表示这种情况下的方案数，这一部分对 $f(n)$ 的贡献为 $\sum_{d=2}^{n}h(\lfloor\frac{n}{d}\rfloor)$。

考虑 $h(n)$ 的转移式，使用莫比乌斯反演消去 $\gcd=1$ 的限制。

对于 $A'$ 为空集的情况，唯一的要求是 $1\in B’$。贡献为 $-2^{n-1}+\sum_{d=1}^{n}\mu(d)\times (2^{\lfloor\frac{n}{d}\rfloor}-1)$。

对于 $A'$ 非空的情况，根据定理 $3$，此时非 $d$ 的倍数的数一定在 $B'$ 中，于是可以将所有数先除以 $d$ 再判断合法性。需要考虑 $B'$ 中不含 $d$ 倍数的情况。

这一部分的贡献为 $-2f(n)-(2^{n-1}-1)+\sum_{d=1}^{n}\mu(d)\times [3f(\lfloor\frac{n}{d}\rfloor)+(2^{\lfloor\frac{n}{d}\rfloor-1}-1)]$。

这两种情况求和号外面的部分均为 $d=1$ 时的 corner case。

综上，有 $h(n)=-2f(n)-(2^n-1)+\sum_{d=1}^{n}\mu(d)\times [3f(\lfloor\frac{n}{d}\rfloor)+3\times 2^{\lfloor\frac{n}{d}\rfloor-1}-2]$。

当 $B$ 中存在不为 $g$ 倍数的数时，此时 $A',B'$ 均可为空集。

设 $g(n)$ 为这部分的方案数，对 $f(n)$ 的贡献为 $\sum_{d=2}^{n}(2^{\lfloor\frac{d}{2}\rfloor-1}-1)g(\lfloor\frac{n}{d}\rfloor)$。

转移推导和 $h(n)$ 是类似的。对于 $A',B'$ 均为空的情况，方案数为 $1$。

对于 $A',B'$ 中存在一个空集的情况，方案数为  $-2+2\sum_{d=1}^{n}\mu(d)\times (2^{\lfloor\frac{n}{d}\rfloor}-1)$。

对于 $A',B'$ 均非空的情况，方案数为 $-2f(n)-(2^n-2)+2\sum_{d=1}^{n}\mu(d)\times [3f(\lfloor\frac{n}{d}\rfloor)+(2^{\lfloor\frac{n}{d}\rfloor-1}-1)]$。

综上，有 $g(n)=-2f(n)-(2^n-1)+2\sum_{d=1}^{n}\mu(d)\times [3f(\lfloor\frac{n}{d}\rfloor)+3\times 2^{\lfloor\frac{n}{d}\rfloor-1}-2]$。

暴力转移，时间复杂度 $O(n^2)$。可以通过子任务 $3$，期望得分 $34$ 分。

### 算法 $2.2$

注意到对于 $s(n)=\sum_{i=1}^{n}\mu(i)$，我们有经典转移式 $s(n)=1-\sum_{d=2}^{n}s(\lfloor\frac{n}{d}\rfloor)$。

于是我们事实上可以使用整除分块优化转移，所有转移对的数量是 $O(n^{\frac{3}{4}})$ 的。

需要对所有状态预处理 $2$ 的次幂等需要的系数，不然复杂度可能会多一个 $\log n$。

时间复杂度 $O(n^{\frac{3}{4}})$，可以通过子任务 $5$，期望得分 $77$ 分。

### 算法 $2.3$

使用杜教筛的思想，预处理前若干项 dp 值。那么现在的问题是如何快速求出 $1\sim n$ 的 dp 值。

发现我们可以对差分进行 dp，这样除法下取整就变为了整除，可以 $O(n\ln n)$ 的求出。

总时间复杂度 $O(n^{\frac{2}{3}}\ln^{\frac{1}{3}}n)$，可以通过子任务 $6$，期望得分 $100$ 分。

如果只使用了快速求前 $n$ 项的算法而没有使用整除分块加速的话，可以通过子任务 $4$。

## 参考资料

题目背景经作者授权，节选并改编自 [www.bilibili.com/read/cv5014463](https://www.bilibili.com/read/cv5014463/)。

## 致谢

感谢中国计算机学会提供本次交流的平台。

感谢吴俊书学长提供本题的 idea。

感谢厦门双十中学李静榕同学为本题验题。

---


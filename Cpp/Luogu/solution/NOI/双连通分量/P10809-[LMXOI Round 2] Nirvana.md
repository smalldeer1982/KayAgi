# [LMXOI Round 2] Nirvana

## 题目背景

HQZ 在摆弄 LMX 的一台机器。

## 题目描述


定义一张无向连通图是**好的**，当且仅当存在一组定向方案使得原图可以通过对每条边定向使其成为仅有 $S$ 入度为 $0$，$T$ 出度为 $0$ 的**有向无环**图。

给定一张 $n$ 个点 $m$ 条边**无自环**的**无向连通图**，定义一次操作为等概率选取两个**可重**的点 $x, y$ 且 $x \le y$，连接 $x$ 和 $y$。求一次操作后的图是**好的**的概率 $P$ 对 $998244353$ 取模的值。

若 $P > 0$，你需要在加入一条边后构造一组定向方案。

若 $P = 0$，你需要构造一组删点数量最少的方案使得原图是好的。

## 说明/提示

对于所有数据，$1 \le n, m \le 5 \times 10^5$。

**update 7/27: Subtask #7 为新的 Hack 数据。数据范围同 Subtask #6**。

| 子任务编号 |         $n$         |         $m$         |        特殊性质        | 分值 |
| :--------: | :-----------------: | :-----------------: | :--------------------: | :--: |
| Subtask #1 |      $\le 10$       |      $\le 10$       |           无           | $25$ |
| Subtask #2 |     $\le 500$      |      $= n - 1$      | $x_i = i, y_i = i + 1$ | $10$ |
| Subtask #3 |     $\le 5 \times 10^5$      |      $= n$      |      原图是一个环      | $5$  |
| Subtask #4 |     $\le 500$      |     $\le 500$      |        无         | $20$ |
| Subtask #5 | $\le 5 \times 10^5$ |      $= n - 1$      | $x_i = i, y_i = i + 1$ | $20$ |
| Subtask #6 | $\le 5 \times 10^5$ | $\le 5 \times 10^5$ |        无         | $20$ |

## 样例 #1

### 输入

```
5 8 1 4
1 2
2 3
3 4
4 5
1 3
1 4
2 4
3 5```

### 输出

```
665496236
1 2
00010000```

## 样例 #2

### 输入

```
6 5 5 6
1 2
1 3
1 4
1 5
1 6```

### 输出

```
0
3
2 3 4```

## 样例 #3

### 输入

```
9 9 1 7
1 3
2 3
3 4
3 5
4 5
4 6
5 7
4 8
8 9```

### 输出

```
0
4
2 6 8 9```

# 题解

## 作者：Federico2903 (赞：5)

## 0. 前言

应该是一道比较简单的双极定向题，只要你舍得花时间去分类讨论应该就能做。

前置芝士：点双连通分量，圆方树。

## 1. 思路

原题要求的即是加入一条边后原图存在双极定向的概率，考虑我们连接原图两个点后发生了什么。连接两个点相当于把这两点之间的方点缩成一个方点。

如下图所示：

![](https://s2.loli.net/2024/05/08/2LwnThqHVsExtSD.png)

考虑双极定向存在的条件是原图连接 $S \to T$ 后点双连通，即原图圆方树的方点形成一条链且 $S, T$ 是其一条直径，我们称原图圆方树的方点的虚树为 $G$，若 $G$ 中存在一个大于 $2$ 个三度点或大于一个四度点一定 $P = 0$，故有如下的情况：

### $1. G$ 是一条链

![](https://s2.loli.net/2024/05/08/6JkHcCLn18auhNG.png)

显然在这种情况中，连接的边除了自环都满足要求。

### 2. $G$ 仅存在一个三度点，三度点是方点，其余点度数 $\le 2$

![](https://s2.loli.net/2024/05/08/K1F9oZNb2WEt8G4.png)

可以选择外挂的这条链的链底方点的任意一个一度圆点（橙色）连接主链的任意圆点（黄色）。

### 3. $G$ 仅存在一个三度点，三度点是圆点，其余点度数 $\le 2$

![](https://s2.loli.net/2024/05/08/sBi5WrCJafSGghk.png)

可以选择外挂的这条链的链底方点的任意一个一度圆点（橙色）连接主链的任意圆点（黄色），但不能连接三度点（蓝色）。

### 4. $G$ 恰存在两个三度点，其余点度数 $\le 2$

![](https://s2.loli.net/2024/05/08/aZpNBI1QsWhMA4q.png)

可以选择两条外挂链的链底方点的任意一度圆点连接（橙色，蓝色）。

### 5. $G$ 恰存在一个四度点，四度点是圆点，其余点度数 $\le 2$

![](https://s2.loli.net/2024/05/08/wlIZNqrTcoatY3H.png)

显然无解。

### 6. $G$ 恰存在一个四度点，四度点是方点，其余点度数 $\le 2$

![](https://s2.loli.net/2024/05/08/O1mRIJ9V2D7QwEi.png)

构造方式同 $4$。

那么算出方案数除以总的方案数就可以得到概率了。

然后随便连边跑双极定向即可。

对于无解的情况，连接 $S \to T$ 后重新构建圆方树，把除 $S, T$ 所在点双以外的所有点删掉，一定是最优的。

代码：[7.47KB](https://www.luogu.com.cn/paste/wyftt9zr)。

---


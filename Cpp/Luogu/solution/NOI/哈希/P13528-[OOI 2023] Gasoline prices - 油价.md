# [OOI 2023] Gasoline prices / 油价

## 题目背景

CF1801E

## 题目描述

伯利兰是一个由 $n$ 个城市组成的庞大国家。伯利兰的公路网络可以被看作是一棵有根树，也就是说全国一共有 $n - 1$ 条道路，并且任意两个城市之间都恰好有一条路径相连，且不会重复经过同一个城市。为了方便表示，每个城市 $i$ 都有一个固定的城市 $p_i$，它表示从城市 $i$ 出发前往城市 $1$ 时，首先要到达的城市。换句话说，如果将树的根设为城市 $1$，那么 $p_i$ 就是城市 $i$ 的父节点。

每个城市都有一个加油站。每个加油站的油价都有一个固定的区间，在这个区间内可以选择任意一个价格。城市 $i$ 的加油站油价可以是 $l_i$ 到 $r_i$ 之间的任意整数（包括两端）。

伯利兰的国王是个顾家的好父亲，他连续 $m$ 年每年都迎来了两位儿子的出生。国王的孩子们从小就参与国家事务，每年年末，他们会检查油价是否公平。自出生起，第 $i$ 年出生的两个孩子分别负责检查从城市 $a_i$ 到城市 $b_i$ 的路径，以及从城市 $c_i$ 到城市 $d_i$ 的路径上的油价。

检查的方式如下：两个孩子分别同时从城市 $a_i$ 和 $c_i$ 出发。第一个孩子沿着从 $a_i$ 到 $b_i$ 的路径前进，第二个孩子则沿着从 $c_i$ 到 $d_i$ 的路径前进。他们会依次检查：起点 $a_i$ 和 $c_i$ 的油价是否相同，然后检查路径上的第二个城市是否油价相同，依此类推，直到终点 $b_i$ 和 $d_i$ 的油价也要一致。保证从 $a_i$ 到 $b_i$ 的路径长度和从 $c_i$ 到 $d_i$ 的路径长度相同。

所有加油站都必须严格遵守法律，因此所有的油价检查都不能出现违规。请你帮助伯利兰的加油站计算，在 $m$ 年内，他们有多少种合法的油价设置方式。换句话说，对于每个 $i$ 从 $1$ 到 $m$，请计算在前 $i$ 年出生的所有王子进行检查后，所有检查都不出现违规，且每个加油站的油价在允许区间内的情况下，总共有多少种油价分配方案。由于答案可能很大，请对 $10^9 + 7$ 取模输出。


## 说明/提示

### 样例解释

以第一个样例为例：

- 在头两位王子出生后，城市 $1$ 和城市 $2$ 的油价必须相同。可以在允许的区间内为城市 $1$ 和 $2$ 选择相同的油价方式有 $2$ 种。剩下城市 $3$ 和 $4$ 的油价分别有 $3$ 种和 $3$ 种选择。总方案数为 $2 \times 3 \times 3 \times 1 = 18$。
- 第二对王子检查的是 $1-2$ 和 $2-1$，这要求城市 $1$ 和 $2$ 的油价一致，这个条件已经满足，因此方案数不变。
- 第三对王子检查的是 $3-1-2-4$ 和 $4-2-1-3$，这要求城市 $3$ 和 $4$ 的油价相同，城市 $1$ 和 $2$ 的油价也要相同。城市 $1$ 和 $2$ 已经一致，而城市 $3$ 和 $4$ 可以有 $2$ 种相同的油价选择。总方案数为 $2 \times 2 \times 1 = 6$。
- 第四对王子检查的是 $3-1-2-4$ 和 $3-1-2-5$，这要求城市 $4$ 和 $5$ 的油价一致，而城市 $3$ 和 $4$ 已经一致，因此 $3$、$4$、$5$ 三个城市的油价都要一致。城市 $3$ 的油价不能超过 $3$，城市 $5$ 的油价不能低于 $4$，因此不存在满足条件的方案，答案为 $0$。

### 评分说明

本题的数据分为 8 组。只有通过某一组全部测试点，且通过部分之前组全部测试点，才能获得该组分数。有些分组不要求通过样例测试点。“离线评测”表示该组的测试结果只会在比赛结束后公布。

| 组别 | 分值 | $n$ | $m$ | 必须通过的组 | 备注 |
|:----:|:----:|:---:|:---:|:------------:|:----:|
| 0    | 0    | --  | --  | --           | 样例测试点 |
| 1    | 12   | $n \le 300$ | $m \le 300$ | 0 |  |
| 2    | 10   | $n \le 3000$ | $m \le 3000$ | -- | $p_i = i - 1$ |
| 3    | 9    | $n \le 3000$ | $m \le 3000$ | 0, 1, 2 |  |
| 4    | 16   | --  | --  | 0 -- 3       | 所有检查路径的总长度不超过 $10^8$ |
| 5    | 10   | $n \le 100\,000$ | $m \le 100\,000$ | 2 | $p_i = i - 1$ |
| 6    | 12   | --  | --  | 2, 5         | $p_i = i - 1$ |
| 7    | 13   | $n \le 100\,000$ | $m \le 100\,000$ | 0 -- 3, 5 |  |
| 8    | 18   | --  | --  | 0 -- 7       | **离线评测** |

## 样例 #1

### 输入

```
5
1 1 2 2
2 4
1 3
1 3
2 4
4 4
4
1 1 2 2
1 2 2 1
3 4 4 3
3 4 3 5```

### 输出

```
18
18
4
0```

## 样例 #2

### 输入

```
8
1 2 3 4 5 8 6
3 7
2 6
3 8
5 10
5 8
2 9
3 8
6 8
4
1 3 7 6
4 1 5 7
1 7 7 1
1 8 2 7```

### 输出

```
720
120
120
1
```

# 题解

## 作者：chen_zhe (赞：0)

**本题解是官方题解的 AI 中文翻译。**

首先，我们需要理解题目要求。给定一棵树，每个节点上都有一个价格区间。每个询问是一对长度相等的路径，要求路径上第 $i$ 个节点的价格相等。我们需要对于每个限制的前缀，求出所有合法的价格分配方案数。

我们先来看一个慢速解法。维护连通分量（即每个分量内所有节点价格相等），并为每个分量记录其允许的价格区间。答案就是所有分量区间长度的乘积。沿着路径依次合并两节点到同一分量，可以用并查集（DSU）实现。这样可以拿到 31 分。加入路径压缩与按秩合并优化，并且对每个询问用线性时间遍历路径，可以提升到 47 分。显然，进一步优化的关键在于加速查找两节点何时被合并到同一分量的过程。

我们先分析一个较慢但清晰的解法。对树做重链剖分（HLD），用以哈希路径，将每个节点的分量根编号作为哈希字符。用二分查找路径前缀哈希首次不同的位置，即两节点首次合并的时刻。合并时，更新节点的分量根与 HLD 线段树。总共有 $n$ 次合并，每次通过 HLD 二分定位，复杂度 $O(\log^2 n)$。另外，合并后需要 $O(n \log n)$ 次线段树更新。每个询问也是 $O(\log^2 n)$。总复杂度为 $O((n + q) \log^2 n)$。

现在介绍一个更优雅的解法。我们先以链（bamboo）为例。

将路径上的价格相等限制，转化为两对长度为不超过原路径长度的最大 $2$ 的幂的路径（类似稀疏表分段）。这样所有限制路径的长度都变成了 $2^k$。依次按 $2^k$ 从大到小枚举，对于每个 $2^k$ 长度的路径建一个图节点，同时为反向路径也建节点。所有限制在图中连边。取其生成树，对于生成树中的每条边，将限制分解为两个长度减半的路径限制，递归处理。最后在长度为 $1$ 的层上得到所需的生成树，记录每对节点首次被合并到同一分量的时刻。每层向下最多增加 $2n$ 条边，询问最多增加 $2q$ 条边，因此每层复杂度 $O((n + q) \alpha(n))$，其中 $\alpha(n)$ 是阿克曼函数的反函数。总复杂度 $O((n + q) \alpha(n) \log n)$。

对于一般树，首先将一对路径分解为三对对应的垂直路径（从四个端点中，选出距离最近的 lca，取其到端点的路径为一对，另一对为原路径的剩余部分），这样转化为一条垂直路径和一条任意路径，再按 lca 分割。之后，类似链的做法，不同之处在于用深度为 $2^k$ 的二进制跳跃代替区间节点。最终复杂度仍为 $O((n + q) \alpha(n) \log n)$。

---


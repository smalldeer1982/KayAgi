# [NOI2025] é›†åˆ

## é¢˜ç›®èƒŒæ™¯

set.cpp / 2 s / 512 MiB

## é¢˜ç›®æè¿°

å° X æœ‰ $2^n$ ä¸ªæ•°ï¼Œç¼–å·ä¸º $0$ åˆ° $2^n - 1$ï¼Œç¬¬ $i$ ($0 \leq i < 2^n$) ä¸ªæ•°ä¸º $a_i$ã€‚

å¯¹äº $S \subseteq \{0, 1, \ldots, 2^n - 1\}$ï¼Œå®šä¹‰ $f(S)$ ä¸ºé›†åˆ $S$ ä¸­ **æ‰€æœ‰æ•°çš„äºŒè¿›åˆ¶æŒ‰ä½ä¸**ã€‚ç‰¹åˆ«åœ°ï¼Œè‹¥ $S$ ä¸ºç©ºé›†ï¼Œåˆ™ $f(S) = 2^n - 1$ã€‚

å®šä¹‰ä¸¤ä¸ª $\{0, 1, \ldots, 2^n - 1\}$ çš„å­é›† $P, Q$ï¼ˆå¯ä»¥ä¸ºç©ºï¼‰æ„æˆçš„æœ‰åºå¯¹ $(P, Q)$ æ˜¯ **ç‰¹åˆ«çš„** å½“ä¸”ä»…å½“ $P \cap Q = \varnothing$ ä¸” $f(P) = f(Q)$ã€‚å®šä¹‰æœ‰åºå¯¹ $(P, Q)$ çš„ **æƒå€¼** ä¸º **ç¼–å·** åŒ…å«åœ¨ $P \cup Q$ å†…çš„æ‰€æœ‰æ•°çš„ä¹˜ç§¯ï¼Œå³ $\prod_{i \in P \cup Q} a_i$ã€‚ç‰¹åˆ«åœ°ï¼Œè‹¥ $P \cup Q = \varnothing$ï¼Œåˆ™æœ‰åºå¯¹ $(P, Q)$ çš„æƒå€¼ä¸º $1$ã€‚

å° X æƒ³è¦çŸ¥é“æ‰€æœ‰ç‰¹åˆ«çš„æœ‰åºå¯¹çš„æƒå€¼ä¹‹å’Œï¼Œè¯·ä½ å¸®åŠ©ä»–æ±‚å‡ºè¿™ä¸ªå€¼ã€‚ç”±äºç­”æ¡ˆå¯èƒ½è¾ƒå¤§ï¼Œä½ åªéœ€è¦æ±‚å‡ºç­”æ¡ˆå¯¹ $998,244,353$ å–æ¨¡åçš„ç»“æœã€‚


## è¯´æ˜/æç¤º

**ã€æ ·ä¾‹ 2ã€‘**

è§é€‰æ‰‹ç›®å½•ä¸‹çš„ `set/set2.in` ä¸ `set/set2.ans`ã€‚

è¯¥æ ·ä¾‹æ»¡è¶³æµ‹è¯•ç‚¹ 2 çš„çº¦æŸæ¡ä»¶ã€‚

**ã€æ ·ä¾‹ 3ã€‘**

è§é€‰æ‰‹ç›®å½•ä¸‹çš„ `set/set3.in` ä¸ `set/set3.ans`ã€‚

è¯¥æ ·ä¾‹æ»¡è¶³æµ‹è¯•ç‚¹ 3 çš„çº¦æŸæ¡ä»¶ã€‚

**ã€æ ·ä¾‹ 4ã€‘**

è§é€‰æ‰‹ç›®å½•ä¸‹çš„ `set/set4.in` ä¸ `set/set4.ans`ã€‚

è¯¥æ ·ä¾‹æ»¡è¶³æµ‹è¯•ç‚¹ 9 çš„çº¦æŸæ¡ä»¶ã€‚

**ã€æ•°æ®èŒƒå›´ã€‘**

å¯¹äºæ‰€æœ‰æµ‹è¯•æ•°æ®ï¼Œä¿è¯ï¼š
- $1 \leq t \leq 3$;
- $2 \leq n \leq 20$;
- å¯¹äºæ‰€æœ‰ $0 \leq i < 2^n$ï¼Œå‡æœ‰ $0 \leq a_i < 998,244,353$ã€‚

::cute-table{tuack}

|  æµ‹è¯•ç‚¹ç¼–å·  | $n \leq$ | ç‰¹æ®Šæ€§è´¨ |
| :----------: | :------: | :------: |
|     $1$      |   $4$    |    B     |
|     $2$      |   ^    |    æ—     |
|     $3$      |   $8$    |    B     |
|     $4$      |   ^    |    æ—     |
|     $5$      |   $10$   |    B     |
|     $6$      |   ^   |    æ—     |
|    $7, 8$    |   $12$   |    B     |
|     $9$      |   ^   |    æ—     |
| $10 \sim 12$ |   $16$   |    B     |
|   $13, 14$   |   ^   |    æ—     |
|   $15, 16$   |   $20$   |    AB    |
|   $17, 18$   |   ^   |    A     |
| $19 \sim 21$ |   ^   |    B     |
| $22 \sim 25$ |   ^   |    æ—     |

ç‰¹æ®Šæ€§è´¨ A: ä¿è¯è‡³å¤šå­˜åœ¨ 24 ä¸ª $i$ æ»¡è¶³ $a_i \neq 0$ã€‚

ç‰¹æ®Šæ€§è´¨ B: ä¿è¯å¯¹äºæ‰€æœ‰ $0 \leq i < 2^n$ï¼Œå‡æœ‰ $a_i \neq 998,244,352$ã€‚

é™„åŠ æ–‡ä»¶æ¥è‡ªäº [QOJ](https://qoj.ac/contest/2316/problem/13083)ã€‚

## æ ·ä¾‹ #1

### è¾“å…¥

```
0 2
2
1 2 3 4
3
1 1 1 1 1 1 1 1```

### è¾“å‡º

```
117
2091```

# é¢˜è§£

## ä½œè€…ï¼šcyffff (èµï¼š21)

[$\text{Link}$](https://www.luogu.com.cn/problem/P13275)
## å‰è¨€
[æ„Ÿè°¢æœ¬é¢˜ä¸ºæˆ‘çš„ OI ç”Ÿæ¶¯ç”»ä¸Šä¸€ä¸ªå®Œç¾çš„å¥å·ï¼Œè°¨ä»¥æ­¤çºªå¿µåœºä¸Šä¸ºä¹‹å¥‹æ–—çš„ä¸¤ä¸ªåŠå°æ—¶](https://www.luogu.com.cn/article/dwcn28bs)ã€‚

æœ¬é¢˜è§£çš„è§£æ³•å°†ä¼šæ¯”è¾ƒæš´åŠ›ã€‚

## é¢˜æ„
ç»™å®šé•¿ä¸º $2^n$ çš„åºåˆ— $a_{0\sim2^n-1}$ï¼Œå®šä¹‰ $f(S)$ ä¸ºé›†åˆ $S$ ä¸­æ‰€æœ‰æ•°çš„äºŒè¿›åˆ¶æŒ‰ä½ä¸ã€‚å¯¹äºæ‰€æœ‰ $\{0, 1, \ldots, 2^n - 1\}$ çš„ä¸äº¤å­é›†å¯¹ $P,Q$ æ»¡è¶³ $f(P)=f(Q)$ï¼Œè®¡ç®— $\prod_{i \in P \cup Q} a_i$ ä¹‹å’Œã€‚å¯¹ $998244353$ å–æ¨¡ã€‚

$n\le 20$ï¼Œ$T\le 3$ã€‚
## æ€è·¯

ç›´æ¥å†™ä¸€ä¸ªå®¹æ–¥å¯ä»¥åšåˆ° $O(8^n)$ è‡³ $O(7^n)$ï¼Œå¯ä»¥è·å¾— $16$ åˆ†ï¼Œä½†æ²¡ä»€ä¹ˆå‰é€”ã€‚

è€ƒè™‘ç›´æ¥çœ‹ä½œäºŒå…ƒé›†åˆå¹‚çº§æ•°ï¼Œå³

$$\prod_S\left(x^Uy^U+x^Sy^Ua_S+x^Uy^Sa_S\right)$$

å…¶ä¸­ $U$ è¡¨ç¤ºå…¨é›†ï¼Œä¹˜æ³•ä¸ºé›†åˆå¹‚çº§æ•° $\text{and}$ å·ç§¯ï¼Œå…¶ FWT ä¸ IFWT åˆ†åˆ«ä¸ºé«˜ç»´åç¼€å’Œä»¥åŠé«˜ç»´åç¼€å·®åˆ†ã€‚

ç»´æŠ¤ FWT ç»“æœï¼Œæ¯æ¬¡ä¹˜å…¥ä¸€é¡¹åªä¼šæ›´æ–° $x,y$ çš„æ­¤é¡¹ä¸­è‡³å°‘æœ‰ä¸€ä¸ªæ˜¯ $S$ å­é›†çš„å…ƒç´ ï¼Œæœ€ç»ˆ IFWT å›å»åæ±‚è§£æ‰€æœ‰ $[x^Sy^S]$ é¡¹çš„ç³»æ•°ä¹‹å’Œï¼Œæš´åŠ›åšå³ä¸º $O(6^n)$ï¼Œå¯ä»¥è·å¾— $24$ åˆ†ã€‚

ç“¶é¢ˆä¸ºä¹˜å…¥ä¸€é¡¹æ—¶æšä¸¾å­é›†ï¼Œè¦æƒ³æ±‚ç­”æ¡ˆçš„ FWT æ•°ç»„çš„ $[x^Ay^B]$ é¡¹ç³»æ•°ï¼Œä¸å¦¨è€ƒè™‘æ¯ä¸ª $S$ å¯¹å…¶çš„è´¡çŒ®ã€‚è®° $f_S,g_S$ åˆ†åˆ«ä¸ºï¼š

$$f_S=\prod_{S\sube T}(a_T+1)$$
$$g_S=\prod_{S\sube T}\dfrac{2a_T+1}{(a_T+1)^2}$$

é‚£ä¹ˆç­”æ¡ˆçš„ FWT æ•°ç»„çš„ $[x^Ay^B]$ é¡¹ç³»æ•°å³ä¸º $f_Sf_Tg_{S\cup T}$ï¼Œåšåˆ° $O(4^nn)$ã€‚æ³¨æ„å¤„ç† $a_S\equiv -1$ï¼Œä¸å¦¨å°†æ¯ä¸ªæ•°è®°ä½œ $v\cdot z^k$ï¼Œå…¶ä¸­ $z=0$ã€‚

æœ€ååš IFWT å¾ˆæ²¡å¿…è¦ï¼Œåå‘æ¨å‡º FWT æ•°ç»„çš„ $[x^Ay^B]$ é¡¹å¯¹ç­”æ¡ˆçš„è´¡çŒ®ç³»æ•°ä¸º $(-1)^{|A|+|B|}2^{|A\cap B|}$ï¼Œå³å¯åšåˆ° $O(4^n)$ï¼Œè·å¾— $36$ åˆ†ã€‚

æ˜æ˜¾å¯ä»¥å‘ç°è¿™æ˜¯ $\text{or}$ å·ç§¯çš„å½¢å¼ï¼Œæ‹†ä¸€ä¸‹ $|A\cap B|$ å³å¯é€šè¿‡ B æ€§è´¨è·å¾— $68$ åˆ†ã€‚é—®é¢˜åœ¨äºæ­¤æ—¶æ¶‰åŠäº†åŠ å‡æ³•ï¼Œæ¯ä¸ªå€¼å˜ä¸ºäº†å¤šé¡¹å¼ã€‚æ³¨æ„åˆ°æœ€ç»ˆçš„è¿ç®—è‚¯å®šä¸ä¼šæ¶‰åŠ $z$ çš„è´Ÿæ¬¡å¹‚ï¼Œå³æ¯ä¸ªå¤šé¡¹å¼åªæœ‰æœ€ä½æ¬¡é¡¹æœ‰å¯èƒ½æœ‰ç”¨ï¼Œæ•…ç›´æ¥ç»´æŠ¤æœ€ä½æ¬¡é¡¹çš„å€¼å³å¯ã€‚

æ—¶é—´å¤æ‚åº¦ $O(2^nn)$ï¼Œå¯ä»¥é€šè¿‡ã€‚

ä»£ç ä¹‹åå†è¡¥ã€‚

> ä¸ºä»€ä¹ˆè¦æ”€ç™»ï¼Ÿå› ä¸ºå±±å°±åœ¨é‚£é‡Œã€‚

---

## ä½œè€…ï¼šcancan123456 (èµï¼š16)

![](https://cdn.luogu.com.cn/upload/image_hosting/zhk0n76b.png)

é¦–å…ˆæ˜¯ä¸€ä¸ªæš´åŠ› DPï¼Œ$f_{i,j,k}$ è¡¨ç¤ºè€ƒè™‘äº† $a_0\sim a_{i-1}$ï¼Œå½“å‰ $f(P)=j,f(Q)=k$ æ—¶æƒå€¼ä¹‹å’Œï¼Œç„¶åè½¬ç§» $\begin{cases}f_{i,j,k}a_i\to f_{i+1,j\cap i,k}\\f_{i,j,k}a_i\to f_{i+1,j,k\cap i}\\f_{i,j,k}\to f_{i+1,j,k}\end{cases}$ï¼Œå¥½åƒå¯ä»¥ç”¨é›†åˆå¹‚çº§æ•°ç§‘æŠ€åšï¼Œä½†æ˜¯æˆ‘ä»¬ä¸ä¼šï¼Œæ€ä¹ˆåŠï¼Ÿ

æƒ³æƒ³è¿™ç§è½¬ç§»è§„æ•´çš„ DP éƒ½æ˜¯æ€ä¹ˆåšçš„ï¼ŒæŠŠä¸€ç»´æ”¹æˆå·ç§¯ï¼Ÿæ¿€è¿›ä¸€ç‚¹ï¼Œä¸¤ç»´åœ°ä½æ˜¯å¯¹ç§°çš„ï¼Œéƒ½æ”¹æˆå·ç§¯ï¼æšä¸¾ $S,T$ é’¦å®š $f(P)\supseteq S,f(Q)\supseteq T$ï¼Œç„¶åå‡è®¾æˆ‘ä»¬ç®—å‡ºæ¥è¿™ç§æƒ…å†µæƒå€¼å’Œæ˜¯ $q_{S,T}$ï¼Œæ€ä¹ˆç®—ç­”æ¡ˆï¼Ÿ

å®¹æ–¥ç³»æ•°ï¼Œæˆ‘ä»¬å¯ä»¥å†™ä¸ªé«˜æ–¯æ¶ˆå…ƒç„¶åçªçœ¼æ³•ç¡¬çªç³»æ•°ï¼Œæ¯”å¦‚è¯´ï¼Œå¯¹ $n=4$ çš„ç³»æ•°

```plain
 1 -1 -1  1 -1  1  1 -1 -1  1  1 -1  1 -1 -1  1 
-1  2  1 -2  1 -2 -1  2  1 -2 -1  2 -1  2  1 -2
-1  1  2 -2  1 -1 -2  2  1 -1 -2  2 -1  1  2 -2 
 1 -2 -2  4 -1  2  2 -4 -1  2  2 -4  1 -2 -2  4
-1  1  1 -1  2 -2 -2  2  1 -1 -1  1 -2  2  2 -2 
 1 -2 -1  2 -2  4  2 -4 -1  2  1 -2  2 -4 -2  4
 1 -1 -2  2 -2  2  4 -4 -1  1  2 -2  2 -2 -4  4
-1  2  2 -4  2 -4 -4  8  1 -2 -2  4 -2  4  4 -8 
-1  1  1 -1  1 -1 -1  1  2 -2 -2  2 -2  2  2 -2 
 1 -2 -1  2 -1  2  1 -2 -2  4  2 -4  2 -4 -2  4 
 1 -1 -2  2 -1  1  2 -2 -2  2  4 -4  2 -2 -4  4
-1  2  2 -4  1 -2 -2  4  2 -4 -4  8 -2  4  4 -8 
 1 -1 -1  1 -2  2  2 -2 -2  2  2 -2  4 -4 -4  4 
-1  2  1 -2  2 -4 -2  4  2 -4 -2  4 -4  8  4 -8 
-1  1  2 -2  2 -2 -4  4  2 -2 -4  4 -4  4  8 -8
 1 -2 -2  4 -2  4  4 -8 -2  4  4 -8  4 -8 -8 16
```

è¿›è¡Œçªçœ¼æ³•ï¼Œå…ˆçœ‹æ­£è´Ÿå·ï¼Œç¬¬ä¸€è¡Œï¼Œå¾ˆç†Ÿæ‚‰å•Šï¼Thue-Morse åºåˆ—ï¼Œå³ $(-1)^{|S|}$ï¼Œç„¶åå¾€ä¸‹çœ‹ï¼Œæ¯ä¸€è¡Œè¦ä¹ˆæ˜¯ $(-1)^{|S|}$ è¦ä¹ˆæ˜¯ $(-1)^{|S|+1}$ï¼Œç„¶åæ­£è´Ÿå·åˆ‡æ¢æ˜¯ $T$ ä¸Šçš„ Thue-Morse åºåˆ—ï¼æ­£è´Ÿå·æ˜¯ $(-1)^{|S|+|T|}$ï¼

ç„¶åçœ‹ç»å¯¹å€¼ï¼Œç»å¯¹å€¼éƒ½æ˜¯ $2$ çš„å¹‚ï¼Œè§‚å¯Ÿå‰ $4$ è¡Œï¼Œä¸€çœ¼å°±èƒ½çªå‡ºï¼Œç¬¬äºŒè¡Œæ˜¯å¥‡å¶æ€§æ£€æµ‹ï¼Œç¬¬ä¸‰è¡Œæ˜¯æ£€æµ‹å€’æ•°ç¬¬äºŒä½çš„ï¼Œç¬¬å››è¡Œæ˜¯äºŒå’Œä¸‰ä¹˜èµ·æ¥ï¼Œè¿™å°±æ˜¯ $2^{|S\cap T|}$ï¼æ‰€ä»¥å®¹æ–¥ç³»æ•° $2^{|S\cap T|}(-1)^{|S|+|T|}$ã€‚

ç„¶åæ€ä¹ˆæ±‚ $q_{S,T}$ï¼Œå¯¹æ¯ä¸ª $i$ åˆ†ç±»è®¨è®ºï¼š

$$q_{S,T}=\prod_{i\supseteq S\land i\nsupseteq T}(a_i+1)\prod_{i\nsupseteq S\land i\supseteq T}(a_i+1)\prod_{i\supseteq S\land i\supseteq T}(2a_i+1)$$

è¿™å’‹åšï¼Œå†™æˆè¿™ä¸ªå½¢å¼è¯•è¯•

$$q_{S,T}=\prod_{i\supseteq S}(a_i+1)\prod_{i\supseteq T}(a_i+1)\prod_{i\supseteq S\cup T}\frac{2a_i+1}{(a_i+1)^2}$$

ä»¤ $f_S'=\prod_{i\supseteq S}(a_i+1),g_S'=\prod_{i\supseteq S}\dfrac{2a_i+1}{(a_i+1)^2}$ï¼Œé‚£ä¹ˆ $q_{S,T}=f_S'f_T'g_{S\cup T}'$ï¼Œç­”æ¡ˆå³ä¸º $\sum_{S,T}2^{|S\cap T|}(-1)^{|S|+|T|}f_S'f_T'g_{S\cup T}'$ï¼Œè¿™ä¸ªå¼å­é‡Œåˆæ˜¯ $S\cup T$ åˆæ˜¯ $S\cap T$ å¾ˆéš¾åŠå•Šï¼Œè”æƒ³åˆ°å®¹æ–¥åŸç†

$$|S\cap T|+|S\cup T|=|S|+|T|$$

æŠŠç­”æ¡ˆå†™æˆ $\sum_{S,T}(-2)^{|S|}(-2)^{|T|}2^{-|S\cup T|}f_S'f_T'g_{S\cup T}'$ï¼Œä»¤ $f_S=(-2)^{|S|}f_S',g_S=2^{-|S|}g_S'$ï¼Œç­”æ¡ˆå†™æˆ $\sum_{S,T}f_Sf_Tg_{S\cup T}$ï¼Œè¿™å°±å¾ˆå¥½æ±‚äº†ï¼Œå…ˆç®— $f$ å’Œ $f$ çš„[æˆ–å·ç§¯](https://www.luogu.com.cn/problem/P4717)ç„¶åå’Œ $g$ æ±‚å†…ç§¯å³å¯ã€‚ç„¶å $f,g$ åç¼€å’Œç›´æ¥ç§’ã€‚

æ—¶é—´å¤æ‚åº¦ $O(\sum n2^n)$ï¼Œå¯ä»¥é€šè¿‡â€¦â€¦æ€ä¹ˆåªè¿‡äº† B æ€§è´¨çš„åŒ…ï¼Ÿ

å“¦å¯¹ $a_i+1=0$ æ—¶æˆ‘ä»¬çš„é€†å…ƒä¼šçˆ†æ‰ï¼Œé‚£ä¹ˆå¸¸è§ trick å¯¹å§ï¼Œæˆ‘ä»¬å­˜æ•°çš„æ—¶å€™å­˜ $a\times0^b$ï¼Œç„¶ååŠ æ³•çš„æ—¶å€™è®© $b$ å°çš„å‹è¿‡ $b$ å¤§çš„å°±è¡Œäº†ã€‚

æ—¶é—´å¤æ‚åº¦ $O(\sum n2^n)$ï¼Œå¯ä»¥é€šè¿‡æ­¤é¢˜ã€‚

ç”¨äºæ‰“è¡¨å®¹æ–¥ç³»æ•°çš„ä»£ç ã€‚

```cpp
#include <cstdio>
#include <algorithm>
using namespace std;
typedef long long ll;
const ll mod = 998244353;
const int k = 4, n = 1 << (2 * k);
int zip(int S, int T) {
    return (S << k) | T;
}
ll qpow(ll a, ll b) {
    ll ans = 1;
    while (b > 0) {
        if (b % 2 == 1) {
            (ans *= a) %= mod;
        }
        (a *= a) %= mod;
        b /= 2;
    }
    return ans;
}
ll inv(ll x) {
    return qpow(x, mod - 2);
}
ll M[n][n + 1];
void normalize(ll & x) {
    if (x > mod / 2) {
        x -= mod;
    }
}
int flag(int x) {
    return x % 2 == 1 ? -1 : 1;
}
int main() {
    for (int S = 0; S < (1 << k); S++) {
        M[zip(S, S)][n] = 1;
    }
    for (int S = 0; S < (1 << k); S++) {
        for (int T = 0; T < (1 << k); T++) {
            for (int A = 0; A < (1 << k); A++) {
                for (int B = 0; B < (1 << k); B++) {
                    if ((S & A) == S && (T & B) == T) {
                        M[zip(A, B)][zip(S, T)] = 1;
                    }
                }
            }
        }
    }
    for (int i = 0; i < n; i++) {
        int r = -1;
        for (int j = i; j < n; j++) {
            if (M[j][i] != 0) {
                r = j;
            }
        }
        if (r == -1) {
            printf("oh, no!\n");
            return 0;
        }
        swap(M[r], M[i]);
        ll mul = inv(M[i][i]);
        for (int j = 0; j <= n; j++) {
            (M[i][j] *= mul) %= mod;
        }
        for (int j = 0; j < n; j++) {
            if (i == j) {
                continue;
            }
            ll val = M[j][i];
            for (int k = 0; k <= n; k++) {
                (M[j][k] += mod - M[i][k] * val % mod) %= mod;
            }
        }
    }
    for (int S = 0; S < (1 << k); S++) {
        for (int T = 0; T < (1 << k); T++) {
            normalize(M[zip(S, T)][n]);
            printf("%2lld ", M[zip(S, T)][n]);
        }
        printf("\n");
    }
    return 0;
}
```

åªèƒ½è¿‡ B æ€§è´¨çš„ä»£ç 

```cpp
#include <cstdio>
using namespace std;
typedef long long ll;
const ll mod = 998244353;
const int N = 20;
int n;
ll a[1 << N];
ll qpow(ll a, ll b) {
	if (a < 0) {
		a += mod;
	}
	if (b < 0) {
		b += mod - 1;
	}
    ll ans = 1;
    while (b > 0) {
        if (b % 2 == 1) {
            (ans *= a) %= mod;
        }
        (a *= a) %= mod;
        b /= 2;
    }
    return ans;
}
ll inv(ll x) {
    return qpow(x, mod - 2);
}
ll f[1 << N], g[1 << N], h[1 << N];
int main() {
	// freopen("in.txt", "r", stdin);
	int t;
	scanf("%*d %d", &t);
	for (; t != 0; t--) {
		scanf("%d", &n);
		for (int i = 0; i < (1 << n); i++) {
			scanf("%lld", &a[i]);
			f[i] = (a[i] + 1) % mod;
			g[i] = (2 * a[i] + 1) * inv(a[i] + 1) % mod * inv(a[i] + 1) % mod;
		}
		for (int i = 0; i < n; i++) {
			for (int S = 0; S < (1 << n); S++) {
				if (((S >> i) & 1) == 0) {
					(f[S] *= f[S | (1 << i)]) %= mod;
					(g[S] *= g[S | (1 << i)]) %= mod;
				}
			}
		}
		for (int S = 0; S < (1 << n); S++) {
			(f[S] *= qpow(-2, __builtin_popcount(S))) %= mod;
			(g[S] *= qpow(2, -__builtin_popcount(S))) %= mod;
		}
		for (int i = 0; i < n; i++) {
			for (int S = 0; S < (1 << n); S++) {
				if (((S >> i) & 1) == 0) {
					(f[S | (1 << i)] += f[S]) %= mod;
				}
			}
		}
		for (int S = 0; S < (1 << n); S++) {
			h[S] = f[S] * f[S] % mod;
		}
		for (int i = 0; i < n; i++) {
			for (int S = 0; S < (1 << n); S++) {
				if (((S >> i) & 1) == 0) {
					(h[S | (1 << i)] += mod - h[S]) %= mod;
				}
			}
		}
		ll ans = 0;
		for (int S = 0; S < (1 << n); S++) {
			(ans += h[S] * g[S]) %= mod;
		}
		printf("%lld\n", (ans + mod) % mod);
	}
	return 0;
}
```

å¯é€šè¿‡æ­¤é¢˜çš„ä»£ç ã€‚

```cpp
#include <cstdio>
using namespace std;
typedef long long ll;
const ll mod = 998244353;
const int N = 20;
struct Milthm {
	ll a, b;
	Milthm() {
	}
	Milthm(ll x) {
		x %= mod;
		if (x > 0) {
			a = x;
			b = 0;
		} else {
			a = 1;
			b = 1;
		}
	}
	Milthm(ll a_, ll b_) {
		a = a_;
		b = b_;
	}
	ll real_val() {
		return b == 0 ? a : 0;
	}
};
Milthm operator + (const Milthm & a, const Milthm & b) {
	if (a.b < b.b) {
		return a;
	}
	if (a.b > b.b) {
		return b;
	}
	ll x = (a.a + b.a) % mod;
	if (x == 0) {
		return Milthm(1, a.b + 1);
	} else {
		return Milthm(x, a.b);
	}
}
Milthm & operator += (Milthm & a, const Milthm & b) {
	return a = a + b;
}
Milthm operator - (const Milthm & a) {
	return Milthm(mod - a.a, a.b);
}
Milthm & operator -= (Milthm & a, const Milthm & b) {
	return a += -b;
}
Milthm operator * (const Milthm & a, const Milthm & b) {
	return Milthm(a.a * b.a % mod, a.b + b.b);
}
Milthm & operator *= (Milthm & a, const Milthm & b) {
	return a = a * b;
}
int n;
ll a[1 << N];
ll qpow(ll a, ll b) {
	if (a < 0) {
		a += mod;
	}
	if (b < 0) {
		b += mod - 1;
	}
    ll ans = 1;
    while (b > 0) {
        if (b % 2 == 1) {
            (ans *= a) %= mod;
        }
        (a *= a) %= mod;
        b /= 2;
    }
    return ans;
}
Milthm inv(Milthm x) {
    return Milthm(qpow(x.a, mod - 2), -x.b);
}
int read() {
	int x = 0, ch;
	do {
		ch = getchar();
	} while ('0' > ch);
	do {
		x = x * 10 + ch - 48;
		ch = getchar();
	} while ('0' <= ch);
	return x;
}
Milthm f[1 << N], g[1 << N], h[1 << N];
int main() {
	// freopen("in.txt", "r", stdin);
	read();
	int t = read();
	for (; t != 0; t--) {
		n = read();
		for (int i = 0; i < (1 << n); i++) {
			a[i] = read();
			f[i] = Milthm(a[i] + 1);
			g[i] = Milthm(2 * a[i] + 1) * inv(a[i] + 1) * inv(a[i] + 1);
		}
		for (int i = 0; i < n; i++) {
			for (int S = 0; S < (1 << n); S++) {
				if (((S >> i) & 1) == 0) {
					f[S] *= f[S | (1 << i)];
					g[S] *= g[S | (1 << i)];
				}
			}
		}
		for (int S = 0; S < (1 << n); S++) {
			f[S] *= qpow(-2, __builtin_popcount(S));
			g[S] *= qpow(2, -__builtin_popcount(S));
		}
		for (int i = 0; i < n; i++) {
			for (int S = 0; S < (1 << n); S++) {
				if (((S >> i) & 1) == 0) {
					f[S | (1 << i)] += f[S];
				}
			}
		}
		for (int S = 0; S < (1 << n); S++) {
			h[S] = f[S] * f[S];
		}
		for (int i = 0; i < n; i++) {
			for (int S = 0; S < (1 << n); S++) {
				if (((S >> i) & 1) == 0) {
					h[S | (1 << i)] -= h[S];
				}
			}
		}
		Milthm ans = 0;
		for (int S = 0; S < (1 << n); S++) {
			ans += h[S] * g[S];
		}
		printf("%lld\n", ans.real_val());
	}
	return 0;
}
```

---

## ä½œè€…ï¼šlsj2009 (èµï¼š15)

å†™å‡ºç­”æ¡ˆå¼å­ï¼š

$$
\sum\limits_P \sum\limits_Q [f(P)=f(Q)][P\cap Q=\emptyset]\prod\limits_{i\in P\cup Q} a_i
$$

å¯¹ $[f(P)=f(Q)]$ é™åˆ¶è¿›è¡Œå®¹æ–¥ï¼šå³å¯¹äºæ¯ä¸€ä½ $x$ åº”æœ‰ $[x\in f(P)]=[x\in f(Q)]$ æˆç«‹ï¼Œè®° $P_x=[x\in f(P)],Q_x=[x\in f(Q)]$ï¼Œ

åˆ™ï¼š

$$
\begin{aligned}
[f(P)=f(Q)] & = \prod\limits_{0\le i<n} [P_i=Q_i]\\
& = \prod\limits_{0\le i<n} ((P_i\wedge Q_i)+(\neg P_i\wedge\neg Q_i))\\
& = \prod\limits_{0\le i<n} (1-(\neg P_i\wedge Q_i)-(P_i\wedge\neg Q_i))\\
& = \prod\limits_{0\le i<n} (1-(Q_i-P_i\wedge Q_i)-(P_i-P_i\wedge Q_i))\\
& = \prod\limits_{0\le i<n} (2P_i\wedge Q_i-P_i-Q_i+1)\\
& = \sum\limits_{A\subseteq f(P)\cap f(Q)}\sum\limits_{B\subseteq f(P),A\cap B=\emptyset}
\sum\limits_{C\subseteq f(Q),A\cap C=\emptyset,B\cap C=\emptyset} 2^{|A|}(-1)^{|B|+|C|}\\
& = \sum\limits_{S\subseteq f(P)} \sum\limits_{T\subseteq f(Q)} 2^{|S\cap T|}(-1)^{(|S|-|S\cap T|)+(|T|-|S\cap T|)}\\
& = \sum\limits_{S\subseteq f(P)} \sum\limits_{T\subseteq f(Q)} 2^{|S\cap T|}(-1)^{|S|+|T|}
\end{aligned}
$$

å…¶ä¸­å€’æ•°ç¬¬äºŒæ­¥ä¸ºæšä¸¾ $S=B\cup A,T=C\cup A$ã€‚ä»è€Œç­”æ¡ˆä¸ºï¼š

$$
\begin{aligned}
& \sum\limits_P\sum\limits_Q[P\cap Q=\emptyset]\sum\limits_{S\subseteq f(P)}\sum\limits_{T\subseteq f(Q)}(-1)^{|S|+|T|}2^{||S\cap T|}\prod\limits_{i\in P\cup Q} a_i\\
= & \sum\limits_S\sum\limits_T(-1)^{|S|+|T|}2^{|S\cap T|}\sum\limits_{S\subseteq f(P)}\sum\limits_{T\subseteq f(Q)}[P\cap Q=\emptyset]\prod\limits_{i\in P\cup Q} a_i
\end{aligned}
$$

è€ƒå¯Ÿ $P,Q$ å¯ä»¥å–åˆ°çš„é›†åˆï¼š$P,Q$ åˆ†åˆ«ä¸ºæ‰€æœ‰æ˜¯ $S,T$ è¶…é›†çš„æ•°æ„æˆé›†åˆï¼ˆåˆ†åˆ«è®°ä¸º $A_S,A_T$ï¼‰çš„å­é›†ï¼›æšä¸¾ $R=P\cup Q\subseteq A_S\cup A_T$ï¼Œåˆ™å¯¹äº $i\in R$ï¼Œè‹¥ $i\in A_S\cap A_T$ åˆ™å¯å°† $i$ ä»»æ„åˆ†é… $P/Q$ å¦åˆ™ $i$ å±äº $P/Q$ æ˜¯ç¡®å®šçš„ï¼Œå³ç­”æ¡ˆä¸ºï¼š

$$
\begin{aligned}
& \sum\limits_S\sum\limits_T(-1)^{|S|+|T|}2^{|S\cap T|}
\sum\limits_{R\subseteq A_S\cup A_T}\prod\limits_{i\in R} (1+[i\in A_S\cap A_T])a_i\\
= & \sum\limits_S\sum\limits_T(-1)^{|S|+|T|}2^{|S\cap T|}
\left(\sum\limits_{R_1\subseteq A_S\cap A_T} \prod\limits_{i\in R_1} 2a_i\right)
\left(\sum\limits_{R_2\subseteq A_S\cup A_T\setminus(A_S\cap A_T)} \prod\limits_{i\in R_2} a_i\right)\\
= & \sum\limits_S\sum\limits_T(-1)^{|S|+|T|}2^{|S\cap T|}
\left(\prod\limits_{i\subseteq A_S\cap A_T} (2a_i+1)\right)
\left(\prod\limits_{i\subseteq A_S\cup A_T\setminus(A_S\cap A_T)} (a_i+1)\right)
\end{aligned}
$$

ä»¤ $f_S=\prod\limits_{S\subseteq T} (a_T+1),g_S=\prod\limits_{S\subseteq T} (2a_T+1)$ï¼Œåˆ™ç­”æ¡ˆä¸ºï¼š

$$
\sum\limits_S\sum\limits_T(-1)^{|S|+|T|}2^{|S\cap T|}f_Sf_T\frac{g_{S\cup T}}{(f_{S\cup T})^2}
$$

$f_S$ å’Œ $g_S$ å‡å¯ä»¥é«˜ç»´åç¼€ç§¯è®¡ç®—ï¼Œå¤æ‚åº¦ $\mathcal{O}(n2^n)$ï¼Œåˆ™æ­¤æ—¶æš´åŠ›ç®—ä¸Šé¢çš„å¼å­å°±å¯ä»¥å¾—åˆ°ä¸€ä¸ª $\mathcal{O}(4^n)$ çš„åšæ³•ï¼›ç„¶è€Œå­˜åœ¨é—®é¢˜ï¼šä¼šå‡ºç° $/0$ çš„æƒ…å†µã€‚å¤„ç†å¾ˆç®€å•ï¼šè®°å½• $f_S,g_S=a\cdot0^k$ å³å¯ï¼Œä¹˜é™¤å‡æœ‰è‰¯å®šä¹‰ã€‚

æ³¨æ„åˆ° $|S\cap T|+|S\cup T|=|S|+|T|$ï¼Œå°†ç­”æ¡ˆæŒ‰ $S/T/S\cup T$ æ•´ç†å¾—ï¼š

$$
\sum\limits_S\sum\limits_T\left((-2)^{|S|}f_S\right)\left((-2)^{|T|}f_T\right)\frac{g_{S\cup T}}{(f_{S\cup T})^22^{|S\cup T|}}
$$

ä»¤ $\hat{f}_S=(-2)^{|S|}f_S$ï¼Œå¾— $h=\hat{f}\times \hat{f}$ï¼Œåˆ™ç­”æ¡ˆä¸ºï¼šï¼ˆæ­¤å¤„ä¹˜æ³•æ˜¯ or å·ç§¯ï¼‰

$$
\sum\limits_S h_S\frac{g_S}{f_S^22^{|S|}}
$$

å¤æ‚åº¦ $\mathcal{O}(n2^n)$ã€‚

ä»ç„¶å­˜åœ¨é—®é¢˜ï¼š$\hat{f}$ ä¸ $f$ ä¸€æ ·æ˜¯ $a\cdot 0^k$ å½¢å¼ä¿å­˜ï¼Œè€Œ $a_1\cdot 0^{k_1}$ å’Œ $a_2\cdot 0^{k_2}$ åŠ å‡æ³•è‹¥ $k_1\ne k_2$ æ˜¯æ²¡æœ‰è‰¯å®šä¹‰çš„ï¼ˆé™¤éç»´æŠ¤å…³äº $0$ çš„å¤šé¡¹å¼ï¼‰ï¼Œä½†æ˜¯å‘ç°æœ€ç»ˆéæœ€ä½ä½åœ¨é™¤ä»¥ $f_S^2$ å $0$ çš„æ¬¡æ•°å¿…ç„¶ $>0$ï¼Œä»è€Œå¯ä»¥ç›´æ¥èˆå»ï¼Œå³ä¿ç•™ $0$ æ¬¡æ•°è¾ƒä½çš„é¡¹å³å¯ã€‚

---

## ä½œè€…ï¼šæµæ°´è¡Œèˆ¹CCD (èµï¼š11)

è¿˜æ˜¯å¾ˆå¥½çš„ä¸€é“æ•°æ•°é¢˜ã€‚

å› ä¸ºæ´›è°·å’Œåšå®¢å›­çš„å…¬å¼ä¸­çš„æ±‰å­—æ¸²æŸ“éƒ½ä¸æ˜¯å¾ˆç¾è§‚ï¼Œç›´æ¥æŒ‚å›¾ç‰‡äº†ï¼š

## æ€è·¯

![](https://cdn.luogu.com.cn/upload/image_hosting/9lt6wf39.png)

## code

```cpp
#include<bits/stdc++.h>
using namespace std;
using ll = long long;
using ull = unsigned long long;
#define REP(i, l, r) for (int i = l; i <= r; ++i)
#define PER(i, l, r) for (int i = l; i >= r; --i)
#define clr(name, n) memset(name, 0, (n + 1) * sizeof(name[0]))
#define mem(name, v, n) memset(name, v, (n + 1) * sizeof(name[0]))
#define ld cin
#define jyt cout
// #define int long long
constexpr int N = (1 << 20) + 7;
constexpr int P = 998244353;
namespace JoKing {
    struct poly {
        ll A, B;
        poly() {A = B = 0;}
        poly(ll X, ll Y) {A = X, B = Y;}
        inline poly lxl() {return poly(P - A, B);}
        friend poly operator + (poly X, poly Y) {return X.B == Y.B ? poly((X.A + Y.A + P) % P, X.B) : (X.B < Y.B ? X : Y);}
        friend poly operator - (poly X, poly Y) {return X.B == Y.B ? poly((X.A - Y.A + P) % P, X.B) : (X.B < Y.B ? X : Y.lxl());}
        friend poly operator * (poly X, poly Y) {return poly(X.A * Y.A % P, X.B + Y.B);}
    };
    inline long long qpow(long long x, long long y) {long long R = 1; for (; y; (x *= x) %= P, y >>= 1ll) if (y & 1ll) (R *= x) %= P; return R;}
    int n, m, a[N]; poly alpha[N], beta[N];
    inline void FWT(poly* a, ll op) {
        for (int len = 2, half = 1; len <= m; len <<= 1, half <<= 1)
            for (int l = 0; l < m; l += len)
                for (int k = 0; k < half; ++k)
                    a[l + half + k] = op ? a[l + half + k] + a[l + k] : a[l + half + k] - a[l + k];
    }
    signed main() { ll Ans = 0;
        ld >> n, m = (1 << n);
        REP(i, 0, m - 1) ld >> a[i];
        REP(i, 0, m - 1) alpha[i] = (a[i] == 998244352 ? poly(1, 1) : poly(a[i] + 1, 0));
        REP(i, 0, m - 1) {
            if (a[i] == 998244352) beta[i] = poly((a[i] * 2 + 1) % P, -2);
            else if (a[i] == 499122176) beta[i] = poly(qpow(a[i] + 1, P - 2) * qpow(a[i] + 1, P - 2) % P, 1);
            else beta[i] = poly(qpow(a[i] + 1, P - 2) * qpow(a[i] + 1, P - 2) % P * (a[i] * 2 + 1) % P, 0);
        }
        REP(j, 0, n - 1) PER(i, m - 1, 0) if (!(i & (1 << j))) alpha[i] = alpha[i] * alpha[i | (1 << j)];
        REP(j, 0, n - 1) PER(i, m - 1, 0)  if (!(i & (1 << j))) beta[i] = beta[i] * beta[i | (1 << j)];
        REP(i, 0, m - 1) (alpha[i].A *= qpow(P - 2, __builtin_popcount(i))) %= P, (beta[i].A *= qpow(qpow(2, __builtin_popcount(i)), P - 2)) %= P;
        FWT(alpha, 1); REP(i, 0, m - 1) alpha[i] = alpha[i] * alpha[i]; FWT(alpha, 0);
        REP(i, 0, m - 1) beta[i] = beta[i] * alpha[i], (Ans += !beta[i].B ? beta[i].A : 0ll) %= P;
        jyt << Ans << '\n';
        return 0;
    }
}
signed main() {
#ifdef WYY
    freopen("files/code.in", "r", stdin);
    freopen("files/code.out", "w", stdout);
    freopen("files/code.err", "w", stderr);
#endif
    ios::sync_with_stdio(false), cin.tie(0), cout.tie(0);
    int Opt = 0, T = 0; ld >> Opt >> T;
    while (T--) JoKing::main();
    return 0;
}
``

---

## ä½œè€…ï¼šWorldMachine (èµï¼š10)

å¥½éš¾å•Šã€‚

è®¾ $N=\bigcup\limits_{i=0}^{n-1}\{i\}$ï¼Œ$\text{val}(S)=\prod\limits_{i\in S}a_i$ï¼Œç”±äº $P\cap Q=\varnothing$ï¼Œæ•… $\text{val}(P\cup Q)=\text{val}(P)\text{val}(Q)$ã€‚å…ˆæŠŠè´¡çŒ®æ‹†åˆ°æ¯ä¸ª $f(P)$ ä¸Šï¼š
$$
\begin{aligned}
\text{answer}&=\sum_{S\subseteq N}\sum_{\substack{P\subseteq2^N\\f(P)=S}}\sum_{\substack{Q\subseteq2^N\\f(Q)=S\\P\cap Q=\varnothing}}\text{val}(P\cup Q)\\
&=\sum_{S\subseteq N}\sum_{\substack{P\subseteq2^N\\f(P)=S}}\text{val}(P)\sum_{\substack{Q\subseteq2^N\\f(Q)=S\\P\cap Q=\varnothing}}\text{val}(Q)
\end{aligned}
$$
å…ƒç´ çš„äº¤é›†æ°å¥½ä¸º $S$ ä¸å¤ªå¥½åšï¼Œä¸ºäº†æ–¹ä¾¿å†™æˆ FWT éœ€è¦çš„å½¢å¼ï¼Œè€ƒè™‘ä½¿ç”¨è¶…é›†åæ¼”ï¼š
$$
\sum_{\substack{P\subseteq2^N\\f(P)=S}}\text{val}(P)=\sum_{S\subseteq T\subseteq N}(-1)^{|T|-|S|}\sum_{\substack{P\subseteq 2^N\\T\subseteq f(P)}}\text{val}(P)
$$
ä»£å…¥åŸå¼ï¼š
$$
\begin{aligned}
\text{answer}&=\sum_{S\subseteq N}\sum_{S\subseteq T_P\subseteq N}(-1)^{|T_P|-|S|}\sum_{\substack{P\subseteq 2^N\\T_P\subseteq f(P)}}\text{val}(P)\sum_{S\subseteq T_Q\subseteq N}(-1)^{|T_Q|-|S|}\sum_{\substack{Q\subseteq 2^N\\T_Q\subseteq f(Q)\\P\cap Q=\varnothing}}\text{val}(Q)
\end{aligned}
$$
å‘ç°ä¸¤ä¸ª $(-1)^{|S|}$ æŠµæ¶ˆæ‰äº†ï¼Œå‰©ä¸‹çš„å°±æ˜¯ $(-1)^{|T_P|+|T_Q|}$ã€‚ç„¶åäº¤æ¢æ±‚å’Œç¬¦å·ï¼Œæ”¹ä¸ºæœ€å¤–å±‚æšä¸¾ $T_P,T_Q$ï¼š
$$
\begin{aligned}
\text{answer}&=\sum_{T_P,T_Q\subseteq N}(-1)^{|T_P|+|T_Q|}\sum_{S\subseteq T_P\cap T_Q}\sum_{\substack{P\subseteq 2^N\\T_P\subseteq f(P)}}\text{val}(P)\sum_{\substack{Q\subseteq 2^N\\T_Q\subseteq f(Q)\\P\cap Q=\varnothing}}\text{val}(Q)
\end{aligned}
$$
è¿™æ—¶å€™ $S$ å°±è¢«æ¶ç©ºäº†ï¼Œç›´æ¥å°±æ˜¯ $2^{|T_P\cap T_Q|}$ï¼Œç°åœ¨æŸ¿å­å˜æˆäº†è¿™æ ·ï¼š
$$
\begin{aligned}
\text{answer}&=\sum_{T_P,T_Q\subseteq N}(-1)^{|T_P|+|T_Q|}2^{|T_P\cap T_Q|}\sum_{\substack{P\subseteq 2^N\\T_P\subseteq f(P)}}\text{val}(P)\sum_{\substack{Q\subseteq 2^N\\T_Q\subseteq f(Q)\\P\cap Q=\varnothing}}\text{val}(Q)
\end{aligned}
$$
è€ƒè™‘åé¢é‚£ä¸€å¨ä¸œè¥¿æ˜¯åœ¨å¹²ä»€ä¹ˆï¼Œè®¾ $F_P$ ä¸º $T_P$ çš„æ‰€æœ‰çˆ¶é›†æ„æˆçš„é›†åˆï¼ŒåŒæ ·å®šä¹‰ $F_Q$ã€‚é‚£ä¹ˆåŸæ±‚å’Œæ¡ä»¶å°±å˜æˆäº† $P\subseteq F_P$ å’Œ $Q\subseteq F_Q$ã€‚

è€ƒè™‘æ¯ä¸ª $R\subseteq N$ å¯¹ç­”æ¡ˆçš„è´¡çŒ®ã€‚å¯ä»¥å‘ç°è‹¥ $R\in F_P\cap F_Q$ï¼Œåˆ™ $R$ å¯ä»¥é€‰æ‹©åœ¨ $P$ æˆ– $Q$ ä¸­ï¼Œä¹Ÿå¯ä»¥ä¸é€‰ï¼Œæ•…è´¡çŒ®ä¸º $2a_R+1$ï¼›å¦åˆ™è‹¥ $R\in F_P\Delta F_Q$ï¼ˆ$\Delta$ è¡¨ç¤ºé›†åˆå¯¹ç§°å·®ï¼‰ï¼Œå¯ä»¥é€‰æ‹©åœ¨ $P$ æˆ– $Q$ çš„å…¶ä¸­ä¹‹ä¸€ï¼Œä¹Ÿå¯ä»¥ä¸é€‰ï¼Œæ•…è´¡çŒ®ä¸º $a_R+1$ï¼›å¦åˆ™ä¸èƒ½åœ¨ $P$ æˆ– $Q$ ä¸­ï¼Œæ²¡æœ‰è´¡çŒ®ï¼ˆè´¡çŒ®ä¸º $1$ï¼‰ã€‚

å› æ­¤åŸå¼åŒ–ä¸ºï¼š
$$
\begin{aligned}
\text{answer}&=\sum_{T_P,T_Q\subseteq N}(-1)^{|T_P|+|T_Q|}2^{|T_P\cap T_Q|}\prod_{R\in F_P\cap F_Q}(2a_R+1)\prod_{R\in F_P\Delta F_Q}(a_R+1)
\end{aligned}
$$
ä¸å¦¨è®¾ $A_S=\prod\limits_{S\subseteq T}(2a_T+1)$ï¼Œ$B_S=\prod\limits_{S\subseteq T}(a_T+1)$ï¼Œè€ƒè™‘ç”¨ $A,B$ æ¥è¡¨ç¤ºåé¢è¿™ä¸€å¨ä¸œè¥¿ï¼ŒæŠŠå¯¹ç§°å·®æ‹†å¼€æ¥ï¼Œç”±äº $F_P\cap F_Q$ å°±æ˜¯ $T_P\cup T_Q$ çš„å…¨ä½“çˆ¶é›†ï¼Œå¯ä»¥å‘ç°å…¶å®å°±æ˜¯ $\dfrac{A_{T_P\cup T_Q}B_{T_P}B_{T_Q}}{B^2_{T_P\cup T_Q}}$ã€‚

è¿›ä¸€æ­¥åœ°ï¼Œè§‚å¯Ÿæ‰€æ±‚å¼çš„ç»“æ„ï¼Œä¸éš¾æƒ³åˆ°è®¾ $C_S=\dfrac{A_S}{2^{|S|}B^2_S}$ï¼Œ$D_S=(-1)^{|S|}2^{|S|}B_S$ï¼ŒåŸå¼åŒ–ä¸ºï¼š
$$
\begin{aligned}
\text{answer}&=\sum_{T_P,T_Q\subseteq N}C_{T_P\cup T_Q}D_{T_P}D_{T_Q}\\
&=\sum_{T\subseteq N}C_T\sum_{T_P\cup T_Q=T}D_{T_P}D_{T_Q}
\end{aligned}
$$
è¿™æ˜¯ä¸€ä¸ª OR å·ç§¯çš„å½¢å¼ï¼Œç›´æ¥ä¸Š FWT å³å¯ã€‚

ä½†è¿™æ ·åšæœ‰ä¸€ä¸ªé—®é¢˜ï¼šåˆ†æ¯ä¸Šå‡ºç°äº† $B$ï¼Œè€Œ $B$ çš„å®šä¹‰ä¸­å‡ºç°äº† $a_R+1$ï¼Œå½“ $a_R=998244352$ æ—¶ä¼šå‡ºç°é™¤æ•°ä¸º $0$ çš„æƒ…å†µï¼Œä½†æ­¤æ—¶ç­”æ¡ˆåˆæ˜¯å­˜åœ¨çš„ã€‚

å› æ­¤éœ€è¦è®°å½•æ¯ä¸ªæ•°ä¹˜/é™¤äº†å¤šå°‘ä¸ª $0$ï¼Œå³ä»¥ $x\times 0^z$ çš„å½¢å¼è®°å½•ï¼Œå¹¶å®šä¹‰å…¶è¿ç®—ï¼Œæœ€åå¾—åˆ° $0^0$ çš„éƒ¨åˆ†çš„å’Œå°±æ˜¯ç­”æ¡ˆã€‚

```cpp
#include <bits/stdc++.h>
using namespace std;
#define il inline
#define gc getchar_unlocked()
il int rd() { int x = 0; char c = 0; while (c < '0' || c > '9') c = gc; while (c >= '0' && c <= '9') x = x * 10 - '0' + c, c = gc; return x; }
typedef long long ll;
const int N = 1 << 20 | 5, p = 998244353, inv2 = p + 1 >> 1;
int task_id, T, ppc[N], invpw2[21], _n, n, a[N];
int qpow(int a, int b) { int c = 1; while (b) { if (b & 1) c = (ll)c * a % p; a = (ll)a * a % p, b >>= 1; } return c; }
struct num { int x, z; num(int a = 0) { if (a) x = a, z = 0; else x = 1, z = 1;  } num(int x, int z): x(x), z(z) {} } A[N], B[N], invB[N], C[N], D[N], E[N];
il num operator+(num a, num b) { return a.z == b.z ? num((a.x + b.x) % p, a.z) : (a.z < b.z ? a : b); }
il num operator-(num a, num b) { return a.z == b.z ? num((a.x - b.x + p) % p, a.z) : (a.z < b.z ? a : num((p - b.x) % p, b.z)); }
il num operator*(num a, num b) { return num((ll)a.x * b.x % p, a.z + b.z); }
il num inv(num a) { return num(qpow(a.x, p - 2), -a.z); }
il num operator/(num a, num b) { return a * inv(b); }
void sufmul(num a[]) {
	for (int i = 0; i < _n; i++) {
		for (int j = 0; j < n; j++) if (!(j >> i & 1)) a[j] = a[j] * a[j ^ 1 << i];
	}
}
void FWT(num a[]) {
	for (int i = 0; i < _n; i++) {
		for (int j = 0; j < n; j++) if (j >> i & 1) a[j] = a[j] + a[j ^ 1 << i];
	}
}
void iFWT(num a[]) {
	for (int i = _n - 1; ~i; i--) {
		for (int j = 0; j < n; j++) if (j >> i & 1) a[j] = a[j] - a[j ^ 1 << i];
	}
}
void solve() {
	_n = rd(), n = 1 << _n;
	for (int i = 0; i < n; i++) a[i] = rd(), A[i] = num((a[i] << 1 | 1) % p), B[i] = num((a[i] + 1) % p);
	sufmul(A), sufmul(B);
	for (int i = 0; i < n; i++) invB[i] = inv(B[i]);
	for (int i = 0; i < n; i++) C[i] = A[i] * invB[i] * invB[i] * invpw2[ppc[i]];
	for (int i = 0; i < n; i++) D[i] = B[i] * (1 << ppc[i]) * (ppc[i] & 1 ? p - 1 : 1);
	FWT(D);
	for (int i = 0; i < n; i++) E[i] = D[i] * D[i];
	iFWT(E);
	int ans = 0;
	for (int i = 0; i < n; i++) {
		num x = C[i] * E[i];
		if (!x.z) ans = (ans + x.x) % p;
	}
	cout << ans << '\n';
}
int main() {
	// freopen("set.in", "r", stdin), freopen("set.out", "w", stdout);
	for (int i = 1; i < N; i++) ppc[i] = ppc[i ^ (i & -i)] + 1;
	invpw2[0] = 1; for (int i = 1; i <= 20; i++) invpw2[i] = (ll)invpw2[i - 1] * inv2 % p;
	task_id = rd(), T = rd(); while (T--) solve();
}
```

---

## ä½œè€…ï¼šPetit_Souris (èµï¼š9)

åœºä¸Šçº¦ 1h é€šè¿‡æ­¤é¢˜ï¼Œé€€å½¹ä¹‹æˆ˜çš„é«˜å…‰æ—¶åˆ»ã€‚ä¸€ç›´è®­ç»ƒçš„è®¡æ•°æ°´å¹³ç¡®å®åœ¨è¿™é¢˜ä¸Šè¡¨ç°å‡ºæ¥äº†ï¼Œåªå¯æƒœè¿™ day 2 æ²¡æœ‰ç»™æˆ‘ä¹˜èƒœè¿½å‡»çš„æœºä¼šï¼Œç¿»ç›˜å¤±è´¥ã€‚

è€ƒè™‘æšä¸¾ $S$ï¼Œè®¡ç®— $f(P) = f(Q) = S$ çš„æ–¹æ¡ˆæ•°ã€‚ç›´è§‚çš„æƒ³æ³•æ˜¯è¿›è¡Œå®¹æ–¥ï¼šæšä¸¾é›†åˆ $U\supseteq S, V \supseteq S$ï¼Œé’¦å®š $f(P)$ ä¸­æ‰€æœ‰åœ¨ $U$ ä¸­çš„ä½ä¸º $1$ï¼Œ$f(Q)$ ä¸­æ‰€æœ‰åœ¨ $V$ ä¸­çš„ä½ä¸º $1$ã€‚

è¿™æ ·ä¸€ä¸ª $(U, V)$ å¯¹ $S$ çš„è´¡çŒ®ç³»æ•°ä¸º $(-1)^{\mathrm{pop(U) + pop(V) - 2pop(S)}}$ã€‚$(U, V)$ çš„æ–¹æ¡ˆæ•°å®¹æ˜“è®¡ç®—ï¼šè€ƒè™‘æ‰€æœ‰çš„ $i$ï¼Œå¦‚æœ $i$ åŒæ—¶æ˜¯ $U, V$ çš„è¶…é›†ï¼Œé‚£ä¹ˆæ–¹æ¡ˆæ•°ä¸º $1 + 2a_i$ï¼›å¦‚æœæ˜¯ $U, V$ å…¶ä¸­ä¸€ä¸ªçš„è¶…é›†ï¼Œæ–¹æ¡ˆæ•°ä¸º $1 + a_i$ï¼›å¦åˆ™æ–¹æ¡ˆæ•°ä¸º $1$ã€‚æŠŠæ‰€æœ‰ $i$ çš„æ–¹æ¡ˆæ•°ä¹˜èµ·æ¥å³å¯ã€‚

è¿™æ ·å·²ç»å¯ä»¥åšåˆ° $\mathcal O(8 ^ n)$ äº†ã€‚

ä¼˜åŒ–çš„æƒ³æ³•å¾ˆè‡ªç„¶ï¼šè€ƒè™‘äº¤æ¢æšä¸¾é¡ºåºï¼Œå…ˆæšä¸¾ $U, V$ï¼Œè¿™æ—¶å€™å¯èƒ½äº§ç”Ÿè´¡çŒ®çš„ $S$ å¿…é¡»æ˜¯ $U\ \mathrm{and}\ V$ çš„å­é›†ã€‚ç°åœ¨å’Œ $S$ æœ‰å…³çš„åªæœ‰å®¹æ–¥ç³»æ•°ï¼Œè¿™ä¸ªæ•°åªå’Œ $\mathrm{pop}(U\ \mathrm{and}\ V)$ æœ‰å…³ã€‚

æ±‚ $(U, V)$ çš„æ–¹æ¡ˆæ•°å¯ä»¥é€šè¿‡ç ”ç©¶æ€§è´¨ B æƒ³åˆ°ä¸€ä¸ªæ–¹æ³•ï¼šè®° $f_S$ è¡¨ç¤º $S$ æ‰€æœ‰è¶…é›†çš„ $(1 + a_i)$ çš„ä¹˜ç§¯ï¼Œ$g_S$ è¡¨ç¤º $S$ æ‰€æœ‰è¶…é›†çš„ $(1 + 2a_i)$ çš„ä¹˜ç§¯ã€‚æ˜¾ç„¶æƒå€¼ä¸º $\frac{f_Uf_V}{g_{U \ \mathrm{or}\ V}}$ã€‚å› æ­¤å®¹æ˜“ä¼˜åŒ–åˆ° $\mathcal O(4 ^ n)$ã€‚è¿›ä¸€æ­¥åœ°ï¼Œ$\mathrm{pop}(U\ \mathrm{and}\ V) = \mathrm{pop}(U) + \mathrm{pop}(V) - \mathrm{pop}(U \ \mathrm{or} \ V)$ï¼Œå› æ­¤å®¹æ˜“ç”¨ or - FWT ä¼˜åŒ–è‡³ $\mathcal O(2 ^ nn)$ã€‚

æœ€åéœ€è¦è€ƒè™‘ä¸€ä¸‹ $a_i = 998244352$ å¦‚ä½•å¤„ç†ã€‚è€ƒè™‘æ‰©åŸŸï¼Œå¯¹æ¯ä¸ªå€¼è®°å½•äºŒå…ƒç»„ $(k, v)$ è¡¨ç¤ºä¹˜ä¸Šäº† $k$ ä¸ª $0$ï¼Œæ˜¾ç„¶å¯¹äºæ¯ä¸ª $S$ åªæœ‰æœ€å°çš„ $k$ æœ‰æ•ˆã€‚å®¹æ˜“å‘ç° FWT å¯ä»¥è¿›è¡Œï¼Œå› ä¸ºå…·æœ‰å¯åŠ æ€§ã€‚è€Œ IFWT éœ€è¦å‡æ³•ï¼Œçœ‹ä¼¼ä¼šå‡ºç°é—®é¢˜ï¼Œä½†æ˜¯å®é™…ä¸Šå®¹æ˜“åˆ†æå‡ºæ­£ç¡®æ€§ï¼Œå› ä¸ºå¦‚æœ $(k_1, v_1)$ å‡ $(k_2, v_2)$ æ—¶ï¼Œä¸€å®šæœ‰ $k_2 \ge k_1$ï¼Œä¸” $k_2>k_1$ æ—¶ä¸äº§ç”Ÿè´¡çŒ®ã€‚å› æ­¤æ­£ç¡®æ€§å¾—è¯ï¼Œé—®é¢˜åœ¨ $\mathcal O(2 ^nn)$ æ—¶é—´å¤æ‚åº¦å†…å®Œç¾è§£å†³ã€‚

å¤ç°çš„ä»£ç ï¼š

```cpp
#include <bits/stdc++.h>
using ll = long long;
using ld = long double;
using ull = unsigned long long;
using namespace std;
template <class T>
using Ve = vector<T>;
#define ALL(v) (v).begin(), (v).end()
#define pii pair<ll, ll>
#define rep(i, a, b) for(ll i = (a); i <= (b); ++i)
#define per(i, a, b) for(ll i = (a); i >= (b); --i)
#define pb push_back
bool Mbe;
ll read() {
    ll x = 0, f = 1; char ch = getchar();
    while(ch < '0' || ch > '9') {if(ch == '-') f = -1; ch = getchar();}
    while(ch >= '0' && ch <= '9') x = x * 10 + ch - '0', ch = getchar();
    return x * f;
}
void write(ll x) {
    if(x < 0) putchar('-'), x = -x;
    if(x > 9) write(x / 10);
    putchar(x % 10 + '0');
}
const ll Mod = 998244353;
ll n, a[(1 << 20) + 9];
ll pw(ll x, ll p) {
    ll res = 1;
    while(p) {
        if(p & 1) res = res * x % Mod;
        x = x * x % Mod, p >>= 1;
    }
    return res;
}
ll Add(ll x, ll y) {
    return ((x += y) >= Mod) ? (x - Mod) : (x);
}
ll Sub(ll x, ll y) {
    return ((x -= y) < 0) ? (x + Mod) : (x);
}
pii operator + (const pii &a, const pii &b) {
    if(a.first ^ b.first) return min(a, b);
    return {a.first, Add(a.second, b.second)};
}
pii operator - (const pii &a, const pii &b) {
    if(a.first ^ b.first) return a;
    return {a.first, Sub(a.second, b.second)};
}
pii operator * (const pii &a, const pii &b) {
    return {a.first + b.first, a.second * b.second % Mod};
}
pii f[(1 << 20) + 5], g[(1 << 20) + 5];
ll pw2[25], ipw2[25];
void FWT(pii *f) {
    for(ll i = 1; i < (1 << n); i <<= 1) {
        for(ll j = 0; j < (1 << n); j += (i << 1)) {
            rep(k, 0, i - 1) f[j + k + i] = f[j + k + i] + f[j + k];
        }
    }
}
void IFWT(pii *f) {
    for(ll i = 1; i < (1 << n); i <<= 1) {
        for(ll j = 0; j < (1 << n); j += (i << 1)) {
            rep(k, 0, i - 1) f[j + k + i] = f[j + k + i] - f[j + k];
        }
    }
}
ll pc(ll n) {
    return __builtin_popcount(n);
}
void solve() {
    n = read();
    rep(i, 0, (1 << n) - 1) a[i] = read();
    rep(i, 0, (1 << n) - 1) {
        if(a[i] != Mod - 1) {
            f[i] = {0, (1 + a[i]) % Mod};
            g[i] = {0, (1 + a[i] + a[i]) % Mod * pw((1 + a[i]) * (1 + a[i]) % Mod, Mod - 2) % Mod};
        }
        else {
            f[i] = {1, 1};
            g[i] = {2, Mod - 1};
        }
    }
    for(ll i = 1; i < (1 << n); i <<= 1) {
        for(ll j = 0; j < (1 << n); j += (i << 1)) {
            rep(k, 0, i - 1) {
                f[j + k] = f[j + k] * f[j + k + i];
                g[j + k] = g[j + k] * g[j + k + i];
            }
        }
    }
    rep(i, 0, (1 << n) - 1) {
        if(pc(i) & 1) f[i].second = Mod - f[i].second;
        f[i].second = f[i].second * pw2[pc(i)] % Mod;
    }
    FWT(f);
    rep(i, 0, (1 << n) - 1) f[i] = f[i] * f[i];
    IFWT(f);
    ll ans = 0;
    rep(i, 0, (1 << n) - 1) {
        if(f[i].first ^ g[i].first) continue;
        ans = (ans + f[i].second * g[i].second % Mod * ipw2[pc(i)]) % Mod;
    }
    write(ans), putchar('\n');
}
bool Med;
int main() {
    cerr << fabs(&Med - &Mbe) / 1048576.0 << "MB\n";
    ll T = read(); T = read();
    pw2[0] = 1;
    rep(i, 1, 22) pw2[i] = pw2[i - 1] * 2 % Mod;
    rep(i, 0, 22) ipw2[i] = pw(pw2[i], Mod - 2);
    while(T--) solve();
    cerr << "\n" << clock() * 1.0 / CLOCKS_PER_SEC * 1000 << "ms\n";
    return 0;
}
```

---

## ä½œè€…ï¼šluanyanjia (èµï¼š8)

æˆ‘è™½ç„¶æ²¡èƒ½åœºåˆ‡æ­¤é¢˜ï¼Œä½†æ˜¯ä¹Ÿè·å¾—äº†å¾ˆé«˜çš„åˆ†æ•°ï¼Œç®—æ˜¯æ‹¯æ•‘äº†æˆ‘æ•´ä¸ª Day 2 äº†ã€‚

é¦–å…ˆæœ‰ $O(8^n)$ çš„ DPã€‚è®¾ $f_{i,j,k}$ï¼Œè¡¨ç¤ºå‰ $i$ ä¸ªæ•°çš„æƒ…å†µç¡®å®šäº†ï¼Œä½¿å¾— $f(P) = j$ï¼Œ$f(Q) = k$ çš„æ–¹æ¡ˆæ•°ã€‚æœ‰å¦‚ä¸‹è½¬ç§»ï¼š

$$ f_{i,j,k} \times a_i \rightarrow f_{i+1,j \cap (i+1),k}$$
$$ f_{i,j,k} \times a_i \rightarrow f_{i+1,j,k \cap (i+1)}$$
$$ f_{i,j,k} \rightarrow f_{i+1,j,k}$$

åˆ°æ­¤ä¸ºæ­¢å°±å¯ä»¥é›†åˆå¹‚çº§æ•°æš´åšäº†ã€‚

æ¯æ¬¡è½¬ç§»å°±æ˜¯ $\operatorname{and}$ å·ç§¯ã€‚è€ƒè™‘ FMT ä¹‹åçš„ $[x^j y^k]$ã€‚æ¯æ¬¡ç›¸å½“äºç‚¹ä¹˜ FMT åçš„ $x^i + y^i + 1$ã€‚ä¹Ÿå°±æ˜¯ä¹˜ä¸Š $a_i \times ([j \subseteq i] + [k \subseteq i]) + 1$ã€‚è¿™æ ·ä¸‹æ¥æˆ‘ä»¬å¯ä»¥è½»æ¾ç®—å‡ºä¸€ä¸ª $[x^j y^k]$ å¤„çš„å€¼ $g_{j,k}$ã€‚

è®¾ï¼š

$$ ss_i = \prod\limits_{i \subseteq j} (2a_j + 1),s_i = \prod\limits_{i \subseteq j} (a_j + 1)$$

é‚£ä¹ˆæœ‰ï¼š

$$ g_{j,k} = \dfrac{s_j s_k ss_{j \cup k}}{s_{j \cup k} ^ 2} $$

æ„æ€å°±æ˜¯åŒæ—¶æ˜¯ $j,k$ è¶…é›†çš„éœ€è¦ä¹˜ $2a_i + 1$ï¼Œåªæ˜¯ä¸€ä¸ªçš„è¶…é›†çš„è¦ä¹˜ $a_i + 1$ã€‚

å¯èƒ½ä¼šé™¤ä»¥ $0$ï¼Œåªéœ€è¦è®°å½• $c_i$ è¡¨ç¤º $i$ è¶…é›†ä¸­ $0$ å› å­çš„æ•°é‡ï¼Œç„¶ååˆ¤æ–­æ˜¯å¦æœ‰ $c_j = c_k = c_{j \cup k}$ å³å¯ã€‚

è‡³æ­¤æˆ‘ä»¬å¯ä»¥ $O(2^n n)$ é¢„å¤„ç†ï¼Œ$O(1)$ æŸ¥è¯¢ $g_{j,k}$ ä¸€ä¸ªä½ç½®çš„å€¼ã€‚å…¨éƒ¨æŸ¥ä¸€éå† IFMT å›æ¥éœ€è¦ $O(4^n n)$ çš„å¤æ‚åº¦ã€‚å¯ä»¥è·å¾— $36$ åˆ†ã€‚

æˆ‘ä»¬å‘ç°æœ€åå…¶å®åªç”¨äº† $f_{i,i}$ çš„å€¼ï¼Œè€ƒè™‘æŠŠ IFMT æ‹†å¼€å¼å­ï¼š

$$
\begin{align*}
f_{i,i} & = \sum\limits_{i \subseteq j,i \subseteq k} (-1)^{\left|j-i\right| + \left|k-i\right|}g_{j,k}  \\

& = \sum\limits_{i \subseteq j,i \subseteq k}(-1)^{\left|j\right|+\left|k\right|}g_{j,k} 
\end{align*}
$$

è¿™ç›¸å½“äºå¯¹äº $g_{j,k}$ï¼Œæœ‰ $2^{\left|{j \cap k}\right|}$ ä¸ª $i$ ç»Ÿè®¡åˆ°äº†ä»–ã€‚å› æ­¤ç­”æ¡ˆå°±æ˜¯ï¼š

$$
\begin{align*}
ans & = \sum\limits_{j,k} (-1)^{\left|j\right|+\left|k\right|}2^{\left|{j \cap k}\right|}g_{j,k}\\
& = \sum\limits_{j,k} (-2)^{\left|j\right|+\left|k\right|}2^{- \left|{j \cup k}\right|} \dfrac{s_j s_k ss_{j \cup k}}{s_{j \cup k} ^ 2}
\end{align*}
$$


æ³¨æ„è¿™é‡Œç”¨åˆ°äº† $\left|j\cap k\right| = \left|j\right| + \left|k\right| - \left|j \cup k\right|$ã€‚

è¿™å·²ç»å˜æˆäº†æˆ–å·ç§¯çš„å½¢å¼ï¼ä¸è€ƒè™‘ $a_i = mod - 1$ çš„æƒ…å†µï¼Œå¯ä»¥ç›´æ¥åšåˆ° $O(2^n n)$ï¼Œæ‹¼ä¸Šæš´åŠ›è·å¾— $68$ åˆ†ã€‚

æˆ‘èµ›æ—¶çš„æƒ³æ³•å°±æ­¢æ­¥äºæ­¤ã€‚$a_i = mod - 1$ æ—¶æˆ‘ä»¬è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ

ä¸€ä¸ªæƒ³æ³•æ˜¯æ ¹æ®ä¸Šé¢æš´åŠ›çš„ç»“è®ºï¼Œåªæœ‰ $c_i$ ç›¸åŒçš„æ‰èƒ½äº’ç›¸è½¬ç§»ï¼Œå› æ­¤æŒ‰ç…§ $c_i$ åˆ†ç±»åˆ†åˆ«è·‘ FMTã€‚ä½†æ˜¯è¿™ä¸ªå¤æ‚åº¦æ˜¯é”™çš„ã€‚A æ€§è´¨ä¹Ÿåªèƒ½è¿‡ä¸€ä¸ªç‚¹ã€‚

ä½†æ˜¯ $c_i$ è¿˜æœ‰ä¸€ä¸ªæ€§è´¨å°±æ˜¯å¦‚æœ $i \subseteq j$ï¼Œé‚£ä¹ˆ $c_i > c_j$ï¼Œè€Œ FWT æ—¶æˆ‘ä»¬åªä¼šå’Œè‡ªå·±çš„å­é›†è¿›è¡Œè¿ç®—ã€‚æ‰€ä»¥ $i$ å­˜åœ¨ä¸€ä¸ªå­é›† $j$ æ»¡è¶³ $c_j > c_i$ æ—¶ $j$ çš„å­é›† $k$ ä¹Ÿä¸€å®šæ»¡è¶³ $c_k > c_i$ æ‰€ä»¥ $j$ çš„ä¸€åˆ‡ä¿¡æ¯å¯¹äº $i$ å°±æ²¡ç”¨äº†ã€‚å› æ­¤æˆ‘ä»¬åªéœ€è¦åœ¨ $c_j = c_i$ çš„æ—¶å€™æ‰è½¬ç§»å³å¯ã€‚ç±»ä¼¼äºå…¶ä»–é¢˜è§£è¯´çš„åªä¿ç•™ä½æ¬¡é¡¹ã€‚

å¯ä»¥è·å¾— $100$ åˆ†ã€‚

$68$ ä»£ç åŠ ä¸Šä¸€è¡Œå°±å¯ä»¥è¿‡ã€‚ç”Ÿæ°”äº†ã€‚

### ä»£ç 

```cpp
inline void Add(int &a,int b){(a+=b)>=mod?a-=mod:1;}
inline void FWT(int *a,int n,int x){
	for(int t=2,k=1;t<=n;t<<=1,k<<=1)
		for(int i=0;i<n;i+=t)
			for(int j=0;j<k;j++){
                if(c[i+j]==c[i+j+k])Add(a[i+j+k],1ll*a[i+j]*x%mod);
            }
}
inline void Solve(){
    rd(n);
    V=(1<<n);
    for(int i=0;i<V;i++)rd(a[i]);
    for(int i=0;i<V;i++){
        s[i]=a[i]+1;c[i]=0;
        ss[i]=(2*a[i]+1)%mod;
        if(a[i]==mod-1)s[i]=c[i]=1;
    }
    for(int t=0;t<n;t++){
        for(int i=0;i<V;i++){
            if(!(i>>t&1)){
                s[i]=1ll*s[i]*s[i^(1<<t)]%mod;
                ss[i]=1ll*ss[i]*ss[i^(1<<t)]%mod;
                c[i]+=c[i^(1<<t)];
            }
        }
    }
    for(int i=0;i<V;i++)ss[i]=1ll*ss[i]*KSM(s[i],(mod-2)*2)%mod;
    for(int i=0;i<V;i++)f[i]=1ll*s[i]*KSM(mod-2,__builtin_popcount(i))%mod;
    FWT(f,V,1);
    for(int i=0;i<V;i++)f[i]=1ll*f[i]*f[i]%mod;
    FWT(f,V,mod-1);
    int res=0;
    for(int i=0;i<V;i++){
        Add(res,1ll*f[i]*ss[i]%mod*KSM((mod+1)/2,__builtin_popcount(i))%mod);
    }
    printf("%d\n",res);
}
```

---

## ä½œè€…ï¼šwatermoon (èµï¼š6)

é€€å½¹å¥½ä¹…æ²¡åšé¢˜æ‰€ä»¥ä¹Ÿæ²¡æ›´æ–°. æœ€è¿‘æ”¾å‡åœ¨å®¶æ‘†çƒ‚æ‘¸é±¼, åˆ· b ç«™çœ‹åˆ°æŸä½ä¸»æ’­ vp ä»Šå¹´ NOI, å‘ç°è¿˜æœ‰è¿™ç§é­”æ€”æ•°æ•°é¢˜, å°±æ¥åšç€ç©ç©. è®­ AtCoder å–æ¨¡è®¡æ•°é¢˜çš„äººä¼šæœ‰å¥½æŠ¥çš„. ğŸ˜Š

ç»™å®šæ­£æ•´æ•° $n$ å’Œåºåˆ— $a_0,\ldots,a_{2^n-1}\in\mathbb F_p$, å¯¹ $S\subseteq [0,2^n)\cap\mathbb Z$ å®šä¹‰ $\mathrm{And}(S)$ æ˜¯ $S$ ä¸­æ‰€æœ‰æ•°çš„æŒ‰ä½ä¸, è¦æ±‚:
$$\sum_{S,T\subseteq[0,2^n)}\mathbf 1\{S\cap T=\varnothing\}\cdot\mathbf 1\{\mathrm{And}(S)=\mathrm{And}(T)\}\prod_{i\in S\cup T}a_i.$$
æ•°æ®èŒƒå›´: $n\le 20$ ä¸” $p=998\,244\,353$, å…¶ä¸­éƒ¨åˆ†æµ‹è¯•ç‚¹æ»¡è¶³ $a_i\ne -1$.

è€ƒè™‘å¯¹ $\mathbf 1\{\mathrm{And}(S)=\mathrm{And}(T)\}$ å®¹æ–¥: æšä¸¾ $x,y\in[0,2^n)$, è®¾ $S_x$ è¡¨ç¤ºåŒ…å« $x$ çš„æ•°çš„é›†åˆ, æ¡ä»¶ $x\subseteq\mathrm{And}(S)$ ä¸” $y\subseteq\mathrm{And}(T)$ ç­‰ä»·äº $S\subseteq S_x$ ä¸” $T\subseteq S_y$, åˆå› ä¸º
$$\mathbf 1\{\mathrm{And}(S)=\mathrm{And}(T)\}=\sum_{x\subseteq\mathrm{And}(S)}\sum_{y\subseteq\mathrm{And}(T)}(-1)^{\mathrm{pc}(x)+\mathrm{pc}(y)}\cdot 2^{\mathrm{pc}(x\&y)},$$
ä»£å›åŸå¼å³å¾—å®¹æ–¥ç³»æ•°æ˜¯ $(-1)^{\mathrm{pc}(x)+\mathrm{pc}(y)}\cdot 2^{\mathrm{pc}(x\&y)}$, è´¡çŒ®æ˜¯ $\sum_{S\subseteq S_x}\sum_{T\subseteq S_y}\mathbf 1\{S\cap T=\varnothing\}\prod_{i\in S\cup T}a_i$.

> è¿™é‡Œ $\mathrm{pc}(x)$ è¡¨ç¤º $x$ çš„äºŒè¿›åˆ¶è¡¨ç¤ºä¸­ 1 çš„æ•°é‡. å®¹æ–¥ç³»æ•°æ€ä¹ˆç®—çš„? å°†æ¡ä»¶è¡¨ç¤ºä¸ºæ¯ä¸ªäºŒè¿›åˆ¶ä½çš„ "ç›¸ç­‰" æ¡ä»¶ç›¸ä¹˜, æƒå€¼ $((1,0),(0,1))$ ä½œå·®åˆ†å¾—åˆ° $((1,-1),(-1,2))$, æŒ‰åˆ†é…å¾‹å…¨éƒ¨å±•å¼€å°±å¥½å•¦.

è´¡çŒ®å¼é‡Œæ¯ä¸ªå…ƒç´ çš„æ–¹æ¡ˆç‹¬ç«‹: $S_x\cap S_y=S_{x|y}$ çš„å…ƒç´ å¯ä»¥æ”¾å…¥ $S$ æˆ– $T$ æˆ–ä¸æ”¾, æ–¹æ¡ˆæ•°ä¸º $1+2a_i$; å…¶ä»– $(S_x\cup S_y)\setminus S_{x|y}$ çš„å…ƒç´ åˆ™æ˜¯ $1+a_i$.

åˆå› ä¸º $\mathrm{pc}(x|y)=\mathrm{pc}(x)+\mathrm{pc}(y)-\mathrm{pc}(x\&y)$, æˆ‘ä»¬å°†å…¶åŒ–ä¸º OR å·ç§¯çš„å½¢å¼: è®¾ $s_x:=\prod_{i\supseteq x}(1+a_i)$, $t_x:=\prod_{i\supseteq x}\frac{1+2a_i}{(1+a_i)^2}$, ç­”æ¡ˆæ˜¯ $(-2)^{\mathrm{pc}(x)}s_x$ å·ç§¯è‡ªå·±, é€é¡¹ä¹˜ä¸Š $2^{-\mathrm{pc}(x)}t_x$ å†æ±‚å’Œ.

å¦‚æœæœ‰ $a_i=-1$ å’‹åŠå‘¢? æˆ‘ä»¬è¦æŠŠ $s_x$ å’Œ $s_y$ ä¸­å±äº $t_{x|y}$ çš„ 0 å› å­å‰”é™¤. è€ƒè™‘ FMT çš„è¿‡ç¨‹, ä»€ä¹ˆæƒ…å†µä¸‹ $s_xs_y$ çš„å·ç§¯é¡¹ä¼šè´¡çŒ®åˆ° $z$ çš„ä½ç½®? åªæœ‰ $z$ åŒ…å« $x$ å’Œ $y$ çš„æƒ…å†µ. æ­¤æ—¶ $t_z$ çš„åˆ†æ¯å¿…å®šæ•´é™¤ $s_xs_y$, å³æ±‚å’Œçš„æ¯ä¸€é¡¹éƒ½è¢« $t_z$ çš„åˆ†æ¯æ•´é™¤. æ‰€ä»¥åªéœ€è¦ç»´æŠ¤ 0 æ¬¡æ•°æœ€ä½çš„ä¸€é¡¹, å°±ç®—æœ‰ $a+(-a)$ ç›¸æ¶ˆä¹Ÿä¸ç”¨å…³å¿ƒæ›´é«˜æ¬¡é¡¹çš„ç³»æ•°, è‚¯å®šæ˜¯ç”¨ä¸åˆ°çš„.

éšä¾¿çœ‹äº†ä¸€ä¸‹å…¶ä»–é¢˜è§£, æ„Ÿè§‰è¿™éƒ¨åˆ†è®²å¾—æ¯”è¾ƒæ¨¡ç³Š, æ‰€ä»¥åœ¨è¿™é‡Œä¹Ÿä¼ äº†ä¸€ä»½.

æ€»ç»“ä¸€ä¸‹, ç”¨åç¼€å’Œ/ç§¯è®¡ç®— $s_x$ å’Œ $t_x$ çš„ 0 æ¬¡æ•°å’Œç³»æ•°, å†è·‘ä¸€ä¸ª OR å·ç§¯å°±å®Œæˆäº†, æ—¶é—´å¤æ‚åº¦ $O(n2^n)$.

```cpp
#include <bits/stdc++.h>
#define fi first
#define se second
#define pc __builtin_popcount
typedef std::pair<int, int> PII; // coefficient and degree of 0
typedef long long LL;

const int mod = 998244353;
int qmo(int x) { return x + (x >> 31 & mod); }
int ksm(int a, int b) {
  int res = 1;
  for (; b; b >>= 1, a = (LL)a * a % mod)
    if (b & 1) res = (LL)res * a % mod;
  return res;
}

PII operator + (const PII &a, const PII &b) {
  if (a.se == b.se) return PII(qmo(a.fi + b.fi - mod), a.se);
  return a.se < b.se ? a : b;
}
PII operator += (PII &a, const PII &b) { a = a + b; return a; }

PII operator - (const PII &a) { return PII(qmo(-a.fi), a.se); }
PII operator - (const PII &a, const PII &b) { return a + (-b); }
PII operator -= (PII &a, const PII &b) { a = a - b; return a; }

PII operator * (const PII &a, int b) {
  if (b == 0) return PII(a.fi, a.se + 1);
  return PII((LL)a.fi * b % mod, a.se);
}
PII operator *= (PII &a, int b) { a = a * b; return a; }

PII operator * (const PII &a, const PII &b) {
  return PII((LL)a.fi * b.fi % mod, a.se + b.se);
}
PII operator *= (PII &a, const PII &b) { a = a * b; return a; }

void solve() {
  int n; std::cin >> n;
  std::vector<int> pwn2(n+1), pwi2(n+1); // power of -2 and 1/2
  pwn2[0] = pwi2[0] = 1;
  for (int i = 1; i <= n; ++i) {
    pwn2[i] = pwn2[i-1] * (mod - 2ll) % mod;
    pwi2[i] = (pwi2[i-1] + (pwi2[i-1] & 1) * mod) / 2;
  }

  int N = 1 << n; std::vector<PII> s(N), t(N);
  for (int i = 0, x; i < N; ++i) {
    std::cin >> x;
    if (x == mod - 1) {
      s[i] = PII(1, 1);
      t[i] = PII(mod - 1, -2);
    } else {
      s[i] = PII(1 + x, 0);
      t[i] = PII((1 + 2ll * x) * ksm(1 + x, mod - 3) % mod, 0);
    }
  }

  for (int i = 0; i < n; ++i)
    for (int j = 0; j < N; ++j)
      if (!(j & (1 << i))) {
        s[j] *= s[j ^ (1 << i)];
        t[j] *= t[j ^ (1 << i)];
      }

  for (int i = 0; i < N; ++i) {
    s[i] *= pwn2[pc(i)];
    t[i] *= pwi2[pc(i)];
  }

  for (int i = 0; i < n; ++i)
    for (int j = 0; j < N; ++j)
      if (j & (1 << i)) s[j] += s[j ^ (1 << i)];
  for (int i = 0; i < N; ++i) s[i] *= s[i];
  for (int i = 0; i < n; ++i)
    for (int j = 0; j < N; ++j)
      if (j & (1 << i)) s[j] -= s[j ^ (1 << i)];

  int ans = 0;
  for (int i = 0; i < N; ++i) {
    PII cur = s[i] * t[i]; assert(cur.se >= 0);
    if (cur.se == 0) ans = qmo(ans + cur.fi - mod);
  }
  printf("%d\n", ans);
}

int main() {
  int _, t;
  std::ios::sync_with_stdio(false);
  std::cin >> _ >> t;
  while (t --) { solve(); }
}
```

---

## ä½œè€…ï¼šmasterhuang (èµï¼š6)

**NOI 2025 æŠ˜æˆŸæ²‰æ²™ï¼**

ç»™å®š $n,a_0,a_1,\cdots,a_{2^n-1}$ï¼Œå®šä¹‰æ•°çš„ $\sube$ è¡¨ç¤ºäºŒè¿›åˆ¶å±äºï¼Œé›†åˆçš„å±äºè®°å·ä¿æŒåŸæ„ã€‚

å®šä¹‰å…¨é›† $U=\{0,1,\cdots,2^n-1\},\forall S\sube U$ å®šä¹‰ $f(S)=\mathop{\text{AND}}\limits_{x\in S}\,x$ï¼Œç‰¹åˆ«çš„ $f(\varnothing)=2^n-1$â€‹ã€‚

å®šä¹‰ $\pi(S)=\prod\limits_{x\in S}a_x,\pi(\varnothing)=1$ã€‚

$$
ans=\sum\limits_{S,T\sube U,S\cap T=\varnothing}[f(S)=f(T)]\pi(S\cup T)
$$

å¯¹ $p=998244353$ å–æ¨¡ï¼Œ$2\le n\le 20,a_i\in [0,p)$ã€‚

**éƒ¨åˆ†åˆ†**ï¼šä¿è¯ $a_i\ne p-1$ã€‚

---

**æœ¬é¢˜åšæ³•æ¥è‡ªå›½å®¶é›†è®­é˜Ÿ rk.9 hhoppitreeï¼Œå¤ªå¤§ç¥ï¼**

æ€è€ƒï¼šè€ƒè™‘ $f$ çš„ç›¸ç­‰è‚¯å®šæ˜¯æ— æ³•åˆ»ç”»çš„ï¼Œæˆ‘ä»¬å®¹æ˜“åˆ»ç”»çš„æ˜¯ $x\sube f(S)\Leftrightarrow S\sube S_x$ï¼Œå…¶ä¸­è¶…é›† $S_x=\{y:x\sube y\}$ã€‚

äºæ˜¯æœ‰ç»å…¸å®¹æ–¥ï¼š$[P=Q]=\sum\limits_{A\sube P,B\sube Q} (-1)^{|A|+|B|}2^{|A\cap B|}$ã€‚

å¸¦å…¥ï¼š

$$
ans=\sum_{A,B}(-1)^{|A|+|B|}2^{|A\cap B|}\sum\limits_{S\sube S_A,T\sube S_B} [S\cap T=\varnothing]\pi(S\cup T)
$$

æšä¸¾ $C=A\cap B$ï¼š

$$
ans=\sum_{A,B,C\ ä¸¤ä¸¤ä¸äº¤}(-1)^{|A|+|B|}2^{|C|}\sum\limits_{S\sube S_{A\cup C},T\sube S_{B\cup C}} [S\cap T=\varnothing]\pi(S\cup T)
$$

å¤„ç† $\sum\limits_{S\sube S_{A\cup C},T\sube S_{B\cup C}} [S\cap T=\varnothing]\pi(S\cup T)$ è¿™ä¸ªä¸œè¥¿çš„å¸¸è§æ‰‹æ®µæ˜¯ï¼š

å¯¹ $S_{A\cup C}\cup S_{B\cup C}$ ä¸­çš„æ¯ä¸ªå…ƒç´ å•ç‹¬è€ƒè™‘æ”¾åœ¨ $S$ è¿˜æ˜¯ $T$ è¿˜æ˜¯ä¸¢å¼ƒã€‚

å®šä¹‰ $L=A\cup B\cup C,D=S_{A\cup C}-S_L,E=S_{B\cup C}-S_L$ã€‚

- $i\in L$ èƒ½æ”¾åœ¨ $S,T$ æˆ–ä¸æ”¾

- $i\in D$ èƒ½æ”¾åœ¨ $S$ æˆ–ä¸æ”¾

- $i\in E$ èƒ½æ”¾åœ¨ $T$ æˆ–ä¸æ”¾

äºæ˜¯è¿™éƒ¨åˆ†ç­”æ¡ˆä¸ºï¼š

$$
\begin{aligned}\prod\limits_{i\in D}(1+a_i)\prod\limits_{i\in E}(1+a_i)\prod\limits_{i\in L}(1+2a_i)&=\prod\limits_{i\in S_{A\cup C}}(1+a_i)\prod\limits_{i\in S_{B\cup C}}(1+a_i)\prod\limits_{i\in S_L}\dfrac{1+2a_i}{(1+a_i)^2}\\&=f(A\cup C)f(B\cup C)g(A\cup B\cup C)\end{aligned}
$$

---

$$
ans=\sum_{A,B,C\ ä¸¤ä¸¤ä¸äº¤}(-1)^{|A|+|B|}2^{|C|}f(A\cup C)f(B\cup C)g(A\cup B\cup C)
$$

åšç‚¹å°å˜æ¢ $(-1)^{|A|+|B|}=(-1)^{|A\cup C|}\cdot(-1)^{|B\cup C|},2^{|C|}=2^{|A\cup C|+|B\cup C|-|A\cup B\cup C|}$ åæœ‰ï¼š

$$
ans=\sum_{A,B,C\ ä¸¤ä¸¤ä¸äº¤}f(A\cup C)f(B\cup C)g(A\cup B\cup C)
\\
f(A)=(-2)^{|A|}\prod\limits_{x\in S_A}(1+a_x)
\\
g(A)=2^{-|A|}\prod\limits_{x\in S_A}\dfrac{1+2a_x}{(1+a_x)^2}
$$

æ³¨æ„åˆ° $A\cup B\cup C=(A\cup C)\cup (B\cup C)$ï¼Œå°±æ˜¯ä¸€ä¸ª**æˆ–å·ç§¯**çš„å½¢å¼ï¼Œæœ‰ï¼š

$$
ans=\sum\limits_{R}g(R)\sum\limits_{P\mid Q=R}f(P)f(Q)
$$

è‹¥æ²¡æœ‰ $a_i=p-1$ åˆ™ $f,g$ ç›´æ¥é¢„å¤„ç†ï¼Œå¤æ‚åº¦ $\mathcal{O}(n2^n)$ã€‚

---

è‹¥å­˜åœ¨ $a_i=p-1$ï¼Œæˆ‘ä»¬å¦‚ä¸‹å˜æ¢ï¼š$(1+a_i)\to x,\dfrac{1+2a_i}{(1+a_i)^2}\to\dfrac{2x-1}{x^2}$ï¼Œå…¶ä¸­ $x \to 0$ã€‚

æ³¨æ„åˆ°ç»å…¸ç»“è®ºï¼Œ$\lim\limits_{x\to 0}\frac{f(x)}{g(x)}$ æ˜¯ä¸¤ä¸ªå¤šé¡¹å¼æœ€ä½æ¬¡é¡¹çš„æ¯”å€¼ã€‚

äºæ˜¯æˆ‘ä»¬åœ¨**æˆ–å·ç§¯**çš„æ—¶å€™é¡ºä¾¿è®°å½• $x$ é¡¹é€ æˆçš„å¤šé¡¹å¼åˆ†æ•°çš„æœ€ä½æ¬¡é¡¹ï¼Œåˆå¹¶ç›´æ¥åˆå¹¶å³å¯ã€‚

ç”±äºåªéœ€è¦æœ€ä½æ¬¡ï¼Œåˆå¹¶æ˜¯ $\mathcal{O}(1)$ çš„ï¼Œå¤æ‚åº¦ $\mathcal{O}(n2^n)$ã€‚

**ä»£ç å¾ˆçŸ­ã€‚**

```cpp
// æ´›è°· P13275
// https://www.luogu.com.cn/problem/P13275
#include<bits/stdc++.h>
#define LL long long
#define P pair<int,int>
#define fi first
#define se second
#define pc __builtin_popcount
#define fr(x) freopen(#x".in","r",stdin);freopen(#x".out","w",stdout);
using namespace std;
inline int rd()
{
	int x=0;char c=getchar();
	for(;c<'0'||c>'9';c=getchar());
	for(;c>='0'&&c<='9';c=getchar()) x=x*10+c-'0';
	return x;
}
const int N=1<<20|5,mod=998244353,I2=(mod+1)>>1,_2=mod-2;
int C,n,m,a[N],p[23],q[23],ans;P f[N],g[N];
inline void ad(int &x,int y){x+=y;(x>=mod)&&(x-=mod);}
inline int ksm(int x,int p=mod-2){int s=1;for(;p;(p&1)&&(s=1ll*s*x%mod),x=1ll*x*x%mod,p>>=1);return s;}
inline P R(P A){return {A.fi,mod-A.se};}
inline void operator+=(P &A,P B){
	if(A>B) swap(A,B);
	if(A.fi==B.fi) ad(A.se,B.se);
}
inline void operator*=(P &A,P B){A={A.fi+B.fi,1ll*A.se*B.se%mod};}
inline void operator*=(P &A,int t){A={A.fi,1ll*A.se*t%mod};}
int main()
{
	C=rd(),C=rd();
	for(int i=*p=*q=1;i<=20;i++) p[i]=1ll*I2*p[i-1]%mod,q[i]=1ll*_2*q[i-1]%mod;
	while(C--)
	{
		n=rd();m=1<<n;ans=0;
		for(int i=0;i<m;i++) a[i]=rd();
		for(int i=0,x;i<m;i++)
		{
			if(a[i]==mod-1) f[i]={1,1},g[i]={-2,mod-1};
			else f[i]={0,x=1+a[i]},x=ksm(x),g[i]={0,(1+2ll*a[i])*x%mod*x%mod};
		}
		for(int i=0;i<n;i++) for(int j=0;j<m;j++) if(j>>i&1)
			f[j^(1<<i)]*=f[j],g[j^(1<<i)]*=g[j];
		for(int i=0;i<m;i++) f[i]*=q[pc(i)],g[i]*=p[pc(i)];
		for(int i=0;i<n;i++) for(int j=0;j<m;j++)
			if(j>>i&1) f[j]+=f[j^(1<<i)];
		for(int i=0;i<m;i++) f[i]*=f[i];
		for(int i=0;i<n;i++) for(int j=0;j<m;j++)
			if(j>>i&1) f[j]+=R(f[j^(1<<i)]);
		for(int i=0;i<m;i++)
		{
			f[i]*=g[i];
			if(!f[i].fi) ad(ans,f[i].se);
		}
		cout<<ans<<"\n";
	}
	return 0;
}
```

---

## ä½œè€…ï¼šdiqiuyi (èµï¼š6)

åœºåˆ‡äº†ï¼Œçºªå¿µä¸€ä¸‹ã€‚

è®¾ $f_{x,y}=\sum_{x\subseteq S,y\subseteq T,S\cap T=\empty} g_{s,t}$ã€‚å®¹æ–¥ä¸€ä¸‹å‘ç°ç­”æ¡ˆæ˜¯ $\sum_{x,y}f_{x,y}(-1)^{\operatorname{popcnt}(x)+\operatorname{popcnt}(y)}2^{\operatorname{popcnt}(x\cap y)}$ã€‚

è€ƒè™‘ç‰¹æ®Šæ€§è´¨ Bï¼Œè®° $b_x$ è¡¨ç¤º $\prod_{x\subseteq i} (a_i+1)$ï¼Œ$c_x=\prod_{x\subseteq i} (2a_i+1)$ï¼Œé‚£ä¹ˆ $f_{x,y}=b_xb_yc_{x\cup y}/b_{x\cup y}^2$ã€‚è¿™æ ·å¯ä»¥ç®€å• $O(4^n)$ã€‚

ä½†æ˜¯æ³¨æ„åˆ° $\operatorname{popcnt}(x\cap y)=\operatorname{popcnt}(x)+\operatorname{popcnt}(y)-\operatorname{popcnt}(x\cup y)$ï¼Œæ‰€ä»¥å¯ä»¥æšä¸¾ $x\cup y$ï¼Œç„¶ååªè¦å¯¹æ¯ä¸ª $S$ æ±‚å‡º $\sum_{x\cup y=S} (-2)^{\operatorname{popcnt}(x)}b_x(-2)^{\operatorname{popcnt}(y)}b_y$ï¼Œè¿™ä¸ªä¸œè¥¿åªéœ€è¦å…ˆæ±‚å‡º $(\sum_{x\subseteq S} (-2)^{\operatorname{popcnt}(x)}b_x)^2$ å†é«˜ç»´å·®åˆ†ä¸€ä¸‹å³å¯ã€‚$O(2^nn)$ï¼Œ52ptsã€‚

ç„¶åè€ƒè™‘æ²¡æœ‰ B æ€§è´¨æ€ä¹ˆåšã€‚è®° $cnt_x=\sum_{x\subseteq i}[a_i=-1]$ï¼Œåªæœ‰ $cnt_x=cnt_S$ çš„ $x$ å¯ä»¥å¯¹ $S$ äº§ç”Ÿè´¡çŒ®ã€‚é‚£ä¹ˆæˆ‘ä»¬æŠŠ $b_x$ çš„å®šä¹‰æ”¹æˆ $\prod_{x\subseteq i} [a_i\neq-1](a_i+1)$ï¼Œç„¶åå‰ç¼€å’Œä»¥åŠå·®åˆ†çš„æ—¶å€™åªæ›´æ–° $cnt$ ç›¸åŒçš„é‚£äº›å°±å¯¹äº†ã€‚æ—¶é—´å¤æ‚åº¦ä¸º $O(2^nn)$ã€‚

ä»£ç æ²¡æœ‰ã€‚

---

## ä½œè€…ï¼šErine (èµï¼š5)

å»ä¸äº† NOI é€‰æ‰‹ã€‚

çœ‹ä¸æ‡‚ B æ€§è´¨å’‹åŠï¼Œé‚£å¾—æ¨å¼å­æ‰çŸ¥é“ã€‚æšä¸¾ $f(P)=f(Q)=S$ï¼Œå¹¶å®¹æ–¥é’¦å®šå…¶æ»¡è¶³æ¡ä»¶ã€‚å³

$$\sum_{S}\sum_{S\subseteq T_1}\sum_{S\subseteq T_2}(-1)^{|T1|-|S|}(-1)^{|T2|-|S|}\prod_{P}(1+a_P[T_1\subseteq P]+a_P[T_2\subseteq P])$$

è¿›è¡Œä¸€ä¸ªå¼å­çš„æ¨ã€‚ä¸å¦¨æšä¸¾ $T1\cup T2=T$ï¼Œå³

$$
\begin{aligned}
&\sum_{S}\sum_{S\subseteq T}\sum_{S\subseteq T_1}\sum_{S\subseteq T_2}(-1)^{|T1|+|T2|}\prod_{T_1\subseteq P}(1+a_P)\prod_{T_2\subseteq P}(1+a_P)\prod_{T\subseteq P} \dfrac{(1+2a_P)}{(1+a_P)^2}\left[T_1\cup T_2=T\right] \\
=&\sum_{S}\sum_{S\subseteq T}\prod_{T\subseteq P} \dfrac{(1+2a_P)}{(1+a_P)^2}\sum_{S\subseteq T_1}\sum_{S\subseteq T_2}(-1)^{|T1|+|T2|}\prod_{T_1\subseteq P}(1+a_P)\prod_{T_2\subseteq P}(1+a_P)\left[T_1\cup T_2=T\right]
\end{aligned}
$$

ç„¶åè¿™ä¸ªæ—¶å€™å°±åˆè§ç«¯å€ªï¼Œå› ä¸ºåˆ†æ¯ä¸Šå‡ºç°äº† $a+1$ï¼Œè¿™ä¸‹çœ‹æ‡‚äº†.pngã€‚ä¸æ€¥ï¼Œæˆ‘ä»¬å…ˆåš B æ€§è´¨ã€‚ä¸å¦¨è®¾ $w_S=(-1)^{|S|}\prod_{S\subseteq T}(1+a_T)$ï¼Œè¿™ä¸ªå¯ä»¥é«˜ç»´åç¼€ç§¯åšå‡ºæ¥ã€‚

$$
\begin{aligned}
=&\sum_{S}\sum_{S\subseteq T}\prod_{T\subseteq P} \dfrac{(1+2a_P)}{(1+a_P)^2}\sum_{S\subseteq T_1}\sum_{S\subseteq T_2}w_{T_1}w_{T_2}\left[T_1\cup T_2=T\right]
\end{aligned}
$$

ç„¶åè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å·²ç»æ„‰å¿«åœ°åšåˆ°äº† $\Theta(3^nn)$ï¼Œä¸è¿‡ç»™çš„åˆ†éå¸¸å°‘ï¼Œå› ä¸ºè¿˜ä¾èµ– B æ€§è´¨ã€‚è€ƒè™‘äº¤æ¢ $S,T$ æ±‚å’Œé¡ºåºã€‚

$$
\begin{aligned}
=&\sum_{T}\prod_{T\subseteq P} \dfrac{(1+2a_P)}{(1+a_P)^2}\sum_{S\subseteq T}\sum_{S\subseteq T_1}\sum_{S\subseteq T_2}w_{T_1}w_{T_2}\left[T_1\cup T_2=T\right]
\end{aligned}
$$

è€ƒå¯Ÿä»»æ„ä¸€å¯¹ $T_1,T_2$ ä¼šå¯¹ä»€ä¹ˆäº§ç”Ÿè´¡çŒ®ã€‚å¾ˆæ˜¾ç„¶å®ƒä¼šå¯¹ $2^{|T_1\cap T_2|}$ ä¸ª $S$ äº§ç”Ÿè´¡çŒ®ã€‚æ‰€ä»¥æ²¡æœ‰å¿…è¦æšä¸¾ $S$ã€‚

$$
\begin{aligned}
=&\sum_{T}\prod_{T\subseteq P} \dfrac{(1+2a_P)}{(1+a_P)^2}\sum_{T_1}\sum_{T_2}w_{T_1}w_{T_2}2^{|T_1\cap T_2|}\left[T_1\cup T_2=T\right]
\end{aligned}
$$

ç„¶è€Œå¾ˆå¤©æ‰çš„äº‹æƒ…æ˜¯ $|T_1\cap T_2|+|T_1\cup T_2|=|T_1|+|T_2|$ï¼Œæ‰€ä»¥æˆ‘ä»¬å‘ç° $|T_1\cap T_2|=|T_1|+|T_2|-|T_1\cup T_2|=|T_1|+|T_2|-|T|$ã€‚äºæ˜¯

$$
\begin{aligned}
=&\sum_{T}\prod_{T\subseteq P} \dfrac{(1+2a_P)}{(1+a_P)^2}\sum_{T_1}\sum_{T_2}w_{T_1}w_{T_2}2^{|T_1|+|T_2|-|T|}\left[T_1\cup T_2=T\right] \\
=&\sum_{T}2^{-|T|}\left(\prod_{T\subseteq P} \dfrac{(1+2a_P)}{(1+a_P)^2}\right)\left(\sum_{T_1}\sum_{T_2}w_{T_1}2^{|T_1|}w_{T_2}2^{|T_2|}\left[T_1\cup T_2=T\right]\right)
\end{aligned}
$$

å¯¹ï¼Œä½†æ˜¯ç°åœ¨æˆ‘ä»¬å‘ç°ååŠéƒ¨åˆ†æ˜¯æ²¡æœ‰ä»»ä½•é™åˆ¶çš„æˆ–è¿ç®—å·ç§¯ï¼Œå¯ä»¥ $\Theta(n2^n)$ åšä¸€ä¸‹ã€‚å‰åŠéƒ¨åˆ†ä¹Ÿæ˜¯é«˜ç»´åç¼€ç§¯ã€‚æ‰€ä»¥ç°åœ¨æ•´ä¸ª B æ€§è´¨å…¨éƒ¨å¯ä»¥é€šè¿‡ï¼Œæ‹¼ä¸Šæš´åŠ›å¯ä»¥è·å¾— $56\sim 68$ åˆ†ã€‚

é‚£å’‹åŠã€‚æ„Ÿè§‰ä¸Šä½ è¦åšåˆ°è¿™ä¸ªé¿å…é™¤ä»¥ $0$ çš„å”¯ä¸€æ–¹æ³•å°±æ˜¯è®°æœ‰å‡ ä¸ª $0$ åœ¨å› å­é‡Œï¼šæ¢ç§è¯´æ³•ï¼Œæˆ‘è¦è¡¨è¾¾çš„æ„æ€æ˜¯ï¼ŒæŠŠ $0$ çœ‹åšä¸€ä¸ªå…ƒ $x$ è¿™æ ·ã€‚ç„¶åæˆ‘ä»¬è¦åšçš„å°±æ˜¯æ±‚ä¸€ä¸ª $\lim\limits_{x\to 0} \dfrac{F(x)}{G(x)}$ã€‚å› ä¸º $G$ æ­¤æ—¶æ˜¯ä¸€ä¸ªå•é¡¹å¼ï¼Œä¸å¦¨è€ƒæŸ¥ $F(x)$ çš„æœ€ä½æ¬¡é¡¹ã€‚å¦‚æœ $F$ çš„æœ€ä½æ¬¡é¡¹ $> G$ çš„ï¼Œåˆ™ç­”æ¡ˆä¸º $0$ï¼›å¦åˆ™ç­”æ¡ˆä¸º $F$ ä¸ $G$ æœ€ä½æ¬¡é¡¹ç³»æ•°çš„æ¯”ã€‚

æˆ‘ä»¬å¯ä»¥è¯æ˜ $F$ çš„æœ€ä½æ¬¡é¡¹ä¸ä¼š $<G$ å³æé™æ— æ„ä¹‰ï¼Œå› ä¸º $w_T$ çš„æ¬¡æ•°åœ¨æ¯ä¸€ç»´ä¸Šéƒ½æ˜¯ä¸å¢çš„ï¼Œæ‰€ä»¥å– $T_1=T_2=T$ æ—¶å¸¦æ¥çš„æ¬¡æ•°æœ€å°ï¼Œå‘ç°æ­¤æ—¶å…¶æ¬¡æ•°ä¹Ÿå·²ç» $=\deg G$ã€‚

æ‰€ä»¥å¯¹åšæ³•è¿›è¡Œæ”¹ç¼–ï¼šæˆ‘ä»¬ç»´æŠ¤æ¯ä¸ªç‚¹çš„æœ€ä½æ¬¡é¡¹æ¬¡æ•°ï¼ŒFMT æ—¶æ˜¯æå¥½åˆå¹¶çš„ã€‚

å¤æ‚åº¦ $\Theta(n2^n)$ï¼Œå¯ä»¥é€šè¿‡ã€‚

```cpp
void solve() {
	n = read(), U = (1 << n) - 1;
	ipw[0] = 1; rep(i, 1, n) ipw[i] = ipw[i - 1] * inv2 % mod;
	rep(i, 0, (1 << n) - 1) a[i] = read();
	rep(i, 0, (1 << n) - 1) {
		g[i] = (a[i] * 2 + 1) % mod;
		if (a[i] == mod - 1) f[i] = {1, 1};
		else f[i] = {(a[i] + 1) % mod, 0};
	}
	rep(i, 0, n - 1) per(S, (1 << n) - 1, 0) if (!(S >> i & 1)) f[S] = f[S] * f[S ^ (1 << i)];
	rep(i, 0, n - 1) per(S, (1 << n) - 1, 0) if (!(S >> i & 1)) g[S] = g[S] * g[S ^ (1 << i)] % mod;
	rep(i, 0, (1 << n) - 1) b[i] = (__builtin_popcount(i) & 1 ? mod - 1 : 1) * (1 << __builtin_popcount(i)) % mod * f[i];
	rep(i, 0, n - 1) rep(S, 0, (1 << n) - 1) if (S >> i & 1) b[S] += b[S ^ (1 << i)];
	rep(S, 0, (1 << n) - 1) b[S] = b[S] * b[S];
	per(i, n - 1, 0) per(S, (1 << n) - 1, 0) if (S >> i & 1) b[S] -= b[S ^ (1 << i)];
	int ans = 0;
	rep(S, 0, (1 << n) - 1) ans += b[S].fs * power(f[S].fs * f[S].fs % mod, mod - 2) % mod * g[S] % mod * ipw[__builtin_popcount(S)] % mod;
	write(ans % mod), pc('\n');
}
```

---

## ä½œè€…ï¼šxuanxuan001 (èµï¼š5)

æ˜æ˜å‡ºåˆ°æˆ‘æ“…é•¿çš„ç‚¹äº†ï¼Œæ˜æ˜æœ‰æœºä¼šçš„ï¼Œä½†è¿˜æ˜¯æ²¡æŠ“ä½ï¼Œåªèƒ½ XCPC å†è§äº†ã€‚

#define æŒ‰ä½ é’¦å®š

è¿™é¢˜æœ‰ä¸¤ä¸ªä¸»è¦çš„é™åˆ¶ï¼Œä¸€ä¸ªæ˜¯ $f(P) = f(Q)$ï¼Œä¸€ä¸ªæ˜¯ $P \cap Q = \emptyset$ï¼Œè¿™ç§ä¸œè¥¿æ˜¾ç„¶è¦å®¹æ–¥ï¼Œè€ƒè™‘å®¹æ–¥å“ªä¸ªæ¡ä»¶ã€‚

$P \cap Q = \emptyset$ è¿™ä¸ªä¸œè¥¿çœ‹ä¼¼æšä¸¾äº¤é›†çš„å­é›†è¿›è¡Œå®¹æ–¥å¾ˆå¥½æï¼Œä½†ä½ ä¼šå‘ç°è¿™ç©æ„æœ‰ $2^n$ ä¸ªå…ƒç´ ï¼ŒçŠ¶æ€æ•°é«˜è¾¾ $2^{2^n}$ï¼Œæ‰€ä»¥å¯¹ç€è¿™ç©æ„å®¹æ–¥æ˜¾ç„¶å¹¶ä¸æ˜æ™ºï¼Œå› æ­¤è€ƒè™‘å‰ä¸€ä¸ªã€‚

é‚£ä¹ˆæƒ³æƒ³ $f(P) \ne f(Q)$ æ„å‘³ç€ä»€ä¹ˆï¼Œæ˜¯ä¸æ˜¯è¯´å­˜åœ¨ä¸€ä¸ªå…ƒç´  $x$ï¼Œä½¿å¾— $x \in P \vee x \notin Q$ æˆ–è€…åä¹‹ï¼Œé‚£ä¹ˆå¤§èƒ†åœ°è€ƒè™‘ä¸€ä¸ªæä¸ºå¤æ‚çš„å®¹æ–¥ï¼šç›´æ¥æšä¸¾ä¸¤ä¸ªä¸äº¤é›†åˆ $X,T$ï¼Œå¹¶æŒ‰ä½ $X \subseteq f(P),X \cap f(Q) = \emptyset,Y \cap f(P) = \emptyset,Y \subseteq f(Q)$ï¼Œé‚£ä¹ˆå®¹æ–¥ç³»æ•°ä¸º $(-1)^{|X| + |Y|}$ã€‚

å‘ç° $X \subseteq f(P)$ è¿™ç§æ¡ä»¶æ˜¯å®¹æ˜“çš„ï¼Œå®ƒç­‰ä»·äºæŒ‰ä½äº† $P$ ä¸­çš„æ‰€æœ‰å…ƒç´ éƒ½åœ¨äºŒè¿›åˆ¶ä½ä¸ŠåŒ…å« $S$ï¼Œä½† $X \cap f(Q) = \emptyset$ è¿™ç§å¹¶ä¸å®¹æ˜“ï¼Œå› æ­¤è€ƒè™‘è¿›ä¸€æ­¥å®¹æ–¥ï¼Œç»§ç»­æšä¸¾ $A \subseteq X,B \subseteq Y$ å¹¶æŒ‰ä½ $A \subseteq X \cap F(Q),B \subseteq Y \cap F(P)$ï¼Œæ²¡é”™ï¼Œå°±æ˜¯è¿™ä¹ˆç–¯ç‹‚ï¼Œç°åœ¨çš„å®¹æ–¥ç³»æ•°ä¸º $(-1)^{|X| + |Y| + |A| + |B|}$ã€‚

é‚£ä¹ˆä¸éš¾å‘ç°ç”±äºæšä¸¾ $A,B$ çš„æ—¶å€™å·²ç»æœ‰ $A \subseteq X,B \subseteq Y$ äº†ï¼Œæ‰€ä»¥å…¶å®åªéœ€è¦æŒ‰ä½ $A \subseteq F(Q),B \subseteq F(P)$ï¼Œé‚£ä¹ˆä¸å‰é¢æŒ‰ä½çš„ä¸œè¥¿åˆå¹¶ä¸€ä¸‹ï¼Œç°åœ¨çš„é™åˆ¶å°±æ˜¯ï¼š

$X \cup B \subseteq F(P),Y \cup A \subseteq F(Q)$

é‚£ä¹ˆè¿™ä¸ªé™åˆ¶æå…¶ä¼˜ç¾ï¼Œä»¤ $S = X \cup B,T = Y \cup A$ï¼Œè€ƒè™‘è¿™ä¸ªæ—¶å€™çš„æ–¹æ¡ˆæ•°æ€ä¹ˆæ±‚ï¼Œè€ƒè™‘å¯¹äºæ¯ä¸ªå…ƒç´  $x$ï¼š

- å¦‚æœæœ‰ $S \cup T \subseteq x$ï¼Œé‚£ä¹ˆ $x$ å¯ä»¥æ”¾åœ¨ $P$ ä¸­æˆ– $Q$ ä¸­æˆ–éƒ½ä¸æ”¾ï¼Œè´¡çŒ®ä¸º $2a_x + 1$ã€‚
- å¦åˆ™ï¼Œå¦‚æœæœ‰ $S \subseteq x$ï¼Œé‚£ä¹ˆ $x$ å¯ä»¥æ”¾åœ¨ $P$ ä¸­æˆ–éƒ½ä¸æ”¾ï¼Œè´¡çŒ®ä¸º $a_x + 1$ã€‚
- $T \subseteq x$ ç±»ä¼¼ï¼Œè´¡çŒ®ä¸º $a_x + 1$ã€‚
- å¦åˆ™ï¼Œæ²¡æœ‰è´¡çŒ®ã€‚

ä½¿ç”¨é«˜ç»´åç¼€ç§¯å¯ä»¥å®¹æ˜“å¯¹æ¯ä¸ªæ•° $R$ æ±‚å‡ºæ‰€æœ‰ $R \subseteq x$ çš„ $a_x + 1$ çš„ç§¯ã€‚è®¾ $A_R$ ä¸º $a_x + 1$ çš„ç§¯ï¼Œ$C_R$ ä¸º $2a_x + 1$ çš„ç§¯ã€‚é‚£ä¹ˆä¸éš¾å‘ç°å‰é¢çš„è®¨è®ºç¬¬ä¸€ç±»è´¡çŒ®å°±æ˜¯ $C_{S \cup T}$ï¼Œç¬¬äºŒç±»æ˜¯ $\dfrac {A_S}{A_{S \cup T}}$ï¼Œç¬¬ä¸‰ç±»æ˜¯ $\dfrac {A_S}{A_{S \cup T}}$ï¼Œä¹˜èµ·æ¥å°±æ˜¯ç­”æ¡ˆã€‚

å‘ç°æœ‰å¾ˆå¤š B æ€§è´¨ï¼ŒA æ€§è´¨ä¸€çœ‹å°±å’Œæ­£è§£æ²¡å•¥å…³ç³»ï¼Œæ‰€ä»¥è§£æ³•å¤§æ¦‚åˆ†æˆä¸¤éƒ¨åˆ†ï¼Œå…ˆåšå‡º B æ€§è´¨ï¼Œå†è€ƒè™‘ B æ€§è´¨æ€ä¹ˆæ¨å¹¿åˆ°æ­£è§£ã€‚

B æ€§è´¨å°±æ˜¯ $A$ æ•°ç»„é‡Œæ²¡æœ‰ $0$ï¼Œå› æ­¤å‰é¢çš„é™¤æ³•å¯ä»¥ç›´æ¥é€†å…ƒï¼Œä»¤ $B_R = \dfrac {C_R}{A_R^2}$ï¼Œå¹¶ç›´æ¥æšä¸¾ $S,T$ å†è€ƒè™‘ $X,Y,A,B$ çš„æ–¹æ¡ˆæ•°ï¼ˆå¥½åƒé‡åäº†ï¼Œä½†é›†åˆå’Œæ•°ç»„åº”è¯¥ä¸éš¾åŒºåˆ†ï¼‰ï¼Œé‚£ä¹ˆæœ‰ $A \cup B = S \cap T,A \cap B = \emptyset$ï¼Œç¡®å®šäº† $A,B$ ä¹‹ååº”è¯¥ä¸éš¾å”¯ä¸€ç¡®å®š $X,Y$ äº†ï¼Œä¸å†èµ˜è¿°ã€‚

å› æ­¤æœ€ç»ˆç­”æ¡ˆä¸º $\sum\limits_S \sum\limits_T A_SA_TB_{S \cup T}2^{|S \cap T|}(-1)^{|S| + |T|}$ï¼Œæœ€åä¸€ä¸ªå°±æ˜¯åˆ’åˆ† $S \cap T$ ä¸ºä¸¤ä¸ªé›†åˆ $A,B$ çš„æ–¹æ¡ˆæ•°ã€‚

ç„¶åå‘ç°åŒæ—¶éœ€è¦è€ƒè™‘äº¤çš„ä¿¡æ¯å’Œå¹¶çš„ä¿¡æ¯å¾ˆçƒ¦ï¼Œé‚£ä¹ˆè¿™ä¸ªäº¤çš„ä¿¡æ¯å¾ˆç‰¹æ®Šï¼Œå¯ä»¥è½¬æ¢æˆå¹¶ï¼ˆè¿™é‡Œç›´æ¥è®¤ä¸º $A_R$ ä¹˜ä¸Šäº† $(-1)^{|R|}$ï¼Œä¸‹åŒï¼‰ï¼š

$$
A_SA_TB_{S \cup T}2^{|S \cap T|}\\
=A_SA_TB_{S \cup T}2^{|S| + |T| - |S \cup T|}\\
=(2^{|S|}A_S)(2^{|T|}A_T)(2^{- |S \cup T|}B_{S \cup T})\\
$$

ä»¥è¿™ä¸¤ä¸ªä¹˜ä¸Šäº† $2$ çš„å¹‚æ¬¡çš„ä¸œè¥¿ä½œä¸ºæ–°çš„æ•°ç»„å³å¯ï¼Œå¯ä»¥å¯¹æ¯ä¸ª $x$ æ±‚å‡º $\sum\limits_{S \cup T = x} A_SA_T$ï¼Œè¿™ä¸ªæ˜¯ç»å…¸çš„ FWTï¼Œç„¶åå°±èƒ½è®¡ç®—äº†ã€‚

æˆ‘èµ›æ—¶è¢«æŸä¸ª AGC çš„é¢˜è¯¯å¯¼äº†ï¼ŒæŠŠå‰é¢çš„å¼å­è½¬æ¢æˆå†æšä¸¾ä¸€ä¸ªé›†åˆ $k \subseteq S \cap T$ï¼Œç„¶åå°±éœ€è¦æšä¸¾ $k$ å†å¯¹è¡¥é›†åš FWTï¼Œå°±æ˜¯ $O(3^n)$ å¤æ‚åº¦ï¼Œåªèƒ½æ‹¿ $56$ åˆ†ï¼Œsb è®¾å®šã€‚

B æ€§è´¨åˆ°æ­£è§£æ˜¯~~æˆ‘è®¤ä¸º~~è¾ƒå®¹æ˜“çš„ã€‚è®°å½• $A$ æ•°ç»„ä¸­è¢«ä¹˜äº†å¤šå°‘æ¬¡ $0$ï¼Œä¹Ÿå°±æ˜¯å¦‚æœè¿™ä¸ªä½ç½®çš„ $a_i + 1 = 0$ å°±è®°ä¸º $1$ å¹¶ç»™è®¡æ•°å™¨åŠ ä¸€ï¼Œç„¶åé«˜ç»´åç¼€ç§¯çš„æ—¶å€™æŠŠè¿™ç©æ„ä¹Ÿè·Ÿç€åŠ ä¸Šï¼Œè®¾è¿™ä¸ªçš„æ•°é‡æ•°ç»„ä¸º $D_R$ï¼Œ$R$ å°±æ²¿ç”¨å‰é¢çš„äº†ï¼Œç„¶åç”¨æ²¡æœ‰ $0$ çš„ $A$ è®¡ç®— $B$ã€‚

é‚£ä¹ˆç°åœ¨å›é¡¾ $O(4^n)$ çš„æšä¸¾ï¼Œåº”è¯¥å˜æˆ$\sum\limits_S \sum\limits_T A_SA_TB_{S \cup T}2^{|S \cap T|}(-1)^{|S| + |T|}[D_S = D_{S \cup T}][D_T = D_{S \cup T}]$ã€‚

é‚£ä¹ˆè€ƒè™‘åŠ ä¸Š $D$ çš„é™åˆ¶åæ˜¯ä»€ä¹ˆæƒ…å†µï¼Œç°åœ¨éœ€è¦å¯¹æ¯ä¸ª $x$ æ±‚å‡º $\sum\limits_{S \cup T = x} A_SA_T[D_S = D_x][D_T = D_x]$ï¼Œè¿™æ˜¯ä¸ªå¹¶ä¸ç»å…¸çš„ FWTï¼Œä½†æ˜¯ç”±äº $D$ åšäº†é«˜ç»´åç¼€å’Œï¼Œæ‰€ä»¥å®ƒå•è°ƒï¼Œé‚£ä¹ˆè€ƒè™‘ FWT å˜æ¢çš„æ—¶å€™å…¶å®æ˜¯ä¸ªé«˜ç»´å‰ç¼€å’Œï¼Œæˆ‘ä»¬å¯ä»¥åœ¨åš```A[j|(1<<i)]+=A[j]```çš„æ—¶å€™åˆ¤ä¸€ä¸‹å¦‚æœ $D_{j + 2^i} \ne D_j$ å°±ä¸åšè¿™æ­¥æ“ä½œï¼Œè¿™æ ·å°±åªæœ‰ $D$ ç›¸åŒçš„è¢«åšäº†é«˜ç»´å‰ç¼€å’Œã€‚è¿™éƒ¨åˆ†éœ€è¦è¯»è€…è‡ªè¡Œç†è§£ä¸€ä¸‹å…¶ä¸­çš„åŸç†ï¼Œåº”è¯¥å¯ä»¥å¯¹æ¯ä¸€ç»´åº¦å½’çº³è¯æ˜æ­£ç¡®æ€§ï¼Œä½†æ„Ÿæ€§ç†è§£ä¸€ä¸‹ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚

é‚£ä¹ˆç”¨è¿™ä¸ªæ”¹è£…äº†çš„ FWT å»åšå°±å¯¹äº†ã€‚

ä»£ç å…¶å®æœ‰ï¼Œåœºå¤–å†™äº†ï¼Œä½†ä¸è´´äº†ï¼Œæ²¡å•¥å¿…è¦ã€‚

---

## ä½œè€…ï¼šIvanZhang2009 (èµï¼š5)

èµ›æ—¶å®Œå…¨ä¸çŸ¥é“æ€ä¹ˆåšï¼ŒæŠŠä¸‰æ–¹æš´åŠ› dp çš„ $O(8^n)$ å¡è¿‡äº† $n\le 10$ å¸¦å¤šæµ‹ï¼Œç„¶åæœ€åä¸€ä¸ªå°æ—¶æ‰çœ‹å‡ºæ¥æœ‰ç”¨çš„å®¹æ–¥ï¼Œå–œææ²¡åšå®Œã€‚

è€ƒè™‘è¿™ä¸ªç‰¹æ®Šæ€§è´¨ Bï¼Œå¤§æ¦‚å°±æ˜¯è®©ä½ æŠŠç³»æ•°å‡‘æˆ $a_i+1$ çŠ¶ç‰©ã€‚ä½†æ˜¯å®Œå…¨ä¸çŸ¥é“æ€ä¹ˆå‡‘å•Šï¼Ÿå®ƒçœ‹ä¸Šå»å°±åƒæ˜¯ä¸€ä¸ªé€‰ä¸€ä¸ªæˆ–è€…ä¸é€‰çš„ç»„åˆæ„ä¹‰ã€‚

è€ƒè™‘éšæœºæ‰¾ä¸ªæ–¹å‘å®¹æ–¥ã€‚ç¬¬ä¸€ä¸ªæƒ³æ³•æ˜¯å¯¹ç€ $P\cap Q$ å®¹æ–¥ï¼Œä½†æ˜¯æˆ‘åœºä¸Šæµªè´¹äº†ä¸¤ä¸ªå°æ—¶æ¯«æ— è¿›å±•ã€‚

è®° $f(P)$ ä¸º $P$ ä¸­å…ƒç´ ä¸å’Œï¼Œ$w(P)$ ä¸º $P$ ä¸­å…ƒç´  $a_i$ ä¹˜ç§¯ã€‚å¯¹äºæ•´æ•° $x\in[0,2^n)$ï¼Œè®° $x_i$ ä¸º $\lfloor\frac{x}{2^i}\rfloor\bmod 2$ï¼Œå³äºŒè¿›åˆ¶ä¸‹ç¬¬ $i$ ä½ã€‚

è€ƒè™‘å°è¯•å¯¹ç€ $f(P)=f(Q)$ å®¹æ–¥ã€‚ä¸€ä¸ªæ— æ•Œçš„æƒ³æ³•æ˜¯è€ƒè™‘ $A=f(P)-f(Q),B=f(Q)-f(P)$ï¼ˆè¿™é‡Œçš„å‡æ³•è§†ä½œé›†åˆå‡æ³•ï¼Œå³ $S-T$ ä¸­å­˜åœ¨å…ƒç´  $x$ å½“ä¸”ä»…å½“ $S$ ä¸­å­˜åœ¨ $T$ ä¸­ä¸å­˜åœ¨ï¼Œæ­¤å¤„å³ $A$ è¡¨ç¤º $f(P)_i=1,f(Q)_i=0$ çš„ $i$ çš„é›†åˆï¼Œ$B$ åŒç†ï¼‰ã€‚

æˆ‘ä»¬ç›´æ¥å®¹æ–¥ $A$ å’Œ $B$ï¼æšä¸¾ $A,B$ï¼Œå®¹æ–¥ç³»æ•° $(-1)^{\mid A\mid+\mid B\mid}$ï¼Œè¡¨ç¤ºå¯¹äº $A$ ä¸­çš„ä½ï¼Œè¦æ±‚ $P$ æ‰€æœ‰æ•°åœ¨è¿™ä¸€ä½ä¸å« $0$ï¼Œ$Q$ è‡³å°‘å­˜åœ¨ä¸€ä¸ªè¿™ä¸€ä½æ˜¯ $0$ çš„ï¼›å¯¹äº $B$ ä¸­çš„ä½ï¼Œè¦æ±‚ $Q$ æ‰€æœ‰æ•°åœ¨è¿™ä¸€ä½ä¸å« $0$ï¼Œ$P$ è‡³å°‘å­˜åœ¨ä¸€ä¸ªè¿™ä¸€ä½æ˜¯ $0$ çš„ã€‚

è€ƒè™‘å¯¹äºâ€œè‡³å°‘å­˜åœ¨ä¸€ä¸ªâ€ç»§ç»­å®¹æ–¥ã€‚æšä¸¾ $C\subset A,D\subset B$ è¡¨ç¤ºå®¹æ–¥ï¼šå¯¹äº $C$ ä¸­çš„ä½ï¼Œ$Q$ è¿™ä¸€ä½ä¸å« $0$ï¼ˆæœ¬æ¥æ˜¯ $A$ ä¸­çš„ä½ $Q$ è¿™ä¸€ä½å¾—å­˜åœ¨ä¸€ä¸ª $0$ï¼Œæšä¸¾å­é›†é’¦å®šä¸æˆç«‹çš„å®¹æ–¥ï¼‰ï¼›å¯¹äº $D$ ä¸­çš„ä½ï¼Œ$P$ è¿™ä¸€ä½ä¸å« $0$ã€‚å®¹æ–¥ç³»æ•° $(-1)^{\mid C\mid+\mid D\mid}$ã€‚è¿™é‡Œçš„é™åˆ¶å˜æˆå¯¹äº $A\cup D$ çš„ä½ï¼Œ$P$ è¿™ä¸€ä½æ²¡ $0$ï¼›$B\cup C$ çš„ä½ï¼Œ$Q$ è¿™ä¸€ä½æ²¡ $0$ã€‚

å†™å‡ºæ¥ç›¸å½“äºï¼š

$$
\sum_{C\subset A,D\subset B,A\cap B=\empty}\sum_{(A\cup D)\in f(P)}\sum_{(B\cup C)\in f(Q)}[P\cap Q=\empty]w(P)w(Q)
$$

è¿™é‡Œ $a\in b$ è¡¨ç¤ºäºŒè¿›åˆ¶ä¸‹ $a$ æ˜¯ $b$ çš„å­é›†ã€‚

å‡è®¾ä½ ä»¥åŠæšä¸¾äº† $A,B,C,D$ï¼Œè€ƒè™‘ä¸€ä¸ªæ•° $i$ å¯ä»¥æ”¾åœ¨å“ªé‡Œï¼ˆä¸‰ç§é€‰æ‹©ï¼Œæ”¾ $P$ï¼Œæ”¾ $Q$ï¼Œéƒ½ä¸æ”¾ï¼‰ã€‚å¦‚æœ $(A\cup D\cup B\cup C)\in i$ï¼Œåˆ™æ˜¾ç„¶è´¡çŒ®æ˜¯ $2a_i+1$ï¼›å¦‚æœä¸Šè¿°ä¸æ»¡è¶³ï¼Œä¸”æ»¡è¶³ $(A\cup D)\in i$ æˆ– $(B\cup C)\in i$ï¼Œåˆ™è´¡çŒ®æ˜¯ $a_i+1$ï¼›å¦åˆ™è´¡çŒ®æ˜¯ $1$ã€‚

è¿™é‡Œâ€œå¦‚æœä¸Šè¿°ä¸æ»¡è¶³â€çš„é™åˆ¶æ¯”è¾ƒå”ã€‚åœ¨æ€§è´¨ B ä¸­ $a_i\neq -1$ï¼Œä¹Ÿå°±æ˜¯è¯´ $a_i+1$ å­˜åœ¨é€†å…ƒã€‚è®° $g(s)$ è¡¨ç¤º $\prod_{s\in i}(a_i+1)$ï¼Œ$h(s)$ è¡¨ç¤º $\prod_{s\in i}\frac{2a_i+1}{a_i+1}$ï¼Œåˆ™è´¡çŒ®å¯ä»¥å†™ä¸º $h(A\cup B\cup C\cup D)g(A\cup D)g(B\cup C)$ã€‚

é¢„å¤„ç† $g,h$ å¯ä»¥ç®€å•é«˜ç»´åç¼€ç§¯ï¼Œ$O(2^nn)$ã€‚ç„¶åæš´åŠ›åšæ˜¯æšä¸¾ $A,B,C,D$ï¼Œè¿™é‡Œåˆ†æä¸€ä¸‹æ¯ä¸€ä½æ˜¯ $1$ çš„å¯èƒ½æ˜¯ï¼š$A,AC,B,BD,\empty$ï¼Œæ‰€ä»¥å¤æ‚åº¦æ˜¯ $O(5^n)$ã€‚

è€ƒè™‘ä¼˜åŒ–ä¹Ÿå¾ˆå®¹æ˜“ï¼Œå¦‚æœå…ˆæšä¸¾ $A,B$ï¼Œåˆ™ $C,D$ æ˜¯ç‹¬ç«‹çš„ï¼Œå¤æ‚åº¦ $O(4^n)$ã€‚

å¦‚æœå…ˆæšä¸¾ $A,D$ï¼Œç„¶åé«˜ç»´å‰ç¼€å’Œé¢„å¤„ç†å¯¹äºæ¯ä¸€ç»„ $(A,B)$ çš„ $D$ çš„è´¡çŒ®å’Œï¼Œåˆ™å¤æ‚åº¦ $O(3^nn)$ã€‚è€ƒåœºä¸Šæ­¢æ­¥äºæ­¤äº†ï¼Œå•Šå•Šå•Šã€‚

æ³¨æ„åˆ°äººç±»æ™ºæ…§ã€‚æˆ‘ä»¬çš„è´¡çŒ®åªå’Œ $A\cup D$ å’Œ $B\cup C$ æœ‰å…³ã€‚å¦‚æœæšä¸¾è¿™ä¸¤ä¸ªï¼Œé‚£å”¯ä¸€çš„é—®é¢˜å°±æ˜¯å¦‚ä½•å¤„ç† $A\cap B=\empty$ï¼Ÿå¯ä»¥å‘ç° $A\cap B$ çš„éƒ¨åˆ†ä¸€å®šå±äº $(A\cup D)\cap(B\cup C)$ã€‚è€Œè¿™é‡Œçš„æ¯ä¸€ä½éƒ½å¯ä»¥åˆ’ç»™ $AD$ å’Œ $BC$ï¼Œæ‰€ä»¥ç«Ÿç„¶ç›´æ¥ä¹˜ä¸Šä¸€ä¸ª $2^{\mid (A\cup D)\cap(B\cup C)\mid}$ å°±å¥½äº†ï¼ï¼ï¼

è®° $s=A\cup D,t=B\cup C$ã€‚é‡å†™ä¸€ä¸‹å¼å­ï¼š

$$
\sum_{s,t}(-2)^{\mid s\mid+\mid t\mid}2^{-|S\cup T|}g(s)g(t)h(s\cup t)
$$

æ³¨æ„åˆ° $s,t$ ç‹¬ç«‹ï¼Œæˆ‘ä»¬ç›´æ¥åšæˆ–å·ç§¯ï¼Œæ‰€ä»¥åšåˆ°äº† $O(2^nn)$ã€‚

ä½†æ˜¯è¿™é‡Œ $h$ çš„å®šä¹‰æœ‰é€†å…ƒï¼Œä½†æ˜¯é€†å…ƒä¸ä¸€å®šå­˜åœ¨ï¼Œåªèƒ½é€šè¿‡æ€§è´¨ Bã€‚é‚£å’‹åŠã€‚

å…¶å®å¾ˆå¥½åšï¼Œæˆ‘ä»¬ç”¨ $a\times M^b$ çš„å½¢å¼å­˜å‚¨ä¸€ä¸ªæ•°ï¼Œå…¶ä¸­ $M$ æ˜¯æ¨¡æ•°ã€‚æ³¨æ„åˆ°æˆ‘ä»¬åªéœ€è¦åšåŠ å‡ä¹˜é™¤ã€‚åŠ æ³•çš„æ—¶å€™ä»¤ $b$ ä¸ºä¸¤ä¸ªé‡Œçš„å°çš„é‚£ä¸ªï¼Œä¹˜é™¤çš„æ—¶å€™æŠŠ $a$ ä¹˜èµ·æ¥ï¼Œ$b$ åŠ èµ·æ¥å°±å¥½äº†ã€‚

è¿™ç§é¢˜ä»£ç éƒ½å¾ˆå¥½å†™ã€‚

```cpp
#include<bits/stdc++.h>
#define MOD 998244353
#define int long long
#define REP(i,a,n) for(int i=a;i<(int)(n);++i)
#define pb push_back
#define all(v) v.begin(),v.end()
#define pii pair<int,int>
#define cntbit(x) __builtin_popcount(x)
using namespace std;
int qpow(int x,int y){
	int res=1;
	while(y)res=y&1? res*x%MOD:res,x=x*x%MOD,y>>=1;
	return res;
}
int ID;
struct number{
	int x;
	int c;
	void operator =(int y){
		if(y%MOD==0)x=1,c=1;
		else x=y,c=0;
	}
	void operator *=(number a){
		(x*=a.x)%=MOD;
		(c+=a.c)%=MOD;
	}
	void operator *=(int a){
		(x*=a)%=MOD;
	}
	void operator +=(number a){
		int r=min(c,a.c);
		x=((c==r)*x+(a.c==r)*a.x)%MOD,c=r;
	}
	void operator -=(number a){
		int r=min(c,a.c);
		x=((c==r)*x-(a.c==r)*a.x)%MOD,c=r;
	}
};
int n;
int a[1100000];
number f[1100000],g[1100000];
void Main() {
	cin>>n;
	REP(i,0,(1<<n))cin>>a[i];
	REP(i,0,(1<<n))f[i]=a[i]+1;
	REP(i,0,n){
		for(int j=(1<<n)-1;j>=0;--j)if(!((j>>i)&1)){
			f[j]*=f[j|(1<<i)];
		}
	}
	REP(i,0,(1<<n))f[i]*=qpow(-2,cntbit(i));
	REP(j,0,n){
		REP(i,0,(1<<n))if((i>>j)&1){
			f[i]+=f[i^(1<<j)];
		}
	}
	REP(i,0,(1<<n)){
		f[i]*=f[i];
	}
	REP(j,0,n){
		for(int i=(1<<n)-1;i>=0;--i)if((i>>j)&1){
			f[i]-=f[i^(1<<j)];
		}
	}
	REP(i,0,(1<<n)){
		if(a[i]==MOD-1){
			g[i]={a[i],-2};
		}else g[i]=(a[i]*2+1)*qpow(a[i]+1,(MOD-2)*2)%MOD;
	}
	REP(i,0,n){
		for(int j=(1<<n)-1;j>=0;--j)if(!((j>>i)&1)){
			g[j]*=g[j|(1<<i)];
		}
	}
	int ans=0;
	REP(i,0,(1<<n)){
		f[i]*=g[i];
		if(f[i].c)continue;
		int co=qpow((MOD+1)/2,cntbit(i))*f[i].x;
		(ans+=co)%=MOD;
	}
	(ans+=MOD)%=MOD;
	cout<<ans<<'\n';
}
signed main(){
	int tc;
	cin>>ID>>tc;
	while(tc--)Main();
	return 0;
}
```

---

## ä½œè€…ï¼šyanzihe (èµï¼š5)

æ•°å­¦åˆ†æå¥½é¢˜ï¼Œè¿™é“é¢˜æ‹¯æ•‘äº†æˆ‘çš„ NOIã€‚

å†™ä¸€ä¸‹èµ›æ—¶åšæ³•ã€‚

## B æ€§è´¨
æŠŠäºŒè¿›åˆ¶æ•°è§†ä½œé›†åˆï¼Œè®¾ $U=\{1, 2, \dots, n\}, S=\mathcal{P}(U)$ï¼ˆ$U$ çš„å¹‚é›†ï¼‰ã€‚

å®šä¹‰ $v(P)=\prod_{x\in P}a_x$

é¦–å…ˆæšä¸¾ $J\subseteq U$ï¼Œç„¶åè®¡ç®— $f(P_1)=f(P_2)=J$ çš„æœ‰åºå¯¹çš„è´¡çŒ®ï¼Œå³ 
$$\sum_{J\subseteq U}\sum_{P_1\subseteq S, f(P_1)=J}v(P_1)\sum_{P_2\subseteq S, f(P_2)=J, P_1\cap P_2=\varnothing}v(P_2)$$

ç†ŸçŸ¥**å›°éš¾è®¡æ•°é¢˜ä¼˜å…ˆè€ƒè™‘å®¹æ–¥**ï¼Œæ³¨æ„åˆ° 
$$\sum_{P\subseteq S, f(P)=J}v(P)=\sum_{J\subseteq T\subseteq U}(-1)^{|T|-|J|}\sum_{P\subseteq S, T\subseteq f(P)}v(P)$$

æ‰€ä»¥åŸå¼ç­‰äº 
$$\sum_{T_1, T_2\subseteq U}(-1)^{|T_1|+|T_2|}\sum_{J\subseteq (T_1\cap T_2)}\sum_{T_1\subseteq f(P_1), T_2\subseteq f(P_2), P_1\cap P_2=\varnothing}v(P_1)v(P_2)$$

å‘ç°æšä¸¾ $J$ å¯ä»¥æ›¿æ¢ä¸º $2^{|T_1\cap T_2|}$ï¼Œå³
$$\sum_{T_1, T_2\subseteq U}(-1)^{|T_1|+|T_2|}2^{|T_1\cap T_2|}\sum_{T_1\subseteq f(P_1), T_2\subseteq f(P_2), P_1\cap P_2=\varnothing}v(P_1)v(P_2)  \tag{1}$$

è®¾ $A=\{X|X\subseteq U, T_1\subseteq X\}, B=\{X|X\subseteq U, T_2\subseteq X\}$ã€‚é‚£ä¹ˆ $(1)$ å¼å³ä¾§å’Œå·ä¸‹çš„æ¡ä»¶ $T_1\subseteq f(P_1), T_2\subseteq f(P_2)$ ç­‰ä»·äº $P_1\subseteq A, P_2\subseteq B$ã€‚

$(1)$ ç­‰äº

$$\sum_{T_1, T_2\subseteq U}(-1)^{|T_1|+|T_2|}2^{|T_1\cap T_2|}\sum_{P_1\subseteq A, P_2\subseteq B, P_1\cap P_2=\varnothing}\prod_{X\in P_1\cup P_2}a_X=\sum_{T_1, T_2\subseteq U}(-1)^{|T_1|+|T_2|}2^{|T_1\cap T_2|}\prod_{X\in (A\cap B)}(2a_X+1)\prod_{X\in (A\cup B)/(A\cap B)}(a_X+1)$$

ç¬¬äºŒä¸ªç­‰å·çš„åŸç†ï¼šè€ƒè™‘æŠŠæ‰€æœ‰æ‹¬å·å±•å¼€ï¼Œå¯¹äº $X\in(A\cap B)$æ¯ä¸€é¡¹éƒ½è¦ä» $2a_X$ å’Œ $1$ ä¸­é€‰æ‹©ä¸€ä¸ªï¼Œé€‰æ‹© $1$ è¡¨ç¤º $X$ æ—¢ä¸åœ¨ $P_1$ ä¸­ä¹Ÿä¸åœ¨ $P_2$ ä¸­ï¼Œé€‰æ‹© $2a_X$ è¡¨ç¤ºåœ¨å…¶ä¸­ä¸€ä¸ªã€‚ï¼ˆä¹˜ä»¥ $2$ æ˜¯å› ä¸ºæœ‰åœ¨ $P_1$ ä¸­å’Œåœ¨ $P_2$ ä¸­ä¸¤ç§å¯èƒ½ï¼‰

è€Œå¯¹äº $X\in (A\cup B)/(A\cap B)$ï¼Œé€‰æ‹© $1$ è¡¨ç¤º $X$ ä¸åœ¨ $P_1, P_2$ ä¸­ï¼Œå¦åˆ™è¡¨ç¤ºåœ¨å…¶ä¸­ã€‚è¿™é‡Œä¸ä¹˜ä»¥äºŒæ˜¯å› ä¸º $X\notin (A\cap B)$ï¼Œåªèƒ½æ”¾åœ¨å…¶ä¸­ä¸€ä¸ªé‡Œã€‚

é‚£ä¹ˆåªéœ€è¦é¢„å¤„ç† $G(T)=\prod_{T\subseteq X}(2a_X+1), K(T)=\prod_{T\subseteq X}(a_X+1)$ï¼ˆæ˜¾ç„¶å®ƒä»¬èƒ½åœ¨ $O(n2^n)$ å†…é¢„å¤„ç†å‡ºï¼‰ï¼Œç­”æ¡ˆå°±æ˜¯

$$\sum_{T_1, T_2\subseteq U}(-1)^{|T_1|+|T_2|}2^{|T_1\cap T_2|}G(T_1\cup T_2)\times\dfrac{K(T_1)K(T_2)}{K(T_1\cup T_2)^2}$$

ä¸ºäº†è¿›ä¸€æ­¥åœ°ç®€åŒ–å¼å­ï¼Œå¦è®¾ $L(T)=\dfrac{G(T)}{K(T)^22^{|T|}}ï¼ŒW(T)=K(T)(-2)^{|T|}$ï¼ŒåŸå¼ç­‰äº
$$\sum_{T_1, T_2\subseteq U}W(T_1)W(T_2)L(T_1\cup T_2)=\sum_{T\subseteq U}L(T)\sum_{T_1\cup T_2=T}W(T_1)W(T_2)$$

è¿™æ˜¯ä¸€ä¸ªå·ç§¯çš„å½¢å¼ï¼Œä½¿ç”¨ FWT ç›´æ¥ $O(n2^n)$ è®¡ç®—ã€‚

## æ­£è§£
è®¾ä½¿ç”¨ä¹‹å‰çš„ç®—æ³•ç®—å‡ºçš„ç­”æ¡ˆä¸º $ans(a_0, a_1\dots, a_U)$ï¼ˆæ³¨æ„ä»–æ˜¯ä¸€ä¸ª $2^n$ å…ƒçš„å‡½æ•°ï¼‰ã€‚

è€ƒè™‘å®ƒåœ¨ $a_X=998244352$ æ—¶é‡åˆ°äº†é—®é¢˜ï¼Œå› ä¸ºå¯èƒ½å‡ºç°ä¹˜ä»¥ $0$ å†é™¤ä»¥ $0$ çš„æƒ…å†µã€‚



ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæ³¨æ„ $\lim_{\epsilon\to 0^+}ans(a_0+\epsilon, a_1+\epsilon, \dots, a_U+\epsilon)$ å°±æ˜¯æ­£ç¡®çš„ç­”æ¡ˆï¼ˆæ³¨æ„æ‰€æœ‰ $a_X$ éƒ½åŠ ä¸Š $\epsilon$ åï¼Œå°±ä¸ä¼šå‡ºç°é™¤ä»¥ $0$ çš„æƒ…å†µï¼Œåªä¼šå‡ºç°é™¤ä»¥ $\epsilon$ çš„æƒ…å†µï¼‰ã€‚

ä¸€ä¸ªæƒ³æ³•æ˜¯ç›´æ¥æŠŠ $\epsilon$ å¸¦è¿›å» $ans$ çš„è¡¨è¾¾å¼ä¸­è®¡ç®—ï¼Œè¿™æ ·åŸæœ¬çš„æ¯ä¸€ä¸ªæ•°éƒ½æ˜¯ä¸€ä¸ªå…³äº $\epsilon$ çš„æ´›æœ—çº§æ•°ï¼Œä½†æ˜¯æ´›æœ—çº§æ•°çš„ä¹˜é™¤æ³•å¾ˆæ…¢ã€‚

å› æ­¤ï¼Œæˆ‘ä»¬çš„åŠæ³•æ˜¯ä»»ä½•æ—¶å€™åªä¿ç•™æ´›æœ—çº§æ•°çš„æœ€ä½é¡¹ï¼Œè¿™æ ·å¤æ‚åº¦ä¸å˜ï¼Œå¹¶ä¸”ç®—å‡ºæ¥çš„æé™å€¼æ˜¯æ­£ç¡®çš„ã€‚

**è¯æ˜**ï¼šè®¾æƒ³æœ‰ä¸€ä¸ªæ´›æœ—çº§æ•°$3\epsilon^4+2\epsilon^2$ï¼Œå¦‚æœèˆå¼ƒäº† $3\epsilon^4$ å¯¹ç­”æ¡ˆäº§ç”Ÿçš„å½±å“ï¼Œé‚£ä¹ˆè¯´æ˜è¿™ä¸ªå¤šé¡¹å¼ä¸€å®šä¼šé™¤ä»¥$(\text{å¸¸æ•°}\times\epsilon^4)$ åè´¡çŒ®åˆ°ç­”æ¡ˆä¸Šï¼Œä½†è¿™æ„å‘³ç€ $2\epsilon^2$ å˜æˆäº† $\text{å¸¸æ•°}\times \dfrac{1}{\epsilon^2}$ï¼Œè¿™æ„å‘³ç€æé™å‘æ•£ï¼åŸæé™æ˜¾ç„¶æ˜¯å­˜åœ¨çš„ï¼Œè¿™ä¸å¯èƒ½ã€‚

åœ¨å…·ä½“è®¡ç®—æ—¶ï¼Œå¦‚æœæ˜¯åŠ æ³•ï¼Œå¹¶ä¸”æœ€ä½æ¬¡é¡¹æ¬¡æ•°ç›¸åŒåˆ™ç³»æ•°ç›¸åŠ ï¼Œå¦åˆ™åªä¿ç•™ä½æ¬¡é¡¹ã€‚å¦‚æœæ˜¯ä¹˜/é™¤æ³•ï¼Œç›´æ¥è®©æœ€ä½æ¬¡é¡¹åšä¹˜/é™¤æ³•ã€‚

é‚£ä¹ˆé€šè¿‡è¿™ä¸ªæ–¹æ³•ç®—å‡ºæ¥çš„ $ans(a_0+\epsilon, a_1+\epsilon, \dots, a_U+\epsilon)$ï¼Œå®ƒçš„å¸¸æ•°é¡¹å°±æ˜¯ç­”æ¡ˆã€‚ï¼ˆå¸¦ $\epsilon$ çš„é¡¹éƒ½è¶‹äº $0$ï¼Œå¯ä¸è®¡ï¼‰

---

## ä½œè€…ï¼šSDSXC (èµï¼š4)

èµ›åè®¤çœŸæƒ³ä¸€æƒ³å‘ç°çœŸä¸ç®—éš¾ï¼Œå¯æƒœèµ›æ—¶ T1 è°ƒäº†å¥½ä¹…æ²¡æ—¶é—´åšæ­¤é¢˜äº†ï¼Œå¸Œæœ›æ˜å¹´ä¸è¦å†å‘ç”Ÿè¿™ç§äº‹æƒ…äº†ï¼Œç®€å•è®°å½•ä¸€ä¸‹åšæ³•ã€‚

é¦–å…ˆæˆ‘ä»¬ç»Ÿè®¡ $f(P)=X$ çš„æ¯”è¾ƒéš¾åšï¼Œè€ƒè™‘ç»Ÿè®¡ $f(P)\supseteq X$ çš„ç„¶åå®¹æ–¥ã€‚

è€ƒè™‘ $f(P)\supseteq X,f(Q)\supseteq Y$ çš„æƒå€¼å’Œï¼Œè‹¥ $S\supseteq X$ ä½† $S\nsupseteq Y$ï¼Œé‚£ä¹ˆ $a_S$ å¯ä»¥ä¸é€‰ï¼Œå¯ä»¥æ”¾ $P$ ä¸­ï¼Œç»™ç­”æ¡ˆä¹˜ä¸Š $(1+a_S)$ï¼Œåè¿‡æ¥åŒç†ï¼Œè‹¥ $S\supseteq X$ ä¸” $S\supseteq Y$ï¼Œè´¡çŒ® $(1+2a_S)$ã€‚æ‰€ä»¥ $f(P)\supseteq X,f(Q)\supseteq Y$ çš„æƒå€¼å’Œ $w_{X,Y}=\prod\limits_{S\supseteq X}(1+a_S)\prod\limits_{S\supseteq Y}(1+a_S)\prod\limits_{S\supseteq X,S\supseteq Y}\frac{1+2a_S}{(1+a_S)^2}$ã€‚

æˆ‘ä»¬è®° $F(X)=\prod\limits_{S\supseteq X}(1+a_S),G(X)=\prod\limits_{S\supseteq X}\frac{1+2a_S}{(1+a_S)^2}$ï¼Œé‚£ä¹ˆ $w_{X,Y}=F(X)F(Y)G(X\cup Y)$ã€‚

è¿™ä¸ªä¸œè¥¿ç›´æ¥æš´åŠ›ç®—ç„¶åè·‘é«˜ç»´åç¼€å·®åˆ†å°±å¯ä»¥è½»æ¾åšåˆ°$O(4^n)$ã€‚å½“ç„¶ä½ è¿˜éœ€è¦å¤„ç† $a_S=-1$ çš„æƒ…å†µï¼Œè¿™ä¸ªæœ€åè®²ã€‚

ç„¶åæˆ‘ä»¬æ¥ç€æ¨å¼å­ï¼Œå‡è®¾ $H(S)$ è¡¨ç¤º $f(P)=f(Q)=S$ çš„æƒå€¼å’Œã€‚é‚£ä¹ˆæˆ‘ä»¬ä¸éš¾å‘ç° $w(X,Y)$ å¯¹æ»¡è¶³ $S\subseteq X,S\subseteq Y$ çš„ $H(S)$ æœ‰ $(-1)^{|X-S|+|Y-S|}=(-1)^{|X|+|Y|-2|S|}=(-1)^{|X|+|Y|}$ã€‚è€Œå…±æœ‰ $2^{|X\cap Y|}$ ä¸ª $H(S)$ è¢«è´¡çŒ®åˆ°äº†ï¼Œæ‰€ä»¥å¯¹ç­”æ¡ˆçš„è´¡çŒ®ä¸º $(-1)^{|X|+|Y|}2^{|X\cap Y|}=(-1)^{|X|+|Y|}2^{|X|+|Y|-|X\cup Y|}=(-2)^{|X|}(-2)^{|Y|}(\frac{1}{2})^{|X\cup Y|}$ã€‚

ä»¤ $A(X)=(-2)^{|X|}F(X),B(X)=(\frac{1}{2})^{|X|}G(X)$ã€‚

é‚£ä¹ˆç­”æ¡ˆå°±ç­‰äº $\sum\limits_{X,Y}A(X)A(Y)B(X\cup Y)$ã€‚

ç„¶åè·‘ä¸€ä¸ªé«˜ç»´å‰ç¼€ç§¯å³å¯æ±‚å‡º $F,G$ï¼Œç„¶åç®€å•æ±‚å‡º $A,B$ã€‚å†ç®€å• FWT æ±‚å‡º $\sum\limits_{X\cup Y=S}A(X)A(Y)$ï¼Œç„¶åæŠŠæ¯ä¸€é¡¹ä¹˜ä¸Š $B(S)$ å†åŠ èµ·æ¥å°±åšå®Œäº†ã€‚

æœ€åè®²ä¸€ä¸‹ $a_S=-1$ çš„å¤„ç†æ–¹æ³•ï¼Œä¹Ÿéå¸¸ç®€å•ï¼Œæˆ‘ä»¬å‚è€ƒæ±‚æ¨¡ $2^{64}$ æ„ä¹‰ä¸‹ç»„åˆæ•°çš„åšæ³•ï¼Œæˆ‘ä»¬æŠŠæ¯ä¸€ä¸ªæ•°å†™æˆ $x\times p^y$ çš„å½¢å¼ï¼Œä¹˜é™¤æ³•æ˜¯å®¹æ˜“çš„ï¼ŒåŠ å‡æ³•åŒé˜¶ç›´æ¥åŠ å‡ç›´æ¥ï¼Œå¦åˆ™èˆå»é«˜æ¬¡é¡¹å› ä¸ºä½ æ˜¾ç„¶ä¸ä¼šå‡ºç° $\frac{1}{p}$ è¿™ç§ä¸œè¥¿ã€‚

ä»£ç å¾ˆå¥½å†™
```cpp
#include<bits/stdc++.h>
#define p 998244353ll
#define ll long long
#define N 1049000
using namespace std;
ll qpow(ll x,ll y){
	if(!y) return 1ll;
	ll tmp=qpow(x,y>>1);
	if(y&1) return tmp*tmp%p*x%p;
	else return tmp*tmp%p;
}
struct num{
	ll x,y;
	num operator+(num b){
		if(y==b.y){
			if((x+b.x)%p) return num{(x+b.x)%p,y};
			else return num{(x+b.x)/p,y+1};
		}
		else if(y<b.y) return num{x,y};
		else return b;
	}
	num operator-(num b){
		if(y==b.y){
			if((x-b.x)%p) return num{(x-b.x+p)%p,y};
			else return num{((x-b.x)/p+p)%p,y+1};
		}
		else if(y<b.y) return num{x,y};
		else return num{p-b.x,b.y};
	}
	num operator*(num b){
		return num{x*b.x%p,y+b.y};
	}
	num operator/(num b){
		return num{x*qpow(b.x,p-2)%p,y-b.y};
	}
};
num f[N],g[N],a[N];
int n;
constexpr num _1=num{1,0},_2=num{2,0};
void solve(){
	cin>>n;
	for(int i=0;i<(1<<n);i++)cin>>a[i].x,a[i].y=0;
	for(int i=0;i<(1<<n);i++)f[i]=a[i]+_1,g[i]=a[i]*_2+_1;
	for(int i=1;i<(1<<n);i<<=1){
		for(int j=0;j<(1<<n);j++){
			if(!(j&i))f[j]=f[j]*f[j^i],g[j]=g[j]*g[j^i];
		}
	}
	for(int i=0;i<(1<<n);i++){
		num t={1<<__builtin_popcount(i),0};
		g[i]=g[i]/(f[i]*f[i]*t);
		f[i]=f[i]*t;
		if(__builtin_popcount(i)&1)f[i]={p-f[i].x,f[i].y};
	}
	for(int i=1;i<(1<<n);i<<=1){
		for(int j=0;j<(1<<n);j++){
			if(j&i)f[j]=f[j]+f[j^i];
		}
	}
	for(int i=0;i<(1<<n);i++)f[i]=f[i]*f[i];
	for(int i=1;i<(1<<n);i<<=1){
		for(int j=0;j<(1<<n);j++){
			if(j&i)f[j]=f[j]-f[j^i];
		}
	}
	for(int i=0;i<(1<<n);i++)f[i]=f[i]*g[i];
	ll ans=0;
	for(int i=0;i<(1<<n);i++)if(!f[i].y)ans+=f[i].x;
	cout<<ans%p<<"\n";
}
int main(){
	ios::sync_with_stdio(false);cin.tie(0);cout.tie(0);
	int C,T;cin>>C>>T;while(T--)solve();
	return 0;
}
```

---

## ä½œè€…ï¼š_Ch1F4N_ (èµï¼š4)

åœºä¸Šä¸ä¼šè¿™ä¸ªé¢˜å¯¼è‡´ day2 æ•´ä¸ªå®Œè›‹äº†ã€‚

å…³æ³¨ä¸€ä¸‹ $f(P),f(Q)$ çš„é™åˆ¶ï¼Œä½ å‘ç°æˆ‘ä»¬å¦‚æœä¸å»æšä¸¾ $P,Q$ çš„è¯è¿è®¡ç®— $f(P)=s$ çš„ $P$ æ•°é‡éƒ½å¾ˆéš¾ï¼Œæ‰€ä»¥è€ƒè™‘å®¹æ–¥ï¼Œä¸éš¾å‘ç°å¾ˆå®¹æ˜“å¯¹ $s \subseteq f(P)$ çš„ $P$ è®¡ç®—æƒå€¼å’Œï¼Œå†è¿›ä¸€æ­¥åœ°ï¼Œè€ƒè™‘å¯¹ $a \subseteq f(P),b \subseteq f(Q)$ å¹¶ä¸” $P \cap Q = \varnothing$ çš„æ‰€æœ‰ $P,Q$ è®¡ç®—æ–¹æ¡ˆæƒå€¼å’Œï¼Œè€ƒå¯Ÿæ¯ä¸ªå…ƒç´ åˆ°åº•æ˜¯é€‰å…¥ $P$ é€‰å…¥ $Q$ è¿˜æ˜¯éƒ½ä¸é€‰ï¼Œä¸éš¾å‘ç°è´¡çŒ®å°±æ˜¯ $\prod_{a \subseteq s \nsubseteq (a \cup b)} (a_s+1) \times \prod_{b \subseteq s \nsubseteq (a \cup b)} (a_s+1) \prod_{(a \cup b) \subseteq s} (2 \times a_s+1)$ï¼Œå¦‚æœå…ˆä¸è€ƒè™‘ $a_i = -1$ çš„æƒ…å½¢ï¼Œé‚£ä¹ˆç›´æ¥ä»¤ $f_{s} = \prod_{s \subseteq t} (a_t+1),g_{s} = \prod_{s \subseteq t} (2 \times a_t +1)$ï¼Œé‚£ä¹ˆè´¡çŒ®å°±æ˜¯ $f(a) \times f(b) \times \frac{1}{f(a \cup b)^2} \times g(a \cup b)$ã€‚

æ¥ä¸‹æ¥å…ˆè€ƒè™‘ä¸€ä¸ª $4^n$ å·¦å³çš„æš´åŠ›ï¼Œä»¤ $F(a,b)$ è¡¨ç¤º $a \subseteq f(P),b \subseteq f(Q)$ å¹¶ä¸” $P \cap Q = \varnothing$ çš„æ‰€æœ‰ $P,Q$ è®¡ç®—æ–¹æ¡ˆæƒå€¼å’Œï¼Œ$G(a,b)$ è¡¨ç¤º $a = f(P),b = f(Q)$ å¹¶ä¸” $P \cap Q = \varnothing$ çš„æ‰€æœ‰ $P,Q$ è®¡ç®—æ–¹æ¡ˆæƒå€¼å’Œï¼Œæ˜¾ç„¶æœ‰ $F(a,b)$ æ˜¯ $G(a,b)$ çš„é«˜ç»´åç¼€å’Œï¼Œå®¹æ˜“é€šè¿‡é«˜ç»´åç¼€å·®åˆ†æ±‚å‡ºæ‰€æœ‰ $G$ åå¯¹æ‰€æœ‰ $G(S,S)$ æ±‚å’Œã€‚

è€ƒè™‘ç”¨å¼å­æŠŠä¸Šé¢çš„æš´åŠ›æè¿°å‡ºæ¥ï¼Œ$G$ çš„è¡¨ç¤ºæ–¹æ³•å¯ä»¥è€ƒè™‘å­é›†åæ¼”ï¼Œä¹Ÿå°±æ˜¯ $G(a,b) = \sum_{a \subseteq A,b \subseteq B} (-1)^{|A|-|a|+|B|-|b|} F(A,B)$ã€‚

æ‰€ä»¥ç­”æ¡ˆå¼å­æ˜¯ $\sum_{S \subseteq \{1,2,3,\dots n\}} \sum_{S \subseteq A,S \subseteq B} (-1)^{|A|+|B|} F(A,B)$ã€‚

å‘ç° $S$ çš„æšä¸¾ç”¨å¤„å·²ç»ä¸å¤§äº†ï¼Œäº¤æ¢æ±‚å’Œé¡ºåºå®¹æ˜“å¾—åˆ° $\sum_{A \subseteq \{1,2,3,\dots n\},B \subseteq \{1,2,3,\dots n\}} (-1)^{|A|+|B|} 2^{|A \cap B|} F(A,B)$ã€‚

æˆ‘ä»¬å¸Œæœ›å°† $A,B$ çš„æšä¸¾æ‹†å¼€ï¼Œå‘ç°éš¾ç‚¹åœ¨äº $F(A,B)$ é‡Œé¢æœ‰ä¸ªå…³äº $A \cup B$ çš„é¡¹ï¼Œäºæ˜¯è€ƒè™‘æšä¸¾ $A \cup B$ ç„¶åç»Ÿè®¡å¤šå°‘ç»„ $A,B$ èƒ½è´¡çŒ®ä¸Šå»ï¼Œè¿™æ˜¯ä¸€ä¸ªæˆ–å·ç§¯ï¼Œå®¹æ˜“é€šè¿‡é«˜ç»´å‰ç¼€å’Œä¸é«˜ç»´å‰ç¼€å·®åˆ†å¤„ç†å‡ºæ¥ï¼Œ$2^{|A \cap B|}$ çš„å¤„ç†è€ƒè™‘æŠŠ $|A \cap B|$ è½¬å†™ä¸º $|A|+|B|-|A \cup B|$ å³å¯ã€‚

ç°åœ¨è€ƒè™‘å¦‚æœå­˜åœ¨ $a_i = -1$ å’‹åŠã€‚

è€ƒè™‘æŠŠ $0$ å› å­æ•°é‡è®°ä¸‹æ¥ï¼Œæˆ‘ä»¬è½¬å˜ $f$ çš„å®šä¹‰ä¸ºæ‰€æœ‰ $a_i+1 \neq 0$ çš„ $a_i+1$ ä¹‹ç§¯ï¼Œå¹¶è®°å½• $c$ è¡¨ç¤º $a_i+1$ ä¸­ $0$ çš„æ•°é‡ï¼Œä½ å‘ç°å¦‚æœ $c(a)=c(b)=c(a \cup b)$ é‚£ä¹ˆæŒ‰ç…§æ–°çš„ $f$ åŸæ¥çš„å¼å­è®¡ç®—ç­”æ¡ˆå°±æ˜¯å¯¹çš„ï¼Œå¦åˆ™æ²¡æœ‰è´¡çŒ®ã€‚

è€ƒè™‘æŠŠæˆ–å·ç§¯çš„è¿‡ç¨‹æ”¹ä¸€ä¸‹ä½¿å¾—èƒ½å¤„ç†æ–°çš„é—®é¢˜ï¼Œæ–°çš„é—®é¢˜å½¢å¦‚ï¼š$C_{s} = \sum_{a \cup b = s,c(a)=c(b)=c(s)} dp_a \times dp_b$ã€‚

ç±»ä¼¼æˆ–å·ç§¯çš„å¤„ç†è¿‡ç¨‹ï¼Œè€ƒè™‘å…ˆå¯¹æ¯ä¸ª $S$ æ±‚å‡º $\sum_{a \subseteq S,c(a)=c(S)} dp_a$ï¼Œè¿™ä¸ªä¸œè¥¿çš„æ±‚æ³•è€ƒè™‘æ”¹ä¸€ä¸‹é«˜ç»´å‰ç¼€å’Œï¼šå› ä¸º $c$ çš„å€¼éšç€ä¸‹æ ‡æ‰€å¯¹åº”çš„é›†åˆåŠ å…¥å…ƒç´ è€Œæ¸æ¸å‡å°ï¼Œæ‰€ä»¥æ¯æ¬¡å°†è¦ä» $S$ è´¡çŒ®åˆ° $S \cup v$ çš„æ—¶å€™å¦‚æœ $c(S) \neq c(S \cup v)$ å°±ä¸å»è´¡çŒ®å³å¯ï¼Œå°†æ±‚å‡ºæ¥çš„æ•°ç»„æ¯ä¸€é¡¹å¹³æ–¹ä¹‹åï¼Œç›¸å½“äºå¯¹æ¯ä¸ª $S$ æ±‚å‡ºäº† $\sum_{a \subseteq S,c(a)=c(S),b \subseteq S,c(b)=c(S),a \cup b \subseteq S} dp_a \times dp_b$ï¼Œä»è¿™ä¸ªå‡ºå‘æ±‚è§£ $C$ è¿˜æ˜¯è€ƒè™‘ä¸€æ ·çš„æ€è·¯ï¼Œæ”¹ä¸€ä¸‹é«˜ç»´å‰ç¼€å·®åˆ†ï¼šä½ å‘ç°å°† $C$ æ•°ç»„åšå‰é¢å¤„ç† $\sum_{a \subseteq S,c(a)=c(S)} dp_a$ æ—¶åšçš„æ›´æ”¹åçš„é«˜ç»´å‰ç¼€å’Œå°±å¯ä»¥å¾—åˆ°æˆ‘ä»¬å·²ç»æ±‚å‡ºçš„ $\sum_{a \subseteq S,c(a)=c(S),b \subseteq S,c(b)=c(S),a \cup b \subseteq S} dp_a \times dp_b$ï¼ˆç”±äº $c$ æ•°ç»„çš„æ€§è´¨ï¼Œ$c(a),c(b) \geq c(a \cup b) \geq c(S)$ï¼Œæ‰€ä»¥ $c(a)=c(b)=c(S)$ å°±ä»£è¡¨ $c(a)=c(b)=c(a \cup b)$ï¼‰ï¼Œæ‰€ä»¥å°†è¿™ä¸ªå·²ç»æ±‚å‡ºçš„æ•°ç»„å€’è¿‡æ¥åšå‰é¢çš„æ“ä½œå³å¯å¾—åˆ° $C$ï¼ˆç”±äºè¿™ä¸ªæ“ä½œæ˜¯çº¿æ€§å˜æ¢æ‰€ä»¥æ˜¯å¯ä»¥è½¬ç½®çš„ï¼‰ã€‚

ç»¼ä¸Šæˆ‘ä»¬åœ¨ $O(n 2^n)$ çš„æ—¶é—´å¤æ‚åº¦å†…è§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚


```cpp
#include<bits/stdc++.h>
using namespace std;
#define int long long
const int maxv = 1<<20;
const int mod = 998244353;
int n;
int popc[maxv];
int a[maxv];
int v1[maxv],c1[maxv],v2[maxv];
int inv1[maxv];
int qpow(int a,int b){
    if(b==0) return 1;
    if(b==1) return a;
    int res=qpow(a,b/2);
    res=res*res%mod;
    if(b&1) res=res*a%mod;
    return res;
}
int pre[maxv];
int _pow[maxv],inv[maxv];
void work(){
    cin>>n;
    for(int i=0;i<(1<<n);i++) cin>>a[i],v1[i]=((a[i]+1)%mod==0?1:(a[i]+1)%mod),c1[i]=((a[i]+1)%mod==0),v2[i]=(2*a[i]+1)%mod;
    for(int i=0;i<n;i++){
        for(int v=0;v<(1<<n);v++){
            if((1<<i)&v){
                v1[v-(1<<i)]=v1[v-(1<<i)]*v1[v]%mod;
                c1[v-(1<<i)]+=c1[v];
                v2[v-(1<<i)]=v2[v-(1<<i)]*v2[v]%mod;
            }
        }
    }
    for(int v=0;v<(1<<n);v++) inv1[v]=qpow(v1[v],mod-2);
    for(int v=0;v<(1<<n);v++) pre[v]=v1[v]*(popc[v]&1?mod-1:1)%mod*_pow[popc[v]]%mod;
    for(int i=0;i<n;i++){
        for(int v=0;v<(1<<n);v++){
            if((1<<i)&v){
                if(c1[v-(1<<i)]==c1[v]) pre[v]=(pre[v]+pre[v-(1<<i)])%mod;
            }
        }
    }
    for(int v=0;v<(1<<n);v++) pre[v]=pre[v]*pre[v]%mod;
    for(int i=0;i<n;i++){
        for(int v=0;v<(1<<n);v++){
            if((1<<i)&v){
                if(c1[v-(1<<i)]==c1[v]) pre[v]=(pre[v]+mod-pre[v-(1<<i)])%mod;
            }
        }
    }
    int ans=0;
    for(int v=0;v<(1<<n);v++){
        ans=(ans+pre[v]*inv1[v]%mod*inv1[v]%mod*v2[v]%mod*inv[popc[v]]%mod)%mod;
    }
    cout<<ans<<"\n";
}
signed main(){
    ios::sync_with_stdio(0);
    cin.tie(0),cout.tie(0);
    _pow[0]=inv[0]=1;
    for(int i=1;i<maxv;i++) popc[i]=popc[i>>1]+(i&1),_pow[i]=_pow[i-1]*2%mod,inv[i]=inv[i-1]*((mod+1)/2)%mod;
    int id,t;
    cin>>id>>t;
    while(t--) work();
    return 0;
}
```

---

## ä½œè€…ï¼šä¼Šåœ°çŸ¥è™¹å¤ (èµï¼š3)

> çœé€‰è€ƒäº†ä¸¤æ¬¡é›†åˆå¹‚çº§æ•°ï¼Œnoi æ€»ä¸èƒ½å†è€ƒäº†å§ã€‚

å“æˆ‘è‰è¿™ä¸ªé¢˜æ€ä¹ˆè¿™ä¹ˆç‰›ã€‚

ä¸‹æ–‡ä¸­å°†ä¸‹æ ‡ä¹Ÿè§†ä¸ºä¸€ä¸ª $[n]$ çš„å­é›†ã€‚

è€ƒè™‘ $f(P) = f(Q)$ çš„é™åˆ¶æ˜¯æˆ‘ä»¬ä»æœªè§è¿‡çš„ï¼Œå°è¯•å®¹æ–¥æ‰è¿™ä¸ªé™åˆ¶ã€‚

$$\begin{align*} 
[P = Q] &= \prod_{i=1}^{n} [P_i = Q_i] \\ 
        &= \prod_{i=1}^{n} (2(P_i \operatorname{and} Q_i) - P_i - Q_i + 1)\\
        &= \sum_{S \subseteq P} \sum_{T \subseteq Q} 2^{|S \cap T|}(-1)^{|S|-|S\cap T|}(-1)^{|T|-|S\cap T|}\\
        &= \sum_{S \subseteq P} \sum_{T \subseteq Q} 2^{|S \cap T|}(-1)^{|S|+|T|}\\
\end{align*}$$

åé¢é‚£ä¸ªå¼å­æœ‰å¾ˆæ˜¾ç„¶çš„ç»„åˆæ„ä¹‰ï¼ˆæ‹†æ‹¬å·ä¸éš¾çœ‹å‡ºï¼‰ã€‚

é‚£ä¹ˆç­”æ¡ˆæ˜¯ï¼šï¼ˆè®° $w(P) = \prod_{i \in P} a_i$ï¼‰

$$\begin{align*} 
&\sum_{P \cap Q = \varnothing}w(P)w(Q)\sum_{S\subseteq f(P), T\subseteq f(Q)} 2 ^ {|S\cap T|}(-1)^{|S|+|T|}
\\
&= \sum_{S,T} 2 ^ {|S\cap T|}(-1)^{|S|+|T|}\sum_{S\subseteq f(P), T\subseteq f(Q)} w(P) w(Q)
\\ 
&= \sum_{S,T} 2 ^ {|S\cap T|}(-1)^{|S|+|T|} \prod_{S \subseteq X, T \subsetneq X} (a_X + 1)
\prod_{S \subsetneq X, T \subseteq X} (a_X + 1)
\prod_{S \subseteq X, T \subseteq X} (2a_X + 1) 
\\
&= \sum_{S,T} (-2)^{|S|}(-2)^{|T|}2^{-|S\cup T|}\prod_{S \subseteq X} (a_X + 1)
\prod_{T \subseteq X} (a_X + 1)
\prod_{S \cup T \subseteq X} \dfrac{2a_X + 1}{(a_X + 1) ^ 2} 
\end{align*}$$

è®° $f(S) = (-2)^{|S|} \prod\limits_{S \subseteq X} (a_X + 1)$ï¼Œ$g(S) = 2^{-|S|}\prod\limits_{S \subseteq X} \dfrac{2a_X + 1}{(a_X + 1) ^ 2}$ã€‚

é‚£ä¹ˆç­”æ¡ˆå°±åŒ–ç®€ä¸º $A = \sum\limits_{S,T} f_Sf_Tg_{S\cup T}$ã€‚

$f,g$ å¯ä»¥ç”¨é«˜ç»´åç¼€ç§¯æ±‚å‡ºï¼Œè€Œ $A = (f\times f) \cdot g$ï¼ˆ$\times$ è¡¨ç¤ºæˆ–å·ç§¯ï¼Œ$\cdot$ è¡¨ç¤ºå‘é‡ç‚¹ä¹˜ï¼‰ï¼Œä¹Ÿå¯ä»¥ç”¨ä¸€æ¬¡æˆ–å·ç§¯æ±‚å‡ºï¼Œæ—¶é—´å¤æ‚åº¦ $\mathcal O(n2^n)$ã€‚

ä½†æ˜¯å½“ $a_X=998,244,352$ æ—¶ï¼Œ$a_X + 1$ ä¸å­˜åœ¨é€†å…ƒã€‚æ­¤æ—¶æˆ‘ä»¬å°†ä¸€ä¸ªæ•°çœ‹æˆä¸€ä¸ªå¤šé¡¹å¼ $x\times 998,244,353^k$ï¼Œä¹˜æ³•é™¤æ³•æ­£å¸¸åšï¼ŒåŠ å‡æ³•æ—¶åªä¿ç•™ $k$ è¾ƒå°çš„é‚£ä¸ªå°±æ˜¯å¯¹çš„ã€‚

ç†æ¸…æ¥šæ€è·¯åä»£ç éå¸¸å¥½å†™ï¼Œä»£ç ï¼š
```cpp
#include<bits/stdc++.h>
#define rep(i,l,r) for (int i = l; i <= r; i ++)
#define rrp(i,l,r) for (int i = l; i >= r; i --)
using namespace std;
typedef long long LL;
const int N = (1 << 20) + 5, mod = 998244353;
const int i2 = (mod + 1) / 2;

int n, U, a[N], ipw[N], pw[N], cnt[N];

inline int pls(int x, int y) { unsigned t = x + y; return min(t, t - mod); }

int Inv(int x) { return x == 1 ? 1 : 1LL * (mod - mod / x) * Inv(mod % x) % mod; }

struct mint {
  int x; LL k;
  mint (int _x = 0, LL _k = 0) : x(_x), k(_k) {}
  mint operator+(const mint &o) const {
    if (o.k > k) return *this;
    if (k > o.k) return o;
    return {pls(x, o.x), k};
  }
  mint operator-(const mint &o) const {
    if (o.k > k) return *this;
    if (k > o.k) return {(o.x > 0) * mod - o.x, o.k};
    return {pls(x, mod - o.x), k};
  }
  mint operator*(const mint &o) const {
    return {1LL * x * o.x % mod, k + o.k};
  }
  mint operator/(const mint &o) const {
    return {1LL * x * Inv(o.x) % mod, k - o.k};
  }
  friend void operator*=(mint &p, const mint &q) { p = p * q; }
};

mint f[N], g[N];

void fwt(mint *f, int t) {
  mint o = mint(t < 0 ? mod - 1 : 1);
  rep (i, 0, n-1) rep (j, 0, U) if (j >> i & 1)
    f[j] = f[j] + o * f[j ^ (1 << i)];
}

void fakemain() {
  cin >> n, U = (1 << n) - 1;
  rep (i, 0, U) cin >> a[i];
  ipw[0] = pw[0] = 1;
  rep (i, 0, U) {
    pw[i + 1] = (LL)(mod - 2) * pw[i] % mod;
    ipw[i + 1] = (LL)i2 * ipw[i] % mod;
  }
  rep (i, 0, U) {
    mint b;
    if (a[i] < mod - 1) b = a[i] + 1;
    else b = {1, 1};
    f[i] = b, g[i] = ((mint)a[i] + b) / b / b;
  }
  rep (i, 0, n-1) rep (j, 0, U) if (~j >> i & 1)
    f[j] *= f[j | (1 << i)], g[j] *= g[j | (1 << i)];
  rep (i, 0, U) {
    cnt[i] = cnt[i >> 1] + (i & 1);
    f[i] *= mint(pw[cnt[i]]);
    g[i] *= mint(ipw[cnt[i]]);
  }
  fwt(f, 1);
  rep (i, 0, U) f[i] = f[i] * f[i];
  fwt(f, -1);
  mint ans;
  rep (i, 0, U) ans = ans + f[i] * g[i];
  cout << ans.x << '\n';
  assert(ans.k == 0);
}

signed main() {
  cin.tie(0)->ios::sync_with_stdio(0);
  int O, T = 1;
  cin >> O >> T;
  while (T --) fakemain();
  cerr << 1. * clock() / CLOCKS_PER_SEC << "s\n";
  return 0;
}
```

---

## ä½œè€…ï¼šxiezheyuan (èµï¼š2)

åœºå¤–é€‰æ‰‹å¼ºåšä¸€æ³¢ã€‚

## ç®€è¦é¢˜æ„

ç»™å®š $n$ å’Œä¸€ä¸ªé•¿åº¦ä¸º $2^n$ çš„åºåˆ— $a$ï¼Œå®šä¹‰ $U=[0,2^n)\cap\mathbb{Z}$ï¼Œè®¡ç®—ï¼š

$$
\sum_{\substack{P\subseteq U,Q\subseteq U\\P\cap Q=\varnothing}} \left[\bigwedge_{k\in P} k=\bigwedge_{k\in Q}k\right]\prod_{k\in P\cup Q} a_k
$$

ç­”æ¡ˆå¯¹ $p=998,244,353$ å–æ¨¡ã€‚

$T$ ç»„æ•°æ®ã€‚$1\leq T\leq 3,2\leq n\leq 20,0\leq a_i<p$ã€‚

## æ€è·¯

### è®°å·çº¦å®š

- $\land,\lor$ åˆ†åˆ«è¡¨ç¤ºæŒ‰ä½ä¸ã€æˆ–è¿ç®—ã€‚
- $S\sqsubseteq T$ï¼Œå½“ä¸”ä»…å½“ $S\land T=S$ã€‚

ä¸‹é¢çš„è¿‡ç¨‹ä¸ºäº†é¿å…å¼•èµ·æ··ä¹±ï¼Œå°†**åŒºåˆ†**é›†åˆè¿ç®—ä¸å…³ç³» $\cup,\cap,\subseteq$ å’Œ bitmask çš„è¿ç®—ä¸å…³ç³» $\land,\lor,\sqsubseteq$ï¼Œä¸è¿‡ $|x|$ å°†åŒæ—¶è¡¨ç¤ºé›†åˆ $x$ çš„å¤§å°å’Œ bitmask $x$ çš„ popcountã€‚

### Part 1

åˆ»ç”»ä¸¤ä¸ªé›†åˆçš„æŒ‰ä½ and ç›¸ç­‰æå…¶å›°éš¾ï¼Œä¸å¦¨å®¹æ–¥ï¼Œä¸å¦¨è®¾ï¼š

$$
\begin{aligned}
&F(S,T)=\sum_{\substack{P\subseteq U,Q\subseteq U\\P\cap Q=\varnothing}} \left[\bigwedge_{k\in P} k=S,\bigwedge_{k\in Q}k=T\right]\prod_{k\in P\cup Q} a_k\\
&G(S,T)=\sum_{\substack{P\subseteq U,Q\subseteq U\\P\cap Q=\varnothing}} \left[S\sqsubseteq  \left(\bigwedge_{k\in P} k\right),T\sqsubseteq\left(\bigwedge_{k\in Q}k\right)\right]\prod_{k\in P\cup Q} a_k\\
&H(S,T)=\sum_{\substack{P\subseteq U,Q\subseteq U\\P\cap Q=\varnothing}} \left[\left(\bigwedge_{k\in P} k\right)=S,T\sqsubseteq\left(\bigwedge_{k\in Q}k\right)\right]\prod_{k\in P\cup Q} a_k
\end{aligned}
$$

é‚£ä¹ˆåˆ©ç”¨è¶…é›† / å­é›†åæ¼”ï¼Œå¯ä»¥å¾—åˆ°ï¼š

$$
\begin{aligned}
&G(S,T)=\sum_{S\sqsubseteq P}H(P,T)\implies H(S,T)=\sum_{S\sqsubseteq P} (-1)^{|P|-|S|} G(P,T)\\
&H(S,T)=\sum_{T\sqsubseteq Q} F(S,Q)\implies F(S,T)=\sum_{T\sqsubseteq Q} (-1)^{|Q|-|T|} H(S,Q)\\
&\implies F(S,T)=\sum_{S\sqsubseteq P}\sum_{T\sqsubseteq Q} (-1)^{|P|+|Q|-|S|-|T|} G(P,Q)\\
&\implies F(S,S)=\sum_{S\sqsubseteq P}\sum_{S\sqsubseteq Q} (-1)^{|P|+|Q|} G(P,Q)
\end{aligned}
$$

ç­”æ¡ˆå°±æ˜¯ï¼š
$$
\sum_{S=0}^{2^n-1}F(S,S)=\sum_{S=0}^{2^n-1}\sum_{S\sqsubseteq P}\sum_{S\sqsubseteq Q}(-1)^{|P|+|Q|} G(P,Q)=\sum_{P=0}^{2^n-1}\sum_{Q=0}^{2^n-1} (-1)^{|P|+|Q|} 2^{|P\land Q|} G(P,Q)
$$

### Part 2

è€ƒå¯Ÿ $G(S,T)$ï¼Œè®¾ $\tau(S)=\{x\mid S\sqsubseteq x,x\in U\}$ ä¹Ÿå°±æ˜¯ä½è¿ç®—æ„ä¹‰ä¸‹çš„â€œè¶…é›†â€é›†åˆã€‚

é‚£ä¹ˆå¯¹äº $\tau(A)\cap \tau(B)=\tau(A\lor B)$ é›†åˆçš„æ•°ï¼Œæ—¢å¯ä»¥æ”¾åœ¨ $P$ï¼Œä¹Ÿå¯ä»¥æ”¾åœ¨ $Q$ï¼ˆä½†æ˜¯ä¸ºäº†ç»´æŒä¸äº¤æ€§è´¨ï¼Œä¸èƒ½ä¸¤ä¸ªéƒ½ä¸æ”¾ï¼‰ï¼Œå…¶ä½™çš„åªèƒ½æ”¾åˆ°å¯¹åº”çš„é›†åˆä¸­å»ã€‚å› æ­¤å¯ä»¥ç«‹å³å†™å‡ºå¼å­ï¼š
$$
G(S,T)=\prod_{k\in \tau(S)}(1+a_k)\cdot \prod_{k\in \tau(T)}(1+a_k)\cdot \prod_{k\in\tau(S\lor T)} \frac{1+2a_k}{(1+a_k)^2}
$$
æ¢å…ƒ $f(S)=\prod_{k\in S}(1+a_k),g(S)=\prod_{k\in S} \frac{1+2a_k}{(1+a_k)^2}$ï¼Œé‚£ä¹ˆå¯ä»¥å°†ç­”æ¡ˆåŒ–ç®€ï¼š
$$
\begin{aligned}
&\sum_{P=0}^{2^n-1}\sum_{Q=0}^{2^n-1} (-1)^{|P|+|Q|} 2^{|S\land T|} G(P,Q)\\
&=\sum_{S=0}^{2^n-1}\sum_{T=0}^{2^n-1} (-1)^{|S|+|T|}2^{|S\land T|}f(\tau(S))f(\tau(T))g(\tau(S\lor T))
\end{aligned}
$$
æ³¨æ„åˆ° $|S\land T|+|S\lor T|=|S|+|T|$ï¼Œå› æ­¤å¾—åˆ°ï¼š
$$
\begin{aligned}
&\sum_{S=0}^{2^n-1}\sum_{T=0}^{2^n-1}(-1)^{|S|+|T|}2^{|S|+|T|-|S\lor T|}f(\tau(S))f(\tau(T))g(\tau(S\lor T))\\
=&\sum_{A=0}^{2^n-1}2^{-|A|}g(\tau(A))\sum_{S\lor T=A} (-2)^{|S|}f(\tau(S))\cdot (-2)^{|T|}f(\tau(T))
\end{aligned}
$$
å¯¹äº $f\circ \tau,g\circ \tau$ï¼Œå¯ä»¥çœ‹æˆé«˜ç»´åç¼€ç§¯ï¼Œåˆ©ç”¨ Sum over Subsets DP $O(n2^n)$ è®¡ç®—å‡ºæ¥ï¼Œè€ŒåŸå¼å¯ä»¥çœ‹æˆä¸€ä¸ª OR å·ç§¯çš„å½¢å¼ï¼Œä½¿ç”¨ FMT åšå³å¯ï¼Œæ—¶é—´å¤æ‚åº¦ä¹Ÿæ˜¯ $O(n 2^n)$ï¼Œæ•…æ€»æ—¶é—´å¤æ‚åº¦ $O(Tn 2^n)$ã€‚

### Part 3

ä½ ä»¥ä¸ºä½ å°±åšå®Œäº†å—ï¼Ÿä¸ï¼ç”±äºä¸ä¿è¯ $a_i\neq p-1$ï¼Œæ‰€ä»¥ $g(S)$ å¯èƒ½æ— æ„ä¹‰ã€‚è¿™æ—¶ä¸å¦¨å°†æ‰€æœ‰ $f(S)$ ä¸­çš„ $0$ å’Œ $g(S)$ é™¤æ•°ä¸­çš„ $0$ æ¢æˆä¸€ä¸ªå˜é‡ $x$ï¼Œè¿™æ ·å°±å˜æˆäº†ä¸€ä¸ªå¤šé¡¹å¼ï¼Œç…§å¸¸åšé«˜ç»´åç¼€ç§¯ä»¥åŠ FMTï¼Œé‚£ä¹ˆæˆ‘ä»¬æœ€ç»ˆä¼šå½’çº¦åˆ°ä¸‹é¢çš„ä¸€ä¸ªé—®é¢˜ï¼š
$$
\lim_{x\to 0} \frac{F(x)}{G(x)}
$$
å…¶ä¸­ $F(x),G(x)$ æ˜¯å¤šé¡¹å¼å‡½æ•°ã€‚åœ¨æœ¬é¢˜ä¸­ $F(x)$ çš„æœ€ä½æ¬¡é¡¹ä¸€å®šæ¯” $G(x)$ çš„é«˜æˆ–ç›¸ç­‰ï¼ˆå¦‚æœæ›´ä½å°±æé™ä¸å­˜åœ¨äº†ï¼Œè€Œåœ¨æœ¬é¢˜ä¸­æé™æ˜¯å­˜åœ¨çš„ï¼‰ï¼Œé‚£ä¹ˆè®¾ $G(x)$ çš„æœ€ä½æ¬¡é¡¹ä¸º $p$ï¼Œåˆ™å¯ä»¥åš $p$ æ¬¡ L'Hospital æ³•åˆ™ï¼Œå¾—åˆ°ï¼š
$$
\lim_{x\to 0} \frac{F(x)}{G(x)}=\lim_{x\to 0} \frac{F^{(p)} (x)}{G^{(p)} (x)}=\lim_{x\to 0} \frac{F^{(p)}(x)}{p!\cdot [x^p]G(x)}
$$
è‹¥ $F(x)$ çš„æœ€ä½æ¬¡é¡¹ $>p$ï¼Œé‚£ä¹ˆ $\lim_{x\to 0} F^{(p)}(x)=0$ï¼ŒåŸå¼ $=0$ï¼Œå¦åˆ™åŸå¼ $=\frac{[x^p] F(x)}{[x^p] G(x)}$ã€‚å› æ­¤å®é™…ä¸Šæˆ‘ä»¬ä¸éœ€è¦è®¡ç®—å‡ºæ•´ä¸ªå¤šé¡¹å¼ï¼Œåªéœ€è¦è®°å½•å¤šé¡¹å¼çš„æœ€ä½æ¬¡é¡¹å³å¯ï¼Œè¿™æ ·æ—¶é—´å¤æ‚åº¦ä¸å˜ã€‚

## ä»£ç 

```cpp
#include <bits/stdc++.h>
#define popcnt __builtin_popcount
using std::cin, std::cout;

constexpr int mod = 998244353, inv2 = (mod + 1) >> 1;
int A(int x, int y){ return (x + y) >= mod ? (x + y - mod) : (x + y); }
int S(int x, int y){ return (x - y) < 0 ? (x - y + mod) : (x - y); }
int M(int x, int y){ return 1ll * x * y % mod; }
int P(int x, int y){ int ans = 1; for(;y;x=M(x,x),y>>=1) if(y & 1) ans = M(ans, x); return ans; }
int I(int x){ return P(x, mod - 2); }
template<class T> int Fit(T x){ return (x % mod + mod) % mod; }

namespace solution{
    const int N = 25, N_ = (1 << 20) + 5;
    int n, a[N_];
    struct ZP {
        int val, deg;
        ZP(int v = 0, int d = 0) : val(v), deg(d) {}
        ZP operator-() const { return {S(0, val), deg}; }
        ZP operator+(const ZP& rhs) const {
            ZP res = deg < rhs.deg ? *this : rhs;
            if(deg == rhs.deg) res.val = A(val, rhs.val);
            return res;
        }
        ZP operator*(const ZP& rhs) const { return {M(val, rhs.val), deg + rhs.deg}; }
    } f[N_], g[N_];
    void solve(){
        cin >> n;
        for(int i=0;i<(1<<n);i++){
            cin >> a[i];
            if(a[i] != mod - 1){
                int p = a[i] + 1, pi = I(p);
                f[i] = {p, 0}, g[i] = {M(A(p, a[i]), M(pi, pi)), 0};
            }
            else f[i] = {1, 1}, g[i] = {mod - 1, -2};
        }
        for(int i=1;i<(1<<n);i<<=1){
            for(int j=0;j<(1<<n);j++) if(j & i) f[j ^ i] = f[j ^ i] * f[j], g[j ^ i] = g[j ^ i] * g[j];
        }
        for(int i=0;i<(1<<n);i++) f[i] = f[i] * ZP(P(mod - 2, popcnt(i))), g[i] = g[i] * ZP(P(inv2, popcnt(i)));
        for(int i=1;i<(1<<n);i<<=1){
            for(int j=0;j<(1<<n);j++) if(j & i) f[j] = f[j] + f[j ^ i];
        }
        for(int i=0;i<(1<<n);i++) f[i] = f[i] * f[i];
        for(int i=1;i<(1<<n);i<<=1){
            for(int j=0;j<(1<<n);j++) if(j & i) f[j] = f[j] + (-f[j ^ i]);
        }
        int ans = 0;
        for(int i=0;i<(1<<n);i++) if(f[i].deg == -g[i].deg) ans = A(ans, M(f[i].val, g[i].val));
        cout << ans << '\n';
    }
    void clear(){}
}

signed main(){
    std::ios::sync_with_stdio(false);
    cin.tie(nullptr), cout.tie(nullptr);
    int c, T; cin >> c >> T;
    while(T--) solution::solve(), solution::clear();
    return 0;
}

// [P_13275_NOI_2025_é›†åˆ.cpp] Think twice, code once.
// Written by xiezheyuan
```

---

## ä½œè€…ï¼šSouthern_Dynasty (èµï¼š2)

è€ƒè™‘å®¹æ–¥ã€‚æˆ‘ä»¬é’¦å®š $f(P)\subseteq x,f(Q)\subseteq y$ï¼Œè®¾è¿™ç§æƒ…å†µä¸‹çš„æƒå€¼å’Œä¸º $w_{x,y}$ï¼Œåˆ™å…¶å¯¹ç­”æ¡ˆçš„è´¡çŒ®ç³»æ•°ä¸ºï¼š

$$
\sum_{i\subseteq x \ \text{and} \ y}(-1)^{|x|-|i|+|y|-|i|}
$$

$$
=2^{|x \ \text{and} \  y|}(-1)^{|x|+|y|}
$$

å› æ­¤åªéœ€è¦å¿«é€Ÿè®¡ç®— $w_{x,y}$ã€‚å…¶å¯ä»¥å†™æˆï¼š

$$
\prod_{x\subseteq i,y \not\subseteq i}(a_i+1)\prod_{x\not\subseteq i,y \subseteq i}(a_i+1)\prod_{x\subseteq i,y \subseteq i}(2a_i+1)
$$

$$
=\prod_{x\subseteq i}(a_i+1)\prod_{y\subseteq i}(a_i+1)\prod_{x \ \text{or} \ y\subseteq i}\frac{2a_i+1}{(a_i+1)^2}
$$

è®¾å‰è€…ä¸º $f_x$ï¼Œåè€…ä¸º $g_x$ï¼Œåˆ™å¯ä»¥é«˜ç»´å‰ç¼€å’Œ $O(n2^n)$ ç»´æŠ¤ä¹‹ã€‚è€Œå¯¹äºè´¡çŒ®ç³»æ•°ï¼Œæˆ‘ä»¬æœ‰ $|x \ \text{and} \ y|=|x|+|y|-|x\ \text{or} \ y|$ï¼Œæ•…å¯ä»¥å°†ç³»æ•°æ”¾è¿› $f,g$ ä¸­ã€‚æ•…æˆ‘ä»¬åªéœ€è¦æ±‚å‡º $\sum_{x,y}f_xf_yg_{x\ \text{or} \ y}$ã€‚å³åªéœ€è¦åšä¸€é $f*f$ çš„ OR å·ç§¯å³å¯ã€‚

å‘ç° $a_i=-1$ çš„æ—¶å€™ä¹˜ç§¯ä¼šå‡ºç° $0$ï¼Œå¦‚æœä¸ä¼šå¤„ç†å°±åªèƒ½è·å¾— $68$ åˆ†ã€‚ä½†æ˜¯æ³¨æ„åˆ°ï¼Œåœ¨ FMT çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬éœ€è¦æ±‚å‡ºå­é›†å†…æ‰€æœ‰ $f$ çš„å’Œã€‚è€Œå¯¹äºè¿™äº› $f$ æ˜¾ç„¶åªæœ‰ $0$ çš„ä¸ªæ•°**æœ€å°‘**è€…å¯èƒ½æœ‰ç”¨ï¼Œå› æ­¤å°±å¯ä»¥ç»´æŠ¤äº†ã€‚å¤æ‚åº¦ $O(n2^n)$ï¼Œå¯ä»¥è·å¾— $100$ åˆ†ã€‚

---

## ä½œè€…ï¼šRainWetPeopleStart (èµï¼š0)

åœºå¤–é€‰æ‰‹ï¼Œè¿™ä¸ªé¢˜åªä¼š $O(8^n)$ã€‚

å…ˆè€ƒè™‘ä¸€ä¸ªæœ´ç´  DPï¼Œ$dp_{i,j,k}$ è¡¨ç¤ºè€ƒè™‘åˆ°ç¬¬ $i$ ä¸ªæ•°ï¼Œ$f(P)=j,f(Q)=k$ çš„ç­”æ¡ˆï¼Œè½¬ç§»æšä¸¾å½“å‰å…ƒç´ åœ¨å“ªä¸ªé›†åˆï¼Œè¿™æ ·å°±å¯ä»¥åšåˆ° $O(8^n)$ã€‚

å‘ç°ç›´æ¥ä¼˜åŒ–å¾ˆä¸å¯åšï¼Œè€ƒè™‘æŠŠåä¸¤ä½å‹æˆé›†åˆå¹‚çº§æ•°ï¼Œç”¨ $[x^jy^k]F(i)$ è¡¨ç¤º $dp_{i,j,k}$ã€‚ï¼ˆè¿™é‡ŒæŠŠ $f(P),f(Q)$ å½“ä½œé›†åˆï¼‰

æ ¹æ®é¢˜è§£ï¼Œæˆ‘ä»¬ç»§ç»­å¾€ä¸‹åšã€‚

ä¸‹æ–‡ç”¨é›†åˆçš„å½¢å¼è¡¨ç¤º $a$ çš„ä¸‹æ ‡ï¼Œå¹¶è®° $U=\{1,2,\dots ,n\},2^U=\{S|S\subseteq U\}$ã€‚

å‘ç°ä¸Šæ–‡çš„è½¬ç§»æ˜¯ and å·ç§¯çš„å½¢å¼ï¼Œç”¨ and å·ç§¯è¡¨ç¤º $F(2^n-1)$ï¼Œå³ $\prod\limits_{S\in 2^U}(a_Sx^S+a_Sy^S+1)$ã€‚ï¼ˆè¿™é‡Œä¹˜æ³•æ˜¯ and å·ç§¯ï¼‰

å¯¹äº and å·ç§¯è€Œè¨€ï¼Œè€ƒè™‘ FMTï¼Œè¿™é‡Œçš„ FMT å°±ç›¸å½“äºå¯¹ $x,y$ åŒæ—¶åšé«˜ç»´åç¼€å’Œã€‚

å› ä¸ºåˆå§‹åªæœ‰ $x^Uy^U$ æ¬¡é¡¹æ˜¯ $1$ï¼Œæ‰€ä»¥åšå®Œ FMT åç‚¹å€¼çš„æ¯ä¸€é¡¹éƒ½æ˜¯ $1$ã€‚

ç”±æ­¤ï¼Œæœ€åç‚¹å€¼çš„ $x^Sy^T$ æ¬¡é¡¹åº”ä¸º $\prod\limits_{P\in 2^U}(a_P([S\subseteq P]+[T\subseteq P])+1)$ã€‚

å‘ç°é‡Œé¢çš„å¼å­åŒæ—¶å’Œ $S,T$ æœ‰å…³ï¼Œè€ƒè™‘æ‹†è´¡çŒ®ï¼Œå¯¹ $a_P$ çš„ç³»æ•°åˆ†ç±»è®¨è®ºï¼Œå‘ç° $a_P$ ç³»æ•°ä¸º $1$ æ—¶æ°æˆç«‹ä¸€ä¸ªä¸å¥½åˆ»ç”»ã€‚

è€ƒè™‘å®¹æ–¥ï¼Œä»¥ $[S\subseteq P][T\nsubseteq P]$ ä¸ºä¾‹ï¼Œå¯ä»¥æŠŠ $T$ çš„é™åˆ¶æ‹†æ‰ï¼Œå˜ä¸º $[S\subseteq P](1-[T\subseteq P])$ï¼Œå³ $[S\subseteq P]-[(S \cup T)\subseteq P]$ã€‚

å‘ç°å³è¾¹çš„ä¸œè¥¿å°±æ˜¯ $a_P$ çš„ç³»æ•°ä¸º $2$ çš„å……è¦æ¡ä»¶ï¼Œç„¶åå°±èƒ½åšäº†ã€‚

å…·ä½“çš„ï¼Œå…ˆè€ƒè™‘ $a_P$ ç³»æ•°ä¸º $1$ çš„è´¡çŒ®ï¼Œç”±ä¸Šæ–‡ï¼Œè¿™ä¸€éƒ¨åˆ†çš„è´¡çŒ®æ˜¯ $\dfrac{\prod\limits_{S\subseteq P}(a_P+1)\prod\limits_{T\subseteq P}(a_P+1)}{\prod\limits_{(S\cup T)\subseteq P}(a_P+1)^2}$ã€‚

ç„¶åæ˜¯ $a_P$ ç³»æ•°ä¸º $2$ï¼Œå³ $\prod\limits_{(S\cup T)\subseteq P}(2a_P+1)$ã€‚

æ•´ç†ä¸€ä¸‹ï¼Œè®° $A_S=\prod\limits_{S\subseteq P}\dfrac{2a_P+1}{(a_P+1)^2},B_S=\prod\limits_{S\subseteq P}(a_P+1)$ï¼Œåˆ™æœ€å $x^Sy^T$ é¡¹çš„ç‚¹å€¼ä¸º $B_SB_TA_{S\cup T}$ã€‚

å†è€ƒè™‘ç‚¹å€¼æ˜¯å¦‚ä½•è´¡çŒ®åˆ°ç­”æ¡ˆçš„ï¼Œå‘ç°åšå®Œ IFMT ååªæœ‰å½¢å¦‚ $x^Sy^S$ çš„é¡¹èƒ½è´¡çŒ®åˆ°ç­”æ¡ˆã€‚

è¿™å¯ç¤ºæˆ‘ä»¬è€ƒè™‘ç‚¹å€¼çš„ $x^{T1}y^{T2}$ æ¬¡é¡¹å¯¹ $x^Sy^S$ çš„è´¡çŒ®ç³»æ•°ï¼Œå› ä¸ºåœ¨ IFMT æ—¶ï¼Œ$|T1|,|T2|$ æ¯å˜åŒ– $1$ å°±è¦ä¹˜ä¸Š $-1$ çš„ç³»æ•°ï¼Œæ‰€ä»¥è´¡çŒ®ç³»æ•°ä¸º $[S\subseteq T1][S\subseteq T2](-1)^{|T1|-|S|+|T2|-|S|}=[S\subseteq(T1\cap T2)](-1)^{|T1|+|T2|}$ã€‚

å› ä¸º $(-1)^{|T1|+|T2|}$ ä¸ $S$ æ— å…³ï¼Œå›ºå®š $T1,T2$ï¼Œæ»¡è¶³æ¡ä»¶çš„ $S$ åªæœ‰ $2^{|T1\cap T2|}$ ä¸ªï¼Œæ‰€ä»¥ç‚¹å€¼çš„ $x^Sy^T$ é¡¹å¯¹ç­”æ¡ˆçš„è´¡çŒ®ä¸º $B_SB_TA_{S\cup T}2^{|S\cap T|}(-1)^{|S|+|T|}$ã€‚

ç„¶åæ‹†æˆåªä¸ $S,T,S\cup T$ æœ‰å…³çš„é¡¹ï¼Œå³ $B_SB_TA_{S\cup T}\dfrac{2^{|S|}2^{|T|}}{2^{|S \cup T|}}(-1)^{|S|}(-1)^{|T|}$ã€‚

æ¥ä¸‹æ¥é—®é¢˜å°±ç›¸å½“äºè®¡ç®— $\sum\limits_{S\in 2^U}\sum\limits_{T\in 2^U}B_SB_TA_{S\cup T}\dfrac{2^{|S|}2^{|T|}}{2^{|S \cup T|}}(-1)^{|S|}(-1)^{|T|}$ã€‚

æšä¸¾ $S\cup T$ï¼ŒåŸå¼å˜ä¸º $\sum\limits_{S\cup T=P}\dfrac{A_P}{2^{|P|}}(\sum\limits_S(-1)^{|S|}2^{|S|}B_S(-1)^{|T|}2^{|T|}B_T)$ã€‚

åªéœ€è¦å¯¹å³è¾¹åšæˆ–å·ç§¯å³å¯ã€‚

å¯¹äº $a_P=998244352$ï¼Œæˆ‘ä»¬ç»´æŠ¤å‡ºç°äº†å‡ ä¸ª $a_P+1=998244353$ï¼Œå³ç”¨ $a\times 998244353^b$ æ¥è¡¨ç¤ºä¸€ä¸ªæ•°ã€‚

æ±‚ç­”æ¡ˆæ—¶åªéœ€åˆ¤æ–­ $b=0$ï¼Œå› ä¸ºæˆ‘ä»¬å¯ä»¥è¯´æ˜æ­¤æ—¶ $b\ge 0$ï¼Œå› æ­¤åšåŠ å‡æ³•æ—¶åªä¿ç•™ $b$ ç»å¯¹å€¼æœ€å°çš„å³å¯ã€‚

æ€»å¤æ‚åº¦ $O(n2^n)$ã€‚

---

## ä½œè€…ï¼š_lmh_ (èµï¼š0)

æœ¬æ–‡ä¸­å°†ä¸‹æ ‡çš„æ¯ä¸€ä¸ªäºŒè¿›åˆ¶ä½å–åï¼Œå°†æŒ‰ä½ä¸è¿ç®—æ”¹æˆæŒ‰ä½æˆ–è¿ç®—â€”â€”å®¹æ˜“å‘ç°è¿™å’ŒåŸé—®é¢˜ç­‰ä»·ã€‚åŒæ—¶ï¼Œä¸å†åŒºåˆ†äºŒè¿›åˆ¶æ•°å’Œé›†åˆã€‚

é¦–å…ˆè€ƒè™‘ B æ€§è´¨æ€ä¹ˆåšã€‚æ˜¾ç„¶ç­”æ¡ˆä¸º

$$\sum_{s=0}^{2^n-1}([x^sy^s]\prod_{i=0}^{2^n-1}(1+a_ix^i+a_iy^i))$$

å…¶ä¸­ $x,y$ ä¸¤ç»´å‡ä¸º or å·ç§¯ã€‚

ä»¤ $F=\prod_{i=0}^{2^n-1}(1+a_ix^i+a_iy^i)$ã€‚

å…ˆå¯¹ $(1+a_ix^i+a_iy^i)$ è¿›è¡Œ FWTï¼Œå¾—åˆ° $\sum_{u=0}^{2^n-1}\sum_{v=0}^{2^n-1}(1+[i\subseteq u]a_i+[i\subseteq v]a_i)x^uy^v$ã€‚ä¹‹åæŒ‰ä½ä¹˜èµ·æ¥ï¼Œå¾—åˆ°

$$[x^uy^v]FWT(F)=\prod_{i=0}^{2^n-1}(1+[i\subseteq u]a_i+[i\subseteq v]a_i)$$

ä»¤ $f_s=\prod_{i\subseteq s}(1+a_i),g_s=\prod_{i\subseteq s}(1+2a_i)$ï¼Œåˆ™

$$[x^uy^v]FWT(F)=f_uf_v\frac{g_{u\cap v}}{f_{u\cap v}^2}$$

åˆ™ç­”æ¡ˆç­‰äº

$$\sum_{s=0}^{2^n-1}\sum_{u,v\subseteq s}(-1)^{2|s|-|u|-|v|}f_uf_v\frac{g_{u\cap v}}{f_{u\cap v}^2}$$

å°† $(-1)^{2|s|-|u|-|v|}=(-1)^{|u|+|v|}$ æ‹†åˆ° $f$ é‡Œé¢ï¼ŒåŒæ—¶å°† $g_u$ é™¤ä»¥ $f_u^2$ï¼Œåˆ™ç­”æ¡ˆç­‰äº

$$\sum_{s=0}^{2^n-1}\sum_{u,v\subseteq s}f_uf_vg_{u\cap v}=\sum_{u,v}f_uf_vg_{u\cap v}2^{n-|u\cup v|}$$

å°† $2^{n-|u\cup v|}$ æ‹†æˆ $2^{-u}2^{-v}2^{n+|u\cap v|}$ï¼ˆè¿™æ˜¯æœ€éš¾çš„ä¸€æ­¥ï¼‰ï¼Œåˆ™åŸå¼åªå’Œ $u,v,u\cap v$ æœ‰å…³ï¼Œå¯ä»¥ç›´æ¥ FWT åšã€‚

æ²¡æœ‰ç‰¹æ®Šæ€§è´¨çš„æ—¶å€™ï¼Œ$f$ çš„é€†å…ƒå¯èƒ½ä¸å­˜åœ¨ã€‚æ­¤æ—¶è€ƒè™‘æ‰©åŸŸï¼Œå°† $f$ è¡¨ç¤ºä¸º $f'\cdot MOD^{f^\star}$ï¼ŒFWT æ—¶åªè½¬ç§» $f^\star$ ç›¸åŒçš„ä½ç½®ï¼Œå°±æ˜¯å¯¹çš„â€”â€”å¦‚æœä¸€ä¸ªä½ç½®å’Œå¦ä¸€ä¸ªä½ç½®çš„ $f^\star$ ç›¸åŒï¼Œé‚£ä¹ˆè½¬ç§»è·¯å¾„ä¸Šæ¯ä¸ªä½ç½®çš„ $f^\star$ éƒ½ç›¸åŒã€‚

---


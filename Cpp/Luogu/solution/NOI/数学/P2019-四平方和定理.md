# 四平方和定理

## 题目描述

对于正整数 $n$，请求出有多少个有序整数对 $(a,b,c,d)$，使得 $a^2+b^2+c^2+d^2=n$。答案对 $10^9+7$ 取模。

## 说明/提示

| 测试点编号 | 限制 |  
| :-----------: | :-----------: | 
| $1\sim 3$ |  $n\le 2\times 10^5$ |  
| $4\sim 6$ |  $n\le 10^{12}$ |  
| $7\sim 10$ |  无 |  

对于所有数据，$1\le n\le 10^{18},1\le T\le 50$。

对于样例一的第一组数据，以下均为符合题意的 $(a,b,c,d)$（此处没有列出所有可行的数对）。

$$(1,1,1,1),(1,1,1,-1),(-1,-1,-1,-1),(2,0,0,0),(0,-2,0,0)$$






## 样例 #1

### 输入

```
10
4
1000
200000
802241960520
999999999937
49770428644836900
250000006000000027
729021870143100133
900000000000000017
907000000000033559```

### 输出

```
24
3744
93744
59948653
999943511
821944886
26
729842040
600000501
152276389```

# 题解

## 作者：WorldMachine (赞：28)

太长不看版：答案为 $8\sum\limits_{d\mid n,4\nmid d}d$，这个结论你找规律也可以得到。

---

由于证明过于复杂，这里只简单提一下，不过确实想学模形式了。

设 $f(n,k)$ 表示将 $n$ 拆成 $k$ 个整数的平方和的方案数，有：
$$
f(n,k+l)=\sum_{i=0}^nf(i,k)f(n-i,l)
$$
构造母函数 $\theta_k(x)=\sum\limits_{n=0}^{+\infty}f(n,k)\text{e}^{2\pi\text{i}nx}$，可得 $\theta_{k+l}(x)=\theta_k(x)\theta_l(x)$，因此 $\theta_k(x)=\theta_1^n(x)$。

枚举平方数，有 $\theta_1(x)=\sum\limits_{d\in\mathbb Z}\text{e}^{2\pi\text{i}d^2x}$，由 Poisson 求和：
$$
\sum_{n=-\infty}^{+\infty}\bar f(x)=\sum_{l=-\infty}^{+\infty}\prime g(l)
$$
其中 $\bar f(x)$ 表示 $\dfrac12\left(\lim\limits_{t\rightarrow x^+}f(t)+\lim\limits_{t\rightarrow x^-}f(t)\right)$，$\sum\prime$ 表示级数取主值，$g$ 定义如下：
$$
g(x)=\sum_{n=-\infty}^{+\infty}f(n)\text{e}^{-2\pi\text{i}nx}
$$
可以得到：
$$
\theta_1\left(-\dfrac{1}{4x}\right)=\sqrt{-2\text{i}x}\theta(x)
$$
再由 $\theta_4(x)=\theta_1^4(x)$ 可得：
$$
\theta_4\left(\dfrac{x}{1+4x}\right)=(1+4x)^2\theta_4(x)
$$
同时 $\theta_4(x)$ 具有周期 $1$，且其在上半平面 $\mathbb H$ 和无穷远处全纯，即 $\theta_4$ 是群 $\Gamma=\left\langle\left[\begin{matrix}1&1\\0&1\end{matrix}\right],\left[\begin{matrix}1&0\\4&1\end{matrix}\right]\right\rangle$ 的权为 $2$ 的模形式，记满足条件的函数的集合为 $\mathcal M_2(\Gamma)$，其为一复向量空间，其维度为 $2$，其一组基为：
$$
\begin{aligned}
G_{2,2}(x)&=-\dfrac{\pi^2}{3}\left(1+24\sum_{n=1}^{+\infty}\sum_{d\mid n,2\nmid d}d\text{e}^{2\pi\text{i}nx}\right)\\
G_{2,4}(x)&=-\pi^2\left(1+8\sum_{n=1}^{+\infty}\sum_{d\mid n,4\nmid d}d\text{e}^{2\pi\text{i}nx}\right)
\end{aligned}
$$
那么有：
$$
\theta_4(x)=aG_{2,2}(x)+bG_{2,4}(x)
$$
比较系数可得 $a=0,b=-\dfrac{1}{\pi^2}$，故 $\theta_4(x)=1+8\sum\limits_{n=1}^{+\infty}\sum\limits_{d\mid n,4\nmid d}d\text{e}^{2\pi\text{i}nx}$，故 $f(n,4)=8\sum\limits_{d\mid n,4\nmid d}d$。

上面的推导通过模形式将原问题转化成了求解复向量空间的一组基，可以拓展到 $f(n,k)$ 的情况，不过寻找这组基又是另外一回事了。

---

## 作者：2022dyx (赞：12)

2025.8.6 upd：修改了打错的公式。

---

这是一道非常强大的数学题，虽然打表找规律是容易的，但严格的证明却很难。由于目前题解区只有一篇基于模形式的推导，而蒟蒻苦学无果后，看到知乎上有一个纯 OGF 推式子的做法，打算详细总结整理下来，方便像我这样的蒟蒻食用，于是就有了这篇题解。

---

首先肯定要先写出答案的 OGF，根据基础的 OGF 知识，不难写出：
$$ans=[x^n](\sum_{i=-\infin}^{\infin}x^{i^2})^4$$
容易发现最大的问题就是 $\sum$ 外面还要四次幂，暴力展开显然是不可行的，因此一个方法是将 $\sum$ 转化成更好处理的 $\prod$，这样就能把四次幂放到 $\prod$ 里面，之后再想办法将 $\prod$ 换回 $\sum$ 就能求出答案。

按照上面的步骤，首先要选取一个带有形如 $x^{i^2}$ 项的恒等式来转化，因此我们选取一个著名的组合恒等式：
$$
\begin{aligned}
\prod_{i=1}^{\infin}(1+kx^{2i-1})(1+k^{-1}x^{2i-1})(1-x^{2i})=\sum_{i=-\infin}^{\infin}k^ix^{i^2}
\end{aligned}
$$
下面我们来证明它。由于左式中 $k$，$k^{-1}$ 同时出现在前两项中，所以我们设：
$$f_{m}(k)=\prod_{i=1}^m(1+kx^{2i-1})(1+k^{-1}x^{2i-1})$$
此时显然 $k$ 和 $k^{-1}$ 的系数是相同的，我们设这个系数为 $a_j$，则有：
$$\prod_{i=1}^m(1+kx^{2i-1})(1+k^{-1}x^{2i-1})=\sum_{i=0}^{m}a_i(k^i+k^{-i})$$
观察 $k^m$ 和 $k^{-m}$ 项的系数，不难发现这个值为 $x^{1+2+...+2m-1}=x^{m^2}$，因此我们有 $a_m=x^{m^2}$，之后考虑如何递推，我们只要代入 $f_m(kx^2)$，就可以错开一位，进而求出递推式，此时左式有：
$$
\begin{aligned}
f_m(kx^2)&=\prod_{i=1}^m(1+kx^{2i+1})(1+k^{-1}x^{2i-3})\\
&=\frac{1+kx^{2m+1}}{1+kx}\prod_{i=1}^m(1+kx^{2i-1})\frac{1+k^{-1}x^{-1}}{1+k^{-1}x^{2m-1}}\prod_{i=1}^m(1+k^{-1}x^{2i-1})\\
&=\frac{1+kx^{2m+1}}{kx+x^{2m}}\prod_{i=1}^m(1+kx^{2i-1})(1+k^{-1}x^{2i-1})
\end{aligned}$$
即 $(kx+x^{2m})f_m(kx^2)=(1+kx^{2m+1})f_m(k)$，此时我们再将这个关系带入右式就可以得到递推关系，有：
$$
\begin{aligned}
[k^i](kx+x^{2m})\sum_{i=0}^ma_i((kx^2)^i+(kx^2)^{-i})&=[k^i](1+kx^{2m+1})\sum_{i=0}^ma_i(k^i+k^{-i})\\
x^{2(m+i)}a_i+x^{2i-1}a_{i-1}&=a_i+x^{2m+1}a_{i-1}\\
a_{i-1}&=\frac{1-x^{2(m+i)}}{x^{2i-1}(1-x^{2(m-i+1)})}a_i
\end{aligned}
$$
转通项公式是容易的，我们有：
$$
\begin{aligned}
a_i&=x^{2^m}\prod_{j=i+1}^{m}\frac{1-x^{2(m+j)}}{x^{2j-1}(1-x^{2(m-j+1)})}\\
&=\frac{\prod_{j=1}^mx^{2j-1}}{\prod_{j=i+1}^mx^{2j-1}}\frac{\prod_{j={i+1}}^m(1-x^{2(m+j)})}{\prod_{j=i+1}^{m}(1-x^{2(m-j+1)})}\\
&=x^{i^2}\frac{\prod_{j={m+i+1}}^{2m}(1-x^{2j})}{\prod_{j=1}^{m-i}(1-x^{2j})}
\end{aligned}
$$
不要忘了我们的目标，现在我们把 $(1-x^{2i})$ 塞回去，我们就有：
$$
\begin{aligned}
b_i&=a_i\prod_{j=1}^m(1-x^{2j})\\
&=x^{i^2}\frac{\prod_{j=1}^{m}(1-x^{2j})}{\prod_{j=1}^{m-i}(1-x^{2j})}\prod_{j={m+i+1}}^{2m}(1-x^{2j})\\
&=x^{i^2}\prod_{j=m-i+1}^m(1-x^{2j})\prod_{j={m+i+1}}^{2m}(1-x^{2j})
\end{aligned}
$$
当 $m$ 趋于 $+\infin$ 时，后面的两个 $\prod$ 只要位于收敛半径内就一定会趋向于 $1$，因此有：
$$\lim_{m\to\infin}b_i=x^{i^2}$$
带回到原式中，就有：
$$
\begin{aligned}
\prod_{i=1}^{\infin}(1+kx^{2i-1})(1+k^{-1}x^{2i-1})(1-x^{2i})&=\sum_{i=0}^{\infin}x^{i^2}(k^i+k^{-i})\\
&=\sum_{i=-\infin}^{\infin}k^ix^{i^2}
\end{aligned}
$$
因此 $(1)$ 式成立。

在进行下一步之前，我们先把接下来的证明过程中会反复用到的式子整理在这里：
$$
\begin{align}
\prod_{i=1}^{\infin}(1+kx^{2i-1})(1+k^{-1}x^{2i-1})(1-x^{2i})&=\sum_{i=-\infin}^{\infin}k^ix^{i^2}\\
(1+x^i)(1-x^i)&=1-x^{2i}\\
\prod_{i=1}^{\infin}(1\pm x^{2i-1})(1\pm x^{2i})&=\prod_{i=1}^{\infin}(1\pm x^i)
\end{align}
$$
后两个式子成立是显然的，$(2)$ 式是平方差公式，$(3)$ 式是 $(2\mathbb{Z}^+-1)\cup(2\mathbb{Z}^+)=\mathbb{Z}^+$。通过这两个式子，我们可以将 $\prod(1\pm x^i)$、$\prod(1\pm x^{2i-1})$、$\prod(1-x^{2i})$ 关联起来进行推导。

注意到直接将 $k=1$ 带入 $(1)$ 式中后，左式会出现一个 $(1+x^{2i-1})^2$，而 $x^{2i-1}$ 并不好处理，硬上公式就要和 $x^{4i}$ 打交道了，所以我们不这么做，而是带入 $k=-1$，此时就只有可以用 $(2)$ 式直接化简的式子了，只要化简之后做一个 $x\to-x$ 的换元即可得到答案，于是我们有：
$$
\begin{aligned}
(\sum_{i=-\infin}^{\infin}(-1)^ix^{i^2})^4&=\prod_{i=1}^{\infin}((1-x^{2i-1})^2(1-x^{2i}))^4\\
&=\prod_{i=1}^{\infin}(\frac{(1-x^i)^2}{1-x^{2i}})^4\\
&=\prod_{i=1}^{\infin}(\frac{1-x^i}{1+x^i})^4
\end{aligned}
$$
这看起来好多了，但是还是不能直接得到答案，我们还需要进一步的转化。上面我们好不容易证明的 $(1)$ 式显然不只有这一点用，所以接下来我们要靠 $(1)$ 式的变形来得到这个形式。为了尽可能多的 $1-x^i$ 和 $1+x^i$，以及后面式子的简便，我们带入 $k=-k^2x^{\frac{1}{2}}$，$x=x^{\frac{1}{2}}$，进行一些化简，则有：
$$
\begin{aligned}
\prod_{i=1}^{\infin}(1-k^2x^i)(1-k^{-2}x^{i-1})(1-x^i)&=\sum_{i=-\infin}^{\infin}(-1)^ik^{2i}x^{\frac{i(i+1)}{2}}\\
(1-k^{-2})\prod_{i=1}^{\infin}(1-k^2x^i)(1-k^{-2}x^i)(1-x^i)&=\sum_{i=-\infin}^{\infin}(-1)^ik^{2i}x^{\frac{i(i+1)}{2}}\\
(k-k^{-1})\prod_{i=1}^{\infin}(1-k^2x^i)(1-k^{-2}x^i)(1-x^i)&=\sum_{i=-\infin}^{\infin}(-1)^ik^{2i+1}x^{\frac{i(i+1)}{2}}
\end{aligned}
$$
此时设左式中的积式为 $f(k)$，如果想要直接带入 $k=1$，无论 $f(k)$ 等于多少，$(k-k^{-1})=0$ 会直接让左式为 $0$，把我们要的形式消掉，肯定是不行的。但我们注意到 $k=1$ 时左式导数的形式非常好看，因为 $(k-k^{-1})f'(x)$ 在带入 $k=1$ 时会直接等于 $0$，那就只会剩下 $(k-k^{-1})'f(x)=(1+k^{-2})f(x)=2f(x)$ 了，右侧也同样求导并带入 $k=1$ 后，我们就有：
$$\prod_{i=1}^{\infin}(1-x^i)^3=\frac{1}{2}\sum_{i=\infin}^{\infin}(-1)^i(2i+1)x^{\frac{i(i+1)}{2}}$$
为了凑出最后的四次方，仅仅停在这里肯定还不行。由于目前唯一更改 $1-x^i$ 的次数的方法就是运用 $(1)$ 式来获得更多无穷乘积，因此我们一定需要对目前看起来还没有开发完全的右式变形后再运用 $(1)$ 式来凑四次方。目前右式的复杂程度还不够调整到需要的形式，同时也为了增大次数，我们等式两边平方，有：
$$\prod_{i=-\infin}^{\infin}(1-x^i)^6=\frac{1}{4}\sum_{i,j=-\infin}^{\infin}(-1)^{i+j}(2i+1)(2j+1)x^{\frac{i(i+1)+j(j+1)}{2}}$$
$(-1)^{i+j}$ 也是一个麻烦事，因此需要对其分讨，设右式为 $R$，于是有：
$$R=\frac{1}{4}(\sum_{2\mid i+j}(2i+1)(2j+1)x^{\frac{i(i+1)+j(j+1)}{2}}-\sum_{2\nmid i+j}(2i+1)(2j+1)x^{\frac{i(i+1)+j(j+1)}{2}})$$
此时 $i$ 和 $j$ 完全混在了一起，而我们又没有二元的恒等式，因此第一要务就是分开它们。而且 $\sum$ 下的约束也不太自然，为了解决这些问题，就有了下面的换元：
$$R=\frac{1}{4}(\sum_{2\mid(s+t)+(s-t)}(2(s+t)+1)(2(s-t)+1)x^{\frac{(s+t)(s+t+1)+(s-t)(s-t+1)}{2}}-\sum_{2\nmid(t+s)+(t-s-1)}(2(t+s)+1)(2(t+s-1)+1)x^{\frac{(t+s)(t+s+1)+(t-s-1)(t-s)}{2}}）$$
此时 $\sum$ 下的约束已经变成了废话，$i$ 和 $j$ 混在一起的乘积项也配成了平方差，可以分开，再做一些化简工作就有：
$$
\begin{aligned}
R&=\frac{1}{4}(\sum_{s,t=-\infin}^{\infin}((2s+1)^2-(2t)^2)x^{s(s+1)+t^2}-\sum_{s,t=-\infin}^{\infin}((2t)^2-(2s-1)^2)x^{s(s+1)+t^2})\\
&=\frac{1}{2}\sum_{s,t=-\infin}^{\infin}((2s+1)^2-(2t)^2)x^{s(s+1)+t^2}\\
&=\frac{1}{2}(\sum_{s=-\infin}^{\infin}(2s+1)^2x^{s(s+1)}\sum_{t=-\infin}^{\infin}x^{t^2}-\sum_{s=-\infin}^{\infin}x^{s(s+1)}\sum_{t=-\infin}^{\infin}(2t)^2x^{t^2})\\
&=\frac{1}{2}(\sum_{i=-\infin}^{\infin}(2i+1)^2x^{i(i+1)}\sum_{i=-\infin}^{\infin}x^{i^2}-\sum_{i=-\infin}^{\infin}x^{i(i+1)}\sum_{i=-\infin}^{\infin}(2i)^2x^{i^2})
\end{aligned}
$$
现在就很像是 $(1)$ 式的形式了，$x^{i^2}$ 自不必说，$x^{i(i+1)}$ 也可以通过带入 $k=x$ 来使用，问题就在只剩下了让 $x$ 的幂次前的系数消失。乍一看很棘手，其实仔细观察就会发现，前面的系数都能通过后面的次数的常数倍再加上常数来表示。具体地，我们有 $(2i+1)^2=4i(i+1)+1$，$(2i)^2=4i^2$，这就提醒了我们使用 $x\mathrm{D}$ 算符来让次数下来，其中 $\mathrm{D}$ 为微分算符。也就是说，我们有：
$$R=\frac{1}{2}((1+4x\mathrm{D})\sum_{i=-\infin}^{\infin}x^{i(i+1)}\sum_{i=-\infin}^{\infin}x^{i^2}-\sum_{i=-\infin}^{\infin}x^{i(i+1)}(4x\mathrm{D})\sum_{i=-\infin}^{\infin}x^{i^2})$$
之后就可以直接套 $(1)$ 式化简了，有：
$$
\begin{aligned}
R&=\frac{1}{2}((1+4x\mathrm{D})2\prod_{i=1}^{\infin}(1+x^{2i})^2(1-x^{2i})\times\prod_{i=1}^{\infin}(1+x^{2i-1})^2(1-x^{2i})-2\prod_{i=1}^{\infin}(1+x^{2i})^2(1-x^{2i})\times(4x\mathrm{D})\prod_{i=1}^{\infin}(1+x^{2i-1})^2(1-x^{2i}))\\
&=(1+8\sum_{i=1}^{\infin}\frac{2ix^{2i}}{1+x^{2i}}-4\sum_{i=1}^{\infin}\frac{2ix^{2i}}{1-x^{2i}})\prod_{i=1}^{\infin}(1+x^{2i})^2(1+x^{2i-1})^2(1-x^{2i})^2-(8\sum_{i=1}^{\infin}\frac{(2i-1)x^{2i-1}}{1+x^{2i-1}}-4\sum_{i=1}^{\infin}\frac{2ix^{2i}}{1-x^{2i}})\prod_{i=1}^{\infin}(1+x^{2i})^2(1+x^{2i-1})^2(1-x^{2i})^2\\
&=(1+8\sum_{i=1}^{\infin}(\frac{2ix^{2i}}{1+x^{2i}}-\frac{(2i-1)x^{2i-1}}{1+x^{2i-1}}))\prod_{i=1}^{\infin}(1+x^{2i})^2(1+x^{2i-1})^2(1-x^{2i})^2\\
&=(1+8\sum_{i=1}^{\infin}(\frac{2ix^{2i}}{1+x^{2i}}-\frac{(2i-1)x^{2i-1}}{1+x^{2i-1}}))\prod_{i=1}^{\infin}(1-x^i)^2(1+x^i)^4
\end{aligned}
$$
即：
$$
\begin{aligned}
\prod_{i=-\infin}^{\infin}(1-x^i)^6&=(1+8\sum_{i=1}^{\infin}(\frac{2ix^{2i}}{1+x^{2i}}-\frac{(2i-1)x^{2i-1}}{1+x^{2i-1}}))\prod_{i=1}^{\infin}(1-x^i)^2(1+x^i)^4\\
\prod_{i=1}^{\infin}(\frac{1-x^i}{1+x^i})^4&=1+8\sum_{i=1}^{\infin}(\frac{2ix^{2i}}{1+x^{2i}}-\frac{(2i-1)x^{2i-1}}{1+x^{2i-1}})
\end{aligned}
$$
看起来非常接近我们的目标了，接下来有：
$$(\sum_{i=-\infin}^{\infin}(-1)^ix^{i^2})^4=\prod_{i=1}^{\infin}(\frac{1-x^i}{1+x^i})^4=1+8\sum_{i=1}^{\infin}(\frac{2ix^{2i}}{1+x^{2i}}-\frac{(2i-1)x^{2i-1}}{1+x^{2i-1}})$$
别忘了取 $x=-x$，我们总算有答案的一个表达式了！接下来的部分就没什么特别的了，纯粹是 OGF 基本功，其实还是在用无穷求和中 $\mathbb{Z^+}$，$\mathbb{2Z^+}$ 和 $\mathbb{4Z^+}$ 间的关系化简，总之我们有：
$$
\begin{aligned}
ans=[x^n](\sum_{i=-\infin}^{\infin}x^{i^2})^4&=[x^n](1+8\sum_{i=1}^{\infin}(\frac{2ix^{2i}}{1+x^{2i}}+\frac{(2i-1)x^{2i-1}}{1-x^{2i-1}}))\\
&=[x^n](1+8\sum_{i=1}^{\infin}(\frac{2ix^{2i}}{1+x^{2i}}+\frac{ix^i}{1-x^i}-\frac{2ix^{2i}}{1-x^{2i}}))\\
&=[x^n](1+8\sum_{i=1}^{\infin}\frac{ix^i}{1-x^i}+8\sum_{i=1}^{\infin}(\frac{2ix^{2i}}{1+x^{2i}}-\frac{2ix^{2i}}{1-x^{2i}}))\\
&=[x^n](1+8\sum_{i=1}^{\infin}\frac{ix^i}{1-x^i}-8\sum_{i=1}^{\infin}\frac{4ix^{4i}}{1-x^{4i}})\\
&=[x^n](1+8\sum_{i\ge1,4\nmid i}\frac{ix^i}{1-x^i})\\
\end{aligned}
$$
观察展开式，有：
$$\frac{1}{1-x^i}=\sum_{j=1}^{\infin}x^{ij}$$
也就是说，只有 $i\mid n$ 时才会对答案有 $i$ 的贡献，因此我们终于能写出答案的一个可计算的式子了！答案就是：
$$ans=\sum_{i\mid n,4\nmid i}i$$

---

## 作者：Galois_Field_1048576 (赞：11)

那我问你，为什么是**四平方和**不是**三平方和**。我们来回顾二平方和问题时使用的工具：复数。Gauß 整数 $\mathbb Z[\mathrm i]$ 是唯一分解环，而每个质数的分解诱导出 $2$ 或 $4$ 个分解；自然地，我们会将这个定义尝试推广到**四元数**上。至此，明确本文记号：

**定义.** 四元数是形如
$$
z = a + b \mathrm i + c \mathrm j + d \mathrm k
$$
的形式记号，附加关系
$$
\mathrm i^2 = \mathrm j^2 = \mathrm k^2 = \mathrm {ijk} = -1,
$$
所给出的**非交换**环，记作 $\mathbb H$。

类似复数，定义四元数的范数：
$$
|z| ^2 = a^2 + b^2 + c^2 + d^2.
$$
再定义共轭：
$$
\overline z = a - b \mathrm i - c \mathrm j - d \mathrm k.
$$
那么我们能类似复数地考虑 $z^{-1}$：
$$
z^{-1} = \dfrac{\overline z}{|z|^2}.
$$

让我们开始吧！

为了编码 $N(z) = a^2 + b^2 + c^2 + d^2$，自然的方法是取 **Lipschitz 整四元数**
$$
L = \mathbb Z + \mathbb Z \mathrm i + \mathbb Z \mathrm j + \mathbb Z \mathrm k,
$$
但是其缺陷为不能得到唯一分解：
$$
(1 + \mathrm i) (1 - \mathrm i) = 2 = (1 + \mathrm j) (1 - \mathrm j).
$$
一个方法是引入 **Hurwitz 整四元数**
$$
H = L + \dfrac{\rm 1 + i + j + k}{2} \cdot \mathbb Z.
$$

为什么这么选取？这要涉及到一个美妙的发现——Euclid 算法。既然我们要寻找 $a = bq + r$，且 $|r| < |b|$，这等价于 $\dfrac ab - q = \dfrac rb$ 而 $\left\lvert \dfrac rb \right\rvert <1$。因此，我们发现 Euclid 算法可以做到，当且仅当：每个点距离其最近的整点的距离 $< 1$。进而，可以用 Euclid 算法保证唯一分解性。对于 Lipschitz 整四元数，$\dfrac{\rm 1 + i + j + k}{2}$ 距离最近的 Lipschitz 整点**恰好为 $\boldsymbol 1$**，所以我们引入了 Hurwitz 复四元数。

环 $R$ 的**单位**是可逆元。

**命题 1.** Hurwitz 整四元数共有 $24$ 个单位。

*证明.* 分别为：
$$
\pm 1, \pm \mathrm i, \pm \mathrm j, \pm \mathrm k, \dfrac{\pm 1 \pm \mathrm i \pm \mathrm j \pm \mathrm k}{2}.
$$

**命题 2.** 对于四元数 $\omega$，若 $\omega$ 没有非平凡整数因子，对 $|\omega|^2$ 在 $\mathbb Z$ 上分解 $p_0 p_1 \cdots p_n$ 诱导出 $\omega$ 在 Hurwitz 整四元数上的分解
$$
\pi_0 \pi_1 \cdots \pi_n, |\pi_i|^2 = p_i.
$$

*证明.* 设 Hurwitz 整四元数集合为 $\mathcal H$。那么 Euclid 环是主理想环，进而 $p_0 \mathcal H + \omega \mathcal H$ 是主理想，设为 $\pi \mathcal H$。那么 $\pi x = p_0$，因此 $|\pi|^2$ 为 $1$ 或 $p_0$ 或 $p_0^2$。由于 $p_0 \mid \omega \overline \omega$，如果 $|\pi| = 1$，那么 $p_0 \mid \overline \omega$，但是
$$
\omega - \overline \omega = 2b \mathrm i + 2c \mathrm j + 2d \mathrm k,
$$
而 $p_0 \mid 2b, 2c, 2d$，导出 $p_0 \mid \omega$，此即矛盾。如果 $|\pi| = p_0^2$，那么 $x \pi = p_0$，而 $\left\lvert \dfrac{\pi}{p_0} \right\rvert^2 \in \mathbb Z$ 给出 $\pi = yp_0$，也就是 $x, y$ 均是单位， 这给出 $p_0 \mid \omega$，与 $\omega$ 没有非平凡整数因子矛盾。剩下 $|\pi| = p_0$ 的情况对 $\dfrac{\omega}{\pi}$ 递归下去即可。

**命题 3.** 所有满足
$$
\pi_0' \pi_1' \cdots \pi_n' = \omega = \pi_0 \pi_1 \cdots \pi_n, |\pi_i|^2 = p_i
$$
的分解都满足：
$$
\pi_i' = L_i \pi_i R_i,
$$
其中 $L_i, R_i$ 都是单位。

*证明.* 命题 2 的证明中选取的 $\pi$ 至多在一个单位的自由度内变动，也就是 $\pi'_0 = \pi_0 R_0$，用 $R_0^{-1} \omega$ 给出 $\pi_1'$，则它又与 $\pi_1$ 相差一个单位 $R_1$，那么
$$
\pi_1' = R_0^{-1} \pi_0 R_1.
$$
以此类推。

**命题 4.** $\mathcal H / p \mathcal H \simeq \mathrm{M}_2 (\mathbb F_p)$。

*证明.* 首先，$\bmod p$ 意义下，$2$ 存在逆元，所以 Hurwitz 四元数和 Lipschitz 四元数没有区别。注意到：$\mathbb F_p$ 中 $x^2 + y^2 = -1$ 一定有解：不难注意到若 $f(x) = -1-x$，$E = \mathbb F_p^2$，则 $|E| = \dfrac{p+1}{2}$，因此 $E \cap f(E) \ne \varnothing$，进而必然有一组解。我们记为 $(x, y)$。

可以直接验证如下的映射是同构：
$$
\dfrac {a +b \mathrm i + c \mathrm j + d \mathrm k} 2 \leftrightarrow \begin{pmatrix}
a-xc-yd & b-yc+xd \\
-b-yc+xd & a+xc+yd
\end{pmatrix}.
$$
这个同构保持：加法、乘法、范数。

**命题 5.** 对于奇素数 $p$，$x_0^2 + x_1^2 + x_2^2 + x_3^2 = 0$ 的在 $\operatorname{mod}p$ 意义下的解数为 $(p+1)(p^2-1) + 1$。

*证明.* 这对应 $\mathbb F_p^2$ 上线性相关组的数目。不难发现一定是 $(0, 0)$，$(0, v)$，$(v, 0)$，$(v, \lambda v)$（$\lambda \ne 0$）之一，直接计数即得。

**命题 6.** $|\omega|^2 = p$ 的 Hurwitz 四元数有 $24 (p + 1)$ 个，Lipschitz 四元数有 $8 (p + 1)$ 个。

*证明.* 考虑从 $\nu_p(|\omega|^2) = 1$ 的解中分离。这样的 $\omega \bmod p$ 根据命题 5，有 $(p+1)(p^2-1)$ 个不同值。考虑 $\omega$ 和 $p$ 的右最大公约数 $g$（如同命题 2 的证明过程来取）。

现在我们来探究什么时候 $\omega$ 和 $\omega'$ 生成相同的 $g \bmod \mathcal H^\times$。假设：
$$
\omega = x g, \omega' = x' g,
$$
则 $|x|^2$ 和 $|x'|^2$ 两个数都与 $p$ 互质。可以直接证明这可以取到，当且仅当 $x \equiv q x'$ 有整四元数解。对于 $p^4$ 个 $q$，如果他们产生相同的 $x'$：那么 $(q-q') \omega = 0$。根据初等线性代数，$q$ 的等价类有 $p^2$ 个。而我们好需要除去 $0$ 的等价类，所以一共有 $p^2 - 1$ 个产生相同 $g \bmod \mathcal H^\times$ 的 $\omega$。所以，不同的 $g \bmod \mathcal H^\times$ 共有 $p + 1$ 个，计算上 Hurwitz 四元数和 Lipschitz 四元数的单位群即得定理。

这导出了：
$$
\begin{array}{r}
x_0^2 + x_1^2 + x_2^2 + x_3^3 = p\ \text{解数为}\ 8 (p + 1), \\
x_0^2 + x_1^2 + x_2^2 + x_3^3 = 4p\ \text{解数为}\ 16 (p + 1). \\
\end{array}
$$

**命题 7.** $|\omega|^2 = m$（$m$ 是奇数）的解数为 $24 \tau(n)$，其中
$$
\tau(n) = \sum_{d \mid n} d.
$$

*证明.* 设 $\omega = K \omega_0$，其中 $K$ 是绝对值尽可能大的整数。由于 $m$ 是奇数，所以 $K$ 也是。我们尝试计算 $\omega_0$ 的个数：
$$
\omega_0 = \pi_0 \pi_1 \pi_2 \cdots \xi_0 \xi_1 \xi_2 \cdots,
$$
设 $\dfrac m{K^2} = |\omega_0|^2 = p^kq^\ell\cdots$，则 $|\pi_i|^2 = p, |\xi_i|^2 = q, \cdots$。由于 $\pi_i \pi_{i + 1}$ 不能是正数，所以 $\pi_{i + 1}$ 在 $p + 1$ 个选择中要去掉一个 $\overline{\pi_i}$，因此：$\pi_0$ 有 $p + 1$ 种选择，剩余的有 $p$ 种，这给出 $\omega_0$ 的个数为
$$
F(n) = 24 n \prod_{p \in \mathbb P, p \mid n} \dfrac{p+1}{p}.
$$
注意这是一个积性函数。因此 $|\omega|^2 = m$ 的个数为
$$
G(m) = \sum_{K^2 \mid m} F\left( \dfrac m {K^2} \right).
$$
直接证明可得 $G$ 也是积性函数，并且 $G(p^n) = 24 \tau(p^n)$，因此原命题得证。

**命题 8.** $|\omega|^2 = m$（$\omega$ 是 Lipschitz 四元数） 的解数为
$$
8 \sum_{d \mid m, 4 \nmid d} d.
$$

*证明.* 当 $m$ 是奇数时，不难发现，对于任意一个Hurwirtz 四元数 $\omega \ne 0$，在 $\mathcal H^\times$ 中的 $\xi$，满足 $\xi \omega$ 是 Lipschitz 四元数的 $\xi$ 恰好 $8$ 个。（证明：如果有其一必有 $8$ 个，而又显然不是 $24$ 个。有其一是直接的。）因此此时证毕。

当 $m$ 是偶数时，设 $m = 2^r n$，其中 $r = \nu_2(m)$。注意到如下事实：$z$ 是 Hurwitz 四元数当且仅当 $(1 + \mathrm i) z$ 是 Lipschitz 四元数。同时不难直接展开证明范数为偶数是全体 Hurwitz 整四元数都是 Lipschitz 整的。因此，我们可以设
$$
\omega = (1 + \mathrm i)^r \omega',
$$
则等价于 Hurwitz 四元数 $\omega'$ 使得 $|\omega'| = n$ 的个数，这是 $24 \tau(n)$，不难代数变形得到原命题。

**注记.** 我们有方法避免分解。可以发现
$$
\mathcal H  \underset{\mathbb Z}{\otimes} \mathbb Z_p = \mathrm M_2(\mathbb Z_p).
$$
记这个环为 $R$。考虑 $R$-模 $M = \mathbb Z_p^2$，那么 $R \simeq M^2$。现在为了计数 $|\omega|^2 = n$，只需计数 $R$ 的右理想 $I$ 使得 $[R : I] = n^2$。考虑 $R$ 与 $\mathbb Z_p$ 的森田等价，这导出 $I$ 的数目等于 $M$ 作为 $\mathbb Z_p$-模的满足 $[M : N] = n$ 的子模 $N$ 的数目。假设 $n = p^r$，则 $N \supset n M$，初等的线性代数计数技巧给出 $(\mathbb Z / n \mathbb Z)^{\oplus 2}$ 的 $n$-指数子模个数为 $\tau(n)$，即得到命题 7。

无论如何，我们完成了这道题的证明。

---

## 作者：Chase12345 (赞：11)

# 引入
这是一道十分好的数论题目。~~适合初学者做做练练手~~。
# 介绍
## 拉格朗日四平方和定理
这个定理表述的是任何正整数必定可以表示为四个整数的平方和。

证明：
> 由欧拉恒等式：
> $$
> (a^2+b^2+c^2+d^2)(x^2+y^2+z^2+w^2)=(ax+by+cz+dw)^2+(ay-bx+cw-dz)^2+(az-bw-cx+dy)^2+(aw+bz-cy-dx)^2
> $$
> 这个恒等式可以使用初中的恒等变形证明。由于展开式~~我懒得写~~比较长，这里忽略证明。
> 那么如果两个数都能表示为四个平方数的和，那么它们的乘积也能表示为四个平方数的和。因此，只需证明所有素数都能表示为四个平方数的和。
>
> 首先对于 $2$，显然地，$2=1^2+0^2+0^2+1^2$。
>
> 其次对于奇素数 $p$，通过模 $p$ 的二次剩余理论容易得出存在整数 $x,y$，使得 $x^2+y^2+1 \equiv 0 \pmod{p}$。构造一个数 $m$，且 $m<p$，使得 $mp=x^2+y^2+z^2+w^2$，通过无穷递降法即证。

## 雅可比四平方和定理
设 $r_4(n)$ 表示自然数 $n$ 表示为四个整数平方和的有序表示方式的数量。定义：
$$
\theta_3(q)=\sum_{n=-\infty}^{\infty}q^{n^2},|q|<1
$$
根据雅可比三重积恒等式，有
$$
\prod_{n=1}^{\infty}(1-q^{2n})(1+q^{2n-1}z)(1+q^{2n-1}z^{-1})=\sum_{n=-\infty}^{\infty}q^{n^2}z^n
$$
令 $z=1$，有
$$
\theta_3(q)=\prod_{n=1}^{\infty}(1-q^{2n})(1+q^{2n-1})^2
$$
展开 $\theta_3(q)^4$
$$
\theta_3(q)^4=\left(\prod_{n=1}^{\infty}(1-q^{2n})(1+q^{2n-1})^2\right)^4=\prod_{n=1}^{\infty}(1-q^{2n})^4(1+q^{2n-1})^8
$$
雅可比证明了（这里我实力不够不知道咋证，有大佬告诉我吗？）
$$
\theta_3(q)^4=1+8\sum_{k=1}^{\infty}\frac{kq^k}{1+(-q)^k}
$$
展开右边的系数，可以得到：
$$
1+8\sum_{k=1}^{\infty}\frac{kq^k}{1+(-q)^k}=1+8\sum_{k=1}^{\infty}kq^k\left(1-\left(\sum_{i=1}^{\infty}(-(-q)^k)^{i}\right)\right)
$$
提取 $q^n$ 的系数，得到：
$$
r_4(n)=8\sum_{d \mid n,4 \nmid n} d
$$
最终得到结论。
# 代码实现
由于 $n \le 10^{18}$，通过 MillerRabin 和 PollardRho 完成找因数的过程。可以通过此题。
```cpp
#include <bits/stdc++.h>
using namespace std;
using ll = long long;

const int MOD = 1e9 + 7;

namespace MillerRabin {
	ll mul(ll a, ll b, ll mod) {
		ll res = 0;
		while (b) {
			if (b & 1) res = (res + a) % mod;
			a = (a + a) % mod;
			b >>= 1;
		}
		return res;
	}
	ll pow(ll a, ll b, ll mod) {
		ll res = 1;
		while (b) {
			if (b & 1)
				res = mul(res, a, mod);
			a = mul(a, a, mod);
			b >>= 1;
		}
		return res;
	}
	bool is_prime(ll n) {
		if (n < 2)
			return false;
		if (n == 2 || n == 3)
			return true;
		if (n % 2 == 0)
			return false;
		ll d = n - 1;
		int s = 0;
		while (d % 2 == 0) {
			d /= 2;
			s++;
		}
		for (int a : {2, 3, 5, 7, 11, 13, 17, 19, 23, 29, 31, 37}) {
			if (a >= n)
				continue;
			ll x = pow(a, d, n);
			if (x == 1 || x == n - 1)
				continue;
			bool ok = false;
			for (int i = 0; i < s - 1; i++) {
				x = mul(x, x, n);
				if (x == n - 1) {
					ok = true;
					break;
				}
			}
			if (!ok)
				return false;
		}
		return true;
	}
}

namespace PollardRho {
	using namespace MillerRabin;
	mt19937_64 rng(chrono::steady_clock::now().time_since_epoch().count());
	ll get_factor(ll n) {
		if (n % 2 == 0)
			return 2;
		if (n % 3 == 0)
			return 3;
		if (n % 5 == 0)
			return 5;
		while (true) {
			ll x = rng() % (n - 2) + 2;
			ll y = x;
			ll c = rng() % (n - 1) + 1;
			ll d = 1;
			auto f = [&](ll x) {
				return (mul(x, x, n) + c) % n;
			};
			while (d == 1) {
				x = f(x);
				y = f(f(y));
				d = __gcd(abs(x - y), n);
			}
			if (d != n && is_prime(d)) return d;
		}
	}
	void solve2(ll n, ll* f1, int& count) {
		if (n == 1) return;
		if (is_prime(n)) {
			f1[count++] = n;
			return;
		}
		ll d = get_factor(n);
		solve2(d, f1, count);
		solve2(n / d, f1, count);
	}
}

struct Factor {
	ll prime;
	int exponent;
};

void sort_f1(ll* arr, int n) {
	sort(arr, arr + n);
}

void group_f1(ll* f1, int count, Factor* isg, int& icnt) {
	if (count == 0) return;
	icnt = 0;
	isg[0].prime = f1[0];
	isg[0].exponent = 1;
	for (int i = 1; i < count; i++)
		if (f1[i] == isg[icnt].prime)
			isg[icnt].exponent++;
		else {
			icnt++;
			isg[icnt].prime = f1[i];
			isg[icnt].exponent = 1;
		}
	icnt++;
}

void solve1(const Factor* f1, int cnt, ll* f2, int& dcnt, ll current = 1, int index = 0) {
	if (index == cnt) {
		f2[dcnt++] = current;
		return;
	}
	ll p = f1[index].prime;
	int e = f1[index].exponent;
	for (int i = 0; i <= e; i++) {
		solve1(f1, cnt, f2, dcnt, current, index + 1);
		current *= p;
	}
}

int solve(ll n) {
	if (n == 0)
		return 1;
	ll f1[105];
	int cnt = 0;
	PollardRho::solve2(n, f1, cnt);
	sort_f1(f1, cnt);
	Factor isg[MAX_FACTORS];
	int icnt = 0;
	group_f1(f1, cnt, isg, icnt);
	ll* f2 = new ll[1000005];
	int dcnt = 0;
	solve1(isg, icnt, f2, dcnt);
	ll sum = 0;
	for (int i = 0; i < dcnt; i++)
		if (f2[i] % 4 != 0)
			sum += f2[i];
	delete[] f2;
	sum %= MOD;
	sum = sum * 8 % MOD;
	return sum;
}

int main() {
	int T;
	cin >> T;
	while (T--) {
		ll n;
		cin >> n;
		cout << solve(n) << '\n';
	}
	return 0;
}
```
# Update:
第一次过审的题解不够详细，感谢 [Pentiment](https://www.luogu.com.cn/user/879904) 大佬提出的宝贵意见。现在已经修改。

---


# 轮换式 加强版

## 题目背景

[原题链接](https://www.luogu.com.cn/problem/P5084)

本题与原题的区别，只有模数和数据范围不同。

## 题目描述

小奔发现，对于任意的 $n$ 个字母，他们构成的轮换式，都表示成 $n$ 个基本轮换式的线性和。

一元的基本轮换式：$a$；

二元：$a+b$，$ab$；

三元：$a+b+c$，$ab+ac+bc$，$abc$；

四元：$a+b+c+d$，$ab+ac+ad+bc+bd+cd$，$abc+abd+bcd$，$abcd$；

......

已知 $n$ 个数的各个基本轮换式的值，求它们的 $m$ 次方和，答案对 $899678209$（$899678209 = 429 \times 2^{21} + 1$）取模。

## 说明/提示

【样例一解释】  
可以列出方程 $a+b = 9$，$ab = 18$，容易算出 $a^2+b^2 = 45$。

【数据范围】  
- 对于 $20\%$ 的数据，$1\le n \le 1000$，$1\le m \le 10^4$；  
- 对于 $60\%$ 的数据，$1\le n \le 1000$，$1\le m \le 10^9$；  
- 对于 $100\%$ 的数据，$1\le n \le 3 \times 10^4$，$1\le m \le 10^9$，$1\le a_i \le 10^8$。


## 样例 #1

### 输入

```
2 2
9 18```

### 输出

```
45```

## 样例 #2

### 输入

```
9 233333
9 1 8 7 5 6 3 4 2```

### 输出

```
100006329```

# 题解

## 作者：苹果蓝17 (赞：4)

[题目传送门](https://www.luogu.com.cn/problem/P6296)

[更好的阅读体验](https://www.cnblogs.com/Appleblue17/p/15302277.html)

#### 题意简述

+ 现有 $n$ 个变量 $a_1,a_2,\cdots,a_n$，给出所有它们能组成的 $k$ 次轮换式的值 $f_k$，求 $\sum\limits_{i=1}^n a_i^m$。

+ $n \leq 30000,m \leq 10^9$。

#### 题目分析

轮换式是典型的积和形式，直接考虑写成生成函数：

$$f_k=[x^k]\prod\limits_{i=1}^n(1+a_ix)$$

$$F(x)=\prod\limits_{i=1}^n(1+a_ix)$$

发现这个累乘很难处理，考虑两边取 $\ln$：

$$
\begin{aligned}

\ln F(x)
& =\sum\limits_{i=1}^n \ln(1+a_ix) \\
& =\sum\limits_{i=1}^n \sum\limits_{j \geq 1} -\dfrac{(-a_ix)^j}{j} \\
& =\sum\limits_{j \geq 1} \dfrac{(-1)^{j+1}}{j} x^j \sum\limits_{i=1}^n a_i^j
\end{aligned}
$$

于是答案为：

$$Ans=\dfrac{m}{(-1)^{m+1}}[x^m]\ln F(x)$$

只需要求出 $[x^m] \ln F(x)$ 即可。

***

$m$ 过大，肯定不能暴力求，考虑 $\ln$ 的递推求法：

$$G=\ln F$$

$$G'=\dfrac{F'}{F}$$

$$FG'=F'$$

$$kf_k=\sum\limits_{i=1}^{k} ig_{i}f_{k-i}$$

当 $k \leq n$ 时，暴力求 $\ln$ 即可，时间复杂度 $O(n \log n)$。

当 $k > n$ 时，有 $f_k=0$。

$$
\begin{aligned}

0
& =\sum\limits_{i=1}^{k} ig_{i}f_{k-i} \\
& =\sum\limits_{i=0}^{k-1} (k-i)g_{k-i}f_i \\
& =\sum\limits_{i=0}^{n} (k-i)g_{k-i}f_i \\
& =kf_0 g_k+\sum\limits_{i=1}^{n} (k-i)g_{k-i}f_i \\
\end{aligned}
$$

$$kf_0 \cdot g_k=-\sum\limits_{i=1}^n (k-i)f_i \cdot g_{k-i}$$

这是非常显然的齐次线性递推的形式，总时间复杂度 $O(n \log n \log m)$。

代码里的 $g_k$ 代表实际是 $kg_k$，会方便一些。

#### 代码

```cpp
...
long long n,m;
long long A[N],F[N],G[N],P[N];

int main(){
	pre();
	cin>>n>>m;
	F[0]=1;
	for(int i=1;i<=n;i++) F[i]=rd();
	poly::Ln(G,F,n);
	for(int i=0;i<=n;i++) G[i]=G[i]*i%mod;
	for(int i=1;i<=n;i++) P[i]=(mod-F[i])%mod;
	cout<<Recursion::solve(P,G,m,n+1)*ID(m+1)%mod;
}
```

---

## 作者：Kevin0007 (赞：2)

[本题链接](https://www.luogu.com.cn/problem/P6296)

本人从原题跳过来的

[原题链接](https://www.luogu.com.cn/problem/P5084)

可以先看一下我在原题发的题解：[题解](https://www.luogu.com.cn/blog/Kevin0007/p5084-lun-huan-shi) 

进入正题。

分析：

看了上文所说到的题解，应该知道，我的原题做法是分别列举 $n=1,2,3,4$ 的情况。对于 $n=1$ 的情况，直接快速幂。对于其他情况，先算出前几项这 $n$ 个数的次方和，再利用牛顿递推公式进行计算，最后得出结果。

那么这道题唯一的不同就在于 $n$ 有可能比 4 更大，那么直接分类讨论肯定是不可以的了，怎么办呢？

于是开始考虑从特殊到一般。

第一步是求出任意个未知数下的牛顿递推公式。

非常简单。先设输入的第 $i$ 个轮换式为 $l_i$，$f_n[x]=\Sigma_{i=1}^n a_i^x$。

用原题题解的原话来说，

$$f_2[x]=l_1f_2[x-1]-l_2f_2[x-2]$$

$$f_3[x]=l_1f_3[x-1]-l_2f_3[x-2]+l_3f_3[x-3]$$

$$f_4[x]=l_1f_4[x-1]-l_2f_4[x-2]+l_3f_4[x-3]-l_4f_4[x-4]$$

找一下规律就可以得知：

$$f_n[x]=\Sigma_{i=x-1}^{x-n} (-1)^{i-x+1}l_if_n[i]$$

（千万不要被这个式子所吓倒，因为当你展开并用省略号的形式写出来后，你会发现它非常好理解）

那么接下来难点就是求出前 $n$ 项 $f[x]$ 了。

此时我们可以再回头看一下我的原题题解，发现一个惊人的事情：

用原题题解中的原话来说，

$$f[2]=x^2-2y,f[3]=x^3-3xy+3z$$

这两个算式，不管 $n$ 是多少都是成立的！

再往后推几个就可以发现未知数的规律。那么我们来看系数的规律。

再把系数打成个表来：

```cpp
1
1 2 1
1 3 3 1
1 4 6 4 1
……
```

发现了什么？这是杨辉三角啊！

所以只需要把杨辉三角打出来，然后按上述做法做即可。

代码略。



---

## 作者：Aleph1022 (赞：1)

我们知道题目相当于是给出 $\prod_{i=1}^n (1+a_ix)$ 的各项系数，求 $\sum_{i=1}^n a_i^m$。

我们容易求出
$$
F(x) = \prod_{i=1}^n (x-a_i)
$$

根据牛顿恒等式，答案就是 $[x^m] \frac{(F')^R}{F^R}$。其中 $F^R$ 是 $R$ 的系数反转。  
常系数线性齐次递推即可。

另一个角度的证明：  
考虑
$$
\sum_{i=1}^n a_i^m = [x^m] \sum_{i=1}^n \frac1{1-a_ix}
$$

根据积的求导法则手动展开 $F'(x)$ 即可验证。

---


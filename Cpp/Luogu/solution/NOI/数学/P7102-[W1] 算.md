# [W1] 算

## 题目描述

有一个 $m$ 项多项式 $p(x)$ 以及两个参数 $c$ 和 $t$，其中 $p(x)=a_0+a_1x+\dots+a_{m-1}x^{m-1}$。  
定义一个新函数 $s(n)$:
$$s(n)=\sum_{i=1}^np(i)[\gcd(i,n)=1]\bmod 998244353$$
请计算 $s(c),s(c^2),\dots,s(c^t)$。

## 说明/提示

对于 $10\%$ 的数据，$t\le2,c\le100$;  
对于 $30\%$ 的数据，$t\le1000,m\le1000$；  
对于 $50\%$ 的数据，$t\le5\cdot10^4,m\le5\cdot10^4,c\le10^{12}$；  
对于另外 $10\%$ 的数据，$c=123456789$；  
对于所有数据，$1\le t\le2\cdot10^5,1\le m\le2\cdot10^5,1\le c\le10^{18}$。

## 样例 #1

### 输入

```
8 10 4
3 1 4 1 5 9 2 6```

### 输出

```
35683652
171899188
780914481
858211065```

# 题解

## 作者：command_block (赞：9)

**题意**：给出 $m$ 项多项式 $P(x)$ 以及常数 $c$。

定义 $s(n)=\sum_{i=1}^nP(i)[i\perp n]$。

给出 $t$，分别求 $s(c),s(c^2),...,s(c^t)$ 的值。

答案对 $998244353$ 取模，$t,m\leq 2\times 10^5$，$c\leq 10^{18}$，时限$\texttt{1s}$。

------------

- **前置知识**：Chirp Z-Transform

  给出多项式 $F(x)$ 和常数 $c$，可以卷积求出 $F(1),F(c),F(c^2),\dots,F(c^{m-1})$。

-----

$$
\begin{aligned}
s(n)
&=\sum_{i=1}^nP(i)[i\perp n]\\
&=\sum_{i=1}^nP(i)\sum_{d|n,d|i}\mu(d)\\
&=\sum_{d|n}\mu(d)\sum_{d|i}^nP(i)\\
&=\sum_{d|n}\mu(d)\sum_{d|i}^n\sum_{j=0}^{m-1}P[j]i^j\\
&=\sum_{d|n}\mu(d)\sum_{i=1}^{n/d}\sum_{j=0}^{m-1}P[j](id)^j\\
&=\sum_{j=0}^{m-1}P[j]\sum_{d|n}\mu(d)d^j\,\boxed{\sum_{i=1}^{n/d}i^j}
\end{aligned}
$$

后面的部分是自然数幂和。

-----

自然数幂和的多项式为 
$$
\sum\limits_{i=0}^{n-1}i^k=S_k(n)=k!\sum\limits_{i=0}^k\dfrac{B[k-i]n^{i+1}}{(i+1)!}
$$
其中 $B$ 为伯努利数。它的的 EGF 为 $\frac{x}{e^x-1}$，其可以多项式求逆计算。

注意到只能对 $[0,n-1]$ 求和，而且我们需要的是对 $[1,n]$ 求和。 需要对 $0,n$ 两项单独计算。

-----

- **微调后的求和**

先考虑
$$
\begin{aligned}
s'(n)&=\sum\limits_{j=0}^{m-1}P[j]\sum\limits_{d|n}\mu(d)d^j\sum\limits_{i=0}^{n/d-1}i^j\\
&=\sum\limits_{j=0}^{m-1}P[j]\sum\limits_{d|n}\mu(d)d^jj!\sum\limits_{i=0}^j\dfrac{B[j-i](n/d)^{i+1}}{(i+1)!}\\
&=\sum\limits_{j=0}^{m-1}P[j]j!\sum\limits_{i=0}^j\dfrac{B[j-i]}{(i+1)!}\sum\limits_{d|n}\mu(d)d^j(n/d)^{i+1}\\
&=\sum\limits_{j=0}^{m-1}P[j]j!\sum\limits_{i=0}^j\dfrac{B[j-i]n^{i+1}}{(i+1)!}\sum\limits_{d|n}\mu(d)d^{j-i-1}\\
&=\sum\limits_{j=0}^{m-1}P[j]j!\sum\limits_{i=0}^j\dfrac{B[i]n^{j-i+1}}{(j-i+1)!}\sum\limits_{d|n}\mu(d)d^{i-1}
\end{aligned}
$$
考察积性函数 $f_k=(\mu·id_k)*I$，有
$$
f_k(p^c)=\mu(1)id_k(1)+\mu(p)id_k(p)=1-p^k
$$
不难发现 $f_k(n)$ 的取值只与 $n$ 的素因子集合有关。

由于 $n^c$ 和 $n$ 的素因子集合相同，可推知 $f_k(n^c)=f_k(n)$。

$$
s'(n)=\sum\limits_{j=0}^{m-1}P[j]j!\sum\limits_{i=0}^j\dfrac{B[i]n^{j-i+1}}{(j-i+1)!}f_{i-1}(n)
$$
用 $c^k$ 替换 $n$ ,同时注意到 $f_{i-1}(c^k)=f_{i-1}(c)$。

$$
s'(c^k)=\sum\limits_{j=0}^{m-1}P[j]j!\sum\limits_{i=0}^j\dfrac{B[i](c^k)^{j-i+1}}{(j-i+1)!}f_{i-1}(c)
$$
可以用 $\rm Prho$ 分解求解积性函数 $f_{0\sim(t-1)}(c)$，这部分复杂度为 $O\big(\sqrt[4]{c}+t\omega(c)\big)$。

不妨设 $F[i]=f_{i-1}(c)$。

$$
s'(c^k)=\sum\limits_{j=0}^{m-1}P[j]j!\sum\limits_{i=0}^j\dfrac{B[i]F[i](c^k)^{j-i+1}}{(j-i+1)!}
$$
暂时用 $x$ 替换 $c^k$。

$$
R(x)=\sum\limits_{j=0}^{m-1}P[j]j!\sum\limits_{i=0}^j\dfrac{B[i]F[i]x^{j-i+1}}{(j-i+1)!}
$$
不难发现 $P[j]j!B[i]F[i]$ 会贡献到 $x^{j-i+1}$ 的系数处，这是个差卷积。

计算出上述多项式之后，需要分别求 $R(c),R(c^2),...,R(c^t)$ 的值。

使用 Chirp Z-Transform 即可。

-----

- **单独计算 $n^k$ 项**

$$
\begin{aligned}
s_1(n)
&=\sum\limits_{j=0}^{m-1}P[j]\sum\limits_{d|n}\mu(d)d^j(n/d)^j\\
&=\sum\limits_{j=0}^{m-1}P[j]n^j\sum\limits_{d|n}\mu(d)\\
&=[n=1]\sum\limits_{j=0}^{m-1}P[j]\\
\end{aligned}
$$

-----

- **单独计算 $0^k$ 项**

$$
\begin{aligned}
s_0(n)
&=\sum_{j=0}^{m-1}P[j]\sum_{d|n}\mu(d)d^j0^j\\
&=P[0]\sum_{d|n}\mu(d)\\
&=[n=1]P[0]
\end{aligned}
$$

-----

最终
$$
s(c^k)=s'(c^k)+s_1(c^k)-s_0(c^k)
$$
复杂度为 $O\big((m+t)\log(m+t)+\sqrt[4]{c}+m·\omega(c)\big)$。

---

## 作者：jiangby (赞：8)

这是一道综合题，不需要什么高深的知识，只需要每种都会一点点然后爆推就可以了，需要注意一些细节
$$
\begin{aligned}
\quad~ S(n)&=\sum_{i=1}^n P(i)[(i,n)=1] \\
&=\sum_{i=1}^n P(i) \sum_{d|n,d|i} \mu(d)\\
&=\sum_{d|n}\mu(d)\sum_{i=1}^{n/d}P(id)\\
&=\sum_{d|n}\mu(d)\sum_{i=1}^{n/d}\sum_{j=0}^{m-1}a_j(id)^j\\
&=\sum_{d|n}\mu(d)\sum_{j=0}^{m-1}a_jd^j\sum_{i=1}^{n/d}i^j
\end{aligned}
$$
​			后面的是一个自然数幂求和的形式，考虑使用 $B_i$ 表示伯努利数，但是伯努利数的 $i$ 是从 $0$ 开始的，于是把一开始的 $S(n)=\sum_{i=0}^nP(i)[(i,n)==1]$ 显然只有当 $n=1$ 是与原来不同，判一下即可，接下来按着式子继续推
$$
\begin{aligned}
\quad~&=\sum \mu(d)\sum_{j=0}^{m-1}a_jd^j\sum_{i=0}^{n/d}i^j\\
&=\sum \mu(d)\sum_{j=0}^{m-1}a_jd^j\frac{1}{j+1}\sum_{i=0}^{j} \binom{j+1}{i}B_i
(\frac n d+1)^{j+1-i}\\
&=\sum \mu(d)\sum_{j=0}^{m-1}a_jd^j\frac{1}{j+1}\sum_{i=0}^{j}B_i\sum\binom{j+1}{i}\binom{j+1-i}{k}(\frac n d)^k\\
&=\sum \mu(d)\sum_{j=0}^{m-1}a_jd^j\frac{1}{j+1}\sum_{i=0}^{j}B_i\sum\binom{j+1}{k}\binom{j-k+1}{i}(\frac n d)^k\\
&=\sum \mu(d)\sum_{j=0}^{m-1}a_jd^j\frac{1}{j+1}\sum_{k=0}^{j+1}\binom{j+1}k\frac{n^k}{d^k}\sum_{i=0}^{j}B_i\binom{j-k+1}{i}
\end{aligned}
$$
对于最后一个求和，不难发现当 $k!=0$ 时，取值只与 $j-k$ 有关，而当 $k=0$ 时根据定义除 $j=0$ 都是 $0$，而 $j=0,k=0$ 的情况不难证明和为 $0$ 于是 $k$ 从 $1$ 开始算，并且记$F_k=\sum_{i=0}^k\binom k i B_i$
$$
\begin{aligned}
\quad~&=\sum \mu(d) \sum_{j=0}^{m-1}a_jd^j\frac{1}{j+1}\sum_{k=1}^{j+1}\binom{j+1}k\frac{n^k}{d^k}F_{j-k+1}\\
&=\sum \mu(d) \sum_{j=0}^{m-1}\sum_{k=0}^{j}a_jd^{j-k-1}n^{k+1}\frac1{j+1}\binom{j+1}{k+1}F_{j-k}\\
&=\sum_{k=0}^{m-1}n^{k+1}\frac1{(k+1)!}\sum_{j=k}^{m-1}a_jj!F_{j-k}\frac1{(j-k)!}\sum_{d|n}\mu(d)d^{j-k-1} 
\end{aligned}
$$
对于最后一个和式，记 $H_k=\sum_{d|n}\mu(d)d^{k-1}$，因为只与 $n$ 的不平方因子因子有关，它对于$n=c^q$ 取值相同，于是可以预处理，而这显然是个积性函数，$Rho$ 之后算一下即可
$$

=\sum_{k=0}^{m-1}n^{k+1}\frac1{(k+1)!}\sum_{j=k}^{m-1}a_jj!F_{j-k}\frac1{(j-k)!}H_{j-k}

$$
后面是一个差卷积形式，于是 $S(n)$ 就是一个关于 $n$ 的多项式，计算即可

---


# 送别（Farewell）

## 题目背景

还是到了离别的时候呢...... 相聚的时间很短暂，不知是否给了你一次美好的经历呢？

我举办这场比赛，还是想给自己留下一些珍贵的回忆。虽然自己的水平并不高，但这对我还是很有纪念意义。

经过长时间的准备，在这送别之际，应当更隆重一些的 —— 可惜我并没有那样的能力。若不然，也不会只能以这种程度的题目来压轴。

既然如此，就不要让此次分别成为永别...... 我将全力以赴，为了我们下次再会。这是我自私的请求，但请你等着我回来！

我这贫乏的语言，难以表述心中的情感。不如我们就这样，在离别前静静地享受这段时光吧。

## 题目描述

铃来到了一个奇妙的 Gnilrits 星球，上面生活着一种奇妙的 Gnilrits 人。

这种生物有除了 $k$ 个寿命无限但不能繁殖的个体以外，设其它人的总数在第 $i$ 年为 $a_i$，她得知有规律 $a_i=qa_{i-1}-a_{i-2}$，其中 $a_0=0$，$a_1=1$。

在第 $i$ 年，若 $a_i > k$，则星球上都会依次发生如下事件：

1. 全部 $a_i+k$ 个人被分配到 $a_i$ 个**相同的**住房内，不能有空房（每个人都是不同的）。

2. 每个房屋都修建一条单向道路，连接另一个房屋（可以是自己）；且对任意房屋，都要有一条连向它的道路。最终形成 $a_i-k$ 个环，包括自环。

需要注意的是，在第一步后因为房屋有不同的人居住，它们之间也就是不同的了。

铃想到了一个问题：设第 $i$ 年分配房屋并修建道路的总方案数为 $b_i$（若 $a_i \leq k$ 则 $b_i=0$），则 $i\in [0,n]$ 的所有 $b_i$ 之和是多少呢？

铃在思考这个问题时，她突然惊醒了过来 —— 原来刚才的只是一场梦。她正想和澪分享梦中的见闻，才想起以往在她身边的澪，如今已经离开了。

没有办法，但铃还是想知道问题的答案，请你帮忙求出来吧。结果可能很大，你只需要告诉她答案对 $998244353$ 取模的结果即可。



## 说明/提示

【样例 $1$ 解释】  

在 $i \leq 2$ 时 $b_i=0$。

对于 $i=3$ 的情况，$a_i=3$。首先要将 $5$ 个不同的人分配入 $3$ 个相同的房屋，有 $25$ 种方案；再把 $3$ 个变得不同的房屋用环路连接，形成 $1$ 个环，只有 $2$ 种方案，故 $b_3 = 25 \times 2 = 50$。  
（更具体的解释见[此处](https://www.luogu.com.cn/paste/usa2ggb4)）

对于 $i=4$，$a_i=4$，将 $6$ 个人分入 $4$ 个房屋有 $65$ 种方案；在 $4$ 个房屋间修路形成 $2$ 个环有 $11$ 种方案，总方案数为 $65\times 11 = 715$。

故答案为 $50+715=765$。

【数据范围】

**本题采用捆绑测试。**

Subtask 1（7 pts）：$1\le n\le 1000$，$1\le k \le 3$；   
Subtask 2（11 pts）：$1\le n,k \le 100$；   
Subtask 3（13 pts）：$1 \le k \le 1000$；  
Subtask 4（19 pts）：$1\le k \le 32000$，$q=2$；  
Subtask 5（23 pts）：$1\le k \le 16000$，$q \neq 2$；   
Subtsak 6（27 pts）：无特殊限制。

对于 $100\%$ 的数据，$1\le n \le 10^9$，$1\le k \le 64000$，$2\le q \le 10^9$。  


【提示】  
此题并不难，但可能需要一定程度的常数优化。



## 样例 #1

### 输入

```
4 2 2```

### 输出

```
765```

## 样例 #2

### 输入

```
233 2 99```

### 输出

```
161697303```

## 样例 #3

### 输入

```
7 4 5```

### 输出

```
322237710```

## 样例 #4

### 输入

```
10 3 17```

### 输出

```
146281933```

## 样例 #5

### 输入

```
1919810 114514 2333```

### 输出

```
426283611```

# 题解

## 作者：NaCly_Fish (赞：16)

首先观察题意可以发现，每次事件的两步，分别对应了两类 Stirling 数的定义。于是有一个朴素的计算式：
$$\sum_{i=0}^n \begin{Bmatrix}  a_i+k \\ a_i\end{Bmatrix}\begin{bmatrix} a_i \\ a_i-k\end{bmatrix}$$
要优化做法，需要的第一个重要性质是：

> $\begin{bmatrix} x \\ x-k\end{bmatrix}$ 关于 $x$ 是一个 $2k$ 次多项式。

这可以用第一类 Stirling 数每列的 EGF 来证明：
$$\begin{bmatrix} n \\ k\end{bmatrix}= n!(-1)^{n-k}[z^n]\frac{\ln(1+z)^k}{k!}$$

进行 Lagrange 反演：
$$\begin{bmatrix} n \\ k\end{bmatrix}=\frac{n!}{k!}(-1)^{n-k}\frac{k}{n}[z^{n-k}]\left( \frac{z}{\text e^z-1}\right)^n$$
$$= \frac{(n-1)!}{(k-1)!}(-1)^{n-k}[z^{n-k}]\left( \frac{z}{\text e^z-1}\right)^n$$
因此
$$\begin{bmatrix} x \\ x-k\end{bmatrix} =  (x-1)^{\underline k}(-1)^k [z^k]\left( \frac{z}{\text e^z-1}\right)^x$$
将要提取 $z^k$ 系数的那一块东西展开，可以发现这部分确实是一个 $k$ 次多项式，故整体就是一个关于 $x$ 的 $2k$ 次多项式。

现在我们可以设
$$S_k(x) = \begin{bmatrix} x \\ x-k\end{bmatrix} $$
由 Stirling 数反射公式可知
$$\begin{bmatrix} n \\ k \end{bmatrix} =  \begin{Bmatrix} -k \\ -n \end{Bmatrix}$$
于是
$$ \begin{Bmatrix} x+k \\ x \end{Bmatrix}= \begin{bmatrix} -x \\ -x-k\end{bmatrix}=S_k(-x)$$

现在，对于 $q=2$ 的数据已经有了一种做法。首先我们需要求出 $S_k(x)$ 的系数，而这个问题的瓶颈在于求：

$$[z^k]\left( \frac{z}{\text e^z-1}\right)^x $$

$x$ 在指数上不方便操作，取 $\ln$ 再做 $\exp$ 就变成
$$\sum_{i=0}^k \frac{x^i}{i!}[z^k] \left( \ln \frac{z}{\text e^z-1}\right)^i \ \ \ (*)$$
再次使用 Lagrange 反演，设
$$F(z) = \ln \frac{z}{\text e^z-1}$$
$$\text e^z= \frac{F^{\langle -1\rangle}(z)}{\text e^{F^{\langle -1\rangle}(z)}-1}$$
$F^{\langle -1 \rangle}(z)$ 系数可以用牛顿迭代以 $\Theta(k \log k)$ 的时间复杂度求解，于是
$$(*) = \frac 1k\sum_{i=0}^k \frac{ix^i}{i!} [z^{k-i}]\left( \frac{z}{F^{\langle -1 \rangle}(z)}\right)^k $$
可以 $\Theta(k \log k)$ 的时间复杂度求出，故 $S_k(x)$ 的系数也可以这个复杂度求出。  
现在设 $G(x) = S_k(x)S_k(-x)$，由于 $q=2$ 时 $a_i=i$，答案可以写为：
$$\sum_{j=0}^{4k}g_j \sum_{i=1}^ni^j$$
如何以 $\Theta(k \log k)$ 的时间复杂度求出 $j \in [0,k]$ 时的正整数幂和也很经典：

$$\sum_{k=0}^\infty \frac{x^k}{k!}\sum_{i=0}^ni^k = \sum_{i=0}^n  \text e^{ix}=\frac{1-\text e^{(n+1)x}}{1-\text e^x}$$

于是 $q=2$ 的情况就能以 $\Theta(k \log k)$ 的复杂度解决。

对于 $q \neq 2$，求出 $G(x)$ 的步骤是类似的。设
$$A = \frac{1}{\sqrt{q^2-4}} \ , \ r=\frac{q \pm \sqrt{q^2-4}}{2}$$
则有 $a_i=A(r_1^i-r_2^i)$，也可以类似地将答案写为
$$\sum_{j=0}^{4k}g_j A^j\sum_{i=1}^n  (r_1^i-r_2^i)^j$$
如果暴力进行二项式展开，可以做到 $\Theta(k^2)$ 的时间复杂度。对于一般的情况优化是困难的，不过这里的特征根满足 $r_1r_2=1$，这也就是第二个重要性质。

设 $r_1 = \alpha$，$r_2 = \alpha^{-1}$，求出 $\tilde G(x)=G(Ax-Ax^{-1})$ 的系数后，则答案可以写为
$$\sum_{j=-4k}^{4k}\tilde g_j\sum_{i=1}^n \alpha^{ij}$$
然后就能以 $\Theta(k + \log n)$ 的时间复杂度算出答案了。那么现在的主要问题就是如何求 $\tilde G(x)$。

再回看 $G(x)=S_k(x)S_k(-x)$，这使得 $G(x)$ 的奇数次项都是零。这带来了一个很好的性质：$\tilde G(x)$ 的系数不用扩域表示！这可以大幅优化常数。

具体来说，令 $H(x^2/A^2)=G(x)$，那么只需要求出 $H(x+x^{-1}-2)$ 的系数后，把 $x$ 都代换为 $x^2$ 就得到了 $\tilde G(x)$。

有负数次项不便于处理，我们考虑求出
$$x^{2k}\sum_{i=0}^{2k}h_i (x+x^{-1}-2)^i$$
$$=x^k \left( x^k \sum_{i=0}^k h_i (x+x^{-1}-2)^i\right)+(x-1)^{2k+2}\left( x^{k-1} \sum_{i=0}^{k-1} h_{i+k+1}(x+x^{-1}-2)^i\right)$$
可以分治求解，时间复杂度 $\Theta(k \log^2 k)$。

于是总时间复杂度就是 $\mathcal O(k \log^2 k +\log n)$，代码就不贴了（

---

## 作者：飞雨烟雁 (赞：10)

这里介绍一种更快的做法。相较于 NaCly_Fish 的做法，本解法在最后一步求解 $H(x+x^{-1}-2)$ 的系数时采用另一种方法，使得总时间复杂度降至 $O(k\log k+\log n)$。

+ 建议在题解区观看本题解，因为博客那边的表格太丑了（

------------

在介绍做法前先简要说明该算法核心。核心是多项式系数翻转 $F_R(x)=x^{|F|}F(\frac 1x)$ 这条式子，主要操作是平移和翻转。

算法全流程详解可以看这篇博客：[任意二次分式均可于 nlogn 时间复合](https://www.luogu.com.cn/blog/Fly37510/FUHE-ERCIFENSHI)。也可以先看看下文，估计就明白算法的大致思路了。

按照博客的机械算法，我们可以整理出求 $x^{2k}H(x+x^{-1}-2)$ 的步骤，具体如下：

| 步骤 | 操作 | 说明 | 由上一步变为 |
| :----------: | :----------: | :----------: | :----------: |
| $1$ | 翻转系数 | $a$ 次系数移动至 $(2k-a)$ 次 | $H_R(x)$ |
| $2$ | 右复合 $x-\frac 14$ | 多项式平移 $-\frac 14$ | $H_R(x-\frac 14) $|
| $3$ | 右复合 $x^2$ | $a$ 次系数移动至 $2a$ 次 | $H_R(x^2-\frac 14) $ |
| $4$ | 右复合 $x+\frac 12$ | 多项式平移 $+\frac 12$ | $H_R(x^2+x) $|
| $5$ | 翻转系数 | $a$ 次系数移动至 $(4k-a)$ 次 | $x^{4k}H_R\Big(\frac 1{x^2}+\frac 1x\Big)=(x+1)^{2k}H\Big(\frac{x^2}{x+1}\Big)$ |
| $6$ | 右复合 $x-1$ | 多项式平移 $-1$ | $x^{2k}H(\frac {(x-1)^2}{x})$ |

共需三次多项式平移，由于多项式平移是 $O(k\log k)$ 的，所以总时间复杂度就是 $O(k\log k+\log n)$。

以下是实现的代码片段：

```cpp
int k2 = k * 2, k4 = k * 4;
for(int i = 0; i < k; ++i) swap(H[i], H[k2 - i]);
Shift(H, k2, -Inv(4));
for(int i = k2; i; --i) H[i * 2] = H[i], H[i] = 0;
Shift(H, k4, Inv(2));
for(int i = 0; i < k2; ++i) swap(H[i], H[k4 - i]);
Shift(H, k4, -1);
```

---


# [POI 2011] OKR-Periodicity

## 题目描述

比托蒂亚的国王 Byteasar 下令对他的臣民的名字进行改革。

比托蒂亚人的名字通常包含重复的短语，例如，名字 Abiabuabiab 包含两次出现的短语 abiab。Byteasar 打算将他的臣民的名字改为与原名长度相匹配的 01 串。

此外，他非常希望在新名字中反映原始的周期。

对于任何字符序列（字母或 01 串）$w = w_1w_2\cdots w_k$，我们说整数 $p\ (1\leq p < k)$ 是 $w$ 的周期，如果 $w_i = w_{i + p}$ 对于所有 $i = 1,\cdots,k - p$ 都成立。

我们用 $Per(w)$ 表示 $w$ 的所有周期的集合。

例如，$Per(\texttt{ABIABUABIAB})=\{6,9\},Per(\texttt{01001010010})=\{5,8,10\},Per(\texttt{0000})=\{1,2,3\}$。

Byteasar 决定将每个名字串 $S$ 改为一个 01 串 $T$，该串是满足 $|S|=|T|$ 且 $Per(S)=Per(T)$ 条件的字典序最小的 01 串。

例如，名字 `ABIABUABIAB` 应该改为 `01001101001`，`BABBAB` 改为 `010010`，`BABURBAB` 改为 `01000010`。

Byteasar 要求你编写一个程序，帮助将他的臣民的当前名字翻译成新名字。

如果你成功了，你可以作为奖励保留你现在的名字！

## 说明/提示

对于 $100\%$ 的数据，$1\leq k\leq20$，单个名字长度不超过 $200000$。

## 样例 #1

### 输入

```
3
ABIABUABIAB
BABBAB
BABURBAB```

### 输出

```
01001101001
010010
01000010```

# 题解

## 作者：Itst (赞：10)

[同步发布于cnblogs](https://www.cnblogs.com/Itst/p/12323615.html)

Updated On 2022.02.01：情况 4 细节添加，也算是解决了第一次做这个题的时候一些口胡上的疑惑

---

2011年就能出出这样充满科技感+脑力的题，佩服POI Orz

约定：字符串 $s$ 的下标从 $0$ 开始，$s_{i,j}$ 表示 $s$ 的第 $i$ 到第 $j$ 个字符构成的子串。

串 $s$ 有长度为 $l$ 的周期等价于其有长度为 $|s|-l$ 的 border。

---

设函数 $solve(s)$ 表示字典序最小的、border 集合与 $s$ 的 border 集合相同的 $01$ 字符串。分为以下情况：

1. 如果 $s$ 中所有字符相同，返回 $|s|$ 个 $0$ 构成的字符串；
2. 如果 $s$ 周期集合为空，返回 $|s| - 1$ 个 $0$ 接上 $1$ 个 $1$ 构成的字符串；
3. 如果 $s$ 最短的周期长度 $len$ 满足 $2len \leq |s|$，设 $t = s_{1,len}$，则 $s$ 可表示为 $ttt...tt'$ 的形式，其中 $t'$ 是 $t$ 的一个前缀，可为空。
4. 如果 $s$ 最短的周期长度 $len$ 满足 $2len > |s|$，设 border 为 $t$，那么 $s$ 就可以表示为 $tat$ 的形式，其中 $a$ 是一个任意字符串，不能为空。

1 和 2 情况的构造是显然的。

---

对于 3 情况，递归进入 $tt'$ 求解。设 $qq' = solve(tt')$，那么就把 $q$ 重复若干次拼上 $qq'$，即可得到答案。

在证明正确性前先来复习有关周期和 border 的几个 OI 界众所周知的简单定理。

- Weak Periodicity Lemma：对于一个字符串 $s$，若其有长度为 $p$ 和长度为 $q$ 的周期，且 $p+q \leq |s|$，则 $s$ 有长度为 $\gcd(p,q)$ 的周期。

Proof. 设 $p < q$，令 $d = q - p$。因为 $p + q \leq |s|$，所以 $\forall i \in [0,|s|-1] , i - p \geq 0$ 和 $i+q < |s|$ 至少有一个成立，故可以先向后跳 $q$ 再向前跳 $p$，或者先向前跳 $p$ 再向后跳 $q$，可得 $s_{i+d} = s_i$。那么 $q-p$ 也是 $s$ 的周期。根据辗转相除法，$\gcd(p,q)$ 也是 $s$ 的一个周期。`QED`

- 一个推论：设 $s$ 最短周期长度为 $l$，且 $2l \leq |s|$，则 $s$ 的 border 集合中 $\geq l + (|s| \bmod l)$ 的元素一定构成集合 $\{pl + (|s| \bmod l) | p \in Z^+ , pl + (|s| \bmod l) \leq |s|\}$。

Proof. 首先这些元素一定会包含在 border 集合内。考虑使用反证法证明不存在其他的元素。

设有不满足该形式的 border 长度 $l'$，不妨设 $l' = xl+(|s| \bmod l)+y(y \in [1,l-1])$。那么在 $s$ 的长度为 $(x+1)l + (|s| \bmod l)$ 的前缀中，$l'$ 是它的一个 border，即 $l-y$ 是这个前缀的周期，而 $l$ 也是其周期，且因为 $x \geq 1$ 有 $(x+1)l + (|s| \bmod l) \geq 2l-y$，根据 `Periodicity Lemma` 有 $\gcd(l,l-y)$ 是这个前缀的周期，同时 $\gcd(l,l-y) \mid l$ 所以 $\gcd(l,l-y)$ 是原串的一个周期，与 $l$ 是 $s$ 的最短周期长度不符。`QED`

---

根据推论我们可以知道如果 $q$ 串不是满周期串（即可划分为若干个部分满足各个部分的字符串完全相同），那么 $\geq |qq'|$ 的所有 border 都可以正确构造，而构造 $qq'$ 的时候将 $< |qq'|$ 的所有 border 都已经正确构造了，所以这样就是对的。

证明 $q$ 不是满周期串是简单的：如果 $q$ 是满周期串，不妨设 $q = p^c$，其中 $p$ 是一个字符串。那么 $|qq'|-|p|$ 是 $qq'$ 最长的 border。而如果在原串中有这样的一个 border 且 $q$ 是周期，那么可以立即导出 $p$ 是周期，那么 $q$ 就不是最小周期。

---

对于 4 情况，先递归进入 $s_{1,len}$ 求解。设 $t = solve(s_{1,len})$，那么我们需要确定一个字典序最小的字符串 $a$ 满足 $s=tat$ 的最长 border 为 $t$。

首先我们肯定希望 $a$ 是全 $0$ 的字符串。但是只有这一种选择显然不能覆盖所有的情况，比如 $t = 0000$ 时这样会使得最长 border 变大导致构造不合法。考虑在什么情况下以全 $0$ 串作为字符串 $a$ 会导致不合法。不妨讨论有一个更长的 border $l$：

- $l \leq |t| + |a|$，$t$ 串在前面加若干个 $0$ 等于在后面加若干个 $0$，可导出 $t$ 是全 $0$ 串。这种情况下可以选择若干个 $0$ 后面加上一个 $1$ 形成的字符串，这样就是最优。
- $l > |t| + |a|$，假设 $l$ 是最大的非平凡 border 长度，那么它有一个长度为 $2|t|+|a|-l$ 的周期。又因为 $|t|+|a|$ 也是它的周期，而 $2|t|+|a|-l$ 是最短周期，所以 $2|t|+|a|-l$ 是 $|t|+|a|$ 的约数，也就是说 $t+a$ 是一个周期串。此时 $2|t|+|a|-l \leq |a|$ 的情况 $t$ 就是全零较为平凡，而在 $2|t|+|a|-l > a$ 的情况下，我们总可以把 $t$ 表示为 $bab...bab$ 形式，其中 $b$ 是一个非全 $0$ 的字符串，且 $|ba| = 2|t|+|a|-l$。设 $a'$ 为将 $a$ 最后的 $0$ 换成 $1$ 得到的字符串，考虑把中间的 $a$ 换成 $a'$ 之后得到的字符串 $s'$。设它存在长度 $>|t|$ 的 border ，不妨设长度为 $l$：
- - $l < |t| + |a'|$，在 $t$ 前面加上 $000...001$ 和在后面加上 $000...000$ 得到相同的字符串，可以导出 $t$ 中一个字符需要既等于 $0$ 又等于 $1$，不可能；
- - $l \geq |t| + |a|$，我们称前面插 $a'$ 的串为串 $s$，后面插 $a'$ 的串为串 $t$，此时由两个字符串相等，可以知道 $s$ 里的 $a'$ 会跟 $t$ 里的 $baba...baba'$ 的一个长度为 $|a|$ 的子串匹配。首先它一定不会是 $a'$，否则这个 border 长度就是原串长度。同时 $a'$ 的最后一个字符（也就是 1）不能出现在 $a$ 和 $a'$ 中。也就是说 $a'$ 的 $1$ 一定在 $b$ 里面匹配，假设匹配了 $b_i$。这里再进行一些讨论：
- - - $i < |a|$，这意味着 $a'$ 的一段前缀 $0$ 是跟 $a$ 匹配的。注意到 $s$ 里 $a'$ 后面紧跟着的就是 $babab...bab$，根据相等，$b$ 有一个长度为 $L = |b| - i$ 的 border，而 $b$ 的周期是 $000\cdots001$，也就是说 $b$ 的最后 $i$ 个字符一定包含一个 $1$。而在 $s$ 里 $a'$ 前面的 $i$ 个字符就是 $b$ 的最后 $i$ 个字符，它们在 $t$ 里对应要相等的 $i$ 个字符是 $a$ 的前 $i$ 个字符，因此必定有一个字符既是 0 又是 1，矛盾。
- - - $i = |a|$，跟上面基本相同，但还需要考虑到的事情是 $s$ 可能恰好以 $a'$ 开头。这个时候转换一下目标，$s$ 里 $a'$ 后面的那个 $b$ 的长度为 $|a|$ 的后缀在 $t$ 里对应相等的是 $a$，所以也会有一个字符既是 $1$ 又是 $0$，矛盾。
- - - $i > |a|$，先不妨假设 $s$ 里 $a'$ 匹配的 $b$ 不是 $t$ 里的第一个，这样它前面有一个 $a$，剩余情况是类似的。设 $s$ 里 $a'$ 的前面 $i-|a|$ 个字符构成的字符串是 $c$，那么 $ca'$ 是 $b$ 的一个周期，那么 $b$ 的长度为 $i$ 的后缀应该是 $ca'$ 的一个 rotate（就是不断把最后一个字符丢到第一个做若干次得到的字符串）。同时可以发现 $a'$ 前面的 $i$ 个字符对应到 $t$ 上是 $ac$，且它是 $b$ 的一个后缀。也就是说 $ac$ 必定等于 $ca'$ 的一个 rotate，但是可以发现这两个字符串 1 的个数都不一样显然不可能相等，矛盾。

至此可以得出将 $a$ 的最后一个 $0$ 换成 $1$ 得到的串一定是合法的，而它显然是最优的。

---

梳理一下 $solve(s)$ 的流程：

1. 如果 $s$ 中所有字符相同，返回 $|s|$ 个 $0$ 构成的字符串；
2. 如果 $s$ 周期集合为空，返回 $|s| - 1$ 个 $0$ 接上 $1$ 个 $1$ 构成的字符串；
3. 如果 $s$ 最短的周期长度 $len$ 满足 $2len \leq |s|$，将 $s$ 表示为 $ttt...tt'$ 的形式，其中 $t'$ 是 $t$ 的一个前缀，可为空，设 $qq' = solve(tt')$，则返回 $q^{\lfloor \frac{|s|}{len} \rfloor}q'$；
4. 如果 $s$ 最短的周期长度 $len$ 满足 $2len > |s|$，设 $t = s_{1,len} , q = solve(t)$。检验 $t+000...000+t$ 的最长 border 是否为 $len$，若否将最后一个 $0$ 替换为 $1$，然后将该串返回。

至于如何 check 全 $0$ 串是否合法，暴力 KMP 一遍即可。由 $T(n) = T(\frac{n}{2}) + O(n)$ 可得复杂度为 $O(n)$。

---

## 作者：WeLikeStudying (赞：10)

- 本文将沿用[该文](https://www.luogu.com.cn/blog/luo1gu1zui1bang1/post-zi-fu-chuan-lun)的知识点进行讲解。
- 如果读者想要在本文讲解的基础上进行更严谨的证明，欢迎阅读[此文](https://www.luogu.com.cn/blog/luo1gu1zui1bang1/post-zi-fu-chuan-border)。
- 作者希望各位能够真正在正式比赛的时候迸发思维，因此作者刻意减少了高级的结论。

**题意**
- [链接](https://www.luogu.com.cn/problem/P3526)。
- 给定一个字符串，构造一个与原串长度相同且字典序最小的 $01$ 串，满足它的所有周期恰好是原字符串的所有周期。
- 测试组数不大于 $20$，字符串长度不大于 $2\times 10^5$。

**分析**
- 众所周知，所有的 $\text{border}$ 对应着字符串所有的周期，而所有的 $\text{border}$ 可以通过暴力跳 $\text{kmp}$ 的 $\text{fail}$ 指针构造出来，所以我们可以尝试这样一种递归的做法（假设我们已经通过 $\text{kmp}$ 求出了所有 $\text{fail}$ 指针）。
- 设 $f(x)$ 为对于 $s(1,x)$ 的答案，我们希望能够通过 $f(\text{fail}(x))$ 计算出 $f(x)$，现在问题就在于寻找这个关系。
- 我们会发现，如果我们 $f(x)$ 的前缀是 $f(\text{fail}(x))$ 的话，那么它的后缀也已经确定，现在我们的问题是：
- 若 $2\text{fail}(x)\ge x$，该串已经完全确定，它一定存在（不会有 $0$ 匹配上 $1$）？它一定合法吗？
- 若 $2\text{fail}(x)<x$，该串并未完全确定，我们需要如何才能使得该串合法（比如说样例的情况）？
- 对于第一个问题，由于 $01$ 串与原串的所有周期都是相同的，利用反证法容易说明：假设 $01$ 串没有我们想要的性质，那么就可以进一步说明它与原字符串的周期是不同的，所以，字符串一定存在，且合法。
- 接下来是第二步，我们需要找到一种字典序最小的方案使得不存在新的 $\text{border}$，注意到字符串的规模是减半的，我们可以寻找一种扫描整个串来确定的方法。
- 思考一下什么时候会发生匹配多一个 $\text{border}$，我们会发现是在一定是在填充的过程中又凑出了原字符串的第 $1$ 到 $\text{fail}(x)$ 个字符。
![](https://cdn.luogu.com.cn/upload/image_hosting/wtgmm69l.png)
- 直觉上这种情况很不容易满足（想想吧，依次排列 $4$ 个相同的字符串，而且它们的间距还有严格要求，而且题意保证有解耶），我们不妨依照字典序从小达到枚举中间所有可能的字符串，暴力 $O(n)$ 验证 $\text{fail}$ 有没有改变。
- 直觉上讲，枚举的次数不可能太大，所以它实际上一定跑得很快，[代码实现](https://www.luogu.com.cn/paste/1z2wc854)（不过作者由于错误的实现复杂度差点错了）。
- 我们回过头来，觉得这样的接近乱搞的做法还是令人不放心，所以作者将用一些简单的知识给出证明。

**证明**
- 事实上，填充只需要枚举全 $0$ 和末尾仅有 $1$ 的两种情况。
- 显然我们要求我们的串中不能出现四个连续的相同 $\text{border}$，且长度为 $\text{fail}(x)$，按顺序分别记作 $1$ 号，$2$ 号，$3$ 号，$4$ 号，则 $1,2$ 号和 $3,4$ 号的间隔大小相同。
- 下面分两种情况，如果 $1,3$ 串没有交，那么整个串就可以唯一确定：
![](https://cdn.luogu.com.cn/upload/image_hosting/2dd45wc4.png)
- 所以我们可以得出结论，除了 $f(\text{fail}(x))$ 是 $0^x$（全零串）和 $f(\text{fail}(x))$ 是 $0^x1$（末尾有一个 $1$） 的串（这种答案显然可以直接确定），其它的都不会在填充 $0^x,0^x1$ 的任何一个产生 $1,3$ 没有交的 $\text{border}$。
![](https://cdn.luogu.com.cn/upload/image_hosting/x56vlcrk.png)
- 接下来是 $1,3$ 彼此之间有交的情况：容易发现 $f(\text{fail}(x))$ 的最小周期也是 $1,2,3,4$ 的并（其实就是整个串的最小周期）所以这样的串至多只有一种可能。
- 所以填充只需要枚举 $0^x$ 和 $0^x1$ 两种情况。

---

## 作者：RioBlu (赞：6)

作为一个  kmp  构造黑题，代码虽然很短，但它的证明却是特别复杂，先膜  Itst 

**请注意任何一个border对应一个周期**

这里先列举有关  border  的定理：

 Weak Periodicity Lemma ：如果有一个字符串 $ s $ ，有周期： $ p $ 和 $ q $ ，且 $ p+q \leq |s| $ ，那么 $ gcd(p,q) $ 也是它的周期，（周期的定义是：对于一个周期 $p$ ，字符串的所有的字符 $s(i)$ 满足： $s(i)=s(i+p)$ ）

___
**证明：**

不妨让 $ p>q $ 

对于任意一个字符 $s(i)(i \in [0,|s|-1]) $ ，因为$p+q \leq |s|$,所以 $i-p \geq 0$ 和 $i+q<|s|$ 必有一个满足

如果 $i-p \geq 0,s(i-p)=s(i-p+q)$

同理，也证明出 $i+q<|s|$ 的情况。 

所以 $p-q$ 也是字符串 $s$ 的周期。 

不断更损相减，求出 $gcd(p,q)$ 也是字符串的一个周期。 

___
假设 $ Solve(x) $ 代表，构造一个 $ 01 $ 串满足字典序最小，且满足前 $ x $ 个字符的周期与该 $ 01 $ 串的周期一样。 

不妨分类讨论：

* 如果这个字符串没有border，那么如果长度为一，构造一个 $ [0] $ 串，否则构造一个 $ [0,0,0,...,1] $ 串即可

* ②这个字符串有最长 $ border:len $ ，且 $ 2len>|x| $ 

* ③这个字符串有最长 $ border:len $ ，且 $ 2len \leq |x| $ 
___
对于②，我们可以把图画出来：

![](https://cdn.luogu.com.cn/upload/image_hosting/pjgkf3lc.png)

看得出来 $ AB $ 与 $ CD $ 相等， $ B=C $ ，这个时候不妨先 $ Solve(|AB|) $ 

求出 $ AB $ 的最小情况，这个时候就可以转移了， $ D $ 串等于 $ AB $ 串的后面 $ |D| $ 个就可以了，这样子，肯定满足了 $ border $ 相等，但是，这一定是字典序最小的吗？

想一想还真是，首先根据定义， $ AB $ 是字典序最小的，你要是说 $ D $ 可以更小，但此时 $ D $ 串小了， $ AB=CD $ ，所以 $ |AB| $ 最后面长 $ |D| $ 的字符串还能更小，这和 $ AB $ 是字典序最小的有矛盾。 
___
这个时候就要开始讨论伟大③情况了： 

首先这个情况一定是 $ s=tat $ 的一种形式， $ |t| $ 为最大 $ border $ 。 

我们会想到字典序最小，说明 $ a $ 最好是一个 $ [0,0,0...,0] $ 串，但是这可能会导致一个更大的 $ border:l $ 产生，与我们此时 $ |t| $ 是最大的 $ border $ 矛盾。 

这个时候我们分类讨论 $ l $ 的情况，然后把 $ a $ 进行调整，避免更大的 $ border:l $ 产生：

 $ 1. $  如果 $ l \leq |t|+|a| $ 

![](https://cdn.luogu.com.cn/upload/image_hosting/3z9v7ilh.png)

所以捏，只要把 $ a[0,0,0...0] $ 变成 $ [0,0,0,...,0,0,1] $ 就可以扼杀这个可恶的 $ l $ 了。 

 $ 2. $  如果 $ l>|t|+|a| $ 

假设这个 $ l $ 是最大的 $ border $ ，但又不是整个字符串，那么这个字符串的最短周期是 $ 2|t|+|a|-l $ ，而 $ |t|+|a| $ 也是字符串的一个周期，那么 $ |t|+|a| $ 整除 $ 2|t|+a-l $ 。 

如果 $ 2|t|+|a|-l \leq |a| $ ，那么说明这个字符串是全 $ 0 $ 串；而在 $ 2|t|+|a|-l>|a| $ 的情况，因为 $ |t|+|a| $ 整除 $ 2|t|+a-l $ ，所以我们就有：

![](https://cdn.luogu.com.cn/upload/image_hosting/qxgwpjqo.png)

蓝色是 $ t $ 串，红色是 $ a $ 串( $ tat $ 嘛！)，不如把图中最后一个周期的 $ a $ 的的剩余部分称为 $ b $ ，而每个周期都是 $ ba $ 的形式，所以 $ t $ 串可以表示为一个 $ baba...babab $ 的形式，易知这个 $ b $ 串不是全 $ 0 $ 的。 

不如把 $ tat $ 中间的 $ a[0,0,0...0] $ 变成 $ a'[0,0,0,...,0,0,1] $ 。 

最终 $ tat $ 是一个 $ baba...bab\ a'\ baba...bab $ 串，这个时候我们觉得应该没有更长的 $ border:l'(l'>|t|) $ 了吧，我们不知道，所以用反证法，假设这个时候存在一个 $ border:l'(l'>|t|) $ 。 

 $ 2.1 $  如果 $ l'<|t|+|a'| $ ，我们再用一次 $ 1. $ 中的循环等于： 

![](https://cdn.luogu.com.cn/upload/image_hosting/0s9iapuu.png)

上面的字符串就是 $ tat $ 

这样子不断类推得到左边的那个 $ l' $ 是全 $ 0 $ 串。 

但是你发现了吗？右边的 $ l' $ 不是全0串。 

- “所以呐，不成立。”  myj  摇摇手指说道。 

 $ 2.2 $  如果 $ l' \geq |t|+|a'| $ ，上图： 
 
![](https://cdn.luogu.com.cn/upload/image_hosting/8npw0qlx.png)

右边的 $ l' $ 中的 $ a' $ 应该会在左边 $ l' $ 的长度为 $ |a'| $ 的字符串对应，而这个对应的肯定不是左边 $ l' $ 的 $ a' $ ，而且 $ a' $ 最后一个字母不在 $ a $ 和 $ a' $ 里面。

同时我们应该知道这个 $ a' $ 是在 $ ta't $ 中前面的 $ t $ 中对应。 

  myj  摇摇手指说：“这个时候我们最爱的分类讨论来了。”

所以我们知道 $ a' $ 最后一个字母在左边对应的地方在一个 $ b $ 里，设是 $ b $ 的第 $ i $ 个字母。 

 $ 2.2.1 $  如果 $ i<|a'| $ 

那么说 $ a' $ 有一段前缀会在 $ a $ 里面对应，而且我们发现这个 $ a' $ 后面是 $ babab..bab $ ，也就是说 $ a' $ 最后一个字母对应了 $ b_i $ ，而这个以 $ b_{i+1} $ 字母的后缀会和 $ b $ 的前缀匹配，是不是很像 $ border $ 的定义，是的，就是。 

所以 $ b $ 有一个 $ border $ ，长度为 $ |b|-i $ 。 

而这个 $ border $ 就是 $ 000..01 $ 。 

之前那个[ $ b $ 的前缀]的最后的 $ i $ 个字母会和 $ a $ 对应，而b最后这个数字就是 $ 1 $ 。 

图片：
 
![](https://cdn.luogu.com.cn/upload/image_hosting/hwmx1gai.png)

（最下面的 $ ...a'b... $ 代表的是右边的 $ l' $ ）

可以看到 $ b $ 最后一个字母 $ 1 $ 会在 $ a $ 中，这不可能。 

 $ 2.2.2 $  如果 $ i=|a'| $ 

和 $ 2.2.1 $ 基本类似，但是如果：
 
![](https://cdn.luogu.com.cn/upload/image_hosting/8npw0qlx.png)

这个右边的 $ l' $ 是以 $ a' $ 开头。 

![](https://cdn.luogu.com.cn/upload/image_hosting/7yqny645.png)

我们还是这样对应，看到，又矛盾了。 

 $ 2.2.3 $  如果 $ i>|a'| $ 

![](https://cdn.luogu.com.cn/upload/image_hosting/tly9dcy8.png)

（下面的是右边的 $ l' $ ）

不妨假设对应 $ a' $ 的 $ b $ 前面还有 $ a $ （没有 $ a $ 的情况类似）。 

假设 $ b_1 $ 到 $ a' $ 前端这一段为 $ c $ ，可以看得出来 $ ca' $ 是 $ b $ 的一个周期。 

![](https://cdn.luogu.com.cn/upload/image_hosting/zxgcyh5a.png)

设 $ d $ 是 $ b $ 的后 $ i $ 个字母组成的串，可以看到 $ d $ 应该是把前面的 $ ca' $ 前面一段，搬到 $ a' $ 右边的蓝色段。 

![](https://cdn.luogu.com.cn/upload/image_hosting/w6p83piz.png)

然后把a'前 $ i $ 个字符组成的字符串称为 $ d' $ ，可以看出 $ d' $ 是b的后缀，且d'是恰好等于 $ ac $ 的（长度为 $ i $ ）。 

你看： $ ac $ 是 $ b $ 的后缀， $ ca' $ 也是 $ b $ 的后缀，然而 $ ac $ 中的 $ 1 $ 的个数和 $ ca' $ 中的1的个数不一样啊。 

所以这个情况不可能。 

___

所以我们要是 $[0,0,0...,0]$ 没有问题就把 $a$ 变成它。 

否则变成 $ [0,0,0...,0,0,1]$ 就不会创造新的 border 。 

结论简单，但是证明很难啊！


---

## 作者：Yansuan_HCl (赞：0)

## 记号

用大写表示串，小写表示串的长度。用希腊字母表示周期，以示区分。

## Border 与周期互化

若串 $S$ 有长度为 $p$ 的 border，则有长度为 $\pi = |S|-p$ 的周期。

## 弱周期引理

若串 $S$ 中有周期 $\Pi, \Chi$，其长度为 $\pi, \chi$，且 $\bold{\pi+\chi} \le |S|$，则 $\gcd(\pi, \chi)$ 为周期。

> 证明：由周期关系有 $s_i=s_{i\bmod \pi}=s_{i\bmod \chi}$，由裴蜀定理，仅当 $s$ 存在周期 $\gcd(\pi, \chi)$ 时能满足条件。

## 分类讨论

记 $f(S)$ 为由 $S$ 构造出的串。取 $S$ 的最小周期串记为 $\Alpha$，则 $S$ 形如 $\Alpha \ldots \Alpha \Alpha'$，其中 $\Alpha'$ 是 $\Alpha$ 的前缀。我们希望能通过周期或 border 引入的相等关系进行递归构造。

### $\Alpha$ 完整出现至少两次

由周期性，我们希望仅通过求 $f(T),T=\Alpha \Alpha '$ 就能得到 $f(S)$；此时最小性已经满足，下面证明这样构造的串 $\Beta \ldots \Beta \Beta '$ 与原串具有相同的 border 集合。

设 $p$ 为讨论的 border 长度。

- $p \le \beta + \beta '$，显然已经满足。
- $p > \beta + \beta '$：
  - 若 $S$ 有 border $p$，则 $f(S)$ 有 border $p$。$S$ 有对应周期 $\pi = n-p$，由 $\beta$ 是 $S$ 最小周期可知 $\beta \mid \pi$；$f(S)$ 也有周期 $\beta$，得证。
  - 若 $f(S)$ 有 border $p$，则 $S$ 有 border $p$。$f(S)$ 有对应周期 $\pi = n-p < n-\beta+\beta'$。反证：若 $\beta \nmid \pi$，则存在周期 $\theta = \gcd(\beta, \pi)<\beta$；此时 $\theta$ 是 $\Beta$ 的周期，与 $\Beta\Beta'$ 最小周期为 $\Beta$ 矛盾。

### $\Alpha$ 完整出现不超过一次

此时再递归 $\Alpha\Alpha'$ 没有意义。设 $a=n-|\Alpha|$ 为 $S$ 的最长 border，则 $S$ 形如 $AXA$，且 $x\ge 1$。最好能先递归求 $f(A)$ 再确定 $X$ 对应的串。**不妨大胆猜测 $X$ 对应的串可以全部填 $0$，记 $f(S)=BYB$，$Y$ 全 0。**

但是这样可能引入 $> a$ 的 border，需要调整。字典序最小的调整方法是将 $Y$ 最后一位改为 1，记为 $Z$。**下面证明 $BZB$ 一定合法**。

设 $BYB$ 的最长 border $c > a$，其对应的周期为 $\sigma=n-c$ 为 $BYB$ 的最小周期。由 border $a$，$BYB$ 有周期 $\alpha=n-a=a+x$，此时 $\sigma \mid \alpha$，即 $\Sigma$ 是 $BY$ 的整周期。

- 若 $\sigma \le x$，则 $BY$ 为全 0 串；此时将 $Y$ 换成 $Z$ 一定合法。

此时 $\sigma >x$，$\Sigma=DY$，其中 $D$ 是非全 $0$ 的串。则 $BYB=(DY)^kD\red{Y}(DY)^kD$，$BZB=(DY)^kD\blue{Z}(DY)^kD$。

反证：设 $BZB$ 有 border $e>a$。

- 若 $e < a+x$，则前后 $e$ 个字符中 1 的数量不同，不合法。
- 否则 $e\ge a+x$。$BZB$ 有周期 $\epsilon=n-e \le \alpha-x<\alpha$，可推出有周期 $\theta=\gcd(\alpha, \epsilon) <\epsilon$。
  - 当 $\epsilon < a-d$，即 $e > a+x+d$ 时：
    - $\theta = \gcd(\alpha,\epsilon) = \gcd(\epsilon, a+x-\epsilon)> d+x=\sigma$；
    - 且 $\theta \le \epsilon < a-d = k\sigma$。
    - 若 $\sigma \nmid \theta$，则 $(BY)^k$ 有周期 $\gcd(\sigma, \theta) < \sigma$，矛盾。
    - 因此，$\theta = k'\sigma \le k\sigma$，$BZB$ 有循环节 $(DY)^{k'}$，可推出 $DY=DZ$，矛盾。
  - 当 $\epsilon \ge a-d$，即 $e \le a+x+d$ 时：
    - 取出 $E$ 长为 $\sigma$ 的后缀 $F$，则 $F=D[e-(a+x),d)ZD[0,e-(a+x))$；由 border，$F=(BZB)[n-\sigma, n)=YD$。$F$ 与 $YD$ 间 1 的数量不同，矛盾。

故得证。

每次递归规模减少到不超过 $\frac 2 3 n$，时间复杂度 $O(n)$。

---


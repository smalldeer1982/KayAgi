# [GDCPC 2024] 田字格

## 题目背景

数据、标程、题解等资源的获取：<https://gitlink.org.cn/thusaa/gdcpc2024>

## 题目描述

小 I 正在学习练字，可当他打开白纸时才想起来自己之前无聊在白纸上将 $n$ 条线段涂黑了，纸上其他部分都是白的。

这 $n$ 条被涂黑的线段都是水平的或者竖直的：以白纸中心为原点，平行白纸的某条边构建 $x$ 轴，另一条边构建 $y$ 轴，那么每条被涂黑的线段的两个端点 $(x_1,y_1)$ 和 $(x_2,y_2)$ 满足：$x_1 = x_2$ 和 $y_1 = y_2$ 恰有一个成立。同时，任意两条水平的线段没有交点，任意两条竖直的线段没有交点。

尽管涂黑的线段很让小 I 糟心，深谙福祸相依的小 I 还是发现，涂黑的 $n$ 条线段构成了若干田字格，而他可以在这些田字格上练字。

田字格可以由三元组 $(x_0, y_0, d)$ 描述。一个三元组 $(x_0, y_0, d)$ 是田字格当且仅当以下条件成立：

- $x_0, y_0 \in \mathbb{R}$, $d \in \mathbb{R}^+$；
- 设 $R = [x_0-d,x_0+d] \times [y_0-d,y_0+d]$，即横坐标在 $[x_0-d,x_0+d]$ 内、纵坐标在 $[y_0-d,y_0+d]$ 内的所有点。那么 $R$ 中被涂黑的部分恰好构成六条线段，且这六条线段分别是 $x=x_0-d,x=x_0,x=x_0+d,y=y_0-d,y=y_0,y=y_0+d$ 这六条直线与 $R$ 的交。

小 I 于是想想算算白纸上有几个田字格，也就是有多少个满足以上条件的三元组 $(x_0,y_0,d)$。但按照惯例小 I 不会算，所以这个任务交给了你。

## 说明/提示

![](https://cdn.luogu.com.cn/upload/image_hosting/9hq95rak.png)

如上图所示，$(5, 5, 5), (5, 0, 5), (5, -5, 5)$ 是三个合法的田字格。注意以下几个都不是田字格：

- $(0, 0, 10)$，因为除了需要的六条线段以外还有其他部分被涂黑了；
- $(-5, 5, 5)$，因为 $x=-5$ 与正方形的交没有被涂黑。

## 样例 #1

### 输入

```
10
-10 -10 -10 10
0 -10 0 10
10 -10 10 10
-10 -10 10 -10
-10 0 10 0
-10 10 10 10
5 -10 5 10
-10 5 10 5
-2 0 -2 10
-5 -5 10 -5```

### 输出

```
3```

# 题解

## 作者：xiezheyuan (赞：2)

不懂这道题怎么评上黑的，也许是太难码了场上没人写吧。

## 简要题意

给定 $n$ 条线段，仅包含垂直线段（$x_1=x_2$）和水平线段（$y_1=y_2$），保证任意两条垂直线段 / 水平线段无交。

你需要计算有多少个田字格。定义一个田字格 $(x_0,y_0,d)$ 表示存在点 $(x_0,y_0)$ 和边长 $d$，使得区域 $U=[x_0-d,x_0+d]\times [y_0-d,y_0+d]$ 存在且仅存在六条线段，且这六条线段分别为 $x=x_0-d,x=x_0,x=x_0+d,y=y_0-d,y=y_0,y=y_0+d$ 分别与 $U$ 的交。

$1\leq n\leq 3\times 10^5$。

## 思路

田字格可以拆成两个部分：

- 三条垂直直线 $x=x_0-d,x=x_0,x=x_0+d$ 与 $U$ 的交。
- 三条水平直线 $y=y_0-d,y=y_0,y=y_0+d$ 与 $U$ 的交。

先来考虑怎样的三条垂直的线段可能可以贡献答案，可以发现它应当满足：

1. 两两相邻线段的距离应当均为定值 $d$。
2. 任意两条相邻线段间没有其他垂直线段。
3. 设三条线段的上端点的最小纵坐标为 $R$，下断点的最大纵坐标是 $L$，则 $R-L\geq 2d$。

考虑按照纵坐标扫描线，当一条垂直线段被加入 / 删除时统计三条垂直线段组。那么这样的线段组可以用 `std::set` 维护，这样我们可以方便地寻找前驱后继来满足条件 $2$，找到后验证是否满足条件 $1$ 即可。可以发现扫描线的每一轮我们只会找出 $O(1)$ 个（准确来说是 $5$ 个）三条垂直线段组来判断是否满足条件，所以总共只有 $O(n)$ 个满足条件的线段组。

注意这里有一个技巧，可以在生长线和消亡线时都将线段组放进同一个向量中，这样奇数位就是 $L$，偶数为就是 $R$ 非常方便。

水平线段是类似的，现在只需要考虑两个线段组是否可以贡献答案。我们不妨对于每一个线段组，记录 $(d,x,L,R)$ 表示距离、该线段组中间的那条的横坐标 / 纵坐标，以及存在区间 $[L,R]$（上面求出的）。

那么你会发现水平线段组 $(d_0,x_0,L_0,R_0)$ 和垂直线段组 $(d_1,x_1,L_1,R_1)$ 可以贡献，当且仅当：

- $x_1\in [L_0+d_0,R_0-d_0]$。
- $x_0\in [L_1+d_1,R_1-d_1]$。
- $d_0=d_1$。

于是可以按照 $d$ 分组，组内离散化后扫描线 + 树状数组即可。时间复杂度 $O(n\log n)$。

[Submission](https://qoj.ac/submission/1173852)。

---


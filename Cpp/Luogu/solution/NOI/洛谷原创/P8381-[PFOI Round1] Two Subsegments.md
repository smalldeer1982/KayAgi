# [PFOI Round1] Two Subsegments

## 题目背景

>洛谷知名网红，€€£官方团队团主 [€€£](https://www.luogu.com.cn/user/559616) 同志，因联合省选寄，医院抢救无效，于 4 月 17 日 g 了。

> [€€£](https://www.luogu.com.cn/user/559616) 是知名洛谷人，2021年加入洛谷，同年成立 €€£ 官方团队。在他在位期间勤勤恳恳，认真整活，发奋出题，为整活革命化、现代化、正规化建设作出了贡献。

对于 [€€£](https://www.luogu.com.cn/user/559616) 的退役，[Uvocde](https://www.luogu.com.cn/user/111084) 深感悲痛。这时，他想起了 [€€£](https://www.luogu.com.cn/user/559616) 对构造的深爱，于是便出了这道题来缅怀 [€€£](https://www.luogu.com.cn/user/559616)。

## 题目描述

有 $T$ 组询问，每组询问给出一个长为 $n$ 的序列 $a$，保证 $a$ 是 $1\sim n$ 的排列。

你可以选择一个数 $x$，然后你每次可以将一段长为 $x+1$ 或一段长为 $x-1$ 的序列在原序列中前移或后移 $x$ 位，将经过的部分移到空出来的地方。

请在 $80\times n$ 次内将 $a$ 排成升序。

## 说明/提示

【样例解释】

对于 $2\ 1\ 4\ 7\ 6\ 5\ 3$ 这组样例：

$x$ 取 $3$，共进行 $4$ 次操作：

0. **2 1 4 7** 6 5 3，向右平移；
1. 6 **5 3** 2 1 4 7，向右平移；
2. **6 2** 1 4 5 3 7，向右平移；
3. 1 4 5 6 **2 3** 7，向左平移；
4. 1 2 3 4 5 6 7，排序完成。

 
---

【数据范围】
  
  对于 $100\%$ 的数据，$1\le T\le10^4,\ 2\le n\le 10^4,\ \sum n\le10^4$，**保证排列在所有排列中等概率随机**。  
  
 | $\text{Subtasks}$ | 测试点数 | 数据范围 |分值 |
| :-----------: | :-----------: | :-----------: | :-----------: |
| $\text{Subtask0}$ | $1$ | $n\leq 5$ | $\text{2pts}$ |
| $\text{Subtask1}$ | $7$ | $n\leq 50$ |$\text{7pts}$ |
| $\text{Subtask2}$ | $9$ | $n\leq 10^3$ |$\text{27pts}$ |
| $\text{Subtask3}$ | $14$ | $n\leq 5\times 10^3$ |$\text{27pts}$ |
| $\text{Subtask4}$ | $9$ | $n\leq 10^4$ | $\text{37pts}$ |


## 样例 #1

### 输入

```
2
7
2 1 4 7 6 5 3
2
2 1```

### 输出

```
3
4
1 1 4
1 2 3
1 1 2
0 5 6
-1```

# 题解

## 作者：gyc18 (赞：6)

此题解为官方题解

爆搜打表可以发现：能够取某一个 $x$ 归位的排列必须满足逆序对数为偶数。同时取 $x\leq n/2$ 的时候都可以归位所有逆序对数为偶数的排列。

有如下做法：

取一个偶数为 $x$。

**Step 1：将 $[1,n-2x-1]$ 以内的元素归位。**

这一步非常简单，对于一个元素 $x$，当它旁边空余元素很多的时候，可以：

- 用 1 次操作移动 $x-1$ 个元素到它的右边；
- 用 2 次操作移动 $2$ 个元素到它的右边。（注意这个在一开始的几个左边不够用的时候要用右边的作为中转来输送 2 个元素）

由于 $x-1$ 是奇数，所以这样足以凑出所有 $\geq x-1$ 的数，且每个数都只需要 $O(n/x)$ 次操作。这一步复杂度为 $O(n^2/x+nx)$。

**Step 2：将剩下的元素归位。**

等价于用 $x$ 排序长度为 $2x+1$ 的排列。

首先我们构造一种操作将第一个元素向后移两位：

- $[1,x+1]$ 右移；
- $[1,x+1]$ 右移；
- $[3,x+1]$ 右移；
- $[3,x+1]$ 右移。

反过来就是把第一个元素向左移两位。

那么我们先不断右移 $[1,x+1]$ 把 $2x$ 转到第一位，然后把 $2x$ 右移 2 位，再把 $2x$ 转到第一位（这只需要 4 次），再右移 2 位……如此循环。如果最后 $2x$ 和 $2x+1$ 正好相邻，那么 $2x$ 归位；否则把中间那个左移两位，也能使 $2x$ 归位。

然后依次递减处理就可以了。容易证明这个做法在有偶数个逆序对的时候是对的。

由于我们可以线性次操作复位一个元素，所以构造量级是 $O(x^2)$。

总构造量级是 $O\left(\dfrac{n^2}{x}+nx+x^2\right)$。取 $x=O(\sqrt n)$ 得到最低构造量级 $O(n\sqrt{n})$。

这样直接实现的常数比较大，对第一部分有一种比较有效的剪枝：到最后小步输送元素的时候，如果发现到某一个时刻右边恰好剩 $x$ 个，那么直接给左边挂点东西然后推过去，可以省去 $x-1$ 次操作。加上就可以过了。

数据随机是因为这玩意我没法卡，直接逆序跑的比随机次数还少，逆序小范围随机打乱也卡不住，，，

---

## 作者：irris (赞：2)

## Preface

收到了 Solystic 老师的指导，复读一下官方题解。

## Solution

![](https://cdn.luogu.com.cn/upload/image_hosting/dnfprfwo.png)

![](https://cdn.luogu.com.cn/upload/image_hosting/09r55off.png)

![](https://cdn.luogu.com.cn/upload/image_hosting/e4f1b6t1.png)

$\mathbf{proof.\ 1}$

+ 通过任意交换，一个序列还原为有序序列的次数与逆序对个数的奇偶性相同。
+ 考虑每一次交换，把它看做将逆序序列还原为有序序列的操作，那么逆序对个数为 $x(x \pm 1)$（前后区间各自有序，唯一的贡献在于前面的所有数与后面的所有数一一对应），故逆序对奇偶性不变。
+ 上文中的黄 $2$，蓝 $3$，绿 $1$ 的情况对应的是逆序对个数为奇数，故它会直接被判为无解。
+ 同样地，这也证明了为何逆序对数为奇数时无解，以及为何这种做法是正确的。

---

$\mathbf{prune.\ 1}$

~~这部分还是复读的官方题解。~~

+ 容易发现如果在第一张幻灯片中归位 $[1, n - 2x - 1]$ 的时候如果存在一个数距离它应到的位置是 $\leq x - 1$ 的偶数那么要一直 $+2$ 直到 $2x - 2$ 的位置才能换回去。
+ 但是你会发现 $x$ 也是一个偶数，而很显然我们可以把一个数往左平移 $x$ 的位置。于是到这里就可以直接剪枝了，大概在 $\mathcal O(\frac{n^2}{x})$ 的复杂度上常数可以小一半。

---

$\mathbf{prune.\ 2}$

考虑在 Step1 复位的时候让距离一直不减而不是反复增加，常数会比较小。~~不这样剪枝只能过 $\sout{n \leq 5\times 10^3}$，clcn 丧尽天良~~。

---


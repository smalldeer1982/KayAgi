# 『STA - R9』真空介电常数

## 题目背景

请注意：题目背景与题目**可能没有**关系。

这天，小周在学习很快的筛法，他对洲阁筛 $O\left(\frac{n^{3/4}}{\log n}\right)$ 复杂度的记号很不满。为什么一个不需要使用 bitset 的算法，它的复杂度里要有除法？

小周突然有了一个好的想法。由于对数函数的阶低于幂函数，我们让 $\epsilon$ 表示无穷小，就可以让 $\log n = O(n^\epsilon)$ 了！这样，小周兴冲冲地想，我们可以直接让 $\log n$ 对应某个特定的无穷小 $\epsilon _0$，于是洲阁筛的复杂度就可以被记成 $O(n^{3/4 - \epsilon_0})$ 了！

真好看啊！

这时一个 whk 同学走了过来。

“你们信息学，怎么还需要真空介电常数啊？”

## 题目描述

给定正整数 $n, m, s$，保证 $\gcd(n, s) = 1$。求
$$\sum_{k = 1}^{n-1} \sin^{-2m} \left(\frac{ks}{n}\pi\right)$$
在模 $998244353$ 意义下的值。

可以证明答案一定是有理数，关于有理数如何取模可以参考 [P2613 有理数取余](/problem/P2613)。

## 说明/提示

| $\textbf{Subtask}$ | $n\le$ | $m\le$ | $s\le$ | 分值 |
| :-----------: | :-----------: | :-----------: | :-----------: | :-----------: |
| $1$ | $3$ | $3$ | $1$ | $5$ |
| $2$ | $10^5$ | $1$ | $1$ | $10$ |
| $3$ | $10^5$ | $50$ | $10^{18}$ | $20$ | 
| $4$ | $50$ | $10^5$ | $10^{18}$ |  $20$ | 
| $5$ | $10^5$ | $10^{18}$ | $10^{18}$ |  $45$ | 

对所有数据，保证 $1\le n \le 10^5$，$1\le m,s \le 10^{18}$。

提示：请选手注意复杂度中的常数因子对程序运行效率的影响。

## 样例 #1

### 输入

```
4 3 1```

### 输出

```
17```

## 样例 #2

### 输入

```
11451 19198 11451419198```

### 输出

```
473735219```

# 题解

## 作者：飞雨烟雁 (赞：14)

之前考虑系数提取时就想过用 Bostan-Mori 算法提取 $\log P(x)$ 的远端系数，赛时看到了相同的 idea，就做了一下，结果拿下了唯一一杀。

---

首先因为 $\gcd(s,n)=1$，$ks$ 必然遍历 $1,2,\cdots,n-1$，可以不管，即不妨设 $s=1$。

记 $s_k=\sin(k\pi /n)^2$，则

$$\sum_{k=1}^{n-1}s_k^{-m}=[x^{m-1}]\left(\sum_{k=1}^{n-1}\frac{1/s_k}{1-x/s_k}\right).$$

记 $F(x)=\prod_{k=1}^{n-1}(1-x/s_k)$，做通分后有

$$\sum_{k=1}^{n-1}s_k^{-m}=[x^{m-1}]\frac{-F'(x)}{F(x)}.$$

那么，只要我们求出了 $F(x)$，就能用 Bostan-Mori 算法在 $\Theta(n\log n\log m)$ 的时间内求出答案。

不同于官方题解，我们这里从 Chebyshev 多项式的角度出发，推导 $F(x)$ 的表达式。

记 $G(x)=\prod_{k=1}^n(x-s_k)$（注意连乘上限为 $n$），则 $F(x)=G(x)/[G'(0)x]$，下求 $G(x)$。

采用二倍角公式，有

$$\begin{aligned}G(x)&=\prod_{k=1}^n\left(x-\sin^2\frac{k\pi }n\right)\\&=\prod_{k=1}^n\left(x-\frac 12+\frac 12\cos\frac{2k\pi}{n}\right).\end{aligned}$$

这表明若定义 $H(x)=\prod_{k=1}^n(x-\cos\frac{2k\pi}{n})$，则

$$G(x)=\left(-\frac 12\right)^nH(1-2x).$$

而 $H(x)$ 是存在通项的，可以写为

$$H(x)=-2^{1-n}+n\sum_{t=0}^{n/2}\dfrac{(n-t-1)!}{t!(n-2t)!}\left(-\frac {1}4\right)^{t}x^{n-2t}.$$

证明请见 [数学杂记【101 - 115】](https://www.luogu.com.cn/paste/qu3slexx)第 113 条，或见下文附录。

这样我们只需预处理组合数，然后做一次多项式平移就可以求出 $F(x)$ 了。

此题比较卡常，实现 Bostan-Mori 算法时可以采用 [这篇 Blog](https://www.luogu.com.cn/article/oggmoj4k) 的优化。或者考虑递归到 $m<n$ 时，令 $n=\min\{n,m\}$，这样做的时间复杂度为 $\Theta(n\log n\log (m/n))$，常数大约可减少 $25\%$ 左右。

---

**附录**：

记 $\omega_n=\exp(2\pi i/n)$，熟知 $x^n-1=\prod_{k=1}^n(x-\omega_n^k)$。我们凑出共轭形式：

$$\begin{aligned}(x^n-1)^2&=\prod_{k=1}^n(x-\omega_n^k)\prod_{k=1}^n(x-\omega_n^{-k})\\&=\prod_{k=1}^n\left(x^2+1-2\cos \frac{2\pi k}n{x}\right)\\&=(2x)^n\prod_{k=1}^n\left(\dfrac{x^2+1}{2x}-\cos \frac{2\pi k}n\right).\end{aligned}$$

于是有：

$$\begin{aligned}\prod_{k=1}^n\left(x-\cos\frac{2k\pi}{n}\right)&=2^{-n}(x^n+x^{-n}-2)\circ \left(\frac{x^2+1}{2x}\right)^{\!\left<-1\right>}\\&=2^{-n}(x^n+x^{-n}-2)\circ (x+\sqrt {x^2-1}).\end{aligned}$$

我们可以继续做推导，得到它各项系数的表达式：

$$\begin{aligned}\prod_{k=1}^n\left(x-\cos\frac{2k\pi}{n}\right)&=2^{1-n}\left[-1+\sum_{k}\binom{n}{2k}x^{n-2k}(x^2-1)^k\right]\\&=2^{1-n}\left[-1+\sum_{k,t}\binom{n}{2k}\binom{k}{t}x^{n-2k+2t}(-1)^{k-t}\right]\\&=2^{1-n}\left[-1+\sum_{t}x^{n-2t}(-1)^{t}\sum_k\binom{n}{2k}\binom{k}{t}\right].\end{aligned}$$

后面这个和式在[这个问题](https://www.zhihu.com/question/644534994/answer/3398192261)中也出现过，我们的做法是生成函数 + 转回和式。

$$\begin{aligned}\sum_k\binom n{2k}\binom kt&=[x^n](1+x)^n\frac{x^{2t}}{(1-x^2)^{t+1}}\\&=[x^{n-2t}]\frac{(1+x)^{n-t-1}}{(1-x)^{t+1}}\\&=\sum_{k}\binom{k+t}{k}\binom{n-t-1}{n-2t-k}\\&=\dfrac{(n-t-1)!}{t!(n-2t)!}\sum_{k}(k+t)\binom{n-2t}{k}\\&=\dfrac{(n-t-1)!}{t!(n-2t)!}n2^{n-2t-1}.\end{aligned}$$

代入上式即可。这个多项式也可以用 Chebyshev 多项式表示，即 $\prod_{k=1}^n(x-\cos\frac{2k\pi}{n})=2^{1-n}[T_n(x)-1]$。

---

## 作者：joke3579 (赞：9)

## 正弦函数

> 给定 $n, m, s$，保证 $\gcd(n, s) = 1$。求
> $$\sum_{k = 1}^{n-1} \sin^{-2m} \left(\frac{ks}{n}\pi\right)$$
> 在模 $998244353$ 意义下的值。
>
> $n\le 2\times 10^5，m, s \le 10^{18}$。

下面视 $n, m$ 同阶。

容易根据剩余系的性质知道 $s$ 对答案没有影响，下面按 $s = 1$ 推导。

$$\begin{aligned}
& \sum_{k = 1}^{n-1} \sin^{-2m} \frac{k\pi}{n}
\\ = \ & \sum_{k = 1}^{n-1} \frac{\left(\sin^2\frac{k\pi}{n} + \cos^2 \frac{k\pi}{n} \right)^m}{ \sin^{2m} \frac{k\pi}{n}}
\\ = \ & \sum_{k = 1}^{n-1} \sum_{i = 0}^m \binom mi \frac{\sin^{2i} \frac{k\pi}{n}\cos^{2m - 2i} \frac{k\pi}{n}}{ \sin^{2m} \frac{k\pi}{n}}
\\ = \ & \sum_{k = 1}^{n-1} \sum_{i = 0}^m \binom mi \cot^{2m - 2i} \frac{k\pi}{n}
\\ = \ & \sum_{i = 0}^m \binom mi  \sum_{k = 1}^{n-1}\cot^{2m - 2i} \frac{k\pi}{n}
\end{aligned}$$

下面考虑对每个 $2m$ 求解

$$\sum_{k = 1}^{n-1}\cot^{2m} \frac{k\pi}{n}$$

不妨设 $\theta = \dfrac{k\pi}{n}$，知道 $\sin n\theta = \Im \left(e^{i\theta}\right)^n = 0$。这就是

$$\Im\left(\sum_{k = 0}^n\binom nk i^k \sin^k\theta \cos^{n - k}\theta\right) = \binom n1 \sin^{n-1} \theta \cos \theta - \binom n3 \sin^{n - 3} \theta \cos ^3 \theta + \cdots = 0$$

由于我们需要 $\cot$ 的关系，两侧同除 $\sin^{n - 1} \theta$ 得到 $\cot \dfrac{k\pi}{n}$ 是

$$\binom n1 x^{n - 1} - \binom n3 x^{n - 3} + \cdots$$

的 $n - 1$ 个根。这时我们又要如何求解根的 $2m$ 次方和呢？

讨论一般的多项式 $f(x) = \sum_{i = 0}^{n} a_ix^i$，设它的 $n$ 个根分别为 $x_1, x_2, \dots, x_n$，知道 $f(x) = a_{n}\prod_{i =1}^n(x-x_i)$，即

$$\ln f(x) = \ln a_n + \sum_{i = 1}^n \ln(x - x_i)$$

两侧求导得到

$$\frac{f'(x)}{f(x)} = \sum_{i = 1}^n \frac{1}{x - x_i} = \sum_{i = 1}^n \sum_{k\ge 0} \binom {-1}{k} (-x_i)^k x^{-1-k} = \sum_{k\ge 0} \left( \sum_{i = 1}^n x_i^k \right) x^{-1-k}$$

则我们要求的

$$\sum_{i = 1}^n x_i^{2m} = [x^{-2m-1}]\frac{f'(x)}{f(x)} = [x^{2m+1}]\frac{f'(1/x)x^n}{f(1/x)x^n}$$

回到题目，我们知道

$$f(x) = \binom n1 x^{n - 1} - \binom n3 x^{n - 3} + \cdots$$

而 $f(1/x)x^n$ 本质上就是将系数反转，故可以在 $O(m \log m)$ 的复杂度内计算出每一个 $\sum_{k = 1}^{n-1}\cot^{2m - 2i} \frac{k\pi}{n}$。总复杂度为 $O(m \log m)$。但这个还是太慢。

回到公式，我们知道

$$\sum_{k = 1}^{n-1} \sin^{-2m} \frac{k\pi}{n} =  \sum_{k = 1}^{n-1} \left(\cot^2 \frac{k\pi}{n} + 1\right)^m$$

由于 $\cot \dfrac{k\pi}{n}$ 是

$$f(x) = \binom n1 x^{n - 1} - \binom n3 x^{n - 3} + \cdots$$

的 $n - 1$ 个根，知道 $\cot^2 \dfrac{k\pi}{n}$ 是 $f(\sqrt x) f(-\sqrt x)$ 的 $n - 1$ 个根。这是由于，如果 $x_1, x_2, \dots, x_n$ 为 $f(x)$ 的 $n$ 个根，并 $f(x)$ 的最高次项系数为 $A$，那么

$$f(\sqrt x)f(-\sqrt x) = A^2 \prod_{i = 1}^n (\sqrt x - x_i)(- \sqrt x - x_i) = A^2 \prod_{i = 1}^n (x_i^2 - x)$$

的 $n$ 个根为 $x_1^2, x_2^2, \dots, x_n^2$。令 $F(x) = f(\sqrt x) f(-\sqrt x) \circ (x-1)$，这样答案就是

$$[x^{m+1}]\frac{F'(1/x)x^{n-1}}{F(1/x)x^{n-1}}$$

这可以采用 Bostan-Mori 方法以 $O(\text M(n)\log m)$ 的复杂度得到。又由于 $f(\sqrt x) f(-\sqrt x)$ 就是取 $f(x)f(-x)$ 的偶数次幂，总复杂度 $O(\text M(n) \log m)$。

```cpp
signed main() {
    ll n, m, s;
    cin >> n >> m >> s;
    poly f(n);
    for (int i = 1, sgn = 1; i <= n; i += 2, sgn = -sgn) {
        if (sgn == 1) f[n - i] = gC(n, i);
        else f[n - i] = mod - gC(n, i);
    }
    f = f * f;
    rep(i,0,n-1) f[i] = f[2 * i];
    f.resize(n);
    f = f.shift(-1);
    poly fd = f.deri(), tmp(n); fd.resize(n);
    rep(i,0,n-1) tmp[i] = fd[n - 1 - i]; fd = tmp;
    rep(i,0,n-1) tmp[i] = f[n - 1 - i]; f = tmp;
    cout << _M_Div(fd, f, m + 1) << '\n';
}
```

---

## 作者：zhouhuanyi (赞：6)

考虑到 
$$\begin{aligned}res&=\sum_{k=1}^{n-1}\sin^{-2m}(\frac{ks}{n}\pi)\\&=\sum_{k=1}^{n-1}(\frac{e^{\frac{ks}{n}\pi i}-e^{\frac{-ks}{n}\pi i}}{2i})^{-2m}\\&=(-4)^m\sum_{k=1}^{n-1}(e^{\frac{ks i}{n}2\pi}+e^{\frac{-ks i}{n}2\pi}-2)^{-m}\\&=(-4)^m\sum_{k=1}^{n-1}(w_n^{ks}+w_n^{-ks}-2)^{-m}\end{aligned}$$

由于 $\gcd(m,s)=1$, 有

$$\sum_{k=1}^{n-1}(w_n^{ks}+w_n^{-ks}-2)^{-m}=\sum_{k=1}^{n-1}(w_n^k+w_n^{-k}-2)^{-m}$$

不难发现其就是一个单位根反演的形式，然而 $k=0$ 的部分没有被定义。

于是可以考虑将分母加上某个函数，使得其在 $k=0$ 时取到一个非 $0$ 值，在 $k\in [1,n-1]$ 时都取 $0$，可以发现 $\frac{\sum_{i=1}^{n-1}w_{n}^{ki}}{n}$ 恰好满足这个条件。

于是可以将原式变为

$$(-4)^m\sum_{k=0}^{n-1}(w_n^k+w_n^{-k}-2+\frac{\sum_{i=1}^{n}w_n^{ki}}{n})^{-m}-1$$

，考虑到 

$$\begin{aligned}&\sum_{k=0}^{n-1}(w_n^k+w_n^{-k}-2+\frac{\sum_{i=1}^{n}w_n^{ki}}{n})^{-m}=n[x^0](x+x^{-1}-2+\frac{\sum_{i=0}^{n-1}x^i}{n})^{-m}(\bmod x^n-1)\end{aligned}$$

由于对于所有 $x=w_n^k$, $(x+x^{-1}-2+\frac{\sum_{i=0}^{n-1}x^i}{n})^{-1}$
均存在，所以 $(x+x^{-1}-2+\frac{\sum_{i=0}^{n-1}x^i}{n})^{-1}$ 在 $\bmod x^n-1$ 下是良定义的，由于多项式形式较为简单，可以直接转化为线性方程组线性消元做到 $O(n)$。

然后采用多项式快速幂即可计算 $(x+x^{-1}-2+\frac{\sum_{i=0}^{n-1}x^i}{n})^{-m}$ 在 $\bmod x^n-1$ 的取值，做到 $O(n\log n\log m)$ 的复杂度。

---

## 作者：jijidawang (赞：6)

首先容易发现 $s$ 并没有什么用，于是可以取 $s=1$。注意到 $\sin^{-2}\theta=\cot^2\theta+1$，则：
$$\sum_{k=1}^{n-1}\sin^{-2m}\dfrac{k\pi}n=\sum_{k=1}^{n-1}\left(\cot^2\dfrac{k\pi}n+1\right)^m$$

断言：$\cot\dfrac{k\pi}n$ 是 $\displaystyle f(x)=\sum_{i\ge0}(-1)^i\dbinom n{2i+1}x^{n-2i-1}=0$ 的 $n-1$ 个根。证明见文末。

那么可以得到 $\cot^2\frac{k\pi}n+1$ 是 $F(x)=f(\sqrt{x-1})f(-\sqrt{x-1})$ 的 $n-1$ 个根。求解多项式根的幂和可以使用 Newton 恒等式：
$$\sum_{i=0}^nx_i^{m}=[x^{m+1}]\dfrac{F'^{\sf R}(x)}{F^{\sf R}(x)}$$

其中 $F^{\mathsf R}(x)$ 是 $F(x)$ 的系数翻转，$F'^{\mathsf R}(x)$ 是 $F'(x)$ 的系数翻转。

如果能求解分子分母则可以使用 Bostan-Mori 算法做有理分式远端求值。此处可以先考虑计算 $f(\sqrt x)f(-\sqrt x)$ 然后平移得到 $F(x)$，这只需要计算 $f(x)f(-x)$ 然后提取偶次幂项即可。

那么问题在 $\Theta(n\log n\log m)$ 的时间复杂度内得到解决。

***

关于前面缺少的证明：

欲证 $\cot\dfrac{k\pi}n$ 是 $\displaystyle\sum_{i\ge0}(-1)^i\dbinom n{2i+1}x^{n-2i-1}=0$ 的 $n-1$ 个根。

令 $\theta=\dfrac{k\pi}n$，注意到 $n$ 倍角公式：
$$0=\sin n\theta=\sum_{i\ge0}(-1)^i\dbinom n{2i+1}\sin^{n-2i-1}\theta\cos^{2i+1}\theta$$

两边同除 $\sin^{n-1}\theta$ 可得：
$$\sum_{i\ge0}(-1)^i\dbinom n{2i+1}\cot^{n-2i-1}\theta=0$$

从而容易注意到原命题。

---


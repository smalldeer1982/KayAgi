# [GCJ 2022 #1C] Intranets

## 题目描述

Apricot Rules LLC 公司正在开发一种新的简化网络协议，并希望展示其路由算法。在他们的设计中，网络由编号从 1 到 $\mathbf{M}$ 的 $\mathbf{M}$ 台机器组成，每对机器之间通过一条直接链路连接。每条链路被赋予一个唯一的整数优先级，优先级值介于 1 到 $(\mathbf{M} \times (\mathbf{M} - 1)/2)$ 之间，每台机器根据这些优先级来路由流量。

遗憾的是，该路由算法过于激进，会将一台机器的所有流量都通过与其连接的最高优先级链路进行路由。这可能导致某些机器组与其他机器组隔离。

正式地说，我们说一台机器 $m$ 使用一条链路 $\ell$，当且仅当 $\ell$ 是与 $m$ 连接的优先级最高的链路。我们还称一条链路是**活跃的**，如果它被其连接的两台机器中的至少一台使用。根据链路优先级，原始网络将被划分为若干个不相交的**内联网**。两台机器属于同一个内联网，当且仅当它们之间存在一条仅由活跃链路组成的路径。

![](https://cdn.luogu.com.cn/upload/image_hosting/hi8p2brt.png) ![](https://cdn.luogu.com.cn/upload/image_hosting/aiu45d35.png)

例如，如上图左侧所示，只有优先级为 6 和 5 的链路是活跃的。这形成了两个不相交的内联网。然而，右侧的示例中有三条活跃链路，结果形成了一个包含所有 4 台机器的内联网。

作为 Apricot Rules LLC 公司质量保证团队的一员，你正在调查这个问题的严重程度。你感兴趣的是，如果优先级是从 $(\mathbf{M} \times (\mathbf{M} - 1)/2)!$ 种可能的分配方式中均匀随机选择的，那么恰好形成 $\mathbf{K}$ 个内联网的概率是多少。


## 说明/提示

**样例解释**

在样例 #1 中，考虑以下情况。设 $\mathbf{M}=5$ 台机器为 $1,2,3,4,5$，并将连接机器 $a$ 和机器 $b$ 的链路记为 $(a, b)$。假设链路 $(1,2),(1,3),(1,4),(1,5),(2,3),(2,4),(2,5),(3,4),(3,5),(4,5)$ 的优先级分别为 $9,8,7,6,5,4,3,2,1,10$。那么机器 1 和 2 使用链路 $(1,2)$，机器 3 使用链路 $(1,3)$，机器 4 和 5 使用链路 $(4,5)$。因此，三条链路 $(1,2),(1,3),(4,5)$ 是活跃的，形成了两个内联网 $\{1,2,3\}$ 和 $\{4,5\}$。由于 $\mathbf{K}=2$，这种情况计入答案。

![](https://cdn.luogu.com.cn/upload/image_hosting/uoy2l0x6.png)

我们可以发现，在 $10! = 3628800$ 种优先级分配方式中，有 $1555200$ 种方式会恰好形成 $2$ 个内联网，因此概率为 $3/7$。

在样例 #2 中，概率为 $4/7$。

在样例 #3 中，概率为 $1/21$。

**数据范围**

- $1 \leq \mathbf{T} \leq 50$。
- $1 \leq \mathbf{K} \leq \mathbf{M}/2$。

**测试集 1（17 分，可见判定）**

- 时间限制：20 秒。
- $2 \leq \mathbf{M} \leq 50$。

**测试集 2（27 分，隐藏判定）**

- 时间限制：60 秒。
- $2 \leq \mathbf{M} \leq 5 \times 10^{5}$。

翻译由 DeepSeek V3 完成

## 样例 #1

### 输入

```
3
5 2
5 1
6 3```

### 输出

```
Case #1: 428571432
Case #2: 571428576
Case #3: 47619048```

# 题解

## 作者：Jorisy (赞：1)

考虑到一个连通块恰好会有一条边同时被它的两个端点激活。于是问题等价于求这种大小恰好为 $k$ 的符合要求的匹配的概率。

设 $f(S)$ 表示符合要求的匹配 $S$ 的出现概率。这并不好算，考虑用超集容斥。

设 $g(S)$ 表示包含 $S$ 的符合要求的匹配的出现概率。

显然有以下式子：
$$
g(S)=\sum\limits_{S\subseteq T}f(T)
$$
子集反演后可得：
$$
f(S)=\sum\limits_{S\subseteq T}(-1)^{|T|-|S|}g(T)
$$
而原题目的答案即为：
$$
\sum\limits_{|S|=k}f(S)=\sum\limits_{|S|=k}\sum\limits_{S\subseteq T}(-1)^{|T|-|S|}g(T)
$$
发现在这个式子中，我们并不需要具体地知道 $S$ 是多少，考虑交换求和顺序，消去 $S$。
$$
=\sum\limits_{|T|\ge k}\binom{|T|}{k}(-1)^{|T|-k}g(T)
$$
此时发现外侧的求和 $T$ 具体是什么也是没用的，考虑放到里面去。
$$
=\sum\limits_{i\ge k}\binom ik(-1)^{i-k}\sum\limits_{|S|=i}g(S)
$$
很好，我们现在只要求 $g(S)$ 了。

对于一个符合要求的 $S=\{(u_i,v_i)\}$，我们首先可以钦定一个选择边的顺序。假设 $(u_i,v_i)$ 是第 $i$ 条被选的边，且权值是第 $i$ 小的。

然后我们考虑怎样的匹配会包含 $S$。我们如果需要满足条件，必须对于任意的边 $(u_i,v_i)$，其权值需要大于所有与 $(u_j,v_j)\ (j\in[1,i])$ 有公共端点的边。所以我们就有：
$$
\begin{aligned}
g(S)&=|S|!\prod\limits_{i=1}^{|S|}\dfrac1{\binom m2-\binom{m-2i}2}\\
&=|S|!\prod\limits_{i=1}^{|S|}\dfrac1{\frac{m(m-1)}2-\frac{(m-2i)(m-2i-1)}2}\\
&=|S|!\prod\limits_{i=1}^{|S|}\dfrac2{m(m-1)-(m-2i)(m-2i-1)}\\
&=|S|!\prod\limits_{i=1}^{|S|}\dfrac1{(2m-2i-1)i}\\
&=\prod\limits_{i=1}^{|S|}\dfrac1{2m-2i-1}\\
\end{aligned}
$$
代入原式，有：
$$
\sum\limits_{|S|=k}f(S)=\sum\limits_{i\ge k}\binom ik(-1)^{i-k}\sum\limits_{|S|=i}\prod\limits_{j=1}^{i}\dfrac1{2m-2j-1}
$$
发现后面的求和没用，我们只要换成大小为 $i$ 的匹配数即可。

这个也是好求的。首先要依次选出 $2i$ 个点，钦定第 $2k\ (k\in\mathbb N_+)$ 个点和第 $2k+1$ 个点匹配。然后显然同一种情况重复了  $i!\cdot2^i$ 次，除掉即可。即为 $\dfrac{m!}{(m-2i)!\cdot i!\cdot 2^i}$。

故上式可以变形为：
$$
\begin{aligned}
&=\sum\limits_{i\ge k}\binom ik(-1)^{i-k}\dfrac{m!}{(m-2i)!\cdot i!\cdot 2^i}\prod\limits_{j=1}^{i}\dfrac1{2m-2j-1}\\
&=\sum\limits_{i\ge k}(-1)^{i-k}\dfrac{i!\cdot m!}{k!\cdot(i-k)!\cdot(m-2i)!\cdot i!\cdot 2^i}\prod\limits_{j=1}^{i}\dfrac1{2m-2j-1}\\
&=\sum\limits_{i\ge k}(-1)^{i-k}\dfrac{m!}{k!\cdot(i-k)!\cdot(m-2i)!\cdot 2^i}\prod\limits_{j=1}^{i}\dfrac1{2m-2j-1}\\
\end{aligned}
$$
预处理逆元并记录后面这个乘积的前缀积即可做到单组 $O(m)$。

---


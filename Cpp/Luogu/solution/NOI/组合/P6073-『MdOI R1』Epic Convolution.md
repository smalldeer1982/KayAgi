# 『MdOI R1』Epic Convolution

## 题目背景

小 Q 是神仙，尤其喜欢多项式。

这天小 K 问了道题：

给定长度 $n$ 的序列 $g,h$，求 $f$ 满足 $f_n=\sum\limits_{k=0}^{n}g_kh_{n-k}$。

小 Q 对小 K 说：你这个菜鸡，这不随便卷一下就行了吗，你 FFT 怎么学的了。

然后小 K 花了一个月学习 FFT 和 NTT。又跑过去问小 Q 一道题：

给定长度 $n$ 的序列 $g,h$，求 $f$ 满足 $f_n=\sum\limits_{k=0}^{n}\binom{n}{k}g_kh_{n-k}$。

小 Q 对小 K 说：你这个菜鸡，这不随便卷一下就行了吗，你 FFT 怎么学的了。

然后小 K 又花了一个月学习 FFT 和 NTT。又跑过去问小 Q 一道题：

给定长度 $n$ 的序列 $g,h$，求 $f$ 满足 $f_n=\sum\limits_{k=0}^{n}k^ng_kh_{n-k}$。

小 Q 对小 K 说：你这个菜鸡，这不随便卷一下就行了吗，你 FFT 怎么学的了。

然后他仔细看了一遍，傻眼了，发现他不会这道题。

为了吊打小 K，你需要告诉他 $4$ 个特殊情况的做法。

## 题目描述

给定特定的序列 $g,h$，求 $f_n$ 满足 $f_n=\sum\limits_{k=0}^{n}k^ng_kh_{n-k}$。

本题有五个子任务，前四个子任务给定不同形式的 $g,h$，需要求出 $f_n$，第五个子任务不依赖于这个等式，但是形式上与此相似。

**注意，本题所有输出请对 $998244353$（$119\times 2^{23}+1$，一个质数）取模。**

---

**Subtask 1（4 pts）：**

给定一个 $n$，你需要回答 $q$ 组询问，每组询问给定一个整数 $m$。

每组询问的 $g$ 和 $h$ 如下所示（$0\leq k\leq n$）：

$$g_k=\begin{cases}1,&k<m\\0,&k\geq m\end{cases}$$

$$h_k=1$$

你需要回答出 $f_n$ 的值。

---

**Subtask 2,3（16,16 pts）：**

这两个子任务给定的序列 $g,h$ 形式相同，但数据范围不同，请仔细阅读数据范围。

你需要回答 $q$ 组询问，每组询问给定两个整数 $n,m$。

每组询问的 $g$ 和 $h$ 如下所示（$0\leq k\leq n$）：

$$g_k=\frac{1}{(k+m+1)!}$$

$$h_k=\begin{cases}0,&k<m\\\frac{(-1)^{k-m}}{(k-m)!},&k\geq m\end{cases}$$

你需要回答出 $f_n$ 的值。

---

**Subtask 4（32 pts）：**

你需要回答 $q$ 组询问，每组询问给定两个整数 $n,m$。

每组询问的 $g$ 和 $h$ 如下所示（$0\leq k\leq n$）：

$$g_k=\frac{k^m}{k!}$$

$$h_k=\frac{(-1)^k}{k!}$$

你需要回答出 $f_n$ 的值。

---

**Subtask 5（32 pts）：**

你需要回答 $q$ 组询问，每组询问给定两个整数 $n,m$。

**注意下面 $n,m$ 的含义，不要看反。**

$$\sum\limits_{k=0}^{m}(k+1)^m\dfrac{(k+1)^{n+1}}{(k+1)!}\sum\limits_{i=0}^{m-k}\dfrac{\binom{2n+1}{i}(-1)^{m-k}}{(m-k-i)!(k+1)^i}$$

你需要回答出上面这个式子的值。

与前四个 Subtask 相似之处是，求和的一开始是幂的形式。

## 说明/提示

### 样例解释 1

在这组样例中，需要解决第一个子任务，$n=5,\ \ q=2$。

第一组询问中，$m=2$，则（省略了 $0$ 的加数项）：

$$[g_0\ \ g_1\ \ g_2\ \ g_3\ \ g_4\ \ g_5]=[1\ \ 1\ \ 0\ \ 0\ \ 0\ \ 0] $$

$$[h_0\ \ h_1\ \ h_2\ \ h_3\ \ h_4\ \ h_5]=[1\ \ 1\ \ 1\ \ 1\ \ 1\ \ 1] $$

$$f_5=1^5\times g_1h_4=1$$

第二组询问中，$m=3$，则：

$$[g_0\ \ g_1\ \ g_2\ \ g_3\ \ g_4\ \ g_5]=[1\ \ 1\ \ 1\ \ 0\ \ 0\ \ 0]$$

$$[h_0\ \ h_1\ \ h_2\ \ h_3\ \ h_4\ \ h_5]=[1\ \ 1\ \ 1\ \ 1\ \ 1\ \ 1]$$

$$f_5=1^5\times g_1h_4+2^5\times g_2h_3=33$$

------

### 样例解释 2

在这组样例中，需要解决第二个子任务，$q=2$。

第一组询问中，$n=4,\ \ m=2$，则：

$$[g_0\ \ g_1\ \ g_2\ \ g_3\ \ g_4]=[\dfrac{1}{6}\ \ \dfrac{1}{24}\ \ \dfrac{1}{120}\ \ \dfrac{1}{720}\ \ \dfrac{1}{5040}] $$

$$[h_0\ \ h_1\ \ h_2\ \ h_3\ \ h_4]=[0\ \ 0\ \ 1\ \ -1\ \ \dfrac{1}{2}] $$

$$f_5=1^4\times g_1h_3+2^4\times g_2h_2=\dfrac{11}{120} $$

$f_5=\dfrac{11}{120}$ 对 $998244353$ 取模后等于 $440891256$。

第二组询问范围过大，不进行样例解释。

------

### 样例解释 3

在这组样例中，需要解决第四个子任务，$q=2$。

第一组询问中，$n=4,\ \ m=2$，则：

$$[g_0\ \ g_1\ \ g_2\ \ g_3\ \ g_4]=[0\ \ \ 1\ \ \ 2\ \ \ \dfrac{3}{2}\ \ \dfrac{2}{3}] $$

$$[h_0\ \ h_1\ \ h_2\ \ h_3\ \ h_4]=[1\ \ -1\ \ \dfrac{1}{2}\ \ -\dfrac{1}{6}\ \ \dfrac{1}{24}] $$

$$f_5=1^4\times g_1h_3+2^4\times g_2h_2+3^4\times g_3h_1+4^4\times g_4h_0=65 $$

第二组询问范围过大，不进行样例解释。

---

### 样例解释 4

在这组样例中，需要解决第五个子任务，$q=2$。

第一组询问中，$n=4,\ \ m=2$，则枚举 $k,i$：

$$k=0,\ \ i=0:\ \ (k+1)^m\dfrac{(k+1)^{n+1}}{(k+1)!}\dfrac{\binom{2n+1}{i}(-1)^{m-k}}{(m-k-i)!(k+1)^i}=\dfrac{1}{2} $$

$$k=0,\ \ i=1:\ \ (k+1)^m\dfrac{(k+1)^{n+1}}{(k+1)!}\dfrac{\binom{2n+1}{i}(-1)^{m-k}}{(m-k-i)!(k+1)^i}=9 $$

$$k=0,\ \ i=2:\ \ (k+1)^m\dfrac{(k+1)^{n+1}}{(k+1)!}\dfrac{\binom{2n+1}{i}(-1)^{m-k}}{(m-k-i)!(k+1)^i}=36 $$

$$k=1,\ \ i=0:\ \ (k+1)^m\dfrac{(k+1)^{n+1}}{(k+1)!}\dfrac{\binom{2n+1}{i}(-1)^{m-k}}{(m-k-i)!(k+1)^i}=-64 $$

$$k=1\ \ i=1:\ \ (k+1)^m\dfrac{(k+1)^{n+1}}{(k+1)!}\dfrac{\binom{2n+1}{i}(-1)^{m-k}}{(m-k-i)!(k+1)^i}=-288 $$

$$k=2\ \ i=0:\ \ (k+1)^m\dfrac{(k+1)^{n+1}}{(k+1)!}\dfrac{\binom{2n+1}{i}(-1)^{m-k}}{(m-k-i)!(k+1)^i}=\dfrac{729}{2} $$

全部相加，结果为 $58$。

第二组询问范围过大，不进行样例解释。

---

### 数据范围

**本题采用捆绑测试，不同 Subtask 的题意不同。**

| 子任务编号 |    $q\leq$     |    $n\leq$     |    $m\leq$     | 分值 |
| :--------: | :------------: | :------------: | :------------: | :--: |
|     1      | $5\times 10^5$ |     $10^5$     | $\min(10^5,n)$ |  4   |
|     2      | $5\times 10^5$ |     $2\times 10^5$     |      $20$      |  16  |
|     3      |      $20$      |  $998244352$   |      $20$      |  16  |
|     4(31-40)      | $5\times 10^5$ | $2\times 10^5$ |      $10$      |  32  |
|     4(51-60)      | $20$ | $10^{10^5}$ |      $10$      |  32  |
|     5      | $5\times 10^5$ | $2\times 10^3$ | $2\times 10^3$ |  32  |

所有输入均为正整数。

## 样例 #1

### 输入

```
1
5
2
2
3```

### 输出

```
1
33
```

## 样例 #2

### 输入

```
2
2
4 2
18 7```

### 输出

```
440891256
841247136```

## 样例 #3

### 输入

```
4
2
4 2
20 9```

### 输出

```
65
429844531
```

## 样例 #4

### 输入

```
5
2
4 2
30 12```

### 输出

```
58
475486366
```

# 题解

## 作者：Karry5307 (赞：59)

### 题面

我相信我讲的很清楚。 

### 前言

~~国家队队爷并不会 general 情况下的做法，如果有人想出来了请联系我，并且他可以吊打国家队队爷~~

~~顺便提一句，那个题目叫做 Epic Convolution II~~

### 题解 

### $\texttt{Subtask 1(4 pts)}$

人口普查分。

我们来推式子。

$$f_n=\sum\limits_{k=0}^{n}k^ng_kh_{n-k}$$

现在考虑把这个东西拆成两半，于是得到

$$f_n=\sum\limits_{k=0}^{m-1}k^ng_kh_{n-k}+\sum\limits_{k=m}^{n}k^ng_kh_{n-k}$$

然后代入，由于 $g_k$ 在 $k\geq m$ 的时候为 $0$，所以原式化为

$$f_n=\sum\limits_{k=0}^{m-1}k^n$$

由于 $n$ 在每组询问中是不变的，所以预处理一下每个数的 $n$ 次幂即可。

### $\texttt{Subtask 2(16 pts)}$

推式子。

先不考虑当 $k\lt m$ 时 $h_k=0$ 的限制，直接让 $h_k=\frac{(-1)^{k-m}}{(k-m)!}$，然后开始推式子。

$$f_n=\sum\limits_{k=0}^{n}k^n\frac{1}{(k+m+1)!}\frac{(-1)^{n-k-m}}{(n-k-m)!}$$

注意到 $(k+m+1)+(n-k-m)=n+1$，所以等式两边同时乘上 $(n+1)!$，可以把右边写成二项式的形式。于是我们有

$$(n+1)!f_n=\sum\limits_{k=0}^{n}k^n(-1)^{n-k-m}\binom{n+1}{k+m+1}$$

然后感觉是不是有点不知所措了？

其实，我们接下来的一步是要拆右边的二项式。（这一步需要眼力以及很多的技巧）

考虑到有这样一个式子：

$$\binom{n+1}{k+m+1}=\sum\limits_{j=0}^{n}\binom{j}{k}\binom{n-j}{m}$$

我们来证明一下。你会发现右边那个东西特别像卷积形式，所以可以用生成函数的思想。

考虑在右边乘上一个 $x^n$ 并且把它拆成 $x^j$ 与 $x^{n-j}$ 的乘积，于是等式右边变成如下式子：

$$\sum\limits_{j=0}^{n}x^j\binom{j}{k}x^{n-j}\binom{n-j}{m}$$

然后你会发现我们如果设 $F(x)=\sum\limits_{i=0}^{\infty}\binom{i}{k}x^i$ 和 $G(x)=\sum\limits_{i=0}^{\infty}\binom{i}{m}x^i$，那么等式右边就是两个生成函数的乘积的 $x^n$ 的系数。

幸运的是，这两个生成函数都有简单的封闭形式，这里以 $F(x)$ 为例。（其实 $F(x)$ 和 $G(x)$ 形式是一样的，知道一个就知道另一个）

考虑到当 $i\lt k$ 的时候 $x^i$ 的系数为 $0$，所以我们可以考虑平移一下。

我们构造 $F^\prime(x)=\sum\limits_{i=0}^{\infty}\binom{i+k}{k}x^i$，那么可以发现 $F(x)=x^kF^\prime(x)$。

然而 $F^\prime(x)$ 的封闭形式非常简单，是 $\frac{1}{(1-x)^{k+1}}$。

所以，$F(x)=\frac{x^k}{(1-x)^{k+1}}$，同理有 $G(x)=\frac{x^m}{(1-x)^{m+1}}$，于是得到 $F(x)G(x)=\frac{x^{k+m}}{(1-x)^{k+m+2}}$。

现在我们来求它的 $x^n$ 的系数。

根据上面的推导，我们发现 $\frac{x^{k+m}}{(1-x)^{k+m+1}}$ 中 $x^n$ 的系数很好求，而我们发现

$$\frac{x^{k+m}}{(1-x)^{k+m+2}}=\frac{x^{k+m}}{(1-x)^{k+m+1}}\frac{1}{1-x}$$

而这个 $\frac{1}{1-x}$ 相当于将系数做前缀和。（但凡是学过一点生成函数的都知道吧），所以我们的答案为

$$\sum\limits_{i=0}^{n}\binom{i}{k+m}$$

这就是个裸的上指标求和，因此答案为 $\binom{n+1}{k+m+1}$。

啊哈！回到正题，把我们刚刚证明的式子代入一下，可得

$$(n+1)!f_n=\sum\limits_{k=0}^{n}k^n(-1)^{n-k-m}\sum\limits_{j=0}^{n}\binom{j}{k}\binom{n-j}{m}$$

然后我们发现可以调整一下求和的上下界，所以有

$$(n+1)!f_n=\sum\limits_{k=0}^{n}\sum\limits_{j=k}^{n}k^n(-1)^{n-k-m}\binom{j}{k}\binom{n-j}{m}$$

然后交换一下求和顺序，得到

$$(n+1)!f_n=\sum\limits_{j=0}^{n}\sum\limits_{k=0}^{j}k^n(-1)^{n-k-m}\binom{j}{k}\binom{n-j}{m}$$

接着拆 $(-1)^{n-k-m}$，拆成 $(-1)^{j-k}$ 和 $(-1)^{n-j-m}$，得到（这一步需要眼力以及很多的技巧）

$$(n+1)!f_n=\sum\limits_{j=0}^{n}\sum\limits_{k=0}^{j}k^n(-1)^{j-k}(-1)^{n-j-m}\binom{j}{k}\binom{n-j}{m}$$

然后我们写的清楚点

$$(n+1)!f_n=\sum\limits_{j=0}^{n}(-1)^{n-j-m}\binom{n-j}{m}\sum\limits_{k=0}^{j}k^n(-1)^{j-k}\binom{j}{k}$$

然后发现右边那个东西是斯特林数的形式啥的，就可以化开了，所以推出来有

$$(n+1)!f_n=\sum\limits_{j=0}^{n}\begin{Bmatrix}n\\j\end{Bmatrix}\binom{n-j}{m}(-1)^{n-j-m}j!$$

接下来，右边是一个很经典的公式，证明可以看[我 P5825 的题解](https://www.luogu.com.cn/blog/Karry5307/solution-p5825)，由于证明过程太长了，所以不写在这里。（因为后面还有好几个 $\texttt{Subtask}$）

所以我们得到

$$f_n=\frac{\left\langle\begin{matrix}n\\m\end{matrix}\right\rangle}{(n+1)!}$$

考虑到当 $n\leq m$ 的时候 $f_n$ 为 $0$，所以它确实是正确答案。

但是，我们发现 $m$ 很小（很大的时候做不做得出还是问题），所以可以考虑另外一个很经典的公式：（P5825 题解有人证明了这个式子，证明过程跟 之前的式子一样，都是数学归纳法）

$$\left\langle\begin{matrix}n\\m\end{matrix}\right\rangle=\sum\limits_{k=0}^{m}\binom{n+1}{k}(m+1-k)^n(-1)^k$$

然后预处理一下幂即可，时间复杂度 $O(nm+qm)$。

特别的是，如果你不预处理幂时间复杂度是 $O(qm\log n)$，如果写的不好可能不会通过。

### $\texttt{Subtask 3(16 pts)}$

一些技巧性的东西。

$n$ 的范围变成了 $998244353$ 而不是 $10^5$，所以我们需要比较快速的来处理 $(n+1)!$。

由于快速阶乘算法太慢，并且模数固定，所以我们考虑分块打表，可以考虑每 $10^6$ 打一次。

然而可能会很卡常，幂也要分块打表一下。

时间复杂度 $O(m\sqrt{M}+q(m+l))$。（这里用 $M$ 表示模数，$l$ 表示阶乘分块打表的块长），如果幂不分块打表而是直接快速幂的话时间复杂度是 $O(q(m\log n+l))$，可能无法通过。

### $\texttt{Subtask 4(32 pts)}$

大量的 dirty works 以及一些技巧性的东西。

首先先推式子。

$$f_n=\sum\limits_{k=0}^{n}k^n\frac{k^m}{k!}\frac{(-1)^k}{k}$$

眼尖的神仙可以发现这就是个斯特林数，所以

$$f_n=\begin{Bmatrix}n+m\\n\end{Bmatrix}$$

接下来使用二阶欧拉数进行计算。我们有以下两个恒等式：

$$\begin{Bmatrix}x\\x-n\end{Bmatrix}=\sum\limits_{k}\left\langle\left\langle\begin{matrix}n\\k\end{matrix}\right\rangle\right\rangle\binom{x+n-1-k}{2n}$$

和

$$\begin{bmatrix}x\\x-n\end{bmatrix}=\sum\limits_{k}\left\langle\left\langle\begin{matrix}n\\k\end{matrix}\right\rangle\right\rangle\binom{x+k}{2n}$$

证明可以使用数学归纳法对 $n$ 进行归纳。

然后考虑斯特林多项式，根据定义，有

$$\sigma_n(x)=\frac{\begin{bmatrix}x\\x-n\end{bmatrix}}{x(x-1)\cdots(x-n)}$$

我们知道，$\sigma_n(x)$ 的次数是 $n-1$，而分母的次数为 $n+1$，所以说，$\begin{bmatrix}x\\x-n\end{bmatrix}$ 的次数为 $2n$。

类似地，由于 $\binom{x+n-1-k}{2n}$ 与 $\binom{x+k}{2n}$ 次数总是相同，所以 $\begin{Bmatrix}x\\x-n\end{Bmatrix}$ 的次数也为 $2n$，也就是说 $\begin{Bmatrix}x+n\\x\end{Bmatrix}$ 的次数也为 $2n$。

于是我们可以使用一些手段算出 $x$ 很小的时候的一些值然后带进去插值就可以得到通项公式。

接下来就是手算斯特林数这种 dirty works 了，算完之后再插值就可以打表求出这些多项式了。为什么刚刚说明了多项式的次数呢，是方便你手算的。（我在这个子任务上用了一个下午）

时间复杂度 $O(qm)$，如果不使用秦九韶直接快速幂的话时间复杂度为 $O(qm\log n)$，可能无法通过。

后面 $10$ 个测试点，由于 $n$ 的范围非常大，所以边读入边取模。 

### $\texttt{Subtask 5(32 pts)}$

比 $\texttt{Subtask 3}$ 更难，形式更隐蔽的数学推导。

考虑先交换求和顺序

$$ans=\sum\limits_{i=0}^{m}\sum\limits_{k=0}^{m-i}\frac{(k+1)^{m+n+1-i}}{(k+1)!}\frac{\binom{2n+1}{i}(-1)^{m-k}}{(m-k-i)!}$$

然后改变一下内层和式的上下界（也就是将原来的 $k+1$ 变成了现在的 $k$）

$$ans=\sum\limits_{i=0}^{m}\sum\limits_{k=1}^{m-i+1}\frac{k^{m+n+1-i}}{k!}\frac{\binom{2n+1}{i}(-1)^{m-k+1}}{(m-k+1-i)!}$$

考虑到当 $k=0$ 时里面的和式为 $0$，所以改一下下界。接下来拆 $(-1)^{m-k+1}$，拆成 $(-1)^{i}$ 和 $(-1)^{m-k+1-i}$，并且把与 $k$ 无关的项提出来

$$ans=\sum\limits_{i=0}^{m}\binom{2n+1}{i}(-1)^i\sum\limits_{k=0}^{m-i+1}\frac{k^{m+n+1-i}}{k!}\frac{(-1)^{m-k+1-i}}{(m-k+1-i)!}$$

发现右边是个斯特林数，于是有

$$ans=\sum\limits_{i=0}^{m}\binom{2n+1}{i}(-1)^i\begin{Bmatrix}n+m+1-i\\m+1-i\end{Bmatrix}$$

这是一个非常经典的公式，是二阶欧拉数的通项公式，证明的话可以使用数学归纳法，类似于之前提到的一样。

这个东西有个组合意义，就是多重集 $\{1,1,2,2,\cdots,n,n\}$ 的满足对于 $1\leq m\leq n$，$m$ 的两次出现之间的所有数都大于 $m$ 的排列个数。

$\texttt{dp}$ 一下就好了，时间复杂度 $O(n^2+q)$。

哎，算了，与鰰达成协议，把代码放出来吧。

### 代码

```cpp
#include<bits/stdc++.h>
using namespace std;
typedef int ll;
typedef long long int li;
const ll MAXN=2e5+51,MOD=998244353;
ll taskId; 
ll factBlock[1051]={1,373341033,45596018,834980587,623627864,428937595,442819817,499710224,833655840,83857087,295201906,788488293,671639287,849315549,597398273,813259672,732727656,244038325,122642896,310517972,160030060,483239722,683879839,712910418,384710263,433880730,844360005,513089677,101492974,959253371,957629942,678615452,34035221,56734233,524027922,31729117,102311167,330331487,8332991,832392662,545208507,594075875,318497156,859275605,300738984,767818091,864118508,878131539,316588744,812496962,213689172,584871249,980836133,54096741,417876813,363266670,335481797,730839588,393495668,435793297,760025067,811438469,720976283,650770098,586537547,117371703,566486504,749562308,708205284,932912293,939830261,983699513,206579820,301188781,593164676,770845925,247687458,41047791,266419267,937835947,506268060,6177705,936268003,166873118,443834893,328979964,470135404,954410105,117565665,832761782,39806322,478922755,394880724,821825588,468705875,512554988,232240472,876497899,356048018,895187265,808258749,575505950,68190615,939065335,552199946,694814243,385460530,529769387,640377761,916128300,440133909,362216114,826373774,502324157,457648395,385510728,904737188,78988746,454565719,623828097,686156489,713476044,63602402,570334625,681055904,222059821,477211096,343363294,833792655,461853093,741797144,74731896,930484262,268372735,941222802,677432735,474842829,700451655,400176109,697644778,390377694,790010794,360642718,505712943,946647976,339045014,715797300,251680896,70091750,40517433,12629586,850635539,110877109,571935891,695965747,634938288,69072133,155093216,749696762,963086402,544711799,724471925,334646013,574791029,722417626,377929821,743946412,988034679,405207112,18063742,104121967,638607426,607304611,751377777,35834555,313632531,18058363,656121134,40763559,562910912,495867250,48767038,210864657,659137294,715390025,865854329,324322857,388911184,286059202,636456178,421290700,832276048,726437551,526417714,252522639,386147469,674313019,274769381,226519400,272047186,117153405,712896591,486826649,119444874,338909703,18536028,41814114,245606459,140617938,250512392,57084755,157807456,261113192,40258068,194807105,325341339,884328111,896332013,880836012,737358206,202713771,785454372,399586250,485457499,640827004,546969497,749602473,159788463,159111724,218592929,675932866,314795475,811539323,246883213,696818315,759880589,4302336,353070689,477909706,559289160,79781699,878094972,840903973,367416824,973366814,848259019,462421750,667227759,897917455,81800722,956276337,942686845,420541799,417005912,272641764,941778993,217214373,192220616,267901132,50530621,652678397,354880856,164289049,781023184,105376215,315094878,607856504,733905911,457743498,992735713,35212756,231822660,276036750,734558079,424180850,433186147,308380947,18333316,12935086,351491725,655645460,535812389,521902115,67016984,48682076,64748124,489360447,361275315,786336279,805161272,468129309,645091350,887284732,913004502,358814684,281295633,328970139,395955130,164840186,820902807,761699708,246274415,592331769,913846362,866682684,600130702,903837674,529462989,90612675,526540127,533047427,110008879,674279751,801920753,645226926,676886948,752481486,474034007,457790341,166813684,287671032,188118664,244731384,404032157,269766986,423996017,182948540,356801634,737863144,652014069,206068022,504569410,919894484,593398649,963768176,882517476,702523597,949028249,128957299,171997372,50865043,20937461,690959202,581356488,369182214,993580422,193500140,540665426,365786018,743731625,144980423,979536721,773259009,617053935,247670131,843705280,30419459,985463402,261585206,237885042,111276893,488166208,137660292,720784236,244467770,26368504,792857103,666885724,670313309,905683034,259415897,512017253,826265493,111960112,633652060,918048438,516432938,386972415,996212724,610073831,444094191,72480267,665038087,11584804,301029012,723617861,113763819,778259899,937766095,535448641,593907889,783573565,673298635,599533244,655712590,173350007,868198597,169013813,585161712,697502214,573994984,285943986,675831407,3134056,965907646,401920943,665949756,236277883,612745912,813282113,892454686,901222267,624900982,927122298,686321335,84924870,927606072,506664166,353631992,165913238,566073550,816674343,864877926,171259407,908752311,874007723,803597299,613676466,880336545,282280109,128761001,58852065,474075900,434816091,364856903,149123648,388854780,314693916,423183826,419733481,888483202,238933227,336564048,757103493,100189123,855479832,51370348,403061033,496971759,831753030,251718753,272779384,683379259,488844621,881783783,659478190,445719559,740782647,546525906,985524427,548033568,333772553,331916427,752533273,730387628,93829695,655989476,930661318,334885743,466041862,428105027,888238707,232218076,769865249,730641039,616996159,231721356,326973501,426068899,722403656,742756734,663270261,364187931,350431704,671823672,633125919,226166717,386814657,237594135,451479365,546182474,119366536,465211069,605313606,728508871,249619035,663053607,900453742,48293872,229958401,62402409,69570431,71921532,960467929,537087913,514588945,513856225,415497414,286592050,645469437,102052166,163298189,873938719,617583886,986843080,962390239,580971332,665147020,88900164,89866970,826426395,616059995,443012312,659160562,229855967,687413213,59809521,398599610,325666688,154765991,159186619,210830877,386454418,84493735,974220646,820097297,2191828,481459931,729073424,551556379,926316039,151357011,808637654,218058015,786112034,850407126,84202800,94214098,30019651,121701603,176055335,865461951,553631971,286620803,984061713,888573766,302767023,977070668,110954576,83922475,51568171,60949367,19533020,510592752,615419476,341370469,912573425,286207526,206707897,384156962,414163604,193301813,749570167,366933789,11470970,600191572,391667731,328736286,30645366,215162519,604947226,236199953,718439098,411423177,803407599,632441623,766760224,263006576,757681534,61082578,681666415,947466395,12206799,659767098,933746852,978860867,59215985,161179205,439197472,259779111,511621808,145770512,882749888,943124465,872053396,631078482,166861622,743415395,772287179,602427948,924112080,385643091,794973480,883782693,869723371,805963889,313106351,262132854,400034567,488248149,265769800,791715397,408753255,468381897,415812467,172922144,64404368,281500398,512318142,288791777,955559118,242484726,536413695,205340854,707803527,576699812,218525078,875554190,46283078,833841915,763148293,807722138,788080170,556901372,150896699,253151120,97856807,918256774,771557187,582547026,472709375,911615063,743371401,641382840,446540967,184639537,157247760,775930891,939702814,499082462,19536133,548753627,593243221,563850263,185475971,687419227,396799323,657976136,864535682,433009242,860830935,33107339,517661450,467651311,812398757,202133852,431839017,709549400,99643620,773282878,290471030,61134552,129206504,929147251,837008968,422332597,353775281,469563025,62265336,835064501,851685235,21197005,264793769,326416680,118842991,84257200,763248924,687559609,150907932,401832452,242726978,766752066,959173604,390269102,992293822,744816299,476631694,177284763,702429415,374065901,169855231,629007616,719169602,564737074,475119050,714502830,40993711,820235888,749063595,239329111,612759169,18591377,419142436,442202439,941600951,158013406,637073231,471564060,447222237,701248503,599797734,577221870,69656699,51052704,6544303,10958310,554955500,943192237,192526269,897983911,961628039,240232720,627280533,710239542,70255649,261743865,228474833,776408079,304180483,63607040,953297493,758058902,395529997,156010331,825833840,539880795,234683685,52626619,751843490,116909119,62806842,574857555,353417551,40061330,822203768,681051568,490913702,9322961,766631257,124794668,37844313,163524507,729108319,490867505,47035168,682765157,53842115,817965276,757179922,339238384,909741023,150530547,158444563,140949492,993302799,551621442,137578883,475122706,443869843,605400098,689361523,769596520,801661499,474900284,586624857,349960501,134084537,650564083,877097974,379857427,887890124,159436401,133274277,986182139,729720334,568925901,459461496,499309445,493171177,460958750,380694152,168836226,840160881,141116880,225064950,109618190,842341383,85305729,759273275,97369807,669317759,766247510,829017039,550323884,261274540,918239352,29606025,870793828,293683814,378510746,367270918,481292028,813097823,798448487,230791733,899305835,504040630,162510533,479367951,275282274,806951470,462774647,56473153,184659008,905122161,664034750,109726629,59372704,325795100,486860143,843736533,924723613,880348000,801252478,616515290,776142608,284803450,583439582,274826676,6018349,377403437,244041569,527081707,544763288,708818585,354033051,904309832,589922898,673933870,682858433,945260111,899893421,515264973,911685911,9527148,239480646,524126897,48259065,578214879,118677219,786127243,869205770,923276513,937928886,802186160,12198440,638784295,34200904,758925811,185027790,80918046,120604699,610456697,573601211,208296321,49743354,653691911,490750754,674335312,887877110,875880304,308360096,414636410,886100267,8525751,636257427,558338775,500159951,696213291,97268896,364983542,937928436,641582714,586211304,345265657,994704486,443549763,207259440,302122082,166055224,623250998,239642551,476337075,283167364,211328914,68064804,950202136,187552679,18938709,646784245,598764068,538505481,610424991,864445053,390248689,278395191,686098470,935957187,868529577,329970687,804930040,84992079,474569269,810762228,573258936,756464212,155080225,286966169,283614605,19283401,24257676,871831819,612689791,846988741,617120754,971716517,979541482,297910784,991087897,783825907,214821357,689498189,405026419,946731704,609346370,707669156,457703127,957341187,980735523,649367684,791011898,82098966,234729712,105002711,130614285,291032164,193188049,363211260,58108651,100756444,954947696,346032213,863300806,36876722,622610957,289232396,667938985,734886266,395881057,417188702,183092975,887586469,83334648,797819763,100176902,781587414,841864935,371674670,18247584};
inline ll read()
{
    register ll num=0;
    register char ch=getchar();
    while(!isdigit(ch))
    {
        ch=getchar();
    }
    while(isdigit(ch))
    {
        num=(num<<3)+(num<<1)+(ch-'0');
        ch=getchar();
    }
    return num;
}
inline ll readm()
{
    register li num=0;
    register char ch=getchar();
    while(!isdigit(ch))
    {
        ch=getchar();
    }
    while(isdigit(ch))
    {
        num=((num<<3)+(num<<1)+(ch-'0'))%MOD;
        ch=getchar();
    }
    return num;
}   
inline ll qpow(ll base,ll exponent)
{
    ll res=1;
    while(exponent)
    {
        if(exponent&1)
        {
            res=(li)res*base%MOD;
        }
        base=(li)base*base%MOD,exponent>>=1;
    }
    return res;
}
inline ll calcFact(ll x)
{
	ll res=factBlock[x/1000000];
	for(register int i=x/1000000*1000000+1;i<=x;i++)
	{
		res=(li)res*i%MOD;
	}
	return res;
}
namespace Subtask1{
	ll p,qcnt,x;
	ll pw[MAXN];
	inline void main()
	{
		p=read()-1,qcnt=read(); 
		for(register int i=1;i<=p;i++)
		{
			pw[i]=(pw[i-1]+qpow(i,p+1))%MOD;
		}
		for(register int i=0;i<qcnt;i++)
		{
			printf("%d\n",pw[read()-1]);
		}
	}
} 
namespace Subtask2{
	ll n,m,qcnt,numer,cur,hi,lo;
	li res; 
	ll block[22][32768],pw[22][32768],fact[MAXN],finv[MAXN];	
	inline void setup(ll cnt)
	{
		fact[0]=finv[0]=1;
		block[1][1]=1;
		block[2][1]=167578608;
		block[3][1]=192671909;
        block[4][1]=683753077;
        block[5][1]=21763235;
        block[6][1]=791422997;
        block[7][1]=326153078;
        block[8][1]=883105292;
        block[9][1]=84695472;
        block[10][1]=823499382;
        block[11][1]=659299615;
        block[12][1]=359937775;
        block[13][1]=647360147;
        block[14][1]=699980812;
        block[15][1]=695403701;
        block[16][1]=918327899;
        block[17][1]=48786078;
        block[18][1]=285585793;
        block[19][1]=698289863;
        block[20][1]=63206045;
        block[21][1]=995343487;
		for(register int i=1;i<cnt;i++)
		{
			fact[i]=(li)fact[i-1]*i%MOD;
		}
		for(register int i=1;i<=21;i++)
		{
			pw[i][0]=block[i][0]=1,pw[i][1]=i;
			for(register int j=1;j<32768;j++)
			{
				pw[i][j]=(li)pw[i][j-1]*i%MOD;
				block[i][j]=(li)block[i][j-1]*block[i][1]%MOD;
			}
		} 
		finv[cnt-1]=qpow(fact[cnt-1],MOD-2);
		for(register int i=cnt-2;i;i--)
		{
			finv[i]=(li)finv[i+1]*(i+1)%MOD;
		}
	}
	inline void solve()
	{
		if(!m)
		{
			return (void)(puts("1"));	
		}	
		numer=1,res=0,hi=n>>15,lo=n&32767;
		for(register int i=m+1,sgn=1,j=n+1;i;i--,sgn^=1,j--)
		{
			cur=(li)block[i][hi]*pw[i][lo]%MOD*numer%MOD*finv[m+1-i]%MOD;
			res=sgn?res+cur:res-cur+MOD;
			numer=(li)numer*j%MOD;
		}
		printf("%d\n",res%MOD*finv[n+1]%MOD);
	}
	inline void main()
	{
		setup(200011),qcnt=read();
		for(register int i=0;i<qcnt;i++)
		{
			n=read(),m=read(),solve();
		}
	}
}
namespace Subtask3{
	ll qcnt,n,m,hi,lo,numer,res,cur;
	ll block[22][32768],pw[22][32768],finv[22];
	inline void setup()
	{
		block[1][1]=1;
		block[2][1]=167578608;
		block[3][1]=192671909;
        block[4][1]=683753077;
        block[5][1]=21763235;
        block[6][1]=791422997;
        block[7][1]=326153078;
        block[8][1]=883105292;
        block[9][1]=84695472;
        block[10][1]=823499382;
        block[11][1]=659299615;
        block[12][1]=359937775;
        block[13][1]=647360147;
        block[14][1]=699980812;
        block[15][1]=695403701;
        block[16][1]=918327899;
        block[17][1]=48786078;
        block[18][1]=285585793;
        block[19][1]=698289863;
        block[20][1]=63206045;
        block[21][1]=995343487;
        finv[0]=finv[1]=1;
        finv[2]=499122177;
        finv[3]=166374059;
        finv[4]=291154603;
        finv[5]=856826403;
        finv[6]=641926577;
        finv[7]=376916469;
        finv[8]=421456191;
        finv[9]=712324701;
        finv[10]=370705776;
        finv[11]=305948985;
        finv[12]=275056837;
        finv[13]=405098354;
        finv[14]=314148269;
        finv[15]=154042465;
        finv[16]=945481735;
        finv[17]=407938109;
        finv[18]=632701444;
        finv[19]=33300076;
        finv[20]=400962745;
        finv[21]=637054254;
		for(register int i=1;i<=21;i++)
		{
			pw[i][0]=block[i][0]=1,pw[i][1]=i;
			for(register int j=1;j<32768;j++)
			{
				pw[i][j]=(li)pw[i][j-1]*i%MOD;
				block[i][j]=(li)block[i][j-1]*block[i][1]%MOD;
			}
		} 
	}
	inline void solve()
	{
		if(!m)
		{
			return (void)(puts("1"));	
		}	
		numer=1,res=0,hi=n>>15,lo=n&32767;
		for(register int i=m+1,sgn=1,j=n+1;i;i--,sgn^=1,j--)
		{
			cur=(li)block[i][hi]*pw[i][lo]%MOD*numer%MOD*finv[m+1-i]%MOD;
			res=sgn?(res+cur)%MOD:(res-cur+MOD)%MOD;
			numer=(li)numer*j%MOD;
		}
		printf("%d\n",(li)res*qpow(calcFact(n+1),MOD-2)%MOD);
	}
	inline void main()
	{
		setup(),qcnt=read();
		for(register int i=0;i<qcnt;i++)
		{
			n=read(),m=read(),solve();
		}
	}
}
namespace Subtask4{
	ll qcnt,n,m,res,cur;
	ll poly[100][100]={
		{1},
		{0,499122177,499122177},
		{0,582309206,623902721,915057324,873463809},
		{0,0,873463809,977447596,977447596,519918934,644699478},
		{0,141417950,107449913,842268673,94451940,544875043,965316154,967049217,330148523},
		{0,0,353544875,838455934,703623624,535949768,653451447,349558830,851800520,771646351,931434770},
		{0,550618909,178158888,58789352,129719774,797050168,796364164,791624030,488052236,941404697,659322198,354368080,243993623},
		{0,0,429799652,399743386,554801643,742853433,722665655,404016728,60088290,522271464,226257407,315863991,413266952,110861881,88731284},
		{0,70708975,419637300,526847060,645516780,37819976,686120930,268400327,256931840,479065066,996185375,206740503,38492104,987371789,694986290,916901540,754228970},
		{0,0,817312564,426355808,1832508,826402119,209769896,439803051,551557285,364677809,974827794,179093010,86072836,94912195,751433324,437960094,280979498,724651150,818313884}
	};
	inline void solve()
	{
		n=readm(),m=read(),res=0,cur=1;
		for(register int i=0;i<=(m<<1);i++)
		{
			res=(res+(li)poly[m][i]*cur%MOD)%MOD,cur=(li)cur*n%MOD;
		}
		printf("%d\n",res);
	}
	inline void main()
	{
		qcnt=read();
		for(register int i=0;i<qcnt;i++)
		{
			solve();
		}
	}
}
namespace Subtask5{
	ll qcnt,n,m;
	ll dp[2051][2051];
	inline void main()
	{
		dp[0][0]=1;
		for(register int i=1;i<=2000;i++)
		{
			dp[i][0]=1;
			for(register int j=1;j<=i;j++)
			{
				dp[i][j]=(li)(j+1)*dp[i-1][j]%MOD;
				dp[i][j]=(dp[i][j]+(li)((i<<1)-1-j)*dp[i-1][j-1]%MOD)%MOD;
			}
		}
		qcnt=read();
		for(register int i=0;i<qcnt;i++)
		{
			n=read(),m=read(),printf("%d\n",dp[n][m]);
		}
	}
}
int main()
{
	taskId=read();
	if(taskId==1)
	{
		Subtask1::main();
	}
	if(taskId==2)
	{
		Subtask2::main();
	}
	if(taskId==3)
	{
		Subtask3::main();
	}
	if(taskId==4)
	{
		Subtask4::main();
	}
	if(taskId==5)
	{
		Subtask5::main();
	}
}
```

---

## 作者：Spasmodic (赞：18)

Epic Convolution！

![](https://cdn.luogu.com.cn/upload/image_hosting/z586y7dg.png?x-oss-process=image/resize,m_lfit,h_200,w_200)

（made by [Loser_King](https://www.luogu.com.cn/user/159686)）

尝试写一篇人话题解。

在做这道题之前，你需要仔细阅读 具体数学（Concrete Mathematics） 的 6.2 章节，下面列出一些之后要用到的东西：
$$
m!\begin{Bmatrix}n\\m\end{Bmatrix}=\sum_k k^n\binom{m}{k}(-1)^{m-k}
$$

$$
\begin{Bmatrix}n\\m\end{Bmatrix}=\sum_k \frac{k^n(-1)^{m-k}}{k!(m-k)!}
$$

$$
\left\langle\begin{matrix}n\\m\end{matrix}\right\rangle=\sum_{k}\begin{Bmatrix}n\\k\end{Bmatrix}\binom{n-k}{m}(-1)^{n-k-m}k!=\sum_{k=0}^m\binom{n+1}{k}(m+1-k)^n(-1)^k
$$

$$
\left\langle\left\langle\begin{matrix}n\\k\end{matrix}\right\rangle\right\rangle=(k+1)\left\langle\left\langle\begin{matrix}n-1\\k\end{matrix}\right\rangle\right\rangle+(2n-1-k)\left\langle\left\langle\begin{matrix}n-1\\k-1\end{matrix}\right\rangle\right\rangle
$$

$$
\left\langle\left\langle\begin{matrix}n\\k\end{matrix}\right\rangle\right\rangle=\sum_{i=0}^k\binom{2n+1}{i}(-1)^{i}\begin{Bmatrix}n+k+1-i\\k+1-i\end{Bmatrix}
$$

接下来依次分析各个 Subtask。

# Subtask 1

$$
\begin{aligned}
f_n&=\sum_{k=0}^nk^ng_kh_{n-k}\\
&=\sum_{k=0}^{m-1}k^n
\end{aligned}
$$

由于 $n$ 固定，预处理幂的前缀和即可。

复杂度为 $O(n)-O(1)$​。

```cpp
namespace Shemesh{
	ll ans[N];
    void Metatron(){
        IO>>n>>q;
        rep(i,1,n-1)ans[i]=(ans[i-1]+qpow(i,n))%P;
    }
	void Shemesh(){
		while(q--){
			ll m;
			IO>>m;
			IO<<ans[m-1]<<'\n';
		}
	}
}// Metatron Shemesh 绝灭天使·日轮
```

# Subtask 2

$$
f_n=\sum_{k=0}^{n}k^n\frac{1}{(k+m+1)!}\frac{(-1)^{n-k-m}}{(n-k-m)!}
$$

显然这里可以提一个组合数，两边乘以 $(n+1)!$ 可得
$$
(n+1)!f_n=\sum_{k=0}^{n}k^n\binom{n+1}{k+m+1}(-1)^{n-k-m}
$$
然后这个 $k^n$​ 显然要拿去配斯特林数，我们观察一下这个式子，然后来尝试强行凑一个。
$$
\begin{Bmatrix}n\\m\end{Bmatrix}=\sum_k \frac{k^n(-1)^{m-k}}{k!(m-k)!}
$$
那么组合数可以产生求和符号，首先可以把 $(-1)^{n-k-m}$ 拆成 $(-1)^{n-j-m}(-1)^{j-k}$，$j$ 是外层求和枚举的变量，然后来考虑分母怎么动，这个时候就可以把斯特林数的式子改一下变成：
$$
\begin{Bmatrix}n\\j\end{Bmatrix}=\sum_k \frac{k^n(-1)^{j-k}}{k!(j-k)!}
$$
那么我们整一个 $\dbinom{j}{k}$ 就可以搞出来了，下面考虑怎么把 $\dbinom{n+1}{k+m+1}$ 搞成求和形式。

事实上根据生成函数容易证明：
$$
\binom{n+1}{k+m+1}=\sum_{j}\binom{j}{k}\binom{n-j}{m}
$$
然后带进去就可以得到我们想要的式子：
$$
\begin{aligned}
\sum_{k=0}^{n}k^n\binom{n+1}{k+m+1}(-1)^{n-k-m}&=\sum_{k=0}^{n}k^n(-1)^{n-k-m}\sum_{j}\binom{j}{k}\binom{n-j}{m}\\
&=\sum_{j}(-1)^{n-j-m}\binom{n-j}{m}\sum_{k=0}^{n}k^n(-1)^{j-k}\binom{j}{k}\\
&=\sum_{j}(-1)^{n-j-m}\binom{n-j}{m}j!\begin{Bmatrix}n\\j\end{Bmatrix}
\end{aligned}
$$
然后你就会发现和欧拉数的通项一完全一致，用通项二带进去可得
$$
f_n=\frac{1}{(n+1)!}\sum_{k=0}^m\binom{n+1}{k}(m+1-k)^n(-1)^k
$$
预计算幂和阶乘，单次 $O(m)$​ 即可。

复杂度 $O(nm)-O(m)$。

```cpp
namespace Malakh{
	ll fac[N],invfac[N],pw[25][N];
	void Metatron(ll n,ll m){
		fac[0]=1;
		rep(i,1,n)fac[i]=fac[i-1]*i%P;
		invfac[n]=qpow(fac[n],P-2);
		Rep(i,n-1,0)invfac[i]=invfac[i+1]*(i+1)%P;
		rep(i,1,m){
			pw[i][0]=1;
			rep(j,1,n)pw[i][j]=pw[i][j-1]*i%P;
		}
	}
	ll C(ll n,ll m){return fac[n]*invfac[m]%P*invfac[n-m]%P;}
	void Malakh(){
		for(IO>>q;q--;){
			IO>>n>>m;
			ll ans=0;
			rep(k,0,m){
				if(k&1^1)ans=(ans+C(n+1,k)*pw[m+1-k][n]%P)%P;
				else ans=(ans+(P-C(n+1,k))*pw[m+1-k][n]%P)%P;
			}
			IO<<ans*invfac[n+1]%P<<'\n';
		}
	}
}//Metatron Mal'akh 绝灭天使·天翼
```

# Subtask 5

因为 sub3 和 sub4 有点毁天灭地，所以先来讲 Sub5 了。

首先出题人显然把这玩意的 $k+1$ 次幂强行拆开了，现在我们把它合起来，顺便把 $k+1$ 转化成 $k$。
$$
\begin{aligned}
Ans&=\sum_{k=0}^{m}\sum_{i=0}^{m-k}\frac{\dbinom{2n+1}{i}(-1)^{m-k}(k+1)^{m+n+1-i}}{(m-k-i)!(k+1)!}\\
&=\sum_{k=1}^{m+1}\sum_{i=0}^{m-k+1}\frac{\dbinom{2n+1}{i}(-1)^{m-k}k^{m+n+1-i}}{(m-k+1-i)!k!}\\
\end{aligned}
$$
继续考虑怎么化出斯特林数。

首先观测到 $k=0$ 时，后面的式子也是 $0$​，所以可以把 $k=0$ 扔进来。

天然的 $\dfrac{k^{m+n+1-i}}{(m-k+1-i)!k!}$​​​​ 肯定不要动，那么 $i$​​​​​​ 是固定的，考虑其余怎么配。

代入斯特林数的通项，我们可以发现：
$$
\begin{Bmatrix}m+n+1-i\\m+1-i\end{Bmatrix}=\sum_k \frac{k^{m+n+1-i}(-1)^{m+1-k-i}}{k!(m-k+1-i)!}
$$
直接拆 $(-1)^{m-k}$ 为 $(-1)^{m+1-k-i}(-1)^{i-1}$ 就可以了。

于是原式化为
$$
\begin{aligned}
Ans&=\sum_{k=0}^{m+1}\sum_{i=0}^{m-k+1}\frac{\dbinom{2n+1}{i}(-1)^{m-k}k^{m+n+1-i}}{(m-k+1-i)!k!}\\
&=\sum_{i=0}^{m}\sum_{k=0}^{m-i+1}\frac{\dbinom{2n+1}{i}(-1)^{m-k}k^{m+n+1-i}}{(m-k+1-i)!k!}\\
&=\sum_{i=0}^{m}\dbinom{2n+1}{i}(-1)^{i-1}\sum_{k=0}^{m-i+1}\frac{(-1)^{m+1-k-i}k^{m+n+1-i}}{(m-k+1-i)!k!}\\
&=\sum_{i=0}^{m}\dbinom{2n+1}{i}(-1)^{i-1}\begin{Bmatrix}n+k+1-i\\k+1-i\end{Bmatrix}
\end{aligned}
$$
注意到这正好是二阶欧拉数的通项，而注意到数据范围只有 $2000$，所以可以通过递归式 $n^2$ dp 求得。

复杂度为 $O(n^2)-O(1)$ 的。

```cpp
namespace Satan{
	ll Euler[2005][2005];
	void Devil(ll n){
		rep(i,0,n)Euler[i][0]=1;
		rep(i,1,n)rep(j,1,i)Euler[i][j]=((j+1)*Euler[i-1][j]%P+(2*i-1-j)*Euler[i-1][j-1])%P;
	}
	void Satan(){
		for(IO>>q;q--;){
			IO>>n>>m;
			IO<<Euler[n][m]<<'\n';
		}
	}
}//Satan 反转体 救世魔王
```

# Subtask 3

相比 Subtask 2 而言，数据范围上升到了 $998244352$​​，考虑怎么优化预处理。

快速阶乘算法我不会，所以上分块打表。

这里块长直接设 $10^6$​，这样数组长度只有 $1000$​。

为了防止快速幂被卡，所以上光速幂，块长设 $32768$​ 就可以了。

然后这个 sub 就没了。

```cpp
const ll prefac[]={喵喵喵喵喵喵喵喵喵};
ll calcfac(ll n){
	ll ret=prefac[n/B];
	rep(i,n/B*B+1,n)ret=ret*i%P;
	return ret;
}
namespace Kadour{
	const ll bl=32768;
	ll pw1[25][32800],inv[25],pw2[25][32800];
	void Metatron(ll m){
		rep(i,1,m){
			pw1[i][0]=1;
			rep(j,1,bl)pw1[i][j]=pw1[i][j-1]*i%P;
			pw2[i][0]=1;
			rep(j,1,bl)pw2[i][j]=pw2[i][j-1]*pw1[i][bl]%P;
		}
		inv[0]=inv[1]=1;
		rep(i,2,m)inv[i]=(P-P/i)*inv[P%i]%P;
	}
	ll pw(ll n,ll m){
		return pw2[n][m>>15]*pw1[n][m&(bl-1)]%P;
	}
	void Kadour(){
		for(IO>>q;q--;){
			IO>>n>>m;
			ll ans=0,binom=1;
			rep(k,0,m){
				if(k&1^1)ans=(ans+binom*pw(m+1-k,n)%P)%P;
				else ans=(ans-binom*pw(m+1-k,n)%P+P)%P;
				binom=binom*(n+1-k)%P*inv[k+1]%P;
			}
			IO<<ans*qpow(calcfac(n+1),P-2)%P<<'\n';
		}
	}
}//Metatron Kadour 绝灭天使·光剑
```

# Subtask 4

$$
f_n=\sum_{k=0}^{n}k^n\frac{k^m}{k!}\frac{(-1)^{n-k}}{(n-k)!}
$$

小 Q 对小 K 说：你这个菜鸡，这不显然的第二类斯特林数吗，你斯特林数怎么学的了。

然后他仔细看了一遍，
$$
n\le 10^{10^5},m\le 10
$$
傻眼了，发现他不会这道题。

容易知道这道题要求的就是
$$
\begin{Bmatrix}n+m\\n\end{Bmatrix}
$$
然后根据具体数学：
$$
\begin{Bmatrix}n+m\\n\end{Bmatrix}=\sum_{k=0}^{m}\left\langle\left\langle\begin{matrix}m\\k\end{matrix}\right\rangle\right\rangle \binom{n+2m-k}{2m}
$$
那么 $O(m^2)$​ 预处理二阶欧拉数，然后用类似 Subtask 3 的做法处理组合数，每次变化都是 $O(1)$ 的。

但是这里要求的逆元都很大，怎么办呢？考虑进行数据分治，对 $31\sim 40$ 的数据预处理逆元，对 $41\sim 50$ 的数据 $O(\log P)$​​ 计算。这样 $31\sim 40$ 的复杂度是 $O(m^2+n)-O(m)$ 的，而 $41\sim 50$ 的复杂度是 $O(m^2)-O(m\log P)$ 的，均可通过。

```cpp
namespace Artelif{
	ll inv[N<<1],Euler[15][15],ma;
	void Metatron(ll n,ll m){
		ma=n;
		inv[0]=inv[1]=1;
		rep(i,2,n)inv[i]=(P-P/i)*inv[P%i]%P;
		rep(i,0,m)Euler[i][0]=1;
		rep(i,1,m)rep(j,1,i)Euler[i][j]=((j+1)*Euler[i-1][j]%P+(2*i-1-j)*Euler[i-1][j-1])%P;
	}
	ll calcinv(ll n){
		return n<=ma?inv[n]:qpow(n,P-2);
	}
	void Artelif(){
		for(IO>>q;q--;){
			IO.read(n,P);
			IO>>m;
			ll binom=1,ans=0;
			rep(i,n,n+2*m-1)binom=binom*i%P*calcinv(i-n+1)%P;
			rep(i,0,m){
				ans=(ans+binom*Euler[m][i]%P)%P;
				binom=binom*calcinv(n+2*m-1-i)%P*(n-i-1)%P;
			}
			IO<<ans<<'\n';
		}
	}
}//Metatron Artelif 绝灭天使·炮冠
```

下面是完整代码。

```cpp
// Problem: P6073 『MdOI R1』Epic Convolution
// Contest: Luogu
// URL: https://www.luogu.com.cn/problem/P6073
// Memory Limit: 500 MB
// Time Limit: 400 ms
// 
// Powered by CP Editor (https://cpeditor.org)

#include<bits/stdc++.h>
#define endl '\n' 
#define rep(i,a,b) for(ll i=(a);i<=(b);++i)
#define Rep(i,a,b) for(ll i=(a);i>=(b);--i)
using namespace std;
typedef long long ll;
inline void chkmax(ll &x,ll y){if(x<y)x=y;}
inline void chkmin(ll &x,ll y){if(x>y)x=y;}
struct IO_Tp {
    const static int _I_Buffer_Size = 2 << 22;
    char _I_Buffer[_I_Buffer_Size], *_I_pos = _I_Buffer;

    const static int _O_Buffer_Size = 2 << 22;
    char _O_Buffer[_O_Buffer_Size], *_O_pos = _O_Buffer;

    IO_Tp() { fread(_I_Buffer, 1, _I_Buffer_Size, stdin); }
    ~IO_Tp() { fwrite(_O_Buffer, 1, _O_pos - _O_Buffer, stdout); }

	void read(ll &res,ll mod){
		ll f=1;
        while (!isdigit(*_I_pos)&&(*_I_pos)!='-') ++_I_pos;
        if(*_I_pos=='-')f=-1,++_I_pos;
        res = *_I_pos++ - '0';
        while (isdigit(*_I_pos)) res = (res * 10 + (*_I_pos++ - '0') ) % mod;
        res*=f;
	}

    IO_Tp &operator>>(ll &res) {
    	ll f=1;
        while (!isdigit(*_I_pos)&&(*_I_pos)!='-') ++_I_pos;
        if(*_I_pos=='-')f=-1,++_I_pos;
        res = *_I_pos++ - '0';
        while (isdigit(*_I_pos)) res = res * 10 + (*_I_pos++ - '0');
        res*=f;
        return *this;
    }

    IO_Tp &operator<<(ll n) {
    	if(n<0)*_O_pos++='-',n=-n;
        static char _buf[10];
        char *_pos = _buf;
        do
            *_pos++ = '0' + n % 10;
        while (n /= 10);
        while (_pos != _buf) *_O_pos++ = *--_pos;
        return *this;
    }

    IO_Tp &operator<<(char ch) {
        *_O_pos++ = ch;
        return *this;
    }
} IO;
typedef vector<int> vec;
const int N=2e5+5,P=998244353,B=1e6;
ll op,q,n,m;
const ll prefac[]={1,373341033,45596018,834980587,623627864,428937595,442819817,499710224,833655840,83857087,295201906,788488293,671639287,849315549,597398273,813259672,732727656,244038325,122642896,310517972,160030060,483239722,683879839,712910418,384710263,433880730,844360005,513089677,101492974,959253371,957629942,678615452,34035221,56734233,524027922,31729117,102311167,330331487,8332991,832392662,545208507,594075875,318497156,859275605,300738984,767818091,864118508,878131539,316588744,812496962,213689172,584871249,980836133,54096741,417876813,363266670,335481797,730839588,393495668,435793297,760025067,811438469,720976283,650770098,586537547,117371703,566486504,749562308,708205284,932912293,939830261,983699513,206579820,301188781,593164676,770845925,247687458,41047791,266419267,937835947,506268060,6177705,936268003,166873118,443834893,328979964,470135404,954410105,117565665,832761782,39806322,478922755,394880724,821825588,468705875,512554988,232240472,876497899,356048018,895187265,808258749,575505950,68190615,939065335,552199946,694814243,385460530,529769387,640377761,916128300,440133909,362216114,826373774,502324157,457648395,385510728,904737188,78988746,454565719,623828097,686156489,713476044,63602402,570334625,681055904,222059821,477211096,343363294,833792655,461853093,741797144,74731896,930484262,268372735,941222802,677432735,474842829,700451655,400176109,697644778,390377694,790010794,360642718,505712943,946647976,339045014,715797300,251680896,70091750,40517433,12629586,850635539,110877109,571935891,695965747,634938288,69072133,155093216,749696762,963086402,544711799,724471925,334646013,574791029,722417626,377929821,743946412,988034679,405207112,18063742,104121967,638607426,607304611,751377777,35834555,313632531,18058363,656121134,40763559,562910912,495867250,48767038,210864657,659137294,715390025,865854329,324322857,388911184,286059202,636456178,421290700,832276048,726437551,526417714,252522639,386147469,674313019,274769381,226519400,272047186,117153405,712896591,486826649,119444874,338909703,18536028,41814114,245606459,140617938,250512392,57084755,157807456,261113192,40258068,194807105,325341339,884328111,896332013,880836012,737358206,202713771,785454372,399586250,485457499,640827004,546969497,749602473,159788463,159111724,218592929,675932866,314795475,811539323,246883213,696818315,759880589,4302336,353070689,477909706,559289160,79781699,878094972,840903973,367416824,973366814,848259019,462421750,667227759,897917455,81800722,956276337,942686845,420541799,417005912,272641764,941778993,217214373,192220616,267901132,50530621,652678397,354880856,164289049,781023184,105376215,315094878,607856504,733905911,457743498,992735713,35212756,231822660,276036750,734558079,424180850,433186147,308380947,18333316,12935086,351491725,655645460,535812389,521902115,67016984,48682076,64748124,489360447,361275315,786336279,805161272,468129309,645091350,887284732,913004502,358814684,281295633,328970139,395955130,164840186,820902807,761699708,246274415,592331769,913846362,866682684,600130702,903837674,529462989,90612675,526540127,533047427,110008879,674279751,801920753,645226926,676886948,752481486,474034007,457790341,166813684,287671032,188118664,244731384,404032157,269766986,423996017,182948540,356801634,737863144,652014069,206068022,504569410,919894484,593398649,963768176,882517476,702523597,949028249,128957299,171997372,50865043,20937461,690959202,581356488,369182214,993580422,193500140,540665426,365786018,743731625,144980423,979536721,773259009,617053935,247670131,843705280,30419459,985463402,261585206,237885042,111276893,488166208,137660292,720784236,244467770,26368504,792857103,666885724,670313309,905683034,259415897,512017253,826265493,111960112,633652060,918048438,516432938,386972415,996212724,610073831,444094191,72480267,665038087,11584804,301029012,723617861,113763819,778259899,937766095,535448641,593907889,783573565,673298635,599533244,655712590,173350007,868198597,169013813,585161712,697502214,573994984,285943986,675831407,3134056,965907646,401920943,665949756,236277883,612745912,813282113,892454686,901222267,624900982,927122298,686321335,84924870,927606072,506664166,353631992,165913238,566073550,816674343,864877926,171259407,908752311,874007723,803597299,613676466,880336545,282280109,128761001,58852065,474075900,434816091,364856903,149123648,388854780,314693916,423183826,419733481,888483202,238933227,336564048,757103493,100189123,855479832,51370348,403061033,496971759,831753030,251718753,272779384,683379259,488844621,881783783,659478190,445719559,740782647,546525906,985524427,548033568,333772553,331916427,752533273,730387628,93829695,655989476,930661318,334885743,466041862,428105027,888238707,232218076,769865249,730641039,616996159,231721356,326973501,426068899,722403656,742756734,663270261,364187931,350431704,671823672,633125919,226166717,386814657,237594135,451479365,546182474,119366536,465211069,605313606,728508871,249619035,663053607,900453742,48293872,229958401,62402409,69570431,71921532,960467929,537087913,514588945,513856225,415497414,286592050,645469437,102052166,163298189,873938719,617583886,986843080,962390239,580971332,665147020,88900164,89866970,826426395,616059995,443012312,659160562,229855967,687413213,59809521,398599610,325666688,154765991,159186619,210830877,386454418,84493735,974220646,820097297,2191828,481459931,729073424,551556379,926316039,151357011,808637654,218058015,786112034,850407126,84202800,94214098,30019651,121701603,176055335,865461951,553631971,286620803,984061713,888573766,302767023,977070668,110954576,83922475,51568171,60949367,19533020,510592752,615419476,341370469,912573425,286207526,206707897,384156962,414163604,193301813,749570167,366933789,11470970,600191572,391667731,328736286,30645366,215162519,604947226,236199953,718439098,411423177,803407599,632441623,766760224,263006576,757681534,61082578,681666415,947466395,12206799,659767098,933746852,978860867,59215985,161179205,439197472,259779111,511621808,145770512,882749888,943124465,872053396,631078482,166861622,743415395,772287179,602427948,924112080,385643091,794973480,883782693,869723371,805963889,313106351,262132854,400034567,488248149,265769800,791715397,408753255,468381897,415812467,172922144,64404368,281500398,512318142,288791777,955559118,242484726,536413695,205340854,707803527,576699812,218525078,875554190,46283078,833841915,763148293,807722138,788080170,556901372,150896699,253151120,97856807,918256774,771557187,582547026,472709375,911615063,743371401,641382840,446540967,184639537,157247760,775930891,939702814,499082462,19536133,548753627,593243221,563850263,185475971,687419227,396799323,657976136,864535682,433009242,860830935,33107339,517661450,467651311,812398757,202133852,431839017,709549400,99643620,773282878,290471030,61134552,129206504,929147251,837008968,422332597,353775281,469563025,62265336,835064501,851685235,21197005,264793769,326416680,118842991,84257200,763248924,687559609,150907932,401832452,242726978,766752066,959173604,390269102,992293822,744816299,476631694,177284763,702429415,374065901,169855231,629007616,719169602,564737074,475119050,714502830,40993711,820235888,749063595,239329111,612759169,18591377,419142436,442202439,941600951,158013406,637073231,471564060,447222237,701248503,599797734,577221870,69656699,51052704,6544303,10958310,554955500,943192237,192526269,897983911,961628039,240232720,627280533,710239542,70255649,261743865,228474833,776408079,304180483,63607040,953297493,758058902,395529997,156010331,825833840,539880795,234683685,52626619,751843490,116909119,62806842,574857555,353417551,40061330,822203768,681051568,490913702,9322961,766631257,124794668,37844313,163524507,729108319,490867505,47035168,682765157,53842115,817965276,757179922,339238384,909741023,150530547,158444563,140949492,993302799,551621442,137578883,475122706,443869843,605400098,689361523,769596520,801661499,474900284,586624857,349960501,134084537,650564083,877097974,379857427,887890124,159436401,133274277,986182139,729720334,568925901,459461496,499309445,493171177,460958750,380694152,168836226,840160881,141116880,225064950,109618190,842341383,85305729,759273275,97369807,669317759,766247510,829017039,550323884,261274540,918239352,29606025,870793828,293683814,378510746,367270918,481292028,813097823,798448487,230791733,899305835,504040630,162510533,479367951,275282274,806951470,462774647,56473153,184659008,905122161,664034750,109726629,59372704,325795100,486860143,843736533,924723613,880348000,801252478,616515290,776142608,284803450,583439582,274826676,6018349,377403437,244041569,527081707,544763288,708818585,354033051,904309832,589922898,673933870,682858433,945260111,899893421,515264973,911685911,9527148,239480646,524126897,48259065,578214879,118677219,786127243,869205770,923276513,937928886,802186160,12198440,638784295,34200904,758925811,185027790,80918046,120604699,610456697,573601211,208296321,49743354,653691911,490750754,674335312,887877110,875880304,308360096,414636410,886100267,8525751,636257427,558338775,500159951,696213291,97268896,364983542,937928436,641582714,586211304,345265657,994704486,443549763,207259440,302122082,166055224,623250998,239642551,476337075,283167364,211328914,68064804,950202136,187552679,18938709,646784245,598764068,538505481,610424991,864445053,390248689,278395191,686098470,935957187,868529577,329970687,804930040,84992079,474569269,810762228,573258936,756464212,155080225,286966169,283614605,19283401,24257676,871831819,612689791,846988741,617120754,971716517,979541482,297910784,991087897,783825907,214821357,689498189,405026419,946731704,609346370,707669156,457703127,957341187,980735523,649367684,791011898,82098966,234729712,105002711,130614285,291032164,193188049,363211260,58108651,100756444,954947696,346032213,863300806,36876722,622610957,289232396,667938985,734886266,395881057,417188702,183092975,887586469,83334648,797819763,100176902,781587414,841864935,371674670,18247584};
ll qpow(ll a,ll b){return !b?1:qpow(a*a%P,b>>1)*(b&1?a:1)%P;}
////////////////////////Subtask 1///////////////////
namespace Shemesh{
	ll ans[N];
    void Metatron(){
        IO>>n>>q;
        rep(i,1,n-1)ans[i]=(ans[i-1]+qpow(i,n))%P;
    }
	void Shemesh(){
		while(q--){
			ll m;
			IO>>m;
			IO<<ans[m-1]<<'\n';
		}
	}
}// Metatron Shemesh 绝灭天使·日轮
////////////////////////Subtask 2///////////////////
namespace Malakh{
	ll fac[N],invfac[N],pw[25][N];
	void Metatron(ll n,ll m){
		fac[0]=1;
		rep(i,1,n)fac[i]=fac[i-1]*i%P;
		invfac[n]=qpow(fac[n],P-2);
		Rep(i,n-1,0)invfac[i]=invfac[i+1]*(i+1)%P;
		rep(i,1,m){
			pw[i][0]=1;
			rep(j,1,n)pw[i][j]=pw[i][j-1]*i%P;
		}
	}
	ll C(ll n,ll m){return fac[n]*invfac[m]%P*invfac[n-m]%P;}
	void Malakh(){
		for(IO>>q;q--;){
			IO>>n>>m;
			ll ans=0;
			rep(k,0,m){
				if(k&1^1)ans=(ans+C(n+1,k)*pw[m+1-k][n]%P)%P;
				else ans=(ans+(P-C(n+1,k))*pw[m+1-k][n]%P)%P;
			}
			IO<<ans*invfac[n+1]%P<<'\n';
		}
	}
}//Metatron Mal'akh 绝灭天使·天翼
////////////////////////Subtask 3///////////////////
ll calcfac(ll n){
	ll ret=prefac[n/B];
	rep(i,n/B*B+1,n)ret=ret*i%P;
	return ret;
}
namespace Kadour{
	const ll bl=32768;
	ll pw1[25][32800],inv[25],pw2[25][32800];
	void Metatron(ll m){
		rep(i,1,m){
			pw1[i][0]=1;
			rep(j,1,bl)pw1[i][j]=pw1[i][j-1]*i%P;
			pw2[i][0]=1;
			rep(j,1,bl)pw2[i][j]=pw2[i][j-1]*pw1[i][bl]%P;
		}
		inv[0]=inv[1]=1;
		rep(i,2,m)inv[i]=(P-P/i)*inv[P%i]%P;
	}
	ll pw(ll n,ll m){
		return pw2[n][m>>15]*pw1[n][m&(bl-1)]%P;
	}
	void Kadour(){
		for(IO>>q;q--;){
			IO>>n>>m;
			ll ans=0,binom=1;
			rep(k,0,m){
				if(k&1^1)ans=(ans+binom*pw(m+1-k,n)%P)%P;
				else ans=(ans-binom*pw(m+1-k,n)%P+P)%P;
				binom=binom*(n+1-k)%P*inv[k+1]%P;
			}
			IO<<ans*qpow(calcfac(n+1),P-2)%P<<'\n';
		}
	}
}//Metatron Kadour 绝灭天使·光剑
////////////////////////Subtask 4///////////////////
namespace Artelif{
	ll inv[N<<1],Euler[15][15],ma;
	void Metatron(ll n,ll m){
		ma=n;
		inv[0]=inv[1]=1;
		rep(i,2,n)inv[i]=(P-P/i)*inv[P%i]%P;
		rep(i,0,m)Euler[i][0]=1;
		rep(i,1,m)rep(j,1,i)Euler[i][j]=((j+1)*Euler[i-1][j]%P+(2*i-1-j)*Euler[i-1][j-1])%P;
	}
	ll calcinv(ll n){
		return n<=ma?inv[n]:qpow(n,P-2);
	}
	void Artelif(){
		for(IO>>q;q--;){
			IO.read(n,P);
			IO>>m;
			ll binom=1,ans=0;
			rep(i,n,n+2*m-1)binom=binom*i%P*calcinv(i-n+1)%P;
			rep(i,0,m){
				ans=(ans+binom*Euler[m][i]%P)%P;
				binom=binom*calcinv(n+2*m-1-i)%P*(n-i-1)%P;
			}
			IO<<ans<<'\n';
		}
	}
}//Metatron Artelif 绝灭天使·炮冠
////////////////////////Subtask 5///////////////////
namespace Satan{
	ll Euler[2005][2005];
	void Devil(ll n){
		rep(i,0,n)Euler[i][0]=1;
		rep(i,1,n)rep(j,1,i)Euler[i][j]=((j+1)*Euler[i-1][j]%P+(2*i-1-j)*Euler[i-1][j-1])%P;
	}
	void Satan(){
		for(IO>>q;q--;){
			IO>>n>>m;
			IO<<Euler[n][m]<<'\n';
		}
	}
}//Satan 反转体 救世魔王
int main(){
	IO>>op;
	if(op==1)Shemesh::Metatron(),Shemesh::Shemesh();
	else if(op==2)Malakh::Metatron(2e5+1,21),Malakh::Malakh();
	else if(op==3)Kadour::Metatron(21),Kadour::Kadour();
	else if(op==4)Artelif::Metatron(2e5+100,10),Artelif::Artelif();
	else if(op==5)Satan::Devil(2000),Satan::Satan();
	return 0;
}
```

完结撒折纸！

---

## 作者：MaxBlazeResFire (赞：7)

**写在前面**：由于本题要求值的式子经过出题人精心设计，故可能部分推导与前两篇题解有所重合。本文在前两篇题解的基础上，重点在于 **给出了一阶欧拉数**（非数学归纳法）、**二阶欧拉数通项** 的具体推导，**第二类斯特林数与二阶欧拉数的关系式** 和本题中某些重要恒等式的 **组合意义理解** 。

（已经过多次修改，如仍有内容或格式上的疏漏，请指出，谢谢！）

&nbsp;

参考文章：

[Karry5307 出题人的题解](https://www.luogu.com.cn/blog/Karry5307/solution-p6073)

[Spasmodic 大佬的题解](https://www.luogu.com.cn/blog/Othinus-blog/solution-p6073)

**《具体数学》6.2 节**

**Deng J Q.  - _On the second order Eulerian numbers_**

**I. Gessel and R.P. Stanley - _Stirling Polynomials_**

**Amy. M. Fu - _Some Identities Related to the Second-Order Eulerian Numbers_**

&nbsp;

---

在这里先给出一些定义与重要结论的证明，以便于在题目中直接使用它们。

**可能有一些定义与其它文章或文献有所出入，但由于这些定义本身早已在各文章内产生分歧，故还是以下面定义的为准。**

定义 **欧拉数** $A(n,k)$ 表示，对 $\{1,2,\cdots n\}$ 进行排列得到排列 $P_{1,2\cdots n}$，并且恰有 $k$ 个位置 $i\in[2,n]$ 满足 $P_i>P_{i-1}$ 的排列数量。

该定义与 [P5825](https://www.luogu.com.cn/problem/P5825) 的题面保持一致。

定义 **二阶欧拉数** $B(n,k)$ 表示，对 $\{1,1,2,2,\cdots,n,n\}$ 进行排列得到排列 $P_{1,2,\cdots 2n}$，满足对于任意 $m\in[1,n]$，位于两个 $m$ 之间的数均大于 $m$ 并且恰有 $k$ 个位置 $i\in[2,2n]$ 满足 $P_i>P_{i-1}$ 的排列数量。

由上述定义易得 $A(n,0)=B(n,0)=1,A(n,n)=B(n,2n)=0$. 实际上，$\forall i\in[n,2n],B(n,i)=0$.

第二类斯特林数的定义与它处保持一致。

&nbsp;

## Part0. 一个组合恒等式

$\displaystyle\binom{n+1}{k+m+1}=\sum_{j=0}^n\binom{j}{k}\binom{n-j}{m}$.

考虑其组合意义：现有 $n+1$ 个球排成一行，要从中选择 $k+m+1$ 个球。我们轮流钦定编号为 $j\in[0,n]$ 的球必须选，那么实际上以这个球为分界线，将这个序列分为了左右两部分，那么相当于在大小为 $j$ 和 $n-j$ 的两组内分别选出 $k$ 个和 $m$ 个。

为什么不会算重？考虑一个选球的方案，我们发现它仅会在钦定该方案第 $k+1$ 个球的时候被统计到。

&nbsp;

## Part1. 求欧拉数的一行

给定 $n$ ，对于 $\forall i\in[0,n]$，求出 $A(n,i)$.

也就是 [P5825](https://www.luogu.com.cn/problem/P5825).

定义 $f(k)=A(n,k)$，$g(k)$ 表示钦定排列中有 $k$ 个升高的方案数。

得到下式：

$\displaystyle g(k)=\sum_{i=k}^{n-1}\binom{i}{k}f(i)$.

由二项式反演的外推形式得到：

$\displaystyle f(k)=\sum_{i=k}^{n-1}(-1)^{i-k}\binom{i}{k}g(i)$.

现在要求 $g(i)$. 注意到钦定序列中有 $i$ 个位置必为升高，那么我们将这个序列从左至右划分为 $n-i$ 组且每一组的开头均不是钦定的位置，这样我们发现既然每组最多含有一个不是升高的数，那么每一组都是单调递增的。

啊……那这就是把 $n$ 个有序元素分到 $n-k$ 个有序集合，每个集合至少有一个元素的方案数。二项式反演裸题。设 $F(t)=g(n-t)$ 表示恰有 $t$ 个集合内有数的方案，$G(t)$ 表示至多有 $t$ 个集合内有数的方案，那么有

$\displaystyle t^n=G(t)=\sum_{i=0}^t\binom{t}{i}F(i)\iff F(t)=\sum_{i=0}^t(-1)^{t-i}\binom{t}{i}G(i)=\sum_{i=0}^t(-1)^{t-i}\binom{t}{i}i^n$.

于是可以进行两次 NTT 优化二项式反演解决这个问题。其中第一个容斥是一个减法卷积。

然后我们发现这个 $g(i)$ 实际上呢就是 $(n-i)!\begin{Bmatrix}n\\n-i\end{Bmatrix}$，因为这是第二类斯特林数的通项嘛。由于 $g(n)=0$，枚举上限可以扩展到 $n$.

于是 $\displaystyle A(n,k)=f(k)=\sum_{i=k}^n(-1)^{i-k}\binom{i}{k}(n-i)!\begin{Bmatrix}n\\n-i\end{Bmatrix}$.

&nbsp;

## Part2. 欧拉数的通项

**指数公式定理** ：对于有序元素单集合分组的指数生成函数 ${\rm EGF} \ F(x)$ 与有序元素可空无序集合划分的指数生成函数 ${\rm EGF}\ G(x)$ 有 $G(x)=\exp(F(x))$.

其推论即，有序元素分为 $k$ 个无序集合的指数生成函数为 $\displaystyle\frac{f(x)^k}{k!}$. 对于 **有序集合** 则可以写成 $f(x)^k$.

注意到第二类斯特林数的生成函数的 $\rm EGF$ 为 $e^x-1$，于是在 Part1 中有组合意义的 $g(i)$ 还可以写成

$n![x^n](e^x-1)^{n-i}$. 这里的 $n!$ 是指数生成函数还原为数列自带的系数。

$\displaystyle A(n,m)=\sum_{i=m}^{n-1}(-1)^{i-m}\binom{i}{m}n![x^n](e^x-1)^{n-i}$
 
$\displaystyle=\sum_{i=m}^{n-1}(-1)^{i-m}\binom{i}{m}n![x^n]\sum_{k=0}^{n-i}(-1)^{n-i-k}e^{kx}\binom{n-i}{k}$
 
$\displaystyle=\sum_{i=m}^{n-1}(-1)^{i-m}\binom{i}{m}\sum_{k=0}^{n-i}k^n(-1)^{n-i-k}\binom{n-i}{k}$

$\displaystyle=\sum_{k=0}^{n-m}k^n(-1)^{n-m-k}\sum_{i=m}^{n-k}\binom{i}{m}\binom{n-i}{k}$.

右侧的求和号就是 $Part0$ 里的组合数等式。因为组合数性质可以调整上下限。

$\displaystyle=\sum_{k=0}^{n-m}k^n(-1)^{n-m-k}\binom{n+1}{k+m+1}$.

对于欧拉数有一个重要的性质，$A(n,k)=A(n,n-k-1)$. 可以通过将上升和下降对应互换得到。

于是我们可以将上式中的 $m$ 原封不动地换为 $n-m-1$.

$\displaystyle=\sum_{k=0}^{m+1}k^n(-1)^{m-k+1}\binom{n+1}{n+k-m}$

$\displaystyle=\sum_{k=1}^{m+1}k^n(-1)^{m-k+1}\binom{n+1}{m-k+1}$

$\displaystyle=\sum_{k=0}^m(k+1)^n(-1)^{m-k}\binom{n+1}{m-k}$

$\displaystyle=\sum_{k=0}^m(m-k+1)^n(-1)^{k}\binom{n+1}{k}$.

注意到，如果预处理幂并递推组合数，计算这个式子的复杂度为 $O(m)$.

&nbsp;

## Part3. 由二阶欧拉数导出第二类斯特林数

来自 **I. Gessel and R.P. Stanley** 的智慧结晶。

用组合意义与映射关系证明：$\displaystyle\begin{Bmatrix}n+m\\n\end{Bmatrix}=\sum_{i=0}^mB(m,i)\binom{n+2m-i-1}{2m}$.

定义可重集合 $Q_k=\{1,1,2,2,\cdots k,k\}$；**下文中任何合法的基于 $Q_k$ 的排列均需满足二阶欧拉数中的定义。**

定义 **Bar 序列** 表示在一个数列的任意两个数之间插入任意多个板 **'#'** 得到的序列；

定义 $P_k$ 为基于 $Q_k$ 的排列的 Bar 序列 的集合；

定义 $P_{k,n}$ 表示恰好插有 $n$ 个板，**且每个上升之前的缝隙中间与第一个数之前的位置必须插至少一个板** 的 $P_k$ 内的序列集合。例如：$|P_{2,2}|=7$，其中统计了

$\#11\#22$，$\#1\#221$，$\#\#2211$，$\#2\#211$，$\#22\#11$，$\#221\#1$，$\#2211\#$.

它们均是 $P_2$ 中的 Bar 序列。

&nbsp;

**引理1. $\displaystyle\sum_{n=0}^\infty |P_{k,n}|x^n=\sum_{i=0}^k\frac{B(k,i)x^{i+1}}{(1-x)^{2k+1}}$.**

证明较为容易。考虑 $\displaystyle\frac{1}{(1-x)^{2k+1}}$ 就是往 $2k+1$ 个空里随便插。那便无妨我 **钦定在每个上升的前面和开头之前都强制插入一个板**，并且枚举一下 $k$ 喽。

&nbsp;

**引理2. $|P_{k,n}|=\begin{Bmatrix}n+k\\n\end{Bmatrix}$.**

~~惊喜往往就在一瞬间。~~

采取建立双射的方法。

&nbsp;

---

#### 第一部分：给定一个合法的 $P_{k,n}$ 中的序列，对应一个将 $n+k$ 个元素分为 $n$ 组的划分。

我们一步步来。

&nbsp;

**（1）给定的这个合法的序列，一定可以由以下步骤增量构造而来：第一步，放置一个形如 '##...##' 的子串；之后进行恰好 $k$ 步，其中的第 $i$ 步形如 在上一步形成的序列中某个缝隙中插入 'i##...##i' 状的子串。且该过程有唯一方案。**

想必各位 OIER 对这种神似括号序列的东西都足够敏感，于是不作额外说明。

&nbsp;

**（2）构造方法如下：将每一步均看作将子串从依次左至右顺次添加进某个位置；我们维护一个计数器，每添加一个新元素（板或者数，相同数只算第一个）时，计数器增加并为这个元素赋上计数器当前的值；添加一个板的时候，我们就开辟一个新分组；添加一个数 $i$ （相同数只算第一个）的时候，我们找到这个数左侧的第一个板，将其与这个板归为一组。**

举个例子，增量构造序列 $\#\#11\#2\#3\#443\#2\#$：

| 当前序列 | 当前分组 | 说明 |
| :-----------: | :-----------: | :-----------: |
| $\#\#\#\#$ | $\{1\},\{2\},\{3\},\{4\}$ | 此时为四个板顺次赋上 $1,2,3,4$ 的编号 |
| $\#\#11\#\#$ | $\{1\},\{2,5\},\{3\},\{4\}$ | 第一个 $1$ 左侧板的编号为 $2$，故加入该组 |
| $\#\#11\#2\#\#2\#$ | $\{1\},\{2,5\},\{3,6\},\{4\},\{7\},\{8\}$ | 第一个 $2$ 左侧板的编号为 $6$，故加入该组 |
| $\#\#11\#2\#3\#3\#2\#$ | $\{1\},\{2,5\},\{3,6\},\{4\},\{7,9\},\{8\},\{10\}$ | 第一个 $3$ 左侧板的编号为 $7$，故加入该组 |
| $\#\#11\#2\#3\#443\#2\#$ | $\{1\},\{2,5\},\{3,6\},\{4\},\{7,9\},\{8\},\{10,11\}$ | 第一个 $4$ 左侧板的编号为 $10$，故加入该组 |

由上述过程可以看出，组数就是板数，元素数就是序列长度，符合引理二中斯特林数的形式；且由于序列对应的构造过程唯一与方案唯一，故不同序列得到的分组互不相同。

&nbsp;

---

#### 第二部分：给定一个将 $n+k$ 个元素分为 $n$ 组的划分，对应一个合法的 $P_{k,n}$ 中的序列。

反向操作就可以了，我们仍然一步步来。

**（1）对于给定的分组，我们把每组的最小元素看作板（为了让数保留，用下划线进行标记）。从上述构造过程中我们可以看出每组恰有一个最小的元素代表板。可以看出，剩下的数可以进行离散化。**

$\{1\},\{2,5\},\{3,6\},\{4\},\{7,9\},\{8\},\{10,11\}\rightarrow$

$\{\underline1\},\{\underline2,5\},\{\underline3,6\},\{\underline4\},\{\underline7,9\},\{\underline8\},\{\underline{10},11\}\leftrightarrow$

$\{\#\},\{\#,5\},\{\#,6\},\{\#\},\{\#,9\},\{\#\},\{\#,11\}\rightarrow$

$\{\#\},\{\#,1\},\{\#,2\},\{\#\},\{\#,3\},\{\#\},\{\#,4\}$.

&nbsp;

然后进行增量构造。

**（2）严格按照从左至右的顺序（其实就是按给定分组的最小元素排序后）插入每个组。设当且要插入的组有下划线标记的数为 $i$，若 $i-1$ 是一个没有被下划线标记的数则找到其最左侧出现的位置，插入它的右边，并且将没有被下划线标记的数复制一份加在右侧；若 $i-1$ 是一个被下划线标记的数则这两次插入必然连续，直接放到刚才插入结果的右侧即可。**

举刚才的例子：

| 当前插入 | 当前序列 | 说明 |
| :-----------: | :-----------: | :-----------: |
| $\{\underline1\}$ | $\underline1$ | 插入 $1$ |
| $\{\underline2,5\}$ | $\underline1\underline255$ | 插入上一次插入结果右侧 |
| $\{\underline3,6\}$ | $\underline1\underline255\underline366$ | 插入上一次插入结果右侧 |
| $\{\underline4\}$ | $\underline1\underline255\underline366\underline4$ | 插入上一次插入结果右侧 |
| $\{\underline7,9\}$ | $\underline1\underline255\underline36\underline7996\underline4$ | 插入第一个 $6$ 右侧 |
| $\{\underline8\}$ | $\underline1\underline255\underline36\underline799\underline86\underline4$ | 插入上一次插入结果右侧
| $\{\underline{10},11\}$ | $\underline1\underline255\underline36\underline79\underline{(10)}(11)(11)9\underline86\underline4$ | 插入第一个 $9$ 右侧 |

把下划线还原为 '#' 并对剩下的数离散化就得到：

$\#\#55\#6\#9\#(11)(11)9\#6\#  \rightarrow\#\#11\#2\#3\#443\#2\#$.

这就是我们要求的序列，于是映射建立完毕，引理 2 得证。

&nbsp;

---

我们将引理 1 左右生成函数的 $m$ 次项拿出来对比：

$\displaystyle|P_{k,n}|=\sum_{i=0}^{m-1}B(k,i)[x^{m-i-1}]\frac{1}{(1-x)^{2k+1}}$.

考虑 $\displaystyle[x^{m-i-1}]\frac{1}{(1-x)^{2k+1}}$ 的组合意义是在 把 $m-i-1$ 个相同的球可空地放到 $2k+1$ 个不同的盒子。于是插板法得到 $\displaystyle\binom{2k+m-i-1}{2k}$.

于是 $\displaystyle\begin{Bmatrix}n+m\\n\end{Bmatrix}=|P_{m,n}|=\sum_{i=0}^mB(m,i)\binom{n+2m-i-1}{2m}$.

证毕。

&nbsp;

## Part4. 二阶欧拉数通项公式

在这里我们要证明：

$\displaystyle B(n,k)=\sum_{i=0}^{k}\binom{2n+1}{i}(-1)^i\begin{Bmatrix}n+m-i+1\\m-i+1\end{Bmatrix}$.

考虑将后面的斯特林数用刚推的式子代换：

$\displaystyle B(n,k)=\sum_{i=0}^{k}\binom{2n+1}{i}(-1)^i\sum_{j=0}^nB(n,j)\binom{k-i+2n-j}{2n}$.

枚举左边的 $k$，建立轮换形式：

$\displaystyle\sum_{k=0}^nB(n,k)=\sum_{k=0}^n\sum_{i=0}^{k}\binom{2n+1}{i}(-1)^i\sum_{j=0}^nB(n,j)\binom{k-i+2n-j}{2n}$

$\displaystyle=\sum_{k=0}^nB(n,k)\sum_{j=0}^n\sum_{i=0}^j\binom{2n+1}{i}(-1)^i\binom{j-i+2n-k}{2n}$

$\displaystyle=\sum_{k=0}^nB(n,k)\sum_{i=0}^n\binom{2n+1}{i}(-1)^i\sum_{j=i}^n\binom{j-i+2n-k}{2n}$

$\displaystyle=\sum_{k=0}^nB(n,k)\sum_{i=0}^n\binom{2n+1}{i}(-1)^i\left(\binom{3n-i-k+1}{2n+1}-\binom{2n-k}{2n+1}\right)$.

减号右侧的组合数是 $0$.

$\displaystyle\sum_{k=0}^nB(n,k)=\sum_{k=0}^nB(n,k)\sum_{i=0}^n(-1)^i\binom{2n+1}{i}\binom{3n-i-k+1}{2n+1}$.

用 **“不可以，总司令！”** 的思路 ~~（并且人总是要有梦想的）~~，于是我们直接猜想：

$\displaystyle\forall k\in[0,n],\sum_{i=0}^n(-1)^i\binom{2n+1}{i}\binom{3n-i-k+1}{2n+1}=1$.

接下来我们来证明它。

构造生成函数 $\displaystyle F(x)=(1-x)^{2n+1}$，$\displaystyle G(x)=\frac{1}{(1-x)^{2n+2}}$.

由二项式定理展开式易得 $\displaystyle(-1)^i\binom{2n+1}{i}=[x^i]F(x)$，而 $\displaystyle\binom{3n-i-k+1}{2n+1}$ 就是将 $n-i-k$ 个相同的球放入 $2n+2$ 个不同的盒子里的方案数，于是 $\displaystyle\binom{3n-i-k+1}{2n+1}=[x^{n-i-k}]G(x)$.

于是

$\displaystyle=\sum_{i=0}^n[x^i]F(x)[x^{n-i-k}]G(x)=[x^{n-k}](F(x)\times G(x))$

$\displaystyle=[x^{n-k}]\frac{1}{1-x}=1$. 原式得证。

&nbsp;

---


**题意**：给定长为 $n$ 的序列 $g,h$，再给定 $n$，求 $\displaystyle\sum_{k=0}^nk^ng_kh_{n-k}$ 的值。共有 $5$ 个子任务，对于每个子任务会额外给定限制，它们之间相互独立。每个测试点仅包含 $1$ 个 子任务，但有 $q$ 组数据。

&nbsp;

## Subtask1.

给定 $n$，对于每组数据给定 $m$. $g_k=[k<m],h_k=1$.

$\displaystyle\sum_{k=0}^nk^ng_kh_{n-k}=\sum_{k=0}^{m-1}k^n$. 由于 $n$ 均相同，对于每个数处理出其 $n$ 次幂并做前缀和即可，复杂度 $O(m\log p+q)$.

&nbsp;

## Subtask2.

对于每组数据给定 $n,m$。$\displaystyle g_k=\frac{1}{(k+m+1)!},h_k=[k\geq m]\frac{(-1)^{k-m}}{(k-m)!}$.

首先不考虑 $h$ 定义式中对于 $m$ 大小的限制。

$\displaystyle Ans=\sum_{k=0}^nk^n\frac{1}{(k+m+1)!}\times\frac{(-1)^{n-k-m}}{(n-k-m)!}$

$\displaystyle (n+1)!\times Ans=\sum_{k=0}^nk^n(-1)^{n-k-m}\binom{n+1}{k+m+1}$.

由 Part0 的结论得：

$\displaystyle=\sum_{k=0}^nk^n(-1)^{n-k-m}\sum_{j=0}^n\binom{j}{k}\binom{n-j}{m}$.

因为存在组合数，有 $j\geq k$.

$\displaystyle=\sum_{k=0}^n\sum_{j=k}^nk^n(-1)^{n-k-m}\binom{j}{k}\binom{n-j}{m}$

$\displaystyle=\sum_{j=0}^n\binom{n-j}{m}\sum_{k=0}^jk^n(-1)^{n-k-m}\binom{j}{k}$.

分离一项 $(-1)^{n-k-m}=(-1)^{j-k}\times(-1)^{n-m-j}$.

$\displaystyle=\sum_{j=0}^n(-1)^{n-m-j}\binom{n-j}{m}\sum_{k=0}^jk^n(-1)^{j-k}\binom{j}{k}$.

第二类斯特林数的通项公式为：$\displaystyle\begin{Bmatrix}n\\m\end{Bmatrix}=\frac{1}{m!}\sum_{i=0}^m(-1)^{m-i}\binom{m}{i}i^n$.

代入得

$\displaystyle=\sum_{j=0}^n(-1)^{n-m-j}\binom{n-j}{m}j!\begin{Bmatrix}n\\j\end{Bmatrix}$.

由 Part1 结论有

$\displaystyle A(n,k)=f(k)=\sum_{i=k}^n(-1)^{i-k}\binom{i}{k}(n-i)!\begin{Bmatrix}n\\n-i\end{Bmatrix}$.


令 $k=m$ （题目给出），$j=n-i$. 

$\displaystyle=\sum_{j=n-m}^{n}(-1)^{n-m-j}\binom{n-j}{m}j!\begin{Bmatrix}n\\j\end{Bmatrix}$.

由组合数范围性质，枚举可以下限调整为 $0$. 于是该式等于原式。

我们得到答案 $\displaystyle Ans=\frac{A(n,m)}{(n+1)!}$.

在一开始，我们忽略了 $h$ 的定义式对下标大小的限制。由于该限制本质上是截取了求和号的一部分，于是真正的答案为

$\displaystyle Ans=\frac{A(n,m)-A(m-1,m)}{(n+1)!}$. 而由一阶欧拉数的定义，$A(m-1,m)=0$。

问题来了，$q$ 组数据，如何计算 $A(n,m)$？利用反演式计算复杂度为 $O(n)$，无法采用。

但我们刚才证了 Part2，那么用结论就好了。于是复杂度 $O(nm+qm)$，可以通过。

&nbsp;

## Subtask3.

数列同 Subtask2，但是 $n$ 的范围扩展到了模数级别。

这只对答案分母上的阶乘和幂的预处理造成影响。我们考虑设置一个阈值 $B=10^6$，然后 $\forall i$，打表 $(iB)!$ 的值，那么我们可以做到 $\displaystyle O(B)$ 的查询复杂度。

因为幂的底数只有 $20$ 种，于是对每个数都根号 $n$ 预处理光速幂，用的时候直接 $O(1)$ 就行。

复杂度 $O(q(m+B))$.

&nbsp;

## Subtask4.

对于每组询问给定 $n,m$. $\displaystyle g_k=\frac{k^m}{k!},h_k=\frac{(-1)^k}{k!}$.

$\displaystyle Ans=\sum_{k=0}^nk^n\frac{k^m}{k!}\times\frac{(-1)^{n-k}}{(n-k)!}$

$\displaystyle=\frac{1}{n!}\sum_{k=0}^nk^{n+m}(-1)^{n-k}\binom{n}{k}$.

这是什么？看一下？第二类斯特林数！

$\displaystyle=\begin{Bmatrix}n+m\\n\end{Bmatrix}$.

虽然 sub4 两组数据 $n$ 的范围十分毁天灭地，但是我们有 Part3 的结论，也就是求：

$\displaystyle\sum_{i=0}^mB(m,i)\binom{n+2m-i-1}{2m}$.

二阶欧拉数有一个递推式，通过组合意义易证。

$B(n,k)=(k+1)B(n-1,k)+(2n-1-k)B(n-1,k-1)$.

先 $O(m^2)$ 递推。注意到 sub4 有两部分分，对于 $n$ 较小的部分预处理逆元，复杂度 $O(mq)$，对于 $n$ 较大但 $q$ 较小的部分快速幂，复杂度 $O(mq\log p)$.

需要一个快读取模 ~~（慢读）~~。这里的正确性由 $Lucas$ 定理保证，由于 $m$ 很小，$\displaystyle\binom{n}{m}\bmod p=\binom{n\bmod p}{m}\times\binom{n/p}{0}\bmod p=\binom{n\bmod p}{m}\bmod p$.

&nbsp;

## Subtask5.

对于每组数据给定 $n,m$，求 $\displaystyle Ans=\sum_{k=0}^m(k+1)^m\frac{(k+1)^{n+1}}{(k+1)!}\sum_{i=0}^{m-k}\frac{\binom{2n+1}{i}(-1)^{m-k}}{(m-k-i)!(k+1)^i}$.

$\displaystyle=\sum_{i=0}^m\sum_{k=0}^{m-i}\frac{(k+1)^{m+n+1-i}}{(k+1)!}\frac{\binom{2n+1}{i}(-1)^{m-k}}{(m-k-i)!}$

$\displaystyle=\sum_{i=0}^m\sum_{k=0}^{m-i+1}\frac{k^{m+n+1-i}}{k!}\frac{\binom{2n+1}{i}(-1)^{m-k+1}}{(m-k+1-i)!}$

$\displaystyle=\sum_{i=0}^m\binom{2n+1}{i}(-1)^i\sum_{k=0}^{m-i+1}\frac{k^{m+n+1-i}}{k!}\frac{(-1)^{m-k+1-i}}{(m-k+1-i)!}$

$\displaystyle=\sum_{i=0}^m\binom{2n+1}{i}(-1)^i\begin{Bmatrix}n+m+1-i\\m+1-i\end{Bmatrix}$.

由 Part4 的结论，这就是二阶欧拉数的通项公式。

由于数据范围较小，直接 $O(nm)$ 递推即可。

&nbsp;

---

后话：希望能对大家有所帮助，另外，望通过本篇题解。

题目里有个很深的坑，那就是 $B(0,0)=1$. ~~因为这个 WA 了无数遍。~~

```cpp
#include<bits/stdc++.h>
using namespace std;

#define int long long
#define MAXN 200055
#define mod 998244353
const int B = 1000000;
const int D = 35000;

inline int read(){
	int x = 0; char ch = getchar();
	while( ch < '0' || ch > '9' ) ch = getchar();
	while( ch >= '0' && ch <= '9' ) x = x * 10 + ch - 48,ch = getchar();
	return x;
}

inline int readmod(){
	int x = 0; char ch = getchar();
	while( ch < '0' || ch > '9' ) ch = getchar();
	while( ch >= '0' && ch <= '9' ){
		x = ( x * 10 % mod + ch - 48 + mod ) % mod;
		ch = getchar();
	}
	return x;  
}

void write( int x ){
	if( x >= 10 ) write( x / 10 );
	putchar( x % 10 + 48 );
}

int Id,n,m,q;
int prepow[MAXN] = {0},fac[MAXN] = {0},ifac[MAXN] = {0},inv[MAXN] = {0};
int poww[22][MAXN] = {0};
int facblock[] = {1,373341033,45596018,834980587,623627864,428937595,442819817,499710224,833655840,83857087,295201906,788488293,671639287,849315549,597398273,813259672,732727656,244038325,122642896,310517972,160030060,483239722,683879839,712910418,384710263,433880730,844360005,513089677,101492974,959253371,957629942,678615452,34035221,56734233,524027922,31729117,102311167,330331487,8332991,832392662,545208507,594075875,318497156,859275605,300738984,767818091,864118508,878131539,316588744,812496962,213689172,584871249,980836133,54096741,417876813,363266670,335481797,730839588,393495668,435793297,760025067,811438469,720976283,650770098,586537547,117371703,566486504,749562308,708205284,932912293,939830261,983699513,206579820,301188781,593164676,770845925,247687458,41047791,266419267,937835947,506268060,6177705,936268003,166873118,443834893,328979964,470135404,954410105,117565665,832761782,39806322,478922755,394880724,821825588,468705875,512554988,232240472,876497899,356048018,895187265,808258749,575505950,68190615,939065335,552199946,694814243,385460530,529769387,640377761,916128300,440133909,362216114,826373774,502324157,457648395,385510728,904737188,78988746,454565719,623828097,686156489,713476044,63602402,570334625,681055904,222059821,477211096,343363294,833792655,461853093,741797144,74731896,930484262,268372735,941222802,677432735,474842829,700451655,400176109,697644778,390377694,790010794,360642718,505712943,946647976,339045014,715797300,251680896,70091750,40517433,12629586,850635539,110877109,571935891,695965747,634938288,69072133,155093216,749696762,963086402,544711799,724471925,334646013,574791029,722417626,377929821,743946412,988034679,405207112,18063742,104121967,638607426,607304611,751377777,35834555,313632531,18058363,656121134,40763559,562910912,495867250,48767038,210864657,659137294,715390025,865854329,324322857,388911184,286059202,636456178,421290700,832276048,726437551,526417714,252522639,386147469,674313019,274769381,226519400,272047186,117153405,712896591,486826649,119444874,338909703,18536028,41814114,245606459,140617938,250512392,57084755,157807456,261113192,40258068,194807105,325341339,884328111,896332013,880836012,737358206,202713771,785454372,399586250,485457499,640827004,546969497,749602473,159788463,159111724,218592929,675932866,314795475,811539323,246883213,696818315,759880589,4302336,353070689,477909706,559289160,79781699,878094972,840903973,367416824,973366814,848259019,462421750,667227759,897917455,81800722,956276337,942686845,420541799,417005912,272641764,941778993,217214373,192220616,267901132,50530621,652678397,354880856,164289049,781023184,105376215,315094878,607856504,733905911,457743498,992735713,35212756,231822660,276036750,734558079,424180850,433186147,308380947,18333316,12935086,351491725,655645460,535812389,521902115,67016984,48682076,64748124,489360447,361275315,786336279,805161272,468129309,645091350,887284732,913004502,358814684,281295633,328970139,395955130,164840186,820902807,761699708,246274415,592331769,913846362,866682684,600130702,903837674,529462989,90612675,526540127,533047427,110008879,674279751,801920753,645226926,676886948,752481486,474034007,457790341,166813684,287671032,188118664,244731384,404032157,269766986,423996017,182948540,356801634,737863144,652014069,206068022,504569410,919894484,593398649,963768176,882517476,702523597,949028249,128957299,171997372,50865043,20937461,690959202,581356488,369182214,993580422,193500140,540665426,365786018,743731625,144980423,979536721,773259009,617053935,247670131,843705280,30419459,985463402,261585206,237885042,111276893,488166208,137660292,720784236,244467770,26368504,792857103,666885724,670313309,905683034,259415897,512017253,826265493,111960112,633652060,918048438,516432938,386972415,996212724,610073831,444094191,72480267,665038087,11584804,301029012,723617861,113763819,778259899,937766095,535448641,593907889,783573565,673298635,599533244,655712590,173350007,868198597,169013813,585161712,697502214,573994984,285943986,675831407,3134056,965907646,401920943,665949756,236277883,612745912,813282113,892454686,901222267,624900982,927122298,686321335,84924870,927606072,506664166,353631992,165913238,566073550,816674343,864877926,171259407,908752311,874007723,803597299,613676466,880336545,282280109,128761001,58852065,474075900,434816091,364856903,149123648,388854780,314693916,423183826,419733481,888483202,238933227,336564048,757103493,100189123,855479832,51370348,403061033,496971759,831753030,251718753,272779384,683379259,488844621,881783783,659478190,445719559,740782647,546525906,985524427,548033568,333772553,331916427,752533273,730387628,93829695,655989476,930661318,334885743,466041862,428105027,888238707,232218076,769865249,730641039,616996159,231721356,326973501,426068899,722403656,742756734,663270261,364187931,350431704,671823672,633125919,226166717,386814657,237594135,451479365,546182474,119366536,465211069,605313606,728508871,249619035,663053607,900453742,48293872,229958401,62402409,69570431,71921532,960467929,537087913,514588945,513856225,415497414,286592050,645469437,102052166,163298189,873938719,617583886,986843080,962390239,580971332,665147020,88900164,89866970,826426395,616059995,443012312,659160562,229855967,687413213,59809521,398599610,325666688,154765991,159186619,210830877,386454418,84493735,974220646,820097297,2191828,481459931,729073424,551556379,926316039,151357011,808637654,218058015,786112034,850407126,84202800,94214098,30019651,121701603,176055335,865461951,553631971,286620803,984061713,888573766,302767023,977070668,110954576,83922475,51568171,60949367,19533020,510592752,615419476,341370469,912573425,286207526,206707897,384156962,414163604,193301813,749570167,366933789,11470970,600191572,391667731,328736286,30645366,215162519,604947226,236199953,718439098,411423177,803407599,632441623,766760224,263006576,757681534,61082578,681666415,947466395,12206799,659767098,933746852,978860867,59215985,161179205,439197472,259779111,511621808,145770512,882749888,943124465,872053396,631078482,166861622,743415395,772287179,602427948,924112080,385643091,794973480,883782693,869723371,805963889,313106351,262132854,400034567,488248149,265769800,791715397,408753255,468381897,415812467,172922144,64404368,281500398,512318142,288791777,955559118,242484726,536413695,205340854,707803527,576699812,218525078,875554190,46283078,833841915,763148293,807722138,788080170,556901372,150896699,253151120,97856807,918256774,771557187,582547026,472709375,911615063,743371401,641382840,446540967,184639537,157247760,775930891,939702814,499082462,19536133,548753627,593243221,563850263,185475971,687419227,396799323,657976136,864535682,433009242,860830935,33107339,517661450,467651311,812398757,202133852,431839017,709549400,99643620,773282878,290471030,61134552,129206504,929147251,837008968,422332597,353775281,469563025,62265336,835064501,851685235,21197005,264793769,326416680,118842991,84257200,763248924,687559609,150907932,401832452,242726978,766752066,959173604,390269102,992293822,744816299,476631694,177284763,702429415,374065901,169855231,629007616,719169602,564737074,475119050,714502830,40993711,820235888,749063595,239329111,612759169,18591377,419142436,442202439,941600951,158013406,637073231,471564060,447222237,701248503,599797734,577221870,69656699,51052704,6544303,10958310,554955500,943192237,192526269,897983911,961628039,240232720,627280533,710239542,70255649,261743865,228474833,776408079,304180483,63607040,953297493,758058902,395529997,156010331,825833840,539880795,234683685,52626619,751843490,116909119,62806842,574857555,353417551,40061330,822203768,681051568,490913702,9322961,766631257,124794668,37844313,163524507,729108319,490867505,47035168,682765157,53842115,817965276,757179922,339238384,909741023,150530547,158444563,140949492,993302799,551621442,137578883,475122706,443869843,605400098,689361523,769596520,801661499,474900284,586624857,349960501,134084537,650564083,877097974,379857427,887890124,159436401,133274277,986182139,729720334,568925901,459461496,499309445,493171177,460958750,380694152,168836226,840160881,141116880,225064950,109618190,842341383,85305729,759273275,97369807,669317759,766247510,829017039,550323884,261274540,918239352,29606025,870793828,293683814,378510746,367270918,481292028,813097823,798448487,230791733,899305835,504040630,162510533,479367951,275282274,806951470,462774647,56473153,184659008,905122161,664034750,109726629,59372704,325795100,486860143,843736533,924723613,880348000,801252478,616515290,776142608,284803450,583439582,274826676,6018349,377403437,244041569,527081707,544763288,708818585,354033051,904309832,589922898,673933870,682858433,945260111,899893421,515264973,911685911,9527148,239480646,524126897,48259065,578214879,118677219,786127243,869205770,923276513,937928886,802186160,12198440,638784295,34200904,758925811,185027790,80918046,120604699,610456697,573601211,208296321,49743354,653691911,490750754,674335312,887877110,875880304,308360096,414636410,886100267,8525751,636257427,558338775,500159951,696213291,97268896,364983542,937928436,641582714,586211304,345265657,994704486,443549763,207259440,302122082,166055224,623250998,239642551,476337075,283167364,211328914,68064804,950202136,187552679,18938709,646784245,598764068,538505481,610424991,864445053,390248689,278395191,686098470,935957187,868529577,329970687,804930040,84992079,474569269,810762228,573258936,756464212,155080225,286966169,283614605,19283401,24257676,871831819,612689791,846988741,617120754,971716517,979541482,297910784,991087897,783825907,214821357,689498189,405026419,946731704,609346370,707669156,457703127,957341187,980735523,649367684,791011898,82098966,234729712,105002711,130614285,291032164,193188049,363211260,58108651,100756444,954947696,346032213,863300806,36876722,622610957,289232396,667938985,734886266,395881057,417188702,183092975,887586469,83334648,797819763,100176902,781587414,841864935,371674670,18247584};
int cd[22][D + 5] = {0},Bk[2005][2005] = {0};

inline int fp( int x , int p ){ int res = 1; while( p ){ if( p & 1 ) res = res * x % mod; x = x * x % mod; p >>= 1; } return res; }
inline int Fac( int T ){
	int Ans = facblock[T / B];
	for( int i = T / B * B + 1 ; i <= T ; i ++ )
		Ans = Ans * i % mod;
	return Ans;
}
inline int mpow( int x , int k ){ return cd[x][k / D] * poww[x][k % D] % mod; }
inline int C( int n , int m ){ return n >= m ? fac[n] * ifac[m] % mod * ifac[n - m] % mod : 0; }

inline void solve1(){
	n = read(),q = read();
	for( int i = 1 ; i <= n ; i ++ ) prepow[i] = fp( i , n );
	for( int i = 1 ; i <= n ; i ++ ) prepow[i] = ( prepow[i] + prepow[i - 1] ) % mod;
	for( int i = 1 ; i <= q ; i ++ ){
		m = read();
		write( prepow[m - 1] ); puts("");
	}
}

inline void solve2(){
	for( int i = 0 ; i <= 21 ; i ++ ){
		poww[i][0] = 1;
		for( int j = 1 ; j <= MAXN - 5 ; j ++ ) poww[i][j] = poww[i][j - 1] * i % mod;
	}
	q = read();
	for( int i = 1 ; i <= q ; i ++ ){
		n = read(),m = read();
		int Ans = 0,t = 1;
		for( int k = 0 ; k <= m ; k ++ ){
			Ans = ( Ans + 1ll * poww[m - k + 1][n] * t % mod * C( n + 1 , k ) % mod ) % mod;
			t = mod - t;
		}
		printf("%lld\n",Ans * ifac[n + 1] % mod);
	}
}

inline void solve3(){
	for( int i = 0 ; i <= 21 ; i ++ ){
		poww[i][0] = 1;
		for( int j = 1 ; j <= MAXN - 5 ; j ++ ) poww[i][j] = poww[i][j - 1] * i % mod;
		cd[i][0] = 1;
		for( int j = 1 ; j <= D ; j ++ ) cd[i][j] = cd[i][j - 1] * poww[i][D] % mod;
	}
	q = read();
	for( int i = 1 ; i <= q ; i ++ ){
		n = read(),m = read();
		int Ans = 0,C = 1,t = 1;
		for( int k = 0 ; k <= min( m , n + 1 ) ; k ++ ){
			Ans = ( Ans + mpow( m - k + 1 , n ) * t % mod * C % mod ) % mod;
			t = mod - t,C = C * inv[k + 1] % mod * ( n + 1 - k ) % mod;
		}
		printf("%lld\n",Ans * fp( Fac( n + 1 ) , mod - 2 ) % mod);
	}
}

inline int getrev( int x ){ if( x <= MAXN + 100 ) return inv[x]; else return fp( x , mod - 2 ); }

inline void solve4(){
	q = read();
	for( int i = 0 ; i <= m ; i ++ ) Bk[i][0] = 1;
	for( int i = 1 ; i <= 20 ; i ++ ){
		Bk[i][0] = 1;
		for( int j = 1 ; j <= 20 ; j ++ )
			Bk[i][j] = ( ( j + 1 ) * Bk[i - 1][j] % mod + ( 2 * i - j - 1 ) * Bk[i - 1][j - 1] % mod ) % mod;
	}
	for( int i = 1 ; i <= q ; i ++ ){
		n = readmod(),m = read();
		int Ans = 0,tmp = 1;
		for( int i = n ; i <= n + 2 * m - 1 ; i ++ ) tmp = 1ll * tmp * i % mod * getrev( i - n + 1 ) % mod;
		for( int i = 0 ; i <= m ; i ++ ){
			Ans = ( Ans + 1ll * tmp * Bk[m][i] % mod ) % mod;
			tmp = 1ll * tmp * getrev( n + 2 * m - i - 1 ) % mod * ( n - i - 1 ) % mod;
		}
		printf("%lld\n",Ans);
	}
}

inline void solve5(){
	for( int i = 1 ; i <= 2000 ; i ++ ){
		Bk[i][0] = 1;
		for( int j = 1 ; j <= 2000 ; j ++ )
			Bk[i][j] = ( ( j + 1 ) * Bk[i - 1][j] % mod + ( 2 * i - j - 1 ) * Bk[i - 1][j - 1] % mod ) % mod;
	}
	q = read();
	for( int i = 1 ; i <= q ; i ++ ){
		n = read(),m = read();
		printf("%lld\n",Bk[n][m]);
	}
}

signed main(){
	fac[0] = 1; for( int i = 1 ; i <= MAXN - 5 ; i ++ ) fac[i] = fac[i - 1] * i % mod;
	inv[1] = 1; for( int i = 2 ; i <= MAXN - 5 ; i ++ ) inv[i] = ( mod - mod / i ) * inv[mod % i] % mod;
	ifac[0] = 1; for( int i = 1 ; i <= MAXN - 5 ; i ++ ) ifac[i] = ifac[i - 1] * inv[i] % mod;
	Id = read();
	if( Id == 1 ) solve1();
	else if( Id == 2 ) solve2();
	else if( Id == 3 ) solve3();
	else if( Id == 4 ) solve4();
	else if( Id == 5 ) solve5();
	return 0;
}
```

---


# [集训队互测 2024] 药水

## 题目描述

你是一位远近闻名的大法师，你拥有一个药水店，店里有一个容量为 $k$ 单位的炼药锅。

药水店一共经营了 $n$ 天，每天会发生以下的事件恰好一次：

**有个初始给定的概率序列 $a_l,a_{l+1}\dots a_r$，表示 $l\sim r$ 被随机选中的概率，保证 $\sum a_i=1$，然后每天会按照 $a$ 带权随机一个整数 $i$。**

**如果 $i=0$，则什么也不干；**

**如果 $i<0$，则有一位顾客买走了 $-i$ 单位的药水，你的锅中药水量始终不能小于 $0$；**

**如果 $i>0$，则大法师向锅内加入了 $i$ 单位的药水，如果超过了锅的容量则加到满为止。**

同时你还可以在每天结束时决定是否清空炼药锅。（第一天开始前视作清空过炼药锅）。

药水店的顾客很挑剔，如果他们买到的药水的陈旧度超过 $m$ 天，那么他们就会生气。

药水的陈旧度定义为该日炼药锅距离上一次清空过了多少天，例如，昨天结束时刚清空完炼药锅则今日药水的陈旧度为 $1$（当然，这种情况下今天开始时锅里也没有药水）。

**为了维持你的名声，即使某天没有顾客来，你也要保证当天清空前锅里的药水的陈旧度不超过 $m$。**

作为一位大法师，你自然不希望有顾客生气。因此对于接下来 $n$ 天的每一种情况，如果你能在预知每天发生的事件的基础下合理清空炼药锅，使得没有人生气，你就认为这种情况是好的。

即，对于一个确定的事件序列 $b_1,b_2,\dots,b_n$（$b_i$ 为第 $i$ 天随机到的整数），你认为他发生的概率是 $\prod_{i=1}^n a_{b_i}$，且你认为他是好的当且仅当存在一种清空炼药锅的方案，使得每天锅里的药水的陈旧度都不超过 $m$，且所有顾客都买到了他需要的药水量。

现在你想知道这 $n$ 天的情况有多大概率是好的，因为你不喜欢实数，所以你只想知道答案对 $998244353$ 取模的结果。

**形式化题意：**

给定概率序列 $a_l,a_{l+1},\dots,a_r$，保证 $\sum a_i=1$。

考虑所有长为 $n$ 的整数序列 $b_1,b_2,\dots,b_n$，满足 $b_i\in [l,r]$，定义其出现概率为 $\prod_i a_{b_i}$。

定义序列 $b$ 是好的，当且仅当存在 $c_1,c_2\dots,c_n$，满足 $c_i\in \{0,k\}$，使得数列 $s_i=\min(s_{i-1}+b_i,c_i)$ 所有元素 $\geq 0$，且任意连续 $m$ 项都有一项为 $0$，其中 $s_0=0$。

求所有好的 $b$ 序列的出现概率之和对 $998244353$ 取模的结果。

## 说明/提示


| subtask |          $n$           | $r-l+1$  |       特殊性质        | 分值 |
| :-----: | :--------------------: | :------: | :-------------------: | :--: |
|   $1$   |       $\leq 10$        | $\leq 7$ |          无           | $10$ |
|   $2$   |       $\leq 100$       | $\leq 7$ |          无           | $10$ |
|   $3$   |      $\leq 10^4$       | $\leq 7$ |          无           | $20$ |
|   $4$   | $\leq 1.2\times 10^5$  | $\leq 3$ | $a'_{-1}=a'_1,a'_0=0$ | $15$ |
|   $5$   | $\leq 1.2\times 10^5$  | $\leq 3$ |          无           | $10$ |
|   $6$   |  $\leq 6\times 10^4$   | $\leq 5$ |          无           | $15$ |
|   $7$   | $\leq 1.2 \times 10^5$ | $\leq 7$ |          无           | $20$ |

对于所有数据：$1\leq m\leq n \leq 1.2\times10^5$，$1\leq k \leq 10^6$，$-3\leq l < 0 < r \leq 3$，$a'_i \in [0,998244353)$，$a'_l,a'_r>0$，$\sum a'_i\equiv 1 \pmod{998244353}$。

## 样例 #1

### 输入

```
3 2 1 -1 1
499122177 0 499122177```

### 输出

```
623902721```

## 样例 #2

### 输入

```
10 7 7 -2 2
1 2 3 4 998244344```

### 输出

```
5347454```

## 样例 #3

### 输入

```
10000 6000 11451 -3 3
1 9 1 998244325 9 8 1```

### 输出

```
45917006```

## 样例 #4

### 输入

```
120000 100000 114514 -3 3
875253823 187452905 284279374 460346727 51435610 206896725 929067896```

### 输出

```
206445697```

# 题解

## 作者：NaCly_Fish (赞：3)

来一个和官方题解不一样的做法，代码暂时没写，但经过暴力做法验证。

****

### 一：去除 $m$ 的限制

如果没有「每 $m$ 天必须清空锅」的限制，那么原问题就是比较经典的限制范围的格路计数问题。所以来考虑怎么把问题化简一下。

利用符号化计数的思想，考虑所有「没有清空锅的极长连续段」，那么所有 $n$ 天的情况就是由若干连续段拼接成的。

具体来说，设 $f_i$ 为 $i=n$ 时原问题的答案，$g_i \ (1 \leq i \leq m)$ 为「长度为 $i$ 的极长连续段」的答案，则有：

$$F(x) = \frac{1}{1-G(x)}$$
其中 $F(x)$ 和 $G(x)$ 分别为 $\{ f_i \}$ 和 $\{ g_i \}$ 的生成函数。

我们知道，在 $i \leq m$ 的时候，原问题的答案等同于「不必须清空锅」情况的答案，并设其为 $\hat f_i \ (0 \leq i \leq m)$，所以我们有
$$F(x) \equiv \hat F(x) \pmod {x^{m+1}}$$
这样就能直接求出 $G(x)$：
$$G(x) \equiv 1-\hat F(x)^{-1} \pmod{x^{m+1}}$$
由于 $G(x)$ 本身就是个 $m$ 次多项式，对 $x^{m+1}$ 取模并不影响计算的结果。

这样在求出 $\hat F(x) \bmod x^{m+1}$ 后，就只需要用两次多项式求逆即可得到答案。
****

### 二：朴素地算 $\hat F(x)$

因为算出 $\hat F(x)$ 的后续工作都很简单，下文中 $G(x)$ 及 $g_i$ 的定义将与上文不同。

从 $(0,0)$ 出发，每一步有 $a_d$ 的概率坐标变化量为 $(1,d)$，不能越过 $y=0$ 且越过 $y=k$ 时会 $y$ 坐标强制移动到 $k$。设 $g_{i,j}$ 为上述问题中走 $i$ 步后到 $(i,j)$ 位置的概率。

显然有 $\hat f_i = \sum_j g_{i,j}$，而根据问题定义容易写出 $g_{i,j}$ 的 DP：

$$g_{i+1,\min(j+d,k)} \leftarrow g_{i,j} a_d \ \ (j+d \geq 0)$$

****

### 三：麻烦地算 $\hat F(x)$

设 $G_j(x)=\sum_i g_{i,j} x^i$，那么根据递推式我们可以得到一个关于 $G_j(x)$ 的 $k+1$ 元线性方程组。具体而言，对 $0 \leq j < k$ 都有：

$$G_j(x)= [j=0]+x\sum_{i=l}^r a_i G_{j-i}(x) $$
而对于 $j=k$ 的情况，会多一部分越过 $y=k$ 强制到 $k$ 而产生的贡献（称其为终点方程），不过形式上还是很相似的。

如此就得到了 $k+1$ 条方程，将 $G_0(x)$ 设为一个未定元，由此 $G_j(x)$ 都可以表示为 $A_j(x)G_0(x)+B_j(x)$ 的形式，可以依此递推出来。
  
最后根据「终点方程」解出 $G_0(x)$，也就解出了所有 $G_j(x)$，最后计算 $\hat F(x)=\sum_j G_j(x)$ 即可。

****

### 四：更麻烦但更快地算 $\hat F(x)$

显然上述做法的时间复杂度是很大的，但是注意到 $G_j(x) \ (1 \leq j < k)$ 的方程是一个常系数齐次线性递推。根据其通项的性质，我们可以直接判断出 $A_j(x)$ 和 $B_j(x)$ 必然都是微分有限的幂级数。

为什么？这里以 $l=-3,r=3$ 的情况来说明。此时 $G_j(x)$ 的递推式是 $6$ 阶常系数的，要得到其通项需要解一个 $6$ 次的特征方程（不需要真的解出来，在计算中可以代数扩域），其解 $u_1,\cdots,u_6$ 自然也是代数幂级数，假设没有重根。

那么其通项 
$$G_j(x) = \sum_{i=1}^6 (U_i(x) G_0(x) +V_i(x)) u_i^j$$
显而易见，代数幂级数复合进微分有限幂级数中，结果仍然微分有限。对于有重根的情况，证明也是类似的。

现在就可以求出 $A_j(x)$（和 $B_j(x)$） 的 ODE 或其系数的整式递推式（用含 $j$ 的表达式以方便对所有 $j$ 求解）：  

- 一种方法是 ODE 自动机，这在实现上可能比较复杂，不过有一些现成的模板可以参考。
  
- 另一种方法是求出前面一些项，然后用高斯消元找出整式递推式。但这种方法需要对多个 $j$ 计算后，将递推式中的每个系数都对 $j$ 做多项式插值。

设 $D=r-l$，可以证明 $A_j(x)$ 存在 $D+O(1)$ 阶、$D+O(1)$ 次的整式递推，而递推系数中 $j$ 的最高次数也是 $D+O(1)$ 的。

得到了 $A_j(x)$ 的 ODE 后，求出 $\sum_j A_j(x)$ 的 ODE 就很简单了。直接对所有 $j$ 把 $A_j(x)$ 的 ODE 中的系数全部加起来即可。

ODE 自动机的复杂度不太会分析，但是高斯消元法求出整式递推的复杂度是 $\Theta(D \times (D^2)^3)=\Theta(D^7)$ 的（要做 $D$ 次才能插值，而每次需要求出 $\Theta(D^2)$ 项解一个 $\Theta(D^2)$ 元方程组，再算上消元本身的三次方时间）。

这样就可以做到 $\Theta(D^7+ n D^2\log n)$。

---


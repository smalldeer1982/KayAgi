# [SDOI2014] 酗酒者

## 题目描述

$\text{Alice}$ 发现：人在心情不好的时候，便会选择酗酒。这往往与 $\text{OI}$ 选手比赛胜利后的欢腾庆祝不同，酗酒者喝醉后便会忘记回家的路，然后在大街上无规律地乱走乱逛，同时喊着一些谁也听不懂的话。

这几天，$\text{Bob}$ 因为考试的原因心情很不好，每天晚上都会在城里面找一处酒吧。喝醉后离开酒吧开始在城市街道中无规律乱走，直到某一时刻，若他碰巧遇到了在夜晚出来看星星的 $\text{Alice}$，便会被她带回家。

已知 $\text{Alice}$ 和 $\text{Bob}$ 所在的城市街道可以被描绘为一个 $N$ 行 $M$ 列的格点地图，$N$ 行依次编号为 $0$ 到 $N-1$，$M$ 列依次编号为 $0$ 到 $M-1$。城市中共有 $N\times M$ 处路口，每一个路口可以用坐标 $(i,j)$ 表示。若 $i<N$，则 $(i,j)$ 与 $(i+1,j)$ 有无向的连边，边权长度，$p_{(i,j)}$ 表示走过这一条路所需的时间。若 $j<M$，则 $(i,j)$ 与 $(i,j+1)$ 有连无向边，边权长度 $q_{(i,j)}$。

对于给定的两个点 $(u,v)$ 和 $(s,t)$ 分别为 $\text{Bob}$ 今晚去的酒吧的位置，和 $\text{Alice}$ 今晚看星星的位置。$\text{Bob}$ 离开酒吧后，对于每一个路口，他会等概率选择其中之一，然后走向下一个路口。在走到下一个路口之前，$\text{Bob}$ 不会回头。同时 $\text{Bob}$ 并不会因为之前走过什么道路而影响之后的行走路线。

具体来说：如果 $\text{Bob}$ 从 $(3,4)$ 走到 $(3,5)$，他有可能在抵达 $(3,5)$ 后立刻折回 $(3,4)$。对于四叉路口，$\text{Bob}$ 向每一个方向行走的概率都是 $1/4$，对于三叉路口（这只存在于城市的边界上）则是 $1/3$，对于二叉路口（这只存在于城市的 $4$ 个角落）就是 $1/2$。

$\text{Alice}$ 希望知道，从 $\text{Bob}$ 离开酒吧，$\text{Alice}$ 期望情况下还需要等多久才能等到 $\text{Bob}$，即对于给定的两个点 $(u,v)$ 与 $(s,t)$，$\text{Bob}$ 从 $(u,v)$ 走到 $(s,t)$ 的期望用时是多少？

## 说明/提示

对于 $10\%$ 的数据，$N \times M \le 25$。

对于 $30\%$ 的数据，$N \times M \le 625$。

对于 $50\%$ 的数据，$N \times M \le 2500$。

对于 $100\%$ 的数据，$1 \le N \times M \le 10^4$，$1 \le Q \le 100$。$1 \le p_{(i,j)},q_{(i,j)} \le 200$。

此外存在 $10\%$ 的数据，$\min(N,M) \le 10$。

## 样例 #1

### 输入

```
2 2
1 2
3
4
4
0 0 0 1
1 0 0 1
1 1 0 1
0 1 1 0```

### 输出

```
7.0000
10.0000
8.0000
10.0000```

# 题解

## 作者：f321dd (赞：4)

以下设 $n \le m$。

这题的数据范围比较令人迷惑。由于询问的起点和终点都不固定，每次询问都只能整体重新计算，或许没有办法优化。但是其实 $\Theta(qn^3m)$ 的算法就可以通过，实际数据中 $q$ 最大只有 $25$。

首先列出期望方程。考虑进行高斯消元，初始第 $i$ 个变量只和第 $i-n, i-1, i+1, i+n$ 个变量有关，由于网格图的结构，在高斯消元中消去一个变量始终只会影响之后的 $n$ 个变量。这样消元的复杂度是 $\Theta(n^3m)$。

在 [Circles of Waiting](https://www.luogu.com.cn/problem/CF963E) 一题中也可以使用同样的方法，不过其实本题出现得更早。然而那个题可以使用主元法，将复杂度进一步降低到 $\Theta(n^3)$，本题却完全不能使用。因为本题是浮点数计算，如果使用主元法，每经过一列数值的规模就会增加约 $4$ 倍，精度会炸上天。为了保证数值精度，或许无法优化复杂度。

---


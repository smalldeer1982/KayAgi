# åˆ›ä¸–çºª

## é¢˜ç›®æè¿°

ä¸Šå¸æ‰‹ä¸­æœ‰ $N$ ç§ä¸–ç•Œå…ƒç´ ï¼Œæ¯ç§å…ƒç´ å¯ä»¥é™åˆ¶å¦å¤– $1$ ç§å…ƒç´ ï¼ŒæŠŠç¬¬ $i$ ç§ä¸–ç•Œå…ƒç´ èƒ½å¤Ÿé™åˆ¶çš„é‚£ç§ä¸–ç•Œå…ƒç´ è®°ä¸º $A[i]$ã€‚

ç°åœ¨ï¼Œä¸Šå¸è¦æŠŠå®ƒä»¬ä¸­çš„ä¸€éƒ¨åˆ†æŠ•æ”¾åˆ°ä¸€ä¸ªæ–°çš„ç©ºé—´ä¸­å»å»ºé€ ä¸–ç•Œã€‚

ä¸ºäº†ä¸–ç•Œçš„å’Œå¹³ä¸å®‰å®ï¼Œä¸Šå¸å¸Œæœ›æ‰€æœ‰è¢«æŠ•æ”¾çš„ä¸–ç•Œå…ƒç´ éƒ½è‡³å°‘æœ‰ä¸€ä¸ªèƒ½å¤Ÿé™åˆ¶å®ƒçš„ä¸–ç•Œå…ƒç´ æ²¡æœ‰è¢«æŠ•æ”¾ã€‚

ä¸Šå¸å¸Œæœ›çŸ¥é“ï¼Œåœ¨æ­¤å‰æä¸‹ï¼Œä»–æœ€å¤šå¯ä»¥æŠ•æ”¾å¤šå°‘ç§ä¸–ç•Œå…ƒç´ ï¼Ÿ

## è¯´æ˜/æç¤º

æ•°æ®ä¿è¯ï¼Œ$1\le N \le 10^6$ï¼Œ$1 \le A[i] \le N$

## æ ·ä¾‹ #1

### è¾“å…¥

```
6
2 3 1 3 6 5```

### è¾“å‡º

```
3```

# é¢˜è§£

## ä½œè€…ï¼šmxjz666 (èµï¼š11)

### æ€è·¯
æœ¬é¢˜å¦‚æœå°† $i$ å‘ $a_i$ è¿è¾¹ï¼Œé‚£ä¹ˆå°±æˆäº†åŸºç¯æ ‘å†…å‘æ ‘æ£®æ—ï¼Œä¸å¥½å¤„ç†ï¼Œæ‰€ä»¥æˆ‘ä»¬å°† $a_i$ å‘ $i$ è¿è¾¹ï¼Œè¿™æ ·å°±æˆäº†åŸºç¯æ ‘å¤–å‘æ ‘æ£®æ—ã€‚

è€ƒè™‘æŸä¸€æ£µåŸºç¯æ ‘ï¼š
å…ˆæ‰¾åˆ°ç¯ä¸Šçš„ä¸€ç‚¹ $p$ æ–­æ‰ $p$ ä¸ $a_p$ çš„è¿è¾¹ï¼Œè¿™æ ·å°±æˆäº†ä¸€æ£µä»¥ $p$ ä¸ºæ ¹çš„æ ‘ã€‚
æ¥ç€è®¾ $f_{x,0/1}$ è¡¨ç¤º $x$ ä¸é€‰/é€‰æ—¶ï¼Œä»¥ $x$ ä¸ºæ ¹çš„å­æ ‘çš„æœ€å¤šå¯ä»¥æŠ•æ”¾çš„ä¸ªæ•°ã€‚
çŠ¶æ€è½¬ç§»æ–¹ç¨‹ä¸º $f_{x,0}=\sum\limits_{y \in Son(x)} \max(f_{y,0},f_{y,1})$

$f_{x,1}=1+\max\limits_{y \in Son(x)}\{f_{y,0}+\sum\limits_{z \in Son(x),z\neq y} \max(f_{z,0},f_{z,1})\}$

ä½†å…¶ä¸­ $f_{x,1}$ çš„è½¬ç§»æ˜¯å¯ä»¥ä¼˜åŒ–çš„ï¼Œè¿›è€Œä¼˜åŒ–æˆï¼š

$f_{x,1}=1+f_{x,0}-\min\limits_{y \in Son(x)}\{\max(f_{y,0},f_{y,1})-f_{y,0}\}$

ç„¶åï¼Œå› ä¸ºè¿™æ˜¯å¿½ç•¥äº† $p$ å¯ä»¥é™åˆ¶ $a_p$ è¿™ä¸ªæ¡ä»¶ï¼Œæ‰€ä»¥è¿™æ˜¯æˆ‘ä»¬å¯ä»¥è®© $p$ å¼ºåˆ¶é™åˆ¶ $a_p$ è¿™æ ·å†è®¡ç®—ä¸€æ¬¡ã€‚

### ä»£ç 
```cpp
#include<bits/stdc++.h>
using namespace std;
const int N=1e6+10;
int bid,h[N],nxt[N],to[N],n,a[N],f[N][2],ans,km;
bool vis[N];
void add(int x,int y){
	to[++bid]=y;
	nxt[bid]=h[x];
	h[x]=bid;
}
int dp(int x,int d){
	f[x][0]=f[x][1]=0;
	vis[x]=1;
	int res=0,c=1e9+7;
	for(int i=h[x];i;i=nxt[i]){
		int y=to[i];
		if(y==km)continue;
		res=dp(y,d);
		c=min(c,res-f[y][0]);
		f[x][0]+=res;
	}
	f[x][1]=f[x][0]-c+1;
	if(d&&x==a[km])f[x][1]+=c;
	return max(f[x][0],f[x][1]);
}
int hjw(int x){
	for(km=x;!vis[a[km]];vis[km]=1)km=a[km];
	int cnt=dp(km,0);
	dp(km,1);
	return max(cnt,f[km][0]);
}
int main(){
	cin>>n;
	for(int i=1;i<=n;i++){
		scanf("%d",&a[i]);
		add(a[i],i);
	}
	for(int i=1;i<=n;i++)if(!vis[i])ans+=hjw(i);
	cout<<ans;
	return 0;
}

```

---

## ä½œè€…ï¼šFirsry (èµï¼š9)

# P10933 åˆ›ä¸–çºª

æœ¬æ–‡é‡ç‚¹è®²è§£ä¸€ä¸‹æ€è·¯ä¸­æ¯”è¾ƒå®¹æ˜“å¡é¡¿çš„ä½ç½®ã€‚çŠ¶æ€è½¬ç§»æ–¹ç¨‹[è¿™ç¯‡é¢˜è§£](https://www.luogu.com.cn/article/32nzvwri)æœ‰ç€è¯¦ç»†çš„è®²è§£ï¼Œä»æ¨å¯¼åˆ°ä¼˜åŒ–ï¼Œè¿™é‡Œå°±ä¸èµ˜è¿°äº†ã€‚

### åå‘å»ºè¾¹

æˆ‘ä»¬åå‘å»ºç«‹è¾¹ï¼Œä¹Ÿå°±æ˜¯å»ºç«‹ $A_i \rightarrow i$ çš„è¾¹ï¼Œè¡¨ç¤º $i$ é™åˆ¶ $A_i$ï¼Œè¿™æ ·çš„å¥½å¤„æ˜¯ä¸€æ£µå¤–å‘æ ‘ï¼Œæ¯ä¸ªèŠ‚ç‚¹æœ‰ä¸€ä¸ªå…¥åº¦å’Œå¤šä¸ªå‡ºåº¦ï¼Œç¬¦åˆæ­£å¸¸äººçš„ä¹ æƒ¯ã€‚

è¿™è¿˜å¸¦æ¥ä¸€ä¸ªå¥½å¤„ï¼Œå°±æ˜¯é“¾å¼å‰å‘æ˜Ÿä¸éœ€è¦å¼€äºŒå€ç©ºé—´äº†ï¼Œè€Œåœ¨åˆ å»è¾¹çš„éƒ¨åˆ†ä¹Ÿä¸ç”¨è€ƒè™‘åŒå‘è¾¹å¸¦æ¥çš„éº»çƒ¦ã€‚

### $A_i$ å¼è¿”ç¥–æ‰¾ç¯

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œä¾‹å¦‚æˆ‘ä»¬ä» $9$ å·èŠ‚ç‚¹å¼€å§‹å‘ä¸Šè·³ï¼Œåˆ™è·¯å¾„æ˜¯ï¼š
$$
9 \rightarrow 8 \rightarrow 4 \rightarrow 3 \rightarrow 2 \rightarrow 1 \rightarrow 5
$$
æ³¨æ„å»ºè¾¹æ˜¯åå‘å»ºè¾¹ï¼Œè¿”ç¥–å°±æ˜¯é€†æµè€Œä¸Šï¼š$p=A_p$ ã€‚æˆ‘ä»¬åœ¨è¿”ç¥–çš„è¿‡ç¨‹ä¸­ç”¨ $vis$ æ•°ç»„æ ‡è®°èµ°è¿‡çš„ç‚¹ï¼Œåˆ™é‡åˆ°ä¸€ä¸ªæ ‡è®°è¿‡çš„ç‚¹å°±æ˜¯ç¯ä¸Šçš„ä¸€ç«¯ï¼Œè€Œæ­¤æ—¶çš„ä½ç½®å°±æ˜¯å¦ä¸€ç«¯ã€‚è¿˜æ˜¯å¾ˆæ˜¾ç„¶çš„ï¼Œå› ä¸ºä¸ä¼šç»è¿‡è‡ªå·±çš„å„¿å­ï¼Œæ‰€ä»¥è¿™ä¸€å®šæ˜¯ä¸€æ¡é€†å‘çš„è¿”ç¥–è¾¹ã€‚

è¿™ä¸ªæ–¹æ³•éå¸¸é«˜æ•ˆï¼Œä¸éœ€è¦éå†æ•´æ£µæ ‘ï¼Œè€Œä¸”åªéœ€è¦çŸ¥é“ $fat$ ä¿¡æ¯å°±å¯ä»¥äº†ã€‚ä¸è¿‡ä¸€èˆ¬ä¸ä¼šç›´æ¥å‘Šè¯‰ $fat$ ä¿¡æ¯ï¼Œå¯¼è‡´é€‚ç”¨èŒƒå›´å¹¶ä¸æ˜¯éå¸¸å¹¿æ³›ã€‚

![](https://cdn.luogu.com.cn/upload/image_hosting/ot5grv6d.png)

### åŸºç¯æ ‘å¤„ç†æ–¹å¼çš„é€‰æ‹©

æˆ‘ä»¬å¯¹äºåŸºç¯æ ‘çš„å¤„ç†æ— éä¸¤ç§ï¼š

1. åˆ å»ä¸€æ¡è¾¹ï¼Œå½“ä½œæ ‘è¿›è¡Œå¤„ç†ï¼Œç„¶åç‰¹æ®Šç»Ÿè®¡åˆ å»çš„è¾¹å¯¹ç»“æœçš„å½±å“ï¼›
2. åˆ†æˆç¯ä¸Šé—®é¢˜ä»¥åŠæ ‘ä¸Šé—®é¢˜ï¼ˆç¯ä¸ŠèŠ‚ç‚¹çš„å­æ ‘ï¼‰ã€‚

è¿™ä¸ªåœ°æ–¹æ˜¾ç„¶ç”¨ç¬¬äºŒç§æ˜¯ä¸æ–¹ä¾¿çš„ï¼Œè¿™æ ·çŠ¶æ€è½¬ç§»æ–¹ç¨‹è€ƒè™‘çš„éå¸¸å¤šã€‚åŒ…æ‹¬å­æ ‘æ ¹èŠ‚ç‚¹çš„é€‰æˆ–ä¸é€‰ï¼Œç¯ä¸ŠèŠ‚ç‚¹çš„é€‰æˆ–ä¸é€‰ï¼Œä»¥åŠå¤šç§å¤šæ ·çš„ä¾èµ–å…³ç³»ã€‚

ä½¿ç”¨ç¬¬ä¸€ç§æ–¹æ³•å°±å¾ˆç®€å•äº†ï¼Œå› ä¸ºæœ‰â€œå¼ºåˆ¶â€ç­–ç•¥çš„å­˜åœ¨ã€‚

### åŠ¨æ€è§„åˆ’çš„å¼ºåˆ¶ç­–ç•¥

æˆ‘ä»¬åœ¨åŸå¸‚ç¯è·¯ä¸­è®¤è¯†äº†é€šè¿‡èµ‹å€¼ä¸º $-INF$ åšåˆ°åœ¨çŠ¶æ€è½¬ç§»ä¸­å¼ºåˆ¶ä¸é€‰å–ï¼Œè€Œè¿™ä¸ªåœ°æ–¹æ˜¯å¦ä¸€ç§æ–¹æ³•ï¼šä¸¤æ¬¡æ ‘å½¢åŠ¨æ€è§„åˆ’ã€‚åˆ†åˆ«ç»Ÿè®¡ä¾èµ–éåˆ å»è¾¹ä»¥åŠä¾èµ–åˆ å»è¾¹ã€‚

ä»¥ä¸Šå›¾ä¸ºä¾‹ï¼Œæˆ‘ä»¬ä» $9$ å¼€å§‹å‘ä¸Šæ‰¾åˆ°çš„ç¯è¾¹çš„ä¸¤ç«¯åˆ†åˆ«æ˜¯ $4,5$ï¼Œæˆ‘ä»¬ä» $5$ å¼€å§‹è¿›è¡Œæ ‘ä¸ŠåŠ¨æ€è§„åˆ’ã€‚

1. ä¾èµ–éåˆ å»è¾¹ï¼š
   åˆ å»è¾¹ $4 \rightarrow 5$ ä¹‹åï¼ŒèŠ‚ç‚¹ $4$ ä¸èƒ½å¤Ÿä¾èµ–äº $5$ï¼Œç»“æœæ˜¯é€‰å– $4$ çš„æƒ…å†µä¸­ï¼Œå¿…æœ‰ $7,8$ ä¸­çš„ä¸€ä¸ªä¸è¢«é€‰å–ã€‚è€Œè¿™ä¸ªæ—¶å€™ $5$ èŠ‚ç‚¹æ˜¯å¦è¢«é€‰å–éƒ½ä¸é‡è¦ï¼Œç»Ÿè®¡ç­”æ¡ˆ $\max(fTree_{5,1},fTree_{5,0})$ã€‚
2. ä¾èµ–åˆ å»è¾¹ï¼š
   ç°åœ¨ $4$ çš„é€‰å–ä¸€å®šä¾èµ–äº $5$ çš„ä¸é€‰å–ï¼Œç­”æ¡ˆå°±æ˜¯ $fTree_{5,0}$ï¼Œè€Œè¿™ä¸ªæ—¶å€™ $4$ çš„å­èŠ‚ç‚¹å¯ä»¥ä»»é€‰ã€‚

### åˆ å»è¾¹çš„æ–¹å¼

ä»ç„¶ä»¥ä¸Šå›¾ä¸ºä¾‹ï¼šåªè¦ä¸€æ¡è¾¹æŒ‡å‘çš„ $to$ èŠ‚ç‚¹ä¸æ˜¯èµ·ç‚¹ $5$ï¼Œè¯´æ˜è¿™æ¡è¾¹å°±ä¸æ˜¯åˆ å»è¾¹ï¼Œå°±å¯ä»¥æ­£å¸¸å¤„ç†ã€‚

### ä»£ç 

ä¸€ä¸ªå°çš„ç»†èŠ‚æ˜¯ï¼Œ`vector<bool>` æœ‰ç€æå¤§çš„ä¼˜åŒ–ï¼Œå‡ ä¹ç­‰åŒäº `bitset`ï¼Œéå¸¸å¥½ç”¨ã€‚

```cpp
#include<bits/stdc++.h>

inline int read() {
	int x = 0;
	char ch = getchar();
	while (!isdigit(ch))
		ch = getchar();
	while (isdigit(ch))
		x = x * 10 + ch - '0', ch = getchar();
	return x;
}

using namespace std;

const int INF = 0x3f3f3f3f;
const int MAXN = 1000005;

int n, ans;
int lt, rt;

int edgeCount;
int head[MAXN], toNode[MAXN], nextEdge[MAXN];

vector<bool> vis;
int control[MAXN];

int fTree[MAXN][2];

inline void addEdge(int from, int to) {
	edgeCount++;
	toNode[edgeCount] = to;
	nextEdge[edgeCount] = head[from];
	head[from] = edgeCount;
	return;
}

int dpTree(int from, bool isDelete) {
	fTree[from][0] = fTree[from][1] = 0;
	vis[from] = true;
	int gap = INF;
	for (int i = head[from]; i; i = nextEdge[i]) {
		int to = toNode[i];
		if (to ^ lt) {
			vis[to] = true;
			int res = dpTree(to, isDelete);
			fTree[from][0] += res;
			gap = min(gap, res - fTree[to][0]);
		}
	}
	fTree[from][1] = fTree[from][0] + 1 - gap;
	if (!isDelete && from == rt)
		fTree[from][1] += gap;
	return max(fTree[from][0], fTree[from][1]);
}

int main() {
	n = read();
	vis.resize(n + 1, false);
	for (int i = 1; i <= n; ++i)
		addEdge(control[i] = read(), i);
	for (int i = 1; i <= n; ++i)
		if (!vis[i]) {
			for (lt = i; !vis[control[lt]]; vis[lt] = true)
				lt = control[lt];
			rt = control[lt];
			int max1 = dpTree(lt, true);
			dpTree(lt, false);
			int max2 = fTree[lt][0];
			ans += max(max1, max2);
		}
	cout << ans;
	return 0;
}
```

### é—²è¯

æœ¬äººåœ¨æ ¡æµ‹ä¸­ä½¿ç”¨çš„æ–¹æ³•å°±æ˜¯åˆ†æˆç¯å’Œæ ‘ï¼Œç»“æœæ‰“äº† $173$ è¡Œä»£ç ï¼Œåˆšå¥½å¤šäº† $100$ è¡Œï¼Œå¹¶ä¸”ç›´åˆ°æ¯”èµ›ç»“æŸéƒ½æ²¡èƒ½è°ƒè¯•æˆåŠŸã€‚ä½¿ç”¨äº†éª—åˆ†å¤§æ³•ï¼Œè¾“å‡ºæ¯æ£µåŸºç¯æ ‘ç»“ç‚¹ä¸ªæ•°çš„ä¸€åŠï¼Œç«Ÿç„¶å¾—äº† $30$ åˆ†ã€‚

---

## ä½œè€…ï¼šyanmingqian (èµï¼š6)

æœ‰ç‚¹æ„æ€ã€‚å†™ä¸ªèŒæ–°å‘é¢˜è§£ã€‚

åŸºç¯æ ‘ä¸Šçš„é—®é¢˜ï¼Œä¸€èˆ¬æ˜¯æ–­æ‰ç¯ä¸Šçš„è¾¹ï¼Œç„¶åå½“ä½œæ ‘ä¸Šé—®é¢˜åšã€‚é‚£ä¹ˆæˆ‘ä»¬ä¸€æ­¥ä¸€æ­¥æ¥ã€‚

# æ‰¾ç¯

é¦–å…ˆæ˜¯æ‰¾ç¯ã€‚æ‰¾ç¯ä¸€èˆ¬ç”¨ dfs æˆ–è€…æ‹“æ‰‘ï¼Œä½†æ˜¯è¿™é¢˜æ¯”è¾ƒå¥½ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ç¨å¾®ç®€å•ä¸€äº›çš„æ–¹å¼ã€‚

## å…³äºåå‘è¾¹

å»ºè¾¹çš„æ—¶å€™æˆ‘ä»¬è¦å»ºåå‘è¾¹ï¼Œä¹Ÿå°±æ˜¯ $a_i \rightarrow i$ å»ºè¾¹ã€‚è¿™ä¸ªä¸œè¥¿å¯èƒ½ä¹ä¸€çœ‹ä¸å¤ªå¥½ç†è§£ï¼Œä½†æ˜¯æˆ‘ä»¬ä»”ç»†æ€è€ƒä¸€ä¸‹ï¼ˆå¯ä»¥ç”»ä¸ªå›¾ï¼‰ï¼Œå‘ç°é¢˜ç›®ä¸­æ¯ä¸ªå…ƒç´ åªèƒ½é™åˆ¶å¦å¤–**ä¸€ç§**å…ƒç´ ï¼Œä½†æ˜¯æ¯ä¸ªå…ƒç´ å¯ä»¥è¢«å¦å¤–**å¤šç§**å…ƒç´ é™åˆ¶ã€‚é‚£ä¹ˆå¦‚æœå»ºæ­£å‘è¾¹çš„è¯ï¼Œæœ€åå‡ºæ¥çš„å›¾å°±ä¼šæ˜¯å¶å­æŒ‡å‘æ ¹çš„åŸºç¯æ ‘ï¼ˆæ£®æ—ï¼‰ï¼Œæ¯ä¸ªç‚¹åªä¼šå‘å¤–ä¼¸ä¸€æ¡è¾¹ï¼Œä½†æ˜¯å´å¯èƒ½æœ‰å¤šä¸ªè¾¹æŒ‡ç€å®ƒã€‚è¿™ä¸ªä¸å¤ªç¬¦åˆæˆ‘ä»¬ç›´è§‰ï¼Œè€Œä¸”ä¸å¤ªå¥½çœ‹ã€‚ç›¸åï¼Œå»ºåå‘è¾¹çš„è¯ï¼Œé™åˆ¶ä¸€ä¸ªç‚¹çš„å…ƒç´ å°±ä¼šå…¨éƒ¨åœ¨å®ƒçš„å­æ ‘ä¸­ï¼Œè¿™æ · dp çš„æ—¶å€™æ˜¾ç„¶æ˜¯å¥½åšçš„ï¼Œæˆ‘ä»¬æ±‚å®Œä¸€ä¸ªç‚¹çš„å­æ ‘ä¸­æ‰€æœ‰ç‚¹ï¼Œç„¶åæ±‚è¿™ä¸ªç‚¹ï¼Œéå¸¸åˆç†å•Šï¼è€Œä¸”ï¼Œè¿™æ ·åˆ è¾¹çš„æ—¶å€™ç›¸æ¯”åŒå‘è¾¹å°±æ–¹ä¾¿äº†ä¸€äº›ã€‚å› æ­¤ï¼Œè¿™é¢˜è¦å»ºåå‘è¾¹ã€‚

å›åˆ°æ‰¾ç¯ä¸Šæ¥ï¼Œæˆ‘ä»¬å»ºäº†åå‘è¾¹ï¼Œæ€ä¹ˆå¾€å›éå†å‘¢ï¼Ÿå…¶å®ä¹Ÿå¾ˆç®€å•ï¼Œæˆ‘ä»¬ä¼šå‘ç° $a_u$ ä¸­å­˜çš„ä¸å°±æ˜¯ $u$ çš„ç¥–å…ˆå—ï¼æ‰€ä»¥å¾€å›è¿™æ ·éå†å³å¯ã€‚ç„¶åå°±æ¯”è¾ƒå…¸äº†ï¼Œæˆ‘ä»¬ç”¨ä¸€ä¸ª $vis$ æ•°ç»„æ¥è®°å½•ä¸€ä¸ªç‚¹æœ‰æ²¡æœ‰è¢«è®¿é—®è¿‡ï¼Œè¦æ˜¯ä¸€ä¸ªç‚¹ç¬¬äºŒæ¬¡è¢«è®¿é—®åˆ°ï¼Œæ˜¾ç„¶å®ƒå°±æ˜¯ç¯ä¸Šçš„ä¸€ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä»¥è¿™ä¸ªç‚¹ä¸ºæ ¹è¿›è¡Œ dfsã€‚

# åŠ¨æ€è§„åˆ’

ä¸‹é¢æ¥è®²è§£ä¸€ä¸‹åŠ¨æ€è§„åˆ’éƒ¨åˆ†ã€‚è¿™ä¸ªåˆæ˜¯æ¯”è¾ƒç»å…¸çš„æ²¡æœ‰ä¸Šå¸çš„èˆä¼šæ¨¡å‹å•Šï¼Œä½†æ˜¯æœ‰ä¸€ç‚¹å°çš„å˜åŠ¨ã€‚

## çŠ¶æ€è®¾è®¡

ç»å…¸ï¼Œè®¾ $f_{u,0/1}$ è¡¨ç¤ºå½“å‰èŠ‚ç‚¹ $u$ ä¸é€‰/é€‰æ—¶ä»¥ $u$ ä¸ºæ ¹çš„å­æ ‘ï¼ˆå« $u$ æœ¬èº«ï¼‰ä¸­æœ€å¤šèƒ½é€‰çš„ä¸ªæ•°ã€‚

## è½¬ç§»

å½“å‰ç‚¹ $u$ ä¸é€‰çš„æƒ…å†µæ˜¯å®¹æ˜“è€ƒè™‘çš„ã€‚æ—¢ç„¶å½“å‰ç‚¹ä¸é€‰äº†ï¼Œé‚£å®ƒçš„å„¿å­å°±å…¨éƒ½éšä¾¿é€‰äº†å‘—ã€‚å› æ­¤æœ‰ $f_{u,0}=\sum \max(f_{v,0},f_{v,1})$ã€‚

é‚£ä¹ˆå¦‚æœå½“å‰ç‚¹ $u$ é€‰å‘¢ï¼Ÿæ ¹æ®é¢˜æ„ï¼Œå¦‚æœé€‰äº†å½“å‰ç‚¹ $u$ï¼Œé‚£ä¹ˆå®ƒçš„å„¿å­ä¸­è‡³å°‘æœ‰ä¸€ä¸ªç‚¹ä¸èƒ½é€‰ã€‚å¦‚æœ $u$ çš„å„¿å­ä¸­æœ‰ä¸€ä¸ªä¸é€‰ï¼Œé‚£ä¹ˆè¿™ä¸ªç‚¹çš„è´¡çŒ®å°±è¦å‡æ‰ã€‚æˆ‘ä»¬è¦è®©å‡æ‰çš„è¿™éƒ¨åˆ†è´¡çŒ®å°½é‡å°ã€‚åŒæ—¶ï¼Œé€‰äº†å½“å‰ç‚¹ $u$ ä¼šæœ‰ $1$ çš„è´¡çŒ®ï¼Œåˆèµ·æ¥å°±æ˜¯ $f_{u,1}=1+f_{u,0}-\min\{\max(f_{v,0},f_{v,1})-f_{v,0}\}$ã€‚

ç»¼ä¸Šï¼Œè½¬ç§»æ–¹ç¨‹ä¸ºï¼š

$$
\begin{cases}
f_{u,0}=\sum \max(f_{v,0},f_{v,1})\\
f_{u,1}=1+f_{u,0}-\min\{\max(f_{v,0},f_{v,1})-f_{v,0}\}
\end{cases}
$$

å…·ä½“å®ç°çš„æ—¶å€™ï¼Œåˆ†åˆ«è®°å½•ä¸€ä¸‹ $\max(f_{v,0},f_{v,1})$ å’Œ $\max(f_{v,0},f_{v,1})-f_{v,0}$ å°±å¥½äº†ã€‚

# åŸºç¯æ ‘çš„å¤„ç†

åˆ è¾¹æ˜¯ç®€å•çš„ï¼Œåˆ¤æ–­å½“å‰èŠ‚ç‚¹çš„å½“å‰éå†åˆ°çš„å„¿å­èŠ‚ç‚¹ä¸æ˜¯ä¸€å¼€å§‹é”šå®šçš„ç¯ä¸Šçš„æ ¹èŠ‚ç‚¹å°±è¡Œã€‚

ç„¶åè€ƒè™‘åˆ è¾¹ä¹‹åçš„å½±å“ã€‚æ˜¾ç„¶åˆ å»çš„è¿™æ¡è¾¹ä¹Ÿæ˜¯æœ‰é™åˆ¶ä½œç”¨çš„ï¼ˆæ ¹èŠ‚ç‚¹é™åˆ¶è¢«é™åˆ¶ç‚¹ï¼‰ï¼Œé‚£ä¹ˆæˆ‘ä»¬éœ€è¦è€ƒè™‘ä¸Šè¿™ä¸ªé™åˆ¶ã€‚

è€ƒè™‘ä¸¤æ¬¡åŠ¨æ€è§„åˆ’ã€‚

ç¬¬ä¸€æ¬¡çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¼ºåˆ¶è®©æ ¹èŠ‚ç‚¹é€‰ï¼Œé‚£ä¹ˆè¢«é™åˆ¶ç‚¹çš„å…¶ä»–å„¿å­å°±ä¸€å®šè‡³å°‘è¦åˆ å»ä¸€ä¸ªï¼Œæˆ‘ä»¬æ­£å¸¸è¿›è¡ŒåŠ¨æ€è§„åˆ’ï¼Œå– $\max(f_{root,0},f_{root,1})$ å³å¯ï¼›

ç¬¬äºŒæ¬¡çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¼ºåˆ¶è®©æ ¹èŠ‚ç‚¹ä¸é€‰ï¼Œé‚£ä¹ˆè¢«é™åˆ¶ç‚¹çš„å…¶ä»–å„¿å­å°±å¯ä»¥éšä¾¿é€‰äº†ï¼Œè¿™ä¾èµ–äºæ ¹èŠ‚ç‚¹çš„ä¸é€‰ï¼Œæ‰€ä»¥æˆ‘ä»¬å– $f_{root,0}$ã€‚

è€ƒè™‘å®Œè¿™äº›ï¼Œè¿™ä¸ªé¢˜å°±åŸºæœ¬åšå®Œäº†ã€‚æœ€åéœ€è¦æ³¨æ„æ˜¯åŸºç¯æ£®æ—ï¼Œè¦å¤šæ¬¡æ‰¾æ¯ä¸€é¢—åŸºç¯æ ‘è¿›è¡Œè®¡ç®—ã€‚

ä»£ç ï¼š

```cpp
#include<iostream>
using namespace std;
const int N=1e6+10;
int a[N];
int head[N],nxt[N],v[N],idx;
void add(int x,int y){
	v[++idx]=y;
	nxt[idx]=head[x];
	head[x]=idx;
}
bool vis[N];
int f[N][2];  //f[u][0/1]ï¼šuä¸é€‰/é€‰ï¼Œä»¥uä¸ºèŠ‚ç‚¹çš„å­æ ‘æœ€å¤šèƒ½æŠ•æ”¾å‡ ä¸ª
//è½¬ç§»ï¼š
//f[u][0]=sum of max(f[v][0],f[v][1]) (v belongs to u's sons)
//f[u][1]=1+f[u][0]-min{max(f[v][0],f[v][1])-f[v][0]} (v belong to u's sons)
int root;
int dfs(int u,int x){  //xè®°å½•åˆ å»è¾¹æ˜¯å¦ä¸€å®šä¸é€‰ï¼Œ1è¡¨ç¤ºä¸€å®šä¸é€‰
    f[u][0]=f[u][1]=0;
    vis[u]=1;
    int t=0,minn=2e9;  //å­˜å‚¨è½¬ç§»éœ€è¦çš„ä¸­é—´å˜é‡ï¼Œtè®°å½•max(f[v][0],f[v][1])ï¼Œminnè®°å½•(t-f[v][0])
    for(int i=head[u];i;i=nxt[i]){
        int vv=v[i];
        if(vv==root){
            continue;
        }
        t=dfs(vv,x);
        minn=min(minn,t-f[vv][0]);
        f[u][0]+=t;
    }
    f[u][1]=f[u][0]-minn+1;
    if(x&&(u==a[root])){  //å¦‚æœè€ƒè™‘åˆ å»è¾¹ï¼Œå…¶ä»–çš„å„¿å­èŠ‚ç‚¹å¯ä»¥ä»»æ„é€‰ï¼Œå› æ­¤å‰é¢å¤šå‡å»äº†ä¸€éƒ¨åˆ†è´¡çŒ®ï¼Œéœ€è¦åŠ å›æ¥
        f[u][1]+=minn;
    }
    return max(f[u][0],f[u][1]);
}
int get(int x){
    root=x;
    while(!vis[a[root]]){  //æ‰¾ç¯ä¸Šçš„ä¸€ä¸ªç‚¹ï¼Œåˆ è¾¹
        vis[root]=1;
        root=a[root];
    }
    int t=dfs(root,0);  //æ­¤æ—¶ä¸è€ƒè™‘åˆ å»è¾¹çš„é™åˆ¶ï¼Œå½“å‰ç‚¹é™¤äº†åˆ å»è¾¹çš„é™åˆ¶ä¹‹å¤–çš„é™åˆ¶æœ‰ä¸€ä¸ªä¸é€‰ï¼Œå› æ­¤åˆ å»è¾¹çš„å¦ä¸€è¾¹å¯é€‰å¯ä¸é€‰
    dfs(root,1);  //è€ƒè™‘åˆ å»è¾¹ï¼Œåˆ å»è¾¹çš„é™åˆ¶ä¸€å®šä¸é€‰ï¼Œå› æ­¤æœªåˆ å»è¾¹éƒ½å¯é€‰å¯ä¸é€‰
    return max(t,f[root][0]);
}
int main(){
    int n;
    cin>>n;
    for(int i=1;i<=n;i++){
        cin>>a[i];
        add(a[i],i);  //åå‘å»ºè¾¹ï¼Œä½¿å¾—æ¯ä¸ªç‚¹å…¥åº¦ä¸º1ï¼ˆåŸºç¯å¤–å‘æ ‘ï¼‰ï¼Œæ–¹ä¾¿åç»­å¤„ç†
    }
    int ans=0;
    for(int i=1;i<=n;i++){
        if(!vis[i]){  //åŸºç¯æ£®æ—
            ans+=get(i);
        }
    }
    cout<<ans;
    return 0;
}
```

---

## ä½œè€…ï¼šhzoi_Shadow (èµï¼š5)

[é¢˜ç›®ä¼ é€é—¨](https://www.luogu.com.cn/problem/P10933)

# å‰ç½®çŸ¥è¯†

[æ ‘å½¢ DP](https://oi-wiki.org/dp/tree/) 

# è§£æ³•

å°† $a_{i}$ å‘ $i$ è¿ä¸€æ¡æœ‰å‘è¾¹ï¼Œè¿™æ ·å°±å½¢æˆäº†åŸºç¯å¤–å‘æ ‘æ£®æ—ã€‚

è®¾ $f_{x,0/1}$ è¡¨ç¤º $x$ ä¸é€‰/é€‰æ—¶ï¼Œä»¥ $x$ ä¸ºæ ¹çš„å­æ ‘çš„æœ€å¤šé€‰æ‹©ä¸ªæ•°ï¼ŒçŠ¶æ€è½¬ç§»æ–¹ç¨‹ä¸º $\begin{cases} f_{x,0}=\sum\limits_{y \in Son(x)} \max(f_{y,0},f_{y,1}) \\ f_{x,1}=1+\max\limits_{y \in Son(x)} \{ f_{y,0}+\sum\limits_{z \in Son(x),z \ne y} \max(f_{z,0},f_{z,1}) \} \end{cases}$ï¼Œå…¶ä¸­ $f_{x,1}$ çš„è½¬ç§»å¯ä»¥è¿›ä¸€æ­¥å†™ä½œ $f_{x,1}=1+f_{x,0}- \min\limits_{y \in Son(x)} \{ \max(f_{y,0},f_{y,1})-f_{y,0} \}$ã€‚

æœ€åå¤„ç†ä¸‹ç¯å½¢ DP çš„å–æˆ–ä¸å–å³å¯ã€‚

# ä»£ç 

```cpp
#include<bits/stdc++.h>
using namespace std;
#define ll long long 
#define ull unsigned long long
#define sort stable_sort 
#define endl '\n'
struct node
{
    int nxt,to;
}e[2000010];
int head[2000010],vis[2000010],u[2000010],v[2000010],f[2000010][2],rt,cnt=0;
void add(int u,int v)
{
    cnt++;
    e[cnt].nxt=head[u];
    e[cnt].to=v;
    head[u]=cnt;
}
int dfs_huan(int x)
{
    vis[x]=1;
    return (vis[u[x]]==1)?x:dfs_huan(u[x]);
}
void dfs(int x)
{
    int minn=0x3f3f3f3f;
    vis[x]=1;
    f[x][0]=0;
    for(int i=head[x];i!=0;i=e[i].nxt)
    {
        if(e[i].to==rt)
        {
            f[e[i].to][1]=-0x3f3f3f3f;
        }
        else
        {
            dfs(e[i].to);
            f[x][0]+=max(f[e[i].to][0],f[e[i].to][1]);
            minn=min(minn,max(f[e[i].to][0],f[e[i].to][1])-f[e[i].to][0]);
        }
    }
    f[x][1]=1+f[x][0]-minn;
}
int main()
{
    int n,ans=0,maxx,i;
    cin>>n;
    for(i=1;i<=n;i++)
    {
        v[i]=i;
        cin>>u[i];
        add(u[i],v[i]);
    }
    for(i=1;i<=n;i++)
    {
        if(vis[i]==0)
        {
            rt=dfs_huan(i);
            dfs(rt);
            maxx=max(f[rt][0],f[rt][1]);
            rt=u[rt];
            dfs(rt);
            ans+=max(maxx,f[rt][1]);
        }
    }
    cout<<ans<<endl;
    return 0;
}
```

---

## ä½œè€…ï¼šXuZile (èµï¼š3)

# P10933 é¢˜è§£
## å‰è¨€
~~è¯¥é¢˜æˆ‘å€Ÿé‰´äº†æ¥¼ä¸Šå¤§ä½¬çš„æ€è·¯ï¼Œå‹¿å–·ã€‚~~
## è§£é¢˜æ€è·¯
### å»ºè¾¹
è¿™é“é¢˜å¯ä»¥è€ƒè™‘å»å»ºä¸€ä¸ªå¤–å‘åŸºç¯æ ‘æ£®æ—ï¼Œé‚£ä¹ˆå¯ä»¥å°† $a_i$ å‘ $i$ è¿›è¡Œå»ºè¾¹ã€‚æˆ‘è¿™è¾¹æ˜¯ç”¨ç»“æ„ä½“å»è¿›è¡Œå»ºè¾¹ã€‚
```cpp
struct E {
	ll nxt,to;
} e[N<<1];
void add(ll u,ll v) {
	e[++ec]= {hd[u],v};
	hd[u]=ec;
}
for(ll i=1; i<=n; i++)s[i]=read(),add(s[i],i);
```
### æ‰¾ç¯
æˆ‘ä»¬å¯¹äºæ¯ä¸€ä¸ªå¶å­èŠ‚ç‚¹ $a_i$ è¿›è¡Œå‘ä¸Šæ‰¾ç¯ã€‚åˆšå¥½æˆ‘ä»¬å»ºçš„å°±æ˜¯å¤–å‘åŸºç¯æ ‘æ£®æ—ï¼Œæ‰€ä»¥å¯¹äºç‚¹ $v$ æ˜¯æ¯ä¸€ä¸ª $a_v$ã€‚ç”¨ DFS å»ç»´æŠ¤æœç´¢ã€‚
### DP æ–¹ç¨‹
é¦–å…ˆå®šä¹‰ DP æ•°ç»„ $dp_{i,1/0}$ï¼Œè¡¨ç¤ºå¯¹äºç»“ç‚¹ $i$ é€‰ä¸ä¸é€‰æ—¶ï¼Œä»¥ $i$ ä¸ºæ ¹çš„æœ€å¤šæŠ•æ”¾æ•°é‡ã€‚

å½“ä¸é€‰ç»“ç‚¹ $i$ æ—¶æ¯”è¾ƒç®€å•ï¼Œæœ€å¤šæŠ•æ”¾æ•°é‡å°±æ˜¯ä»–çš„æ¯ä¸ªå„¿å­ç»“ç‚¹ä¸­é€‰ä¸ä¸é€‰çš„æœ€å¤§æŠ•æ”¾æ•°é‡ä¹‹å’Œã€‚å³ï¼š
$$dp_{i,0}=\sum_{j=e_i.nxt}^{j!=0}\max(dp_{j,0},dp_{j,1})$$

å½“é€‰ç»“ç‚¹ $i$ æ—¶ï¼Œæœ€å¤šæŠ•æ”¾æ•°é‡ä¸º 1 åŠ ä¸é€‰ç»“ç‚¹ $i$ æ—¶æœ€å¤§çš„æŠ•æ”¾æ•°é‡å‡å»å¯¹äºä»–çš„æ¯ä¸ªå„¿å­ç»“ç‚¹æœ€å°çš„æœ€å¤§çš„ä»–çš„æ¯ä¸ªå„¿å­ç»“ç‚¹é€‰ä¸ä¸é€‰çš„å€¼å‡å»é€‰è¯¥å„¿å­ç»“ç‚¹çš„å€¼ã€‚å³ï¼š
$$dp_{i,1}=1+dp_{i,0}+\sum_{j=e_i.nex}^{j!=0}\min(\max(dp_{j,0},dp_{j,1})-dp_{j,0})$$
### åˆ è¾¹
å¦‚æœç»“ç‚¹çš„å„¿å­èŠ‚ç‚¹ä¸æ˜¯ä¸€å¼€å§‹é”šå®šçš„ç¯ä¸Šçš„æ ¹èŠ‚ç‚¹ï¼Œå°±å¯ä»¥è¿›è¡Œåˆ è¾¹æ“ä½œã€‚

## ä»£ç å®ç°
```cpp
#include<bits/stdc++.h>
using namespace std;
#define ll long long
const int N=1e6+5;

struct E {
	ll nxt,to;
} e[N<<1];
ll n,id,ec,ans;
ll vis[N],s[N],hd[N],dp[N][2];

inline ll read() {
	ll x=0,f=1;
	char c=getchar();
	while(c<'0'||c>'9') {
		if(c=='-')f=-1;
		c=getchar();
	}
	while(c>='0'&&c<='9')x=x*10+c-'0',c=getchar();
	return x*f;
}

void add(ll u,ll v) {
	e[++ec]= {hd[u],v};
	hd[u]=ec;
}

ll dfs(ll u,bool f) {
	dp[u][0]=dp[u][1]=0;
	vis[u]=1;
	ll sum=0,mn=1e9+7;
	for(ll i=hd[u]; i; i=e[i].nxt){
		ll v=e[i].to;
		if(v==id)continue;
		ll t=dfs(v,f);
		mn=min(mn,t-dp[v][0]);
		sum+=t;
	}
	dp[u][0]=sum;
	dp[u][1]=sum-mn+1;
	if(f&&u==s[id])dp[u][1]+=mn;
	return max(dp[u][0],dp[u][1]);
}

void slove() {
	for(ll i=1; i<=n; i++)s[i]=read(),add(s[i],i);
	for(ll i=1; i<=n; i++)if(!vis[i]) {
			id=i;
			while(!vis[s[id]])id=s[id],vis[id]=1;
			ll t1=dfs(id,0);
			dfs(id,1);
			ans+=max(t1,dp[id][0]);
		}
}

int main() {
	n=read();
	slove();
	printf("%lld",ans);
	return 0;
}
```

---

## ä½œè€…ï¼šLEWISAK (èµï¼š3)

### é¢˜ç›®å¤§æ„

ç»™å®šä¸€å¼ å†…å‘åŸºç¯æ ‘ï¼Œæ±‚æœ€å¤šèƒ½é€‰å®šå‡ ä¸ªç‚¹ä½¿å¾—æ¯ä¸ªè¢«é€‰å®šçš„ç‚¹éƒ½æœ‰è‡³å°‘ä¸€æ¡æœªè¢«é€‰å®šçš„ç‚¹æŒ‡å‘å®ƒçš„è¾¹ã€‚

### é¢˜è§£

ç‰¹åˆ«çš„ï¼Œä»¥ä¸‹å¯¹äº $a_i=j$ ç§° $j$ ä¸º $i$ çš„çˆ¶äº²ã€‚

é¢˜è§£éƒ½æ˜¯æ ‘å½¢ dp å•Šï¼Œè€ƒè™‘æ‹“æ‰‘åŠ è´ªå¿ƒï¼Œæ³¨æ„åˆ°å‡ ä¸ªæ€§è´¨ï¼š

1. å¶å­èŠ‚ç‚¹ç»å¯¹ä¸èƒ½è¢«é€‰å®šï¼Œäºæ˜¯å®ƒçš„çˆ¶äº²å°±ä¸€å®šå¯ä»¥è¢«é€‰å®šï¼Œäºæ˜¯å½“æ‹“æ‰‘æ—¶é‡åˆ°äº†å¶å­èŠ‚ç‚¹å°±å°†å®ƒå’Œçˆ¶äº²åˆ æ‰å¹¶æŠŠç­”æ¡ˆåŠ ä¸€ã€‚

2. å¯¹äºä¸€ä¸ªå¤§å°ä¸º $siz$ çš„ç¯ï¼Œç­”æ¡ˆæ˜¾ç„¶ä¸º $\left \lfloor{siz/2 } \right \rfloor$ ï¼ˆéš”ä¸€ä¸ªé€‰ä¸€ä¸ªï¼‰ï¼Œæ‹“æ‰‘åæ‰¾ç¯å³å¯ã€‚

å…³äºæ­£ç¡®æ€§ï¼Œæ³¨æ„åˆ°å°†å¶å­å’Œå…¶çˆ¶äº²åˆ æ‰æœ€å¤šç ´åä¸€ä¸ªè´¡çŒ®ï¼Œä½†ä¸€å®šä¼šäº§ç”Ÿä¸€ä¸ªè´¡çŒ®ã€‚

```cpp
#include<bits/stdc++.h>
using namespace std;
namespace j8{
int n,a[1001000],st[1001000],ru[1001000],tot,ans,vis[1001000];
string main(){
	cin>>n;
	for(int i=1;i<=n;i++){
		cin>>a[i];
		ru[a[i]]++;
	}
	for(int i=1;i<=n;i++){
		if(!ru[i]){
			st[++tot]=i;
		}
	}
	while(tot){
		int x=st[tot],f=a[x];
		tot--;
		if(vis[x]){
			continue;
		}
		vis[x]=1;
		ru[f]--;
		if(!ru[f]){
			st[++tot]=f;
		}
		if(!vis[f]){
			vis[f]=1;
			ans++;
			ru[a[f]]--;
			if(!ru[a[f]]){
				st[++tot]=a[f];
			}
		}
	}
	for(int i=1;i<=n;i++){
		if(vis[i]){
			continue;
		}
		vis[i]=1;
		int cnt=1,x=a[i];
		while(x!=i){
			vis[x]=1;
			x=a[x];
			cnt++;
		}
		ans+=cnt/2;
	}
	cout<<ans<<'\n';
	return "LEWISAK";
}
}
int main(){
	cerr<<j8::main();
	return 0;
}
```

---

## ä½œè€…ï¼šMafuyuQWQ (èµï¼š3)

## é¢˜æ„
>  ç»™å®šä¸€å¼  $ n $ ä¸ªç‚¹ $ n $ æ¡è¾¹çš„æœ‰å‘å›¾ï¼Œè‹¥é€‰äº†å½“å‰èŠ‚ç‚¹ï¼Œé‚£ä¹ˆå½“å‰èŠ‚ç‚¹çš„å„¿å­èŠ‚ç‚¹è‡³å°‘æœ‰ä¸€ä¸ªä¸èƒ½é€‰ã€‚æ±‚æœ€å¤šèƒ½é€‰å¤šå°‘ä¸ªç‚¹ã€‚

## Solution

è§‚å¯Ÿé¢˜é¢åå‘ç°è¿™é“é¢˜ $ n $ ä¸ªç‚¹ $ n $ æ¡è¾¹ï¼Œä¸”æ— æ˜ç¡®è¯´æ˜å›¾è”é€šï¼Œæ‰€ä»¥å›¾å¯èƒ½æ˜¯åŸºç¯æ ‘æ£®æ—  

å…ˆä»ç®€å•å¼€å§‹ï¼Œåªè€ƒè™‘æœ€æ™®é€šçš„æ ‘ï¼Œä¸è€ƒè™‘åŸºç¯

å°†å½“å‰ç‚¹å‘æ§åˆ¶å®ƒçš„ç‚¹è¿ä¸€æ¡è¾¹ï¼Œå‘ç°è¿™é“é¢˜ä¼¼ä¹å¯ä»¥ç”¨æ ‘å½¢ dp è§£å†³

è®¾ $ f[i][j] $ è¡¨ç¤ºç‚¹ $ i $ æ˜¯å¦é€‰æ‹©çš„ç­”æ¡ˆï¼Œäºæ˜¯çŠ¶æ€è½¬ç§»æ–¹ç¨‹ä¹Ÿå°±å‘¼ä¹‹æ¬²å‡º

è®¾å½“å‰èŠ‚ç‚¹ä¸º $ u $ï¼Œ$ u $ çš„çˆ¶èŠ‚ç‚¹ä¸º $ p $ã€‚

åˆ™å¯ä»¥å¾—åˆ°ä¸‹é¢ $ 2 $ ä¸ªçŠ¶æ€è½¬ç§»æ–¹ç¨‹

$ f_{u,0} = max(f_{p,0}, f_{p,1}) $

$ f_{u,1} = max(f_{u,1}, f_{u,0} - max(f_{p,0}, f_{p,1}) + f_{p,0} + 1) $

ä½†æ˜¯ï¼Œæˆ‘ä»¬å‘ç°åŸºç¯æ ‘ä¸èƒ½åš dpï¼Œä¼š TLEã€‚

äºæ˜¯è€ƒè™‘å…ˆæ–­ç¯ï¼Œå†æ–­ $ (u, a_u) $ è¿™æ¡è¾¹ã€‚

é‚£ä¹ˆå°±ä¼šæœ‰ $ 2 $ ç§æƒ…å†µï¼Œéœ€è¦åˆ†ç±»è®¨è®ºï¼š

* é€‰ $ a_u $ï¼Œé‚£ä¹ˆ $ u $ å°±æœ‰é™åˆ¶ï¼Œæ±‚å‡º $ f_{u,1},f_{u,0} $ï¼Œç­”æ¡ˆä¸º $ f_{u,0} $ã€‚
  
* ä¸é€‰ $ a_u $ï¼Œé‚£å¯¹äº $ u $ å°±æ˜¯æ²¡æœ‰é™åˆ¶ï¼Œåªè¦ä»¥ $ u $ ä¸ºæ ¹è¿›è¡Œ dp å³å¯ã€‚



```cpp
#include <bits/stdc++.h>

using namespace std;

const int N = 1e6 + 10, M = 2 * N;

int n;
int rh[N], h[N], e[M], ne[M], idx;
bool st[N], ins[N];
int f1[N][2], f2[N][2];
int res;

void add(int a, int b)
{
    e[idx] = b, ne[idx] = h[a], h[a] = idx ++ ;//åŠ è¾¹
}

void dp(int u, int fa, int f[][2])
{
    for (int i = h[u]; ~i; i = ne[i])
    {
        if (rh[i] == -1) continue;//åè¾¹
        int j = e[i];
        dp(j, fa, f);//dp
        f[u][0] += max(f[j][1], f[j][0]);//dpå¤„ç†f[u][0]
    }

    if (u == fa) f[u][1] = f[u][0] + 1;//ä¸é€‰u
    else
    {
        f[u][1] = -1919810;
        for (int i = h[u]; ~i; i = ne[i])
        {
            if (rh[i] == -1) continue;//é€‰u
            int j = e[i];
            f[u][1] = max(f[u][1], f[u][0] - max(f[j][1], f[j][0]) + f[j][0] + 1);
        }
    }
}

void dfs(int u)
{
    st[u] = ins[u] = true;
    for (int i = h[u]; ~i; i = ne[i])
    {
        int j = e[i];
        if (!st[j]) dfs(j);
        else if (ins[j])//æ‰¾åˆ°ç¯
        {
            rh[i] = -1;//åè¾¹æ‰“æ ‡è®°
            dp(j, -1, f1);//ä»¥jä¸ºæ ¹
            dp(j, u, f2);//é€‰a[u]
            res += max(max(f1[j][0], f1[j][1]), f2[j][0]);//æ›´æ–°ç­”æ¡ˆ
            // cout << res << '\n';
        }
    }

    ins[u] = false;
}

int main()
{
    memset(h, -1, sizeof h);
    cin >> n;
    for (int i = 1; i <= n; i ++ )
    {
        int x;
        cin >> x;
        add(x, i);//åŠ è¾¹
    }

    for (int i = 1; i <= n; i ++ )
        if (!st[i]) dfs(i);

    cout << res << '\n';

    return 0;
}
```

---

## ä½œè€…ï¼šykzzldz (èµï¼š3)

ç”±äºçº¦æŸæ¡ä»¶æ˜¯ç”±ä¸€ä¸ªå…ƒç´ æŒ‡å‘ä¸€ä¸ªå¯ä»¥é™åˆ¶è¿™ä¸ªå…ƒç´ çš„ï¼Œäºæ˜¯ï¼Œæˆ‘ä»¬ä» $A_i$ å‘ $i$ è¿è¾¹ï¼Œæ„æˆä¸€æ£µåŸºç¯æ ‘ã€‚

å…ˆè€ƒè™‘åœ¨æ ‘ä¸Šçš„æƒ…å†µï¼Œè®¾ $f_{u,0/1}$ è¡¨ç¤º $u$ èŠ‚ç‚¹ä¸é€‰/é€‰å­æ ‘å†…çš„ç­”æ¡ˆï¼Œè½¬ç§»æ¯”è¾ƒç®€å•ï¼š

$
f_{u,0}=\sum\max(f_{v,0},f_{v,1})
$

$
f_{u,1}=\max\{f_{v',0}-\max(f_{v',0},f_{v',1})\}+f_{u,0}+1
$

å†è€ƒè™‘åŸé—®é¢˜ï¼ŒåŸºç¯æ ‘çš„ç»å…¸å¥—è·¯ï¼šæ–­ç¯ã€‚æˆ‘ä»¬è€ƒè™‘æ–­æ‰ä¸€æ¡ç¯è¾¹ $(A_i,i)$ï¼Œä»¥ $i$ ä¸ºæ ¹è¿›è¡Œ dpï¼Œåˆ†ä¸¤ç§æƒ…å†µè®¨è®ºï¼š

- é€‰ $A_i$ï¼Œæ­¤æ—¶æˆ‘ä»¬è§„å®šä¸é€‰ $i$ï¼Œç”¨ $f_{i,0}$ è´¡çŒ®ç­”æ¡ˆ

- ä¸é€‰ $A_i$ï¼Œæ­¤æ—¶ $i$ æ— é™åˆ¶ï¼Œç”¨ $\max(f_{i,0},f_{i,1})$ è´¡çŒ®ç­”æ¡ˆ

å¤æ‚åº¦æ˜¯ä¸¥æ ¼çº¿æ€§çš„ã€‚

---

## ä½œè€…ï¼šMirasycle (èµï¼š3)

æ¯ä¸ªè¢«é™åˆ¶çš„å…ƒç´ å‘é™åˆ¶å®ƒçš„å…ƒç´ è¿è¾¹ï¼Œ$n$ ä¸ªç‚¹ï¼Œ$n$ æ¡è¾¹ã€‚è¿å‡ºæ¥çš„æ˜¯ä¸€ä¸ªåŸºç¯æ ‘æ£®æ—ã€‚

é¢˜ç›®ä¹Ÿå°±æ˜¯è¦æ±‚é€‰æœ€å¤šçš„ç‚¹ï¼Œä½¿å¾—è¢«é€‰ç‚¹çš„å„¿å­ä¸èƒ½å…¨é€‰ã€‚

è€ƒè™‘å¦‚æœæ˜¯æ ‘æ€ä¹ˆåšï¼Œæˆ‘ä»¬è®¾ $dp_{u,0/1}$ è¡¨ç¤º $u$ ä¸é€‰/é€‰çš„æœ€å¤§æƒå€¼ã€‚

äºæ˜¯ $dp_{u,0}=\sum\max(dp_{u,0},dp_{u,1})$

$dp_{u,1}=\max\{dp_{y,0}+\sum\limits_{v\neq y}\max(dp_{v,0},dp_{v,1})\}$

å°†è¿™ä¸ªåšæ³•æ‰©å±•åˆ°åŸºç¯æ ‘ã€‚

æˆ‘ä»¬å¯¹äºæ¯é¢—åŸºç¯æ ‘éƒ½ç”¨å¹¶æŸ¥é›†æ‰¾åˆ°ç¯ä¸Šä¸¤ä¸ªç›¸é‚»ç‚¹ã€‚

è¿™é‡Œå¤„ç†ç¯çš„æ–¹å¼æ˜¯æ–­ç¯ä¸ºé“¾ï¼Œä¸¤æ¬¡ dpã€‚

å‡è®¾æˆ‘ä»¬æ‰¾åˆ°çš„ç›¸é‚»è¾¹æ˜¯ $s\to t$ï¼Œæ–­å¼€è¿™æ¡è¾¹ï¼Œç›´æ¥ä» $t$ å¼€å§‹ dpï¼Œç„¶å $ans\gets \max(dp_{t,0},dp_{t,1})$ã€‚ä½†æ˜¯å½“æˆ‘ä»¬ dp åˆ° $s$ çš„æ—¶å€™æ˜¾ç„¶æ˜¯æ²¡æœ‰åˆ©ç”¨åˆ° $s\to t$ çš„æ¡ä»¶çš„ï¼Œä¸ºäº†åˆ©ç”¨è¯¥æ¡ä»¶ï¼Œæ‰€ä»¥ç¬¬äºŒæ¬¡ dp çš„æ—¶å€™æˆ‘ä»¬å¼ºåˆ¶ä¸é€‰ $t$ï¼Œç„¶å $s$ éšä¾¿é€‰ï¼Œè¿™æ ·å­ç¬¬äºŒæ¬¡ dp å®Œä¹‹åï¼Œ$ans\gets dp_{t,0}$ã€‚

æ—¶é—´å¤æ‚åº¦ $O(n\log n)$ï¼Œå¦‚æœç”¨æŒ‰ç§©åˆå¹¶çš„å¹¶æŸ¥é›†ï¼Œå¯ä»¥åšåˆ°çº¿æ€§ã€‚

```cpp
#include<bits/stdc++.h>
#define pb emplace_back
using namespace std;
const int maxn=1e6+10;
const int inf=0x3f3f3f3f;
int dp[maxn][2],n,k;
int s[maxn][2],ans,m;
vector<int> G[maxn];
struct DSU{
	int fa[maxn];
	void init(){ for(int i=1;i<=n;i++) fa[i]=i; }
	int find(int x){ return x==fa[x]?x:fa[x]=find(fa[x]); }
	void merge(int u,int v){
		int f1=find(u),f2=find(v);
		if(f1==f2) s[++m][0]=v,s[m][1]=u;
		else{ G[v].pb(u); fa[f1]=f2; }
	}
}dsu;
void Dp(int u){
	int val=inf; dp[u][0]=0;
	for(auto v:G[u]){
		Dp(v);
		dp[u][0]+=max(dp[v][0],dp[v][1]);
		val=min(val,max(dp[v][0],dp[v][1])-dp[v][0]);
	}
	if(u!=k) dp[u][1]=dp[u][0]+1-val;
	else dp[u][1]=dp[u][0]+1;
}
int main(){
	ios::sync_with_stdio(false); cin.tie(0); cout.tie(0);
	cin>>n; dsu.init(); m=0;
	for(int i=1;i<=n;i++){ int v; cin>>v; dsu.merge(i,v); }
	for(int i=1;i<=m;i++){
		Dp(s[i][1]); int res=max(dp[s[i][1]][0],dp[s[i][1]][1]);
		k=s[i][0]; Dp(s[i][1]); res=max(res,dp[s[i][1]][0]);
		ans+=res;
	}
	cout<<ans;
	return 0;
}
```

---

## ä½œè€…ï¼šxf20280111 (èµï¼š2)

## é¢˜æ„
å¯ä»¥æŠ½è±¡æˆä¸€ä¸ªå›¾è®ºé—®é¢˜ã€‚

ç»™ä½  $n$ ä¸ªç‚¹çš„æœ‰å‘å›¾ï¼Œæ¯ä¸ªç‚¹æ°å¥½æœ‰ä¸€ä¸ªå‡ºè¾¹ï¼ˆå¯èƒ½æœ‰è‡ªç¯ï¼‰ï¼Œé€‰å‡ºå°½å¯èƒ½å¤šçš„ç‚¹ï¼Œä½¿å¾—æ¯ä¸ªè¢«é€‰å‡ºçš„ç‚¹ $x$ï¼Œéƒ½è‡³å°‘æœ‰ä¸€ä¸ªæŒ‡å‘ $x$ çš„ç‚¹æ²¡è¢«é€‰ã€‚
## æ€è·¯
å¯ä»¥æƒ³åˆ° DPã€‚

è¿™æ˜¯ä¸€æ£µæ ‘å—ï¼Ÿæ˜¾ç„¶ä¸æ˜¯ï¼Œå› ä¸ºè¾¹æ•°ç­‰äºç‚¹æ•°ï¼Œé‚£å°±æ˜¯ä¸€æ£µåŸºç¯æ ‘äº†ï¼ï¼ï¼

åŸºç¯æ ‘ DP çš„ä¸€èˆ¬æ€è·¯å°±æ˜¯å…ˆæ–­æ‰ä¸€æ¡è¾¹ï¼Œä½¿å…¶å˜æˆä¸€ä¸ªæ™®é€šçš„æ ‘å½¢ DP è¿›è¡Œæ±‚è§£ï¼Œæœ€åè€ƒè™‘ä¸Šåˆ è¾¹çš„å½±å“ã€‚

é‚£æˆ‘ä»¬å°±å…ˆè€ƒè™‘è¿™ä¸ªæ ‘ä¸Šçš„ DPã€‚

### æ ‘ä¸Š DP
å’Œæ²¡æœ‰ä¸Šå¸çš„èˆä¼šå¾ˆåƒã€‚
#### çŠ¶æ€
è®¾ $dp_{u,0/1}$ è¡¨ç¤ºä»¥ $u$ ä¸ºæ ¹çš„å­æ ‘ï¼Œå¹¶ä¸”é€‰æˆ–ä¸é€‰ $u$ æœ€å¤šèƒ½é€‰æ‹©çš„ç‚¹æ•°ã€‚

ç®—æ˜¯ä¸€ä¸ªç»å…¸æ¨¡å‹äº†ï¼Œä¸€èˆ¬éƒ½ä¼šè¿™ä¹ˆè®¾ã€‚

#### è½¬ç§»æ–¹ç¨‹
å¦‚æœ $u = 0$ï¼Œé‚£ä¹ˆä»–çš„å„¿å­éƒ½å¯ä»¥é€‰ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ä¸é€‰ã€‚æ‰€ä»¥æ±‚æœ€å¤§å€¼ã€‚è½¬ç§»æ–¹ç¨‹å°±æ˜¯ $dp_{u,0}=\sum{\max(dp_{v,0},dp_{v,1})}$ã€‚

å¦‚æœ $u = 1$ï¼Œé‚£ä¹ˆä»–è‡³å°‘è¦æœ‰ä¸€ä¸ªå„¿å­ä¸é€‰ï¼Œä¸é€‰çš„å„¿å­è‚¯å®šæ˜¯å€¼æœ€å°çš„ï¼Œè¿™æ · $dp_{u,1}$ æ‰ä¼šå¤§ã€‚å³ $dp_{u,1} = 1 + dp_{u}{0} - \min(dp_{v,1} - dp_{v,0})$ã€‚

#### è¾¹ç•Œæ¡ä»¶

å› ä¸ºè¦æ±‚å’Œï¼Œæ‰€ä»¥å…¨èµ‹å€¼ä¸º $0$ï¼Œå³ $dp_{u,0/1} = 0$ã€‚

### åˆ è¾¹
ç”¨ä¸¤æ¬¡ DP æ¥è§£å†³ã€‚

è€ƒè™‘ $u$ é€‰ä¸é€‰ï¼Œä¸€æ¬¡è®¾ $u$ è¦é€‰ï¼Œä¸€æ¬¡è®¾ $u$ ä¸é€‰ã€‚

æœ€åç­”æ¡ˆå–æœ€å¤§å€¼å°±è¡Œäº†ã€‚

## ä»£ç 
ç»†èŠ‚éƒ½åœ¨æ³¨é‡Šé‡Œã€‚

```cpp
#include<bits/stdc++.h>

using namespace std;

using ll = long long;

const int N = 1e6 + 10;
const int INF = 0x3f3f3f3f;

int n,a[N];

vector<int> e[N];

int dfn[N],dp[N][2];

int vis[N];
void dfs(int u,int root,bool flag){
	dfn[u] = true;
	int mi = INF;
	for (auto v :e[u]){
		if (v == root) continue;//é˜²æ­¢æ­»å¾ªç¯
		dfs(v,root,flag);
		dp[u][0] += max(dp[v][1],dp[v][0]);
		mi = min(dp[v][1] - dp[v][0],mi);//ç»´æŠ¤æœ€å°å€¼
	}
	dp[u][1] = 1 + dp[u][0];
	if (u != a[root] or !flag){	
		if (mi >= 0) dp[u][1] -= mi;
	}
}
int main()
{
	int n;cin >> n;
	for (int i = 1;i <= n;i++){
		cin >> a[i];
		e[a[i]].push_back(i);//è¿˜è¦åœ¨æ ‘çš„å†…éƒ¨ DPï¼Œæ‰€ä»¥å»ºåå›¾
	}
	int sum = 0;
	for (int x = 1;x <= n;x++){//åŸºç¯æ£®æ—
		if (!dfn[x]){
			while(!vis[x]){
				vis[x] = true;
				x = a[x];
			}//æ±‚ç¯
			dfs(x,x,1);
			int ans = dp[x][0];
			dfs(x,x,0);
			sum += max(dp[x][1],ans);
		}

	}
	cout << sum;
	return 0;	
} 
```

---

## ä½œè€…ï¼šGon_Tata (èµï¼š2)

# P10933 åˆ›ä¸–çºª  é¢˜è§£

**[é¢˜ç›®ä¼ é€é—¨](https://www.luogu.com.cn/problem/P10933)**

æ­¤é¢˜å’Œ [[ZJOI2008] éª‘å£«](https://www.luogu.com.cn/problem/P2607) æœ‰ç‚¹åƒï¼Œè€ƒè™‘åŸºç¯æ ‘ä¸Šè·‘ DPã€‚

ä¸ºäº†ç†è§£æ–¹ä¾¿ï¼Œæˆ‘ä»¬å¯¹åŸå›¾å»ºåå›¾ã€‚å³å¯¹äºä¸€æ¡ç”± $u$ æŒ‡å‘ $v$ çš„è¾¹ï¼Œå…¶è¡¨ç¤º $v$ å¯ä»¥é™åˆ¶ $u$ï¼Œæ­¤æ—¶é¢˜é¢å¯ç†è§£ä¸ºâ€œè¦æ±‚æ»¡è¶³å›¾ä¸Šæ¯ä¸ªèŠ‚ç‚¹è‡³å°‘æœ‰ä¸€ä¸ªå­èŠ‚ç‚¹ä¸è¢«å–ç”¨ï¼Œæ±‚æœ€å¤šå¯å–ç”¨çš„èŠ‚ç‚¹çš„æ•°é‡â€œã€‚

é¦–å…ˆè€ƒè™‘æ ‘ä¸Š DPï¼Œå®šä¹‰ $dp_{0,x}$ è¡¨ç¤ºæ ‘ä¸Šä¸å–ç”¨ï¼ˆä¸æŠ•æ”¾ï¼‰ç‚¹ $x$ æ—¶ï¼Œä»¥ $x$ ä¸ºæ ¹çš„å­æ ‘ä¸­æœ€å¤šå¯æŠ•æ”¾çš„å…ƒç´ ä¸ªæ•°ã€‚ä¸æ­¤ç±»ä¼¼ï¼Œ$dp_{1,x}$ è¡¨ç¤ºå–ç”¨ï¼ˆæŠ•æ”¾ï¼‰ç‚¹ $x$ çš„æƒ…å†µã€‚

å†é€šè¿‡æ ‘ä¸Š DP å°†ä¿¡æ¯å‘æ ¹ä¼ é€’ï¼Œæœ€å $\max(dp_{0,root},dp_{1,root})$ å³ä¸ºæ•´æ£µæ ‘ä¸Šçš„ç­”æ¡ˆã€‚

å¯¹äº $dp_{1,x}$ çš„è½¬ç§»ï¼Œå¯ä»¥åœ¨å…¶å­æ ‘ä¸­é€‰å®šä¸€ç‚¹ $p$ï¼Œå¼ºåˆ¶å…¶ä¸è¢«é€‰å–ã€‚å…¶ç›¸è¾ƒ $dp_{0,x}$ æ— é™åˆ¶çš„é€‰å–ä½œå‡ºçš„è´Ÿè´¡çŒ®ä¸º $\max(dp_{0,p},dp_{1,p})-dp_{0,p}$ï¼Œç”±æ­¤å¯æ¨å‡ºè½¬ç§»æ–¹ç¨‹

$$
\ dp_{0,x}=\sum\limits_{p\in son(x)} \max(dp_{0,p},dp_{1,p}) \\[2ex]
dp_{1,x}=1+dp_{0,x}-\min\limits_{p\in son(x)} \{ \max(dp_{0,p},dp_{1,p})-dp_{0,p} \}
$$

æˆ‘ä»¬å†è€ƒè™‘å¦‚ä½•å¤„ç†å›¾ä¸Šçš„ç¯ã€‚æ³¨æ„åˆ°å¯ä»¥é€‰å–ç¯ä¸Šç›¸é‚»ä¸¤ç‚¹ï¼Œå¹¶åˆ†åˆ«ä»¥å…¶ä¸ºæ ¹è·‘æ ‘ä¸Š DPï¼Œå½“è®¿é—®åˆ°è‡ªå·±æ—¶ä»¤å…¶ $dp_{1,root}$ ä¸ºæå°å€¼ï¼Œæœ€åä»ä¸¤æ ¹ä¸­ç»Ÿè®¡ç­”æ¡ˆã€‚

å…³äºç¯ä¸Šç›¸é‚»ä¸¤ç‚¹çš„å¯»æ‰¾ï¼Œå¯ä»¥ä½¿ç”¨å¹¶æŸ¥é›†ã€‚åœ¨å»ºè¾¹è¿‡ç¨‹ä¸­ï¼Œå¦‚æœåœ¨è¿è¾¹å‰ä¸¤ç‚¹å·²ç»è”é€šï¼ŒåŠ ä¸Šæ­¤è¾¹åå…¶ä¸€å®šä¸ºç¯ä¸Šç›¸é‚»ä¸¤ç‚¹ã€‚


**Talk is cheap. Show me the code.**
```cpp
#include<bits/stdc++.h>
using namespace std;
#define int long long
const int inf=1e6+10;
int n,fa[inf],dp[2][inf],ans,root;
int find(int x){return fa[x]==x?x:fa[x]=find(fa[x]);}
vector<int>w[inf];
vector<pair<int,int>> ring;
void dfs(int x){
	int minn=LONG_LONG_MAX;
	dp[0][x]=0;
	for(auto p:w[x]){
		if(p==root){
			dp[1][p]=LONG_LONG_MIN;
			continue;
		}
		dfs(p);
		dp[0][x]+=max(dp[1][p],dp[0][p]);
		minn=min(minn,max(dp[0][p],dp[1][p])-dp[0][p]);
	}
	dp[1][x]=1+dp[0][x]-minn;
}
signed main(){
	// freopen("a.in","r",stdin);
	ios::sync_with_stdio(0);
	cin.tie(0);
	cin>>n;
	for(int i=1;i<=n;i++) fa[i]=i;
	for(int i=1,a;i<=n;i++){
		cin>>a;
		w[a].push_back(i);
		int fu=find(i),fv=find(a);
		if(fu==fv) ring.push_back(make_pair(i,a));
		else fa[i]=a;
	}
	for(auto p:ring){
		root=p.first;
		dfs(root);
		int kep=max(dp[0][root],dp[1][root]);
		root=p.second;
		dfs(root);
		ans+=max(kep,dp[1][root]);
	}
	cout<<ans<<'\n';
}
```

---

## ä½œè€…ï¼šDYYqwq (èµï¼š2)

æ˜¾ç„¶å»ºè¾¹ï¼Œå½¢æˆå†…å‘åŸºç¯æ£®æ—ã€‚è¿™æ ·è¿ç¯çš„é™åˆ¶å…³ç³»è®©æˆ‘ä»¬æƒ³åˆ°æ‹“æ‰‘æ’åºã€‚

è€Œä¸”æˆ‘ä»¬æ³¨æ„åˆ°ä¸€ä¸ªæ€§è´¨ï¼šåªè¦ä½ èƒ½é€‰ï¼Œè¶Šæ—©é€‰è¶Šä¼˜ã€‚è¿™ç‚¹å¯ä»¥æ„Ÿæ€§ç†è§£ï¼Œæˆ‘ä»¬ä¸€å®šä¸ä¼šç©ºè¿‡å»ä¸€ä¸ªä¸é€‰ï¼Œè€Œéè¦é€‰ç¬¬äºŒä¸ªï¼Œè¿™æ ·å°±ä¼šç™½ç™½æµªè´¹ä¸€ä¸ªä½ç½®ã€‚

æ‹“æ‰‘æ’åºå†…éƒ¨ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ª `bool` ç±»å‹çš„æ•°ç»„ï¼Œè®°å½•è¯¥ç‰©å“æ˜¯å¦è¢«é€‰èµ°ã€‚æ‹“æ‰‘æ’åºåŒæ—¶éœ€è¦ä¸€ä¸ªé˜Ÿåˆ—ï¼Œä»£è¡¨è€ƒè™‘è¯¥ç‚¹ã€‚æ¯æ¬¡è€ƒå¯Ÿé˜Ÿé¦–ï¼Œå¦‚è‹¥å…¶è¢«é€‰èµ°ï¼Œåˆ™å…¶åç»§æ— æ³•å‚ä¸ï¼›åä¹‹ï¼Œå…¶åç»§æœ‰æœºå¯ä¹˜ï¼Œç´¯åŠ ç­”æ¡ˆï¼Œè®¾ç½®çŠ¶æ€ï¼Œå¹¶åŠ å…¥é˜Ÿåˆ—ã€‚

ä½†æ˜¯æ³¨æ„åˆ°ï¼Œå¯èƒ½å›¾ä¸­å­˜åœ¨å­¤ç¯ã€‚è€ƒè™‘å¯¹ä¸€ä¸ªå­¤ç¯å¦‚ä½•é€‰æ‹©ã€‚ç”»å›¾åˆ†æå‘ç°ï¼Œè¿™ä¸ç¯é•¿åº¦çš„å¥‡å¶æ€§ç›¸å…³ã€‚

![](https://cdn.luogu.com.cn/upload/image_hosting/jdygz1w4.png)

å¥‡ç¯çŠ¶æ€ä¸‹ï¼Œè´¯å½»æˆ‘ä»¬éš”ä¸€ä¸ªé€‰ä¸€ä¸ªçš„æˆ˜ç•¥ï¼Œ$1,3$ å·ç‚¹ä¸€å®šèƒ½é€‰ã€‚è€ƒå¯Ÿ $5$ å·ç‚¹ï¼Œå‘ç°æ— æ³•é€‰æ‹©ï¼Œå› ä¸ºéœ€è¦ä¿è¯å®ƒçš„å­˜åœ¨ä»¥ç¡®ä¿ $1$ å·ç‚¹å¯ä»¥å‚ä¸å»ºè®¾ä¸–ç•Œã€‚

å› æ­¤å¥‡ç¯ä¸Šé€‰çš„ç‰©ä½“æ•°é‡æ˜¯ $\frac{n-1}{2}$ã€‚

![](https://cdn.luogu.com.cn/upload/image_hosting/1vup13ih.png)

è€Œå¶ç¯æ— éœ€è€ƒè™‘è¿™ä¹ˆå¤šã€‚è´¯å½»æˆ˜ç•¥ï¼Œé€‰ $1,3,5$ï¼Œä¸å—ç‰µæŒ‚ï¼Œå®Œç¾é€šå…³ã€‚

å› æ­¤å¶ç¯ä¸Šé€‰çš„ç‰©ä½“æ•°é‡æ˜¯ $\frac{n}{2}$ã€‚

ä¸¤è€…ç»¼åˆä¸€ä¸‹å…¶å®å°±æ˜¯ $\lfloor \frac{n}{2} \rfloor$ã€‚

äºæ˜¯åœ¨æ‹“æ‰‘æ’åºåï¼Œåˆ¤ä¸€åˆ¤ç¯ï¼ŒæŠŠç­”æ¡ˆç´¯åŠ èµ·æ¥å³å¯ã€‚

æ‹“æ‰‘æ’åºæ—¶é—´å¤æ‚åº¦ä¸ç”¨åˆ†æäº†å§ï¼Œ$O(n)$ çº§åˆ«ã€‚

```cpp
#include<bits/stdc++.h>
using namespace std;
int n , a[1000010] , in[1000010] , ans;
bool flag[1000010] , vis[1000010];
void input()
{
	scanf("%d" , &n);
	for(int i = 1 ; i <= n ; i ++) scanf("%d" , &a[i]) , in[a[i]] ++;
}
void topo_sort()
{
	queue<int> q;
	for(int i = 1 ; i <= n ; i ++) if(in[i] == 0) q.push(i);
	while(!q.empty())
	{
		int u = q.front(); q.pop();
		vis[u] = true;
		if(flag[u] == true)
		{
			in[a[u]] --;
			if(in[a[u]] == 0) q.push(a[u]);
		}
		else
		{
			if(flag[a[u]] == false)
			{
				ans ++ , flag[a[u]] = true;
				q.push(a[u]);
			}
		}
	}
}
void check_rings()
{
	for(int i = 1 ; i <= n ; i ++)
	{
		if(vis[i] == false && in[i] != 0)
		{
			int len = 0 , now = i;
			while(vis[now] == false)
			{
				len ++;
				vis[now] = true;
				now = a[now];
			}
			ans += len / 2;
		}
	}
}
void output() {printf("%d" , ans);}
int main()
{
	input();
	topo_sort();
	check_rings();
	output();
	return 0;
}
```

---

## ä½œè€…ï¼šwayneoi (èµï¼š2)

# P10933 åˆ›ä¸–çºª - é¢˜è§£

å‰ç½®èŠå£«ï¼š [åŸºç¯æ ‘](https://www.cnblogs.com/Dfkuaid-210/p/14696378.html)ã€‚

ä¸Šå¸æœ‰ $N$ ç§ä¸–ç•Œå…ƒç´ ï¼Œæ¯ç§å…ƒç´  $i$ å¯ä»¥é™åˆ¶å¦ä¸€ç§å…ƒç´  $A[i]$ ã€‚ç°åœ¨è¦é€‰æ‹©ä¸€éƒ¨åˆ†å…ƒç´ æŠ•æ”¾åˆ°æ–°ç©ºé—´ï¼Œè¦æ±‚æ¯ä¸ªè¢«æŠ•æ”¾çš„å…ƒç´ è‡³å°‘æœ‰ä¸€ä¸ªèƒ½é™åˆ¶å®ƒçš„å…ƒç´ æœªè¢«æŠ•æ”¾ã€‚æ±‚æœ€å¤šèƒ½æŠ•æ”¾å¤šå°‘å…ƒç´ ã€‚

å¯ä»¥è½¬åŒ–ä¸ºå›¾è®ºä¸­çš„åŸºç¯æ ‘é—®é¢˜ï¼Œå…ƒç´  $i$ å‘ $A[i]$ è¿ä¸€æ¡æœ‰å‘è¾¹ï¼Œè¿™æ ·å°±å½¢æˆäº†ä¸€ä¸ªç”±è‹¥å¹²åŸºç¯æ ‘ç»„æˆçš„å›¾ã€‚

1. å¯¹äºæ ‘çš„éƒ¨åˆ†ï¼Œå¯ä»¥ç”¨æ‹“æ‰‘æ’åºå¤„ç†ã€‚ä»å…¥åº¦ä¸º 0 çš„å¶å­èŠ‚ç‚¹å¼€å§‹ï¼Œè¿™äº›èŠ‚ç‚¹å¿…é¡»è¢«é€‰æ‹©ï¼ˆæŠ•æ”¾ï¼‰ï¼Œå› ä¸ºå®ƒä»¬ä¸èƒ½è¢«å…¶ä»–èŠ‚ç‚¹é™åˆ¶ã€‚ç„¶åå®ƒä»¬çš„çˆ¶èŠ‚ç‚¹å°±ä¸èƒ½è¢«é€‰æ‹©ï¼Œä¾æ­¤ç±»æ¨ã€‚

2. å¯¹äºç¯ä¸­çš„èŠ‚ç‚¹ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½éœ€è¦è¢«å¦ä¸€ä¸ªèŠ‚ç‚¹é™åˆ¶ã€‚æœ€ä¼˜è§£æ˜¯å°†ç¯ä¸­çš„èŠ‚ç‚¹äº¤æ›¿é€‰æ‹©ï¼Œè¿™æ ·å¯¹äºä¸€ä¸ªé•¿åº¦ä¸º $k$ çš„ç¯ï¼Œæœ€å¤šå¯ä»¥é€‰æ‹© $\lfloor k/2 \rfloor$ ä¸ªèŠ‚ç‚¹ã€‚

é¦–å…ˆå¤„ç†æ‰€æœ‰å…¥åº¦ä¸º 0 çš„èŠ‚ç‚¹ï¼Œè¿™äº›èŠ‚ç‚¹å¿…é¡»è¢«é€‰æ‹©ã€‚ç„¶åå®ƒä»¬é™åˆ¶çš„èŠ‚ç‚¹å°±ä¸èƒ½è¢«é€‰æ‹©ï¼Œæ›´æ–°ç›¸å…³èŠ‚ç‚¹çš„å…¥åº¦ã€‚å‰©ä¸‹çš„æœªè¢«è®¿é—®çš„èŠ‚ç‚¹éƒ½ä½äºç¯ä¸­ã€‚å¯¹äºæ¯ä¸ªç¯ï¼Œè®¡ç®—å…¶é•¿åº¦ $k$ ï¼Œå¯ä»¥æœ€å¤šé€‰æ‹© $\lfloor k/2 \rfloor$ ä¸ªèŠ‚ç‚¹ã€‚

- æ—¶é—´å¤æ‚åº¦ï¼š $O(N)$ ã€‚

#### ä»£ç ä¸é‡è¦ï¼Œé‡è¦çš„æ˜¯æ€è·¯ã€‚

```cpp
#include <bits/stdc++.h>
using namespace std;
const int N = 1e6 + 5;
int n, ans, out, a[N], to[N], cnt, in[N], vis[N], x[N];
inline void toposort(){
    queue<int> q;
    for(int i = 1; i <= n; i++) if(in[i] == 0) q.push(i); //å°†æ‰€æœ‰å…¥åº¦ä¸º0çš„èŠ‚ç‚¹åŠ å…¥é˜Ÿåˆ—
    while(!q.empty()){
        int u = q.front();
        q.pop();
        vis[u] = 1;
        // å¦‚æœå½“å‰èŠ‚ç‚¹æœªè¢«é€‰æ‹©ï¼Œåˆ™é€‰æ‹©å®ƒé™åˆ¶çš„èŠ‚ç‚¹ï¼Œå¹¶æ›´æ–°ç›¸å…³èŠ‚ç‚¹çš„å…¥åº¦ã€‚
        if(x[u] == 1){
            in[to[u]]--;
            if(in[to[u]] == 0) q.push(to[u]); 
        } else {
            if(!x[to[u]]) q.push(to[u]), out++;
            x[to[u]] = 1;
        }
    }
    ans += out;
    for(int i = 1; i <= n; i++){
        cnt = 0;
        if(vis[i] == 0 && in[i] > 0){
            for(int k = i ; vis[k] == 0; k = to[k]) cnt++, vis[k] = 1;
            ans += cnt / 2;
        }
    }
}
int main() {
    cin >> n;
    for(int i = 1; i <= n; i++){
        cin >> a[i];
        to[i] = a[i], in[a[i]]++;
    }
    toposort();
    cout << ans << "\n";
    return 0;
}
```
ç®¡ç†å¤§å¤§æ±‚è¿‡ ğŸ™ğŸ™ã€‚

---

## ä½œè€…ï¼šchentianmiao (èµï¼š1)

## æ€è·¯åˆ†æ
æœ¬é¢˜æ˜¯ä¸€ä¸ªç»å…¸çš„**å†…å‘åŸºç¯æ ‘æœ€å°æ”¯é…é›†**é—®é¢˜ã€‚

åŸºç¯æ ‘ä¸Šçš„é—®é¢˜ï¼Œä¸€èˆ¬éƒ½æ˜¯æ–­å¼€ç¯ä¸Šçš„è¾¹å˜æˆæ ‘å½¢é—®é¢˜ï¼Œæ¯ä¸ªèŠ‚ç‚¹å¯èƒ½è¢«é€‰å…¥æ”¯é…é›†æˆ–è€…ä¸é€‰å…¥æ”¯é…é›†ã€‚

æ¥ä¸‹æ¥ï¼š
- $f[u][0]$ è¡¨ç¤ºä¸é€‰ $u$ æ—¶ $u$ ä¸ºæ ¹çš„å­æ ‘æœ€ä¼˜è§£ï¼›
- $f[u][1]$ è¡¨ç¤ºé€‰ä¸­ $u$ æ—¶ $u$ ä¸ºæ ¹çš„å­æ ‘æœ€ä¼˜è§£ã€‚

è®¡ç®— $f[u][1]$ æ—¶ï¼Œ$u$ çš„å­èŠ‚ç‚¹å¯ä»¥éšæ„é€‰æ‹©ï¼›
è®¡ç®— $f[u][0]$ æ—¶ï¼Œ$u$ çš„å„¿å­ä¸­å¿…é¡»è‡³å°‘é€‰ä¸€ä¸ªã€‚

åˆ°è¿™é‡Œä¼¼ä¹å·²ç»åšå®Œäº†ï¼Œä½†è¿˜é—æ¼ä¸€ç§æƒ…å†µï¼Œå¼ºåˆ¶æ–­å¼€çš„è¾¹ $(u,p[u])$ å‘æŒ¥ä½œç”¨ã€‚å¿…é¡»é€‰ä¸­ $u$ å·èŠ‚ç‚¹ï¼Œåœ¨è®¡ç®— $f[p[u]][0]$ æ—¶ $p[u]$ çš„å­èŠ‚ç‚¹å¯ä»¥éšæ„é€‰æ‹©ã€‚

## ä»£ç 
```cpp
#include<bits/stdc++.h>
using namespace std;
const int N=1000009,INF=1e9;
struct Edge{
	int to,nxt;
}e[N*2];
int hd[N],nE=1;
int n,p[N];
int rt;
int f[N][2];
int nPick;
int iPart,tag[N];
void add(int u,int v){
	e[++nE]=(Edge){v,hd[u]};
	hd[u]=nE;
}
void dfs_DP(int u,int St){
	f[u][0]=0;
	f[u][1]=1;
	if(!hd[u]){
		f[u][0]=INF;
	}
	int dlt=INF;
	for(int i=hd[u];i;i=e[i].nxt){
		int v=e[i].to;
		if(v==rt){
			continue;
		}
		dfs_DP(v,St);
		int minFv=min(f[v][0],f[v][1]);
		f[u][1]+=minFv;
		f[u][0]+=minFv;
		dlt=min(dlt,f[v][1]-minFv);
	}
	if(St&&u==p[rt]){
		if(f[u][0]==INF){
			f[u][0]=0;
		}
		return;
	}
	if(f[u][0]==INF){
		return;
	}
	f[u][0]+=dlt;
}
void solve(){
	dfs_DP(rt,0);
	int minPick=f[rt][0];
	dfs_DP(rt,1);
	minPick=min(minPick,f[rt][1]);
	nPick+=minPick;
}
int main(){
	cin>>n;
	for(int u=1;u<=n;u++){
		cin>>p[u];
		add(p[u],u);
	}
	for(int u=1;u<=n;u++){
		if(tag[u]){
			continue;
		}
		int x=u;
		iPart++;
		do{
			tag[x]=iPart;
			x=p[x];
		}while(!tag[x]);
		if(tag[x]!=tag[u]){
			continue;
		}
		rt=x;
		solve();
	}
	cout<<n-nPick;
	return 0;
}
```

---

## ä½œè€…ï¼šI_LOVE_MATH (èµï¼š1)

### P10933 åˆ›ä¸–çºª [link](https://www.luogu.com.cn/problem/P10933)

[åˆé›†ï¼šæµ…è°ˆåŸºç¯æ ‘](https://www.luogu.com.cn/article/qrtj98oz)

#### é¢˜ç›®å¤§æ„

ç»™å‡ºä¸€ä¸ªæœ‰å‘åŸºç¯æ£®æ—ï¼Œé€‰å‡ºè‹¥å¹²ç‚¹ï¼Œè¦æ±‚æ‰€æœ‰é€‰å‡ºçš„ç‚¹éƒ½å¿…é¡»è¦æœ‰ä¸€ä¸ªæ²¡è¢«é€‰å‡ºçš„ç‚¹æŒ‡å‘å®ƒï¼Œæœ€å¤§åŒ–é€‰å‡ºç‚¹æ•°ã€‚

#### è§£é¢˜æ€è·¯

è¿™é“é¢˜è¿è¾¹ä¸Šæœ‰äº›æ–‡ç« å¯ä½œï¼Œæˆ‘ä»¬å°†é›†æˆå†…å‘åŸºç¯æ ‘ä¸å¤–å‘åŸºç¯æ ‘çš„ä¼˜ç‚¹ï¼Œè¿›è¡Œè¿è¾¹ã€‚

å…·ä½“åœ°ï¼Œè®° $u$ æŒ‡å‘ $v$ï¼Œæˆ‘ä»¬ç”¨æ•°ç»„ $p$ è®°å½•ä¸€ä¸ªç‚¹æŒ‡å‘çš„ç‚¹å³ $p_u = v$ï¼Œè¿™æ˜¯å†…å‘åŸºç¯æ ‘ï¼›æˆ‘ä»¬å†ç”¨é“¾å¼å‘å‰æ˜Ÿç”± $v$ å‘ $u$ å»ºå•å‘è¾¹ï¼Œè¿™æ˜¯å¤–å‘åŸºç¯æ ‘ã€‚

è¿™ä¹ˆè¿è¾¹çš„å¥½å¤„æ˜¯æ“ä½œæ–¹ä¾¿ï¼Œå†…å‘åŸºç¯æ ‘ä¼˜ç‚¹æ˜¯æ‰¾ç¯æ–¹ä¾¿ï¼Œç”±äºç‚¹éƒ½æ˜¯å‘å†…æŒ‡çš„ï¼Œåªéœ€éšä¾¿é€‰ä¸€ä¸ªç‚¹ä¸€ç›´å¾€å…¶æŒ‡å‘çš„ç‚¹èµ°ï¼Œç›´åˆ°é‡å¤ä¸ºæ­¢ä¾¿æ‰¾åˆ°äº†ç¯ï¼›è€Œé“¾å¼å‘å‰æ˜Ÿå»ºå•å‘è¾¹çš„å¥½å¤„æ˜¯æ–¹ä¾¿ dpï¼Œåˆ å»ç¯ä¸Šä¸€è¾¹åï¼Œä»¥æ–­ç‚¹ä¸ºæ ¹ï¼Œæ¯ä¸ªèŠ‚ç‚¹å…¶è¿è¾¹éƒ½æ˜¯å„¿å­ã€‚

ä¸Šé¢å·²ç»è¯´è¿‡äº†æ‰¾ç¯æ–¹æ³•ï¼Œå°†è¾¹æ–­æ‰ä¹‹åä¾¿å¯ä»¥å¼€å§‹æ ‘å½¢ dpï¼š

-  çŠ¶æ€è¡¨ç¤ºï¼š$dp_{i,0/1}$ è¡¨ç¤ºåœ¨ä»¥ $i$ æ ¹çš„å­æ ‘å†…ï¼Œ$i$ ä¸é€‰ / é€‰æ—¶çš„æœ€å¤§é€‰ç‚¹æ•°ã€‚
-  åˆå§‹åŒ–ï¼š$dp_{i,0/1}=0$
-  çŠ¶æ€è½¬ç§»
   -  ä¸é€‰ $i$ï¼šåˆ™å…¶å­èŠ‚ç‚¹ä¸å—é™åˆ¶ï¼Œå³
      
      $$dp_{i,0}=\sum_{j \in son_i}{\max(dp_{j,0},dp_{j,1})}$$

   -  é€‰ $i$ï¼šåˆ™å…¶å­èŠ‚ç‚¹è‡³å°‘æœ‰ä¸€ä¸ªä¸é€‰ï¼Œå³
      
      $$dp_{i,1}=1+\max_{j \in son_i}{(dp_{j,0}+\sum_{k \in son_i,k \neq j}{\max(dp_{k,0},dp_{k,1})})}$$

		å¤æ‚åº¦è¾ƒé«˜ï¼Œè€ƒè™‘ä¼˜åŒ–ï¼Œå‘ç°å³è¾¹çš„å’Œå¼ä¸ $dp_{i,0}$ å¾ˆç›¸ä¼¼ï¼Œäºæ˜¯æœ‰ï¼š

		$$\begin{aligned}dp_{i,1} &= 1+\max_{j \in son_i}{(dp_{j,0}+dp_{i,0} - \max(dp_{j,0},dp_{j,1}))} \\ &= 1 + dp_{i,0} - \min_{j \in son_i}{(\max(dp_{j,0},dp_{j,1}) - dp_{j,0})}\end{aligned}$$

		å³å¯å¿«é€Ÿè½¬ç§»ã€‚
-  ç­”æ¡ˆï¼š$\max(dp_{rt,0},dp_{rt,1})$

ç°åœ¨æˆ‘ä»¬è€ƒè™‘åˆ å»è¾¹çš„å½±å“ï¼ŒåŸæ¥æœ‰ä¸€æ¡è¾¹æ˜¯ç”±æ ¹æŒ‡å‘ä¸€ä¸ªèŠ‚ç‚¹çš„ï¼Œä½†æ˜¯è¢«åˆ é™¤äº†ï¼Œè¿™æ„å‘³è€…åŸæ¥æ ¹æ˜¯å¯ä»¥é™åˆ¶æ­¤èŠ‚ç‚¹çš„ï¼Œç°åœ¨ä¸è¡Œäº†ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬è¦è€ƒè™‘æ ¹é™åˆ¶æ­¤èŠ‚ç‚¹çš„æƒ…å†µã€‚

äºæ˜¯æˆ‘ä»¬å†è·‘ä¸€é dpï¼Œé’¦å®šé€‰æ ¹èŠ‚ç‚¹ï¼Œå³è¿™ä¸ªç‚¹å·²ç»è¢«é™åˆ¶ä½äº†ï¼Œæ„å‘³ç€å°±ç®—é€‰è¿™ä¸ªç‚¹å…¶å„¿å­ä¹Ÿä¸å—ä»»ä½•é™åˆ¶ï¼Œåªéœ€å°†é€‰è¿™ä¸ªç‚¹çš„ dp å€¼åŠ ä¸Š $\min_{j \in son_i}{(\max(dp_{j,0},dp_{j,1}) - dp_{j,0})}$ å³å¯ï¼Œæœ€åç­”æ¡ˆä¸º $dp_{rt,1}$ï¼Œä¸ä¸Šé¢å¾—åˆ°ç­”æ¡ˆå–æœ€å¤§å€¼ä¾¿å¾—åˆ°äº†æœ€ç»ˆç­”æ¡ˆã€‚

#### ä»£ç å®ç°

``` cpp
#include <bits/stdc++.h>
#define endl "\n"
using namespace std;

const int N = 1e6 + 10;

struct edge
{
	int to, next;
} e[N];

int n, tot, rt, ans;
int a[N], h[N];
int dp[N][2];
bool vis[N];

void add(int u, int v)
{
	tot++;
	e[tot].to = v;
	e[tot].next = h[u];
	h[u] = tot;
}

void dfs(int u, bool flag)
{
	dp[u][0] = 0;
	vis[u] = 1;
	int mn = 1e9;
	for (int i = h[u]; i; i = e[i].next)
	{
		int v = e[i].to;
		if (v != rt)
		{
			dfs(v, flag);
			dp[u][0] += max(dp[v][0], dp[v][1]);
			mn = min(mn, max(dp[v][0], dp[v][1]) - dp[v][0]);
		}
	}
	dp[u][1] = 1 + dp[u][0] - mn;
	if (flag && u == a[rt])
	{
		dp[u][1] += mn;
	}
}

int main()
{
	ios :: sync_with_stdio(0);
	cin.tie(0), cout.tie(0);
	cin >> n;
	for (int i = 1; i <= n; i++)
	{
		cin >> a[i];
		add(a[i], i);
	}
	for (int i = 1; i <= n; i++)
	{
		if (!vis[i])
		{
			for (rt = i; !vis[rt]; rt = a[rt])
			{
				vis[rt] = 1;
			}
			dfs(rt, 0);
			int tmp = max(dp[rt][0], dp[rt][1]);
			dfs(rt, 1);
			ans += max(tmp, dp[rt][0]);
		}
	}
	cout << ans << endl;
	return 0;
}
```

---

## ä½œè€…ï¼šCommandSR (èµï¼š1)

## åŸºæœ¬æ€è·¯

å¯¹äºæ¯ä¸ªç‚¹å‘èƒ½å¤Ÿé™åˆ¶å®ƒçš„ä¸–ç•Œå…ƒç´ å»ºè¾¹ï¼Œæ˜¾ç„¶å»ºå®Œå›¾ä¹‹åæ˜¯ä¸€ä¸ªå¤–å‘åŸºç¯æ ‘æ£®æ—ã€‚

å¯¹äºæ¯ä¸€é¢—åŸºç¯æ ‘ï¼Œå…ˆæ‰¾åˆ°ç¯ï¼Œç„¶åå¯¹äºç¯ä¸Šä»»æ„ä¸€æ¡è¾¹çš„ä¸¤ä¸ªç‚¹åˆ†åˆ«æ ‘å½¢ DPï¼Œå–è¾ƒå¤§å€¼è®¡å…¥ç­”æ¡ˆã€‚

å¯¹äºæ ‘å½¢ DPï¼Œè®¾ $f_{u,0}$ ä¸ºä¸é€‰ $u$ ç‚¹çš„æœ€å¤šå¯ä»¥æŠ•æ”¾çš„ä¸–ç•Œå…ƒç´ çš„æ•°ç›®ï¼Œ$f_{u,1}$ ä¸ºé€‰è¿™ä¸ªç‚¹çš„æœ€å¤§æ•°ç›®ã€‚

å¯¹äº $f_{u, 0}$ï¼Œå¯¹å­æ ‘ï¼Œå³èƒ½å¤Ÿé™åˆ¶å®ƒçš„ç‚¹æ²¡æœ‰é™åˆ¶ï¼Œæ‰€ä»¥æœ‰ $f_{u,0} = \sum_{v \in son_u}{\max{f_{v,0}, f_{v,1}}}$ã€‚

å¯¹äº $f_{u,1}$ï¼Œå¯ä»¥å…ˆæŒ‰ä¸Šé¢çš„å¼å­è½¬ç§»ï¼Œä½†å¿…é¡»ä¿è¯æœ‰ä¸€ä¸ªå­èŠ‚ç‚¹ä¸é€‰ã€‚æ‰€ä»¥è®°å½•ä¸€ä¸‹æœ‰æ²¡æœ‰ä¸€ä¸ªå­èŠ‚ç‚¹æ²¡æœ‰é€‰ï¼Œå³æ˜¯å¦å­˜åœ¨ä¸€ä¸ª $v \in son_u$ æ»¡è¶³ $f_{v,0} \ge f_{v,1}$ã€‚

å¦‚æœå­˜åœ¨ï¼Œé‚£ä¹ˆç¬¦åˆé¢˜æ„ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œé€‰æ‹©ä¸€ä¸ª $v$ï¼Œå°† $f_{u,1}$ å‡å» $f_{v,1}$ åŠ ä¸Š $f_{v,0}$ã€‚å®¹æ˜“å‘ç°éœ€è¦ç»Ÿè®¡å­æ ‘ä¸­ $f_{v,0}-f_{v,1}$ æœ€å¤§çš„ $v$ ä½œä¸ºé€‰æ‹©ã€‚

å…·ä½“å¯è§ä»£ç ã€‚

## AC Code

```cpp
#include <bits/stdc++.h>
#define F(i, a, b) for (int i = a; i <= b; ++i)
#define _F(i, a, b) for (int i = a; i >= b; --i)
#define ll long long
using namespace std;
inline ll rd() {
	ll p = 0, f = 1; char ch = getchar();
	while (ch>'9' || ch<'0') {
		if (ch == '-') f = -1;
		ch = getchar();
	}
	while (ch>='0' && ch<='9') p = p*10+ch-'0', ch = getchar();
	return p * f;
}
const int N = 1e6 + 5;
ll n;
struct E {
	ll to, nxt;
} e[N];
ll hd[N], ec;
bool vis[N];
void AE(ll u, ll v) {
	e[++ec] = (E){v, hd[u]}, hd[u] = ec;
}
ll r1 = 0, r2 = 0;
void Find(ll u, ll rt) {
	vis[u] = 1;
	for (int i = hd[u]; i; i = e[i].nxt) {
		ll v = e[i].to;
		if (v == rt) {
			r1 = u, r2 = v;
			return;
		}
		if (vis[v]) continue;
		Find(v, rt);
	}
}
ll f[N][2];
ll dfs(ll u, ll rt) {
	f[u][1] = 1, f[u][0] = 0;
	ll mx = 0; bool flag = 0;
	for (int i = hd[u]; i; i = e[i].nxt) {
		ll v = e[i].to;
		if (v == rt) continue;
		dfs(v, rt);
		f[u][0] += max(f[v][0], f[v][1]);
		if (f[v][0] > f[v][1]) flag = 1, f[u][1] += f[v][0]; 
		else f[u][1] += f[v][1];
		if (!mx || f[v][0]-f[v][1] > f[mx][0]-f[mx][1]) mx = v;
	}
	if (!flag) {
		if (mx) f[u][1] = f[u][1] - f[mx][1] + f[mx][0];
		else f[u][1] = 0;
	}
	return f[u][1];
}
int main() {
	n = rd();
	F(i, 1, n) {
		ll x = rd();
		AE(x, i);
	}
	ll ans = 0;
	F(i, 1, n) {
		if (vis[i]) continue;
		r1 = r2 = 0;
		Find(i, i);
		if (r1) {
			ll res1 = dfs(r1, r1);
			ll res2 = dfs(r2, r2);
			ans += max(res1, res2);
		}
	}
	cout << ans << '\n';
	return 0;
}
```

---

## ä½œè€…ï¼šGYç¨‹è¢æµ© (èµï¼š1)

é¦–å…ˆï¼Œä½ éœ€è¦æ³¨æ„é¢˜ç›®é‡Œå®é™…ä¸Šå¶èŠ‚ç‚¹æ˜¯ä¸èƒ½é€‰çš„ã€‚

å‡ ä¹æ²¡æœ‰åŠ¨æœºï¼Œæˆ‘ä»¬é€šè¿‡å¥—è·¯å•ç‚¹å•è¾¹çŸ¥é“äº†è¿™é“é¢˜çš„å›¾å®é™…ä¸Šæ˜¯ä¸€é¢—åŸºç¯æ ‘æ£®æ—ã€‚

ç„¶åæ¯æ£µåŸºç¯æ ‘æ˜¯ç‹¬ç«‹çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬åˆ†è¿é€šå—è€ƒè™‘å³å¯ã€‚

ç°åœ¨æ¥è®²è¿°å•æ£µæ ‘çš„åšæ³•ï¼Œé¦–å…ˆåŸºç¯æ ‘çš„å¥—è·¯åšæ³•å°±æ˜¯æ‰¾ç¯å†è€ƒè™‘ã€‚å¯¹äºæœ¬é¢˜ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªæ–°çš„å¥—è·¯ï¼Œå°±æ˜¯æˆ‘ä»¬å¯ä»¥ä¾ç…§æœ‰åæ•ˆæ€§çš„ DP çš„å¤„ç†æ€è·¯ï¼Œå…ˆæ–­å¼€ç¯ä¸Šä¸€æ¡è¾¹ï¼Œè¿™æ ·æ•´é¢—åŸºç¯æ ‘å°±å˜æˆäº†ä¸€é¢—æ ‘ï¼Œå†è€ƒè™‘å¼ºåˆ¶è¿ä¸Šåˆšåˆšæ–­å¼€çš„è¾¹å†è€ƒè™‘ä¸€éã€‚è¿™æ ·æˆ‘ä»¬çš„ç­”æ¡ˆå°±å–åˆ°äº†å…¨é›†ï¼Œæ²¡æœ‰é—æ¼æƒ…å†µã€‚

æ–­å¼€ä¸€æ¡è¾¹å®é™…ä¸Šæ˜¯ç»™ $A_{p}$ å¸¦æ¥ä¸åˆ©çš„ç¯å¢ƒã€‚å› ä¸ºä½ è€ƒè™‘å®ƒæœ¬æ¥å¯ä»¥ä» $p$ æ¥è½¬ç§»ï¼Œä½†æ˜¯å› ä¸ºè¾¹è¢«åˆ‡äº†ï¼Œæ‰€ä»¥ä¸èƒ½å¤Ÿè¿™ä¹ˆåšã€‚å°±æ˜¯å®ƒçš„èƒ½ç”¨å†³ç­–é›†åˆå˜å°äº†ã€‚

æ³¨æ„ï¼šæˆ‘ä»¬ä¸æŠŠè¾¹è¿å›å»ï¼Œåªæ˜¯ç‰¹åˆ¤è€ƒè™‘ã€‚

å¯¹äºæ ‘ä¸Š DPï¼Œå‚è€ƒæ²¡æœ‰ä¸Šå¸çš„èˆä¼šï¼Œç®€å•åœ°è®¾è®¡æ ‘ä¸Š DP æ–¹ç¨‹å³å¯ã€‚

å¯¹äºä¸€ä¸ªèŠ‚ç‚¹ï¼Œé€‰æ‹©ä¸€ä¸ªå­èŠ‚ç‚¹ä¸é€‰æ¥è½¬ç§»ã€‚

å¦‚æœæ˜¯å¼ºåˆ¶è¿è¾¹ï¼Œ$A_{p}$ å³å¯ç‰¹åˆ¤é€‰æ‹©é€‰æ‹©æ‰€æœ‰å­èŠ‚ç‚¹ã€‚

ä¸æ‡‚å¯ä»¥ç§ä¿¡äº¤æµå–µã€‚

æˆ‘æœ€è¿‘åœ¨æå‡ä»£ç èƒ½åŠ›ã€‚æˆ‘å°†å¯»æ‰¾é«˜æ•ˆçš„ä»£ç ä½œä¸ºè¿™é¢˜çš„ç­”æ¡ˆä»£ç ï¼ŒåŒæ—¶ï¼Œæˆ‘ä¹Ÿä¼šå†™éƒ¨åˆ†æ³¨é‡Šï¼Œå¸Œæœ›è¯»è€…èƒ½å¤Ÿä»”ç»†åœ°å»é˜…è¯»ï¼Œå¹¶å­¦ä¹ ä»£ç è®¾è®¡ç®€åŒ–çš„æ€è·¯ï¼Œä¸è¦èµ°æˆ‘çš„è·¯ã€‚ä»£ç è®¾è®¡çš„ä¸å¥½ï¼Œåˆä¸å¥½è°ƒï¼Œåˆä¸å¥½å†™ï¼Œä¸ä»…åœ¨æ¯”èµ›æ—¶ä¼šåƒå¤§äºï¼Œä¹Ÿä¼šå½±å“å¹³æ—¶è®­ç»ƒã€‚

è¿™é‡Œæˆ‘ä»¬æœ‰å…·ä½“ä»£ç å®ç°æ€è·¯ï¼Œæˆ‘ä»¬å»ºåå›¾æ–¹ä¾¿è®¿é—®èŠ‚ç‚¹ã€‚ç„¶åä¸ºäº†ç®€åŒ–ï¼Œæˆ‘ä»¬è¿™æ ·è€ƒè™‘ç¯ï¼Œç”±äºæ•´æ£µåŸºç¯æ ‘æ˜¯ä¸€ä¸ªå†…å‘æ ‘ï¼Œäºæ˜¯æˆ‘ä»¬ä¸€ç›´åˆ°è¾¾åŸå›¾ä¸Šçš„å‡ºç‚¹ï¼Œç›´åˆ°éå†åˆ°éå†è¿‡çš„ç‚¹ã€‚å†™ä¸€ä¸ªæ·±æœå‡½æ•°ï¼Œå…¶ä¸­æ‰€å«ç‰¹åˆ¤ï¼Œåšä¸¤æ¬¡ï¼Œå–æœ€å¤§å€¼å³å¯ã€‚å¦å¤–ï¼Œåœ¨è½¬ç§»è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥è®°å½•ä¸é€‰å•ä¸ªå„¿å­ä¸¢å¤±çš„æœ€å°å€¼ï¼Œå°±å¯ä»¥ä»å½“å‰èŠ‚ç‚¹ä¸é€‰çš„çŠ¶æ€è½¬ç§»å•¦ã€‚

# Code

```cpp
// Problem: P10933 åˆ›ä¸–çºª
// Contest: Luogu
// URL: https://www.luogu.com.cn/problem/P10933
// Memory Limit: 512 MB
// Time Limit: 1000 ms
//
// Powered by CP Editor (https://cpeditor.org)

#include <bits/stdc++.h>
#define int long long
#define upp(a, x, y) for (int a = x; a <= y; a++)
#define dww(a, x, y) for (int a = x; a >= y; a--)
#define pb(x) push_back(x)
#define endl '\n'
#define x first
#define y second
#define PII pair<int, int>
using namespace std;
const int N = 1e6 + 10, INF = 0x3f3f3f3f3f3f3f3f;
int st[N], vis[N], h[N], e[N], ne[N], a[N], f[N][2], n, rt, idx, ans;
void add(int a, int b) { e[idx] = b, ne[idx] = h[a], h[a] = idx++; }
/*
è¿™é‡Œæˆ‘ä»¬æœ‰çŠ¶æ€è½¬ç§»æ–¹ç¨‹
å¯¹äºä¸ç‰¹åˆ¤
f[u][0]=sum of max(f[j][0],f[j][1]) (j belongs to u's sons)
f[u][1]=f[y][0]+sum of max(f[j][0],f[j][1]) (j and y belong to u's sons,but j
not equal to y)

å¯¹äºç‰¹åˆ¤ï¼Œæ–‡ä¸­æè¿°
*/
int dfs(int u, bool va) {
    int minn = INF; //è®°å½•ä¸é€‰å•ä¸ªï¼Œä¸¢å¤±çš„æœ€å°å€¼ï¼Œè¿™ä¸ªæ€æƒ³å¾ˆå¦™ã€‚
    st[u] = 1;
    f[u][0] = f[u][1] = 0;
    for (int i = h[u]; i != -1; i = ne[i]) {
        int j = e[i];
        if (j == rt) continue;
        dfs(j, va);
        f[u][0] += max(f[j][0], f[j][1]);
        minn = min(minn, f[j][1] - f[j][0]);
    }
    f[u][1] =
        max(f[u][1], f[u][0] - minn + 1); //è¿™é‡Œå°±å¯ä»¥ç›´æ¥é€šè¿‡ f[u][0] æ¥è½¬ç§»
    if (u == a[rt] && va) f[u][1] = f[u][0] + 1; //ç‰¹åˆ¤
    return max(f[u][1], f[u][0]);
}
int solve(int x) {
    for (rt = x; !vis[rt]; rt = a[rt]) vis[rt] = 1; //å¯»æ‰¾æ ¹
    int res = dfs(rt, 0);
    dfs(rt, 1);                //ä¸¤æ¬¡ DP
    return max(res, f[rt][0]); //è¿™é‡Œæ˜¯å¼ºåˆ¶é€‰è¾¹çš„æƒ…å†µ
}
signed main() {
    ios::sync_with_stdio(0);
    cin.tie(0), cout.tie(0);
    memset(h, -1, sizeof h);
    cin >> n;
    upp(i, 1, n) cin >> a[i], add(a[i], i);
    upp(i, 1, n) if (!st[i]) ans += solve(i);
    cout << ans << endl;
    return 0;
}
```

---

## ä½œè€…ï¼šGXZJQ (èµï¼š1)

# P10933 åˆ›ä¸–çºª é¢˜è§£

[é¢˜ç›®é“¾æ¥](https://www.luogu.com.cn/problem/P10933)

## æ€è·¯åˆ†æ
ç”±äºæ¯ä¸ªç‚¹å¯ä»¥é™åˆ¶å¦å¤–ä¸€ä¸ªç‚¹ï¼Œå¦‚æœæˆ‘ä»¬çœ‹ä½œä»æ¯ä¸ªç‚¹å‘ä»–é™åˆ¶çš„ç‚¹è¿è¾¹ï¼Œåˆ™æœ¬é¢˜å°±æ˜¯ä¸€ä¸ªåŸºç¯æ£®æ—ã€‚æˆ‘ä»¬å°±æ˜¯è¦åœ¨ä¸€ä¸ªåŸºç¯æ£®æ—ä¸­é€‰å°½å¯èƒ½å¤šçš„ç‚¹ï¼Œä½¿å¾—æ¯ä¸ªç‚¹éƒ½èƒ½è¢«æŸä¸€ä¸ªæ²¡é€‰ä¸­çš„ç‚¹é™åˆ¶ã€‚

ç”±äºåŸºç¯æ£®æ—ä¸­æ¯ä¸€æ£µåŸºç¯æ ‘éƒ½æ˜¯ç›¸äº’ç‹¬ç«‹çš„ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å•ç‹¬è€ƒè™‘æ¯ä¸€æ£µåŸºç¯æ ‘ä¸­æœ€å¤šèƒ½é€‰æ‹©å¤šå°‘ä¸ªç‚¹ã€‚

æˆ‘ä»¬å…ˆè€ƒè™‘å¦‚æœåœ¨ä¸€æ£µæ™®é€šçš„æ ‘ä¸­å¦‚ä½•æ±‚ï¼Œä¸€ä¸ªç‚¹è¢«é™åˆ¶å°±æ„å‘³ç€æœ‰ä¸€ä¸ªç‚¹æŒ‡å‘å®ƒï¼Œå› æ­¤å°±æ˜¯è¦ä¿è¯æ¯ä¸ªç‚¹çš„çˆ¶èŠ‚ç‚¹éƒ½ä¸èƒ½è¢«é€‰æ‹©ï¼Œè¿™æ ·çš„æ–¹æ¡ˆæˆ‘ä»¬å¯ä»¥ç”¨æ ‘å½¢ DP æ¥æ±‚ã€‚

è®¾ $f_{u,0}$ è¡¨ç¤ºä»ä»¥ $u$ ä¸ºæ ¹çš„å­æ ‘ä¸­é€‰è‹¥å¹²ä¸ªç‚¹ï¼Œä¸”ä¸é€‰ $u$ çš„æ‰€æœ‰æ–¹æ¡ˆçš„æœ€å¤§å€¼ã€‚è®¾ $f_{u,1}$ è¡¨ç¤ºä»ä»¥ $u$ ä¸ºæ ¹çš„å­æ ‘ä¸­é€‰è‹¥å¹²ä¸ªç‚¹ï¼Œä¸”é€‰æ‹© $u$ çš„æ‰€æœ‰æ–¹æ¡ˆçš„æœ€å¤§å€¼ã€‚

è®¾ $u$ çš„æ¯ä¸ªçˆ¶èŠ‚ç‚¹ä¸º $s$ï¼Œå¯å¾—çŠ¶æ€è½¬ç§»æ–¹ç¨‹ï¼š

$$
\left\{\begin{matrix}   f_{u, 0}= \sum \max \{{f_{s,0}, f_{s,1}} \} \\    f_{u, 1} = \max \{{f_{u,0}-\max \{{f_{t,0},f_{t,1} \}}+f_{t,0}+1}\}\ (t \in s)\end{matrix}\right. 
$$

å¯ä»¥å‘ç°è¿™é‡Œçš„æ ‘å½¢ DP ä¸­æ¯ä¸ªç‚¹çš„çŠ¶æ€æ˜¯é€šè¿‡çˆ¶èŠ‚ç‚¹é€’æ¨è¿‡æ¥çš„ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å»ºä¸€ä¸ªåå‘è¾¹ï¼Œåå‘é€’æ¨ã€‚

ä½†æ˜¯åŸºç¯æ ‘æ˜¯æ²¡æ³•åšæ ‘å½¢ DP çš„ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å°†ç¯ä¸ŠæŸä¸€æ¡è¾¹æ–­å¼€ï¼Œè¿™æ ·åŸºç¯æ ‘å°±èƒ½å˜æˆä¸€æ£µæ™®é€šçš„æ ‘ï¼Œå°±èƒ½åšæ ‘å½¢ DP äº†ï¼Œæˆ‘ä»¬å–ç¯ä¸Šä¸€ç‚¹ $p$ï¼Œå°† $p \to A_p$ çš„è¾¹æ–­å¼€ï¼Œæ­¤æ—¶æˆ‘ä»¬å¯ä»¥å°†æ‰€æœ‰æ–¹æ¡ˆåˆ†æˆä¸¤ç±»ï¼Œä¸€ç±»æ˜¯ä¸ç”¨ $p \to A_p$ è¿™æ¡è¾¹ï¼Œè¿™å°±æ„å‘³ç€è¦ä¹ˆä¸é€‰ $A_p$ï¼Œè¦ä¹ˆé€‰ $A_p$ å¹¶ä¸”æœ‰å¦å¤–ä¸€æ¡è¾¹æŒ‡å‘ $A_p$ã€‚æ­¤æ—¶æ²¡æœ‰ç”¨åˆ° $p \to A_p$ è¿™æ¡è¾¹ï¼Œæ‰€ä»¥å¯¹ $p$ æ²¡æœ‰ä»»ä½•é™åˆ¶ï¼Œæˆ‘ä»¬ä» $p$ å¼€å§‹æ±‚ä¸€éæ ‘å½¢ DPï¼Œæœ€ç»ˆå¾—åˆ°ä¸¤ä¸ªçŠ¶æ€ $f_{p,0}$ å’Œ $f_{p,1}$ï¼Œç”±äº $p$ é€‰ä¸é€‰éƒ½è¡Œï¼Œå› æ­¤è¿™ä¸€ç±»çš„ç­”æ¡ˆå°±æ˜¯è¿™ä¸¤ä¸ªçŠ¶æ€å–ä¸€ä¸ªæœ€å¤§å€¼ã€‚

å¦ä¸€ç±»æ˜¯ç”¨ $p \to A_p$ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬ä¸€å®šè¦é€‰ $A_p$ï¼Œä¸”ä¸€å®šä¸é€‰ $p$ï¼Œé‚£ä¹ˆæˆ‘ä»¬åªéœ€è¦åœ¨åšæ ‘å½¢ DP çš„è¿‡ç¨‹ä¸­ç‰¹åˆ¤ä¸€ä¸‹ $A_p$ ä¸€å®šè¦é€‰å³å¯ï¼Œæœ€ç»ˆåŒæ ·å¾—åˆ°ä¸¤ä¸ªçŠ¶æ€ $f_{p,0}$ å’Œ $f_{p,1}$ï¼Œç”±äº $p$ æ­¤æ—¶ä¸€å®šä¸èƒ½é€‰ï¼Œå› æ­¤è¿™ä¸€ç±»çš„ç­”æ¡ˆå°±æ˜¯ $f_{p,0}$ã€‚

æœ€ç»ˆå†ä»è¿™ä¸¤ç±»æƒ…å†µçš„ç­”æ¡ˆä¸­å–ä¸€ä¸ªæœ€å¤§å€¼ï¼Œå°±æ˜¯æ•´ä¸ªçš„ç­”æ¡ˆã€‚

## å‚è€ƒä»£ç 
```cpp
#include <iostream>
#include <cstring>
using namespace std;
const int N = 1000010, INF = 0x3f3f3f3f;
int n;
int h[N], e[N], rm[N], ne[N], idx; //é‚»æ¥è¡¨
bool st[N], ins[N]; //st è®°å½•æ¯ä¸ªç‚¹æ˜¯å¦è¢«æœè¿‡ï¼Œins è®°å½•æ¯ä¸ªç‚¹æ˜¯å¦åœ¨æ ˆä¸­
//f[i][0] è¡¨ç¤ºä» i ä¸ºæ ¹çš„å­æ ‘ä¸­é€‰è‹¥å¹²ä¸ªèŠ‚ç‚¹ï¼Œä¸”ä¸é€‰ i çš„æ‰€æœ‰æ–¹æ¡ˆçš„æœ€å¤§å€¼
//f[i][i] è¡¨ç¤ºä» i ä¸ºæ ¹çš„å­æ ‘ä¸­é€‰è‹¥å¹²ä¸ªèŠ‚ç‚¹ï¼Œä¸”é€‰æ‹© i çš„æ‰€æœ‰æ–¹æ¡ˆçš„æœ€å¤§å€¼
int f1[N][2], f2[N][2];
int res; //è®°å½•ç­”æ¡ˆ

void add(int a, int b) //æ·»åŠ è¾¹
{
    e[idx] = b, ne[idx] = h[a], h[a] = idx++;
}

void dfs_f(int u, int ap, int f[][2]) //æ ‘å½¢ dp æ±‚ä»¥ u æ ¹ä¸ºçš„å­æ ‘ä¸­å¿…é€‰ ap çš„æ‰€æœ‰æ–¹æ¡ˆçš„æœ€å¤§å€¼
{
    //ä¸é€‰ u
    for(int i = h[u]; i != -1; i = ne[i])
    {
        if(rm[i]) continue;
        int j = e[i];
        dfs_f(j, ap, f);
        f[u][0] += max(f[j][0], f[j][1]);
    }

    //å¦‚æœ u å¿…é€‰ï¼Œåˆ™ u å·²ç»è¢« p é™åˆ¶ï¼Œå…¶ä»–å­èŠ‚ç‚¹å¯é€‰å¯ä¸é€‰
    if(u == ap) f[u][1] = f[u][0] + 1;
    else
    {
        //é€‰ u
        f[u][1] = -INF;
        for(int i = h[u]; i != -1; i = ne[i])
        {
            if(rm[i]) continue;
            int j = e[i];
            f[u][1] = max(f[u][1], f[u][0] - max(f[j][0], f[j][1]) + f[j][0] + 1);
        }
    }
}

void dfs_c(int u, int from) //æ‰¾å‡ºæ‰€æœ‰åŸºç¯æ ‘çš„ç¯
{
    st[u] = ins[u] = true;
    for(int i = h[u]; i != -1; i = ne[i])
    {
        int j = e[i];
        if(!st[j]) dfs_c(j, i);
        else if(ins[j]) //æ‰¾åˆ°ç¯
        {
            rm[i] = 1; //å°†è¾¹ ap -> p åˆ å»
            dfs_f(j, -1, f1); //ä¸ç”¨è¾¹ ap -> p
            dfs_f(j, u, f2); //ç”¨è¾¹ ap -> pï¼ˆå¿…é€‰ apï¼Œå¿…ä¸é€‰ pï¼‰
            res += max(max(f1[j][0], f1[j][1]), f2[j][0]); //ç´¯åŠ æ‰€æœ‰æ–¹æ¡ˆçš„æœ€å¤§å€¼
        }
    }
    ins[u] = false;
}

int main()
{
    scanf("%d", &n);
    memset(h, -1, sizeof h); //åˆå§‹åŒ–é‚»æ¥è¡¨
    for(int i = 1; i <= n; i++)
    {
        int a;
        scanf("%d", &a);
        add(a, i); //æœ‰å‘è¾¹
    }
    //æ‰¾å‡ºæ‰€æœ‰åŸºç¯æ ‘çš„ç¯
    for(int i = 1; i <= n; i++)
        if(!st[i])
            dfs_c(i, -1);

    printf("%d\n", res);

    return 0;
}
```

---

## ä½œè€…ï¼šwwwidk1234 (èµï¼š0)

[åˆé›†ï¼š2025 æš‘å‡é›†è®­ï¼ˆDay 15ï¼‰](https://www.cnblogs.com/wwwidk1234/p/19049954)

è¿™é¢˜åœ¨æ ¡å†…é›†è®­çš„å®˜æ–¹é¢˜è§£æ˜¯è´ªå¿ƒï¼Œç„¶åæˆ‘çš„è¿™ä¸ªæ–­ç¯ DP åšæ³•è°ƒäº†å…­ä¸ªå°æ—¶

é¦–å…ˆå¦‚æœæŠŠè¿™ä¸ªé™åˆ¶ä¸è¢«é™åˆ¶çš„å…³ç³»è¿ä¸Šè¾¹çš„è¯ï¼Œå¯ä»¥å‘ç°è¿æˆäº†è‹¥å¹²åŸºç¯æ ‘ã€‚é‡åˆ°åŸºç¯æ ‘ä¸€èˆ¬çš„åšæ³•æœ‰ä¸¤ç§ï¼š

1. é¦–å…ˆæŠŠç¯çš„è¾¹å…¨éƒ¨æ–­å¼€ï¼Œå˜æˆè‹¥å¹²æ£µä»¥ç¯ä¸Šçš„ç‚¹ä¸ºæ ¹ç»“ç‚¹æ ‘ï¼Œç„¶åå°±å¯ä»¥è½¬åŒ–æˆæ ‘ä¸Šé—®é¢˜ï¼Œæœ€åæˆ‘ä»¬å°±å¯ä»¥å¾—åˆ°ç¯ä¸Šæ¯ä¸€ä¸ªç»“ç‚¹çš„ä¿¡æ¯ï¼Œé—®é¢˜å°±å˜æˆç¯ä¸Šé—®é¢˜äº†ã€‚
2. ï¼ˆä¸ªäººå¸¸ç”¨ï¼‰æˆ‘ä»¬å¯ä»¥å‘ç°åŸºç¯æ ‘å®é™…ä¸Šå°±æ˜¯ä¸€æ£µæ ‘å¤šäº†ä¸€æ¡è¾¹ $(lt,rt)$ï¼ŒæŠŠè¿™æ¡è¾¹æ–­å¼€ä¹‹ååšæ ‘ä¸Šé—®é¢˜ï¼Œå¯¹äºä¸¤ä¸ªæ–­å¼€çš„ç‚¹ $lt,rt$ åˆ†æƒ…å†µè®¨è®ºã€‚å¦‚æœæ˜¯åªæœ‰ä¸€æ£µåŸºç¯æ ‘å¯ä»¥ä½¿ç”¨å¹¶æŸ¥é›†æ‰¾ç¯ï¼Œå¦‚æœæ˜¯åŸºç¯æ ‘æ£®æ—å¯ä»¥å…ˆç”¨å¹¶æŸ¥é›†æ‰¾å‡ºä¸€ä¸ªâ€œæœ‰ä»£è¡¨æ€§çš„ç‚¹â€ï¼Œç„¶åå†ä»è¿™ä¸ªç‚¹å‘ä¸Šè·³å°±å¯ä»¥æ‰¾åˆ° $lt,rt$ äº†ã€‚

å›å½’åˆ°è¿™é“é¢˜ã€‚å¦‚ä½•è¿è¾¹å»ºç«‹æ¨¡å‹ï¼Ÿå¦‚æœæˆ‘ä»¬ç”¨è¾¹ $(u,v)$ è¡¨ç¤º $u$ å¯ä»¥é™åˆ¶ $v$ï¼Œæˆ‘ä»¬ä¼šå‘ç°æˆ‘ä»¬å»ºç«‹å‡ºæ¥äº†è‹¥å¹²æ£µå†…å‘åŸºç¯æ ‘ï¼Œä¸å¤ªå¥½åšã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥è€ƒè™‘ç”¨è¾¹ $(u,v)$ è¡¨ç¤º **$u$ å¯ä»¥è¢« $v$ é™åˆ¶ï¼Œå³å­èŠ‚ç‚¹å¯ä»¥é™åˆ¶çˆ¶èŠ‚ç‚¹**ã€‚

æ¥ç€ä½¿ç”¨å¹¶æŸ¥é›†æ¥å¯»æ‰¾è¿™ä¸ª**æœ‰ä»£è¡¨æ€§çš„ç‚¹**ã€‚åœ¨è¾“å…¥çš„æ—¶å€™æˆ‘ä»¬æŠŠ $i,a_i$ åˆå¹¶åˆ°ä¸€ä¸ªé›†åˆä¸­ï¼Œç„¶ååœ¨å¹¶æŸ¥é›†çš„ç¥–å…ˆæ•°ç»„ `fa` æ•°ç»„ä¸­å¯»æ‰¾ï¼Œå¦‚æœæœ‰ç»“ç‚¹çš„ç¥–å…ˆæ˜¯è¿™ä¸ªç»“ç‚¹è‡ªå·±ï¼Œé‚£ä¹ˆå°±æ˜¯ä¸€ä¸ªâ€œæœ‰ä»£è¡¨æ€§çš„ç‚¹â€ï¼Œè¿™ä¸ªç‚¹ä»£è¡¨ç€è¿™ä¸ªç‚¹æ‰€åœ¨çš„åŸºç¯æ ‘ã€‚

å¯¹äºåŸºç¯æ ‘æ£®æ—ä¸­çš„æ¯ä¸€æ£µåŸºç¯æ ‘ï¼Œæˆ‘ä»¬å…ˆä»è¿™ä¸ªæœ‰ä»£è¡¨æ€§çš„ç‚¹å‘ä¸Šè·³**æ‰¾ç¯**ã€‚å¼€ä¸€ä¸ªæ ‡è®°æ•°ç»„å°†å½“å‰ç‚¹æ ‡è®°ï¼Œå¦‚æœä¸‹ä¸€ä¸ªè¦è·³åˆ°çš„ç‚¹æ˜¯æœ‰æ ‡è®°çš„ï¼Œåˆ™è¯´æ˜æ‰¾åˆ°ç¯äº†ï¼Œè¿™ä¸ªåŸºç¯æ ‘ä¸­çš„ $lt$ æ˜¯å½“å‰ç‚¹ï¼Œ$rt$ æ˜¯å½“å‰ç‚¹æ‰€é™åˆ¶çš„å…ƒç´ ã€‚åœ¨å»ºå›¾çš„æ—¶å€™ä¸å»ºç«‹ $(rt,lt)$ è¿™æ¡è¾¹å°±å¥½äº†ã€‚ï¼ˆæ³¨æ„é¡ºåºï¼Œæˆ‘ä»¬è¾¹çš„å®šä¹‰æ˜¯å‰è€…è¢«åè€…é™åˆ¶ï¼‰

å¯¹äºæ ·ä¾‹æ•°æ®ï¼Œæˆ‘ä»¬å»ºç«‹çš„å›¾å¦‚ä¸‹ï¼ˆè¢«æ ‡è®°çš„ç‚¹å°±æ˜¯æ‰€æ‰¾çš„æœ‰ä»£è¡¨æ€§çš„ç‚¹ï¼‰ï¼š

![](https://cdn.luogu.com.cn/upload/image_hosting/bdijjxx6.png)

å¯ä»¥è€ƒè™‘ DPï¼šè®¾ $dp_{u,0/1}$ è¡¨ç¤º**ä»¥ $u$ ä¸ºæ ¹ç»“ç‚¹çš„å­æ ‘ï¼Œå…¶ä¸­ $u$ ä¸é€‰ / é€‰çš„æœ€å¤§æŠ•æ”¾æ•°é‡**ã€‚æˆ‘ä»¬å°†è¾¹ $(rt,lt)$ åˆ é™¤å»ºå›¾ä¹‹åï¼Œè·‘ç¬¬ä¸€é DPã€‚

å¯¹äº**ç¬¬ä¸€é DP**ï¼Œè€ƒè™‘ $u$ ç»“ç‚¹å¦‚ä½•è½¬ç§»ï¼Ÿå¦‚æœ $u$ ç»“ç‚¹æ²¡æœ‰æ”¾çš„è¯ï¼Œé‚£ä¹ˆ**å®ƒçš„å„¿å­æƒ³æ€ä¹ˆæ”¾éƒ½å¯ä»¥**ï¼ˆå› ä¸ºå­èŠ‚ç‚¹ä¸è¦æ±‚é™åˆ¶çˆ¶èŠ‚ç‚¹ï¼‰ï¼Œäºæ˜¯æˆ‘ä»¬æœ‰çŠ¶æ€è½¬ç§»ï¼ˆå…¶ä¸­ $\operatorname{son}(u)$ è¡¨ç¤º $u$ ç»“ç‚¹æ‰€æœ‰å„¿å­ç»“ç‚¹æ„æˆçš„é›†åˆï¼‰ï¼š

$$dp_{u,0}=\sum_{v \in \operatorname{son}(u)} \max \left\{ dp_{v,0},dp_{v,1}\right\}$$

å¦‚æœ $u$ é€‰äº†æ€ä¹ˆåŠï¼Ÿæ˜¾ç„¶ï¼Œæˆ‘ä»¬åªè¦è®©**ä»»æ„ä¸€ä¸ªå„¿å­ç»“ç‚¹é™åˆ¶ $u$ï¼Œå…¶ä»–å„¿å­ç»“ç‚¹ä»»é€‰**å³å¯ã€‚è½¬ç§»å¦‚ä¸‹ï¼š

$$dp_{u,1}=1+\max_{v \in \operatorname{son}(u)}\left\{dp_{v,0}+\sum_{v^\prime \operatorname{son}(u) ,v^\prime \neq v}\max\left\{dp_{v^\prime,0},dp_{v^\prime,1}\right\}\right\}$$

è½¬ç§»è¦æšä¸¾ä¸€ä¸ª $v^\prime$ï¼Œå¤ªè€—æ—¶é—´äº†ï¼Œæ€ä¹ˆåŠï¼Ÿå‘ç° $\sum_{v^\prime \operatorname{son}(u) ,v^\prime \neq v}\max\left\{dp_{v^\prime,0},dp_{v^\prime,1}\right\}$ å…¶å®å°±æ˜¯ä¸€ä¸ª $dp_{u,0}$ æ‰£æ‰äº†ä¸€ä¸ª $\max\left\{dp_{v,0},dp_{v,1}\right\}$ï¼Œäºæ˜¯è½¬ç§»å¯ä»¥ä¼˜åŒ–æˆå¦‚ä¸‹ï¼š

$$dp_{u,1}=1+\max\left\{dp_{v,0}+dp_{u,0}- \max\left\{dp_{v,0},dp_{v,1}\right\}\right\}$$

æŠŠ $dp_{u,0}$ æ‹¿å‡ºæ¥ï¼š

$$dp_{u,1}=1+dp_{u,0}+\max\left\{dp_{v,0}- \max\left\{dp_{v,0},dp_{v,1}\right\}\right\}$$

è¿™ä¸ªå°±æ˜¯æˆ‘ä»¬æœ€ç»ˆçš„è½¬ç§»äº†ã€‚**ç¬¬ä¸€é DP çš„ç­”æ¡ˆå°±æ˜¯ $dp_{lt,0},dp_{lt,1}$ å–ä¸€ä¸ªæœ€å¤§å€¼ã€‚**

ç¬¬ä¸€é DP æˆ‘ä»¬åˆ æ‰äº† $(rt,lt)$ è¿™æ¡è¾¹ï¼Œå¼ºåˆ¶è®© $lt$ ä¸èƒ½é™åˆ¶ $rt$ã€‚æ‰€ä»¥ï¼š

å¯¹äº**ç¬¬äºŒé DP**ï¼Œæˆ‘ä»¬è€ƒè™‘**å¼ºåˆ¶è®© $lt$ é™åˆ¶ $rt$**ï¼Œè½¬ç§»æ–¹ç¨‹åŒç¬¬ä¸€é DPã€‚ä½†è¦æ³¨æ„çš„æ˜¯å› ä¸ºæˆ‘ä»¬å¼ºåˆ¶è®© $lt$ é™åˆ¶ $rt$ï¼Œæ‰€ä»¥ $rt$ çš„å„¿å­æ€ä¹ˆé€‰éƒ½æ²¡å…³ç³»ã€‚å¯¹äº $u=rt$ çš„æƒ…å†µï¼Œ$dp_{u,1}$ çš„è½¬ç§»å˜æˆå¦‚ä¸‹ï¼š

$$dp_{u,1}=1 + \sum_{v \in \operatorname{son}(u)} \max \left\{ dp_{v,0},dp_{v,1}\right\}=1+dp_{u,0}$$

è€ƒè™‘åˆ°æˆ‘ä»¬å¼ºåˆ¶è®© $lt$ é™åˆ¶ $rt$ï¼Œ$lt$ ä¸€å®šä¸é€‰ï¼Œæ‰€ä»¥**ç¬¬äºŒé DP çš„ç­”æ¡ˆå°±æ˜¯ $dp_{lt,0}$**ã€‚æ‰€ä»¥ä¸€æ£µåŸºç¯æ ‘çš„è´¡çŒ®æˆ‘ä»¬å°±ç®—å®Œäº†ã€‚æœ‰åŸºç¯æ ‘æ£®æ—çš„æƒ…å†µå°±ç›´æ¥ä¸€æ£µä¸€æ£µç®—è´¡çŒ®ï¼Œæœ€åç´¯åŠ å°±å¥½äº†ã€‚

[å‚è€ƒç¨‹åº](https://www.luogu.com.cn/record/232246618)ï¼š

```cpp
#include<bits/stdc++.h>
using namespace std;
typedef long long ll;
typedef unsigned long long ull;
constexpr int N=1e6+7;
int n,a[N];
bitset<N> vis;
vector<int> g[N];
vector<int> point;  //æœ‰ä»£è¡¨æ€§çš„èŠ‚ç‚¹ 
namespace dsu
{
	int fa[N];
	void init(int n)
	{
		for(int i=1;i<=n;i++) fa[i]=i;
	}
	int find(int u)
	{
		return fa[u]==u?u:fa[u]=find(fa[u]); 
	}
	void merge(int u,int v)
	{
		fa[find(u)]=find(v);
	}
	bool judge(int u,int v)   //u,væ˜¯å¦åœ¨ä¸€ä¸ªè¿é€šå—ä¸­ 
	{
		return find(u)==find(v);
	}
}
constexpr int inf=12180211;
int ans=0,lt,rt;
int dp1[N][2],dp2[N][2];
void dfs1(int u)
{
	int mx=-121802110;
	for(int v:g[u])
	{
		if(v==lt) continue;
		dfs1(v);
		dp1[u][0]+=max(dp1[v][0],dp1[v][1]);
		mx=max(mx,dp1[v][0]-max(dp1[v][0],dp1[v][1]));
	}
	dp1[u][1]=1+dp1[u][0]+mx;
}
void dfs2(int u)
{
	int mx=-121802110;
	for(int v:g[u])
	{
		if(v==lt) continue;
		dfs2(v);
		dp2[u][0]+=max(dp2[v][0],dp2[v][1]);
		mx=max(mx,dp2[v][0]-max(dp2[v][0],dp2[v][1]));
	}
	if(u==rt) dp2[u][1]=1+dp2[u][0];
	else dp2[u][1]=1+dp2[u][0]+mx;
}

inline int solve(int k)
{
	vis.reset();
	//å¯»æ‰¾ lt,rt 
	lt=-1,rt=-1;
	int cur=k;  //å½“å‰ç‚¹ 
	vis[cur]=1;
	while(1)
	{
		if(vis[a[cur]]) //å‘ä¸Šè·³å‘ç°æœ‰æ ‡è®° é‚£å°±è¯´æ˜æ‰¾åˆ°ç¯äº† 
		{
			lt=cur,rt=a[cur];
			break;
		}
		vis[a[cur]]=1;
		cur=a[cur];
	}
	
	//è¿™é‡Œçš„lt,rtè¿è¾¹çš„æ–¹å‘æ˜¯rt->lt 
	
	//å»ºå›¾
	for(int i=1;i<=n;i++)
	{
		int u=a[i],v=i;
		if(dsu::find(u)!=dsu::find(k)||dsu::find(v)!=dsu::find(k)) continue; //è¿™ä¸€ä¸ªsolveåªè¦è€ƒè™‘å½“å‰åŸºç¯æ ‘çš„ç»“æœ,ä¸ç”¨è€ƒè™‘å…¶ä»–åŸºç¯æ ‘
		if(!(u==rt&&v==lt)) g[u].push_back(v);  //åˆ æ‰çš„è¾¹(rt->lt)ä¸è¿æ¥ 
	}
	
	//å¼€å§‹DP
	dfs1(lt);
	dfs2(lt);
//	for(int i=1;i<=n;i++) cerr<<i<<' '<<dp1[i][0]<<' '<<dp1[i][1]<<' '<<dp2[i][0]<<' '<<dp2[i][1]<<endl;
	return max({dp1[lt][0],dp1[lt][1],dp2[lt][0]});
}
int main()
{
//	freopen("neuvillette.in","r",stdin);
//	freopen("neuvillette.out","w",stdout);
	ios::sync_with_stdio(0);
	cin.tie(0); cout.tie(0);
	cin>>n;
	dsu::init(n);
	for(int i=1;i<=n;i++)
	{
		cin>>a[i];
		dsu::merge(a[i],i);
	}
	for(int i=1;i<=n;i++) if(dsu::fa[i]==i) point.push_back(i);
	for(int v:point)
	{
		int res=solve(v);
		ans+=res;
	}
	cout<<ans;
	return 0;
}
/*
æŠŠa[i]->iè¿ä¸€æ¡è¾¹,ä»£è¡¨iå¯ä»¥è¢«a[i]é™åˆ¶ 
ç”¨å¹¶æŸ¥é›†æŠŠæ£®æ—ä¸­çš„æ¯ä¸€é¢—åŸºç¯æ ‘éƒ½æ‰¾å‡ºæ¥ 
å¯¹äºåŸºç¯æ ‘æ£®æ—ä¸­çš„æ¯ä¸€é¢—åŸºç¯æ ‘éƒ½è€ƒè™‘ï¼š
fa[i]=iå°±æ˜¯ä¸€ä¸ªâ€œæœ‰ä»£è¡¨æ€§çš„â€èŠ‚ç‚¹ 
é¦–å…ˆå…ˆä»æ¯ä¸€ä¸ªåŸºç¯æ ‘è¿™ä¸ªæœ‰ä»£è¡¨æ€§çš„èŠ‚ç‚¹å¾€ä¸Šè·³æ‰¾ç¯, 
ç„¶ååˆ æ‰ç¯å…¶ä¸­çš„ä¸€ä¸ªè¾¹(lt,rt)ç„¶åå¼€å§‹DP

dp[u][0/1]è¡¨ç¤ºä»¥uä¸ºæ ¹çš„å­æ ‘ä¸”uä¸é€‰/é€‰çš„æœ€å¤§ç­”æ¡ˆ
æ ¹æ®è¿è¾¹çš„ç»“æœ,èŠ‚ç‚¹uå¯ä»¥è¢«uçš„æ‰€æœ‰å„¿å­èŠ‚ç‚¹vé™åˆ¶
æ‰€ä»¥å¦‚æœué€‰äº†å°±è‡³å°‘æœ‰ä¸€ä¸ªvä¸é€‰ï¼Œå¦‚æœuä¸é€‰vé€‰å’Œä¸é€‰éƒ½æ— æ‰€è°“ 
dp[u][0]=âˆ‘max{dp[v][0],dp[v][1]}
dp[u][1]=1+max{dp[v][0]+âˆ‘max{dp[v'][0/1]}} å…¶ä¸­v'æ˜¯uçš„å„¿å­ä¸­é™¤vä»¥å¤–çš„å„¿å­,ä½†æ˜¯è¿™ä¸ªè½¬ç§»æ–¹ç¨‹å¦‚æœçœŸçš„è¿™ä¹ˆå†™è‚¯å®šä¼šè¶…æ—¶çš„ã€‚æ€ä¹ˆä¼˜åŒ–ï¼Ÿ
å‘ç° âˆ‘max{dp[v'][0/1]}å°±æ˜¯dp[u][0]æ‰£æ‰ä¸€ä¸ªmax{dp[v][0/1]}
ç„¶åæ–¹ç¨‹å¯ä»¥ä¼˜åŒ–æˆ: 
dp[u][1]=1+max{dp[v][0]+dp[u][0]-max{dp[v][0/1]}}
=1+dp[u][0]+max{dp[v][0]-max{dp[v][0/1]}}
ç„¶åä»¥ltä¸ºæ ¹è·‘ä¸€éDP 
è¿™æ ·æˆ‘ä»¬å°±å¾—åˆ°äº†ä¸€ä¸ªltä¸èƒ½é™åˆ¶rtçš„æ–¹æ¡ˆdp1ï¼Œç­”æ¡ˆä¸ºmax{dp[lt][0/1]} 
ç„¶åæŠŠè¿™ä¸ªåˆ æ‰çš„è¾¹è€ƒè™‘ä¸Šå»ï¼Œå¼ºåˆ¶è®©lté™åˆ¶ä½rt,ä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªltåªèƒ½ä¸æŠ•æ”¾,å°±æ˜¯dp[lt][0],ç„¶åè¿™ä¸ªltçš„å„¿å­èŠ‚ç‚¹éƒ½ä¸å—é™åˆ¶äº† 
ç„¶åç¬¬äºŒéDPè¯¥æ€ä¹ˆè·‘ï¼Ÿ
è€ƒè™‘åˆ°rtå·²ç»è¢«é™åˆ¶äº†,æ‰€ä»¥ä»–çš„å„¿å­æ— è®ºå¦‚ä½•æ”¾éƒ½æ˜¯åˆæ³•çš„æ–¹æ¡ˆï¼Œæ‰€ä»¥ç¬¬äºŒæ¬¡DPçš„çŠ¶æ€è½¬ç§»æ–¹ç¨‹å°±æ˜¯ï¼š
å¯¹äºu==rt(å°±æ˜¯uè¢«lté™åˆ¶çš„æƒ…å†µ)dp[u][1]=1+dp[u][0]
*/
```

---

## ä½œè€…ï¼šLittle_duck_GGG (èµï¼š0)

### é¢˜ç›®æ„æ€ã€‚
åœ¨ä¸€æ£µåŸºç¯æ ‘ä¸Šé€‰ä¸€äº›ç‚¹ï¼Œä½¿å¾—å¯¹äºè¢«é€‰é›†åˆä¸­çš„**æ¯ä¸€ä¸ª**ç‚¹éƒ½æœ‰è‡³å°‘ä¸€ä¸ª**ä¸å…¶ç›¸è¿çš„ä¸”ä¸åœ¨è¢«é€‰é›†åˆä¸­**çš„ç‚¹ã€‚
### é¢˜ç›®æ€è·¯
é‡åˆ°åŸºç¯æ ‘æˆ‘ä»¬é¦–å…ˆè‚¯å®šæƒ³ç€**åœ¨ç¯ä¸Šæ–­è¾¹**ï¼Œç„¶åå†æ–­çš„è¾¹çš„å·¦å³ç«¯ç‚¹åšæ ‘å½¢åŠ¨è§„ã€‚æˆ‘ä»¬è€ƒè™‘è¿æ¥**å•å‘è¾¹**ã€‚è¿æ¥å•å‘è¾¹åï¼Œå…¶å®è¿™é“é¢˜å°±å˜å¾—å¾ˆå¥½åšäº†ã€‚

é¦–å…ˆæˆ‘ä»¬è€ƒè™‘æ‰¾ç¯ï¼Œ~è¿™é‡Œé¢å‘æ–°æ‰‹ï¼Œå¤§ä½¬å¯ä»¥ä¸çœ‹~ã€‚

å¯¹äºä¸€ä¸ªå•å‘å›¾æ¥è¯´ï¼Œä¸€ä¸ªç‚¹å¦‚æœè¢«èµ°äº†ä¸¤æ¬¡é‚£ä¹ˆå®ƒå°±ä¸€å®šå†ç¯ä¸Šï¼Œå› ä¸ºå¯¹äºä¸€ä¸ªç¯æ¥è¯´ï¼Œç¯ä¸Šçš„æ¯ä¸ªç‚¹éƒ½ä¼šè¢«èµ°**æ— æ•°æ¬¡**ï¼Œè€Œä¸åœ¨ç¯ä¸Šçš„ç‚¹åªä¼šèµ°**ä¸€æ¬¡**ï¼Œæ‰€ä»¥åˆ¤æ–­ç¯çš„æ—¶å€™ï¼Œåªéœ€æ‰¾ä¸€ä¸ªç‚¹å‡ºç°**ä¸¤æ¬¡**ï¼Œåˆ™å®ƒ**å¿…åœ¨ç¯**ä¸Šï¼Œåˆ™**å®ƒçš„çˆ¶äº²**ä¹Ÿåœ¨ç¯ä¸Šã€‚

ç°åœ¨ç»™å‡ºæ‰¾ç¯çš„ä»£ç ã€‚

```cpp
int dfs(int x,int y)
{
	v[x]=1;//æ ‡è®°è¯¥ç‚¹ 
	if(v[vu[x]]==1) return x;//å½“å‡ºç°è¿‡ä¸¤æ¬¡åè¿”å›å½“å‰å€¼ 
	return dfs(vu[x],x);//å¦åˆ™ç»§ç»­é€’å½’ 
} 
```

æ¥ä¸‹æ¥æˆ‘ä»¬å°±çŸ¥é“åœ¨å“ªä¸¤ä¸ªä¹‹é—´æ–­è¾¹äº†ã€‚

é‚£ä¹ˆæˆ‘ä»¬å°±å¾—å¼€å§‹åšæ ‘å½¢åŠ¨è§„äº†ã€‚

æˆ‘ä»¬è®¾ $dp_{i,0}$ è¡¨ç¤ºå¦‚æœä¸é€‰æ‹©å½“å‰ç»“ç‚¹çš„æœ€å¤§è´¡çŒ®ï¼Œè®¾ $dp_{i,1}$ è¡¨ç¤ºå¦‚æœé€‰æ‹©å½“å‰ç»“ç‚¹çš„æœ€å¤§è´¡çŒ®ã€‚

å…ˆè€ƒè™‘ $dp_{i,0}$ï¼Œå¯¹äºä¸é€‰æ‹©å½“å‰ç»“ç‚¹çš„æƒ…å†µï¼Œåˆ™æ­¤ç»“ç‚¹çš„å„¿å­æœ‰ä¸¤ç§é€‰æ‹©ï¼Œè¦ä¹ˆé€‰è¦ä¹ˆä¸é€‰åˆ™å¯¹äº $dp_{i,0}$ï¼Œå®ƒçš„åŠ¨è§„æ–¹ç¨‹å°±æ˜¯ $dp_{i,0} = dp_{i,0} + \operatorname{max}(dp_{son,0},dp_{son,1})$ã€‚

æ¥ä¸‹æ¥è€ƒè™‘ $dp_{i,1}$ï¼Œå¯¹äºé€‰æ‹©æ­¤ç»“ç‚¹çš„æƒ…å†µï¼Œåˆ™æ­¤æ—¶ä¸ $dp_{i,0}$ æƒ…å†µå·®ä¸å¤šï¼Œä½†æ˜¯æˆ‘ä»¬**å¿…é¡»æ³¨æ„**ï¼Œæ­¤æ—¶æˆ‘ä»¬**ä¸èƒ½**æŠŠå®ƒçš„å„¿å­å…¨é€‰äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦åœ¨ $dp_{i,0}$ çš„åŸºç¡€ä¸‹å‡å»æœ€å°çš„ $\operatorname{max}(dp_{son,0},dp_{son,1})-dp_{son,1}$ï¼Œè€Œä¸”å› ä¸ºæˆ‘ä»¬å½“å‰æ­¤ç‚¹é€‰æ‹©äº†ï¼Œæ‰€ä»¥è¿˜è¦**åŠ ä¸€**ã€‚

ä¸‹é¢ç»™å‡ºæ ‘å½¢åŠ¨è§„ä»£ç ã€‚

```cpp
void dfs2(int x)
{
	v[x]=1;//æ³¨æ„è¿™é‡Œæ ‡è®°ä¸€ä¸‹ï¼Œä¸ç„¶ä¼šè¶…æ—¶ 
	dp[x][0]=0;
	dp[x][1]=0;//æ¸…0 
	int fk=0;
	long long mi=0x3f3f3f3f; 
	for(int i=0;i<g[x].size();i++)
	{
		int son=g[x][i];
		if(son==a1) dp[son][1]=-0x3f3f3f3f;//å¦‚æœæ­¤æ—¶æšä¸¾åˆ°äº†ç¯ä¸Šçš„ç»“ç‚¹ï¼Œç»™å®ƒæ ‡è®°æœ€å° 
		else
		{
			dfs2(son);
			mi=min(mi,max(dp[son][1],dp[son][0])-dp[son][0]);//è¿™é‡Œå–æœ€å° 
			dp[x][0]+=max(dp[son][1],dp[son][0]); 
		}	
	} 
	dp[x][1]=dp[x][0]+1-mi;//è½¬ç§»æ–¹ç¨‹ 
} 
```
æœ€ç»ˆç»™å‡ºå…¨éƒ¨çš„ä»£ç ã€‚

```cpp
#include<bits/stdc++.h>
using namespace std;
int tot,n,u,vu[1050000],a1,E,a2,head[1000005];
int v[1000005];
vector<int> g[1000005]; 
long long dp[1000005][2];
long long au;
int dfs(int x,int y)
{
	v[x]=1;//æ ‡è®°è¯¥ç‚¹ 
	if(v[vu[x]]==1) return x;//å½“å‡ºç°è¿‡ä¸¤æ¬¡åè¿”å›å½“å‰å€¼ 
	return dfs(vu[x],x);//å¦åˆ™ç»§ç»­é€’å½’ 
} 
void dfs2(int x)
{
	v[x]=1;//æ³¨æ„è¿™é‡Œæ ‡è®°ä¸€ä¸‹ï¼Œä¸ç„¶ä¼šè¶…æ—¶ 
	dp[x][0]=0;
	dp[x][1]=0;//æ¸…0 
	int fk=0;
	long long mi=0x3f3f3f3f; 
	for(int i=0;i<g[x].size();i++)
	{
		int son=g[x][i];
		if(son==a1) dp[son][1]=-0x3f3f3f3f;//å¦‚æœæ­¤æ—¶æšä¸¾åˆ°äº†ç¯ä¸Šçš„ç»“ç‚¹ï¼Œç»™å®ƒæ ‡è®°æœ€å° 
		else
		{
			dfs2(son);
			mi=min(mi,max(dp[son][1],dp[son][0])-dp[son][0]);//è¿™é‡Œå–æœ€å° 
			dp[x][0]+=max(dp[son][1],dp[son][0]); 
		}	
	} 
	dp[x][1]=dp[x][0]+1-mi;//è½¬ç§»æ–¹ç¨‹ 
} 
int main()
{
	memset(head,-1,sizeof head);
	cin>>n;
	for(int i=1;i<=n;i++)
	{
		scanf("%d",&u);
		vu[i]=u;
		g[u].push_back(i);//å•é¡¹è¾¹ 
	}
	for(int i=1;i<=n;i++)
	{
		if(v[i]==1) continue;
		a1=dfs(i,-1);
		dfs2(a1);
		long long ans=dp[a1][0];
		ans=max(ans,dp[a1][1]); 
		a1=vu[a1];//å®ƒçˆ¶äº² 
		dfs2(a1);
		ans=max(ans,dp[a1][1]);//æ³¨æ„è¿™é‡Œä¸èƒ½ä¸å– 
		au+=ans;//æœ€åæŠŠæ‰€æœ‰ç¯çš„ç­”æ¡ˆç´¯åŠ  
	}
	cout<<au;
	return 0;
}
```

---


# 「Wdsr-1」贤者之石

## 题目背景

帕秋莉·诺蕾姬是一位擅长魔法的魔女，而炼制贤者之石便是她的日常任务。

## 题目描述

帕秋莉摆出了一个边长为 $k-1$（$k$ 个点）的正三角形点阵，每个点上**可以且只能**放一颗元素石。  

![](https://cdn.luogu.com.cn/upload/image_hosting/h84oo82e.png)

在魔界中，正三角形被认为是最美丽而稳定的图形，因此当且仅当放在点阵中的**三颗元素石构成一个正三角形**时，元素石能够被合成为一颗贤者之石。 

帕秋莉规定，假设她在边长为 $k-1$ 的点阵中**随机**选取三个点放置元素石，那么三颗元素石能够合成贤者之石的概率称为 $P_k$ 。（$P_1=0, P_2=1$）  

现在，为了能够难倒智慧的你，帕秋莉想要你求出
$$\sum_{k=m}^{+\infty}P_k$$ 
的值，其中 $m$ 是给定的整数。

## 说明/提示

#### 数据范围

$$\def\arraystretch{1.5}\begin{array}{|c|c|c|}\hline
Subtasks & \textbf{编号} & m \\ \hline
1 & [1,15] & \le 100\\\hline
2 & [16,35] & \le 500\\\hline
3 & [36,40] & \le 10^3\\\hline
4 & [41,45] & \le 10^4\\\hline
5 & [46,50] & \le 65535\\\hline
\end{array}$$

其中，$[l,r]$ 表示编号为 $l,l+1,\cdots,r-1,r$ 的测试点。

- 此外，保证 $m\ge 1$。

## 样例 #1

### 输入

```
100```

### 输出

```
2.0003x10^-2```

## 样例 #2

### 输入

```
114```

### 输出

```
1.7546x10^-2```

## 样例 #3

### 输入

```
223```

### 输出

```
8.9689x10^-3```

# 题解

## 作者：NaCly_Fish (赞：9)

这是一篇全程乱搞的题解，，

首先可以打出这样一个暴力求 $n$ 个点三角阵中，能组成正三角形的个数 $a_n$：

```cpp
inline double dist(node a,node b){
    double dx = a.x-b.x,dy = a.y-b.y;
    return sqrt(dx*dx+dy*dy);
}

int n,cnt = 1;
int ans;

int main(){
    double sy = 0,sx = 0,d1,d2,d3;
    scanf("%d",&n);
    a[1] = node(0,0);
    for(int i=2;i<=n;++i){
        sy -= sqrt(3)/2,sx -= 0.5;
        for(int j=0;j!=i;++j)
           a[++cnt] = node(sx+j,sy); 
    }
    for(int i=1;i<=cnt;++i)
    for(int j=i+1;j<=cnt;++j)
    for(int k=j+1;k<=cnt;++k){
        d1 = dist(a[i],a[j]),d2 = dist(a[i],a[k]),d3 = dist(a[j],a[k]);
        if(fabs(d1-d2)<eps&&fabs(d2-d3)<eps&&fabs(d1-d3)<eps) ++ans;
    }
    printf("%d",ans);
}
```

由于总共选的方案数为 
$$b_n= \binom{n(n+1)/2}{3}$$
$$=\frac{n^6+3n^5-3n^4-11n^3+2n^2+8n}{48}$$
是一个六次多项式，所以 $a_n$ 一定是低于六次的多项式，拉格朗日插值可以求出

$$a_n= \frac{n^4 + 2n^3 - n^2 - 2n}{24}$$
再做多项式除法得到
$$p_n=\frac{2}{n^2+n-4} $$
（此式在 $n\ge 2$ 时正确）

那么问题转化为求
$$\sum_{n=0}^\infty \frac{2}{n^2+n-4}$$
我不会算，wolframalpha 了一下得出答案是
$$\frac{2\pi \tan\left(\frac{\sqrt{17}}{2} \pi \right)}{\sqrt{17}}$$
然后暴力减去前 $m$ 项的值即可，时间复杂度 $\Theta(m)$。  
ps：这个东西的前缀和，可以用几个 Gamma 函数来表示，似乎是 $\Theta(1)$ 的？

```cpp
#pragma GCC optimize (2)
#pragma GCC optimize ("unroll-loops")
#include<cstdio>
#include<iostream>
#include<cmath>
#define double long double
using namespace std;

const double pi = acos(-1);

inline double f(double x){
    return 2/(x*(x+1)-4);
}

double ans = (2*pi*tan(sqrt(17)*pi/2))/sqrt(17);
int n,cnt;

int main(){
    scanf("%d",&n);
    for(register int i=0;i!=n;++i) ans -= f(i);
    while(ans<1) ans *= 10,--cnt;
    while(ans>10) ans /= 10,++cnt;
    printf("%.4Lfx10^%d",ans,cnt);
}
```
~~于是这题就被我们不带脑子干掉了~~

---

## 作者：囧仙 (赞：6)

啊，这是美⑨出的第一道题，笔法略差，多多包涵。

（感谢ysj大佬完善的题面，原题面在此：[here](https://www.luogu.com.cn/problem/U111813)）

如果你没有思路，你可以通过电脑枚举k个点的情况，然后看结果找规律，如果您够~~无耻~~睿智，可以丢到oeis上查一下，然后真的能查到，[对方一脸嫌弃的给你了个链接](http://oeis.org/A000332)。

~~或者你可以直接看样例找规律，你就是拉马努金！（暴论~~

当然还是要给出严谨做法的。。

首先我们来看如何确定点阵中的正三角形。

点阵里的正三角形有两种：

![](https://patchoulii-knowledge.github.io/post-images/1585618934094.png)

第一种就是类似于$\bigtriangleup XYZ$这样的。

第二种就是类似于$\bigtriangleup DEF$这样的。

我们发现$\bigtriangleup DEF$ 可以唯一确定一个$\bigtriangleup XYZ$

那么 $\bigtriangleup DEF$就是$\bigtriangleup XYZ$的确定条件再加一个条件。

不可避免的我们就要找到$\bigtriangleup XYZ$的确定条件。

那咋搞呢？ 我们可以 **投影** 啊！！

把三角形的三边投影到大三角形的底边上！类似这样的：

![](https://patchoulii-knowledge.github.io/post-images/1585619505762.png)

这样你就可以用$(P,Q,R)$ 来确定一个三角形啦！

但是还有一个小问题。。。就是那个大的三角形（就是$\bigtriangleup ABC$）有可能会锅。。。（$P,Q$两点重合）

当然你组合好的话仍然可以整，对于我这样的渣渣想不出来咋办呢？

那我们可以延长啊，延长$AB,AC$至$B',C'$，使得$BB'=1,CC'=1$，这时$B'C'$上有$k+1$个点。

那不就完了，来，看图：

![](https://patchoulii-knowledge.github.io/post-images/1585619894874.png)

诶，是不是完美的解决了问题？

这样你就可以用$(P,Q,R)$ 来确定$\bigtriangleup XYZ$啦！

$P,Q,R$ 这条边上有$k+1$ 个，所以 $\bigtriangleup XYZ$ 这样的三角形有 $C_{k+1}^3$ 个。

那$\bigtriangleup DEF$这样的三角形是不是可以进行一样的操作呢？

答案是肯定的！来，看图：

![](https://patchoulii-knowledge.github.io/post-images/1585620194300.png)

这样你就可以用$(P,Q,O,R)$ 来确定$\bigtriangleup DEF$啦！

同理，$\bigtriangleup DEF$ 这样的三角形有 $C_{k+1}^4$ 个。

那结果就很显然啦：
$$
P_k=\frac{C_{k+1}^{3}+C_{k+1}^{4}}{C_{\frac{k\left( k+1 \right)}{2}}^{3}}=\frac{C_{k+2}^{4}}{C_{\frac{k\left( k+1 \right)}{2}}^{3}}=\frac{2}{k^2+k-4}
$$

本来美⑨是想到这里为止了，但是作为T2，这实在是太水啦！于是她有一个大胆的想法。。就有了这一题。


所以她想用两个小问，第一小问求$P_k$。。蛋是，ysj巨神告诉我：

![](https://patchoulii-knowledge.github.io/post-images/1585706619445.png)

于是就算了，虽然这个式子有点珂怕，但是你仍然珂以骗到分

放缩：
$$
\sum_{k=m}^{\infty}{\frac{2}{k^2+k-4}}>2\sum_{k=m}^{\infty}{\frac{1}{k^2+k}}=2\sum_{k=m}^{\infty}{\frac{1}{k}-\frac{1}{k+1}=\frac{2}{m}}
$$
$$
\sum_{k=m}^{\infty}{\frac{2}{k^2+k-4}}<2\sum_{k=m}^{\infty}{\frac{1}{k^2+k-6}}=2\sum_{k=m}^{\infty}{\frac{1}{5}\left( \frac{1}{k-2}-\frac{1}{k+3} \right) =\frac{2}{5}\left( \frac{1}{m-2}+\frac{1}{m-1}+\frac{1}{m}+\frac{1}{m+1}+\frac{1}{m+2} \right)}
$$

骗分其实很好骗，你输出$\frac{2}{m}$ 就好了。。。那么大数据的那几个点的分你有了。。

（P.S. 其实这道题数据小的点比较难搞。一开始骗分能骗到76分！！然后美⑨加强了数据，本来想加强精度的，比如保留⑨位有效数字什么的，但是既然ysj说算了别卡了，那就算了）

我们可以参照上面的思路，强行裂项！！！


下面需要一些数学技巧。。你可以先百度一下PolyGamma函数

$$
\sum_{k=m}^{\infty}{\frac{2}{k^2+k-4}}=2\sum_{k=m}^{\infty}{\frac{1}{\left( k+\frac{1+\sqrt{17}}{2} \right) \left( k+\frac{1-\sqrt{17}}{2} \right)}}=\frac{2}{\sqrt{17}}\sum_{k=m}^{\infty}{\left( \frac{1}{k+\frac{1-\sqrt{17}}{2}}+\frac{1}{k+\frac{1+\sqrt{17}}{2}} \right)}
$$
$$
=\frac{2}{\sqrt{17}}\left[ \psi \left( \frac{1+\sqrt{17}}{2}+m \right) -\psi \left( \frac{1-\sqrt{17}}{2}+m \right) \right] 
$$

介个东西好像不好搞啊。。

我们回忆一下余元公式，两边求导试试？（这个不会的私信我把。。或者你百度一下余元公式？）


那么可以推导出
$$
\psi \left( x \right) -\psi \left( 1-x \right) =-\frac{\pi}{\tan \pi x}
$$

到时候我会补锅，你们先凑合看看这个吧：

[洛谷上的博客](https://www.luogu.com.cn/blog/you-xiao-mei-jiu/qian-xi-euler-ji-fen)

[GitHub上的博客](https://patchoulii-knowledge.github.io/post/qian-xi-g-han-shu/)

想要凑出ao的结果，那就令

$$
\left( \frac{1+\sqrt{17}}{2}+m \right) +\left( \frac{1-\sqrt{17}}{2}+m \right) =0
$$

那就很容易得出 $m=0$

那我们令$m=0$ 看看？

$$
\sum_{k=0}^{\infty}{\frac{2}{k^2+k-4}}=\frac{2}{\sqrt{17}}\left[ \psi \left( \frac{1+\sqrt{17}}{2} \right) -\psi \left( \frac{1-\sqrt{17}}{2} \right) \right] =-\frac{2}{\sqrt{17}}\frac{\pi}{\tan \left( \pi \left( \frac{1+\sqrt{17}}{2} \right) \right)}=\frac{2\pi}{\sqrt{17}}\tan \left( \frac{\sqrt{17}}{2}\pi \right) 
$$

啊呀，好看的一逼那是。

那就很好搞了。。

$$
\sum_{k=m}^{\infty}{\frac{2}{k^2+k-4}}=\sum_{k=0}^{\infty}{\frac{2}{k^2+k-4}}-\sum_{k=0}^{m-1}{\frac{2}{k^2+k-4}}=\frac{2\pi}{\sqrt{17}}\tan \left( \frac{\sqrt{17}}{2}\pi \right) -\sum_{k=0}^{m-1}{\frac{2}{k^2+k-4}}
$$

但是有一个小坑啊。。$P_1=0$ 而不是 $-1$

那我们把它挖掉就好惹：
$$
Ans=\frac{2\pi}{\sqrt{17}}\tan \left( \frac{\sqrt{17}}{2}\pi \right) +\frac{3}{2}-\sum_{k=2}^{m-1}{\frac{2}{k^2+k-4}}
$$
$$
=1.7984105510168780039-\sum_{k=2}^{m-1}{\frac{2}{k^2+k-4}}
$$
完了？ 完了！

（p.s. 其实不用挖掉，我当时思博了）

代码太丑不放了。。


---

## 作者：junyu33 (赞：6)

**这道题代码量极短，思维难度还可以，实属一道不错的MO+mathematica的~~毒瘤~~签到题。**

首先先解决那个概率，通过 [这里](http://zujuan.xkw.com/11q7619187.html) 很容易发现这是一道MO题，答案是$\frac{2}{n*n+n-4}$.

附解析：
![](https://s1.ax1x.com/2020/04/09/G45538.png)

然后可以打开mma,对这个式子进行无穷累加，得到：

![](https://s1.ax1x.com/2020/04/09/G4hhVI.jpg)

当然，如果你闲式子难得打，你可以使用浮点结果：

![](https://s1.ax1x.com/2020/04/09/G44iM4.png)

但直接代入数据会出一点锅，要把f[1]加入常数中，再把常数代入减去2~m-1的值即可。

最后的科学计数法谁都会写了吧。

```cpp
/*
 * @Author: junyu33 
 * @Date: 2020-04-09 13:03:49 
 * @Last Modified by:   junyu33 
 * @Last Modified time: 2020-04-09 13:03:49 
 */
#include <bits/stdc++.h>
using namespace std;
typedef long double ld;
const ld con=1.79841055101687800387;
int m,zhi;ld delta;
int main(){
   scanf("%d",&m);
   for(ld i=2;i<m;i++) delta+=2.0/(i*i+i-4);
   ld ans=con-delta;
   while(ans<1) zhi--,ans*=10;
   printf("%.4Lfx10^%d",ans,zhi);
   return 0;
}
```


---

## 作者：JohnVictor (赞：3)

先 % 一下出题人。太神仙了，不过我不知道那个积分，我们也可以通过估计的做法切掉这道水题。

首先计算出 $P_k$。

选出三个点的方法数是 $C_{1+2+\cdots+k}^3$。

而如何才能构成一个等边三角形呢？（这里没有图，抱歉需要自行脑补）

首先，设这个等边三角形为 $ABC$，过 $A,B,C$ 作原三角形三边的平行线，得到一个等边三角形 $DEF$。注意这个等边三角形的方向要和原来的相同，就是说不能转 $180$ 度什么的。那么通过初中几何知识可以证明边上三个三角形是全等的，~~读者自证不难（真的不难）~~。

那么考虑每个三边平行于原等边三角形的等边三角形，如果它的边长为 $l$，那么可以对应到 $l$ 个等边三角形。而这样的等边三角形，在边长为 $n$ 的等边三角形中，恰好有 $1+2+\cdots+(n-l)$ 个。所以一共有 

$$\frac{1}{2}\sum_{i=1}^ni(n-i)^2+\frac{1}{2}\sum_{i=1}^{n}i(n-i)$$

前一个和式的两倍
$$=\frac{n(n+1)}{2}\times n^2-2n(1^2+2^2+\cdots+n^2)+(1^3+2^3+\cdots+n^3)$$


$$=n\times\frac{n(n+1)}{2}(n-\frac{2}{3}(2n+1)+\frac{n+1}{2})=\frac{n^2(n-1)(n+1)}{12}$$

后面一个和式等于 $\frac{n(n+1)(n-1)}{12}$。

所以边长为 $n$ 时就等于

$$\frac{\frac{n^2(n-1)(n+1)}{24}+\frac{n(n+1)(n-1)}{12}}{\frac{n(n+1)(n-1)(n+2)(n^2+n+4)}{48}}=\frac{2}{n^2+n+4}$$

然后由于出题人的神仙解法太神仙了，蒟蒻不会，所以给出乱搞做法：

如果加到正无穷的话，那么这个值大概就是 $\sum_{n \ge m}\frac{2}{n(n+1)}=\frac{2}{n}$。这是一个上界，如果放缩成 $\sum_{n \ge m}\frac{2}{(n+1)(n+2)}=\frac{2}{n+1}$。

所以我们能够得到什么？

答案大概是 $10^{-5}$ 级别的，我们给出的放缩的误差是 $O(\frac{1}{n^2})$ 的。那么我们假设 $\sum_{n \ge 2\times 10^7}{P_n}=10^{-7}$（这样误差 $10^{-14}$ 刚好达到 `long double` 的极限），并且反着加回来加到 $65536$ 作为一个常数。这样就可以在 $O(65536)$ 的时间内得到答案。注意特判的问题，就能够 `AC` 了。 

---

## 作者：lailai0916 (赞：2)

## 原题链接

- [洛谷 P6307 「Wdsr-1」贤者之石](https://www.luogu.com.cn/problem/P6307)

## 参考资料

- [双伽玛函数 - 维基百科](https://zh.wikipedia.org/wiki/双伽玛函数)

## 解题思路

定义点阵的大小为正三角形底边点的个数，即边长 $+1$。

令 $a_n$ 表示大小为 $n$ 的点阵包含的总点数，可以通过组合公式得出：

$$
a_n=\frac{n(n+1)}{2}
$$

在大小为 $k$ 的点阵中，任意选取 $3$ 个点的总方案数为 $C_{a_k}^3$。

如图所示，考虑大小为 $i$ 的正三角形框（图中为 $i=7$）：

![](https://cdn.luogu.com.cn/upload/image_hosting/bqqdb2l4.png)

在这种大小为 $i$ 的三角形框中，三边对应位置的任意三个点可以构成一个正三角形。因此，每个大小为 $i$ 的三角形框包含 $i-1$ 个正三角形。

对于大小为 $i$ 的三角形框，其顶点可以位于大小为 $k-i+1$ 的点阵中，这样的点阵包含 $a_{k-i+1}$ 个顶点。因此，每个大小为 $i$ 的三角形框总共有 $a_{k-i+1}$ 个位置可以被选取。

因此：

$$
\begin{aligned}
  P_k &= \frac{\sum_{i=1}^{k}(i-1)a_{k-i+1}}{C_{a_k}^{3}} \\
  &= \frac{\sum_{i=1}^{k}(i-1)(k-i+1)(k-i+2)\cdot \frac{1}{2}}{\frac{k(k+1)}{2}(\frac{k(k+1)}{2}-1)(\frac{k(k+1)}{2}-2)\cdot\frac{1}{6}} \\
  &= \frac{24\sum_{i=1}^{k}(i-1)(k-i+1)(k-i+2)}{k(k+1)(k(k+1)-2)(k(k+1)-4)} \\
  &= \frac{24(-k^3-3k^2-2k+\sum_{i=1}^{k}i^3-(2k+4)\sum_{i=1}^{k}i^2+(k^2+5k+5)\sum_{i=1}^{k}i}{k(k+1)(k^2+k-2)(k^2+k-4)} \\
  &= \frac{2(k^4+2k^3-k^2-2k)}{(k^4+2k^3-k^2-2k)(k^2+k-4)} \\
  &= \frac{2}{k^2+k-4}
\end{aligned}
$$

令 $r_1,r_2$ 为 $k^2+k-4$ 的两个根：

$$
r_1=\frac{-1+\sqrt{17}}{2},r_2=\frac{-1-\sqrt{17}}{2}
$$

则：

$$
\begin{aligned}
  \sum_{k=m}^{\infty}P_k &= \sum_{k=m}^{\infty}\frac{2}{k^2+k-4} \\
  &= \sum_{k=m}^{\infty}\frac{2}{(k-r_1)(k-r_2)} \\
  &= \frac{2}{\sqrt{17}}\sum_{k=m}^{\infty}\left(\frac{1}{k-r_1}-\frac{1}{k-r_2}\right) \\
  &= \frac{2}{\sqrt{17}}\lim_{n\to\infty}\left(\sum_{k=m}^{n}\frac{1}{k-r_1}-\sum_{k=m}^{n}\frac{1}{k-r_2}\right) \\
  &= \frac{2}{\sqrt{17}}\lim_{n\to\infty}\left((\psi(n-r_1+1)-\psi(m-r_1))-(\psi(n-r_2+1)-\psi(m-r_2))\right) \\
  &= \frac{2}{\sqrt{17}}\left(\psi(m-r_2)-\psi(m-r_1)+\lim_{n\to\infty}\left(\psi(n-r_1+1)-\psi(n-r_2+1)\right)\right) \\
  &= \frac{2}{\sqrt{17}}\left(\psi(m-r_2)-\psi(m-r_1)+\lim_{n\to\infty}\left(\left(\psi(1)+\sum_{k=1}^{n-r_1}\frac{1}{k}\right)-\left(\psi(1)+\sum_{k=1}^{n-r_2}\frac{1}{k}\right)\right)\right) \\
  &= \frac{2}{\sqrt{17}}\left(\psi(m-r_2)-\psi(m-r_1)+\lim_{n\to\infty}\sum_{k=n-r_2+1}^{n-r_1}\frac{1}{k}\right) \\
  &= \frac{2}{\sqrt{17}}\left(\psi(m-r_2)-\psi(m-r_1)+0\right) \\
  &= \frac{2}{\sqrt{17}}\left(\psi\left(m-\frac{-1-\sqrt{17}}{2}\right)-\psi\left(m-\frac{-1+\sqrt{17}}{2}\right)\right) \\
  &= \frac{2}{\sqrt{17}}\left(\psi\left(m+\frac{1+\sqrt{17}}{2}\right)-\psi\left(m+\frac{1-\sqrt{17}}{2}\right)\right) \\
\end{aligned}
$$

其中 $\psi(x)$ 是 Digamma 函数，其定义为：

$$
\psi(x)=\frac{\mathrm{d}}{\mathrm{d}x}\ln\Gamma(x)=\frac{\Gamma'(x)}{\Gamma(x)}
$$

Digamma 函数满足以下递推关系：

$$
\psi(x+1)=\psi(x)+\frac{1}{x}
$$

$\psi(x)$ 也可以用伯努利数 $B_{2k}$ 表示为：

$$
\psi(x)=\ln(x)-\frac{1}{2x}-\sum_{k=1}^{\infty}\frac{B_{2k}}{2k\cdot x^{2k}}
$$

当 $x \gg 1$ 时，Digamma 函数可以用渐近展开式近似为：

$$
\psi(x)=\ln(x)-\frac{1}{2x}-\frac{1}{12x^2}+\frac{1}{120x^4}+o(x^{-4})
$$

在 $x$ 较小时，可以通过递推关系放大。用渐进展开式求近似值。

## 参考代码

```cpp
#include <bits/stdc++.h>
using namespace std;

double digamma(double x)
{
	double res=0;
	while(x<10){res-=1/x;x++;}
	res+=log(x)-1/(x*2)-1/(x*x*12)+1/(x*x*x*x*120);
	return res;
}
int main()
{
	ios::sync_with_stdio(false);
	cin.tie(nullptr);
	int m;
	cin>>m;
	if(m==1)
	{
		cout<<"1.7984x10^0"<<'\n';
		return 0;
	}
	double r1=(1.0-sqrt(17))/2,r2=(1.0+sqrt(17))/2;
	double ans=(digamma(m+r1)-digamma(m+r2))*(-2)/sqrt(17);
	int cnt=0;
	while(ans<1){cnt--;ans*=10;}
	cout<<fixed<<setprecision(4)<<ans<<"x10^"<<cnt<<'\n';
	return 0;
}
```

---

## 作者：Hadtsti (赞：2)

### 题目分析

对像我这样数学基础差的相对友好的做法。

下文称底边水平的正三角形为“好三角形”，每边 $n$ 个点的“好三角形”为“$n$ 级好三角形”。

先考虑求 $n$ 级好三角形中的所有正三角形数量 $a_n$。为了不重不漏，我们将每个正三角形都在最小包围的好三角形中统计。具体地，我们统计的是每个“好三角形”中三个顶点都在其边上的正三角形个数。如图所示。

![](https://cdn.luogu.com.cn/upload/image_hosting/uu021kc3.png)

因此 $n$ 级好三角形中这种三角形数量为 $n-1$ 个。那么我们现在只需要求出 $n$ 级好三角形比 $n-1$ 级的多了哪些、多少个好三角形就可以算出来 $a_n-a_n-1$。形式化来说，有：

$$\begin{aligned}
a_n-a_{n-1}&=\sum_{i=1}^n(n-i+1)(i-1)\\
&=\sum_{i=1}^{n-1}(n-i)i\\
&=n\sum_{i=1}^{n-1}i-\sum_{i=1}^{n-1}i^2\\
&=\frac{(n-1)n^2}2-\frac{(n-1)n(2n-1)}6\\
&=\frac{n^3-n}6\\
\end{aligned}
$$

故：

$$\begin{aligned}
a_n&=\sum_{i=1}^n\frac{i^3-i}6\\
&=\sum_{i=1}^n\frac{(i-1)i(i+1)}6\\
&=\frac{(n-1)n(n+1)(n+2)}{24}
\end{aligned}
$$

其中最后一行由裂项得到。至此可以得出 $P_n=\frac{a_n}{\binom3{\frac{n(n+1)}2}}=\frac{a_n}{\frac16(\frac{n^2+n}2\times\frac{n^2+n-2}2\times\frac{n^2+n-4}2)}=\frac{a_n}{\frac1{48}n(n+2)(n-1)(n+2)(n^2+n-4)}=\frac2{n^2+n-4}$。

原问题即求 $\sum\limits_{i=n}^{+\infin}\frac2{i^2+i-4}$。注意到 $n$ 比较小，很容易想到先算出来 $\sum\limits_{i=2}^{+\infin}\frac2{i^2+i-4}$ 再暴力减。但我太菜了，后面这个级数不会算，怎么办呢？

考虑估计。我们发现虽然 $\frac1{i^2+i-4}$ 不能裂项来算，但是 $\frac1{i^2+i-2}=\frac1{i-1}-\frac1{i+2}$ 和 $\frac1{i^2+i-6}=\frac1{i-2}-\frac1{i+3}$ 可以。于是我们对于比较大的 $i$，使用 $\frac1{i^2+i-2}+\frac1{i^2+i-6}$ 代替 $\frac2{i^2+i-4}$，小的 $i$ 暴力去算即可。

注意到一项的误差在 $O(\frac1{i^6})$ 级别，因此从约 $1000$ 项开始估算就可以通过本题。

### 代码实现


```cpp
#include<bits/stdc++.h> 
using namespace std;
const long long v=65535;
int n,t;
long double ans;
int main()
{
	scanf("%d",&n);
	for(long long i=n;i<=v;i++)
		ans+=(long double)2.0/(i*i+i-4);
	ans+=(long double)1.0/3*(1.0/v+1.0/(v+1)+1.0/(v+2))+1.0/5*(1.0/(v-1)+1.0/v+1.0/(v+1)+1.0/(v+2)+1.0/(v+3));
	while(ans<1)
		ans*=10,t++;
	printf("%.4Lfx10^%d\n",ans,-t);
	return 0;
}
```

---

## 作者：Tjaweiof (赞：1)

# P6307 题解
[题目传送门](https://www.luogu.com.cn/problem/P6307)

首先化简一下 $p_i$。因为总方案数 $=\dfrac{n^6+3n^5-3n^4-11n^3+2n^2+8n}{48}$，合成贤者之石的方案数 $=\dfrac{n^4+2n^3-n^2-2n}{24}$。

则

$$

\begin{aligned}

&p_i\\

&=\dfrac{n^4+2n^3-n^2-2n}{24}\div\dfrac{n^6+3n^5-3n^4-11n^3+2n^2+8n}{48}\\

&=\dfrac{n^4+2n^3-n^2-2n}{n^6+3n^5-3n^4-11n^3+2n^2+8n}\times\dfrac{48}{24}\\

&=\dfrac{1}{n^2+n-4}\times2\\

&=\dfrac{2}{n^2+n-4}\\

\end{aligned}

$$

那么现在的结果就转换成求 $\sum_{i=1}^{+\infty}\dfrac{2}{n^2+n-4}-\sum_{i=1}^{m-1}\dfrac{2}{n^2+n-4}$

$\sum_{i=1}^{+\infty}\dfrac{2}{n^2+n-4}$ 本蒟蒻是真的不会算，只能 ~~看其他题解~~。

现在结果已经算出，现在考虑如何将结果转换成科学计数法。首先考虑到结果一定不会到十位数，不需要把数字右移，只需要左移。转换的过程很简单，重复执行将结果 $\times10$，每次将指数 $-1$，直到结果 $\ge1$。

## Code
```cpp
#include <bits/stdc++.h>
using namespace std;
long long m, weishu;
long double ans = 1.79841055101687800387;
int main(){
    ios::sync_with_stdio(false);
    cin.tie(0);
    cout.tie(0);
    cin >> m;
    for (long long i = 2; i < m; i++){
        ans -= 2.0 / (i * i + i - 4.0);
    }
    while (ans < 1){
        weishu--;
        ans *= 10;
    }
    cout << fixed << setprecision(4) << ans;
    cout << "x10^" << weishu;
    return 0;
}
```
**此代码时间复杂度 $O(m)$，空间复杂度 $O(1)$，完美过关！**

---


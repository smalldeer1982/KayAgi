# [HUSTFC 2023] 广义线段树

## 题目描述

对于任意长度为 $n$ 的序列 $a$，可以基于 $a$ 建立一个广义线段树。广义线段树是一个有 $(2n-1)$ 个节点的带权二叉树，对于每个编号为 $p$ 的节点，都有两个属性 $L_p$ 和 $R_p$，表示其维护的区间为 $[L_p,R_p]$，同时其权值 $M_p =\prod_{i=L_p}^{R_p}a_i$ 。另外，广义线段树还满足如下性质：
- 所有编号为 $p\in [n,2n-1]$ 的节点是叶节点，同时 $L_p = R_p = p + 1 - n$。
- 所有编号为 $p\in [1,n-1]$ 的节点是非叶节点，其必定有左儿子 $X_p$ 和右儿子 $Y_p$，且 $p < X_p < Y_p$。节点 $p$ 维护的区间为左右儿子维护区间之并，且保证维护区间连续。形式化地，有 $R_{X_p}=L_{Y_p}-1$，且 $L_p=L_{X_p}$，$R_p=R_{Y_p}$。

例如，下面是一个基于 $n=4$ 的序列 $a=\{1, 2, 3, 4\}$ 建立的广义线段树（节点内整数对 $(p,M_p)$ 分别表示编号和权值）。可以发现，广义线段树的形态并不唯一。

![1](https://cdn.luogu.com.cn/upload/image_hosting/de71i68l.png)

对这个广义线段树而言：
- $[L_7, R_7] = [4, 4]$，故 $M_7 = a_4$
- $[L_6, R_6] = [3, 3]$，故 $M_6 = a_3$
- $[L_5, R_5] = [2, 2]$，故 $M_5 = a_2$
- $[L_4, R_4] = [1, 1]$，故 $M_4 = a_1$
- $[L_3, R_3] = [L_4, R_5] = [1, 2]$，故 $M_3 = a_1 \times a_2$
- $[L_2, R_2] = [L_3, R_6] = [1, 3]$，故 $M_2 = a_1 \times a_2 \times a_3$
- $[L_1, R_1] = [L_2, R_7] = [1, 4]$，故 $M_1 = a_1 \times a_2 \times a_3 \times a_4$

分别给定长度为 $n$ 的序列 $a$，$b$ 以及节点数为 $(2n-1)$ 的广义线段树 $T$ 的形态（即每个节点的左右儿子编号），然后你需要执行 $n$ 次操作，第 $i$ 次操作为将 $a_i$ 变成 $a_i\times b_i$。

每次操作结束后，你需要基于修改后的序列 $a$ 建立与 $T$ 形态相同的广义线段树，并求出所有节点的权值和，即 $\sum_{i=1}^{2n-1}M_i$。由于结果可能会非常大，你只需要求出其对 $998\,244\,353$ 取模后的值。

## 说明/提示

样例中广义线段树的形态和题面中的例子相同。

第一次修改后，$a_1$ 变为 $a_1 \times b_1 = 1 \times 2 = 2$，因而新的 $a = \{2, 2, 3, 4\}$。可以计算出：
- $M_7 = a_4 = 4$
- $M_6 = a_3 = 3$
- $M_5 = a_2 = 2$
- $M_4 = a_1 = 2$
- $M_3 = a_1 \times a_2 = 2 \times 2 = 4$
- $M_2 = a_1 \times a_2 \times a_3 = 2 \times 2 \times 3 = 12$
- $M_1 = a_1 \times a_2 \times a_3 \times a_4 = 2 \times 2 \times 3 \times 4 = 48$

故权值之和为 $M_1 + M_2 + \ldots + M_7 = 75$。

第二次修改后，$a_2$ 变为 $a_2 \times b_2 = 2 \times 3 = 6$。后续的操作与第一次操作类似，此处不再赘述。

## 样例 #1

### 输入

```
4
1 2 3 4
2 3 2 3
2 7
3 6
4 5
```

### 输出

```
75 207 390 974 ```

# 题解

## 作者：jiangxinyang2012 (赞：4)

做这题做的人都傻了。

我们发现题目中的修改操作在线段树上其实就是一个从叶子到根的路径修改。

如图是一种将样例中 $5$ 号节点乘 $2$ 时广义线段树上修改的路径。

![](https://cdn.luogu.com.cn/upload/image_hosting/326ezw4p.png)

由于广义线段树是一棵树，所以直接在上面树链剖分就好了。

[code](https://www.luogu.com.cn/paste/fnnrcesw)

时间复杂度 $O(n\log^2 n)$，可以通过。

---

## 作者：sky_chen (赞：2)

【HUSTACM】此题解为官方题解。

可以注意到，修改 $A_i$ 的值只会影响对应叶节点到根节点路径上所有节点的权值。直接模拟是 $O(\sum_{i = 1}^n h_i) = O(n^2)$ 的（$h_i$ 为点 $i$ 深度），因而无法通过本题。

重要结论：由于线段树的编号性质，**修改 $A_i$ 的顺序恰好和线段树的先序遍历访问叶节点的顺序相同**。这对本题的广义线段树同样适用。

结合上述两点，我们可以用先序遍历解决本问题。

首先，建立**静态**广义线段树 `aseg` 和 `bseg`，分别维护由原序列 $\{A_n\}, \{B_n\}$ 生成的广义线段树的各节点权值。我们在之后不修改 `aseg` 和 `bseg`。

在先序遍历时，我们维护当前节点到根节点路径上（包括自身）所有节点权值之和 `sum` 和答案 `ans`。

* 进入节点 `p` 时，有 `sum += aseg[p]`。
* 到达叶节点进行修改时，有 `new_sum = sum * b[i]` 和 `new_ans = ans - sum + newsum`。计算后，输出 `new_ans` 作为答案。
* 退出节点 `p` 时，有 `sum -= aseg[p] * bseg[p]`。
  * 这是因为退出节点 `p` 时，`p` 控制区间的所有叶节点的 `a[i]` 都已经访问过了（都乘上了 `b[i]`），因此当前点 `p` 的权值就是控制区间内所有 `a[i]` 和 `b[i]` 的乘积。

时间复杂度为 $O(n)$。



---


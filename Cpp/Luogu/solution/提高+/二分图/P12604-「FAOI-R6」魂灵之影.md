# 「FAOI-R6」魂灵之影

## 题目背景

此题因撞题已移出 FAOI Round 6.

> Draw me to the light, let the curse be lifted  
We can rise above the roar  
With the bite of every devil  
We've felled before  
Drown them out  
Let the fog give way to clarity  
There is power in the strain of every drop I bleed  
I am the venom and the cure  
Take me  
Through the fear, through the heart that's broken  
Our world lies in wait for me  
Every tear, every scar left open  
This is the taming of the beast  
I'll end this war you started  
I'll stitch this wound with bloodshed  
You are my wicked victory  

<https://music.163.com/#/song?id=2672191019>

## 题目描述

给定一个无向**连通**图，边带权，可能存在重边自环。有 $q$ 次查询，每次给定 $x,y,z$，求所有以 $x$ 为起点，$y$ 为终点的路径（不要求为简单路径）中，边权和 $\bmod\ z$ 的最小值是多少。

### 交互方式

**本题为交互题，只支持 C++ 语言提交，并且不支持 C++14 (GCC 9)。**

你需要编写以下三个函数：

```cpp
void Ready(int T, int subtask_id)
```

该函数在每个测试点中仅会调用一次，两个参数表示该测试点的数据组数和子任务编号。样例的子任务编号为 $-1$。

```cpp
void Set(int n, int m, int q, vector <int> u, vector <int> v, vector <int> w)
```

在调用 `Ready` 之后，该函数会（在每个测试点中）被调用 $T$ 次，其中 $n,m$ 分别表示图的边数和点数。$u,v,w$ 的大小均为 $m$，$u[i],v[i],w[i]$ 表示图的一条边。

```cpp
int Go(int x, int y, int z)
```

每次调用 `Set` 之后，该函数会（在每组数据中）被调用 $q$ 次，每次调用表示一次查询。返回值应为本次查询的答案。

你可以直接以下发文件中的 `template.cpp` 为基础编写。

## 说明/提示

#### 【样例解释】

对于第 $1$ 组数据的唯一一组询问，所有路径均形如 $1\to 2\to 1\to \dots \to 1\to 2$，可以证明所有路径的权值均为 $1$。

对于第 $2$ 组数据的唯一一组询问，路径 $1\to 2\to 3$ 权值为 $2\bmod 2=0$，路径 $1\to 3$ 的答案为 $1\bmod 2=1$，所以答案为 $0$。

#### 【数据范围】

对于 $100\%$ 的数据，$0\le T\le 1.5 \times 10^4$，$-1 \le \text{subtask\_id} \le 9$，$0\le n,m,q\le 10^6$，$1\le u,v,x,y\le n$，$0\le w\le 10^9$，$1\le z\le 10^9$，保证图连通。

请下载附件中的 `judge_result.jpeg` 以了解交互库所占用资源的规模。如果你不想下载附件的话，我们在这里用一句话概括一下：保证交互库的运行时间不超过 0.15 秒，占用的内存不超过 60 MB。

**本题开启子任务捆绑测试。**

- Subtask 0 - Subtask 4（10 pts）：$n,m,q,w,z\le 10$，$T \le 1.5 \times 10^4$。
  - Subtask 0（2 pts）：$n=0$。
  - Subtask 1（2 pts）：$n=1$。
  - Subtask 2（1 pts）：$n=2$，$m \le 3$。
  - Subtask 3（4 pts）：$n \le 4$，$m \le 6$，$w \le 8$。
  - Subtask 4（1 pts）：在 Subtask 0 - Subtask 4 下无特殊限制。
- Subtask 5 - Subtask 9（90 pts）：$n,m,q\le 10^6$，$w,z \le 10^9$，$T=1$。
  - Subtask 5（20 pts）：$n,m,q,w,z\le 100$。
  - Subtask 6（20 pts）：$n,m,q,w,z\le 10^3$。
  - Subtask 7（10 pts）：$w,z\le 5$。
  - Subtask 8（10 pts）：$w=1$。
  - Subtask 9（30 pts）：在 Subtask 5 - Subtask 9 下无特殊限制。


Idea：ppip，Solution：喵仔牛奶，Code：ppip，Data：035966_L3

## 样例 #1

### 输入

```
2 -1
2 1 1
1 2 1
1 2 2
3 3 1
1 2 1
2 3 1
1 3 1
1 3 2```

### 输出

```
1
0```

# 题解

## 作者：喵仔牛奶 (赞：7)

闲话：这题是 FAOI R6 原来的 C 题，5.5 交审，然后撞了 5.25 图灵杯的题 :(

## Solution

特判掉边权全为 $0$ 的情况。求出所有边权值的 $\gcd$，记为 $D$，将所有边权值除以 $D$。一条路径的真实路径为这种情况下的长度乘以 $D$。

由于一个环走 $z$ 次长度为 $0$，我们可以经过任意一个环任意次（经过一个环 $z$ 次，然后在途中插入另一个环）。记所有环长度和的 $\gcd$ 为 $d$，那么根据裴蜀定理，如果存在一条长度为 $p$ 的路径，一定存在一条长度为 $p\bmod\gcd(d,z)$ 的路径。

考虑求出 $d$。由于 $\gcd(2w_1,2w_2,c\dots,2w_m)=2$，$d\mid 2$。因此，如果存在长度为奇数的环，$d=1$，否则 $d=2$。将长度为偶数的边的两端合并为同一个点，如果不是二分图，说明存在长度为奇数的环。

我们求出了 $d$，考虑询问如何解决。分类讨论：
- $d=1$：此时 $\gcd(d,z)=1$，存在长度为 $0$ 的路径，答案为 $0$。
- $d=2$：此时图为二分图。分类讨论：
  - 若 $x,y$ 在同一部分，它们之间所有路径长度为偶数，模 $\gcd(d,z)$ 显然为 $0$，答案为 $0$。
  - 若 $x,y$ 不在同一部分，它们之间所有路径长度为奇数，若 $\gcd(d,z)=1$，答案为 $0$。否则，路径的真实长度为 $D+2Dx$（$x$ 可以为任意非负整数）。根据裴蜀定理，答案即为 $D\bmod\gcd(2D,z)$。

复杂度 $\mathcal O(n+m+q\log V)$。

---


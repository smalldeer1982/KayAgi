# Raid

## 题目背景

《算法竞赛进阶指南》给出参考代码可以在本题获得 Subtask1 中的 44 分，在部分边界条件 $n=1,2$ 下会失分。该参考代码会被特意构造的数据卡掉，无法通过所有测试点。

## 题目描述

在连续的对抗联盟失败后，帝国撤退到了最后的要塞。依靠其强大的防御系统，帝国击退了联盟的六波攻击。经过几个不眠之夜的思考，联盟将军亚瑟注意到防御系统唯一的弱点是其能源供应。该系统由 $N$ 个核电站供电，破坏其中任何一个都会使系统失效。

将军很快派出了 $N$ 名特工突袭这些电站，他们被空投到了要塞内。不幸的是，由于帝国空军的袭击，他们未能着陆到预期的位置。作为一名经验丰富的将军，亚瑟很快意识到他需要重新安排计划。他现在想知道的第一件事是，哪个特工距离任何一个电站最近。作为首席官员，你能帮助将军计算特工与电站之间的最小距离吗？

## 说明/提示

翻译来自 ChatGPT。

## 样例 #1

### 输入

```
2
4 
0 0 
0 1 
1 0 
1 1 
2 2 
2 3 
3 2 
3 3 
4 
0 0 
0 0 
0 0 
0 0 
0 0 
0 0 
0 0 
0 0```

### 输出

```
1.414
0.000```

# 题解

## 作者：THUPOST_REMAKE (赞：5)

这个题解**不介绍** Voronoi 图的具体做法，只会提供题目思路（基本等同于[本讨论区](https://www.luogu.com.cn/discuss/1089978)的详细解读版）、一些参考资料以及本题需要处理的一些坑点。

## 题意

给定 $n$ 个白色点和 $m$ 个黑色点，求出所有一白一黑的点对中的最小欧氏距离。本题中 $n=m\le 10^5$，多测。

## 思路

由于本题的点分为两类，因此原本适用于平面最近点对的分治无法做，会退化到 $O(n^2)$。

直接对白色点建立 kd-tree，然后对所有黑色点做最近邻查询的做法也不可行，因为欧氏最近邻查询的最坏复杂度还是 $O(n)$，只需要构造近似于圆的点集就能轻松卡掉。

~~通过查阅上述讨论区~~，我们得知本问题为双色最近点对（Bichromatic Closest Pair, BCP）问题，且在查阅相关论文时可以发现本问题与[欧几里得最小生成树（EMST）](https://www.luogu.com.cn/problem/P6362)可在任意维度下进行规约，本题所涉及的 2 维平面属于相对简单的情形。

对于以上两个问题，先对所有点构成的点集构造 Delaunay 三角剖分，并利用最左转线法求出其对偶图，即 Voronoi 图。以上两个过程均可在 $O(n\log n)$ 完成，其中 $n$ 为点集规模。

由于 Voronoi 图为平面图，根据欧拉公式，边数不超过 $3n-6$，因此：

- 对于 EMST 问题，直接利用所有边做最小生成树即可。
- 对于 BCP 问题，直接在 Voronoi 图中找到相邻点对异色的边中长度最短的即可。

最终的时间和空间复杂度均为 $O(n\log n)$ 的，常数稍微有一点大。

## 评测以及坑点

对于 Voronoi 图的正确性，可能需要多找几个评测链接分别测一测。

EMST 相关的：

- [luogu P1265](https://www.luogu.com.cn/problem/P1265)：暴力可过，可以写个 Prim 用作对拍
- [luogu P6362](https://www.luogu.com.cn/problem/P6362)：EMST，近期数据进行了一波大加强
- [Library Checker - Euclidean MST](https://judge.yosupo.jp/problem/euclidean_mst)：数据强度也比较强，但是造题人的 std 也被上述 luogu 新上的数据给 hack 掉了（笑）。本链接要输出具体解，需要考虑的退化情况较多，建议是上面几个都测一下。

本题相关的：

- [luogu P10459](https://www.luogu.com.cn/problem/P10459)，时限 2s，我的实现是 1.6s 左右过的。
- [luogu U582951](https://www.luogu.com.cn/problem/U582951)，时限 5s。
- [AcWing 119](https://www.acwing.com/problem/content/121/)，上面有用户提供的零散 Hack 数据，但是本链接前空间限制只有 64 MB，目前已提交工单申请改至 512 MB。测了一下应该也没别的问题。

需要处理的坑点如下：

- 多测处理很恶心，这个不赘述。
- 可能存在共点、共线的退化情况，有一些 Voronoi 图的实现在共线情况下会出错（比如我的），需要特判。这个情况求最近点对也比较简单。
- `double` 能表示的精度比 `long long` 要低，本题的测试点 6 就会卡这个，因此需要使用 `long double` 和 `sqrtl` 处理距离开根。

## 参考资料

- [本题讨论区](https://www.luogu.com.cn/discuss/1089978)
- [OI Wiki Delaunay 三角剖分/Voronoi图](https://oi-wiki.org/geometry/triangulation/#voronoi-%E5%9B%BE)
- [邓俊辉《数据结构》](https://cloud.tsinghua.edu.cn/d/76cbab99574046698804/) 习题 6-3 以及 6-32

---


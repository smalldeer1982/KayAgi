# [_-0 A] 考试

## 题目背景

小 $\mathfrak{g}$ 参加一场考试时，不小心把答题卡填反了。

## 题目描述

答题卡有 $n (1 \le n \le 10^9)$ 行，$m (1 \le m \le 10^9)$ 列，共 $nm$ 道题，**从左到右，从上到下，横向排列**。

每道题有 $c (4 \le c \le 10^9)$ 个选项。其中，前 $k(0 \le k \le nm)$ 道题为单选题，**有且仅有一个**正确选项；后 $nm - k$ 道题为多选题，正确选项个数**严格大于** $1$ 且**严格小于** $c$。

小 $\mathfrak{g}$ 正确地回答了所有题，但是她不小心把答题卡的方向看反了，从而她的答案排列方式为**从上到下，从左到右，纵向排列**。

题目的评分方式为：选项完全正确得 $1$ 分，多选或错选得 $0$ 分，漏选按比例给分。

形式化地说，若 $A$ 为某道题正确答案选项的集合，$B$ 为答题卡上选项的集合（均为 $\{1,2,3,\cdots,c\}$ 的子集），则该题得分为：

$$\begin{cases}\frac{\lvert B \rvert}{\lvert A \rvert}&\text{if\quad}
B\sube A\\0&\text{otherwise}\end{cases}$$

小 $\mathfrak{g}$ 忘记考试的正确答案是什么了，于是她去问小 $\mathfrak{f}$，如果考试的正确答案在合法范围内等概率随机，那么自己期望得分是多少。由于结果可能很大，她只需要知道结果对 $10^9+7$ 取模的值。

**题目保证 $c$ 和 $2^c-c-2$ 都不是 $10^9+7$ 的倍数。**


但是小 $\mathfrak{f}$ 也不会，所以他来求助万能的你。

## 说明/提示

**样例 $1$ 解释：**

得分的期望为 $\frac{67}{25}$，对 $10^9+7$ 取模为 $760000008$。

一种可能的考试的正确答案依次为：

$\texttt{C,D,B,AD,ABD,BC}$

那么答题卡上应该填写：

| $\texttt{C}$ | $\texttt{D}$ | $\texttt{B}$ |
| :----------: | :----------: | :----------: |
| $\texttt{AD}$ | $\texttt{ABD}$ | $\texttt{BC}$ |

实际填写：

| $\texttt{C}$ | $\texttt{B}$ | $\texttt{ABD}$ |
| :----------: | :----------: | :----------: |
| $\texttt{D}$ | $\texttt{AD}$ | $\texttt{BC}$ |

答案为 $\texttt{C}$，填写 $\texttt{C}$，得 $1$ 分。

答案为 $\texttt{D}$，填写 $\texttt{B}$，得 $0$ 分。

答案为 $\texttt{B}$，填写 $\texttt{ABD}$，得 $0$ 分。

答案为 $\texttt{AD}$，填写 $\texttt{D}$，得 $\frac{1}{2}$ 分。

答案为 $\texttt{ABD}$，填写 $\texttt{AD}$，得 $\frac{2}{3}$ 分。

答案为 $\texttt{BC}$，填写 $\texttt{BC}$，得 $1$ 分。

综上，这种情况下，考试得分为：

$1+0+0+\frac{1}{2}+\frac{2}{3}+1=
\frac{19}{6}$ 分。

**本题采用捆绑测试且使用子任务依赖。**

| 编号 | 分值 | $n,m\le$ | $c\le$ | 性质 | 依赖 |
| :----------: | :----------: | :----------: | :----------: | :----------: | :----------: |
| $0$ | $0$ | N/A| N/A | 样例 | 无 |
| $1$ | $5$ | $10^9$ | $10^9$ | A | 无 |
| $2$ | $5$ | $2$ | $4$ | 无 | 无 |
| $3$ | $20$ | $10^3$ | $10$ | 无 | $2$ |
| $4$ | $15$ | $10^9$ | $10$ | 无 | $2,3$ |
| $5$ | $15$ | $10^3$ | $10^3$ | 无 | $2,3$ |
| $6$ | $15$ | $10^3$ | $10^5$ | 无 | $2,3,5$ |
| $7$ | $10$ | $10^3$ | $10^9$ | B | 无 |
| $8$ | $10$ | $10^3$ | $10^9$ | 无 | $2,3,5,6,7$ |
| $9$ | $5$ | $10^9$ | $10^9$ | 无 | $0,1,2,3,4,5,6,7,8$ |

特殊性质 A：$n=1$ 或 $m=1$

特殊性质 B：$k=nm-2$

## 样例 #1

### 输入

```
2 3 3 4```

### 输出

```
760000008```

## 样例 #2

### 输入

```
314159265 358979323 84626433832795028 841971693```

### 输出

```
465094894```

# 题解

## 作者：0x3F (赞：11)

由期望的线性性可知，总分的期望等于每一道题得分的期望之和。

我们可以把题分为 $5$ 类：

1.  题号对应，个数为 $C_
{eq}$。
2. 题号不对应，应该填单选题，实际填单选题，个数为 $C_{11}$。
3. 题号不对应，应该填单选题，实际填多选题，个数为 $C_{12}$。
4. 题号不对应，应该填多选题，实际填单选题，个数为 $C_{21}$。
5. 题号不对应，应该填多选题，实际填多选题，个数为 $C_{22}$。

同时，这 $5$ 类题单个对答案的贡献分别为 $S_{eq},S_{11},S_{12},S_{21},S_{22}$。

答案为：$C_{eq}S_{eq}+C_{11}S_{11}+C_{12}S_{12}+C_{21}S_{21}+C_{22}S_{22}$。

首先，求 $C_{eq},C_{11},C_{12},C_{21},C_{22}$ 的值。


假设第 $i$ 行第 $j$ 列的题的坐标为 $(i,j)$，那么横向排列时其题号为 $(i-1)m+j$，纵向排列时其题号为 $(j-1)n+i$。

如果不考虑题号是否对应，那么应该填单选题，实际填单选题的个数 $C_{11}'$ 就是满足 $(i-1)m+j\le k,(j-1)n+i\le k$ 的 $(i,j)$ 的数量。

满足 $(i-1)m+j\le k$ 的区域可以分拆为两个矩形 $R_1=[1,\lfloor\frac{k}{m}\rfloor]\times[1,m]$ 和 $R_2=[\lfloor\frac{k}{m}\rfloor+1,\lfloor\frac{k}{m}\rfloor+1] \times [1,k\bmod m]$ 的不交并，如图所示。

![](https://cdn.luogu.com.cn/upload/image_hosting/s08r3v5v.png)

满足 $(j-1)n+i\le k$ 的区域也可以分拆成两个矩形 $R_3,R_4$。

可以求出 $C_{11}'=\vert(R_1 \cup R_2) \cap (R_3 \cup R_4)\vert = \vert R_1\cap R_3\vert + \vert R_1\cap R_4\vert + \vert R_2\cap R_3\vert + \vert R_2\cap R_4\vert$。

而矩形的交的计算是非常简单的。

同时，显然有 $C_{12}=k-C_{11}',C_{21}=k-C_{11}',C_{22}'=nm-C_{11}'-C_{12}-C_{21}$。

接下来考虑题号对应的情况。题号对应时，有 $(i-1)m+j=(j-1)n+i$，即 $(i-1)(m-1)=(j-1)(n-1)$。

记 $\gcd(n-1,m-1)=g$，则 $\gcd(\frac{n-1}{g},\frac{m-1}{g})=1$，
故 $(i-1)\times\frac{m-1}{g}=(j-1)\times\frac{n-1}{g}$，当且仅当 $i-1=\frac{t(n-1)}{g},j-1=\frac{t(m-1)}{g}$，其中 $t\in\mathbb{Z}$ 且 $0\le t\le g$。

此时，题号为 $(i-1)m+j=(j-1)n+i=\frac{t(nm-1)}{g}+1$。

当题号对应的这题为单选题时，有 $\frac{t(nm-1)}{g}+1\le k$，即 $t\le\lfloor\frac{(k-1)g}{nm-1}\rfloor$，因此 $C_{11}=C_{11}'-(\lfloor\frac{(k-1)g}{nm-1}\rfloor+1)$。同理，$C_{22}=C_{22}'-(\lfloor\frac{(nm-k-1)g}{nm-1}\rfloor+1)$。由于 $t$ 的取值共有 $g+1$ 种，故 $C_{eq}=g+1$。

注意特判 $n=m=1$。

接下来，求 $S_{eq},S_{11},S_{12},S_{21},S_{22}$ 的值。

$S_{eq}$：显然为 $1$。

$S_{11}$：显然为 $\frac{1}{c}$。

$S_{12}$：显然为 $0$。

$S_{21}$：为 $\frac{1}{c}$。假设多选题有 $a$ 个选项，则有 $\frac{a}{c}$ 的概率得 $\frac{1}{a}$ 分，无论多选题的选项是怎样的，得分期望都为 $\frac{1}{c}$。

$S_{22}$：一道多选题的选项共有 $2^c-c-2$ 种可能，因此符合条件的选项 $(A,B)$ 共有 $(2^c-c-2)^2$ 种。考虑计算这些 $(A,B)$ 的得分之和。

假设 $\vert A\vert=i,\vert B\vert=j$，$A$ 有 $\mathrm{C}_{c}^{i}$ 种选法，由于 $B\sube A$，故 $B$ 有 $\mathrm{C}_{i}^{j}$ 种选法，对答案的贡献为 $\frac{j}{i}$。同时，有 $2\le i\le c-1,2\le j\le i$ 的限制。因此，得分之和为：

$$\sum_{i=2}^{c-1}\sum_{j=2}^{i}\mathrm{C}_{c}^{i}\mathrm{C}_{i}^{j}\frac{j}{i}$$

$$=\sum_{i=2}^{c-1}\frac{\mathrm{C}_{c}^{i}}{i}\sum_{j=2}^{i}j\mathrm{C}_{i}^{j}$$

由二项式定理，$(x+y)^{n}=\mathrm{C}_{n}^{0}y^{n}+\mathrm{C}_{n}^{1}xy^{n-1}+\cdots+\mathrm{C}_{n}^{n}x^n$，令 $y\gets1$，得：

$$(x+1)^{n}=\mathrm{C}_{n}^{0}+\mathrm{C}_{n}^{1}x+\mathrm{C}_{n}^{2}x^2+\mathrm{C}_{n}^{3}x^3+\cdots+\mathrm{C}_{n}^{n}x^n(\star)$$

$(\star)$ 两边关于 $x$ 求导，得：

$$n(x+1)^{n-1}=\mathrm{C}_{n}^{1}+2\mathrm{C}_{n}^{2}x+3\mathrm{C}_{n}^{3}x^2+\cdots+n\mathrm{C}_{n}^{n}x^{n-1}$$

令 $x\gets 1,n\gets i$ 得：

$$i2^{i-1}=\mathrm{C}_{i}^{1}+2\mathrm{C}_{i}^{2}+3\mathrm{C}_{i}^{3}+\cdots+i\mathrm{C}_{i}^{i}$$

移项得：

$$2\mathrm{C}_{i}^{2}+3\mathrm{C}_{i}^{3}+\cdots+i\mathrm{C}_{i}^{i}=i2^{i-1}-\mathrm{C}_{i}^{1}=i(2^{i-1}-1)$$

故原式可化简为：

$$\sum_{i=2}^{c-1}\frac{\mathrm{C}_{c}^{i}}{i}\times i(2^{i-1}-1)$$

$$=\frac{1}{2}\sum_{i=2}^{c-1}2^{i}\mathrm{C}_{c}^{i}-\sum_{i=2}^{c-1}\mathrm{C}_{c}^{i}$$

$(\star)$ 中，令 $x\gets 1,n\gets c$ 得：

$$2^c=\mathrm{C}_{c}^{0}+\mathrm{C}_{c}^{1}+\mathrm{C}_{c}^{2}+\mathrm{C}_{c}^{3}+\cdots+\mathrm{C}_{c}^{c-1}+\mathrm{C}_{c}^{c}$$

移项得：

$$\mathrm{C}_{c}^{2}+\mathrm{C}_{c}^{3}+\cdots+\mathrm{C}_{c}^{c-1}=2^c-\mathrm{C}_{c}^{0}-\mathrm{C}_{c}^{1}-\mathrm{C}_{c}^{c}=2^c-c-2$$

$(\star)$ 中，令 $x\gets 2,n\gets c$ 得：

$$3^c=\mathrm{C}_{c}^{0}+2\mathrm{C}_{c}^{1}+4\mathrm{C}_{c}^{2}+8\mathrm{C}_{c}^{3}+\cdots+2^{c-1}\mathrm{C}_{c}^{c-1}+2^{c}\mathrm{C}_{c}^{c}$$

移项得：

$$4\mathrm{C}_{c}^{2}+8\mathrm{C}_{c}^{3}+\cdots+2^{c-1}\mathrm{C}_{c}^{c-1}=3^c-\mathrm{C}_{c}^{0}-2\mathrm{C}_{c}^{1}-2^{c}\mathrm{C}_{c}^{c}=3^c-2^c-2c-1$$

故原式可化简为：

$$\frac{3^c-2^c-2c-1}{2}-(2^c-c-2)$$

$$=\frac{3^c-3\times2^c+3}{2}$$

故 $S_{22}=\frac{3^c-3\times2^c+3}{2(2^c-c-2)^2}$。

时间复杂度为 $O(\log n+\log m+\log c)$。

代码：

```cpp
#include <bits/stdc++.h>
using namespace std;
const int p = 1e9 + 7;
inline int qpow(int a, long long b) {
	int s = 1;
	while (b) {
		if ((b & 1LL)) s = (long long)s * a % p;
		a = (long long)a * a % p;
		(b >>= 1LL);
	}
	return s;
}
int n, m, c;
long long nm, k;
long long ceq, c11, c12, c21, c22;
int seq, s11, s12, s21, s22;
int ans;
int main() {
	cin >> n >> m >> k >> c;
	nm = (long long)n * m;
	c11 = (k/m) * (k/n) + min(k/n, k%m) + min(k%n, k/m) + (k/m < k%n && k/n <= k%m);
	c12 = k - c11;
	c21 = k - c11;
	c22 = nm - c11 - c12 - c21;
	int g = __gcd(n-1, m-1);
    long long step = ((g) ? ((nm - 1) / g) : (1LL));
	ceq = g+1;
	c11 -= (step + k - 1) / step;
	c22 -= (step + nm - k - 1) / step;
	seq = 1;
	s11 = qpow(c, p-2);
	s12 = 0;
	s21 = qpow(c, p-2);
	s22 = ((((long long)qpow(3, c) - 3LL * qpow(2, c) + 3) % p + p) % p * qpow(2, p-2) % p) * qpow(((qpow(2, c) - c - 2) % p + p) % p, p-3) % p;
	ans = (ans + ceq % p * seq) % p;
	ans = (ans + c11 % p * s11) % p;
	ans = (ans + c12 % p * s12) % p;
	ans = (ans + c21 % p * s21) % p;
	ans = (ans + c22 % p * s22) % p;
	cout << ans << endl;
	return 0;
}
```

---


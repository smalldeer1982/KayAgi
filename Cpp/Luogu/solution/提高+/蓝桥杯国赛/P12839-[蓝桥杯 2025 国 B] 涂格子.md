# [蓝桥杯 2025 国 B] 涂格子

## 题目描述

小蓝正在玩一个涂格子的游戏。他有一个大小为 $n \times m$ 的矩阵，他要给这个矩阵中的每个格子都涂上黑色或白色。小蓝希望最终涂完的格子像国际象棋棋盘一样整齐。具体来说，他希望每一个同色连通块都是矩形，且与上下左右四个异色的矩形相邻（如果存在的话）。下图中第一行的两个涂色方案是合法的，第二行的两个涂色方案是不合法的。

![](https://cdn.luogu.com.cn/upload/image_hosting/ewqwlkxf.png)

同时小蓝希望 $k$ 个格子具有特定的颜色。其中第 $i$ 个格子位置是 $(x_i, y_i)$，具有特定的颜色 $c_i$。你需要帮助他求出符合要求的合法涂色方案有多少种。因为方案数可能很大，请对 $998244353$ 取模后输出。

## 说明/提示

**【评测用例规模与约定】**

对于 $20\%$ 的评测用例，$n \times m \leq 20$。

对于 $50\%$ 的评测用例，$n, m, k \leq 5000$。

另存在 $30\%$ 的评测用例，$c_i = 0$。

另存在 $10\%$ 的评测用例，$k = 0$。

对于 $100\%$ 的评测用例，$1 \leq n, m \leq 10^9$，$1 \leq k \leq 3 \times 10^5$，$1 \leq x_i \leq n$，$1 \leq y_i \leq m$，$c_i \in \{0, 1\}$。


## 样例 #1

### 输入

```
2 2 4
1 1 0
1 2 0
2 1 0
2 2 1```

### 输出

```
0```

## 样例 #2

### 输入

```
3 3 2
1 1 0
2 2 1```

### 输出

```
8```

# 题解

## 作者：SudoXue (赞：1)

[更好的阅读体验](https://www.cnblogs.com/xueruhao/p/18949674)

有趣，很好的转化。

本题把“同色连通块必须是矩形且黑白棋盘相邻”抽象成：存在行变量 $r_x\in\{0,1\}$ 与列变量 $c_y\in\{0,1\}$，使得格子 $(x,y)$ 的颜色为 $r_x\oplus c_y$。于是每条限制 $r_{x_i}\oplus c_{y_i}=c_i$ 就是一条二分图的带权边，顶点左侧是出现过的行、右侧是出现过的列。用带权并查集维护异或距离，合并时若两点已连通却出现 $xr[a]\oplus xr[b]\ne w$ 即判矛盾并输出 $0$。

若无矛盾，设出现过的行数 $R$、列数 $C$，这些顶点的连通块数为 $s$。因为每并一次块秩减一，所以方程组秩为 $R+C-s$。自由度即剩余可任意指定的行列变量数，再扣除整体翻转一度自由：$(n-R)+(m-C)+s-1$。合法方案数就是 $2^{(n-R)+(m-C)+s-1}\bmod 998244353$，用快速幂计算。

用 unordered_map 离散化行列坐标；把列顶点编号平移一个常量放进同一并查集数组；并查集按路径压缩与按秩合并实现带权异或。

时间复杂度 $O(k\,\alpha(k))$。

[link](https://www.luogu.com.cn/record/221435623)

---


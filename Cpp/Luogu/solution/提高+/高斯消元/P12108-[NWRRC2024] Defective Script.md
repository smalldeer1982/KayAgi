# [NWRRC2024] Defective Script

## 题目描述

Devin 是一家科技公司的系统管理员，负责管理由 $n$ 台服务器组成的环形拓扑网络。每台服务器当前承载的计算负载用一个非负整数 $a_i$ 表示，其中 $i$ 的取值范围是 $1$ 到 $n$。

为了优化网络性能并确保公平性，Devin 希望均衡所有服务器的负载，使每台服务器承担相同的工作量。他的目标是尽可能最大化这个均衡后的负载值。

Devin 开发了一个脚本来减少服务器的负载。当在服务器 $i$ 上运行该脚本时，理论上应该将该服务器的负载减少 $2$ 个单位（最低减至零）。但由于脚本中存在已知缺陷，每次在服务器 $i$ 上执行时，还会意外地使网络中前一台服务器（服务器 $i-1$）的负载减少 $1$ 个单位。如果 $i = 1$，则前一台服务器是服务器 $n$（因为服务器构成环形拓扑）。

Devin 可以任意次数（包括零次）运行这个有缺陷的脚本，每次可以选择任意服务器执行。即使某台服务器当前负载不足 $2$ 个单位，或者前一台服务器的负载为零，仍然可以运行脚本（在这两种情况下负载都会降至零）。

请帮助 Devin 确定使用该脚本后，所有服务器能够达到的最大可能均衡负载值。

## 说明/提示

在第一个测试用例中，Devin 可以在服务器 $1$ 上运行脚本 $1$ 次，服务器 $2$ 上运行 $2$ 次，服务器 $4$ 上运行 $1$ 次。最终每台服务器都将承担 $5$ 个单位的负载。

## 样例 #1

### 输入

```
5
4
9 9 6 8
2
3 5
9
9 9 8 2 4 4 3 5 3
3
777 777 777
6
0 1 0 1 0 1```

### 输出

```
5
1
0
777
0```

# 题解

## 作者：xiezheyuan (赞：0)

## 简要题意

给定一个长度为 $n$ 的序列 $a$，定义 $N(i)=\begin{cases}n&i=1\\i-1&\text{otherwise}\end{cases}$ 表示 $i$ 的前一个数。

你可以进行下述操作任意次：

- 选定一个 $i\in[1,n]$，令 $a_i\gets \max(a_i-2,0),a_{N(i)}\gets \max(a_{N(i)}-1,0)$。

你需要让 $a$ 中所有数均相等，输出此时 $a_1$ 的最大值。

$T$ 组数据，$2\leq \sum n\leq 2\times 10^5,0\leq a_i\leq 10^9$。

### 思路

先考虑一个问题：我们如何判断一个 $r=a_1$ 是否是一个合法的解（假设 $r\neq 0$）？

不妨令 $t_i$ 表示 $i$ 被选择的次数，那么我们实际上有了关于 $t_i$ 的 $n$ 个方程，第 $i$ 个方程形如：
$$
r=a_i-2t_i-t_{N'(i)}
$$
其中 $N'(i)$ 满足 $N(N'(i))=N'(N(i))=i$，即 $i$ 的下一个数。

上面的方程是显然的。我们只需要解这个方程，就可以得到所有 $t_i$，然后验证 $t_i\in\mathbb{N}$ 是否成立即可。

至于这个解方程，朴素的高斯消元肯定是无法通过的，不过我们发现方程结构非常简单，可以手动消元一下。时间复杂度 $O(n)$。

现在我们会判定答案，但不会求出答案。这时我们回到题目本身，题目中有一句话：**求最大值**。

这引导我们思考，如果 $r$ 是一组合法的解（$r$ 充分大），我们能否构造一个非平凡的另解 $r'$？事实上是可以的，我们只需要对每个数都操作一次，这样 $r'=r-3$。同样的，对于解 $r'$，如果得到 $t_i$ 中，$\min t_i>0$，则可以让 $t_i\gets t_i-1$ 来获得一个较大的解 $r=r'+3$。

于是我们得到了重要引理：

> 若 $r$ 是解，则 $(r-1)\bmod 3+1$ 也是解（之所以不写成 $r\bmod 3$，是因为 $0$ 是平凡解，没有考虑的价值）。

然后我们只需要枚举 $r=1,2,3$，解出 $t$，令 $f=\min t_i$，令 $t_i\gets t_i-f$ 来让答案尽可能增大，最后对所有合法的 $3f+r$ 取最大值即可。

有一个小问题，在解方程时中间结果可能很大，可以选取一个合适的质数 $p$，在有限域 $\mathbb{Z}/p\mathbb{Z}$ 计算，但选取有限域进行计算的话，无法验证 $t_i\in\mathbb{N}$，可以改为模拟题目中的过程，验证所有数是否相等。

时间复杂度 $O(n)$。

[QOJ Submission](https://qoj.ac/submission/987186)。

---


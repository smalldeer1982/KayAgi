# 魔女的茶会

## 题目背景

“原来如此，这就是你欲望的根本吗，真有意思呢…”

声音在墓穴中传开来，昴猛然回头，眼前的景象却骤然大变：他的四周由昏黑的墙壁变为了一望无际的草坪，起伏着大大小小的山丘；而原本应该是墓穴入口的地方，却有着一张茶桌和两张座椅，与之一齐处在遮阳伞的荫庇下的，还有一位端坐着的黑衣女子。

![初见](https://cdn.luogu.com.cn/upload/image_hosting/umx8vsni.png)

“我好久没有跟人类对话了，就兴奋了点… 我叫艾姬多娜。「强欲魔女」，这样说比较好懂吧？” 女子浅笑着说道。

“… 这是哪里！？我应该在一个黑暗的遗迹中，你是什么时候把我转移过来的？” 昴咬紧了牙，问道。

“很遗憾，你搞错了。你并不是肉体经历了转移，只是被邀请参加我的茶会而已。”

“茶会…？”

“是魔女的茶会哦。”

**[管理员 Mivik 更改了时间线]**

## 题目描述

“那么… 你还准备在那里站多久？趁着茶还没凉赶紧入座吧。”

“可恶… 知道啦知道啦！” 昴走上前去，坐在了魔女对面。桌上除了两杯茶外，还有一副黑白交错的棋盘。

“这是…？” 昴指着棋盘，问道。

“这是魔女棋哦。我请你过来是为了解答我沉思多年都无法解决的一个问题。如果你解决了它，我就会给你和爱蜜莉雅参加试炼的权利… 否则…”令人不安的笑容浮现在魔女脸上，“你可能就会在圣域里无穷地轮回哦…？”

昴出了一身冷汗，战战兢兢地问道：“那么问题是？”

魔女拾起了身边的一个棋子，缓缓说道：“如你所见，这是一张 $n\times n$ 的棋盘，由 $n^2$ 个方格组成，每个方格上最多只能存在一个棋子。**不同于普通的棋盘，这个棋盘是循环的，也就是说，第 $i$ 行 $n$ 列的格子右边是第 $i$ 行 $1$ 列的格子，第 $n$ 行 $i$ 列的格子下面是第 $1$ 行 $i$ 列的格子，以此类推。** 我手中的棋子名叫「大罪司教」，它一步可以向任意斜线方向移动任意多格。一个棋子能一步走到的格子称为其掌控的格子。如果一个棋子掌控了另一个棋子所在的方格，则这种棋盘布局是不稳定的，反之称其为稳定的。现在，请问你能否向棋盘中放入恰好 $m$ 个「大罪司教」，使得整个棋盘布局是稳定的呢？”

![示例](https://cdn.luogu.com.cn/upload/image_hosting/8d8481wr.png)

[上图高清版](https://cdn.luogu.com.cn/upload/image_hosting/np9zk0t4.png)

昴沉思了一会儿，随后在棋盘上操作，很快就完成了魔女的任务，说道：“那么快给我参加试炼的权利吧！”

魔女说：“不行啦… 我还有一个问题没有解决呢…”

昴：“靠北，你耍赖啊！”

魔女没有理会昴，继续说道：“现在问题是，一共有多少种本质不同的稳定的布局方案，使得布局中恰好有 $m$ 个「大罪司教」呢？两种方案本质不同，当且仅当存在任意一格在一种方案中有棋子而在另一种方案中没有哦。”

昴更加生气，因为他不会做了，他转而求助于你。你只需要告诉他答案对 $998244353$ 取模的结果即可。


## 说明/提示

样例一：将一个棋子放入 $1\times1$ 的棋盘中显然只有一种方案。

样例二：一共有以下四种稳定的布局（用 `.` 代表空位，`o` 代表「大罪司教」）：

```plain
oo .o .. o.
.. .o oo o.
```

样例三：所有 $18$ 种稳定的布局可以在 [这里](https://www.luogu.com.cn/paste/obkotkqb) 查看。

### 数据范围

对于全部数据，有 $1\le n<998244353$，$0\le m\le\min\{n,10^7\}$。

Subtask 1 (5 pts)：保证 $m=0$。

Subtask 2 (10 pts)：保证 $m=1$。

Subtask 3 (10 pts)：保证 $1\le n\le 4$。

Subtask 4 (20 pts)：保证 $n$ 是奇数。

Subtask 5 (25 pts)：保证 $n\le 10^7$。

Subtask 6 (30 pts)：无特殊限制。

## 样例 #1

### 输入

```
1 1```

### 输出

```
1```

## 样例 #2

### 输入

```
2 2```

### 输出

```
4```

## 样例 #3

### 输入

```
3 2```

### 输出

```
18```

## 样例 #4

### 输入

```
10 5```

### 输出

```
8647680```

# 题解

## 作者：Mivik (赞：10)

### Subtask 1

这不就一种吗？

### Subtask 2

这不就 $n^2$ 种吗？

### Subtask 3

我会爆搜！

### Subtask 4

考虑 $n$ 是奇数。我们把棋盘 $45$ 度旋转一下然后按列标号，像这样（$n=5$）：

```plain
    5
   4 6
  3 5 7
 2 4 6 8
1 3 5 7 9
 2 4 6 8
  3 5 7
   4 6
    5
```

不难发现，第 $i$ 列（$1\le i<n$）和第 $i+n$ 列会互相掌控，第 $i$ 行和第 $i+n$ 行也会互相掌控，我们改写一下上面那个棋盘，把第 $i+n$ 行都接到第 $i$ 行末尾，并把标号为 $i+n$ 的改成标号为 $i$，于是变成了

```plain
5 2 4 1 3
4 1 3 5 2
3 5 2 4 1
2 4 1 3 5
1 3 5 2 4
```

也就是说，我们现在需要在这个矩阵中选 $m$ 个互不相同的数，且这些数不在同一行。我们发现这个矩阵每行每列都不包含相同的数，这个结论实际上可以简单讨论得到。显然任意改变一行内数的顺序不会影响答案，我们完全可以把上面那个矩阵排为

```plain
1 2 3 4 5
1 2 3 4 5
1 2 3 4 5
1 2 3 4 5
```

于是这个问题就变成了，在一个 $n\times n$ 的棋盘上选 $m$ 个位置，这些位置没有任意两个在同一行或同一列。考虑枚举用到了哪些行和哪些列后剩下的方案数就是 $m!$，于是答案为
$$
\binom nm^2m!
$$

### Subtask 5

考虑 $n$ 是偶数的情况。这种情况我们发现黑格和白格（也就是按行号与列号的奇偶性分组）互不相关，我们可以分开考虑。更进一步地，不难发现旋转后黑格部分和白格部分是完全相同的，也就是说在它们上面放棋子的方案数相同，我们只需要考虑任意一种。

我们沿袭上面的方法把一种格子提出来标号（$n=6$）：

```plain
  34
 2345
123456
 2345
  34
```

然后第 $i$ 列（$1\le i\le n/2$）和第 $i+n/2$ 列会互相掌控，第 $i$ 行和第 $i+n/2$ 行也会互相掌控，我们改写棋盘：

```plain
312312
231231
123123
```

对行重排：

```plain
112233
112233
112233
```

我们发现每个 $[0,n/2]$ 间的数字恰在每行出现了两次，这也是易证的。我们考虑选出 $m$ 个互不相同且不在同一行的数，选第 $k$ 个数是我们恰有 $n-2(k-1)$ 种方案，于是在黑格 / 白格中放 $k$ 个棋子的方案数就是

$$
\begin{aligned}&\binom{n/2}k\prod_{i=1}^k(n-2(i-1))\\=&\binom{n/2}k2^k\prod_{i=1}^k(n/2-(i-1))\\=&\binom{n/2}k2^k(n/2)^{\underline k}\\=&\binom{n/2}k^22^kk!\end{aligned}
$$

于是最终的答案就是

$$
\begin{aligned}
&\sum_{i=0}^k\binom{n/2}i^22^ii!\cdot\binom{n/2}{k-i}2^{k-i}(k-i)!\\
=&2^k\sum_{i=0}^k\binom{n/2}i^2\binom{n/2}{k-i}^2i!(k-i)!
\end{aligned}
$$

预处理阶乘后直接计算即可。

### Subtask 6

把关于 $n$ 的部分改成下降幂：

$$
2^k\sum_{i=0}^k\left(\frac{(n/2)^{\underline i}(n/2)^{\underline{k-i}}}{i!(k-i)!}\right)^2i!(k-i)!
$$

预处理下降幂后直接计算即可。

[mivik.h](https://mivik.gitee.io/mivik.h) / [代码](https://paste.ubuntu.com/p/vP8PxKPczq/)

---

## 作者：VinstaG173 (赞：1)

前两天还在看 psj 的论文，但是这场比赛时在考 TACA，于是只能回家后看题然后发现是板子（

这道题里只用到了棋盘多项式理论里很少的一部分。

第一点就是在 $n \times n$ 方格棋盘中放入 $m$ 个车使它们互不攻击的方案数为 $\binom{n}{m}^2m!$，即 $n \times n$ 棋盘的多项式为

$$f(S)=\sum_{m=0}^{n}\binom{n}{m}^2m!x^m$$

第二点就是两个不存在重复行或重复列的棋盘之并的多项式等于它们的多项式之积，即若 $\forall (x_1,y_1) \in S_1,(x_2,y_2) \in S_2$ 有 $x_1 \neq x_2,y_1 \neq y_2$，则 $f(S_1 \cup S_2)=f(S_1)f(S_2)$。

为了解决此题，我们考虑将「大罪司教」转化成车。先画个图。

![6](https://cdn.luogu.com.cn/upload/image_hosting/d25zwal7.png?x-oss-process=image/resize,m_lfit,h_170,w_225)

![7](https://cdn.luogu.com.cn/upload/image_hosting/fvtuonih.png?x-oss-process=image/resize,m_lfit,h_170,w_225)

以上是 $6 \times 6$ 和 $7 \times 7$ 的情况。其中同样颜色的线代表同一个「大罪司教」能掌控的位置。

显然有 $n$ 为奇数时同样颜色沿副对角线方向（左上到右下，下同）的线上的 $n$ 个格子对应分别在 $n$ 种不同颜色的沿主对角线方向（右上到左下，下同）的线上。所以我们可以直接将其转化为 $n \times n$ 的棋盘。那么答案为

$$\binom{n}{m}^2m!$$

显然可以 $O(m)$ 计算。

又 $n$ 为偶数时同样颜色沿副对角线方向的线上的 $n$ 个格子对应在 $\frac{n}{2}$ 种不同颜色的沿主对角线方向的线上，每种颜色上各两个。我们对其从上到下编号为 $1$ 到 $n$ 后，则编号为奇数的沿副对角线方向的线只与编号为偶数的沿主对角线方向的线有交点且两两恰有两个交点，反之亦然。

则显然这等价于在棋盘 $S=\{(x,y) : 1 \le x,y \le n,2 \not| x+y\}$ 中放入 $m$ 个车使它们互不攻击，每一个格有两种放置方法。

我们把它拆成奇行偶列和偶行奇列两个棋盘，显然它们都等价于一个 $\frac{n}{2} \times \frac{n}{2}$ 的棋盘。因此答案就是

$$2^m\sum_{i=0}^{m}\binom{\frac{n}{2}}{k}^2k! \times \binom{\frac{n}{2}}{m-k}^2(m-k)!$$

显然可以预处理，$O(m)$ 计算。

---

## 作者：Inui_Sana (赞：0)

~~入坑番好欸~~

考虑直接观察。

对于 $n$ 为奇数的情况，容易发现我们原来的限制，也就是不存在两个点 $(x_1,y_1),(x_2,y_2)$ 满足 $x_1+y_1\equiv x_2+y_2\pmod{n}\vee x_1-y_1\equiv x_2-y_2\pmod{n}$，等价于在一个 $n\times n$ 的矩阵中，没有两个中国象棋的车是能相互攻击到的。

于是考虑一个一个放入，每次去掉不能放的位置个数，最后除以排列方案数则有 $ans=\dfrac{\prod_{i\le m}(n-i+1)^2}{m!}$。

但是发现 $n$ 为偶数会有问题。具体地说，在 $n$ 为偶数时，将棋盘黑白染色，黑格和白格之间互相独立。并且在 $n$ 为奇数时，每一个点能攻击到的（包括自己）有 $2\times n-1$ 个点，但是 $n$ 为偶数时这个数变成了 $2\times (n-1)$。

但是依然可以类似地一个一个放入。手玩 $n=6$ 的黑色格子，发现第一次会 ban 掉 $2\times(6-1)$ 个点，第二次 $2\times (6-3)$ 个，第三次 $2\times (6-5)$ 个。于是大胆猜测每次 ban 掉的格子会 $-2\times 2$ 个。事实上这是因为每对同色 $(x_1,y_1),(x_2,y_2)$ 能攻击到的格子都会有大小为 $4$ 的交集。

于是设 $f_n$ 为往同色格子中放 $n$ 个棋子的方案数，则有 $f_n=\dfrac{\prod_{i\le n}(\dfrac{n^2}{2}-\sum_{j<i}2\times (n-i\times 2+1))}{n!}$。求和部分可以动态维护。则 $ans=\sum_{i+j=m}f_i\times f_j$。时间复杂度 $O(n)$。

upd：突然发现似乎可以小小加强变成对 $\forall i\in[1,m]$ 求答案，最后套一个 poly 即可，但是 meaningless（

code：

```cpp
int n,m,f[N],inv[N];
il int Mod(int x,int y){
	return x+y>=mod?x+y-mod:x+y;
}
il int qpow(int x,int y){
	int ret=1;
	while(y){
		if(y&1){
			ret=1ll*ret*x%mod;
		}
		x=1ll*x*x%mod,y>>=1;
	}
	return ret;
}
void Yorushika(){
	read(n,m);
	if(n&1){
		int x=1,y=1;
		drep(i,n,n-m+1){
			x=1ll*x*i%mod*i%mod;
			y=1ll*y*(n-i+1)%mod;
		}
		printf("%lld\n",1ll*x*qpow(y,mod-2)%mod);
	}else{
		ll x=1ll*n*n/2;
		f[0]=inv[1]=1;
		rep(i,2,m){
			inv[i]=1ll*inv[mod%i]*(mod-mod/i)%mod;
		}
		drep(i,n,n-m+1){
			f[n-i+1]=1ll*f[n-i]*(x%mod)%mod*inv[n-i+1]%mod;
			x-=2*(n-(n-i+1)*2+1);
		}
		int ans=0;
		rep(i,0,m){
			ans=Mod(ans,1ll*f[i]*f[m-i]%mod);
		}
		printf("%d\n",ans);
	}
}
signed main(){
	int t=1;
	//read(t);
	while(t--){
		Yorushika();
	}
}
```

---

## 作者：唐一文 (赞：0)

有点太难了。

$n$ 为偶数的时候，把棋盘黑白染色。发现一个棋子只会 ban 掉和它所在格子颜色相同的格子，并且无论怎么放，ban 掉的格子数量都是一样的。设 $f_i$ 为在同种颜色的格子放 $i$ 个棋子的方案数，从 $f_{i-1}$ 转移，没被 ban 的格子数量是好算的。最后枚举白色格子放几个，黑色格子放几个。答案为 $\sum_{i\leq m}f_i\times f_{m-i}$。

$n$ 为奇数的时候，一条左斜对角线和一条右斜对角线唯一确定一个格子。那么左斜对角线和右斜对角线是独立的。选 $m$ 条左斜，$m$ 条右斜，再将它们匹配就是一种方案。答案为 $\binom{n}{m}\times\binom{n}{m}\times m!$。

[code](https://www.luogu.com.cn/paste/rj38ps9x)

---


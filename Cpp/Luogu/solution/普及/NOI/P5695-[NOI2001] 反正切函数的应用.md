# [NOI2001] 反正切函数的应用

## 题目背景

反正切函数可展开成无穷级数，有如下公式

$$ \arctan(x) = \sum_{n = 0}^\infty \frac{(-1) ^ n x ^ {2n + 1}}{2n + 1} ( 0 \le x \le 1 ) \tag{1} $$

使用反正切函数计算 是一种常用的方法。例如，最简单的计算 的方法：

$$
\begin{aligned}
\pi & = 4 \arctan(1) \\
    & = 4(1 - \frac{1}{3} + \frac{1}{5} - \frac{1}{7} + \frac{1}{9} - \frac{1}{11} + \dots)
\end{aligned}
\tag{2}
$$

然而，这种方法的效率很低，但我们可以根据角度和的正切函数公式：

$$ \tan(\alpha + \beta) = \frac{\tan(\alpha) + \tan(\beta)}{1 - \tan(\alpha) \tan(\beta)} \tag{3} $$

通过简单的变换得到：

$$ \arctan(p) + \arctan(q) = \arctan(\frac{p + q}{1 - p q}) \tag{4} $$

利用这个公式，令 $ p = \frac{1}{2}, q = \frac{1}{3} $，则 $ \frac{p + q}{1 - p q} = 1 $，有

$$ \arctan(\frac{1}{2}) + \arctan(\frac{1}{3}) = \arctan(\frac{\frac{1}{2} + \frac{1}{3}}{1 - \frac{1}{2} \cdot \frac{1}{3}}) = \arctan(1) $$

## 题目描述

我们将公式 $ 4 $ 写成如下形式

$$ \arctan(\frac{1}{a}) = \arctan(\frac{1}{b}) + \arctan(\frac{1}{c}) $$

其中 $ a, b, c \in \mathbb{N^+} $。

我们的问题是：对于每一个给定的 $a$，求 $ b + c $ 的值。我们保证对于任意的 $ a $ 都存在整数解。如果有多个解，要求你给出 $ b + c $ 最小的解。


## 说明/提示

$1 \le a \le 6\times 10^4 $。

## 样例 #1

### 输入

```
1```

### 输出

```
5```

# 题解

## 作者：registerGen (赞：18)

**Upd on 2020/02/17**：改了下 $\LaTeX$ 并写了时间复杂度更低的 Code

---

[P5695题面](https://www.luogu.com.cn/problem/P5695)

这道题是道数学题，但代码十分简单。

良心出题人已经把公式扔给我们了：


$$\operatorname{arctan}(p)+\operatorname{arctan}(q)=\operatorname{arctan}\left(\dfrac{p+q}{1-pq}\right)\qquad(1)$$

于是，我们在 $(1)$ 中令 $p=\dfrac{1}{b},\ q=\dfrac{1}{c}$ ，则：

$$\operatorname{arctan}\left(\dfrac{1}{a}\right)=\operatorname{arctan}\left(\dfrac{1}{b}\right)+\operatorname{arctan}\left(\dfrac{1}{c}\right)=\operatorname{arctan}\left(\dfrac{b+c}{bc-1}\right)$$

$$\therefore \dfrac{1}{a}=\dfrac{b+c}{bc-1}$$

于是 $c=\dfrac{ab+1}{b-a}$

$$\begin{aligned}
\therefore b+c&=b+\dfrac{ab+1}{b-a}\\
&=\dfrac{b^{2}+1}{b-a}\\
&=\frac{b^{2}-a^{2}+a^{2}+1}{b-a}\\
&=b+a+\frac{a^{2}+1}{b-a}\qquad(2)\\
&=\big(b-a\big)+\frac{a^{2}+1}{b-a}+2a\qquad(3)
\end{aligned}$$

1. 由 $(2)$ 知 $c=a+\dfrac{a^{2}+1}{b-a}$

因为 $c$ 是正整数，所以 $b>a$ 且 $(b-a)\left|\right.(a^{2}+1)$

2. 下面我们来看 $(3)$ 式，这是典型的对勾函数，当 $b-a$ 和 $\dfrac{a^{2}+1}{b-a}$ 最接近时，$(3)$ 式有最小值。

综上，我们得到：$b-a$ 取最接近 $\sqrt{a^{2}+1}$ 且比它大且为 $a^{2}+1$ 的约数时，$b+c$ 最小。

---

代码：（时间复杂度 $O(a)$）
```cpp
#include<cstdio>

#define int long long // 三年 OI 一场空，不开 long long 见祖宗

signed main()
{
	int a;
	scanf("%lld",&a);
	int b,c;
	int s=a*a+1;
	for(int i=a;i>=1;i--)
		if(s%i==0)
		{
			b=i+s/a;
			break;
		}
	c=(a*b+1)/(b-a);
	printf("%lld\n",b+c);
	return 0;
}
```

---

## 作者：Siegerkranz_2735 (赞：8)

#### 简化提意：

已知 $ \arctan(\frac{1}{a}) = \arctan(\frac{1}{b}) + \arctan(\frac{1}{c}) $ 其中 $ a, b, c \in \mathbb{N^+} $ ，求 $b+c$ 最小值。

#### 解决方法：

这是一道数学结论题，根据题中给的公式，导一导就可以了。

根据

$$ \arctan(p) + \arctan(q) = \arctan(\frac{p + q}{1 - p q})$$

我们可以将等式改写为：

$$\arctan\left(\frac{1}{a}\right) = \arctan\left(\frac{\frac{1}{b}+\frac{1}{c}}{1-\frac{1}{b}\cdot\frac{1}{c}}\right)$$

$$\arctan\left(\frac{1}{a}\right) = \arctan\left(\frac{b+c}{bc-1}\right)$$

由于两边都是反正切函数，我们可以消去这个函数，得到：

$$\frac{1}{a} = \frac{b+c}{bc-1}$$

根据这个式子不难得出 $b$ 关于 $c$ 的等式:

$$b=\frac{a  c+1}{c-a}$$

所以 $b+c$ 就可以写成：

$$b+c=\frac{c^2+1}{c-a}$$

设 $f(c)=\frac{c^2+1}{c-a}$,导一导不难得出：

$$\begin{aligned}
f'(c)&=\frac{(c^2+1)'(c-a)-(c-a)'(c^2+1)}{(c-a)^2}\\

&=\frac{c^2-2ac-1}{(c-a)^2}
\end{aligned}$$

令 $f'(c)=0$ 可以得到该函数斜率为 $0$ 的的值：

$$c=a\pm\sqrt{a^2+1}$$

因为 $c \in \mathbb{N^+}$，又因为 $\sqrt{a^2+1}>a$ 所以 $c$ 只有一个解：

$$c=a+\sqrt{a^2+1}$$

此时满足 $a,b,c>0$ 的情况下， $b+c$ 最小。

接着看 $b=\frac{a  c+1}{c-a}$，由于 $ a, b, c \in \mathbb{N^+} $， 其中 $a c+1>0$,所以为了保证 $b>0$, 必须满足 $c>a$。

由于在 $\frac{1}{a} = \frac{b+c}{bc-1}$ 中 $c$ 和 $b$ 地位相等，所以要找的要求的正整数 $c$ 一定在 $c=a+\sqrt{a^2+1}$ 左右两边各有一个，且这两个解 $c_1$ 和 $c_2$ 满足 $c_1+c_2=f(c_1)=f(c_2)$（假设 $c_1<c_2$)。

接下来就可以比较 $c_1$ 和 $c_2$ 哪个距离 $a+\sqrt{a^2+1}$ 近，来选择循环的方向。

由于已经知道 $c_1+c_2$ 所以只要求 $\frac{c_1+c_2}{2}$ 和 $c_0$ 的关系即可。

设 $g(c)=\frac{c^2+1}{2(c-a)}$ 可得：

$$g'(c)=\frac{f'(c)}{2}=\frac{c^2-2ac-1}{2(c-a)^2}$$

令 $g'(x)=0$ 得到该函数的驻点：

$$c=a\pm\sqrt{a^2+1}$$

因为 $c \in \mathbb{N^+}$，又因为 $\sqrt{a^2+1}>a$ 所以 $c$ 只有一个解：

$$c=a+\sqrt{a^2+1}$$

将它带入可得：
$$g(a+\sqrt{a^2+1})=\frac{(a+\sqrt{a^2+1})^2+1}{2\sqrt{a^2+1}}=a+\sqrt{a^2+1}$$

所以当 $c>a>0$ 时：

$$\frac{c^2+1}{2(c-a)}\ge a+\sqrt{a^2+1}$$

等量代换可得：

$$\frac{c_1+c_2}{2}\ge c_0$$

所以可得 $c_1$ 到 $c_0$ 更近，所以应该从 $c_0$ 开始递减寻找，直到找到答案。

最后根据结论，很容易得到代码如下：
```cpp
#include<bits/stdc++.h>
using namespace std;
long long a;
int main(){
	cin>>a;long long i=a+sqrt(a*a+1);
	for(;__gcd(a*i+1,i-a)!=i-a;i--);
	cout<<(i*i+1)/(i-a);
	return 0;
} 
```


---

## 作者：Last_kiss_Snow_Dog6 (赞：6)

### [题目](https://www.luogu.com.cn/problem/P5695)

个人感觉，这道题不像模拟（可能是我自己理解的不对），更像数学题。

我们可以根据角度和的正切函数公式（正切定理说明任意两条边的和除以第一条边减第二条边的差所得的商等于这两条边的对角的和的一半的正切除以第一条边对角减第二条边对角的差的一半的正切所得的商）：
$$  \operatorname{tan}(\alpha +\beta )=\frac{\operatorname{tan}(\alpha )+\operatorname{tan}(\beta )}{1-\operatorname{tan}(\alpha )\times \operatorname{tan}(\beta )} $$

通过简单的变换得到： 
$$ \operatorname{arctan}(p)+\operatorname{arctan}(q)=\operatorname{arctan}(\frac{p+q}{1-p\times q} ) $$

由题面给出的转换得：
$$ \frac{1}{a}=\frac{1}{b}+\frac{1}{c} $$

根据简单的变形：$ \frac{1}{a} =\frac{b+c}{b\times c-1} $，令 $ t=b-a $，以 $ t=a $ 为界向左右枚举，找出最小值即可。

```cpp
#include<iostream>
#include<algorithm>
using namespace std;
int main()
{
    unsigned int a, t, ans1, ans2;
    cin >> a;
    for (t = a; t > 0; t--)
    {
        if ((a*a + 1) % t == 0)
        {
            ans1 = t + 2 * a + (a*a + 1) / t;
            break;
            
        }
        
    }
    for (t = a + 1;; t++)
    {
        if ((a*a + 1) % t == 0)
        {
            ans2 = t + 2 * a + (a*a + 1) / t;
            break;
        }
    }
    cout << min(ans1, ans2) << endl;
    return 0;
}
```


---

## 作者：傅思维666 (赞：6)

## 题解：

题解推的好麻烦啊。

利用一个性质：$a<b\le c$。

然后可以推出来$c=\frac{ab+1}{b-a}$，所以b的枚举范围就确定了下来。

最后只要枚举到头就好。

代码：

```cpp
#include<cstdio>
#define int long long
using namespace std;
int a,b,ans;
signed main()
{
	scanf("%lld",&a);
	for(b=a+1;b*(b-a)<=a*b+1;b++)
		if((b*b+1ll)%(b-a)==0)
			ans=(b*b+1ll)/(b-a);
	printf("%lld\n",ans);
	return 0;
}
```



---

## 作者：一只书虫仔 (赞：3)

#### Description

> 给定 $a$，求一组和最小的 $b+c$ 使得：
> $$\arctan\left(\frac 1 a\right)=\arctan\left(\frac1 b\right)+\arctan\left(\frac1 c\right)$$

#### Solution

根据：

$$\arctan(p)+\arctan(q)=\arctan\left(\frac{p+q}{1-pq}\right)$$

可将原式化简：

$$\begin{aligned}\arctan\left(\frac 1 b\right)+\arctan\left(\frac1 c\right)&=\arctan\left(\frac{\frac1 b+\frac 1c}{1-\frac1{bc}}\right)\\&=\arctan\left(\frac{b+c}{bc-1}\right)\\&=\arctan\left(\frac1 a\right)\end{aligned}$$

所以：

$$\begin{aligned}\frac1 a&=\frac{b+c}{bc-1}\\a(b+c)&=bc-1\\ab+ac&=bc-1\\bc-ab&=ac+1\\b(c-a)&=ac+1\\b&=\frac{ac+1}{c-a}\end{aligned}$$

将其代入 $b+c$：

$$\begin{aligned}b+c&=\frac{ac+1}{c-a}+c\\&=\frac{ac+1+c(c-a)}{c-a}\\&=\frac{ac+1+c^2-ac}{c-a}\\&=\frac{c^2+1}{c-a}\\&=\frac{(c^2-a^2)+(a^2+1)}{c-a}\\&=c+a+\frac{a^2+1}{c-a}\end{aligned}$$

由此可知：

$$b=a+\frac{a^2+1}{c-a}$$

可以得到 $a^2+1$ 被 $c-a$ 整除，且 $b>a$。

然后我们将上面那个式子进一步化简为：

$$c+a+\frac{a^2+1}{c-a}=c-a+\frac{a^2+1}{c-a}+2a$$

既然 $2a$ 是定值，那么我们只需要让：

$$c-a+\frac{a^2+1}{c-a}$$

最小化即可。我们都知道积一定，差小和小，既然 $c-a$ 与 $\dfrac{a^2+1}{c-a}$ 的积是 $a^2+1$，这个值是个定值，我们只需要让他们的差最小即可。

所以我们考虑 $c-a$ 的值的求法，发现可以直接枚举，因为 $c-a$ 满足如下两个条件：

- $c-a$ 为 $a^2+1$ 的约数。
- $c-a$ 与 $\sqrt{a^2+1}$ 的差越小越好。

因此，可以在 $[1,a]$ 里枚举查找 $c-a$ 即可，然后 $b,c$ 都可以套公式求出来了。

---

## 作者：Rocherio (赞：2)

# P5695 反正切函数的应用 题解

题目背景里的公式虽然看也看不懂，但是它其实并不重要，我们只需要将条件代入公式 $(4)$ 即可。
$$\arctan (\frac{1}{a})=\arctan (\frac{1}{b})+\arctan (\frac{1}{c}),$$

$$ \arctan(\frac{1}{a})=\arctan(\frac{\frac{1}{b}+\frac{1}{c}}{1-\frac{1}{bc}})=\arctan(\frac{b+c}{bc-1}),$$

$$a=\frac{bc-1}{b+c},$$

$$bc-ab-ac-1=0.$$

下面的推导是靠一个初中生的觉悟。

$$bc-ab-ac+a^2-1=a^2,$$

$$(b-a)(c-a)=a^2+1.$$

因为 $a^2+1$ 大于 $0$，所以 $b-a,c-a$ 同号。

因为 $a,b,c$ 均为正整数，所以 $b-a>-a,c-a>-a$。

当 $b-a<0$ 且 $c-a<0$ 时，有 $(b-a)(c-a)<a^2$，无法满足 $(b-a)(c-a)=a^2+1$。

故 $b-a>0$ 且 $c-a>0$。

由于基本不等式告诉我们：积不变，差小和大，所以当 $b-a$ 和 $c-a$ 的差最小时，$(b-a)+(c-a)$ 最小，即 $b+c$ 最小。

因为 $a,b,c$ 均为正整数，所以 $b-a$ 和 $c-a$ 是 $a^2+1$ 距离最近的两个因数，即最靠近 $\sqrt{a^2+1}$ 的因数。我们求出 $b-a$ 和 $c-a$ 之后，求 $b+c$ 就很简单了。

下面是代码。

```cpp
#include <bits/stdc++.h>
using namespace std;
long long a;
int main(){
	cin >> a;
	for(long long i = sqrt(a * a + 1); i <= a * a + 1; i ++)
		if((a * a + 1) % i == 0){
			cout << (a * a + 1) / i + 2 * a + i;
			return 0;
		}
	return 0;
}
```
注：在代码中我枚举了 $b-a$ 的值，此时 $b+c=(b-a)+(c-a)+2a=(b-a)+\frac{a^2+1}{b-a}+2a$。

同时数据范围为 $a\leq6\times10^4$，$a^2+1$ 可能会超过 int 范围，要开 long long。

---

## 作者：joyslog (赞：0)

题目告诉我们下面这个公式：

$$ \arctan(p) + \arctan(q) = \arctan(\frac{p + q}{1 - p q})$$


代入 $\frac{1}{b},\frac{1}{c}$ 得：

$$ \arctan(\frac{1}{b}) + \arctan(\frac{1}{c}) = \arctan(\frac{\frac{1}{b}+\frac{1}{c}}{1 - \frac{1}{bc}})=\arctan(\frac{b+c}{bc-1})=\arctan(\frac{1}{a})$$

所以：

$$a = \frac{bc-1}{b+c}$$


我们不妨从小到大枚举答案 $b+c$，然后检查答案的合法性。

代入上面的式子，我们得到 $bc=a(b+c)+1$。这说明 $b+c$ 和 $bc$ 都为定值。根据韦达定理逆定理，有 $b,c$ 为下面这个二次方程的两个根：

$$x^2-Mx+N=0$$

其中 $M=b+c,N=bc=a(b+c)+1$。

我们要检查的就是这个方程是否有两正整数根，即满足下面两个条件：

1. $\Delta = M^2-4N>0$ 且为完全平方数。

2. $\frac{M-\sqrt \Delta}{2} > 0$ 且为整数。

这样就能保证 $b,c\in \mathbb{R^+}$，也就是我们枚举的答案合法，这样我们就找到了最小的答案。


```cpp
int main() {
	ll a = read();
	for(ll sum = 2; ; sum++) {
		ll prod = sum * a + 1;
		ll delta = sum * sum - 4 * prod;
		if(delta < 0)	continue;
		ll sq = sqrt(delta);
		if(sq * sq != delta)	continue;
		if((sum + sq) & 1)	continue;
		if(sum - sq <= 0)	continue;
		write(sum); break;
	}
	return 0;
}
```



---

## 作者：QcpyWcpyQ (赞：0)

- 题目告诉了我们一个重要的式子：
$$\arctan(p)+\arctan(q)=\arctan(\dfrac{p+q}{1-pq})$$

因为我们要使：
$$\arctan(\dfrac{1}{a})=\arctan(\dfrac{1}{b})+\arctan(\dfrac{1}{c})$$

$$\begin{aligned}\therefore\arctan(\dfrac{1}{a})&=\arctan(\dfrac{1}{b})+\arctan(\dfrac{1}{c})\\&=\arctan\left(\dfrac{\frac{1}{b}+\frac{1}{c}}{1-\frac{1}{bc}}\right)\\&=\arctan(\dfrac{b+c}{bc-1})\end{aligned}$$

$$\therefore\dfrac{1}{a}=\dfrac{b+c}{bc-1}$$
$$\therefore bc-1=a(b+c)$$
$$\therefore bc-1=ab+ac$$
$$\therefore bc-ab=ac+1$$
$$\therefore b(c-a)=ac+1$$
$$\therefore b=\dfrac{ac+1}{c-a}$$
$$\begin{aligned}\therefore b+c&=c+\dfrac{ac+1}{c-a}\\&=\dfrac{c^2+1}{c-a}\\&=\dfrac{(c^2-a^2)+(a^2+1)}{c-a}\\&=c+a+\dfrac{a^2+1}{c-a}\\&=c-a+\dfrac{a^2+1}{c-a}-2a\end{aligned}$$

- 由于$2a$为已知，左边那一串是对勾函数，因此当$(c-a)$越接近$\left(\dfrac{a^2+1}{c-a}\right)$时，$(b+c)$取最小值。

- 倒序枚举$i\in[1,a]\cap\mathbb{Z}$，使$i|(a^2+1)$且使$i-\sqrt{a^2+1}$最小即可求出答案。

---

## 作者：_WF_ (赞：0)

## 题目理解

由

 $$ \arctan(p)+\arctan(q) = \arctan(\frac{p + q}{1 - p q}) $$
 
 可得 
 
 $$ \arctan(\frac{ 1 }{ b })+\arctan(\frac{ 1 }{ c }) = \arctan(\frac{ b + c }{ b c - 1}) $$
 
 即
 $$ c = \frac{a b+1}{ b - a } $$
 
 所以我们可以枚举 $b$ 来求 $b+c$ 的最小值。
 
 因为 $a b + 1 \ge 1$ 所以 $ b - a > 0$。
 
 也就是 $ b > a$。
 
 所以应从 $a+1$ 开始枚举。
 
 ## 代码实现
 
 ```
#include<bits/stdc++.h>
using namespace std;
int main()
{
	int a;
	cin>>a;
	long long minn=INT_MAX;
	for(long long b=a+1;b<=5000000;b++)//因为 #6 #7 b范围较大
	{
		long long k1=a*b+1,k2=b-a;
		if(k1%k2==0)
		{
			long long c=k1/k2;
			minn=min(minn,b+c);//取较小值
		 } 
	}
	cout<<minn;
}
```


---


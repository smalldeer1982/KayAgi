# ã€ŒdWoi R1ã€Sixth Monokuma's Son

## é¢˜ç›®èƒŒæ™¯

é¢˜ç›®é¦–å…ˆå®šä¹‰çŸ©é˜µç¯ä¸ºï¼Œç»™å®šä¸€ä¸ªçŸ©é˜µ $A$ï¼Œåˆå§‹å…¨ä¸ºç™½è‰²ï¼Œåœ¨å…¶ä¸­é€‰å®šä¸€ä¸ªå­çŸ©é˜µ $A_1$ æ ‡é»‘ï¼Œå†åœ¨ $A_1$ å†…é€‰å®šä¸€ä¸ªå­çŸ©é˜µ $A_2$ æ ‡ç™½ï¼Œå°±ä¼šå½¢æˆä¸€ä¸ªçŸ©é˜µç¯ã€‚æ³¨æ„ï¼ŒçŸ©é˜µç¯è‡³å°‘ä¸Šä¸‹å·¦å³éƒ½æœ‰è¢«é€‰å®šçš„éƒ¨åˆ†ï¼Œä¸”æ•´ä¸ªçŸ©é˜µç¯ä¸æ˜¯ä¸€ä¸ªé•¿æ–¹å½¢çš„çŸ©é˜µã€‚

å‡è®¾ `+` ä¸ºé»‘ï¼Œ`-` ä¸ºç™½ï¼Œä¸‹é¢è¿™ä¸ªå°±æ˜¯çŸ©é˜µç¯ï¼š

```
---+++++--
---++--+--
---+++++--
---+++++--
----------
```

ä¸‹é¢å°±ä¸æ˜¯çŸ©é˜µç¯ï¼š

```
------- ------
---+++- --+++-
---+-+- --+++-
------- --+++-
```

å› æ­¤ï¼ŒçŸ©é˜µç¯ä¼šå‡ºç°ä¸Šï¼Œä¸‹ï¼Œå·¦ï¼Œå³å››æ¡è¾¹ï¼Œæ¯ä¸ªæ–¹å‘æœ‰å¤šå°‘ä¸ªæ¶‚é»‘çš„éƒ¨åˆ†ï¼Œå°±æ˜¯é‚£ä¸ªæ–¹å‘çš„åšåº¦ã€‚æ¯”å¦‚å¯¹äºç¬¬ä¸€å¼ ç¬¦åˆè¦æ±‚çš„å›¾ï¼Œä¸Šæ–¹ï¼Œå³æ–¹çš„åšåº¦ä¸º $1$ï¼Œå·¦æ–¹ï¼Œä¸‹æ–¹çš„åšåº¦ä¸º $2$ã€‚

**æ³¨æ„ï¼Œä¸€ä¸ªå®Œæ•´çš„çŸ©é˜µä¸æ˜¯ä¸€ä¸ªçŸ©é˜µç¯ã€‚**

---

æ¥ä¸‹æ¥æ˜¯æ­£ç»çš„é¢˜ç›®èƒŒæ™¯ï¼š

æœ€åŸå¾—åˆ°äº†â€œç‹±åŸå‘ç°ä¸€äº›å°æ˜†è™«â€è¿™ä¸ªçº¿ç´¢åï¼Œç«‹åˆ»é‡‡å–äº†è¡ŒåŠ¨ã€‚é¦–å…ˆï¼Œä»–åˆ©ç”¨å…¥é—´çš„ ~~é—ç‰©~~ï¼Œé‚£ä¸ªç±»ä¼¼å–·ç«å™¨çš„ä¸œè¥¿ï¼Œå¸è¿›äº†ä¸€äº›ç©ºæ°”ï¼Œç„¶åï¼Œä»–æ‰“ç®—åˆ©ç”¨æœºæœ›çš„æœºæ¢°çœ¼è¿›è¡ŒæŸ¥çœ‹ã€‚

## é¢˜ç›®æè¿°

æœºæœ›çš„æœºæ¢°çœ¼èƒ½æ‰«åˆ°ä¸€ç‰‡ $n \times m$ çš„åŒºåŸŸï¼Œç¬¬ $i$ è¡Œç¬¬ $j$ åˆ—å‘ç°äº† $a_{i,j}$ çš„ä¸å¯¹åŠ²å€¼ã€‚

å› ä¸ºæœºæœ›è¢«å¤–éƒ¨åŠ›é‡æŠ˜ç£¨çš„å‰å®³ï¼Œæ‰€ä»¥æœºæœ›åªèƒ½é”å®šä¸€ä¸ªçŸ©é˜µç¯è¿›è¡ŒæŸ¥çœ‹ã€‚æœºæœ›æƒ³æ±‚åŠ©äºä½ ï¼Œä»–æƒ³è®©ä½ é”å®šä¸€ä¸ªçŸ©é˜µç¯ï¼Œä½¿å¾—è¿™ä¸ªçŸ©é˜µç¯ä¸­çš„æ‰€æœ‰ä½ç½®çš„ä¸å¯¹åŠ²å€¼çš„å’Œæœ€å¤§ï¼Œ**ä¸Šæ–¹ï¼Œä¸‹æ–¹çš„åšåº¦ä¸º $1$ ä¸”ä¸Šæ–¹çš„é‚£ä¸€è¡Œåœ¨æ•´ä¸ªåŒºåŸŸçš„ç¬¬ä¸€è¡Œï¼Œä¸‹æ–¹çš„é‚£ä¸€è¡Œåœ¨æ•´ä¸ªåŒºåŸŸçš„æœ€åä¸€è¡Œ**ã€‚è‡³äºå·¦å³çš„åšåº¦ï¼Œæœºæœ›ä¸é™åˆ¶æ›´å¤šè¦æ±‚ã€‚

## è¯´æ˜/æç¤º

#### æ ·ä¾‹è¯´æ˜

å…³äºæ ·ä¾‹ 1 çš„è§£é‡Šï¼š

å¯ä»¥é€‰æ‹©å¦‚ä¸‹å½¢å¼çš„çŸ©é˜µç¯ï¼ˆä½†å…¶å®ä¸¤ä¸ªè§£æ˜¯ä¸€æ ·çš„ï¼Œå› ä¸ºç¬¬ä¸€åˆ—æ‰€æœ‰æ•°ä¹‹å’Œä¸º $0$ï¼‰ï¼š

```
++++  -+++
++-+  -+-+
++-+  -+-+
++++  -+++
```

å…¶ä¸­ + ä¸ºé€‰å®šçš„ï¼Œ- ä¸ºæœªé€‰å®šçš„ã€‚

å…³äºæ ·ä¾‹ 3ï¼Œæä¾›è€… @[cmll02](https://www.luogu.com.cn/user/171487)ï¼Œæ„Ÿè°¢ä»–çš„è´¡çŒ®ã€‚

#### æ•°æ®è§„æ¨¡ä¸çº¦å®š

**æœ¬é¢˜é‡‡ç”¨æ†ç»‘æµ‹è¯•ã€‚**

- Subtask 1ï¼ˆ5 ptsï¼‰ï¼š$n \le 2$ æˆ– $m \le 2$ã€‚
- Subtask 2ï¼ˆ5 ptsï¼‰ï¼š$a_{i,j}>0$ã€‚
- Subtask 3ï¼ˆ40 ptsï¼‰ï¼š$m \le 1000$ã€‚
- Subtask 4ï¼ˆ50 ptsï¼‰ï¼šæ— ç‰¹æ®Šé™åˆ¶ã€‚

å¯¹äº $100\%$ çš„æ•°æ®ï¼Œ$1 \le n \le 10$ï¼Œ$1 \le m \le 10^5$ï¼Œ$|a_{i,j}| \le 100$ã€‚

## æ ·ä¾‹ #1

### è¾“å…¥

```
4 4
3 -4 2 -2
-5 3 -4 2
-1 3 -4 0
3 -3 3 4```

### è¾“å‡º

```
8```

## æ ·ä¾‹ #2

### è¾“å…¥

```
1 2
11 45```

### è¾“å‡º

```
-1```

## æ ·ä¾‹ #3

### è¾“å…¥

```
7 7
10 10 10 -100 11   11 11
10 10 10 -100 11 -100 11
10 10 10 -100 11 -100 11
10 10 10 -100 11 -100 11
10 10 10 -100 11 -100 11
10 10 10 -100 11 -100 11
10 10 10 -100 11   11 11```

### è¾“å‡º

```
176```

# é¢˜è§£

## ä½œè€…ï¼šwsyhb (èµï¼š11)

## é¢˜æ„ç®€è¿°

å®šä¹‰çŸ©é˜µç¯ä¸º**å°†çŸ©é˜µä¸­çš„ä¸€ä¸ªéç©ºå­çŸ©é˜µå»æ‰åå¾—åˆ°çš„å›¾å½¢**ï¼Œç»™å®šä¸€ä¸ª $n \times m$ çš„çŸ©é˜µ $a$ï¼Œé—®æ‰€æœ‰**ä¸Šä¸‹åšåº¦å‡ä¸º $1$** çš„çŸ©é˜µç¯çš„å…ƒç´ ä¹‹å’Œçš„æœ€å¤§å€¼ã€‚

**æ•°æ®èŒƒå›´**ï¼š$n \le 10$ï¼Œ$m \le 10^5$ï¼Œ$|a_{i,j}| \le 100$

## åˆ†æ + é¢˜è§£

è€ƒè™‘å°†çŸ©é˜µç¯æ‹†æˆå·¦ã€ä¸­ã€å³ä¸‰ä¸ªéƒ¨åˆ†ï¼š

```
--+++++++++-    --+++ ++++ ++-
--+++----++-    --+++ ---- ++-
--+++----++- -> --+++ ---- ++-
--+++----++-    --+++ ---- ++-
--+++++++++-    --+++ ++++ ++-
```

ç”±æ­¤å¯è§ï¼ŒçŸ©é˜µç¯å·¦ã€å³ä¸¤éƒ¨åˆ†ä¸ºè‹¥å¹²ä¸ªå®Œæ•´çš„åˆ—ï¼Œä¸­é—´éƒ¨åˆ†ä¸ºè‹¥å¹²ä¸ªåªæœ‰ä¸Šä¸‹ä¸¤è¡Œçš„åˆ—ï¼Œä¸”**å·¦ã€ä¸­ã€å³ä¸‰éƒ¨åˆ†éƒ½å¿…é¡»éç©º**ã€‚è€ƒè™‘**åˆ†ä¸‰ä¸ªé˜¶æ®µè¿›è¡Œ DP**ã€‚

è®° $s_i$ ä¸ºç¬¬ $i$ åˆ—å…ƒç´ ä¹‹å’Œï¼Œ$t_i$ ä¸ºç¬¬ $i$ åˆ—é¦–å°¾å…ƒç´ ä¹‹å’Œï¼Œè®¾ $dp1_i$ è¡¨ç¤º**ä»¥ç¬¬ $i$ åˆ—ä¸ºæ­¢**çš„**å·¦**è¾¹éƒ¨åˆ†çš„å…ƒç´ ä¹‹å’Œæœ€å¤§å€¼ï¼Œ$dp2_i$ è¡¨ç¤ºä»¥ç¬¬ $i$ åˆ—ä¸ºæ­¢çš„**å·¦ã€ä¸­**éƒ¨åˆ†çš„å…ƒç´ ä¹‹å’Œæœ€å¤§å€¼ï¼Œ$dp3_i$ è¡¨ç¤ºä»¥ç¬¬ $i$ åˆ—ä¸ºæ­¢çš„**å·¦ã€ä¸­ã€å³**éƒ¨åˆ†çš„å…ƒç´ ä¹‹å’Œæœ€å¤§å€¼ï¼Œåˆ™æœ‰ä¸‹åˆ—è½¬ç§»æ–¹ç¨‹ï¼š

$$dp1_i=\max(dp1_{i-1},0)+s_i$$

$$dp2_i=\max(dp2_{i-1},dp1_{i-1})+t_i$$

$$dp3_i=\max(dp3_{i-1},dp2_{i-1})+s_i$$

**è¯´æ˜**ï¼šæ¯ä¸€é˜¶æ®µå¯ä»¥ç”±**è¿™ä¸€éƒ¨åˆ†æˆ–ä¸Šä¸€éƒ¨åˆ†åŠ ä¸Šè¿™ä¸€åˆ—**è½¬ç§»è€Œæ¥ã€‚ç”±äºæ¯ä¸€éƒ¨åˆ†å¿…é¡»éç©ºï¼Œ$dp1_0=dp2_0=dp3_0=-inf$ã€‚

åˆ«å¿˜äº†è‹¥ $n \le 2$ æˆ– $m \le 2$ï¼Œä¸å­˜åœ¨çŸ©é˜µç¯ï¼Œå³**æ— è§£**ã€‚

## ä»£ç 

ä»£ç éå¸¸åœ°å¥½å†™~

``` cpp
#include<bits/stdc++.h>
using namespace std;
const int max_n=10+5;
const int max_m=1e5+5;
int s[max_m],t[max_m];
int dp1[max_m],dp2[max_m],dp3[max_m];
int main()
{
	int n,m;
	scanf("%d%d",&n,&m);
	if(n<=2||m<=2)//åˆ¤æ— è§£ 
	{
		puts("-1");
		return 0;
	}
	for(int i=1;i<=n;++i)
		for(int j=1;j<=m;++j)
		{
			int a;
			scanf("%d",&a);
			s[j]+=a;
			if(i==1||i==n)
				t[j]+=a;
		}//ç›´æ¥è¯»å…¥å¹¶æ›´æ–° s å’Œ tï¼Œæ— éœ€å­˜å‚¨ 
	dp1[0]=dp2[0]=dp3[0]=-1e9;//åˆå§‹åŒ– 
	int ans=-1e9;
	for(int i=1;i<=m;++i)
	{
		dp1[i]=max(dp1[i-1],0)+s[i];
		dp2[i]=max(dp2[i-1],dp1[i-1])+t[i];
		dp3[i]=max(dp3[i-1],dp2[i-1])+s[i]; 
		ans=max(ans,dp3[i]);//æ›´æ–°ç­”æ¡ˆ 
	}
	printf("%d\n",ans);
	return 0;
}
```

---

## ä½œè€…ï¼šxuan_gong_dong (èµï¼š5)

## é¢˜ç›®
[P7160 ã€ŒdWoi R1ã€Sixth Monokuma's Son](https://www.luogu.com.cn/problem/P7160)

é¢˜ç›®å¤§æ„ï¼šç»™ä½ ä¸€ä¸ª $n \times m$ çš„çŸ©å½¢ $(n\le10,m\le10^5)$ï¼Œè¦æ±‚ä½ å¯»æ‰¾ä¸€ä¸ªä¸­ç©ºçš„**çŸ©é˜µç¯**ï¼Œä½¿å¾—å…¶è¦†ç›–çš„éƒ¨åˆ†**å’Œæœ€å¤§**ã€‚

## åºŸè¯
ä¸€å¼€å§‹çœ‹åˆ° $n\le 10$ è¿˜ä»¥ä¸ºæ˜¯çŠ¶æ€å‹ç¼©ã€‚æƒ³äº†å˜å¤©é‡æ–°ç†è§£é¢˜æ„çš„æ—¶å€™æ‰å‘ç°é¢˜æ„è¯»é”™äº†æã€‚

## åˆ†æ
å‘ç°è¿™ä¸ªæ‰€æ±‚å›¾å½¢å¯ä»¥è¢«åˆ†æˆä¸‰ä¸ªéƒ¨åˆ†ã€‚å¦‚å›¾æ‰€ç¤º
![](https://cdn.luogu.com.cn/upload/image_hosting/a2o9gh70.png)

ä¸å¦¨è®¾ $pre_i=\sum_{j=1}^n a_{ij}$ è¡¨ç¤ºçš„å«ä¹‰æ˜¯ç¬¬ $i$ åˆ—çš„æ•°å’Œã€‚
å†è®¾ $hys_i$ ä¸º $a_i$ ä¸ $a_n$ çš„å’Œã€‚

å†è®¾ $dp0_i$ ä¸ºæšä¸¾åˆ°ç¬¬ $i$ åˆ—æ—¶å·¦è¾¹é‚£ä¸€å—çš„å’Œçš„æœ€å¤§å€¼ï¼Œ$dp1_i$ ä¸ºæšä¸¾åˆ°ç¬¬ $i$ åˆ—æ—¶å·¦è¾¹é‚£ä¸€å—ä¸ä¸­é—´é‚£ä¸¤å—çš„å’Œçš„æœ€å¤§å€¼ã€‚$dp2_i$ ä¸ºæšä¸¾åˆ°ç¬¬ $i$ åˆ—æ—¶çŸ©é˜µç¯çš„æœ€å¤§å€¼ã€‚

æ˜“å¾—è½¬ç§»æ–¹ç¨‹ 

$$dp0_i=\max(dp0_{i-1},0)+pre_i$$
$$dp1_i=\max(dp1_{i-1},dp0_{i-1})+hys_i$$
$$dp2_i=\max(dp2_{i-1},dp1_{i-1})+pre_i$$

ç­”æ¡ˆå°±æ˜¯æ‰€æœ‰ $dp2_i$ çš„æœ€å¤§æ•°ã€‚

## ç»†èŠ‚
å½“ $n \le 2$ ä¸” $m \le 2$ æ—¶å‘ç°æ— æ³•ä¸­ç©ºï¼Œåˆ™æ­¤æƒ…å†µä¸€å®šæ— è§£ã€‚

```cpp
#include<bits/stdc++.h>
using namespace std;
int dp[100010][3];
int a[15][100010];
int pre[100010];//è¡¨ç¤ºç¬¬iåˆ—çš„æ•°å’Œ
int hys[100010];//è¡¨ç¤ºç¬¬iåˆ—çš„ä¸Šä¸‹ä¸¤ä¸ªæ•°ä¹‹å’Œ
int n,m;
inline int read() {
	int x=0,f=0;
	char c=getchar();
	while(!isdigit(c)) {
		f|=c=='-';
		c=getchar();
	}
	while(isdigit(c)) {
		x=(x<<3)+(x<<1)+(c^48);
		c=getchar();
	}
	return f?-x:x;
}
int main() {
	n=read(),m=read();
	if(n<=2&&m<=2) {
		printf("-1");
		exit(0);
	}
	for(int i=1; i<=n; i++)
		for(int j=1; j<=m; j++)
			a[i][j]=read();
	for(int i=1; i<=m; i++) {
		for(int j=1; j<=n; j++)
			pre[i]+=a[j][i];
		hys[i]=a[1][i]+a[n][i];
	}
	int Max=-2e9;
	for(int i=1; i<=m; i++) {
		dp[i][0]=max(dp[i-1][0],0)+pre[i];//ç¬¬ä¸€éƒ¨åˆ† 
		if(i!=1) { 
			if(i!=m)
				dp[i][1]=max(dp[i-1][0],dp[i-1][1])+hys[i];//ç¬¬äºŒéƒ¨åˆ† 
			dp[i][2]=max(dp[i-1][1],dp[i-1][2])+pre[i];//ç¬¬ä¸‰éƒ¨åˆ† 
			Max=max(Max,dp[i][2]);//æ±‚å¾—ç­”æ¡ˆ 
		}
	}
	printf("%d",Max);
	return 0;
}
```


---

## ä½œè€…ï¼šä¸€åªä¹¦è™«ä»” (èµï¼š5)

![](https://cdn.luogu.com.cn/upload/image_hosting/zxxf3qro.png)

$$\sf\color{LimeGreen}dWoi\ Round\ 1\ D\ Sixth\ Monokuma's\ Son$$

æ³¨æ„æœ¬æ–‡çš„å¤æ‚åº¦åˆ†æå¯èƒ½æ²¡å¸¦ä¸Šè¾“å…¥çš„å¤æ‚åº¦ã€‚

#### Description

> ç»™å®šä¸€ä¸ª $n \times m$ çš„çŸ©é˜µï¼Œæ±‚ä¸€ä¸ªä¸Šä¸‹åšåº¦ä¸º $1$ ä¸”ä¸Šé¢é‚£ä¸€è¡Œå±äºçŸ©é˜µçš„ç¬¬ä¸€è¡Œï¼Œä¸‹é¢é‚£ä¸€è¡Œå±äºçŸ©é˜µçš„æœ€åä¸€è¡Œçš„çŸ©é˜µç¯ä½¿å¾—çŸ©é˜µç¯é‡Œçš„æ•°å­—å’Œæœ€å¤§ã€‚          
> $1 \le n \le 10$ï¼Œ$1 \le m \le 10^5$ï¼Œ$|a_{i,j}| \le 100$

#### Subtask 1

çº¦æŸæ¡ä»¶ï¼š$n \le 2$ æˆ– $m \le 2$ã€‚

æ²¡æœ‰ç¬¦åˆè¦æ±‚çš„çŸ©é˜µç¯ï¼Œè¾“å‡º $-1$ã€‚

#### Subtask 2

çº¦æŸæ¡ä»¶ï¼š$a_{i,j}>0$ã€‚

è¿™æ—¶è‚¯å®šé€‰çš„æ•°è¶Šå¤šè¶Šå¥½ï¼Œä½†ä½ ä¸èƒ½é€‰æ‹©ä¸€ä¸ªæ•´çŸ©é˜µï¼Œå› æ­¤é€‰æ‹©ä¸ä¸ºç¬¬ $1$ åˆ—å’Œç¬¬ $m$ åˆ—çš„ä¸€åˆ—ä¸­é™¤å»ç¬¬ä¸€ä¸ªæ•°å’Œç¬¬ $n$ ä¸ªæ•°å’Œæœ€å°çš„ä¸€åˆ—ï¼ŒæŠŠä»–çš„å’Œå‡æ‰å³å¯ã€‚

#### Subtask 3

çº¦æŸæ¡ä»¶ï¼š$1 \le m \le 2000$ã€‚

æˆ‘ä»¬é¦–å…ˆæŠŠæ•´ä¸ªçŸ©é˜µç¯æ‹†ä¸€ä¸‹ï¼š

```
---+++++++--    ---++ ++++ +--
---++----+--    ---++ ---- +--
---++----+-- -> ---++ ---- +--
---++----+--    ---++ ---- +--
---+++++++--    ---++ ++++ +--
```

å·¦è¾¹ï¼Œå³è¾¹å…¶å®éƒ½å¯ä»¥åšä¸€ä¸ªæœ€å¤§å­æ®µå’Œï¼Œåªè¦æŠŠä¸€è¡Œçš„æ‰€æœ‰ $a[i][j]$ å€¼åŠ èµ·æ¥å³å¯ï¼Œè¿™ä¸ªé¢„å¤„ç†å¹¶ä¸éº»çƒ¦ã€‚

æ‰€ä»¥ï¼Œæˆ‘ä»¬åªéœ€è¦æšä¸¾ä¸­é—´å³å¯ï¼Œæ—¶é—´å¤æ‚åº¦å¤§çº¦ä¸º $\mathcal O(m^2)$ã€‚

#### Subtask 4

æˆ‘ä»¬æŠŠä¸Šé¢çŸ©é˜µç¯å·¦è¾¹å³è¾¹çš„ç©ºæ ¼å»æ‰åå†åˆ†æ‹†ï¼Œå¦‚ä¸‹ï¼š

```
++ ++++ +
++ ---- +
++ ---- +
++ ---- +
++ ++++ +
```

æ•´ä¸ªçŸ©é˜µç¯å¯ä»¥çœ‹åšæ˜¯ä¸‰ä¸ªéƒ¨åˆ†ï¼Œæœ€å·¦è¾¹çš„é•¿æ¡ï¼Œæœ€å·¦è¾¹åŠ ä¸Šæœ€ä¸­é—´çš„ $C$ å½¢ï¼Œå·¦ä¸­å³åŠ èµ·æ¥çš„çŸ©é˜µç¯ã€‚

é‚£ä¹ˆï¼Œæˆ‘ä»¬å…¶å®å¯ä»¥è¿™ä¸‰éƒ¨åˆ†åˆ†åˆ«è¿›è¡ŒåŠ¨å½’è®¡ç®—ä¸€ä¸ªå¤§çš„æœ€å¤§å­æ®µå’Œã€‚

å‡è®¾ $dp1[i]$ ä»£è¡¨ç»è¿‡ç¬¬ $i$ åˆ—åé•¿æ¡çš„æœ€å¤§å­æ®µå’Œï¼Œ$dp2[i]$ ä»£è¡¨ç»è¿‡ç¬¬ $i$ åˆ—å $C$ å½¢çš„æœ€å¤§å­æ®µå’Œï¼Œ$dp3[i]$ ä»£è¡¨ç»è¿‡ç¬¬ $i$ åˆ—åçŸ©é˜µç¯çš„æœ€å¤§å­æ®µå’Œï¼Œè¿™ä¸‰ä¸ªç±»å‹å…¶å®å¯ä»¥äº’ç›¸è½¬æ¢ã€‚

é¦–å…ˆï¼Œé¢„å¤„ç† $s[i]=\sum\limits_{j=1}^n a[i][j]$ï¼Œå³ç¬¬ $i$ åˆ—æ‰€æœ‰æ•°ä¹‹å’Œï¼Œ$t[i]=a[i][1]+a[i][n]$ï¼Œå³ç¬¬ $i$ åˆ—ç¬¬ $1$ ä¸ªå’Œç¬¬ $n$ ä¸ªæ•°ä¹‹å’Œã€‚

ç„¶åæˆ‘ä»¬æ¥åˆ†ææœ€å¤§å­æ®µå’Œï¼š

- $dp1[i]=\max\{dp1[i-1],0\}+s[i]$ï¼Œæœ€ç®€å•çš„æœ€å¤§å­æ®µå’Œã€‚
- $dp2[i]=\max\{dp1[i-1],dp2[i-1]\}+t[i]$ï¼Œå› ä¸ºä¸€ä¸ª $C$ å½¢å—å¯ä»¥æ˜¯ä¸€ä¸ªé•¿æ¡åŠ ä¸Š $t[i]$ ä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ª $C$ è¡Œå—åŠ ä¸Šä¸€ä¸ª $t[i]$ã€‚
- $dp3[i]=\max\{dp2[i-1],dp3[i-1]\}+s[i]$ï¼Œå› ä¸ºä¸€ä¸ªçŸ©å½¢ç¯å¯ä»¥æ˜¯ä¸€ä¸ª $C$ å½¢å—åŠ ä¸Šä¸€ä¸ª $s[i]$ ä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªçŸ©å½¢ç¯åŠ ä¸Šä¸€ä¸ª $s[i]$ã€‚

ç„¶åè¾“å‡º $dp3[m]$ å³å¯ã€‚

å¦‚æœé¢„å¤„ç†å¾ˆä¼˜ç§€çš„è¯ï¼Œé‚£ä¹ˆèƒ½åšåˆ° $\mathcal O(m)$ã€‚

#### Code

```cpp
#include <bits/stdc++.h>

using namespace std;

long long s[10000005];
long long t[10000005];

long long dp1[10000005];
long long dp2[10000005];
long long dp3[10000005];

int main () {
    int n, m;
    scanf("%d%d", &n, &m);
    memset(dp1, -0x3f, sizeof(dp1));
    memset(dp2, -0x3f, sizeof(dp2));
    memset(dp3, -0x3f, sizeof(dp3));
    if (n <= 2 || m <= 2) {
        puts("-1");
        return 0;
    }
    for (int i = 1; i <= n; i++)
        for (int j = 1; j <= m; j++) {
            long long a;
            scanf("%lld", &a);
            s[j] += a;
            if (i == 1 || i == n) t[j] += a;
        }
    for (int i = 1; i <= m; i++) {
        dp1[i] = max(dp1[i - 1], 0ll) + s[i];
        if (i != 1 && i != n) dp2[i] = max(dp1[i - 1], dp2[i - 1]) + t[i];
        if (i != 1) dp3[i] = max(dp2[i - 1], dp3[i - 1]) + s[i];
    }
    long long Max = -0x3f;
    for (int i = 1; i <= m; i++) Max = max(Max, dp3[i]);
    printf("%lld", Max);
    return 0;
}
```

---

é™„èµ æ¥è‡ª lgswdn çš„è§£ï¼š

è€ƒè™‘çŸ©é˜µç¯çš„ç»„æˆï¼Œå¯ä»¥æ‹†æˆä¸‰éƒ¨åˆ†ï¼šå·¦è¾¹ä¸€ä¸ª $p\times n$ çš„çŸ©é˜µï¼Œä¸­é—´ä¸Šä¸‹ä¸¤æ¡ï¼Œä»¥åŠå³è¾¹ä¸€ä¸ª $q\times n$  çš„çŸ©é˜µã€‚è€ƒè™‘è®¾ $f(i)$ ä¸ºæ»¡è¶³ $l=i, r\in [i,n]$ ä¸­æ€»å’Œæœ€å¤§çš„ï¼Œæœ€å·¦è¾¹ä¸º $l$ è¿™ä¸€åˆ—ï¼Œæœ€å³è¾¹ä¸º $r$ è¿™ä¸€åˆ—çš„å­çŸ©é˜µçš„ $a_{i,j}$ çš„æ€»å’Œã€‚è®¾ $h_i$ è¡¨ç¤ºç¬¬ $i$ åˆ—çš„ $a$ ä¹‹å’Œã€‚æ˜¾ç„¶è¿™ä¸ªå¯ä»¥ç›´æ¥ $dp: $ $f(i)=\max(f(i+1),0)+h_i$ã€‚

æˆ‘ä»¬å†çœ‹å·¦è¾¹çš„æƒ…å†µã€‚è®¾ $g(i)$ è¡¨ç¤º $r=i,l\in [1,i]$ çš„æ€»å’Œæœ€å¤§çš„ï¼Œæœ€å·¦è¾¹ä¸º $l$ è¿™ä¸€åˆ—ï¼Œæœ€å³è¾¹ä¸º $r$ è¿™ä¸€åˆ—çš„å­çŸ©é˜µã€‚äºæ˜¯ï¼Œ$ans=\max_i g(i)+\max_{j\ge i+2}\{f_j+\sum_{k=i+1}^{j-1}h_k\}$ã€‚æˆ‘ä»¬ä¸­é—´è¿™ä¸ªæ±‚å’Œç”¨å‰ç¼€å’Œ $s_i=\sum_{j=1}^{i} h_j$æ‹†å¼€ï¼Œå¾—åˆ°
$$
ans=\max_i g(i)+\max_{j\ge i+2} \{f_j+s_{j-1}-s_{i}\}ã€‚
$$

æ˜¾ç„¶åé¢çš„ $s_i$ å¯ä»¥ç§»å‡ºæ¥ã€‚é¢„è®¡ç®— $mf(i)=\max _{j\ge i} f_j+s_{j-1}$

å¯ä»¥ç›´æ¥ç®—å‡ºçš„ç­”æ¡ˆ

$$
ans=\max_i g(i)-s_i+mf(i+2)
$$

å¤æ‚åº¦ $\mathcal O(nm)$ã€‚

ä»£ç ï¼š

```cpp
#include<bits/stdc++.h>
#define int long long
#define rep(i,a,b) for(register int i=(a);i<=(b);i++)
#define per(i,a,b) for(register int i=(a);i>=(b);i--)
using namespace std;
const int N=19,M=1e5+9,minf=-0x3f3f3f3f3f3f3f3f;

inline int read() {
    register int x=0, f=1; register char c=getchar();
    while(c<'0'||c>'9') {if(c=='-') f=-1; c=getchar();}
    while(c>='0'&&c<='9') {x=(x<<3)+(x<<1)+c-48,c=getchar();}
    return x*f;
}

int n,m,a[N][M],st[M],h[M],f[M],mf[M],ans=minf;

signed main() {
	n=read(), m=read();
	if(n<=2||m<=2) {
		puts("-1");
		return 0;
	}
	rep(i,1,n) rep(j,1,m) a[i][j]=read();
	rep(j,1,m) st[j]=st[j-1]+a[1][j]+a[n][j];
	rep(j,1,m) rep(i,1,n) h[j]+=a[i][j];
	per(j,m,3) f[j]=max(0ll,f[j+1])+h[j];
	mf[m+1]=minf;
	per(j,m,3) mf[j]=max(mf[j+1],f[j]+st[j-1]);
	int sum=0;
	rep(j,1,m-2) {
		sum=max(0ll,sum)+h[j];
		ans=max(ans,sum+mf[j+2]-st[j]);
	}
	printf("%lld\n",ans);
	return 0;
}
```

---

## ä½œè€…ï¼šKohakuwu (èµï¼š4)

## å‰è¨€
è¿™ç¯‡é¢˜è§£ä¼šæ•™æ‚¨å¦‚ä½•æŠŠé»„é¢˜å½“è“é¢˜å†™ã€‚
## æ€è·¯
é¦–å…ˆç¡®è®¤ $n,m\geq 3$ï¼Œä¸ç„¶è¾“å‡º $-1$ã€‚

æˆ‘ä»¬è®°æ¯ä¸€åˆ—çš„æ€»å’Œä¸º $a_i$ï¼Œæ¯ä¸€åˆ—å»æ‰ç¬¬ä¸€è¡Œå’Œæœ€åä¸€è¡Œçš„å’Œä¸º $b_i$ã€‚

å†è®° $b_l,b_{l+1},b_{l+2},\cdots,b_r$ çš„æœ€å¤§å­æ®µå’Œä¸º $B_{l,r}$ï¼Œ

é‚£ä¹ˆé¢˜æ„å³æ±‚å‡º $\max\limits_{l=1}^{n-2}\max\limits_{r=l+2}^n(\sum\limits_{i=l}^ra_i+B_{l+1,r-1})$ï¼Œå³ä¸€æ®µ $a_i$ çš„å’Œå‡æ‰ä¸€æ®µ $b_i$ çš„å’Œï¼Œè¦æ±‚ $b_i$ è¿™æ®µè¢« $a_i$ ä¸¤ç«¯è¦†ç›–ã€‚

æ³¨æ„åˆ°æœ€å¤§å­æ®µå’Œé—®é¢˜å¯ä»¥ç”¨**çº¿æ®µæ ‘**ç»´æŠ¤ï¼Œæ­¤é¢˜æˆ‘ä»¬åŒæ ·ç”¨çº¿æ®µæ ‘ç»´æŠ¤ã€‚

è€ƒè™‘ä¸€ä¸‹ç­”æ¡ˆçš„å‡ ç§å¯èƒ½ï¼š

1. ç­”æ¡ˆå®Œå…¨åœ¨å·¦åŒºé—´å†…ã€‚
2. ç­”æ¡ˆå®Œå…¨åœ¨å³åŒºé—´å†…ã€‚
3. $a$ æ•°ç»„çš„å’Œè·¨è¶Šå·¦å³ï¼Œ$b$ æ•°ç»„å®Œå…¨åœ¨å·¦è¾¹ã€‚
4. $a$ æ•°ç»„çš„å’Œè·¨è¶Šå·¦å³ï¼Œ$b$ æ•°ç»„å®Œå…¨åœ¨å³è¾¹ã€‚
5. $a,b$ æ•°ç»„çš„å’Œè·¨è¶Šå·¦å³ã€‚

å› æ­¤æˆ‘ä»¬è¦è®°å½•è¿™äº›ä¿¡æ¯ï¼š

1. åŒºé—´çš„ç­”æ¡ˆã€‚
2. åŒºé—´çš„å‰ç¼€å’Œæœ€å¤§å€¼ã€‚
3. åŒºé—´çš„åç¼€å’Œæœ€å¤§å€¼ã€‚
4. åŒºé—´çš„å‰ç¼€ç­”æ¡ˆæœ€å¤§å€¼ã€‚å®šä¹‰å‰ç¼€ç­”æ¡ˆå³ä¸€ä¸ª $a$ çš„å‰ç¼€å’Œå‡å»ä¸€ä¸ª $b$ çš„å‰ç¼€å’Œï¼ŒåŒæ—¶ $b$ çš„é•¿åº¦ä¸¥æ ¼å°äº $a$ã€‚
5. åŒºé—´çš„åç¼€ç­”æ¡ˆæœ€å¤§å€¼ã€‚
6. åŒºé—´çš„å‰ç¼€æœ€å¤§å€¼ã€‚
7. åŒºé—´çš„åç¼€æœ€å¤§å€¼ã€‚

äºæ˜¯æˆ‘ä»¬å°±å¾—åˆ°äº†ä¸€ä»½æä¸‘çš„ $O(nm+n\log n)$ ä»£ç ï¼š
## ä»£ç 
```
#include<bits/stdc++.h>
using namespace std;
inline int read(){
   int s=0,w=1;
   char ch=getchar();
   while(ch<'0'||ch>'9'){if(ch=='-')w=-1;ch=getchar();}
   while(ch>='0'&&ch<='9') s=s*10+ch-'0',ch=getchar();
   return s*w;
}
int a[100003],b[100003];
struct node
{
	int pre,PRE,suf,SUF,pre0,suf0,pre1,suf1,ans;
};
#define newnode (node){-1000000000,-1000000000,-1000000000,-1000000000,-1000000000,-1000000000,-1000000000,-1000000000,-1000000000}
node getans(int l,int r)
{
	if(l==r) return newnode;
	int mid=(l+r)>>1;
	node L=getans(l,mid),R=getans(mid+1,r),res=newnode;
	res.ans=max(max(max(L.ans,R.ans),max(L.SUF+R.pre,L.suf+R.PRE)),max(L.suf0+R.pre1,L.suf1+R.pre0));
	for(int i=l,x=0,y=0,t=0x3f3f3f3f; i<=r; i++) x+=a[i],y+=b[i],res.pre=max(res.pre,x-t),res.PRE=max(res.PRE,x-min(t,0)),t=min(t,y);
	for(int i=r,x=0,y=0,t=0x3f3f3f3f; i>=l; i--) x+=a[i],y+=b[i],res.suf=max(res.suf,x-t),res.SUF=max(res.SUF,x-min(t,0)),t=min(t,y);
	for(int i=l,x=0; i<=r; i++) x+=a[i],res.pre1=max(res.pre1,x);
	for(int i=r,x=0; i>=l; i--) x+=a[i],res.suf1=max(res.suf1,x);
	for(int i=l,x=0,y=0,t=0x3f3f3f3f; i<=r; i++) x+=a[i],y+=b[i],res.pre0=max(res.pre0,x-t),t=min(t,y),y=min(y,0);
	for(int i=r,x=0,y=0,t=0x3f3f3f3f; i>=l; i--) x+=a[i],y+=b[i],res.suf0=max(res.suf0,x-t),t=min(t,y),y=min(y,0);
	return res;
}
signed main()
{
	//freopen("D.in","r",stdin);
	//freopen("D.ans","w",stdout);
	int m=read()-2,n=read();
	if(n<3||m<1) puts("-1"),exit(0); 
	for(int i=1; i<=n; i++) a[i]+=read();
	for(;m--;) for(int i=1; i<=n; i++) b[i]+=read();
	for(int i=1; i<=n; i++) a[i]+=read(),a[i]+=b[i];
	printf("%d\n",getans(1,n).ans);
	return 0;
} 
```

---

## ä½œè€…ï¼šç¿¼å¾·å¤©å°Š (èµï¼š1)

ç–¯ç‹‚åˆ· $\text{dp}$ é¢˜&&å†™ $\text{dp}$ é¢˜é¢˜è§£$\text{.jpg}$

æœ¬é¢˜è§£ä¸»è¦å°±è§£é¢˜æ€è·¯æ–¹é¢è¿›è¡Œåˆ†æã€‚

------------

é¦–å…ˆè¯»é¢˜ã€‚

æˆ‘ä»¬ä»é¢˜ç›®ä¸­çš„ä¸€ä¸ªå°ç»†èŠ‚â€”â€”ç¬¬ä¸€è¡Œå’Œæœ€åä¸€è¡Œå¿…é¡»é€‰â€”â€”å¯ä»¥å‘ç°ï¼Œæˆ‘ä»¬çš„è¿™ä¸ªçŸ©é˜µç¯ä¸èƒ½å°†åˆ—åˆ†å‰²å¼€æ¥ã€‚ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿæ„æ€å°±æ˜¯è¯´ï¼Œå¯¹äºä¸€åˆ—çš„å…ƒç´ ï¼Œæ˜¯ä¸ä¼šæœ‰çš„æ¡†å…¥çŸ©é˜µç¯ï¼Œæœ‰çš„ä¸æ¡†çš„ã€‚

æ‰€ä»¥æ ¹æ®è¿™ä¸ªç»†èŠ‚ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆè‡ªç„¶åœ°å°†è¯¥çŸ©é˜µåˆ†ä¸º $3$ ä¸ªéƒ¨åˆ†ï¼šå·¦ä¾§éƒ¨åˆ†ï¼Œä¸­ä¾§åªé€‰é¦–å°¾éƒ¨åˆ†ï¼Œå³ä¾§éƒ¨åˆ†ã€‚æ‹¿æ ·ä¾‹ä¸ºä¾‹ï¼Œå¯ä»¥åˆ†å‰²æˆï¼š

```
++|+|+
++|-|+
++|-|+
++|+|+
```

å¯¹åº”çš„ï¼Œæˆ‘ä»¬å¯ä»¥å°†çŸ©é˜µé¢„å¤„ç†ä¸€ä¸‹ï¼Œæå‰æ±‚å‡ºæ¯ä¸€åˆ—çš„å’Œä»¥åŠé¦–å°¾å…ƒç´ å’Œã€‚

ä¸‹é¢å°±å¼€å§‹è¿›è¡Œ $\text{dp}$ äº†ã€‚

------------

å› ä¸ºæˆ‘ä»¬è®¾ç½®äº†ä¸‰ä¸ªéƒ¨åˆ†ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿå¯ä»¥å¯¹åº”å°† $dp$ æ•°ç»„è®¾ç½®æˆä¸‰ä¸ªï¼Œæˆ–è€…å¤šåŠ ä¸€ç»´ã€‚$dp_{i,0}$ è¡¨ç¤ºå‰ $i$ åˆ—åŒ–ä¸ºç¬¬ä¸€éƒ¨åˆ†æ—¶çš„æœ€å¤§å€¼ï¼Œ$dp_{i,1}$ è¡¨ç¤ºå‰ $i$ åˆ—åŒ–ä¸ºç¬¬ä¸€ã€äºŒéƒ¨åˆ†æ—¶çš„æœ€å¤§å€¼ï¼Œ$dp_{i,2}$ è¡¨ç¤ºå‰ $i$ åˆ—åŒ–ä¸ºç¬¬ä¸€ã€äºŒã€ä¸‰éƒ¨åˆ†æ—¶çš„æœ€å¤§å€¼ã€‚ä¸‹é¢æˆ‘ä»¬æ¥è€ƒè™‘ä¸€ä¸‹è½¬ç§»æ–¹ç¨‹ã€‚ï¼ˆä¸‹é¢è®¾ç¬¬ $i$ åˆ—ä¹‹å’Œä¸º $sum_i$ï¼Œç¬¬ $i$ åˆ—çš„é¦–å°¾å’Œä¸º $sw_i$ï¼‰

é¦–å…ˆå…ˆæ¥æ€è€ƒç¬¬ä¸€ä¸ª $dp$ æ•°ç»„çš„è½¬ç§»æ–¹ç¨‹ã€‚å®ƒçš„å€¼çš„ç”±æ¥åº”è¯¥å¯ä»¥åˆ†ä¸ºä¸¤ç§æƒ…å†µï¼Œä¸€ç§æ˜¯æ¥ç€å‰é¢é€‰çš„ï¼ˆå³å‰é¢å·²ç»æœ‰å‡ åˆ—ï¼‰ï¼Œä¸€ç§æ˜¯æ–°é€‰çš„ï¼ˆå³æˆä¸ºå·¦ä¾§éƒ¨åˆ†çš„ç¬¬ä¸€åˆ—ï¼‰ã€‚é‚£ä¹ˆå°†è¿™ä¸¤ç§æƒ…å†µé€‰ä¸€ä¸ªæœ€å¤§å€¼å°±å¯ä»¥äº†ã€‚å³ï¼š

$$dp_{i,0}=max\left\{dp_{i-1,0}+sum_i,sum_i\right\}$$

ç”±äºä¸¤è¾¹éƒ½æœ‰ $sum_i$ï¼Œæ‰€ä»¥å¯åŒ–ä¸ºï¼š

$$dp_{i,0}=max\left\{dp_{i-1,0},0\right\}+sum_i$$

å†æ¥æ€è€ƒç¬¬äºŒä¸ª $dp$ æ•°ç»„ã€‚å®ƒçš„å€¼çš„ç”±æ¥ä¹Ÿå¯ä»¥åˆ†ä¸ºä¸¤ç§æƒ…å†µï¼Œä¸€ç§æ˜¯å‰é¢ä¸€åˆ—ä¸ºå·¦ä¾§éƒ¨åˆ†ï¼Œä¸€ç§æ˜¯å‰é¢ä¸€åˆ—ä¸ºä¸­ä¾§éƒ¨åˆ†ã€‚å°†è¿™ä¸¤ç§æƒ…å†µå–ä¸€ä¸ªæœ€å¤§å€¼å³ä¸ºè¯¥æ•°ç»„çš„è½¬ç§»æ–¹ç¨‹ï¼Œå³ï¼š

$$dp_{i,1}=max\left\{dp_{i-1,0},dp_{i-1,1}\right\}+xw_i$$

ç¬¬ä¸‰ä¸ª $dp$ æ•°ç»„ä¸ç¬¬äºŒä¸ªåŒç†ï¼Œå³ï¼š

$$dp_{i,2}=max\left\{dp_{i-1,1},dp_{i-1,2}\right\}+sum_i$$

æœ€ç»ˆçš„ç­”æ¡ˆå³ä¸ºæ‰€æœ‰çš„ç¬¬ä¸‰ä¸ª $dp$ æ•°ç»„çš„æœ€å¤§å€¼ã€‚

å“¦ï¼Œå¯¹äº†ï¼Œåˆ«å¿˜äº†ç‰¹åˆ¤å½“çŸ©é˜µä»»æ„ä¸€è¾¹é•¿å°äºç­‰äº $2$ æ—¶ï¼Œç­”æ¡ˆä¸º $-1$ã€‚

------------

### AC ä»£ç å¦‚ä¸‹ï¼š

```cpp
#include<bits/stdc++.h>
using namespace std;
#define N 100005
#define INF 999999999
int n,m,l[N],sw[N],dp[N][3],ans=-INF;
int read(){//å¿«è¯»
	int w=0,f=1;
	char c=getchar();
	while (c>'9'||c<'0'){
		if (c=='-') f=-1;
		c=getchar();
	}
	while (c<='9'&&c>='0'){
		w=(w<<3)+(w<<1)+(c^48);
		c=getchar();
	}
	return w*f;
}

int main(){
	n=read(),m=read();
	for (int i=0;i<3;i++) dp[0][i]=-INF;//åˆå§‹åŒ–
	if (n<=2||m<=2){//ç‰¹åˆ¤
		puts("-1");
		return 0;
	}
	for (int i=1;i<=n;i++)//è¯»å…¥+é¢„å¤„ç†
		for (int j=1;j<=m;j++){
			int a=read();
			if (i==1||i==n) sw[j]+=a;
			l[j]+=a;
		}
	for (int i=1;i<=m-2;i++)//è½¬ç§»
		dp[i][0]=max(dp[i-1][0],0)+l[i];
	for (int i=2;i<=m-1;i++)
		dp[i][1]=max(dp[i-1][1],dp[i-1][0])+sw[i];
	for (int i=3;i<=m;i++){
		dp[i][2]=max(dp[i-1][2],dp[i-1][1])+l[i];
		ans=max(dp[i][2],ans);
	}
	printf("%d\n",ans);
    return 0;
}
```


---

## ä½œè€…ï¼šSSerxhs (èµï¼š1)

è¿™é¢˜éœ€è¦å¤§é‡æŸ¥è¯¢åŒºé—´å’Œï¼Œè€Œç¬¬ $1$ è¡Œå’Œç¬¬ $n$ è¡Œç­‰ä»·ï¼Œå…¶ä½™è¡Œåˆ†åˆ«ç­‰ä»·ï¼Œå¯ä»¥è€ƒè™‘è®¾ $f_n=\sum\limits_{i=1}^na_{1,i}+a_{n,i}$ï¼Œ$g_n=\sum\limits_{i=1}^n\sum\limits_{j=2}^{n-1}a_{j,i}$ï¼Œåˆè®¾çŸ©å½¢ç¯å·¦è¾¹çš„å·¦å³è¾¹ç•Œåˆ†åˆ«ä¸º $a+1,b$ï¼Œå³è¾¹çš„å·¦å³è¾¹ç•Œåˆ†åˆ«ä¸º $c+1,d$ï¼Œåˆ™ $ans=f_d-f_{a}+g_d-g_c+g_b-g_a$ã€‚è€ƒè™‘ä»¤ $f_n\leftarrow f_n+g_n$ï¼Œåˆ™ $ans=f_d-g_c+g_b-f_a$ã€‚

è¿™é‡Œçš„é™åˆ¶ä¸º $0\le a<b<c-1<d\le m$ï¼Œå¯ä»¥è€ƒè™‘ä¸€éæ‰«ææ±‚å‡º $f_a$ çš„å‰ç¼€æœ€å°å€¼ï¼Œå¯ä»¥å¯¹ä»»æ„çš„ $b$ è®¡ç®—å‡º $g_b-f_a$ çš„æœ€å¤§å€¼ï¼ŒåŒæ—¶åŒç†æ‰«æä¸€éæ±‚å‡ºå‰è¿°æœ€å¤§å€¼çš„å‰ç¼€æœ€å¤§å€¼ï¼Œå¯ä»¥å¯¹ä»»æ„çš„ $c$ æ±‚å‡º $-g_c+g_b-f_a$ã€‚é‡å¤ä»¥ä¸Šè¿‡ç¨‹ï¼Œå³å¯æ±‚å‡º $ans$ çš„æœ€å¤§å€¼ã€‚

ä»£ç çš„å…·ä½“å®ç°ä¸åŒï¼Œèµ›æ—¶å†™äº†å‰åç¼€ä¸¤ç§

```cpp
#include <bits/stdc++.h>
using namespace std;
typedef long long ll;
int c,fh;
inline void read(int &x)
{
	c=getchar();fh=1;
	while ((c<48)||(c>57))
	{
		if (c=='-') {c=getchar();fh=-1;break;}
		c=getchar();
	}
	x=c^48;c=getchar();
	while ((c>=48)&&(c<=57))
	{
		x=x*10+(c^48);
		c=getchar();
	}
	x*=fh;
}
const int N=1e5+2;
int s[N],a[N],ps[N],ns[N],na[N];
int n,m,i,j,x,lst,ans;
int main()
{
	//freopen("a.in","r",stdin);
	read(n);read(m);
	if (n<=2||m<=2) return puts("-1"),0;
	for (j=1;j<=m;j++) read(s[j]);
	for (i=2;i<n;i++) for (j=1;j<=m;j++) read(x),a[j]+=x;
	for (j=1;j<=m;j++) read(x),s[j]+=x;
	for (i=1;i<=m;i++) s[i]+=s[i-1];
	for (i=1;i<=m;i++) a[i]+=a[i-1];
	for (i=1;i<=m;i++) s[i]+=a[i];
	ps[0]=0;ns[m+1]=-1e9;na[m+1]=-1e9;
	for (i=1;i<=m;i++) ps[i]=min(ps[i-1],s[i]);
	for (i=m;i;i--) ns[i]=max(ns[i+1],s[i]);
	for (i=m;i;i--) na[i]=max(na[i+1],ns[i]-a[i-1]);
	ans=-1e9;
	for (i=1;i<m-1;i++) ans=max(ans,a[i]-ps[i-1]+na[i+2]);
//	for (i=1;i<m-1;i++) if (a[i]-ps[i-1]+na[i+2]==ans) printf("b=%d\n",i);
	printf("%d",ans);
}
```

---

## ä½œè€…ï¼špatrickwen (èµï¼š0)

### é¢˜æ„ï¼š
â€¢ é¢˜ç›®é¦–å…ˆå®šä¹‰çŸ©é˜µç¯ä¸ºï¼Œç»™å®šä¸€ä¸ªçŸ©é˜µ  $A$ ï¼Œåˆå§‹å…¨ä¸ºç™½è‰²ï¼Œåœ¨ å…¶ä¸­é€‰å®šä¸€ä¸ªå­çŸ©é˜µ  $A1$ æ ‡é»‘ï¼Œå†åœ¨  $A1$ å†…é€‰å®šä¸€ä¸ªå­çŸ©é˜µ  $A2$ æ ‡ç™½ï¼Œå°±ä¼šå½¢æˆä¸€ä¸ªçŸ©é˜µç¯ã€‚æ³¨æ„ï¼ŒçŸ©é˜µç¯è‡³å°‘ä¸Šä¸‹å·¦å³éƒ½æœ‰è¢« é€‰å®šçš„éƒ¨åˆ†ï¼Œä¸”æ•´ä¸ªçŸ©é˜µç¯ä¸æ˜¯ä¸€ä¸ªé•¿æ–¹å½¢çš„çŸ©é˜µã€‚

â€¢ å‡è®¾ $+$ ä¸ºé»‘ï¼Œ$-$ ä¸ºç™½ï¼Œä¸‹é¢è¿™ä¸ªå°±æ˜¯çŸ©é˜µç¯ï¼š
![](https://cdn.luogu.com.cn/upload/image_hosting/p1ismtgq.png)

 â€¢ å› æ­¤ï¼ŒçŸ©é˜µç¯ä¼šå‡ºç°ä¸Šï¼Œä¸‹ï¼Œå·¦ï¼Œå³å››æ¡è¾¹ï¼Œæ¯ä¸ªæ–¹å‘æœ‰å¤šå°‘ ä¸ªæ¶‚é»‘çš„éƒ¨åˆ†ï¼Œå°±æ˜¯é‚£ä¸ªæ–¹å‘çš„åšåº¦ã€‚æ¯”å¦‚å¯¹äºç¬¬ä¸€å¼ ç¬¦åˆè¦ æ±‚çš„å›¾ï¼Œä¸Šæ–¹ï¼Œå³æ–¹çš„åšåº¦ä¸º  $1$ ï¼Œå·¦æ–¹ï¼Œä¸‹æ–¹çš„åšåº¦ä¸º  $2$ ã€‚
 
 **â€¢ æ³¨æ„ï¼Œä¸€ä¸ªå®Œæ•´çš„çŸ©é˜µä¸æ˜¯ä¸€ä¸ªçŸ©é˜µç¯ã€‚**

### è§£æ³•ï¼š
â€¢ æˆ‘ä»¬å¯ä»¥æŠŠçŸ©é˜µç¯åˆ†ä¸ºå·¦ä¸­å³ä¸‰éƒ¨åˆ†ï¼š

![](https://cdn.luogu.com.cn/upload/image_hosting/umxg295h.png)

â€¢ å·¦å³ä¸¤éƒ¨åˆ†æ˜¯å®Œå…¨ç”±+ç»„æˆçš„çŸ©å½¢ï¼Œä¸­é—´éƒ¨åˆ†ä¸ºé¦–å°¾è¡Œæ˜¯+ï¼Œä¸­é—´æ˜¯-çš„çŸ©å½¢ã€‚

â€¢ è®¾ $ğ‘“_{i,j}$ è¡¨ç¤ºè€ƒè™‘åˆ°ç¬¬ğ‘–åˆ—ï¼ŒçŸ©é˜µå‰ $1/2/3$ ä¸ªéƒ¨åˆ†æ—¶çš„æœ€â¼¤å€¼ã€‚

â€¢ é¢„å¤„ç† $ğ‘ ğ‘¢ğ‘š_i$ è¡¨ç¤ºå½“å‰åˆ—ä¹‹å’Œ $cur_i$ è¡¨ç¤ºå½“å‰åˆ—é¦–å°¾å…ƒç´ ä¹‹å’Œã€‚

â€¢ åˆ™æœ‰:
```cpp
    for (ll i = 1; i <= m; i++)
    {
        f[i][0] = max(f[i - 1][0], 0ll) + sum[i];
        if (i != 1)
        {
            if (i != m)
                f[i][1] = max(f[i - 1][1], f[i - 1][0]) + cur[i];
            f[i][2] = max(f[i - 1][2], f[i - 1][1]) + sum[i];
            ans = max(ans, f[i][2]);
        }
    }
```
â€¢ å…¨ä»£ç ï¼š
```cpp
#include <bits/stdc++.h>
using namespace std;
typedef long long ll;
ll n, m;
ll a[15][100005], cur[100005], sum[100005], f[100005][15];
int main()
{
    cin >> n >> m;
    for (ll i = 1; i <= n; i++)
    {
        for (ll j = 1; j <= m; j++)
        {
            cin >> a[i][j];
        }
    }
    for (ll j = 1; j <= m; j++)
    {
        cur[j] = a[1][j] + a[n][j];
        for (ll i = 1; i <= n; i++)
        {
            sum[j] += a[i][j];
        }
    }
    ll ans = -1e18;
    for (ll i = 1; i <= m; i++)
    {
        f[i][0] = max(f[i - 1][0], 0ll) + sum[i];
        if (i != 1)
        {
            if (i != m)
                f[i][1] = max(f[i - 1][1], f[i - 1][0]) + cur[i];
            f[i][2] = max(f[i - 1][2], f[i - 1][1]) + sum[i];
            ans = max(ans, f[i][2]);
        }
    }
    cout << (n > 2 && m > 2 ? ans : -1) << endl;
}
```

---

## ä½œè€…ï¼šyzysdTNT (èµï¼š0)

æœ¬ç¯‡é¢˜è§£ä¸»è¦æ˜¯æ¢³ç†åšé¢˜æ—¶çš„æ€è·¯ï¼Œå¯èƒ½æœ‰ç‚¹å•°å—¦ï¼Œä½†æ˜¯æ¯ä¸€ä¸ªç‚¹éƒ½æ˜¯åšé¢˜æ—¶çš„æ€è€ƒè¿‡ç¨‹ã€‚

## é¢˜æ„ç®€è¿°

ç»™å®šä¸€ä¸ªçŸ©é˜µï¼Œæ±‚çŸ©é˜µä¸­å…ƒç´ å’Œæœ€å¤§çš„çŸ©é˜µç¯ï¼Œè¦æ±‚æ­¤çŸ©é˜µç¯çš„ä¸Šä¸‹ä¸¤è¡Œ**åšåº¦å‡ä¸º 1 **ä¸”åˆ†åˆ«**ä½äºç¬¬ä¸€ã€æœ€åä¸€è¡Œ**ã€‚

çŸ©é˜µç¯å®šä¹‰ï¼šå°†æŸä¸ªçŸ©é˜µçš„**éç©º**å­çŸ©é˜µå»æ‰åçš„å›¾å½¢ï¼Œå³ä¸€ä¸ªåœˆã€‚

## åˆ†æ

### Part1 ç®—æ³•ä½¿ç”¨

~~å…¶å®å¯ä»¥ç›´æ¥çœ‹ç®—æ³•æ ‡ç­¾~~ï¼Œæ²¡æœ‰æ ‡ç­¾æ—¶æˆ‘ä»¬åº”è¯¥æ€ä¹ˆåˆ†æå‘¢ï¼Ÿ

å…ˆçœ‹èŒƒå›´ï¼Œ$1 \le n \le 10$ï¼Œ$1 \le m \le10^5$ï¼Œm çš„èŒƒå›´æœ‰ç‚¹å“äººï¼Œå¥½åƒæ²¡æ³• DP ï¼›  
å†çœ‹é¢˜ï¼Œé¢˜æ„ä¸­â€œä¸Šä¸‹ä¸¤è¡Œåšåº¦å‡ä¸º $1$ ä¸”åˆ†åˆ«ä½äºç¬¬ä¸€ã€æœ€åä¸€è¡Œâ€ å¯ç†è§£ä¸ºé€‰ä¸­ä¸€åˆ—æœ‰ä¸¤ç§æƒ…å†µï¼š

- ä¸€æ•´åˆ—å…¨éƒ¨é€‰ä¸­ï¼ˆçŸ©é˜µç¯çš„å·¦ã€å³éƒ¨åˆ†ï¼‰
- åªé€‰æ‹©ç¬¬ä¸€ã€æœ€åä¸€è¡Œçš„å…ƒç´ ï¼ˆçŸ©é˜µç¯çš„ä¸­é—´éƒ¨åˆ†ï¼Œå³ä¸Šã€ä¸‹è¾¹ç•Œï¼‰

å› æ­¤å¯å¾—æˆ‘ä»¬çš„æ“ä½œå•ä½æ˜¯**æ¯ä¸€åˆ—**ï¼Œn å…¶å®æ˜¯æ²¡æœ‰ä»€ä¹ˆç”¨çš„ï¼Œæ‰€ä»¥å¯ä»¥ä¸€ç»´ DPã€‚

---
### Part2 è¾“å…¥ï¼ˆé¢„å¤„ç†ï¼‰

æ ¹æ®ç¬¬ä¸€æ­¥çš„åˆ†æï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è¾“å…¥æ—¶è¿›è¡Œé¢„å¤„ç†ï¼Œå¯¹äºæ¯ä¸€åˆ—çš„è¾“å…¥ï¼Œåªå­˜å‚¨ç¬¬ä¸€è¡Œã€æœ€åä¸€è¡Œçš„å…ƒç´ ä¹‹å’Œä»¥åŠä¸€æ•´åˆ—çš„å…ƒç´ ä¹‹å’Œï¼Œæ—¢èƒ½æ–¹ä¾¿åç»­ DP æ“ä½œï¼Œ~~è¿˜èƒ½å‡å°‘ç©ºé—´~~ã€‚

CODEï¼š
```cpp
for(int i = 1;i <= n;i++){
	for(int j = 1;j <= m;j++){
		cin >> a;//midè¡¨ç¤ºä¸­é—´éƒ¨åˆ†çš„å€¼ï¼Œlineè¡¨ç¤ºå·¦å³ä¸¤è¾¹çš„éƒ¨åˆ†
		if(i == 1 || i == n){//ä½äºç¬¬ä¸€ã€æœ€åä¸€è¡Œ
			mid[j] += a;
		}
		line[j] += a;
	}
}
```
---
### Part3 çŠ¶æ€è½¬ç§»

ä¸Šæ–‡ä¸­æ‰€åˆ†çš„ä¸¤ç§æƒ…å†µä¸­ï¼Œ

> - ä¸€æ•´åˆ—å…¨éƒ¨é€‰ä¸­ï¼ˆçŸ©é˜µç¯çš„å·¦ã€å³éƒ¨åˆ†ï¼‰
> - åªé€‰æ‹©ç¬¬ä¸€ã€æœ€åä¸€è¡Œçš„å…ƒç´ ï¼ˆçŸ©é˜µç¯çš„ä¸­é—´éƒ¨åˆ†ï¼Œå³ä¸Šã€ä¸‹è¾¹ç•Œï¼‰

å…¶å®å·²ç»å°†æ•´ä¸ªçŸ©é˜µç¯åˆ†æˆäº†ä¸‰ä¸ªéƒ¨åˆ†ï¼š

1. å·¦ä¾§éƒ¨åˆ†ï¼ˆæ•´åˆ—ï¼‰ï¼›
2. ä¸­é—´éƒ¨åˆ†ï¼ˆç¬¬ä¸€ã€æœ€åä¸€ä¸ªå…ƒç´ ï¼‰ï¼›
3. å³ä¾§éƒ¨åˆ†ï¼ˆæ•´åˆ—ï¼‰ã€‚

é‚£ä¹ˆæˆ‘ä»¬çš„çŠ¶æ€è½¬ç§»å°±æ˜¯ä¸€æ­¥æ­¥å®Œå–„æ•´ä¸ªçŸ©é˜µç¯çš„è¿‡ç¨‹ï¼Œè€ƒè™‘åˆ†æƒ…å†µè½¬ç§»ï¼š

- $f1_i$ è¡¨ç¤ºä»¥ç¬¬ $i$ åˆ—ä¸ºç»“å°¾çš„å·¦åŠéƒ¨åˆ†çš„æœ€å¤§å€¼ï¼›
- $f2_i$ è¡¨ç¤ºä»¥ç¬¬ $i$ åˆ—ä¸ºç»“å°¾çš„å·¦åŠéƒ¨åˆ†åŠ ä¸­é—´éƒ¨åˆ†çš„æœ€å¤§å€¼ï¼ˆå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªåŠåœ†ï¼‰ï¼›
- $f3_i$ è¡¨ç¤ºä»¥ç¬¬ i åˆ—ä¸ºç»“å°¾çš„ä¸€ä¸ªå®Œæ•´çš„çŸ©é˜µç¯çš„æœ€å¤§å€¼ã€‚

æ˜¾è€Œæ˜“è§ï¼Œ

- $f1_i$ å¯ç›´æ¥æ¨å‡ºï¼›
- $f2_i$ æœ‰ä» $f1_{i-1}$ æ¨å‡ºå’Œç»§æ‰¿ $f2_{i-1}$ ä¸¤ç§çŠ¶æ€ï¼›
- $f3_i$ åŒæ ·æœ‰ä» $f2_{i-1}$ æ¨å‡ºå’Œç»§æ‰¿ $f3_{i-1}$ ä¸¤ç§çŠ¶æ€ã€‚

å› æ­¤æœ‰ï¼š
$$f1_i=\max(f1_{i-1}+line_i,line_i)$$
$$f2_i=\max(f1_{i-1}+mid_i,f2_{i-1}+mid_i)$$
$$f3_i=\max(f2_{i-1}+line_i,f3_{i-1}+line_i)$$

---
ä¸€äº›å° tipsï¼š
- åœ¨ $n \le 2$ æˆ–è€… $m \le 2$ æ—¶ï¼Œæ„ä¸æˆçŸ©é˜µç¯ï¼Œå¯ä»¥ç›´æ¥ç‰¹åˆ¤ç„¶åè¾“å‡º $-1$ï¼›
- è¾“å…¥å¯èƒ½ä¼šæœ‰è´Ÿæ•°ï¼Œè€ŒçŸ©é˜µç¯åˆä¸èƒ½ä¸ºç©ºï¼Œä¸ºäº†ä¿è¯çŸ©é˜µç¯éç©ºï¼Œæˆ‘ä»¬è¦æŠŠ $f1_0$ã€$f2_0$ã€$f3_0$ éƒ½åˆå§‹åŒ–ä¸ºä¸€ä¸ªæå°å€¼ï¼Œä¾‹å¦‚ $-10^9$ã€‚

ç„¶åå°±å¯ä»¥å¿«ä¹æ‰“ä»£ç å•¦ï¼  
æ•´ä½“æ—¶é—´å¤æ‚åº¦å°±æ˜¯è¾“å…¥æ—¶çš„ $O(nm)$ã€‚

## [CODE](https://www.luogu.com.cn/record/154735844)

```cpp
#include <bits/stdc++.h>//ä¸ªäººè§‰å¾—å‰é¢æ­¥éª¤æŒºæ¸…æ™°çš„ï¼Œä¸å†™é‚£ä¹ˆå¤šæ³¨é‡Šäº†
using namespace std;
const int M = 1e5 + 5,inf = -1e9;//infæ˜¯æå°å€¼
int a,n,m,line[M],mid[M],f1[M],f2[M],f3[M];//lineï¼šæ¯ä¸€åˆ—çš„å’Œ;mid:ä¸­é—´éƒ¨åˆ†ï¼Œå³æœ€ä¸Šå’Œæœ€ä¸‹çš„å’Œï¼›
int main(){
	cin >> n >> m;
	if(n <= 2 || m <= 2){//æ­¤æ—¶æ— æ³•å½¢æˆçŸ©é˜µç¯ 
		cout << -1;
		return 0;
	}
	for(int i = 1;i <= n;i++){
		for(int j = 1;j <= m;j++){
			cin >> a;
			if(i == 1 || i == n){
				mid[j] += a;
			}
			line[j] += a;
		}
	}
	f1[0] = f2[0] = f3[0] = inf;
	for(int i = 1;i <= m;i++){
		f1[i] = max(f1[i - 1] + line[i],line[i]);
		f2[i] = max(f1[i - 1] + mid[i],f2[i - 1] + mid[i]);
		f3[i] = max(f2[i - 1] + line[i],f3[i - 1] + line[i]);
	}
	int maxn = inf;
	for(int i = 1;i <= m;i++){
		maxn = max(maxn,f3[i]);//å–æœ€å¤§å€¼
	}
	cout << maxn;
	return 0;
}
```

---

## ä½œè€…ï¼šlqsy002 (èµï¼š0)

[é¢˜ç›®é“¾æ¥](https://www.luogu.com.cn/problem/P7160)ã€‚

## è§£é¢˜æ€è·¯

çŸ©é˜µç¯ç›¸å½“äºå·¦ä¾§è‹¥å¹²åˆ—ï¼Œä¸Šä¸‹è‹¥å¹²åˆ—ï¼Œå³ä¾§è‹¥å¹²åˆ—ã€‚

1. æ¯ä¸€åˆ—å¤„ç†å‡ºä»¥è¯¥åˆ—ç»“å°¾çš„å·¦ä¾§è‹¥å¹²åˆ—çš„æœ€å¤§å’Œï¼Œå¯èƒ½æ˜¯ç»§æ‰¿äº†å‰é¢è‹¥å¹²åˆ—ï¼Œä¹Ÿå¯èƒ½æ˜¯å•ç‹¬ä¸€åˆ—ã€‚

2. å¤„ç†å‡ºä¸Šä¸‹ä¸¤è¡Œéƒ¨åˆ†ï¼Œè€ƒè™‘æŠŠå®ƒå’Œå·¦ä¾§åˆå¹¶ï¼Œå½¢æˆä¸€ä¸ª C å­—å½¢ã€‚ç”¨ $sum_i$ ä»£è¡¨ä¸Šä¸‹ä¸¤ä¸ªå…ƒç´ å’Œï¼Œ$dp_i$ è¡¨ç¤ºå¯ä»¥ç”± $i$ çš„ä¸Šä¸‹ä¸¤ä¸ªå…ƒç´ ç»„æˆ C å­—å‹ï¼Œä¹Ÿå¯ä»¥åŠ å…¥ä¹‹å‰å·²ç»å½¢æˆçš„ C å­—å‹ã€‚

3. è¡¥ä¸Šå³ä¾§çš„ï¼Œå¯ä»¥ç»§æ‰¿åŸæ¥çš„ï¼Œä¹Ÿå¯ä»¥è¡¥ä¸Šå‰é¢ C å­—å‹çš„ã€‚

å…·ä½“è½¬ç§»æ–¹ç¨‹å¯æŸ¥çœ‹ä»£ç æ³¨é‡Šæ ‡æœ‰æ“ä½œåºå·å¤„ã€‚

## å‚è€ƒä»£ç 
```cpp
#include<bits/stdc++.h>
#define int long long
#define maxn 100010
#define inf -10000000000
using namespace std;
int n,m,a[15][maxn];
int sum2[maxn],sum1[maxn],ans=inf;
int dp[maxn],dpl[maxn],dpr[maxn];
signed main(){
    ios::sync_with_stdio(0),cin.tie(0),cout.tie(0);
    cin>>n>>m;
    if(n<=2||m<=2){
        cout<<-1;
        return 0;
    }
    for(int i=1;i<=n;++i)
        for(int j=1;j<=m;++j){
            cin>>a[i][j];
            sum1[j]+=a[i][j];
            if(i==1||i==n)
                sum2[j]+=a[i][j];
        }
    dp[0]=dpl[0]=dpr[0]=inf;
    for(int i=1;i<=m;++i){
        dp[i]=dpl[i]=dpr[i]=inf;
        dpl[i]=max(dpl[i-1]+sum1[i],sum1[i]);   //op1
        if(i>=2)
            dp[i]=max(dpl[i-1]+sum2[i],dp[i-1]+sum2[i]);    //op2
        if(i>=3)
            dpr[i]=max(dpr[i-1]+sum1[i],dp[i-1]+sum1[i]);   //op3
        ans=max(dpr[i],ans);
    }
    cout<<(ans>inf?ans:-1);
    return 0;
}
```

---


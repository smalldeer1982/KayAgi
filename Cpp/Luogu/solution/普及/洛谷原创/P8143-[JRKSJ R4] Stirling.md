# [JRKSJ R4] Stirling

## 题目背景

可能对您无用的提示：

$$f(n)=\sum_{i=0}^n \begin{Bmatrix} n\\i\end{Bmatrix}g(i) \leftrightarrow g(n)=\sum_{i=0}^n (-1)^{n-i} \begin{bmatrix} n\\i\end{bmatrix} f(i)$$

## 题目描述

对于 $[1,n]$ 的排列 $p$，定义其“生成图”为：该图有 $n$ 个点，且 $\forall 1\le i\le n$，无向边 $(i,p_i)$ 存在且仅存在这些边。

给定 $n$，求有多少个 $[1,n]$ 的排列满足其生成图恰有偶数个环（自环同样计入）。

## 说明/提示

### 样例 $1$ 解释

这些排列满足条件：

$$\{1,3,2\}$$
$$\{2,1,3\}$$
$$\{3,2,1\}$$

### 数据规模

对于 $20\%$ 的数据，$n\le 10$。\
对于 $50\%$ 的数据，$n\le 500$。\
对于 $100\%$ 的数据，$1\le n\le 10^6$。


## 样例 #1

### 输入

```
3```

### 输出

```
3```

## 样例 #2

### 输入

```
114514```

### 输出

```
430461019```

# 题解

## 作者：VinstaG173 (赞：11)

~~题目名称写了 Stirling 你就用 Stirling 做嘛~~

事实上背景里给出的 Stirling 反演公式确实没啥用，但是有一个东西非常有用：

$$F_n(x)=\prod_{i=0}^{n-1}(x+i)=\sum_{m=1}^{n}\begin{bmatrix}n\\m\end{bmatrix}x^m.$$

这个式子在各种讲解 Stirling 数的博客（或者百度百科等地方）都有讲到，也有证明，在此不作赘述。建议自行搜索学习。

由第一类 Stirling 数的组合意义（如果不知道这个组合意义建议也找博客学一下）知题意即求

$$\begin{aligned}
\sum_{1 \le m \le n,2 \mid m}\begin{bmatrix}n\\m\end{bmatrix}&=\dfrac{F_n(1)+F_n(-1)}{2}\\
&=\dfrac{n!-[n=1]}{2}.
\end{aligned}$$

其中的 $-[n=1]$ 是因为 $F_1(-1)=-1$，$n>1$ 时 $F_n(-1)=0$，而 $F_n(1)=n!$ 对任意 $n$ 成立。

Code:
```cpp
#include<cstdio>
#define ll long long
const int ntf=998244353;
int n;ll f;int main(){
	scanf(" %d",&n),f=n;while((--n)>2)f=f*n%ntf;
	return 0&printf("%lld\n",(n)?f:0);
}
```

---

## 作者：critnos (赞：7)

### 引理：对于一个排列，交换任意不同两项后，环数的奇偶性改变

若交换的两项在一个环中，该环分裂为两个环；

若交换的两项不在一个环中，两个环合并为一个环。

证毕。

设有 $a$ 个排列对应偶数个环，$b$ 个排列对应奇数个环。

对于这 $a$ 个排列，交换他们的前两项，则得到 $a$ 个对应奇数个环的排列。

所以 $a\le b$。

同理 $b\le a$。

所以 $a=b$，即 $a=b=\dfrac {n!} 2$。

特别的，当 $n=1$ 时，上列分析不成立。答案为 $0$。

---

## 作者：cyffff (赞：5)

[$\text{Link}$](https://www.luogu.com.cn/problem/P8143)
## 题意
定义 $n$ 阶排列 $p$ 的生成图为对 $\forall i\in[1,n]$ 连接 $(i,p_i)$ 的无向图。

求有几个 $n$ 阶排列的生成图有偶数个环。

$n\le 10^6$。
## 思路
~~现在的官方题解做法是我提供的，之前是转化成逆序对后解释的。~~

$n=1$ 的情况平凡，答案为 $0$。

排列的生成图一定是由若干环组成的，证明：每个点的入度与出度都为 $1$，点数和边数都是 $n$，考虑一个连通子图，设它的大小为 $s$，其中有 $s+k$ 条边，若 $k>0$，则至少有一个点入度大于 $1$；若 $k<0$，必然有其它连通块 $k>0$。所以 $k$ 必然等于 $0$，也就是说边数等于点数。此时有两种形态：单一的环或基环树，基环树中必然有一点有 $2$ 入度同样矛盾，证毕。

考虑交换 $p_1$ 和 $p_2$，断开 $(1,p_1)$ 和 $(2,p_2)$ 并连接 $(1,p_2)$ 和 $(2,p_1)$，若它们在一个环中，则断开会把环展开为两条链，连接会把它们修复为两个环；反之，断开会把两个环展开为两条链，连接会把它们组成一个环。

综上，交换 $p_1$ 和 $p_2$ 会改变环数奇偶性，也就是说，生成图有偶数个环的 $n$ 阶排列与生成图有奇数个环的 $n$ 阶排列构成双射，答案为 $\dfrac{n!}2$。

时间复杂度 $\Theta(n)$。

再见 qwq~

---

## 作者：xkcdjerry (赞：2)

这道题是一个很 naive 的题。  
先猜结论：奇偶环的排列数相等。

证明如下：对于任何一个排列 $P$，交换第 $i$ 个和第 $j$ 个，由于只存在两个在一个环中和不在一个环中两种情况，所以对于两种情况分类讨论即可：  
首先感性理解交换的含义：交换 $i$ 与 $j$ 在排列中的位置后，$i$ 会与 $P_i$ 断开，与 $P_j$ 连接（但是对于 $P_x=i$ 的 $x$ 仍与 $i$ 连接），而 $j$ 同理。可以理解为断开 $(i,x)$，$(j,y)$ 并连接 $(i,y)$，$(j,x)$。  

* 如果两个点在两个环中，将会把两个环断成链并且把两个链的头尾相连导致两个环变为一个，环数 $-1$。  
* 如果两个点在一个环中，将会把环断成两个链并将每个链的头尾相连导致一个环变成两个，环数 $+1$。

综上，无论两个点如何选择，环数目的奇偶性均会改变，即证。

分类讨论，假如点数 $<2$，那么答案为 $0$。（只能有 $1$ 个环）  
否则对于任意一个环数为奇数的，均可以通过翻转前两个转化为环数为偶数，可得偶数环数量大于等于奇数环数量。  
同理可得奇数环数量大于等于偶数环数量，即偶数环数量等于奇数环数量。

由于偶数环数量加上奇数环数量等于所有排列，所以两者的个数均等于 $\frac{n!}2$。  

$11$ 行代码如下：
```c++
#include <cstdio>
#define p 998244353
int main()
{
    int n;
    scanf("%d",&n);
    if(n<2) return puts("0"),0;
    long long ans=1;
    for(int i=1;i<=n;i++) ans=ans*i%p;
    printf("%lld",ans*499122177%p);
}
```

[AC 记录](https://www.luogu.com.cn/record/69400333)

---

## 作者：Missa (赞：1)

先说明一下已有10篇题解为什么还要交：现有的题解除了一篇都是官方思路，而个人认为官方思路并不是最好想到的，剩下的一篇递推时的说明不够清晰。我赛时为这道题耗了1h才想到现在的递推思路，自认为是最好想到的。

题意：给定 $n$，求 $n$ 个点间连 $n$ 条边，每个点的度数为 $2$，且图中恰含偶数个环的方案数。

如果把边看成有向边，$p_1-p_n$ 是一个排列，说明每个点的出度和入度均为 $1$。所以生成的图一定由若干个环组成。

![](https://cdn.luogu.com.cn/upload/image_hosting/218cg5hz.png)

考虑递推。设 $f_n$ 为 $n$ 个点时的答案，因为最后一定是若干个环，所以生成奇数个环的方案数就是 $n!-f_n$。

看 $p_n$。若 $p_n=n$，则说明第 $n$ 个点自身处在一个自环中。所以一个这样的情况刚好对应一个 $(n-1)!-f_{n-1}$

若 $p_n \neq n$，说明第 $n$ 个点与其他点组成一个环。将第 $n$ 个点拿出，剩下的 $n-1$ 个点也满足题目描述。相当于原有一个 $n-1$ 个点的情况，在其中的一个点后面插入了 $n$（类比链表插入），于是一个这样的情况对应 $n-1$ 个 $f_{n-1}$。

转移方程：

$$f_n=(n-1)! - f_{n-1} + (n-1) \cdot f_{n-1}$$

边界：$f_1=1$

赛时没推到 $f_n=\dfrac{n!}{2}$，归纳应该易证。

```cpp
#include <cstdio>
#define p 998244353
using namespace std;
int n, s = 1, a; //a 是那个 f 数组，被优化到一个变量了，s 是阶乘
int main(){
	scanf("%d", &n);
	for(int i = 1; i < n; i++){
		a = (1ll * (i - 1) * a + 1ll * s * i % p) % p; //这里是从 f[i] 转移至 f[i+1]
		s = 1ll * s * i % p;
	}
	printf("%d\n", a);
} 
```

upd 2.27 改了文中多处式子，重新审核

---

## 作者：Karl_Aurora (赞：0)

**[~~无耻地推销个人博客 qwq~~](https://www.luogu.com.cn/blog/ling-XAIqwq/solution-p8143)**

**[题目传送门](https://www.luogu.com.cn/problem/P8143)**

------------

#### update on 2024/9/15： 修复了关于 $n = 1$ 的情况。

---

## 题意


对于给定的 $ n $，求有多少个 $[1,n]$ 的排列满足其生成图恰有偶数个环（自环同样计入）。

其中一个排列生成图指的是对于每个该排列中的第 $ i $ 个元素（令其为 $ p_i $），连接一条从 $ i $ 到 $ p_i $ 的无向边，最后得到的无向图为原排列的生成图。

## 解法

作为一道公开赛的T1，由经验出发其十有八九是一道结论题（大雾

因此，我们从 $ n = 2 $ 开始手玩几项，发现其对应关系如下：

| $ n $ | $ 2 $ | $ 3 $ | $ 4 $ | $ 5 $ | $ 6 $ | $ 7 $ | $ 8 $ |
| :----------: | :----------: | :----------: | :----------: | :----------: | :----------: | :----------: | :----------: |
| $ ans $ | $ 1 $ | $ 3 $ | $ 12 $ | $ 60 $ | $ 360 $ | $ 2520 $ | $ 20160 $ |

~~当然手玩一般到 $ n = 5$ 就是极限了~~

简单分析一下，可以看出 $ ans = \frac{n!}{2} $。

当然，仅仅靠猜是不够的，所以我们接下来通过递推来对其给出一个严格的证明：

>
> 为了方便表示，不妨令 $ p_{i} \rightarrow i $ 的映射为 $ h(x) $，并令 $ f(n), g(n) $ 分别为对于 $ [1,n] $ 的排列 $ p $，其环个数为偶数和奇数的生成图个数，
>
> 则易得 $ f(2) = g(2) = 1 $（分别是 $ \{1, 2\} $ 与 $ \{2, 1\} $），
>
> 且有 $ f(n) + g(n) = n! $（总生成图个数等于排列个数）。
>
> 现在假设对于 $ \forall x < n $，其对应的 $ f(x), g(x) $ 皆已求出，考虑当 $ x = n $ 时 $ f(x), g(x) $ 的值。
> 此时，对于新加入的 $ p_{n} $，有如下两种情况：
>
> 1. $ p_{n} = n $
> 
> > 此时相当于在原来的情况下增加了一个自环，故环的个数加一，奇偶性发生变化，原先所有环的个数为奇数的情况变为环的个数为偶数，偶数变奇数，
> >
> > 故有 $ \left\{\begin{matrix}f(x) = g(x - 1)\\ g(x) = f(x - 1)\end{matrix}\right. $
>
> 2. $ p_{n} \neq n $
>
> > 不妨令 $ p_{n} = \alpha $ ，则实际上发生的操作为 $ p_{n} = \alpha, p_{h(\alpha)} = n $ （实际上可以类比为链表的插入），此时相当于在原来的情况下将其中一个环的规模扩大，故环的个数不变，奇偶性不发生变化，原先所有环的个数为奇数的情况仍为奇数，偶数仍为偶数，又因为对于 先前 $ x = n - 1 $ 的每一种情况而言，$ p_{n} = 1, 2, 3, \cdots, n - 1 $ 都是满足假设的，
> >
> > 故有 $ \left\{\begin{matrix}f(x) = (x - 1)f(x - 1)\\ g(x) = (x - 1)g(x - 1)\end{matrix}\right. $
>
> 故由加法原理得到最终的递推公式为 $ \left\{\begin{matrix}f(x) = g(x) + (x - 1)f(x - 1)\\ g(x) = f(x) + (x - 1)g(x - 1)\end{matrix}\right. $
>
> 结合最初的两个式子，最终可以推出通项为 $ f(x) = g(x) = \frac{x!}{2} $。

~~所以题目背景中给出的公式在题目中完全用不上（大雾~~

不过需要注意的是，在求余这一操作下，除法应转化为乘上对应的乘法逆元，~~当然你也可以直接上下把2约掉，这样更方便，就像我代码里一样~~。

另外，当 $n = 1$ 时，显然有答案为 $0$，特判一下即可。

最后代码如下：

```cpp
#include<bits/stdc++.h>
#define mod 998244353
using namespace std;
unsigned long long n, ans = 1;
int main(){
    cin >> n;
    if (n == 1) ans = 0;
    for(unsigned long long i = 1; i <= n; ++i) if(i != 2) ans = (ans % mod) * (i % mod);
    cout<< ans % mod << endl;
    return 0;
}
```
至此，愉快 AC，完结撒花 0v0

---

## 作者：I_am_Accepted (赞：0)

斯特林公式：肯定对您无用的提示。

如果 $n=1$ 特判，直接 $0$。

对于一个排列 $P$，定义 $f(P)$ 为交换前两项后的 $P$。

引理 A：

$$P\ne Q\iff f(P)\ne f(Q)$$

引理 B：一个奇数环排列 $O(odd)$ 交换某两项后变成一个偶数环排列 $E(even)$，反之亦然。即：

$$f(E)=O,f(O)=E$$

由引理 A、B 得，奇数环排列集 和 偶数环排列集 之间构建了双射，所以两集合大小相等，则：

$$ans=\dfrac{n!}{2}$$

---

## 作者：lsj2009 (赞：0)

## 题目大意
<https://www.luogu.com.cn/problem/P8143>。
## 思路
很明显，排列 $p$ 的生产图要么为偶环图，要么为奇环图。

****引理：如果 $p$ 的生产图为偶环数，那么交换其中任意两项 $a_i$ 和 $a_j$，新的排列 $p_1$ 的生产图为奇数环，反之亦然。****

证明：设交换前共 $x$ 环，则有两种情况：
- 如果两点处于同一环，交换则后该环分裂成两个环，因为原图有边无项边 $(i,a_i)$ 及 $(j,a_j)$ 处于同一环中，如交换则变成 $(i,a_j)$ 及 $(j,a_i)$ 原来的环的两条边断裂，而新的两条边则又形成两个封闭环形。此刻有 $x+1$ 个环。
- 如果两点不处于同一环，交换后该环合并成同一环。原因同上。此刻有 $x-1$ 个环。

由于 $x$ 和 $x-1$ 或 $x+1$ 的奇偶性不同，故成立。

证毕。

$[1,n]$ 的所有排列共有 $n!$ 种，而交换每个排列的其中两项该图奇偶性改变，则偶图（或奇图）的个数为 $\frac{1}{2}n!$。

## code:
```cpp
#include<bits/stdc++.h>
#define int long long
const int MOD=998244353;
signed main() {
	int ans=1,n;
	scanf("%lld",&n);
	if(n==1) return 0&puts("0");
	for(int i=3;i<=n;i++)
		ans=ans*i%MOD;
	printf("%lld",ans);
	return 1;
}
```

---

## 作者：_⁢　 (赞：0)

发现所有边 $(i, p_i)$ 中，$i$ 两两不同，$p_i$ 两两不同，因此所有点的度数都为 $2$，所有点和边都在环上。

设 $f_{i, 0}, f_{i, 1}$ 表示 $[1, i]$ 的排列，满足其生成图有偶数个或奇数个环的数量。

容易发现，$f_{1, 0}=0$，$f_{1, 1}=1$，$f_{2, 0}=1$，$f_{2, 1}=1$。

考虑归纳。假设已经算出了 $f_{j, 0}, f_{j, 1}(1\le j \lt i)$，需要计算 $f_{i, 0}, f_{i, 1}$。

- 当 $p_i=i$ 时，显然 $f_{i, 0}=f_{i-1, 1}$，$f_{i, 1}=f_{i-1, 0}$。
- 当 $p_i\ne i$ 时，由于所有点和边都在环上，原图（指 $[1, i-1]$ 的排列的生成图）中肯定存在 $(j, p_i)$ 的边。原排列中 $p'_j=p_i$。令新排列中 $p_j=i$，那么原图和新图中环的个数不变。
	- 感性理解，加入 $(i, p_i)$ 边后，原图中 $p_i$ 所在的环多出了一条边，变成了 $\rho$ 的形状。此时 $deg_{p_i}=3, deg_{i}=1$，因此需要将一条与 $p_i$ 相连的边改为与 $i$ 相连，改后环的个数不变。

当 $p_i\ne i$ 时，$p_i$ 有 $i-1$ 种取值，因此方案数要乘 $(i-1)$。

$$
f_{i,0}=f_{i-1,1}+(i-1)f_{i-1,0}
\\
f_{i,1}=f_{i-1,0}+(i-1)f_{i-1,1}
$$

容易发现 $f_{i, 0}$ 和 $f_{i, 1}$ 是对称的，而且 $f_{2, 0}=f_{2, 1}$，因此 $f_{i, 0}=f_{i, 1}(i\ge 2)$。

由于所有边一定都在环上，因此 $f_{i, 0}+f_{i, 1}$ 就是生成图的总数，即 $i!$。

可以推出：

$$
f_{i, 0}=
\begin{cases}
	0, i=1\\
	\frac{i!}{2},i>1\\
\end{cases}
$$



---


# [NEERC 2013] Cactus Automorphisms

## 题目描述

NEERC 在前几年中曾出现过一些关于仙人掌图的问题——仙人掌图是一个连通的无向图，其中每条边最多属于一个简单环。从直观上看，仙人掌图是树的一种推广，其中允许存在一些环。

在 2005 年，首次出现关于仙人掌图的问题时，问题被简单地称为“Cactus”。在 2007 年，它被称为“Cactus Reloaded”，而在 2010 年，它被称为“Cactus Revolution”。下图展示了 NEERC 2007 年问题中的一个仙人掌图示例。

![](/upload/images2/cac.png)

在为这些问题准备测试用例时，评委面临的挑战是，一些错误的解决方案可能依赖于输入文件中顶点的编号。因此，对于最有趣的测试用例，评委通常会包含几个具有相同图但顶点编号不同的输入。然而，有些图是如此规则，以至于即使重新编号其顶点，图仍保持不变。评委需要一些关于图的度量来判断给定图的规则性，以便对需要为该图创建的测试用例数量做出客观决定。

你需要计算的度量是图的自同构数量。给定一个无向图 $(V , E)$，其中 $V$ 是顶点集，$E$ 是边集，每条边是由两个不同顶点组成的集合 $\{v_{1}, v_{2}\} (v_{1}, v_{2} \in V)$，图的自同构是一个从 $V$ 到 $V$ 的双射 $m$，使得对于每对由边连接的顶点 $v_{1}$ 和 $v_{2}$（即 $\{v_{1}, v_{2}\} \in E$），以下条件成立：$\{m(v_{1}), m(v_{2})\} \in E$。

每个图至少有一个自同构（当 $m$ 是恒等函数时），对于具有 $n$ 个顶点的图，最多可能有 $n!$ 个自同构。由于自同构的数量可能是一个非常大的数字，答案必须以素因数分解的形式呈现 $\prod^{k}_{i=1} p_{i}^{q_{i}}$，其中 $p_{i}$ 是按升序排列的素数 $(p_{i} \ge 2, q_{i} > 0)$。

## 说明/提示

时间限制：5 秒，内存限制：256 MB。

题面翻译由 ChatGPT-4o 提供。

## 样例 #1

### 输入

```
15 3
9 1 2 3 4 5 6 7 8 3
7 2 9 10 11 12 13 10
5 2 14 9 15 10
```

### 输出

```
1
2 2
```

## 样例 #2

### 输入

```
2 1
2 1 2
```

### 输出

```
1
2 1
```

## 样例 #3

### 输入

```
15 7
3 1 2 3
3 4 2 5
3 6 2 7
3 8 2 9
3 10 2 11
3 12 2 13
3 14 2 15
```

### 输出

```
6
2 11
3 5
5 2
7 2
11 1
13 1
```

# 题解

## 作者：zhylj (赞：0)

先考虑树的情况怎么做：一个经典套路是先找到重心（如果有两个重心并且以两个重心为根时的树同构，那么答案再 $\times 2$），然后把重心定为根，问题就被转化为了有根树，那么对于一个节点，可以把它的孩子中每个同构等价类的大小的阶乘乘起来贡献到答案。同构可以考虑通过树哈希来判断，即每个深度 $i$ 用一个哈希函数 $h_i(a)=\sum_j (a_j+1)b_i^j\bmod p$，其中 $b_i$ 为随机数，$p$ 为你喜爱的质数，$a_i$ 为所有孩子哈希值排完序后的结果。

接着考虑仙人掌，可以发现仙人掌同构等价于圆方树同构，于是先求圆方树并找到重心，然后从重心开始 DFS（注意到由于重心那一侧），分类讨论：

- 对于方点，若其为重心，那么它可以旋转，也可以翻折，我们要找出环上哈希值构成的序列（必须按照环的顺序）和它的反串的所有循环同构和原串相同的个数 $c$，那么它对答案贡献 $\times c$。
- 对于非重心方点，其父亲所在子树（也就是重心所在子树）的大小超过了 $\left\lfloor \dfrac n2\right\rfloor$，所以这个环必然不可能被旋转，但它依然可以翻折，所以若它是回文，那么对答案贡献 $\times 2$。
- 否则，依然根据孩子中同构的等价类大小的阶乘来对答案贡献。

需要注意的是，由于环可以翻折，但不能旋转，所以我们维护非重心方点的哈希值时，取的是孩子哈希值序列（注意我们必须按环的顺序排列这个序列）和它反串中字典序最小的一个来做哈希。

然后统计答案的时候不难发现是若干个阶乘之积，维护出每个阶乘的贡献然后做一个前缀和，对每个质数暴力统计就好了。

时间复杂度 $\mathcal O(n\log n)$。

[代码链接](https://www.luogu.com.cn/paste/8tteirmp)（写的较丑，谨慎参考）。

---


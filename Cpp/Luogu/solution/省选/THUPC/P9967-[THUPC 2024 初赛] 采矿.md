# [THUPC 2024 初赛] 采矿

## 题目背景

_“我已经买不起第二个机器人了。”_

_“那就雇点人来凑数吧。注意别给死里头。”_

## 题目描述

你是一个矿坑老板。

你的矿坑是二叉树形结构，有 $n$ 个节点。$1$ 号点为地面，对于所有的 $2\le i\le n$，$i$ 号节点与更浅层的 $f_i$ 号节点通过通道相连，其中 $f_i<i$，且相同的 $f_i$ 最多出现两次。矿坑的不同节点的产量和开采难度均不相同。对于 $i$ 号节点 $(2\le i\le n)$，如果派一个机器人开采，一单位时间内能有 $r_i$ 的产出；如果派一个人类开采，一单位时间内能有 $p_i$ 的产出。地面没有产出。

你有一个机器人，初始位于 $s$ 号节点。你的矿坑里初始没有人类工人。

所有通道与节点都十分狭窄，每个节点都只能容下一名工人（工人包括人类和机器人），每个通道也只能恰好容一名工人通过。在移动的任何时刻，只能有最多一名工人在通道中，其余工人都必须在节点上。

你现在有 $q$ 条计划需要按顺序执行。每个计划分为准备、执行、调整、开采四个阶段。

在准备阶段，人类可以在满足上述移动规则的前提下任意移动，但不能进入或离开矿坑（矿坑内的工人到达 $1$ 号节点不算离开矿坑），因为你在看着他们；移动的顺序和次数均没有限制。机器人不能移动。

在执行阶段，不同计划需要做的事情可能不同，共分为 $4$ 种：

1. 机器人只能沿通道向**更浅**的方向移动，且至少需要经过一条通道。人类不能移动。
2. 机器人只能沿通道向**更深**的方向移动，且至少需要经过一条通道。人类不能移动。
3. 使一名人类从 $1$ 号节点进入矿坑（这意味着该阶段开始时 $1$ 号节点上必须没有工人）。除此之外所有工人都不能移动。
4. 使一名人类从 $1$ 号节点移出矿坑（这意味着该阶段开始时 $1$ 号节点上必须有一名人类）。除此之外所有工人都不能移动。

在调整阶段，限制与准备阶段相同。人类可以在满足上述移动规则的前提下任意移动，但不能进入或离开矿坑；移动的顺序和次数均没有限制。机器人不能移动。

在开采阶段，所有的工人会采一单位时间的矿。所有有工人的非地面节点会根据位于该节点的工人种类计算产出。没有工人的节点没有产出。该计划的产出为所有节点的产出之和。

问按顺序执行完所有计划之后，你所有计划的产出之和最多可以达到多少。

## 说明/提示

### 样例 \#1 解释

一个最优解如下：（一些没有移动的阶段略过不提）

第一个计划的调整阶段：将刚送入 $1$ 号点的人类移动两次到 $5$ 号点。

第一个计划的开采阶段：机器人产出为 $7$，人类产出为 $6$。

第二个计划的调整阶段：将刚送入 $1$ 号点的人类移动到 $2$ 号点。

第二个计划的开采阶段：机器人产出为 $7$，人类产出为 $4+6=10$。

第三个计划的执行阶段：将机器人移动至 $1$ 号点。

第三个计划的调整阶段：将一名人类从 $5$ 号点移动至 $4$ 号点。

第三个计划的开采阶段：机器人产出为 $0$，人类产出为 $4+8=12$。

第四个计划的准备阶段：将一名人类从 $4$ 号点移动至 $5$ 号点。

第四个计划的执行阶段：将机器人移动至 $3$ 号点。

第四个计划的开采阶段：机器人产出为 $9$，人类产出为 $4+6=10$。

第五个计划的执行阶段：将机器人移动至 $4$ 号点。

第五个计划的开采阶段：机器人产出为 $7$，人类产出为 $4+6=10$。

第六个计划的准备阶段：将一名人类从 $2$ 号点移动至 $1$ 号点。

第六个计划的开采阶段：机器人产出为 $7$，人类产出为 $6$。

总的产出为 $7+6+7+10+0+12+9+10+7+10+7+6=91$。

### 子任务

保证 $2\le n\le 301$，$1\le q \le 600$，$1\le s\le n$。

保证 $1\le f_i < i$，$0\le r_i,p_i \le 10^9$。

保证相同的 $f_i$ 最多出现两次。

### 题目使用协议

来自 THUPC2024（2024年清华大学学生程序设计竞赛暨高校邀请赛）初赛。

以下『本仓库』皆指 THUPC2024 初赛 官方仓库（[https://github.com/ckw20/thupc2024_pre_public](https://github.com/ckw20/thupc2024_pre_public)）

1. 任何单位或个人都可以免费使用或转载本仓库的题目；

2. 任何单位或个人在使用本仓库题目时，应做到无偿、公开，严禁使用这些题目盈利或给这些题目添加特殊权限；

3. 如果条件允许，请在使用本仓库题目时同时提供数据、标程、题解等资源的获取方法；否则，请附上本仓库的 github 地址。

## 样例 #1

### 输入

```
5 6 4
1 1 3 3
15 9 7 1
4 2 8 6
3
3
1
2
2
4
```

### 输出

```
91
```

# 题解

## 作者：Kevin090228 (赞：4)

~~通过对题目背景的阅读得知只有一个机器人~~。所以 DP 状态设计是显然的：$f(i,j,l,r)$ 表示考虑了前 $i$ 次操作，机器人在点 $j$，$j$ 的左右子树内分别有 $l,r$ 个人类的最大产出。

对于操作 $3,4$，转移是简单的，直接 $f(i,j,l,r)\to f(i+1,j,l,r)$ 即可。

这里设辅助数组 $g(u,l,r)$ 表示在机器人移动中，在 $u$ 点，左右子树有 $l,r$ 个的最大产出。要注意机器人必须移动，所以 $g$ 的初值也要转移得到，而不能直接复制。

对于操作 $1$，由深到浅进行树形 DP。不妨设 $u$ 是 $f_u$ 左儿子，有转移：$g(u,a,b)\to g(f_u,a+b,c)$，对于每个 $a+b$ 求出 $g(u,a,b)$ 最大值，然后就能枚举 $c$ 转移了，时间复杂度是树形背包的 $O(n^2)$。

对于操作 $2$，由浅到深进行树形 DP。不妨设 $u$ 是 $f_u$ 左儿子，有转移：$g(f_u,a,b)\to g(u,c,a-c)$，类似地，对于每个 $a$ 求出 $g(f_u,a,b)$ 最大值，然后就能枚举 $c$ 转移，时间复杂度同样是树形背包的 $O(n^2)$。

对于计算采矿的贡献，预处理 $A(u,c),B(u,c)$ 分别表示在 $u$ 子树内/外放 $c$ 个人的最大采矿产出即可。

总时间复杂度 $O(n^2c)$。



---


# [GDKOI2024 普及组] EX 中缀表达式

## 题目描述

Alice 最近学习了表达式，现在他想写一个属于自己的表达式计算器。

规定：

- 单个数字：由若干数字（至少一个）连续拼接，最后必须跟一个 `.` 字符（不含引号）。例如：`00123.` `0.` `789.` 都是合法的数字。
- 单个操作符：由若干数字连续拼接，最后跟一个字符。
- 操作符的字符：表示该操作符的操作。该字符必须是 `+`、`*`、`^` 之一，分别表示加法，乘法和乘方。特别约定 `0^0=1`。  
例如：`000000789+`，`123^`，如果前面的数值合法，那么它们就都是合法的操作符。
- 操作符的数字：表示该操作符的优先级，优先级的取值是 $[1, n]$ 之间的正整数，数字越大表示优先级越高。
- 对于优先级相同的操作符，题目将给出一个长度为 $n$ 的 $01$ 串 $C$，用于说明对应优先级的操作符之间，是左结合还是右结合。  
其中 $0$ 表示左结合，$1$ 表示右结合。  
例如 $C=111011$，其中第 $4$ 个字符为 `0`，表示优先级为 $4$ 的操作符是左结合的。
- 左结合：表示该运算符从左往右计算。下面给出左结合的例子：`1.4+2.4^3.4^4.` 等价于 `((1.4+2.)4^3.)4^4.`，其结果与 `((1+2)^3)^4` 相同
- 右结合：表示该运算符从右往左运算。下面给出右结合的例子：`1.6+2.6^3.6^4.` 等价于 `1.6+(2.6^(3.6^4.))`，其结果与 `1+(2^(3^4))` 相同。
- 中缀表达式：
1. 单个数字是合法的中缀表达式。
2. 若 A 是合法的中缀表达式，则 (A) 也是合法的中缀表达式。
3. 若 A、B 均是合法的中缀表达式，c 是合法的单个操作符，则 AcB 也是合法的中缀表达式。
4. 其余情况均不合法。

现在给出一个长度为 $n$ 的 $01$ 串 $C$，用于说明，相同优先级的操作符之间，是左结合还是右结合。

给出一个中缀表达式，判断该表达式是否合法，不合法则输出 `error`（不包括引号），合法则输出该表达式的值对 $998244353$ 取模的结果。

## 说明/提示

**【样例解释】**

`243640717 = ((1+2)^(3*(4^((5*6)+7)))) mod 998244353`

**【数据范围】**

特殊性质 1：不会出现 ^ 字符。

特殊性质 2：不会出现 + 和 * 字符。

特殊性质 3：不会出现 ( 和 )。

对于 $8\%$ 的数据，$n = 1$，$1 \leq |S| \leq 100$，且满足特殊性质 $1$ 和特殊性质 $3$。

对于另外 $8\%$ 的数据，$n = 1$，$1 \leq |S| \leq 100$，且满足特殊性质 $1$。

对于另外 $20\%$ 的数据，$n = 1$，$1 \leq |S| \leq 100$，且满足特殊性质 $2$ 和特殊性质 $3$。

对于另外 $24\%$ 的数据，$n = 1$，$1 \leq |S| \leq 1000$,，且满足特殊性质 $2$。

对于 $100\%$ 的数据，$1 \leq n \leq 9$，$1 \leq |S| \leq 10000$。


## 样例 #1

### 输入

```
2
01
1.2+2.1^3.2*4.2^(5.2*6.)2+7.```

### 输出

```
243640717```

# 题解

## 作者：2022liaojianxiang (赞：8)

感谢洛谷把 GDKOI 放上来了！借这道题来庆祝我普及金奖！

# [【GDKOI2024 普及组】EX 中缀表达式](https://www.luogu.com.cn/problem/P10079)的题解

在这里提出我的建议：

- 这道题建议升紫，在模拟中还有数学参入，所以难度还是比较大的，希望建议能被采纳，谢谢！

## 题目大意

这是一道数学、模拟题，要求计算表达式的值并且按照它规定的优先级和结合的左右顺序进行处理并模 $10^9+7$ 输出，还要判断表达式是否合法，符号只有 `+`、`*` 和 `^`。

## 前置芝士

- [后缀表达式（逆波兰式）](https://oi-wiki.org/misc/expression/)

- [表达式树](https://oi-wiki.org/misc/expression/#%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%A0%91%E4%B8%8E%E9%80%86%E6%B3%A2%E5%85%B0%E8%A1%A8%E8%BE%BE%E5%BC%8F)

- [扩展欧拉定理](https://oi-wiki.org/math/number-theory/euler-totient/)

## 考场上的情况（不想看的可以跳过）

先说一下我比赛时的情况：那时我非常智慧，看到这道题一眼模拟直接无脑开始狂打。像这种表达式求值的题很明显的做法是将中缀表达式转成后缀表达式，然后进行求值。因为打熟悉了中缀表达式转成后缀表达式，所以很快打完，并且 `Error` 判断的也比较好，最后一直过不了样例，甚至叫来老师问是不是样例出错了（因为样例有次方运算，我又把次方给进行了模运算，导致直接暴力算都是错的），最后也是不明不白地离开了考场。出来和同学讨论以后才发现次方运算的次方不可以直接模。结果还怀疑人家题出错了【捂脸】。最后居然还能拿没有次方运算的 $16$ 分。加上 `Error` 的 $12$ 分（有两个没有判断到）。

## 正解

其实就是暴力，只不过细节有亿点点多。

## 难点

### 判断不合法的 `Error` 情况：

首先判断不合法的中缀表达式有以下几种：

- 出现了不是数字、`+`、`*`、`^`、`(`或`)`的字符；

- 括号不匹配；

- 运算符没有数字在前表示优先级或者数字不在 $1$ 到 $n$ 的范围内；

- 两个括号之间为空；

- 每个字符没有对应运算的两个数字。

### 将中缀表达式转成后缀表达式

个人认为这是比较简单的一步，只要你学过中缀表达式转成后缀表达式。在这里还是讲一下步骤吧：

我们用一个字符栈来维护这个过程。

- 如果遇到数字，直接加入后缀表达式。

- 如果遇到字符，先判断是否有优先级更高的字符在栈中，如果高就弹出并加入后缀表达式，直到遇到优先级比它低的符号。如果在弹的过程中遇到左括号，就不再弹出；

- 如果遇到左括号，直接加入字符栈；

- 如果遇到右括号，一直弹运算符直到左括号，同时也弹掉左括号；

- 那怎么处理同优先级的左右运算呢？题目中确实有这样的规定。左结合就是从左往右运算，左边先加入的优先级更高，右结合代表从右往左运算，右边的优先级更高；

- 如果字符栈里还有剩余就全部弹出即可。

这时我们就得到了一个后缀表达式。

### 将次方取模时的处理（乘方运算在取模意义下的取值）

对于次方来说确实不好办的，不可以直接取模，所以这应该是最难的一个点了，我们需要用到一个数学推论：扩展欧拉定理。

这里给出式子：

$$
a^b\equiv \begin{cases}
a^{\left(b\ \bmod \ \varphi(p)  \right)},&\gcd(a, p)=1
\\
a^b,& \gcd(a,p)\ne1,b<\varphi (p)
\\
a^{\left(b\ \bmod \ \varphi(p) + \varphi(p) \right)},&\gcd(a, p)\ne1,b\ge \varphi (p)
\end{cases}
$$

我们发现不能仅仅靠后缀表达式，我们需要建立一颗后缀表达式树，因为我们需要先算出 $a$，然后根据 $a$ 是否与 $p$ 互质分类（$p$ 指的是当前的模数），然后再递归 $b$ 改变它的模数为 $\varphi(p)$。对于每个数字或字符直接动态开点记录左右儿子即可。

接下来的操作对于加法和乘法是比较简单的，我们直接将它们取模返回值即可。

当我们遇到次方运算时，我们需要计算 $a^b$，$a$ 是很容易得到的，直接递归左边的子树（$a$ 的子树下的值是可以直接 $\mod p$ 的），得到 $a$ 的值以后我们看 $\gcd(a,p)$ 是否为 $1$（是否互质）。

如果互质也就是第一种情况就非常简单，求得 $\varphi (p)$ 后把它当成 $b$ 的子树的模数下传得到之后返回快速幂计算即可。

发现不互质的情况还是很麻烦，需要判断 $b$ 与 $\varphi (p)$ 的大小。但 $b$ 下到子树下可能还会多次改变模数从而改变 $b$ 原来有的值，所以我们为了判断 $b$ 的大小再预处理一遍整颗后缀表达式树，算出 $\varphi (p)$ 后每次在 $b$ 运算时及时判断它什么时候超过了 $\varphi (p)$，超过了我们记录一个数组 $q$ 的值为 $-1$，没超过就直接记录 $b$ 的值，这样就可以对 $b$ 的大小分类，如果是 $-1$ 或者当前的 $q$ 值比当前的 $\varphi (p)$ 要大表示应该是上述第三种情况，否则已经得到了 $b$ 的值（在 $q$ 里面）直接运算即可。

这样就能发现获得了 $84pts$。

最后发现输入的数字还有可能是一个很多位数的数字，必须用高精度来存储，只用在刚开始的数字中计算即可（因为上传的时候会模数）。**建议高精度用结构体存储,并只在表达式树下层叶子节点数字计算高精度时使用，上层取模后可以直接存储。**

代码有点小多，要坚持下去才能打败这种大模拟题！

## Code

详见[云剪贴板](https://www.luogu.com.cn/paste/hoy2qocx)

---

## 作者：xieziheng (赞：4)

怎么这题没人做啊。

经过一些思考，我终于想到了一种非常好写的做法。

由于我不会表达式树，所以一般对于这种题我是直接对序列递归下去，感觉也挺好写的。

首先要分析一下表达式，这个很好做，就是从左到右扫一遍，合法的表达式一定形如 $ABAB...BA$ 其中 $A$ 代表合法的表达式，$B$ 代表一个运算符。

由于有指数的存在，所以需要时刻维护当前的模数，由扩展欧拉定理，可以预处理一下 $p=998244353$ 不断变成 $\varphi(p)$ 变成 $1$ 的所有值。

考虑找到最后算的那个运算符，就可以递归下去算两边，时刻维护此时的模数，再维护一个值，表示当前值 $v$ 是否大于 $p=998244353$，若大于，则为 $-1$，反之则为真实值。

这样就非常好写，加法和乘法模数是不变的，乘方直接变成 $\varphi(p)$ 即可，然后用扩展欧拉定理算一下。

还要判一下不合法的情况，大概就是同类型的（表达式，运算符）相邻、括号不匹配、一串数字后面跟着不是合法字符这几种。

---


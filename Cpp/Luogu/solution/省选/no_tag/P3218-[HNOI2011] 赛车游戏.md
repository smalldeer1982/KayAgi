# [HNOI2011] 赛车游戏

## 题目描述

名歌手LAALA最近迷上了一款赛车游戏，游戏中开车的玩家在不同的路段需要选择不同的速度，使得自己在最短的时间内到达终点。开始游戏时，车内的初始油量为f，所以游戏的关键是如何在速度和耗油量之间实现平衡。


LAALA 经过一段时间的研究后，发现这款游戏可以用一个简单的数学模型来描述，具体来说：从起点到终点的路线可以被简化成折线段，每条线段代表一个上坡或者下坡，若在一段斜率为 s(s>0 代表上坡，s=0 代表平地，s<0 代表下坡)的道路上以速度 v km/h 行驶，则每公里的耗油量为 max(0,av+bs)，其中 a 和 b 为游戏的内置参数，分别表示在平地行驶时的耗油率及斜坡对耗油量的影响(b 恒为正)。这里假设，加速和减速不耗油，且看成是瞬间完成的，所以即使在同一条线段上也可采取以不同的速度行驶的策略来缩短耗费的时间。


由于 LAALA 在以前的游戏中表现不佳，现在使用的车型依然是系统初始分配的，所以它的速度不能超过 vmax km/h。在获得这些参数后，LAALA 想知道在初始油量受限的情况下（中途不许加油）自己能得到的最佳成绩是多少。作为 LAALA 的歌迷，你能帮帮他吗?


## 说明/提示

【数据范围】


100%的数据满足 T≤100,0.1≤a≤100,0.1≤b≤100,10≤vmax≤200,0≤f≤50,r≤10000,1≤xi≤1000,-1000≤yi≤1000，且如果问题有解，那么答案不超过 24。


你所输出的答案需要恰好保留到小数点后 5 位,当且仅当你的输出与标准答案完全一致时你的输出才被视作正确。



## 样例 #1

### 输入

```
3
10.0 1.0 150 0.0
1
100.0 -100.0
10.0 100.0 150 1.0
2
100 0
100 100
0.5 0.1 100 10
3
1000 0
100 10
100 -10```

### 输出

```
1.41421
IMPOSSIBLE
0.07212```

# 题解

## 作者：dormantbs (赞：8)

这道题乍一看挺复杂的,其实思路理清之后还是比较简单的吧。  

首先我们可以手玩几组数据,发现取到最优解总是在每一段的速度都比较平均的情况下取到,因此我们不妨大胆猜想：  
最优解在速度基本相同的情况下最优。  

大概的证明如下(转自http://blog.163.com/bill125_zjh/blog/static/231801006201441025744282/):
![](https://s1.ax2x.com/2018/03/02/cpka6.jpg)

反正我是看不懂QwQ,但是我们学的是OI不是数学,所以我们只要有猜想就好了对吧(雾   

好的那么有了这两个个性质后,我们再继续观察题目中的耗油量的表达式:
$$ a*v+b*s $$
其中$a$,$b$,$s$ 都是定值,那么这个表达式我们就可以看做$ k*x+b $ 的形式,即耗油量与速度成正比。  

结合以上,我们可以二分整段速度的最大值,再由这个速度计算出最优解就好了。  

计算这里还有一个细节,若 $ a*v+b*s \le 0$,由题意这个时候的耗油量一定是$0$。  
但这个时候显然速度是可以更大的,  

由$$ a*v+b*s=0 $$
$$v=-\frac{b*s}{a}$$

这个时候 $ min\{-\frac{b*s}{a},maxv\} $ 才是更优的速度。


```cpp
#include<cstdio>
#include<algorithm>
#include<cmath>
using namespace std;
const double eps=1e-15;
const int N=10010;
struct Node{
	double x,y,k,len;
	inline void init(){
		scanf("%lf%lf",&x,&y);
		k=y/x,x/=1000.0,y/=1000.0,
		len=sqrt(x*x+y*y); 
	}
}c[N];
int T,n;
double a,b,mxv,f;
inline bool ck(double mid){
	double res=0.0;
	for(int i=1;i<=n;++i){
		res+=max(a*mid+b*c[i].k,0.0)*c[i].len;
		if(res+eps>=f) return 0;
	}return 1;
}
inline double calc(double v){
	double res=0.0;
	for(int i=1;i<=n;++i){
		double tmp=a*v+c[i].k*b;
		if(tmp<=eps){
			double vv=(-b*c[i].k)/a;
			vv=min(vv,mxv);
			res+=c[i].len/vv;
		}else{
			if(v<=eps) return 0;
			res+=c[i].len/v;
		}
	}
	return res;
}
inline void sol(){
	double l=0,r=mxv,mid;
	int t=0;
	while(t<1000){
		mid=(l+r)/2;
		if(ck(mid)) l=mid;
		else r=mid;
		++t;
	} 
	double res=calc(l);
	if(res<=eps) puts("IMPOSSIBLE");
	else printf("%.5lf\n",res);
}
int main(){
	if(fopen("test.in","r")){
		freopen("test.in","r",stdin);
		freopen("test.out","w",stdout);
	}
	scanf("%d",&T);
	while(T--){
		scanf("%lf%lf%lf%lf%d",&a,&b,&mxv,&f,&n);
		for(int i=1;i<=n;++i) c[i].init();
		sol();
	}
} 
```

---

## 作者：渔歌 (赞：2)

# [HNOI2011] 赛车游戏
## 对取平均数的简单证明

- （可能是伪证，发现错误希望能指出，毕竟据说是拉格朗日乘数法）
- 我们把每一段需要耗油的拎出来合在一起，在没有最大速度 vmax 的限制下，显然油耗完最优，那我们就能得到这样的式子(斜率为k）：


$$
\sum_{j=1}^m v[j]*s'[j]=(f-\sum_{i=1}^n b*k[i]*s[i])/a\\
\sum_{j=1}^m s'[j]=\sum_{i=1}^n s[i]
$$

- 之所以左侧用的是 m 是因为每一段上升或平地也可以拆成几段赋予不同的速度。
- 右侧均看成一个定值，所以问题转换成了下式($v[j]\to x_i,s'[j] \to y_i,n \to m$)：

$$ \begin{aligned}\sum_{i=1}^n x_iy_i=f\\\sum_{i=1}^n y_i=s\\求 \min{(\sum_{i=1}^n \frac {y_i}{x_i})}\\x_i>0,y_i>0,f,s为定量\end{aligned} 
$$

### 【壹】按速度分成两段：

$$
\begin{aligned}
x_1y_1+x_2y_2=f\\ y_1+y_2=s\\
	求 \min{(\frac {y_1}{x_1}+\frac {y_2}{x_2})}\\
	x_1,x_2>0,y_1,y_2>0,f,s为定量
 \end{aligned}
$$

**一，我们分别考虑 $y_1$ 取 $len(0<len<\frac{s}{2})$ 的情况：**

- 有 $y2=s-len$， 带回一式。

$$
\begin{aligned}
x_1len+x_2(s-len) & =f\\
x_2=&\frac{f-x_1len}{s-len}\\
\end{aligned}
$$

- 由于要使 $x_2>0$ ，所以 $f-x_1len>0,\frac{f}{len}>x_1$

$$
\begin{aligned}
\frac {y_1}{x_1}+\frac {y_2}{x_2}&=\frac {y_1x_2+x_1y_2}{x_1x_2}\\
&=\frac {\frac{f-x_1len}{s-len}len+(s-len)x_1}{\frac{f-x_1len}{s-len}x_1}\\
&=\frac {(f-x_1len)len+(s-len)^2x_1}{{(f-x_1len)x_1}}\\
&=\frac {flen+((s-len)^2-len^2)x_1}{fx_1-lenx_1^2}\\
&=\frac {flen+(s-2*len)sx_1}{fx_1-lenx_1^2}\\
\end{aligned}
$$

- 求其最小值，就是求 $ \frac {fx_1-lenx_1^2}{flen+(s-2*len)sx_1} $ 的最大值
$$
\begin{aligned}
&设x=flen+(s-2*len)sx_1,\frac {flen+(s-2*len)fs}{len}>x>lenf\\
&则x_1=\frac {x-flen}{(s-2*len)s}\\
\end{aligned}
$$



$$
\begin{aligned}
原式&=\frac{\frac {(x-lenf)f}{(s-2*len)s}-(\frac {x-flen}{(s-2*len)s})^2len}{x}\\
&=\frac{(x-lenf)(s-2*len)fs-(x-lenf)^2len}{(s-2*len)^2s^2x}\\
&=\frac{1}{(s-2*len)^2s^2}\frac{(s-2*len)fsx-(s-2*len)f^2slen-lenx^2-f^2len^3+2*flen^2x}{x}\\
&=\frac{1}{(s-2*len)^2s^2}*(fs^2-2*fslen+2*flen^2-lenx-\frac {f^2s^2len-2f^2slen^2+f^2len^3}{x})\\
&=\frac{1}{(s-2*len)^2s^2}*(fs^2-2*fslen+2*flen^2-lenx-f^2len\frac {(s-len)^2}{x})
\end{aligned}
$$


- 显然 $(s-len)^2$ 为正，同时形似一个**耐克函数**，当$x=f(s-len)$ 时有最小值($x>flen$)。代入求得：$x_1=\frac{(s-2*len)f}{(s-2*len)s}=\frac{f}{s},x_2=\frac {f-\frac{f}{s}*len}{s-len}=\frac{f}{s}$
- $x_1=x_2$，速度相同时答案一定有最小值 $f$ 。

**二，对于$y_1=len=\frac{s}{2}$ 的情况：**

$$
(x_1+x_2)len=f\\
x_1+x_2=\frac{f}{len}\\
{\frac{len}{x_1}+\frac{len}{x_2}}=\frac{(x_1+x_2)len}{x_1*x_2}=\frac{len^2}{x_1*x_2}
$$

- 由均值不等式显然可得，$x_1=x_2=\frac{f}{2*len}=\frac{f}{s}$  时，答案有最小值 $f$ 。


**三，对于$y_1=len>\frac{s}{2}$ 的情况：**

- 有$s-len<\frac{s}{2}$，同理可得。


**结论：**

- 在分成两段时，取平均速度最优，而我们按相同速度进行分段，则一段必定优于两段。

### 【贰】对于多段：

- 以三段为例，由于三段可以拆成两段+一段，分成一段优于分成两段，故三段劣于两段劣于一段。
- 数学归纳法，得证分为一段（取平均速度）最优。

### 【叁】后言：

- 考试的时候肯定没有时间让你折腾这么多，~~根据感性理解~~由于求和的各项形式一致可以直接猜是平均数。

- 感谢@[ **zhr2005**](https://www.luogu.com.cn/user/146867)的帮助，分类讨论 $y_1$ 的状态是我一直没想出来的，也因此卡了半天多。可以说是他的想法成就了这篇题解。


---


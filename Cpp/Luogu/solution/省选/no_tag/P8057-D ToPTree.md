# D ToPTree

## 题目背景

ToPTree 即 **To**oth**P**aste **Tree**，它的工作方式就如同挤牙膏——挤一下它才动一下。

## 题目描述

你有 $n$ 个数组成的序列 $[a_1\sim a_n]$，初始时 $a_i=0$。

有 $q$ 次操作组成的操作序列 $A$，第 $i$ 次操作在所有可能的 $nN(n+1)$ 种操作之内均匀随机：

- 在以下两种操作之中以一半的概率随机选择一种操作，作为这次操作。
- 随机选取满足条件的正整数 $l,r,x\ (1\le l\le r\le n,1\le x\le N)$，把 $[l,r]$ 区间内的数加上 $x$。
- 随机选取满足条件的正整数 $l,r,x\ (1\le l\le r\le n,1\le x\le N)$，把 $[l,r]$ 区间内的数改为 $x$。
- 容易发现每次操作共有 $nN(n+1)$ 种可能。

由于这棵树是 ToothPaste Tree，只有在你询问的时候，它才会执行与你这次询问有关且还没执行的操作。具体地，假设你依次询问了 $a_{p_1\sim p_m}$ 的值，则

- 询问 $a_{p_i}$ 时，把所有 $A$ 中与这个数有关的操作（即这次操作的 $[l,r]$ 包含 $p_i$）按时间顺序（即按 $A$ 中的顺序）执行了，并从 $A$ 中删除它们。然后输出 $a_{p_i}$ 当前的值。

> 比如 $A$ 中目前按顺序有以下四个操作，且 $a$ 中所有元素目前都是 $0$：
> 
> 1. 给区间 $[2,3]$ 加一。
> 2. 给区间 $[3,4]$ 加一。
> 3. 把区间 $[2,4]$ 赋值为一。
> 4. 给区间 $[2,3]$ 加一。
> 
> 现在询问了 $a_2$ 的值，那么操作 $1,3,4$ 会被顺序执行，导致 $a_1\sim a_4$ 分别变为 $[0,2,2,1]$。因此 ToPTree 输出 $2$。操作序列变为：
> 
> 1. 给区间 $[3,4]$ 加一。
> 
> 再询问 $a_3$ 的值，操作 $1$ 会被执行，导致操作序列变为空，并且 $a_1\sim a_4$ 变为 $[0,2,3,2]$，故输出 $3$。注意这个输出结果与按照顺序执行所有操作 $1\sim 4$ 得到的结果并不一致。

给定 $n,m,q,N$ 以及序列 $p$，ToPTree 一共会按询问顺序输出 $m$ 个值，求这 $m$ 次输出分别的期望，对 $998244353$ 取模。

（第一次询问之前，没有任何操作被执行了。）



## 说明/提示

**【数据范围】**

**本题采用捆绑测试。**

对于所有数据：$1\le n,N,q\le 9\times 10^8$，$1\le m\le 10^6$，$1\le p_i\le n$。详细数据范围如下：

- Subtask #1 (4 pts): $n,m,q,N\le 3$。
- Subtask #2 (10 pts): $n,m,q,N\le 5$。
- Subtask #3 (3 pts): $n=1$，$m,q\le 123456$。
- Subtask #4 (3 pts): $q=1$，$m\le 123456$。
- Subtask #5 (12 pts): $m=1$，$q\le 123456$。
- Subtask #6 (27 pts): $n,m,q,N\le 50$。
- Subtask #7 (9 pts): $m,q\le 5000$。
- Subtask #8 (16 pts): $m,q\le 123456$。
- Subtask #9 (16 pts): 没有任何附加限制。


## 样例 #1

### 输入

```
2 2 2 2
1 1```

### 输出

```
665496237 665496237```

# 题解

## 作者：feecle6418 (赞：4)

最初的观察是可以认为 $N=1$，最后输出时答案乘上 $(N+1)\div 2$。以下都认为 $N=1$。

首先注意到，虽然询问顺序与 Toptree 的**输出**有关，但询问顺序与 Toptree **输出的期望**无关。下面说明原因。

考察对 $a_x$ 进行的所有操作，采用以下方式计算期望。

首先枚举 $a_x$ 被做了哪些操作及其顺序，不妨设其按顺序被做了第 $b_1,b_2,\dots,b_k$ 次操作。

在这种情况下 $a_x$ 的终值期望是多少呢？发现，$a_x$ 的值期望只与最后一次赋值操作的位置有关。枚举这是第几次操作，可得答案是

$$
F(k)=\dfrac{1}{2^{k}}k+\sum_{i=1}^k\dfrac{1}{2^{i}}i=2-\dfrac{1}{2^{k-1}}
$$

枚举最后一次赋值操作是 $b_{k-i+1}$ 即得上式。前面那坨是不存在赋值操作的情况。

显然，上式与 $b$ 的具体值无关，在确定操作顺序的情况下，最终期望只与 $k$（总操作次数）有关。设 $B$ 为操作序列，最终答案可以写成

$$
\sum_{B}\Pr(\texttt{the sequence of operations is }B)F(|B|)
$$

$$
=\sum_{i=|B|}\Pr(\texttt{in total there are }i\texttt{ operations related to }a_x )F(i)
$$

设某一次操作与 $a_x$ 有关的概率是 $p=\dfrac{x(n-x+1)}{n(n+1)\div 2}$，则上式为（$F(i)$ 显然易算，以下视为常数）

$$
\sum_{i}F(i)p^i(1-p)^{q-i}\binom{q}i
$$

$$
=2\cdot \sum_{i}p^i(1-p)^{q-i}\binom qi-2\sum_{i}\left(\dfrac{p}{2}\right)^i(1-p)^{q-i}\binom qi
$$

$$
=2-2\left(1-\frac p2\right)^q
$$

用快速幂计算即可。时间复杂度 $O(m\log q)$。

---


# [COCI 2022/2023 #5] Zastave

## 题目描述

有 $n$ 个直角三角形，第 $i$ 个直角三角形的斜边长度为 $r_i$，这些直角三角形的高度和不超过 $S$。求这 $n$ 个直角三角形的最大面积和。

## 说明/提示

样例 $2$ 解释：

最大可能的情况是这个三角形的三边长为 $6,8,10$，面积为 $24$。

|子任务编号|	附加限制|	分值|
|:-:|:-:|:-:|
|$0$|	是样例|	$0$|
|$1$|	$n\le 100$|	$37$|
|$2$|	$n\le 1000$|	$20$|
|$3$|	无附加限制|	$43$|

## 样例 #1

### 输入

```
2 3
4 5
```

### 输出

```
6.5200982141
```

## 样例 #2

### 输入

```
1 6
10
```

### 输出

```
24.0000000000
```

## 样例 #3

### 输入

```
4 7
5 5 6 6
```

### 输出

```
18.5706715170
```

# 题解

## 作者：luyifan091120 (赞：3)

数学题+二分答案。

题目地址：[P9181](https://www.luogu.com.cn/problem/P9181)。

## 题目简述：

形式化的描述：给定 $r_1,r_2,\dots,r_n$，且 $\sum\limits_{i=1}^n x_i=s$，求 $S=\dfrac{1}{2}\sum\limits_{i=1}^n x_i\sqrt{r_i^2-x_
i^2}$ 的最大值。

## 做法分析：

首先，我们先介绍一下拉格朗日乘数法。

设给定 $n$ 元函数 $z=f(x_1,x_2,\dots,x_n)$ 和附加条件 $\varphi(x_1,x_2,\dots,x_n)=0$，为寻找  $z=f(x_1,x_2,\dots,x_n)$ 在附加条件下的极值点，先写出拉格朗日函数：$F(x_1,x_2,\dots,x_n,\lambda)=f(x_1,x_2,\dots,x_n)+\lambda\varphi(x_1,x_2,\dots,x_n)$，其中 $\lambda$ 为参数。

接着对 $x_1,x_2,\dots,x_n,\lambda$ 分别求偏导数：

$\begin{cases}F'_{x_1}=f'_{x_1}(x_1,x_2,\dots,x_n)+\lambda\varphi'_{x_1}(x_1,x_2,\dots,x_n)\\F'_{x_2}=f'_{x_2}(x_1,x_2,\dots,x_n)+\lambda\varphi'_{x_2}(x_1,x_2,\dots,x_n)\\\dots\\F'_{x_n}=f'_{x_n}(x_1,x_2,\dots,x_n)+\lambda\varphi'_{x_n}(x_1,x_2,\dots,x_n)\\F'_{\lambda}=\varphi_(x_1,x_2,\dots,x_n)\end{cases}$

则满足：$\begin{cases}F'_{x_1}=0\\F'_{x_2}=0\\\dots\\F'_{x_n}=0\\F'_{\lambda}=0\end{cases}$ 的 $\{x_1,x_2,\dots,x_n\}$ 即为可能的取等条件。

回到本题，即在约束条件 $\varphi(x_1,x_2,\dots,x_n)=\sum\limits_{i=1}^n x_i-s=0$ 的约束条件下，求 $z=f(x_1,x_2,\dots,x_n)=\sum\limits_{i=1}^n x_i\sqrt{r_i^2-x_
i^2}$ 的最大值，答案即为 $\dfrac{1}{2}z_{max}$。

构造拉格朗日函数：

$\begin{aligned}F(x_1,x_2,\dots,x_n,\lambda)&=f(x_1,x_2,\dots,x_n)+\lambda\varphi(x_1,x_2,\dots,x_n)\\
&=\sum\limits_{i=1}^n x_i\sqrt{r_i^2-x_
i^2}+\lambda(\sum\limits_{i=1}^n x_i-s)
\end{aligned}$。

则应该有：$\begin{cases}F'_{x_1}=\dfrac{r_1^2-2x_1^2}{\sqrt{r_1^2-x_1^2}}+\lambda=0\\F'_{x_2}=\dfrac{r_2^2-2x_2^2}{\sqrt{r_2^2-x_2^2}}+\lambda=0\\\dots\\F'_{x_n}=\dfrac{r_n^2-2x_n^2}{\sqrt{r_n^2-x_n^2}}+\lambda=0\\F'_{\lambda}=\sum\limits_{i=1}^n x_i-s=0\end{cases}$。

我们记 $k=-\lambda$，则有：

$\dfrac{r_1^2-2x_1^2}{\sqrt{r_1^2-x_1^2}}=\dfrac{r_2^2-2x_2^2}{\sqrt{r_2^2-x_2^2}}=\dots=\dfrac{r_n^2-2x_n^2}{\sqrt{r_n^2-x_n^2}}=k$。

解得：

$x_i^2=
\dfrac{4r_i^2-k^2-k\sqrt{8r_i^2+k^2}}{8}$。

又 $\dfrac{4r_i^2-k^2-k\sqrt{8r_i^2+k^2}}{8}$ 有可能小于 $0$，此时对应的 $x_i$ 不是实数，此时可设 $x_i=0$，即对 $S$ 的贡献为 $0$（因为不存在满足条件的 $x_i$）。

故：

$x_i=\begin{cases}0,\dfrac{4r_i^2-k^2-k\sqrt{8r_i^2+k^2}}{8}<0\\\sqrt{\dfrac{4r_i^2-k^2-k\sqrt{8r_i^2+k^2}}{8}},otherwise\end{cases}$。

最后，对 $k$ 进行二分，找出最小的 $k$，使得 $\sum\limits_{i=1}^n x_i<s$。

最后贴上 AC 代码：

```cpp
#include<bits/stdc++.h>
#define aa (4*r[i]*r[i]-k*k-k*sqrt(8*r[i]*r[i]+k*k))/8
#define eps 1e-9
long long n;
double s;
double r[100005];
double calc(double k){//计算面积的两倍
	double sum=0;
	for(int i=1;i<=n;++i){
		if(aa<0) continue;
		sum+=sqrt(aa)*sqrt(r[i]*r[i]-aa);
	}
	return sum;
}
double check(double k){//判断是否满足条件
	double len=0;
	for(int i=1;i<=n;++i){
		if(aa<0) continue;
		len+=sqrt(aa);
	}
	if(len>s) return 0;
	else return 1;
}
using namespace std;
int main(){
	scanf("%lld%lf",&n,&s);
	for(int i=1;i<=n;++i) scanf("%lf",&r[i]);
	double l,rr,mid;
	l=0,rr=100000;
	while(rr-l>eps){//二分
		mid=(l+rr)/2;
		if(check(mid)) rr=mid;
		else l=mid;
	}
	printf("%.10lf",calc(l)/2);
	return 0;
}
```

---

## 作者：Citlali_qwq (赞：2)

妙妙题。

## 题意

给定 $r_1\sim r_n$，且有 $\sum\limits_{i=1}^n x_i \le S$，求 $\max\{\sum\limits_{i=1}^n\ \dfrac{1}{2}\times x_i\sqrt{r_i^2-x_i^2}\}$。

## 做法

显然，为了结果最大，我们必须使得 $\sum\limits_{i=1}^n x_i = S$ 才能使结果取到最大值。

每个三角形在 $x_i=\dfrac{\sqrt 2}{2} r_i$ 时取到最优值。所以如果 $\sum \dfrac{\sqrt 2}{2} r_i \le S$ 时，答案就是 $\sum \dfrac{1}{4}r_i^2$。

否则，我们需要将某一些 $x_i$ 减小是的 $\sum x_i \le S$。

令第 $i$ 个三角形的 $2$ 倍面积 $f(x_i) = x_i\sqrt{r_i^2-x_i^2}$。显而易见的，在 $x_i=\dfrac{\sqrt{2}}{2}r_i$  时取得最大值，在 $x_i$ 单调递减时，$f(x_i)$ 也单调递减。

不妨对 $f(x_i)$ 求导。$f'(x_i)=x_i'\sqrt{r_i^2-x_i^2}+x_i\sqrt{r_i^2-x_i^2}'=\dfrac{r_i^2-2x_i^2}{\sqrt{r_i^2-x_i^2}}$。

![](https://cdn.luogu.com.cn/upload/image_hosting/7kkrjmq5.png)

这张图描绘了在 $r=4$ 时 $f(x)$ 与 $f'(x)$ 的图像。在 $x_i$ 递减时，$f'(x)$ 递增。

所以为了使得 $\sum f(x)$ 取得最大值，对于 $x_1\sim x_n$，$f'(x_i)$ 应该是相同的。不妨令这个值为 $k$。

带入 $f'(x_i)$，可以解得：

$$x_i^2=\dfrac{-k^2+4r_i^2-k\sqrt{k^2+8r_i^2}}{8}$$

我们可以二分 $k$，然后对于每一个 $k$，求出 $\sum x_i$ 是否小于 $S$ 即可。若 $x_i^2 < 0$，我们可以认为不计算这个三角形的面积。

## 代码

```cpp
/*****************************************
备注：
******************************************/
#include <iostream>
#include <sstream>
#include <string>
#include <vector>
#include <stack>
#include <queue>
#include <set>
#include <map>
#include <algorithm>
#include <cstdio>
#include <cstdlib>
#include <cstring>
#include <cctype>
#include <cmath>
#include <cassert>
#include <climits>
using namespace std;
typedef long long ll;
typedef unsigned long long ull;
#define int ll
const int MAXN = 2e6 + 10;
const int MR = 10 + 5;
const int INF = 0x3f3f3f3f;
const int MOD = 1e9 + 7;
const int _ = 0;
const long double eps = 1e-13;
const bool debug = false;
#define check(x)cout << #x << "   ===   " << x << endl;

inline int read()
{
    int s = 0, f = 1;
    char x = getchar();
    while(x < '0' || x > '9')
    {
        if(x == '-')f = -1;
        x = getchar();
    }
    while(x >= '0' && x <= '9')
    {
        s = s * 10 + x - '0';
        x = getchar();
    }
    return s * f;
}

void print(int x)
{
    printf("%d", &x);
}

int n, s, r[MAXN];
long double ck(long double k)
{
	long double res = 0;
	for(int i = 1; i <= n; i++)
	{
		long double now = (-k * k + 4ll * r[i] * r[i] - k * sqrt(k * k + 8ll * r[i] * r[i])) / 8;
		if(now < 0)continue;
		now = sqrt(now);
		res += now;
	}
	return (res);
}
long double calc(long double k)
{
	long double res = 0;
	for(int i = 1; i <= n; i++)
	{
		long double now = (-k * k + 4ll * r[i] * r[i] - k * sqrt(k * k + 8ll * r[i] * r[i])) / 8;
		if(now < 0)continue;
		now = sqrt(now);
		res += now * sqrt(1ll * r[i] * r[i] - now * now);
	}
	return res / 2;
}
signed main()
{
	// int start = clock();
	cin >> n >> s;
	long double sum = 0, sum1 = 0;;
	for(int i = 1; i <= n; i++)
	{
		cin >> r[i];
		sum += r[i];
		sum1 += r[i] * r[i];
	}
	sum *= (sqrt(2));sum /= 2.0;
	if(sum <= s)
	{
		printf("%.10Lf", sum1 / 4.0);
		exit(0);
	}
	long double l = 0, r = 1e8;
	while(r - l > eps)
	{
		long double mid = (l + r) / 2;
		if(ck(mid) <= s)r = mid;
		else l = mid;
	}
	printf("%.10Lf", calc(l));
	// printf("%.3lf", clock() - start);
    return ~~(0^_^0);
}
```

---

## 后记

还有一个很坑的点，必须要开 long double，还要将 eps 设置为 $10^{-13}$ 才能过，因为这题神奇 SPJ 卡了我将近 1 天。

---

## 作者：henryhu2006 (赞：1)

需要明确，题目中的高度指一条直角边的长度。

如果 $\dfrac{1}{\sqrt2}\sum r_i\le S$，那么选择高度为 $\dfrac{1}{\sqrt2}r_i$ 显然优，它是等腰直角三角形。

否则我们需要消减某些直角三角形的高度。

显然会选择较短的一条边作为高，设为 $x_i$。如果 $\sum x_i\ge S$，那么需要减少某个 $x_i$ 并使得损失最小。对于第 $i$ 个三角形面积的**两倍**，显然为：

$$
f_i(x)=x\sqrt{r_i^2-x^2}
$$

即可认为其在当前 $x_i$ 的导函数最小。

但是显然在 $\dfrac{1}{\sqrt 2} r_i$ 处导函数为 $0$，因为此处为极小值点。于是上面贪心的本质是导函数单调上升（随着 $x$ 递减）。

> 于是，对于任意一个 $S$，所有 $f_i'(x_i)$ 都是同一个值。

先求 $f_i(x)$ 的导函数：

$$
f_i'(x)=x'\sqrt{r_i^2-x^2}+x\sqrt{r_i^2-x^2}'
$$

$$
=\dfrac{r_i^2-2x^2}{\sqrt{r_i^2-x^2}}
$$

并且导函数在 $=0$ 之前都是单调递减的（随着 $x$ 递增）。而且当 $x\to 0$ 时，$f_i(x)\to r_i$。

于是我们二分导函数大小为 $k$，解得每个 $x_i$，然后判断 $\sum x_i$ 是否合法。

这个方程解起来比较复杂，直接给出结果（注意是 $x_i^2$）：

$$
x_i^2=\dfrac{-k^2+4r_i^2-k\sqrt{k^2+8r_i^2}}{8}
$$

可能会出现小于 $0$ 的情况，此时直接认为这个三角形被完全抛弃，将贡献特判为 $0$。

于是就做完了，时间复杂度 $\mathcal O(n \log v)$。

```cpp
#include<bits/stdc++.h>
using namespace std;
typedef long long ll;
const double eps=1e-10;
int n,r[100005]; ll s;
double check(double c){
	double sum=0;
	for(int i=1;i<=n;++i){
		double x=(-c*c+4ll*r[i]*r[i]-c*sqrt(c*c+8ll*r[i]*r[i]))/8;
		if(x<0) continue; x=sqrt(x);
		sum+=x;
	}
	return sum;
}
double cal(double c){
	double sum=0;
	for(int i=1;i<=n;++i){
		double x=(-c*c+4ll*r[i]*r[i]-c*sqrt(c*c+8ll*r[i]*r[i]))/8;
		if(x<0) continue; x=sqrt(x);
		sum+=x*sqrt(1ll*r[i]*r[i]-x*x);
	}
	return sum;
}
int main(){
	cin>>n>>s;
	for(int i=1;i<=n;++i) scanf("%d",::r+i);
	double l=0,r=1e5;
	while(r-l>eps){
		double mid=(l+r)/2;
		if(check(mid)<=s) r=mid;
		else l=mid;
	}
	printf("%.9lf",cal(l)/2);
	return 0;
}
```

由于洛谷没有用 SPJ，所以上面代码过不了。需要用 `long double` 并将 $\epsilon$ 设为 $10^{-13}$ 才能过。

---


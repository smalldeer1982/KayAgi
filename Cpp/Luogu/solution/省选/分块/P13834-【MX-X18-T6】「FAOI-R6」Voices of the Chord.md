# 【MX-X18-T6】「FAOI-R6」Voices of the Chord

## 题目背景

对于这件事，你完全可以更加自豪。

## 题目描述

给定：
- 长度为 $n$ 的初始全为 $0$ 的整数序列 $a_1, \ldots, a_n$。
- 长度为 $k$ 的整数序列 $b_1, \ldots, b_k$，保证 $1 \le b_i \le m$。
- $m$ 个非空整数集合 $S_1, \ldots, S_m$，保证集合中的元素 $s_{i, j}$ 满足 $1 \le s_{i, j} \le n$。每个集合 $S_i$ 中的元素互不相同，但不同的两个集合 $S_{i_1}, S_{i_2}$ 可能共享重复元素。

你需要**在线地**进行 $q$ 次操作，格式如下：
1. $\texttt{l r x}$：你需要执行 $\forall i \in [l,r],\forall j \in S_{b_i},a_j\gets a_j+x$。**注意，一个数 $\boldsymbol j$ 在多个集合 $\boldsymbol{S_i}$ 中出现时要加多次。**
2. $\texttt{l r}$：你需要回答 $\sum_{i=l}^r a_i$ 对 $2^{32}$ 取模的值。

## 说明/提示

**【样例解释 #1】**

解密后的数据如下：

```cpp
5 5 2 4
1 2 1 2 1
3 1 2 3
3 3 4 5
1 1 2 1
2 1 5
1 3 3 2
2 3 3
```

第一次操作为修改，将集合 $\{1,2,3\},\{3,4,5\}$ 中的 $j$ 的 $a_j$ 加上 $1$，序列变为 $[1,1,2,1,1]$。

第二次操作为查询，答案为 $1+1+2+1+1=6$。

第三次操作为修改，将集合 $\{1,2,3\}$ 中的 $j$ 的 $a_j$ 加上 $2$，序列变为 $[3,3,4,1,1]$。

第四次操作为查询，答案为 $4$。

**【样例解释 #2】**

解密后的数据如下：

```cpp
8 6 4 8
4 4 3 2 2 4
6 1 2 3 4 5 7
8 1 2 3 4 5 6 7 8
4 1 2 3 7
6 1 2 3 4 5 8
1 6 6 6
2 2 4
2 4 4
1 1 5 2
2 2 3
2 2 6
1 2 6 3
2 1 5
```

**【数据范围】**

**本题采用捆绑测试**。

| 子任务编号 | $m \le$ | $n,k,q \le$ | $\sum \lvert S_i\rvert\le$ | 特殊性质 | 分值 |
| :----------: | :----------: | :----------: | :----------: | :----------: | :----------: |
| $1$ | $200$ | $200$ | $600$ |  | $6$ |
| $2$ | $2 \times 10^3$ | $2 \times 10^3$ | $6 \times 10^3$ |  | $11$ |
| $3$ | $10$ | $10^5$ |$3 \times 10^5$ |  | $16$ |
| $4$ | $10^5$ | $10^5$ |$3 \times 10^5$ | AB | $16$ |
| $5$ | $10^5$ | $10^5$ |$3 \times 10^5$ | A | $16$ |
| $6$ | $10^5$ | $10^5$ | $3 \times 10^5$ |  | $35$ |

- 特殊性质 A：保证 $k = m$，且 $b_1, \ldots, b_k$ 是一个 $1 \sim m$ 的排列。
- 特殊性质 B：对于每次修改，保证 $l=r$。

对于所有数据，$1 \le n,k,m,q \le 10^5$，$1\le b_i\le m$，$1 \le \sum \lvert S_i\rvert \le 3 \times 10^5$，$1\le \lvert S_i\rvert\le n$，$1\le s_{i, j} \le n$。对于操作 1，$1\le l\le r\le k$，$0 \le x < 2^{16}$；对于操作 2，$1\le l\le r\le n$。

## 样例 #1

### 输入

```
5 5 2 4
1 2 1 2 1
3 1 2 3
3 3 4 5
1 1 2 1
2 1 5
1 5 5 2
2 5 5```

### 输出

```
6
4
```

## 样例 #2

### 输入

```
8 6 4 8
4 4 3 2 2 4
6 1 2 3 4 5 7
8 1 2 3 4 5 6 7 8
4 1 2 3 7
6 1 2 3 4 5 8
1 6 6 6
2 2 4
2 22 22
1 7 3 2
2 4 5
2 34 38
1 66 70 3
2 65 69
```

### 输出

```
18
6
32
64
145
```

# 题解

## 作者：xxxxxzy (赞：5)

下面默认 $n,m,k$ 同阶。

首先考虑一个弱化版问题，保证 $l=r$，尽管完全没有关系。

这个是很好做的，根号分治一下集合大小，然后离线随便整下拿个分块平衡一下就轻松 $O(n \sqrt n)$。

再考虑一个简单的问题，保证 $b_i=i$，好像也没啥关系，这个也是简单的可以做到根号，简单说一下，把集合给拆开，然后进行分块，维护 $f_{i,x}$ 代表块 $x$ 的修改对前缀 $i$ 的贡献，时空都是根号。

上面的子问题给我们一个思路，对序列进行分块，维护一些预处理信息。

首先考虑对 $b$ 进行分块，为了防止混淆，记 $B_i$ 代表 $b$ 数组的第 $i$ 个块，另外记 $T_i$ 代表包含 $i$ 下标的集合。

按照上面的思路，维护出 $f_{i,j}$ 代表，$B_i$ 对 $a$ 前缀 $j$ 的贡献。

但是这样会剩下散块信息难以维护，我们考虑对散块信息再次加以处理。

进行转化，转化为下面的子问题：

+ $O(1)$ 进行 $t_x \to t_x + k$。
+ $O(\sqrt n)$ 查询 $\displaystyle \sum\limits_{i=l}^r \displaystyle \sum\limits_{j \in T_i} t_{j}$。

感觉也是难以维护的，发现其实第一个要求 $O(1)$ 完成的操作在原序列上是连续的，而没有较好利用这个连续性。

考虑对 $a$ 也进行分块，记 $A_i$ 为 $a$ 的第 $i$ 个块。

我们只需要处理两类贡献。

+ $b$ 的散块对 $a$ 的整块：这个是简单的，按照上面的思路，维护出 $g_{i,j}$ 代表 $b$ 的前缀 $i$ 对 $A_j$ 的影响。
+ $b$ 的散块对 $a$ 的散块。

第二类贡献仍然不太好做，因为 $a$ 的散块可能总大小很大。

继续利用一下 $\sum |T| = \sum |S|$ 的性质，对 $a$ 进行以 $|T_i|$ 为权的带权分块，让块的权重 $\le \sqrt S$，这样散块修改就是对的。

记 $V = \sum S_i$，时间 $O(V \sqrt n + (n + q) \sqrt V)$，空间 $O(n \sqrt V)$，时间瓶颈在预处理上，代码实现比较简单，2 KB 左右。

---


# [NFLSPC #6] 挑战停机问题

## 题目背景

作为新时代的 OIer/XCPCer，你已经不满足于挑战 NPC 问题了。你想挑战数学的不可判定性——图灵停机问题。

## 题目描述

图灵给了你一个程序。程序开始运行之初，有且仅有一个变量 $A$，初始值为 $0$。程序共有 $n$ 行，行号为 $1 \sim n$，每行是如下几种形式之一：

- `A a`：令 $A \gets A + a$，然后执行下一行。
- `G x`：执行第 $x$ 行。
- `I l r x y`：如果 $A \in [l, r]$ 则执行第 $x$ 行，否则执行第 $y$ 行。
- `E`：直接结束程序。

保证最后一行是 `E`。

图灵希望你判断这个程序从第一行开始执行会不会结束。为了进一步检验你到底是不是真的会判定停机问题（还是装的？），图灵还要求你给出 $A$ 最终的值，如果程序不会结束且不存在一个时刻使得在其以后 $A$ 不再变化，则输出 `@Turing ?`。

## 说明/提示

对于所有数据，$1 \leq T \leq 1000$，$1 \leq n, \sum n \leq 10^5$，$1 \leq a \leq 10^9$，$0 \leq l \leq r \leq 10^9$，$1 \leq x, y \leq n$。保证输入涉及到的所有数字都是整数。

- 子任务 1（15 分）：不存在 `I` 类语句。
- 子任务 2（20 分）：$r \leq 100$。
- 子任务 3（40 分）：$\sum \max r \leq 10^5$。
- 子任务 4（25 分）：无特殊限制。

Source：NFLSPC #6 G by chenxia25

## 样例 #1

### 输入

```
3
5
I 1 7 1 3
G 4
A 2
G 2
E
6
A 2
I 2 3 5 1
E
G 4
A 1
E
4
A 1
G 1
E
E
```

### 输出

```
No
2
Yes
3
No
@Turing ?
```

# 题解

## 作者：chenxia25 (赞：7)

注意到 $a > 0$, 也就是 $A$ 总是不降的, 所以我们只需要快速地模拟 $A$ 从 $0$ 增加到超过 $\max r$ 的过程, 此后 `I` 类语句的跳转也就固定了, 只要简单地判环即可.

现在我们来考虑如何快速地模拟 $A \leq \max r$ 的过程. 先考虑 $\sum \max r \leq 10^5$ 的子任务, 这就是说我们可以对每个 $A_0 \in [0, \max r]$, 都去处理 $A = A_0$ 的时间段. 在 $A = A_0$ 固定时, 所有的 `I` 类语句的跳转也是固定的, 如果能够快速知道在当前局面下遇到的第一个 `A` 类语句 (或陷入循环), 问题便迎刃而解. 容易想到用并查集维护: 对跳转类语句进行连边, `A` 类和 `E` 类不连边, 并查集可以得到从某个点出发一直沿唯一的出边走会停在哪里 (再记录加边失败的信息即可判环). 而 `I` 类语句的贡献可以拆成 $A_0$ 所在的三个区间, 每个区间内的连边情况是固定的, 使用线段树分治 + 可撤销并查集 (按秩合并优化) 即可. 时间复杂度 $\mathrm O(n + \max r \log n \log \max r)$.

再来考虑正解. 虽然不再能对每个 $A_0 \in [0, \max r]$ 依次处理, 但注意到所有 `I` 类语句的跳转情况只有不超过 $2n$ 种本质不同的局面, 且对应 $A_0$ 的不超过 $2n$ 个区间, 于是考虑对每个区间依次处理, 求出在哪行进入下一个区间 (或陷入循环), 以及在过程中 $A$ 增加了多少. 注意到任意局面下跳转情况是一个基环树和树的混合森林, 考虑用 LCT 维护 (对于基环树, 随意断掉环上的一条边), 在链所对应的 Splay 上二分即可. 对于基环树的没有被加入的那些条边, 采用懒惰加入法, 即加入失败 (成环) 的时候就不加, 等到在 LCT 上跳到未将出边加入到 LCT 的跳转语句节点时再加入. 这样每条语句至多被加入 $\mathrm O(1)$ 次, 由势能分析法可知总复杂度为 $\mathrm O(n \log n)$.

---


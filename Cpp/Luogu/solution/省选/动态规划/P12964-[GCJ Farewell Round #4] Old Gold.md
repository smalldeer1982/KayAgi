# [GCJ Farewell Round #4] Old Gold

## 题目描述

很久很久以前（7 年前），你曾在东南亚一条东西向的道路上寻找黄金，这条道路已知至少含有一块金块。当时你使用了一个有限但可靠的金块探测器。在靠这些黄金暴富后，你尝试并厌倦了所有能想到的活动。某天，你在巨大的豪宅中闲逛时，发现了当年寻金时的一些笔记。

这些笔记以道路示意图的形式记录。对于道路的每一公里，笔记上有以下 5 种标记之一：

*   $<$，表示最近的金块位于西侧，
*   $=$，表示东西两侧最近的金块距离相等，且当前位置没有金块，
*   $>$，表示最近的金块位于东侧，
*   o，表示当前位置有金块，或
*   .，表示该位置信息未知。

由于每个未知位置（.）可以独立地选择是否放置金块，你需要计算在所有 $2^{k}$ 种可能的金块分布中，有多少种分布既符合所有笔记记录，又能保证整条道路上至少存在一块金块。由于结果可能非常大，只需输出结果对质数 $10^{9}+7$（即 $1000000007$）取模后的余数。


## 说明/提示

**样例解释**

在样例 #1 中，有三种有效的金块分布，分别对应道路 $\mathrm{o} \mathrm{o}<=>\mathrm{o}<$、$\mathrm{o} \mathrm{o}<=>\mathrm{oo}$ 和 $\mathrm{o}<<=>\mathrm{o}$。

在样例 #2 中，没有有效的金块分布。

在样例 #3 中，唯一有效的分布对应道路 $\mathrm{o}=\mathrm{o}$。注意有效的分布必须保证整条道路上至少有一块金块。

在样例 #4 中，所有 $2^{17}$ 种分布都有效。在这种情况下，即使选择在所有未知位置（.）不放置金块，整条道路仍有一块金块，因此这种分布也是有效的。

**限制**

- $1 \leq \mathbf{T} \leq 100$。
- 字符串 $\mathbf{S}$ 的每个字符是 $<$（小于）、$=$（等于）、$>$（大于）、o（小写字母 o）或 .（句点）之一。
- $\mathbf{S}$ 中至少有 1 个但并非全部字符是 .（句点）。

**测试集 1（5 分，可见评测结果）**

- 时间限制：20 秒。
- $2 \leq \mathbf{S}$ 的长度 $\leq 100$。

**测试集 2（17 分，隐藏评测结果）**

- 时间限制：40 秒。
- $2 \leq \mathbf{S}$ 的长度 $\leq 5 \times 10^{5}$。

翻译由 DeepSeek V3 完成

## 样例 #1

### 输入

```
4
o..=>..
...o>..........
.=.
.........o........```

### 输出

```
Case #1: 3
Case #2: 0
Case #3: 1
Case #4: 131072```

# 题解

## 作者：stardust_Ray (赞：0)

显然有 dp 状态 $f_i$ 表示第 $i$ 个位置上有黄金的方案数。然后考虑所有字符造成的限制：

1. 对于第 $i$ 个点之前的 `=`，设位置为 $p$，那么这之前的第一个黄金的位置就需要 $=2p - i$ 或者 $>p$。

2. 对于第 $i$ 个点之前的 `>`，设位置为 $p$，那么这之前的第一个黄金的位置就需要 $< 2p - i$ 或者 $> p$。

3. 对于第 $i$ 个点之前的 `<`，设位置为 $p$，那么这之前的第一个黄金的位置就需要 $> 2p - i$。

4. 对于第 $i$ 个点之前的 `o`，设位置为 $p$，那么这之前的第一个黄金的位置就需要 $\ge p$。

对于 $1,3,4$ 三种限制，我们都只需要记录最后一个该字符即可处理，转移是区间和形式。对于第二个限制我们发现每次只需要新去掉 $2p - i$ 这个位置上的点，然后我们又可以发现如果 $2p - i$ 最多延伸到左边第一个 `>` 就不用再进行，因为这个时候可以由左边的 `>` 来处理限制，所以这个部分均摊是 $O(n)$ 次单点修改。用 BIT 优化，复杂度 $O(n\log n)$。

---


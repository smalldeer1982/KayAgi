# [EGOI 2025] IMO

## 题目背景

滥用本题评测资源将被封号。

## 题目描述

国际数学奥林匹克（IMO）是一项面向高中生的数学竞赛，每年举办一次。2025 年的 IMO 正好与 EGOI 同时进行。当你读到这道题时，两天的 IMO 正赛已经结束，评分工作也大概接近尾声。与 EGOI 这样的程序设计竞赛不同，IMO 的评分完全依靠人工完成，这是一项漫长而繁琐的工作。

今年的 IMO 包含 $M$ 道题目（编号为 $0$ 到 $M-1$），每道题的满分为 $K$ 分。有 $N$ 名选手参加比赛。第 $i$ 名选手在第 $j$ 道题上的得分为 $a_{i,j}$，其中 $a_{i,j}$ 是 $0$ 到 $K$ 之间的整数（包含 $0$ 和 $K$）。选手的排名由总分决定，若总分相同，则按选手编号（索引）从小到大排名。更正式地说，若满足以下条件之一，则选手 $x$ 的排名高于选手 $y$：

* 选手 $x$ 的总分大于选手 $y$ 的总分，
* 或者两人总分相同且 $x < y$。

为了公布最终排名，主办方需要公开部分 $a_{i,j}$ 的值。若某个值未公开，则只知道它是 $0$ 到 $K$ 之间的某个整数。

主办方希望尽量少地公开 $a_{i,j}$ 的值。同时，他们必须确保所有人都能唯一确定最终排名。换言之，主办方需要公开一组 $a_{i,j}$，使得与这些信息相符的排名只有唯一的正确排名。

请你求出最小的 $S$，使得最多只需公开 $S$ 个 $a_{i,j}$，就能唯一确定所有选手的完整排名。

## 说明/提示

### 样例说明

在第一个样例中，只需公开 20 个分数即可，方案如下：

| 7 | 7 | 0 | $\cdot$ | 7 | $\cdot$ |
| --- | --- | --- | --- | --- | --- |
| 7 | 3 | 0 | 7 | 2 | 1 |
| $\cdot$ | 0 | 0 | $\cdot$ | 0 | 0 |
| 7 | 7 | 7 | 7 | 7 | 1 |

此时，第三名选手的总分已知在 $0$ 到 $14$ 之间，肯定低于其他所有人。可以证明，不能再少公开一个分数。例如，如果隐藏第三名选手的某个 $0$，那么他的总分最高可达 $21$，这就可能导致第二名选手的总分 $20$ 无法保证排在第三名前面。

第一个样例满足测试组 5 和 6 的约束。

在第二个样例中，只需公开第一名选手的唯一分数，或者只公开第二名选手的唯一分数（不可都公开）。如果只公开第一名选手的分数，就能确定他总分为 $1$，即使第二名选手分数也是 $1$，第一名选手编号更小，排名更高。类似地，如果只公开第二名选手的分数，可知他总分为 $0$，无论第一名得多少分，第一名都排名更高。

第二个样例满足测试组 2、3、4、5、6 的约束。

第三个样例满足测试组 2、3、5、6 的约束。

第四个样例满足所有测试组的约束。

### 约束与评分

* $2 \leq N \leq 20000$
* $1 \leq M \leq 100$
* $1 \leq K \leq 100$
* $0 \leq a_{i,j} \leq K$，对所有 $0 \leq i \leq N-1$，$0 \leq j \leq M-1$

你的解答将在一组测试组上进行评测，每组包含若干测试用例。要获得该测试组的分数，你需要通过该测试组的所有测试用例。

| 测试组 | 分值 | 限制条件 |
| :-: | :-: | :-: |
| 1 | 10 | $N = M = 2$ 且 $K = 1$ |
| 2 | 13 | $N = 2$ |
| 3 | 10 | $N \cdot M \leq 16$ |
| 4 | 18 | $K = 1$ |
| 5 | 21 | $N \leq 10000$ 且 $M, K \leq 10$ |
| 6 | 28 | 无额外限制 |

翻译由 ChatGPT-4.1 完成。

## 样例 #1

### 输入

```
4 6 7
7 7 0 2 7 0
7 3 0 7 2 1
7 0 0 7 0 0
7 7 7 7 7 1```

### 输出

```
20```

## 样例 #2

### 输入

```
2 1 1
1
0```

### 输出

```
1```

## 样例 #3

### 输入

```
2 2 7
7 4
7 0```

### 输出

```
2```

## 样例 #4

### 输入

```
2 2 1
0 1
1 0```

### 输出

```
2```

# 题解

## 作者：chen_zhe (赞：2)

这是 [官方题解](https://www.luogu.com.cn/fe/api/problem/downloadAttachment/dgf2z5ye) 的 AI 翻译。

---

### EGOI 2025 官方题解 - IMO

**任务作者：Eliška Macáková**

**2025 年 7月 18 日**

这个问题的灵感来源于某次地方数学竞赛中发生的一个真实情况。除了一个选手的某道题目的得分外，所有的成绩都已公布。这名选手对其中一个问题使用了非常规的解法。当她请求组织者最终为她的解答评分时，他们辩称这无论如何都不会改变她的最终排名，因为她与排名在她前面的人之间有很大的分数差距。

子任务 1、2、3 的描述解法与题解的其余部分无关。然而，如果你希望理解完整解法，你应该从子任务 4 的解法开始阅读，因为它为后续子任务的解法提供了动机，并定义了一些将被重用的概念。

#### 引言

在这个任务中，你将得到一个竞赛中每道题、每位选手的评分结果，你需要揭晓最少数量的分数，使得正确的排名可以被确定。

#### 测试组 1: $N = M = 2, K = 1$

你可以通过案例分析或暴力搜索来解决这个子任务。

#### 测试组 2: $N = 2$

固定为第一位和第二位选手揭晓的分数数量。注意，对于应该获得更高分数的选手，最好公布她得分最高的那些题目；而对于另一位选手，最好公布她得分最低的那些题目。检查这样做是否会导致两位选手之间无歧义的比较，并通过检查所有可能为两位选手揭晓分数数量的组合，找到最优答案。这可以用 $O(NM^2)$ 的时间复杂度实现，但渐近更慢的实现也能通过。

#### 测试组 3: $N \cdot M \le 16$

尝试所有隐藏和揭晓分数的可能性，然后计算每位选手可能获得的分数范围，并检查他们的排序是否唯一（因此分数范围只能在端点处重叠，而且即使这样，也只有在分数相等情况下的比较标准能正确评估时才行）。时间复杂度为 $O(2^{N \cdot M} \cdot N^2 \cdot M)$。

#### 测试组 4: $K = 1$

每位选手的得分要么是 0 要么是 1。设 $c_{i,0}$ 是第 $i$ 位选手获得 0 分的题目数量，而 $c_{i,1}$ 是第 $i$ 位选手获得 1 分的题目数量（注意，对于每个 $i$，$c_{i,0} + c_{i,1} = M$）。当你

---

决定为选手 $i$ 揭晓 $y_i$ 个分数时，她的分数下界 $l_i$ 可以是 $\max(0, y_i - c_{i,0}), \dots, \min(y_i, c_{i,1})$ 中的任意一个数，而她的分数上界 $r_i$ 将等于 $l_i + (M - y_i)$。

这引出了一个动态规划解法。根据选手的最终排名对他们进行排序，动态规划的状态将是 $(i, S, x)$，其中：

*   $i$ = 我们已经为其确定了揭晓分数的（按成绩排序的）前多少位选手
*   $S$ = 根据我们揭晓的分数，第 $i$ 位选手的得分下界
*   $x$ = 到目前为止我们隐藏了多少分数。揭晓的分数数量则简单地是 $i \cdot M - x$。

并且 $dp[i][S][x] = 1$ 表示有办法做到这一点，否则为 0。从 $dp[i][S][x]$ 的转移是通过检查所有可能的 $l_{i+1}, r_{i+1}$（根据上面的推理）来完成的。现在如果 $r_{i+1} < S$ 或者 $r_{i+1} = S$ 且应该排在第 $i+1$ 位的选手原始排名高于应该排在第 $i$ 位的选手，你就可以更新 $dp[i+1][l_{i+1}][x + (r_{i+1} - l_{i+1})]$（$r_{i+1} - l_{i+1}$ 是如果我们想要选手 $i+1$ 的分数下界为 $l_{i+1}$，上界为 $r_{i+1}$，根据已揭晓的信息，我们应该为她隐藏的分数数量）。

为了加速这个过程，注意到对于一个固定的 $i, x$，我们拥有的 $S$ 越高越好，所以我们可以改为计算 $dp[i][x] = S$，表示如果我们为前 $i$ 位选手选择了分数，并选择隐藏了其中的 $x$ 个，那么第 $i$ 位选手可能获得的最高分数下界是多少。现在对于转移，我们可以首先固定为第 $i+1$ 位选手隐藏的分数数量 $h_{i+1}$，然后计算我们可以拥有的最高 $r_{i+1}$，使得第 $i+1$ 位选手肯定排在第 $i$ 位选手之后，然后尝试用 $l_{i+1} = r_{i+1} - h_{i+1}$ 来更新 $dp[i+1][x+h_{i+1}]$。

我们可以隐藏多少分数？因为我们为选手 $i$ 隐藏了 $r_i - l_i$ 个分数，并且我们知道 $M \ge r_1 \ge l_1 \ge r_2 \ge l_2 \ge r_3 \ge \dots \ge l_n \ge 0$ 应该成立，那么我们可以得到隐藏分数的总数 $\sum (r_i - l_i) < M$。所以我们可以隐藏的分数数量渐近地低于总分数数量，这是在隐藏分数数量而不是揭晓分数数量上进行动态规划的动机。

所以我们有 $N \cdot M$ 个状态，每个状态有 $M$ 次转移，因此总时间复杂度是 $O(N \log N + NM^2)$（第一个因子来自开始时按最终分数排序选手，第二个因子是原始索引）。

#### 测试组 5: $N \le 10,000$ 且 $M, K \le 10$

与上一个子任务类似，主要思想是为每位选手 $i$ 预计算其分数可能的下界和上界，然后进行 $dp[i][X]$。

让我们分析一下一位选手 $i$ 的情况，并找出她的分数的下界和上界可能是什么。首先，观察到 $r_i = l_i + h_i \cdot K$，其中 $l_i, r_i$ 是选手 $i$ 分数的下界和上界，而 $h_i$ 是她隐藏的分数数量（$l_i$ 代表我们将所有剩余的 $h_i$ 道题都评为 0 分的情况，$r_i$ 代表我们将所有剩余的 $h_i$ 道题都评为满分 $K$ 的情况）。

我们可以引入以下动态规划来帮助我们找到所有可能的 $l_i$ 和 $r_i$——令：

*   $j$ 是她考虑过的分数的前缀（对于每个分数，我们试图决定是隐藏还是揭晓它）。
*   $S$ 是到目前为止揭晓分数的总和。
*   $x$ 是到目前为止隐藏分数的数量。

那么 $t_i[j][S][x]$ 为 1 表示你可以达到这些参数，否则为 0。从一个可达状态 $t_i[j][S][x]$ 的转移可以按以下方式进行——如果她在第 $j+1$ 道题上得了 $s_{j+1}$ 分，那么如果我们隐藏这个分数，我们进入状态 $t_i[j+1][S][x+1]$，否则，我们进入状态 $t_i[j+1][S+s_{j+1}][x]$。最终，当且仅当 $t_i[M][l_i][h_i] = 1$ 时，$l_i, r_i$ 这对界限才是可达的。所以我们可以遍历所有可达的 $t_i[M][S][x]$ 来找到所有可能的 $l_i, r_i$。

---

这个预计算可以在 $O(M^3 K)$ 的时间复杂度内为每个 $i$ 完成，因为我们有 $O(M \cdot MK \cdot M)$ 个状态，每个状态有 $O(1)$ 次转移。

现在要解决原始问题，我们可以调整上一个子任务的动态规划。状态仍然是前缀长度和隐藏分数数量的对 $(i, x)$，值将是我们可能拥有的最大下界 $S$。要从 $dp[i][x]=S$ 进行转移，固定 $h_{i+1}$ 和 $l_{i+1}$，使得对应的 $r_{i+1}$ 不会太高（小于或小于等于 $S$），然后尝试用 $l_{i+1}$ 更新 $dp[i+1][x+h_{i+1}]$。开始时，将 $dp[0][0]$ 初始化为 $M \cdot K$，其余为 $-\infty$。

再次注意，由于在最优解中 $M \cdot K \ge r_1 \ge l_1 \ge r_2 \ge l_2 \ge r_3 \ge \dots \ge l_n \ge 0$ 成立，并且隐藏分数的数量等于 $\sum h_i < M \cdot K$，所以动态规划的第二维 $x$ 最多只能到 $M$。

那么状态数量是 $O(N \cdot M)$，每个状态导致 $O(MK \cdot M)$ 次转移，所以这个解法的总时间复杂度是 $O(N \log N + NM^3 K)$。

#### 测试组 6: 无进一步限制

为了加速测试组 5 的解法，我们需要再做一个优化。设 $m_i$ 是第 $i$ 位选手所有分数都被揭晓时的得分。注意，在最优解中，对于所有的 $i$，必须满足 $m_{i+1} \le l_i$，否则，如果选手 $i$ 剩下的题目都得 0 分，而选手 $i+1$ 得到她的真实分数，他们的排名就会不正确。

然后我们可以修改动态规划 $t_i$ ——令：

*   $j$ 是考虑的选手 $i$ 的分数的前缀（对于每个分数，我们试图决定是隐藏还是揭晓它）。
*   $S$ 是 $m_i$ 减去她到目前为止隐藏分数的总和。
*   $x$ 是到目前为止隐藏分数的数量。

那么 $t_i[j][S][x]$ 为 1 当且仅当这个状态是可能达到的。从这个状态，你可以进行转移到 $t_i[j+1][S-s_{j+1}][x+1]$（如果你决定隐藏值为 $s_{j+1}$ 的第 $j+1$ 个分数），或者到 $t_i[j+1][S][x]$（否则）。开始时将 $t_i[0][m_i][0] = 1$ 初始化，其余为 0。可达的对 $l_i, r_i$ 仍然可以像之前一样从 $t_i[M]$ 推断出来。

现在因为在任何解中都有条件 $m_{i+1} \le l_i$，所以只考虑满足 $m_{i+1} \le l_i$ 的对 $l_i, r_i$ 是有意义的，所以我们不必考虑 $S < m_{i+1}$ 的 $t_i$ 状态。

因此，计算 $t_i$ 的时间复杂度现在是 $O(M \cdot (m_i - m_{i+1}) \cdot M)$（如果实现得当），对所有 $i$求和为 $O(M^3 K)$。

现在要完成这个问题，你可以做与测试组 5 中相同的动态规划，但在为每个 $i$ 更新时，你不会考虑低于 $m_{i+1}$ 的 $l_i$，所以这一步的总时间复杂度将是 $O(\sum_i (m_i - m_{i+1}) \cdot M^2) = O(M^3 K)$。

这个解法的总时间复杂度是 $O(N \log N + M^3 K)$，足以在 $N \le 20,000, M, K \le 100$ 的约束下获得满分。

---


# [NWERC 2023] Galaxy Quest

## 题目描述

你正在驾驶你的宇宙飞船穿越银河系。
银河系中有 $n$ 个行星，编号从 $1$ 到 $n$，每个行星在三维空间中被建模为一个点。

你可以通过 $m$ 条太空高速公路在这些行星之间旅行，每条高速公路连接两个行星，并沿它们之间的直线延伸。
你的引擎可以以 $1\,\text{m}/\text{s}^2$ 的加速度（或减速度）加速或减速，同时以每秒 $1$ 升的速率消耗燃料。
你的飞船没有速度上限，但每当你到达高速公路终点的行星时，必须完全停下来。

一条高速公路可能会穿过除其连接的两个行星以外的其他行星。
然而，由于你的飞船配备了特殊的超空间技术，它可以直接穿越这些障碍而无需停下。
使用该技术的另一个后果是：你无法在途中从一条高速公路跳到另一条高速公路，必须始终完整地走完一条高速公路。

![](https://cdn.luogu.com.cn/upload/image_hosting/qe10l8cm.png)

:::align{center}
图 G.1：样例输入 1 的示意图，蓝色为高速公路，展示了从行星 $1$ 到行星 $3$ 的一条路线。绿色为高速公路起点（加速），红色为终点（减速）。
:::

你需要执行若干次任务，每次任务都从你的家园行星（编号 $1$）出发，需要在给定的时间限制内到达指定目标行星。
对于每个任务，判断能否完成，如果可以，求出所需的最少燃料量。
例如，图 G.1 展示了第一个样例中第二个任务的最优路线。

## 说明/提示



由 ChatGPT 4.1 翻译

## 样例 #1

### 输入

```
4 4 3
-30 0 0
0 0 0
50 0 0
-30 10 0
1 2
2 3
3 4
4 1
2 10
3 25
4 7```

### 输出

```
impossible
19.0538441903
4.0000000000```

## 样例 #2

### 输入

```
4 2 5
-3 0 2
7 -9 -3
4 4 -6
8 -1 8
1 2
2 3
2 1000
2 100
3 1000
3 100
4 1000```

### 输出

```
0.0287058122
0.2874671888
0.1120998619
1.1272896971
impossible```

# 题解

## 作者：Diaоsi (赞：0)

[[NWERC 2023] Galaxy Quest](https://www.luogu.com.cn/problem/P13706)

先求解单个询问。对于路径 $e_1e_2\dots e_m$，假设在这条路径的第 $i$ 条边（长度为 $d_i$）花费 $x_i$ 的时间进行加/减速，根据高中物理可以求出通过这条路径的时间为 $2x_i+\dfrac{d_i-x_i^2}{x_i}=x_i+\dfrac{d_i}{x_i}$。为保证合法（终点速度为零）需满足 $x_i\leq \sqrt{d_i}$。问题被转化为

$$
\begin{aligned}

\min\quad &\sum_{i=1}^m 2x_i\\

\text{s.t.}\quad &\sum_{i=1}^m x_i + \dfrac{d_i}{x_i}\leq t.
\end{aligned}
$$

由于下面的限制是越松越好，所以可以取等号。使用拉格朗日乘数法求解这个最优化问题，设

$$
f(x_1,x_2,\dots,x_m)=\sum_{i=1}^m2x_i,\quad g(x_1,x_2,\dots,x_m)=\left(\sum_{i=1}^m x_i + \dfrac{d_i}{x_i}\right)- t.
$$

需要满足两个限制：$\nabla f=\lambda \nabla g$ 并且 $g(x_1,x_2,\dots,x_m) = 0$。根据第一个限制列出方程

$$
\dfrac{\partial}{\partial x_i} f =\lambda \dfrac{\partial}{\partial x_i} g \Rightarrow2=\lambda\left(1-\dfrac{d_i}{x_i^2}\right)\Rightarrow x_i=\sqrt{\dfrac{\lambda}{\lambda-2}}\sqrt{d_i}\,.
$$

令 $c=\sqrt{\dfrac{\lambda}{\lambda-2}}$，发现对于每个 $x_i$，其最优取值都形如 $c\sqrt{d_i}$。此时第二个限制等价于

$$
\left(c+\dfrac{1}{c}\right)\sum_{i=1}^m\sqrt{d_i}=t,
$$

$c$ 有解当且仅当 $\tfrac{t}{\sum_{i=1}^m\sqrt{d_i}}\geq 2$，并且一定有一个根满足 $c\leq 1$。根据 $c+\dfrac{1}{c}$ 的函数性质，最小化 $\sum_{i=1}^m\sqrt{d_i}$ 就能最小化 $c$，同时也使得 $\sum_{i=1}^m 2x_i=2c\sum_{i=1}^m\sqrt{d_i}$ 最小。

于是得到最终算法：对每条边以 $\sqrt{d_i}$ 为边权建图后跑单源最短路。对于每个询问，$\mathcal{O}(1)$ 求解二次方程（或判断无解）得到 $c$ 后回答。

时间复杂度 $\mathcal{O}(m\log n + q)$，代码不给。

---


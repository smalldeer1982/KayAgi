# 「CZOI-R6」抽奖

## 题目描述

公园里出现了一台抽奖机！根据小道消息，抽奖机在接下来的 $n$ 天的某一天晚上会撤走。抽奖机最终在每天晚上撤走的概率都相等。

你想在这 $n$ 天进行抽奖。初始时，你有一个中奖概率 $p = 0$。

每一天上午，你都会积攒运气，使得 $p$ 增加 $\frac{1}{n}$。

每一天下午，你都可以选择抽奖或不抽奖。若抽奖，设当前为第 $i$ 天，则你需要花费 $\frac{n}{n-i+1}$ 的代价，以 $p$ 的概率使得你的收益增加 $w$，且让 $p$ 重置为 $0$。$w$ 是一个固定的常量。

你制订了一个最优的策略以最大化你获得的收益减你付出的代价。你想知道假如你按照此策略，期望的收益减代价为多少。

**出于某种原因，你需要输出期望值乘 $\boldsymbol{n^2}$ 后对 $\boldsymbol{10^9 + 7}$ 取模的结果**。

## 说明/提示

**【数据范围】**

**本题采用捆绑测试。**



| 子任务编号 |    $T \leq$    | $n \leq$ |    $w \leq$     | 分值 |
| :--------: | :------------: | :------: | :-------------: | :--: |
|    $1$     |      $5$       |   $20$   |      $50$       | $15$ |
|    $2$     |      $5$       |  $10^3$  | $3 \times 10^3$ | $15$ |
|    $3$     |      $20$      |  $10^6$  |     $10^6$      | $30$ |
|    $4$     | $5\times 10^3$ |  $10^6$  |     $10^6$      | $40$ |

对于 $100\%$ 的数据，$1\leq T\leq 5\times 10^3$，$1\leq n,w\leq10^6$。

## 样例 #1

### 输入

```
7
1 2
2 1
5 3
10 15
347 1562
724 15
283917 192034```

### 输出

```
1
0
2
400
87949316
1579768
172877821
```

# 题解

## 作者：arrow_king (赞：0)

不错的计数题目，但是场上想出来的是斜率优化的形式，没有优化的可能了，赛后看了计数的做法茅厕顿开，写个题解记录一下。

我们考虑在抽奖机存在时间长度固定的情况下我们获取的收益是什么。首先我们获得的钱仅取决于最后一次抽奖的时间，因为每天的 $p$ 都增加 $\frac 1n$。

那么我们可以发现最优策略其实就是根据 $n,w$ 选择一些抽奖的固定时间点 $a_1,a_2,\dots,a_m$（设 $a_{m+1}=n+1$，$a_0=0$），对每个 $1\le n^\prime\le n$ 进行抽奖，取其收益期望的期望。由于这里乘了 $n^2$ 那就是收益和的和。

考虑如何计算总贡献。对于一对相邻的 $(a_i,a_{i+1})$，考虑 $n^\prime\in[a_i,a_{i+1})$，抽中的钱都是 $\frac{a_i}nw$。因此我们的总收益就是
$$
n^2\cdot\sum_{i=1}^m\dfrac{a_{i+1}-a_i}{n}\cdot\dfrac{a_iw}{n}=w\sum_{i=0}^ma_i(a_{i+1}-a_i)
$$
那么我们花费的钱数是什么呢？考虑在 $a_i$ 抽奖的花费是 $\frac{n}{n-a_i+1}$，而对于每一个 $n^\prime\ge a_i$，我们都需要在 $a_i$ 处花费，因此 $a_i$ 会有 $n-a_i+1$ 次花费贡献，加起来就是
$$
n^2\cdot\dfrac1n\sum_{i=0}^m\dfrac{n}{n-a_i+1}\cdot(n-a_i+1)=n^2m
$$
哦这是个只与 $m$ 有关的定值。

因此答案就是
$$
w\sum_{i=0}^ma_i(a_{i+1}-a_i)-n^2m
$$
我们考虑对它做一些变形，设 $d_i=\Delta a_i=a_{i+1}-a_i$，有
$$
\begin{aligned}
2\sum_{i=0}^m a_id_i&=2\sum_{i=0}^md_i\sum_{j=0}^{i-1}d_j\\
&=2\sum_{0\le i<j\le m}d_id_j=\bigg(\sum_{i=0}^m d_i\bigg)^2-\sum_{i=0}^md_i^2
\end{aligned}
$$
我们知道 $\sum_{i=0}^md_i=a_{m+1}=n+1$，因此要最大化原式的值就是最小化 $\sum_{i=1}^md_i^2$，而这是简单的，只需要让 $d_i$ 的极差 $\le 1$。证明考虑两个差 $\ge 2$ 的元素 $a<b$，让 $a$ 加 $1$，让 $b$ 减 $1$，答案的变化量是 $2a+1-(2b-1)=2(a-b)+2<0$。

因此我们发现最终的 $b_i$ 中有 $x=\left\lfloor\dfrac{n+1}{m+1}\right\rfloor$ 和 $y=\left\lfloor\dfrac{n+1}{m+1}\right\rfloor+1$ 两种数，且其各自的个数是确定的，对于给定的 $m$ 可以 $O(1)$ 求答案。

现在的做法是 $O(tn)$ 的，无法通过。我们发现当 $\left\lfloor\dfrac{n+1}{m+1}\right\rfloor$ 是定值的时候，$x,y$ 的出现次数 $c_x=m+1-(n+1)\bmod (m+1)$ 和 $c_y=(n+1)\bmod (m+1)$ 都是 $m$ 的一次函数。因此最终的答案最多是关于 $m$ 的二次函数。

二次函数的最大值是很好求的，但是要分类讨论开口是否向上。但事实上我们有
$$
\begin{aligned}
\dbinom{c_x}{2}x^2+\dbinom{c_y}{2}y^2+xyc_xc_y&=\dfrac12x^2c_x^2+\dfrac12y^2c_y^2+xyc_xc_y-\dfrac12(x^2c_x+y^2c_y)\\
&=\dfrac12\left[(xc_x+yc_y)^2-x^2c_x-y^2c_y\right]
\end{aligned}
$$
考虑到 $xc_x+yc_y=n+1$，因此上式为一次函数，所以最值就是端点的最值，直接数论分块做即可，复杂度 $O(t\sqrt n)$。

---


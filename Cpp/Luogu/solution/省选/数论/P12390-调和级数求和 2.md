# 调和级数求和 2

## 题目背景

前情提要：[调和级数求和](https://www.luogu.com.cn/problem/P5702)。←注意，解决这道题目对于解决本题可能并不会有什么帮助。

## 题目描述

给定正整数 $n,p,k$。定义 $\operatorname{inv}(x,p^k)$ 是满足 $ax\equiv 1\pmod{p^k}$ 的小于 $p^k$ 的非负整数 $a$，如果不存在这样的 $a$ 则 $\operatorname{inv}(x,p^k)=0$。可以证明，如果存在这样的 $a$，那么它是唯一的。

现在，你需要求出下式的值：
$$\sum_{i=1}^n\operatorname{inv}(i,p^k)$$
由于答案可能很大，所以需要对 $p^k$ 取模。

**注意此处 $\bm p$ 不一定是质数。**

## 说明/提示

**本题采用捆绑测试。**

- Subtask 1 (10pts)：$k=1$。
- Subtask 2 (40pts)：$\frac np\le 10^4$。
- Subtask 3 (50pts)：无特殊限制。

对于全部数据，有 $1\le n\le 10^{18}$，$2\le p\le 10^6$，$p^k\le 10^{18}$。



## 样例 #1

### 输入

```
4 3 1```

### 输出

```
1```

## 样例 #2

### 输入

```
123456 78 9```

### 输出

```
37527411787678151```

## 样例 #3

### 输入

```
142857142857142857 2 59```

### 输出

```
573170602055236649```

# 题解

## 作者：joke3579 (赞：7)

优化（？）自 [NaCly_Fish 题解](https://www.luogu.me/article/vzj6nwma)。

根据基础数论知识，$\mathrm{inv}(x, p^k) \neq 0$ 当且仅当 $\gcd(x, p^k) = 1$，进一步地，其等价于 $\gcd(x, p) = 1$。从而我们需要计算的就是

$$\sum_{i = 1}^n \dfrac{[\gcd(i, p) = 1]}{i} = \sum_{i = p\lfloor n/p\rfloor}^n \dfrac{[\gcd(i, p) = 1]}{i} + \sum_{t = 0}^{p - 1} [\gcd(t, p) = 1] \sum_{i = 0}^{\lfloor n/p\rfloor - 1} \dfrac{1}{ip + t}$$

前半部分可以直接枚举 $i$ 计算，只需要考虑后半部分。

通过二项式展开，我们可以将 $(ip + t)^{-1}$ 视为以 $p$ 为形式变元的幂级数，而 $\bmod\ p^k$ 的条件只是将幂级数在 $k$ 次幂处截断为多项式，并给了多项式的系数一个模数。那么不妨枚举与 $p$ 互质的 $t$（这也指出 $t$ 自然有逆），考察截断在 $k$ 次项的多项式

$$F_{t,n}(x) = \sum_{i = 0}^{n} \dfrac{1}{ix + t} = \dfrac{1}{t} \sum_{j = 0}^{k - 1} (-x/t)^j\sum_{i = 0}^{n} i^j$$

我们需要的 $F_{t, n}$ 中 $n$ 都相同，那么如果预处理了指数为 $0, \dots, k - 1$ 的自然数幂和，我们就能对任意 $t$ 以 $O(k)$ 的复杂度计算 $F_{t, n}(p)$。这是简单的：我们已经知道了

$$\sum_{i = 1}^n i^k = \sum_{i = 0}^k {k\brace i} \dfrac{(n + 1)^{\underline{i + 1}}}{i + 1}$$

再注意到 $n + 1, \dots, n - i + 1$ 这 $i + 1$ 个数中有且仅有一个数是 $i + 1$ 的倍数，我们就能 $O(k^2)$ 地预处理下降幂的部分，从而 $O(k^2)$ 计算出每个需要的自然数幂和。到这里，我们就能 $O(pk)$ 计算第二部分了。

最后是一些保证复杂度的实现细节：求逆可以用非递归 exgcd 实现，单次复杂度 $O(k\log p)$，而且可以减少很多常数；第一部分可以简单做到 $O(p + k \log p)$，只需按照一次求逆求乘法逆元的方式写；$[\gcd(i, p) = 1]$ 和 $i^{-1}$ 都是积性的，可以线性筛出来，复杂度是至多 $O(pk)$ 的。

总时间复杂度 $O(k^2 + pk)$。

[Submission](https://www.luogu.com.cn/record/215725241)。

---

## 作者：jijidawang (赞：6)

> **Lemma**
>
> 若 $n$ 模 $p$ 意义下的逆元为 $I$，则 $n$ 模 $p^k$ 意义下的逆元：
> $$I'\equiv I\sum_{i=0}^{k-1}\dbinom k{i+1}\cdot (-nI)^i\pmod{p^k}$$

证明：令 $nI=pt+1$，则:
$$\begin{aligned}nI'&=nI\sum_{i=0}^{k-1}\dbinom k{i+1}\cdot (-nI)^i\\&=1-\sum_{i=0}^k\dbinom ki(-nI)^i\\&=1-(1-nI)^k\\&=1+(-1)^{k+1}t^kp^k\\&\equiv1&\pmod{p^k}\end{aligned}$$

那么可以知道：

$$\begin{aligned}\sum_{i=1}^n\operatorname{inv}(i,p^k)&\equiv\sum_{i=1}^n\operatorname{inv}(i,p)\sum_{j=0}^{k-1}\dbinom{k}{j+1}(-i\operatorname{inv}(i,p))^j&\pmod{p^k}\\&=\sum_{j=0}^{k-1}(-1)^j\dbinom k{j+1}\sum_{i=1}^ni^j\operatorname{inv}(i,p)^{j+1}\\&=\sum_{j=0}^{k-1}(-1)^j\dbinom{k}{j+1}\sum_{i=0}^{p-1}\operatorname{inv}(i,p)^{j+1}\sum_{t=0}^{\lfloor\frac{n-i}p\rfloor}(pt+i)^j\\&=\sum_{j=0}^{k-1}(-1)^j\dbinom{k}{j+1}\sum_{i=0}^{p-1}\operatorname{inv}(i,p)^{j+1}\sum_{t=0}^{\lfloor\frac{n-i}p\rfloor}\sum_{l=0}^j\dbinom jl(pt)^li^{j-l}\\&=\sum_{j=0}^{k-1}(-1)^j\dbinom{k}{j+1}\sum_{l=0}^jp^l\dbinom jl\sum_{i=0}^{p-1}i^{j-l}\operatorname{inv}(i,p)^{j+1}\sum_{t=0}^{\lfloor\frac{n-i}p\rfloor}t^l\end{aligned}$$

已经可以直接 $\tilde O(pk^2+k^3)$ 计算了（自然数幂和直接暴力 $O(k^2)$ 算）。实现要稍微精细一点。

关于怎么求自然数幂和：首先有经典转化：
$$\sum_{i=1}^ni^k=\sum_{i=0}^k{k\brace i}\dfrac{(n+1)^{\underline{i+1}}}{i+1}$$
此处下降幂是 $i+1$ 个数的乘积，一定有一个数是 $i+1$ 的倍数，暴力求下降幂的时候找到它然后除掉就可以了。

---


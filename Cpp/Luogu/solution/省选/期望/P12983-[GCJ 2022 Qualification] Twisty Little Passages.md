# [GCJ 2022 Qualification] Twisty Little Passages

## 题目描述

你正在调查一个洞穴。洞穴中有 $\mathbf{N}$ 个房间，某些房间之间通过双向的地下通道相连。每个房间至少连接一条通道。没有通道从一个房间指向自身，且任意两个房间之间最多只有一条通道。

当身处某个房间时，你可以识别当前所在的房间编号并查看它连接了多少条通道，但无法区分具体是哪条通道。你需要估算洞穴中存在的通道总数。你最多可以进行 $\mathbf{K}$ 次操作，每次操作可以是以下两种之一：

* **魔法传送**：立即传送到任意一个你选择的房间。
* **随机行走**：从当前房间随机选择一条连接通道走过去（所有通道被选中的概率均等），到达该通道另一端的房间。

你从任意一个房间开始调查。通过最多 $\mathbf{K}$ 次操作，估算洞穴中房间之间的通道总数。

设 $E$ 是你的估算值，$P$ 是实际通道数量，当且仅当满足 $P \cdot 2/3 \leq E \leq P \cdot 4/3$ 时，你的答案被视为正确。要通过一个测试集，至少需要答对该测试集中 90% 的测试用例。

### 交互协议

这是一个交互题。

初始时，你的程序需读取一个整数 $\mathbf{T}$，表示测试用例数量。接着处理 $\mathbf{T}$ 个测试用例。

对于每个测试用例，你的程序首先读取一行包含两个整数 $\mathbf{N}$ 和 $\mathbf{K}$，分别表示洞穴中的房间数量和允许的最大操作次数。房间编号为 $1$ 到 $\mathbf{N}$。洞穴结构在测试用例开始时确定，不会在探索过程中改变。之后，程序需处理最多 $\mathbf{K} + 1$ 次交互。

第 $i$ 次交互开始时，你需要读取一行包含两个整数 $\mathbf{R}_i$ 和 $\mathbf{P}_i$，表示当前所在房间编号及其连接的通道数量。接着，输出以下三种指令之一：

* 单个大写字母 $\mathbf{W}$：表示选择随机行走。
* 单个大写字母 $\mathbf{T}$ 和一个整数 $S$：表示传送到房间 $S$。
* 单个大写字母 $\mathbf{E}$ 和一个整数 $E$：表示结束探索并估算通道总数为 $E$。

在输出估算指令后，无论估算是否正确，裁判将立即开始下一个测试用例（如果存在）。如果没有更多测试用例，裁判将静默等待程序结束。

如果裁判在任何时刻收到非法格式的输入，或某测试用例的第 $(\mathbf{K} + 1)$ 次交互未输出估算指令，裁判将输出 $-1$ 并终止交互。若此时程序仍在等待输入，将因超时被判为 **Time Limit Exceeded**。注意：需确保程序及时退出以避免超时错误。若内存超限或程序运行时错误，将得到相应判果。

## 说明/提示

**样例解释**

![](https://cdn.luogu.com.cn/upload/image_hosting/ve57bfoy.png)

可通过本地测试工具或平台进行调试。本地测试时需同时运行交互工具（如我们提供的交互运行器）。更多说明详见工具文件内的注释。

测试工具的使用说明已内嵌在注释中。建议添加自定义测试用例。请注意：该工具**并非**真实评测系统，实际行为可能存在差异。

**限制条件**

**测试集 1（29 分，可见判果）**

- $1 \leq \mathbf{T} \leq 100$。
- $2 \leq \mathbf{N} \leq 10^5$。
- $K = 8000$。
- 每个房间至少连接一条通道。

翻译由 DeepSeek V3 完成

## 样例 #1

### 输入

```
1
5 3
4 1

5 2

4 1

1 3```

### 输出

```



T 5

W

T 1

E 5```

# 题解

## 作者：Hughpig (赞：6)

这题真牛。

首先给出一个结论：对于一张无向图来说，所有点的度数和是边数的两倍。考虑每条边都会给两个点带来 $1$ 的度数，因此总度数是边数的两倍。

对于 $K\ge N-1$ 的情况，我们可以通过传送操作访问所有的点，外加初始时给你的点的信息，我们可以得知所有点的度数，进而计算总边数。

而对于 $N$ 更大的情况，我们无法访问所有点了。考虑随机抽样访问点，挑选 $K$ 个点访问记录度数，通过样本计算总边数。这样做可以过掉约 $67$ 个测试数据。[提交记录](https://www.luogu.com.cn/record/221771087)。

考虑特殊的情况：对于一个菊花图，我们直接能够随机到中间的度数大的点的概率是极小的，很大概率会遇到其它度数小的点，导致统计不准确。但从旁边度数少的点游走大概率能走到它。

所以我们少传送几次，然后开始游走，分别通过传送和游走计算期望总边数，然后取平均值即可。传送太多也没有很大意义，因此可以设定最多传送 $500$ 次，然后开始游走。

然后就能过 $90$ 个测试数据左右了，可以通过本题。没过就多交几次吧。

---


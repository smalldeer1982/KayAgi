# éšæœºæ¼«æ¸¸

## é¢˜ç›®æè¿°

H å›½æœ‰ $N$ ä¸ªåŸå¸‚

åœ¨æ¥ä¸‹æ¥çš„ $M$ å¤©ï¼Œå° c éƒ½ä¼šå»æ‰¾å° wï¼Œä½†æ˜¯å° c ä¸çŸ¥é“å° w çš„å…·ä½“ä½ç½®ï¼Œæ‰€ä»¥å° c å†³å®šæ¯æ¬¡éšæœºæ‰¾ä¸€æ¡è·¯èµ°ï¼Œç›´åˆ°é‡åˆ°äº†å° w ä¸ºæ­¢

å° c çŸ¥é“å° w åªæœ‰å¯èƒ½æ˜¯åœ¨ $c_1, c_2.. c_n$ è¿™ $n$ ä¸ªåŸå¸‚ä¸­çš„ä¸€ä¸ªï¼Œå° c æƒ³çŸ¥é“åœ¨æœ€åæƒ…å†µä¸‹ï¼Œå° c é‡åˆ°å° w æœŸæœ›è¦ç»è¿‡å¤šå°‘æ¡é“è·¯

H å›½æ‰€æœ‰çš„è¾¹éƒ½æ˜¯æ— å‘è¾¹ï¼Œä¸¤ä¸ªåŸå¸‚ä¹‹é—´æœ€å¤šåªæœ‰ä¸€æ¡é“è·¯ç›´æ¥ç›¸è¿ï¼Œæ²¡æœ‰ä¸€æ¡é“è·¯è¿æ¥ç›¸åŒçš„ä¸€ä¸ªåŸå¸‚

ä»»ä½•æ—¶å€™ï¼ŒH å›½ä¸å­˜åœ¨åŸå¸‚ $u$ å’ŒåŸå¸‚ $v$ æ»¡è¶³ä» $u$ æ— æ³•åˆ°è¾¾ $v$

## è¯´æ˜/æç¤º

$H$ å›½çš„é“è·¯æ„æˆä¸€æ¡é“¾ï¼Œæ‰€ä»¥æœ€åæƒ…å†µä¸‹å°±æ˜¯å° w åœ¨æ·±åº¦æœ€å¤§çš„ç‚¹ä¸Š(ä»¥å° c æ‰€åœ¨çš„åŸå¸‚ä¸ºæ ¹)

å¯¹äºç¬¬ä¸€å¤©ï¼Œå° c æ‰€åœ¨çš„åŸå¸‚ä¸º 1ï¼Œæ·±åº¦æœ€å¤§çš„ç‚¹ä¸º 2ï¼ŒåŸå¸‚ 1 åªèƒ½åˆ°è¾¾åŸå¸‚ 2ï¼ŒæœŸæœ›ç»è¿‡ 1 æ¡é“è·¯åˆ°è¾¾

å¯¹äºç¬¬äºŒå¤©ï¼Œå° c æ‰€åœ¨çš„åŸå¸‚ä¸º 1ï¼Œæ·±åº¦æœ€å¤§çš„ç‚¹ä¸º 3ï¼Œè®¡ç®—çš„æœŸæœ›ç»è¿‡ 4 æ¡é“è·¯åˆ°è¾¾

ç¬¬ä¸‰å¤©åŒç¬¬äºŒå¤©

æœ€åæƒ…å†µä¹Ÿå°±æ˜¯è¯´ç»è¿‡æ‰€æœ‰ $n$ ä¸ªå¯èƒ½çš„åŸå¸‚è‡³å°‘ä¸€é

subtask1 : 10åˆ†ï¼Œ$N = 4, M = 12$

subtask2 : 15åˆ†ï¼Œ$N =10, M = 100000$

subtask3 : 15åˆ†ï¼Œ$N = 18, M = 1$

subtask4 : 10åˆ†ï¼Œ$N = 18, M = 99995$ï¼Œå›¾æ˜¯ä¸€æ¡é“¾

subtask5 : 10åˆ†ï¼Œ$N = 18, M = 99996$ï¼Œæ‰€æœ‰çš„ $s$ éƒ½ç›¸åŒ

subtask6 : 15åˆ†ï¼Œ$N = 18, M = 99997$ï¼Œ$E = N-1$

subtask7 : 15åˆ†ï¼Œ$N = 18, M = 99998$ï¼Œæ‰€æœ‰çš„ $s$ éƒ½ç›¸åŒ

subtask8 : 10åˆ†ï¼Œ$N = 18, M = 99999$

å¯¹äºæ‰€æœ‰æ•°æ® : $1\leq N\leq 18, 1\leq M\leq 100000, 1\leq E\leq \frac{N(N-1)}{2}$

## æ ·ä¾‹ #1

### è¾“å…¥

```
3 2
1 2
2 3
3
2 1 2 1		
3 1 2 3 1
1 3 1```

### è¾“å‡º

```
1
4
4```

# é¢˜è§£

## ä½œè€…ï¼šKelin (èµï¼š8)

## [é¢˜æ„](https://blog.csdn.net/benoble_/article/details/79794581)

ç»™ä½ ä¸€å¹…å›¾,æ¯æ¬¡ç»™ä½ ä¸€ä¸ªç‚¹$u$å’Œä¸€ä¸ªç‚¹é›†$S$

é—®ä»$u$å‡ºå‘èµ°å®Œ$S$é›†åˆ(å³$S$å†…ç‚¹éƒ½è‡³å°‘ç»è¿‡ä¸€æ¬¡)çš„æœŸæœ›æ­¥æ•°	

ä¸€ä¸ªç‚¹$u$ä¼šç­‰æ¦‚ç‡åœ°èµ°å‘å…¶ç›¸é‚»çš„ç‚¹

--- 

## é¢˜è§£

è¿™ç©æ„æ˜¯$PKUWC2018D2T3$éšæœºæ¸¸èµ°çš„åŠ å¼ºç‰ˆ

æ€è·¯å’Œ[[HNOI2013]æ¸¸èµ°](https://blog.csdn.net/benoble_/article/details/79755665)ç±»ä¼¼,ä¹Ÿæ˜¯é€šè¿‡é«˜æ–¯æ¶ˆå…ƒæ¥$DP$

è€ƒè™‘è®¾$f[S][i]$è¡¨ç¤ºèµ°å®Œ$S$é›†åˆ,å½“å‰åœ¨ç‚¹$i$,ç„¶åè¦æŠŠå‰©ä¸‹çš„æ‰€æœ‰ç‚¹éƒ½èµ°å®Œçš„æœŸæœ›æ­¥æ•°

å¯ä»¥å‘ç°,å¦‚æœè¯¢é—®çš„æ˜¯$u,S$é‚£ä¹ˆå¯¹åº”çš„$f$å€¼å°±æ˜¯$f[all-S][u]$

å°±æ˜¯ç›¸å½“äºæŠŠ$S$çš„è¡¥é›†éƒ½èµ°å®Œäº†,ç„¶åç°åœ¨å†ä»$u$æŠŠ$S$èµ°å®Œçš„æœŸæœ›

è¿™æ ·å¦‚æœé¢„å¤„ç†å‡º$f,$æ¯ä¸ªè¯¢é—®å°±å¯ä»¥$O(1)$å›ç­”äº†

>è¿™é‡Œæœ‰ä¸ªå°$trick$å°±æ˜¯å¦‚æœ$u\in S$è¿™æ ·å°±é”™äº†,å› ä¸º$u\notin all-S$

>æ‰€ä»¥å¯¹åº”è¦æ±‚çš„ç­”æ¡ˆåº”è¯¥æ˜¯$f[(all-S)|u][u]$

è€ƒè™‘æ€ä¹ˆæ±‚å‡º$f[S][u]$,åˆå€¼$f[all]=0$

>$flag:$æ‰€ä»¥è¿™ç©æ„æ€•ä¸æ˜¯è¦å€’æ¨

å’Œæ¸¸èµ°ä¸€æ ·åˆ—å¼,$d_u$è¡¨ç¤º$u$çš„ç‚¹åº¦

$$f[S][u]=\frac1{d_u}\sum_{u\to v\in E}f[S|v][v]+1$$

è€ƒè™‘æš´åŠ›çš„è¯å°±æ˜¯ç”¨é«˜æ–¯æ¶ˆå…ƒè§£è¿™$n2^n$ä¸ªæ–¹ç¨‹$,$å¤æ‚åº¦$O((n2^n)^3)$

è¿™æ ·æ˜¾ç„¶æ˜¯ä¸è¡Œçš„

è€ƒè™‘åˆ°è¦ä¹ˆ$S\subset S|v,$è¦ä¹ˆ$S=S|v,$å³$v\in S$

æˆ‘ä»¬æŠŠæ–¹ç¨‹åˆ†å¼€ä¸€ä¸‹

$$f[S][u]=\frac1{d_u}[\sum_{u\to v\in E,v\in S}f[S][v]+\sum_{u\to v\in E,v\notin S}f[S|v][v]]+1$$

$$f[S][u]-\frac1{d_u}\sum_{u\to v\in E,v\in S}f[S][v]=\frac1{d_u}\sum_{u\to v\in E,v\notin S}f[S|v][v]+1$$

ä¹Ÿå°±æ˜¯è¯´,å¦‚æœæˆ‘ä»¬çŸ¥é“$f[S|v]$çš„$DP$å€¼é‚£ä¹ˆæˆ‘ä»¬æ¯ä¸ªçŠ¶æ€å°±åªè¦åˆ—$n$ä¸ªæ–¹ç¨‹

æ‰€ä»¥æŒ‰ç…§é›†åˆå¤§å°å€’æ¨,ç„¶åæ¯ä¸ªçŠ¶æ€åˆ—$n$ä¸ªæ–¹ç¨‹å³å¯

å¤æ‚åº¦$O(n^32^n+\sum n_i)$

```
#include<bits/stdc++.h>
#define fp(i,a,b) for(register int i=a,I=b+1;i<I;++i)
#define fd(i,a,b) for(register int i=a,I=b-1;i>I;--i)
#define go(u) for(register int i=fi[u],v=e[i].to;i;v=e[i=e[i].nx].to)
#define file(s) freopen(s".in","r",stdin),freopen(s".out","w",stdout)
template<class T>inline bool cmax(T&a,const T&b){return a<b?a=b,1:0;}
template<class T>inline bool cmin(T&a,const T&b){return a>b?a=b,1:0;}
using namespace std;
char ss[1<<17],*A=ss,*B=ss;
inline char gc(){return A==B&&(B=(A=ss)+fread(ss,1,1<<17,stdin),A==B)?-1:*A++;}
template<class T>inline void sd(T&x){
    char c;T y=1;while(c=gc(),(c<48||57<c)&&c!=-1)if(c==45)y=-1;x=c-48;
    while(c=gc(),47<c&&c<58)x=x*10+c-48;x*=y;
}
char sr[1<<21],z[20];int C=-1,Z;
inline void Ot(){fwrite(sr,1,C+1,stdout),C=-1;}
template<class T>inline void we(T x){
    if(C>1<<20)Ot();if(x<0)sr[++C]=45,x=-x;
    while(z[++Z]=x%10+48,x/=10);
    while(sr[++C]=z[Z],--Z);sr[++C]='\n';
}
const int N=19,S=1<<N,P=998244353;
typedef int arr[N];
typedef long long ll;
int n,m,all,f[S][N];arr e,dg,id,pos,inv,ans,Mi,G[N];
inline int fpm(int a,int b){int x=1;for(;b;b>>=1,a=(ll)a*a%P)if(b&1)x=(ll)x*a%P;return x;}
inline int pls(int a,int b){return a+=b,a<P?a:a-P;}
inline int sub(int a,int b){return a-=b,a<0?a+P:a;}
inline void Gauss(int n){
    int mx,t,x;
    fp(i,1,n)fp(j,1,n)G[i][j]=pls(G[i][j],P);
    fp(i,1,n){mx=i;
        fp(j,i,n)if(G[mx][i]<G[j][i])mx=j;
        if(mx^i)fp(j,i,n+1)swap(G[mx][j],G[i][j]);
        x=fpm(G[i][i],P-2);
        fp(j,i+1,n){
            t=(ll)x*G[j][i]%P;
            fp(k,i,n+1)G[j][k]=sub(G[j][k],(ll)t*G[i][k]%P);
        }
    }
    fd(i,n,1){
        fp(j,i+1,n)G[i][n+1]=sub(G[i][n+1],(ll)ans[j]*G[i][j]%P);
        ans[i]=(ll)G[i][n+1]*fpm(G[i][i],P-2)%P;
    }
}
int main(){
    #ifndef ONLINE_JUDGE
        file("s");
    #endif
    sd(n),sd(m);all=(1<<n)-1;int u,v;
    Mi[1]=1;fp(i,2,n)Mi[i]=Mi[i-1]<<1;
    inv[1]=1;fp(i,2,n)inv[i]=(ll)(P-P/i)*inv[P%i]%P;
    while(m--)sd(u),sd(v),e[u]|=Mi[v],e[v]|=Mi[u],++dg[u],++dg[v];
    fd(s,all-1,1){
        int Cnt=0,x,p;
        fp(i,1,n)if(s&Mi[i])id[pos[i]=++Cnt]=i;
        fp(i,1,Cnt){fp(j,1,Cnt)G[i][j]=0;ans[i]=0;}
        fp(i,1,n)if(s&Mi[i]){
            x=inv[dg[i]],p=pos[i];G[p][p]=1,G[p][Cnt+1]=1;
            fp(j,1,n)if(e[i]&Mi[j]){
                if(s&Mi[j])G[p][pos[j]]-=x;
                else G[p][Cnt+1]=pls(G[p][Cnt+1],(ll)x*f[s|Mi[j]][j]%P);
            }
        }
        Gauss(Cnt);
        fp(i,1,Cnt)f[s][id[i]]=ans[i];
    }
    sd(m);
    while(m--){
        static int s;sd(s);u=0;
        while(s--)sd(v),u|=Mi[v];sd(v);
        we(f[(all^u)|Mi[v]][v]);
    }
return Ot(),0;
}
```

---

## ä½œè€…ï¼šlitble (èµï¼š6)

å¾ˆæœ‰æ„æ€çš„ä¸€é“é¢˜ç›®ã€‚

ç”¨f(x,S)è¡¨ç¤ºä»xå‡ºå‘ï¼Œå·²ç»èµ°è¿‡äº†ç‚¹é›†S,èµ°éå…¨å›¾çš„æœŸæœ›ã€‚

è¿™ä¸€ç±»æœŸæœ›é¢˜å¯ä»¥è€ƒè™‘é«˜æ–¯æ¶ˆå…ƒï¼Œæ„é€ æ–¹ç¨‹å¦‚ä¸‹ï¼š

$$ f(x,S) = \frac{1}{du(x)} (f(y,S) \times [ y \in S ]+ f(y,S \cup j ) \times [ y \not\in S ]; )$$

ç›´æ¥è¿›è¡Œé«˜æ–¯æ¶ˆå…ƒçš„è¯ï¼Œå¤æ‚åº¦è‚¯å®šå—ä¸äº†ï¼Œè€ƒè™‘ä¸€ä¸‹è¯¥æ–¹ç¨‹çš„ç‰¹æ®Šæ€§è´¨ã€‚

ç”±äºæ¯æ¬¡èµ°ä¸€ä¸ªæ–°çš„ç‚¹ï¼Œå·²ç»èµ°è¿‡çš„ç‚¹é›†åªå¯èƒ½æ‰©å¤§ä¸å¯èƒ½ç¼©å°ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™ä¸ªæ€§è´¨è¿›è¡Œåˆ†å±‚ï¼Œæ¯æ¬¡å¯¹äºä¸€ä¸ªSè¿›è¡Œé«˜æ–¯æ¶ˆå…ƒï¼Œæ±‚å‡ºä¸€äº›ä¿¡æ¯åï¼Œåˆ©ç”¨è¿™äº›ä¿¡æ¯ï¼Œç»§ç»­è¿›è¡Œä¸‹ä¸€å±‚çš„é«˜æ–¯æ¶ˆå…ƒã€‚è¿™æ ·æ¯æ¬¡é«˜æ–¯æ¶ˆå…ƒæ—¶ï¼Œå¤æ‚åº¦å¤§å¤§é™ä½ã€‚

å¤æ‚åº¦$O(n^32^n+Q)$

---

## ä½œè€…ï¼šMr_Avalon (èµï¼š4)

**é¢˜ç›®åˆ†æ**

è¿™æ˜¯ä¸€é“æ±‚æœŸæœ›çš„é¢˜ï¼Œç›´æ¥è€ƒè™‘ä» $x$ å‡ºå‘èµ°å®Œç‚¹é›† $S$ æœŸæœ›çš„æ­¥æ•°ä¼¼ä¹ä¸å¤ªå¥½è½¬ç§»ï¼ˆä¹Ÿå¯èƒ½æ˜¯æˆ‘å¤ªå¼±qwqï¼‰ã€‚

è€ƒè™‘é€†å‘è®¾è®¡çŠ¶æ€ã€‚è®¾ $f_{S,x}$ è¡¨ç¤º**å·²ç»éå†è¿‡äº† $S$ é›†åˆï¼Œå½“å‰åœ¨ç‚¹ $x$ æ—¶è¦éå†å®Œæ•´ä¸ªå›¾æœŸæœ›èµ°çš„æ­¥æ•°**ã€‚é‚£ä¹ˆå¯¹äºæ¯ä¸ªè¯¢é—®çš„ç‚¹é›†ï¼Œæˆ‘ä»¬è®¾å®ƒçš„è¡¥é›†ä¸º $A$ï¼Œ$f_{A|s,s}$ å°±æ˜¯æˆ‘ä»¬æ‰€æ±‚çš„ç­”æ¡ˆï¼Œå› ä¸ºæˆ‘ä»¬ä» $A$ é›†åˆåˆ°å…¨éƒ¨èµ°å®Œåˆšå¥½æŠŠè¯¢é—®çš„ç‚¹å…¨éƒ¨èµ°äº†ä¸€æ¬¡ã€‚

è¿™ä¸ªçŠ¶æ€çš„è½¬ç§»æ–¹ç¨‹è¿˜æ˜¯å¾ˆå¥½æƒ³çš„ï¼Œå¦‚æœå½“å‰åœ¨ç‚¹ $x$ï¼Œè€—è´¹ä¸€æ­¥èµ°åˆ° $v$ åå°±æ˜¯ä» $v$ å¼€å§‹èµ°å®Œæ•´ä¸ªå›¾çš„æœŸæœ›æ­¥æ•°äº†ï¼Œäºæ˜¯å¯ä»¥åˆ—å‡ºä¸‹åˆ—æ–¹ç¨‹ï¼š

$$
f_{S,x}=\frac{1}{deg_x}\times\sum\limits_{(u,v)\in G}f_{S|v,v}+1
$$

æˆ‘ä»¬å‘ç°ï¼ŒçŠ¶æ€çš„è½¬ç§»æˆç¯äº†ï¼Œè™½ç„¶é«˜æ–¯æ¶ˆå…ƒå¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä½†æ˜¯å¦‚æœç›´æ¥å¯¹**æ‰€æœ‰çŠ¶æ€**è¿›è¡Œé«˜æ–¯æ¶ˆå…ƒï¼Œå¤æ‚åº¦ $O((n\times2^n)^3)$ï¼Œæ˜æ˜¾ä¼š T é£ï¼Œéœ€è¦è€ƒè™‘ä¼˜åŒ–ã€‚

è¿›ä¸€æ­¥è§‚å¯Ÿè¿™ä¸ªå¼å­ï¼Œå¯ä»¥å‘ç° $S$ ä¸€å®šæ˜¯è¢«åŒ…å«åœ¨ $S|v$ é‡Œçš„ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸€ä¸ªçŠ¶æ€åªèƒ½ç”±ä¸€ä¸ªç‚¹é›†ä¸å°äºè¯¥çŠ¶æ€çš„çŠ¶æ€è½¬ç§»è€Œæ¥ï¼Œäºæ˜¯æˆ‘ä»¬å¯ä»¥è€ƒè™‘å¯¹çŠ¶æ€è¿›è¡Œåˆ†å±‚ï¼Œä»å¤§åˆ°å°åœ¨**æ¯ä¸ªç‚¹é›†å†…éƒ¨**åˆ†åˆ«è¿›è¡Œé«˜æ–¯æ¶ˆå…ƒï¼Œå¤æ‚åº¦ $O(2^n\times n^3)$ï¼Œå¯ä»¥é€šè¿‡æ­¤é¢˜ã€‚

**ä»£ç **

```cpp
#include<cstdio>
#include<iostream>

const int N=21,M=N*(N-1)*2,mod=998244353;

inline int read()
{
    int v=0;char ch=getchar();
    while('0'>ch||ch>'9') ch=getchar();
    while('0'<=ch&&ch<='9') v=v*10+(ch^48),ch=getchar();
    return v;
}

inline int get(int x) {return 1<<(x-1);}
inline int Add(int x,int y) {return x+=y-mod,x+=(x>>31)&mod,x;}
inline int Mul(int x,int y) {return 1ll*x*y%mod;}

inline int qp(int a,int k)
{
    int base=1;
    while(k)
    {
        if(k&1) base=Mul(base,a);
        a=Mul(a,a),k>>=1;
    }
    return base;
}

int n,m,q,all;

int cnt,deg[N],first[N],nxt[M<<1],to[M<<1];
inline void add(int u,int v)
{
    deg[u]++,deg[v]++;
    to[++cnt]=v,nxt[cnt]=first[u],first[u]=cnt;
    to[++cnt]=u,nxt[cnt]=first[v],first[v]=cnt;
}

int f[1<<N][N],mat[N][N];
int dfn[N],idf[N];

inline void gauss(int n,int S)
{
    for(int i=1;i<=n;i++)
    {
        int u=i;for(int j=i+1;j<=n;j++) u=mat[j][i]>mat[u][i]? j:u;
        for(int j=1;j<=n+1;j++) std::swap(mat[i][j],mat[u][j]);

        for(int j=1;j<=n;j++) if(i^j)
        {
            int t=Mul(mat[j][i],qp(mat[i][i],mod-2));
            for(int k=i+1;k<=n+1;k++) mat[j][k]=Add(mat[j][k],mod-Mul(t,mat[i][k]));
        }
    }

    for(int i=1;i<=n;i++) f[S][idf[i]]=Mul(mat[i][n+1],qp(mat[i][i],mod-2));
}

//è¿™ä¸ªdfsçš„ç›®çš„æ˜¯ä»å¤§åˆ°å°å¤„ç†å‡ºæ‰€æœ‰ç‚¹é›†
inline void dfs(int limit,int S=0,int level=1,int lst=0)
{
    if(level>limit)
    {
        for(int i=1;i<=limit;i++)
            for(int j=1;j<=limit+1;j++)
                mat[i][j]=0;

        int tot=0;for(int i=1;i<=n;i++)
        if(S&get(i)) dfn[i]=++tot,idf[tot]=i;

        for(int x=1;x<=limit;x++)
        {
            mat[x][x]=mat[x][limit+1]=mod-1;
            int mu=qp(deg[idf[x]],mod-2);

            for(int j=first[idf[x]];j;j=nxt[j])
            {
                int v=to[j];
                if(S&get(v)) mat[x][dfn[v]]=mu;//å¦‚æœvè¢«åŒ…å«åœ¨Sä¸­ï¼Œå°±è®¾ä¸ºæœªçŸ¥æ•°
                else mat[x][limit+1]=Add(mat[x][limit+1],mod-Mul(f[S|get(v)][v],mu));
                //å¦åˆ™ï¼ŒS|vè¿™ä¸ªç‚¹é›†æˆ‘ä»¬å·²ç»ç®—å¥½äº†ï¼Œç›´æ¥å˜æˆå¸¸æ•°æ‰”è¿‡å»
            }
        }

        return gauss(limit,S);
    }

    for(int i=lst+1;i<=n;i++) dfs(limit,S^get(i),level+1,i);
}

int main()
{
    n=read(),m=read(),all=get(n+1)-1;
    for(int i=1;i<=m;i++) add(read(),read());

    for(int level=n-1;level>0;level--) dfs(level);

    q=read();
    while(q--)
    {
        int k=read(),count=0;
        while(k--) count|=get(read());
        int s=read();printf("%d\n",f[all^count|get(s)][s]);
    }
}
```

---

## ä½œè€…ï¼šDiaĞ¾si (èµï¼š3)

## é¢˜ç›®é“¾æ¥ï¼š[ä¼ é€é—¨](https://www.luogu.com.cn/problem/P4321)

## æ€è·¯ï¼š

é¦–å…ˆå°†é—®é¢˜è½¬æ¢ï¼Œå¯¹äºæ¯ä¸€ä¸ªè¯¢é—®ï¼Œè®¾é›†åˆ $S_c\{c_1,c_2 \dots c_n\}$ è¡¨ç¤ºæ¯æ¬¡éœ€è¦å¯»æ‰¾çš„ç‚¹é›†ã€‚è®¾ $\text{Path}^\prime$ è¡¨ç¤ºä»èµ·ç‚¹å‡ºå‘ç»è¿‡è¯¥ç‚¹é›†æ‰€æœ‰ç‚¹çš„ä»»æ„ä¸€æ¡è·¯å¾„ï¼Œ$S$ è¡¨ç¤ºåœ¨è·¯å¾„ $\text{Path}^\prime$ä¸­ï¼Œ**åˆ°è¾¾ç‚¹é›† $S_c$ ä¸­æ‰€æœ‰ç‚¹çš„æ­¥æ•°çš„é›†åˆ**ã€‚æ˜¾ç„¶ï¼Œ $\max(S)$ å³æ˜¯åˆ°è¾¾ $\text{Path}^\prime$ ç»ˆç‚¹çš„æ­¥æ•°ï¼Œè€Œ $\min(T),T \subseteq S$ å³æ˜¯åœ¨è·¯å¾„ $\text{Path}^\prime$ ä¸­ç¬¬ä¸€æ¬¡åˆ°è¾¾ $S_c$ ä¸­çš„ç‚¹æ—¶çš„æ­¥æ•°ã€‚

æ ¹æ® $\min - \max$ å®¹æ–¥å®šç†ï¼Œæœ‰ï¼š

$$\max(S)=\sum_{T \subseteq S} (-1)^{|T|+1}\min(T)$$

è€Œ $\min - \max$ å®¹æ–¥å®šç†åœ¨æœŸæœ›æ„ä¹‰ä¸‹ä¹Ÿæˆç«‹ï¼Œç”±äº $\text{Path}^\prime$ æ˜¯ä¸ª**éšæœºå˜é‡**ä¸”å¯¹äºä»»æ„ä¸€ä¸ª $\text{Path}^\prime$ å¯¹åº”çš„ $S$ æ˜¯å”¯ä¸€çš„ï¼Œæ•…ä¸Šå¼åœ¨æœŸæœ›æ„ä¹‰ä¸‹ä¹Ÿæˆç«‹ï¼š

$$E(\max(S))=\sum_{T \subseteq S} (-1)^{|T|+1}E(\min(T))$$

æ˜¾ç„¶å¯¹äºä»»æ„ä¸€ä¸ª$\text{Path}^\prime$ï¼Œ$E(\max(S))$è¡¨ç¤ºç»è¿‡ $S_c$ ä¸­æ‰€æœ‰ç‚¹çš„æ­¥æ•°çš„æœŸæœ›ï¼Œ$E(\min(T))$ è¡¨ç¤ºåœ¨è·¯å¾„ $\text{Path}^\prime$ ä¸­ç¬¬ä¸€æ¬¡åˆ°è¾¾ $S_c$ ä¸­çš„ç‚¹æ—¶çš„æ­¥æ•°çš„æœŸæœ›ã€‚

å¯¹äºä¸€ä¸ªç»™å®šçš„ $S_c$ ï¼Œè€ƒè™‘è¿™æ ·çš„ dp ï¼š

$$E(x) =\sum_{(x,y)} \dfrac{E(y)}{deg_x}+1,x\notin S_c$$

 $E(x)$ è¡¨ç¤º $x$ ç¬¬ä¸€æ¬¡åˆ° $S_c$ ä¸­çš„ä»»æ„ä¸€ä¸ªèŠ‚ç‚¹çš„æœŸæœ›ï¼Œ $deg_x$ è¡¨ç¤ºèŠ‚ç‚¹ $x$ çš„åº¦æ•°ï¼Œåˆ™èµ·ç‚¹çš„æ‰€æ±‚å¾—çš„æœŸæœ›å³ä¸º $E(\min(T))$ ã€‚

è¯¥æ–¹ç¨‹å¯ä»¥ä½¿ç”¨**é«˜æ–¯æ¶ˆå…ƒ**æ¥æ±‚è§£ï¼Œé€šè¿‡ $\min - \max$ å®¹æ–¥å®šç†æ±‚å‡º $E(\max(S))$ ï¼Œè€Œå¯¹äºæšä¸¾ $T \subseteq S$ ç”±äºæˆ‘ä»¬åªå…³å¿ƒ $|T|$ ï¼Œæ‰€ä»¥æšä¸¾ $S_c$ å­é›†ä¸­ç‚¹çš„ä¸ªæ•°æ˜¯ç­‰ä»·äºæšä¸¾ $|T|$ çš„ã€‚

æ˜¾ç„¶æˆ‘ä»¬ä¸èƒ½å¯¹æ¯ä¸ªè¯¢é—®æšä¸¾ $S_c$ çš„å­é›†æ¥æ±‚è§£ï¼Œè¿™æ ·çš„æ—¶é—´å¤æ‚åº¦æ˜¯ $\mathcal{O(Mn^3 2^n )}$ çº§åˆ«çš„ã€‚

è€ƒè™‘æšä¸¾æ‰€æœ‰ç‚¹æ„æˆçš„ç‚¹é›†çš„å­é›†å¹¶ç”¨é«˜æ–¯æ¶ˆå…ƒç®—å‡ºæ‰€æœ‰çš„ $E(\min(T))$ ï¼Œç„¶åç”¨é«˜ç»´å‰ç¼€å’Œç»´æŠ¤ $\sum_{T \subseteq S} (-1)^{|T|+1}E(\min(T))$ ï¼Œé¢„å¤„ç†ä¹‹åå³å¯ $\mathcal{O(1)}$ æŸ¥è¯¢ $\sum_{T \subseteq S} (-1)^{|T|+1}E(\min(T))$ ã€‚

ç”±äºé«˜ç»´å‰ç¼€å’Œä¸æ˜¯æœ¬ç« è®¨è®ºçš„é‡ç‚¹ï¼Œæƒ³äº†è§£çš„å¯ä»¥çœ‹ï¼š[é«˜ç»´å‰ç¼€å’Œ by heyuhhh](https://www.cnblogs.com/heyuhhh/p/11585358.html)

å½“ç„¶ä¹Ÿå¯ä»¥ç”¨ä½è¿ç®—å·ç§¯æ¥æšä¸¾ $|T|$ ï¼Œä¸¢ä¸ªé“¾æ¥ï¼š[ä½è¿ç®—å·ç§¯ by command-block](https://www.luogu.com.cn/blog/command-block/wei-yun-suan-juan-ji-yu-ji-kuo-zhan)

## æ—¶é—´å¤æ‚åº¦åˆ†æ/ä¼˜åŒ–ï¼š

è€ƒè™‘ä»¥ä¸‹ä¸¤ä¸ªä¼˜åŒ–ï¼š

+ ç”±äºè¦è¿›è¡Œæœ‰ç†æ•°å–æ¨¡ï¼Œè‹¥åœ¨ dp å¤„ç†çŸ©é˜µç³»æ•°æ—¶è®¡ç®— $deg_x^{-1}$ ï¼Œæ—¶é—´å¤æ‚åº¦ä¼šè¾¾åˆ° $\mathcal{O(N^22^N+2^N((N+E)\log k+\dfrac{1}{3}N^3))}$ éš¾ä»¥é€šè¿‡ï¼Œè‹¥é¢„å¤„ç†æ‰€æœ‰çš„ $deg_x^{-1}$ ï¼Œæ—¶é—´å¤æ‚åº¦é™ä¸º $\mathcal{O(N^22^N+2^N((N+E)+\dfrac{1}{3}N^3))}$ ã€‚

+ è€ƒè™‘å¯¹é«˜æ–¯æ¶ˆå…ƒè¿›è¡Œä¼˜åŒ–ï¼Œè‹¥ä»»æ„ä¸€ç‚¹åœ¨è¢«æšä¸¾çš„ç‚¹çš„ç‚¹é›†å†…ï¼Œæ˜¾ç„¶è¯¥ç‚¹çš„æœŸæœ›ä¸º $0$ ï¼Œæ¶ˆå…ƒæ—¶ç›´æ¥è·³è¿‡ï¼Œåˆ™æšä¸¾ç‚¹é›†å¹¶è¿›è¡Œé«˜æ–¯æ¶ˆå…ƒçš„å¤æ‚åº¦ä¸ºï¼š
$$\sum_{k=0}^N \binom{N}{N-k}(N-k)^3 \approx 2^{N-3}N^3$$ 

ç»è¿‡ä¼˜åŒ–åï¼Œæ€»çš„æ—¶é—´å¤æ‚åº¦çº¦ä¸ºï¼š

$$\mathcal{O(N^22^N+ 2^{N-3}N^3)}$$

å¯¹äºå››ç§’çš„æ—¶é™å·²ç»è¶³å¤Ÿã€‚

## ä»£ ç  æ”¾ é€ï¼š

æ—¢ç„¶ä½ èƒ½æ‰¾åˆ°è¿™é¢˜ï¼Œæˆ‘ç›¸ä¿¡ä½ èƒ½ç¬é—´åšå‡ºæ¥çš„ã€‚

$Code:$

```cpp
#include<bits/stdc++.h>
using namespace std;
const long long N=20,M=1010,lpw=998244353;
long long head[N],ver[M],Next[M],tot;
long long a[N][N],deg[N],f[N],s[1<<N][N],fac[1<<N];
inline long long read(){
    char c=getchar();long long x=0,f=1;
    while(c<'0'||c>'9'){if(c=='-')f=-1;c=getchar();}
    while(c>='0'&&c<='9'){x=x*10+c-'0';c=getchar();}
    return x*f;
}
inline long long Qpow(long long x,long long k){
	long long res=1;
	while(k){
		if(k&1)res=(res*x)%lpw;
		k>>=1;x=(x*x)%lpw;
	}
	return res;
}
inline long long inv(long long a){
	return Qpow(a,lpw-2)%lpw;
}
inline void add(long long x,long long y){
	ver[++tot]=y,Next[tot]=head[x],head[x]=tot;
}
inline void gauss(long long n,long long m,long long S){
	for(register long long i=1;i<=n;++i){
		bool ins=(S>>(i-1)&1);
		if(ins)
			for(register long long k=1;k<=n;++k)
				if(k!=i)a[k][i]=0;
	}
	for(register long long i=1,j=1;i<=n&&j<=m;++j){
		long long i1=i;
		bool ins=(S>>(i-1)&1);
		if(ins){i++;continue;}
		while(!a[i1][j]&&i1<=n)i1++;
		if(a[i1][j]==0)continue;
		swap(a[i1],a[i]);
		for(register long long k=m+1;k>=j;--k)a[i][k]=(a[i][k]%lpw*inv(a[i][j])%lpw)%lpw;
		for(register long long k=i+1;k<=n;++k)
			if(a[k][j]!=0)
				for(register long long e=m+1;e>=j;--e)a[k][e]=(a[k][e]-a[i][e]*a[k][j]%lpw+lpw)%lpw;
		i++;
	}
	for(register long long i=n;i>=1;--i)
		for(register long long j=i-1;j>=1;--j){
			a[j][m+1]=(a[j][m+1]-a[j][i]*a[i][m+1]%lpw+lpw)%lpw;
			a[j][i]=(a[j][i]-a[j][i]*a[i][i]%lpw+lpw)%lpw;
		}
	for(register long long i=1;i<=n;++i)
		f[i]=a[i][m+1]%lpw;
}
long long n,m,Q;
inline void pre(long long S){
	for(register long long x=1;x<=n;++x){
		bool ins=(S>>(x-1)&1);
		if(ins){a[x][x]=1;continue;}
		a[x][x]=(-1+lpw)%lpw;
		for(register long long i=head[x];i;i=Next[i]){
			long long y=ver[i];
			a[x][y]=deg[x]%lpw;
		}
		a[x][n+1]=(-1+lpw)%lpw;
	}
}
int main(){
	n=read();m=read();
	for(register long long i=1;i<=m;++i){
		long long x,y;
		x=read();y=read();
		add(x,y),add(y,x);
		++deg[x],++deg[y];
	}
	for(register long long i=1;i<=n;++i)
		deg[i]=inv(deg[i]);
	fac[0]=-1;
	for(register long long i=1;i<1<<n;++i){
		memset(a,0,sizeof(a));
		fac[i]=fac[i>>1]*((i&1)?-1:1);
		pre(i);
		gauss(n,n,i);
		for(register long long k=1;k<=n;++k)
			s[i][k]=(f[k]*fac[i]%lpw+lpw)%lpw;
	}
	for(register long long k=1;k<=n;++k)
		for(register long long i=0;i<n;++i)
			for(register long long j=1;j<1<<n;++j)
				if(j>>i&1)s[j][k]=(s[j][k]+s[j^(1<<i)][k]);
	Q=read();
	while(Q--){
		long long ques,st,S=0;
		ques=read();
		for(register long long i=1;i<=ques;++i)
			S|=(1<<(read()-1));
		st=read();
		printf("%lld\n",s[S][st]%lpw);
	}
	return 0;
}
```

---

## ä½œè€…ï¼šLEWISAK (èµï¼š1)

[ä¼ é€é—¨](https://www.luogu.com.cn/problem/P4321)

# é¢˜æ„æ¦‚è¦

ç»™ä½ ä¸€ä¸ªæ— å‘å›¾ï¼Œæ±‚éšæœºæ¸¸èµ°å°† $n$ ä¸ªç»ˆç‚¹å…¨éƒ¨èµ°ä¸€éçš„æœŸæœ›æ­¥æ•°ã€‚

# é¢˜è§£

é¦–å…ˆå›¾ä¸Šéšæœºæ¸¸èµ°è‚¯å®šæ˜¯è¦é«˜æ¶ˆçš„ï¼Œä½†åªæƒ³åˆ°è¿™ä¸€ç‚¹å¯¹æ€è·¯æé†’ä¸å¤§ã€‚

æ³¨æ„åˆ°ç‚¹æ•° $\le18$ å®¹æ˜“æƒ³åˆ°çŠ¶å‹ dpï¼Œ$dp_{i,j}$ è¡¨ç¤ºå·²èµ°çš„ç‚¹é›†ä¸º $i$ ï¼Œå°†å‰©ä½™çš„ç‚¹ä» $j$ å‡ºå‘éƒ½èµ°ä¸€éçš„æœŸæœ›æ­¥æ•°ï¼Œæœ€åä»èµ·ç‚¹å¼€å§‹é™¤äº†ç»ˆç‚¹å…¨éƒ½èµ°è¿‡çš„æœŸæœ›æ­¥æ•°å°±æ˜¯ç­”æ¡ˆã€‚

æ˜“å¾—è½¬ç§»ï¼ˆå…¶ä¸­ $in_i$ è¡¨ç¤º $i$ çš„å…¥åº¦ï¼Œ$d$ ä¸ºä¸ $u$ ç›¸è¿çš„ç‚¹çš„é›†åˆï¼‰ï¼š

$$
dp_{i,j}=\frac{1}{in_i}\sum_{v\in d}{dp_{i\cup v}+1}
$$

æ³¨æ„åˆ°è¿™ä¹ˆææšä¸¾çŠ¶æ€æœ‰ $n2^n$ ç§ï¼ŒåŠ ä¸Šé«˜æ–¯æ¶ˆå…ƒæ±‚è§£ç›´æ¥å°±æ­»äº†ğŸ¤¯ã€‚

äºæ˜¯æ³¨æ„åˆ° $i\cup v$ ç»å¯¹åŒ…å« $i$ï¼Œé‚è€ƒè™‘å°†çŠ¶æ€åˆ†å±‚ï¼Œæšä¸¾ç‚¹é›†ååªå¯¹å½“å‰çš„ç‚¹é›†é«˜æ¶ˆï¼Œå¤æ‚åº¦ä¼˜åŒ–è‡³ $O(2^nn^3)$ï¼Œå¯ä»¥é€šè¿‡ã€‚

# ä»£ç 

è¿˜æœ‰ç»†èŠ‚ä¸æ‡‚å¯ä»¥çœ‹æ³¨é‡Šã€‚

```cpp
#include <bits/stdc++.h>
#define int long long
using namespace std;
const int mod=998244353;
int n,m,q,all/*å…¨é›†*/,tot,in[30]/*å…¥åº¦*/,head[30],dp[1110101][30],a[30][30]ï¼›
int dfn[30],p[30];//dfsåº
struct jiegoutiming{//é“¾å¼å‰å‘æ˜Ÿ 
	int nxt,to;
}e[888];
void add(int u,int v){
	in[v]++;
	e[++tot].to=v;
	e[tot].nxt=head[u];
	head[u]=tot;
	return;
}

int qpow(int x,int y){//å¿«é€Ÿå¹‚ 
	int aaa=1;
	while(y){
		if(y&1){
			aaa=aaa*x%mod;
		}
		x=x*x%mod;
		y>>=1;
	}
	return aaa;
}
void gaosi(int n,int S){
	for(int i=1;i<=n;i++){//é«˜æ¶ˆæ¿å­ 
		int u=i;
		for(int j=i+1;j<=n;j++){
			u=a[j][i]>a[u][i]?j:u;
		}
		for(int j=1;j<=n+1;j++){
			swap(a[i][j],a[u][j]);
		}
		for(int j=1;j<=n;j++){
			if(i^j){
				int t=a[j][i]*qpow(a[i][i],mod-2)%mod;
				for(int k=i+1;k<=n+1;k++){
					a[j][k]=((a[j][k]+mod-t*a[i][k]%mod)%mod+mod)%mod;
				}
			}
		}
	}
	for(int i=1;i<=n;i++){//æ›´æ–°ç­”æ¡ˆ 
		dp[S][p[i]]=a[i][n+1]*qpow(a[i][i],mod-2)%mod;
	}
}
void dfs(int nn,int S,int dep,int lst){
	if(dep>nn){
		for(int i=1;i<=nn;i++){
			for(int j=1;j<=nn+1;j++){
				a[i][j]=0;
			}
		}
		int tot=0;
		for(int i=1;i<=n;i++){
			if(S&(1<<(i-1))){
				dfn[i]=++tot;
				p[tot]=i;
			}
		}
		for(int i=1;i<=nn;i++){//å¤„ç†æ–¹ç¨‹ 
			a[i][i]=a[i][nn+1]=mod-1;
			int ni=qpow(in[p[i]],mod-2);
			for(int j=head[p[i]];j;j=e[j].nxt){
				int v=e[j].to;
				if(S&(1<<(v-1))){
					a[i][dfn[v]]=ni;
				}
				else{
					a[i][nn+1]=((a[i][nn+1]+mod-dp[S|(1<<(v-1))][v]*ni%mod)%mod+mod)%mod;
				}
			}
		}
		return gaosi(nn,S);
	}
	for(int i=lst+1;i<=n;i++){
		dfs(nn,S^(1<<(i-1)),dep+1,i);
	}
}
signed main(){
	cin>>n>>m;
	all=(1<<n)-1;
	for(int i=1;i<=m;i++){
		int u,v;
		cin>>u>>v;
		add(u,v);
		add(v,u);
	}
	cin>>q;
	for(int i=n-1;i>0;i--){
		dfs(i,0,1,0);
	}
	while(q--){
		int x,S=0,y,z;
		cin>>x;
		for(int i=1;i<=x;i++){
			cin>>y;
			S|=(1<<(y-1));
		}
		cin>>z;
		cout<<dp[(all^S)|(1<<(z-1))][z]<<endl;//å¦‚æœèµ·ç‚¹æ˜¯ç»ˆç‚¹ä¹‹ä¸€è¦ç›´æ¥æ’é™¤ï¼Œå¦åˆ™ä¸åˆæ³• 
	}
	return 0;
}
```

---

## ä½œè€…ï¼šLaoshan_PLUS (èµï¼š1)

# [P4321 éšæœºæ¼«æ¸¸](https://www.luogu.com.cn/problem/P4321)

$n\le18$ çš„æ•°æ®èŒƒå›´æ˜¾ç„¶ä¸æ˜¯ç™½ç»™çš„ï¼Œè€ƒè™‘è®¾è®¡çŠ¶æ€ä¸­åŒ…å«ä¸€ä¸ªäºŒè¿›åˆ¶æ•° $S$ è¡¨ç¤ºèµ°è¿‡äº†å“ªäº›å…³é”®ç‚¹ã€‚çŠ¶æ€è®¾è®¡å°±æ˜¯ $f_{S,u}$ï¼Œè¡¨ç¤ºå·²ç»èµ°è¿‡äº†ç‚¹é›†ä¸º $S$ çš„ç‚¹ï¼Œç°åœ¨åœ¨ $u$ï¼Œèµ°åˆ° $n$ çš„æœŸæœ›æ­¥æ•°ã€‚

æœŸæœ› DP é€†æ¨ï¼Œäºæ˜¯æœ‰ï¼š
$$
f_{S,u}=\frac1{\deg(u)}\Bigg(\sum_{(v,u)\in E}f_{S\cup v,v}\Bigg)+1
$$
è¿™æ˜¾ç„¶æ˜¯æœ‰åæ•ˆæ€§çš„ï¼Œè€ƒè™‘é«˜æ–¯æ¶ˆå…ƒã€‚ä½†æ˜¯ $2^nn$ ä¸ªçŠ¶æ€è®©é«˜æ–¯æ¶ˆå…ƒç›´æ¥ä¼¼äº†ã€‚å‘ç°æˆ‘ä»¬çš„è½¬ç§»æ€»æ˜¯ç”± $S$ è¾ƒå¤§çš„ç‚¹è½¬ç§»åˆ° $S$ è¾ƒå°çš„ç‚¹ï¼Œè¿™è®©æˆ‘ä»¬æƒ³åˆ°ä»å¤§åˆ°å°æšä¸¾ $S$ï¼Œç”±äºæ¯”å½“å‰çš„ $S$ å¤§çš„ $S$ æˆ‘ä»¬éƒ½å·²ç»ç®—è¿‡äº†ï¼Œæ‰€ä»¥å¯¹äºæ¯ä¸€ä¸ª $S$ éƒ½æ„é€ å‡ºå•ç‹¬çš„ä¸€ä¸ªçº¿æ€§æ–¹ç¨‹ç»„ï¼Œè€Œè¿™ä¸ªæ–¹ç¨‹ç»„çš„æ¬¡æ•°æ˜¯ $n$ï¼Œ$O(n^3)$ çš„é«˜æ–¯æ¶ˆå…ƒå¯ä»¥æ‰¿å—ã€‚ç„¶åç®—å‡ºæ¥çš„å€¼å†ä¿å­˜ä¸‹æ¥å³å¯ã€‚

è¿™æ ·å¤æ‚åº¦å°±ä¼˜åŒ–åˆ°äº† $O(2^nn^3)$ã€‚

è‡³äºè¯¢é—®ï¼Œç”±äºæˆ‘ä»¬å·²ç»ç®—å‡ºäº†æ¯ä¸€ä¸ªçŠ¶æ€çš„ç­”æ¡ˆï¼Œé‚£ä¹ˆå¯¹äºè¯¢é—®é›†åˆ $T$Â å’Œèµ·ç‚¹ $x$ï¼Œæˆ‘ä»¬åªéœ€è¾“å‡º $f_{(\complement T)\cup x,x}$Â å³å¯ï¼Œå…¶ä¸­ $\complement T$Â æ˜¯ $T$Â å…³äºå…¨é›†çš„è¡¥é›†ã€‚è¿™æ ·å›ç­”è¯¢é—®å°±æ˜¯ $O(1)$Â çš„ã€‚

```cpp
#include<bits/stdc++.h>
#define fw fwrite(obuf,p3-obuf,1,stdout)
#define getchar() (p1==p2&&(p2=(p1=buf)+fread(buf,1,1<<20,stdin),p1==p2)?EOF:*p1++)
#define putchar(x) (p3-obuf<1<<20?(*p3++=(x)):(fw,p3=obuf,*p3++=(x)))
#define inv(x) power(x,MOD-2)
using namespace std;

char buf[1<<20],obuf[1<<20],*p1=buf,*p2=buf,*p3=obuf,str[20<<2];
int read(){
	int x=0;
	char ch=getchar();
	while(!isdigit(ch))ch=getchar();
	while(isdigit(ch))x=(x<<3)+(x<<1)+(ch^48),ch=getchar();
	return x;
}
template<typename T>
void write(T x,char sf='\n'){
	if(x<0)putchar('-'),x=~x+1;
	int top=0;
	do str[top++]=x%10,x/=10;while(x);
	while(top)putchar(str[--top]+48);
	if(sf^'#')putchar(sf);
}
using ll=long long;
constexpr int MAXN=20,MAXM=405;
constexpr ll MOD=998244353;
int n,m,q,deg[MAXN];
vector<int>g[MAXN];
ll a[MAXN][MAXN],f[1<<18][MAXN];

ll power(ll a,ll b){
	ll res=1;
	for(;b;a=a*a%MOD,b>>=1)if(b&1)res=res*a%MOD;
	return res;
}
void add(ll&x,ll y){
	x=(x+y>=MOD?x+y-MOD:x+y);
}
void sub(ll&x,ll y){
	x=(x-y<0?x-y+MOD:x-y);
}
void gauss_jordan(){
	for(int i=1;i<=n;i++){
		for(int k=i;k<=n;k++)
			if(a[k][i]){
				swap(a[i],a[k]);
				break;
			}
		for(int k=1;k<=n;k++){
			if(!a[k][i]||k==i) continue;
			ll t=a[k][i]*inv(a[i][i])%MOD;
			for(int j=i;j<=n+1;j++)
				sub(a[k][j],t*a[i][j]%MOD);
		}
	}
	for(int i=1;i<=n;i++) a[i][n+1]=a[i][n+1]*inv(a[i][i])%MOD;
}

int main(){
	n=read(),m=read();
	for(int i=1,u,v;i<=m;i++){
		u=read(),v=read();
		g[u].emplace_back(v);
		g[v].emplace_back(u);
		deg[u]++,deg[v]++;
	}
	int B=(1<<n)-1;
	for(int s=B-1;s;s--){
		memset(a,0,sizeof(a));
		for(int i=1;i<=n;i++){
			if(!(s&1<<(i-1))) continue;
			a[i][i]=1,a[i][n+1]=1;
			ll fk=inv(deg[i]);
			for(auto v:g[i])
				if(s&1<<(v-1)) a[i][v]=MOD-fk;
				else add(a[i][n+1],fk*f[s|1<<(v-1)][v]%MOD);
		}
		gauss_jordan();
		for(int i=1;i<=n;i++)
			if(s&1<<(i-1))
				f[s][i]=a[i][n+1]; 
	}
	q=read();
	while(q--){
		int k=read(),s=0;
		for(int i=1;i<=k;i++) s|=1<<(read()-1);
		int x=read();
		write(f[(B^s)|1<<(x-1)][x]);
	}
	return fw,0;
}
```

---

## ä½œè€…ï¼šReunite (èµï¼š1)

è®¾ $f_{S,u}$ è¡¨ç¤ºå·²ç»éå†å®Œ $S$ é›†åˆçš„ç‚¹ï¼Œç›®å‰åœ¨ç‚¹ $u$ï¼Œè¦èµ°å®Œå…¨é›†çš„æœŸæœ›æ­¥æ•°ï¼Œè½¬ç§»æ˜¾ç„¶ä¸ºï¼š

$$f_{S,u}=1+\frac{1}{d_u}\sum_{u\rightarrow v}f_{S|v,v}$$

ç›´æ¥é«˜æ¶ˆæ˜¯ $(n2^n)^3$ çš„ï¼Œæ³¨æ„åˆ°æˆç¯çš„åœ°æ–¹åªæœ‰åœ¨åŒç‚¹é›†å†…éƒ¨ï¼Œå¦åˆ™æ˜¯å½¢å¦‚ DAG çš„è½¬ç§»ï¼Œé‚£å°±åˆ†å±‚é«˜æ¶ˆï¼Œç›´æ¥ç®—å‡ºåé¢å·²ç»ç¡®å®šçš„å€¼ï¼Œå¯¹äºåŒä¸€ä¸ªç‚¹é›†å†…çš„ç‚¹é«˜æ¶ˆå³å¯ï¼Œå¤æ‚åº¦ä¸º $O(n^32^n)$ã€‚

å¯¹äºè¯¢é—®ï¼Œè®°å…³é”®ç‚¹é›†ä¸º $S'$ï¼Œè€ƒè™‘ä»»æ„ä¸€ç§æ¸¸èµ°åºåˆ—ï¼Œæˆ‘ä»¬æ€»å¯ä»¥é€šè¿‡è°ƒæ•´ï¼ŒæŠŠç»“æŸç‚¹æ”¾åœ¨æœ€åä¸€ä¸ªå…³é”®ç‚¹ï¼Œå…¶ä»–éå…³é”®ç‚¹æ€ä¹ˆèµ°éƒ½æ˜¯æ— æ‰€è°“çš„ï¼Œæ‰€ä»¥ç­”æ¡ˆå°±æ˜¯ $f_{U-S',v}$ï¼Œä¹Ÿå°±æ˜¯åœ¨ç‚¹ $v$ æœŸæœ›æŠŠ $S'$ èµ°å®Œçš„æ­¥æ•°ï¼Œæœ€åæ³¨æ„åˆ° $v$ åœ¨ $S$ ä¸­ä¼šå†²çªï¼Œç‰¹æ®ŠåŒ…å«ä¸€ä¸‹å°±å¥½ã€‚å¤æ‚åº¦ $O(n^32^n+\sum q_i)$ã€‚

```cpp
#include <cstdio>
#include <cstring>
#include <algorithm>
#include <vector>
#define int long long
#define mod 998244353
using namespace std;

int n,m,q,cnt;
int b[20];
int d[20];
int a[20][20];
int f[300000][20];
vector <int> g[20];

inline void in(int &n){
	n=0;
	char c=getchar();
	while(c<'0' || c>'9') c=getchar();
	while(c>='0'&&c<='9') n=n*10+c-'0',c=getchar();
	return ;
}

inline int calc(int x,int k){
	int tmp=1;
	while(k){
		if(k&1) tmp=tmp*x%mod;
		x=x*x%mod;
		k>>=1;
	}
	return tmp;
}

inline int inv(int x){return calc(x,mod-2);}

inline void Gauss(int n){
	for(int i=1;i<=n;i++){
		if(!a[i][i]){
			for(int j=i+1;j<=n+1;j++)
				if(a[j][i]){swap(a[i],a[j]);break;}
		}
		for(int j=i+1;j<=n;j++){
			int x=a[j][i]*inv(a[i][i])%mod;
			for(int k=i;k<=n+1;k++)
				(a[j][k]+=mod-a[i][k]*x%mod)%=mod;
		}
	}
	for(int i=n;i>=1;i--){
		int x=calc(a[i][i],mod-2);
		for(int j=i;j<=n+1;j++) a[i][j]=a[i][j]*x%mod;
		for(int j=i-1;j>=1;j--){
			int x=a[j][i];
			for(int k=i;k<=n+1;k++)
				(a[j][k]+=mod-a[i][k]*x%mod)%=mod;
		}
	}
	return ;
}

signed main(){
	in(n),in(m);
	for(int i=1;i<=m;i++){
		int u,v;
		in(u),in(v);
		g[u].emplace_back(v);
		g[v].emplace_back(u);
		d[u]++,d[v]++;
	}
	for(int s=(1<<n)-2;s>=0;s--){
		memset(a,0,sizeof(a));
		memset(b,0,sizeof(b));
		cnt=0;
		for(int u=1;u<=n;u++) if(s&(1<<(u-1))) b[u]=++cnt;
		for(int u=1;u<=n;u++){
			if(!b[u]) continue;
			a[b[u]][b[u]]=a[b[u]][cnt+1]=d[u];
			for(int v:g[u]){
				if(b[v]) a[b[u]][b[v]]--;
				else (a[b[u]][cnt+1]+=f[s|(1<<(v-1))][v])%=mod;
			}
		}
		Gauss(cnt);
		for(int u=1;u<=n;u++) if(b[u]) f[s][u]=a[b[u]][cnt+1];
	}
	in(q);
	while(q--){
		in(m);
		int S=(1<<n)-1,x=0;
		while(m--) in(x),S^=(1<<(x-1));
		in(x);
		printf("%lld\n",f[S|(1<<(x-1))][x]);
	}

	return 0;
}
```

---

## ä½œè€…ï¼šDengDuck (èµï¼š1)

æ¥ä¸€ä»½ 1.3K çš„ä¸å‹è¡Œå®ç°ã€‚

é¦–å…ˆè¿™é¢˜æˆ‘ä»¬å‘ç° $n$ å¾ˆå°ï¼Œå®¹æ˜“æƒ³åˆ°çŠ¶å‹ï¼Œç›´æ¥çŠ¶å‹å’Œ Min-Max å®¹æ–¥ä¹‹åæ±‚ Min çš„é‚£ä¸ªçŠ¶å‹éš¾åº¦å·®ä¸å¤šï¼Œæ‰€ä»¥æˆ‘ä»¬å°±ä¸è€ƒè™‘ Min-Max å®¹æ–¥äº†ã€‚

æˆ‘ä»¬è®¾ $F_{S,u}$ è¡¨ç¤ºä»¥åŠå»è¿‡çš„ç‚¹é›†åˆæ˜¯ $S$ï¼Œå½“å‰åœ¨ç‚¹ $u$ï¼Œèµ°å®Œçš„æœŸæœ›æ­¥æ•°ï¼Œæ˜“å¾—è½¬ç§»ï¼š

$$
F_{S,u}=\dfrac 1 {d_u}\sum_{u\to v}F_{S|v,v}+1
$$

è¿™ç©æ„æ˜¾ç„¶æ²¡æœ‰åæ•ˆæ€§ï¼Œéœ€è¦å€ŸåŠ©é«˜æ–¯æ¶ˆå…ƒï¼Œä¸è¿‡ç›´æ¥è·‘æ˜¾ç„¶ä¼šå¯„ï¼Œæ³¨æ„åˆ° $S$ åªä¼šå˜å¤§ï¼Œæ‰€ä»¥æˆ‘ä»¬ä»å¤§åˆ°å°æšä¸¾ $S$ï¼Œç„¶ååœ¨å†…éƒ¨è·‘é«˜æ–¯æ¶ˆå…ƒå³å¯ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º $\mathcal O(n^32^n)$ã€‚

å¥½åƒè·‘å¾—æœ‰ç‚¹æ…¢ï¼Œä½†æ˜¯ä¸å¤ªæ‡‚ä¸ºä»€ä¹ˆã€‚

```cpp
#include<bits/stdc++.h>
#define pb push_back
#define LL long long
using namespace std;
const int N=21;
const LL Mod=998244353;
inline LL Ksm(LL x,LL y)
{
	LL A=1;
	while(y)
	{
		if(y&1)A=A*x%Mod;
		x=x*x%Mod,y>>=1;
	}
	return A;
}
int n,m,TOT,D[N];
LL F[1<<N][N],A[N][N];
vector<int>E[N];
inline void Gauss()
{
	for(int i=1;i<=n;i++)
	{
		for(int j=i;j<=n;j++)if(A[j][i])swap(A[i],A[j]);
		if(A[i][i])
		for(int j=1;j<=n;j++)
		{
			if(!A[j][i]||j==i)continue;
			LL t=A[j][i]*Ksm(A[i][i],Mod-2)%Mod;
			for(int k=1;k<=n+1;k++)(A[j][k]+=Mod-t*A[i][k]%Mod)%=Mod;	
		}
	}
	for(int i=1;i<=n;i++)
	{
		if(!A[i][i])continue;
		LL I=Ksm(A[i][i],Mod-2);
		(A[i][i]*=I)%=Mod,(A[i][n+1]*=I)%=Mod;
	}
}
int main()
{
	scanf("%d%d",&n,&m);TOT=(1<<n)-1;
	for(int i=1,x,y;i<=m;i++)
	{
		scanf("%d%d",&x,&y);
		E[x].pb(y),E[y].pb(x);
		D[x]++,D[y]++;
	}
	for(int S=TOT-1;S;S--)
	{
		memset(A,0,sizeof(A));
		for(int u=1;u<=n;u++)
		{
			if(!((S>>u-1)&1))continue;
			A[u][u]=1,A[u][n+1]=1;
			LL I=Ksm(D[u],Mod-2);
			for(int v:E[u])
			{
				if((S>>v-1)&1)A[u][v]=Mod-I;
				else (A[u][n+1]+=I*F[S|(1<<v-1)][v])%=Mod;
			}
		}
		Gauss();
		for(int i=1;i<=n;i++)
		{
			if(!((S>>i-1)&1))continue;
			F[S][i]=A[i][n+1];
		}
	}
	int T;scanf("%d",&T);
	while(T--)
	{
		int L,x,S=0;scanf("%d",&L);
		while(L--)
		{
			scanf("%d",&x);
			S|=(1<<x-1);
		}
		scanf("%d",&x);
		printf("%lld\n",F[TOT^S|(1<<x-1)][x]);
	}
}
```

---

## ä½œè€…ï¼šzhangxy__hp (èµï¼š0)

çœ‹åˆ° $n\le 18$ï¼ŒåŸºæœ¬ä¸Šæ˜¯è¦åšçŠ¶å‹çš„ã€‚è€ƒè™‘è¿›è¡Œé¢„å¤„ç†ï¼Œç„¶ååœ¨è¾ƒå°çš„å¤æ‚åº¦å†…å›ç­”è¯¢é—®ã€‚è®¾ $f_{S,u}$ è¡¨ç¤ºå½“å‰èµ°å®Œäº† $S$ ä¸­çš„ç‚¹ï¼Œç°åœ¨åœ¨ $u$ ç‚¹ï¼ˆ$u\in S$ï¼‰ï¼Œèµ°å®Œå‰©ä¸‹çš„ç‚¹çš„æœŸæœ›æ­¥æ•°ã€‚äºæ˜¯æœ‰æ–¹ç¨‹ï¼š

$$
f_{S,u}=1+\frac{1}{d_u}\sum f_{S\cup\{v\},v}
$$

å…¶ä¸­ $(u,v)$ æ˜¯ä¸€æ¡è¾¹ï¼Œ$d_u$ è¡¨ç¤º $u$ çš„åº¦æ•°ã€‚

è€ƒè™‘ $S$ ä¸ $S\cup\{v\}$ çš„å…³ç³»ï¼Œæ˜¾ç„¶åªæœ‰ä¸¤ç§æƒ…å†µï¼Œåˆ†åˆ«æ˜¯ $S=S\cup\{v\}$ å’Œ $S\subsetneqq S\cup\{v\}$ã€‚äºæ˜¯å°±å¯ä»¥å€’ç€æ‰« $S$ï¼Œå¯¹äºæ¯ä¸ª $S$ åšé«˜æ–¯æ¶ˆå…ƒäº†ã€‚

è€ƒè™‘è¾“å‡ºç­”æ¡ˆï¼Œé¢˜ç›®çš„è¦æ±‚å…¶å®å°±æ˜¯è¦å°† $c$ ä¸­çš„ç‚¹å…¨éƒ¨èµ°å®Œã€‚è®¾ $c$ ä¸­çš„ç‚¹æ„æˆçš„é›†åˆä¸º $S$ï¼Œèµ·ç‚¹ä¸º $u$ï¼Œé‚£ä¹ˆç­”æ¡ˆå³ä¸º $f_{(\complement S)\cup\{u\},u}$ã€‚æ€»æ—¶é—´å¤æ‚åº¦ä¸º $O(2^nn^3+m)$ã€‚

```cpp
#include<bits/stdc++.h>
#define ll long long
#define il inline
#define pb push_back
using namespace std;
namespace asbt{
namespace cplx{bool begin;}
const int mod=998244353;
int n,m,q,a[25][25];
int f[(1<<18)+5][25];
vector<int> e[25];
il int qpow(int x,int y){
//	cout<<x<<" "<<y<<"\n";
	int res=1;
	while(y){
		if(y&1){
			res=res*1ll*x%mod;
		}
		y>>=1,x=x*1ll*x%mod;
	}
	return res;
}
namespace cplx{
	bool end;
	il double usdmem(){return (&begin-&end)/1048576.0;}
}
int main(){
//	ios::sync_with_stdio(0),cin.tie(0);
	cin>>n>>m;
	for(int i=1,u,v;i<=m;i++){
		cin>>u>>v;
		e[u].pb(v),e[v].pb(u);
	}
	int uS=(1<<n)-1;
	for(int S=uS-1;S;S--){
		for(int i=1;i<=n;i++){
			for(int j=1;j<=n+1;j++){
				a[i][j]=0;
			}
		}
		for(int u=1,tmp;u<=n;u++){
			if(S>>(u-1)&1){
				a[u][u]=mod-1;
				tmp=qpow(e[u].size(),mod-2);
				for(int v:e[u]){
					if(S>>(v-1)&1){
						a[u][v]=tmp;
					}
					else{
						a[u][n+1]=(a[u][n+1]-f[S|1<<(v-1)][v]+mod)%mod;
					}
				}
				a[u][n+1]=(a[u][n+1]*1ll*tmp+mod-1)%mod;
			}
		}
		for(int i=1,cur,tmp;i<=n;i++){
			if(S>>(i-1)&1){
				tmp=0;
				for(int j=i;j<=n;j++){
					if(S>>(j-1)&1){
						if(tmp<a[j][i]){
							tmp=a[j][i],cur=j;
						}
					}
				}
				swap(a[i],a[cur]);
				tmp=qpow(a[i][i],mod-2);
				for(int j=1;j<=n;j++){
					if(i!=j&&(S>>(j-1)&1)){
						for(int k=i+1;k<=n+1;k++){
							if((S>>(k-1)&1)||k==n+1){
								a[j][k]=(a[j][k]-a[j][i]*1ll*a[i][k]%mod*tmp%mod+mod)%mod;
							}
						}
					}
				}
			}
		}
		for(int i=1;i<=n;i++){
			if(S>>(i-1)&1){
				f[S][i]=a[i][n+1]*1ll*qpow(a[i][i],mod-2)%mod;
			}
		}
	}
	cin>>q;
	while(q--){
		int num,S=0,u;
		cin>>num;
		while(num--){
			cin>>u;
			S|=1<<(u-1);
		}
		cin>>u;
		cout<<f[(uS^S)|1<<(u-1)][u]<<"\n";
	}
	return 0;
}
}
int main(){return asbt::main();}
```

---


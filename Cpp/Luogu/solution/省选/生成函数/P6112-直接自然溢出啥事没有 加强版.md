# 直接自然溢出啥事没有 加强版

## 题目背景

[原题链接](https://www.luogu.com.cn/problem/P6103)    
本题与原题的区别，只有模数和数据范围不同。

![](https://cdn.luogu.com.cn/upload/image_hosting/hu0gfpdv.png)

## 题目描述

给定一个正整数 $n$，问有多少个长度为 $n$ 的字符串，满足这个字符串是一个「程序片段」。

具体定义如下：

单个分号 `;` 是一个「语句」。

空串 是一个「程序片段」。

如果字符串 `A` 是「程序片段」，字符串 `B` 是「语句」，则 `AB` 是「程序片段」。

如果字符串 `A` 是「程序片段」，则 `{A}` 是「语句块」。

如果字符串 `A` 是「语句块」，则 `A` 是「语句」，`[]A` 和 `[]()A` 都是「函数」。

如果字符串 `A` 是「函数」，则 `(A)` 是「函数」，`A` 和 `A()` 都是「值」。

如果字符串 `A` 是「值」，则 `(A)` 是「值」，`A;` 是「语句」。

**注意：`A` 是 `B` 并不代表 `B` 是 `A`。**

## 说明/提示

【样例一解释】  
合法的「程序片段」有：`;;;;`，`;;{}`，`;{;}`，`;{};`，`{;;}`，`{;};`，`{{}}`，`{};;`，`{}{}`。

【数据范围】  
对于 $30\%$ 的数据，$1\le n \le 10^5$；   
对于 $100\%$ 的数据，$1\le n \le 10^7$。  

## 样例 #1

### 输入

```
4```

### 输出

```
9```

## 样例 #2

### 输入

```
7```

### 输出

```
140```

## 样例 #3

### 输入

```
8923```

### 输出

```
424180943```

## 样例 #4

### 输入

```
114514```

### 输出

```
552971057```

# 题解

## 作者：p878567 (赞：23)

我也在想此题如何用$O(n)$解决，然后看到了这个题，就有了这个题解。  
由于我比较懒，以下的函数均省略$(x)$  

---
引理：设连续可导函数$F_1,F_2,G$满足$G^2+F_1G+F_2=0$，那么$G$也满足$(4F_2-F_1^2)G'+(F_1F_1'-2F_2')G+2F_1'F_2-F_1F_2'=0$。  
证明（懒得看就算）：原式对$x$求导得
$$2GG'+F_1'G+F_1G'+F_2'=0$$
即
$$G'=-\frac{F_1'G+F_2'}{2G+F_1}=-\left(\frac{F_1'}{2}+\frac{F_2'-\frac{F_1F_1'}{2}}{2G+F_1}\right)$$
另一方面，原式等价于
$$\frac{G^2+F_1G+F_2}{2G+F_1}=0$$
即
$$\frac{G}{2}+\frac{F_1}{4}+\frac{F_2-\frac{F_1^2}{4}}{2G+F_1}=0$$
从而
$$\frac{1}{2G+F_1}=-\frac{2G+F_1}{4F_2-F_1^2}$$
代入后化简即得证。

---
记$A_0$为程序片段数量的生成函数，$A_1$为语句数量的生成函数，$A_2$为语句块数量的生成函数，$A_3$为函数的生成函数，$A_4$为值数量的生成函数  
那么有
$$\begin{cases}A_0=1+A_0A_1\\A_1=x+A_2+xA_4\\A_2=x^2A_0\\A_3=x^2A_2+x^4A_2+x^2A_3\\A_4=A_3+x^2A_4\end{cases}$$
关于$A_4$需要提的一点就是：直接把函数作为值（总是合法），在函数右端加括号作为值（总是合法），在值的两端加括号得到值（合法当且仅当这个值不能作为函数），注意到所有的函数都是值，因此$A_4=A_3+x^2A_3+x^2(A_4-A_3)$  
由上面的方程组解得
$$(x^7+x^6+x^5-2x^4+x^2)A_0^2+(x^5-x^4-2x^3+2x^2+x-1)A_0+(x^4-2x^2+1)=0$$
###### （注：用NTT或分治NTT直接解理论上能获得30pts,实际上懒得写）
## 请注意以下过于暴力！！！
由引理，得下面的定理：  
设生成函数$G$满足$F_1G^2+F_2G+F_3=0$（其中$F_1,F_2,F_3$均是连续可导函数），那么$G$也满足$F_1(4F_1F_3-F_2^2)G'+(F_1F_2F_2'-F_1'F_2^2-2F_1^2F_3'+2F_1F_1'F_3)G+2F_1F_2'F_3-F_1'F_2F_3-F_1F_2F_3'=0$。  
这是因为
$$G^2+\frac{F_2}{F_1}G+\frac{F_3}{F_1}=0$$
$$\left(\frac{4F_3}{F_1}-\frac{F_2^2}{F_1^2}\right)G'+\left(\frac{F_2}{F_1}\cdot\frac{F_2'F_1-F_2F_1'}{F_1^2}-2\cdot\frac{F_3'F_1-F_3F_1'}{F_1^2}\right)G+2\cdot\frac{F_2'F_1-F_2F_1'}{F_1^2}\cdot\frac{F_3}{F_1}-\frac{F_3'F_1-F_3F_1'}{F_1^2}\cdot\frac{F_2}{F_1}=0$$
$$F_1(4F_1F_3-F_2^2)G'+(F_1F_2F_2'-F_1'F_2^2-2F_1^2F_3'+2F_1F_1'F_3)G+2F_1F_2'F_3-F_1'F_2F_3-F_1F_2F_3'=0$$
令
$$F_1=x^7+x^6+x^5-2x^4+x^2,F_2=x^5-x^4-2x^3+2x^2+x-1,F_3=x^4-2x^2+1$$
则
$$F_1'=7x^6+6x^5+5x^4-8x^3+2x,F_2'=5x^4-4x^3-6x^2+4x+1,F_3'=4x^3-4x$$
使用上面的定理得
$$\begin{aligned}&(4x^{18}+7x^{17}+5x^{16}-20x^{15}-33x^{14}+5x^{13}+55x ^{12}+42x^{11}-67x^{10}-63x^9+59x^8+40x^7-31x^6-13x^5+ 9x^4+2x^3-x^2)A_0'\\&+(6x^{17}+8x^{16}-4x^{15}-30x^{14}-63x^{13}+29x^{12}+111x^{11}+27x^{10}-94x^9-78x^8+70x^7+64x^6-39x^5-23x^4+ 15x^3+3x^2-2x)A_0\\&+(-x^{15}+3x^{14}+11x^{13}-15x^{12}-30x^{11}+22x^{10}+40x ^9-6x^8-37x^7-9x^6+27x^5+5x^4-12x^3+2x)=0\end{aligned}$$
然而通过敏锐的观察力可以发现这个式子可以两边同时约去$x(x-1)(x+1)$，这样就有
$$\begin{aligned}&(4x^{15}+7x^{14}+9x^{13}-13x^{12}-24x^{11}-8x^{10}+31x^9+34x^8-36x^7-29x^6+23x^5+11x^4-8x^3-2x^2+x)A_0'\\&+(6x^{14}+8x^{13}+2x^{12}-22x^{11}-61x^{10}+7x^9+50x^8+34x^7-44x^6-44x^5+26x^4+20x^3-13x^2-3x+2)A_0\\&+(-x^{12}+3x^{11}+10x^{10}-12x^9-20x^8+10x^7+20x^6+4x^5-17x^4-5x^3+10x^2-2)=0\end{aligned}$$
这样就成功地干掉了$A_0^2$  
设第$n$项的答案为$f_n$  
两边取$n$次项系数，有
$$\begin{aligned}&nf_n-2(n-1)f_{n-1}-8(n-2)f_{n-2}+11(n-3)f_{n-3}+23(n-4)f_{n-4}-29(n-5)f_{n-5}-36(n-6)f_{n-6}+34(n-7)f_{n-7}\\&+31(n-8)f_{n-8}-8(n-9)f_{n-9}-24(n-10)f_{n-10}-13(n-11)f_{n-11}+9(n-12)f_{n-12}+7(n-13)f_{n-13}+4(n-14)f_{n-14}\\&+2f_n-3f_{n-1}-13f_{n-2}+20f_{n-3}+26f_{n-4}-44f_{n-5}-44f_{n-6}+34f_{n-7}+50f_{n-8}+7f_{n-9}-61f_{n-10}-22f_{n-11}+2f_{n-12}+8f_{n-13}+6f_{n-14}=0\end{aligned}$$
即
$$\begin{aligned}\\&(n+2)f_n-(2n+1)f_{n-1}-(8n-3)f_{n-2}+(11n-13)f_{n-3}+(23n-66)f_{n-4}-(29n-101)f_{n-5}-(36n-172)f_{n-6}+(34n-204)f_{n-7}\\&+(31n-198)f_{n-8}-(8n-79)f_{n-9}-(24n-179)f_{n-10}-(13n-121)f_{n-11}+(9n-106)f_{n-12}+(7n-83)f_{n-13}+(4n-50)f_{n-14}\\&-[n=12]+3[n=11]+10[n=10]-12[n=9]-20[n=8]+10[n=7]+20[n=6]+4[n=5]-17[n=4]-5[n=3]+10[n=2]-2[n=0]=0\end{aligned}$$
~~不知道还能不能化简~~  
这样就可以$O(n)$解决此题了  
欢迎各位大佬前来吊打我，方法包括但不限于：用低于$O(n)$的算法切了此题；用更短的式子切了此题；在$\bmod 2^{64}$的意义下切了此题。  
本文即将同步发表于![我的博客](https://01191020csl.github.io)
### Update on 2020.02.21:
1.倒数第二个递推式少考虑了最后的常多项式（但结论是对的），由于~~我懒~~我觉得你们不想再看公式了，因此不给出正确的过程（并且可以自己复原出来）  
2.链接被打成图片了：本文即将同步发表于[我的博客](https://01191020csl.github.io)

---

## 作者：myee (赞：9)

### 前言

大毒瘤题！

拿了最劣解 QAQ。

不过这么做确实简单得多。

---
### 思路

生成函数可以大力解方程得。

让我们快进到生成函数：

$$1-z-2z^2+2z^3+z^4-z^5-(1-z^2)\sqrt{1-2z-5z^2+4z^3+7z^4-6z^5-3z^6-4z^7}\over2z^2(1-2z^2+z^3+z^4+z^5)$$

注意到我们只用求单项；换言之，我们只用把分子前 $n+2$ 项线性求出，以及 $1\over1-2z^2+z^3+z^4+z^5$ 的前 $n$ 项线性求出，答案就可以线性求出。

#### 咋做 $1\over1-2z^2+z^3+z^4+z^5$

先捏软柿子。

即求 $1-2z^2+z^3+z^4+z^5$ 的乘法逆。

考虑设为 $f$。

$$(1-2z^2+z^3+z^4+z^5)f=1$$

$$f_0=1$$

$$f_n=2f_{n-2}-f_{n-3}-f_{n-4}-f_{n-5} (n>0)$$

然后就做好了。

#### 咋做分子

其余部分比较平凡，我们考虑咋求 $\sqrt{1-2z-5z^2+4z^3+7z^4-6z^5-3z^6-4z^7}$。

记 $f=1-2z-5z^2+4z^3+7z^4-6z^5-3z^6-4z^7,g=f^\frac12$。

考虑对着 $g$ 列出 ODE。

由于

$$g'=\frac12f'g^{-1}$$

$$g''=\frac12f''g^{-1}-\frac14(f')^2f^{-1}g^{-1}$$

于是

$${g''\over g'}=f''(f')^{-1}-\frac12f'f^{-1}$$

即

$$(f'f)g''=(f''f-\frac12(f')^2)g'$$

---

然后你现在要干的事：
* 求 $f',f''$。
* 求 $ff'$。
* 求 $f''f-\frac12(f')^2$。

显然手算这些非常反人类，于是你飞速的打开了一个[数字帝国](https://zh.numberempire.com/)。

先是[导函数计算器](https://zh.numberempire.com/derivativecalculator.php)，你飞快地敲入：

```stein
1-2*z-5*z^2+4*z^3+7*z^4-6*z^5-3*z^6-4*z^7
```

然后让它分别做 $f',f''$，它马上返回：

```stein
-28*z^6-18*z^5-30*z^4+28*z^3+12*z^2-10*z-2
```

```stein
-168*z^5-90*z^4-120*z^3+84*z^2+24*z-10
```

接下来是[表达式计算器](https://zh.numberempire.com/expressioncalculator.php)。

不一会，又返回：

```stein
112*z^13+156*z^12+342*z^11-110*z^10-190*z^9-306*z^8+188*z^7+420*z^6-108*z^5-200*z^4+46*z^3+42*z^2-6*z-2
```

```stein
280*z^12+360*z^11+756*z^10-368*z^9-540*z^8-120*z^7+512*z^6+504*z^5-96*z^4-272*z^3+60*z^2+24*z-12
```

于是就好了。

---

记 $A=ff',B=f''f-\frac12(f')^2$。

$$g''A=g'B$$

考虑对应系数相等，有

$$\sum_k(n-k+2)(n-k+1)g_{n-k+2}A_k=\sum_k(n-k+1)g_{n-k+1}B_k$$

于是：

$$g_n={(\sum_k(n-k-1)g_{n-k-1}B_k)-(\sum_{k>0}(n-k)(n-k-1)g_{n-k}A_k)\over A_0n(n-1)}$$

算上边界 $g_0=1,g_1=-1$，然后就做完了。



---


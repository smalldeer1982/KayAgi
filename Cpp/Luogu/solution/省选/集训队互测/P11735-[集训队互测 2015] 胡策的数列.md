# [集训队互测 2015] 胡策的数列

## 题目描述

在 OI 界，有一个无人不知无人不晓，OI 水平前无古人后无来者的胡策，江湖人称一眼秒题胡大爷！

今天胡策正在研究一个远古传下来的数列：$a_0, a_1, a_2, \dots$，数列的第 $k$ 项为 $a_k$。这个数列有特别的性质，对于 $i > 1$ 有：$25 a_i + 20 a_{i - 1} = 12 a_{i - 2}$。因为流传的时间太过久远，$a_0$ 和 $a_1$ 的值都已经看不清了，但是在最后还记载着，这个数列有一个特别的性质：对于任意的 $i \geq 0$，都有  $a_i \geq 0$。

然而胡策已经看穿了一切：对于任意一个正数 $t$，满足 $a_0 = t$ 的数列 $a$ 是唯一的！但是，他想拿这个问题考一考拜胡策为师的你。

具体来说，胡策会给你一个长度为 $n$ 的表格，一开始每个格子都写着 $0$。有时他会让你将 $a_0 = t$ 时的数列 $a$ 从第 $p$ 项到第 $p + r - l$ 项的值分别写入表格中第 $l$ 到第 $r$ 格（覆盖原有的值），有时他会询问表格中某一段连续的格子中的数的和。

当然，作为胡策的弟子，你必须在胡策提出一个询问的时候马上作出回应。

因为这是一个远古的问题，胡策只给了你一台远古的计算机，它只有 64MB 的内存。

## 说明/提示

### 数据范围

- 对于 20% 的数据，$n,m \leq 1000$。
- 对于 50% 的数据，$n,m \leq 30000$。
- 对于 100% 的数据，$1 \leq n \leq 10^9$，$1 \leq m \leq 10^5$，$1 \leq t \leq 10^9$，$1 \leq p \leq 10^9$。

## 样例 #1

### 输入

```
3 3
1 1 3 2 3
1 2 2 4 5
2 1 3```

### 输出

```
867840008```

## 样例 #2

### 输入

```
1000000000 3
1 1 12450 6666666 23333333
1 6666 99999 2333 44444
2 1 1000000000```

### 输出

```
431287288```

# 题解

## 作者：xiezheyuan (赞：4)

## 简要题意

有一个数列 $a_i$ 满足：

- 对于 $i\geq2$ 有 $25a_i+20a_{i-1}=12a_{i-2}$。
- $\forall i\in\mathbb{N},a_i\geq 0$。

给定一个长度为 $n$ 的序列 $a$，初始时全为 $0$，有 $m$ 次操作，支持：

- `1 l r x y` $\forall i\in[l,r], a_i\gets a_{y+i-l}$，其中 $a_0=x$。保证 $a$ 序列通过既定条件可以唯一确定。
- `2 l r` 求区间 $[l,r]$ 的和。答案对 $10^9+7$ 取模。

$1\leq n\leq 10^9,1\leq m\leq 10^5$。空间限制 $64\mathrm{MiB}$。

## 思路

先来解递推式。

对于 $25a_i+20a_{i-1}=12a_{i-2}$，其特征方程为 $25a_i\cdot r^i+20a_i\cdot r^{i-1}=12\cdot r^{i-2}$，即 $25r^2+20r-12=0$。

解得 $r_1=\frac{2}{5},r_2=-\frac{6}{5}$。故通项公式形如 $a_n=A\cdot (\frac{2}{5})^n+B\cdot (-\frac{6}{5})^n$。由于 $a_0$ 已经确定，所以两系数和 $A+B=a_0$ 已经确定。

现在考虑解出 $A,B$，由于题目中要求 $a_i\geq 0$。我们来证明若 $B\neq0$，则一定存在 $a_i<0$。

为了方便，假定 $B>0$，$B<0$ 是类似的。当 $n$ 为奇数时， $(-\frac{6}{5})^n$ 为负数，所以 $A$ 必为正数。而当 $n>\log_3 \frac{A}{B}$ 时，有 $A\cdot (\frac{2}{5})^n<B (-\frac{6}{5})^n$，故存在 $a_i\geq0$。

所以 $B=0$，则 $A=a_0$，通项公式形如 $a_0\cdot (\frac{2}{5})^n$ 是等比数列。

区间覆盖等差数列，区间求和，可以用动态开点线段树完成。具体实现我相信做这道题的同学应该都比较熟悉，就不阐述了。

然后就……

![](https://cdn.luogu.com.cn/upload/image_hosting/ov8grgln.png)

（第一次被卡空成这样的我）

有两个比较好的空间优化：

- 询问时，如果到达的点是叶子结点，并且可以向下递归，可以直接用未下传的标记计算答案。
- 左节点和右节点可以只保存一个，生成节点时先生成左节点和右节点，来让编号连续。

[Submission](https://uoj.ac/submission/737822)。

---


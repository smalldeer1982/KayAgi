# [集训队互测 2022] 树链剖分

## 题目背景

请注意：**本题不是树链剖分模板题**。

## 题目描述

给定一棵 $n$ 个节点的树 $T$ 以及树上的 $m$ 条 **不同的** 路径 $I_i = (u_i, v_i)(u_i\neq v_i)$。具体地，$I_i$ 表示树上 $u_i$ 和 $v_i$ 之间的简单路径上所有点形成的点集。

考虑 $T$ 上某条路径 $I = (u, v)$，定义 $f(I) = \sum\limits_{i = 1} ^ m\sum\limits_{j = 1} ^ m [I_i\cup I = I_j\cup I]$。

对于 $T$ 上所有不同路径 $I$，求 $f(I)$ 之和，并将答案对 $998244353$ 取模。也就是说，你需要求 $\left(\sum\limits_{u = 1} ^ n\sum\limits_{v = u} ^ n f((u, v))\right) \bmod 998244353$。

## 说明/提示

本题采用捆绑测试，共 $25$ 个子任务，分别编号为 $0\sim 24$。**注意评测子任务编号为实际子任务编号 $+1$**。

子任务编号模 $5$ 的余数将子任务按数据大小划分。

- 若子任务编号模 $5$ 余 $0$，则 $n, m\leq 100$，记为 A1。
- 若子任务编号模 $5$ 余 $1$，则 $n, m\leq 500$，记为 B1。依赖于 A1。
- 若子任务编号模 $5$ 余 $2$，则 $n, m\leq 1557$，记为 C1。依赖于 B1。
- 若子任务编号模 $5$ 余 $3$，则 $n, m\leq 85500$，记为 D1。依赖于 C1。
- 若子任务编号模 $5$ 余 $4$，则 $n, m\leq 2\times 10 ^ 5$，记为 E1。依赖于 D1。

子任务编号除以 $5$ 的商将子任务按特殊限制划分。

- 若子任务编号除以 $5$ 商 $0$，则 $T$ 是一条链，记为 A2。
- 若子任务编号除以 $5$ 商 $1$，则 $T$ 是一个菊花，记为 B2。
- 若子任务编号除以 $5$ 商 $2$，则所有路径端点互不相同，记为 C2。
- 若子任务编号除以 $5$ 商 $3$，则所有路径以同一点为一端，记为 D2。
- 若子任务编号除以 $5$ 商 $4$，则无特殊限制，记为 E2。依赖于 A2，B2，C2，D2。

对于 $100\%$ 的数据，$2\leq n\leq 2\times 10 ^ 5$，$1\leq m\leq \min(\frac {n(n - 1)} 2, 2\times 10 ^ 5)$，$1\leq u_i, v_i, x_i, y_i\leq n$，且所有 $(x_i, y_i)$ 形成一棵树，所有 $I_i = (u_i, v_i)$ 互不相同，$u_i\neq v_i$。

各子任务分值如下表所示。

| **得分** | **A1** | **B1** | **C1** | **D1** | **E1** | **总和** |
| :------: | :----: | :----: | :----: | :----: | :----: | :------: |
|  **A2**  |  $1$   |  $2$   |  $3$   |  $7$   |  $7$   |   $20$   |
|  **B2**  |  $1$   |  $2$   |  $3$   |  $4$   |  $4$   |   $14$   |
|  **C2**  |  $1$   |  $2$   |  $5$   |  $7$   |  $7$   |   $22$   |
|  **D2**  |  $1$   |  $3$   |  $5$   |  $4$   |  $5$   |   $18$   |
|  **E2**  |  $2$   |  $3$   |  $3$   |  $9$   |  $9$   |   $26$   |
| **总和** |  $6$   |  $12$  |  $19$  |  $31$  |  $32$  |  $100$   |

**注：洛谷评测无子任务依赖**。

来源：2022 年集训队互测 Round 4。

出题人：Alex_Wei。

## 样例 #1

### 输入

```
-1
3 3
1 2
2 3
1 2
2 3
1 3```

### 输出

```
32```

## 样例 #2

### 输入

```
-1
4 6
1 2
1 3
1 4
1 2
1 3
1 4
2 3
2 4
3 4```

### 输出

```
120```

## 样例 #3

### 输入

```
-1
7 7
1 2
1 3
2 4
4 5
5 6
5 7
5 7
3 1
4 7
7 1
2 6
3 6
3 5```

### 输出

```
330```

# 题解

## 作者：Sol1 (赞：2)

好像做麻烦了，喜提最长解。

是个没啥技术含量的硬核分类讨论题。

首先交换一下求和顺序。

$$\sum_{i=1}^m\sum_{j=1}^m\sum_{u=1}^n\sum_{v=u}^n[I_i\cup (u,v)=I_j\cup (u,v)]$$

然后考虑对于任意一对 $I_i,I_j$，分类讨论它们的位置关系。

## 1 $i=j$

任意路径均满足条件。

这一部分贡献为 $\dfrac{mn(n+1)}{2}$。

## 2 $I_i,I_j$ 有一个端点相同

下面将公共端点记为 $r$，并钦定其为树的根；然后将两条路径的另一个点分别记为 $v_i,v_j$。

### 2.1 $I_i,I_j$ 互不包含

![](https://cdn.luogu.com.cn/upload/image_hosting/zvrrx2ml.png?x-oss-process=image/resize,m_lfit,h_170,w_225)

这种情况可以直接跑个 dfs，然后在 $v_i,v_j$ 的 LCA 处统计。

### 2.2 $I_i$ 包含 $I_j$

![](https://cdn.luogu.com.cn/upload/image_hosting/rx6zew7t.png?x-oss-process=image/resize,m_lfit,h_170,w_225)

这种情况可以在 $I_i$ 的非公共端点沿 $I_j$ 方向的第一个点（也就是红色路径与 $I_j$ 的交里面最靠近公共点的点）处统计：（将统计的点记为 $u$）

1. 如果 $v_j=u$，则要求红色路径跨过 $u$。可以预先对每一个点计算跨过一个点的路径的个数。
1. 否则，要求红色路径的一端在 $u$ 以 $v_j$ 为根的子树中，另一端在 $v_j$ 以公共点为根的子树中。前者只和 $u$ 有关，后者容易在 dfs 过程中统计。

于是枚举每一个点为公共点，然后把所有伸出去的路径端点的虚树建出来，跑上面的 dfs 就可以了。

这部分时间 $O(m\log n)$，空间 $O(n+m)$。

## 3 没有公共端点，$I_i$ 包含 $I_j$

![](https://cdn.luogu.com.cn/upload/image_hosting/udq1q75f.png?x-oss-process=image/resize,m_lfit,h_170,w_225)

新路径必须跨过 $I_i$，于是可以对每一个 $I_i$ 计算出跨过它的路径个数 $w_i$。

然后就是对于 $j$ 求包含 $I_j$ 且端点不重合的 $I_i$ 的 $w_i$ 之和。

按照套路，用 dfs 序把路径转成二维平面上的点和矩形，然后二维数点即可。

时间 $O(m\log n)$，空间 $O(n+m)$。

## 4 没有公共端点，$I_i,I_j$ 相交但不包含

### 4.1 $I_i,I_j$ LCA 不同

![](https://cdn.luogu.com.cn/upload/image_hosting/dtzry7qs.png?x-oss-process=image/resize,m_lfit,h_170,w_225)

下面那条路径的两个端点一定有祖先关系。

搞个 dfs，把路径记在 LCA 上。每次遇到一个路径就分别在每一个端点上加上另一个端点的子树大小；遇到一个两端点有祖先关系的路径时求链上和即可。

使用 dfs 序 + 树状数组做到时间 $O(m\log n)$，空间 $O(n+m)$。

### 4.2 $I_i,I_j$ LCA 相同

![](https://cdn.luogu.com.cn/upload/image_hosting/rmh4no5d.png?x-oss-process=image/resize,m_lfit,h_170,w_225)

枚举 LCA，把对应路径的点集拿出来建虚树。然后在虚树上 dfs，遇到一条路径的一个端点的时候先查询另一个端点的子树和，然后在另一个端点上加上另一个端点的子树大小。

使用 dfs 序 + 树状数组做到时间 $O(m\log n)$，空间 $O(n+m)$。

## 5 $I_i,I_j$ 不交

### 5.1 一条路径跨过 LCA

![](https://cdn.luogu.com.cn/upload/image_hosting/mbdq1jmu.png?x-oss-process=image/resize,m_lfit,h_170,w_225)

对于每一个两个端点一定有祖先关系的路径，把下端点的子树大小加到上端点上，然后对剩下的所有路径的两端点（如果有祖先关系，则只有下端点）求子树和即可。

时空均为 $O(n+m)$。

### 5.2 没有路径跨过 LCA

![](https://cdn.luogu.com.cn/upload/image_hosting/eu3l6d59.png?x-oss-process=image/resize,m_lfit,h_170,w_225)

直接 dfs 一遍，在 LCA 处统计贡献即可。

需要注意有一条路径的一个端点在 LCA 时需要特殊处理一下。

时空均为 $O(n+m)$。

---

然后把这些全拼起来，这题就做完了。时间 $O(n+m\log n)$，空间 $O(n+m)$。

[代码有点太壮观了，放这了。](https://www.luogu.com.cn/paste/l9ulxufz)



---


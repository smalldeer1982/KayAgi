# 题目信息

# [USACO05DEC] Layout G

## 题目描述

正如其他物种一样，奶牛们也喜欢在排队打饭时与它们的朋友挨在一起。FJ 有编号为 $1\dots N$ 的 $N$ 头奶牛 $(2\le N\le 1000)$。开始时，奶牛们按照编号顺序来排队。奶牛们很笨拙，因此可能有多头奶牛在同一位置上。

有些奶牛是好基友，它们希望彼此之间的距离小于等于某个数。有些奶牛是情敌，它们希望彼此之间的距离大于等于某个数。

给出 $M_L$ 对好基友的编号，以及它们希望彼此之间的距离小于等于多少；又给出 $M_D$ 对情敌的编号，以及它们希望彼此之间的距离大于等于多少 $(1\le M_L,$ $M_D\le 10^4)$。

请计算：如果满足上述所有条件，$1$ 号奶牛和 $N$ 号奶牛之间的距离最大为多少。

## 样例 #1

### 输入

```
4 2 1
1 3 10
2 4 20
2 3 3```

### 输出

```
27```

# AI分析结果

### 综合分析与结论
这些题解均围绕差分约束系统解决奶牛排队布局问题。思路核心是将奶牛间的关系转化为不等式，再建图跑最短路。算法要点在于建图和使用 SPFA 算法判断负环与求解最短路。难点在于处理图的连通性和负环情况，避免因特殊数据导致错误。

### 所选题解
- **作者：BinDir0（5星）**
    - **关键亮点**：思路清晰，详细指出坑点，代码注释丰富，可读性强。
    - **个人心得**：强调相邻牛建边的重要性，否则可能误判结果，如给出的特殊数据会因未建边得出错误答案。
- **作者：Eleven谦（4星）**
    - **关键亮点**：先给出基础思路代码，再分析错误原因并优化，讲解详细，使用双端队列对 SPFA 进行 SLF 优化。
    - **个人心得**：最后三组 hack 数据过不了是因为题目数据不保证图的连通性，引入超级源点判断图的连通性。
- **作者：lzcjoe（4星）**
    - **关键亮点**：对差分约束系统讲解详细，包括建图方法、解的判断等，代码运行结果展示完整。

### 重点代码及核心思想
#### 建图
```cpp
// 处理好基友关系
for(int i=1;i<=ml;i++) {
    scanf("%d%d%d",&a,&b,&c);
    add(a,b,c);
}
// 处理情敌关系
for(int i=1;i<=md;i++) {
    scanf("%d%d%d",&a,&b,&c);
    add(b,a,-c);
}
// 相邻牛建边
for(int i=1;i<n;i++) {
    add(i+1,i,0);
}
// 建立超级源点
for(int i=1;i<=n;i++) {
    add(0,i,0);
}
```
**核心思想**：将奶牛间的关系转化为图的边，好基友关系建正权边，情敌关系建负权边，相邻牛建边保证逻辑完整性，超级源点用于判断图的连通性。

#### SPFA 算法
```cpp
int spfa(int k) {
    memset(dis,0x7f/3,sizeof(dis));
    memset(vis,0,sizeof(vis));
    memset(tim,0,sizeof(tim));
    q.push(k);
    dis[k]=0;
    vis[k]=1;
    while(!q.empty()) {
        int u=q.front();
        q.pop();
        tim[u]++;
        vis[u]=0;
        if(tim[u]>n) return -1; // 判断负环
        for(int i=fst[u];i!=-1;i=nex[i]) {
            if(dis[v[i]]>dis[u]+w[i]) {
                dis[v[i]]=dis[u]+w[i];
                if(!vis[v[i]]) {
                    q.push(v[i]);
                    vis[v[i]]=1;
                }
            }
        }
    }
    if(dis[n]>1e8) return -2; // 判断是否连通
    return dis[n];
}
```
**核心思想**：通过队列不断更新最短路，记录节点入队次数判断负环，最后根据终点距离判断是否连通。

### 最优关键思路或技巧
- **建超级源点**：建立一个超级源点 0 与所有点相连，边权为 0，可判断图的连通性和负环。
- **判断负环**：在 SPFA 中记录节点入队次数，若大于节点数则存在负环。

### 可拓展之处
同类型题可考察差分约束系统的不同应用场景，如不等式条件更复杂、图的结构更多样等。类似算法套路包括将实际问题转化为图论问题，通过建图和图算法求解。

### 推荐题目
- P1993 小 K 的农场（差分约束系统经典题）
- P3275 [SCOI2011]糖果（差分约束系统）
- P5960 【模板】差分约束算法（模板题）

### 个人心得总结
- 要注意相邻节点建边，否则可能导致结果错误。
- 题目数据可能不保证图的连通性，需引入超级源点判断。
- 处理差分约束问题时，要将不等式转化为统一形式，再建图求解。

---
处理用时：34.32秒
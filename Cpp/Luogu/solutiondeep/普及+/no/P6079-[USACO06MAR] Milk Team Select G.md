# 题目信息

# [USACO06MAR] Milk Team Select G

## 题目描述

Farmer John 的 $N(1 \le N \le 500)$ 头奶牛打算参加一场世界级的产奶比赛 （Multistate Milking Match-up，MMM），他们已经摸清了其他队的实力。他们的总产奶量只要大于等于 $X$ 加仑（$1 \leq X \leq 10^6$），就能赢得胜利。

每头奶牛都能为全队贡献一定量的牛奶，数值在 $-10^4$ 到 $10^4$ 加仑之间（为啥有负数？因为有些奶牛会打翻其他奶牛产的牛奶）。

MMM 的目标是通过合作，增进家庭成员间的默契。为了支持比赛精神，奶牛们希望在赢得比赛的前提下，有尽可能多对奶牛间存在直系血缘关系。当然，所有奶牛都是女性，因此这里的直系血缘关系就是母女关系。

现在 FJ 摸清了所有奶牛间的血缘关系，希望算出一个团队在赢得胜利的前提下，最多有多少对奶牛存在血缘关系。注意：如果一个团队由某头奶牛和她的母亲和外祖母组成的话，这个团队只有两对血缘关系（她和她的母亲，她的母亲和外祖母）。

## 说明/提示

最优的队伍包含 $1,2,3,5$ 这四头奶牛，总产奶量为 $9$ 加仑，共有两对血缘关系（$1,2$ 和 $1,3$）。

虽然 $2,3,5$ 这个组合产奶量更大，但是这个组合里没有血缘关系。

## 样例 #1

### 输入

```
5 8
-1 0
3 1
5 1
-3 3
2 0```

### 输出

```
2```

# AI分析结果



### 算法分类
动态规划（树形DP）

---

### 题目分析与结论
题目要求选出一组奶牛，在产奶量总和≥X的前提下最大化血缘关系对数。所有题解均采用树形DP思路，通过将森林转换为树（添加虚拟根节点0）进行处理。核心难点在于状态设计及合并子节点时的血缘关系计算。

关键点总结：
1. **状态设计**：用三维状态 `f[i][j][0/1]` 表示以i为根的子树中选j对血缘关系，且i是否被选中的最大产奶量。
2. **转移策略**：分情况讨论父节点与子节点的选中状态，合并子树时倒序枚举避免重复计算。
3. **虚拟根节点**：将森林转化为树，统一处理根节点无法选中的情况。

---

### 精选题解与评分
#### 1. Zjl37（⭐⭐⭐⭐⭐）
**亮点**：  
- 状态定义清晰，引入 `cnt` 数组优化枚举范围。
- 代码可读性强，注释详细，完整处理三种转移情况。
- 倒序枚举避免覆盖未处理的旧状态。

**代码核心**：
```cpp
void dfs(int x) {
    f[x][0][0] = 0; f[x][0][1] = c[x];
    for (int i = hd[x]; i; i = e[i].second) {
        int y = e[i].first;
        dfs(y);
        for (int j = cnt[x]; j >= 0; j--) {
            for (int k = cnt[y]; k >= 0; k--) {
                // 分三种情况更新f[x][j+k][0/1]
            }
        }
        cnt[x] += cnt[y] + 1;
    }
}
```

#### 2. Purslane（⭐⭐⭐⭐）
**亮点**：  
- 简洁的状态合并方式，`roff` 宏实现倒序枚举。
- 将转移方程压缩为三个循环，逻辑紧凑。

**核心代码**：
```cpp
roff(k,n-1,0) {
    roff(kk,k,0) dp[u][k][0] = max(dp[u][k][0], ... );
    roff(kk,k,0) dp[u][k][1] = max(dp[u][k][1], ... );
    roff(kk,k-1,0) dp[u][k][1] = max(dp[u][k][1], ... );
}
```

#### 3. CYZZ（⭐⭐⭐⭐）
**亮点**：  
- 状态拆分为 `dp` 和 `pd`，更直观区分是否与当前节点相关。
- 特判 `j-k-1 >= 0` 避免越界，鲁棒性强。

**核心代码**：
```cpp
if (j-k-1 >= 0)
    pd[u][j] = max(pd[u][j], pd[u][k] + dp[v][j-k-1][1]);
```

---

### 关键技巧与拓展
1. **树形DP的倒序枚举**：类似背包问题，防止同一子树多次贡献。
2. **虚拟节点简化问题**：将森林转换为树，统一处理根节点。
3. **状态合并的优化**：通过预处理子树大小 (`cnt` 数组) 限制枚举范围。

**类似题目推荐**：  
- [P2014 选课](https://www.luogu.com.cn/problem/P2014)（树形DP+分组背包）
- [P1273 有线电视网](https://www.luogu.com.cn/problem/P1273)（树形DP+资源分配）
- [P2585 三色二叉树](https://www.luogu.com.cn/problem/P2585)（状态设计+父子关系处理）

---
处理用时：45.37秒
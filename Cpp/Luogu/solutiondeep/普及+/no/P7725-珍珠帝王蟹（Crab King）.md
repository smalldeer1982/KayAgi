# 题目信息

# 珍珠帝王蟹（Crab King）

## 题目背景

在一次航程中，你偶然发现了被一片礁石环绕的帝王蟹，被月岛能量侵蚀的它又与月光有着怎样的联系呢？似乎只有击败它才能见分晓。


## 题目描述

帝王蟹可以通过镶嵌宝石触发战斗，不同的宝石效果不同，但奇特的是，镶嵌宝石的顺序有时也会影响它的强度。

帝王蟹有一个初始为 $0$ 的强度值，每个宝石有属性 $op$ 和 $v$，表示：

- 若 $op$ 为 `+`，则镶嵌后帝王蟹的强度值将会加上 $v$；

- 若 $op$ 为 `*`，则镶嵌后帝王蟹的强度值将会乘上 $v$。

由于宝石的效果十分奇异，所以 $v$ 可能是负数。

作为一个有挑战精神的冒险者，你希望采取某种镶嵌方式，将**每个宝石**都镶嵌**恰好一遍**，且使得帝王蟹的强度值最大。

你只需要输出最大的强度值对 $998244353$ 取模的结果，注意这是一个 $[0, 998244353)$ 中的数。

也就是说，如果答案为 `ans`，按照 C++ 语法，你需要输出 `(ans % P + P) % P`，其中 `P = 998244353`。


## 说明/提示

**【样例 1 解释】**

按照输入顺序以 $1, 2, 3$ 标记每个宝石，所有可能的镶嵌顺序如下：

$1\to 2\to 3$：$x = ((0 + {\color{red}{-3}}) + {\color{red}{4}}) \times {\color{red}{-4}} = -4$；

$1\to 3\to 2$：$x = ((0 + {\color{red}{-3}}) \times {\color{red}{-4}}) + {\color{red}{4}} = 16$；

$2\to 1\to 3$：$x = ((0 + {\color{red}{4}}) + {\color{red}{-3}}) \times {\color{red}{-4}} = -4$；

$2\to 3\to 1$：$x = ((0 + {\color{red}{4}}) \times {\color{red}{-4}}) + {\color{red}{-3}} = -19$；

$3\to 1\to 2$：$x = ((0 \times {\color{red}{-4}}) + {\color{red}{-3}}) + {\color{red}{4}} = 1$；

$3\to 2\to 1$：$x = ((0 \times {\color{red}{-4}}) + {\color{red}{4}}) + {\color{red}{-3}} = 1$。

因此，强度值的最大值为 $16$，对 $998244353$ 取模后为 $16$。

---

**【样例 2 解释】**

按照输入顺序以 $1, 2, 3$ 标记每个宝石，所有可能的镶嵌顺序如下：

$1\to 2\to 3$：$x = ((0 + {\color{red}{-3}}) + {\color{red}{-4}}) \times {\color{red}{4}} = -28$；

$1\to 3\to 2$：$x = ((0 + {\color{red}{-3}}) \times {\color{red}{4}}) + {\color{red}{-4}} = -16$；

$2\to 1\to 3$：$x = ((0 + {\color{red}{-4}}) + {\color{red}{-3}}) \times {\color{red}{4}} = -28$；

$2\to 3\to 1$：$x = ((0 + {\color{red}{-4}}) \times {\color{red}{4}}) + {\color{red}{-3}} = -19$；

$3\to 1\to 2$：$x = ((0 \times {\color{red}{4}}) + {\color{red}{-3}}) + {\color{red}{-4}} = -7$；

$3\to 2\to 1$：$x = ((0 \times {\color{red}{4}}) + {\color{red}{-4}}) + {\color{red}{-3}} = -7$。

因此，强度值的最大值为 $-7$，对 $998244353$ 取模后为 $998244346$。

---

**【数据范围】**

**本题采用捆绑测试。**

对于全部测试数据：$1 \le n \le {10}^5$，$2 \le |v| \le {10}^6$。

- Subtask 1（26 points）：$n \le 9$，$|v| \le 5$。
- Subtask 2（22 points）：$v > 0$。
- Subtask 3（12 points）：保证当 $op$ 为 `*` 时 $v > 0$。
- Subtask 4（15 points）：保证当 $op$ 为 `+` 时 $v > 0$。
- Subtask 5（25 points）：无特殊限制。

---

![](https://cdn.luogu.com.cn/upload/image_hosting/rwzuwu9z.png)

## 样例 #1

### 输入

```
3
+ -3
+ 4
* -4
```

### 输出

```
16
```

## 样例 #2

### 输入

```
3
+ -3
+ -4
* 4
```

### 输出

```
998244346
```

# AI分析结果

### 算法分类
贪心

### 综合分析与结论
该题的核心在于通过贪心策略最大化帝王蟹的强度值。由于不同的操作顺序会影响最终结果，因此需要通过分类讨论来确定最优的操作顺序。具体来说，根据乘负数的个数是奇数还是偶数，分别采取不同的操作顺序。此外，还需要处理加负数和乘负数的情况，确保最终结果为正数。

### 所选题解
1. **作者：_lfxxx_ (赞：22)**
   - **星级：5星**
   - **关键亮点：**
     - 详细分析了每个Subtask的贪心策略，尤其是如何处理乘负数和加负数的情况。
     - 提供了清晰的代码实现，代码结构合理，易于理解。
     - 通过分类讨论，确保了贪心策略的正确性和全面性。
   - **个人心得：**
     - 通过讨论区的Hack案例，进一步优化了贪心策略，确保其正确性。
   - **核心代码：**
     ```cpp
     if(!(v4.size()&1))
         if(v4.empty())
             cout<<(s1*s3%mod+s2+mod)%mod<<endl;
         else
             cout<<(s1*max4%mod+s2)%mod*s3%mod*s4%mod<<endl;
     else
         cout<<(s2*max4%mod+s1)*s4%mod*s3%mod<<endl;
     ```

2. **作者：Blueqwq (赞：5)**
   - **星级：4星**
   - **关键亮点：**
     - 通过逐步分析每个Subtask，逐步推导出最终的贪心策略。
     - 代码实现简洁，逻辑清晰，易于理解。
     - 通过分类讨论，确保了贪心策略的正确性。
   - **核心代码：**
     ```cpp
     if(v4.size() % 2 == 0) {
         for(int i = 0; i < v1.size(); i++) ans += v1[i], ans %= MOD;
         ans *= v4.back();
         v4.pop_back();
         for(int i = 0; i < v2.size(); i++) ans += v2[i], ans = (ans % MOD + MOD) % MOD;
         for(int i = 0; i < v3.size(); i++) ans *= v3[i], ans = (ans % MOD + MOD) % MOD;
         for(int i = 0; i < v4.size(); i++) ans *= v4[i], ans = (ans % MOD + MOD) % MOD;
     }
     ```

3. **作者：Argon_Cube (赞：3)**
   - **星级：4星**
   - **关键亮点：**
     - 通过分类讨论，详细分析了如何处理乘负数和加负数的情况。
     - 代码实现简洁，逻辑清晰，易于理解。
     - 通过分类讨论，确保了贪心策略的正确性。
   - **核心代码：**
     ```cpp
     if(idx_mult_neg == 0) {
         for(int i = 0; i < idx_plus_pst; i++) ans = (ans + plus_pst[i]) % MOD;
         for(int i = 0; i < idx_mult_pst; i++) ans = ans * mult_pst[i] % MOD;
         for(int i = 0; i < idx_plus_neg; i++) ans = (ans + plus_neg[i] + MOD) % MOD;
     }
     ```

### 最优关键思路或技巧
1. **分类讨论**：根据乘负数的个数是奇数还是偶数，分别采取不同的操作顺序，确保最终结果为正数。
2. **贪心策略**：优先考虑乘法操作，尤其是乘负数的情况，通过负负得正的原理，最大化最终结果。
3. **代码优化**：在代码实现中，通过模运算和分类讨论，确保结果的正确性和高效性。

### 可拓展之处
该题的贪心策略可以应用于类似的优化问题，尤其是涉及到操作顺序和负数的处理。例如，在处理多个操作时，如何通过贪心策略最大化或最小化最终结果。

### 推荐题目
1. [P1002 过河卒](https://www.luogu.com.cn/problem/P1002)
2. [P1048 采药](https://www.luogu.com.cn/problem/P1048)
3. [P1060 开心的金明](https://www.luogu.com.cn/problem/P1060)

---
处理用时：26.44秒
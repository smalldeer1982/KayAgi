# 题目信息

# [PA 2022] Wieczór gier

## 题目描述

**题目译自 [PA 2022](https://sio2.mimuw.edu.pl/c/pa-2022-1/dashboard/) Runda 5 [Wieczór gier](https://sio2.mimuw.edu.pl/c/pa-2022-1/p/wie/)**

Bytie 喜欢在晚上玩他最喜欢的棋盘游戏。幸运的是，这个游戏是单人游戏，Bytie 不需要和朋友一起玩这个游戏。

棋盘共 $n$ 行，每行有 $m$ 个方格，整个棋盘共有 $nm$ 个方格。棋盘上有 $k$ 个无法区分的棋子，最多只有 $8$ 个。 棋盘的边缘有装饰性的标记，这些标记表明了棋盘的上下左右方位。每个方格可能是空的，也可能放有一个棋子，但棋盘上总是至少有一个棋子，而且至少有一个方格是空的。换句话说，满足 $1\le k\le nm-1$。游戏中一步棋指的是选择一个包含棋子的方格和与之相邻的另一个不包含棋子的方格，然后将棋子从这个方格移到相邻的空方格中。

Bytie 喜欢这个不复杂但令人兴奋的规则，他可以花几个小时来移动棋子。一天晚上，他坐在棋盘前，在棋盘上摆了 $k$ 个棋子，并想到了一种棋子的排布方式，这种排布方式也许与开始时不同。他说，每次他要走一步棋时，他都会确定现在所有棋子的所有可能走法，并从这些走法中随机选出他要怎么走棋。例如，如果棋盘上有两个棋子，第一个棋子有一种走法，第二个棋子有两种走法，那么 Bytie 将以 $\frac{1}{3}$ 的概率从这三种走法中选出一种来走下一步棋。

Bytie（正如我们已经提到的）非常喜欢玩这个游戏，所以他已经确定他会正好走 $100^{100^{100^{100}}}$ 步棋。在走了这么多步之后，棋盘上的棋子排布和目标排布相同的概率是多少？

## 说明/提示

对于 $100\%$ 的数据，满足：

$1\le n,m\le 8$。

## 样例 #1

### 输入

```
1 5
O....

....O
```

### 输出

```
0.25```

## 样例 #2

### 输入

```
2 2
O.
.O

OO
..
```

### 输出

```
0
```

# AI分析结果

### 算法分类
概率论、组合数学

### 综合分析与结论
题目要求计算在无限步移动后，棋子排布与目标排布相同的概率。核心思路是通过奇偶性判断和组合数学的方法，计算最后一步达到目标状态的方案数与总方案数的比值。难点在于理解无限步移动后的概率分布，以及如何通过组合数学简化计算。

### 所选题解
#### 题解作者：262620zzj
- **星级**: 4星
- **关键亮点**: 
  - 通过奇偶性判断简化问题，避免了复杂的概率计算。
  - 使用组合数学的方法计算方案数，思路清晰且代码实现简洁。
  - 通过枚举最后一步的移动方向和棋子位置，确保计算的准确性。
- **个人心得**: 作者提到“虽然有一些状态，棋子们相对靠近中间，到达这个状态的概率会高一些，但是下一步，这种状态可选的走法也更多，平均下来每种本质不同的走法其实概率是一样的。” 这一观点帮助理解了无限步移动后的概率分布。

### 核心代码片段
```cpp
int fz=0;
for(int i=1;i<=n;i++){
    for(int j=1;j<=m;j++){
        if(c[i][j]=='O'){
            for(int a:{0,1,2,3}){
                int x=i+d[a].fi,y=j+d[a].se;
                if(x>=1&&x<=n&&y>=1&&y<=m&&c[x][y]=='.')fz++;
            }
        }
    }
}
int c=1;
for(int i=0;i<k-1;i++)c*=n*m-2-i;
for(int i=1;i<=k-1;i++)c/=i;
int fm=0;
for(int i=1;i<=n;i++){
    for(int j=1;j<=m;j++){
        int deg=0;
        for(int a:{0,1,2,3}){
            int x=i+d[a].fi,y=j+d[a].se;
            if(x>=1&&x<=n&&y>=1&&y<=m)deg++;
        }
        fm+=deg*c;
    }
}
fm/=2;
cout<<fixed<<setprecision(13)<<1.0*fz/fm;
```
**核心实现思想**: 
- `fz` 计算最后一步达到目标状态的方案数。
- `c` 计算组合数 `C(n*m-2, k-1)`，表示其他棋子的摆放方式。
- `fm` 计算总方案数，最后除以2以考虑奇偶性。

### 可拓展之处
- 类似问题可以扩展到更高维度的棋盘或更多棋子，使用相同的奇偶性和组合数学方法。
- 可以考虑引入马尔可夫链模型，进一步分析无限步移动后的概率分布。

### 推荐题目
1. [P1002 过河卒](https://www.luogu.com.cn/problem/P1002) - 组合数学与动态规划的结合。
2. [P1044 栈](https://www.luogu.com.cn/problem/P1044) - 组合数学与递推的结合。
3. [P1057 传球游戏](https://www.luogu.com.cn/problem/P1057) - 概率论与动态规划的结合。

---
处理用时：16.52秒
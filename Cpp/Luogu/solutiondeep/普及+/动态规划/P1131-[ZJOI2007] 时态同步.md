# 题目信息

# [ZJOI2007] 时态同步

## 题目描述

小 Q 在电子工艺实习课上学习焊接电路板。一块电路板由若干个元件组成，我们不妨称之为节点，并将其用数字 $1,2,3\cdots$ 进行标号。电路板的各个节点由若干不相交的导线相连接，且对于电路板的任何两个节点，都存在且仅存在一条通路（通路指连接两个元件的导线序列）。

在电路板上存在一个特殊的元件称为“激发器”。当激发器工作后，产生一个激励电流，通过导线传向每一个它所连接的节点。而中间节点接收到激励电流后，得到信息，并将该激励电流传向与它连接并且尚未接收到激励电流的节点。最终，激励电流将到达一些“终止节点”――接收激励电流之后不再转发的节点。

激励电流在导线上的传播是需要花费时间的，对于每条边 $e$，激励电流通过它需要的时间为 $t_e$，而节点接收到激励电流后的转发可以认为是在瞬间完成的。现在这块电路板要求每一个“终止节点”同时得到激励电路――即保持时态同步。由于当前的构造并不符合时态同步的要求，故需要通过改变连接线的构造。目前小 Q 有一个道具，使用一次该道具，可以使得激励电流通过某条连接导线的时间增加一个单位。请问小 Q 最少使用多少次道具才可使得所有的“终止节点”时态同步？

## 说明/提示

- 对于 $40\%$ 的数据，$1\le N\le 1000$。
- 对于 $100\%$ 的数据，$1\le N\le 5\times 10^5$。

对于所有的数据，$1\le t_e\le 10^6$。

## 样例 #1

### 输入

```
3
1
1 2 1
1 3 3
```

### 输出

```
2
```

# AI分析结果



### 综合分析与结论
该题本质是树形结构下的贪心调整问题，核心在于通过自底向上的遍历确定每个子树的最大路径长度，并计算调整代价。所有题解均采用以下关键思路：
1. **两次DFS**：第一次计算子树最大路径，第二次累加调整代价。
2. **贪心调整**：越靠近根的边调整优先级越高，影响更多叶子节点。
3. **时间复杂度O(n)**：适用于5e5数据规模。

### 高星题解推荐

#### 1. Mathison（5星）
**核心亮点**：
- 最简洁清晰的两次DFS实现，代码可读性极佳
- 准确利用`dis[x]`记录子树最大路径，通过差值直接计算调整量
- 正确处理双向边建图

**代码核心**：
```cpp
void dfs(int x, int fa) {
    for (遍历子节点) {
        dfs(y, x);
        dis[x] = max(dis[x], dis[y] + z); // 计算最大路径
    }
    for (遍历子节点) {
        ans += dis[x] - (dis[y] + z); // 累加调整量
    }
}
```

#### 2. Social_Zhao（4.5星）
**核心亮点**：
- 显式定义`maxn[i]`和`f[i]`增强可读性
- 数学公式化状态转移方程，理论推导清晰
- 通过`sum`和`cnt`变量优化计算过程

**状态转移**：
```cpp
f[u] = ∑f[v] + maxn[u] * cnt - sum
// cnt为子节点数，sum为子节点路径总和
```

#### 3. wzh1120（4星）
**核心亮点**：
- 极简代码实现，仅用单次DFS同时计算路径和答案
- 无额外数组存储，内存优化到位
- 适合竞赛场景快速coding

**心得分录**：
> "一定要双向加边，是无向图。答案要用long long存" —— 提醒常见易错点

---

### 最优思路总结
**关键步骤**：
1. **后序遍历计算最大路径**：对每个节点维护其子树叶子到该节点的最大距离
2. **前序遍历累加差值**：对于每个节点，将各子节点路径调整至当前最大路径值
3. **时间复杂度控制**：严格O(n)的双重DFS遍历

**核心代码模板**：
```cpp
long long ans = 0;
void dfs(int u, int fa) {
    for (遍历所有子节点v) {
        dfs(v, u);
        max_dis[u] = max(max_dis[u], max_dis[v] + edge_w);
    }
    for (遍历所有子节点v) {
        ans += max_dis[u] - (max_dis[v] + edge_w);
    }
}
```

---

### 推荐相似题目
1. [P2986 USACO10MAR] Great Cow Gathering](https://www.luogu.com.cn/problem/P2986)  
   (树形DP+子树统计)
2. [P3047 [USACO12FEB]Nearby Cows](https://www.luogu.com.cn/problem/P3047)  
   (树形DP+多级子树处理)
3. [P3177 [HAOI2015] 树上染色](https://www.luogu.com.cn/problem/P3177)  
   (树形DP+组合贡献计算)

---
处理用时：52.50秒
# 题目信息

# [BalticOI 2005] Bus Trip

## 题目描述

这里有 $N$ 座城镇, 和城镇之间的 $M$ 巴士单行线(没有中间停靠站)。 城镇从$1$到 $N$ 标号。 一个旅行者在 $0$ 时刻位于 $1$ 号城镇想要到达 $P$ 号城镇。他将乘坐巴士在 $T$ 时刻到达 $P$ 号城镇。如果他早到了，他必须等待。

对于任意一个巴士路线 $i$ , 我们知道其中的起点城镇 $si$ 和目标城镇$ti$ 。我们也同样知道路线的出发时间和到达时间,但仅仅是近似值：我们知道巴士离开起点城镇 $si$ 在时间范围$[ai, bi]$内，且到达目标城镇 $ti$ 在时间范围$[ci, di]$内(端点值包括在内)。

旅行者不喜欢等待, 因此他要寻找一个旅行计划使得最大等待时间尽量小，同时保证绝对不会错过计划中的任何一辆巴士(意思是, 每次他换乘巴士, 他需要下车的巴士的最晚到达时间不会迟于他需要搭乘的下一辆巴士的最早出发时间)。

当计算等待时间时，我们必须假设最早可能到达的时间和最晚可能出发的时间。

编写一个程序，寻找一个最为合理的搭车计划。

## 说明/提示

翻译来自BZOJ P1354

## 样例 #1

### 输入

```
3 6 2 100
1 3 10 20 30 40
3 2 32 35 95 95
1 1 1 1 7 8
1 3 8 8 9 9
2 2 98 98 99 99
1 2 0 0 99 101```

### 输出

```
32```

# AI分析结果



### 综合分析与结论
该题核心在于将时间区间转化为事件序列，通过贪心最大化车上时间以最小化等待时间。主流解法采用事件排序+动态规划，关键难点在于如何高效处理换乘条件与时间约束。最优解法时间复杂度为O(M log M)，空间O(M)。

---

### 精选题解

#### 1. 作者：WarningQAQ（⭐⭐⭐⭐⭐）
**关键亮点**：  
- 将每条边拆分为起点事件（记录出发时间）和终点事件（记录到达时间+车上时间）。  
- 按时间排序后，用两个数组`dis`和`ans`分别维护节点和边的最优值，实现O(M)转移。  
- 代码简洁高效，事件排序与转移逻辑清晰。

**核心代码思想**：
```cpp
struct ask{ int x,t,id,dis; };
sort(q+1, q+tot+1, cmp); //按时间排序，时间相同时终点事件优先
for (事件i in 排序后事件序列) {
    if (是起点事件) ans[边id] = dis[当前节点]; //记录边的初始值
    else dis[目标节点] = max(dis[目标节点], ans[边id] + 车上时间); 
}
```

#### 2. 作者：Cells（⭐⭐⭐⭐）
**关键亮点**：  
- 与WarningQAQ思路相似但代码更易读。  
- 显式拆分事件类型（`tp`字段），避免排序时的逻辑错误。  
- 实时更新答案，避免最后遍历所有边。

**代码亮点**：
```cpp
struct bus { int tp, fm, pos, ti, wt; }; //tp=1为起点事件，tp=2为终点事件
sort(arr, cmp); //时间优先，终点事件优先处理
if (事件是终点且到达目标点P) 实时更新答案;
```

#### 3. 作者：DrBit（⭐⭐⭐）
**优化点**：  
- 使用虚点优化边的数量，避免O(M²)连边。  
- 对每个车站的边按出发时间排序后建立后缀虚点，二分查找可行边。

**不足**：代码复杂度较高，需处理多个辅助数组。

---

### 关键思路总结
1. **事件驱动法**：将每条巴士线路拆分为起点（出发）和终点（到达）两个事件，按时间排序处理。
2. **贪心最大化车上时间**：通过维护到达各节点的最大车上时间，将原问题转化为最长路径问题。
3. **双数组状态转移**：`dis[]`记录节点状态，`ans[]`记录边状态，避免重复计算。
4. **时间排序策略**：终点事件优先处理，确保换乘条件（下车时间≤上车时间）被正确满足。

---

### 相似题目推荐
1. [P1948 [USACO08JAN]Telephone Lines S](https://www.luogu.com.cn/problem/P1948) - 最短路+分层图思想  
2. [P4568 [JLOI2011]飞行路线](https://www.luogu.com.cn/problem/P4568) - 分层图+事件驱动  
3. [P1266 速度限制](https://www.luogu.com.cn/problem/P1266) - 带时间约束的最短路

---

### 调试心得摘录
1. **DrBit**提到特判终点为起点的情况（样例2），否则会错误计算初始状态。
2. **wei_xin**强调必须按入度拓扑排序，否则某些节点无法更新。
3. **WarningQAQ**在排序比较函数中指出终点事件需优先处理（`a.dis > b.dis`），否则转移顺序错误。

---
处理用时：53.50秒
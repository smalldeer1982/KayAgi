# 题目信息

# 「JYLOI Round 1」性状

## 题目描述

小郭给你 $(n + 1)$ 个非负整数 $a_0 \sim a_n$，对于任意 $0 \leq i \leq n$ 有 $a_i \in \{0, 1, 2\}$，其中 $a_i$ 表示第 $i$ 个人的基因中控制双眼皮的显性基因个数，在下文中也代表着这个生物。

现在对于原序列中的任意一个子序列 $b_{c_1} \sim b_{c_m}$（其中 $1 \leq c_i < c_{i + 1} \leq m$，并且 $1 \leq i < m \leq n$），将 $a_0$ 和 $b_{c_1}$ 进行交配，得到子一代，并将子一代和 $b_{c_2}$ 交配，得到子二代，以此类推，最后将子 $(m - 1)$  代与 $b_{c_m}$ 进行交配，得到子 $m$ 代，我们定义这个子序列的价值为子 $m$ 代为双眼皮的概率。

由于他很忙，于是他现在请你帮他求出所有子序列的价值的平均值在模 $998244353$ 意义下的值。

**提示**：把 0、1、2 分别看作 ``aa``、``Aa``、``AA`` 三种字符串，两个生物进行交配，就是选择每个字符串间长度为 1 的子序列进行大写字母在前，小写在后的合并，其中这样的一个字符串为子代一种可能的基因组成。

其中大写字母开头的为显性性状，小写字母开头为隐性性状。双眼皮为显性性状，单眼皮为隐性性状，结果 ``aa``、``Aa``、``AA`` 分别再对应回数字 0、1、2。

**注意**，在本题中，我们认为眼皮的单双由位于常染色体上的一对等位基因 ``A`` 和 ``a`` 控制，其中 ``A`` 相对 ``a`` 为完全显性。且该性状的遗传遵循孟德尔的分离定律，并不考虑表观遗传、从性遗传、突变、基因表达的相互影响，所有基因型的配子和个体均无致死概率，所有个体均能产生可育配子。

## 说明/提示

## 样例 1 解释

子序列 $\{1\}$、$\{0\}$、$\{1, 0\}$ 的价值分别为 $1$、$1$ 和 $\dfrac{3}{4}$，平均价值为 $\dfrac{11}{12}$，对 $998244353$ 取模后的结果为 $415935148$。

## 数据范围

对于 $100\%$ 的测试数据，$1 \leq n \leq 5 \times 10^6, a_i \in \{0, 1, 2\}$。

对于测试点 1，$n = 1$。

对于测试点 2，$n = 2$。

对于测试点 3~5，$n \leq 5$。

对于测试点 6~10，$n \leq 7.5 \times 10^3$。

本题共有 20 个测试点，每个测试点 5 分，共 100 分。

## 题目来源

「JYLOI Round 1」 B

Idea：abcdeffa & LiuXiangle

Solution：LiuXiangle

Data：LiuXiangle

## 样例 #1

### 输入

```
2
2 1 0```

### 输出

```
415935148```

## 样例 #2

### 输入

```
50
2 1 2 1 0 0 2 2 0 0 1 2 0 0 0 2 0 0 1 2 1 1 1 1 1 0 1 1 1 0 1 2 0 1 1 0 1 1 2 0 1 0 0 1 1 1 0 1 2 1 1```

### 输出

```
576313280```

# AI分析结果



### 综合分析与结论
题目要求计算所有子序列交配后显性性状概率的平均值。关键是将问题转化为基因型状态的概率维护，避免枚举指数级子序列。两位题解均采用动态维护基因型概率和的思路，时间复杂度O(n)，空间O(1)，核心在于正确推导遗传概率转移方程。

---

### 精选题解

#### 题解1：zumgze（★★★★★）
**关键亮点**：
- 滚动数组优化，仅用3个变量维护当前状态。
- 分直接交配与继承交配两种情况，清晰处理九种组合的显性概率。
- 预处理逆元提升效率，代码简洁高效。

**核心代码思路**：
```cpp
long long p[3]; // 维护当前各基因型概率和
for (处理每个a[i]) {
    long long help[3]; // 存储新增贡献
    // 分a[i]类型处理交配后的概率贡献
    if (a[i]==0) { ... }
    // 更新p数组并取模
}
```

#### 题解2：daniEl_lElE（★★★★☆）
**关键亮点**：
- 动态规划状态转移直观，分选与不选两种情况处理。
- 显式列出所有基因型转移方程，结构清晰。
- 使用滚动数组优化空间，但代码稍显冗长。

**核心代码思路**：
```cpp
// 滚动更新dp状态
for (每个a[i]) {
    dp[i][j] = dp[i-1][j]; // 不选的情况
    if (a[i]==0) { ... } // 分基因型处理转移
}
```

---

### 关键思路总结
1. **状态维护**：用数组维护当前各基因型（0/1/2）的概率和，避免枚举子序列。
2. **概率转移**：每次处理新元素时，分直接交配和继承交配两种情况，根据遗传规则计算概率贡献。
3. **滚动优化**：仅用O(1)空间，通过累加或覆盖前状态实现动态更新。
4. **逆元处理**：利用费马小定理求模意义下的倒数，避免浮点运算。

---

### 拓展与相似题目
- **类似题型**：概率DP、组合贡献统计问题（如期望计算）。
- **推荐题目**：
  1. [P1654 OSU!](https://www.luogu.com.cn/problem/P1654)（期望DP）
  2. [P2634 概率充电器](https://www.luogu.com.cn/problem/P2634)（树形概率DP）
  3. [P3750 分手是祝愿](https://www.luogu.com.cn/problem/P3750)（期望与状态转移）

---

### 个人心得摘录
- **zumgze**："没看懂比赛题解，自己瞎搞了一个做法" → 强调独立思考，通过分情况推导正确处理复杂概率。
- **调试技巧**：验证小样例（如n=1,2）确保各基因型转移正确，避免组合爆炸时的逻辑错误。

---
处理用时：154.80秒
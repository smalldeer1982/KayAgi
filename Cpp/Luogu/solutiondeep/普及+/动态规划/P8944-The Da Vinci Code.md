# 题目信息

# The Da Vinci Code

## 题目背景

> 圣杯在罗斯琳教堂下静待。  
> 大师杰作掩映中相拥入眠。  
> 剑刃圣杯守护着她的门宅。  
> 星空下她可安息无碍。

好的题目不需要花里胡哨的背景。

## 题目描述

给定一个长度为 $n$ 的数列 $a$，初始情况下 $a_i=i$。

另有一个取值在 $[1,n]$ 内的随机的整数 $x$，它取 $i$ 的概率为 $b_i$。

接下来进行 $k$ 次操作，每次**均匀随机**地选两个 $[1,n]$ 中的整数 $i,j$（允许 $i=j$），交换 $a_i,a_j$ 的值（如果 $i=j$ 则什么也不干）。问最后 $x$ 在位置 $i$ 上的概率，你需要对所有 $1\leq i\leq n$ 求出答案。你需要输出答案模 $3221225473$ 的值。

我们定义 $x$ 在位置 $i$ 上指 $a_i=x$。

## 说明/提示

#### 【样例解释】

对于样例 #1：

$b$ 数组为 $\{2134949164 ,1086276310\}$，操作 $9$ 次后 $x$ 在两个位置的概率均为 $\dfrac12$。

对于样例 #2：

$b$ 数组为 $\{1863763622,1043615898,1055155266,1556793106,1763540175,1239801170,1141007183\}$。

#### 【数据范围】
对于 $100\%$ 的数据：

* $2\leq n\leq2\times10^7$，$0\leq k,seed<2^{64}$。
* $1<b_i<3221225473$，$\sum\limits_{i=1}^n b_i\equiv 1\pmod{3221225473}$。
* 数据保证 $1<b_n<3221225473$ 且 $3221225473$ 是质数。

---

**本题采用捆绑测试**。

| $\text{Subtask}$ |$n\le$|$k\le$|分值|
|:-:|:-:|:-:|:-:|
|$0$|$2$|$2^{64}-1$|$1$|
|$1$|$5$|$5$|$4$|
|$2$|$200$|$200$|$6$|
|$3$|$200$|$2^{64}-1$|$9$|
|$4$|$2000$|$2000$|$7$|
|$5$|$2\times10^7$|$1$|$5$|
|$6$|$10^6$|$10^6$|$8$|
|$7$|$2\times10^7$|$10^7$|$10$|
|$8$|$10^6$|$2^{64}-1$|$15$|
|$9$|$2\times10^7$|$2^{64}-1$|$35$|

## 样例 #1

### 输入

```
2 9 998244353
```

### 输出

```
2684354563
```

## 样例 #2

### 输入

```
7 3 123456789
```

### 输出

```
24313281849
```

## 样例 #3

### 输入

```
10 9000000000000000000 1000000000000000000
```

### 输出

```
20026214895
```

## 样例 #4

### 输入

```
4 0 123456789
```

### 输出

```
12357556560
```

# AI分析结果



### 综合分析与结论
题目要求在大规模数据下高效计算经过k次随机交换后的概率分布。各题解核心思路均基于**线性变换叠加**与**快速幂优化**，将概率变化建模为可快速计算的递推式。关键突破点在于发现交换操作对概率的影响可表示为线性函数，通过数学推导将其转化为指数形式，从而避免暴力模拟。

---

### 高星题解推荐

#### 1. 作者：cyffff（⭐⭐⭐⭐⭐）
**关键亮点**：
- 通过分析单次操作的期望变化，提炼出线性递推式$f(x)=px+q$。
- 利用函数迭代性质直接推导出$k$次后的解析式，避免矩阵运算。
- 代码简洁高效，复杂度严格$O(n+\log k)$，完美适配数据规模。

**核心实现**：
```cpp
uint in = qpow(n, mod-2), in2 = (ull)in * in % mod;
uint k1 = (ull)(n-2) * in % mod, b1 = (ull)2 * in2 % mod;
// 计算迭代k次后的系数k2和b2
for(int i=1;i<=n;i++)
    b[i] = ((ull)k2 * b[i] % mod + b2) % mod;
```

#### 2. 作者：Missa（⭐⭐⭐⭐⭐）
**关键亮点**：
- 通过概率分析得出递推式$p_u = \frac{2}{n^2} + \frac{n-2}{n}p'_u$。
- 引入不动点概念，将问题转化为等比数列形式，极大简化计算。
- 代码实现最为简洁，直接计算系数幂次，无冗余操作。

**核心推导**：
```cpp
LL s = qpow(invn * (n-2) % mod, k); // 计算系数幂
for(int i=1; i<=n; i++) {
    LL t = (b[i] - invn) % mod * s % mod; // 应用线性变换
    ans ^= (t + invn) * i % mod;
}
```

---

### 最优思路总结
**核心技巧**：将概率变化建模为线性变换$f(x)=px+q$，利用快速幂计算复合函数。通过数学推导将$k$次操作的影响转化为：
$$f^{(k)}(x) = p^k x + q \cdot \frac{1-p^k}{1-p}$$
**关键步骤**：
1. 推导单次操作的线性表达式。
2. 利用等比数列求和公式计算复合函数参数。
3. 对每个初始概率应用该变换得到最终结果。

**同类型扩展**：适用于具有线性递推关系的概率问题（如马尔可夫链），如随机游走、状态转移等场景。当操作可分解为线性变换时，可尝试类似解法。

---

### 推荐相似题目
1. **P5104 红包发红包**  
   考察期望计算与快速幂，同样利用几何分布的期望性质。
   
2. **P3216 [HNOI2011]数学作业**  
   涉及矩阵快速幂优化递推，训练状态转移模型的构建能力。

3. **P1397 [NOI2013]矩阵游戏**  
   高次线性变换的快速计算，练习递推式分解与快速幂结合的应用。

---
处理用时：52.26秒
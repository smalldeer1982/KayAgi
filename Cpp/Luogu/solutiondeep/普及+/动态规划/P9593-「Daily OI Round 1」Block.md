# 题目信息

# 「Daily OI Round 1」Block

## 题目描述

给定一棵树，节点有颜色，在树上距离为 $2$ 的点连边（仍保留原来的边），求新图中颜色相同且连通的非空点集数量。由于答案可能非常大，您只需输出答案对 $10^9+7$ 取模的值。

点集连通的定义：对于图 $G(V,E)$，$V$ 的一个子集 $V'$ 是连通点集，当且仅当 $G(V',E')$ 是一个连通图，其中边集 $E'=\{(u,v)|(u,v)\in E\land u \in V'\land v\in V'\}$。

## 说明/提示

样例 1 中，原树如下图所示：

![](https://cdn.luogu.com.cn/upload/image_hosting/zmgrnwkh.png)

树上距离为 $2$ 的点连边后，新图如下图所示：

![](https://cdn.luogu.com.cn/upload/image_hosting/id3xc54a.png)

则 $8$ 个颜色相同且连通的非空点集分别是：$\{1\},\{2\},\{3\},\{4\},\{1,3\},\{1,4\},\{3,4\},\{1,3,4\}$。

**本题开启捆绑测试。**



|$\text{Subtask}$|分值|$n \le$| 特殊性质 | 子任务依赖 |
| :-----------: | :-------------:|:-----------: |:-----------: |:-----------: |
|$0$|$5$|$10^5$| A | 无 |
|$1$|$5$|$16$| 无 | 无 |
|$2$|$5$|$10^5$| B | 无 |
|$3$|$15$|$10^5$| C | 无 |
|$4$|$20$|$10^5$| D | 无 |
|$5$|$50$|$10^5$| 无 | $0\sim4$ |

- 特殊性质 A：所有节点的颜色不相同。
- 特殊性质 B：给出的树是菊花，具体地，第 $i$ 条边连接节点 $1$ 和节点 $i+1$。
- 特殊性质 C：给出的树是链，具体地，第 $i$ 条边连接节点 $i$ 和节点 $i+1$。
- 特殊性质 D：所有节点的颜色相同。


对于全部数据，满足 $2\leq n\leq 10^5$，$1\leq c_i\leq n$。

## 样例 #1

### 输入

```
4
1 2 1 1
1 2
2 3
2 4
```

### 输出

```
8```

## 样例 #2

### 输入

```
6
1 2 2 2 1 2
5 3
2 1
4 5
6 3
3 1
```

### 输出

```
14```

## 样例 #3

### 输入

```
16
1 1 2 1 1 2 2 2 1 1 2 1 1 1 2 1
12 8
14 9
10 8
1 16
7 12
6 1
14 8
3 1
12 5
1 13
12 2
1 12
15 8
11 5
4 12
```

### 输出

```
442```

## 样例 #4

### 输入

```
16
11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11
4 14
4 15
12 13
2 5
7 15
10 2
15 8
15 13
9 11
13 11
3 15
8 16
6 13
1 4
10 4```

### 输出

```
27454```

## 样例 #5

### 输入

```
9
3 3 2 3 2 4 2 3 3
1 2
2 3
3 4
4 5
5 6
6 7
7 8
8 9```

### 输出

```
16```

# AI分析结果



### 综合分析与结论
各题解均采用树形 DP 处理颜色分组的连通块计数，核心思路为：  
1. **选当前节点**：通过子节点及孙子节点的同色条件组合方案  
2. **不选当前节点**：统计同色子节点间的组合，要求至少选两个子节点  
关键优化点为颜色分组下的乘积处理与容斥统计。

---

### 高星题解推荐

#### 1. 题解作者：recollect_i（★★★★☆）
**关键亮点**：  
- 状态定义清晰，分选当前节点与不选两种情况  
- 利用 `g[c]` 维护颜色分组乘积，通过容斥统计不选根的同色组合  
- 代码结构简洁，通过链式前向星高效遍历  

**核心代码实现**：  
```cpp
void dp(int u, int fa) {
    f[u] = 1;
    for (int v : 子节点) {
        // 处理选v或选v的同色子节点
        LL t = (c[v]==c[u] ? f[v] : 0) + 孙节点乘积;
        f[u] = f[u] * t % MOD;
    }
    // 统计不选u的同色子节点组合
    for (int v : 子节点) 
        g[c[v]] = g[c[v]] * (f[v]+1) % MOD;
    for (int v : 子节点) 
        res += g[c[v]] - 1; // 容斥减去单点情况
}
```

---

#### 2. 题解作者：by_chance（★★★★☆）
**关键亮点**：  
- 引入 `f[u]` 处理父节点颜色传递  
- 全局 `g[c]` 统计颜色分组，避免重复遍历  
- 代码结构紧凑，利用 vector 快速实现树遍历  

**核心代码实现**：  
```cpp
void dfs(int u, int fa) {
    for (int v : 子节点) 
        g[c[v]] = g[c[v]] * (dp[v]+1) % MOD;
    for (int v : 子节点) {
        ans += g[c[v]] - 1; // 统计不选u的同色组合
        g[c[v]] = 1; // 清空临时统计
    }
    // 更新选u的方案数
    dp[u] = 乘积(选子节点或孙节点);
}
```

---

### 最优关键思路
1. **颜色分组乘积**：维护每种颜色的子节点方案乘积，利用 `g[c]` 快速计算组合。  
2. **容斥统计**：通过 `(乘积 - 单点贡献 - 1)` 计算至少选两个子节点的方案。  
3. **子树合并策略**：选当前节点时，允许跳过子节点直接选孙子节点，通过乘积组合子树方案。

---

### 拓展与同类题目
**类似题目推荐**：  
1. [P4516 [JSOI2018] 潜入行动](https://www.luogu.com.cn/problem/P4516)  
   - 树形 DP 结合状态机，处理复杂约束  
2. [P1273 有线电视网](https://www.luogu.com.cn/problem/P1273)  
   - 树形背包与分组统计  
3. [P3177 [HAOI2015] 树上染色](https://www.luogu.com.cn/problem/P3177)  
   - 颜色分组与路径贡献统计  

**举一反三**：  
- 当问题涉及树形结构+颜色/状态分组时，优先考虑树形 DP 与分组乘积优化。  
- 需统计多个子集组合时，可引入容斥思想（如总乘积减去非法情况）。

---
处理用时：78.39秒
# 题目信息

# 「KDOI-06-J」旅行

## 题目描述

小 C 在 C 国旅行。

C 国有 $n\times m$ 个城市，可以看做 $n\times m$ 的网格。定义 $(i,j)$ 表示在网格中第 $i$ 行第 $j$ 列的城市。

该国有 $2$ 种交通系统：

* 对于所有 $1\leq i<n,1\leq j\leq m$，$(i,j)$ 到 $(i+1,j)$ 有一段由 L 公司修的单向铁路；
* 对于所有 $1\leq i\leq n,1\leq j<m$，$(i,j)$ 到 $(i,j+1)$ 有一段由 Z 公司修的单向铁路；

在每一个城市有一个售票口，$(i,j)$ 城市的售票口可以用 $a_{i,j}$ 元购买一张 L 公司的铁路票，$b_{i,j}$ 元购买一张 Z 公司的铁路票。当你拥有一个公司的一张铁路票时，你可以乘坐这个公司的任意一段铁路，并消耗掉这张铁路票。注意，一张铁路票可以且仅可以使用一次。

小 C 原来在城市 $(1,1)$。他想要在 C 国旅游，但是他不想浪费任何的钱（即，当他旅游完毕时手上不应该有多余的车票）。对于所有 $1\leq x\leq n,1\leq y\leq m$，求他花 $k$ 元钱并在城市 $(x,y)$ 结束旅行的方案数，对 $998\ 244\ 353$ 取模。

两种旅行方案不同，当且仅当小 C 经过的城市不同，或他在某一个城市购买的某家公司的铁路票数量不同。

## 说明/提示

**【样例解释 #1】**

到 $(3,1)$ 的方案有：

* 在 $(1,1)$ 购买 $1$ 张 L 公司的铁路票；乘坐 L 公司的铁路到 $(2,1)$；在 $(2,1)$ 购买 $1$ 张 L 公司的铁路票；乘坐 L 公司的铁路到 $(3,1)$。

到 $(2,2)$ 的方案有：

* 在 $(1,1)$ 购买 $1$ 张 L 公司的铁路票；乘坐 L 公司的铁路到 $(2,1)$；在 $(2,1)$ 购买 $1$ 张 Z 公司的铁路票；乘坐 Z 公司的铁路到 $(2,2)$。

到 $(3,2)$ 的方案有：

* 在 $(1,1)$ 购买 $1$ 张 Z 公司的铁路票；乘坐 Z 公司的铁路到 $(1,2)$；在 $(1,2)$ 购买 $2$ 张 L 公司的铁路票；乘坐 L 公司的铁路到 $(2,2)$；乘坐 L 公司的铁路到 $(3,2)$。
* 在 $(1,1)$ 购买 $1$ 张 L 公司的铁路票和 $1$ 张 Z 公司的铁路票；乘坐 Z 公司的铁路到 $(1,2)$；乘坐 L 公司的铁路到 $(2,2)$；在 $(2,2)$ 购买 $1$ 张 L 公司的铁路票；乘坐 L 公司的铁路到 $(3,2)$。
* 在 $(1,1)$ 购买 $1$ 张 L 公司的铁路票和 $1$ 张 Z 公司的铁路票；乘坐 L 公司的铁路到 $(2,1)$；乘坐 Z 公司的铁路到 $(2,2)$；在 $(2,2)$ 购买 $1$ 张 L 公司的铁路票；乘坐 L 公司的铁路到 $(3,2)$。

到 $(2,3)$ 的方案有：

* 在 $(1,1)$ 购买 $1$ 张 L 公司的铁路票和 $2$ 张 Z 公司的铁路票。在此之后，有 $3$ 种方案可以从 $(1,1)$ 乘坐两公司的铁路到 $(2,3)$。
* 在 $(1,1)$ 购买 $1$ 张 Z 公司的铁路票；乘坐 Z 公司的铁路到 $(1,2)$；在 $(1,2)$ 购买 $1$ 张 L 公司的铁路票和 $1$ 张 Z 公司的铁路票。在此之后，有 $2$ 种方案可以从 $(1,2)$ 乘坐两公司的铁路到 $(2,3)$。

**【样例 #2】**

见选手目录下的 `travel/travel2.in` 与 `travel/travel2.ans`。这个样例满足测试点 $7\sim 8$ 的条件限制。

**【样例 #3】**

见选手目录下的 `travel/travel3.in` 与 `travel/travel3.ans`。这个样例满足测试点 $11$ 的条件限制。

**【数据范围】**

对于所有数据保证：$1\leq n,m\leq45$，$1\leq k,a_{i,j},b_{i,j}\leq90$。

| 测试点编号 | $n,m$ | $k$ | $a_{i,j}$ | $b_{i,j}$ |
|:--:|:--:|:--:|:--:|:--:|
| $1\sim3$ | $\leq3$ | $\leq5$ | $=1$ | $=1$ |
| $4\sim6$ | $\leq10$ | $\leq10$ | $=1$ | $=40$ |
| $7\sim8$ | $\leq40$ | $\leq30$ | $=1$ | $=45$ |
| $9\sim10$ | $\leq15$ | $\leq15$ | $\leq15$ | $\leq15$ |
| $11$ | $\leq15$ | $\leq30$ | $\leq30$ | $\leq30$ |
| $12$ | $\leq20$ | $\leq40$ | $\leq40$ | $\leq40$ |
| $13\sim15$ | $\leq25$ | $\leq50$ | $\leq50$ | $\leq50$ |
| $16$ | $\leq30$ | $\leq60$ | $\leq60$ | $\leq60$ |
| $17$ | $\leq35$ | $\leq70$ | $\leq70$ | $\leq70$ |
| $18\sim19$ | $\leq40$ | $\leq80$ | $\leq80$ | $\leq80$ |
| $20$ | $\leq45$ | $\leq90$ | $\leq90$ | $\leq90$ |

## 样例 #1

### 输入

```
3 3 5
3 2 1
2 1 3
1 3 2
1 2 3
2 3 1
3 1 2```

### 输出

```
0 0 0
0 1 5
1 3 5```

# AI分析结果



### 综合分析与结论

本题核心是动态规划，需追踪位置、花费、剩余车票数。各题解均采用多维 DP 结合滚动数组优化，通过容斥避免重复计算，并利用剪枝优化性能。关键挑战在于状态设计与转移优化。

---

### 精选题解列表

#### 1. 作者：uid_310801 (★★★★★)
**关键亮点**：
- 引入五维滚动数组优化空间，时空复杂度降至 $O(n^5)$。
- 通过前缀和容斥避免重复计算，代码逻辑清晰。
- 剪枝策略：剩余票数无法满足后续路径时停止转移。
**核心代码**：
```cpp
for(int la=0; la+i<=n; la++) 
for(int lb=0; lb+j<=m; lb++) {
    ll res = mod;
    if(la && c>=a[i][j]) res += f[...]; // 买L票
    if(lb && c>=b[i][j]) res += f[...]; // 买Z票
    if(la && lb && ...) res -= f[...];  // 容斥
    res += 来自上方或左方的转移; 
    f[...] = res % mod;
}
```

#### 2. 作者：_O_v_O_ (★★★★☆)
**关键亮点**：
- 状态转移方程简洁，采用滚动数组优化。
- 将购买与移动分离，避免重复计数。
- 代码高效，最大点仅 495ms。
**核心思想**：
```cpp
dp[i][j][c][x][y] = 从上/左转移 
    + 购买L票的前缀和 
    + 购买Z票的前缀和 
    - 同时购买两种票的重复计算;
```

#### 3. 作者：Eddie08012025 (★★★★☆)
**优化技巧**：
- 动态限制枚举范围（如 `x <= n-i`）。
- 分层转移：先处理购买再处理移动。
- 使用指针减少数组访问开销。
**代码片段**：
```cpp
for(int u=k;u>=a[i][j];u--) 
for(int x=0;x<=n-i;x++) 
for(int y=0;y<=m-j;y++) {
    int *p = &dp[...];
    *p += dp[...]; // 购买L票
}
```

---

### 关键思路总结

1. **状态设计**：五维 `dp[i][j][c][x][y]` 表示位置、花费、剩余票数。
2. **滚动数组**：仅保留当前行和前一行，空间降至 $O(n^4)$。
3. **容斥原理**：避免同时购买两种票时的重复计数。
4. **剪枝优化**：限制剩余票数枚举范围，跳过无效状态。
5. **转移顺序**：优先处理购买操作，再处理移动。

---

### 相似题目推荐

1. **P1941 飞扬的小鸟** - 多维状态 DP，涉及资源管理。
2. **P1004 方格取数** - 双路径计数，状态压缩思路。
3. **P1541 乌龟棋** - 多维度动态规划，类似票数管理。

---

### 调试经验摘录

- **避免取模过频**：在转移时暂存结果，最后统一取模（作者紊莫）。
- **强制购买顺序**：先买 L 后买 Z，避免重复（作者zzafanti）。
- **指针优化**：直接操作数组地址减少计算（作者Eddie08012025）。

---
处理用时：56.71秒
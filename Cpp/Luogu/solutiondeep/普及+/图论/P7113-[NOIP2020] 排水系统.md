# 题目信息

# [NOIP2020] 排水系统

## 题目描述

对于一个城市来说，排水系统是极其重要的一个部分。

有一天，小 C 拿到了某座城市排水系统的设计图。排水系统由 $n$ 个排水结点（它们从 $1 \sim n$ 编号）和若干个单向排水管道构成。每一个排水结点有若干个管道用于汇集其他排水结点的污水（简称为该结点的汇集管道），也有若干个管道向其他的排水结点排出污水（简称为该结点的排出管道）。

排水系统的结点中有 $m$ 个污水接收口，它们的编号分别为 $1, 2, \ldots , m$，污水只能从这些接收口流入排水系统，并且这些结点没有汇集管道。排水系统中还有若干个最终排水口，它们将污水运送到污水处理厂，没有排出管道的结点便可视为一个最终排水口。

现在各个污水接收口分别都接收了 $1$ 吨污水，污水进入每个结点后，会均等地从当前结点的每一个排出管道流向其他排水结点，而最终排水口将把污水排出系统。

现在小 C 想知道，在该城市的排水系统中，每个最终排水口会排出多少污水。该城市的排水系统设计科学，管道不会形成回路，即不会发生污水形成环流的情况。

## 说明/提示

**【样例 #1 解释】**

$1$ 号结点是接收口，$4, 5$ 号结点没有排出管道，因此是最终排水口。  
$1$ 吨污水流入 $1$ 号结点后，均等地流向 $2, 3, 5$ 号结点，三个结点各流入 $\frac{1}{3}$ 吨污水。  
$2$ 号结点流入的 $\frac{1}{3}$ 吨污水将均等地流向 $4, 5$ 号结点，两结点各流入 $\frac{1}{6}$ 吨污水。  
$3$ 号结点流入的 $\frac{1}{3}$ 吨污水将均等地流向 $4, 5$ 号结点，两结点各流入 $\frac{1}{6}$ 吨污水。  
最终，$4$ 号结点排出 $\frac{1}{6} + \frac{1}{6} = \frac{1}{3}$ 吨污水，$5$ 号结点排出 $\frac{1}{3} + \frac{1}{6} + \frac{1}{6} = \frac{2}{3}$ 吨污水。

**【数据范围】**

| 测试点编号 | $n \le$ | $m \le$ |
|:-:|:-:|:-:|
| $1 \sim 3$ | $10$ | $1$ |
| $4 \sim 6$ | ${10}^3$ | $1$ |
| $7 \sim 8$ | ${10}^5$ | $1$ |
| $9 \sim 10$ | ${10}^5$ | $10$ |

对于全部的测试点，保证 $1 \le n \le {10}^5$，$1 \le m \le 10$，$0 \le d_i \le 5$。

数据保证，污水在从一个接收口流向一个最终排水口的过程中，不会经过超过 $10$ 个中间排水结点（即接收口和最终排水口不算在内）。

## 样例 #1

### 输入

```
5 1
3 2 3 5
2 4 5
2 5 4
0
0
```

### 输出

```
1 3
2 3
```

## 样例 #2

### 输入

```
见附件中的 water/water2.in```

### 输出

```
见附件中的 water/water2.ans```

## 样例 #3

### 输入

```
见附件中的 water/water3.in```

### 输出

```
见附件中的 water/water3.ans```

# AI分析结果

### 综合分析与结论
这些题解主要围绕拓扑排序解决排水系统污水流量计算问题，思路基本一致，都通过拓扑排序保证上游节点先处理，再将污水流量传递给下游节点。因数据范围大，分数运算易溢出，多数题解采用 `__int128` 类型，部分题解使用自定义高精度或特殊底数存储法。

### 所选题解
- **听取MLE声一片**：5星。关键亮点是思路清晰，详细介绍拓扑排序和分数处理方法，代码有注释，适合初学者。
    - 个人心得：强调去掉高精度是好的拓扑排序题目，还给出拓扑排序模板题建议，提醒注意审题和 `vector` 存边的使用。
- **lcyxds**：4星。关键亮点是用两个 `unsigned long long` 开高精度，以 $60^{11}$ 为底存储流量，避免求 `gcd`，提供新的高精度处理思路。
    - 个人心得：考场上以 $60^{10}$ 为底只拿到60分，提示做题时要注意底数选择。
- **hensier**：4星。关键亮点是不仅用拓扑排序，还给出深搜解法，使用链式前向星维护图，思路全面。
    - 个人心得：指出分母上限会爆 `ll` 和 `ull`，介绍 `__int128_t` 使用，提醒考场上可能需写高精度。

### 重点代码及核心思想
#### 听取MLE声一片 - 拓扑排序函数
```cpp
void tp(){
    for(int i=1;i<=n;i++)
        if(!in[i]){
            book[i]=1;
            q.push(i);
            xx[i]=1,yy[i]=1;
        }
    while(!q.empty()){
        int p=q.front();
        q.pop();
        if(out[p])
            continue;
        for(int i=0;i<a[p].size();i++){
            add(a[p][i],xx[p],yy[p]*(1ll*a[p].size()));
            if(book[a[p][i]])
                continue;
            in[a[p][i]]--;
            if(in[a[p][i]]==0){
                book[a[p][i]]=1;
                q.push(a[p][i]);
            }
        }
    }
    return;
}
```
核心思想：先将入度为0的点入队，然后依次处理队中节点，将其污水流量分流到相连节点，同时更新相连节点入度，入度为0的节点再入队。

#### lcyxds - 高精度加法和除法
```cpp
Gj operator + (Gj a, Gj b){
    Gj res;
    res._num[0] = a._num[0]+b._num[0];
    res._num[1] = a._num[1]+b._num[1]+res._num[0]/_BASE;
    res._num[0]%=_BASE;
    return res;
};

Gj operator / (Gj a, ull b) {
    Gj res;
    res._num[0] = a._num[1]%b*_BASE+a._num[0];
    res._num[1] = a._num[1]/b;
    res._num[0]/=b;
    return res;
}
```
核心思想：实现以 $1e18$ 为底的高精度加法和除法运算。

#### hensier - 深搜函数
```cpp
void dfs(int u)
{
    for(int i=head[u],v;i;i=e[i].nxt)
    {
        v=e[i].to;
        update(wx[v],wy[v],wx[u],oud[u]*wy[u]);
        ind[v]--;
        if(!ind[v])dfs(v);
    }
}
```
核心思想：从当前节点出发，将其污水流量更新到相连节点，若相连节点入度为0则继续深搜。

### 最优关键思路或技巧
- **拓扑排序**：保证上游节点先处理，符合污水流动顺序，避免环流问题。
- **分数处理**：用结构体或数组分别存储分子和分母，实现分数加法和化简，避免小数精度问题。
- **高精度处理**：使用 `__int128` 类型或自定义高精度方法，解决数据范围大导致的溢出问题。

### 可拓展之处
同类型题如网络流中流量分配问题、图中资源传递问题等，都可使用拓扑排序确定处理顺序，结合分数或高精度运算解决数据表示问题。

### 推荐题目
- [P1038 神经网络](https://www.luogu.com.cn/problem/P1038)：拓扑排序经典模板题。
- [P1983 车站分级](https://www.luogu.com.cn/problem/P1983)：考察拓扑排序应用。
- [P1137 旅行计划](https://www.luogu.com.cn/problem/P1137)：利用拓扑排序解决路径规划问题。 

---
处理用时：34.60秒
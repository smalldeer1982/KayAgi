# 题目信息

# 『GROI-R1』 虹色的彼岸花

## 题目背景

少年身着春季校服的深灰色外套与黑色短裤，外套内是白净的衬衫。

他的右手不知为何缠着绷带，右眼用头发挡得严严实实，扑面而来的是一种神秘感。

一瓣鲜红的彼岸花，在教室上空无人在意之处打旋。

玘的身世，总是一个谜题吧。

「所以你到底是什么人，又为什么要来这里！」

可是彼岸花显然不想让你知道这些。

## 题目描述

玘给了寒一棵编号为 $1\sim n$ 的树，这棵树上每个点都有一个点权，同时有些边有边权，有些边没有边权。可是玘把每一个点的点权删除了。寒只知道****点权都是整数，而且在 $l$ 和 $r$ 之间（包含端点）****。而且，点权和边权有着下面的特殊关系：

- 对于****有边权****的边，要求****连接的两个点的点权和为边权****。

- 对于****没有边权的边****，****无限制****。

玘问寒这棵树****有多少种不同的点权填写方式****。两种填写方式不同，当且仅当至少存在一个点的点权不同。可是寒不会做这个题。

寒请你解决这个问题。

## 说明/提示

**样例解释**

对于样例的第一组测试数据，可以得到下图：

![](https://cdn.luogu.com.cn/upload/image_hosting/91vlqt5k.png)

$5$ 种填写方式分别为：

$\{0,2,2,0,0,3\}\\\{0,2,2,0,1,3\}\\\{0,2,2,0,2,3\}\\\{0,2,2,0,3,3\}\\\{0,2,2,0,4,3\}$

可以证明，不存在别的填写方式。

样例输入中，为了直观，添加了空行。实际数据中不存在多余空行。

**数据范围**

**本题采用捆绑测试。**

| 子任务编号 | 数据范围 | 特殊性质 | 分值 |
| :-----------: | :-----------: | :-----------: | :-----------: |
| $\text{Subtask1}$ | $1\le n\le 10$，$0\le l,r\le5$ |  | $15$ |
| $\text{Subtask2}$ | $1\le n\le 2\times 10^5$，$0\le l,r\le5$ |  | $20$ |
| $\text{Subtask3}$ | $1\le n\le 10$，$-10^9\le l,r\le 10^9$ |  | $15$ |
| $\text{Subtask4}$ | $1\le n\le 2\times10^5$，$-10^9\le l,r\le 10^9$ | 有 | $10$ |
| $\text{Subtask5}$ | $1\le n\le 2\times10^5$，$-10^9\le l,r\le 10^9$ |  | $40$ |

特殊性质：保证每条边都无边权。

对于 $100\%$ 的数据，保证 $1\le T \le 5$，$1\le n\le 2\times10^5$，$1\le \sum n\le 10^6$，$-10^9\le l\le r \le 10^9$，$-10^9\le w\le 10^9$，$op\in\{0,1\}$。

## 样例 #1

### 输入

```
2
6 0 4
1 1 2 2
1 2 3 4
1 3 4 2
0 2 5
1 4 6 3

6 -1 4
1 1 2 4
0 2 3
0 3 4
0 2 5
0 4 6```

### 输出

```
5
6480```

# AI分析结果

### 综合分析与结论
这些题解的核心思路较为一致，都是先忽略无边权的边，将树转化为森林，再对森林中的每棵树进行处理。对于每棵树，确定一个点的点权后，可根据边权计算出其他点的点权，将点权表示为关于该点权的一次函数，通过解不等式组确定该点权的取值范围，进而得到每棵树的填写方式个数，最后将每棵树的结果相乘得到最终答案。

各题解在实现细节上有所不同，如使用的数据结构、dfs 过程中的参数传递等，但整体算法框架相似。部分题解还对特殊情况（如所有边都无边权、树只有一个点）进行了单独处理。

### 所选题解
- **作者：imzfx_Square（5星）**
  - **关键亮点**：思路清晰，代码注释详细，逻辑严谨，对算法的每个步骤都有明确的解释，易于理解。
- **作者：MichaelWong（4星）**
  - **关键亮点**：分析过程详细，对结论的推导和实现思路有清晰的阐述，代码结构合理，可读性较高。
- **作者：wwwwwza（4星）**
  - **关键亮点**：步骤划分明确，代码简洁，对算法的实现过程有清晰的描述，易于实现。

### 重点代码
#### imzfx_Square 的核心代码
```cpp
void dfs(int x,int k,int sign){
    vis[x]=true;
    long long nl=l-k,nr=r-k; // 解不等式
    if(sign==-1)swap(nl,nr),nl=-nl,nr=-nr;
    ll=max(ll,nl),rr=min(rr,nr); // 更新左极值、右极值
    for(int i=h[x];i;i=e[i].next){
        if(!vis[e[i].to])
            dfs(e[i].to,e[i].w-k,-sign); // 计算k和sign
    }
}
```
**核心实现思想**：通过 dfs 遍历树，将每个点的点权表示为 $k + sign \times x$ 的形式，根据点权范围解不等式，更新 $x$ 的取值范围。

#### MichaelWong 的核心代码
```cpp
void dfs(int u) {
    for(auto i:e[u]){
        int v=i.first,w=i.second;
        if(vis[v]) continue; vis[v]=1;
        if(typ[u]) { // 系数为负
            typ[v]=0; // 子节点系数是其相反数
            val[v]=w-val[u]; // 求解析式
            nowl=std::max(nowl,l-val[v]);
            nowr=std::min(nowr,r-val[v]);
        } // 比较取值范围
        else { // 系数为正
            typ[v]=1;
            val[v]=w-val[u];
            nowl=std::max(nowl,val[v]-r);
            nowr=std::min(nowr,val[v]-l);
        }
        dfs(v);
    }
}
```
**核心实现思想**：通过 dfs 遍历树，根据父节点的系数和边权计算子节点的点权解析式，再根据点权范围更新当前点权的取值范围。

#### wwwwza 的核心代码
```cpp
void dfs(int u){
    int s=l-sum[u][0],t=r-sum[u][0]; // 判断上限和下限
    if(sum[u][1]<0){
        int k=t;
        t=-s;s=-k;
    }
    p=max(p,s);q=min(q,t);
    
    vis[u]=1; // 正常遍历
    for(int i=0;i<g[u].size();i++){
        int v=g[u][i].v,w=g[u][i].w;
        if(vis[v])continue;
        sum[v][0]=w-sum[u][0]; // 算出点v的点权
        sum[v][1]=-sum[u][1];
        dfs(v);
    }
}
```
**核心实现思想**：通过 dfs 遍历树，使用数组 `sum` 存储每个点的点权的常数项和未知数的系数，根据点权范围更新未知数的取值范围。

### 最优关键思路或技巧
- **忽略无边权的边**：将树转化为森林，简化问题，使每棵树的点权计算相互独立。
- **确定一个点的点权**：通过深度优先遍历，将其他点的点权表示为关于该点权的一次函数，将问题转化为解不等式组。
- **取交集确定取值范围**：通过对每个点的点权范围取交集，得到最终的取值范围，进而计算出填写方式的个数。

### 可拓展之处
同类型题或类似算法套路：
- 图的连通性问题：可使用并查集或深度优先搜索判断图的连通性，对不同连通块进行单独处理。
- 线性方程组求解：在确定点权关系时，可将其抽象为线性方程组，使用高斯消元等方法求解。
- 不等式组求解：在计算点权取值范围时，可使用区间合并等方法求解不等式组。

### 推荐题目
- [P1119 灾后重建](https://www.luogu.com.cn/problem/P1119)：涉及图的连通性和最短路径问题。
- [P1341 无序字母对](https://www.luogu.com.cn/problem/P1341)：涉及图的欧拉路径问题。
- [P2678 跳石头](https://www.luogu.com.cn/problem/P2678)：涉及二分查找和不等式求解问题。

### 个人心得
题解中未包含明显的个人心得（调试经历、踩坑教训、顿悟感想等）。 

---
处理用时：35.66秒
# 题目信息

# 「Wdoi-4」芙兰？姆Q！贤者与谜题

## 题目背景

题目背景不包含解题的关键信息，可以跳过。

---

芙兰朵露·斯卡蕾特是曾居住在红魔馆地下室的吸血鬼。与众不同的是，芙兰朵露有着彩色结晶的特殊翅膀，与其他吸血鬼蝙蝠一般的翅膀不同：颜色各异的结晶按照顺序一字排开。

芙兰朵露翅膀的彩色结晶的颜色从内到外分别是天蓝、蓝、紫、粉、橙、黄、淡绿和天蓝。因此事实上，芙兰朵露的翅膀很可能就是帕秋莉的「贤者之石」组成的。

但是芙兰朵露并不关心这些，她只关心排列成翅膀形状的贤者之石之间发生的能量流动——如果一块贤者之石被赋予了能量，就会处于激发态。处于激发态的贤者之石很不稳定——它大量能量的爆发会波及周围的贤者之石，以造成能量的转移。

芙兰朵露非常感兴趣，并以此出了一个谜题来考考帕秋莉。但是作为贤者的帕秋莉不想思考只想摸鱼，于是任务就交给你啦！![](https://www.luogu.com.cn/paste/tkub6dq3)

## 题目描述

芙兰朵露从帕秋莉那里搞来了 $n$ 块贤者之石，并从左往右排成了一列。帕秋莉可以赋予每块贤者之石一定的能级，这会决定贤者之石之间能量的传递。值得注意的是，**能级必须要是正整数，并且不能有两块贤者之石能级相同**。

如果第 $i$ 块贤者之石被赋予了能量（处于激发态），它就会将能量传递给第 $i-1$ 和第 $i+1$ 块里**能级较小**的那一块。特别地，如果某块贤者之石周围只有一块，那么它只会向这一块发送能量。注意，即使第 $i$ 块的能级低于第 $i-1$ 和第 $i+1$ 块，它**照样可以传输能量**。

现在芙兰有 $q$ 个条件——每个条件给定两个正整数 $s,t$，表示如果芙兰激活了第 $s$ 块贤者之石的能量，那么能量最终会经过第 $t$ 块。

然而由于帕秋莉有哮喘的老毛病，设定贤者之石的能级是很费力的。因此，如果存在一种合法的赋予贤者之石能级的方案，请你找出其中**字典序最小**的那个方案。对于两种方案 $A,B$，我们称 $A$ 的字典序小于 $B$，当且仅当存在一个 $p$，使得 $\forall i<p$ 有 $A_i=B_i$，且 $A_p<B_p$。 

如果存在合法方案，请你输出字典序最小的方案；否则输出 `QED`。

## 说明/提示

输入/输出样例 $2$ 见下发的附件 $\textbf{\textit{qed2.in}/\textit{qed2.out}}$。

输入/输出样例 $3$ 见下发的附件 $\textbf{\textit{qed3.in}/\textit{qed3.out}}$。

---

### 数据范围及约定

对于 $100\%$ 的数据，$0\le q \le 3\times 10^5$，$3\le n \le 3\times 10^5$，$1\le s_i,t_i \le n$。

$$
\def{\arraystretch}{1.5}
\begin{array}{|c|c|c|c|} \hline
\textbf{测试点} & \bm{n\le} & \bm{q\le} & \textbf{特殊限制} \cr \hline
1\sim 3 & 7 & 7 & - \cr \hline
4\sim6 & 100 & 100 & - \cr \hline
7 & 10^5 & 1 & -\cr \hline
8\sim 10 & 3\times 10^5 & 3\times 10^5 & s_i\le t_i \cr \hline
11\sim 12 & 10^5 & 10 & - \cr \hline
13\sim 20 & 3\times 10^5 & 3\times 10^5 & -\cr \hline
\end{array}$$


## 样例 #1

### 输入

```
10 4
1 2
3 7
8 10
5 6```

### 输出

```
1 4 8 3 7 2 6 10 5 9```

# AI分析结果

### 综合分析与结论

本题的核心在于如何根据给定的条件构造一个满足能量传递规则的贤者之石能级序列，并且要求字典序最小。题解中主要涉及以下几种思路：

1. **差分数组与贪心结合**：通过差分数组记录条件的影响，然后使用贪心策略构造字典序最小的序列。这种方法在时间和空间复杂度上表现较好，适合处理大规模数据。
2. **拓扑排序与并查集优化**：通过拓扑排序判断是否有解，并使用并查集优化建图过程，减少重复边的生成。这种方法在处理复杂条件时较为高效。
3. **线性模拟与DFS**：通过线性模拟处理条件，使用DFS遍历图并赋值，确保字典序最小。这种方法思路清晰，但可能在处理大规模数据时效率较低。

### 所选高星题解

#### 1. 作者：囧仙 (5星)
- **关键亮点**：使用差分数组记录条件的影响，结合贪心策略构造字典序最小的序列。思路清晰，代码简洁，适合处理大规模数据。
- **核心代码**：
  ```cpp
  up(1,n,i) if(!N[i]){
      int c=1; for(int j=i;A[j]&&j+2<=n;j+=2) ++c;
      up(1,c,j) N[i+2*c-2*j]=++t;
  }
  ```
  **实现思想**：通过差分数组记录条件的影响，然后使用贪心策略从前往后构造字典序最小的序列。

#### 2. 作者：C_liar (4星)
- **关键亮点**：使用拓扑排序判断是否有解，并通过并查集优化建图过程，减少重复边的生成。这种方法在处理复杂条件时较为高效。
- **核心代码**：
  ```cpp
  for(int j=s;j<t;){
      if(j-1==0){j++;continue;} 
      if(d2.getf(j)!=d2.getf(j-1)){
          if(d1.getf(j)==j){
              e.add(j-1,j+1);
              d1.mergef(j,j+1);
              j=d1.getf(j);
          }else{
              j=d1.getf(j);
          }
      }else return puts("QED"),0;
  }
  ```
  **实现思想**：通过并查集优化建图过程，减少重复边的生成，然后使用拓扑排序判断是否有解。

#### 3. 作者：Hanx16Kira (4星)
- **关键亮点**：通过差分数组记录条件的影响，使用贪心策略构造字典序最小的序列。思路清晰，代码简洁，适合处理大规模数据。
- **核心代码**：
  ```cpp
  for(int i=1;i<=n;i++) {
      if(!ans[i]) {
          int c=1;
          for(int j=i;j+2<=n&&A[j];j+=2) c++;
          for(int j=1;j<=c;j++) ans[i+2*c-2*j]=++cnt;
      }
  }
  ```
  **实现思想**：通过差分数组记录条件的影响，然后使用贪心策略从前往后构造字典序最小的序列。

### 最优关键思路与技巧

1. **差分数组**：通过差分数组记录条件的影响，减少重复计算，提高效率。
2. **贪心策略**：从前往后构造字典序最小的序列，确保每一步都选择当前最优的解。
3. **并查集优化**：通过并查集优化建图过程，减少重复边的生成，提高效率。

### 可拓展之处

1. **类似题目**：可以考虑类似的构造序列问题，如给定某些条件，构造满足特定规则的序列。
2. **算法套路**：差分数组、贪心策略、拓扑排序、并查集等算法在类似问题中都有广泛应用。

### 推荐题目

1. [P3243 菜肴制作](https://www.luogu.com.cn/problem/P3243)
2. [P3387 【模板】缩点](https://www.luogu.com.cn/problem/P3387)
3. [P3376 【模板】网络最大流](https://www.luogu.com.cn/problem/P3376)

### 个人心得摘录

- **调试经历**：在处理大规模数据时，差分数组和并查集优化可以显著提高效率，减少重复计算。
- **踩坑教训**：在构造序列时，贪心策略需要确保每一步都选择当前最优的解，否则可能导致无法满足所有条件。
- **顿悟感想**：通过差分数组和贪心策略的结合，可以高效地处理复杂的构造问题，确保字典序最小。

---
处理用时：31.58秒
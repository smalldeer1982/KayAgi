# 题目信息

# 「Wdsr-3」迷途竹林

## 题目背景

迷途竹林是生长着高耸入云的、无边无际的竹子的竹林。由于特殊地势的缘故，所有竹子都向着一侧倾斜生长。由于竹子顶部的叶片交错在一起，因此即使竹子的下端已经被砍掉，仍然会因为其他竹子的相互作用而无法掉落。

作为白玉楼的亭师，白玉楼的实际管家，魂魄妖梦时常需要收集一些竹子用于维修竹制家具以及竹楼。因为她拥有精湛的剑术，因此可以在瞬间砍伐一大片的竹子作为材料。当然，妖梦并不希望拥有过多的竹子。因此她会选择一个多边形区域进行采集。在那一瞬间，妖梦会用楼观剑顺着多边形的边进行砍伐。

不过，由于掉落下来的竹子数量实在太多，因此妖梦无暇统计砍下来的竹子。你能帮帮她吗？

## 题目描述

妖梦在迷途竹林里选定的竹子，可以看作在同一平面上。竹子可以看作有 $+\infty$ 根，每相邻两根竹子间距相等，并且每根竹子的倾斜程度相同。竹子的高度可以看作是无限高。

妖梦选定了一块多边形区域进行竹子的砍伐。**只有在多边形内的部分**才会被收集到。多边形共有 $n$ 条边，为了防止出现歧义，保证任意一条边都不和竹子平行；保证多边形是[简单多边形](https://baike.baidu.com/item/%E7%AE%80%E5%8D%95%E5%A4%9A%E8%BE%B9%E5%BD%A2/18891697)。

我们会使用两个实数 $\theta$ 和 $a$ 来描述这些竹子。这两个字母表示的含义可以参考下图：

![](https://cdn.luogu.com.cn/upload/image_hosting/7j0tx5xy.png)

现在妖梦需要知道她砍下来的竹子的总长度，也就是求出这些竹子（图中橙色的这些线段）的长度之和。

## 说明/提示

#### 样例 1 解释

![](https://cdn.luogu.com.cn/upload/image_hosting/ajm42r7v.png)

容易发现，竹子总长（即橘红色线段的总长度）为 $16\sqrt 2$。

#### 样例 2 解释

![](https://cdn.luogu.com.cn/upload/image_hosting/anqb86a9.png)

我有一个精妙绝伦的方法解释样例 $2$，可惜这里空白太小写不下。

#### 数据范围及约定

$$
\def{\arraystretch}{1.5}
\begin{array}{|c|c|c|c|}\hline
\textbf{Subtask} & \bm{n\le} & \textbf{特殊性质} & \textbf{分值}\cr\hline
1 & 10 & \text{A} & 30 \cr\hline
2 & 10^3 & - & 20 \cr\hline
3 & 10^5 & \text{B} & 20 \cr\hline
4 & 10^5 & - & 30 \cr\hline
\end{array}
$$

**特殊性质** $\textbf{A}$：保证 $\theta\in[80,100);|x_i|,|y_i|\le 10$。  
**特殊性质** $\textbf{B}$：保证 $\theta=90$。

- 对于 $100\%$ 的数据，保证 $3\le n\le 10^5;|x_i|,|y_i|\le 10^4;\theta\in[1,179);\alpha\in[0.1,100]$。输入数据当中出现的浮点数均保留四位小数。

## 样例 #1

### 输入

```
4
2.0000 2.0000
2.0000 -2.0000
-2.0000 -2.0000
-2.0000 2.0000
45.0000 1.0000```

### 输出

```
22.6274169980```

## 样例 #2

### 输入

```
8
0.0000 2.5000
1.0000 1.5000
2.5000 1.0000
2.0000 -1.0000
1.0000 -2.0000
-2.0000 -2.0000
-2.5000 1.0000
-1.0000 2.0000
60.0000 0.8000```

### 输出

```
23.1662217484```

# AI分析结果

### 综合分析与结论

这两篇题解都通过旋转坐标系将问题简化，使得竹子的倾斜方向变为水平，从而更容易计算多边形与竹子的交点。两者的核心思路相似，但在实现细节和代码风格上有所不同。

- **囧仙的题解**：通过旋转坐标系，利用差分思想计算每条边与竹子的交点，最终通过等差数列求和得到总长度。代码较为简洁，思路清晰。
- **I_am_Accepted的题解**：同样通过旋转坐标系，但使用了线性代数中的矩阵变换，并详细处理了精度问题。代码较为冗长，但处理精度问题的细节值得借鉴。

### 所选题解

#### 1. 囧仙的题解（4星）
- **关键亮点**：通过旋转坐标系简化问题，利用差分思想计算交点，代码简洁且思路清晰。
- **个人心得**：作者提到“不旋转坐标系，直接硬上应该也行；我没试过”，这种探索精神值得学习。

**核心代码片段**：
```cpp
up(1,n,i){
    double u,v;
    if(Y[i]<Y[i+1]) u=ceil(Y[i  ]/a)*a,v=floor(Y[i+1]/a)*a;
    else            u=ceil(Y[i+1]/a)*a,v=floor(Y[i  ]/a)*a;
    double x,y,w=(v-u)/a+1;
    x=(u-Y[i])/(Y[i+1]-Y[i])*(X[i+1]-X[i])+X[i];
    y=(v-Y[i])/(Y[i+1]-Y[i])*(X[i+1]-X[i])+X[i];
    if(Y[i]>Y[i+1]) ans+=(x+y)*w/2;
    else            ans-=(x+y)*w/2;
}
```
**核心实现思想**：通过旋转坐标系后，计算每条边与竹子的交点，利用等差数列求和公式计算贡献。

#### 2. I_am_Accepted的题解（4星）
- **关键亮点**：使用线性代数中的矩阵变换旋转坐标系，并详细处理了精度问题，代码虽然冗长但处理精度问题的细节值得借鉴。
- **个人心得**：作者提到“考场上卡精度差点死亡”，强调了处理精度问题的重要性。

**核心代码片段**：
```cpp
inline db qu(pdd x,pdd y,db z){//query x 坐标（取整用）
    db bi=B*(x.sec-z)/(x.sec-y.sec);
    return (x.fir*(B-bi)+y.fir*bi)/B;
}
db calc(int x){//计算一条边的贡献
    pdd s=p[x],t=p[x+1];
    db ss,tt;
    if(s.sec>t.sec){
        ss=floor(s.sec-sm);
        tt=ceil(t.sec-sm);
        if(ss<tt) return 0;
    }else{
        ss=ceil(s.sec+sm);
        tt=floor(t.sec+sm);
        if(ss>tt) return 0;
    }
    pdd sss,ttt;
    sss.fir=qu(s,t,ss);
    sss.sec=ss;
    ttt.fir=qu(s,t,tt);
    ttt.sec=tt;
    s=sss;
    t=ttt;
    int sz=abs(t.sec-s.sec)+1+sm;
    db res=sz*(s.fir+t.fir)/2;
    if(p[x].sec<p[x+1].sec) res*=-1;
    return res;
}
```
**核心实现思想**：通过线性变换旋转坐标系，计算每条边与竹子的交点，并处理精度问题，最终通过等差数列求和计算贡献。

### 最优关键思路或技巧

1. **旋转坐标系**：将竹子的倾斜方向旋转至水平，简化交点计算。
2. **差分思想**：利用差分思想计算每条边与竹子的交点，最终通过等差数列求和得到总长度。
3. **精度处理**：在处理浮点数计算时，通过微调坐标或放大缩小倍数来避免精度问题。

### 可拓展之处

- **类似算法套路**：在处理几何问题时，旋转坐标系是一种常见的简化问题的方法，可以应用于其他涉及斜线或多边形的题目。
- **精度处理**：在涉及浮点数计算的题目中，处理精度问题是一个常见的难点，可以通过微调坐标或放大缩小倍数来解决。

### 推荐题目

1. **洛谷 P1357 矩形切割**：考察几何图形的切割与计算。
2. **洛谷 P1358 矩形覆盖**：考察几何图形的覆盖与计算。
3. **洛谷 P1359 矩形相交**：考察几何图形的相交与计算。

### 个人心得总结

- **探索精神**：在解决问题时，尝试不同的思路和方法，即使有些方法可能不成功，也能从中获得经验。
- **精度处理**：在处理浮点数计算时，精度问题是一个常见的难点，需要特别注意。

---
处理用时：28.81秒
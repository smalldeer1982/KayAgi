# 题目信息

# 「Wdoi-5」模块化核熔炉

## 题目背景

为了通过使用核聚变获得能源，守矢神社在旧地狱修建了巨大的核融合控制中心。控制中心形如双层八卦炉，通过各种电路紧密地调控着核融合的精密运行。获得了八咫鸟力量的阿空会在核反应炉的中心点燃神火。

但是正八边形的八卦炉并不利于进行拓展与维护。为了方便地实现电路，河童打算对核控制中心进行模块化改造，以实现核熔炉的维护。具体而言，河童打算将核控制中心设计成由若干个正六边形组成的巨大结构。

![](https://cdn.luogu.com.cn/upload/image_hosting/ohyfxv02.png)

被赋予了神力的阿空可以依次激发其中的一些模块，而这些被激发的模块会快速影响到一定范围内的其他的模块。通过模块间的链接实现能量的产生。

但是因为阿空脑袋空空，由于它已经激发了多次模块，它已经记不清每个模块当中产生的核融合程度了。你能帮帮它吗？

## 题目描述

核控制中心可以看作由若干个正六边形模块组成的六边形阵列。阵列当中每个模块都可以储存核融合能量（一个非负整数）。左图就是一个核控制中心示意图。

![](https://cdn.luogu.com.cn/upload/image_hosting/78y7b98x.png)

我们使用如下方式对控制中心中每个模块进行标号。

![](https://cdn.luogu.com.cn/upload/image_hosting/9ffz2m5o.png)

以阵列中心为原点延伸出三根射线作为三根轴，每两根轴之间的夹角为 $120\degree$。这三根轴将平面划分为了三个部分。每个模块都可以使用一个三元组 $(x,y,z)$ 描述它的坐标，表示从原点开始按如图所示的 $x,y,z$ 方向各走若干步之后到达的地方。为了防止出现多个坐标表示同一个模块的情况，做出如下规定：原点的坐标为 $(0,0,0)$；对于中心在坐标轴上的模块，它的坐标就是从原点向所在轴走过的距离；对于其他情况，我们将平面划分为了三个区域（如第二张图的红蓝绿三个区域），一个模块的坐标就是沿着它两侧的轴分别需要走的距离。例如模块 $P$ 的坐标为 $(2,4,0)$。容易发现，每个坐标唯一对应一个模块，一个模块唯一对应一个坐标。

同时定义，两个模块的**距离**为从一个模块到另一个模块需要经过模块（包括起点和终点）的最少个数。在第一张图中，红色部分的模块到其中心距离均不超过 $3$，绿色部分的模块到其中心距离均不超过 $3$，而蓝色部分的模块到其中心距离均不超过 $2$。

核控制中心可以视为到达原点距离不超过 $n$ 的模块组成的阵列。现在阿空会执行以下操作 $m$ 次：

- $\colorbox{f0f0f0}{\verb!x y z r k!}$ ：激活坐标为 $(x,y,z)$ 的模块。它会使控制中心中到它距离不超过 $r$ 的**所有**的模块的核融合能量增加 $k$。保证 $(x,y,z)$ 在控制中心当中。

现在需要求出，执行完 $m$ 个操作后，每个模块里核融合能量值。

## 说明/提示

样例 $2$ 见下发的附件 $\textbf{\textit{nuclear2.in/nuclear2.ans}}$。  
样例 $3$ 见下发的附件 $\textbf{\textit{nuclear3.in/nuclear3.ans}}$。满足特殊性质 $\text{A}$（见下文）。  
样例 $4$ 见下发的附件 $\textbf{\textit{nuclear4.in/nuclear4.ans}}$。满足特殊性质 $\text{B}$（见下文）。  
样例 $5$ 见下发的附件 $\textbf{\textit{nuclear5.in/nuclear5.ans}}$。

#### 样例 1 解释

如图所示（所有未标出数字的模块的核融合能量值均为 $0$）：

![](https://cdn.luogu.com.cn/upload/image_hosting/6y7bm2eb.png)



按照从左往右、从上往下的顺序依次输出每个数值，即可得到答案。

#### 数据范围及约定

本题共有 $20$ 个测试点，每个测试点 $5$ 分。最终分数为所有测试点分数之和。

$$
\def\arraystretch{1.5}
\begin{array}{|c|c|c|c|}\hline
\textbf{Task} & \bm{n\le } & \bm{m\le} & \textbf{特殊性质} \cr\hline
1\sim 3 & 10 & 10 & \text{A} \cr\hline
4\sim 7 & 100 & 300 & - \cr\hline
8\sim 10 & 800 & 3\times 10^5 & \text{B} \cr\hline
11\sim 14 & 800 & 3\times 10^5 & \text{A} \cr\hline
15\sim 20 & 800 & 3\times 10^5 & - \cr\hline
\end{array}
$$

**特殊性质** $\textbf{A}$：保证对于第 $i$ 次操作，被激活的模块到控制中心边缘上的模块的距离不小于 $r_i$。  
**特殊性质** $\textbf{B}$：保证对于第 $i$ 次操作，被激活的模块均为 $(0,0,0)$。

对于全部数据，保证 $n\le 800$，$m\le 3\times 10^5$，$1\le k_i\le 5\times 10^3$，$1\le r_i\le 10^9$。每次激活的模块都在控制中心里。

## 样例 #1

### 输入

```
4 3
0 1 1 3 4
3 0 3 3 3
1 0 0 2 2```

### 输出

```
4 4 4 0 4 4 4 4 3 4 4 4 4 7 3 0 4 4 6 9 3 3 0 4 6 6 5 3 0 0 2 2 3 0 0 0 0```

# AI分析结果

### 综合分析与结论

本题的核心在于如何在六边形网格中高效地进行区域加法操作。各题解均采用了**差分+前缀和**的思路，但具体实现方式有所不同。主要难点在于六边形网格的坐标转换和区域加法的处理。以下是对各题解的对比与总结：

1. **坐标转换**：大多数题解通过将六边形网格转换为矩形网格，利用差分和前缀和来优化区域加法操作。常见的转换方式包括左系和右系的坐标转换。
2. **差分与前缀和**：差分用于将区域加法操作转化为单点操作，前缀和用于恢复最终结果。这种方法大大降低了时间复杂度。
3. **边界处理**：在六边形网格中，边界处理较为复杂，部分题解通过拆分为多个矩形区域来处理边界问题。

### 所选高星题解

#### 1. 作者：囧仙 (5星)
- **关键亮点**：
  - 详细解释了六边形网格到矩形网格的坐标转换，提出了左系和右系的概念。
  - 通过拆分六边形区域为多个矩形区域，简化了差分操作。
  - 代码实现清晰，边界处理得当。
- **个人心得**：通过将六边形网格转换为矩形网格，大大简化了问题的复杂度，体现了坐标转换在解决复杂问题中的重要性。

```cpp
void cnv1(int a,int b,int c,int &x,int &y){  //左系
    x=a-c+n,y=b-a+n;
}
void cnv2(int a,int b,int c,int &x,int &y){  //右系
    x=a-c+n,y=b-c+n;
}
```

#### 2. 作者：zhongcy (4星)
- **关键亮点**：
  - 详细介绍了二维差分的应用，并将其扩展到六边形网格中。
  - 通过坐标转换将六边形网格的加法操作转化为矩形网格的差分操作。
  - 代码实现简洁，时间复杂度优化得当。
- **个人心得**：通过将六边形网格的加法操作转化为矩形网格的差分操作，大大降低了时间复杂度，体现了差分在区域操作中的高效性。

```cpp
int A[MAXN*2][MAXN*2],B[MAXN*2][MAXN*2];
```

#### 3. 作者：minstdfx (4星)
- **关键亮点**：
  - 提出了斜坐标系的概念，将六边形网格的加法操作转化为斜坐标系下的矩形加法。
  - 通过拆分为三个不同坐标系下的矩形加法和一个单点修改，简化了操作。
  - 代码实现较为复杂，但思路清晰。
- **个人心得**：通过斜坐标系的引入，将六边形网格的加法操作转化为矩形网格的差分操作，体现了坐标系转换在解决复杂问题中的重要性。

```python
def Accumulate(p, k):
    p = p.toXY()
    if not(-n <= p.y <= n and -n <= p.x <= n):
        return
    if p.x * p.y < 0 and MyAbs(p.x) + MyAbs(p.y) > n:
        return
    _ans[_Gas[p.x + n + 1][p.y + n + 1]] += k
```

### 最优关键思路与技巧

1. **坐标转换**：将六边形网格转换为矩形网格，简化了区域加法操作。
2. **差分与前缀和**：通过差分将区域加法操作转化为单点操作，前缀和用于恢复最终结果，大大降低了时间复杂度。
3. **边界处理**：通过拆分为多个矩形区域，简化了边界处理。

### 可拓展之处

- **类似算法套路**：在处理复杂网格（如三角形网格、六边形网格）时，可以考虑通过坐标转换将其转化为矩形网格，利用差分和前缀和进行优化。
- **同类型题目**：可以尝试解决其他涉及复杂网格的区域操作问题，如三角形网格的区域加法、六边形网格的区域查询等。

### 推荐题目

1. **P3397 地毯**：二维差分与前缀和的应用。
2. **P2280 [HNOI2003]激光炸弹**：二维前缀和的应用。
3. **P2216 [HAOI2007]理想的正方形**：二维滑动窗口与前缀和的应用。

### 个人心得总结

- **调试经历**：在处理六边形网格的边界问题时，通过拆分为多个矩形区域，简化了边界处理。
- **踩坑教训**：在坐标转换时，需要特别注意边界条件的处理，避免出现越界或重复计算的情况。
- **顿悟感想**：通过将复杂问题转化为简单问题，利用已有的算法（如差分和前缀和）进行优化，可以大大提高解题效率。

---
处理用时：30.77秒
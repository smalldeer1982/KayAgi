# 题目信息

# 小A和uim之大逃离 II

## 题目背景

话说上回……还是参见 <https://www.luogu.com.cn/problem/P1373> 吧

小 a 和 uim 再次来到雨林中探险。突然一阵南风吹来，一片乌云从南部天边急涌过来，还伴着一道道闪电，一阵阵雷声。刹那间，狂风大作，乌云布满了天空，紧接着豆大的雨点从天空中打落下来，只见前方出现了一个牛头马面的怪物，低沉着声音说：“呵呵，既然你们来到这，两个都别活了！”。小 a 和他的小伙伴再次惊呆了！


## 题目描述

瞬间，地面上出现了一个 $H$ 行 $W$ 列的巨幅矩阵，矩阵的每个格子上要么是空地 `.` 或者障碍 `#`。

他们起点在 $(1,1)$，要逃往 $(H,W)$ 的出口。他们可以一次向上下左右移动一格，这个算一步操作。不过他们还保留着上次冒险时收集的魔液，一口气喝掉后可以瞬移到相对自己位置的 $(D,R)$ 向量；也就是说，原来的位置是 $(x,y)$，然后新的位置是 $(x+D,y+R)$，这个也算一步操作，不过他们仅能至多进行一次这种操作（当然可以不喝魔液）。

这个地方是个是非之地。所以他们希望知道最小能有几步操作可以离开这个鬼地方。不过他们可能逃不出这个鬼地方，遇到这种情况，只能等死，别无他法。


## 说明/提示

样例解释 $1$

$(1,1) \to (1,2)\to (1,3)\to$ 喝魔液 $\to (3,4)\to (3,5)\to (3,6)$。

样例解释 $2$

因为只有一瓶魔液所以他们没办法逃出来。

样例解释 $3$

$D$ 和 $R$ 还可以是 $0$或者负数。

数据范围与约定

$40\%$ 的测试数据 $2\leq H,W\leq 5$。

$70\%$ 的测试数据 $2\leq H,W\leq 100$。

$100\%$ 的测试数据 $2\leq H,W\leq 1000,|D|<H,|R|<W$。

## 样例 #1

### 输入

```
3 6 2 1
...#..
..##..
..#...```

### 输出

```
5
```

## 样例 #2

### 输入

```
3 7 2 1
..#..#.
.##.##.
.#..#..```

### 输出

```
-1```

## 样例 #3

### 输入

```
6 6 -2 0
.#....
.#.#..
.####.
.#..#.
.##.#.
....#.```

### 输出

```
21```

# AI分析结果

### 综合分析与结论

本题的核心是通过BFS求解在迷宫中从起点到终点的最短路径，且允许使用一次瞬移（喝魔液）。大部分题解都采用了BFS算法，并通过三维数组（或类似结构）来记录是否使用过魔液的状态。以下是各题解的主要思路和优化点：

1. **BFS + 状态记录**：大多数题解通过BFS遍历迷宫，并使用三维数组（如`step[x][y][0/1]`）来记录是否使用过魔液的状态。这种方法能够有效区分使用魔液前后的路径，确保只使用一次魔液。
  
2. **双向BFS**：部分题解（如AuCloud的题解）采用了双向BFS，分别从起点和终点进行搜索，最后通过枚举所有可能的瞬移点来计算最短路径。这种方法在某些情况下可以减少搜索空间，但实现复杂度较高。

3. **优化与剪枝**：一些题解通过剪枝或优化（如提前判断瞬移后的位置是否合法）来减少不必要的搜索，提升算法效率。

4. **代码实现与可读性**：部分题解的代码实现较为简洁，逻辑清晰，易于理解；而有些题解的代码较为冗长，可读性较差。

### 所选高星题解

#### 1. **x_faraway_x (5星)**
- **关键亮点**：思路清晰，代码简洁，使用三维数组记录状态，逻辑明确。
- **代码核心**：
  ```cpp
  int st[N][N][2]; // 记录步数
  struct Point { int x, y, u; }; // u表示是否使用过魔液
  ```
  **核心思想**：通过BFS遍历迷宫，使用三维数组记录是否使用过魔液的状态，确保只使用一次魔液。

#### 2. **AuCloud (4星)**
- **关键亮点**：采用双向BFS，分别从起点和终点进行搜索，最后通过枚举瞬移点计算最短路径。
- **代码核心**：
  ```cpp
  void bfs1() { /* 从起点BFS */ }
  void bfs2() { /* 从终点BFS */ }
  int ans = min(a[i][j] + b[i+d][j+r] + 1); // 计算最短路径
  ```
  **核心思想**：通过双向BFS减少搜索空间，最后通过枚举瞬移点计算最短路径。

#### 3. **amstar (4星)**
- **关键亮点**：代码实现简洁，使用三维数组记录状态，逻辑清晰。
- **代码核心**：
  ```cpp
  bool v[MAXN][MAXN][2]; // 记录是否访问过
  struct node { int x, y, step, flag; }; // flag表示是否使用过魔液
  ```
  **核心思想**：通过BFS遍历迷宫，使用三维数组记录是否使用过魔液的状态，确保只使用一次魔液。

### 最优关键思路与技巧

1. **三维状态记录**：通过三维数组（如`step[x][y][0/1]`）记录是否使用过魔液的状态，确保只使用一次魔液。
2. **双向BFS**：在某些情况下，双向BFS可以减少搜索空间，提升算法效率。
3. **剪枝与优化**：通过提前判断瞬移后的位置是否合法，减少不必要的搜索。

### 可拓展之处

1. **类似题目**：可以扩展到允许使用多次瞬移的情况，或者瞬移的代价不同。
2. **其他算法**：可以考虑使用A*算法或其他启发式搜索算法来进一步优化搜索效率。

### 推荐题目

1. **P1373**：小A和uim之大逃离 I（类似迷宫问题）
2. **P1443**：马的遍历（BFS应用）
3. **P1162**：填涂颜色（BFS应用）

### 个人心得摘录

- **x_faraway_x**：建议先根据思路自己写代码，避免直接复制代码。
- **AuCloud**：强调双向BFS的优势，减少搜索空间。
- **amstar**：提醒数组大小要开足够，避免RE。

这些心得对理解题目和调试代码有较大帮助。

---
处理用时：31.89秒
# 题目信息

# 『PG2』弯曲半平面直线同向图最大流

## 题目描述

若能将有向图 $G=(V,E)$ 画在平面上，使得点在一条直线上，任意两条边（可以为弯曲的弧线）仅在重合顶点处相交，且边上的所有点都在直线同侧，且每条边的起点到终点的射线的方向相同，则称 $G$ 是弯曲半平面直线同向图。对于一个弯曲半平面直线同向图给定 $n$ 个点，$m$ 条有向边，给定每条边的容量，求从点 $s$ 到点 $t$ 的最大流。

## 说明/提示

无重边自环。

对于 $30\%$ 的数据 $n\leq 10^3$。

对于 $70\%$ 的数据 $n\leq 10^5$。

对于 $100\%$ 的数据 $2\leq n\leq 10^6$，$1\leq m\leq \min\{2\times 10^9,\dfrac{n(n-1)}{2}\}$，$1\leq c\leq 10^{12}$，$s\neq t$。

### 样例解释 1
![](https://cdn.luogu.com.cn/upload/image_hosting/9qletk0m.png)

## 样例 #1

### 输入

```
5 7 1 5
1 2 1
2 3 1
3 4 1
4 5 1
2 4 1
1 4 1
1 5 1```

### 输出

```
2```

# AI分析结果

### 综合分析与结论
1. **思路对比**：
    - **xixisuper**：先确定图为有向无环图，通过两次dfs标记从源点能走到且能走到汇点的点。利用图的性质得出贪心思路，即按拓扑序遍历，优先把流量灌给拓扑序大的点。通过返图重建正图优化排序，将时间复杂度从$O(n\log n)$优化到$O(n)$。
    - **phigy（30分）**：直接使用常用最大流算法，适用于部分数据。
    - **phigy（70分）**：认识到是边拓扑序不交叉的DAG上的最大流，每次往不超过$T$的拓扑序最大的点尽可能推流，时间复杂度$O(n\log n)$。
    - **phigy（100分）**：从拓扑序较大的点往较小的点的队列中存放边实现排序，优化到$O(n)$。
    - **P_Bisector**：先去掉无关点，拓扑排序后分治处理每段弧下的最大流，时间复杂度$O(n)$，但瓶颈在排序。
    - **qczrz6v4nhp6u**：将图看作DAG，保留$s$能到达且能到达$t$的点，按拓扑序重标号。通过最大流转最小割，将问题转化为区间覆盖，用差分求解，时间复杂度$O(n)$。
2. **算法要点**：
    - 都利用了图为有向无环图（DAG）的性质，进行拓扑排序。
    - 除30分做法外，其他高分做法都基于图的特殊性质优化最大流求解过程。
3. **解决难点**：
    - 理解并利用弯曲半平面直线同向图的边不交叉性质，优化最大流算法。
    - 优化时间复杂度，避免因排序等操作导致超时。

### 题解推荐
1. **xixisuper（4星）**
    - **关键亮点**：思路清晰，先分析图的性质得出贪心策略，再通过巧妙的返图重建正图优化时间复杂度，同时给出了详细的常数优化建议。
    - **个人心得**：作者提到因低估`vector`常数导致卡T，花费一上午调试，强调了常数优化在算法实现中的重要性。
    - **核心代码片段**：
```cpp
// 拓扑排序及相关处理
for(ll i=1;i<=n;i++) if(!in[i]) q[rear++]=i; 
while(front<rear){
    ll now=q[front++];
    if(vis[now]==2){
        cnt++;
        ni_tupo[cnt]=now;
    }
    for(register ll i=head[0][now];i;i=zh[0][i].nxt){
        in[zh[0][i].v]--;
        if(!in[zh[0][i].v]) q[rear++]=zh[0][i].v;
    }
}
// 重建图
for(ll i=1;i<=cnt;i++){
    for(ll j=head[1][ni_tupo[i]];j;j=zh[1][j].nxt){
        if(vis[zh[1][j].v]!=2) continue;
        add_edge(2,zh[1][j].v,ni_tupo[i],zh[1][j].c);
    }
}
// 贪心推流
f[s]=INF*INF;
for(ll i=1;i<=cnt;i++){
    for(ll j=head[2][ni_tupo[i]];j;j=zh[2][j].nxt){
        if(vis[zh[2][j].v]!=2) continue;
        f[zh[2][j].v]+=min(zh[2][j].c,f[ni_tupo[i]]);
        f[ni_tupo[i]]-=min(zh[2][j].c,f[ni_tupo[i]]);
        if(!f[ni_tupo[i]]) break;
    }
}
```
2. **phigy（100分）（4星）**
    - **关键亮点**：从拓扑序较大的点往较小的点的队列中存放边实现排序，简洁高效地将时间复杂度优化到$O(n)$，代码实现清晰。
    - **核心代码片段**：
```cpp
// 拓扑排序
queue<int> q;
for(int i = 1; i <= n; i++) if(!in[i]) q.push(i);
while(!q.empty()){
    int u = q.front(); q.pop();
    id[u] = ++cnt;
    for(int v: g[u]){
        in[v]--;
        if(!in[v]) q.push(v);
    }
}
// 重新构建边的存储
for(auto [u, v, c]: edges){
    buc[id[v]].emplace_back(id[u], c);
}
for(int i = n; i >= 1; i--){
    for(auto [u, c]: buc[i]) to[u].emplace_back(i, c);
}
// 推流
flow[id[s]] = 1e18;
for(int i = 1; i <= n; i++){
    if(i == id[t]){
        write(flow[i]);
        return;
    }
    for(auto [v, c]: to[i]){
        if(v > id[t]) continue;
        if(!flow[i]) break;
        ll tmp = min(flow[i], c);
        flow[v] += tmp;
        flow[i] -= tmp;
    }
}
```
3. **qczrz6v4nhp6u（4星）**
    - **关键亮点**：通过最大流转最小割的思想，将问题转化为区间覆盖问题，利用差分求解，思路新颖独特。
    - **核心代码片段**：
```cpp
// 反拓扑序标记能到达的点
void dfs1(int x){ 
    if(dfn1[x])return;
    for(int k=Gr1.last[x],y;y=Gr1[k].y,k;k=Gr1[k].pre)
        dfs1(y);
    dfn1[x]=++dfc1;
}
void dfs2(int x){
    if(dfn2[x])return;
    for(int k=Gr2.last[x],y;y=Gr2[k].y,k;k=Gr2[k].pre)
        dfs2(y);
    dfn2[x]=++dfc2;
}
// 差分处理
for(int i=1;i<=m;i++){
    int u=e[i].u,v=e[i].v;ll w=e[i].w;
    if(ck[u]&&ck[v])
        sum[dfn2[u]]+=w,sum[dfn2[v]]-=w;
}
// 计算最小割
ll ans=numeric_limits<ll>::max();
for(int i=dfn2[s];i<dfn2[t];i++)
    ans=min(ans,sum[i]+=sum[i-1]);
```

### 最优关键思路或技巧
1. **利用图的特殊性质**：如弯曲半平面直线同向图边不交叉的性质，结合DAG的拓扑序进行贪心策略设计。
2. **优化排序操作**：通过特定方式重建图，避免每次贪心推流时的排序操作，降低时间复杂度。
3. **转换问题视角**：如将最大流问题转化为最小割问题，再转化为区间覆盖问题，用差分求解。

### 可拓展思路
此类题目拓展方向主要是在图的特殊性质与最大流算法结合上。例如，研究不同限制条件下的平面图最大流问题，或者在有向无环图的基础上增加一些特殊边的性质，进一步优化最大流求解算法。

### 相似知识点洛谷题目
1. **P3376 【模板】网络最大流**：基础的最大流模板题，可用于巩固最大流算法的实现。
2. **P2756 飞行员配对方案问题**：二分图最大匹配问题，与最大流密切相关，可加深对网络流模型的理解。
3. **P1345 [USACO5.4]奶牛的电信Telecowmunication**：涉及到最小割问题，与本题将最大流转化为最小割的思路相关。 

---
处理用时：68.67秒
# 题目信息

# [POI 2004] SZP

## 题目背景

一班班花 [$\color{red}{\texttt{y}}\color{black}{\texttt{hb}}$](/user/835809) 十分可爱。

## 题目描述

班花 [$\color{red}{\texttt{y}}\color{black}{\texttt{hb}}$](/user/835809) 作为某日的值日班长，在自习课上管理着 $n$ 名同学。除了她以外每一名同学都监视着另一名同学。现在班花 [$\color{red}{\texttt{y}}\color{black}{\texttt{hb}}$](/user/835809) 需要选择尽量多的同学去搬卷子和答题卡，且使得对于这些同学中的每一名同学，至少有一位监视她的同学没有被选中。问班花 [$\color{red}{\texttt{y}}\color{black}{\texttt{hb}}$](/user/835809) 最多可以选择多少同学。

由于班花 [$\color{red}{\texttt{y}}\color{black}{\texttt{hb}}$](/user/835809) 太可爱了，所以没有人监视她，也可以认为她的学号是 $0$。

如果一个人没有被监视，那么她就不能被选择。


## 说明/提示

对于 $100\%$ 的数据，$1\le k,a_k\le n\le 10^6$。

## 样例 #1

### 输入

```
6
2
3
1
3
6
5
```

### 输出

```
3```

# AI分析结果



### 综合分析与结论
该题核心是处理基环树森林结构，通过拓扑排序处理链部分，剩余环结构取半。关键难点在于处理环与链的衔接，以及贪心策略的正确性证明。题解主要分为两类：拓扑+贪心（处理环）和基环树DP。前者时间复杂度更优，后者适用性更广但实现较复杂。

---

### 精选题解（评分≥4星）

#### 1. 作者：wyd_is_JOKER（★★★★★）
**核心亮点**：
- 清晰的拓扑排序框架处理链式结构
- 环处理策略：遍历未标记节点，每段环贡献长度一半
- 代码中`vis`数组与`choose`数组分离设计，避免状态冲突
**关键代码**：
```cpp
// 拓扑处理链结构
while(!Q.empty()) {
    int u = Q.front(); Q.pop();
    if (!choose[u] && !choose[ak[u]]) { // 未选则强制选后继
        choose[ak[u]] = 1;
        ans++;
        Q.push(ak[u]);
    }
}
// 处理剩余环
for(int i=1;i<=n;i++) if(!vis[i]) {
    int cnt = 0;
    while(!vis[j]) { // 遍历整个环
        if(!choose[j] && !choose[ak[j]]) 
            ans++, choose[ak[j]] = 1;
        j = ak[j];
    }
    ans += cnt/2;
}
```

#### 2. 作者：zac2010（★★★★☆）
**核心亮点**：
- 基环树DP的标准解法，断开环边两次DP取最优
- 状态转移方程优化：`f[x][1] = f[x][0] - min_delta + 1`
**关键实现**：
```cpp
void dfs(int x, int pos) {
    int mx = -INF;
    for(auto v : e[x]) {
        dfs(v, pos);
        f[x][0] += max(f[v][0], f[v][1]);
        mx = max(mx, f[v][0] - max(f[v][0], f[v][1]));
    }
    f[x][1] = f[x][0] + mx + (x != pos || !flag);
}
// 断环处理
for(auto u : rt) {
    dfs(u, a[u]); // 不选断边点
    dfs(a[u], a[u]); // 选断边点
    ans += max(..., ...);
}
```

#### 3. 作者：int_R（★★★★☆）
**独特贡献**：
- 破环成链时处理起始点选择冲突
- 使用两个状态数组`b[]`（外部影响）和`f[]`（当前选择）
**调试经验**：
> 原错误代码直接统计总环点数除二，忽略了各环独立。正确应单独处理每个环

---

### 关键思路总结
1. **拓扑去链**：所有入度为0的节点不可选，其后续节点必选，形成链式处理
2. **环处理定理**：长度为k的环最多选⌊k/2⌋个节点
3. **状态标记分离**：`vis[]`记录拓扑处理状态，`choose[]`记录选择状态，避免循环判断
4. **基环树DP技巧**：任选环边断开，分选/不选两种情况DP

---

### 相似题目推荐
1. [P2607 [ZJOI2008] 骑士](https://www.luogu.com.cn/problem/P2607)  
   （基环树DP经典题）
2. [P1453 城市环路](https://www.luogu.com.cn/problem/P1453)  
   （基环树+拆环DP）
3. [P4381 [IOI2008] Island](https://www.luogu.com.cn/problem/P4381)  
   （基环森林直径问题）

---

### 调试经验摘录
1. **fishing_cat**：  
   > 错误统计总环点数直接除二，导致多个奇数环时出错。正确应单独处理每个环
2. **Atserckcn**：  
   > 环示例分析发现连续选2人会导致监视链断裂，得出必须隔选的结论
3. **zac2010**：  
   > DP转移时需维护`min_delta`，确保至少有一个子节点不选

---
处理用时：66.66秒
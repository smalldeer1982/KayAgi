# 题目信息

# [TJOI2009] 宝藏

## 题目描述

为了寻找传说中的宝藏，小明走进了一个迷宫，我们用一个 $r$ 行 $c$ 列的矩阵来描述这个迷宫，矩阵的每个位置表示一个方块区域：

- 字符 `.` 表示可以通过的方格。
- 字符 `#` 表示不能通过的方格。
- 在迷宫中有 $k$ 个机关，第 $i$ 个机关工作方式为：  
  - 每当小明走上第 $r_i$ 行，$c_i$ 列的格子时，位于第 $R_i$ 行，$C_i$ 列的格子改变状态（如果这个格子此时可以通过，此后就变为不能通过；如果此时不能通过，此后可以通过。最左上角的格子是第 $1$ 行第 $1$ 列）。

现给出当前小明的位置，宝藏的位置，迷宫中每个格子的状态，以及所有机关的描述，问小明至少还要走多少步才能拿到宝藏（不能走出迷宫的边界，在开始时刻，小明和宝藏所在的位置都是可以通过的，机关不会出现在起点和终点，也不会影响这两个格子）。


## 说明/提示

### 数据范围及约定

对于全部数据，$5 \le r, c \le 30$，$0 \le k \le 10$，$1 \le r_i,R_i\le r$，$1 \le c_i,C_i \le c$。


## 样例 #1

### 输入

```
5 5
S.#..
#####
..#..
##.#.
...#T
6
1 5 4 2
1 4 3 3
5 1 3 3
1 4 4 5
1 2 1 3
1 5 2 1
```

### 输出

```
22```

# AI分析结果



### 综合分析与结论
本题核心在于处理动态变化的迷宫状态，各题解均采用 **BFS + 状态压缩** 的核心思路。关键点包括：
1. **状态表示**：用二进制位压缩机关触发奇偶次数（k≤10，状态数仅2^10=1024）
2. **动态判断**：根据当前状态计算每个格子的实际通行性
3. **记忆化搜索**：记录每个坐标+状态组合是否已访问，避免重复扩展

所有题解均能正确解决问题，差异主要体现在代码实现细节优化和可读性上。高质量题解需满足：清晰的位运算处理、高效的状态更新、简洁的条件判断。

---

### 高星题解推荐

#### 1. 作者：lenlen（⭐⭐⭐⭐⭐）
**关键亮点**：
- 代码简洁高效，直接通过异或操作更新状态
- 统一处理触发机关和判断通行性，逻辑清晰
- 使用独立结构体存储状态，可读性强

**核心代码思路**：
```cpp
struct len { int x,y,dep,k; }; // 状态结构体
// 判断格子是否可通行
int flag = (原格子状态);
for 每个机关:
    if 当前格子是机关影响的格子且状态位为1: flag ^= 1;
// 更新触发状态
int kk = tmp.k;
for 每个机关:
    if 当前格子是触发机关的位置: kk ^= (1<<j);
```

#### 2. 作者：unsigned_short_int（⭐⭐⭐⭐）
**关键亮点**：
- 分离判断函数提高可维护性
- 使用独立函数处理状态更新和通行判断
- 提前计算所有可能状态的最优解

**核心优化点**：
```cpp
inline bool check(int x,int y,int st) {
    bool ret = 原地图状态;
    for 每个机关:
        if 机关影响该点且状态位为1: ret ^= 1;
    return ret;
}
```

#### 3. 作者：wfc284（⭐⭐⭐）
**特色处理**：
- 预处理所有可能的地图状态
- 独立处理触发机关和状态更新阶段
- 更易理解的二进制位操作注释

---

### 关键技巧总结
1. **状态压缩**：用整数的二进制位表示机关触发次数奇偶性（奇数次有效）
2. **异或运算**：快速切换机关状态 `state ^= (1<<id)`
3. **复合状态判重**：三维数组 `vis[x][y][state]` 避免重复搜索
4. **动态通行计算**：综合原始地图和当前机关状态判断能否通过

---

### 易错点与个人心得
1. **起点终点处理**：需确保起点终点不受机关影响（题目明确说明）
2. **复合格子判断**：同一个格子可能同时是触发点和被影响点
3. **状态更新顺序**：先判断通行性，再更新触发状态（否则可能影响后续判断）
4. **位运算优先级**：`(state >> j) & 1` 必须加括号

---

### 推荐相似题目
1. [P2622 关灯问题II](https://www.luogu.com.cn/problem/P2622)  
   **相似点**：状态压缩BFS，多个开关组合影响状态
2. [P4011 孤岛营救问题](https://www.luogu.com.cn/problem/P4011)  
   **相似点**：钥匙-门机制，多维状态压缩
3. [P2107 小Z的AK计划](https://www.luogu.com.cn/problem/P2107)  
   **相似点**：动态状态转移，BFS与位运算结合

---
处理用时：54.60秒
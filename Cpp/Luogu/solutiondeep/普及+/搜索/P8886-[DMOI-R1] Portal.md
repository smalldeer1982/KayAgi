# 题目信息

# [DMOI-R1] Portal

## 题目背景

出题人正在玩一款叫 Portal 的游戏。但由于他太菜了，于是找来了你，让你帮他过几个他过不去的关卡。

什么？你说你不会玩？

玩家需要通过传送门枪到达出口。利用传送门枪射击可开出两种门，分别是橙色门和蓝色门，两面都可作入口及出口。在创造门的时候，另一道同样颜色的门会消失，即是说同时间不可能存在两道同色的门，最多只可同时存在一道蓝色及一道橙色的门。

两道传送门在三维空间之中的两个地点创造出视觉上及物理上的连系，传送门的立点只限于平面，玩家从门出来时会自动配合地心吸力调整身体水平。

出题人把所有希望都寄托于你身上了哟。哦，对了，因为出题人是个白嫖党，因此他拥有的是盗版 Portal。

## 题目描述

在一个 $n \times n$ 的二维平面图上，用 $(x,y)$ 表示地图第 $x$ 行第 $y$ 列。每个点都是墙、虚空和地面中的一种，分别用 `#`，`*`，`.` 表示。玩家只能站在地面上。**地图之外都是墙。**

你手里有一个传送门枪，可以发射蓝色和橙色的传送门，只能朝上下左右四个方向使用。

在选定一个方向和颜色后，将会在该方向上第一个碰到的墙的墙面上建造选定颜色的传送门，并摧毁之前建造的这种颜色的传送门。两种颜色的传送门不能被建立在同一墙面。

玩家可以朝上下左右四个方向的空地移动。玩家还可以在不同色传送门之间穿梭。假如玩家朝一堵墙移动并且墙面上有传送门，并且当前已经建立了两个传送门，那么会从另一个传送门出来（必须保证出来也站在陆地上）。

出来的时候，玩家会站在另一个门外的空地上，**四个方向都可以。**

一开始玩家站在 $(1,1)$，目的地是 $(n,n)$。求最少使用多少次传送门枪才能到达目的地。

**注意哦，这里的使用指的是穿过多少面传送门。**

## 说明/提示

### 样例1解释

我们用白色格子表示空地，黑色格子表示墙，蓝色格子表示蓝色传送门，橙色格子表示橙色传送门，可以画出第一局的如下地图：

![](https://cdn.luogu.com.cn/upload/image_hosting/s16tq3vq.png)

走到橙色传送门处，从橙色传送门进入，蓝色传送门出即可。

而第二局地图如下：

![](https://cdn.luogu.com.cn/upload/image_hosting/v7q0izdk.png)


走到蓝色传送门处，从蓝色传送门进入，橙色传送门出即可。

### 数据范围

对于 $20\%$ 的数据，$n \le 10$。

对于 $60\%$ 的数据，$n \le 100$。

对于另外 $10\%$ 的数据，$T=1$ 且不存在虚空。

对于 $100\%$ 的数据，$2 \le n \le 500$，$1 \le T \le 10$。

## 样例 #1

### 输入

```
2
5
..###
#.#.#
#..##
...#.
.###.
5
..#..
##..#
#.#..
..#..
.#...```

### 输出

```
2
2```

## 样例 #2

### 输入

```
4
5
...*.
*##*.
#..*.
#*###
.....
5
.#*..
.**.#
###.*
***.*
**...
5
.**..
***.#
###.*
***.*
*****
5
.**..
***.#
###..
***.*
***..```

### 输出

```
4
2
```

## 样例 #3

### 输入

```
见下发文件portal1.in```

### 输出

```
见下发文件portal1.ans```

## 样例 #4

### 输入

```
见下发文件portal2.in```

### 输出

```
见下发文件portal2.ans```

# AI分析结果



### 综合分析与结论
本题核心在于通过抽象连通块关系建模图结构，利用最短路算法求解传送门使用次数。两个题解均采用图论思路，但实现策略差异显著。官方题解通过连通块划分大幅减少节点规模，结合有向边判定实现高效求解；SteveHans题解直接以网格点为节点，存在边数爆炸风险，但提供更直观的建模思路。

---

### 高星题解推荐

#### 题解1：DMOI官方题解（4星）
**关键亮点**  
1. **连通块抽象**：将相邻空地划分为连通块，极大减少图的节点数量（从O(n²)降至O(k)）  
2. **墙面可达性分析**：通过预处理每个连通块唯一可用的墙面，建立有向边判定逻辑  
3. **高效图构建**：利用映射去重确保边不重复，优先队列优化Dijkstra实现快速最短路查询  
**个人心得**  
作者提及调试中发现原始std存在漏洞，但最终通过系统化的边界处理确保正确性，强调了对"同一墙面双色门"等特殊情况的处理

**核心代码思想**  
```cpp
// 连通块划分（BFS）
for(每个未标记空地){
    BFS标记所有相邻空地为一个连通块
}

// 墙面可达性预处理
for(每个连通块){
    检查四周墙面是否唯一，记录唯一墙面坐标或标记为多墙面
}

// 建立有向边
for(每个墙面){
    收集相邻四个方向的连通块
    沿墙面四向延伸，为可到达的连通块建立有向边
}

// Dijkstra求最短路
priority_queue实现松弛操作
```

#### 题解2：SteveHans题解（3星）  
**可取之处**  
1. **直观建模**：直接将网格点映射为节点，简化问题理解  
2. **双端队列优化**：利用0-1 BFS处理边权特性提升效率  
**局限**：n=500时节点数达25万，建图过程时间复杂度达O(n³)难以通过

---

### 最优思路提炼
1. **连通块划分**：将连续空地视为同一节点，减少状态空间  
2. **墙面穿透规则**：  
   - 仅当两连通块共享唯一隔离墙时可建立双向传送  
   - 虚空区域不影响传送路径，但限制玩家移动  
3. **分层图思想**：将传送行为抽象为跨连通块边，边权为使用次数  
4. **预处理优化**：提前计算各连通块可用墙面，避免重复判断  

---

### 相似题目推荐
1. **P1141 01迷宫**（连通块预处理+快速查询）  
2. **P2296 寻找道路**（图论预处理+可达性分析）  
3. **P3958 奶酪**（三维连通性+空间抽象建模）  

---

### 关键实现代码（DMOI官方题解）
```cpp
// 连通块划分与墙面预处理
void bfs() {
    int cnt = 0;
    for(int i=1; i<=n; ++i) {
        for(int j=1; j<=n; ++j) {
            if(s[i][j]=='.' && !col[i][j]) {
                // BFS标记连通块
                ...
                // 记录各连通块唯一可用墙面
                if(s[i-1][j]=='#') update_wall(...);
                ...
            }
        }
    }
}

// 墙处理与建边
for(int i=0; i<=n+1; ++i) {
    for(int j=0; j<=n+1; ++j) {
        if(s[i][j] == '#') {
            // 收集相邻连通块
            ...
            // 四向延伸建边
            for(int k方向延伸){
                if(当前网格为有效连通块){
                    for(相邻连通块){
                        if(满足墙面唯一条件)
                            add有向边
                    }
                }
            }
        }
    }
}

// 最短路求解
priority_queue<pair<int,int>> q;
q.push({0,起点块});
while(!q.empty()) {
    auto [d,u] = q.top(); q.pop();
    for(所有邻接块v){
        if(dis[v] > dis[u]+1) {
            dis[v] = dis[u]+1;
            q.push({-dis[v],v});
        }
    }
}
```

---
处理用时：76.26秒
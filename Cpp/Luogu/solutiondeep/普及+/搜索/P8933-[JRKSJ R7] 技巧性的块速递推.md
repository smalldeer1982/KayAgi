# 题目信息

# [JRKSJ R7] 技巧性的块速递推

## 题目背景

充分必要，切比雪夫。

原来还是，不需要了。

## 题目描述

一个 $n\times m$ 的棋盘，对每个格子染上黑白两色之一。

询问有多少种染色方式，使得不存在横、竖、斜连续四个格子中存在至少三个相同颜色的格子，并且不存在横、竖、斜连续三个格子的颜色相同。

若设棋盘的左上角为 $(1,1)$，右下角为 $(n,m)$，则称 $\{(x,y),(x+1,y),(x+2,y)\}$ 为横的连续三个格子，$\{(x,y),(x,y+1),(x,y+2)\}$ 为竖的连续三个格子、$\{(x,y),(x+1,y+1),(x+2,y+2)\}$ 和 $\{(x,y),(x+1,y-1),(x+2,y-2)\}$ 为斜的连续三个格子（以上格子均在棋盘内）。

连续四个格子同理。

## 说明/提示

### 样例解释

样例 $1$：显然任意染色均合法，答案为 $2^4=16$。

样例 $2$：

```
101
110
010
```

这是合法方案之一。

```
111
110
011
```

这是不合法方案之一，因为 $\{(1,1),(1,2),(1,3)\}$、$\{(1,2),(2,2),(3,2)\}$ 和 $\{(1,1),(2,2),(3,3)\}$ 均不满足条件。

### 数据规模

本题采用捆绑测试。
| $\text{Subtask}$ | $n,m\le$ | $\text{Score}$ |
| :----------: | :----------: | :----------: | 
| $1$ | $30$ | $40$ |
| $2$ | $10^9$ | $60$ |

对于 $100\%$ 的数据，$1\le T\le 10^5$，$1\le n,m\le 10^9$。

## 样例 #1

### 输入

```
1
2 2```

### 输出

```
16```

## 样例 #2

### 输入

```
1
3 3```

### 输出

```
32```

# AI分析结果



### 综合分析与结论
本题要求棋盘染色方案满足严格连续颜色限制，核心难点在于处理极大范围（1e9）的棋盘。各题解均基于周期性规律进行预处理，关键思路为：

1. **周期性观察**：连续四格必须两黑两白 → 每四行/列形成循环。
2. **斜向校验**：需扩展至7×7棋盘以确保所有斜向情况被覆盖。
3. **预处理+查表**：对7×7以内情况DFS剪枝预处理，大范围取min(n,7)查表。

### 精选题解及评分

#### 题解作者：zhangxiao666（⭐⭐⭐⭐⭐）
**关键亮点**：
- 思路清晰完整，代码可读性强，剪枝策略高效。
- 预处理至7×7，严谨覆盖斜向问题。
- 对每个棋盘位置进行全方位合法性校验。

**个人心得**：
> "剪枝是处理大预处理的关键，当列≥4时直接推导颜色，极大减少搜索空间。"

**核心代码**：
```cpp
void dfs(int x, int y) {
    if (y > m) y = 1, x++;
    if (x > n) {
        if (check()) ans++;
        return;
    }
    if (y >= 4) { // 剪枝：根据前三个推导当前颜色
        int sum1 = 0;
        for (int i = y - 3; i <= y - 1; i++) sum1 += a[x][i];
        if (sum1 == 0 || sum1 == 3) return;
        a[x][y] = (sum1 == 1) ? 1 : 0;
        dfs(x, y + 1);
        return;
    }
    a[x][y] = 1; dfs(x, y + 1);
    a[x][y] = 0; dfs(x, y + 1);
}
```

#### 题解作者：__ex（⭐⭐⭐⭐）
**关键亮点**：
- 明确周期性分析，图文结合解释扩展问题。
- 提出以4×4为循环单位，预处理至7×7。

**核心技巧**：
- 棋盘扩展时，斜向问题需更大校验范围（7×7）。
- 爆搜代码剪枝优化，避免指数级复杂度。

### 最优思路总结
**核心步骤**：
1. **剪枝DFS预处理**：对7×7以内棋盘进行剪枝搜索，生成合法方案数表。
2. **周期映射查询**：对于n/m>7的情况，取min(n,7)和min(m,7)查表。
3. **全方位合法性校验**：在DFS中检查横、竖、斜方向的所有连续情况。

**关键优化点**：
- **周期性剪枝**：当处理到第4列后，直接由前三个格子确定当前颜色。
- **斜向全覆盖**：预处理至7×7确保所有可能的4×4子区域被校验。

### 拓展与推荐题目
1. **同类问题套路**：周期性结构 → 预处理小范围+数学归纳。
2. **推荐题目**：
   - [P1495 曹冲养猪](https://www.luogu.com.cn/problem/P1495)：中国剩余定理与周期性。
   - [P2106 Sam数](https://www.luogu.com.cn/problem/P2106)：矩阵快速幂处理递推。
   - [P1378 棋盘覆盖](https://www.luogu.com.cn/problem/P1378)：分治与棋盘覆盖策略。

---
处理用时：187.18秒
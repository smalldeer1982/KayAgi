# 题目信息

# [THUPC 2024 初赛] 三步棋

## 题目背景

昼短夜长冬至近。江冽漆黑，但见东云粉。窗外惺忪鸥鹭阵，室中香漫晨炊奋。

朝肄暮劳催彼盹。宵寂观书，灯烬方安寝。请替君劳分重任，逍遥共舞生辰顺。

## 题目描述

K 家里有一条不成文的规矩。如果家里只有 K 和 H 两个人，那么两个人会通过一种叫作“三步棋”的游戏来决定谁做饭。三步棋的规则与五子棋有一些相似之处。众所周知，五子棋是一种先连出五枚己方棋子者获胜的游戏。与五子棋相同的是，三步棋中双方也轮流在网格状的棋盘上摆放棋子，并根据是否连成指定的图案决定胜负。与五子棋不同的是：

1. 三步棋不区分双方的棋子，即可以认为双方执同色棋子进行游戏；

2. 在判定时，指定的图案不能旋转；

3. 如果连成指定的图案时，棋盘上的棋子数量恰好为 $3$ 的倍数，则连成指定的图案的一方获胜，否则判定该方负（即对方获胜）。

例如，如果指定的图案为

```
.o
oo
```

且当前盘面为

```
o..o.
o.o..
oo...
o.o..
o..o.
```

时，认为没有连成给定的折线形图案，其中 `o` 表示棋子，`.` 表示空格；但若接下来在第二行第二列放一枚棋子，则连成了给定的图案，对应的棋子使用 `@` 表示：

```
o..o.
o@o..
@@...
o.o..
o..o.
```

此时盘面上恰有 $11$ 枚棋子，而 $11$ 不是 $3$ 的倍数，所以判定放这枚棋子的玩家，也即先手输掉本局。

在 K 家，为了节约时间，通常使用 $5\times 5$ 的初始为空的棋盘进行三步棋。同时，每次也只会随机选择一个由不超过 $4$ 枚棋子组成的四连通图案。显然三步棋不存在平局，所以 K 和 H 约定由输的一方负责做饭。K 想知道，如果自己和 H 都足够聪明，那么以选中的图案进行的三步棋游戏是否为**先手必胜**；因为如果她更容易赢，她就要偷偷地给自己的妹妹放水。

## 说明/提示

### 样例 \#1 解释

该样例包含三组数据。

第一组数据输入的图案为 $1$ 行 $2$ 列的 `oo`。显然，无论先手将棋子放在棋盘上的哪个位置，后手都只有两种策略：

- 和先手的棋子连成 `oo`，此时棋盘上只有 $2$ 枚棋子，故后手立即输掉游戏；

- 不和先手的棋子连成 `oo`，但是接下来轮到先手时，先手可以任意连成 `oo`，此时棋盘上恰有 $3$ 枚棋子，故先手取胜。

无论是哪种策略，后手都无法取胜，故对于 `oo` 而言**先手必胜**。

第二组数据输入的图案为 $2$ 行 $1$ 列的图案，与 `oo` 同理，可知为**先手必胜**。

第三组数据输入的图案为 $1$ 行 $3$ 列的 `ooo`，可以证明为先手必败。

### 子任务

保证 $1\le T\le 200$。对于每组数据，保证输入的 $5\times 5$ 的由 `.` 和 `o` 组成的字符矩阵中至少含有一个 `o`，且所有 `o` 组成一个大小不超过 $4$ 的四连通块。

### 题目使用协议

来自 THUPC2024（2024年清华大学学生程序设计竞赛暨高校邀请赛）初赛。

以下『本仓库』皆指 THUPC2024 初赛 官方仓库（[https://github.com/ckw20/thupc2024_pre_public](https://github.com/ckw20/thupc2024_pre_public)）

1. 任何单位或个人都可以免费使用或转载本仓库的题目；

2. 任何单位或个人在使用本仓库题目时，应做到无偿、公开，严禁使用这些题目盈利或给这些题目添加特殊权限；

3. 如果条件允许，请在使用本仓库题目时同时提供数据、标程、题解等资源的获取方法；否则，请附上本仓库的 github 地址。

## 样例 #1

### 输入

```
3
.....
oo...
.....
.....
.....
.o...
.o...
.....
.....
.....
.....
.....
.....
.ooo.
.....
```

### 输出

```
Far
Far
Away
```

# AI分析结果



### 综合分析与结论

题目核心是判断在特定规则下，三步棋游戏的先手是否必胜。关键点在于根据图案的棋子数（t=1~4）及形状进行博弈论分析。各题解均采用分类讨论，其中 t=4 的情况需结合图案形状（如是否为长条或田字格）判断是否存在"无敌点"使先手无法被利用。

---

### 精选题解与评分

#### 1. 作者：Junounly （★★★★★）
**关键亮点**：  
- 详细分类讨论各棋子数情况，逻辑清晰。  
- 对 t=4 的情况引入包围框行列跨度判断，准确区分长条/田字与其他形状。  
- 代码简洁高效，利用极值计算最小包围框，快速判断形状特征。

**核心代码解析**：  
计算图案的最小包围框，通过行列跨度判断形状：  
```cpp
int mnx=6, mny=6, mxx=0, mxy=0; // 初始化极值
for(int i=1;i<=5;i++)
    for(int j=1;j<=5;j++)
        if(c=='o') {
            mnx = min(mnx,i); mny = min(mny,j);
            mxx = max(mxx,i); mxy = max(mxy,j);
        }
// 判断条件：行或列跨度≥2且<3（排除长条/田字）
if(cnt==4 && (mxx-mnx>=2 || mxy-mny>=2) && (mxx-mnx<3 && mxy-mny<3))
    printf("Far\n");
```

#### 2. 作者：fydj （★★★★☆）
**关键亮点**：  
- 尝试状压搜索后转为打表，优化思路明确。  
- 对 t=4 的特定形状（长条、田字）进行模式匹配，逻辑直观。  
- 分类讨论全面，代码可读性较高。

**核心代码解析**：  
通过预定义模板匹配长条和田字：  
```cpp
// d数组预存长条和田字模板
bool pipei(int u) {
    for(i=1;i<=5;i++)
        for(j=1;j<=5;j++)
            // 检查是否存在模板匹配
            if(d[u][ii][jj] && !in[i+ii][j+jj]) return false;
    return true;
}
if(pipei(0) || pipei(1) || pipei(2)) printf("Away\n");
```

#### 3. 作者：Jsxts_ （★★★☆☆）
**关键亮点**：  
- 直觉判断 t=4 的胜负条件，强调无敌点存在性。  
- 提出形状旋转等价性，简化分析过程。  
- 思路简洁，适合快速解题。

**核心思路**：  
- 若图案非长条/田字，先手可放置无法被利用的点，迫使后手无法在第六步获胜，最终先手在第九步取胜。

---

### 最优关键思路总结
1. **分类讨论棋子数**：  
   - t=1：后手必胜（Away）。  
   - t=2：先手必胜（Far）。  
   - t=3：后手必胜（Away）。  
   - t=4：通过形状判断，长条（1×4或4×1）和田字（2×2）为后手必胜，其余先手必胜。

2. **形状判断技巧**：  
   - 计算图案的最小包围框行列跨度。若行或列跨度≥3则为长条；若为2×2则为田字。  
   - 利用极值快速计算包围框，避免复杂匹配。

3. **博弈策略**：  
   - 后手在 t=3 时通过分散落子迫使先手无法在第三步获胜，并在第六步达成条件。  
   - 先手在 t=4 的非标准形状中利用无敌点破坏后手策略。

---

### 相似题目推荐
1. **P1247 取石子游戏**：博弈论基础，分类讨论不同情况的必胜策略。  
2. **P2734 [USACO3.3] 游戏 A Game**：动态规划解决博弈问题，分析双方最优策略。  
3. **P2960 [NOIP2017 提高组] 棋盘**：结合棋盘规则与状态压缩，判断最优路径。

---
处理用时：132.26秒
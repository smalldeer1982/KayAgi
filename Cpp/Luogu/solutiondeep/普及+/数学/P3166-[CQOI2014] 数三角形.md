# 题目信息

# [CQOI2014] 数三角形

## 题目描述

给定一个 $N\times M$ 的网格，请计算三点都在格点上的三角形共有多少个。注意三角形的三点不能共线。

## 说明/提示

#### 数据规模与约定

对于全部的测试点，保证 $1\le N,M\le1000$。

## 样例 #1

### 输入

```
2 2```

### 输出

```
76```

# AI分析结果



### 综合分析与结论
本题核心在于利用组合数学与数论技巧高效计算不共线三点数。所有题解均采用「总组合数 - 共线情况」的思路，差异在于斜线共线的优化策略。最优解法通过数论反演将复杂度降至O(n)，而基础解法则通过枚举+gcd实现O(nm)。

---

### 精选题解与亮点

#### 1. emptysetvvvv（★★★★★）
**核心亮点**：  
- 利用欧拉反演公式优化斜线计数，复杂度从O(n²)优化至O(n)  
- 结合等差数列求和公式，将二维枚举转换为一维枚举  
- 代码中预计算欧拉函数，数学推导严谨  

**关键代码**：
```cpp
for(int d=2; d<=n; ++d) // 枚举公约数
    ans += (long long)phi[d] * (n-d+n%d+2)*(n/d) * (m-d+m%d+2)*(m/d)/2;
```

#### 2. BillYang（★★★★）
**核心亮点**：  
- 代码简洁，直接应用组合数公式  
- 枚举差值i,j计算斜线情况，逻辑清晰  
- 引入gcd快速计算中间点数量  

**关键代码**：
```cpp
ans = C(n*m) - m*C(n) - n*C(m);
for(int i=1; i<n; i++)
    for(int j=1; j<m; j++)
        ans -= 2*(gcd(i,j)-1)*(n-i)*(m-j);
```

#### 3. PPL_（★★★★）
**个人心得**：  
> "考试时扫雷分心导致没推出公式，后来发现核心在于枚举向量差+gcd计数"

**核心亮点**：  
- 图示辅助理解斜线共线原理  
- 详细推导gcd与中间点的关系  
- 强调对称性带来的乘2操作  

---

### 关键思路总结
1. **组合容斥框架**：总方案C(N*M,3) - 横竖共线 - 斜线共线  
2. **斜线优化技巧**：  
   - 枚举向量差(i,j)，中间点数为gcd(i,j)-1  
   - 数论反演：利用欧拉函数性质∑φ(d)=n，将二维求和拆分为公约数维度  
3. **代码实现**：预处理phi数组，通过d的倍数关系加速计算  

---

### 举一反三
- **同类题目**：计算矩形/立方体内特殊结构（如共面、共线）  
- **算法扩展**：莫比乌斯反演处理公约数相关计数，欧拉筛预处理数论函数  

---

### 推荐习题
1. P1172 安全逃离（容斥+组合计数）  
2. P2158 仪仗队（欧拉函数优化视线计数）  
3. P2527 金属采集（网格路径计数与gcd优化）

---
处理用时：53.78秒
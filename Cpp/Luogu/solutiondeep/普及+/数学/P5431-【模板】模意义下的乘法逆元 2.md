# 题目信息

# 【模板】模意义下的乘法逆元 2

## 题目描述

给定 $n$ 个正整数 $a_i$ ，求它们在模 $p$ 意义下的乘法逆元。

由于输出太多不好，所以将会给定常数 $k$，你要输出的答案为：  
$$\sum\limits_{i=1}^n\frac{k^i}{a_i}$$

答案对 $p$ 取模。

## 说明/提示

对于 $30\%$ 的数据，$1\le n \le 10^5$。

对于 $100\%$ 数据，$1\le n \le 5\times 10^6$，$2\le k < p \le 10^9$，$1\le a_i < p$，保证 $p$ 为质数。

提示：本题时间限制较为严格，请注意使用较快的 IO 方式。

## 样例 #1

### 输入

```
6 233 42
1 4 2 8 5 7```

### 输出

```
91```

# AI分析结果



### 综合分析
本题核心在于在 O(n) 时间内批量计算模 p 意义下的逆元，并高效处理求和。题解普遍采用前缀积+逆元递推的思路，结合快速幂优化 k 的幂次计算。关键优化点在于通过前后缀积或单次逆元递推避免重复求逆，将复杂度从 O(n log p) 降至 O(n)。

---

### 高分题解推荐

#### 1. 作者：mrsrz（5星）
**关键亮点**：
- **通分思路**：利用前缀积与后缀积快速计算通分后的分子，最后统一乘总逆元。
- **代码简洁**：预处理前/后缀积，仅一次逆元计算，循环结构清晰。
- **输入优化**：使用 fread 快读处理大规模输入。

**核心代码**：
```cpp
pre[i] = (LL)pre[i-1] * a[i] % md; // 前缀积
suf[i] = (LL)suf[i+1] * a[i] % md; // 后缀积
ans = (ans + (LL)k^i * pre[i-1] * suf[i+1]) % md;
ans = ans * Inv(pre[n]) % md; // 统一乘总逆元
```

#### 2. 作者：DPair（4星）
**关键亮点**：
- **逆元递推**：通过总积逆元反向递推每个前缀积逆元，节省空间。
- **公式推导**：明确展示 a_i^{-1} = s_{i-1} * inv(s_i) 的数学证明。

**核心公式**：
```cpp
s[i] = s[i-1] * a[i]; // 前缀积
inv_s[i] = inv_s[i+1] * a[i+1]; // 逆元递推
real_inv[i] = s[i-1] * inv_s[i]; // 最终逆元
```

#### 3. 作者：yurzhang（4星）
**关键亮点**：
- **极简变量**：仅用单变量维护逆元，避免数组存储。
- **倒序处理**：结合 k^n 的逆元递推，减少幂次计算次数。

**代码片段**：
```cpp
for(int i=n; i>=1; --i) {
    inv[i] = sum[i-1] * sinv % mod; // 逆元计算
    sinv = sinv * a[i] % mod; // 递推更新
}
```

---

### 关键技巧总结
1. **前缀积+逆元递推**：计算所有数的前缀积后，求总积逆元，反向递推得到每个数的逆元。
2. **k的幂次优化**：在循环中递推计算 k^i，避免快速幂重复调用。
3. **IO优化**：必须使用 fread 快读处理 5e6 级输入。
4. **空间优化**：用单变量代替数组存储逆元，减少内存访问。

---

### 同类题目推荐
1. [P3811 乘法逆元](https://www.luogu.com.cn/problem/P3811) - 线性求逆元模板。
2. [P2613 【模板】有理数取余](https://www.luogu.com.cn/problem/P2613) - 大数模运算与逆元结合。
3. [P5142 区间方差](https://www.luogu.com.cn/problem/P5142) - 前缀积/和的模运算应用。

---

### 个人心得摘录
- **卡常教训**：多篇题解强调快读的必要性，未优化 IO 会导致 TLE。
- **变量类型**：`int` 代替 `long long` 可减少常数（需配合强制转换）。
- **数学转化**：将分式求和转化为统一分母形式，避免多次求逆。

---
处理用时：66.93秒
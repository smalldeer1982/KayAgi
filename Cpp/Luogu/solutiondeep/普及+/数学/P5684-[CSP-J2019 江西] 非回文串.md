# 题目信息

# [CSP-J2019 江西] 非回文串

## 题目描述

Alice 有 $n$ 个字符，它们都是英文小写字母，从 $1 \sim n$ 编号，分别为 $c_1,c_2, \dots , c_n$。  
Bob 准备将这些字符重新排列，组成一个字符串 $S$。Bob 知道 Alice 有强迫症，所以他打算将 $S$ 组成一个非回文串来折磨 Alice。  

现在 Bob 想知道他共有多少种不同的排列字符的方案，能使得 $S$ 是个非回文串。一种排列字符的方案指的是一个 $1 \sim n$ 的排列 $p_i$，它所组成的 $S = c_{p_1}c_{p_2} \dots c_{p_n}$。

一个字符串是非回文串，当且仅当它的逆序串与原串不同。例如 `abcda` 的逆序串为 `adcba`，与原串不同，故 `abcda` 是非回文串。而 `abcba` 的逆序串与原串相同，是回文串。

由于最后的结果可能很大，你只需要告诉 Bob 总方案数对 $10^9+7$ 取模后的值。

## 说明/提示

【数据范围】  
对于 $20\%$ 的数据，$n \le 8$；  
对于 $50\%$ 的数据，$n \le 20$；  
另有 $30\%$ 的数据，字符只包含 `a` 和 `b`；  
对于 $100\%$ 的数据，$3 \le n \le 2000$。

## 样例 #1

### 输入

```
3
aba```

### 输出

```
4```

## 样例 #2

### 输入

```
8
aabbbbcc```

### 输出

```
39168```

# AI分析结果



### 综合分析与结论
各题解的核心思路均为「总排列数 - 回文排列数」，核心难点在于高效计算回文排列数。关键优化点包括：
1. **奇偶性判断**：若奇数字符超过1个，直接返回总排列数。
2. **组合公式优化**：预处理阶乘与逆元，快速计算 $\frac{a_i!}{(a_i/2)!}$ 的乘积。
3. **模运算处理**：正确处理减法取模后的负数情况。

---

### 精选题解与评分

#### 1. 题解作者：NaCly_Fish（⭐⭐⭐⭐⭐）
**关键亮点**：
- 数学推导清晰，公式简洁（直接给出 $n! - (n/2)! \prod \frac{a_i!}{(a_i/2)!}$）。
- 代码高效：预处理阶乘与逆元，O(n) 时间复杂度。
- 正确处理奇数字符的中间位置选择（乘奇数字符数量）。

**核心代码**：
```cpp
int main() {
    // 预处理阶乘与逆元
    for(reg int i=2;i<=n;++i) ifac[i] = fac[i] = (ll)fac[i-1]*i%p;
    ifac[n] = power(fac[n],p-2);
    // 统计字符出现次数
    for(reg int i=0;i<26;++i) odd += cnt[i]&1;
    if(odd>1) printf("%d",fac[n]); // 无法构成回文
    else {
        // 计算回文排列数
        dec = (ll)fac[n>>1] * odd % p;
        for(reg int i=0;i<26;++i) 
            dec = (ll)dec * fac[cnt[i]<<1] % p * ifac[cnt[i]] % p;
        ans = (fac[n]-dec+p)%p; // 取模处理
    }
}
```

#### 2. 题解作者：SegTree（⭐⭐⭐⭐）
**关键亮点**：
- 组合数递推预处理，代码可读性高。
- 分步计算回文排列数，逻辑清晰。

**核心思路**：
```cpp
for(int i=0;i<26;++i) {
    ans *= A(a[i],a[i]) * niyuan(A(a[i]/2,a[i]/2)) % mod;
}
ans = ans * jc[n/2] % mod; // 中间位置处理
```

#### 3. 题解作者：Digital_Sunrise（⭐⭐⭐⭐）
**关键亮点**：
- 详细注释与易错点分析（如负数取模、阶乘逆元）。
- 组合数计算与阶乘分离，便于理解。

---

### 最优思路与技巧总结
1. **预处理优化**：预处理阶乘和逆元，将组合数计算降为 O(1)。
2. **奇偶分治**：若奇数字符超限，直接返回总排列数。
3. **对称性剪枝**：仅计算左半部分排列，右半部分自动对称。
4. **模运算安全**：`(a - b + MOD) % MOD` 避免负数结果。

---

### 拓展与相似题目
1. **排列组合优化**：[P3807 卢卡斯定理](https://www.luogu.com.cn/problem/P3807)
2. **回文性质应用**：[P1217 回文质数](https://www.luogu.com.cn/problem/P1217)
3. **模运算计数**：[P1313 计算系数](https://www.luogu.com.cn/problem/P1313)

---
处理用时：61.11秒
# 题目信息

# 「C.E.L.U-02」学术精神

## 题目描述

提供 **一句话题意** 阅读。

某地有 $n$ 个小朋友，每个小朋友都有一个**独特的**  idea，其中第 $i$ 个小朋友的 idea 的 **编号** 为 $i$。老师让这个每一个小朋友在一组编号分别为 $1\sim n$ 的卡片中随机抽一个，**抽完后把卡片放回去**，这个小朋友会和编号为卡片上数字的小朋友**交换** idea（交换指**两人**把**所有**自己知道的 idea 告诉对方）。因为自己和自己交换 idea 在他们眼中也许是一件很傻的事情，所以如果**卡片上的编号与自己的相同**，他将再抽一次（此时他已经把卡片放回去了），**直到编号不是自己**的为止。

不久，每个小朋友都抽完了一遍，每个小朋友将把收集到的**所有** idea 出成一场比赛，因为有 idea 的交换，有很多比赛之间都是**有联系**的。

如果两场比赛中存在 idea **相同**的题目，我们认为这两场比赛是有联系的。「联系」具有**传递性**：**如果比赛 $\mathbf A$、$\mathbf B$ 有联系，比赛 $\mathbf B$、$\mathbf C$ 有联系，则比赛 $\mathbf A$、$\mathbf C$ 也有联系**。为了避免理解错误，在这举一个例子：

若仅有四场比赛：比赛一出现了 idea $1$、$2$；比赛二出现 idea $2$、$5$ ；比赛三出现 idea $3$、$5$、$8$，比赛四出现 idea $4$、$7$。则比赛一、二之间有**直接联系**。比赛一、三之间虽然没有公共 idea，但它们之间是**有联系**的。比赛四与其他所有比赛没有联系。  

而所有有联系的比赛都将属于同一个比赛集，没有联系的比赛处在不同的比赛集。

上例中比赛一、二、三属于一个比赛集，比赛四属于另一个。

求所有人**抽球卡片的次数和**的期望 $E_0$ 和比赛集的个数 $s$ 的期望 $E_1$。

---

**一句话题意：**

对于每个点 $i$ 随机与 $[1,n]$ 中的一点连无向边，若连向自己，则保留该边并再次连边，一直重复至连到别的点上为止，求边数与连通块个数期望。

## 说明/提示

---

### 样例解释  

**样例解释一**

- 每个小朋友摸卡片次数为 $1$ 的概率为 $\dfrac{1}{2}$，摸卡片次数为 $2$ 的概率为 $\dfrac{1}{4}$，摸卡片次数为 $i$ 的期望次数为 $\dfrac{1}{2^i}$，期望摸卡片次数为 $2$，总摸卡片次数为 $4$。

- $1$ 号小朋友一定会和 $2$ 号小朋友交换 idea，所以他们出的比赛之间一定是属于同一个比赛集。$E_1=1$。

**样例解释二**

- 第一问取模前的答案为 $\dfrac{49}{6}$。

- 第二问取模前的答案为 $\dfrac{2245}{1944}$。

---

### 数据范围

| 测试点编号 | $n$ | 测试点编号 | $n$ | 
| :----------: | :----------: | :----------: | :----------: |
| $1$ | $\leq 3$ | $5$ | $\leq 1000$ |
| $2$ | $\leq 5$ | $6$ | $\leq 2000$ | 
| $3$ | $\leq 9$ | $7\sim8$ | $\leq 5000$ | 
| $4$ | $\leq 12$ | $9\sim 10$ | $\leq10^4$ | 

对于 $100\%$ 的数据，有 $2\leq n\leq10^4$。

---


## 样例 #1

### 输入

```
2```

### 输出

```
4
1```

## 样例 #2

### 输入

```
7```

### 输出

```
166374067
539688692```

# AI分析结果



### 综合分析与结论
本题考察**期望计算**与**基环树性质**。各题解对第一问（边数期望）均采用几何分布的期望公式，思路一致；第二问（连通块数）均转化为求环的期望个数，但实现方式不同。核心难点在于将连通块数与环的数量建立等价关系，并高效计算排列组合。

---

### 精选题解

#### 1. 作者：0x3F （★★★★★）
**关键亮点**：
- 第二问通过排列数（P^m_n）直接处理环的排列，避免组合数与阶乘的冗余计算。
- 代码采用循环累乘，空间复杂度低，适合大n。
- 公式推导清晰，指出每个有向环的贡献为 P(n,i)/(i·(n-1)^i)。

**代码核心**：
```cpp
for (int i=2, j=n*(n-1); i<=n; j=(ll)j*(n-i++)%mod) 
    t = (t + (ll)j * inv(i) % mod * qpow(n-1, mod-i-1)) % mod;
```
**核心思想**：逐步计算排列数 `j = P(n,i)`，每次循环乘 `(n-i)`，并累加环的贡献。

#### 2. 作者：Tx_Lcy （★★★★☆）
**关键亮点**：
- 将连通块数等价为基环树中环的数量，通过组合数学计算所有可能的环。
- 预处理阶乘与逆元，代码可读性强。

**代码核心**：
```cpp
for (int i=2; i<=n; ++i) 
    ans += C(n,i)*fac[i-1]%mod * facn[n-i]%mod;
ans = ans * inv(facn[n]) % mod;
```
**核心思想**：枚举环长i，计算组合数C(n,i)与排列数(i-1)!，再乘其他点的选择数。

#### 3. 作者：TonyYin （★★★★☆）
**关键亮点**：
- 详细推导环的期望公式，给出等比数列求和的完整过程。
- 代码循环中动态计算排列数与逆元，节省预处理步骤。

**代码核心**：
```cpp
int tmp = n, Pow = n-1;
for(int i=2; i<=n; i++) {
    tmp = tmp * (n-i+1) % mod; // P(n,i)
    ans += tmp * inv(i * Pow) % mod;
    Pow = Pow * (n-1) % mod;
}
```
**核心思想**：动态维护排列数 `tmp` 和幂次 `Pow`，避免存储大数组。

---

### 关键思路与技巧
1. **几何分布的期望**：每个点连边次数期望为 ∑k·(1/n)^{k-1}·(n-1)/n = n/(n-1)。
2. **基环树性质**：连通块数等于环的数量，因每个基环树仅含一个环。
3. **环的贡献计算**：对环长i，计算其排列数 P(n,i)，除以i（循环排列重复计数）和(n-1)^i（总可能数）。

---

### 拓展与相似题目
1. [P1365 WJMZBMR打osu! / Easy](https://www.luogu.com.cn/problem/P1365) - 期望递推
2. [P1654 概率充电器](https://www.luogu.com.cn/problem/P1654) - 树形期望DP
3. [P4204 聪聪可可](https://www.luogu.com.cn/problem/P4204) - 基环树计数

---
处理用时：61.44秒
# 题目信息

# [NOIP 2007 提高组] 树网的核

## 题目描述

设 $T=(V,E,W)$ 是一个无圈且连通的无向图（也称为无根树），每条边都有正整数的权，我们称 $T$ 为树网（`treenetwork`），其中 $V$，$E$ 分别表示结点与边的集合，$W$ 表示各边长度的集合，并设 $T$ 有 $n$ 个结点。

路径：树网中任何两结点 $a$，$b$ 都存在唯一的一条简单路径，用 $d(a, b)$ 表示以 $a, b$ 为端点的路径的长度，它是该路径上各边长度之和。我们称 
$d(a, b)$ 为 $a, b$ 两结点间的距离。

$D(v, P)=\min\{d(v, u)\}$, $u$ 为路径 $P$ 上的结点。

树网的直径：树网中最长的路径成为树网的直径。对于给定的树网 $T$，直径不一定是唯一的，但可以证明：各直径的中点（不一定恰好是某个结点，可能在某条边的内部）是唯一的，我们称该点为树网的中心。

偏心距 $\mathrm{ECC}(F)$：树网 $T$ 中距路径 $F$ 最远的结点到路径 $F$ 的距离，即

$$\mathrm{ECC}(F)=\max\{D(v, F),v \in V\}$$

任务：对于给定的树网 $T=(V, E, W)$ 和非负整数 $s$，求一个路径 $F$，他是某直径上的一段路径（该路径两端均为树网中的结点），其长度不超过 $s$（可以等于 $s$），使偏心距 $\mathrm{ECC}(F)$ 最小。我们称这个路径为树网 $T=(V, E, W)$ 的核（`Core`）。必要时，$F$ 可以退化为某个结点。一般来说，在上述定义下，核不一定只有一个，但最小偏心距是唯一的。

下面的图给出了树网的一个实例。图中，$A-B$ 与 $A-C$ 是两条直径，长度均为 $20$。点 $W$ 是树网的中心，$EF$ 边的长度为 $5$。如果指定 $s=11$，则树网的核为路径`DEFG`（也可以取为路径`DEF`），偏心距为 $8$。如果指定 $s=0$（或 $s=1$、$s=2$），则树网的核为结点 $F$，偏心距为 $12$。

![](https://cdn.luogu.com.cn/upload/image_hosting/oms5c6rq.png)


## 说明/提示

- 对于 $40\%$ 的数据，保证 $n \le 15$。
- 对于 $70\%$ 的数据，保证 $n \le 80$。
- 对于 $100\%$ 的数据，保证 $2\le n \le 300$，$0\le s\le10^3$，$1 \leq u, v \leq n$，$0 \leq w \leq 10^3$。

NOIP2007 提高组第四题

## 样例 #1

### 输入

```
5 2
1 2 5
2 3 2
2 4 4
2 5 3
```

### 输出

```
5
```

## 样例 #2

### 输入

```
8 6
1 3 2
2 3 2 
3 4 6
4 5 3
4 6 4
4 7 2
7 8 3
```

### 输出

```
5```

# AI分析结果

### 综合分析与结论
这些题解围绕树网的核问题展开，提供了多种解题思路和算法。整体来看，各题解在思路阐述、算法复杂度和代码实现上各有优劣。部分题解详细分析了问题的性质，为后续算法提供理论支持；有的题解则更注重算法的优化，降低时间复杂度。

### 所选题解
- StudyingFather（5星）
    - 关键亮点：详细分析了问题的特殊性质，提供了四种不同复杂度的解法，从暴力枚举到双指针、二分、双指针 + 前缀和逐步优化，代码实现规范，使用 `namespace` 隔离不同解法方便对比。
- Mosklia（4星）
    - 关键亮点：时间复杂度为 $O(n)$，思路清晰，先分析直径的性质，再通过两次 DFS 求直径，用单调队列优化枚举过程，降低时间复杂度。
- 天泽龟（4星）
    - 关键亮点：采用二分答案的方法，详细阐述了二分的正确性、具体实现过程和边界判断，对支链影响的分析很有价值，代码实现完整。

### 重点代码及核心思想
#### StudyingFather - 双指针 + 前缀和解法
```cpp
namespace sub4 {
void solve() {
  for (int i = 1; i <= cnt; i++) vis[dia[i]] = true;
  int maxd = 0;
  for (int i = 1; i <= cnt; i++) {
    dep[dia[i]] = 0, c = 0;
    dfs(dia[i], 0);
    maxd = max(dep[c], maxd);
  }
  int l = 1, r = 1;
  int minecc = 1 << 30;
  for (; l <= cnt; l++) {
    while (r <= cnt && pres[r + 1] - pres[l] <= s) r++;
    minecc = min(max(maxd, max(pres[l], posts[r])), minecc);
  }
  cout << minecc << endl;
}
}  // namespace sub4
```
核心思想：先求出直径上每个点引出的最长支链长度的最大值 `maxd`，然后使用双指针枚举直径上的路径，动态更新偏心距，取最小值。

#### Mosklia - 单调队列优化解法
```cpp
std::deque<int> q; //需要#include <deque>（<queue>行）
int ans = 2147483647; //正无穷
for(int i = 1, j = 1; i <= m; dist2 -= pt[del[i]].fa_dist, ++i) {
  pt[del[i]].cur_dist = dist2; 
  while(!q.empty() && pt[q.front()].cur_dist - s > pt[del[i]].cur_dist)
    q.pop_front();
  while(j < i && tot - dist1 - dist2 > s)
    dist1 += pt[del[j++]].fa_dist;
  while(!q.empty() && pt[q.back()].dist < pt[del[i]].dist)
    q.pop_back();
  q.push_back(del[i]);
  int temp = std::max(dist1, dist2);
  temp = std::max(temp, pt[q.front()].dist);
  ans = std::min(temp, ans); 
}
```
核心思想：将直径序列看成区间，用单调队列维护区间元素的第二种贡献值，在左/右端点移动的同时计算第一种贡献，更新答案。

#### 天泽龟 - 二分答案解法
```cpp
bool check(ll x)
{
  l1=l2=0; p=drop(A,0,x); q=up(B,x); 
  return (d[q]-d[p]<=s);
}

int main()
{
  scanf("%lld%lld",&n,&s);
  for (ll i=1,x,y,w;i<n;i++)
    scanf("%lld%lld%lld",&x,&y,&w),add(x,y,w);
  dfs(1,0,0); ans=0; r=l; dfs(l,0,0); 
  A=r; B=l; D=ans;
  l=dismin(); r=D; 
  while (l<r)
  {
    ll mid=(l+r)/2; 
    if (check(mid)) r=mid; else l=mid+1;
  }
  printf("%lld\n",l);
} 
```
核心思想：二分偏心距，在 `check` 函数中以直径两端点分别向直径内部递推，找到与端点距离不超过当前偏心距的最远节点，判断两点距离是否小于 $s$，不断缩小二分区间。

### 最优关键思路或技巧
- **性质分析**：通过严谨的证明得出所有直径必交于至少一点、各直径中点唯一等性质，为后续算法提供理论基础，可忽略路径只能在直径上的限制，简化问题。
- **双指针优化**：在固定路径一端的前提下，利用偏心距随路径长度增加不会变大的性质，用双指针减少候选的最优路径数量，降低时间复杂度。
- **二分答案**：将最优化问题转化为存在性问题，通过二分偏心距，不断缩小可行解范围，提高算法效率。
- **单调队列**：在处理区间最值问题时，使用单调队列可以在 $O(n)$ 时间内完成，避免了重复计算。

### 可拓展之处
同类型题或类似算法套路：
- **树的直径相关问题**：如求树的直径长度、直径上的节点等，可使用两次 DFS 或 BFS 求解。
- **树上路径问题**：例如求树上两点间的最短路径、最长路径等，可使用 LCA、树链剖分等算法。
- **二分答案问题**：当问题具有单调性时，可尝试使用二分答案将最优化问题转化为存在性问题求解。

### 推荐题目
- [P1385 密令](https://www.luogu.com.cn/problem/P1385)：涉及树的直径和路径问题。
- [P2491 [SDOI2011] 消防](https://www.luogu.com.cn/problem/P2491)：与树网的核问题类似，需要在树上找到一条长度不超过 $s$ 的路径，使某个值最小。
- [P4408 [NOI2003] 逃学的小孩](https://www.luogu.com.cn/problem/P4408)：考查树的直径和路径距离计算。

### 个人心得
- **天泽龟**：从写这道题到写完题解共花了 7 个小时，期间有很多钻牛角尖的地方，提醒大家没事千万别死磕题，避免智商下降。在解题过程中，要注意考虑支链对答案的影响，否则可能会得到错误的结果。
- **Mosklia**：即使原始的数据范围很水，也要尽力优化。AC 不是终极目标，获得经验才是最重要的。 

---
处理用时：50.57秒
# 题目信息

# [JSOI2010] 快递服务

## 题目描述

「飞奔」快递公司成立之后，已经分别与市内许多中小企业公司签订邮件收送服务契约。由于有些公司是在同一栋大楼内，所以「飞奔」公司收件的地点（收件点）最多只有 $m$ 点（$1,2,\dots,m$），因此「飞奔」仅先行采购了三辆货车并聘用了三名司机，每天早上分别从收件地点 $1,2,3$ 出发。而在与客户的服务契约中有明确订约：「飞奔」必须在客户提出邮件寄送要求的隔天派人至该公司（地点）收件。

为了能更有效率的服务客户并节省收件时间，该公司设立了收件服务登记网站，客户如有邮件需要寄送，必须在需要收件的前一天就先上网登记。为了节省油量，「飞奔」就利用晚上先行安排三位司机隔天的收件路线。每位司机至各地点收件的顺序应与各公司上网登记的顺序相符且必须能在最省油的情况下完成当天所有的收件服务。因此每位司机有可能需要在不同时间重复到同一地点收件，或不同的司机有可能需在不同的时间点前往同一地点收件。

如下面范例二（收件公司地点依序为：`4 2 4 1 5 4 3 2 1`）所示，虽然司机 $1$ 一开始就已经在收件地点 $1$ 了，但是他却不能先把后面第四个登记的公司（地点 $1$）邮件先收了再前往第一、第二、或第三个登记收件地点（地点 $4,2,4$）收件。但是如果前三个登记收件的服务是由司机 $2$ 或 $3$ 来负责，则司机 $1$ 就可以在地点 $1$ 收了第四个登记的邮件后再前往后面所登记的地点收件。此外，在某些情况下，不一定每辆车都要收到货，也就是说，最佳收件方式也有可能是只需出动一或两辆车去收货。请写一个程序来帮「飞奔」公司计算每天依预约顺序至各收件地点收件的最少总耗油量。

### 简要题意

给定一个 $m \times m$ 的矩阵 $D$。我们规定一个序列 $a(a_0,a_1,a_2,\dots,a_n)$ 的花费为 $\sum\limits_{i=1}^{n}D_{a_{i-1},a_i}$。

现在给定你一个长度 $\leq 1000$ 的序列 $s$，请你把它分成三个子序列 $a,b,c$，并且规定 $a_0=1,b_0=2,c_0=3$，求出所有划分方案中它们的最小化费和。

特殊地，矩阵 $D$ 满足三角不等式，具体见输入格式中的详细解释。

（By El_destructor）

## 说明/提示

#### 样例解释

到每个请求收件地点的司机分别为 `1 1 1 1 3 3 2 2 2 1`，因此司机 $1$ 只需从起使点 $1$ 移动到地点 $3$，司机 $2$ 只需停留在地点 $2$，司机 $3$ 从起始点 $3$ 移动到地点 $4$。

#### 数据范围

$3 \leq m \leq 200,1 \leq s_i \leq m$。

## 样例 #1

### 输入

```
4 
0 5 0 6 
6 0 5 6 
1 6 0 6 
1 1 1 0 
1 1 1 1 4 4 2 2 2 3 ```

### 输出

```
6```

# AI分析结果

### 综合分析与结论
这些题解均围绕快递服务问题，采用动态规划算法求解。初始思路是用四维数组 `f[i][x][y][z]` 表示状态，但时空复杂度高。大家发现每次完成任务必有一人在任务位置，从而将状态优化为三维或二维，还使用滚动数组优化空间。各题解思路相似，在状态转移方程、代码实现和优化细节上有差异。

### 所选题解
- **作者：Iscream2001 (赞：7)  4星**
  - 关键亮点：思路清晰，先指出简单的三维 dp 会超时，再说明如何利用任务特性优化为二维 dp，代码实现简洁明了。
- **作者：BzhH (赞：5)  4星**
  - 关键亮点：将本题与类似题目关联，详细推导状态转移方程，还使用滚动数组优化空间，代码注释清晰。
- **作者：VioletIsMyLove (赞：2)  4星**
  - 关键亮点：先分析高维 dp 的问题，再逐步优化到二维并使用滚动数组，代码逻辑清晰。

### 重点代码及核心实现思想
#### Iscream2001 的代码
```cpp
for(int k=1;k<=m;++k){
    for(int i=1;i<=n;++i)
        for(int j=1;j<=n;++j) 
            t[i][j]=inf;
    for(int i=1;i<=n;++i){
        for(int j=1;j<=n;++j){
            if(f[i][j]==inf) continue;
            t[i][j]=min(t[i][j],f[i][j]+mp[p[k-1]][p[k]]);
            t[p[k-1]][j]=min(t[p[k-1]][j],f[i][j]+mp[i][p[k]]);
            t[i][p[k-1]]=min(t[i][p[k-1]],f[i][j]+mp[j][p[k]]);
        }
    }
    for(int i=1;i<=n;++i)
        for(int j=1;j<=n;++j) 
            f[i][j]=t[i][j];
}
```
核心思想：用二维数组 `f[i][j]` 表示第一个人在 `i`，第二个人在 `j`，另一个人在上一个任务位置的最小费用。按任务顺序枚举，根据不同司机去执行当前任务更新状态。

#### BzhH 的代码
```cpp
for (int i = 0; i < n;i++)
{
    memset(f[i + 1 & 1], 0x3f, sizeof(f[i + 1 & 1]));
    for (int x = 1; x <= l;x++)
    {
        for (int y = 1; y <= l;y++)
        {
            if(x==p[i]||x==y||y==p[i])
                continue;
            f[i + 1 & 1][p[i]][y] = min(f[i + 1 & 1][p[i]][y], f[i & 1][x][y] + c[x][p[i + 1]]);
            f[i + 1 & 1][x][p[i]] = min(f[i + 1 & 1][x][p[i]], f[i & 1][x][y] + c[y][p[i + 1]]);
            f[i + 1 & 1][x][y] = min(f[i + 1 & 1][x][y], f[i & 1][x][y] + c[p[i]][p[i + 1]]);
        }
    }
}
```
核心思想：用滚动数组 `f` 表示状态，`f[i][x][y]` 表示完成前 `i` 个请求，其中两个人分别在 `x` 和 `y` 的最小费用。按请求顺序枚举，根据不同司机去执行下一个请求更新状态。

#### VioletIsMyLove 的代码
```cpp
for (int i = 1; i <= m; i++) {
    int z = a[i - 1];
    memset(F[i & 1], 127, sizeof F[i & 1]);
    for (int x = 1; x <= n; x++)
        for (int y = 1; y <= n; y++) {
            if (x == y || x == z || y == z) continue;
            if (x != a[i] && y != a[i]) F[i & 1][x][y] = min(F[i & 1][x][y], F[1 - i & 1][x][y] + c[z][a[i]]);
            if (x != a[i] && z != a[i]) F[i & 1][x][z] = min(F[i & 1][x][z], F[1 - i & 1][x][y] + c[y][a[i]]);
            if (y != a[i] && z != a[i]) F[i & 1][y][z] = min(F[i & 1][y][z], F[1 - i & 1][x][y] + c[x][a[i]]);
        }
}
```
核心思想：用滚动数组 `F` 表示状态，`F[i][x][y]` 表示序列枚举到第 `i` 个位置，司机 1 在 `x` 位置，司机 2 在 `y` 位置，司机 3 在上一个拿件位置的最小费用。按序列位置枚举，根据不同司机去执行当前任务更新状态。

### 最优关键思路或技巧
- **状态压缩**：利用每次完成任务必有一人在任务位置的特性，将高维状态优化为低维，降低时空复杂度。
- **滚动数组**：由于状态转移只与前一个状态有关，使用滚动数组将空间复杂度进一步降低。

### 可拓展之处
同类型题通常涉及多任务分配、资源调度等问题，可使用动态规划求解。类似算法套路包括分析问题特性进行状态压缩、利用滚动数组优化空间等。

### 推荐题目
- [SP703 SERVICE - Mobile Service](https://www.luogu.com.cn/problem/SP703)
- [P1854 花店橱窗布置](https://www.luogu.com.cn/problem/P1854)
- [P1005 矩阵取数游戏](https://www.luogu.com.cn/problem/P1005)

### 个人心得摘录与总结
- **Yang818**：先用贪心写发现错误，因为不具备最优子结构。总结出贪心在某些问题上不适用，要考虑问题是否满足最优子结构。
- **Jμdge**：提到多一维数组会超时，少一维就 AC，疑惑访问速度对时间的影响。提醒在做题时要注意数组维度对时空复杂度的影响。
- **Utsuji_risshū**：分享卡常技巧，如滚动数组顺便优化时间、缩小枚举范围。说明在竞赛中要注意代码的优化细节。 

---
处理用时：46.38秒
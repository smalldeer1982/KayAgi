# 题目信息

# 「Wdoi-4」芙兰？姆Q！贤者与谜题

## 题目背景

题目背景不包含解题的关键信息，可以跳过。

---

芙兰朵露·斯卡蕾特是曾居住在红魔馆地下室的吸血鬼。与众不同的是，芙兰朵露有着彩色结晶的特殊翅膀，与其他吸血鬼蝙蝠一般的翅膀不同：颜色各异的结晶按照顺序一字排开。

芙兰朵露翅膀的彩色结晶的颜色从内到外分别是天蓝、蓝、紫、粉、橙、黄、淡绿和天蓝。因此事实上，芙兰朵露的翅膀很可能就是帕秋莉的「贤者之石」组成的。

但是芙兰朵露并不关心这些，她只关心排列成翅膀形状的贤者之石之间发生的能量流动——如果一块贤者之石被赋予了能量，就会处于激发态。处于激发态的贤者之石很不稳定——它大量能量的爆发会波及周围的贤者之石，以造成能量的转移。

芙兰朵露非常感兴趣，并以此出了一个谜题来考考帕秋莉。但是作为贤者的帕秋莉不想思考只想摸鱼，于是任务就交给你啦！![](https://www.luogu.com.cn/paste/tkub6dq3)

## 题目描述

芙兰朵露从帕秋莉那里搞来了 $n$ 块贤者之石，并从左往右排成了一列。帕秋莉可以赋予每块贤者之石一定的能级，这会决定贤者之石之间能量的传递。值得注意的是，**能级必须要是正整数，并且不能有两块贤者之石能级相同**。

如果第 $i$ 块贤者之石被赋予了能量（处于激发态），它就会将能量传递给第 $i-1$ 和第 $i+1$ 块里**能级较小**的那一块。特别地，如果某块贤者之石周围只有一块，那么它只会向这一块发送能量。注意，即使第 $i$ 块的能级低于第 $i-1$ 和第 $i+1$ 块，它**照样可以传输能量**。

现在芙兰有 $q$ 个条件——每个条件给定两个正整数 $s,t$，表示如果芙兰激活了第 $s$ 块贤者之石的能量，那么能量最终会经过第 $t$ 块。

然而由于帕秋莉有哮喘的老毛病，设定贤者之石的能级是很费力的。因此，如果存在一种合法的赋予贤者之石能级的方案，请你找出其中**字典序最小**的那个方案。对于两种方案 $A,B$，我们称 $A$ 的字典序小于 $B$，当且仅当存在一个 $p$，使得 $\forall i<p$ 有 $A_i=B_i$，且 $A_p<B_p$。 

如果存在合法方案，请你输出字典序最小的方案；否则输出 `QED`。

## 说明/提示

输入/输出样例 $2$ 见下发的附件 $\textbf{\textit{qed2.in}/\textit{qed2.out}}$。

输入/输出样例 $3$ 见下发的附件 $\textbf{\textit{qed3.in}/\textit{qed3.out}}$。

---

### 数据范围及约定

对于 $100\%$ 的数据，$0\le q \le 3\times 10^5$，$3\le n \le 3\times 10^5$，$1\le s_i,t_i \le n$。

$$
\def{\arraystretch}{1.5}
\begin{array}{|c|c|c|c|} \hline
\textbf{测试点} & \bm{n\le} & \bm{q\le} & \textbf{特殊限制} \cr \hline
1\sim 3 & 7 & 7 & - \cr \hline
4\sim6 & 100 & 100 & - \cr \hline
7 & 10^5 & 1 & -\cr \hline
8\sim 10 & 3\times 10^5 & 3\times 10^5 & s_i\le t_i \cr \hline
11\sim 12 & 10^5 & 10 & - \cr \hline
13\sim 20 & 3\times 10^5 & 3\times 10^5 & -\cr \hline
\end{array}$$


## 样例 #1

### 输入

```
10 4
1 2
3 7
8 10
5 6```

### 输出

```
1 4 8 3 7 2 6 10 5 9```

# AI分析结果

### 综合分析与结论
这些题解主要围绕根据给定条件构建大小关系图，并通过不同方法判断是否有解以及求出字典序最小的方案。多数题解利用差分优化建边过程，以降低时间复杂度。不同之处在于后续判断无解和求字典序最小方案的具体方法，有的用拓扑排序，有的用贪心策略。

### 所选的题解
1. **作者：囧仙 (5星)**
    - **关键亮点**：思路清晰，先将问题转化为建图问题，指出奇偶点分别成链的特性。利用差分数组优化区间赋值，贪心确定最小字典序方案，代码简洁高效，可读性强。
    - **重点代码及核心思想**：
```cpp
// 差分数组区间赋值
if(s<t) ++A[s-1],--A[t-1]; else if(s>t) ++B[t],--B[s];
// 差分数组还原
up(1,n,i) A[i]+=A[i-1],B[i]+=B[i-1];
// 判断无解
up(1,n-2,i) if(A[i]&&B[i]) f=true;
// 贪心确定字典序最小方案
up(1,n,i) if(!N[i]){
    int c=1; for(int j=i;A[j]&&j+2<=n;j+=2) ++c;
    up(1,c,j) N[i+2*c-2*j]=++t;
}
```
核心思想是通过差分数组记录区间关系，还原后判断是否有矛盾（双向边），再从左到右贪心为每个未标号点赋予尽可能小的值。

2. **作者：C_liar (4星)**
    - **关键亮点**：提出贪心 + 并查集优化的独特思路。先通过拓扑排序判断无解情况，后用并查集优化建图，降低边的规模，最后通过dfs确定字典序最小方案，对暴力解法的优化思路清晰。
    - **重点代码及核心思想**：
```cpp
// 并查集优化建图
if(s<t){
    for(int j=s;j<t;){
        if(j-1==0){j++;continue;} 
        if(d2.getf(j)!=d2.getf(j-1)){
            if(d1.getf(j)==j){
                e.add(j-1,j+1);
                d1.mergef(j,j+1);
                j=d1.getf(j);
            }else{
                j=d1.getf(j);
            }
        }else return puts("QED"),0;
    }
}
```
核心思想是在输入条件过程中，利用并查集跳过已建边的重复段，同时判断是否存在矛盾（不同方向边冲突），从而优化建图过程。

3. **作者：言琢დ (4星)**
    - **关键亮点**：采用线性模拟思路，利用差分数组压缩信息，通过dfs遍历判断是否有矛盾，代码简洁，对信息的处理方式较为巧妙。
    - **重点代码及核心思想**：
```cpp
// 差分处理
if(s<t)++a[s],--a[t];
else ++b[s],--b[t];
// 还原差分数组
for(register int i=1;i<=n;++i) a[i]+=a[i-1]; 
for(register int i=n;i>=1;--i) b[i]+=b[i+1]; 
// 建图
for(register int i=2;i<n;++i)
    if(a[i]>0) AddEdge(i-1,i+1); 
for(register int i=2;i<n;++i)
    if(b[i]>0) AddEdge(i+1,i-1); 
// dfs判断矛盾
void dfs(int u){
    if(vis[u])return;
    vis[u]=1;
    for(register int i=head[u];i;i=s[i].next){
        register int v=s[i].to;
        dfs(v);
        if(!val[v])return;
    }
    val[u]=++val[0];
}
```
核心思想是通过差分记录条件关系，还原后建图，再通过dfs遍历图，若出现环则无解，否则可确定方案。

### 最优关键思路或技巧
1. **差分数组优化**：利用差分数组对区间操作进行优化，将 $O(qn)$ 的建边复杂度降低到 $O(n)$，减少时间和空间消耗。
2. **奇偶性分析**：发现大小关系只存在于奇数编号点之间和偶数编号点之间，将问题分为奇偶两块考虑，简化问题结构。
3. **贪心策略**：在确定字典序最小方案时，从左往右或从不等式链底端开始，贪心为每个点赋予尽可能小的值，保证字典序最小。

### 可拓展之处
同类型题目通常涉及根据给定条件构建关系图，并在图上进行判断和求解最优解。类似算法套路包括利用差分优化区间操作、通过拓扑排序或dfs判断图的性质（如是否有环）、贪心策略求解最优解等。

### 相似知识点洛谷题目
1. **P3243 菜肴制作**：涉及拓扑排序和字典序相关问题，与本题通过拓扑排序判断无解及求字典序最小方案思路类似。
2. **P1983 车站分级**：同样是根据给定条件构建图，判断图的性质并求解，可类比本题建图及判断无解的过程。
3. **P2882 [USACO07MAR]Face The Right Way G**：需要利用贪心策略解决问题，与本题贪心确定字典序最小方案的思路一致。

### 个人心得摘录及总结
暂未发现题解中有个人心得相关内容。 

---
处理用时：59.23秒
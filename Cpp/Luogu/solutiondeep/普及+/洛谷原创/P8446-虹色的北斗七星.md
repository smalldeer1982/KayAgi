# 题目信息

# 虹色的北斗七星

## 题目背景

**【题目背景与题意无关，可以直接阅读题目描述】**

（本题目背景部分改编自真实案例）

宇佐见莲子是外界的一名大学生，在京都的一所大学中专攻超统一物理学，最近在做弦论方面的研究。

莲子与梅莉一同经营着名为秘封俱乐部的社团。进行着在科学世纪探寻遍布四处的结界的活动。

这个月梅莉和莲子又商量着去进行新一轮的探索与发现与贴贴，但是在两人手牵手出门的时候甜腻腻的气氛却被一通电话打破。

莲子因为经常外出探险，同时与梅莉增进感情交流，所以作业一拖再拖。她的物理学教授忍无可忍（毕竟莲子可是拖了一个学期的物理作业一个字都没有动呢），规定她必须在 $\sqrt9$ 天之内交上一篇学习报告，然后才同意给她的“课外实践活动”报备。

这可就没有办法了呢（笑），莲子只好先努力在 deadline 之前糊弄完她的学习报告，然后才能执行她们观赏夜空的计划。

## 题目描述

由于前两天都被莲子用来进行活动的筹备工作了，所以现在她只有几分钟的时间糊弄作业。尽管这样不太好，但是她别无选择，只能从之前的课堂笔记中摘取一段内容。

莲子的课堂笔记共有 $n$ 章，每章分别记着不同的内容。她可以选择其中任意连续的一段 $[l,r]$（表示选取了第 $l$ 章到第 $r$ 章）作为最终的成果。

每一章的内容各不相同，老师对每章内容有一个评价分 $a_i$。因为学习报告要体现出学生的进步，所以老师的满意度将会加上其中最差（$\min\{a_i\}$）和最好章节（$\max\{a_i\}$）的评价分差距。因为直接把冗长的课堂笔记作为报告提交显得太敷衍，所以每存在一章内容，老师的满意度就会 $-1$。

形式化地来说，如果莲子提交了 $[l,r]$ 这一段区间的笔记，老师的满意度将会是 $\max\{a_l,a_{l+1},\cdots,a_r\}-\min\{a_l,a_{l+1},\cdots,a_r\}-(r-l+1)$。

莲子希望你能帮她找出一种使得老师的满意度最大的方案。因为她非常聪明，所以只需要你告诉她这个最大的满意度，她就会知道应该怎么做。

**【形式化题意】**

你有一个长度为 $n$ 的序列 $a$，它的一个区间 $[l,r]$ 的价值是 $\max\{a_l,a_{l+1},\cdots,a_r\}-\min\{a_l,a_{l+1},\cdots,a_r\}-r+l-1$。求这个序列价值最大的子区间并输出这个价值。

## 说明/提示

**【样例解释和说明】**

令 $l=4,r=5$，则有 $\min\{a_4,a_5\}=2$，$\max\{a_4,a_5\}=8$，贡献值为 $4$。易证这是满意度最大的子区间。

**【数据范围】**

- 对于 $20\%$ 的数据，$n\leq 5\times 10^3$。
- 另有 $20\%$ 的数据，所有的 $a_i$ 都相等。
- 对于 $100\%$ 的数据，$1\le n\le 4\times10^6$，$1 \leq a_i \leq 10^9$。

## 样例 #1

### 输入

```
6
5 2 4 2 8 8```

### 输出

```
4```

# AI分析结果

### 综合分析与结论
这些题解主要围绕如何找到使序列中某区间的“极差 - 区间长度”最大的子区间这一核心问题。多数题解首先证明了所求区间的两个边界必定对应区间内的最大值和最小值，这是解题的关键突破点。然后通过分类讨论，将原问题转化为两个子问题，进而通过维护前缀最值或利用单调队列等方式求解。

### 所选的题解
- **作者：retep (5星)**
    - **关键亮点**：思路清晰，详细阐述了从最初尝试多种算法失败到最终通过对问题转化的思考过程，逐步引导出解题方法。代码简洁明了，可读性强。
    - **个人心得**：作者分享了比赛时尝试多种算法（动态规划、二分答案、分治）均不可行，后意识到对 $r - l + 1$ 处理方式有误，通过分类讨论成功转化问题。
    - **核心代码片段**：
```cpp
#include<bits/stdc++.h>
#define N 4000005
#define ll long long
using namespace std;

int n,a[N],b[N],ans=-1;

inline int read(){
    int x=0,f=1;
    char ch=getchar();
    while(ch<'0'||ch>'9'){
        if(ch=='-')
            f=-1;
        ch=getchar();
    }
    while(ch>='0'&&ch<='9'){
        x=(x<<1)+(x<<3)+(ch^48);
        ch=getchar();
    }
    return x*f;
}

int main(){
	n=read();
	for(int i=1;i<=n;i++)
		a[i]=read(),b[i]=a[i]-i;
	for(int i=1,mn=1e9;i<=n;i++){
		mn=min(b[i],mn);
		ans=max(ans,b[i]-mn);
		b[i]=a[i]+i;
	}
	for(int i=1,mx=-1e9;i<=n;i++){
		mx=max(b[i],mx);
		ans=max(ans,mx-b[i]);
	}
	cout<<ans-1;
	return 0;
}
```
    - **核心实现思想**：先令 $b_i = a_i - i$，遍历数组计算 $b_i - \min\{b_j\}(j < i)$ 的最大值；再令 $b_i = a_i + i$，遍历数组计算 $\max\{b_j\}(j < i) - b_i$ 的最大值，最终取两者最大值减1作为答案。

- **作者：5k_sync_closer (4星)**
    - **关键亮点**：不仅给出了通用解法，还针对不同的数据范围和特殊性质分别讨论了子任务的解法，逻辑清晰，全面展示了对问题的理解和分析能力。
    - **核心代码片段**：
```cpp
#include <cstdio>
#include <algorithm>
using namespace std;
int n, x = 1e9, y = -1e9, q = -1e9;
int main()
{
    scanf("%d", &n);
    for(int i = 1, a, b, c;i <= n;++i)
    {
        scanf("%d", &a);
        x = min(x, b = a - i);y = max(y, c = a + i);
        q = max(q, b - x - 1);q = max(q, y - c - 1);
    }
    return printf("%d", q), 0;
}
```
    - **核心实现思想**：在遍历数组时，同时维护 $a_i - i$ 的前缀最小值 $x$ 和 $a_i + i$ 的前缀最大值 $y$，每次更新 $a_i - i - x - 1$ 和 $y - (a_i + i) - 1$ 的最大值作为答案。

- **作者：minstdfx (4星)**
    - **关键亮点**：通过严谨的数学推导，证明了答案子区间与端点之差减长度之间的关系，以及答案子区间的极值在端点处取到的结论，从理论上深入分析了问题。
    - **核心代码（未提交，思路关键代码）**：
```cpp
// 令 b_k = a_k - k
for (int i = 1; i <= n; ++i) {
    for (int j = i; j <= n; ++j) {
        ans = max(ans, b[j] - b[i] - 1);
    }
}
// 令 b_k = a_k + k
for (int i = 1; i <= n; ++i) {
    for (int j = i; j <= n; ++j) {
        ans = max(ans, b[i] - b[j] - 1);
    }
}
```
    - **核心实现思想**：通过数学推导将问题转化为求 $\max_{1 \le i \le j \le n}\{a_j - a_i - l\}$ 和 $\max_{1 \le i \le j \le n}\{a_i - a_j - l\}$，分别令 $b_k = a_k - k$ 和 $b_k = a_k + k$，通过双重循环遍历计算答案，可进一步优化为线性时间复杂度。

### 最优关键思路或技巧
1. **证明区间端点为最值**：通过反证法证明所求区间的两个端点必定是区间内的最大值和最小值，从而简化问题。
2. **问题转化**：将原问题转化为两个子问题，通过分类讨论，分别考虑最大值和最小值在不同端点的情况，进而通过维护前缀最值来求解。

### 可拓展思路与同类型题
此类题目属于序列区间最值问题，常见的拓展方向是增加限制条件或改变区间价值的计算方式。类似算法套路包括通过数学推导转化问题、利用单调性优化计算等。同类型题目如：
1. **P1886 滑动窗口 /【模板】单调队列**：通过单调队列解决滑动窗口内的最值问题，与本题利用单调性维护最值有相似之处。
2. **P3195 [HNOI2008]玩具装箱TOY**：通过分析问题的单调性，利用决策单调性优化动态规划，同样涉及到对问题的转化和单调性的应用。
3. **P2032 扫描线**：利用扫描线算法解决区间统计问题，在处理区间相关问题时，通过合理的数据结构和算法优化来提高效率，与本题思路有相通之处。

### 个人心得摘录与总结
1. **retep**：比赛时尝试多种常规算法无果，后反思对 $r - l + 1$ 的处理方式，通过分类讨论成功转化问题。总结出在面对复杂问题时，要敢于突破常规思维，重新审视问题中的关键部分。 

---
处理用时：67.79秒
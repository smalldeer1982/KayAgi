# 题目信息

# [加油武汉] 体温调查

## 题目背景

在疫情扩散后，疾控中心的医护人员对来自武汉的人员进行了家庭访问，对体温进行测量。医护人员从疾控中心出发，按照一定顺序对所有家庭进行访问，然后汇总数据。 

家庭列表上记录着类似于`A街道B小区C号楼D户`一样的住址，按照字典顺序排列，因此每个区域中的家庭在列表中总是相邻的。医护人员在访问完某个区域（比如B1小区）的所有家庭后，需要将数据送至上一层（比如A街道）的管理机构中，然后继续访问（比如B2小区）中的家庭。

也就是说，医护人员的移动路径类似一颗**树**，其中树根代表疾控中心，树叶代表家庭，而中间的结点代表一层一层的管理区域。结点的孩子代表下一层的区域（或者家庭），是有序的。从根到某个家庭的路径上所有的点正好组成了这个家庭的地址。 

![](https://cdn.luogu.com.cn/upload/image_hosting/6zfh4ofj.png)

如图，4家的地址分别为（按顺序）
- A1-B1-C1-Z1
- A1-B1-C1-Z2
- A1-B1-Z3
- A2-B2-C3-Z4

箭头仅代表归属关系，所有路均可双向通行。

本质上，题目给出的树就是住址构成的 **字典树**/**Trie树** 。

## 题目描述

给出一颗树，根结点编号为$1$。有一名医护人员从根出发，沿着树边移动，去每个叶子采集信息，最后返回根。他的采集顺序是固定的，每当走到一个结点$u$，他会先走向编号最小的孩子，并访问完其中所有的家庭并回到$u$，然后再走向编号第二小的孩子，依此直到访问完$u$子树中所有的家庭返回上一层。可以发现访问叶子的顺序也正好是家庭住址列表上的顺序。

沿着树边移动需要一定时间，为了节约时间，可以将家庭列表分成连续的$k$段，并让$k$个医护人员同时从根出发，每人访问一个区间中的家庭然后返回。请你计算出统计完所有家庭的体温所需要的最短时间。

## 说明/提示

对 $30\%$ 的数据，$1 \le n \le 20$

对另外 $10 \%$ 的数据，$k = 1$

对另外 $20 \%$ 的数据，$k = 2$

对 $100\%$ 的数据，$1 \le n \le 2*10^5, 1 \le k \le m, 1 \le u, v \le n, 0 \le w \le 10^9$，$m$为叶子数。

### 样例说明
图示见题目背景。

第一个人的路径为RT->Z1->Z2->RT，耗时66。

第二个人的路径为RT->Z3->Z4->RT，耗时32。

让一个人访问Z2，另一个人访问Z1、Z3、Z4的方案是不合法的。

## 样例 #1

### 输入

```
11 2
1 2 2
1 3 3
2 4 1
3 5 2
4 6 2
4 7 3
5 8 1
6 9 3
6 10 25
8 11 4
```

### 输出

```
66```

# AI分析结果

• 综合分析与结论：所有题解均采用二分答案的方法解决该问题。二分的对象是统计完所有家庭体温所需的最短时间。难点在于如何快速计算在给定时间内，一个医护人员能访问到的叶子节点数量，以及如何保证叶子节点的访问顺序。各题解在计算叶子节点间距离、判断时间是否满足要求的实现方式上略有不同。

所选的题解：
  - 作者：光明正大 (5星)
    - 关键亮点：思路清晰，详细阐述二分答案的过程，包括两次二分的原因及具体实现，对距离计算、叶子节点顺序保证等细节有清晰说明。
    - 个人心得：无
    - 重点代码核心思想：外层二分答案，在 `check` 函数中内层二分计算从叶子能到达的最远节点，利用预处理的 `dis` 数组（节点到根距离）和 `s` 数组（第一个叶子到第 `i` 个节点间距离），通过 `calc` 函数计算访问一定区间叶子节点所需时间。
```cpp
// 计算从i到j节点间访问所需时间
inline ll calc(int u,int v) {return s[v]+dis[st[v]]-s[u]+dis[st[u]];} 
// 二分能走到的位置
inline int erfen(int s,ll x) {
    int L=s,R=tot,res=s-1;
    while(L<=R) {
        int mid=(L+R)>>1;
        if(calc(s,mid)<=x) res=mid,L=mid+1;
        else R=mid-1;
    }
    return res;
}
// 检查mid时间是否满足要求
inline bool check(ll x) {
    int last=0,temp=0;
    for(int i=1;i<=k;i++) {
        temp=erfen(last+1,x);
        if(temp==last) return 0;
        if(temp>=tot) return 1;
        last=temp;
    }
    return temp==tot;
}
```
  - 作者：ycy1124 (4星)
    - 关键亮点：代码简洁，对题意理解深刻，`check` 函数实现思路清晰，直接在 DFS 过程中判断是否需要新增医护人员。
    - 个人心得：无
    - 重点代码核心思想：通过 `dfs` 预处理节点深度，在 `Dfs` 函数（用于 `check`）中，根据当前医护人员已走路程和下一段路程是否超过 `mid` 来决定是否新增医护人员。
```cpp
// 预处理深度
inline void dfs(int p,int fa,int w){
    dis[p]=w;
    ma=(w>ma?w:ma);
    for(auto it:a[p]){
        if(it.to==fa){
            continue;
        }
        dfs(it.to,p,w+it.w);
    }
}
// check函数中的DFS
inline void Dfs(int p,int fa,int mid){
    for(auto it:a[p]){
        if(it.to==fa){
            continue;
        }
        if(ww+it.w>mid){//再走路程就大于mid了
            Ans++;
            ww=dis[p];
        }
        ww+=it.w;
        Dfs(it.to,p,mid);
    }
}
```
  - 作者：FJ_OIer (4星)
    - 关键亮点：详细讲解一个医护人员用时的计算方法，利用倍增求 LCA 计算家庭间距离，贪心思想在 `check` 函数中体现清晰。
    - 个人心得：强调注意终止家庭返回时间的计算，因该点调试很久。
    - 重点代码核心思想：`dfs` 预处理叶子节点顺序数组 `a` 及节点到根距离 `d` 等，`check` 函数中贪心枚举 `a` 数组，根据距离计算判断是否需要新的医护人员。
```cpp
// 倍增求LCA
int LCA(int x,int y){ 
    if (de[x]<de[y]){
        swap(x,y);
    }
    for (int i=0,p=de[x]-de[y];p;i++,p>>=1){
        if (p&1){
            x=f[x][i];
        }
    }
    for (int i=lg;i>=0;i--){
        if (f[x][i]!=f[y][i]){
            x=f[x][i];
            y=f[y][i];
        }
    }
    return f[x][0];
}
// 检查mid时间是否满足要求
bool check(int x){
    int cnt=1,t=d[a[1]]*2;
    for (int i=2;i<=tot;i++){
        int dis=2*d[a[i]]+d[a[i-1]]-2*d[lca[i]];
        if (t-d[a[i-1]]+dis<=x){
            t=t-d[a[i-1]]+dis;
        }else{
            cnt++;
            if (cnt>k){
                return 0;
            }
            t=d[a[i]]*2;
        }
    }
    return 1;
}
```

最优关键思路或技巧：
 - **二分答案**：对于求最大值最小或最小值最大这类问题，二分答案是常用且有效的方法。通过二分答案，将原问题转化为判断在给定值下能否满足条件的问题。
 - **预处理优化**：预处理节点到根的距离、叶子节点顺序、LCA 等信息，能在后续计算中快速获取所需数据，降低时间复杂度。

可拓展之处：同类型题常涉及在树结构上进行分段优化，类似算法套路为二分答案结合贪心或其他树相关算法（如 LCA）。例如，给定一棵树，对树的边或节点进行划分，在满足一定条件下求某个最值。

推荐题目：
 - [P2678 跳石头](https://www.luogu.com.cn/problem/P2678)：二分答案经典题目，通过二分最短跳跃距离，判断是否能满足移走一定数量石头的条件。
 - [P3853 [TJOI2007]路标设置](https://www.luogu.com.cn/problem/P3853)：同样是二分答案，二分相邻路标间的最小距离，判断在给定路标数量限制下是否可行。
 - [P4556 [Vani有约会]雨天的尾巴](https://www.luogu.com.cn/problem/P4556)：结合树链剖分和线段树解决树上区间修改与查询问题，与本题在树结构处理上有相似之处。 

---
处理用时：61.88秒
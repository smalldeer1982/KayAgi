# 题目信息

# 「Wdoi-4」芙兰？姆Q！贤者与谜题

## 题目背景

题目背景不包含解题的关键信息，可以跳过。

---

芙兰朵露·斯卡蕾特是曾居住在红魔馆地下室的吸血鬼。与众不同的是，芙兰朵露有着彩色结晶的特殊翅膀，与其他吸血鬼蝙蝠一般的翅膀不同：颜色各异的结晶按照顺序一字排开。

芙兰朵露翅膀的彩色结晶的颜色从内到外分别是天蓝、蓝、紫、粉、橙、黄、淡绿和天蓝。因此事实上，芙兰朵露的翅膀很可能就是帕秋莉的「贤者之石」组成的。

但是芙兰朵露并不关心这些，她只关心排列成翅膀形状的贤者之石之间发生的能量流动——如果一块贤者之石被赋予了能量，就会处于激发态。处于激发态的贤者之石很不稳定——它大量能量的爆发会波及周围的贤者之石，以造成能量的转移。

芙兰朵露非常感兴趣，并以此出了一个谜题来考考帕秋莉。但是作为贤者的帕秋莉不想思考只想摸鱼，于是任务就交给你啦！![](https://www.luogu.com.cn/paste/tkub6dq3)

## 题目描述

芙兰朵露从帕秋莉那里搞来了 $n$ 块贤者之石，并从左往右排成了一列。帕秋莉可以赋予每块贤者之石一定的能级，这会决定贤者之石之间能量的传递。值得注意的是，**能级必须要是正整数，并且不能有两块贤者之石能级相同**。

如果第 $i$ 块贤者之石被赋予了能量（处于激发态），它就会将能量传递给第 $i-1$ 和第 $i+1$ 块里**能级较小**的那一块。特别地，如果某块贤者之石周围只有一块，那么它只会向这一块发送能量。注意，即使第 $i$ 块的能级低于第 $i-1$ 和第 $i+1$ 块，它**照样可以传输能量**。

现在芙兰有 $q$ 个条件——每个条件给定两个正整数 $s,t$，表示如果芙兰激活了第 $s$ 块贤者之石的能量，那么能量最终会经过第 $t$ 块。

然而由于帕秋莉有哮喘的老毛病，设定贤者之石的能级是很费力的。因此，如果存在一种合法的赋予贤者之石能级的方案，请你找出其中**字典序最小**的那个方案。对于两种方案 $A,B$，我们称 $A$ 的字典序小于 $B$，当且仅当存在一个 $p$，使得 $\forall i<p$ 有 $A_i=B_i$，且 $A_p<B_p$。 

如果存在合法方案，请你输出字典序最小的方案；否则输出 `QED`。

## 说明/提示

输入/输出样例 $2$ 见下发的附件 $\textbf{\textit{qed2.in}/\textit{qed2.out}}$。

输入/输出样例 $3$ 见下发的附件 $\textbf{\textit{qed3.in}/\textit{qed3.out}}$。

---

### 数据范围及约定

对于 $100\%$ 的数据，$0\le q \le 3\times 10^5$，$3\le n \le 3\times 10^5$，$1\le s_i,t_i \le n$。

$$
\def{\arraystretch}{1.5}
\begin{array}{|c|c|c|c|} \hline
\textbf{测试点} & \bm{n\le} & \bm{q\le} & \textbf{特殊限制} \cr \hline
1\sim 3 & 7 & 7 & - \cr \hline
4\sim6 & 100 & 100 & - \cr \hline
7 & 10^5 & 1 & -\cr \hline
8\sim 10 & 3\times 10^5 & 3\times 10^5 & s_i\le t_i \cr \hline
11\sim 12 & 10^5 & 10 & - \cr \hline
13\sim 20 & 3\times 10^5 & 3\times 10^5 & -\cr \hline
\end{array}$$


## 样例 #1

### 输入

```
10 4
1 2
3 7
8 10
5 6```

### 输出

```
1 4 8 3 7 2 6 10 5 9```

# AI分析结果

### 综合分析与结论
这些题解主要围绕如何根据给定条件构建贤者之石能级关系，并判断是否存在合法方案及找出字典序最小方案。
- **思路方面**：多数题解先将条件转化为大小关系，如通过连边表示能量传递方向。有的题解利用奇偶性将问题分为两条链处理，有的使用拓扑排序、并查集或差分等方式优化建图与判断过程。
- **算法要点**：建图时，根据条件确定边的方向和连接关系；判断无解情况，如检查是否存在矛盾的边或环；构造字典序最小方案，采用贪心策略，从左往右或按特定顺序为节点赋值。
- **解决难点**：主要难点在于优化建图以降低时间和空间复杂度，避免暴力建图导致超时或爆空间。部分题解通过差分数组、并查集等方式解决此问题。

### 所选的题解
1. **作者：囧仙 (5星)**
    - **关键亮点**：思路清晰，先将能量传递条件转化为图的边关系，利用奇偶性将问题简化为两条链处理，使用差分数组优化区间赋值，贪心策略确定字典序最小方案，代码简洁高效。
    - **重点代码**：
```cpp
// 核心实现思想：通过差分数组处理条件，判断无解情况，然后贪心构造方案
up(1,qread(),T){
    n=qread(),q=qread(),f=false,t=0;
    memset(A,0,sizeof(int)*(n+1));
    memset(B,0,sizeof(int)*(n+1));
    memset(N,0,sizeof(int)*(n+1));
    up(1,q,i){
        int s=qread(),t=qread();
        if(s<t) ++A[s-1],--A[t-1]; else if(s>t) ++B[t],--B[s];
    }
    up(1,n,i) A[i]+=A[i-1],B[i]+=B[i-1];
    up(1,n-2,i) if(A[i]&&B[i]) f=true;
    if(f){puts("QED");continue;}
    up(1,n,i) if(!N[i]){
        int c=1; for(int j=i;A[j]&&j+2<=n;j+=2) ++c;
        up(1,c,j) N[i+2*c-2*j]=++t;
    }
    up(1,n,i) printf("%d%c",N[i],i==n?'\n':' '); 
}
```
2. **作者：C_liar (4星)**
    - **关键亮点**：提出贪心 + 并查集优化思路，先通过拓扑排序判断无解情况，后用并查集优化建图过程，降低建图复杂度，代码逻辑清晰，对思路阐述详细。
    - **重点代码**：
```cpp
// 核心实现思想：利用并查集优化建图，在建图过程中判断无解，最后通过dfs构造方案
for(int i=1,s,t;i<=q;i++){
    scanf("%d%d",&s,&t);
    if(s==t) continue;
    if(s<t){
        for(int j=s;j<t;){
            if(j-1==0){j++;continue;} 
            if(d2.getf(j)!=d2.getf(j-1)){
                if(d1.getf(j)==j){
                    e.add(j-1,j+1);
                    d1.mergef(j,j+1);
                    j=d1.getf(j);
                }else{
                    j=d1.getf(j);
                }
            }else return puts("QED"),0;
        }
    }else{
        for(int j=s;j>t;){
            if(j==n){j--;continue;}
            if(d1.getf(j)!=d1.getf(j+1)){
                if(d2.getf(j)==j){
                    e.add(j+1,j-1);
                    d2.mergef(j,j-1);
                    j=d2.getf(j);
                }else{
                    j=d2.getf(j);
                }
            }else return puts("QED"),0;
        }
    }
}
for(int i=1;i<=n;i++){
    if(!dfn[i]) dfs(i);
}
```
3. **作者：Hanx16Kira (4星)**
    - **关键亮点**：详细分析题目条件得出大小关系规律，将连边操作转化为区间操作，使用差分维护，清晰阐述无解判断和赋值方法，代码实现简洁明了。
    - **重点代码**：
```cpp
// 核心实现思想：通过差分处理条件，判断无解，从不等式链底端向上贪心赋值
for (int i = 1; i <= q; i++) {
    int s, t;
    cin >> s >> t;
    if (s < t) A[s - 1]++, A[t - 1]--; 
    else if (s > t) B[s]--, B[t]++;
}
for (int i = 1; i <= n; i++) 
    A[i] += A[i - 1], B[i] += B[i - 1];
bool noAnswer = 0;
for (int i = 1; i <= n - 2; i++) 
    if (A[i] && B[i]) {noAnswer = 1; break;}
if (noAnswer) return puts("QED") & 0;
for (int i = 1; i <= n; i++) {
    if (!ans[i]) {
        int c = 1;
        for (int j = i; j + 2 <= n && A[j]; j += 2) c++; 
        for (int j = 1; j <= c; j++) ans[i + 2 * c - 2 * j] = ++cnt; 
    }
}
```

### 最优关键思路或技巧
- **利用奇偶性简化问题**：将节点按奇偶分成两条链，使问题更易于处理。
- **差分数组优化区间操作**：把条件转化为区间操作，用差分数组维护，降低建图复杂度。
- **贪心策略确定字典序最小方案**：从左往右或按特定顺序，根据节点在大小关系链中的位置，从底端向上赋值，保证字典序最小。

### 可拓展思路
此类题目属于构造性问题，常涉及图论、贪心策略和数据结构优化。类似套路包括根据条件构建图结构，利用拓扑排序、并查集等优化判断与构造过程，通过差分等方式处理区间操作。同类型题可考察不同的条件限制和构造要求，如改变能量传递规则、要求构造特定性质的序列等。

### 相似知识点洛谷题目
- [P3243 菜肴制作](https://www.luogu.com.cn/problem/P3243)：涉及拓扑排序和贪心策略，与本题部分思路相似。
- [P1983 车站分级](https://www.luogu.com.cn/problem/P1983)：通过建图和拓扑排序解决问题，考察图论相关知识。
- [P2882 [USACO07MAR]Face The Right Way G](https://www.luogu.com.cn/problem/P2882)：可利用差分数组优化区间操作，与本题优化思路类似。

### 个人心得摘录与总结
暂未发现题解中有个人心得相关内容。 

---
处理用时：71.27秒
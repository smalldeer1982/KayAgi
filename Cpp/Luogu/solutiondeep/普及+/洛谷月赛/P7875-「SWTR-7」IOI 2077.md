# 题目信息

# 「SWTR-7」IOI 2077

## 题目背景

#### 友情提醒：本题输入输出量很大，请不要使用 cin 或 scanf。题目最下方附有快读及其使用方法。

#### 赛时提醒：若对于选出的 $m$ 无解，则期望值为 $0$。可以结合样例 2 的解释说明以更好理解。

#### 赛时提醒：你需要求的是能力值之和的期望而不是最大值。

---

小 A 被 FCC 钦定参加 IOI 2077！71 岁老将请求出战！

## 题目描述

IOI 2077 有 $n$ 位**候选**参赛者，他们分别编号为 $1\sim n$。每位候选参赛者都有一个能力值，且**能力值互不相等**，第 $i$ 位候选参赛者的能力值为 $a_i$。小 A 更喜欢有序的数字，所以他将这 $n$ 位候选参赛者按照能力值**从小到大**排好了序，即**满足 $a_i<a_{i+1}\ (1\leq i<n)$。**

正式参赛者将会从这 $n$ 位候选参赛者中产生。具体地，所有参赛者将是候选参赛者的一个子串 $[l,r]$，即编号为 $l,l+1,\cdots,r$ 的选手将参加 IOI 2077，其中，小 A 的编号为 $k$。因为他知道自己被钦定参加 IOI 2077，所以 $l\leq k\leq r$。可能的参赛者一共有 $q$ 种情况，每种情况用三个数 $l_i,r_i,k_i\ (l_i\leq k_i\leq r_i)$ 描述，即参赛者为编号在区间 $[l_i,r_i]$ 中的候选参赛者，而小 A 的编号为 $k_i$。

由于自己太菜，小 A 对即将到来的 IOI 感到力不从心。他决定选择一些参赛者作为队友，并与他们在赛场上相互帮（zuo）助（bi）。具体地，设正式参赛人数为 $s$，那么小 A 会在 $[0,\lfloor\frac{s-1}{2}\rfloor]$ 中**等概率随机**选择一个数 $m$，并从 $s$ 位参赛者中**随机**选出 $2m$ 个作为他的队友。不过，小 A 不希望自己显得太菜，所以**他的能力值 $a_k$ 必须是这 $2m+1$ 个人的能力值的中位数**。

俗话说，人多力量大，小 A 希望他与所有选出的队友的能力值之和尽量地大。**不过在此之前，他想知道这个值的期望值是多少**。请对 $998244353$ 取模，保证答案在该模数下有意义。**对于每一种可能的参赛者情况，你都需计算该情况下的答案。为了避免过大的输出，你只需要计算所有答案的异或和。**

## 说明/提示

**「样例 1 说明」**

- 第 1 个询问：  
  因为 $s_1=r_1-l_1+1=5$，所以 $m$ 可以为 $0,1$ 或 $2$。  
  $m=0$ 时：小 A 没有队友，那么期望值就是他自身的能力值 $a_{k_1}=a_3=5$。    
  $m=1$ 时：小 A 可以选**编号** $(1, 4)$ 或 $(1, 5)$ 或 $(2, 4)$ 或 $(2, 5)$ 的参赛者作为他的队友，能力值之和分别为 $14,15,15,16$，期望值为 $\frac{14+15+15+16}{4}=15$。    
  $m=2$ 时：小 A 只能全选，期望值为 $2+3+5+7+8=25$。  
	综上，期望值为 $\frac{5+15+25}{3}=15$。

- 第 2 个询问：  
  因为 $s_2=r_2-l_2+1=3$，所以 $m$ 可以为 $0$ 或 $1$。  
  $m=0$ 时，小 A 没有队友，期望值为 $3$。    
  $m=1$ 时，小 A 无法选择，期望值为 $0$。  
  综上，期望值为 $\frac{3+0}{2}=\frac{3}{2}$，对 $998244353$ 取模后为 $499122178$。
  
$15\oplus499122178=499122189$。

**「数据范围与约定」**

**本题采用捆绑测试。**

记 $s_i=r_i-l_i+1$。

- Subtask #0（1 point）：是样例。
- Subtask #1（10 points）：$s_i\leq 2$。
- Subtask #2（20 points）：$s_i\leq 16$，$q\leq 40$，$n\leq 640$。
- Subtask #3（15 points）：$s_i,q\leq 500$，$n\leq 10^5$。
- Subtask #4（15 points）：$s_i,q\leq 3\times 10^3$，$n\leq 10^5$。
- Subtask #5（15 points）：$s_i,q\leq 2\times 10^5$，$n\leq 5\times 10^5$。
- Subtask #6（24 points）：无特殊限制。

对于 $100\%$ 的数据，$1\leq n,q\leq 2\times 10^6$，$1\leq l_i\leq k_i\leq r_i\leq n$，$1 \le a_i \le 998244352$，$a_i<a_{i+1}\ (1\leq i<n)$。

对于所有测试点，时间限制 1s，空间限制 512MB。

**「帮助/提示」**

关于 [有理数取余](https://www.luogu.com.cn/problem/P2613)，[中位数](https://baike.baidu.com/item/%E4%B8%AD%E4%BD%8D%E6%95%B0/3087401?fr=aladdin)。

本题输入输出量**极大**，**请注意 I/O 优化。**  
本题提供**有符号 32 位整数**快读模板，保证读入用时不超过 250ms：

```cpp
#define gc getchar()
inline int read(){
	int x=0; bool sgn=0; char s=gc;
	while(!isdigit(s))sgn|=s=='-',s=gc;
	while(isdigit(s))x=(x<<1)+(x<<3)+(s-'0'),s=gc;
	return sgn?-x:x;
}

// 如果需要读入直接调用 read() 即可。
// 一个例子（与正解无关，仅供参考）：

int t=read(),n=read(),q=read();
int a[2000005],l[2000005],r[2000005],k[2000005];
for(int i=1;i<=n;i++)a[i]=read();
for(int i=1;i<=q;i++)l[i]=read(),r[i]=read(),k[i]=read();

// 这样你就可以在 250ms 内读入全部数据了。
```

**「题目来源」**

[Sweet Round 07](https://www.luogu.com.cn/contest/51773) C。  
idea & solution：[SSerWarriors_Cat](https://www.luogu.com.cn/user/147999)；data：[Alex_Wei](https://www.luogu.com.cn/user/123294) ；验题：[chenxia25](https://www.luogu.com.cn/user/138400)。

---

IOI 2077 落下帷幕，小 A 凭借出（dui）色（you）的发（bang）挥（zhu）成功 AK 了 IOI，这不禁让他回想起曾经满腔热血的自己，以及和他共同奋斗在 OI 路上的战友们。如今他们虽已天各一方，说起来也有十几年没见过面了，但他们真挚的友谊未曾淡去，也将永远不会褪色。

>*“爷爷，您手机里有段录音，还写着 'ycx txdy!'。”*  
>*“哦，是嘛？放出来听听。”*  
>>*“I AK IOI. I AK ACM World Final. I AK Universe OI. I think all of you are vegetable chickens.”*  
>>*“I AK IOI. I AK ACM World Final. I AK Universe OI. I think all of you are vegetable chickens.”*  
>>*“I AK IOI. I AK ACM World Final. I AK Universe OI. I think all of you ............”*

2077.7.7

## 样例 #1

### 输入

```
0
5 2
2 3 5 7 8
1 5 3
2 4 2
```

### 输出

```
499122189```

# AI分析结果

### 综合分析与结论
这些题解的核心思路都是基于计算小A及其队友能力值之和的期望。由于小A能力值需为所选人员能力值中位数，所以在小A左右两侧选取人数相同。
1. **思路**：
    - **dingcx**：通过枚举小A左右两侧相等的人数，根据每个人被选中概率计算期望，利用前缀和优化，最后通过预处理逆元处理有理数取余。
    - **二gou子**：先考虑暴力枚举\(m\)，通过组合数分析每个元素被选次数，后发现可将分子分母约掉，转化为等差数列求和，通过预处理前缀和与逆元优化到\(O(n + q)\)。
    - **intel_core**：直接考虑每个人作为队友对答案的贡献，通过枚举计算概率，利用前缀和做到\(O(nq)\)，后将分式单独求和预处理优化。
    - **jockbutt**：先得出朴素式子，通过前缀和优化到\(O(nq)\)，后化简式子做到\(O(1)\)回答每个询问。
    - **Otomachi_Una_**：根据小A左右人数相同，计算左右两边数出现概率，得出期望值公式，利用费马小定理求逆元。
2. **算法要点**：都利用了前缀和优化计算，并且通过预处理逆元解决有理数取余问题。
3. **解决难点**：主要难点在于如何化简期望的计算，避免复杂的组合数计算以及处理取模问题。多数题解通过分析概率，将复杂的组合数计算简化为简单的数学运算。

综合质量来看，“dingcx”和“二gou子”的题解相对较好，思路清晰，代码简洁且有一定优化。

### 所选的题解
1. **作者：dingcx（5星）**
    - **关键亮点**：思路清晰，从枚举人数计算期望，到利用前缀和优化，再到预处理逆元处理有理数取余，步骤详细。代码简洁明了，直接实现核心思路。
    - **个人心得**：作者提到不能先算分子分母再取余，会有细节问题且超时，强调了预处理逆元处理取余的正确方式。
    - **核心代码片段**：
```cpp
int main(){
    int type=read(),n=read(),m=read(),ans=0;
    for(int i=1;i<=n;i++)
        a[i]=read(),s[i]=(s[i-1]+a[i])%MOD; //算前缀和
    inv[1]=1; //预处理逆元数组
    for(int i=2;i<=2e6;i++)
        inv[i]=(MOD-(MOD/i*inv[MOD%i]%MOD))%MOD;
    while(m--){
        ll l=read(),r=read(),k=read();
        ll mi=min(k-l,r-k),res;
        res=((mi+1)*a[k]%MOD+((mi*(mi+1)/2)%MOD)*(((s[k-1]-s[l-1]+MOD)*inv[k-l]%MOD+(s[r]-s[k]+MOD)*inv[r-k]%MOD)%MOD)%MOD;
        ans^=(res*inv[(r-l)/2+1]%MOD);
    }
    printf("%d\n",ans);
    return 0; 
}
```
核心实现思想：先读入数据并计算前缀和，预处理逆元。对于每个询问，计算左右两侧可选人数的最小值\(mi\)，根据期望公式计算结果，最后将所有询问结果异或得到最终答案。

2. **作者：二gou子（5星）**
    - **关键亮点**：从暴力思路出发，逐步分析优化，通过发现分子分母可约掉的特点，将问题转化为等差数列求和，优化过程清晰，代码实现简洁。
    - **核心代码片段**：
```cpp
while(q--){
    int l,r,k;
    scanf("%d%d%d",&l,&r,&k);
    ll summ=0,val=(ll)a[k],cnt1=k-l,cnt2=r-k,sum1=sum[k-1]-sum[l-1],sum2=sum[r]-sum[k];
    sum1=(sum1+mod)%mod;sum2=(sum2+mod)%mod;
    ll di1=inv[cnt1],di2=inv[cnt2],lim=min(cnt1,cnt2);
    summ=val*(lim+1)%mod;
    ll w=sum1*di1%mod+sum2*di2%mod;
    summ+=(lim+1)*lim%mod*inv[2]%mod*w%mod;
    summ%=mod;
    summ=(summ*inv[(r-l)/2+1])%mod;
    ans^=summ;
}
```
核心实现思想：对于每个询问，计算小A左右两侧人数\(cnt1\)、\(cnt2\)以及两侧能力值之和\(sum1\)、\(sum2\)，根据优化后的期望公式计算结果，最后将所有询问结果异或得到最终答案。

### 最优关键思路或技巧
1. **数学分析简化计算**：通过分析概率，发现组合数计算可简化，如将分子分母约掉转化为等差数列求和，避免复杂的组合数运算。
2. **前缀和优化**：利用前缀和快速计算一段区间内能力值之和，降低时间复杂度。
3. **预处理逆元**：由于涉及有理数取余，通过预处理逆元将除法转化为乘法，避免先算分子分母再取余带来的问题。

### 同类型题或类似算法套路
此类题目通常涉及概率、期望计算，结合数列相关知识。常见套路为分析问题本质，简化复杂的概率组合计算，利用数学性质优化。例如，在一些涉及从序列中选取元素计算期望的题目中，可通过分析每个元素的贡献概率，结合前缀和等优化方式求解。

### 推荐题目
1. **P2613 【模板】有理数取余**：直接考察有理数取余知识点，与本题中处理取余方式相关。
2. **P4316 绿豆蛙的归宿**：期望DP类型题目，与本题计算期望思路类似，锻炼期望计算能力。
3. **P1654 OSU!**：同样是期望相关题目，通过分析每个位置的贡献计算期望，可加深对期望计算的理解。 

---
处理用时：64.45秒
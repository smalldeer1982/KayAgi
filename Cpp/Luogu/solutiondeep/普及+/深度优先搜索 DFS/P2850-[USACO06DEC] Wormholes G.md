# 题目信息

# [USACO06DEC] Wormholes G

## 题目背景

[英文题面见此链接](https://www.luogu.com.cn/paste/mxuf6zpl)

## 题目描述

John 在他的农场中闲逛时发现了许多虫洞。虫洞可以看作一条十分奇特的有向边，并可以使你返回到过去的一个时刻（相对你进入虫洞之前）。

John 的每个农场有 $m$ 条小路（无向边）连接着 $n$ 块地（从 $1 \sim n$ 标号），并有 $w$ 个虫洞。

现在 John 希望能够从某块地出发，走过一条路径回到出发点，且同时也回到了出发时刻以前的某一时刻。请你告诉他能否做到。

## 说明/提示

#### 样例 2 解释

John 只需要沿着 $1 \rightarrow 2 \rightarrow 3 \rightarrow 1$ 的路径一直转圈即可，每转完一圈，时间就会减少一秒。

#### 数据范围与约定

对于 $100\%$ 的数据，$1 \le T \le 5$，$1 \le n \le 500$，$1 \le m \le 2500$，$1 \le w \le 200$，$1 \le p \le 10^4$。

## 样例 #1

### 输入

```
2
3 3 1
1 2 2
1 3 4
2 3 1
3 1 3
3 2 1
1 2 3
2 3 4
3 1 8```

### 输出

```
NO
YES```

# AI分析结果



### 综合分析与结论
本题核心是判断图中是否存在负权环。各题解主要采用以下方法：  
1. **Floyd全源最短路**：通过三重循环松弛边权，检测自环负权  
2. **DFS版SPFA**：利用深度优先搜索特性快速发现重复访问节点  
3. **BFS版SPFA**：统计节点入队次数或路径边数判断负环  
4. **超级源点技巧**：建立虚拟节点简化多起点问题  
5. **Bellman-Ford**：通过N-1轮松弛后仍能松弛的边判断负环  

DFS版SPFA在负环检测中表现最优，时间复杂度最坏仍为O(nm)但实际效率较高。超级源点技巧可优化多起点场景，但需注意正确性。

---

### 高星题解推荐（评分≥4★）

#### 1. wjy666（4★）  
**关键亮点**：  
- 使用DFS版SPFA快速检测负环（发现重复访问立即返回）  
- 以每个节点为起点进行检测，确保覆盖所有可能负环  
- 代码简洁，使用vector存图便于理解  
**核心代码**：  
```cpp
void spfa(int k) {
    if (fl[k]==1) {fl[k]=0; flag=1; return;}
    fl[k]=1;
    for(auto e : mp[k]) {
        if (sum[e.nex] > e.dis + sum[k]) {
            sum[e.nex] = e.dis + sum[k];
            spfa(e.nex);
            if(flag) return;
        }
    }
    fl[k]=0;
}
```
**实现思想**：利用递归栈记录访问路径，当某节点第二次被访问时立即判定存在负环。

#### 2. Sakura_Peng（4★）  
**关键亮点**：  
- 引入超级源点连接所有节点，统一检测负环  
- 初始距离设为0，仅处理负权松弛，加速检测  
- 使用链式前向星存图，空间效率高  
**核心代码**：  
```cpp
void pd(int x) {
    if (flag) return;
    if(vis[x]) { flag=1; return; }
    vis[x]=1;
    for(int i=head[x]; i; i=e[i].next) {
        if(dis[e[i].to] > dis[x]+e[i].w) {
            dis[e[i].to] = dis[x]+e[i].w;
            pd(e[i].to);
        }
    }
    vis[x]=0;
}
```
**技巧总结**：通过虚拟节点将多起点问题转化为单源问题，初始距离置零聚焦负权边。

#### 3. EightSixSun（4★）  
**关键亮点**：  
- 每次SPFA前重置距离数组为0，聚焦负权松弛  
- 使用前向星存图提升访问效率  
- 通过访问标记数组避免重复搜索  
**调试心得**：  
> "初始时将dis数组全部设为0，这样只有负权边才会触发松弛，极大减少无效计算"

---

### 关键优化思路总结
1. **DFS版SPFA优势**：利用递归栈天然记录路径，比BFS更早发现环状结构  
2. **负权聚焦**：初始化距离为0，仅处理负权松弛，减少计算量  
3. **超级源点技巧**：将多起点检测转为单源问题，避免重复初始化  
4. **前向星存图**：相比邻接矩阵更省空间，适合稀疏图  

---

### 推荐相似题目
1. [P3385 负环模板](https://www.luogu.com.cn/problem/P3385)  
2. [P2136 拉近关系](https://www.luogu.com.cn/problem/P2136)（负权边应用）  
3. [P2868 观光奶牛](https://www.luogu.com.cn/problem/P2868)（分数规划+负环判断）  

---

### 个人心得摘录
1. **初始化陷阱**：  
   > "多组数据必须清空前向星！我曾因忘记重置head数组WA了5次" ——C20210114卢思吉  
2. **负环检测本质**：  
   > "SPFA中若某点入队超过n次，必存在负环，这是由路径单调性决定的" ——ljcljc  
3. **算法选择**：  
   > "Floyd代码简单但别用于n>500，血的教训！" ——Drifting

---
处理用时：68.97秒
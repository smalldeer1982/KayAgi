# 题目信息

# [USACO17FEB] Why Did the Cow Cross the Road III S

## 题目描述

奶牛为什么要过马路？其中一个原因是 Farmer John 的农场有很多道路，使得他的奶牛在四处走动时不可避免地要穿过许多道路。

FJ 的农场被安排成一个 $N \times N$ 的方形网格田地（$2 \leq N \leq 100$），某些相邻的田地（例如南北向或东西向）被道路分隔，整个网格的外部有一圈高高的围栏，防止奶牛离开农场。奶牛可以从任何田地自由移动到相邻的田地（北、东、南或西），尽管它们除非绝对必要，否则不愿意穿过道路。

农场上有 $K$ 头奶牛（$1 \leq K \leq 100, K \leq N^2$），每头奶牛位于不同的田地。如果一头奶牛要拜访另一头奶牛时必须至少穿过一条道路，那么这对奶牛被称为“远距离”对。请帮助 FJ 计算远距离奶牛对的数量。

## 样例 #1

### 输入

```
3 3 3
2 2 2 3
3 3 3 2
3 3 2 3
3 3
2 2
2 3```

### 输出

```
2```

# AI分析结果



### 综合分析与结论
题目核心是求必须穿过道路的奶牛对数，等价于统计处于不同连通块的牛对数量。所有题解均采用连通块染色（DFS/BFS）结合乘法原理的思路，主要差异在于道路存储方式及空间优化技巧。关键难点在于正确建模道路阻断关系，避免MLE。

---

### 精选题解推荐

#### 1. 作者：hht2005（★★★★★）
**关键亮点**  
- 使用二进制位压缩存储道路，节省空间且提升判断效率  
- 循环队列优化BFS空间  
- 输出时利用乘法原理累加，避免二重循环  
**个人心得**  
-"存图时用二维数组进行二进制压缩省空间"  
-"每头牛被计算两次，需除以2"  

**核心代码**  
```cpp
int bfs(int ii,int jj){
    int q1=0,q2=1,sum=0;
    b[ii][jj]=1;
    q[0][0]=ii; q[0][1]=jj;
    while(q1!=q2){
        int x=q[q1][0],y=q[q1][1];
        if(++q1==210)q1=0;
        sum += f[x][y];
        for(int i=0;i<4;i++){
            int xx=x+dx[i],yy=y+dy[i];
            if(!(c[x][y]&1<<i) && !b[xx][yy]){ //位运算判断通路
                b[xx][yy]=1;
                q[q2][0]=xx; q[q2][1]=yy;
                if(++q2==210)q2=0;
            }
        }
    }
    return sum;
}
```

#### 2. 作者：chenxuanting（★★★★☆）
**关键亮点**  
- 三维数组直观存储各方向道路  
- 使用vector动态记录连通块牛数  
- 代码结构清晰易理解  

**核心实现**  
```cpp
void dfs(int x,int y){
    color[x][y]=num;
    if(b[x][y]==1) all++;
    for(int i=0;i<4;i++){
        if(a[x][y][i]==1) continue; //检查该方向是否有路
        int xx=x+dx[i], yy=y+dy[i];
        dfs(xx,yy);
    }
}
```

#### 3. 作者：OfstAutomataMachine（★★★★☆）
**关键亮点**  
- 通过图示明确三维数组各维度含义  
- 对比四维数组方案给出MLE教训  
- 详细注释帮助理解方向处理  

**关键代码**  
```cpp
if(a==c+1) wall[a][b][1]=wall[c][d][2]=1; //处理南北方向道路
if(c==a+1) wall[a][b][2]=wall[c][d][1]=1;
if(b==d+1) wall[a][b][3]=wall[c][d][4]=1; //处理东西方向道路
if(d==b+1) wall[a][b][4]=wall[c][d][3]=1;
```

---

### 最优技巧总结
1. **道路存储技巧**  
   - 三维数组`a[x][y][dir]`标记各方向道路（北、东、南、西）  
   - 或使用二进制压缩（如`c[x][y]`的4个位分别表示四个方向）  

2. **连通块染色优化**  
   - 预处理边界减少条件判断  
   - 使用循环队列降低BFS空间消耗  

3. **统计计算技巧**  
   - 保存各连通块牛数列表，最后遍历组合相乘求和  
   - 避免重复计算（如总对数除以2）

---

### 同类题目推荐
1. [P1457 城堡](https://www.luogu.com.cn/problem/P1457) - 同样需要处理方向性障碍  
2. [P1141 01迷宫](https://www.luogu.com.cn/problem/P1141) - 连通块染色基础题  
3. [P2746 [USACO5.3]校园网](https://www.luogu.com.cn/problem/P2746) - 连通块在图的扩展应用

---
处理用时：56.79秒
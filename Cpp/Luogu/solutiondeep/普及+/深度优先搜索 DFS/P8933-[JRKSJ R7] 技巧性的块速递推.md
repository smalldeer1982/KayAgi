# 题目信息

# [JRKSJ R7] 技巧性的块速递推

## 题目背景

充分必要，切比雪夫。

原来还是，不需要了。

## 题目描述

一个 $n\times m$ 的棋盘，对每个格子染上黑白两色之一。

询问有多少种染色方式，使得不存在横、竖、斜连续四个格子中存在至少三个相同颜色的格子，并且不存在横、竖、斜连续三个格子的颜色相同。

若设棋盘的左上角为 $(1,1)$，右下角为 $(n,m)$，则称 $\{(x,y),(x+1,y),(x+2,y)\}$ 为横的连续三个格子，$\{(x,y),(x,y+1),(x,y+2)\}$ 为竖的连续三个格子、$\{(x,y),(x+1,y+1),(x+2,y+2)\}$ 和 $\{(x,y),(x+1,y-1),(x+2,y-2)\}$ 为斜的连续三个格子（以上格子均在棋盘内）。

连续四个格子同理。

## 说明/提示

### 样例解释

样例 $1$：显然任意染色均合法，答案为 $2^4=16$。

样例 $2$：

```
101
110
010
```

这是合法方案之一。

```
111
110
011
```

这是不合法方案之一，因为 $\{(1,1),(1,2),(1,3)\}$、$\{(1,2),(2,2),(3,2)\}$ 和 $\{(1,1),(2,2),(3,3)\}$ 均不满足条件。

### 数据规模

本题采用捆绑测试。
| $\text{Subtask}$ | $n,m\le$ | $\text{Score}$ |
| :----------: | :----------: | :----------: | 
| $1$ | $30$ | $40$ |
| $2$ | $10^9$ | $60$ |

对于 $100\%$ 的数据，$1\le T\le 10^5$，$1\le n,m\le 10^9$。

## 样例 #1

### 输入

```
1
2 2```

### 输出

```
16```

## 样例 #2

### 输入

```
1
3 3```

### 输出

```
32```

# AI分析结果



### 综合分析与结论
题目要求满足特定连续染色条件的棋盘方案数。核心难点在于处理超大范围的棋盘（$n,m\le 10^9$）和复杂的约束条件。通过分析各题解，发现关键思路是发现周期性规律，预处理小范围棋盘结果，并通过剪枝优化搜索。

---

### 高星题解推荐

#### 1. 作者：WER_very_fox（★★★★★）
**关键亮点**：
- 发现每四行/列颜色重复的周期性规律，预处理到6×6即可覆盖所有情况。
- 直接打表预处理结果，代码简洁高效。
- 通过严谨的数学推导验证周期性，避免不必要的复杂搜索。

**个人心得**：
- 通过观察四格约束得出周期性，减少预处理范围。
- 使用对称性分析避免重复计算。

**核心代码**：
```cpp
int a[6][6]={{2,4,6,6,6,6},{4,16,36,36,36,36},{6,36,32,20,16,16},
             {6,36,20,10,8,8},{6,36,16,8,8,8},{6,36,16,8,8,8}};
// 预处理1x1到6x6的答案
printf("%d\n", a[min(n-1,5)][min(m-1,5)]); // 输入n,m直接查表
```

---

#### 2. 作者：zhangxiao666（★★★★☆）
**关键亮点**：
- 利用连续四格约束推导出棋盘周期性，预处理7×7的结果。
- 在DFS中引入剪枝（当列≥4时直接确定颜色），大幅优化搜索效率。
- 代码结构清晰，注释详细。

**核心实现**：
```cpp
void dfs(int x, int y) {
    if (y >= 4) { // 剪枝：前三格确定当前格颜色
        int sum = 0;
        for (int i = y-3; i <= y-1; i++) sum += a[x][i];
        a[x][y] = (sum == 1) ? 1 : 0; // 保证四格中恰有2黑2白
        dfs(x, y+1);
        return;
    }
    // 枚举当前格颜色...
}
```

---

#### 3. 作者：__ex（★★★★☆）
**关键亮点**：
- 提出斜向问题最多影响7×7范围，预处理到7×7即可。
- 通过图示直观解释周期性扩展中的矛盾点。
- 剪枝逻辑与数学推导紧密结合。

---

### 最优思路总结
1. **周期性剪枝**：当棋盘尺寸≥4时，颜色分布呈4×4周期，更大的棋盘可等效为小尺寸。
2. **预处理小范围**：通过DFS+剪枝预处理6×6或7×7的所有情况，直接查表回答询问。
3. **斜向约束处理**：扩大预处理范围至7×7，确保覆盖所有可能的斜向冲突。

---

### 拓展与同类题目
1. **周期性规律应用**：类似问题如[P6900 矩阵计数](https://www.luogu.com.cn/problem/P6900)，利用周期性减少状态空间。
2. **剪枝优化搜索**：适用于需要枚举但状态可推导的问题，如[P1378 油滴扩展](https://www.luogu.com.cn/problem/P1378)。
3. **棋盘约束问题**：[P1219 八皇后](https://www.luogu.com.cn/problem/P1219)（经典行列对角线约束）。

**推荐练习**：
1. [P1357 花园](https://www.luogu.com.cn/problem/P1357)（环形矩阵+状态压缩）
2. [P2106 Sam数](https://www.luogu.com.cn/problem/P2106)（递推+矩阵快速幂）
3. [P4910 帕秋莉的手环](https://www.luogu.com.cn/problem/P4910)（环形DP+矩阵优化）

---
处理用时：90.26秒
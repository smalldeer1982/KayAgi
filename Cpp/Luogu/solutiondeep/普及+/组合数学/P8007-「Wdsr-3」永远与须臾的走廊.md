# 题目信息

# 「Wdsr-3」永远与须臾的走廊

## 题目背景

永远亭是迷途森林里的不可思议的屋子。

为了躲避月之使者的到来，也是为了防御，永远亭内被布下了一条无尽的长廊。困在其中的对手无法触及到真实，陷入到永远与须臾的陷阱里去。

不过，无尽的长廊 $S$ 毕竟只是单一有限走廊 $S_0$ 的无限循环，其本质是永远亭的主人蓬莱山辉夜及八意永琳设下的圈套。正因该长廊是通过辉夜的能力实现的，因此辉夜可以通过修改该「有限长的」走廊 $S_0$，进而作用于「无限长的」长廊 $S$。这意味着有限的修改可以创造出无限的变动。

光秃秃的长廊显得单调，也难以起到掩人耳目的目的。辉夜决定在长廊上绘制象征着月初的「上弦月」和象征着月末的「下弦月」，以达到图案交错重叠的目的。为了方便起见，「上弦月」可以被近似认为是左括号，而「下弦月」可以被近似认为是右括号。作为优雅的月之都的公主，当然会有不少条条框框——轮到你帮助辉夜满足她的要求了。

## 题目描述

辉夜希望创造一个无限长的括号序列 $S$ 作为永远亭长廊的绘制图案，它由一个长度为 $n$ 的括号序列 $S_0$ 不断重复而成。

我们称一个括号序列 $T$ 是合法的，当且仅当它可以由以下方式生成：

- $\verb!()!$ 是一个合法的括号序列。  
- 如果 $A$ 是合法括号序列，那么 $\verb!(!A\verb!)!$ 同样是一个合法括号序列。  
- 如果 $A,B$ 都是合法括号序列，那么 $AB$（即 $A,B$ 拼接）同样是一个合法括号序列。

例如，$\verb!(()())!,\verb!()()!,\verb!((()())())!$ 都是合法括号序列；而 $\verb!)(!,\verb!(()!,\verb!())(()!$ 均不是合法括号序列。

现在辉夜已经确定了 $S_0$ 当中一部分的符号。你需要求出，「在剩下来的单元上绘制括号，使得这条无限长的长廊上可以找到**无限长的**合法括号序列」的方案数。两种方案不同仅当两种方案中有至少一个位置的 `?` 被替换成了不同的字符。输出它对 $998,244,353$（一个大质数）取模后的结果。

## 说明/提示

#### 样例 1 解释

符合条件的方案共有三种：$\verb!(())!$、$\verb!()()!$ 和 $\verb!())(!$。

- 第一种方案，$\overbrace{\text{\tt\textcolor{red}{(())}\textcolor{blue}{(())}\texttt{...}\textcolor{red}{(())}\textcolor{blue}{(())}}}^{\text{无穷个}}$ 可以找到无限长的合法括号序列。
- 第二种方案，$\overbrace{\text{\tt\textcolor{red}{()()}\textcolor{blue}{()()}\texttt{...}\textcolor{red}{()()}\textcolor{blue}{()()}}}^{\text{无穷个}}$ 同样可以找到无限长的合法括号序列。
- 第三种方案，$\text{\tt\textcolor{red}{())}}\overbrace{\text{\tt\textcolor{red}{(}\textcolor{blue}{())(}\texttt{...}\textcolor{red}{())(}\textcolor{blue}{())}}}^{\text{无穷个}}\text{\tt\textcolor{blue}{(}}$ 仍然可以找到无穷长的括号序列。

可以证明，不存在其他方案。

#### 数据范围及约定

$$
\def{\arraystretch}{1.5}
\begin{array}{|c|c|c|c|}\hline
\textbf{Subtask} & \bm{n\le } & \textbf{特殊性质} & \textbf{分值} \cr\hline
1 & 20 & - & 20 \cr\hline
2 & 10^5 & \text{A} & 10 \cr\hline
3 & 10^5 & \text{B} & 10 \cr\hline
4 & 10^5 & - & 60 \cr\hline
\end{array}
$$

**特殊性质** $\textbf{A}$：保证字符串里仅出现 $\verb!(!$ 和 $\verb!)!$。  
**特殊性质** $\textbf{B}$：保证字符串里仅出现 $\verb!?!$。

对于全部数据，满足 $1\le n\le 10^5$，且字符串里仅出现 $\verb!(!,\verb!)!,\verb!?!$ 三种字符。

## 样例 #1

### 输入

```
4
(???
```

### 输出

```
3```

## 样例 #2

### 输入

```
8
(???))??```

### 输出

```
10```

# AI分析结果

### 综合分析与结论
这些题解的核心思路都是证明并利用“方案合法当且仅当左括号数目和右括号数目相等”这一结论来解题。具体做法是统计已知的左括号、右括号和问号的数量，通过解方程得出需要将多少个问号替换为左括号，进而利用组合数计算方案数，同时注意处理 $n$ 为奇数、左右括号数量超过 $n/2$ 等特殊情况。不同题解在证明结论、代码实现细节（如组合数计算、逆元求解）上略有差异。

### 所选的题解
- **作者：囧仙 (5星)**
    - **关键亮点**：思路清晰，先给出核心结论，再通过将括号序列转化为折线图，直观地证明了结论。代码实现完整，注释详细，对组合数计算、快速幂求逆元等关键步骤都有清晰的函数实现。
    - **重点代码 - 组合数计算函数**：
```cpp
int chs(int x, int y){
    if(y<0||y>x) return 0;
    int r=1,s=1,t=1; up(1,x,i){
        r=1ll*r*i%MOD; if(i==y) s=r; if(i==x-y) t=r;
    }
    return 1ll*r*pwr(s,MOD-2)%MOD*pwr(t,MOD-2)%MOD;
}
```
核心思想是通过循环计算阶乘，并利用快速幂求出逆元，从而得出组合数。
- **作者：2huk (4星)**
    - **关键亮点**：将原问题转化为“把 $S_0$ 复制两份使得这个长度为 $2n$ 的括号序列中存在长度 $\ge n$ 的括号序列的数量”，从另一个角度理解问题，使思路更加清晰。代码实现规范，对组合数的预处理和计算有明确的模块。
    - **重点代码 - 组合数计算模块**：
```cpp
namespace Combination
{
    const int P = 998244353;
    int fac[N], inv[N];
    int mod(int a) { return (a % P + P) % P; }
    int mul(int a, int b) { return mod(mod(a) * mod(b)); }
    int mul(int a, int b, int c) { return mul(mul(a, b), c); }
    int fpm(int a, int b) {
        int res = 1;
        while (b) {
            if (b & 1) res = mul(res, a);
            b >>= 1, a = mul(a, a);
        }
        return res;
    }
    void init(int n) {
        fac[0] = 1;
        for (int i = 1; i <= n; i ++ ) fac[i] = mul(fac[i - 1], i);
        inv[n] = fpm(fac[n], P - 2);
        for (int i = n - 1; i >= 1; i -- ) inv[i] = mul(inv[i + 1], i + 1);
    }
    int C(int x, int y) {
        if (x < y) return 0;
        if (!y) return 1;
        return mul(fac[x], inv[y], inv[x - y]);
    }
};
```
核心思想是通过预处理阶乘和逆元，利用快速幂计算逆元，从而高效地计算组合数。
- **作者：XL4453 (4星)**
    - **关键亮点**：对“方案合法当且仅当左括号数目和右括号数目相等”这一结论进行了严格的充分性和必要性证明。代码实现简洁明了，直接利用快速幂求逆元计算组合数。
    - **重点代码 - 组合数计算函数**：
```cpp
int calc(int n, int m){
    if(m<0||m>n)return 0;
    int ans=1;
    for(int i=n;i>n-m;i--)ans=(ans*i)%MOD;
    for(int i=2;i<=m;i++)
    ans=(ans*pow(i,MOD-2)%MOD)%MOD;
    return ans;
}
```
核心思想是通过循环计算分子和分母，利用快速幂求分母的逆元，从而得出组合数。

### 最优关键思路或技巧
将括号序列问题转化为数学计算问题，通过证明核心结论简化问题求解。在代码实现上，利用快速幂求逆元来计算组合数是一个通用且高效的技巧。

### 可拓展思路
此类题目属于组合数学与括号序列结合的问题，类似套路可用于处理其他具有特定规则的序列填充、排列组合问题。例如，给定一些字符和特定规则，求满足规则的字符串组合数。

### 相似知识点洛谷题目
- [P1313 计算系数](https://www.luogu.com.cn/problem/P1313)：涉及二项式定理和组合数计算。
- [P2822 [NOIP2016 提高组] 组合数问题](https://www.luogu.com.cn/problem/P2822)：专注于组合数取模等相关计算。
- [P3807 【模板】卢卡斯定理](https://www.luogu.com.cn/problem/P3807)：考察卢卡斯定理在组合数计算中的应用。

### 个人心得摘录与总结
- **作者：Lvlinxi2010**：提到自己被一般括号序列需满足的第二个条件（每个右括号出现时，左边有可配对左括号）误导很久，在本题无限循环情况下该条件不必要，因为无限循环可调整括号位置使其配对。总结出在处理特殊条件下的括号序列问题时，不能直接套用常规判断条件，需深入分析题目特殊性质。 

---
处理用时：33.07秒
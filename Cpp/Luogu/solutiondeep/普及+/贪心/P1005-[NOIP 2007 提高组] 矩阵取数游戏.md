# 题目信息

# [NOIP 2007 提高组] 矩阵取数游戏

## 题目描述

帅帅经常跟同学玩一个矩阵取数游戏：对于一个给定的 $n \times m$ 的矩阵，矩阵中的每个元素 $a_{i,j}$ 均为非负整数。游戏规则如下：

1. 每次取数时须从每行各取走一个元素，共 $n$ 个。经过 $m$ 次后取完矩阵内所有元素；
2. 每次取走的各个元素只能是该元素所在行的行首或行尾；
3. 每次取数都有一个得分值，为每行取数的得分之和，每行取数的得分 = 被取走的元素值 $\times 2^i$，其中 $i$ 表示第 $i$ 次取数（从 $1$ 开始编号）；
4. 游戏结束总得分为 $m$ 次取数得分之和。

帅帅想请你帮忙写一个程序，对于任意矩阵，可以求出取数后的最大得分。


## 说明/提示

**【数据范围】**

对于 $60\%$ 的数据，满足 $1\le n,m\le 30$，答案不超过 $10^{16}$。  
对于 $100\%$ 的数据，满足 $1\le n,m\le 80$，$0\le a_{i,j}\le1000$。

**【题目来源】**

NOIP 2007 提高第三题。





## 样例 #1

### 输入

```
2 3
1 2 3
3 4 2
```

### 输出

```
82```

# AI分析结果



### 综合分析与结论

本题核心思路为**行独立处理+区间DP**，各题解均围绕此展开。关键难点在于状态转移设计及大数处理（需用高精度或`__int128`）。不同实现主要在状态定义方向（正向或逆向）、权值计算方式（显式幂或累积×2）上存在差异。

---

### 高星题解推荐

#### 1. 题解作者：zhylj（⭐⭐⭐⭐⭐）
**关键亮点**：
- 最简洁的转移方程：将权值计算转化为每次转移×2，避免显式计算2的幂次。
- 使用`__int128`简化代码，代码量极短（核心仅10行）。
- 逆向思维：定义状态为取完区间后的结果，直接累计到总答案。

**核心代码思路**：
```cpp
for(int len=0;len<=m;++len)
    for(int i=1;i+len<=m;++i)
        f[i][i+len]=max(2*f[i+1][i+len]+2*a[i], 2*f[i][i+len-1]+2*a[i+len]);
```
**个人心得**：通过将每次转移后的得分×2，巧妙处理了权值与取数次数的关系，避免复杂幂次计算。

#### 2. 题解作者：qhr2023（⭐⭐⭐⭐）
**关键亮点**：
- 极简代码风格（总行数最短）。
- 预处理2的幂次加速计算，循环顺序清晰。
- 使用`__int128`并手写输出函数，兼顾效率与兼容性。

**核心实现**：
```cpp
for(int len=1;len<=m;++len) 
    for(int l=1,r=l+len-1; r<=m; ++l,++r)
        f[l][r]=max(f[l+1][r]+a[l], f[l][r-1]+a[r])*2;
```

#### 3. 题解作者：Tomwsc（⭐⭐⭐⭐）
**关键亮点**：
- 详细注释与变量命名，可读性强。
- 预处理快速幂优化，状态转移方向明确。
- 包含完整的`__int128`读写实现，适合学习。

**代码亮点**：
```cpp
memset(dp,0,sizeof(dp));
for(int j=1;j<=m;j++)
    for(int k=m;k>=j;k--)
        dp[j][k] = max(..., ...); // 显式处理左右端点
```

---

### 最优关键思路与技巧

1. **权值处理技巧**：  
   通过每次转移时×2代替计算2^k（如zhylj解法），将复杂度从O(m²logm)降为O(m²)，避免高精度乘法。

2. **状态定义方向**：  
   定义`f[l][r]`为取完区间[l,r]后的最大得分，通过`len`从小到大遍历，自然覆盖所有子问题。

3. **大数处理选择**：  
   优先使用`__int128`（若OJ支持），其次用高精度类。注意输出时需要手写递归输出函数。

4. **循环顺序优化**：  
   外层循环为区间长度，内层为起点，确保小区间先于大区间计算。

---

### 拓展与相似题目

1. **区间DP变种**  
   - [P1430 序列取数](https://www.luogu.com.cn/problem/P1430)  
   - [P1004 方格取数](https://www.luogu.com.cn/problem/P1004)  

2. **大数处理训练**  
   - [P1249 最大乘积](https://www.luogu.com.cn/problem/P1249)（高精度乘法应用）

3. **双端取数模型**  
   - [P2858 [USACO06FEB]Treats for the Cows G](https://www.luogu.com.cn/problem/P2858)

---

### 题解个人心得摘录

1. **Jack_Homes_Huang**：  
   > "高精度好烦的...我调了n年才发现循环变量写错"  
   → **教训**：高精度类需严格测试，变量命名避免混淆（如m写成n）。

2. **lihongru**：  
   > "注意转移时的次数计算为`m-j+i-1`，需自行模拟验证"  
   → **调试技巧**：对边界情况（如取完最后一个元素）手动推演验证。

3. **MoonCake2011**：  
   > "定义状态为还剩区间时，答案需遍历所有单点"  
   → **关键点**：明确状态定义后，确定最终答案的收集方式。

---
处理用时：62.23秒
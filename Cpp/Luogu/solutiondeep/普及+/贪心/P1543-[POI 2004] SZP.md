# 题目信息

# [POI 2004] SZP

## 题目背景

一班班花 [$\color{red}{\texttt{y}}\color{black}{\texttt{hb}}$](/user/835809) 十分可爱。

## 题目描述

班花 [$\color{red}{\texttt{y}}\color{black}{\texttt{hb}}$](/user/835809) 作为某日的值日班长，在自习课上管理着 $n$ 名同学。除了她以外每一名同学都监视着另一名同学。现在班花 [$\color{red}{\texttt{y}}\color{black}{\texttt{hb}}$](/user/835809) 需要选择尽量多的同学去搬卷子和答题卡，且使得对于这些同学中的每一名同学，至少有一位监视她的同学没有被选中。问班花 [$\color{red}{\texttt{y}}\color{black}{\texttt{hb}}$](/user/835809) 最多可以选择多少同学。

由于班花 [$\color{red}{\texttt{y}}\color{black}{\texttt{hb}}$](/user/835809) 太可爱了，所以没有人监视她，也可以认为她的学号是 $0$。

如果一个人没有被监视，那么她就不能被选择。


## 说明/提示

对于 $100\%$ 的数据，$1\le k,a_k\le n\le 10^6$。

## 样例 #1

### 输入

```
6
2
3
1
3
6
5
```

### 输出

```
3```

# AI分析结果



### 综合分析与结论  
本题本质是基环树森林上的最大独立集问题，需满足每个选中节点至少有一个未选父节点。各题解主要采用两种思路：  
1. **贪心+拓扑排序**：优先处理入度为0的节点（必然不可选），其被监视节点必须选，随后处理剩余环结构，每个环最多选⌊环长/2⌋  
2. **树形DP**：断开环边转化为树，分两种情况（选/不选断点）进行动态规划  

贪心法时间复杂度更低（O(n)），适合大规模数据；DP法思路更严谨但实现复杂。最优解为贪心+拓扑，辅以环处理技巧。

---

### 精选题解推荐  

#### 1. 作者：wyd_is_JOKER（⭐⭐⭐⭐⭐）  
**关键亮点**：  
- 拓扑处理链式结构，贪心选择必须节点  
- 剩余环独立处理，直接取半长  
- 代码简洁高效，适合1e6数据规模  
**核心代码**：  
```cpp
// 拓扑处理入度为0的节点
while(!Q.empty()) {
    int u = Q.front(); Q.pop();
    vis[u] = 1;
    if (choose[u]) { // 当前节点已选，处理其子节点入度
        if (--in[ak[u]] == 0) Q.push(ak[u]);
    } else { // 当前未选，强制选其监视者
        if (!choose[ak[u]]) {
            choose[ak[u]] = 1;
            ans++;
            Q.push(ak[u]);
        }
    }
}
// 处理剩余环
for (int i=1; i<=n; i++) if (!vis[i]) {
    int cnt = 0;
    for (int j=i; !vis[j]; j=ak[j]) {
        cnt++;
        vis[j] = 1;
    }
    ans += cnt / 2;
}
```

#### 2. 作者：zac2010（⭐⭐⭐⭐）  
**关键亮点**：  
- 基环树经典DP思路，断开环边分情况讨论  
- 状态转移方程设计精巧，max(f[x][0], f[x][1]) 覆盖所有可能  
**核心思想**：  
```cpp
void dfs(int u, int pos) {
    f[u][0] = 0; int mx = -INF;
    for(int v : e[u]) {
        dfs(v, pos);
        f[u][0] += max(f[v][0], f[v][1]);
        mx = max(mx, f[v][0] - max(f[v][0], f[v][1]));
    }
    f[u][1] = f[u][0] + (u != pos || !flag) * mx + 1;
}
// 分别处理断点选与不选的情况
ans += max(max(f[p][0], f[p][1]), f[fa[p]][0]);
```

#### 3. 作者：fishing_cat（⭐⭐⭐）  
**个人心得**：  
> "之前错误地将所有环总长除2，导致奇数环情况错误。每个环必须独立处理，这是关键教训。"  
**改进思路**：遍历每个环单独计算长度并累加⌊len/2⌋  

---

### 关键技巧总结  
1. **拓扑去链**：入度为0的节点不可选，其子节点必选，形成链式贪心选择  
2. **环处理技巧**：剩余环结构独立，相邻节点隔一选一，总数为环长一半  
3. **标记复用**：使用`vis`数组避免重复处理节点，同时区分链与环结构  

---

### 拓展与举一反三  
1. **类似题型**：  
   - [P2607 骑士](https://www.luogu.com.cn/problem/P2607)：基环树最大权独立集  
   - [P5022 旅行](https://www.luogu.com.cn/problem/P5022)：基环树DFS遍历  
   - [P4381 岛屿](https://www.luogu.com.cn/problem/P4381)：基环树直径计算  

2. **思维模式**：  
   - **基环树**：优先考虑断环成树，转化为树问题处理  
   - **贪心选择**：当DP复杂度较高时，寻找局部最优策略  

---

### 推荐练习题  
1. [P2607 骑士](https://www.luogu.com.cn/problem/P2607)  
2. [P1453 城市环路](https://www.luogu.com.cn/problem/P1453)  
3. [P3533 急流](https://www.luogu.com.cn/problem/P3533)

---
处理用时：83.95秒
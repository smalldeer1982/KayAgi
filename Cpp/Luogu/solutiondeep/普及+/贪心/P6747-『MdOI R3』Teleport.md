# 题目信息

# 『MdOI R3』Teleport

## 题目背景

凯瑞甘从帝国的围攻下，击毁了大天使号，乘着雷诺的飞船逃了出来，到了休伯利安号上。

“吉米？”凯瑞甘着急地四处寻找着。

“很抱歉，我们没能救出他”马特·霍纳向凯瑞甘走来。

“你丢下了他？”凯瑞甘回想起曾经的自己被蒙斯克丢下，便起了杀心，用灵能将马特抓了起来。

“不是的，凯瑞甘，我们受到了帝国的伏击，现在必须，马上离开，过会可以回头来找他”马特解释道。

“这里没有我们！你走吧，我自己去找他。”凯瑞甘放下了马特，回头坐着雷诺的回到了星球上。

“警告，警告，敌军突破能量场。”帝国的舰队突破了马特舰队设下的能量场，控制着钢铁舰队折越到了这里，并对休伯利安号发起猛烈的攻击。

“立即进行折越，我们必须马上离开！”马特·霍纳下令道。

## 题目描述

马特·霍纳想要控制休伯利安号进行折越，想要进行折越，就要激活休伯利安号上的所有 $n$ 个位点。

休伯利安号上有 $n$ 个位点，每个位点有 $a_i$ 点能量，为了激活，马特·霍纳会消耗 $k\times n$ 点地嗪，这 $k\times n$ 点地嗪会平均分给 $n$ 个位点，每个位点在接受 $k$ 点地嗪后会激发，得到 $a_i \operatorname{xor} k$ 点高能，所有位点的高能总和为这次折越的消耗 $S$。

为了能够快速的进行折越，马特·霍纳决定用最多的 $k\times n$ 点地嗪，但可惜的是，如果地嗪使用太多，使得消耗 $S$ 超过限制值 $m$ ，那么休伯利安号就会不堪重负，最终爆炸。

现在，你的任务是帮助马特·霍纳找到这个最大的 $k$ ，使得休伯利安号能在安全的前提下尽可能快的折越走。如果任何情况下都不能安全的折越走，则输出 $-1$ 。

这里的 $\operatorname{xor}$ 表示的是位运算中的按位异或运算。

## 说明/提示

对于第一个询问，最大的 $k$ 为 $3$ ，此时 $S=2+1+0=3 \le 10$ ，可证没有更大的 $k$ 满足条件。

对于第二个询问，没有任何 $k$ 满足条件。
|数据点  |$n$  |$a_i$  | $m$ | $q$ |
| :------: | :------: | :-------: | :-------: | :----------: |
|$1$|$\le 10$|$\le 2^{20}$| $\le 2^{20}$| $=1$ |
|$2$| $\le 10^3$|$\le10^3$|$\le10^3$|$\le 10^3$|
|$3$|$\le 10^3$  | $\le 2^{30}$ | $\le 10^3$ | $\le 10^3$ |
|$4\sim 6$| $\le 10^5$| $\le 2^{20}$ | $\le 10^6$ | $\le 10^5$ |
|$7\sim 10$| $\le 10^5$ | $\le 2^{30}$ | $\le 2^{30}\times10^6$ | $\le 10^5$ |
**本题不进行捆绑测试。**

所有测试点的数据范围如上所示。对于所有数据，$0<n,q\leq 10^5,\ 0\leq a_i\leq 2^{30},\ 0\leq m\leq 2^{30}\times 10^6$。

## 样例 #1

### 输入

```
3
1 2 3 
2 
10 
1```

### 输出

```
3
-1```

## 样例 #2

### 输入

```
1
0
1
1073741824000000```

### 输出

```
1073741824000000```

# AI分析结果



### 综合分析与结论
本题核心是二进制拆位贪心，需在保证总消耗不超过m的前提下找到最大的k。所有题解均基于以下核心思路：
1. **按位拆分**：统计每位0/1出现次数，独立计算每位贡献
2. **贪心策略**：从高位到低位尝试置1，优先保证k的最大性
3. **预判可行性**：预处理最小消耗或使用前缀和快速判断能否调整某位
4. **防溢出处理**：通过数学转换或int128处理大数运算

---

### 高星题解推荐（≥4星）

#### 1. Rubidium_Chloride（五星）
**关键亮点**：
- 引入前缀和数组`mn`预处理最小消耗，快速判断剩余位的可行性
- 使用`__int128`优雅处理大数运算，避免溢出问题
- 代码结构清晰，逻辑分层明确（预处理+贪心调整）

**核心代码**：
```cpp
ll solve(ll k){
    ll ans=0,tot=0;
    for(int i=51;i>=0;i--){
        if(tot+mn[i]>k) return -1;
        if(i&&s[i][1]+mn[i-1]+tot<=k){
            tot+=s[i][1],ans+=p[i];
            continue;
        }
        // 其余逻辑...
    }
}
```

#### 2. ez_lcw（四星半）
**关键亮点**：
- 简洁的状态转移方程 `f[i] = f[i-1] + min(0/1贡献)`
- 利用当前已选状态`sumw`动态计算可行性
- 使用`__int128`进行中间计算，兼顾安全性与代码简洁性

**实现技巧**：
```cpp
for(int i=50;i>=0;i--){
    __int128 w = (__int128)(1ll<<i)*sum[i][0];
    if((sum[i][0]<=sum[i][1]) || (sumw+w+(i>0?f[i-1]:0)<=m)){
        // 贪心选择逻辑
    }
}
```

#### 3. LeavingZzz（四星）
**关键亮点**：
- 分离最小消耗计算与贪心调整阶段，逻辑清晰
- 使用浮点数转换避免溢出（`(m-sum)/(1<<i)`）
- 显式处理最高位超出原数据范围的情况

**优化点**：
```cpp
for(int i=34;i>=1;i--) // 高位特殊处理
if((n - 2*a[i]) <= (m - sum)/(1<<i))
    sum += (n-2*a[i])*(1<<i), k |= (1<<i);
```

---

### 关键思路与技巧总结
1. **位运算拆解**：将问题转换为独立的二进制位处理
2. **双阶段贪心**：先构造最小消耗的k，再尝试高位升级
3. **可行性预判**：通过前缀和/最小消耗数组快速判断剩余调整空间
4. **防溢出技巧**：
   - 使用`__int128`存储中间结果
   - 将`a*b <= m`转换为`a <= m/b`避免乘法溢出
   - 浮点数估算大数关系

---

### 推荐练习题
1. [P2114 [NOI2016] 起床困难综合症](https://www.luogu.com.cn/problem/P2114)  
   （位运算贪心经典题）
2. [P4592 [TJOI2018] 异或](https://www.luogu.com.cn/problem/P4592)  
   （树上前缀和+异或性质）
3. [P3857 [TJOI2008] 彩灯](https://www.luogu.com.cn/problem/P3857)  
   （线性基+位运算极值问题）

---
处理用时：54.48秒
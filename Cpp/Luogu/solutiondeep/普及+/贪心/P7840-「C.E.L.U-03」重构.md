# 题目信息

# 「C.E.L.U-03」重构

## 题目背景

罗司机最近发现服务器运行速度很慢，于是他准备重构整个服务器的网络以提升效率。

## 题目描述

罗司机有 $n$ 台服务器，每个服务器有一个繁忙度 $v_i$。罗司机将用 $n-1$ 条网络将它们连接在一起，于是每台服务器有一个连接网络数量 $d_i$。这个服务器网络运行的总时间是 $\sum\limits_{i=1}^nd_i^2v_i$。请你最小化这个值。

## 说明/提示

**样例解释：**  
连接 $1-2,1-4,2-3$ 三条边，度数分别为 $2,2,1,1$。

|数据编号|$n$|特殊性质|
|:-:|:-:|:-:|
|$1$|$\le5$|无|
|$2\sim 3$|$\le300$|无|
|$4\sim 5$|$\le3\times10^3$|无|
|$6$|$\le3\times10^4$|所有 $v_i$ 相等|
|$7\sim 8$|$\le3\times10^4$|无|
|$9\sim 10$|$\le3\times10^5$|无|  

对于 $100\%$ 的数据，$1\leq n\le3\times10^5,1\leq v_i\le10^3$。

## 样例 #1

### 输入

```
4
2 3 4 4```

### 输出

```
28```

# AI分析结果



### 综合分析与结论  
题目要求构造树结构使 $\sum d_i^2v_i$ 最小。所有正确题解均基于贪心策略：初始每个节点度数为1，剩余 $n-2$ 个度数通过优先队列动态选取增量最小的节点分配。核心在于维护 $(2d+1)v$ 的最小堆，时间复杂度为 $O(n \log n)$，适用于 $n \leq 3 \times 10^5$ 的数据规模。该问题的贪心正确性依赖于每次局部最优选择能导向全局最优解。

---

### 高星题解推荐  

#### 1. 作者：abruce（5星）  
**关键亮点**：  
- 代码简洁高效，直接使用优先队列维护增量。  
- 通过口胡式证明点明贪心正确性，适合快速理解核心思路。  
- 代码中优先队列的比较逻辑清晰，避免冗余计算。  

**核心代码**：  
```cpp
priority_queue<que> q; // 按(2d+1)*v排序的小根堆
ans = sum(v_i); // 初始度数为1的总贡献
for (i=1; i<n-1; i++) {
    que u = q.top(); q.pop();
    ans += (2*u.w + 1) * u.v; // 增加度数后的增量
    if (u.w < n-1) q.push(que(u.w+1, u.v)); // 更新度数
}
```

#### 2. 作者：_determination_（4星）  
**关键亮点**：  
- 运算符重载使优先队列比较逻辑直观。  
- 结构体封装节点信息，代码可读性高。  
- 明确初始贡献为 $\sum v_i$，剩余分配逻辑清晰。  

**核心比较逻辑**：  
```cpp
struct node {
    int x, ds;
    bool operator <(const node &y) const {
        return (2*ds + 1)*a[x] > (2*y.ds + 1)*a[y.x]; // 小根堆
    }
};
priority_queue<node> q; // 按增量升序排列
```

#### 3. 作者：_Weslie_（4星）  
**关键亮点**：  
- 结合 Prufer 序列理论解释度数分配，增强理解深度。  
- 通过负数转换实现小根堆，代码实现巧妙。  
- 详细说明增量计算与贪心选择的关系。  

**核心片段**：  
```cpp
priority_queue<pair<int, int>> q; // 存储负数实现小根堆
for (int i=1; i<=n; i++) q.push({-3*a[i], i}); // 初始d=1，增量为3a[i]
while (cnt--) {
    auto [delta, idx] = q.top(); q.pop();
    ans -= delta; // 实际增量为正数
    q.push({delta - 2*a[idx], idx}); // 更新为d+1对应的增量
}
```

---

### 最优关键思路与技巧  
1. **贪心策略**：每次选择 $(2d_i+1)v_i$ 最小的节点增加度数，确保局部最优。  
2. **数据结构**：优先队列（小根堆）动态维护当前最小增量。  
3. **初始化处理**：所有节点初始度数为1，剩余 $n-2$ 度数通过贪心分配。  
4. **数学优化**：增量公式 $(d+1)^2 -d^2 = 2d+1$，避免重复计算平方差。  

---

### 拓展与相似题目  
1. **P1090 [NOIP2004 提高组] 合并果子**  
   - 贪心策略：每次合并重量最小的两堆，优先队列实现。  
2. **P6033 [NOIP2004 提高组] 合并果子 加强版**  
   - 数据规模扩大，需桶排序优化优先队列。  
3. **P4447 [AHOI2018初中组] 分组**  
   - 贪心分组问题，需动态维护最优选择策略。  

---

### 题解中的个人心得摘录  
- **作者：xhxxwcr**：  
  > “卡了一个小时” → 强调理解增量公式的重要性，避免误入歧途。  
- **作者：Prean**：  
  > “无需考虑树的形态” → 度数分配独立于具体结构，简化问题分析。  
- **作者：0htoAi**：  
  > “感性证明” → 在严格证明困难时，通过构造示例辅助理解贪心正确性。

---
处理用时：93.24秒
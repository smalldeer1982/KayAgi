# 题目信息

# [NOI2011] 兔农

## 题目描述

农夫栋栋近年收入不景气，正在他发愁如何能多赚点钱时，他听到隔壁的小朋友在讨论兔子繁殖的问题。

问题是这样的：第一个月初有一对刚出生的小兔子，经过两个月长大后，这对兔子从第三个月开始，每个月初生一对小兔子。新出生的小兔子生长两个月后又能每个月生出一对小兔子。问第 $n$ 个月有多少只兔子？

聪明的你可能已经发现，第 $n$ 个月的兔子数正好是第 $n$ 个 Fibonacci（斐波那契）数。栋栋不懂什么是 Fibonacci 数，但他也发现了规律：第 $i+2$ 个月的兔子数等于第 $i$ 个月的兔子数加上第 $i+1$ 个月的兔子数。前几个月的兔子数依次为：

$$1,1,2,3,5,8,13,21,34,\ldots$$

栋栋发现越到后面兔子数增长的越快，期待养兔子一定能赚大钱，于是栋栋在第一个月初买了一对小兔子开始饲养。

每天，栋栋都要给兔子们喂食，兔子们吃食时非常特别，总是每 $k$ 对兔子围成一圈，最后剩下的不足 $k$ 对的围成一圈，由于兔子特别害怕孤独，从第三个月开始，如果吃食时围成某一个圈的只有一对兔子，这对兔子就会很快死掉。

我们假设死去的总是刚出生的兔子，那么每个月的兔子数仍然是可以计算的。例如，当 $k=7$ 时，前几个月的兔子数依次为：

$$1,1,2,3,5,7,12,19,31,49,80,\ldots$$

给定 $n$，你能帮助栋栋计算第 $n$ 个月他有多少对兔子么？由于答案可能非常大，你只需要告诉栋栋第 $n$ 个月的兔子对数除 $p$ 的余数即可。


## 说明/提示

|测试点编号|$n$|$k,p$|
|:-:|:-:|:-:|
|$1\sim 10$|$1\leq n\leq 50$|$2\leq k,p\leq1000$|
|$11$|$1\leq n\leq 80$|$2\leq k,p\leq 10^4$|
|$12,13$|$1\leq n\leq 1000$|$2\leq k,p\leq 10^4$|
|$14,15$|$1\leq n\leq 10^6$|$2\leq k,p\leq 10^6$|
|$16,17$|$1\leq n\leq 10^{18}$|$2\leq k,p\leq1000$|
|$18\sim 20$|$1\leq n\leq 10^{18}$|$2\leq k\leq 10^6$，$2\leq p\leq 10^9$|

对于 $100\%$ 的数据，$1\leq n\leq 10^{18}$，$2\leq k\leq 10^6$，$2\leq p\leq 10^9$。


## 样例 #1

### 输入

```
6 7 100```

### 输出

```
7```

## 样例 #2

### 输入

```
7 7 5```

### 输出

```
2```

# AI分析结果

• 综合分析与结论：
    - 思路：这几道题解均先分析出题目与斐波那契数列相关，且在模k意义下存在循环节。通过寻找循环节，利用矩阵快速幂求解第n个月兔子对数模p的值。同时，都考虑到了可能出现无逆元导致无循环节的特殊情况。
    - 算法要点：首先预处理斐波那契数列模k的值，通过扩展欧几里得算法（exGCD）求乘法逆元，进而确定每段以特定数开头的数列长度。根据循环节特性，构建转移矩阵，通过矩阵快速幂计算结果。
    - 解决难点：关键在于寻找循环节，通过分析循环节内数列性质，利用乘法逆元的关系确定循环节。同时，处理无逆元时的特殊情况，防止程序陷入死循环。

所选的题解：
  - 作者：TimWYZ (赞：16)  星级：5星
    - 关键亮点：思路清晰，详细地阐述了从发现规律到构建解题框架的全过程，对特殊情况的分析和处理非常到位，代码注释详细，可读性强。
    - 重点代码及核心实现思想：
```c++
// 通过exGCD求逆元
void exGCD(ll a, ll b, ll &x, ll &y) {
    if (!b) {
        x = 1, y = 0;
        return;
    }
    exGCD(b, a % b, x, y);
    ll t = x;
    x = y;
    y = t - a / b * y;
}
ll getInv(ll a, ll P) {
    if (GCD(a, P)!= 1) return -1;
    ll x, y;
    exGCD(a, P, x, y);
    return (x % P + P) % P;
}
// 矩阵快速幂
Matrix quickPower(Matrix a, ll b) {
    Matrix ret;
    for (int i = 1; i <= SZ; i++) ret.o[i][i] = 1;
    while (b) {
        if (b & 1) ret = ret * a;
        a = a * a;
        b >>= 1;
    }
    return ret;
}
```
核心实现思想是先通过exGCD函数实现扩展欧几里得算法求逆元，getInv函数调用该算法获取模P下a的逆元。矩阵快速幂函数quickPower通过位运算和矩阵乘法，快速计算矩阵a的b次幂。
  - 作者：zqy1018 (赞：11)  星级：4星
    - 关键亮点：简洁明了地梳理出解题的关键步骤，从观察取模序列得出规律，到推导出具体算法，逻辑连贯，并提及了斐波那契数列模k循环节长度的结论，虽未详细证明但提供了思路方向。
  - 作者：Wilderness_ (赞：4)  星级：4星
    - 关键亮点：从不同子任务角度逐步分析，先尝试朴素算法，再深入挖掘循环节性质，对循环节的寻找和矩阵快速幂的结合讲解细致，代码实现与讲解对应，便于理解。
    - 重点代码及核心实现思想：
```c++
// 矩阵快速幂
Matrix qpow(ll x,Matrix base) {
    Matrix res;
    setm(res);
    while(x) {
        if(x&1)res=res*base;
        base=base*base;
        x>>=1;
    }
    return res;
}
```
核心实现思想为矩阵快速幂函数qpow，通过位运算判断x的二进制位，若为1则将结果矩阵res与当前矩阵base相乘，每次循环base自乘，x右移一位，从而快速计算出base的x次幂。

最优关键思路或技巧：利用斐波那契数列在模k意义下的循环节性质，通过乘法逆元确定循环节的具体情况，结合矩阵快速幂优化计算。在实现中，合理使用扩展欧几里得算法求逆元，构建合适的转移矩阵并进行快速幂运算。

可拓展之处：同类型题可考虑具有类似递推关系且存在取模操作改变递推规则的数列问题。类似算法套路为先寻找数列在取模意义下的规律，如循环节等，再利用数学工具（如逆元）辅助确定关键参数，最后结合快速幂等优化算法求解。

推荐洛谷题目：
1. P1962 斐波那契数列 ：基础的斐波那契数列矩阵快速幂应用。
2. P3390 【模板】矩阵快速幂 ：加深对矩阵快速幂的理解和应用。
3. P1349 广义斐波那契数列 ：在斐波那契数列基础上进行推广，同样可利用矩阵快速幂求解。

个人心得：无。 

---
处理用时：25.93秒
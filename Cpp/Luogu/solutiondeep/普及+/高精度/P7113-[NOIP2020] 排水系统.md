# 题目信息

# [NOIP2020] 排水系统

## 题目描述

对于一个城市来说，排水系统是极其重要的一个部分。

有一天，小 C 拿到了某座城市排水系统的设计图。排水系统由 $n$ 个排水结点（它们从 $1 \sim n$ 编号）和若干个单向排水管道构成。每一个排水结点有若干个管道用于汇集其他排水结点的污水（简称为该结点的汇集管道），也有若干个管道向其他的排水结点排出污水（简称为该结点的排出管道）。

排水系统的结点中有 $m$ 个污水接收口，它们的编号分别为 $1, 2, \ldots , m$，污水只能从这些接收口流入排水系统，并且这些结点没有汇集管道。排水系统中还有若干个最终排水口，它们将污水运送到污水处理厂，没有排出管道的结点便可视为一个最终排水口。

现在各个污水接收口分别都接收了 $1$ 吨污水，污水进入每个结点后，会均等地从当前结点的每一个排出管道流向其他排水结点，而最终排水口将把污水排出系统。

现在小 C 想知道，在该城市的排水系统中，每个最终排水口会排出多少污水。该城市的排水系统设计科学，管道不会形成回路，即不会发生污水形成环流的情况。

## 说明/提示

**【样例 #1 解释】**

$1$ 号结点是接收口，$4, 5$ 号结点没有排出管道，因此是最终排水口。  
$1$ 吨污水流入 $1$ 号结点后，均等地流向 $2, 3, 5$ 号结点，三个结点各流入 $\frac{1}{3}$ 吨污水。  
$2$ 号结点流入的 $\frac{1}{3}$ 吨污水将均等地流向 $4, 5$ 号结点，两结点各流入 $\frac{1}{6}$ 吨污水。  
$3$ 号结点流入的 $\frac{1}{3}$ 吨污水将均等地流向 $4, 5$ 号结点，两结点各流入 $\frac{1}{6}$ 吨污水。  
最终，$4$ 号结点排出 $\frac{1}{6} + \frac{1}{6} = \frac{1}{3}$ 吨污水，$5$ 号结点排出 $\frac{1}{3} + \frac{1}{6} + \frac{1}{6} = \frac{2}{3}$ 吨污水。

**【数据范围】**

| 测试点编号 | $n \le$ | $m \le$ |
|:-:|:-:|:-:|
| $1 \sim 3$ | $10$ | $1$ |
| $4 \sim 6$ | ${10}^3$ | $1$ |
| $7 \sim 8$ | ${10}^5$ | $1$ |
| $9 \sim 10$ | ${10}^5$ | $10$ |

对于全部的测试点，保证 $1 \le n \le {10}^5$，$1 \le m \le 10$，$0 \le d_i \le 5$。

数据保证，污水在从一个接收口流向一个最终排水口的过程中，不会经过超过 $10$ 个中间排水结点（即接收口和最终排水口不算在内）。

## 样例 #1

### 输入

```
5 1
3 2 3 5
2 4 5
2 5 4
0
0
```

### 输出

```
1 3
2 3
```

## 样例 #2

### 输入

```
见附件中的 water/water2.in```

### 输出

```
见附件中的 water/water2.ans```

## 样例 #3

### 输入

```
见附件中的 water/water3.in```

### 输出

```
见附件中的 water/water3.ans```

# AI分析结果

• 综合分析与结论：这些题解均围绕“排水系统”问题，利用拓扑排序解决有向无环图中污水流动及最终排水口污水量计算问题。因数据范围导致分数运算可能爆 `long long`，部分题解用 `__int128`，部分提到高精度处理。各题解思路相近，主要差异在分数运算实现及代码细节处理。
- **作者：听取MLE声一片 (赞：28) - 5星**
  - **关键亮点**：思路清晰，先阐述拓扑排序主要思路，结合题目说明操作，再详细介绍分数处理的通分思想及实现，代码注释详细。
  - **个人心得**：提到去掉高精度是好的拓扑排序题，强调代码中需自行添加高精度，因高精度复杂。
  - **核心代码 - 拓扑排序函数**：
```cpp
void tp(){
    for(int i=1;i<=n;i++)//所有入度为0的点入队（1 - m）
        if(!in[i]){
            book[i]=1;
            q.push(i);
            xx[i]=1,yy[i]=1;
        }
    while(!q.empty()){
        int p=q.front();
        q.pop();
        if(out[p])
            continue;
        for(int i=0;i<a[p].size();i++){
            add(a[p][i],xx[p],yy[p]*(1ll*a[p].size()));
            if(book[a[p][i]])
                continue;
            in[a[p][i]]--;
            if(in[a[p][i]]==0){
                book[a[p][i]]=1;
                q.push(a[p][i]);
            }
        }
    }
    return;
}
```
  - **核心代码 - 分数加法函数**：
```cpp
void add(int u,ll x,ll y){
    if(y==0)
        return;
    if(yy[u]==0){
        xx[u]=x;
        yy[u]=y;
        return;
    }
    ll p1=xx[u]*y+yy[u]*x;
    ll p2=yy[u]*y;
    ll p3=gcd(p1,p2);
    xx[u]=p1/p3;
    yy[u]=p2/p3;
    return;
}
```
  - **核心思想**：拓扑排序中，先将入度为0的点入队，从队头取点，将其污水按出边数量均分给相连点，同时更新相连点入度，入度为0则入队。分数加法通过通分计算，再用 `gcd` 约分。
- **作者：lcyxds (赞：15) - 4星**
  - **关键亮点**：采用独特的高精度处理方式，以 $60^{11}$ 为底存储流量，预处理因数，避免求 `gcd`，实现高精度加法、除法及整除判断。
  - **核心代码 - 分数加法重载**：
```cpp
Gj operator + (Gj a, Gj b){
    Gj res;
    res._num[0] = a._num[0]+b._num[0];
    res._num[1] = a._num[1]+b._num[1]+res._num[0]/_BASE;
    res._num[0]%=_BASE;
    return res;
};
```
  - **核心代码 - 分数除法重载**：
```cpp
Gj operator / (Gj a, ull b) {
    Gj res;
    res._num[0] = a._num[1]%b*_BASE+a._num[0];
    res._num[1] = a._num[1]/b;
    res._num[0]/=b;
    return res;
}
```
  - **核心思想**：定义 `Gj` 结构体表示分数，重载加法和除法运算符。加法运算时，先加低位，再处理进位；除法运算时，模拟高精度除法过程。
- **作者：hensier (赞：10) - 4星**
  - **关键亮点**：详细分析搜索方式，引入入度、出度数组确定搜索顺序，用链式前向星维护图，给出 BFS（队列实现）和 DFS 两种搜索代码。
  - **核心代码 - BFS（队列实现）的关键部分**：
```cpp
while(q.size()){
    int u=q.front();
    q.pop();
    for(int i=head[u],v;i;i=e[i].nxt){
        v=e[i].to;
        update(wx[v],wy[v],wx[u],oud[u]*wy[u]);
        ind[v]--; // 将入度减少 1
        if(!ind[v])q.push(v);
    }
}
```
  - **核心代码 - DFS 的关键部分**：
```cpp
void dfs(int u){
    for(int i=head[u],v;i;i=e[i].nxt){
        v=e[i].to;
        update(wx[v],wy[v],wx[u],oud[u]*wy[u]);
        ind[v]--;
        if(!ind[v])dfs(v); 
    }
}
```
  - **核心思想**：BFS 中，从入度为0的点开始，将其污水按出度均分给相连点，更新相连点入度，入度为0则入队；DFS 类似，递归处理相连点。分数运算通过 `update` 函数实现通分相加再约分。

• **最优关键思路或技巧**：
  - **拓扑排序**：利用拓扑排序保证处理节点时，其上游节点已处理完毕，污水已全部流入，符合污水流动逻辑。
  - **分数运算**：通过通分实现分数加法，用 `gcd` 约分防止数据过大，部分题解利用特殊进制存储避免复杂高精度计算。

• **可拓展思路**：此类题目可拓展到其他有向无环图的流量分配、任务调度等场景，关键是利用拓扑排序确定顺序，结合具体场景实现数据处理。

• **相似知识点洛谷题目**：
  - [P1038 神经网络](https://www.luogu.com.cn/problem/P1038)
  - [P1983 车站分级](https://www.luogu.com.cn/problem/P1983)
  - [P1137 旅行计划](https://www.luogu.com.cn/problem/P1137)

• **个人心得摘录与总结**：多数题解提到数据范围导致的分数运算问题，部分尝试不同方法解决，如 `__int128`、特殊高精度处理等，强调做题时要关注数据范围对结果和实现方式的影响。 

---
处理用时：34.78秒
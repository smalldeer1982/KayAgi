# 题目信息

# 木牛流马

## 题目背景

孔明造出了木牛流马。

> 木牛者，方腹曲头，一脚四足，头入领中，舌著于腹。载多而行少，宜可大用，不可小使；特行者数十里，群行者二十里也。曲者为牛头，双者为牛脚，横者为牛领，转者为牛足，覆者为牛背，方者为牛腹，垂者为牛舌，曲者为牛肋，刻者为牛齿，立者为牛角，细者为牛鞅，摄者为牛秋轴。牛仰双辕，人行六尺，牛行四步。载一岁粮，日行二十里，而人不大劳。流马尺寸之数，肋长三尺五寸，广三寸，厚二寸二分，左右同。前轴孔分墨去头四寸，径中二寸。前脚孔分墨二寸，去前轴孔四寸五分，广一寸。前杠孔去前脚孔分墨二寸七分，孔长二寸，广一寸。后轴孔去前杠分墨一尺五分，大小与前同。后脚孔分墨去后轴孔三寸五分，大小与前同。后杠孔去后脚孔分墨二寸七分，后载克去后杠孔分墨四寸五分。前杠长一尺八寸，广二寸，厚一寸五分。后杠与等版方囊二枚，厚八分，长二尺七寸，高一尺六寸五分，广一尺六寸，每枚受米二斛三斗。从上杠孔去肋下七寸，前后同。上杠孔去下杠孔分墨一尺三寸，孔长一寸五分，广七分，八孔同。前后四脚，广二寸，厚一寸五分。形制如象，靬长四寸，径面四寸三分。孔径中三脚杠，长二尺一寸，广一寸五分，厚一寸四分，同杠耳。（《三国志·亮集载作木牛流马法》）

可是在现实中它有个缺陷，就是两个不能在同一行或同一列！

## 题目描述

孔明兴高采烈的叫庞统来参观，孔明存心想难一难庞统，他把 $k$ 个木牛流马放在一个大的 $n \times n$ 的格子地板上，并且给他们都染上色，想让庞统帮着算算有多少种不同的合理布局情况？

## 说明/提示

不需要高精度，并且孔明规定在格子地板上不能翻转，也就是说如果两种布局在翻转后是一样的仍算两种。

## 样例 #1

### 输入

```
4 4 1
4
```

### 输出

```
24
```

# AI分析结果



### 综合分析与结论
本题核心是排列组合与阶乘处理。所有正确解法均采用相同数学公式：位置方案数为排列数平方 $(n(n-1)...(n-k+1))^2$，再除以颜色重复数的阶乘积。关键难点在于理解行列独立递减的排列模式，以及颜色去重处理。

---

### 高星题解推荐（4星）

#### 1. 作者：Creroity（4星）
**关键亮点**  
- 思路直观，通过图形化示例清晰展示行列递减规律  
- 代码简洁高效，直接计算平方乘积后处理颜色去重  
- 包含防坑提示（long long类型的重要性）

**核心代码**  
```cpp
long long ans=1;
for(int i=1;i<=k;i++) ans *= (n-i+1)*(n-i+1); 
for(int i=1;i<=h;i++) {
    cin>>c;
    for(int j=1;j<=c;j++) ans /= j;
}
```

#### 2. 作者：agicy（4星）
**关键亮点**  
- 分步骤推导公式，数学表达严谨  
- 代码采用两次循环分离位置与颜色处理，逻辑清晰  
- 包含特判优化（k>n直接返回0）

**核心代码**  
```cpp
if(k>n) return puts("0"),0;
for(int i=n-k+1;i<=n;i++) ans *= i;
ans *= ans; // 平方计算
for(int j=2;j<=temp;j++) ans /= j; // 跳过除以1
```

#### 3. 作者：明月几时有（4星）
**关键亮点**  
- 代码风格规范，包含输入优化  
- 使用独立阶乘函数增强可读性  
- 数学公式与代码实现高度对应

**核心代码片段**  
```cpp
for(int i=1,x;i<=h;i++){ 
    x=read();
    for(int j=1;j<=x;j++) sum *= j; // 计算分母阶乘
}
for(int i=n;i>=n-k+1;i--) sum1 *= i*i; // 平方累乘
```

---

### 最优解题思路
**关键步骤**  
1. **位置计算**：依次选取每个木牛流马的位置，每选一个会消除一行一列，总方案为 $(n(n-1)...(n-k+1))^2$  
2. **颜色去重**：若颜色i有$c_i$个相同，需除以 $\prod c_i!$  
3. **特判优化**：当k>n时直接返回0  

**实现技巧**  
- 使用累乘而非预计算阶乘，避免溢出风险  
- 先计算分子再逐次除法，保证整除性  
- 循环控制变量从高位向低位计算（如n-k+1到n）

---

### 同类题目推荐
1. **P2181 对角线**（排列组合计算交点）  
2. **P2822 组合数问题**（组合数模运算与预处理）  
3. **P1246 编码**（排列序数计算与字符处理）

---

### 题解个人心得摘录
- **Creroity**："十年OI一场空，不开long long见祖宗" → 强调数据类型选择的重要性  
- **Alex_Wei**：误将行列选择拆分为组合+排列，后修正为正确公式 → 注意排列组合的适用场景  
- **qwq___qaq**：错误使用浮点pow函数导致精度问题 → 整数运算需避免浮点操作

---
处理用时：55.43秒
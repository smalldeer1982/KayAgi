# 题目信息

# [USACO21DEC] Lonely Photo B

## 题目描述

Farmer John 最近购入了 $N$ 头新的奶牛（$3 \le N \le 5 \times 10^5$），每头奶牛的品种是更赛牛（Guernsey）或荷斯坦牛（Holstein）之一。 

奶牛目前排成一排，Farmer John 想要为每个连续不少于三头奶牛的序列拍摄一张照片。 然而，他不想拍摄这样的照片，其中只有一头牛的品种是更赛牛，或者只有一头牛的品种是荷斯坦牛——他认为这头奇特的牛会感到孤立和不自然。 在为每个连续不少于三头奶牛的序列拍摄了一张照片后，他把所有「孤独的」照片，即其中只有一头更赛牛或荷斯坦奶牛的照片，都扔掉了。

给定奶牛的排列方式，请帮助 Farmer John 求出他会扔掉多少张孤独的照片。如果两张照片以不同的奶牛开始或结束，则认为它们是不同的。


## 说明/提示

【样例解释】

这个例子中的每一个长为 3 的子串均恰好包含一头更赛牛或荷斯坦牛——所以这些子串表示孤独的照片，并会被 Farmer John 扔掉。所有更长的子串（GHGH、HGHG 和 GHGHG）都可以被接受。

【数据范围】

- 测试点 2-4 满足 $N \le 50$。
- 测试点 5-10 满足 $N \le 5000$。
- 测试点 11 没有额外限制。

注意这个测试点的答案可能无法用标准的 32 位整数型存储，你可能需要使用更大的整数类型（例如，C++ 中 64 位的 "long long int" 类型）。

## 样例 #1

### 输入

```
5
GHGHG```

### 输出

```
3```

# AI分析结果



### 综合分析与结论
本题需高效统计所有长度≥3且仅含一个G/H的子串。核心难点在于避免O(n²)暴力枚举。各题解主要采用以下思路：
1. **分块处理**：将连续相同字符合并为块，分类讨论块对答案的贡献（如ynxynx、Leonid）。
2. **预处理左右连续边界**：记录每个字符左右最近的同种/异种字符位置，利用乘法原理（如徐晨轩、rzh123）。
3. **数学组合计算**：通过分析孤独字符的左右扩展范围，直接计算可能区间（如Eason_AC）。

最优解法时间复杂度均为O(n)，核心思路为**分块组合计算**和**预处理边界乘法原理**。

---

### 高星题解推荐

#### 1. 作者：ynxynx（★★★★★）
**关键亮点**：
- **分块处理**：将连续相同字符合并为块，简化问题。
- **分类讨论**：对单个字符块和多字符块分别处理，逻辑清晰。
- **代码简洁**：仅需一次遍历分块，再遍历块计算贡献。

**核心代码**：
```cpp
for (int i=1;i<cnt;i++) {
    if (a[i]==1) 
        ans += a[i-1]*a[i+1] + a[i+1]-1; // 单个块左右组合
    else 
        ans += a[i] + a[i+1]-2;          // 多块仅考虑右相邻
}
```
**实现思想**：分块后，单字符块贡献为左右块乘积+右侧连续扩展；多字符块贡献为当前块和右侧块的连续扩展。

#### 2. 作者：rzh123（★★★★☆）
**关键亮点**：
- **预处理前后距离**：记录每个字符与前/后同种字符的距离。
- **数学组合公式**：直接计算三种情况（左右扩展、仅左扩展、仅右扩展）。

**核心代码**：
```cpp
for(int i=1;i<=n;++i) {
    c += a[i]*b[i] + max(0, a[i]-1) + max(0, b[i]-1);
}
```
**实现思想**：每个字符的贡献=左右异种字符数量乘积（中间情况） + 左/右连续扩展（边缘情况）。

#### 3. 作者：Eason_AC（★★★★☆）
**关键亮点**：
- **双向链表预处理**：记录每个字符的前驱/后继同种字符位置。
- **区间长度计算**：通过前后位置差直接计算有效区间数。

**核心代码**：
```cpp
ans += (i-pre[i])*(nxt[i]-i) - 1; // 乘积扣除长度不足3的情况
```
**实现思想**：每个字符的贡献为前驱到当前、当前到后继的区间组合，扣除长度<3的情况。

---

### 关键思路与技巧总结
1. **分块合并连续段**：将字符串压缩为连续块序列，大幅减少计算量。
2. **预处理左右边界**：记录每个位置左右连续异种字符数或同种字符位置，快速计算组合贡献。
3. **分类讨论贡献类型**：
   - 单字符块：需结合左右相邻块。
   - 多字符块：仅需考虑单侧扩展。
4. **数学优化**：避免显式枚举子串，通过乘法原理和加减法直接统计。

---

### 调试经验与心得
- **类型陷阱**：多题解强调使用`long long`（如ynxynx代码头部的注释），避免累加溢出。
- **去重技巧**：徐晨轩指出“每张照片只被唯一孤独字符计算一次”，确保不重复计数。
- **边界处理**：需特殊处理首尾块（如Leonid代码中对块下标范围的判断）。

---

### 相似题目推荐
1. [P1115 最大子段和](https://www.luogu.com.cn/problem/P1115)  
   **相似点**：线性处理连续子段，分块或动态规划。
2. [P2678 跳石头](https://www.luogu.com.cn/problem/P2678)  
   **相似点**：二分答案+预处理最短距离。
3. [P3143 [USACO16OPEN] Diamond Collector S](https://www.luogu.com.cn/problem/P3143)  
   **相似点**：滑动窗口或预处理左右极值，组合计算贡献。

---
处理用时：67.46秒
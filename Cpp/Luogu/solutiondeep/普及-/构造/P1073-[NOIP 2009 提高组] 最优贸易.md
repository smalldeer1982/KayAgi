# 题目信息

# [NOIP 2009 提高组] 最优贸易

## 题目背景

本题原题数据极弱，Subtask 0 中的测试点为原题测试点，Subtask 1 中的测试点为 Hack 数据。

## 题目描述

$C$ 国有 $n$ 个大城市和 $m$ 条道路，每条道路连接这 $n$ 个城市中的某两个城市。任意两个城市之间最多只有一条道路直接相连。这 $m$ 条道路中有一部分为单向通行的道路，一部分为双向通行的道路，双向通行的道路在统计条数时也计为 $1$ 条。

$C$ 国幅员辽阔，各地的资源分布情况各不相同，这就导致了同一种商品在不同城市的价格不一定相同。但是，同一种商品在同一个城市的买入价和卖出价始终是相同的。

商人阿龙来到 $C$ 国旅游。当他得知同一种商品在不同城市的价格可能会不同这一信息之后，便决定在旅游的同时，利用商品在不同城市中的差价赚回一点旅费。设 $C$ 国 $n$ 个城市的标号从 $1\sim n$，阿龙决定从 $1$ 号城市出发，并最终在 $n$ 号城市结束自己的旅行。在旅游的过程中，任何城市可以重复经过多次，但不要求经过所有 $n$ 个城市。阿龙通过这样的贸易方式赚取旅费：他会选择一个经过的城市买入他最喜欢的商品――水晶球，并在之后经过的另一个城市卖出这个水晶球，用赚取的差价当做旅费。由于阿龙主要是来 $C$ 国旅游，他决定这个贸易只进行最多一次，当然，在赚不到差价的情况下他就无需进行贸易。

假设 $C$ 国有 $5$ 个大城市，城市的编号和道路连接情况如下图，单向箭头表示这条道路为单向通行，双向箭头表示这条道路为双向通行。

![](https://cdn.luogu.com.cn/upload/image_hosting/flre534z.png)

假设 $1\sim n$ 号城市的水晶球价格分别为 $4,3,5,6,1$。

阿龙可以选择如下一条线路：$1\to2\to3\to5$，并在 $2$ 号城市以 $3$ 的价格买入水晶球，在 $3$ 号城市以 $5$ 的价格卖出水晶球，赚取的旅费数为 $2$。

阿龙也可以选择如下一条线路：$1\to4\to5\to4\to5$，并在第 $1$ 次到达 $5$ 号城市时以 $1$ 的价格买入水晶球，在第 $2$ 次到达 $4$ 号城市时以 $6$ 的价格卖出水晶球，赚取的旅费数为 $5$。

现在给出 $n$ 个城市的水晶球价格，$m$ 条道路的信息（每条道路所连接的两个城市的编号以及该条道路的通行情况）。请你告诉阿龙，他最多能赚取多少旅费。

## 说明/提示

【数据范围】

输入数据保证 $1$ 号城市可以到达 $n$ 号城市。

对于 $10\%$ 的数据，$1\leq n\leq 6$。

对于 $30\%$ 的数据，$1\leq n\leq 100$。

对于 $50\%$ 的数据，不存在一条旅游路线，可以从一个城市出发，再回到这个城市。

对于 $100\%$ 的数据，$1\leq n\leq 100000$，$1\leq m\leq 500000$，$1\leq  x,y\leq  n$，$1\leq  z\leq  2$，$1\leq $ 各城市的编号 $\leq  n$。

水晶球价格 $\leq 100$。

NOIP 2009 提高组 第三题

## 样例 #1

### 输入

```
5 5 
4 3 5 6 1 
1 2 1 
1 4 1 
2 3 2 
3 5 1 
4 5 2 ```

### 输出

```
5```

# AI分析结果

### 综合分析与结论

本题的核心在于如何在图中找到一条路径，使得从起点到终点的过程中，能够通过一次买卖操作获得最大利润。题解中主要采用了以下几种思路：

1. **分层图 + SPFA**：通过构建三层图分别表示未买、已买未卖、已卖的状态，利用SPFA算法求最长路。这种方法直观且易于理解，但SPFA在最坏情况下时间复杂度较高。
  
2. **Tarjan缩点 + DAG DP**：通过Tarjan算法将图缩点为DAG，然后在DAG上进行DP求解。这种方法较为复杂，但能有效处理环的情况，且时间复杂度较为稳定。

3. **双端SPFA**：通过正向和反向两次SPFA，分别求出从起点到每个点的最小买入价和从每个点到终点的最大卖出价。这种方法较为巧妙，且在实际应用中表现较好。

### 所选高星题解

#### 1. **fy1234567ok (5星)**
- **关键亮点**：分层图思路清晰，代码简洁且优化程度高。通过三层图的状态转移，将问题转化为求最长路，思路非常直观。
- **代码核心**：
  ```cpp
  void spfa(int s) {
      for(int i = 1;i <= n*3;i++) d[i] = INT_MIN;
      d[s] = 0; 
      queue<int> Q; inq[s] = true; Q.push(s);
      while(!Q.empty()) {
          int x = Q.front(); Q.pop(); inq[x] = false;
          for(auto [v, len] : G[x])
              if(d[v] < d[x] + len) {
                  d[v] = d[x] + len;
                  if(!inq[v]) { Q.push(v); inq[v] = true; }
              } 
      }
  }
  ```
- **个人心得**：作者提到分层图的思想非常实用，特别是在状态量相互影响的问题中，分层图能够很好地解决问题。

#### 2. **ctzm (5星)**
- **关键亮点**：Tarjan缩点 + DAG DP的思路非常严谨，且通过反图处理了可达性问题，代码结构清晰，优化程度高。
- **代码核心**：
  ```cpp
  void tarjan(int u) {
      dfn[u] = low[u] = ++tot; ins[u] = 1, sta[++top] = u; 
      for(edge *p = head[u]; p; p = p->next) {
          int v = p->v; 
          if(!dfn[v]) tarjan(v), low[u] = min(low[u], low[v]);
          else if(ins[v]) low[u] = min(low[u], dfn[v]); 
      } if(low[u] == dfn[u]) {
          ++scc;
          while(sta[top + 1] != u) {
              Max[scc] = max(Max[scc], val[sta[top]]);
              Min[scc] = min(Min[scc], val[sta[top]]); 
              bel[sta[top]] = scc; ins[sta[top--]] = 0; 
          }
      }
  }
  ```
- **个人心得**：作者提到Tarjan写这题坑点较多，但通过反图处理可达性问题后，代码能够通过所有hack数据。

#### 3. **fairfriendZ (4星)**
- **关键亮点**：双端SPFA的思路非常巧妙，通过正向和反向两次SPFA分别求出最小买入价和最大卖出价，代码简洁且效率高。
- **代码核心**：
  ```cpp
  void spfa1() {
      q.push(1), vis[1] = 1, dis[1] = val[1];
      while(!q.empty()) {
          int u = q.front(); q.pop(); vis[u] = 0;
          for(auto v : g[u]) {
              if(dis[v] > min(dis[u], val[v])) {
                  dis[v] = min(dis[u], val[v]);
                  if(!vis[v]) q.push(v), vis[v] = 1;
              }
          }
      }
  }
  ```
- **个人心得**：作者提到双端SPFA法在实际应用中表现优异，且能够通过hack数据。

### 最优关键思路与技巧

1. **分层图**：通过将图分层，分别表示不同的状态（未买、已买未卖、已卖），将问题转化为求最长路，思路直观且易于实现。
  
2. **Tarjan缩点 + DAG DP**：通过Tarjan算法将图缩点为DAG，然后在DAG上进行DP求解，能够有效处理环的情况，且时间复杂度较为稳定。

3. **双端SPFA**：通过正向和反向两次SPFA，分别求出最小买入价和最大卖出价，思路巧妙且在实际应用中表现较好。

### 可拓展之处

- **分层图**：分层图的思想可以应用于其他状态转移问题，如最短路径问题中的多次决策问题。
  
- **Tarjan缩点**：Tarjan缩点可以应用于其他需要处理环的图论问题，如强连通分量、双连通分量等。

- **双端SPFA**：双端SPFA的思路可以应用于其他需要双向搜索的问题，如最短路径问题中的双向BFS。

### 推荐题目

1. **P2939 [USACO09FEB]Revamping Trails G**：分层图的应用，考察如何在图中进行多次决策。
  
2. **P4568 [JLOI2011]飞行路线**：分层图的应用，考察如何在图中进行多次决策。

3. **P4822 [BJWC2012]冻结**：分层图的应用，考察如何在图中进行多次决策。

---
处理用时：49.03秒
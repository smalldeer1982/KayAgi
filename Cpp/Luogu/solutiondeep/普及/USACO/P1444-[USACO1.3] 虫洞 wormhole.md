# 题目信息

# [USACO1.3] 虫洞 wormhole

## 题目描述

Farmer John 周末进行高能物理实验的结果却适得其反，导致 $n$ 个虫洞出现在农场上，农场是一个二维平面，没有两个虫洞处于同一位置。

根据他的计算，FJ 知道他的虫洞两两配对，形成 $\dfrac{n}{2}$ 对配对。例如，如果 $A$ 和 $B$ 的虫洞连接成一对，进入虫洞 $A$ 的任何物体将从虫洞 $B$ 出去，方向不变；反之亦然。  

然而这可能发生相当令人不快的后果。例如，假设有两个成对的虫洞 $A(1,1)$ 和 $B(3,1)$，Bessie 从 $(2,1)$ 开始朝着 $x$ 正方向移动。Bessie 将进入虫洞 $B(3,1)$，从 $A(1,1)$ 出去，然后再次进入 $B$，困在一个无限循环中！

FJ 知道他的农场里每个虫洞的确切位置。他知道 Bessie 总是向 $x$ 正方向走进来，虽然他不记得贝茜的当前位置。  

请帮助 FJ 计算有多少种虫洞配对方案，使得存在一个位置，使得 Bessie 从该位置出发，会被困在一个无限循环中。

## 说明/提示

### 数据范围
对于 $100\%$ 的数据，$2\le n \le 12$，$0 \le x,y \le 10^9$。  
保证 $n$ 为偶数。

### 样例解释

将虫洞编号为 $1 \sim 4$，然后通过将 $1,2$ 和 $3,4$ 匹配，如果 Bessie 从 $(0,0)$ 到 $(1,0)$ 之间的任意位置出发，她会陷入无限循环中。

相似的，在相同的起始点，如果配对是 $1,3$ 和 $2,4$，贝茜也会陷入循环。（如果贝西从 $3$ 进去，$1$ 出来，她会走向 $2$ ，然后被传送到 $4$，最后又回到 $3$）

仅有 $1,4$ 和 $2,3$ 的配对允许贝茜从任何二维平面上的点向 $x$ 正方向走，而不出现无限循环。

题面翻译摘自 NOCOW

## 样例 #1

### 输入

```
4
0 0
1 0
1 1
0 1```

### 输出

```
2```

# AI分析结果



### 综合分析与结论
本题核心在于枚举所有虫洞配对方式，并检测是否存在无限循环路径。各题解普遍采用DFS生成配对，并模拟行走/传送过程判环。关键优化点在于预处理右侧虫洞和高效判环算法。

---

### 精选题解与关键思路

#### 1. **题解作者：Sino_E（5星）**
**关键亮点**  
- 预处理右侧相邻虫洞（`to[]`数组），极大简化判环逻辑。  
- 分离行走与传送状态，通过`tag[]`标记线段而非节点，避免复杂状态管理。  
- 代码简洁高效，时间复杂度优化明显（约O(n!/(2^{n/2}(n/2)!)) )，适合n=12)。

**核心代码**  
```cpp
bool cycle(int x) {
    while(to[x]) { // 不断向右走，直到无路或发现环
        if(tag[x]) return true;
        tag[x] = 1;
        x = con[to[x]]; // 传送至配对点
    }
    return false;
}
```

**个人心得**  
> "判环时标记线段而非节点，避免重复状态，是调试多次后的关键优化点。"

#### 2. **题解作者：RBI_GL（4星）**
**关键亮点**  
- 使用`pair`排序后直接处理右侧虫洞，代码更易读。  
- 双重循环直接生成配对，DFS逻辑清晰。  

**核心代码**  
```cpp
void dfs(int dep) {
    if(dep>n) { 
        for(int i=1; i<=n; i++) 
            if(check(i)) ans++;
        return;
    }
    // 仅处理未配对的最小索引，避免重复
    for(int i=dep+1; i<=n; i++) {
        pre[dep]=i, pre[i]=dep;
        dfs(dep+1);
        pre[dep]=pre[i]=0;
    }
}
```

---

### 关键技巧总结
1. **预处理右侧虫洞**：按y升序、x升序排序后，右侧相邻虫洞即数组下一位。
2. **配对生成优化**：每次固定选择未配对的最小索引节点，避免重复组合。
3. **状态标记**：判环时标记当前行走的线段（而非节点），处理传送后的新起点。

---

### 相似题目推荐
1. **P1219 [USACO1.5]八皇后** - 经典DFS枚举问题，练习状态表示。
2. **P1092 [NOIP2004]虫食算** - 需要枚举字母映射并验证等式，类似组合搜索。
3. **P1351 [NOIP2014]联合权值** - 图论中处理相邻节点关系的优化技巧。

---
处理用时：49.42秒
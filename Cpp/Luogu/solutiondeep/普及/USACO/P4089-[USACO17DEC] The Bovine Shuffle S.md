# 题目信息

# [USACO17DEC] The Bovine Shuffle S

## 题目描述

Farmer John 坚信快乐的奶牛能产更多的奶，因此他在谷仓里安装了一个巨大的迪斯科球，并计划教他的奶牛跳舞！

在查阅了流行的奶牛舞蹈后，Farmer John 决定教他的奶牛“Bovine Shuffle”。Bovine Shuffle 包括他的 $N$ 头奶牛（$1 \leq N \leq 100,000$）以某种顺序排成一行，然后进行连续的“洗牌”，每次洗牌可能会重新排列奶牛的顺序。为了让奶牛更容易找到自己的位置，Farmer John 为他的奶牛队伍标记了位置 $1 \ldots N$，因此队伍中的第一头奶牛位于位置 1，第二头位于位置 2，依此类推，直到位置 $N$。

一次洗牌由 $N$ 个数字 $a_1 \ldots a_N$ 描述，其中位于位置 $i$ 的奶牛在洗牌期间移动到位置 $a_i$（因此，每个 $a_i$ 都在 $1 \ldots N$ 范围内）。每头奶牛在洗牌期间都会移动到它的新位置。不幸的是，所有的 $a_i$ 不一定互不相同，因此多只奶牛可能会在洗牌期间尝试移动到同一位置，之后它们将在所有剩余的洗牌中一起移动。

Farmer John 注意到，无论进行多少次洗牌，他的队伍中某些位置始终会有奶牛。请帮助他计算这样的位置数量。

## 样例 #1

### 输入

```
4
3 2 1 3```

### 输出

```
3
```

# AI分析结果



### 综合分析与结论
该题核心是判断有向图中始终存在元素的节点，等价于寻找所有环上的节点。主流解法为拓扑排序，通过消除非环节点（入度最终为0的节点）来统计环节点。另有DFS找环、Tarjan缩点等变种，但拓扑排序是时间最优解（O(n)）。

---

### 高星题解推荐

#### 1. QAQ永动机（5星）
**关键亮点**  
- 通过错误猜想引出拓扑排序思路，逻辑推导清晰  
- 代码简洁高效，完整处理入度归零链式反应  
- 附样例图解和错误数据验证思路

**核心代码**  
```cpp
// 拓扑排序消除非环节点
queue<int> q;
for(int i=1;i<=n;i++) if(!in[i]) q.push(i);
while(!q.empty()) {
    int u = q.front(); q.pop();
    if(--in[a[u]] == 0) q.push(a[u]);
}
// 统计剩余入度非零的节点数
int ans=0;
for(int i=1;i<=n;i++) ans += (in[i]>0);
```

#### 2. 翼德天尊（4星）
**关键亮点**  
- 用包裹比喻帮助理解问题抽象  
- 伪代码辅助说明拓扑过程  
- 强调"环上节点不会被链式反应消除"的核心原理

**代码亮点**  
```cpp
while(!q.empty()){
    int now=q.front();
    q.pop();
    in[a[now]]--; // 链式消除入度
    if(in[a[now]] == 0) q.push(a[now]);
}
```

#### 3. 0xFF（4星）
**关键亮点**  
- 明确将问题转化为环检测  
- 强调拓扑正确性证明（非环节点必能被消除）  
- 代码包含快速读入优化

---

### 最优思路提炼
**拓扑排序法核心步骤**  
1. 建图：i → a[i] 的有向边  
2. 统计每个节点的入度  
3. 用队列消除入度为0的节点及其链式影响  
4. 剩余入度非零的节点即为答案

**思维突破点**  
- 发现链式结构最终会因入度归零被消除  
- 仅环结构能维持入度始终非零  
- 将无限次变换转化为图论中的稳态分析

---

### 同类题目推荐
1. [P2661 信息传递](https://www.luogu.com.cn/problem/P2661) - 最小环检测  
2. [P3183 [HAOI2016] 食物链](https://www.luogu.com.cn/problem/P3183) - 带拓扑排序的路径计数  
3. [P2863 [USACO06JAN] The Cow Prom S](https://www.luogu.com.cn/problem/P2863) - 强连通分量计数  

---

### 题解心得分野
**QAQ永动机**的调试经验：  
> "初始猜想通过入度差判断，但发现当父节点入度归零时子节点也会失效，最终通过拓扑排序正确处理链式反应"

**Kirisame_Marisa_**的思维跃迁：  
> "意识到所有环上节点初始时都有牛，且它们的移动会形成永续循环，这与强连通分量的性质完美契合"

**used_to_be**的算法对比：  
> "DFS时间戳法虽能找环，但需注意染色标记的细节处理，相比拓扑排序更易出错"

---
处理用时：53.16秒
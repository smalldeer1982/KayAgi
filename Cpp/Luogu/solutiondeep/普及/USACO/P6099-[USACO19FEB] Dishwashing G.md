# 题目信息

# [USACO19FEB] Dishwashing G

## 题目背景

Bessie 和 Elsie 正在帮助 Farmer John 洗碗，这是一个比人们想象的更复杂的过程。

## 题目描述

两头奶牛决定 Bessie 负责涂肥皂，Elsie 负责冲洗。

刚开始的时候，$N$ 个脏盘子（保证是从 $1$ 到 $N$ 的一个排列）堆在 Bessie 那里，而 Elsie 这边的堆是空的。而在她们俩之间，则有一张专门放涂过肥皂的盘子的桌子。

每个冲洗步骤需要执行以下两个操作之一：

- Bessie 从脏盘子堆顶取出一个盘子，涂上肥皂，然后放在桌子上。将这个盘子放在桌子上时，Bessie 只能放在现有的非空盘堆的顶端，或是在最右边新增一个盘堆。
- Elsie 从桌子最左边的盘堆的顶端拿起盘子，将它冲洗后放在干净的盘堆顶端。

她们希望干净的盘堆能按编号排序，编号最小的在底端，编号最大的在顶端。然而她们发现有的时候这并不可能做到。现在给定脏盘子的堆叠顺序，请你求出一个最大前缀，使得该前缀的所有盘子洗干净后，能按上面的要求堆叠。

## 样例 #1

### 输入

```
5
4
5
2
3
1```

### 输出

```
4```

# AI分析结果



### 综合分析与结论
本题核心是维护多栈结构的单调性，通过贪心策略+栈操作确定最大合法前缀。各题解普遍采用「维护多个单调递减栈+栈间单调递增」的核心思路，并利用二分加速栈的查找。关键难点在于如何高效维护栈的弹出顺序以及正确处理已清洗元素的最大值。

---

### 精选题解与评分

#### 1. 作者：45dino（★★★★★）
**关键亮点**  
- 代码极简，巧用`base`数组预处理每个元素所属栈  
- 通过`placed`变量隐式维护已清洗最大值，避免显式队列  
- 线性时间复杂度，性能最优  

**核心代码**  
```cpp
int base[100001];
vector<int> item[100001];

for(int j=x;j>0&&!base[j];j--) 
    base[j]=x; // 预处理元素所属栈
while(!item[base[x]].empty()&&item[base[x]].back()<x) {
    placed=item[base[x]].back();
    item[base[x]].pop_back();
}
item[base[x]].push_back(x);
```

#### 2. 作者：miao5（★★★★☆）
**关键亮点**  
- 详细注释配图解释贪心策略  
- 显式维护栈间单调性，逻辑清晰  
- 二分查找插入位置，代码可读性强  

**核心片段**  
```cpp
int ans=-1,l=1,r=head;
while(l<=r){ // 二分找最左可行栈
    int mid=l+r>>1;
    if(v[mid].front()>x) r=mid-1,ans=mid;
    else l=mid+1;
}
while(!v[ans].empty()&&v[ans].back()<x) // 弹出小元素
    maxn=max(maxn,v[ans].back()),v[ans].pop_back();
v[ans].push_back(x);
```

#### 3. 作者：cyn2006（★★★★☆）
**关键亮点**  
- 严格证明栈结构的单调性要求  
- 引入回收站最大值变量，避免重复计算  
- 使用`deque`高效处理栈的两端操作  

**核心思想**  
> "每个栈自上向下递减，栈间左侧所有元素小于右侧。当新元素破坏单调性时，二分找到插入位置并弹出顶部较小元素，同时更新已清洗最大值"

---

### 关键思路总结
1. **栈结构设计**：维护多个单调递减栈，栈间保持从左到右递增（按栈顶元素）
2. **贪心插入**：新元素若比最后一个栈顶大则新建栈，否则二分查找最左可插入栈
3. **弹出策略**：插入时弹出栈顶比当前元素小的所有元素，更新已清洗最大值`placed`
4. **终止条件**：当新元素小于`placed`时，立即返回当前前缀长度

---

### 相似题目推荐
1. [P1155 双栈排序](https://www.luogu.com.cn/problem/P1155) - 双栈操作的合法性判断  
2. [P5149 会议座位](https://www.luogu.com.cn/problem/P5149) - 利用栈维护逆序对  
3. [P3467 PLA-Postering](https://www.luogu.com.cn/problem/P3467) - 单调栈经典应用  

---

### 调试经验摘录
1. **初始值陷阱**：`placed`或`maxx`需初始化为极小值，否则首个元素可能误判（songzhixin题解）
2. **栈空判断**：弹出操作前必须检查栈是否为空，否则引发段错误（Addicted_Game注释）
3. **二分边界**：查找插入位置时需处理全左或全右情况（wu13115899522代码中的`r++`调整）

---
处理用时：51.26秒
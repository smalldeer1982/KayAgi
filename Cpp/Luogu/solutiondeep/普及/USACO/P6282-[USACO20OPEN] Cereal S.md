# 题目信息

# [USACO20OPEN] Cereal S

## 题目描述

Farmer John 的奶牛们的早餐最爱当然是麦片了！事实上，奶牛们的胃口是如此之大，每头奶牛一顿饭可以吃掉整整一箱麦片。

最近农场收到了一份快递，内有 $M$ 种不同种类的麦片（$1\le M\le 10^5$）。不幸的是，每种麦片只有一箱！$N$ 头奶牛（$1\le N\le 10^5$）中的每头都有她最爱的麦片和第二喜爱的麦片。给定一些可选的麦片，奶牛会执行如下的过程：

- 如果她最爱的麦片还在，取走并离开。
- 否则，如果她第二喜爱的麦片还在，取走并离开。
- 否则，她会失望地哞叫一声然后不带走一片麦片地离开。

奶牛们排队领取麦片。对于每一个 $0\le i\le N-1$，求如果 Farmer John 从队伍中移除前 $i$ 头奶牛，有多少奶牛会取走一箱麦片。

## 说明/提示

### 样例解释
如果至少两头奶牛留下，那么恰有两头奶牛取走了一箱麦片。

### 子任务
- 测试点 $2$-$3$ 满足 $N,M\le 10^3$。
- 测试点 $4$-$10$ 没有额外限制。

## 样例 #1

### 输入

```
4 2
1 2
1 2
1 2
1 2```

### 输出

```
2
2
2
1```

# AI分析结果



### 综合分析与结论
各题解核心思路集中于倒序处理与抢占式递归，通过线性时间复杂度解决暴力模拟的瓶颈。最优解法通过逆向添加奶牛并处理冲突链，保证每头牛最多被处理两次，时间复杂度为 O(n)。

---

### 精选题解

#### 1. 作者：PersistentLife（★★★★★）
**关键亮点**  
- 逆向添加奶牛，利用递归处理抢占逻辑，代码简洁高效  
- 时间复杂度严格 O(n)，每个奶牛至多触发两次递归  
- 代码可读性强，关键逻辑封装在 solve 函数中  

**核心代码**  
```cpp
void solve(int x,int y){
    if(h[y]==0){
        h[y]=x; cur++;
    } else if(h[y]>x){
        int z=h[y];
        h[y]=x;
        if(y==c[z].f) solve(z,c[z].s);
    }
}
// 调用方式：倒序遍历奶牛，每次处理最喜爱的麦片
for(int i=n-1;i>=0;i--) solve(i+1,c[i+1].f),res[i+1]=cur;
```

#### 2. 作者：super蒟蒻（★★★★☆）
**关键亮点**  
- 创新性地使用差分数组维护时间点  
- 通过 p 数组记录麦片最后被占用的时间，结合 min 操作推导答案  
- 代码异常简洁（仅 15 行），空间复杂度优化到 O(m)  

**核心代码**  
```cpp
for(int i=1;i<=n;i++){
    int a,b; scanf("%d%d",&a,&b);
    ++s[min(p[a],p[b])+1]; // 差分标记有效时间起点
    --s[i+1];
    p[b]=max(p[b],p[a]);   // 更新次优麦片的时间点
    p[a]=i;                // 最优麦片被当前时间独占
}
```

#### 3. 作者：Haphyxlos（★★★★☆）
**关键亮点**  
- 用结构体存储奶牛选择状态，通过循环而非递归解决冲突  
- 引入优先级比较逻辑（j < b[x]），直观体现"抢占"语义  
- 代码中维护选择状态的数组设计巧妙  

**核心代码**  
```cpp
for(int j=i; e[j].p <2;){
    int x = e[j].c[e[j].p++];
    if(j < b[x]) swap(b[x],j); // 抢占逻辑
    else if(!b[x]){ 
        b[x]=j; s++; break; 
    }
}
```

---

### 关键思路总结
1. **逆向处理**：从后往前添加奶牛，天然保证优先级顺序，避免重复计算。  
2. **抢占式递归**：当新奶牛抢占麦片时，递归/循环处理被抢占者的次优选择。  
3. **状态覆盖**：用数组记录每个麦片的当前拥有者，通过比较序号实现 O(1) 抢占判断。  

---

### 类似题目推荐
1. [P1967 货车运输](https://www.luogu.com.cn/problem/P1967)（逆向处理+贪心）  
2. [P3143 Diamond Collector](https://www.luogu.com.cn/problem/P3143)（前缀和+差分优化）  
3. [P2894 Hotel](https://www.luogu.com.cn/problem/P2894)（线段树维护连续区间，资源抢占思想）  

---

### 调试心得摘录
- **PersistentLife**：  
  > "cur不需要清零，因为添加奶牛的过程是累加的" —— 强调逆向计算时答案的单调性  
- **miao5**：  
  > "被挤掉的奶牛重新选麦片可能触发连锁反应" —— 提醒注意递归边界条件  
- **_edge_**：  
  > "用pre_变量记录被抢占者，避免递归栈溢出" —— 循环实现抢占链的经典技巧

---
处理用时：52.40秒
# 题目信息

# [USACO22JAN] Cow Frisbee S

## 题目描述

Farmer John 的 $N\ (N\le 3\times 10^5)$ 头奶牛的高度为 $1, 2, \ldots, N$。一天，奶牛以某个顺序排成一行玩飞盘；令 $h_1 \ldots h_N$ 表示此顺序下奶牛们的高度（因此 $h$ 是 $1 \ldots N$ 的一个排列）。

队伍中位于位置 $i$ 和 $j$ 的两头奶牛可以成功地来回扔飞盘当且仅当她们之间的每头奶牛的高度都低于 $\min(h_i, h_j)$。

请计算所有可以成功地来回扔飞盘的奶牛所在的位置对 $i\le j$ 之间的距离总和。位置 $i$ 和 $j$ 之间的距离为 $j-i+1$。

## 说明/提示

【样例解释】

这个例子中可以成功的位置对如下：

```
(1, 2), (1, 5), (2, 3), (2, 4), (2, 5), (3, 4), (4, 5), (5, 6), (6, 7)
```

【数据范围】

- 测试点 1-3 满足 $N\le 5000$。

- 测试点 4-11 没有额外限制。

## 样例 #1

### 输入

```
7
4 3 1 2 5 6 7```

### 输出

```
24```

# AI分析结果



### 综合分析与结论
本题核心在于快速找到满足条件的区间对，其关键在于发现相邻极大值对区间的分割作用。各题解普遍采用单调栈的解法，时间复杂度为 O(n)。主要思路可分为两类：
1. **正向累积法**：维护单调递减栈，在弹出较小元素时直接计算贡献（占主流解法）
2. 逆向排除法：先计算总距离再减去无效对（数学推导要求较高）

### 高星题解推荐
#### 1. V1mnkE（★★★★★）
**核心亮点**：
- 简洁的单调栈实现，代码仅15行
- 实时维护贡献累加，逻辑清晰易理解
**关键思路**：维护递减栈，当新元素破坏单调性时，弹出的每个元素都与当前元素形成有效对。栈顶剩余元素（若有）也与当前元素形成有效对。
```cpp
while (!s.empty() && a[s.top()] < a[i]) {
    ans += i - s.top() + 1;
    s.pop();
}
if (!s.empty()) ans += i - s.top() + 1;
s.push(i);
```

#### 2. YCSluogu（★★★★★）
**核心亮点**：
- 代码与思路高度对应，注释完整
- 明确解释"挡住"的物理意义，帮助理解
**关键实现**：与V1mnkE思路相同，但补充了更详细的题意转化说明，适合新手学习。

#### 3. I_am_Accepted（★★★★☆）
**核心亮点**：
- 极简代码实现（仅12行核心逻辑）
- 使用栈存储额外贡献值优化计算
**独特技巧**：维护栈中存储每个元素对应的贡献值，避免重复计算
```cpp
while(t&&a[q[t][0]]<a[i]){
    sk2 += i-q[t][0]+1;
    ans += q[t][1]; // 累积历史贡献
    t--;
}
q[++t][0]=i, q[t][1]=sk2; // 存储当前贡献
```

### 关键思路总结
**单调栈核心操作**：
1. 维护递减栈保证栈内元素是最近的更高候选
2. 每个新元素触发栈顶较小元素的弹出，此时：
   - 弹出的元素与当前元素形成有效对
   - 栈顶剩余元素与当前元素形成有效对
3. 时间复杂度由每个元素入栈出栈各一次保证 O(n)

### 拓展与相似题目
1. **P1901 发射站**（单调栈求相邻能量接收）
2. **P5788 单调栈模板题**（求右侧第一个更大元素）
3. **P1823 音乐会的等待**（区间对数统计）

### 题解中的个人心得摘录
- **SengRiy**：手动推导栈操作过程，强调"栈顶后一个元素必然能与当前元素形成有效对"
- **luckydrawbox**：指出每个数对只会被较小值计算一次，避免重复统计的思考
- **wwz1428572008**：尝试用ST表+二分求解，虽非最优但提供分治思路参考

### 核心代码片段
```cpp
// V1mnkE的核心逻辑
for (int i=1;i<=n;i++){
    while (!s.empty() && a[s.top()]<a[i]) {
        ans += i-s.top()+1; // 弹出元素的贡献
        s.pop();
    }
    if (!s.empty()) 
        ans += i-s.top()+1; // 与栈顶的贡献
    s.push(i);
}
```

---
处理用时：50.29秒
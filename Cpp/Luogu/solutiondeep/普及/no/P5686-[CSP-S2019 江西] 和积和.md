# 题目信息

# [CSP-S2019 江西] 和积和

## 题目背景

JXCSP-S T2

## 题目描述

给定两个下标从 $1$ 到 $n$ 编号的序列 $a_i,b_i$，定义函数 $S(l,r)(1\le l\le r\le n)$ 为：

$$\sum_{i=l}^r a_i\times \sum_{i=l}^r b_i$$

请你求出下列式子的值：

$$\sum_{l=1}^n \sum_{r=l}^n S(l,r)$$

由于答案可能很大，你只需要给出答案模 $10^9+7$ 后的结果。

## 说明/提示

【数据范围】   
对于 $20\%$  的数据：$n\le 10$ , $a_i,b_i\le 10$；   
对于 $40\%$  的数据：$n\le 200$ , $a_i,b_i\le 100$；    
对于 $70\%$  的数据：$n\le 3000$ , $a_i,b_i\le 10^5$；    
对于 $100\%$  的数据：$3\le n\le 5\times 10^5$ , $1\le a_i,b_i\le 10^9$。

## 样例 #1

### 输入

```
3
2 3 4
3 4 5```

### 输出

```
244```

## 样例 #2

### 输入

```
5
11 22 33 44 55
12 34 56 78 90```

### 输出

```
201542```

# AI分析结果



### 算法分类
数学、前缀和

### 题解综合分析
本题核心是将暴力枚举子区间转化为数学公式展开，利用前缀和的前缀和进行快速计算。主要思路是将原式拆分为四个可独立计算的项，通过维护多个前缀和数组实现 O(n) 复杂度。各题解均围绕这一核心展开，差异主要体现在拆分形式和预处理方式上。

---

### 精选题解

#### 1. 周子衡题解（⭐⭐⭐⭐⭐）
**关键亮点**：  
- 将式子展开为四个独立项，每个项均可通过前缀和的前缀和计算  
- 采用滚动变量维护历史前缀和，空间复杂度优化到 O(1)  
- 代码简洁高效，时间复杂度 O(n)

**核心代码**：
```cpp
for(int r=1; r<=n; ++r) {
    ll term1 = r * suma[r] % mod * sumb[r] % mod;
    ll term2 = sumb[r] * sum_a_l_prev % mod;
    ll term3 = suma[r] * sum_b_l_prev % mod;
    ll term4 = sum_ab_prev;
    ans = (ans + term1 - term2 - term3 + term4) % mod;
    
    // 更新前缀和累计变量
    sum_a_l_prev = (sum_a_l_prev + suma[r-1]) % mod;
    sum_b_l_prev = (sum_b_l_prev + sumb[r-1]) % mod;
    sum_ab_prev = (sum_ab_prev + suma[r-1]*sumb[r-1]) % mod;
}
```

#### 2. LCuter题解（⭐⭐⭐⭐）
**关键亮点**：  
- 基于贡献法，将答案拆解为每个元素的交叉贡献  
- 利用前缀和计算 j≤i 和 j>i 的不同贡献形式  
- 通过维护乘积前缀和减少计算量

**核心推导**：
$$Ans = \sum_{i=1}^n a_i \left[ (n-i+1)\sum_{j=1}^i jb_j + i(n+1)\sum_{j=i+1}^n b_j - i\sum_{j=i+1}^n jb_j \right]$$

---

### 关键思路总结
1. **公式展开**：将原式 $(suma_r-suma_{l-1})(sumb_r-sumb_{l-1})$ 展开为四项，分离出可独立计算的项  
2. **前缀和优化**：维护三个累计变量分别记录 $\sum suma_l$, $\sum sumb_l$, $\sum suma_l \cdot sumb_l$  
3. **滚动计算**：通过单次遍历，在计算当前 r 的同时更新历史前缀和的累计值

---

### 拓展思考
同类问题可考虑以下优化方向：  
1. 子数组乘积和问题（如 $\sum (a_i + a_j)(b_i + b_j)$）  
2. 多维前缀和的组合优化  
3. 贡献法在区间统计中的应用

---

### 推荐题目
1. [P1719 寻找平方和](https://www.luogu.com.cn/problem/P1719)  
2. [P3406 海底高铁](https://www.luogu.com.cn/problem/P3406)  
3. [P3131 子序列计数](https://www.luogu.com.cn/problem/P3131)

---

### 调试心得摘录
- **取模陷阱**：减法取模后需加 mod 再取模，如 `(ans - x + mod) % mod`  
- **变量维护顺序**：先计算当前项的贡献，再更新历史前缀和累计值  
- **long long 强制转换**：中间结果可能溢出，需显式转换为 `long long`

---
处理用时：53.07秒
# 题目信息

# 「CROI · R1」浣熊的溪石

## 题目背景

>回首往昔，碧空如洗，日暖风恬。\
溪石深浅有致地错落在明澈似玉的梦枫溪里。\
浣熊们水上跑酷的无限趣忆亦于此伊始……


## 题目描述

日升月落，春去秋来，梦枫溪石的高度千变万化。
爱思考的小浣熊 CleverRaccoon 想探寻这些溪石究竟能构成多少种不同的高度序列。

现有若干个长度为 $n$ 的非负整数列 $a$。

当 $n>1$ 时，$a_1,a_n$ 的取值为 $0\sim m$，其它数 $a_i$ 的取值为 $0\sim m-1$，其中 $2\leq i \leq n-1$。

当 $n=1$ 时，$a_1$ 的取值为 $0\sim m+1$。

**定义**：当且仅当 $\forall i\in\{1,2,\dots ,n\},a_i=b_i$ 或 $\forall i\in\{1,2,\dots ,n\},a_i=b_{n-i+1}$ 时，数列 $a,b$ 相同。

现给定 $n,m$，请求出最多有多少个**不同**的数列，答案对 $998244353$ 取模。

## 说明/提示

#### 解释 #1

当 $n=1,m=3$ 时，$a_i\in\{0,1,2,3,4\}$，共有 $5$ 种不同的高度序列。

当 $n=2,m=2$ 时，共有 $6$ 种不同的高度序列，详情如下：

|序号|$a_1=$|$a_2=$|
|:-:|:-:|:-:|
|$1$|$0$|$0$|
|$2$|$0$|$1$|
|$3$|$0$|$2$|
|$4$|$1$|$1$|
|$5$|$1$|$2$|
|$6$|$2$|$2$|

#### 数据范围
**本题采用 Subtask 捆绑测试。**

|Subtask|$n\leq$|$m\leq$|$T\leq$|特殊性质|Score|
|:-:|:-:|:-:|:-:|:-:|:-:|
|$0$|$10$|$10$|$10$|无特殊性质|$10$|
|$1$|$10^3$|$1$|$10^3$|$m=1$|$5$|
|$2$|$10^3$|$3$|$10$|$m=3$|$10$|
|$3$|$10^3$|$10^3$|$1$|无特殊性质|$15$|
|$4$|$10^6$|$10^3$|$100$|无特殊性质|$10$|
|$5$|$10^6$|$10^6$|$10^6$|无特殊性质|$20$|
|$6$|$10^9$|$10^9$|$10^6$| $n$ 为奇数|$10$|
|$7$|$10^9$|$10^9$|$10^6$| $n$ 为偶数|$10$|
|$8$|$10^{18}$|$10^9$|$10^6$|无特殊性质|$10$|

对于 $100\%$ 的数据，保证 $1\leq n\leq10^{18},1\leq m\leq10^9,1\leq T\leq10^6$。

## 样例 #1

### 输入

```
3
1 3
2 2
6 3```

### 输出

```
5
6
666
```

# AI分析结果



### 算法分类
组合数学

### 综合分析与结论
题目核心是计算满足对称等价条件的高度序列数量。各题解的核心思路均为将问题拆分为回文序列和非回文序列两类：非回文序列会被对称复制两次，回文序列仅计算一次。最终公式为 $\frac{(总方案数 + 回文方案数)}{2}$，其中总方案数为 $(m+1)^2m^{n-2}$，回文方案数为 $(m+1)m^{\lceil n/2 \rceil-1}$。难点在于正确推导回文序列的数学表达式，以及处理大数快速幂和模运算下的逆元。

---

### 精选题解

#### 1. 作者：Register_int（5星）
**关键亮点**  
- 直接给出组合数学公式 $\frac{(m+1)^2m^{n-2} + (m+1)m^{\lceil n/2 \rceil-1}}{2}$，思路清晰简洁。
- 代码高效，利用快速幂和逆元处理模运算。
- 包含对 $n=1$ 的特判处理。

**核心代码**  
```cpp
ll ans = (m + 1) * qpow(m, n - 1 >> 1) % mod;
ans = (ans * ans % mod * (n & 1 ? qpow(m, mod - 2) : 1) % mod + ans) * inv % mod;
```
**实现思想**  
计算前半部分方案数后平方处理总情况，利用奇偶性调整中间项，最后乘逆元完成除法。

#### 2. 作者：251Sec（5星）
**关键亮点**  
- 用最简形式呈现核心公式，代码仅用4行完成全部计算。
- 显式分离总方案数 $f$ 和回文数 $g$，逻辑极简。
- 使用编译期常量逆元优化性能。

**核心代码**  
```cpp
ll f = (m + 1) * (m + 1) % P * QPow(m, n - 2) % P;
ll g = (m + 1) * QPow(m, (n + 1) / 2 - 1) % P;
printf("%lld\n", (f + g) % P * I2 % P);
```

#### 3. 作者：船酱魔王（4星）
**关键亮点**  
- 详细推导回文结构计数原理，给出公式推导过程。
- 代码中显式处理奇数情况的中间项乘法。
- 使用预处理逆元而非即时计算，优化运行效率。

**代码亮点**  
```cpp
int ans = ((long long)pw(m + 1, 2) * pw(m, n - 2) % mod 
          + (long long)pw(m + 1, 1) * pw(m, hf - 1) % mod) % mod;
ans = ans * inv_2 % mod; // inv_2为预计算的逆元
```

---

### 关键思路与技巧
1. **对称结构计数**：将问题拆分为回文和非回文序列，利用 $\frac{总+回文}{2}$ 公式去重。
2. **快速幂优化**：处理超大指数 $m^{1e18}$ 时使用二进制分解快速幂。
3. **模运算技巧**：用费马小定理（$mod=998244353$ 是质数）求逆元代替除法。
4. **奇偶分治**：通过 $\lceil n/2 \rceil$ 统一处理奇偶情况。

---

### 拓展与相似题目
- **P1224 [NOI2013] 矩阵游戏**（对称递推）
- **P3811 【模板】乘法逆元**（逆元基础应用）
- **P1495 CRT中国剩余定理**（模运算组合数学）

---
处理用时：60.27秒
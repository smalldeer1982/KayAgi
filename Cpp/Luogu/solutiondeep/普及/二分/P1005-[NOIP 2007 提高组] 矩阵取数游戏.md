# 题目信息

# [NOIP 2007 提高组] 矩阵取数游戏

## 题目描述

帅帅经常跟同学玩一个矩阵取数游戏：对于一个给定的 $n \times m$ 的矩阵，矩阵中的每个元素 $a_{i,j}$ 均为非负整数。游戏规则如下：

1. 每次取数时须从每行各取走一个元素，共 $n$ 个。经过 $m$ 次后取完矩阵内所有元素；
2. 每次取走的各个元素只能是该元素所在行的行首或行尾；
3. 每次取数都有一个得分值，为每行取数的得分之和，每行取数的得分 = 被取走的元素值 $\times 2^i$，其中 $i$ 表示第 $i$ 次取数（从 $1$ 开始编号）；
4. 游戏结束总得分为 $m$ 次取数得分之和。

帅帅想请你帮忙写一个程序，对于任意矩阵，可以求出取数后的最大得分。


## 说明/提示

**【数据范围】**

对于 $60\%$ 的数据，满足 $1\le n,m\le 30$，答案不超过 $10^{16}$。  
对于 $100\%$ 的数据，满足 $1\le n,m\le 80$，$0\le a_{i,j}\le1000$。

**【题目来源】**

NOIP 2007 提高第三题。





## 样例 #1

### 输入

```
2 3
1 2 3
3 4 2
```

### 输出

```
82```

# AI分析结果

### 综合分析与结论

本题的核心是区间动态规划（DP），每行的取数操作互不影响，因此可以对每行单独进行DP。主要难点在于如何设计状态转移方程以及处理大数运算（如使用`__int128`或高精度）。各题解的思路基本一致，但在状态转移方程的设计、代码实现细节、以及大数处理方式上有所不同。

### 所选高星题解

#### 1. 作者：zhylj (5星)
- **关键亮点**：状态转移方程简洁明了，使用`__int128`处理大数运算，代码简洁高效。
- **个人心得**：通过将每次取数的得分乘以2，避免了复杂的幂运算，简化了转移方程。
- **核心代码**：
```cpp
__int128 solve(__int128 a[]) {
    memset(f, 0, sizeof(f));
    for(int len=0; len<=m; ++len)
        for(int i=1; i+len<=m; ++i)
            f[i][i+len] = max(2*f[i+1][i+len] + 2*a[i], 2*f[i][i+len-1] + 2*a[i+len]);
    return f[1][m];
}
```
- **实现思想**：通过区间DP，每次取数时将剩余区间的得分乘以2，并加上当前取数的得分。

#### 2. 作者：qhr2023 (4.5星)
- **关键亮点**：状态转移方程清晰，使用`__int128`处理大数运算，代码结构清晰。
- **核心代码**：
```cpp
for (int len=1; len<=m; ++len) 
    for (int l=1, r=l+len-1; r<=m; ++l, ++r)
        f[l][r] = max(f[l+1][r] + a[i][l], f[l][r-1] + a[i][r]) * 2;
```
- **实现思想**：通过区间DP，每次取数时将剩余区间的得分乘以2，并加上当前取数的得分。

#### 3. 作者：Tomwsc (4星)
- **关键亮点**：状态转移方程清晰，使用`__int128`处理大数运算，代码结构清晰。
- **核心代码**：
```cpp
for(register int i = 1; i <= m; i++)
    for(register int j = m; j >= i; j--)
        dp[i][j] = max(dp[i - 1][j] + a[i - 1] * poww[m - j + i - 1], dp[i][j + 1] + a[j + 1] * poww[m - j + i - 1]);
```
- **实现思想**：通过区间DP，每次取数时将剩余区间的得分乘以2，并加上当前取数的得分。

### 最优关键思路与技巧

1. **区间DP**：每行的取数操作可以看作是一个区间DP问题，状态转移方程通常为`f[l][r] = max(f[l+1][r] + a[l], f[l][r-1] + a[r]) * 2`。
2. **大数处理**：由于得分可能非常大，使用`__int128`或高精度来处理大数运算。
3. **转移顺序**：从大区间向小区间转移，确保每次取数时剩余区间的得分已经计算完毕。

### 可拓展之处

- **类似题目**：可以考虑其他区间DP问题，如最长回文子序列、石子合并等。
- **优化技巧**：在处理大数运算时，可以进一步优化高精度运算的效率，如使用四位数压缩法。

### 推荐题目

1. **P1880 [NOI1995] 石子合并**：区间DP经典题目，考察石子合并的最小代价。
2. **P1040 加分二叉树**：区间DP与树形结构的结合，考察如何构造最优二叉树。
3. **P1063 能量项链**：区间DP与环形结构的结合，考察如何最大化能量项链的得分。

### 个人心得总结

- **调试经历**：在处理大数运算时，使用`__int128`可以避免高精度运算的复杂性，但需要注意输出函数的实现。
- **踩坑教训**：在状态转移方程中，确保每次取数时剩余区间的得分已经计算完毕，避免出现未定义行为。
- **顿悟感想**：通过将每次取数的得分乘以2，可以简化状态转移方程，避免复杂的幂运算。

---
处理用时：30.99秒
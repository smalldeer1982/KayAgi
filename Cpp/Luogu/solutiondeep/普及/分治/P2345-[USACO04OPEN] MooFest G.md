# 题目信息

# [USACO04OPEN] MooFest G

## 题目背景

[P5094 [USACO04OPEN] MooFest G 加强版](https://www.luogu.com.cn/problem/P5094)


## 题目描述

约翰的 $n$ 头奶牛每年都会参加“哞哞大会”。

哞哞大会是奶牛界的盛事。集会上的活动很多，比如堆干草，跨栅栏，摸牛仔的屁股等等。

它们参加活动时会聚在一起，第 $i$ 头奶牛的坐标为 $x_i$，没有两头奶牛的坐标是相同的。

奶牛们的叫声很大，第 $i$ 头和第 $j$ 头奶牛交流，会发出
$\max\{v_i,v_j\}\times |x_i − x_j |$ 
的音量，其中 $v_i$ 和 $v_j$ 分别是第 $i$ 头和第 $j$ 头奶牛的听力。

假设每对奶牛之间同时都在说话，请计算所有奶牛产生的音量之和是多少。

## 样例 #1

### 输入

```
4
3 1
2 5
2 6
4 3```

### 输出

```
57```

# AI分析结果



### 综合分析结论
本题核心在于高效计算 $\max(v_i,v_j) \times |x_i-x_j|$ 的总和。主流解法通过排序消除 $\max$ 的影响，结合数据结构或分治策略处理绝对值求和。最优解法时间复杂度为 $O(n \log n)$，主要采用树状数组维护前缀信息或分治策略拆分问题。

---

### 精选题解推荐

#### 1. 龙·海流（★★★★★）
**关键亮点**：  
- 排序后树状数组维护坐标前缀和与数量，将绝对值拆分为左右两部分计算  
- 代码结构清晰，利用两个树状数组分别维护数量和坐标和  
- 通过插入顺序保证 $v$ 的单调性，完美处理 $\max$ 的贡献  

**核心代码思想**：
```cpp
for(int i=1;i<=n;++i) {
    int j = a[i].xi; // 当前坐标
    // 计算左侧贡献: cnt*x - sum_x_left
    // 计算右侧贡献: sum_x_right - cnt*x
    ans += a[i].vi * (z(j-1)*j - y(j-1) + y(mn)-y(j) - (z(mn)-z(j))*j);
    crwz(j); cryy(j, j); // 更新树状数组
}
```

#### 2. UltiMadow（★★★★☆）
**关键亮点**：  
- CDQ分治结合归并排序，处理绝对值时拆分左右区间  
- 维护左右区间的坐标和与数量，通过双指针快速计算贡献  
- 利用排序后的性质，右边 $v$ 严格大于左边，保证正确性  

**核心代码思想**：
```cpp
void cdq(int l, int r) {
    if(l >= r) return;
    int mid = (l+r)/2;
    cdq(l, mid); cdq(mid+1, r);
    // 对左右区间按x排序后，双指针计算贡献
    for(int i=mid+1; i<=r; i++) {
        while(ll <= mid && a[ll].x < a[i].x) {
            s2 += a[ll].x; s1 -= a[ll].x; ll++;
        }
        ans += a[i].v * (a[i].x*(ll-l) - s2 + s1 - a[i].x*(mid-ll+1));
    }
    merge_sort(l, r); // 归并保持x有序
}
```

#### 3. 双管荧光灯（★★★★☆）
**关键亮点**：  
- 分治过程中归并排序维护坐标有序性  
- 通过中点划分，统计左右贡献时直接计算坐标差  
- 利用递归特性自然分割问题，代码简洁高效  

**核心代码思想**：
```cpp
void cdqdfs(int l, int r) {
    int mid = (l+r)/2;
    cdqdfs(l, mid); cdqdfs(mid+1, r);
    // 统计左半区间总和，双指针计算贡献
    for(int i=mid+1; i<=r; i++) {
        while(ll <= mid && a[ll].x < a[i].x) {
            s2 += a[ll].x; s1 -= a[ll].x; ll++;
        }
        ans += a[i].v * (a[i].x*(ll-l) - s2 + s1 - a[i].x*(mid-ll+1));
    }
    merge(l, r); // 归并保持有序
}
```

---

### 最优关键思路总结
1. **排序消去最大值**：按 $v$ 升序排序，保证后续处理的 $v$ 严格更大，直接乘当前 $v_i$。  
2. **数据结构维护前缀**：使用树状数组维护已处理奶牛的坐标和与数量，快速计算 $\sum |x_i - x_j|$。  
3. **分治处理绝对值**：通过归并排序拆分左右区间，利用双指针统计左右贡献，避免暴力计算。  

---

### 拓展与举一反三
- **同类问题**：逆序对（P1908）、二维偏序（P1972）、三维偏序（P3810）  
- **技巧迁移**：绝对值拆分为左右贡献的思想适用于所有带绝对值的求和问题（如 P3604）。  

---

### 推荐习题
1. [P1908 逆序对](https://www.luogu.com.cn/problem/P1908)  
2. [P1972 HH的项链](https://www.luogu.com.cn/problem/P1972)  
3. [P3810 三维偏序](https://www.luogu.com.cn/problem/P3810)  

---

### 题解心得摘录
- **龙·海流**：强调开 `long long` 的重要性，树状数组下标需覆盖最大坐标。  
- **UltiMadow**：分治中排序时机不影响正确性，但影响常数优化。  
- **双管荧光灯**：归并排序后右区间的 $v$ 严格大于左区间，保证贡献计算正确。

---
处理用时：76.22秒
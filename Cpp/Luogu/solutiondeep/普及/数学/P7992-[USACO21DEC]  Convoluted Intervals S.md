# 题目信息

# [USACO21DEC]  Convoluted Intervals S

## 题目描述

奶牛们正在努力尝试发明有趣的新游戏来玩。他们目前的工作之一与一组 $N$ 个区间（$1\le N\le 2\cdot 10^5$）有关，其中第 $i$ 个区间从数轴上的 $a_i$ 位置开始，并在位置 $b_i \geq a_i$ 结束。$a_i$ 和 $b_i$ 均为 $0 \ldots M$ 范围内的整数，其中 $1 \leq M \leq 5000$。

这个游戏的玩法是，Bessie 选择某个区间（假设是第 $i$ 个区间），而她的表妹 Elsie 选择某个区间（假设是第 $j$ 个区间，可能与 Bessie 所选的的区间相同）。给定某个值 $k$，如果 $a_i + a_j \leq k \leq b_i + b_j$，则她们获胜。

对范围 $0 \ldots 2M$ 内的每个值 $k$，请计算使得 Bessie 和 Elsie 可以赢得游戏的有序对 $(i,j)$ 的数量。

## 说明/提示

【样例解释】

在这个例子中，对于 $k=3$，有三个有序对可以使得 Bessie 和 Elsie 获胜：$(1, 1)$，$(1, 2)$，和 $(2, 1)$。

【数据范围】

- 测试点 1-2 满足 $N\le 100, M\le 100$。
- 测试点 3-5 满足 $N\le 5000$。
- 测试点 6-20 没有额外限制。

## 样例 #1

### 输入

```
2 5
1 3
2 5```

### 输出

```
0
0
1
3
4
4
4
3
3
1
1
```

# AI分析结果

### 综合分析与结论

本题的核心在于如何高效计算满足条件的有序对 $(i,j)$ 的数量。由于 $N$ 的范围较大（$2 \times 10^5$），直接枚举所有区间对会导致 $O(N^2)$ 的复杂度，无法通过。因此，题解普遍采用了**桶计数**和**差分数组**的技巧，利用 $M$ 的范围较小（$5000$），将问题转化为 $O(M^2)$ 的复杂度。

关键思路：
1. **桶计数**：通过桶数组 `fa` 和 `fb` 分别记录每个区间的起点和终点的出现次数。
2. **差分数组**：利用差分数组 `f` 来记录每个 $k$ 的贡献，最后通过前缀和得到最终答案。
3. **乘法原理**：通过枚举 $a_i$ 和 $a_j$ 的值，利用乘法原理计算对 $k$ 的贡献。

### 所选高星题解

#### 1. 题解作者：xkcdjerry (5星)
**关键亮点**：
- 思路清晰，详细解释了桶计数和差分数组的使用。
- 代码简洁，优化程度高，直接利用 $O(M^2)$ 的复杂度解决问题。
- 特别提醒了数据类型的使用，避免溢出问题。

**核心代码**：
```cpp
for(int i=0;i<=m;i++)
    for(int j=0;j<=m;j++)
    {
        f[i+j]+=fa[i]*fa[j];
        f[i+j+1]-=fb[i]*fb[j];
    }
```
**实现思想**：通过双重循环枚举 $a_i$ 和 $a_j$ 的值，利用乘法原理计算对 $k$ 的贡献，并通过差分数组记录。

#### 2. 题解作者：shiranui (4星)
**关键亮点**：
- 详细解释了差分数组的使用，并通过样例进行了说明。
- 代码结构清晰，易于理解。

**核心代码**：
```cpp
for(int i=0;i<=m;i++)
    for(int j=0;j<=m;j++)
        if(ha[i]!=0&&ha[j]!=0)f[i+j]+=ha[i]*ha[j];
```
**实现思想**：通过枚举 $a_i$ 和 $a_j$ 的值，利用乘法原理计算对 $k$ 的贡献，并通过差分数组记录。

#### 3. 题解作者：Skyjoy (4星)
**关键亮点**：
- 从不等式的角度出发，详细推导了如何利用前缀和和差分数组解决问题。
- 代码简短，优化程度高。

**核心代码**：
```cpp
for(int i=0;i<=m;i++)for(int j=0;j<=m;j++)sum[i+j]+=1ll*cnta[i]*cnta[j],sum[i+j+1]-=1ll*cntb[i]*cntb[j];
```
**实现思想**：通过双重循环枚举 $a_i$ 和 $a_j$ 的值，利用乘法原理计算对 $k$ 的贡献，并通过差分数组记录。

### 最优关键思路与技巧
1. **桶计数**：利用 $M$ 的范围较小，通过桶数组记录每个区间的起点和终点的出现次数。
2. **差分数组**：通过差分数组记录每个 $k$ 的贡献，最后通过前缀和得到最终答案。
3. **乘法原理**：通过枚举 $a_i$ 和 $a_j$ 的值，利用乘法原理计算对 $k$ 的贡献。

### 可拓展之处
- **类似问题**：可以应用于其他需要统计区间贡献的问题，如统计满足某种条件的区间对的数量。
- **优化技巧**：在数据范围较小的情况下，桶计数和差分数组是常用的优化手段。

### 推荐题目
1. [P3372 【模板】线段树 1](https://www.luogu.com.cn/problem/P3372)
2. [P3368 【模板】树状数组 1](https://www.luogu.com.cn/problem/P3368)
3. [P1908 逆序对](https://www.luogu.com.cn/problem/P1908)

### 个人心得总结
- **数据类型**：在处理大范围数据时，注意使用 `long long` 避免溢出。
- **优化思路**：在数据范围较小的情况下，桶计数和差分数组是常用的优化手段。

---
处理用时：22.73秒
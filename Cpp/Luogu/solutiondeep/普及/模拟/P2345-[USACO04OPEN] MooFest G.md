# 题目信息

# [USACO04OPEN] MooFest G

## 题目背景

[P5094 [USACO04OPEN] MooFest G 加强版](https://www.luogu.com.cn/problem/P5094)


## 题目描述

约翰的 $n$ 头奶牛每年都会参加“哞哞大会”。

哞哞大会是奶牛界的盛事。集会上的活动很多，比如堆干草，跨栅栏，摸牛仔的屁股等等。

它们参加活动时会聚在一起，第 $i$ 头奶牛的坐标为 $x_i$，没有两头奶牛的坐标是相同的。

奶牛们的叫声很大，第 $i$ 头和第 $j$ 头奶牛交流，会发出
$\max\{v_i,v_j\}\times |x_i − x_j |$ 
的音量，其中 $v_i$ 和 $v_j$ 分别是第 $i$ 头和第 $j$ 头奶牛的听力。

假设每对奶牛之间同时都在说话，请计算所有奶牛产生的音量之和是多少。

## 样例 #1

### 输入

```
4
3 1
2 5
2 6
4 3```

### 输出

```
57```

# AI分析结果

### 综合分析与结论
该题要求计算每对奶牛交流产生音量之和，公式为\(\max\{v_i,v_j\}\times |x_i − x_j |\)。众多题解主要围绕对该公式优化展开，以降低时间复杂度。
1. **暴力枚举**：直接\(n^2\)枚举奶牛对计算音量和，时间复杂度\(O(n^2)\)。虽然部分题解指出数据弱可通过，但正常情况此方法效率低。
2. **排序优化max**：多数题解先按\(v_i\)升序排序，使\(\max\{v_i,v_j\}\)可直接取右侧\(v_j\)（\(i<j\)），简化公式。
3. **处理绝对值**：
    - **树状数组**：用两个树状数组，一个维护奶牛数量，一个维护奶牛坐标和。通过统计当前奶牛前后奶牛数量与坐标和，计算与其他奶牛音量和。时间复杂度\(O(nlogn)\)。
    - **分治（CDQ分治/归并排序）**：先按\(v\)排序，再利用分治思想。如CDQ分治通过前半数据计算对后半数据贡献，归并排序在合并时处理\(x\)的影响，同时保证\(v\)的有序性。时间复杂度\(O(nlogn)\)。
    - **线段树**：以\(x\)值建立线段树，维护区间内奶牛到\(0\)点距离和与奶牛个数，计算当前奶牛与之前奶牛距离差和。时间复杂度\(O(nlogn)\)。
    - **分块**：对奶牛按坐标升序排序，通过分块维护前缀和等信息，平衡时间复杂度。时间复杂度\(O(n\sqrt{n})\)。

### 所选4星及以上题解
- **作者：龙·海流 (赞：78)  5星**
    - **关键亮点**：思路清晰，结合图文详细解释过程，从样例出发推出树状数组维护思路，代码注释详细。
    - **个人心得**：作者提到即将退役，优化之前写得不太好的题解外观。
    - **核心代码**：
```cpp
// 树状数组维护坐标和
void cryy(int x,int v) { for(;x<=mn;x+=lobit(x)) yy[x]+=v;}
int y(int x)
{
    int sum=0;
    for(;x>=1;x-=lobit(x)) sum+=yy[x];
    return sum;
}
// 树状数组维护奶牛数量
void crwz(int x) { for(;x<=mn;x+=lobit(x)) wz[x]++;}
int z(int x)
{
    int sum=0;
    for(;x>=1;x-=lobit(x)) sum+=wz[x];
    return sum;
}
int main()
{
    n=read();
    for(int i=1;i<=n;++i) a[i].vi=read(),a[i].xi=read();
    sort(a+1,a+1+n,cmp);
    for(int i=1;i<=n;++i)
    {
        int j=a[i].xi;
        // 计算音量和
        ans+=a[i].vi*(z(j-1)*j-y(j-1)+y(mn)-y(j)-(z(mn)-z(j))*j);
        crwz(a[i].xi);
        cryy(j,a[i].xi);
    }
    printf("%lld",ans);
    return 0;
}
```
核心思想：先按\(v\)排序，每加入一头奶牛，通过树状数组计算其与已加入奶牛的音量和，累加得到总音量。
 - **作者：双管荧光灯 (赞：55)  4星**
    - **关键亮点**：采用分治算法，结合归并排序，思路独特，代码简洁明了。
    - **核心代码**：
```cpp
void cdqdfs(int l,int r)
{
    if(l>=r)
        return;
    int mid=(l+r)/2,ll=l,i;
    long long s1=0,s2=0;
    cdqdfs(l,mid);
    cdqdfs(mid+1,r);
    for(i=l;i<=mid;i++)
        s1+=a[i].x;
    for(i=mid+1;i<=r;i++)
    {
        while(ll<=mid&&a[ll].x<a[i].x)
        {
            s2+=a[ll].x;
            s1-=a[ll].x;
            ll++;
        }
        ans+=(1ll*a[i].x*(ll-l)-s2-1ll*a[i].x*(mid-ll+1)+s1)*a[i].v;
    }
    int l1=l,l2=mid+1,k=l-1;
    while(l1<=mid||l2<=r)
    {
        if((a[l1].x>a[l2].x||l1>mid)&&l2<=r)
        {
            tmp[++k]=a[l2];
            l2++;
        }
        else
        {
            tmp[++k]=a[l1];
            l1++;
        }
    }
    for(i=l;i<=r;i++)
        a[i]=tmp[i];
}
```
核心思想：先按\(v\)排序，分治过程中，递归处理左右区间，在合并时通过移动指针计算左右区间奶牛\(x\)值差异产生的音量贡献。
 - **作者：UltiMadow (赞：18)  4星**
    - **关键亮点**：详细阐述cdq分治思路，对公式推导和代码解释清晰，对比不同写法。
    - **核心代码**：
```cpp
void cdq(int l,int r)
{
    if(l==r)return;
    int mid=l+r>>1;
    cdq(l,mid);cdq(mid+1,r);
    sort(cow+l,cow+mid+1,cmp2);sort(cow+mid+1,cow+r+1,cmp2);
    int sum1=0,sum2=0;
    for(int i=l;i<=mid;i++)
        sum1+=cow[i].x;
    for(int i=mid+1,j=l;i<=r;i++)
    {
        while(j<=mid&&cow[j].x<cow[i].x)
            sum1-=cow[j].x,sum2+=cow[j].x,j++;
        int cnt1=j-l,cnt2=mid-j+1;
        ans+=cow[i].v*(cnt1*cow[i].x-sum2+sum1-cnt2*cow[i].x);
    }
}
```
核心思想：先按\(v\)排序，cdq分治中，对左右区间按\(x\)排序，枚举右区间点，通过移动指针统计左区间点与当前点距离和，计算音量贡献。

### 最优关键思路或技巧
1. **排序简化max运算**：按\(v\)升序排序，使\(\max\{v_i,v_j\}\)在\(i<j\)时直接取\(v_j\)，简化计算。
2. **利用数据结构处理绝对值**：树状数组、线段树可高效维护区间信息，分治算法结合排序处理数据，降低时间复杂度。

### 可拓展思路
此类题目通常涉及对复杂公式优化，可拓展到其他需要处理区间信息、优化运算的场景。如处理二维平面点对距离、权重计算等问题，同样可尝试排序、数据结构优化、分治等方法。

### 相似知识点洛谷题目
1. **P3368 【模板】树状数组 2**：基础树状数组应用，维护区间和并支持单点修改。
2. **P1908 逆序对**：利用归并排序或树状数组求逆序对，与本题分治和树状数组思路相关。
3. **P2163 [SHOI2007]园丁的烦恼**：二维平面点查询问题，可类比本题用数据结构优化区间查询。 

---
处理用时：72.36秒
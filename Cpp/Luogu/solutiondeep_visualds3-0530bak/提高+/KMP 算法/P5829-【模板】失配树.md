# 题目信息

# 【模板】失配树

## 题目描述

给定一个字符串 $s$，定义它的 **$k$ 前缀** $\mathit{pre}_k$ 为字符串 $s_{1\dots k}$，**$k$ 后缀** $\mathit{suf}_k$ 为字符串 $s_{|s|-k+1\dots |s|}$，其中 $1 \le k \le |s|$。

定义 $\bold{Border}(s)$ 为**对于 $i \in [1, |s|)$，满足 $\mathit{pre}_i = \mathit{suf}_i$** 的字符串 $\mathit{pre}_i$ 的集合。$\bold{Border}(s)$ 中的每个元素都称之为字符串 $s$ 的 $\operatorname{border}$。

有 $m$ 组询问，每组询问给定 $p,q$，求 $s$ 的 **$\boldsymbol{p}$ 前缀** 和 **$\boldsymbol{q}$ 前缀** 的 **最长公共 $\operatorname{border}$**  的长度。

## 说明/提示

样例 $2$ 说明：

对于第一个询问，$2$ 前缀和 $18$ 前缀分别是 ``zz`` 和 ``zzaaccaazzccaacczz``，由于 ``zz`` 只有一个 $\operatorname{border}$，即 ``z``，故最长公共 $\operatorname{border}$ 长度为 $1$。

---

对于 $16\%$ 的数据，$s$ 中的字符全部相等。

对于 $100\%$ 的数据，$1\leq p,q \le |s|\leq 10^6$，$1 \leq m \leq 10^5$，$s_i \in [\texttt{a}, \texttt{z}]$。

## 样例 #1

### 输入

```
aaaabbabbaa
5
2 4
7 10
3 4
1 2
4 11
```

### 输出

```
1
1
2
0
2
```

## 样例 #2

### 输入

```
zzaaccaazzccaacczz
3
2 18
10 18
3 5
```

### 输出

```
1
2
0
```

# AI分析结果



**算法分类**：字符串处理与图论（LCA）

---

### **题解思路与核心要点**
1. **KMP构建next数组**：利用KMP算法求出每个前缀的最长border（即next数组）。
2. **构建Fail树**：将next[i]视为节点i的父节点，形成树结构，每个节点的所有祖先即为该前缀的border集合。
3. **LCA求解**：两个前缀的最长公共border即为其在Fail树中的LCA，若LCA是其中一个节点，则取其父节点（因border不能是自身）。

**解决难点**：
- **快速查询LCA**：通过倍增法、树链剖分等高效算法处理多组查询。
- **边界处理**：当LCA为其中一个节点时需返回父节点。

---

### **题解评分（≥4星）**
1. **WYXkk（5星）**  
   - 思路清晰，完整实现KMP+倍增LCA，代码简洁高效。
2. **Tweetuzki（5星）**  
   - 代码精简，直接使用倍增法，处理边界条件明确。
3. **木木！（4星）**  
   - 引入树链剖分优化LCA查询，适合大数据量场景。

---

### **最优思路提炼**
```cpp
// KMP构建next数组
int j = 0;
for (int i = 2; i <= n; ++i) {
    while (j && s[j+1] != s[i]) j = next[j];
    if (s[j+1] == s[i]) ++j;
    next[i] = j;
}

// 倍增LCA预处理
for (int k = 1; k <= 20; ++k)
    for (int i = 1; i <= n; ++i)
        fa[i][k] = fa[fa[i][k-1]][k-1];

// LCA查询
int lca(int x, int y) {
    if (dep[x] < dep[y]) swap(x, y);
    for (int i = 20; i >= 0; --i)
        if (dep[fa[x][i]] >= dep[y]) x = fa[x][i];
    if (x == y) return fa[x][0];
    for (int i = 20; i >= 0; --i)
        if (fa[x][i] != fa[y][i]) x = fa[x][i], y = fa[y][i];
    return fa[x][0];
}
```

---

### **相似题目推荐**
1. [P3379 - 最近公共祖先（LCA模板）](https://www.luogu.com.cn/problem/P3379)
2. [P6146 - 字符串匹配与Border应用](https://www.luogu.com.cn/problem/P6146)
3. [P3435 - 循环节与Border分析](https://www.luogu.com.cn/problem/P3435)

---

### **可视化与算法演示**
**动画设计**：  
1. **KMP步骤**：高亮当前匹配字符，动态显示next数组计算过程。  
2. **Fail树构建**：以树状图展示节点父子关系，点击节点显示其所有border。  
3. **LCA查询**：用不同颜色标记查询路径，逐步跳转父节点直至找到LCA。  

**复古像素风格**：  
- **颜色方案**：8位色调色板，绿色表示匹配成功，红色表示失败。  
- **音效**：跳转父节点时播放“滴”声，找到LCA时播放“胜利”音效。  
- **Canvas交互**：允许拖拽节点观察树结构，按空格键单步执行算法。  

**AI自动模式**：  
- 自动逐步执行KMP和LCA步骤，展示算法核心流程。  

---

**总结**：通过KMP和LCA的高效结合，将字符串问题转化为树论问题，是典型的多算法融合应用。

---
处理用时：59.80秒
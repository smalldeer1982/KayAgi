# 题目信息

# [国家集训队] 稳定婚姻

## 题目描述

我们已知 $n$ 对夫妻的婚姻状况，称第 $i$ 对夫妻的男方为 $B_i$，女方为 $G_i$。若某男 $B_i$ 与某女 $G_j$ 曾经交往过（无论是大学，高中，亦或是幼儿园阶段，$i \le j$），则当某方与其配偶（即 $B_i$ 与 $G_i$ 或 $B_j$ 与 $G_j$）感情出现问题时，他们有私奔的可能性。不妨设 $B_i$ 和其配偶 $G_i$ 感情不和，于是 $B_i$ 和 $G_j$ 旧情复燃，进而 $B_j$ 因被戴绿帽而感到不爽，联系上了他的初恋情人 $G_k$ ……一串串的离婚事件像多米诺骨牌一般接踵而至。若在 $B_i$ 和 $G_i$ 离婚的前提下，这 $2n$ 个人最终依然能够结合成 $n$ 对情侣，那么我们称婚姻 $i$ 为不安全的，否则婚姻 $i$ 就是安全的。

给定所需信息，你的任务是判断每对婚姻是否安全。

## 说明/提示

对于 $20\%$ 的数据，$n \le 20$；

对于 $40\%$ 的数据，$n \le 100$，$m \le 400$；

对于 $100\%$ 的数据，所有姓名字符串中只包含英文大小写字母，大小写敏感，长度不大于 $8$，保证每对关系只在输入文件中出现一次，输入文件的最后 $m$ 行不会出现未在之前出现过的姓名，这 $2n$ 个人的姓名各不相同，$1 \le n \le 4000$，$0 \le m \le 20000$。

## 样例 #1

### 输入

```
2
Melanie Ashley
Scarlett Charles
1
Scarlett Ashley```

### 输出

```
Safe
Safe```

## 样例 #2

### 输入

```
2
Melanie Ashley
Scarlett Charles
2
Scarlett Ashley
Melanie Charles```

### 输出

```
Unsafe
Unsafe```

# AI分析结果



### 算法分类
**无算法分类**

---

### 综合分析与结论
**核心思路**：  
题目要求判断每对婚姻是否处于「环路」中。若夫妻双方在同一个强连通分量（SCC）中，则存在重组可能，婚姻不安全。主流解法采用 **Tarjan 算法求强连通分量**，通过交替建图（夫妻：女→男，情人：男→女）将问题转化为 SCC 判定。

**难点与解决方案**：  
- **建图逻辑**：交替方向确保环结构能被 Tarjan 正确识别。若仅用无向边则无法应用 SCC。  
- **高效性**：Tarjan 时间复杂度为 O(N+M)，完美匹配题目数据规模（N=8e3, M=2e4）。  
- **字符串映射**：使用 `map<string, int>` 或哈希表将字符串转换为节点编号。

**可视化设计要点**：  
1. **动画展示**：  
   - 初始图：用不同颜色区分夫妻（蓝色♀→♂）和情人（红色♂→♀）的边。  
   - Tarjan 过程：DFS 遍历时动态高亮当前访问节点，栈内节点标记为灰色。  
   - SCC 合并：当回溯到根节点时，用相同颜色填充整个 SCC。  
2. **交互功能**：  
   - 步进控制：手动触发 DFS 步骤，观察 `dfn` 和 `low` 值变化。  
   - 高亮环：点击任意夫妻节点，自动闪烁其所属 SCC 的所有节点和边。  

---

### 题解评分（≥4星）
1. **雨季（⭐⭐⭐⭐⭐）**  
   - **亮点**：  
     - 明确建图规则（夫妻女→男，情人男→女）与 SCC 的关系。  
     - 代码简洁，使用 `map` 处理字符串映射，直接输出结果。  
   - **代码片段**：  
     ```cpp
     add(i, i+n); // 夫妻：女→男
     add(cou[boy], cou[gir]); // 情人：男→女
     ```

2. **ahawzlc（⭐⭐⭐⭐）**  
   - **亮点**：  
     - 详细图解说明环的形成与 SCC 的对应关系。  
     - 代码注释清晰，强调男女交替建图的必要性。  

3. **喻文州（⭐⭐⭐⭐）**  
   - **亮点**：  
     - 用「叛变关系」比喻环的传播逻辑，形象解释 SCC 的意义。  
     - 提供反向建图仍 AC 的实例，验证方向选择的灵活性。  

---

### 最优思路提炼
**关键步骤**：  
1. **建图规则**：  
   - 夫妻边：女性节点指向男性节点（♀→♂）。  
   - 情人边：男性节点指向女性节点（♂→♀）。  
2. **强连通分量判定**：  
   - 若夫妻双方属于同一 SCC，则存在重组链，婚姻不安全。  

**思维技巧**：  
- **环路等价性**：将「婚姻不安全」抽象为图中环路存在性，避免暴力枚举重组可能。  
- **交替定向**：通过有向边的交替方向，确保合法环结构能被 Tarjan 捕获。  

---

### 同类型题推荐
1. **P2341 [USACO03FALL] 受欢迎的牛**（强连通分量缩点）  
2. **P3387 【模板】缩点**（SCC 应用与 DAG 最长路）  
3. **P1262 间谍网络**（SCC 与最小覆盖）  

---

### 可视化与算法演示
**复古像素风格设计**：  
1. **Canvas 绘制**：  
   - 节点为 16x16 像素方块，夫妻用粉色/蓝色，情人用红色。  
   - 边动态显示为箭头，SCC 合并时播放 8-bit 音效（如《超级玛丽》金币声）。  
2. **自动演示模式**：  
   - 按空格键逐步执行 Tarjan 的 DFS 过程，当前搜索路径高亮黄色。  
   - 发现 SCC 时，节点闪烁并标记为绿色，播放胜利音效。  

**交互示例**：  
```javascript
// 伪代码：Tarjan 单步执行演示
function tarjanStep(u) {
  highlightNode(u); // 当前节点高亮
  for (const v of graph[u]) {
    if (!visited[v]) {
      stackPush(v);
      updateDFNLow(u, v); // 显示 dfn/low 数值变化
    }
  }
  if (isSCCRoot(u)) {
    playSound('scc_merged'); // 8-bit 音效
    colorSCC(u); // 统一颜色
  }
}
```

---

### 代码实现（雨季题解核心）
```cpp
#include<iostream>
#include<map>
#include<string>
using namespace std;
const int N = 10005, M = 300005;
map<string, int> cou; // 映射夫妻名到节点
struct node { int v, nex; } e[M];
int h[N], tot, dfn[N], low[N], idx, cnt, belong[N];
stack<int> s; bool ins[N];

void add(int u, int v) {
  e[++tot] = {v, h[u]}; h[u] = tot;
}

void Tarjan(int u) {
  dfn[u] = low[u] = ++idx;
  s.push(u); ins[u] = true;
  for (int i = h[u]; i; i = e[i].nex) {
    int v = e[i].v;
    if (!dfn[v]) Tarjan(v), low[u] = min(low[u], low[v]);
    else if (ins[v]) low[u] = min(low[u], dfn[v]);
  }
  if (low[u] == dfn[u]) {
    cnt++;
    while (true) {
      int v = s.top(); s.pop();
      belong[v] = cnt; ins[v] = false;
      if (v == u) break;
    }
  }
}

int main() {
  int n, m; cin >> n;
  for (int i = 1; i <= n; i++) {
    string gir, boy; cin >> gir >> boy;
    cou[gir] = i; cou[boy] = i + n;
    add(i, i + n); // 夫妻：女→男
  }
  cin >> m;
  while (m--) {
    string gir, boy; cin >> gir >> boy;
    add(cou[boy], cou[gir]); // 情人：男→女
  }
  for (int i = 1; i <= 2*n; i++)
    if (!dfn[i]) Tarjan(i);
  for (int i = 1; i <= n; i++)
    cout << (belong[i] == belong[i+n] ? "Unsafe\n" : "Safe\n");
}
```

---
处理用时：101.88秒
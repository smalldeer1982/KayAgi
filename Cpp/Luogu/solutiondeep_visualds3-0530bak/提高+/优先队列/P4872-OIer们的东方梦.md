# 题目信息

# OIer们的东方梦

## 题目背景

**#11,#12 两组 Hack 数据由 uid=20285 提供**

OIer 们做~~魂魄妖~~梦都想去幻想乡玩一下。这一次，他们在睡~~古明地~~觉时在梦中穿越去了幻想乡，幻想乡有很多的少(ju)女(ruo)，但是他们被~~老太婆~~少女的美色~~和蒟蒻的美味~~所吸引，在幻想乡中迷失了方向。

勇敢的~~死肥宅~~少年啊，现在你手里有一份幻想乡人间之里的地图，你知道 OIer 们的位置，你可以远程给OIer们传递信息，请你带领迷路的 OIer 们走进回到现实生活的祭坛吧！

## 题目描述

给你一个 $N\times M$ 的地图，如图所示：              
```
5400000S01     
1111101101     
000003X301      
3111111101     
E000300031      
1111X30001     
```

其中有很多稀奇古怪的东西：  
     
* $S$ 表示出发点，$E$ 表示终点。      
* $0$ 表示空地，你想怎么走就怎么走，走一格需要 $1s$。            
* $1$ 表示墙，你无法通行（~~除非你受到了**风神少女**的庇护~~）。   
* $2$ 表示小妖怪，你需要 $3s$ 的时间去消灭小妖怪，才能经过该位置。（PS: 妖怪被消灭后只要离开当前格子立刻复活）  
* $3$ 表示大妖怪，你需要 $8s$ 的时间去消灭大妖怪，才能经过该位置。   
* $4$ 表示太阳花田，到达该位置可以获得太阳花，获得太阳花后遇到妖怪时可**直接**通过该妖怪的位置。  
* $5$ 表示楼观剑（科普君：楼观剑，英文名 $Louguan\ is\ very\ jian$，是妖怪做的剑，楼观剑斩不断的东西几乎没有)，到达该位置可以花费 $5s$ 获得它，获得它后可以砍墙砍妖怪将其变成空地（当然也可以不砍，砍墙砍妖怪不需要时间，楼观剑可以一直使用**不会损坏**，有了楼观剑依然可以使用隙间，但是楼观剑不能砍隙间~~和一点用都没有的麻薯，麻薯妖梦UUZ是一家嘛~~）       
* $M$ 表示麻薯（是 $mashu$ 不是 $mafu$~~不知道麻薯是什么的一把楼观剑给你砍过来~~)，碰到麻薯后你可以把它吃了(路人甲：那你为什么还要加这个东西? 出题人：有 $S$ 肯定要有 $M$ 啊。路人乙：我就是死外边，从隙间中跳下去，也不会吃麻薯！嗯~真香！）            
* $X$ 表示紫妈的隙间，碰到隙间后会传送至其他的任意一个隙间(数据**不**保证只有 0 或 2 个隙间，**就是说可以有很多隙间乱传**)，每次传送耗时 $1s$。(经过当前格子时可以不经过隙间)       
      
答案输出 OIer 们到达终点所需最短时间。如果无法到达，输出 "We want to live in the TouHou World forever"。     
翻译：此生无悔入东方，来世~~睡遍~~愿生幻想乡。   
    
**温馨提示：不排除存在可以往回走等稀奇古怪的最优走法**

## 说明/提示

对于 $30\%$ 的数据，$1\leq N,M\leq 50$。       
对于 $50\%$ 的数据，$1\leq N,M\leq 100$。       
对于 $100\%$ 的数据，$1\leq N,M\leq 1000$。

保证有一组数据答案为 "We want to live in the TouHou World forever"，数据有梯度。

### 样例解释

**样例 1**：在 $7s$ 时到达楼观剑，在 $12s$ 时获得楼观剑，一路向下砍到达终点。                   
**样例 2**：在 $10s$ 时到达 $(3,3)$，在 $32s$ 时到达$(3,10)$，向上进入隙间后到达终点。          
**样例 3**：这个就不用解释了吧(出题人放飞自我)。

## 样例 #1

### 输入

```
6 10
5400000S01
1111101101
000003X301
3111111101
E000300031
1111X30001```

### 输出

```
16```

## 样例 #2

### 输入

```
5 10
S23323323X
2032332333
1202202202
1111111111
11111111XE```

### 输出

```
44```

## 样例 #3

### 输入

```
9 10
SX1X0X1X1X
2332332333
5205205200
XXXXXXXXXX
2222222222
3333333333
3333333333
XXXXXXXXXX
XXXXXXXXXE```

### 输出

```
3```

# AI分析结果



### 算法分类
优先队列BFS（堆优化的Dijkstra算法）

---

### 题解核心分析与结论
#### 核心思路
所有题解均采用优先队列实现带状态的最短路径搜索，核心逻辑如下：
1. **状态分层**：使用三维数组 `vis[x][y][state]` 记录不同状态下的最短时间，其中状态分为：
   - 0: 无道具
   - 1: 有太阳花（可无视小/大妖怪）
   - 2: 有楼观剑（可砍墙和妖怪）
2. **优先队列优化**：按时间升序处理路径点，确保最先到达终点的解即为最优解
3. **隙间传送优化**：每个状态下仅需处理一次所有传送门，避免重复计算

#### 解决难点
1. **动态状态切换**：
   - 楼观剑需消耗5秒获取，但可以不拿
   - 太阳花无需时间，强制改变状态
2. **妖怪处理逻辑**：
   ```cpp
   // 小妖怪处理示例（Flandre_495题解）
   case '2':
     if(NB!=0) v.d = u.d + 1;  // 有道具直接过
     else      v.d = u.d + 4;  // 无道具需3秒打怪+1秒移动
     check(v);
   ```
3. **隙间高效处理**：
   - 记录每个状态是否已使用过传送，避免同一状态多次传送
   - 传送后更新所有隙间坐标的时间

#### 可视化设计
1. **Canvas动画**：
   - 绘制网格地图，不同颜色表示地形（墙#333、妖怪#F00、传送门#0FF）
   - 角色移动时显示路径，当前操作格高亮黄色边框
   - 状态变化时，角色图标切换（剑🗡️、花🌼、无道具🟢）
2. **音效触发**：
   ```javascript
   // 伪代码示例
   function playSound(type) {
     if(type === 'move') new Audio('move.wav').play();
     if(type === 'teleport') new Audio('teleport.wav').play();
   }
   ```
3. **自动演示模式**：
   - 按算法步骤自动执行，速度可调
   - 显示优先队列的实时状态（右侧面板）

---

### 高星题解推荐（≥4⭐）
1. **Flandre_495（5⭐）**
   - 亮点：状态分层清晰（NB值系统），隙间处理优化（每个状态仅传一次）
   - 代码可读性强，关键逻辑注释详细
2. **disangan233（4.5⭐）**
   - 亮点：分层图最短路思路，代码高度压缩（适合竞赛）
   - 不足：变量命名较简略
3. **Expert_Dream（4⭐）**
   - 亮点：详细的状态转移注释，包含调试心得
   - 特色：处理麻薯的幽默逻辑（`藏起来别让UUZ看到`）

---

### 最优思路代码片段
```cpp
// 核心状态转移逻辑（Flandre_495题解）
void check(E v) {
    int NB = getNB(v);
    if(v.d >= dis[v.i][v.j][NB]) return;
    dis[v.i][v.j][NB] = v.d;
    q.push(v);
}

// 隙间处理（仅每个NB状态触发一次）
void jian_xi(E u) {
    int NB = getNB(u);
    if(bayunzi[NB]) return;
    bayunzi[NB] = 1;
    for(所有隙间坐标i,j) {
        E v = {u.d+1, i, j, u.lou, u.hua};
        check(v);
    }
}
```

---

### 同类题目推荐
1. **P1141 01迷宫** - 多状态连通块问题
2. **P1941 飞扬的小鸟** - 分层图动态规划
3. **P3956 棋盘** - 带状态切换的最短路径

---

### 可视化算法演示
**关键步骤动画流程**：
1. **初始化**：
   - 绘制迷宫，起点闪烁绿色，终点红色
   - 显示优先队列为空
2. **扩展节点**：
   - 当前节点高亮黄色，四方向探测相邻格子
   - 遇到墙显示红色阻挡动画，可通行则显示绿色箭头
3. **状态更新**：
   - 获取楼观剑时播放金属音效，格子变为银色
   - 太阳花格子短暂显示🌼图案
4. **隙间传送**：
   - 触发时全屏闪烁，所有传送门同时发光
   - 角色从当前传送门消失，目标传送门出现

**交互控制**：
- 速度滑块：0.5x~5x调节执行速度
- 单步执行按钮：逐步观察队列变化
- 状态面板：实时显示当前时间、道具状态、访问过的格子计数

---

### 总结
本题通过优先队列BFS处理多状态最短路径，核心在于分层状态记录与高效传送处理。可视化设计中，复古像素风格与音效增强理解，适合教学演示与竞赛复习。

---
处理用时：64.63秒
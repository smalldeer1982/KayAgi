# 题目信息

# [CCO 2015] 太阳能飞行

## 题目背景

**警告：滥用本题评测将被封号**

## 题目描述

**本题译自 [CCO 2015](https://cemc.math.uwaterloo.ca/contests/computing/2015/index.html) Day1 T3「[Solar Flight](https://cemc.math.uwaterloo.ca/contests/computing/2015/stage%202/day1.pdf)」**

航空的新纪元正在来临——第一个太阳能驱动的巨型喷气式飞机即将商用！然而，公众对前沿技术有一些在安全方面的焦虑，因为驱动飞机的阳光的光线可能会被其他在空中的物体挡住。因此，必须先进行一些统计和计算来规划第一次航行。

我们考虑一个包含 $N$ 个从一个城市到另外一个城市的航路组成的图。一架飞机可以被考虑成一个点。它穿过的天空可以被模型化为一个笛卡尔坐标系，其中 $X$ 轴表示从任意一个点向东出发的距离，$Y$ 轴表示高度。我们只考虑 $x$ 值的范围在 $[0,X]$，所有航路均为直线的部分。第 $i$ 架飞机从 $(0,A_i)$ 飞到 $(X,B_i)$。所有$A$值互不相同，对于$B$也如此。飞机以未知的，可能是非恒定的速度沿着航路行驶，所以任意时间点，飞机可能在航路的任意位置上。然而，已知的是飞机从不与其他飞机相撞，所以如果两个航道交错，两个飞机不会同时到达交点。

每个飞机 $i$ 同时也有一个干扰因素值 $C_i$，表示一个飞机影响它下面飞机太阳吸收能力的强弱。

各个飞机上的太阳能板非常奇怪，那些太阳能板只能收集飞机正上方的能量。这就意味着一个飞机能吸收的阳光可能会被其他与其的 $x$ 值相同，但是 $y$ 值比他大的飞机挡住。具体来说，太阳能板吸收的太阳光减少的值为挡住它的飞机的干扰因素值之和。

根据这些信息，以及一个距离常数 $K$，你要回答 $Q$ 个关于可能对太阳能板影响的询问。第 $i$ 个询问询问你在一个时刻飞机 $P_i$ 的太阳能板吸收的太阳光减少的值。在任意时刻飞机的 $x$ 值均在 $[S_i,S_i+K]$之间。

## 说明/提示

飞机的航路示意图如下图所示。

![CCO2015D1T3Pic1](http://miao.su/images/2018/08/15/aaa7e400.png)

询问 $1$ 是对于 $2$ 号飞机在 $[1,5]$ 范围内所提出的询问，当飞机在 $x\le 4$ 时可能会被飞机 $3$ 挡住，但是绝不是飞机 $1$。然而，但是当它的 $x>4$ 时可能会被其他所有飞机挡住，因此，该询问的答案即其他所有飞机的影响因素值之和，为 $5+6=11$。

对于询问 $2$，当 $x<10$ 时飞机 $1$ 可能会被飞机 $3$ 挡住，并且当 $x\geq10$ 时不会被任何飞机盖住，因此只可能被飞机 $3$ 影响，即结果等于飞机 $3$ 的影响因素值 $6$。

对于询问 $3$，飞机 $1,2$ 都不能在飞机 $3$ 的正上方除非 $x$ 达到 $10$。所以该询问的答案为0。

对于 $40\%$ 的数据，$Q\le 1000$。  

对于 $100\%$ 的数据，$1\le N\le 2000,$ $1\le K\le X,$ $1\le X,A_i,B_i,C_i\le 10^9,$ $0\le S_i\le X-K,$ $1\le Q \le 800000$。

## 样例 #1

### 输入

```
12 4 3 3
1 4 5
2 2 3
6 3 6
2 1
1 8
3 0```

### 输出

```
11
6
0```

# AI分析结果



---

**唯一算法分类**：扫描线 + 滑动窗口优化

---

### **题解思路、算法要点与解决难点**

#### **核心思路**
- **事件点预处理**：计算所有飞机对的交点，生成每个飞机干扰值变化的临界点（事件点）。
- **干扰值区间管理**：每个事件点对应干扰值的增减，通过排序和前缀和快速计算任意区间的干扰总和。
- **滑动窗口优化**：利用单调队列维护固定长度区间内的最大值，将查询时间复杂度从 O(n) 优化至 O(log n)。

#### **解决难点**
1. **事件点生成**：两架飞机可能相交或不相交，需分类处理：
   - **相交**：记录交点 x 坐标，干扰值在此处发生 ±C_i 的变化。
   - **不相交**：直接累加全程干扰值。
2. **精度处理**：使用 `long double` 存储坐标，避免浮点误差；查询区间端点需微调以避免包含交点。
3. **高效查询**：对每个飞机的所有事件点排序后，通过二分快速定位查询区间起点，结合单调队列求滑动窗口最大值。

---

### **题解评分 (≥4星)**

1. **Crossing 的题解（4星）**
   - **亮点**：思路清晰，前缀和与二分查找的结合易于理解，代码注释详细。
   - **不足**：查询部分未优化，时间复杂度较高（O(Q*n)）。
   - **代码片段**：
     ```cpp
     sort(a[i]+1,a[i]+l[i]+1,cmp); // 排序事件点
     for(;st<=l[x]&&f[x][st].x<rr;st++) ans = max(ans, f[x][st].val + sum[x]); // 遍历求最大值
     ```

2. **a326820068122c 的题解（5星）**
   - **亮点**：引入单调队列优化滑动窗口，时间复杂度降至 O(n² + Q log n)，处理大规模查询更高效。
   - **代码片段**：
     ```cpp
     while(lq <= rq && dp[j] >= dp[q[rq]]) rq--; // 维护单调队列
     q[++rq] = j; // 插入新位置
     ```

---

### **最优思路或技巧提炼**

1. **事件驱动模型**：将飞机间的上下关系变化转化为事件点，简化动态干扰值计算。
2. **滑动窗口与单调队列**：将固定区间最大值查询转化为单调队列维护，避免重复遍历。
3. **浮点精度微调**：查询区间端点减去微小量（如 5e-11），避免包含交点导致错误。

---

### **同类型题或类似算法套路**

- **区间覆盖问题**：如统计多个区间叠加后的最大覆盖次数。
- **扫描线算法**：处理二维平面上的事件点，如矩形面积并。
- **滑动窗口极值**：利用单调队列/栈优化固定窗口的最值查询。

---

### **推荐相似题目**

1. **P1886 滑动窗口**：单调队列求滑动窗口最值。
2. **P1904 天际线**：扫描线处理建筑轮廓。
3. **P5490 扫描线**：矩形面积并的模板题。

---

### **个人心得摘录**

- **Crossing**：“八WA之后终见AC，看题需逐字理解。” —— 强调仔细审题的重要性。
- **a326820068122c**：“略微减少查询两端距离以排除交点。” —— 精度处理的实战技巧。

---

### **可视化与算法演示**

#### **动画方案**
1. **坐标系绘制**：在 Canvas 上绘制飞机路径，标出交点（红色高亮）。
2. **事件点标记**：用垂直虚线标记事件点，颜色区分干扰值增减（绿色+，红色-）。
3. **滑动窗口交互**：
   - **高亮当前窗口**：蓝色半透明矩形覆盖 [S_i, S_i+K]。
   - **单调队列动态**：右侧面板显示队列元素，颜色渐变表示递减顺序。
4. **复古像素风格**：
   - **8位音效**：窗口滑动时播放“滴”声，最大值更新时播放“叮”声。
   - **像素飞机**：用 8x8 像素块表示飞机，路径用点阵连线。

#### **控制面板**
- **速度调节**：拖动条控制动画速度（0.5x~5x）。
- **单步执行**：按空格键逐事件点前进。
- **自动演示**：点击“AI 运行”自动处理所有查询，类似贪吃蛇 AI 路径展示。

---

### **代码片段（核心逻辑）**

```cpp
// 单调队列优化查询（a326820068122c 的代码）
for(int j=1; j<=cs+1; j++) {
    // 处理当前区间的查询
    for(int y : u[j-1]) {
        while(l[y] - t[q[lq]+1] > d - eps) lq++;
        ans[y] = dp[q[lq]];
    }
    if(j > cs) break;
    // 维护单调队列
    dp[j] = dp[j-1] + s[j].f;
    while(lq <= rq && dp[j] >= dp[q[rq]]) rq--;
    q[++rq] = j;
}
```

---

**总结**：本题通过事件点模型化干扰变化，结合滑动窗口与单调队列优化，实现了高效的大规模查询处理。可视化设计可增强对事件驱动和滑动窗口极值求解的理解。

---
处理用时：89.54秒
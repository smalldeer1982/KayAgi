# 题目信息

# [CCO 2014] 狼人游戏

## 题目描述

**本题译自 [CCO 2014](https://cemc.math.uwaterloo.ca/contests/computing/2014/index.html) Day1 T3「[Werewolf](https://cemc.math.uwaterloo.ca/contests/computing/2014/Stage%202/day1.pdf)」**

和往常一样，$N$ 个机器人在玩狼人游戏，机器人从 $1$ 到 $N$ 编号。$W$ 个机器人扮演狼人，剩下的扮演市民。虽然狼人游戏包括不同的角度，但我们将只着眼于其中一个角度。

机器人指控其他人是狼人并且防止其他机器人无辜地指控它。

狼人知道其他人的角色以及：

- 一个狼人从不指控其他狼人；

- 任何狼人机器人保护的都是其他狼人机器人。

市民可能会指控或保护任何类型的机器人。

其他的一些限制使得题目更简单：

- 没有机器人又被指控又被保护；

- 没有机器人被指控或保护一次以上；

- 如果有一个编号为 $A$ 机器人指控或保护编号为 $B$ 的机器人，那么我们保证$A<B$。

你将知道 $N$ 个机器人间的所有指控和保护关系，并且知道狼人数为 $W$。每个机器人所扮演的角色要么是狼人要么是市民。你的目标是计算出符合上述限制的角色安排方案数。

## 说明/提示

#### 样例解释 1
如果机器人 $1$ 是狼人，机器人 $2$ 也必须是，那么狼人就太多了！唯一的可能是机器人 $2$ 是唯一的狼人。

#### 样例输出 2
没有额外的保护或指控信息的话，机器人 $1$ 和机器人 $2$ 都可能是狼人。

#### 样例解释 3
如果机器人 $1$ 是狼人，机器人 $2$ 将是市民，机器人 $3$ 也是狼人；或者机器人 $1$ 是市民，那么机器人 $2$ 和 $3$ 将是狼人。

对于 $20\%$ 的数据，$1\le N\le 20$；

对于 $100\%$ 的数据，$1\le N\le 200,$ $0\le W\le N,$ $0\le M<N$。

## 样例 #1

### 输入

```
2 1 1
D 1 2```

### 输出

```
1```

## 样例 #2

### 输入

```
2 1 0```

### 输出

```
2```

## 样例 #3

### 输入

```
3 2 2
A 1 2
D 1 3```

### 输出

```
2```

# AI分析结果



0. **题目翻译**

# [CCO 2014] 狼人游戏

## 题目描述

**本题译自 [CCO 2014](https://cemc.math.uwaterloo.ca/contests/computing/2014/index.html) Day1 T3「Werewolf」**

$N$ 个编号为 1 到 N 的机器人参与狼人游戏，其中有 $W$ 个狼人，其余为市民。规则如下：

狼人行为：
1. 从不指控其他狼人
2. 保护的对象必定是其他狼人

市民行为：
- 可以指控或保护任意角色

特殊限制：
1. 没有机器人同时被指控和保护
2. 每个机器人最多被指控/保护一次
3. 所有指控/保护关系满足 $A<B$（A 是发起者，B 是对象）

给定 $N$ 个机器人间的所有指控/保护关系（共 $M$ 条），求符合规则的狼人安排方案数（模 $10^9+7$）。

## 输入格式
第一行三个整数 $N, W, M$  
后续 $M$ 行每行格式："[A/D] u v" 表示指控/保护关系

## 样例输入输出
（样例内容与原文一致，此处略）

---

1. **唯一算法分类**  
树形DP（无算法分类选项中的精确匹配）

---

2. **综合分析与结论**  
**核心难点**：将指控/保护关系建模为森林结构，设计符合狼人行为约束的树形DP状态转移。

**算法框架**：
1. **森林建模**：利用题目约束（A<B 且单入度），将关系建模为多棵树的集合
2. **状态定义**：`dp[u][k][0/1]` 表示以 u 为根的子树，包含 k 个狼人，u 是市民/狼人的方案数
3. **关键转移**：
   - **指控边**：狼人父节点必须指控市民子节点
   - **保护边**：狼人父节点必须保护狼人子节点
4. **森林合并**：通过虚拟根节点连接多棵树，最后背包合并各树结果

**可视化设计**：
- **树形结构展示**：用Canvas绘制森林，狼人节点显示红色，市民显示蓝色
- **DP矩阵动画**：每个节点展开时高亮当前处理的子树，显示转移方程数值变化
- **音效系统**：转移成功时播放"滴"声，非法转移时播放"嘟"声

---

3. **题解清单 (≥4星)**  
1. GZY007（★★★★☆）
   - 引入超级源点简化森林处理
   - 清晰定义`dp[u][j][k]`状态
   - 代码结构简洁，转移方程直观

2. glorious_dream（★★★★☆）
   - 完整列出6种父子关系类型
   - 使用滚动数组优化空间
   - 注释详细，便于理解转移逻辑

3. 船酱魔王（★★★★☆）
   - 状态定义`fg`位表示滚动维度
   - 预处理子树大小优化循环边界
   - 独立处理各树根的背包合并

---

4. **核心代码实现**  
```cpp
// GZY007 题解核心片段
void dfs(int u) {
    dp[u][0][0] = dp[u][1][1] = 1; // 初始化
    for(auto &e : G[u]) {
        int v = e.v, type = e.type;
        dfs(v);
        for(int j = siz[u]; j >= 0; j--) {
            ll tmp0 = 0, tmp1 = 0;
            for(int k = 0; k <= min(j, siz[v]); k++) {
                // 市民节点转移
                tmp0 = (tmp0 + dp[u][j-k][0] * (dp[v][k][0]+dp[v][k][1])) % MOD;
                // 狼人节点转移
                if(type == 1) // 指控边
                    tmp1 = (tmp1 + dp[u][j-k][1] * dp[v][k][0]) % MOD;
                else // 保护边 
                    tmp1 = (tmp1 + dp[u][j-k][1] * dp[v][k][1]) % MOD;
            }
            dp[u][j][0] = tmp0;
            dp[u][j][1] = tmp1;
        }
        siz[u] += siz[v];
    }
}
```

---

5. **同类型题目推荐**  
1. P1352 没有上司的舞会（树形DP基础）
2. P2014 选课（树形背包问题） 
3. P1273 有线电视网（树形DP+费用计算）

---

6. **可视化伪代码示例**  
```javascript
// Canvas 绘制树形结构
function drawTree(root) {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    // 递归绘制节点和边
    _drawNode(root, startX, startY, level);
}

// DP 动画核心逻辑
function animateDP(u) {
    highlightNode(u); // 高亮当前节点
    for(let v of children[u]) {
        animateDP(v); // 先处理子树
        showTransferEquation(u, v); // 显示转移方程
        updateDPTable(u, v); // 表格数值动态变化
        playSound('blip'); // 播放音效
    }
}
```

---

7. **复古游戏化设计要素**  
- **8-bit 风格**：使用NES调色板（#FF0000红、#0000FF蓝）
- **音效设计**：
  - 正确转移：FC《超级马里奥》金币音效
  - 错误转移：《魂斗罗》中弹音效
  - 完成计算：《塞尔达》宝箱开启音效
- **自动演示模式**：按B键加速，A键单步执行
- **积分系统**：每正确转移一个子树+10分，最优解额外+50分

---

8. **关键思维突破点**  
1. **森林到树的转换**：通过虚拟根节点统一处理多棵树
2. **滚动维度压缩**：利用树遍历顺序优化空间复杂度
3. **行为约束编码**：将"狼人不能指控同类"等规则转化为转移条件

---

9. **调试经验分享**  
- 某题解在测试样例3时发现，当父节点为狼人时未正确处理保护边类型，导致少计算1种合法方案。通过增加`assert`检查转移条件发现逻辑漏洞。
- 初始忘记处理孤立节点（入度为0的非根节点），添加虚拟根后解决问题。

---
处理用时：88.36秒
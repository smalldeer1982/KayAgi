# 题目信息

# 『MdOI R2』Odyssey

## 题目背景

超越音速的极限，不及瑰丽多变的极光；

微弱的脉冲，开拓原本一片混沌的天地；

沉郁的蓝缓缓闪动，史诗的红迎接巅峰；

血色的夕阳尽头，是将夜的星辰；

夜半的满天星空，也会被来自地狱的硝烟掩盖；

炽红炼狱消逝，只金色遗迹永存。

在这里等待着每一位的，都是一段艰苦而璀璨的旅程。

## 题目描述

若正整数 $a$ 与 $b$ 满足：

- $a$ 与 $b$ 的积是一个正整数的 $k$ 次方，即存在正整数 $c$ 使得 $ab=c^k$。

那么我们称 $(a,b)$ 为一组**完美数对**。

---

有一个包含 $n$ 个结点和 $m$ 条边的**有向无环图**，这张图中的每条边都有权值和长度两个属性。

如果一条路径 $P$ 满足**以下条件之一**，则称其为一条**完美路径**：

- $P$ 中仅包含一条边。

- $P$ 从其起点开始依次为 $e_1, e_2, e_3, \ldots e_p$ 这 $p\ (p\ge 2)$ 条边，对于任意的 $1\leq i\leq p-1$，$e_i$ 的权值和 $e_{i+1}$ 的权值组成完美数对。

你需要求出图中最长完美路径的长度，一条路径的长度定义为这条路径上所有边的长度之和。

## 说明/提示

【帮助与提示】  

为方便选手测试代码，本题额外提供两组附加样例供选手使用。  

[样例输入1](https://www.luogu.com.cn/paste/wx1lz6m2) [样例输出1](https://www.luogu.com.cn/paste/28xe7f0x)      

[样例输入2](https://www.luogu.com.cn/paste/efgwngs5) [样例输出2](https://www.luogu.com.cn/paste/5hcpoayt)   

----

【样例解释】

样例中给出的有向无环图如图所示，其中边上的红色数字为边的权值，黑色数字为边的长度：

![](https://cdn.luogu.com.cn/upload/image_hosting/w6x03ksd.png)

最长完美路径为 $2\to 5\to 3$，因为这两条边的权值 $2$ 和 $18$ 满足 $2\times 18=6^2$，是完美数对，此路径长度为 $5+9=14$。

此外，$2\to 1\to 4\to 3,\ \ 2\to 4\to 3,\ \ 1\to 5\to 3$ 等也是完美路径，但不是最长的。

图中，$2\to 1\to 5\to 3$ 长度为 $15$，是一条更长的路径，但它并不是完美路径，因为前两个边权 $24$ 和 $8$ 的乘积为 $192$，不是正整数的平方，即 $(24,8)$ 不是完美数对。

---

【数据范围】

**本题采用捆绑测试。**

对于 $100\%$ 的数据：$1\leq n\leq 10^5,\ \ 1\leq m\leq 2\times 10^5,\ \ 1\leq k\leq 10,\ \ 1\leq u,v\leq n,\ \ 1\leq w\leq 10^5,\ \ 1\leq l\leq 10^4$。

给出的图**不保证弱连通**，图中从一个点到另一个点**可能**存在多条边，但保证给出的图是有向无环图。

| 子任务编号 | $n\leq$ |     $m\leq$      | $w\leq$ | $k\leq$ |  特殊性质  | 分值 |
| :--------: | :-----: | :--------------: | :-----: | :-----: | :--------: | :--: |
| Subtask 1  | $10^5$  |  $2\times 10^5$  | $10^5$  |   $1$   |     无     | $18$ |
| Subtask 2  |  $10$   |       $10$       |  $100$  |  $2$   |     无     | $12$ |
| Subtask 3  |  $600$  | $1.5\times 10^3$ | $10^3$  |   $2$   |     无     | $10$ |
| Subtask 4  | $10^5$  |  $2\times 10^5$  | $10^5$  |   $2$   | $w$ 为素数 | $15$ |
| Subtask 5  | $10^5$  |  $2\times 10^5$  | $10^5$  |   $2$   |     无     | $15$ |
| Subtask 6  |  $600$  | $1.5\times 10^3$ | $10^3$  |  $5$   |     无     | $10$ |
| Subtask 7  | $10^5$  |  $2\times 10^5$  | $10^5$  |  $10$   |     无     | $20$ |



## 样例 #1

### 输入

```
5 7 2
2 5 2 5
5 3 18 9
2 4 6 7
4 3 6 3
2 1 24 2
1 4 6 8
1 5 8 4```

### 输出

```
14```

# AI分析结果



0. **题目翻译**

---

# 『MdOI R2』Odyssey

## 题目背景

超越音速的极限，不及瑰丽多变的极光；
微弱的脉冲，开拓原本一片混沌的天地；
沉郁的蓝缓缓闪动，史诗的红迎接巅峰；
血色的夕阳尽头，是将夜的星辰；
夜半的满天星空，也会被来自地狱的硝烟掩盖；
炽红炼狱消逝，只金色遗迹永存。
在这里等待着每一位的，都是一段艰苦而璀璨的旅程。

## 题目描述

若正整数 $a$ 与 $b$ 满足：
- $ab$ 是某个正整数的 $k$ 次方，即存在正整数 $c$ 使得 $ab = c^k$
则称 $(a,b)$ 为完美数对。

给定包含 $n$ 个结点和 $m$ 条边的有向无环图，每条边有两个属性：
- 权值 $w$ 
- 长度 $l$

定义完美路径满足以下条件之一：
1. 仅含一条边
2. 路径中任意相邻两条边的权值组成完美数对

求图中最长完美路径的长度（路径上所有边长度之和）。

## 输入输出格式

输入格式：
- 第一行三个整数 $n,m,k$
- 接下来 $m$ 行，每行四个整数 $u,v,w,l$ 表示有向边

输出格式：
- 一个整数表示最长完美路径长度

## 样例

输入样例：
```
5 7 2
2 5 2 5
5 3 18 9
2 4 6 7
4 3 6 3
2 1 24 2
1 4 6 8
1 5 8 4
```

输出样例：
```
14
```

---

1. **唯一算法分类**  
**线性DP**

---

2. **综合分析与结论**

### 核心思路
将边权分解质因数后，将指数对 $k$ 取模得到特征值。对于每个特征值 $w$，存在唯一配对数 $f(w)$ 使得 $w \times f(w)$ 是完美数对。通过拓扑排序遍历DAG，在状态转移时维护当前路径最后一个边的特征值。

### 关键算法步骤
1. **质因数分解预处理**  
对每条边的权值 $w$ 进行质因数分解，将每个质因数的指数对 $k$ 取模，得到特征值 $w'$。同时计算该特征值对应的配对数 $f(w')$

2. **分层图建模**  
为每个节点 $u$ 创建两个状态：$u$（正常状态）和 $u+n$（配对状态）。边权特征为 $w$ 的边从正常状态出发，特征为 $f(w)$ 的边从配对状态出发

3. **动态规划转移**  
定义 $dp[v][s]$ 表示到达节点 $v$ 且最后一条边特征值为 $s$ 时的最大路径长度。状态转移方程为：
$$
dp[v][s] = \max(dp[u][f(s)] + l)
$$

### 可视化设计
**动画方案**：
- 使用双色网格表示正常状态（蓝色）和配对状态（橙色）
- 当边权特征值为 $w$ 时，用蓝色箭头从正常状态节点指向相邻节点的正常状态
- 当特征值为 $f(w)$ 时，用橙色箭头从配对状态节点指向相邻节点的正常状态
- 状态更新时高亮变化的网格单元，伴随"滴"声效

**复古元素**：
- 8-bit 风格字体和像素化箭头
- 背景音乐采用 NES 风格的循环旋律
- 成功更新最大长度时播放马里奥金币音效

---

3. **题解清单 (≥4星)**

| 作者       | 评分 | 亮点分析 |
|------------|------|----------|
| BFqwq      | ★★★★☆ | 分层图拓扑排序实现优雅，处理大质数边界条件严谨 |
| 一扶苏一   | ★★★★ | 双哈希防碰撞设计巧妙，map状态管理高效 |
| under_time | ★★★★ | 质因数分解与状态转移分离，代码可读性强 |

---

4. **核心代码实现**

```cpp
// 质因数分解与特征值计算
void process(int w, int &res1, int &res2) {
    res1 = res2 = 1;
    for(int p : primes) {
        if(p*p > w) break;
        int cnt = 0;
        while(w % p == 0) {
            cnt++;
            w /= p;
        }
        cnt %= k;
        if(cnt) {
            res1 *= pow(p, cnt);
            res2 *= pow(p, k - cnt);
        }
    }
    if(w > 1) {
        res1 *= w;
        res2 *= pow(w, k-1);
    }
}

// DP转移核心逻辑
void topo(int w) {
    // 构建分层图
    for(auto e : edges[w]) {
        add(e.u, e.v + n, e.l); // 正常状态转移
    }
    for(auto e : edges[f(w)]) {
        add(e.u + n, e.v, e.l); // 配对状态转移
    }
    
    // 拓扑排序执行DP
    while(!q.empty()) {
        int u = q.front(); q.pop();
        for(int i = h[u]; i; i = e[i].nxt) {
            int v = e[i].to;
            if(dp[v] < dp[u] + e[i].l) {
                dp[v] = dp[u] + e[i].l; // 状态更新
                ans = max(ans, dp[v]);
            }
            if(--in[v] == 0) q.push(v);
        }
    }
}
```

---

5. **相似题目推荐**
1. P4017 最大食物链计数（DAG拓扑排序）
2. P1073 最优贸易（分层图DP）
3. P2421 质因数分解（数论预处理）

---

6. **可视化实现要点**
```javascript
// Canvas初始化
const canvas = document.getElementById('grid');
const ctx = canvas.getContext('2d');
const CELL_SIZE = 40;

// 绘制状态网格
function drawNode(x, y, state) {
    ctx.fillStyle = state === 0 ? '#87CEEB' : '#FFA500'; 
    ctx.fillRect(x*CELL_SIZE, y*CELL_SIZE, CELL_SIZE, CELL_SIZE);
}

// 播放音效
function playSound(freq) {
    const osc = audioCtx.createOscillator();
    osc.frequency.value = freq;
    osc.connect(audioCtx.destination);
    osc.start(); osc.stop(0.1);
}

// 自动演示循环
function autoStep() {
    if(step < topoOrder.length) {
        const u = topoOrder[step++];
        highlightCell(u);
        updateDP(u);
        requestAnimationFrame(autoStep);
    }
}
```

---

7. **个人心得摘录**
> "调试时发现当k=1时需要特殊处理，此时所有边权自动满足条件，直接求DAG最长路即可。这个边界条件让我卡了整整3小时" —— BFqwq

> "将大质数单独处理是关键，当计算配对数超过1e5时直接返回-1，避免无效状态扩散" —— under_time

---

8. **扩展思考**
当k较大时（如k=100），指数取模后仍需处理大数，可采用哈希压缩特征值。此时可引入双哈希（如BASE=1e9+7和BASE=999999937）降低碰撞概率。

---
处理用时：100.01秒
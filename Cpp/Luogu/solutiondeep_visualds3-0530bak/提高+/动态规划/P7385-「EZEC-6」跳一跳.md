# 题目信息

# 「EZEC-6」跳一跳

## 题目背景

![](https://cdn.luogu.com.cn/upload/image_hosting/zq0mhuy7.png)

小 A 最近迷上了 “跳一跳” 这个游戏。

## 题目描述

小 A 玩的 “跳一跳” 规则如下：

1. 设定一个计数器 $\text{cnt}$，将其初始值设置为 $2$。
2. 若跳上下一个格子但没跳到其中心，加 $1$ 分，将 $\text{cnt}$ 重置为 $2$。
3. 若跳上下一个格子且跳到了其中心，加 $\text{cnt}$ 分，将 $\text{cnt}$ 翻倍。
4. 若下一个格子为特殊格 $x_i$ 且跳到了其中心，额外加 $y_i$ 分。
5. 终止条件为没跳上下一个格子或者跳完了所有格子。

已知共有 $n$ 个格子，编号 $1$ 到 $n$（不包含起始格）。

小 A 跳上下一个格子但**没跳到**其中心的概率为 $a\%$，跳上下一个格子且**跳到了**其中心的概率为 $b\%$，剩余 $(100-a-b)\%$ 为没跳上下一个格子的概率。

求他的期望得分，并对 $10^9+7$ 取模。

## 说明/提示

**【样例 1 解释】**

小 A 每次都会跳上下一个格子且跳到其中心，期望得分为 $2+4+8=14$ 分。

**【样例 2 解释】**

小 A 每次都会跳上下一个格子但没跳到其中心，期望得分为 $1+1+1=3$ 分。

**【样例 3 解释】**

小 A 不可能跳上下一个格子，期望得分为 $0$ 分。

**【样例 4 解释】**

小 A 每次都会跳上下一个格子且跳到其中心，期望得分为 $2+10+4+10+8+10=44$ 分。

**【数据规模与约定】**

**本题采用捆绑测试。**

下表中斜杠代表无特殊限制。

| 子任务 | 分值 | $n$ | $a$ | $b$ | $m$ |
| :----------: | :----------: | :----------: | :----------: | :----------: | :----------: |
| $1$ | $1$ | $=1$ | $=50$ | $=50$ | / |
| $2$ | $9$ | $\le 20$ | / | / | $=0$ |
| $3$ | $10$ | $\le 20$ | / | / | / |
| $4$ | $10$ | $\le 10^5$ | / | / | $=0$ |
| $5$ | $20$ | $\le 10^5$ | / | / | / |
| $6$ | $5$ | / | $=0$ | $=100$ | / |
| $7$ | $5$ | / | $=100$ | $=0$ | / |
| $8$ | $15$ | / | / | / | $=0$ |
| $9$ | $25$ | / | / | / | / |

对于 $100\%$ 的数据，$1\le n\le 10^{18}$，$0\le a,b,a+b\le 100$，$0\le m\le \min(n,10^5)$，$1\le x\le n$，$1\le y\le 100$。

## 样例 #1

### 输入

```
3 0 100
0```

### 输出

```
14```

## 样例 #2

### 输入

```
3 100 0
0```

### 输出

```
3```

## 样例 #3

### 输入

```
3 0 0
0```

### 输出

```
0```

## 样例 #4

### 输入

```
3 0 100
3
1 10
2 10
3 10```

### 输出

```
44```

## 样例 #5

### 输入

```
114 5 14
3
14 15
92 65
100 100```

### 输出

```
190259152```

# AI分析结果



# 题目重写

## 题目背景

![](https://cdn.luogu.com.cn/upload/image_hosting/zq0mhuy7.png)

小 A 最近迷上了 "跳一跳" 这个游戏。

## 题目描述

小 A 玩的 "跳一跳" 规则如下：

1. 设定一个计数器 $\text{cnt}$，将其初始值设置为 $2$。
2. 若跳上下一个格子但没跳到其中心，加 $1$ 分，将 $\text{cnt}$ 重置为 $2$。
3. 若跳上下一个格子且跳到了其中心，加 $\text{cnt}$ 分，将 $\text{cnt}$ 翻倍。
4. 若下一个格子为特殊格 $x_i$ 且跳到了其中心，额外加 $y_i$ 分。
5. 终止条件为没跳上下一个格子或者跳完了所有格子。

已知共有 $n$ 个格子，编号 $1$ 到 $n$（不包含起始格）。

小 A 跳上下一个格子但**没跳到**其中心的概率为 $a\%$，跳上下一个格子且**跳到了**其中心的概率为 $b\%$，剩余 $(100-a-b)\%$ 为没跳上下一个格子的概率。

求他的期望得分，并对 $10^9+7$ 取模。

---

# 算法分类
**线性DP + 矩阵快速幂优化**

---

# 综合分析与结论

## 核心思路与难点
1. **期望拆分**：将得分拆分为三部分处理：
   - 常规跳A的1分期望
   - 特殊格的额外得分期望
   - 跳B时cnt累加的期望

2. **状态转移方程**：
   - 定义 $E(i)$ 为第i次跳跃后cnt的期望值，满足递推式：
     $$E(i) = 2b \cdot E(i-1) + 2a \cdot (a+b)^{i-1}$$
   - 定义 $S(n) = \sum_{i=0}^n E(i)$ 为前缀和，用于最终得分计算

3. **矩阵优化**：
   - 构造3x3转移矩阵加速递推：
     $$
     \begin{pmatrix}
     S(n) \\ 
     E(n) \\
     (a+b)^n
     \end{pmatrix} = 
     \begin{pmatrix}
     1 & 1 & 1 \\
     0 & 2b & a \\
     0 & 0 & a+b
     \end{pmatrix}^n
     \begin{pmatrix}
     S(0) \\
     E(0) \\
     (a+b)^0
     \end{pmatrix}
     $$

4. **可视化设计**：
   - **像素动画**：用16色像素风格展示矩阵乘法过程，每个矩阵元素用不同颜色块表示
   - **音效提示**：
     - 矩阵旋转时播放8-bit音效
     - 状态更新时触发"哔"声
     - 错误分支播放FC游戏失败音效
   - **自动演示**：按空格键切换自动/手动模式，FPS可调节（默认60帧）

---

# 题解清单（≥4星）

1. **ZigZagKmp（5星）**
   - 亮点：利用期望线性性拆分问题，矩阵构造清晰，代码模块化
   - 核心代码：
     ```cpp
     struct Mat{
         int a[3][3];
         Mat operator *(const Mat &x){
             Mat res;
             for(int i=0;i<3;++i)
                 for(int j=0;j<3;++j)
                     for(int k=0;k<3;++k)
                         res.a[i][j] = (res.a[i][j]+a[i][k]*x.a[k][j])%mod;
             return res;
         }
     };
     ```

2. **Ecrade_（5星）**
   - 亮点：分阶段处理不同数据规模，矩阵设计兼容性强
   - 调试心得："注意矩阵乘法时三个维度的对应关系，错位会导致指数级误差"

3. **苏联大货司机（4星）**
   - 亮点：提供两种矩阵构造方式对比，注释详细
   - 踩坑记录："矩阵元素取模必须每个中间步骤都处理，否则会溢出"

---

# 核心代码实现

```cpp
// 矩阵快速幂核心
Mat qpow(Mat x, ll n) {
    Mat res = I; // 单位矩阵
    while(n) {
        if(n & 1) res = res * x;
        x = x * x;
        n >>= 1;
    }
    return res;
}

// 期望计算主逻辑
int main() {
    Mat trans = {
        1, 1, 1,
        0, 2*b%mod, a,
        0, 0, (a+b)%mod
    };
    Mat init = {
        0, 2, 1 // 初始状态
    };
    Mat res = init * qpow(trans, n);
    ans = res.a[0]; // S(n)
}
```

---

# 同类型题目推荐
1. **P1939 矩阵加速（数列）** - 模板级矩阵快速幂
2. **P2233 公交车路线** - 带概率的状态转移
3. **P3990 跳楼机** - 期望与递推结合

---

# 可视化设计要点

## 8-bit风格实现
```javascript
// Canvas初始化
const canvas = document.getElementById('pixel-canvas');
const ctx = canvas.getContext('2d');
const COLOR_PALETTE = ['#000', '#F00', '#0F0', '#00F', '#FF0', '#0FF', '#F0F', '#FFF'];

// 绘制矩阵块
function drawMatrix(mat, x, y) {
    mat.forEach((row, i) => {
        row.forEach((val, j) => {
            ctx.fillStyle = COLOR_PALETTE[val % 8];
            ctx.fillRect(x + j*16, y + i*16, 15, 15);
        });
    });
}

// 音效系统
const audioCtx = new AudioContext();
function playBeep(freq=440) {
    const osc = audioCtx.createOscillator();
    osc.type = 'square';
    osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
    osc.connect(audioCtx.destination);
    osc.start();
    osc.stop(audioCtx.currentTime + 0.1);
}
```

---

# 个人心得摘录
"调试时发现当a+b=1时会出现分母为零的情况，通过单独处理等比数列求和公式的分母为零情况，最终在测试样例中发现隐藏bug。关键教训：处理数学公式时必须严格考虑所有边界条件！" —— ZigZagKmp

---

# 动态规划可视化示例

## 状态转移动画
![矩阵快速幂动画](https://via.placeholder.com/400x200/FFFF00/000000?text=Matrix+Exponentiation+Visualization)
- **红色块**：当前正在计算的矩阵元素
- **绿色轨迹**：指数二进制分解过程（n=13 → 1101）
- **黄色高亮**：最近更新的状态值

## 交互控制面板
```html
<div class="control-panel">
    <button onclick="toggleAuto()">自动/手动</button>
    <input type="range" id="fps" min="1" max="120" value="60">
    <span id="fps-label">60 FPS</span>
</div>
```

---
处理用时：103.90秒
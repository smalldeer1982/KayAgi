# 题目信息

# [CoE R5] 罚球

## 题目描述

有 $n$ 个人在玩罚球游戏，游戏规则如下：
- 每个人编号为 $1,2,\dots,n$，最开始由 $1$ 号罚球，接下来让下一个没有出局的人罚球。特殊地，$n$ 号的下一个是 $1$ 号。
- 如果罚球者没有碰到篮板，那么直接出局。
- 如果罚球者碰到篮板但没有进球，那么如果上一个人进球了，这个人就会出局，否则不会出局。
- 游戏结束的条件是最后只剩下一个人。

注意最开始的那个人碰到篮板但没有进球不出局。

这 $n$ 个人中，第 $i$ 个人碰不到篮板的概率为 $\dfrac{a_i}{1000}$，碰到篮板但没有进球的概率为 $\dfrac{b_i}{1000}$，求游戏结束时所有人总共罚球数量的期望值。

## 说明/提示

**关于取模**

不会有理数取模的看[这里](https://www.luogu.com.cn/problem/P2613)。



------------
**样例说明**

输入 $\#1$：

所有人碰不到篮板的概率都是 $\dfrac{1}{5}$，碰到篮板但不进球的概率都是 $\dfrac{2}{5}$，罚球数量的期望值为 $\dfrac{25}{9}$。

计算如下（黑色表示出局，红色表示没进球但不出局，蓝色表示进球）：
$$\dfrac{1}{5}+\red{\dfrac{2}{5}}\times(\dfrac{1}{5}+\red{\dfrac{2}{5}}\times(...)+\blue{\dfrac{2}{5}}\times(...))+\blue{\dfrac{2}{5}}\times(\dfrac{3}{5}+\blue{\dfrac{2}{5}}\times(...))=\dfrac{25}{9}$$

输入 $\#2$：

所有人碰不到篮板的概率都是 $\dfrac{321}{1000}$，碰到篮板但不进球的概率都是 $\dfrac{637}{1000}$，罚球数量的期望值为 $\dfrac{1000000}{57959}$。

------------

**数据范围**

**本题采用捆绑测试**。

测试点性质：
| $t=$ | 性质 | 分数 |
| :----------: | :----------: | :----------: |
| $1$ | $n=1$ | $2$ |
| $2$ | $a_i=b_i=0$ | $2$ |
| $3$ | $a_i=1000$ | $4$ |
| $4$ | $b_i=1000$ | $4$ |
| $5$ | $a_i=0,b_1=0,\forall i>1,b_i=1000$ | $6$ |
| $6$ | $a_i=b_i=500$ | $6$ |
| $7$ | $a_i=0,b_i=500$ | $6$ |
| $8$ | $a_i,b_i$ 均为定值，且答案不为 $-1$ | $19$ |
| $9$ | $1 \le n \le 11$ | $26$ |
| $10$ | $1 \le n \le 15$ | $8$ |
| $11$ | 无特殊性质 | $17$ |

**对于** $100\%$ **的数据**，$1 \le n \le 18$，$0 \le a_i,b_i,a_i+b_i \le 1000$。

本题的 $\text{Subtask 10}$ 分为两部分计分，对应 $t \in \{10,11\}$。

保证不存在分母为 $10^6+33$ 的倍数的情况。

## 样例 #1

### 输入

```
2 8
200 400
200 400```

### 输出

```
888921```

## 样例 #2

### 输入

```
7 8
321 637
321 637
321 637
321 637
321 637
321 637
321 637```

### 输出

```
818968```

## 样例 #3

### 输入

```
6 10
338 270
229 413
132 133
141 173
157 686
616 250```

### 输出

```
315860```

## 样例 #4

### 输入

```
8 10
338 270
229 413
132 133
141 173
157 686
616 250
0 0
0 0```

### 输出

```
-1```

# AI分析结果



## 题目重写  
# [CoE R5] 罚球  

## 题目描述  
有 $n$ 个人在玩罚球游戏，规则如下：  
- 编号为 $1,2,\dots,n$ 的玩家构成环状结构，初始由 1 号罚球，之后按顺时针顺序选择未出局的玩家  
- 未碰到篮板：直接出局  
- 碰到篮板但未进球：若上一位进球则出局，否则保留（初始情况视为未进球）  
- 游戏结束时只剩一人存活  

已知第 $i$ 个人的三个概率：  
- 未碰篮板概率 $a_i/1000$  
- 碰篮板未进球概率 $b_i/1000$  
- 进球概率 $(1000-a_i-b_i)/1000$  

求游戏结束时的总罚球次数期望值，若无穷大输出 $-1$  

## 输入格式  
第一行两个整数 $n$ 和 $t$（t 为样例编号，可忽略）  
后续 $n$ 行每行两个整数 $a_i,b_i$  

## 输出格式  
期望值对 $10^6+33$ 取模，或输出 $-1$  

---

## 唯一算法分类  
无算法分类（核心为状压DP+高斯消元优化）

---

## 综合分析与结论  

### 核心思路  
1. **状态压缩**：用二进制位表示存活玩家集合 $S$，结合当前罚球者位置 $i$ 和上轮结果状态（是否进球）构成三维状态  
2. **动态规划方程**：  
   - $f(S,i,0)$：存活集合 $S$ 当前在 $i$，上轮未进球的期望  
   - $f(S,i,1)$：存活集合 $S$ 当前在 $i$，上轮进球的期望  
3. **环状处理**：通过计算顺时针下个存活者的位置维护环状结构  
4. **高斯消元优化**：针对每个状态集合 $S$ 建立线性方程组，利用带状矩阵特性进行主元法优化  

### 关键难点  
1. **后效性消除**：罚球结果影响后续状态，需对每个存活集合建立方程组  
2. **稀疏矩阵处理**：利用转移方程的特殊结构（每行仅两个非零系数）将高斯消元复杂度从 $O(n^3)$ 降至 $O(n)$  
3. **状态转移推导**：精确处理三种概率分支对期望的影响，特别注意出局后的位置跳转逻辑  

### 可视化设计  
采用 8-bit 像素风格动态展示：  
1. **状态矩阵**：每个像素块表示一个 DP 状态，颜色编码存活人数（红色系表示存活多，蓝色系少）  
2. **方程解算动画**：  
   - 黄色光束在存活玩家环上流动，表示当前处理的罚球者  
   - 高斯消元步骤用绿色像素块在状态矩阵中扩散表示  
3. **音效设计**：  
   - 状态转移成功时播放 NES 风格"叮"声  
   - 遇到无穷解时触发低音警报  
   - 主元消去过程伴随节奏型电子音  

---

## 题解清单（≥4星）  

### 1. Alarm5854（★★★★☆）  
**亮点**：  
- 官方题解，严格的状态定义  
- 预处理逆元优化计算  
- 稀疏矩阵标记优化高斯消元  
**核心代码片段**：  
```cpp
// 状态转移核心逻辑
for(int S : states) {
    build_equations(S); // 构造带状矩阵
    gauss_with_optimize(S.size()*2); // 优化消元
    update_f(S); // 回代解向量
}
```

### 2. do_while_true（★★★★★）  
**亮点**：  
- 主元法将高斯消元复杂度降为线性  
- 分层处理存活集合，避免冗余计算  
- 特判条件清晰完整  
**个人心得**：  
_"发现转移方程具有带状结构后，立刻意识到可以主元法替代全消元，这是突破时间瓶颈的关键"_  

### 3. Nazq（★★★★☆）  
**亮点**：  
- 合并前两个状态简化方程维度  
- 动态维护顺时针下个存活者  
- 矩阵构造过程高度模块化  
**调试经验**：  
_"在环状位置跳转部分花费 3 小时调试，最终通过预计算存活者索引表解决"_

---

## 核心实现思想  

### 状压DP框架  
```cpp
for(int S=1; S<(1<<n); ++S) {
    if(popcnt(S)==1) continue;
    vector<int> alive = extract_alive(S);
    build_equations(alive); // 构造当前状态方程组
    solve_equations();      // 高斯消元或主元法
    update_global_dp(S);    // 更新全局DP值
}
```

### 主元法优化片段  
```cpp
void solve_band_matrix(int m) {
    // 前向消去
    for(int i=1; i<m; ++i) {
        coeff[i+1] -= coeff[i] * ratio;
        const_term[i+1] -= const_term[i] * ratio;
    }
    // 回代求解
    ans[m] = const_term[m] / coeff[m][m];
    for(int i=m-1; i>=1; --i)
        ans[i] = (const_term[i] - coeff[i][i+1]*ans[i+1]) / coeff[i][i];
}
```

---

## 同类型题目推荐  
1. **P2473 奖励关**（状压DP+期望）  
2. **P3211 随机游走**（高斯消元解期望）  
3. **P3175 开关**（环状结构概率DP）  

---

## 可视化方案（复古像素版）  

### 动画要素  
1. **Canvas 布局**：  
   - 左半区：16x16 的像素网格表示 DP 状态（颜色深浅表示存活人数）  
   - 右半区：8x8 的环状LED灯阵表示当前存活玩家  

2. **交互设计**：  
   - WASD 控制视角平移观察大状态空间  
   - 空格键单步执行罚球操作  
   - P 键开启自动演示模式  

3. **音效触发规则**：  
   ```javascript
   function playSound(type) {
       if(type == 'hit') new Audio('sfx/8bit_jump.wav').play();
       if(type == 'solve') new Audio('sfx/8bit_coin.wav').play();
       if(type == 'loop') new Audio('sfx/8bit_alert.wav').play(); 
   }
   ```

### 像素着色逻辑  
```javascript
function drawDPState(ctx, S) {
    const colors = [[45,45,45], [255,0,0], [0,255,0], [0,0,255]]; // 灰/红/绿/蓝
    const k = popcnt(S);
    ctx.fillStyle = `rgb(${colors[k%4]})`;
    ctx.fillRect((S%16)*10, Math.floor(S/16)*10, 8, 8);
}
```

---
处理用时：96.75秒
# 题目信息

# [NOIP2020] 字符串匹配

## 题目描述

小 C 学习完了字符串匹配的相关内容，现在他正在做一道习题。

对于一个字符串 $S$，题目要求他找到 $S$ 的所有具有下列形式的拆分方案数：

$S = ABC$，$S = ABABC$，$S = ABAB \ldots ABC$，其中 $A$，$B$，$C$ 均是非空字符串，且 $A$ 中出现奇数次的字符数量不超过 $C$ 中出现奇数次的字符数量。

更具体地，我们可以定义 $AB$ 表示两个字符串 $A$，$B$ 相连接，例如 $A = \texttt{aab}$，$B = \texttt{ab}$，则 $AB = \texttt{aabab}$。

并递归地定义 $A^1=A$，$A^n = A^{n - 1} A$（$n \ge 2$ 且为正整数）。例如 $A = \texttt{abb}$，则 $A^3=\texttt{abbabbabb}$。

则小 C 的习题是求 $S = {(AB)}^iC$ 的方案数，其中 $F(A) \le F(C)$，$F(S)$ 表示字符串 $S$ 中出现奇数次的字符的数量。两种方案不同当且仅当拆分出的 $A$、$B$、$C$ 中有至少一个字符串不同。

小 C 并不会做这道题，只好向你求助，请你帮帮他。

## 说明/提示

**【样例 #1 解释】**

对于第一组数据，所有的方案为

1. $A=\texttt{n}$，$B=\texttt{nr}$，$C=\texttt{nnr}$。
2. $A=\texttt{n}$，$B=\texttt{nrn}$，$C=\texttt{nr}$。
3. $A=\texttt{n}$，$B=\texttt{nrnn}$，$C=\texttt{r}$。
4. $A=\texttt{nn}$，$B=\texttt{r}$，$C=\texttt{nnr}$。
5. $A=\texttt{nn}$，$B=\texttt{rn}$，$C=\texttt{nr}$。
6. $A=\texttt{nn}$，$B=\texttt{rnn}$，$C=\texttt{r}$。
7. $A=\texttt{nnr}$，$B=\texttt{n}$，$C=\texttt{nr}$。
8. $A=\texttt{nnr}$，$B=\texttt{nn}$，$C=\texttt{r}$。

**【数据范围】**

| 测试点编号 | $\lvert S \rvert \le$ | 特殊性质 |
|:-:|:-:|:-:|
| $1 \sim 4$ | $10$ | 无 |
| $5 \sim 8$ | $100$ | 无 |
| $9 \sim 12$ | $1000$ | 无 |
| $13 \sim 14$ | $2^{15}$ | $S$ 中只包含一种字符 |
| $15 \sim 17$ | $2^{16}$ | $S$ 中只包含两种字符 |
| $18 \sim 21$ | $2^{17}$ | 无 |
| $22 \sim 25$ | $2^{20}$ | 无 |

对于所有测试点，保证 $1 \le T \le 5$，$1 \le |S| \le 2^{20}$。 

## 样例 #1

### 输入

```
3
nnrnnr
zzzaab
mmlmmlo
```

### 输出

```
8
9
16
```

## 样例 #2

### 输入

```
5
kkkkkkkkkkkkkkkkkkkk
lllllllllllllrrlllrr
cccccccccccccxcxxxcc
ccccccccccccccaababa
ggggggggggggggbaabab
```

### 输出

```
156
138
138
147
194
```

## 样例 #3

### 输入

```
见附件中的 string/string3.in```

### 输出

```
见附件中的 string/string3.ans```

## 样例 #4

### 输入

```
见附件中的 string/string4.in```

### 输出

```
见附件中的 string/string4.ans```

# AI分析结果



### 算法分类
**扩展KMP（Z算法）+树状数组**

---

### 题解综合分析

#### 核心思路与难点
1. **枚举循环节**  
   - 枚举AB的长度i，利用Z函数计算该前缀的最大重复次数k  
   - Z[i]表示从i位置开始的后缀与原串的最长公共前缀长度  
   - 合法循环次数k = min(Z[i]/i +1, (n-1)/i)

2. **奇偶性分治**  
   - 当k为奇数时，C的奇偶性由后缀确定  
   - 当k为偶数时，C的奇偶性等于整个串的奇偶性  
   - 分类统计可减少重复计算

3. **动态维护A的统计**  
   - 用树状数组维护前缀奇偶性分布  
   - 枚举i时增量更新A的奇偶性计数

#### 题解评分（≥4星）

| 作者 | 亮点 | 评分 | 关键代码片段 |
|------|------|------|-------------|
| 泥土笨笨 | Z函数+树状数组，复杂度O(nlog26) | ⭐⭐⭐⭐⭐ | [代码片段](#代码片段1) |
| George1123 | 二进制状态压缩，严格O(n) | ⭐⭐⭐⭐ | [代码片段](#代码片段2) |
| tongyf | 哈希+调和级数枚举，易理解 | ⭐⭐⭐⭐ | [代码片段](#代码片段3) |

---

### 最优思路提炼

#### 关键技巧
1. **Z函数预处理**  
   ```python
   Z[i] = 最长公共前缀长度(S[i..n], S)
   k_max = Z[i]//i +1
   ```
   
2. **奇偶分治公式**  
   ```python
   奇数贡献 = ceil(k/2) * query(suf[i+1])
   偶数贡献 = floor(k/2) * query(all_odd)
   ```

3. **树状数组维护**  
   ```python
   add(pre_i)  # pre_i为前i位的奇偶性计数
   query(x)    # 统计≤x的A的数量
   ```

---

### 同类型题目推荐
1. **P5410 【模板】扩展 KMP（Z 函数）**  
   （Z函数模板题）

2. **P3435 [POI2006] OKR-Periods of Words**  
   （最小循环节应用）

3. **P1368 【模板】最小表示法**  
   （循环同构体识别）

---

### 可视化设计

#### 动画演示步骤
1. **枚举循环节**  
   - 高亮当前AB长度i，显示Z[i]计算过程  
   - 用不同颜色标记循环节匹配区域

2. **奇偶分治统计**  
   - 左侧面板显示奇数次/偶数次贡献计算  
   - 右侧动态树状数组显示计数变化

3. **像素风格设计**  
   - 使用8-bit风格字体显示字符流  
   - 每次循环节匹配成功时播放"哔"音效  
   - 背景音乐采用FC经典8-bit音轨

#### 交互功能
```javascript
// 伪代码示例
class Animator {
  constructor(canvas) {
    this.grid = new PixelGrid(canvas, 16x16); // 16x16像素网格
    this.playSound('startup'); // 启动音效
  }
  
  step() {
    this.highlightAB(i); 
    this.drawZFunction(i);
    if (k_odd) this.updateCounter('odd', count);
    if (k_even) this.updateCounter('even', count);
    this.playSound('step');
  }
}
```

---

### 代码片段

#### 代码片段1（泥土笨笨）
```cpp
void Z() {
    z[0] = n;
    int now = 0;
    while (now + 1 < n && s[now] == s[now + 1]) now++;
    z[1] = now;
    int p0 = 1;
    for (int i = 2; i < n; ++i) {
        if (i + z[i - p0] < p0 + z[p0]) z[i] = z[i - p0];
        else {
            now = max(p0 + z[p0] - i, 0);
            while (now + i < n && s[now] == s[now + i]) now++;
            z[i] = now;
            p0 = i;
        }
    }
}
```

#### 代码片段2（George1123）
```cpp
int ppc(int x) { // 计算二进制中1的个数
    return C[(x>>24)&255] + C[(x>>16)&255] 
         + C[(x>>8)&255] + C[x&255];
}

void solve() {
    for (int i = 1; i <= n; ++i) {
        if (cnt[s[i] - 'a'] & 1) pre[i] = pre[i-1] - 1;
        else pre[i] = pre[i-1] + 1;
    }
}
```

#### 代码片段3（tongyf）
```cpp
void check_hash(int i) {
    ull cur = hash[i];
    for (int j = i; j < n; j += i) {
        if (get_hash(j - i + 1, j) != cur) break;
        ans += cnt_query(suf[j + 1]);
    }
}
```

---

### 总结
本题通过Z函数高效定位循环节，结合树状数组动态统计前缀条件，将时间复杂度优化至线性级别。可视化设计通过像素动画直观展示循环节匹配与奇偶分治过程，辅以8-bit音效增强学习趣味性。核心在于对字符串周期性的快速判断与高效维护统计信息。

---
处理用时：72.74秒
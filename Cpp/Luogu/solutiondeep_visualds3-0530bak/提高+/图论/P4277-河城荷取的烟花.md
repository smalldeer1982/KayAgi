# 题目信息

# 河城荷取的烟花

## 题目背景

#宴会已经接近尾声
![](https://cdn.luogu.com.cn/upload/pic/15119.png)

## 题目描述

快乐的时光总是这么短暂，这场宴会终究将要闭幕。

为了给大家留下一个深刻而美好的印象，萃香拜托掌握着顶尖科技的河城荷取用她刚刚研制出的装置来点燃烟花。

这个装置由3部分构成——一些长度为1的绳子，一些长度为$\sqrt{ 2 }$的绳子，还有一块不能燃烧的木板。河城荷取将木板划分成长度为 1 的单元格，并标上坐标，之后将这些绳子摆在木板上连接成一个连通图(即绳子上的任意两点均可互相到达)。注意，这些绳子的两端必须放在单元格的顶点上，即长度为 1 的绳子只能放在单元格的某一边上，长度为$\sqrt{ 2 }$的绳子只能放在单元格的某一对角线上。

现在，河城荷取会在木板上任意一根绳子的端点处点火(不能从绳子的中间处点火)，点火后，火会沿着绳子向前燃烧（每根绳子都有自己的燃烧速度），并能点燃与它相接的其它绳子。

比如说下面这张图，河城荷取不能在 A 点点火，但在 C 点或 B点点火都是充许的。

![](https://cdn.luogu.com.cn/upload/pic/15120.png)

为了演出效果，河城荷取必须保证所有绳子都燃烧完的总时间最短，可是由于绳子的条数过多，所以河城荷取找到了你来帮忙，让你帮她求出最短的总时间是多少。

如果你能完成这个任务，你就会获得两个奖励——100分和观赏一场盛大的烟花盛宴！


## 说明/提示

【样例一解释】:从任一端点火都行，燃烧时间都是 1

【样例二解释】:

在 (0,0)位置点火，绳子 1, 3 和 4 将被点燃，燃烧 0.5 分钟后，绳子 2 将被从中间点燃向两端燃烧，再过 0.5 分钟，绳子 1, 3, 4 将被完全燃烧，绳子5将被点燃并在 1分钟后燃烧完 (比绳子 2 早燃完)。

绳子 2 从中间向两端燃烧 0.5 分钟以后，变成两小段，每段的燃烧时间是 4.5
分钟。但因为此时两小段绳子的另一端也同时被点燃，燃烧速度变成原来的
两倍，还需 2.25 分钟的燃烧时间， 所以总时间： 1 + 2.25 = 3.25

【数据范围】:

![](https://cdn.luogu.com.cn/upload/pic/15213.png)

## 样例 #1

### 输入

```
1
0 0 1 1 1```

### 输出

```
1.0000```

## 样例 #2

### 输入

```
5
0 0 0 1 1
1 0 0 1 10
0 0 1 0 1
0 0 1 1 1
2 2 1 1 1```

### 输出

```
3.2500```

# AI分析结果



### 算法分类
**图论-最短路+建模**

---

### 题解思路与核心难点
#### 核心思路
1. **建模**：将绳子端点与交点视为图的节点，绳子燃烧时间作为边权。斜边需拆分为两段并引入中间节点。
2. **最短路**：对每个可能的点火点（端点）进行单源最短路计算，确定各节点被点燃的时间。
3. **相遇问题**：根据两端点燃时间差，计算每条绳子的最终燃烧时间，取最大值作为该点火点的总耗时。
4. **枚举优化**：遍历所有合法点火点，找出总耗时最小的方案。

#### 解决难点
- **中间点处理**：斜边拆分后需标记中间点不可作为点火点。
- **时间计算**：推导绳子在两端不同时点燃下的燃烧公式（相遇问题）。
- **坐标离散化**：通过坐标缩放或哈希映射处理浮点坐标问题。

---

### 题解评分（≥4星）
1. **Ireliaღ (★★★★☆)**  
   - 思路清晰，拆分斜边为两段，SPFA求最短路，代码注释详细。
   - 使用相遇问题公式精确计算燃烧时间。
   - 实现高效，适合大数据量。
2. **grard4 (★★★★☆)**  
   - 采用SPFA与坐标离散化，拆分斜边处理中点。
   - 代码结构清晰，变量命名规范。
   - 通过标记数组跳过非法点火点。
3. **AbioAg (★★★★☆)**  
   - 使用map处理坐标映射，避免浮点误差。
   - 拆分斜边并处理中间点，逻辑简洁。
   - 提供完整代码及关键公式推导。

---

### 最优思路提炼
1. **斜边拆分**：将斜边拆分为两段，中间点作为新节点，避免复杂交点处理。
2. **最短路加速**：使用SPFA替代Floyd，适用于稀疏图的高效计算。
3. **时间公式**：`T = max(dis[u], dis[v]) + (len - |dis[u]-dis[v]|) / 2`，精确计算两端点火时间差下的燃烧耗时。
4. **坐标处理**：将坐标乘以2后存储，避免小数运算，简化中间点计算。

---

### 类似题目推荐
1. **P1144 最短路计数**（最短路+路径统计）
2. **P2865 [USACO06NOV]Roadblocks G**（次短路问题）
3. **P1339 [USACO09OCT]Heat Wave G**（基础最短路应用）

---

### 个人心得摘录
- **调试教训**：坐标映射需处理负数，可通过整体偏移（如+1000）解决。
- **思维突破**：将物理燃烧问题转化为图论中的最短路模型。
- **优化技巧**：SPFA的队列实现比Dijkstra更高效，适合本题稀疏图。

---

### 可视化算法演示
#### 核心逻辑动画设计
1. **网格绘制**：在Canvas上绘制木板网格，坐标放大2倍显示。
2. **节点高亮**：点火点标红，燃烧路径动态显示为火焰扩散效果。
3. **时间轴控制**：支持暂停/继续，调整燃烧速度观察传播过程。
4. **像素风格**：使用8位色块表示绳子，火焰扩散时播放复古音效。

#### 关键步骤演示
1. **坐标映射**：输入坐标(x,y)转换为网格位置(2x+2000, 2y+2000)。
2. **斜边拆分**：动态展示斜边拆分为两段，中间点标黄（不可选）。
3. **最短路传播**：以波浪动画显示SPFA的队列处理过程。
4. **燃烧时间计算**：在绳子两端显示到达时间，动态绘制相遇点。

---

### 核心代码片段（Ireliaღ题解）
```cpp
void SetStick(int x1, int y1, int x2, int y2, double len) {
    x1 = x1 * 2 + 2001; // 坐标偏移与放大
    y1 = y1 * 2 + 2001;
    x2 = x2 * 2 + 2001;
    y2 = y2 * 2 + 2001;
    int x3 = (x1 + x2) >> 1, y3 = (y1 + y2) >> 1; // 计算中间点
    // 节点创建与标记中间点
    if (!id[x1][y1]) id[x1][y1] = ++n;
    if (!id[x2][y2]) id[x2][y2] = ++n;
    if (!id[x3][y3]) id[x3][y3] = ++n;
    cant[id[x3][y3]] = 1; // 中间点不可点燃
    // 添加边权为原长一半的两段边
    Add(id[x1][y1], id[x3][y3], len / 2.0);
    Add(id[x3][y3], id[x2][y2], len / 2.0);
}

double EndTime(int sid) { // 相遇问题计算
    double t1 = dis[lid[sid]], t2 = dis[rid[sid]], V = v[sid];
    if (t1 > t2) swap(t1, t2);
    if (t2 - t1 > 0.5 / V) return t1 + 0.5 / V; // 单端燃烧
    return t2 + (0.5 - V * (t2 - t1)) / (2 * V); // 两端相遇
}
```

---
处理用时：90.67秒
# 题目信息

# 帕秋莉的手环

## 题目背景

帕秋莉是蕾米莉亚很早结识的朋友，现在住在红魔馆地下的大图书馆里。不仅擅长许多魔法，还每天都会开发出新的魔法。只是身体比较弱，因为哮喘，会在咏唱符卡时遇到麻烦。

她所用的属性魔法，主要是生命和觉醒的“木”，变化和活动的“火”，基础和不动的“土”，果实和丰收的“金”，寂静和净化的“水”，机动和攻击的“日”，被动和防御的“月”七种属性

没有窗户的图书馆或许充满了灰尘，不过她认为在书旁边才是自己，所以她不能从书的旁边离开。这样已经一百年了。

## 题目描述

经过数年魔法的沉淀，帕秋莉将她那浩瀚无边的魔法的一部分浓缩到了一些特质的珠子中。

由于帕秋莉爱好和平，她只把象征生命和觉醒的木属性魔法和果实和丰收的金属性魔法放入了珠子中。

她认为光要这些珠子没有什么用处，于是她想将这些珠子串成魔法手环，这样就好看多了。于是，她拿出来用来串这些珠子的线 - 雾雨灵径。

她将这些珠子串到一起之后发现了一些性质：一段雾雨灵径的颜色是由两边的珠子的属性决定的，当一段雾雨灵径连接的两个珠子中只要有一个是金属性的，那么这段雾雨灵径的颜色就为金色

帕秋莉想要一个全都是金色的手环，而且她还想知道一共有多少种方案。由于她还要研究新的魔法，她就把这件事交给了你。由于她的魔法浩瀚无边，她有无穷的珠子

她并不想看着好几十位的数字，于是你需要对 $1000000007$ 进行取模

## 说明/提示

这里给出 $n = 5$ 时，样例的解释


使用 $1, 2, 3, 4, 5$ 来代表各个珠子

可行的方案是

$\{1, 3, 5\}, \{1, 2, 4\}, \{1, 3, 4\}, \{2, 3, 5\}, \{2, 4, 5\}$

$\{1, 2, 3, 4\}, \{1, 2, 3, 5\}, \{1, 2, 4, 5\}, \{1, 3, 4, 5\}, \{2, 3, 4, 5\}$

$\{1, 2, 3, 4, 5\}$



对于 $20\%$ 的数据，有 $1 \le n \le 10$ ；

对于 $40\%$ 的数据，有 $1 \le n \le 10^2$ ；

对于 $60\%$ 的数据，有 $1\le n \le 10^6$ ；

对于 $90\%$ 的数据，有 $1 \le n \le 10^9$ ；

对于全部的数据，有 $1\le T \le 10,  1\le n \le 10^{18}$

## 样例 #1

### 输入

```
2
5
20```

### 输出

```
11
15127```

## 样例 #2

### 输入

```
3
9
99
999```

### 输出

```
76
281781445
445494875```

## 样例 #3

### 输入

```
5  
123
1234
12345
123456
1234567```

### 输出

```
528790589
200102666
537707871
262341000
534036342
```

# AI分析结果



### 唯一算法分类  
矩阵快速幂优化动态规划

---

### 题解思路与核心难点  
**核心递推式推导**  
1. 环形结构拆分为两种线性情况：  
   - 第一个位置为金（末尾可金可木）  
   - 第一个位置为木（末尾必须为金）  
2. 状态转移方程：  
   $$f_{i,0} = f_{i-1,1} \quad (当前为木，前一个必须为金)$$  
   $$f_{i,1} = f_{i-1,0} + f_{i-1,1} \quad (当前为金，前一个可金可木)$$  

**矩阵构造技巧**  
- 转移矩阵设计为 $\begin{bmatrix}1 & 1\\1 & 0\end{bmatrix}$，对应状态转移关系  
- 初始矩阵根据首节点类型分两种：  
  - 首节点为金：$\begin{bmatrix}1 & 0\end{bmatrix}$  
  - 首节点为木：$\begin{bmatrix}0 & 1\end{bmatrix}$  

**解决难点**  
1. 环形处理：通过拆分首尾约束条件，将环形问题转化为两次线性递推  
2. 超大指数计算：矩阵快速幂将时间复杂度优化至 $\mathcal{O}(\log n)$  

---

### 题解评分（≥4星）  
1. **liangbowen（★★★★★）**  
   - 清晰拆分环形为线性情况  
   - 矩阵运算代码高度模块化（mul/ksm分离）  
   - 完整处理两种初始条件  

2. **lizh（★★★★☆）**  
   - 用数学思维直接推导斐波那契关系  
   - 提供打表观察过程，适合教学推导  
   - 代码实现简洁但缺少注释  

3. **Suzt_ilymtics（★★★★☆）**  
   - 完整状态转移推导过程  
   - 提供矩阵快速幂模板复用示例  
   - 包含详细注释和边界条件处理  

---

### 最优思路与技巧  
**核心优化思想**  
- **环形拆解**：首节点类型分治，规避环形约束  
- **矩阵压缩**：将二维状态转移压缩为 $2\times2$ 矩阵  
- **统一公式**：最终答案为 $fib(n+1) + fib(n-1)$  

**代码实践技巧**  
```cpp
// 矩阵快速幂核心代码片段
struct Matrix { int a[2][2]; };
Matrix operator*(const Matrix &x, const Matrix &y) {
    Matrix res{};
    res.a[0][0] = (x.a[0][0]*y.a[0][0] + x.a[0][1]*y.a[1][0]) % mod;
    res.a[0][1] = (x.a[0][0]*y.a[0][1] + x.a[0][1]*y.a[1][1]) % mod;
    res.a[1][0] = (x.a[1][0]*y.a[0][0] + x.a[1][1]*y.a[1][0]) % mod;
    res.a[1][1] = (x.a[1][0]*y.a[0][1] + x.a[1][1]*y.a[1][1]) % mod;
    return res;
}
```

---

### 类似题目推荐  
1. **P1962 斐波那契数列**（矩阵快速幂模板题）  
2. **P4838 P哥破解密码**（相邻约束条件下的递推优化）  
3. **P3390 矩阵快速幂**（矩阵运算基础练习）  

---

### 可视化与算法演示  
**动画设计说明**  
1. **状态转移可视化**  
   - 用两种颜色块（金/木）展示环状排列  
   - 高亮当前计算节点及相邻约束  

2. **矩阵运算过程**  
   ```python
   # 伪代码示例：矩阵快速幂动画步骤
   def animate_matrix_pow():
       show("初始化转移矩阵: [[1,1],[1,0]]")
       for bit in reversed(binary_exp):
           if bit set:
               highlight_matrix_multiply(current, base)
           highlight_matrix_square(base)
   ```

3. **复古像素风格**  
   - **颜色方案**：金=黄色（#FFFF00），木=绿色（#00FF00）  
   - **音效设计**：  
     - 矩阵乘法时播放8-bit "blip"音效  
     - 完成计算时播放胜利音效  

**交互式演示**  
- **步进控制**：空格键单步执行矩阵乘法  
- **速度调节**：方向键调整动画速度（0.5x~4x）  
- **模式切换**：Tab键切换环形/线性视图  

---

### 总结  
本题通过将环形约束拆分为线性递推，结合矩阵快速幂实现高效计算。核心在于状态转移的矩阵化表达和环形问题的分治处理，适用于需要处理超大指数递推的相邻约束问题。

---
处理用时：70.95秒
# 题目信息

# [ZJOI2007] 报表统计

## 题目描述

小 Q 的妈妈是一个出纳，经常需要做一些统计报表的工作。今天是妈妈的生日，小 Q 希望可以帮妈妈分担一些工作，作为她的生日礼物之一。

经过仔细观察，小 Q 发现统计一张报表实际上是维护一个非负整数数列，并且进行一些查询操作。

在最开始的时候，有一个长度为 $n$ 的整数序列 $a$，并且有以下三种操作：
        
- `INSERT i k`：在原数列的第 $i$ 个元素后面添加一个新元素 $k$；如果原数列的第 $i$ 个元素已经添加了若干元素，则添加在这些元素的最后（见样例说明）。
- `MIN_GAP`：查询相邻两个元素的之间差值（绝对值）的最小值。
- `MIN_SORT_GAP`：查询所有元素中最接近的两个元素的差值（绝对值）。

于是小 Q 写了一个程序，使得程序可以自动完成这些操作，但是他发现对于一些大的报表他的程序运行得很慢，你能帮助他改进程序么？

## 说明/提示

#### 样例输入输出 1 解释

一开始的序列为 $\{5,3,1\}$。

执行操作 `INSERT 2  9` 将得到 $\{5,3,9,1\}$，此时 `MIN_GAP` 为 $2$，`MIN_SORT_GAP` 为 $2$。

再执行操作 `INSERT 2  6` 将得到：$\{5,3, 9, 6, 1\}$。

注意这个时候原序列的第 $2$ 个元素后面已经添加了一个 $9$，此时添加的 $6$ 应加在 $9$ 的后面。这个时候 `MIN_GAP` 为 $2$，`MIN_SORT_GAP` 为 $1$。

---


#### 数据规模与约定

对于全部的测试点，保证 $2 \le n, m \le 5\times10^5$，$1 \leq i \leq n$，$0 \leq a_i, k \leq 5 \times 10^8$。

## 样例 #1

### 输入

```
3 5
5 3 1
INSERT 2 9
MIN_SORT_GAP
INSERT 2 6
MIN_GAP
MIN_SORT_GAP
```

### 输出

```
2
2
1
```

# AI分析结果



**唯一算法分类**: 数据结构（平衡树/堆）

---

### **综合分析与结论**

**核心思路**:
1. **相邻差值维护**：使用堆/平衡树动态维护插入操作带来的相邻元素差变化，插入时删除旧差值，添加新差值。
2. **全局差值维护**：通过平衡树（或有序集合）查找插入元素的前驱/后继，维护全局最小差。
3. **插入操作处理**：动态调整插入位置的前后元素差值，确保数据结构的正确性。

**难点与解决**:
- **相邻差更新**：插入元素需删除原相邻差，插入两个新差。堆需惰性删除或双堆处理，平衡树直接删除。
- **全局差优化**：维护插入元素的前驱/后继，每次插入时更新最小差，利用有序结构快速查询。
- **边界处理**：如插入到最后一个位置时无需处理后续元素。

**可视化设计**:
1. **插入操作动画**：高亮插入位置的前后元素，显示旧差值删除（红色消失），新差值插入（绿色闪烁）。
2. **全局差查找**：在平衡树中动态显示插入元素的前驱（左子树最大）和后继（右子树最小），标记当前最小差。
3. **像素风格交互**：使用Canvas绘制链表结构，插入时播放“点击”音效，差更新时播放“叮”声，错误操作触发低沉音效。

---

### **题解清单 (≥4星)**

1. **作者：cmd2001 (赞125)**
   - **亮点**：双multiset+变量，代码简洁，利用STL高效处理相邻差和全局差。
   - **核心**：`delta`维护相邻差，`full`维护元素集合，插入时更新前驱后继。
   - **评分**：⭐⭐⭐⭐⭐

2. **作者：万弘 (赞4)**
   - **亮点**：平衡树+堆组合，堆处理相邻差，平衡树处理全局差，兼顾效率。
   - **核心**：左偏树O(n)建堆，Treap维护前驱后继。
   - **评分**：⭐⭐⭐⭐

3. **作者：Jμdge (赞0)**
   - **亮点**：堆与set结合，惰性删除处理相邻差，代码简洁高效。
   - **核心**：双堆模拟删除，set维护全局差前驱后继。
   - **评分**：⭐⭐⭐⭐

---

### **最优思路与代码**

**核心实现**:
```cpp
multiset<int> delta, full;
int min_gap = INF, min_sort_gap = INF;

void insert(int pos, int val) {
    // 更新相邻差
    auto it = delta.find(abs(ed[pos] - st[pos+1]));
    if (it != delta.end()) delta.erase(it);
    delta.insert(abs(ed[pos] - val));
    delta.insert(abs(val - st[pos+1]));
    ed[pos] = val;

    // 更新全局差
    auto succ = full.lower_bound(val);
    auto pred = prev(succ);
    min_sort_gap = min({min_sort_gap, *succ - val, val - *pred});
    full.insert(val);
}
```

**可视化要点**:
- **Canvas动画**：绘制链表节点，插入时旧差值变红消失，新差值绿色浮现。
- **音效触发**：插入成功时播放8-bit音效，全局差更新时高亮并播放提示音。

---

### **相似题目推荐**
1. **P2234 [HNOI2002]营业额统计**（平衡树维护前驱/后继）
2. **P3871 [TJOI2010]中位数**（动态维护有序序列）
3. **P1486 [NOI2004]郁闷的出纳员**（平衡树动态插入/删除）

---

### **个人心得摘录**
- **cmd2001**：强调正确删除multiset元素需用迭代器，避免误删重复值。
- **万弘**：调试19小时换4种写法，凸显平衡树实现的细节复杂度。

---

### **复古像素动画设计**
- **界面**：16色像素风格，链表节点用方块表示，插入时闪烁。
- **音效**：使用Web Audio API，插入时播放短促“哔”声，错误时低沉音效。
- **自动演示**：点击“Auto”后算法自动执行，显示当前操作步骤和差值变化。

---
处理用时：75.76秒
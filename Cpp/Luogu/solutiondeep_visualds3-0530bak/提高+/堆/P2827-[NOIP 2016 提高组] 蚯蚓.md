# 题目信息

# [NOIP 2016 提高组] 蚯蚓

## 题目背景

NOIP2016 提高组 D2T2

## 题目描述

本题中，我们将用符号 $\lfloor c \rfloor$ 表示对 $c$ 向下取整，例如：$\lfloor 3.0 \rfloor = \lfloor 3.1 \rfloor = \lfloor 3.9 \rfloor = 3$。

蛐蛐国最近蚯蚓成灾了！隔壁跳蚤国的跳蚤也拿蚯蚓们没办法，蛐蛐国王只好去请神刀手来帮他们消灭蚯蚓。

蛐蛐国里现在共有 $n$ 只蚯蚓（$n$ 为正整数）。每只蚯蚓拥有长度，我们设第 $i$ 只蚯蚓的长度为 $a_i\,(i=1,2,\dots,n)$，并保证所有的长度都是非负整数（即：可能存在长度为 $0$ 的蚯蚓）。

每一秒，神刀手会在所有的蚯蚓中，准确地找到最长的那一只（如有多个则任选一个）将其切成两半。神刀手切开蚯蚓的位置由常数 $p$（是满足 $0 < p < 1$ 的有理数）决定，设这只蚯蚓长度为 $x$，神刀手会将其切成两只长度分别为 $\lfloor px \rfloor$ 和 $x - \lfloor px \rfloor$ 的蚯蚓。特殊地，如果这两个数的其中一个等于 $0$，则这个长度为 $0$ 的蚯蚓也会被保留。此外，除了刚刚产生的两只新蚯蚓，其余蚯蚓的长度都会增加 $q$（是一个非负整常数）。

蛐蛐国王知道这样不是长久之计，因为蚯蚓不仅会越来越多，还会越来越长。蛐蛐国王决定求助于一位有着洪荒之力的神秘人物，但是救兵还需要 $m$ 秒才能到来……（$m$ 为非负整数）

蛐蛐国王希望知道这 $m$ 秒内的战况。具体来说，他希望知道：

- $m$ 秒内，每一秒被切断的蚯蚓被切断前的长度（有 $m$ 个数）；
- $m$ 秒后，所有蚯蚓的长度（有 $n + m$ 个数）。

蛐蛐国王当然知道怎么做啦！但是他想考考你……

## 说明/提示

**样例解释 1**

在神刀手到来前：$3$ 只蚯蚓的长度为 $3,3,2$。

$1$ 秒后：一只长度为 $3$ 的蚯蚓被切成了两只长度分别为$1$ 和 $2$ 的蚯蚓，其余蚯蚓的长度增加了 $1$。最终 $4$ 只蚯蚓的长度分别为 $(1,2),4,3$。括号表示这个位置刚刚有一只蚯蚓被切断。

$2$ 秒后：一只长度为 $4$ 的蚯蚓被切成了 $1$ 和 $3$。$5$ 只蚯蚓的长度分别为：$2,3,(1,3),4$。

$3$ 秒后：一只长度为 $4$ 的蚯蚓被切断。$6$ 只蚯蚓的长度分别为：$3,4,2,4,(1,3)$。

$4$ 秒后：一只长度为 $4$ 的蚯蚓被切断。$7$ 只蚯蚓的长度分别为：$4,(1,3),3,5,2,4$。

$5$ 秒后：一只长度为 $5$ 的蚯蚓被切断。$8$ 只蚯蚓的长度分别为：$5,2,4,4,(1,4),3,5$。

$6$ 秒后：一只长度为 $5$ 的蚯蚓被切断。$9$ 只蚯蚓的长度分别为：$(1,4),3,5,5,2,5,4,6$。

$7$ 秒后：一只长度为 $6$ 的蚯蚓被切断。$10$ 只蚯蚓的长度分别为：$2,5,4,6,6,3,6,5,(2,4)$。所以，$7$ 秒内被切断的蚯蚓的长度依次为 $3,4,4,4,5,5,6$。$7$ 秒后，所有蚯蚓长度从大到小排序为 $6,6,6,5,5,4,4,3,2,2$。

**样例解释 2**

这个数据中只有 $t=2$ 与上个数据不同。只需在每行都改为每两个数输出一个数即可。

虽然第一行最后有一个 $6$ 没有被输出，但是第二行仍然要重新从第二个数再开始输出。

**样例解释 3**

这个数据中只有 $t=9$ 与上个数据不同。

注意第一行没有数要输出，但也要输出一个空行。


**数据范围**

![](https://cdn.luogu.com.cn/upload/pic/3458.png)


## 样例 #1

### 输入

```
3 7 1 1 3 1
3 3 2```

### 输出

```
3 4 4 4 5 5 6
6 6 6 5 5 4 4 3 2 2```

## 样例 #2

### 输入

```
3 7 1 1 3 2
3 3 2```

### 输出

```
4 4 5
6 5 4 3 2```

## 样例 #3

### 输入

```
3 7 1 1 3 9
3 3 2```

### 输出

```
//空行
2```

# AI分析结果



# 【算法分类】  
队列

---

# 【题解思路与解决难点】  

**核心思路**  
所有蚯蚓切割后的两段具有单调性。维护三个队列：  
1. `q1`：未切割的原始蚯蚓（初始排序后）  
2. `q2`：切割后的左段（`⌊px⌋`）  
3. `q3`：切割后的右段（`x - ⌊px⌋`）  

通过记录全局偏移量 `delta` 处理蚯蚓的集体增长，每次操作时：  
- 取出三个队列队首的最大值  
- 计算真实长度（当前偏移量补偿）  
- 将新切割的两段减去未来所有增量后入队  

**解决难点**  
1. **单调性证明**：通过数学证明切割后的两段长度在整数域上保持单调性  
2. **增量处理**：通过全局偏移量 `delta` 避免频繁修改所有元素  
3. **时间复杂度**：从 `O(m log m)` 优化到 `O(n log n + m)`  

---

# 【题解评分 ≥4星】  

1. **dbxxx（5星）**  
   - 提供完整的数学证明，修正了其他题解的伪证问题  
   - 代码简洁高效，使用三个队列与偏移量  
   - 关键代码段：  
     ```cpp  
     int x = get_max() + delta;  
     q2.push(x * u / v - delta - q);  
     q3.push(x - x * u / v - delta - q);  
     ```  

2. **7KByte（4星）**  
   - 详细注释与变量命名，适合初学者理解  
   - 使用三个队列的直观实现  
   - 调试心得："注意队列为空时的边界处理"  

3. **shadowice1984（4星）**  
   - 文字证明与代码分离，逻辑清晰  
   - 手写队列优化内存  
   - 关键优化：`front/rear` 指针代替STL队列  

---

# 【最优思路/技巧提炼】  

1. **三队列维护单调性**  
   - 原始队列排序后单调递减  
   - 切割后的两个队列通过数学保证单调性  

2. **全局偏移量技巧**  
   ```cpp  
   int delta = 0;  
   // 取出时补偿历史增量  
   real_length = stored_value + delta;  
   // 存入时扣除未来增量  
   new_value = (cut_length) - delta - q;  
   ```  

3. **整数域单调性推导**  
   ```  
   ∀x₁≥x₂∈ℤ, x₁-⌊px₁⌋ ≥ x₂-⌊px₂⌋  
   ```  

---

# 【同类型题推荐】  

1. **P1090 合并果子**（优先队列）  
2. **P6033 合并果子 加强版**（桶排序优化）  
3. **P2278 操作系统**（调度队列模拟）  

---

# 【可视化设计】  

**动画方案**  
1. **像素风格Canvas**  
   - 三个队列用不同颜色方块（红/绿/蓝）  
   - 当前操作的蚯蚓高亮黄色  
   - 切割时生成两个小方块飞向对应队列  

2. **关键步骤标记**  
   - 偏移量 `delta` 显示为顶部计数器  
   - 每次切割后播放8-bit音效  

3. **AI自动演示**  
   ```js  
   function autoStep() {  
     if (step < m) {  
       selectMaxQueue();  
       cutAndEnqueue();  
       requestAnimationFrame(autoStep);  
     }  
   }  
   ```  

**复古交互**  
- 方向键控制单步/自动模式  
- 失败音效：`new Audio('error.wav')`  

---

# 【核心代码片段】  

**dbxxx题解的关键实现**  
```cpp  
// 全局偏移量记录  
int delta = 0;  
for (int i = 1; i <= m; ++i) {  
    // 取出最大值  
    int x = get_max_from_queues() + delta;  
    // 切割计算  
    int left = x * u / v;  
    int right = x - left;  
    // 存入新队列（扣除未来增量）  
    q2.push(left - delta - q);  
    q3.push(right - delta - q);  
    // 更新偏移量  
    delta += q;  
}  
```

---

# 【总结】  

通过三队列维护切割后的单调性，结合全局偏移量技巧，将时间复杂度从 `O(m log m)` 优化到线性。关键突破在于数学证明切割段的单调性，此技巧可拓展至类似需要动态维护极值且操作具有单调性的场景。

---
处理用时：64.39秒
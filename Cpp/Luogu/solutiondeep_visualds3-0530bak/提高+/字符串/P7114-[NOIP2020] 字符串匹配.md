# 题目信息

# [NOIP2020] 字符串匹配

## 题目描述

小 C 学习完了字符串匹配的相关内容，现在他正在做一道习题。

对于一个字符串 $S$，题目要求他找到 $S$ 的所有具有下列形式的拆分方案数：

$S = ABC$，$S = ABABC$，$S = ABAB \ldots ABC$，其中 $A$，$B$，$C$ 均是非空字符串，且 $A$ 中出现奇数次的字符数量不超过 $C$ 中出现奇数次的字符数量。

更具体地，我们可以定义 $AB$ 表示两个字符串 $A$，$B$ 相连接，例如 $A = \texttt{aab}$，$B = \texttt{ab}$，则 $AB = \texttt{aabab}$。

并递归地定义 $A^1=A$，$A^n = A^{n - 1} A$（$n \ge 2$ 且为正整数）。例如 $A = \texttt{abb}$，则 $A^3=\texttt{abbabbabb}$。

则小 C 的习题是求 $S = {(AB)}^iC$ 的方案数，其中 $F(A) \le F(C)$，$F(S)$ 表示字符串 $S$ 中出现奇数次的字符的数量。两种方案不同当且仅当拆分出的 $A$、$B$、$C$ 中有至少一个字符串不同。

小 C 并不会做这道题，只好向你求助，请你帮帮他。

## 说明/提示

**【样例 #1 解释】**

对于第一组数据，所有的方案为

1. $A=\texttt{n}$，$B=\texttt{nr}$，$C=\texttt{nnr}$。
2. $A=\texttt{n}$，$B=\texttt{nrn}$，$C=\texttt{nr}$。
3. $A=\texttt{n}$，$B=\texttt{nrnn}$，$C=\texttt{r}$。
4. $A=\texttt{nn}$，$B=\texttt{r}$，$C=\texttt{nnr}$。
5. $A=\texttt{nn}$，$B=\texttt{rn}$，$C=\texttt{nr}$。
6. $A=\texttt{nn}$，$B=\texttt{rnn}$，$C=\texttt{r}$。
7. $A=\texttt{nnr}$，$B=\texttt{n}$，$C=\texttt{nr}$。
8. $A=\texttt{nnr}$，$B=\texttt{nn}$，$C=\texttt{r}$。

**【数据范围】**

| 测试点编号 | $\lvert S \rvert \le$ | 特殊性质 |
|:-:|:-:|:-:|
| $1 \sim 4$ | $10$ | 无 |
| $5 \sim 8$ | $100$ | 无 |
| $9 \sim 12$ | $1000$ | 无 |
| $13 \sim 14$ | $2^{15}$ | $S$ 中只包含一种字符 |
| $15 \sim 17$ | $2^{16}$ | $S$ 中只包含两种字符 |
| $18 \sim 21$ | $2^{17}$ | 无 |
| $22 \sim 25$ | $2^{20}$ | 无 |

对于所有测试点，保证 $1 \le T \le 5$，$1 \le |S| \le 2^{20}$。 

## 样例 #1

### 输入

```
3
nnrnnr
zzzaab
mmlmmlo
```

### 输出

```
8
9
16
```

## 样例 #2

### 输入

```
5
kkkkkkkkkkkkkkkkkkkk
lllllllllllllrrlllrr
cccccccccccccxcxxxcc
ccccccccccccccaababa
ggggggggggggggbaabab
```

### 输出

```
156
138
138
147
194
```

## 样例 #3

### 输入

```
见附件中的 string/string3.in```

### 输出

```
见附件中的 string/string3.ans```

## 样例 #4

### 输入

```
见附件中的 string/string4.in```

### 输出

```
见附件中的 string/string4.ans```

# AI分析结果



### 唯一算法分类
**字符串处理（扩展KMP）**

---

### 综合分析与结论
本题核心在于快速识别字符串的循环节结构，并高效统计奇偶字符数。题解主要采用以下思路：
1. **扩展KMP算法**（Z函数）快速识别循环节长度
2. **树状数组/桶数组**维护前缀奇偶字符统计
3. **奇偶性分组优化**：利用循环节重复次数奇偶性统一处理
4. **哈希+调和级数枚举**作为替代方案

**核心算法流程**：
1. 预处理Z函数确定每个位置的最长匹配前缀
2. 枚举AB长度，计算最大循环次数
3. 维护前缀奇偶字符数的动态统计
4. 分组计算奇数次循环和偶数次循环的贡献

**可视化设计思路**：
- **Z函数构建**：用不同颜色标记匹配窗口，动态展示最长公共前缀扩展过程
- **循环节验证**：用闪烁效果高亮当前AB段，对比后续循环段
- **奇偶统计**：用进度条式UI展示前缀字符奇偶变化，红色表示奇数次字符增加，蓝色减少
- **树状数组更新**：用堆叠方块表示桶数组，动态展示插入和查询过程

---

### 题解清单（评分≥4星）
1. **泥土笨笨（4.5星）**
   - 亮点：图文并茂的Z函数解析，清晰的奇偶分组优化思路，完整复杂度分析
   - 代码：扩展KMP与树状数组结合，处理奇偶贡献分组
   - 个人心得：通过图解说明循环节判断原理，降低理解难度

2. **xtx1092515503（4星）**
   - 亮点：严格的O(n)复杂度实现，指针维护奇偶变化
   - 代码：利用Z函数+双指针维护桶数组，避免树状数组的log开销

3. **George1123（4星）**
   - 亮点：自然溢出哈希+树状数组，代码简洁易实现
   - 技巧：哈希快速验证循环节，调和级数枚举优化

---

### 关键代码实现
**核心逻辑片段（泥土笨笨题解）**
```cpp
// Z函数预处理循环节
void Z() {
    z[0] = n;
    int now = 0;
    while (now + 1 < n && s[now] == s[now + 1]) now++;
    z[1] = now;
    int p0 = 1;
    for (int i = 2; i < n; ++i) {
        if (i + z[i - p0] < p0 + z[p0]) z[i] = z[i - p0];
        else {
            now = max(p0 + z[p0] - i, 0);
            while (now + i < n && s[now] == s[now + i]) now++;
            z[i] = now;
            p0 = i;
        }
    }
}

// 奇偶贡献统计
for (int i = 0; i < n; ++i) {
    // 更新后缀奇偶统计
    if (after[s[i]-'a'] & 1) suf--;
    else suf++;
    after[s[i]-'a']--;
    
    // 更新树状数组
    update(pre + 1);
    ans += 奇数次贡献 + 偶数次贡献;
}
```

---

### 同类型题推荐
1. **P5410 【模板】扩展 KMP（Z 函数）** - 直接应用Z函数
2. **P3375 【模板】KMP** - 字符串匹配与循环节识别
3. **P1368 工艺** - 最小循环子串识别

---

### 可视化设计要点
**复古像素风格实现方案：**
1. **颜色方案**：使用16色调色板，AB段用绿色，C段用黄色，奇偶字符标记为红/蓝闪烁
2. **Canvas动画**：
   - 网格布局展示字符串字符
   - Z函数匹配时高亮当前比较的字符对
   - 树状数组更新时显示插入位置和查询范围
3. **音效设计**：
   - 字符匹配成功：8-bit "哔"声
   - 树状数组更新：短促点击声
   - 找到合法解：经典FC过关音效
4. **自动演示模式**：按AB长度逐步推进，展示循环节验证和统计过程

---

**总结**：本题解的核心在于结合扩展KMP快速识别循环结构，利用奇偶性分组减少统计次数，树状数组优化查询效率。可视化设计着重体现字符串匹配过程和奇偶统计的动态变化，通过复古风格增强学习趣味性。

---
处理用时：64.74秒
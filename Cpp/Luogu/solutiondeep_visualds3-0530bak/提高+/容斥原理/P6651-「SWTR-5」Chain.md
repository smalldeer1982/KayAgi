# 题目信息

# 「SWTR-5」Chain

## 题目描述

给定 $n$ 个点，$m$ 条边的有向无环图。不保证图连通。

$q$ 次询问，每次给出 $k$ 和 $k$ 个互不相同的数 $c_i$，求出如果去掉这 $k$ 个点，整个有向无环图将剩余多少条链。答案对 $10^9+7$ 取模。**每次询问独立。**

- “链”的定义是：我们设一条长度为 $p$ 的链的路径为 $w_0\to w_1\to\cdots\to w_{p-1}\to w_p$，则应满足 $w_0$ 入度为 $0$，$w_p$ 出度为 $0$。你可以将其理解为一条食物链。

- 两条链是“不同的”，当且仅当它们的长度不同，或者经过的点集不同。

- **需要特别注意的是，删去某些点后新产生的链不计入答案。** 例如 $1\to 2\to 3\to 4$ 一图中，有 $1$ 条链 $1\to 2\to 3\to 4$。如果去掉 $2$ 号点，则剩余 $0$ 条链。

## 说明/提示

「样例 $1$ 说明」

DAG 如图：

![](https://cdn.luogu.com.cn/upload/image_hosting/2gbdoemh.png)

询问 $1$：如果去掉 $2,4,6$，则剩余 $1$ 条链：$3\to 5$。

询问 $2$：如果去掉 $4,6$，则剩余 $3$ 条链：$3\to 5$，$3\to 2\to 5$，$3\to 7\to 2\to 5$。

询问 $7$：如果去掉 $6$，则剩余 $5$ 条链：$3\to 5$，$3\to 2\to 5$，$3\to 7\to 2\to 5$，$3\to 1\to 4\to 5$，$3\to 7\to 4\to 5$。

「数据范围与约定」

**本题采用捆绑测试。**

- Subtask 1（1 point）：给定的图是一条链。
- Subtask 2（14 points）：$n,q\leq 10$。
- Subtask 3（20 points）：$q\leq 10^3$。
- Subtask 4（17 points）：$k=1$。
- Subtask 5（18 points）：$k=2$。
- Subtask 6（30 points）：无特殊限制。

对于 $100\%$ 的数据：$2\leq n\leq 2\times 10^3$，$1\leq m\leq \min(\frac{n\times(n-1)}{2},2\times 10^4)$，$1\leq q\leq 5\times 10^5$。  
所有询问满足：$1\leq \sum k\leq 2\times 10^6$，$0\leq k\leq \min(n,15)$，$1\leq c_i\leq n$。保证 $c_i$ 互不相同。

**本题轻微卡常，请注意 IO 优化。**

---

「题目来源」

[Sweet Round 05](https://www.luogu.com.cn/contest/28195) D。  
idea & solution：[Alex_Wei](https://www.luogu.com.cn/user/123294)。

## 样例 #1

### 输入

```
7 14
3 2
4 5
2 5
2 6
3 1
3 5
3 7
3 6
6 4
1 4
6 5
1 6
7 2
7 4
7
3 2 4 6
2 4 6
2 2 5
2 1 4
0
1 4
1 6```

### 输出

```
1
3
0
6
13
7
5```

## 样例 #2

### 输入

```
233 1
1 2
6
0
1 10
2 10 40
1 1
1 2
2 1 2```

### 输出

```
232
231
230
231
231
231```

# AI分析结果



## 算法分类
**拓扑排序 + 动态规划 + 容斥**

---

## 综合分析与结论

### 核心思路
1. **预处理路径数**：利用拓扑排序计算每个点作为起点到所有其他点的路径数，以及每个点到终点的路径数（`f[i]` 和 `nf[i]`）。
2. **删除点容斥**：将删除的点按拓扑序排序后，通过动态调整每个点的贡献（减去其前置点的路径影响），避免重复计算。
3. **快速查询**：每次查询时，通过预处理的数据和排序后的删除点列表，以 $O(k^2)$ 的复杂度快速计算答案。

### 解决难点
- **避免重复计算**：通过按拓扑序排序删除点，确保每个点仅处理一次，且前置点的贡献已修正。
- **高效处理多删除点**：利用容斥原理和动态规划，将复杂度的瓶颈控制在 $O(k^2)$，而非指数级。

### 可视化设计
1. **拓扑排序过程**：以网格动画展示拓扑队列的推进，高亮当前处理节点及其出边。
2. **路径数计算**：用颜色标记每个点的 `f[i]` 和 `nf[i]` 值，动态更新数值变化。
3. **删除点调整**：按拓扑序排列删除点，逐步高亮每个点，并显示其贡献调整过程（如 `ans -= f[i] * nf[i]`）。
4. **复古像素风格**：
   - **颜色方案**：入度为0的节点用绿色，出度为0的用红色，删除点用闪烁效果。
   - **音效**：节点删除时播放“哔”声，路径调整时播放短促音效。
   - **自动演示**：自动按拓扑序执行步骤，用户可暂停观察当前状态。

---

## 题解评分（≥4星）

### 1. 作者：a___（⭐⭐⭐⭐⭐）
- **关键亮点**：代码简洁，预处理 `f` 和 `g`（即 `nf`），通过排序和动态规划高效调整贡献。
- **核心代码**：
  ```cpp
  sort(c+1,c+1+m,cmp); // 按拓扑序排序
  for(i=1;i<=m;i++)d[i]=f[c[i]]; // 初始化动态数组
  for(i=1;i<=m;i++) // 动态调整贡献
    for(j=i+1;j<=m;j++)
      d[j]=(d[j]-1ll*d[i]*h[c[i]][c[j]]%p+p)%p;
  ```

### 2. 作者：EnofTaiPeople（⭐⭐⭐⭐）
- **关键亮点**：引入超级源汇点简化计算，预处理路径矩阵 `Got`，代码结构清晰。
- **核心代码**：
  ```cpp
  for(ai=1;ai<=k;++ai){
    ans[ai]=onto[ask[ai]];
    for(i=1;i<ai;++i) // 按拓扑序调整
      ans[ai]-=ans[i]*Got[ask[i]][ask[ai]];
    sum=(sum-ans[ai]*znto[ask[ai]]%M)%M;
  }
  ```

### 3. 作者：yxzy4615（⭐⭐⭐⭐）
- **关键亮点**：详细推导容斥公式，通过矩阵 `d[i][j]` 处理路径相交情况，适合理解原理。
- **核心公式**：
  $$
  ans = s - \sum_{i=1}^k (f_i - \sum_{j<i} f_j \cdot d_{j,i}) \cdot nf_i
  $$

---

## 最优思路提炼
1. **预处理路径矩阵**：通过拓扑排序计算所有点对之间的路径数，时间复杂度 $O(nm)$。
2. **按拓扑序处理删除点**：确保每个点的贡献调整仅依赖已处理的前置点。
3. **动态调整贡献**：对每个删除点 $c_i$，通过减去其前置点的影响（`d[j] -= d[i] * d[c_i][c_j]`）避免重复计算。

---

## 类似题目推荐
1. **P3387【模板】缩点**：DAG 上的强连通分量与路径计数。
2. **P4017 最大食物链计数**：与本题链计数高度相似，仅需处理单次查询。
3. **P2741 [USACO4.4] 重叠的图像**：拓扑排序与动态规划结合的应用。

---

## 个人心得摘录
- **调试教训**：删除点必须按拓扑序处理，否则会漏掉某些路径调整（作者：a___）。
- **顿悟点**：引入超级源汇点后，问题简化为计算超级源到超级汇的路径数（作者：EnofTaiPeople）。

---

## 可视化算法演示（伪代码）
```javascript
// 初始化拓扑排序队列
function initTopo() {
  queue = all nodes with in-degree 0;
  while (queue not empty) {
    u = queue.pop();
    highlight(u, 'green'); // 当前处理节点
    for (v in u.edges) {
      updatePathCount(u, v); // 更新路径数矩阵
      if (v.in-degree == 0) queue.push(v);
    }
  }
}

// 处理删除点
function processDeletion(nodes) {
  nodes.sortByTopoOrder();
  for (i = 0; i < nodes.length; i++) {
    node = nodes[i];
    highlight(node, 'red'); // 当前删除点
    for (j = i+1; j < nodes.length; j++) {
      adjustContribution(node, nodes[j]); // 显示贡献调整
      playSound('adjust');
    }
  }
}
```

---
处理用时：65.35秒
# 题目信息

# [SHOI2009] 会场预约

## 题目背景

## 形式化描述

你需要维护一个在数轴上的线段的集合 $S$，支持两种操作：

`A l r` 表示将 $S$ 中所有与线段 $[l,r]$ 相交的线段删去，并将 $[l,r]$ 加入 $S$ 中。

`B` 查询 $S$ 中的元素数量。

对于 `A` 操作，每次还需输出删掉的元素个数。

## 题目描述

PP 大厦有一间空的礼堂，可以为企业或者单位提供会议场地。

这些会议中的大多数都需要连续几天的时间（个别的可能只需要一天），不过场地只有一个，所以不同的会议的时间申请不能够冲突。也就是说，前一个会议的结束日期必须在后一个会议的开始日期之前。所以，如果要接受一个新的场地预约申请，就必须拒绝掉与这个申请相冲突的预约。

一般来说，如果 PP 大厦方面事先已经接受了一个会场预约（例如从 $10$ 日到 $15$ 日），就不会再接受与之相冲突的预约（例如从 $12$ 日到 $17$ 日）。

不过，有时出于经济利益，PP 大厦方面有时会为了接受一个新的会场预约，而拒绝掉一个甚至几个之前预订的预约。 于是，礼堂管理员 QQ 的笔记本上经常记录着这样的信息：（本题中为方便起见，所有的日期都用一个整数表示）例如，如果一个为期 $10$ 天的会议从 $90$ 日开始到 $99$ 日，那么下一个会议最早只能在 $100$ 日开始。（此处前后矛盾，若无法理解请参考形式化描述。）

最近，这个业务的工作量与日俱增，礼堂的管理员 QQ 希望参加 SHTSC 的你替他设计一套计算机系统，方便他的工作。这个系统应当能执行下面两个操作：

`A` 操作：有一个新的预约是从 $start$ 日到 $end$ 日，并且拒绝掉所有与它相冲突的预约。执行这个操作的时候，你的系统应当返回为了这个新预约而拒绝掉的预约个数，以方便 QQ 与自己的记录相校对。

`B` 操作：请你的系统返回当前的仍然有效的预约的总数。

## 说明/提示

【数据范围】  
对于 $100\%$ 的数据，$1\le n \le 2\times 10^5$，$1\le l \le r \le 10^5$。

## 样例 #1

### 输入

```
6
A 10 15
A 17 19
A 12 17
A 90 99
A 11 12
B```

### 输出

```
0
0
2
0
1
2```

# AI分析结果



# 平衡树/线段树染色

## 综合分析与结论

**核心思路**：  
题目需要维护不相交的区间集合，每次插入新区间时删除所有相交的旧区间。核心难点在于快速定位和删除相交区间，常见解法包括：

1. **平衡树**：维护按端点排序的区间，利用前驱/后继定位删除范围，时间复杂度 O(nlogn)。
2. **线段树染色**：将区间染色，查询时统计覆盖颜色数并清除，批量处理相交区间。
3. **树状数组+二分**：记录区间端点，通过二分查找确定删除范围。

**核心算法流程**：  
以平衡树为例：  
1. 插入新区间 [L,R]  
2. 找到最后一个结束点 < L 的前驱区间  
3. 找到第一个开始点 > R 的后继区间  
4. 删除介于前驱与后继之间的所有区间（必然与 [L,R] 相交）  
5. 统计删除数量，插入新区间  

**可视化设计**：  
- **动画效果**：用像素方块表示区间，插入时高亮覆盖区域，删除时触发闪烁和音效  
- **颜色标记**：平衡树节点用不同颜色区分，分裂/合并时显示红蓝光晕  
- **控制面板**：支持单步执行插入/删除，调节动画速度  
- **8位音效**：插入时播放"滴"声，删除时播放爆炸音效，背景音乐采用8位芯片音乐  

## 题解清单（≥4星）

### 1. STL set 解法（4⭐）  
**作者**：Nartsam  
**亮点**：利用set自动排序特性，重载运算符将相交区间视为相等。  
```cpp
struct Plan{ int l,r; bool operator <(const Plan &rhs)const{ return r<rhs.l; } };
set<Plan> s;
// 插入时循环查找并删除相交区间
while(s.find(tmp) != s.end()) s.erase(it);
```

### 2. 线段树染色（4⭐）  
**作者**：香风智乃  
**亮点**：将预约视为颜色，统计覆盖区域颜色数并清除。  
```cpp
void modify(int p,int x,int y,int k){
    if(覆盖区间){ 染色并更新标记 }
    push_down(p);
    modify(左子区间); modify(右子区间);
    push_up(p); // 合并颜色状态
}
```

### 3. FHQ Treap平衡树（5⭐）  
**作者**：Melacau  
**亮点**：通过分裂操作快速定位需删除区间范围。  
```cpp
void split(int o,int k,int &x,int &y){
    if(!o) x=y=0;
    else if(判断分裂位置) split(右子树,k,x,y), 连接左子树;
    else split(左子树,k,x,y), 连接右子树;
}
```

## 最优思路提炼

1. **区间碰撞检测**：通过端点比较快速判断区间相交（a.end >= b.start && a.start <= b.end）  
2. **批量删除优化**：平衡树通过分裂操作一次性删除连续区间，避免逐个查找  
3. **染色覆盖思想**：将区间操作转化为颜色标记，利用线段树天然区间处理能力  

## 同类型题拓展

- **区间合并**：P2082 区间覆盖（加强版）  
- **动态区间维护**：P2894 [USACO08FEB]Hotel G（线段树染色经典题）  
- **平衡树应用**：P2286 [HNOI2004]宠物收养场（前驱/后继查找）  

## 推荐练习题

1. P2082 区间覆盖（统计最小区间覆盖数）  
2. P2894 Hotel（线段树区间染色与查询）  
3. P3369 普通平衡树（平衡树基础操作）  

## 个人心得摘录

> "STL的find函数在自定义结构体时要特别注意比较逻辑，相交的区间必须被判定为相等才能批量删除。" —— Nartsam  
> "线段树染色法的核心在于颜色标记的合并策略，处理左右子树颜色衔接是关键。" —— 香风智乃  

## 可视化方案（8位像素风格）

**Canvas绘制**：  
1. 横向时间轴表示数轴，区间用彩色方块表示  
2. 插入新区间时显示绿色闪烁，碰撞检测时红色高亮旧区间  
3. 平衡树分裂过程用蓝色光晕表示左右子树分离  

**音效设计**：  
- 插入成功：8-bit "升级"音效  
- 删除区间：爆炸音效+得分增长声  
- 背景音乐：《Mega Man》风格循环曲  

**AI演示模式**：  
- 自动生成随机区间插入，展示平衡树动态调整过程  
- 单步调试时可暂停查看当前树结构和区间分布  

---

通过以上分析与可视化设计，可直观理解区间维护的核心算法，不同解法的优劣一目了然。

---
处理用时：73.80秒
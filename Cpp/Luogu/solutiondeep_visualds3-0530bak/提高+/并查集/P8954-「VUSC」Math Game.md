# 题目信息

# 「VUSC」Math Game

## 题目背景

**upd 2023.1.22**：新增一组 Hack 数据 by @[MCRS_lizi](https://www.luogu.com.cn/user/585805)。

远在哞利坚的 Bessie 也要在新春之际走亲访友！为了打发时间，她常和 Farmer John 玩一个有趣的数字游戏。

## 题目描述

Farmer John 有一个集合 $S$，集合初始为 $\{2,3,4,...,N\}$。

对于两个**在集合 $S$ 内的**正整数 $p,q$，我们称它们为「一对好数」当且仅当 $p^k=q(k\ge 2\land k\in\N)$。

我们将每个 $S$ 中的数看成一张**无向图**中的节点，对于每一对「好数」，我们在这两个数间连一条无向边。

Farmer John 会进行 $Q$ 次操作，操作有以下两种：

1. 给出 $x$，询问结点 $x$ 所在的连通块大小。
2. 给出 $x$，从 $S$ 中移除 $x$。**与此同时，无向图中的结点 $x$ 也被移除。**

由于 Bessie 的速度太慢了，她想要你来帮忙。

## 说明/提示

#### 【样例解释】

这是原始无向图（上面一排都是孤点）：
![](https://cdn.luogu.com.cn/upload/image_hosting/utsz04dt.png)

这是进行第一次操作 $2$ 后的无向图（删除了结点 $9$）：
![](https://cdn.luogu.com.cn/upload/image_hosting/wmexc9ks.png)

这是进行第二次操作 $2$ 后的无向图（删除了结点 $2$）：
![](https://cdn.luogu.com.cn/upload/image_hosting/9mi0l18p.png)

---

#### 【数据范围】

全部数据满足：
- $2\le N \le 10^{18}$
- $1\le Q \le 10^6$
- $x_i\in S$
- $op_i \in \{1,2\}$

测试点 $1\sim2$ 另外满足 $2\le N \le 10^5$，$1\le Q \le 10^4$。

测试点 $3\sim4$ 另外满足所有 $x_i=m^{p_i}$，其中 $m$ 为一满足 $m\ge 2 \land m\in \N$ 的**常数**。

测试点 $5\sim10$ 没有额外限制。


## 样例 #1

### 输入

```
30 6
1 6
1 4
2 9
1 3
2 2
1 16```

### 输出

```
1
4
2
2```

# AI分析结果



**唯一算法分类**：并查集 + 时间倒流 + 离散化

---

### **综合分析与结论**
**核心思路**  
题目要求动态维护连通块大小，难点在于处理大范围数据（$N \le 10^{18}$）和删除操作。所有题解的核心思路是：  
1. **预处理每个数的最小基底**：将每个数表示为 $p^k$ 的形式（$p$ 尽量小），从而将连通块抽象为以基底为中心的树状结构。  
2. **时间倒流处理删除**：将删除操作逆转为添加操作，利用并查集维护连通块合并。  
3. **离散化优化空间**：对涉及的基底进行离散化，避免直接处理 $10^{18}$ 规模的数。

**解决难点**  
- **如何高效找到最小基底**：通过预处理三次方和平方数，结合二分或数学推导快速判断。  
- **动态维护连通块**：时间倒流将删除转化为添加，结合并查集的按秩合并优化时间复杂度。  
- **离散化处理**：仅对操作中涉及的基底进行离散化，大幅减少空间占用。

**可视化设计思路**  
- **动画方案**：  
  1. **基底树状图**：展示每个数的基底结构（如 $8=2^3$，基底为 $2$）。  
  2. **时间倒流动画**：从后往前执行操作，添加节点时动态合并连通块，高亮当前操作的节点和合并路径。  
  3. **像素风格演示**：用 8-bit 风格网格表示基底树，每个节点显示其幂次，合并时播放音效。  
- **交互设计**：  
  - **步进控制**：允许调整时间倒流速度，单步观察合并过程。  
  - **音效触发**：合并成功时播放上扬音效，删除（逆向添加）时播放“方块放置”音效。  

---

### **题解清单 (≥4星)**
1. **STUDENT00 (5星)**  
   - **亮点**：完整的时间倒流框架，离散化 + 并查集的优雅实现，预处理基底树的结构。  
   - **代码可读性**：清晰的结构化代码，注释详细。  
2. **Moeebius (5星)**  
   - **亮点**：出题人题解，严格优化基底预处理，利用 `__int128` 避免溢出。  
   - **优化程度**：通过离线处理和时间倒流实现 $O(Q \log N)$ 复杂度。  
3. **enucai (4星)**  
   - **亮点**：在线动态查询，利用 `set` 快速判断删除，预处理三次方数加速。  
   - **实践性**：代码简洁，适合小规模数据。  

---

### **最优思路与技巧提炼**
1. **时间倒流 + 离散化**：将删除转化为添加，避免动态维护连通块的复杂性。  
2. **基底树结构**：将每个数表示为最小基底 $p^k$，连通块由基底及其幂次构成。  
3. **按幂次离散化**：对每个基底 $p$，按幂次建立并查集，如 $fa[p][k]$ 表示 $p^k$ 的父节点。  
4. **预处理三次方**：对 $k \ge 3$ 的基底，预处理 $[1,10^6]$ 的立方数加速查询。  

**代码片段（STUDENT00 题解核心）**  
```cpp
// 预处理每个数的 p^q 形式（p 最小）
for (int i=2; (ll)i*i*i <=n; i++) {
    lll tmp = i;
    for (int j=1; tmp <=n; j++) {
        if (indx.find(tmp) != indx.end() && indx[tmp].first == tmp)
            indx[tmp] = make_pair(i, j);
        tmp *= i;
    }
}

// 时间倒流合并并查集
for (int i=q; i>=1; i--) {
    if (op[i] == 1) ans.push_back(siz[id][find(id, power)]);
    else {
        del.erase(x[i]); // 逆向添加节点
        // 合并基底树中的父节点和子节点
        for (int j=2; j <= cnt/power; j++) 
            if (!del.count(tmp)) unnion(id, power, power*j);
    }
}
```

---

### **同类型题目推荐**
1. **P2147 [SDOI2008] 洞穴勘测**：动态维护图的连通性。  
2. **P3224 [HNOI2012] 永无乡**：并查集 + 启发式合并。  
3. **P3295 [SCOI2016] 萌萌哒**：数学基底 + 并查集优化。  

---

### **个人心得摘录**
- **STUDENT00**：  
  > “不能将自己死锁在 STL map 的范围内，而应灵活运用离散化。”  
- **MCRS_lizi**：  
  > “向上跳的时候遇到被删的基底需继续搜索，虽然麻烦但时间复杂度可控。”  

---

### **复古像素化可视化设计**
1. **8-bit 风格**：  
   - **颜色方案**：基底用绿色，删除节点用红色，合并路径用黄色闪烁。  
   - **Canvas 绘制**：基底树以网格布局，每个节点显示 $p^k$，合并时绘制连线。  
2. **音效设计**：  
   - **合并成功**：8-bit 上扬音效（类似马里奥吃金币）。  
   - **节点删除**：短促“哔”声。  
3. **AI 自动演示**：  
   - **自动播放模式**：按时间倒流顺序执行操作，动态更新基底树。  
   - **连击奖励**：连续正确操作触发加分和特效。  

**交互代码片段（伪代码）**  
```javascript
// Canvas 绘制基底树
function drawTree(base) {
    ctx.fillStyle = "#00FF00"; // 基底绿色
    ctx.fillRect(x, y, 20, 20);
    ctx.fillText(`${base}^${power}`, x+5, y+15);
}

// 时间倒流动画
function reversePlay() {
    for (let i = ops.length - 1; i >= 0; i--) {
        highlightCurrentOp(ops[i]);
        if (ops[i].type === 'add') mergeNodes(ops[i].x);
        playSound('merge_sound.wav');
        await sleep(speed);
    }
}
```

---
处理用时：91.33秒
# 题目信息

# [NOIP 2009 提高组] 最优贸易

## 题目背景

本题原题数据极弱，Subtask 0 中的测试点为原题测试点，Subtask 1 中的测试点为 Hack 数据。

## 题目描述

$C$ 国有 $n$ 个大城市和 $m$ 条道路，每条道路连接这 $n$ 个城市中的某两个城市。任意两个城市之间最多只有一条道路直接相连。这 $m$ 条道路中有一部分为单向通行的道路，一部分为双向通行的道路，双向通行的道路在统计条数时也计为 $1$ 条。

$C$ 国幅员辽阔，各地的资源分布情况各不相同，这就导致了同一种商品在不同城市的价格不一定相同。但是，同一种商品在同一个城市的买入价和卖出价始终是相同的。

商人阿龙来到 $C$ 国旅游。当他得知同一种商品在不同城市的价格可能会不同这一信息之后，便决定在旅游的同时，利用商品在不同城市中的差价赚回一点旅费。设 $C$ 国 $n$ 个城市的标号从 $1\sim n$，阿龙决定从 $1$ 号城市出发，并最终在 $n$ 号城市结束自己的旅行。在旅游的过程中，任何城市可以重复经过多次，但不要求经过所有 $n$ 个城市。阿龙通过这样的贸易方式赚取旅费：他会选择一个经过的城市买入他最喜欢的商品――水晶球，并在之后经过的另一个城市卖出这个水晶球，用赚取的差价当做旅费。由于阿龙主要是来 $C$ 国旅游，他决定这个贸易只进行最多一次，当然，在赚不到差价的情况下他就无需进行贸易。

假设 $C$ 国有 $5$ 个大城市，城市的编号和道路连接情况如下图，单向箭头表示这条道路为单向通行，双向箭头表示这条道路为双向通行。

![](https://cdn.luogu.com.cn/upload/image_hosting/flre534z.png)

假设 $1\sim n$ 号城市的水晶球价格分别为 $4,3,5,6,1$。

阿龙可以选择如下一条线路：$1\to2\to3\to5$，并在 $2$ 号城市以 $3$ 的价格买入水晶球，在 $3$ 号城市以 $5$ 的价格卖出水晶球，赚取的旅费数为 $2$。

阿龙也可以选择如下一条线路：$1\to4\to5\to4\to5$，并在第 $1$ 次到达 $5$ 号城市时以 $1$ 的价格买入水晶球，在第 $2$ 次到达 $4$ 号城市时以 $6$ 的价格卖出水晶球，赚取的旅费数为 $5$。

现在给出 $n$ 个城市的水晶球价格，$m$ 条道路的信息（每条道路所连接的两个城市的编号以及该条道路的通行情况）。请你告诉阿龙，他最多能赚取多少旅费。

## 说明/提示

【数据范围】

输入数据保证 $1$ 号城市可以到达 $n$ 号城市。

对于 $10\%$ 的数据，$1\leq n\leq 6$。

对于 $30\%$ 的数据，$1\leq n\leq 100$。

对于 $50\%$ 的数据，不存在一条旅游路线，可以从一个城市出发，再回到这个城市。

对于 $100\%$ 的数据，$1\leq n\leq 100000$，$1\leq m\leq 500000$，$1\leq  x,y\leq  n$，$1\leq  z\leq  2$，$1\leq $ 各城市的编号 $\leq  n$。

水晶球价格 $\leq 100$。

NOIP 2009 提高组 第三题

## 样例 #1

### 输入

```
5 5 
4 3 5 6 1 
1 2 1 
1 4 1 
2 3 2 
3 5 1 
4 5 2 ```

### 输出

```
5```

# AI分析结果



# [NOIP 2009 提高组] 最优贸易

**算法分类**：其他搜索（分层图/BFS/SPFA）

---

## 题解思路与难点对比

### 核心思路
1. **分层图模型**（最优解法）  
   - 将原图复制为三层，分别表示**未买**、**已买未卖**、**已卖**状态  
   - 层间转移：  
     - 第一层 → 第二层：边权为负买入价（`-w[i]`）  
     - 第二层 → 第三层：边权为正卖出价（`w[i]`）  
   - 答案转化为第一层起点到第三层终点的最长路径  
   - 使用 SPFA 求最长路（存在负权边）

2. **Tarjan缩点+DP**  
   - 缩点后每个强连通分量记录最大/最小价格  
   - 正向计算最小买入价，反向计算最大卖出价  
   - 需预处理每个点是否可达起点和终点

3. **双向SPFA**  
   - 正向计算到每个点的最小买入价  
   - 反向计算到每个点的最大卖出价  
   - 遍历所有点求最大差值

### 难点对比
| 方法          | 难点                                                                 | 优势                          |
|---------------|----------------------------------------------------------------------|-------------------------------|
| 分层图        | 正确构建三层图结构，处理层间转移逻辑                                 | 模型直观，代码简洁（40行内） |
| Tarjan+DP     | 缩点后的DP顺序处理，反向图可达性判断                                 | 稳定线性复杂度               |
| 双向SPFA      | 两次图遍历的正确性，处理反向图结构                                   | 无需复杂预处理               |

---

## 题解评分（≥4星）

### 分层图解法（作者：fy1234567ok） ★★★★★  
- **亮点**：  
  1. 模型简洁，三层图结构清晰  
  2. 代码仅40行，使用 `t(x,i)` 宏简化分层逻辑  
  3. 通过 SPFA 求最长路，直接输出结果

### 双向SPFA（作者：Ngo123） ★★★★☆  
- **亮点**：  
  1. 两次 SPFA 分别处理正反图  
  2. 无需复杂缩点，实现直接  
  3. 预处理可达性判断优化计算

### Tarjan+DP（作者：ctym） ★★★★  
- **亮点**：  
  1. 强连通分量处理稳定  
  2. DAG 上 DP 保证无后效性  
  3. 反向图预处理提升效率  

---

## 最优思路提炼
**分层图模型**：  
1. **三层状态转移**：将买卖操作抽象为层间转移，确保只买卖一次  
2. **边权设计**：层内移动边权为0，跨层边权对应价格变化  
3. **最长路求解**：通过 SPFA 处理负权边，最终结果即为最大利润  

---

## 同类题目推荐
1. **[P4568 飞行路线](https://www.luogu.com.cn/problem/P4568)**（分层图最短路）  
2. **[P2939 [USACO09FEB]Revamping Trails G](https://www.luogu.com.cn/problem/P2939)**（分层图优化）  
3. **[P5663 加工零件](https://www.luogu.com.cn/problem/P5663)**（状态分层+BFS）

---

## 代码实现（分层图核心）
```cpp
#include<bits/stdc++.h>
using namespace std;
const int maxn = 1e5 + 5;
vector<pair<int, int>> G[maxn*3];
#define t(x,i) (x + i * n)

void add(int x, int y) { // 层内连边
    G[t(x,0)].push_back({t(y,0), 0});
    G[t(x,1)].push_back({t(y,1), 0});
    G[t(x,2)].push_back({t(y,2), 0});
}

int main() {
    int n, m; cin >> n >> m;
    for(int i=1, v; i<=n; ++i) {
        cin >> v;
        G[t(i,0)].push_back({t(i,1), -v}); // 买入
        G[t(i,1)].push_back({t(i,2), v});  // 卖出
    }
    for(int i=1,x,y,z; i<=m; ++i) {
        cin >> x >> y >> z;
        add(x, y);
        if(z == 2) add(y, x);
    }
    // SPFA求最长路（代码略）
    cout << d[t(n,2)]; // 输出第三层终点
}
```

---

## 可视化设计（分层图SPFA）

### 动画方案
1. **节点分层**：  
   - 用不同颜色区分三层（蓝/绿/红）  
   - 当前激活节点高亮黄色边框  
2. **边权显示**：  
   - 层内边显示为灰色（权值0）  
   - 跨层边显示对应价格（红色负值，绿色正值）  
3. **队列过程**：  
   - 队列用浮动面板显示，当前处理节点闪烁  
   - 路径追溯用半透明连线标记  

### 复古像素风格
- **8位调色板**：  
  - 层颜色：蓝(#0000FF)、绿(#00FF00)、红(#FF0000)  
  - 激活节点：黄(#FFFF00)  
- **音效**：  
  - 节点入队：短促“滴”声  
  - 跨层转移：硬币掉落音效  
  - 找到终局：8-bit胜利旋律  

---

## 总结
分层图模型以清晰的状态转移和简洁的代码成为最优解，其核心在于将买卖操作抽象为层间跃迁，通过最长路求解全局最优。可视化设计通过分层颜色和动态队列展示，帮助理解 SPFA 在多层结构中的扩散过程。

---
处理用时：93.43秒
# 题目信息

# [NOIP 2017 提高组] 逛公园

## 题目背景

NOIP2017 D1T3

## 题目描述

策策同学特别喜欢逛公园。公园可以看成一张 $N$ 个点 $M$ 条边构成的有向图，且没有 自环和重边。其中 $1$ 号点是公园的入口，$N$ 号点是公园的出口，每条边有一个非负权值， 代表策策经过这条边所要花的时间。

策策每天都会去逛公园，他总是从 $1$ 号点进去，从 $N$ 号点出来。

策策喜欢新鲜的事物，它不希望有两天逛公园的路线完全一样，同时策策还是一个 特别热爱学习的好孩子，它不希望每天在逛公园这件事上花费太多的时间。如果 $1$ 号点 到 $N$ 号点的最短路长为 $d$，那么策策只会喜欢长度不超过 $d + K$ 的路线。

策策同学想知道总共有多少条满足条件的路线，你能帮帮它吗？

为避免输出过大，答案对 $P$ 取模。

如果有无穷多条合法的路线，请输出 $-1$。


## 说明/提示

【样例解释1】


对于第一组数据，最短路为 $3$。 $1\to 5, 1\to 2\to 4\to 5, 1\to 2\to 3\to 5$ 为 $3$ 条合法路径。


【测试数据与约定】

对于不同的测试点，我们约定各种参数的规模不会超过如下


测试点编号　　|$T$　　　|$N$　　　|$M$　　　|$K$　　　|是否有 $0$ 边
-|-|-|-|-|-
$1$|$5$|$5$|$10$|$0$|否
$2$|$5$|$10^3$|$2\times 10^3$|$0$|否
$3$|$5$|$10^3$|$2\times 10^3$|$50$|否
$4$|$5$|$10^3$|$2\times 10^3$|$50$|否
$5$|$5$|$10^3$|$2\times 10^3$|$50$|否
$6$|$5$|$10^3$|$2\times 10^3$|$50$|是
$7$|$5$|$10^5$|$2\times 10^5$|$0$|否
$8$|$3$|$10^5$|$2\times 10^5$|$50$|否
$9$|$3$|$10^5$|$2\times 10^5$|$50$|是
$10$|$3$|$10^5$|$2\times 10^5$|$50$|是


对于 $100\%$ 的数据，$1 \le P \le 10^9$，$1 \le a_i,b_i \le N$，$0 \le c_i \le 1000$。

数据保证：至少存在一条合法的路线。

---

- 2019.8.30 增加了一组 hack 数据 by @skicean
- 2022.7.21 增加了一组 hack 数据 by @djwj233

## 样例 #1

### 输入

```
2
5 7 2 10
1 2 1
2 4 0
4 5 2
2 3 2
3 4 1
3 5 2
1 5 3
2 2 0 10
1 2 0
2 1 0```

### 输出

```
3
-1

```

# AI分析结果



---

## 唯一算法分类  
**其他搜索**

---

## 综合分析与结论  
本题目需结合**Dijkstra预处理最短路径**与**记忆化搜索/动态规划**，核心难点在于处理路径计数中的状态转移与0环检测。关键解决思路如下：

### 搜索过程与可视化设计  
1. **Dijkstra预处理**：以像素动画展示节点被访问的顺序，绿色标记已确定最短路径的节点，红色标记队列中的候选节点。
2. **记忆化搜索**：用DFS遍历状态空间，蓝色高亮当前访问节点 `(u, k)`，黄色标记待转移的邻接点 `(v, k')`。当检测到同一状态二次访问（红色闪烁）时触发0环警报。
3. **游戏化演示**：采用复古8位风格，节点显示为像素方块，合法路径用绿色连线，0边用黄色连线。每找到一条合法路径播放短促音效，检测到0环时播放警报音。

---

## 题解清单 (≥4星)  
1. **Jay_genius（★★★★☆）**  
   - 核心亮点：清晰的记忆化搜索实现，用 `vis2` 数组检测递归栈中的重复状态，代码可读性极佳。  
   - 个人心得：提到“调了两个小时”强调0环检测的重要性。

2. **2014吕泽龙（★★★★☆）**  
   - 核心亮点：分层图思想+拓扑排序处理0边，提供两种实现方案（拓扑排序与记忆化搜索）。  
   - 关键技巧：按 `dis` 排序保证DP顺序，用强连通分量判断合法0环。

3. **chenxia25（★★★★☆）**  
   - 核心亮点：结合Tarjan缩点与双向Dijkstra预处理，精确判断0环是否在合法路径上。  
   - 优化手段：通过正反图预处理最短路，避免无效状态转移。

---

## 最优思路与技巧提炼  
1. **状态压缩**：定义 `dp[u][k]` 为从1到u且多走k步的路径数，将状态空间压缩至 `O(NK)`。
2. **0环检测**：在记忆化搜索中维护 `vis[u][k]` 标记递归路径，重复访问同一状态即判定为环。
3. **反向图优化**：通过反向边构建邻接表，使DFS从终点向起点回溯，简化状态转移方程。
4. **分层拓扑排序**：对0边单独建图拓扑排序，保证DP顺序无环。

```cpp
// 关键代码片段：记忆化搜索中的状态转移与环检测
ll dfs(ll u, ll k) {
    if (vis[u][k]) { flg = 1; return 0; } // 环检测
    if (dp[u][k] != -1) return dp[u][k];
    vis[u][k] = 1;
    for (auto [v, w] : reverse_edges[u]) {
        ll nk = d[u] - d[v] + k - w;
        if (nk < 0 || nk > K) continue;
        dp[u][k] += dfs(v, nk); // 状态转移方程
    }
    vis[u][k] = 0;
    return dp[u][k];
}
```

---

## 同类型题与算法套路  
1. **最短路计数**（[P1144](https://www.luogu.com.cn/problem/P1144)）  
2. **带限制的最短路径数**（[P1608](https://www.luogu.com.cn/problem/P1608)）  
3. **有向图环检测与路径计数**（[P3530](https://www.luogu.com.cn/problem/P3530)）

---

## 推荐洛谷题目  
1. **P1144** 最短路计数（基础最短路+DP）  
2. **P1613** 跑路（分层图+BFS）  
3. **P4011** 孤岛营救问题（状态压缩+BFS）

---

## 可视化与游戏化设计  
1. **像素风格渲染**：  
   - 节点：16x16像素方块，绿色为已访问，红色为队列中，灰色为未访问。  
   - 边：0边用黄色，其他边用蓝色，线宽随权重增加。  
   ```javascript
   // Canvas绘制节点示例
   ctx.fillStyle = nodeColors[state];
   ctx.fillRect(x*32, y*32, 30, 30);
   ```
2. **音效触发逻辑**：  
   - `new Audio('blip.wav').play()` 当节点加入队列时播放。  
   - 检测到0环时触发 `alert.wav`，成功计数时播放 `success.wav`。  
3. **自动演示模式**：  
   - 使用 `setInterval` 控制搜索步进速度，允许暂停/继续。  
   - AI自动选择下一个扩展节点，模拟BFS/DFS策略差异。

---

## 个人心得摘录  
> "调了两个小时才发现忘记清空 `vis` 数组，血的教训！" —— Jay_genius  
> **总结**：多测清空是竞赛代码的关键，建议封装初始化函数。

> "Tarjan缩点后要检查每个SCC是否在合法路径上，这是hack数据的关键。" —— chenxia25  
> **启示**：0环需结合全局约束判断，局部环可能不影响最终答案。

---
处理用时：92.52秒
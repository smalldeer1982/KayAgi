# 题目信息

# [SDOI2016] 齿轮

## 题目描述

现有一个传动系统，包含了N个组合齿轮和M个链条。每一个链条连接了两个组合齿轮u和v，并提供了一个传动比x: y。即如果只考虑这两个组合齿轮，编号为u的齿轮转动x圈，编号为v的齿轮会转动y圈。传动比为正表示若编号为u的齿轮顺时针转动，则编号为v的齿轮也顺时针转动。传动比为负表示若编号为u的齿轮顺时针转动，则编号为v的齿轮会逆时针转动。若不同链条的传动比不相容，则有些齿轮无法转动。我们希望知道，系统中的这Ｎ个组合齿轮能否同时转动。


## 说明/提示

对于所有数据，T<=32，N<=1000，M<=10000且x与y的绝对值均不超过100。


## 样例 #1

### 输入

```
2
3 3
1 2 3 5
2 3 5 -7
1 3 3 -7
3 3
1 2 3 5
2 3 5 -7
1 3 3 7```

### 输出

```
Case #1: Yes
Case #2: No```

# AI分析结果



---

**唯一算法分类**: DFS

---

### **题解思路与算法要点**

1. **核心思路**  
   所有题解的核心在于**检测图中是否存在矛盾的环**。若存在环且环的传动比乘积不为1，则系统无法转动。通过遍历图结构（DFS/BFS）或并查集维护比例关系，判断矛盾。

2. **DFS/BFS 实现要点**  
   - **起始状态**：每个连通分量选一个节点（如1号齿轮），假设其转动倍数为1。  
   - **访问顺序**：DFS递归访问相邻节点，推导其转动倍数；BFS用队列按层扩展。  
   - **剪枝/终止条件**：若发现相邻节点的计算值与当前值冲突（超过精度容差），立即终止。  
   - **数据结构**：邻接表存图，`visited`数组记录是否访问，`double`数组记录各节点转动倍数。

3. **解决难点**  
   - **精度处理**：浮点数比较使用`eps`容差（如1e-5）。  
   - **双向边处理**：每个链条建正反两条边，分别存储传动比和其倒数。  
   - **多连通分量**：需遍历所有未访问节点，确保每个连通分量独立检查。

---

### **题解评分 (≥4星)**

1. **MloVtry（赞9）**  
   ⭐⭐⭐⭐  
   - **亮点**：简洁的DFS实现，双向边存储传动比，通过`sign`函数处理精度。  
   - **代码可读性**：结构清晰，邻接表建图，递归逻辑直观。

2. **TonyYin（赞0）**  
   ⭐⭐⭐⭐  
   - **亮点**：BFS实现，初始速度设为100避免精度问题，统一处理正负号。  
   - **优化点**：固定初始值减少浮点误差累积。

3. **瞬闪影（赞4）**  
   ⭐⭐⭐⭐  
   - **亮点**：用分数类（分子分母）避免浮点误差，通过GCD化简比例。  
   - **创新点**：质因数分解处理大数，适合极端数据。

---

### **最优思路与技巧**

1. **分数代替浮点数**  
   瞬闪影的题解通过分子分母的分数形式（如结构体存储`a/b`）避免精度问题，结合GCD化简，适合高精度场景。

2. **对数转换**  
   将乘法转换为加减法：`log(x/y) = log(x) - log(y)`，可避免浮点溢出（但需处理符号）。

3. **带权并查集**  
   维护每个节点到根节点的传动比，合并时更新比例关系，高效检测环矛盾（非搜索但值得参考）。

---

### **同类型题与算法套路**

1. **图遍历与环检测**  
   - **类似题**：  
     - [P3385 判断负环](https://www.luogu.com.cn/problem/P3385)（BFS/SPFA）  
     - [P2661 信息传递](https://www.luogu.com.cn/problem/P2661)（DFS找最小环）  

2. **带权并查集应用**  
   - **类似题**：  
     - [P2024 食物链](https://www.luogu.com.cn/problem/P2024)（关系传递）  
     - [P1196 银河英雄传说](https://www.luogu.com.cn/problem/P1196)（距离维护）  

---

### **推荐相似题目**

1. **P1993 小K的农场**  
   差分约束系统，判断是否存在矛盾的不等式环。

2. **P2294 狡猾的商人**  
   带权并查集或DFS检测账本矛盾。

3. **P4926 倍杀测量者**  
   二分答案+图论约束，处理比例关系。

---

### **个人心得摘录**

- **精度陷阱**：多位题解提到浮点误差需用`eps`，如MloVtry的`sign`函数。  
- **调试经验**：Uniecho1因未正确处理双向边比例导致WA，强调反向边的传动比必须取倒数。  
- **优化顿悟**：ywy_c_asm通过哈希模大质数替代浮点运算，避免精度问题。

---

### **可视化与算法演示**

#### **DFS/BFS 动画设计**
1. **节点与边绘制**  
   - **像素风格**：齿轮为8位色块，边为箭头线，当前访问节点高亮为红色。  
   - **Canvas 网格**：齿轮按编号排列成网格，边动态显示传动比（如`3:5`）。

2. **搜索过程演示**  
   - **步进控制**：用户点击“下一步”触发DFS递归或BFS出队。  
   - **冲突提示**：发现矛盾时，环路径闪烁，播放“错误”音效。

3. **音效与交互**  
   - **音效**：访问节点时播放“嘀”声，矛盾时播放“爆炸”音效。  
   - **自动模式**：AI模拟搜索过程，速度可调（快/慢/暂停）。

#### **代码片段（JS 实现）**
```javascript
// Canvas 初始化与节点绘制
const canvas = document.getElementById('gearCanvas');
const ctx = canvas.getContext('2d');
const nodes = [{x:100,y:100, val:1}, {x:200,y:200, val:0}]; // 示例节点

function drawNode(node, color) {
    ctx.fillStyle = color;
    ctx.fillRect(node.x - 15, node.y - 15, 30, 30); // 像素风格方块
    ctx.fillText(node.val.toFixed(2), node.x, node.y + 20);
}

// DFS 递归演示（简化逻辑）
function dfsStep(node) {
    if (conflict) playSound('error');
    gearEdges.forEach(edge => {
        if (edge.from === node && !visited[edge.to]) {
            visited[edge.to] = true;
            drawNode(edge.to, 'blue'); // 访问新节点
            setTimeout(() => dfsStep(edge.to), 500); // 延迟模拟步进
        }
    });
}
```

---

### **总结**  
本题通过图遍历或并查集检测矛盾环，DFS/BFS需注意精度处理和双向边。最优解结合分数或对数转换避免浮点问题，可视化可增强理解搜索过程与环检测机制。

---
处理用时：107.24秒
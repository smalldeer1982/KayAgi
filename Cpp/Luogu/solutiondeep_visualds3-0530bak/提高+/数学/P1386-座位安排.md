# 题目信息

# 座位安排

## 题目描述

给 $n$ 个人安排座位，先给每个人一个 $1\sim n$ 的编号，设第i个人的编号为 $a_i$（不同人的编号可以相同），接着从第一个人开始，大家依次入座。

第 $i$ 个人来了以后尝试坐到 $a_i$，如果 $a_i$ 被占据了，就尝试 $a_{i+1}$，$a_{i+1}$ 也被占据了的话就尝试 $a_{i+2}$，……，如果一直尝试到第 $n$ 个都不行，该安排方案就不合法。

然而有 $m$ 个人的编号已经确定（他们或许贿赂了你的上司…)，你只能安排剩下的人的编号。求有多少种合法的安排方案。由于答案可能很大，只需输出其除以 $M$ 后的余数即可。



## 说明/提示

对于 $30\%$ 的数据 $1\le n\le 10$，$1\le M\le 32767$；

对于 $100\%$ 的数据 $1≤T≤10$，$1≤n≤300$，$0≤m≤n$，$2≤M≤10^9$，$1≤p_i,q_i≤n$ 且保证 $p_i$ 互不相同。


## 样例 #1

### 输入

```
2

4 3 10

1 2 2 1 3 1

10 3 8882

7 9 2 9 5 10

```

### 输出

```
YES 4

NO

```

# AI分析结果



**唯一算法分类**  
组合数学  

---

### **综合分析与结论**  
**题目核心**：安排座位编号，确保每个编号i的后缀人数不超过n-i+1，通过组合数学与动态规划统计合法方案数。  
**关键难点**：  
1. 模型转化为组合数学问题，需确保后缀人数合法。  
2. 动态规划状态设计与转移，处理固定编号与自由人的组合分配。  

**核心公式推导**：  
- **合法性条件**：对任意i，编号≥i的人数s_i ≤ n-i+1。  
- **状态转移方程**（以KAMIYA_KINA题解为例）：  
  $$f_{i,j} = \sum_{k} \binom{j}{k} \cdot f_{i+1,j-k}$$  
  其中，j表示当前处理的位置i的剩余可分配人数，k为分配到i的人数。  

**可视化设计**：  
- **动态展示**：在Canvas中绘制网格表示DP状态矩阵，高亮当前计算的位置(i,j)及转移路径。  
- **组合数计算**：以像素方块表示组合数表格，点击状态转移时联动显示对应的组合数计算过程。  
- **复古风格**：使用8位像素字体和16色调色板，状态转移时播放经典音效（如NES风格“滴答”声）。  

---

### **题解清单 (≥4星)**  
1. **KAMIYA_KINA (5星)**  
   - **亮点**：逆向DP设计清晰，组合数递推预处理高效，时间复杂度O(n³)严格可控。  
   - **代码片段**：  
     ```cpp  
     for(int i=n;i>=1;i--) {
         for(int j=0; j<=n-i+1-sum[i]; j++) {
             for(int k=0; k<=j; k++) {
                 f[i][j] += f[i+1][j-k] * C[j][k];
             }
         }
     }
     ```

2. **wyd_forever (4星)**  
   - **亮点**：前缀和与组合数分离处理，状态转移公式详细注释。  
   - **心得引用**：“人会被抽象成编号，与人没有关系”——强调问题抽象的重要性。  

3. **Hongse_Fox (4星)**  
   - **亮点**：后缀和预处理与合法性快速判断，代码结构模块化。  
   - **关键代码**：  
     ```cpp  
     for(int i=n;i>=1;i--) hzh[i]=hzh[i+1]+num[i];
     if(hzh[i]>n-i+1) flag=1;
     ```

---

### **最优技巧提炼**  
1. **逆向状态转移**：从编号n向1处理，避免正向转移的后效性。  
2. **组合数分离计算**：将固定编号与自由人的组合分配拆解为独立步骤，利用组合数公式：  
   $$\text{方案数} = \binom{\text{剩余自由人}}{\text{需分配的自由人}}$$  
3. **合法性剪枝**：预处理后缀和，若存在s_i > n-i+1直接判定非法。  

---

### **同类型题与套路**  
**通用套路**：  
1. **组合限制模型**：当问题涉及“数量不超过某阈值”时，常用后缀和合法性判断。  
2. **动态规划+组合数**：状态表示当前分配进度，组合数计算具体分配方式。  

**推荐题目**：  
1. [P2523] [SHOI2001] 红黑牌  
2. [P3223] [HNOI2012] 排队  
3. [P4091] [HEOI2016/TJOI2016] 求和  

---

### **个人心得摘录**  
- **wyd_forever**：“考试DP爆炸后，逆向思维是解题关键”——强调从失败中调整思路的重要性。  
- **Hongse_Fox**：“找好状态转移方程，组合数不重不漏”——提醒注意计数问题的细节设计。  

---

### **复古游戏化动画设计**  
**实现要点**：  
1. **像素网格**：用16x16像素块表示DP状态矩阵，每个块显示f[i][j]的值。  
2. **音效触发**：  
   - **正确转移**：播放8-bit上升音调（频率440Hz，50ms）。  
   - **非法判定**：播放低频噪声（频率220Hz，100ms）。  
3. **自动演示模式**：模拟AI解题，自动高亮当前计算步骤并显示组合数选择。  
4. **关卡积分**：将n=5,10,15设为关卡，每关积分=剩余时间×正确步骤数。  

**代码片段（JS伪代码）**：  
```javascript  
// 绘制DP状态网格  
function drawGrid(fMatrix) {
    for(let i=1; i<=n; i++) {
        for(let j=0; j<=n-i+1; j++) {
            ctx.fillStyle = getColor(fMatrix[i][j]);
            ctx.fillRect(i*16, j*16, 15, 15);
        }
    }
}
// 音效触发  
function playSound(freq) {
    let osc = audioCtx.createOscillator();
    osc.frequency.value = freq;
    osc.connect(audioCtx.destination);
    osc.start(); osc.stop(0.05);
}
```

---
处理用时：69.73秒
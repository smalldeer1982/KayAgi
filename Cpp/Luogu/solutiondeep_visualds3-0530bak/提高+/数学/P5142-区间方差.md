# 题目信息

# 区间方差

## 题目背景

出题人并没有能力写有趣的题面……


## 题目描述

对于一个长度为 $n$ 的序列 $a_1,a_2,a_3\cdots a_n$，我们定义它的平均数 $a$ 为:

$$a=\frac{1}{n}\sum_{i=1}^{n}a_i$$

并定义它的方差 $d$ 为:

$$d=\frac{1}{n}\sum_{i=1}^{n}(a_i-a)^2$$

现在给定一个长度为 $n$ 的序列 $b_1,b_2\cdots b_n$。你需要支持两种操作。每种操作的格式为 `c x y`。

若 $c=1$，为修改操作，代表将 $b_x$ 赋值为 $y$。

若 $c=2$，为查询操作，代表查询 $b_x$ 到 $b_y$ 的方差。

为了避免浮点数误差，请以分数取模形式输出结果（对 1000000007（$10^9+7$）取模）。

## 说明/提示

#### 样例 1 解释
四次修改后，序列 $b$ 为：$\{1,2,3,4\}$。

区间 $[1,1]$ 的方差为 $0$。

区间 $[1,2]$ 的方差为 $\frac{1}{4}$ 。$4$ 的逆元为 $250000002$。

区间 $[1,3]$ 的方差为 $\frac{2}{3}$。$3$ 的逆元为 $333333336$，$2\times333333336\bmod M=666666672$。

#### 数据规模与约定

- 对于 $50\%$ 的数据，$n\leq 1000$，$m\leq 1000$。
- 对于 $100\%$ 的数据，$1\leq n,m\leq 1\times 10^5$，$1\leq b_i\leq 1\times 10^9$，$1\leq x\leq n$。对于操作 1，$1\leq y\leq 1\times 10^9$。对于操作2，$x\leq y\leq n$。

## 样例 #1

### 输入

```
4 8
0 0 0 0
1 1 1
1 2 2
1 3 3
1 4 4
2 1 1
2 1 2
2 1 3
2 1 4```

### 输出

```
0
250000002
666666672
250000003```

# AI分析结果



### 唯一算法分类
**数论**

---

### 题解思路与核心难点
**核心数学推导**：  
方差公式展开为 $d = \frac{1}{n} \sum a_i^2 - (\frac{1}{n} \sum a_i)^2$，需维护区间和与平方和。  
**关键难点**：  
1. 公式变形后需处理分数取模（逆元）  
2. 避免负数取模导致的错误  
**解决方式**：  
- 线段树/树状数组维护区间和 $\sum a_i$ 和平方和 $\sum a_i^2$  
- 费马小定理求逆元 $n^{-1} \equiv n^{mod-2} \pmod{mod}$  
- 计算方差时对负数结果进行 $(x + mod) \% mod$ 修正  

---

### 题解评分（≥4星）
1. **fa_555（★★★★☆）**  
   - 详细公式推导，完整线段树实现  
   - 代码注释清晰，处理取模严谨  
   - 核心代码段：  
     ```cpp
     ans = (s2 * inv % mod - ave * ave % mod + mod) % mod;
     ```

2. **NaCly_Fish（★★★★☆）**  
   - 树状数组实现，代码简洁高效  
   - 逆元计算采用递归方式，略有优化空间  
   - 核心代码段：  
     ```cpp
     ans = (sqsum * inv - (sum * inv % mod) * (sum * inv % mod)) % mod;
     ```

3. **Prean（★★★★☆）**  
   - 极简线段树实现，代码紧凑  
   - 省略部分注释，但算法正确性明确  
   - 核心代码段：  
     ```cpp
     ans = ((tmp.squ * inv % mod) - (ave * ave % mod) + mod) % mod;
     ```

---

### 最优思路提炼
1. **公式转换**：将方差拆解为 **平方和均值 - 均值的平方**  
2. **数据结构选择**：线段树/树状数组维护 **区间和** 和 **区间平方和**  
3. **取模技巧**：  
   - 所有运算后立即取模  
   - 负数结果修正：`(x % mod + mod) % mod`  
4. **逆元优化**：预处理逆元或快速幂计算  

---

### 类似题目推荐
1. [P1471 方差](https://www.luogu.com.cn/problem/P1471)  
   - 区间修改+方差查询，需扩展维护方式  
2. [P2122 还教室](https://www.luogu.com.cn/problem/P2122)  
   - 动态维护区间方差与均值  
3. [P2613 有理数取余](https://www.luogu.com.cn/problem/P2613)  
   - 分数取模的专项训练  

---

### 可视化设计（像素风格演示）
**动画方案**：  
1. **线段树节点绘制**：  
   - 每个节点显示 `[sum, sum_sq]`，用8-bit像素字体  
   - 修改操作时，对应节点闪烁黄色，更新数值  
2. **查询过程演示**：  
   - 高亮查询区间，逐步合并子区间和（绿色路径）  
   - 显示计算步骤：$\frac{sum\_sq}{n} - (\frac{sum}{n})^2$  
3. **音效设计**：  
   - 节点更新：短促“哔”声（8-bit音效）  
   - 查询完成：上扬旋律（类似NES过关音效）  

**交互功能**：  
- 步进控制：空格键单步执行运算  
- 速度调节：方向键控制动画速度（1x/2x/0.5x）  

---

### 关键代码片段（fa_555题解核心）
```cpp
// 方差计算逻辑
s1 = query1(1, x, y); // 区间和
s2 = query2(1, x, y); // 区间平方和
inv = qpow(y - x + 1, mod - 2); // 逆元
ave = (ll)s1 * inv % mod; // 平均值
ans = (ll)s2 * inv % mod - (ll)ave * ave % mod;
ans = (ans % mod + mod) % mod; // 负数修正
```

---

### 总结
通过公式转换将方差问题转化为可维护的区间统计量，结合数论中的逆元处理，实现高效动态维护。线段树与树状数组均可胜任，关键在严谨处理模运算边界条件。可视化设计通过复古像素风格增强理解，音效与动画提升交互体验。

---
处理用时：68.60秒
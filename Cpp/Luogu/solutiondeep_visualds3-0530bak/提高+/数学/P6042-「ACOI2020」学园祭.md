# 题目信息

# 「ACOI2020」学园祭

## 题目背景

![T4](https://s2.ax1x.com/2020/01/12/lopWDS.md.png)

秋天，是学习之秋，食欲之秋，更是，学园祭之秋！随着时间流逝，学园祭也越来越近。终于等到这一天，可是没想到在冲绳岛上邂逅到女装的渚同学的勇次竟然来了！中村 莉櫻（Nakamura Rio）见到这个情况，忙给渚同学换上女装。没办法，勇次已经来了，于是渚同学鼓起勇气迈出了第一步。（为什么自顾自地加提示框啊喂！）

## 题目描述

莉櫻为了利用这个人傻钱多的少爷，尽全力提高消费额，努力地暗示渚同学。没办法，于是渚同学想了一下，提出了一个问题：

给出一个 $n$，定义：
$$
\Gamma(0)=1,\Gamma(n)={n!}
$$

$$
A_i^j=\frac{\Gamma(i)}{\Gamma(j)}
$$
求
$$
\sum_{i=1}^n \sum_{j=1}^i \sum_{k=1}^j \gcd(A_{i-j}^j \times \Gamma(j),A_{j-k}^k \times \Gamma(k)) 
$$

渚同学念着莉櫻举起的对话板上写的字：如果不能在规定时间回答出问题的话，就要把菜单全部买一遍哦！

尽管勇次钱多，但是他并不想吃得太多，因为这个问题有 $T$ 个小问题！

**由于答案可能太大，请将答案对 $10086001$ 取模。**

## 说明/提示

#### 数据范围
**本题采用捆绑测试**。

- Subtask 1（20 points）：$T \leq 10^3$，$n \leq 10^2$。   
- Subtask 2（30 points）：$T \leq 10^6$，$n \leq 5 \times 10^3$。  
- Subtask 3（50 points）：$T \leq 10^6$，$n \leq 10^6$。   

对于 $100\%$ 的数据，$1 \leq T,n \leq 10^6$。

## 样例 #1

### 输入

```
5
1
2
3
4
5
```

### 输出

```
1
4
10
20
36
```

# AI分析结果



---

## **唯一算法分类**  
**数论**

---

## **题解思路、算法要点与解决难点**  
### **核心公式推导**  
原式经化简为：  
$$\sum_{i=1}^n \sum_{j=1}^i \sum_{k=1}^j \min(i-j, j-k)!$$  
通过变量替换 \(x = i-j, y = j-k\)，发现 \(\min(x, y)\) 的最大值为 \(\lfloor \frac{n-1}{2} \rfloor\)，最终转化为：  
$$\sum_{a=0}^{\lfloor \frac{n-1}{2} \rfloor} a! \cdot (n-2a)^2$$  

### **解决难点**  
1. **三重循环简化**：将 \(O(n^3)\) 问题转化为单变量求和，利用阶乘和平方项的线性组合拆分。  
2. **快速查询优化**：预处理 \(a!\), \(4a \cdot a!\), \(4a^2 \cdot a!\) 的前缀和，实现 \(O(1)\) 查询。  

### **关键数学步骤**  
1. **变量替换与范围分析**：通过 \(x, y\) 的非负性和 \(x+y \le n-1\) 推导贡献次数。  
2. **完全平方展开**：将 \((n-2a)^2\) 拆分为 \(n^2 - 4an + 4a^2\)，分别计算各分项前缀和。  

---

## **题解评分 (≥4星)**  
1. **Alex_Wei (5星)**  
   - **亮点**：详细推导变量替换与贡献计算，代码简洁高效，预处理前缀和实现 \(O(1)\) 查询。  
   - **代码**：拆分完全平方式，通过三个前缀和数组快速计算答案。  

2. **WYXkk (4星)**  
   - **亮点**：通过找规律发现三次差分后为阶乘，代码极短，适合快速实现。  
   - **缺点**：推导过程依赖找规律，数学严谨性较弱。  

3. **do_while_true (4星)**  
   - **亮点**：分步推导贡献计算，代码清晰，预处理阶乘和前缀和。  
   - **缺点**：推导过程稍显冗长。  

---

## **最优思路或技巧提炼**  
1. **变量替换与贡献分析**：通过 \(x = i-j, y = j-k\) 将三重循环转化为单变量问题。  
2. **前缀和优化**：预处理阶乘及其线性组合的前缀和，将求和复杂度从 \(O(n)\) 降为 \(O(1)\)。  
3. **完全平方拆分**：将 \((n-2a)^2\) 分解为线性组合，分别对应独立的前缀和计算。  

---

## **同类型题与解法套路**  
1. **数论公式推导**：将复杂求和式转化为单变量问题（如利用对称性、变量替换）。  
2. **前缀和预处理**：针对固定模式的多次查询，通过拆分公式预处理分项。  

---

## **推荐相似题目**  
1. **P2158 [SDOI2008] 仪仗队**（数论，欧拉函数）  
2. **P1069 细胞分裂**（质因数分解与gcd优化）  
3. **P2260 [清华集训2012] 模积和**（数论分块与公式拆分）  

---

## **个人心得摘录**  
- **Alex_Wei**：注意公式推导中的笔误，如完全平方拆分时的系数符号。  
- **WYXkk**：通过暴力程序找规律可快速发现隐藏模式。  
- **zfio**：分情况讨论贡献时需避免重复计数，边界条件需仔细验证。  

---

## **可视化与算法演示**  
### **动画设计**  
1. **公式推导步骤**：  
   - **Step 1**：展示三重循环转化为 \(x, y\) 的过程（动态替换变量）。  
   - **Step 2**：高亮 \(\min(x, y)\) 的贡献区域，标记 \(a = \min(x, y)\)。  
   - **Step 3**：动态绘制 \(a! \cdot (n-2a)^2\) 的柱状图，颜色区分阶乘与平方项。  

2. **复古像素风格**：  
   - **颜色方案**：8-bit 色调（阶乘用绿色，平方项用蓝色，结果用红色）。  
   - **音效**：每完成一个 \(a\) 的计算播放短促音效，最终答案显示时播放胜利音效。  
   - **Canvas 动画**：用像素块表示每个 \(a\) 的贡献值，逐步累加显示总和。  

### **代码片段（关键逻辑）**  
```cpp
// 预处理阶乘及前缀和
frc[0] = pre1[0] = 1;
for (int i = 1; i < N; i++) {
    frc[i] = frc[i-1] * i % mod;
    pre1[i] = (pre1[i-1] + frc[i]) % mod;
    pre2[i] = (pre2[i-1] + frc[i] * 4 * i) % mod;
    pre3[i] = (pre3[i-1] + frc[i] * 4 * i % mod * i) % mod;
}
// 查询计算
ans = (pre1[u] * n % mod * n - pre2[u] * n % mod + pre3[u]) % mod;
```

---

## **总结**  
本题核心为数论公式推导，通过变量替换与前缀和优化将复杂度从 \(O(n^3)\) 降至 \(O(1)\)。最优解法为完全平方拆分与预处理，推荐结合动画演示公式推导步骤加深理解。

---
处理用时：81.62秒
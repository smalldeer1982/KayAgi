# 题目信息

# 『MdOI R2』Odyssey

## 题目背景

超越音速的极限，不及瑰丽多变的极光；

微弱的脉冲，开拓原本一片混沌的天地；

沉郁的蓝缓缓闪动，史诗的红迎接巅峰；

血色的夕阳尽头，是将夜的星辰；

夜半的满天星空，也会被来自地狱的硝烟掩盖；

炽红炼狱消逝，只金色遗迹永存。

在这里等待着每一位的，都是一段艰苦而璀璨的旅程。

## 题目描述

若正整数 $a$ 与 $b$ 满足：

- $a$ 与 $b$ 的积是一个正整数的 $k$ 次方，即存在正整数 $c$ 使得 $ab=c^k$。

那么我们称 $(a,b)$ 为一组**完美数对**。

---

有一个包含 $n$ 个结点和 $m$ 条边的**有向无环图**，这张图中的每条边都有权值和长度两个属性。

如果一条路径 $P$ 满足**以下条件之一**，则称其为一条**完美路径**：

- $P$ 中仅包含一条边。

- $P$ 从其起点开始依次为 $e_1, e_2, e_3, \ldots e_p$ 这 $p\ (p\ge 2)$ 条边，对于任意的 $1\leq i\leq p-1$，$e_i$ 的权值和 $e_{i+1}$ 的权值组成完美数对。

你需要求出图中最长完美路径的长度，一条路径的长度定义为这条路径上所有边的长度之和。

## 说明/提示

【帮助与提示】  

为方便选手测试代码，本题额外提供两组附加样例供选手使用。  

[样例输入1](https://www.luogu.com.cn/paste/wx1lz6m2) [样例输出1](https://www.luogu.com.cn/paste/28xe7f0x)      

[样例输入2](https://www.luogu.com.cn/paste/efgwngs5) [样例输出2](https://www.luogu.com.cn/paste/5hcpoayt)   

----

【样例解释】

样例中给出的有向无环图如图所示，其中边上的红色数字为边的权值，黑色数字为边的长度：

![](https://cdn.luogu.com.cn/upload/image_hosting/w6x03ksd.png)

最长完美路径为 $2\to 5\to 3$，因为这两条边的权值 $2$ 和 $18$ 满足 $2\times 18=6^2$，是完美数对，此路径长度为 $5+9=14$。

此外，$2\to 1\to 4\to 3,\ \ 2\to 4\to 3,\ \ 1\to 5\to 3$ 等也是完美路径，但不是最长的。

图中，$2\to 1\to 5\to 3$ 长度为 $15$，是一条更长的路径，但它并不是完美路径，因为前两个边权 $24$ 和 $8$ 的乘积为 $192$，不是正整数的平方，即 $(24,8)$ 不是完美数对。

---

【数据范围】

**本题采用捆绑测试。**

对于 $100\%$ 的数据：$1\leq n\leq 10^5,\ \ 1\leq m\leq 2\times 10^5,\ \ 1\leq k\leq 10,\ \ 1\leq u,v\leq n,\ \ 1\leq w\leq 10^5,\ \ 1\leq l\leq 10^4$。

给出的图**不保证弱连通**，图中从一个点到另一个点**可能**存在多条边，但保证给出的图是有向无环图。

| 子任务编号 | $n\leq$ |     $m\leq$      | $w\leq$ | $k\leq$ |  特殊性质  | 分值 |
| :--------: | :-----: | :--------------: | :-----: | :-----: | :--------: | :--: |
| Subtask 1  | $10^5$  |  $2\times 10^5$  | $10^5$  |   $1$   |     无     | $18$ |
| Subtask 2  |  $10$   |       $10$       |  $100$  |  $2$   |     无     | $12$ |
| Subtask 3  |  $600$  | $1.5\times 10^3$ | $10^3$  |   $2$   |     无     | $10$ |
| Subtask 4  | $10^5$  |  $2\times 10^5$  | $10^5$  |   $2$   | $w$ 为素数 | $15$ |
| Subtask 5  | $10^5$  |  $2\times 10^5$  | $10^5$  |   $2$   |     无     | $15$ |
| Subtask 6  |  $600$  | $1.5\times 10^3$ | $10^3$  |  $5$   |     无     | $10$ |
| Subtask 7  | $10^5$  |  $2\times 10^5$  | $10^5$  |  $10$   |     无     | $20$ |



## 样例 #1

### 输入

```
5 7 2
2 5 2 5
5 3 18 9
2 4 6 7
4 3 6 3
2 1 24 2
1 4 6 8
1 5 8 4```

### 输出

```
14```

# AI分析结果



## 唯一算法分类
**数论**

---

## 题解思路与核心难点分析
### 核心数学逻辑
所有题解均基于以下数论思想：
1. **质因数分解**：将边权分解为 $w = \prod p_i^{a_i}$  
2. **指数取模**：对每个质因数的指数取模 $k$，得到规范形式 $w' = \prod p_i^{(a_i \bmod k)}$  
3. **唯一配对**：计算每个 $w'$ 的完美配对 $f(w') = \prod p_i^{(k - a_i \bmod k) \bmod k}$  
4. **DAG动态规划**：在拓扑排序中维护状态 $dp[u][w']$ 表示以节点 $u$ 结尾且最后边权为 $w'$ 的最长路径

### 解决难点
1. **大质数处理**：当 $f(w')$ 超过值域时直接标记为无效  
2. **状态存储优化**：使用哈希或分层图技术（节点数翻倍）避免直接存储巨大状态  
3. **DAG转移优化**：通过拓扑序保证无后效性，仅需线性时间复杂度

### 可视化设计要点
1. **质因数分解动画**：  
   - 用像素方块表示质因数（不同颜色区分质数）  
   - 分解时显示指数数值，取模过程用闪烁高亮  
2. **状态转移演示**：  
   - 节点显示为像素风格方块，边权用对应颜色光带连接  
   - 当转移发生时，源节点和目标节点发出8bit音效  
3. **自动推导模式**：  
   - 自动展示从随机起点到最长路径的推导过程  
   - 错误路径播放短促"哔"声，正确路径播放上升音阶

---

## 题解评分（≥4星）
1. **BFqwq（4.5星）**  
   - 亮点：分层图拓扑排序清晰展示状态转移，代码结构模块化  
   - 优化：预处理素数加速分解，双倍节点处理环路风险

2. **一扶苏一（4.2星）**  
   - 亮点：双模哈希避免碰撞，map自动处理状态转移  
   - 不足：哈希计算略复杂，可读性稍差

3. **under_the_time（4.0星）**  
   - 亮点：直接使用unordered_map简化代码，包含详细调试注释  
   - 创新：特判k=1情况提升效率

---

## 最优思路提炼
**关键技巧链**：
```
质因数分解 → 指数取模 → 配对计算 → 分层图拓扑排序 → 动态规划状态转移
```
1. **预处理优化**：  
   ```cpp
   void work(int w) {
       for(int i=2; i*i<=w; ) {
           int cnt=0;
           while(w%i == 0) cnt++, w/=i;
           cnt %= k;  // 关键取模操作
           // 计算res1和res2...
       }
       // 处理剩余大质数...
   }
   ```
2. **状态转移方程**：  
   $dp[v][w'] = \max(dp[v][w'], dp[u][f(w')] + l)$

---

## 同类型题套路
1. **质因数分解应用**：  
   - 预处理素数表加速分解  
   - 指数取模处理周期性  
2. **DAG动态规划**：  
   - 拓扑序保证转移顺序  
   - 状态设计为（节点，附加条件）

---

## 推荐练习题
1. P1072 [NOIP2009] Hankson的趣味题（数论+分解）  
2. P2154 [SDOI2009] 学校食堂（状态压缩DP）  
3. P4213 【模板】杜教筛（数论函数应用）

---

## 核心代码片段
```cpp
// 质因数分解与配对计算
pair<int, int> process(int w) {
    int res = 1, inv = 1;
    for(int p=2; p*p<=w; p++) {
        int cnt = 0;
        while(w%p == 0) cnt++, w /= p;
        cnt %= k;
        res *= pow(p, cnt);
        inv *= pow(p, (k - cnt)%k);
    }
    if(w > 1) {
        res *= w;
        inv *= pow(w, k-1);
    }
    return {res, inv};
}

// 动态规划转移
void topo() {
    while(!q.empty()) {
        int u = q.front(); q.pop();
        for(auto &e : G[u]) {
            auto [w, inv] = e.pair;
            dp[e.v][w] = max(dp[e.v][w], dp[u][inv] + e.len);
            ans = max(ans, dp[e.v][w]);
        }
    }
}
```

---

## 复古像素化演示设计
```javascript
class PixelAnimator {
    constructor(canvas) {
        this.ctx = canvas.getContext('2d');
        this.nodes = new Map(); // 存储节点像素坐标
        this.edges = [];        // 边动画队列
        this.palette = ['#2D1B3D', '#E60576', '#05E6E6', '#E6E605'];
    }
    
    drawFactorization(w) {
        // 质因数分解动画：用不同颜色方块表示质因数
        let x = 50, y = 50;
        for(let p=2; p*p<=w; p++) {
            let cnt = 0;
            while(w%p == 0) {
                cnt++;
                w /= p;
                this.drawCube(x, y, p, cnt); // 绘制质因数方块
                x += 20;
            }
        }
        // 播放分解完成音效
        playSound('blip2', 500 + w%2000);
    }
    
    drawStateTransition(u, v, w) {
        // 用闪烁光带表示状态转移
        let [x1, y1] = this.nodes.get(u);
        let [x2, y2] = this.nodes.get(v);
        drawLaser(x1, y1, x2, y2, this.palette[w%4]);
    }
}
```

---

## 调试心得摘录
**BFqwq题解注释**：  
> "预处理素数时数组开小导致WA，后来发现最大质数要处理到√1e5"

**under_the_time调试记录**：  
> "unordered_map的默认构造函数在大量节点时会超内存，改用指针后AC"

---

## 知识迁移建议
当遇到以下特征时，可考虑本解法模式：  
1. 问题涉及数的乘积特性  
2. 需要处理周期性或模运算  
3. 图论问题需要附加状态转移

将复杂乘积条件转化为模运算问题，是数论在图论中的典型应用。

---
处理用时：76.16秒
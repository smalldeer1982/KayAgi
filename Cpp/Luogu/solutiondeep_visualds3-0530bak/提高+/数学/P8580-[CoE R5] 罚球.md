# 题目信息

# [CoE R5] 罚球

## 题目描述

有 $n$ 个人在玩罚球游戏，游戏规则如下：
- 每个人编号为 $1,2,\dots,n$，最开始由 $1$ 号罚球，接下来让下一个没有出局的人罚球。特殊地，$n$ 号的下一个是 $1$ 号。
- 如果罚球者没有碰到篮板，那么直接出局。
- 如果罚球者碰到篮板但没有进球，那么如果上一个人进球了，这个人就会出局，否则不会出局。
- 游戏结束的条件是最后只剩下一个人。

注意最开始的那个人碰到篮板但没有进球不出局。

这 $n$ 个人中，第 $i$ 个人碰不到篮板的概率为 $\dfrac{a_i}{1000}$，碰到篮板但没有进球的概率为 $\dfrac{b_i}{1000}$，求游戏结束时所有人总共罚球数量的期望值。

## 说明/提示

**关于取模**

不会有理数取模的看[这里](https://www.luogu.com.cn/problem/P2613)。



------------
**样例说明**

输入 $\#1$：

所有人碰不到篮板的概率都是 $\dfrac{1}{5}$，碰到篮板但不进球的概率都是 $\dfrac{2}{5}$，罚球数量的期望值为 $\dfrac{25}{9}$。

计算如下（黑色表示出局，红色表示没进球但不出局，蓝色表示进球）：
$$\dfrac{1}{5}+\red{\dfrac{2}{5}}\times(\dfrac{1}{5}+\red{\dfrac{2}{5}}\times(...)+\blue{\dfrac{2}{5}}\times(...))+\blue{\dfrac{2}{5}}\times(\dfrac{3}{5}+\blue{\dfrac{2}{5}}\times(...))=\dfrac{25}{9}$$

输入 $\#2$：

所有人碰不到篮板的概率都是 $\dfrac{321}{1000}$，碰到篮板但不进球的概率都是 $\dfrac{637}{1000}$，罚球数量的期望值为 $\dfrac{1000000}{57959}$。

------------

**数据范围**

**本题采用捆绑测试**。

测试点性质：
| $t=$ | 性质 | 分数 |
| :----------: | :----------: | :----------: |
| $1$ | $n=1$ | $2$ |
| $2$ | $a_i=b_i=0$ | $2$ |
| $3$ | $a_i=1000$ | $4$ |
| $4$ | $b_i=1000$ | $4$ |
| $5$ | $a_i=0,b_1=0,\forall i>1,b_i=1000$ | $6$ |
| $6$ | $a_i=b_i=500$ | $6$ |
| $7$ | $a_i=0,b_i=500$ | $6$ |
| $8$ | $a_i,b_i$ 均为定值，且答案不为 $-1$ | $19$ |
| $9$ | $1 \le n \le 11$ | $26$ |
| $10$ | $1 \le n \le 15$ | $8$ |
| $11$ | 无特殊性质 | $17$ |

**对于** $100\%$ **的数据**，$1 \le n \le 18$，$0 \le a_i,b_i,a_i+b_i \le 1000$。

本题的 $\text{Subtask 10}$ 分为两部分计分，对应 $t \in \{10,11\}$。

保证不存在分母为 $10^6+33$ 的倍数的情况。

## 样例 #1

### 输入

```
2 8
200 400
200 400```

### 输出

```
888921```

## 样例 #2

### 输入

```
7 8
321 637
321 637
321 637
321 637
321 637
321 637
321 637```

### 输出

```
818968```

## 样例 #3

### 输入

```
6 10
338 270
229 413
132 133
141 173
157 686
616 250```

### 输出

```
315860```

## 样例 #4

### 输入

```
8 10
338 270
229 413
132 133
141 173
157 686
616 250
0 0
0 0```

### 输出

```
-1```

# AI分析结果



### 数学分类选择  
**组合数学**（状态压缩与概率期望的动态规划）

---

### 题解思路与算法要点  
#### 核心数学模型  
1. **状态定义**  
   - `f(S, i, 0/1)`：存活集合为 `S`，当前罚球者是 `i`，上一个状态是未进球（0）或进球（1）时的期望次数。  
   - **状态转移**需考虑三种情况：未碰篮板（出局）、碰篮板未进球（是否出局由前序状态决定）、进球。  

2. **方程推导**  
   - 当上一个人未进球（状态0）：  
     $$f(S,i,0) = a_i \cdot f(S \setminus i, j, 0) + b_i \cdot f(S, j, 0) + c_i \cdot f(S, j, 1) + 1$$  
   - 当上一个人进球（状态1）：  
     $$f(S,i,1) = (a_i + b_i) \cdot f(S \setminus i, j, 0) + c_i \cdot f(S, j, 1) + 1$$  
   - 其中 `j` 是下一个存活者的位置，`c_i = 1 - a_i - b_i`。  

#### 解决难点  
- **循环依赖**：同一状态 `S` 内的 `f` 相互依赖，需对每个状态建立线性方程组。  
- **高效消元**：通过观察矩阵的带状结构，使用主元法将高斯消元复杂度从 $O(n^3)$ 降至 $O(n)$。  
- **特判-1**：存在多个永不淘汰的人时，直接返回 `-1`。  

#### 优化手段  
- **倒序枚举状态**：按集合大小从大到小处理，确保子问题已解决。  
- **逆元预处理**：提前计算模意义下的分数逆元，加速概率计算。  

---

### 题解评分  
1. **Alarm5854（★★★★★）**  
   - **亮点**：官方解法，状态定义清晰，预处理逆元优化计算，稀疏矩阵优化高斯消元。  
   - **代码**：高效处理 2^18 种状态，模运算严谨。  

2. **do_while_true（★★★★☆）**  
   - **亮点**：拆分状态转移，主元法简化消元，特判逻辑完备。  
   - **代码**：按存活人数分层处理状态，逻辑简洁。  

3. **QQ82272760（★★★★☆）**  
   - **亮点**：倒序处理状态，手动高斯消元，避免矩阵存储。  
   - **心得**：首次一血题解，强调状态转移的逆向思维。  

---

### 最优思路提炼  
**关键步骤**：  
1. **状态压缩**：用二进制表示存活集合，共 $2^n$ 种状态。  
2. **分治消元**：对每个状态独立建立方程组，利用转移方程的带状结构快速求解。  
3. **概率转换**：将 `a_i/1000` 和 `b_i/1000` 提前转为模逆元，避免重复计算。  

**代码片段**（Alarm5854 的核心消元逻辑）：  
```cpp
void gauss(ll n) {
    for (ll i = 0; i < n; ++i) {
        // 寻找主元并交换行
        ll t = i;
        for (ll j = i; j < n; ++j) 
            if (c[j][i]) { t = j; break; }
        swap(c[i], c[t]);
        // 消元过程（仅处理非零元素）
        for (ll j = i+1; j < n; ++j) {
            if (!c[j][i]) continue;
            ll x = c[j][i] * inv[c[i][i]] % mod;
            for (ll k = i; k <= n; ++k) 
                c[j][k] = (c[j][k] - x * c[i][k] % mod + mod) % mod;
        }
    }
    // 回代求解
    for (ll i = n-1; ~i; --i) {
        s[i] = c[i][n] * inv[c[i][i]] % mod;
        for (ll j = i-1; ~j; --j)
            c[j][n] = (c[j][n] - c[j][i] * s[i] % mod + mod) % mod;
    }
}
```

---

### 类似题目推荐  
1. **P2473** [奖励关]：状态压缩 + 期望 DP。  
2. **P3175** [HAOI2015 按位或]：高维前缀和与概率期望。  
3. **P6835** [CSP-S 2020] 函数调用：动态规划与拓扑排序。  

---

### 可视化设计  
**8位像素风格演示**：  
1. **Canvas 网格**：每个格子表示一个状态 `S`，颜色深浅表示存活人数。  
2. **动画流程**：  
   - **罚球步骤**：高亮当前罚球者，显示三种概率分支（红/黄/蓝对应未碰/碰未进/进球）。  
   - **状态更新**：出局时对应格子变暗，下一个存活者闪烁提示。  
3. **音效触发**：  
   - 成功消元时播放“升级”音效，特判-1时播放“失败”音效。  

**控制面板**：  
- **速度调节**：拖拽条控制罚球动画速度（0.5x~3x）。  
- **单步执行**：按空格键逐帧观察状态转移。  

---

### 总结  
本题结合状态压缩与动态规划，通过分治消元解决循环依赖，是概率期望与组合数学的经典结合。掌握逆元预处理和稀疏矩阵优化是解题关键。

---
处理用时：85.42秒
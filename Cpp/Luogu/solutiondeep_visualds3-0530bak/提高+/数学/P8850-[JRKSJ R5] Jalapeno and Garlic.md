# 题目信息

# [JRKSJ R5] Jalapeno and Garlic

## 题目背景

![](https://cdn.luogu.com.cn/upload/image_hosting/peaku0fe.png)

## 题目描述

一个 $n$ 个点的环，点有点权 $a$，编号依次从 $1\sim n$。点 $1$ 与点 $n$ 相邻。

你希望只存在一个 $x\in[1,n]$ 满足 $a_x\ne 0$。为此，你需要按下面流程进行操作：

1. 选定一个 $x$，表示最终使得 $a_x\ne 0$。**此后不能更改 $x$ 的选择。**
2. 进行若干次修改操作，每次操作你可以选定一个 $y\in[1,n]$，将 $a_y\gets a_y-1$。同时在与点 $y$ 相邻的两个点中**等概率选择**一个，其点权将被 $+1$。

你希望期望的修改次数最少，所以求在最优策略下的期望操作次数（操作 1 不计入）。

## 说明/提示

### 样例 $1$ 解释

选定 $x=2$，进行 $114514$ 次操作，每次的 $y=1$。

### 数据规模

**本题采用捆绑测试。**

| $\text{Subtask}$ | $n\le$ |分值 |
| :----------: | :----------: |:----------: |
| $1$ | $2$ | $5$ |
| $2$ | $10^3$ | $20$ |
| $3$ | $10^4$ | $20$ |
| $4$ | $10^5$ | $20$ |
| $5$ | $10^6$ | $35$ |

对于 $100\%$ 的数据，$2\le n\le 10^6$，$0\le a_i<1004535809$。

## 样例 #1

### 输入

```
2
114514 1919810```

### 输出

```
114514```

## 样例 #2

### 输入

```
3
1 1 2```

### 输出

```
4```

# AI分析结果



**唯一算法分类**：组合数学

---

### **题解思路、算法要点与解决难点**

1. **核心公式推导**  
   各题解均推导出关键公式 $f_i = i(n-i)$，表示距离目标点 $i$ 的棋子移动到目标的期望步数。  
   - **递推方程**：$f_i = 1 + \frac{1}{2}(f_{i-1} + f_{i+1})$，结合环的对称性 $f_i = f_{n-i}$，通过数学归纳或主元法得解。
   - **优化计算**：将绝对值展开为多项式，利用前缀和维护 $\sum a_i$, $\sum i a_i$, $\sum i^2 a_i$，将时间复杂度从 $O(n^2)$ 优化至 $O(n)$。

2. **解决难点**  
   - **环形结构的对称性处理**：通过 $f_i = f_{n-i}$ 简化方程组求解。
   - **避免重复计算**：利用前缀和/差分技巧快速计算每个目标点的总和，避免暴力枚举。

---

### **题解评分 (≥4星)**

| 题解作者      | 评分 | 关键亮点                                                                 |
|---------------|------|--------------------------------------------------------------------------|
| NaCly_Fish    | ★★★★★ | 公式推导清晰，代码高效，利用前缀和与数学展开实现最优复杂度。             |
| normalpcer    | ★★★★☆ | 递推过程详细，代码可读性强，引入差分维护增量优化计算。                   |
| 鲍勃L (BobL)  | ★★★★☆ | 通过维护增量简化计算，代码简洁，思维独特。                               |

---

### **最优思路或技巧提炼**

1. **期望公式统一性**  
   所有解法均通过递推方程推导出 $f_i = i(n-i)$，这是问题的核心突破点。  
   **关键推导步骤**：  
   $$f_{i+1} - f_i = f_i - f_{i-1} - 2 \implies 等差数列求和得 f_i = i(n-i)$$

2. **数学展开与前缀和优化**  
   将总和公式 $\sum a_i |i-d|(n-|i-d|)$ 展开为多项式，通过预处理以下三个前缀和快速计算：  
   $$S_1 = \sum a_i, \quad S_2 = \sum i a_i, \quad S_3 = \sum i^2 a_i$$  
   公式示例（目标点 $d$）：  
   $$ans_d = -S_3 + (2d-n)S_2 + d(n-d)S_1$$

3. **增量维护技巧**  
   当目标点从 $d$ 移动到 $d+1$ 时，通过差分更新总和，避免重复计算：  
   $$\Delta ans = 2n a_d - 2\sum a_i + \text{调整项}$$

---

### **同类型题与解法套路**

- **常见套路**：  
  1. 环形结构对称性处理  
  2. 递推方程求解期望  
  3. 前缀和/差分优化区间计算  

- **相似题目**：  
  1. [P1365 WJMZBMR打osu!](https://www.luogu.com.cn/problem/P1365)（期望递推）  
  2. [P6154 游走](https://www.luogu.com.cn/problem/P6154)（图上游走期望）  
  3. [CF1278F Cards](https://www.luogu.com.cn/problem/CF1278F)（组合期望公式推导）

---

### **代码实现核心**

```cpp
// 预处理前缀和并计算初始答案
i128 init = 0;
for (i32 i = 0; i < N; i++) {
    init += static_cast<i128>(a[i]) * i * (N - i);
}

// 增量维护总答案
i128 cur = init;
for (i32 p = 0; p < N; p++) {
    chkMin(ans, cur);
    cur += 2 * sigma_i_times_ai - (N + 1) * sigma_ai + 2 * N * a[p];
    sigma_i_times_ai += a[p] * N - sigma_ai; // 更新差分项
}
```

---

### **可视化与算法演示**

1. **动画设计**  
   - **环形展示**：用Canvas绘制环形结构，高亮当前目标点 $d$。  
   - **贡献计算**：动态显示每个点 $i$ 对 $d$ 的贡献 $f_{|i-d|}$，颜色渐变表示权值大小。  
   - **增量更新**：当目标点右移时，用红色箭头标记变化区域，显示 $\Delta ans$ 的计算过程。

2. **复古像素风格**  
   - **8位环模型**：用16色调色板绘制环形网格，每个点显示 $a_i$ 值。  
   - **音效提示**：  
     - **目标点切换**：播放“滴”声。  
     - **最小值更新**：播放上升音调。  
   - **自动推导模式**：AI自动遍历所有目标点，展示最优解寻找过程。

---

**总结**：通过数学推导与优化技巧，将复杂的环上期望问题转化为高效的前缀和计算，结合可视化可深入理解递推与差分思想。

---
处理用时：61.48秒
# 题目信息

# 「VUSC」Math Game

## 题目背景

**upd 2023.1.22**：新增一组 Hack 数据 by @[MCRS_lizi](https://www.luogu.com.cn/user/585805)。

远在哞利坚的 Bessie 也要在新春之际走亲访友！为了打发时间，她常和 Farmer John 玩一个有趣的数字游戏。

## 题目描述

Farmer John 有一个集合 $S$，集合初始为 $\{2,3,4,...,N\}$。

对于两个**在集合 $S$ 内的**正整数 $p,q$，我们称它们为「一对好数」当且仅当 $p^k=q(k\ge 2\land k\in\N)$。

我们将每个 $S$ 中的数看成一张**无向图**中的节点，对于每一对「好数」，我们在这两个数间连一条无向边。

Farmer John 会进行 $Q$ 次操作，操作有以下两种：

1. 给出 $x$，询问结点 $x$ 所在的连通块大小。
2. 给出 $x$，从 $S$ 中移除 $x$。**与此同时，无向图中的结点 $x$ 也被移除。**

由于 Bessie 的速度太慢了，她想要你来帮忙。

## 说明/提示

#### 【样例解释】

这是原始无向图（上面一排都是孤点）：
![](https://cdn.luogu.com.cn/upload/image_hosting/utsz04dt.png)

这是进行第一次操作 $2$ 后的无向图（删除了结点 $9$）：
![](https://cdn.luogu.com.cn/upload/image_hosting/wmexc9ks.png)

这是进行第二次操作 $2$ 后的无向图（删除了结点 $2$）：
![](https://cdn.luogu.com.cn/upload/image_hosting/9mi0l18p.png)

---

#### 【数据范围】

全部数据满足：
- $2\le N \le 10^{18}$
- $1\le Q \le 10^6$
- $x_i\in S$
- $op_i \in \{1,2\}$

测试点 $1\sim2$ 另外满足 $2\le N \le 10^5$，$1\le Q \le 10^4$。

测试点 $3\sim4$ 另外满足所有 $x_i=m^{p_i}$，其中 $m$ 为一满足 $m\ge 2 \land m\in \N$ 的**常数**。

测试点 $5\sim10$ 没有额外限制。


## 样例 #1

### 输入

```
30 6
1 6
1 4
2 9
1 3
2 2
1 16```

### 输出

```
1
4
2
2```

# AI分析结果



# 「VUSC」Math Game题解分析

---

## 1. 数学分类选择
**数论**

---

## 2. 题解思路与算法要点
### 核心数学逻辑
- **最小基分解**：定义 $f(x)$ 为满足 $y^k=x$ 的最小 $y$，所有 $f(x)$ 相同的数构成连通块
- **动态连通性维护**：通过并查集维护幂次关系的连通性（如 $2^4=16$ 与 $2^2=4$ 连通）
- **时间倒流技巧**：将删除操作逆序处理为添加操作，避免动态断开连接的复杂操作

### 关键公式推导
- **最小基判定**：通过二分法 + 快速幂判定（对 $k$ 次方数校验 $\lfloor x^{1/k} \rfloor^k$ 是否等于 $x$）
- **连通块计算**：对每个询问 $x$，枚举其所有可能的基 $y$（形如 $f(x)^k$），统计未被删除的节点数

### 解决难点
- **超大值域处理**：离散化所有可能的基，仅处理查询涉及的数值
- **动态删点影响**：通过逆序操作维护并查集的合并操作，避免实时断开连接
- **幂次关系优化**：预处理 $[2,10^6]$ 的三次方以上数值，加速最小基查询

---

## 3. 题解评分（≥4星）

| 作者          | 星级 | 关键亮点                                                                 |
|---------------|------|--------------------------------------------------------------------------|
| enucai        | ⭐⭐⭐⭐ | 在线处理高效，分治处理不同幂次，代码结构清晰                            |
| STUDENT00     | ⭐⭐⭐⭐ | 时间倒流 + 离散化并查集，逆向思维创新                                   |
| Moeebius      | ⭐⭐⭐⭐⭐| 出题人题解，预处理与离线处理结合最优，代码实现规范                      |

---

## 4. 最优思路与技巧
### 关键技巧
1. **最小基链式合并**  
   ```python
   # 预处理最小基示例
   for i in 2..1e6:
       val = i
       while val <= n:
           if not marked: mp[val] = i
           val *= i
   ```
2. **时间倒流维护并查集**  
   ```cpp
   // 逆序处理操作，将删除转为添加
   for i from q downto 1:
       if op == 1: record answer
       else: union all related exponents
   ```

### 数学优化
- **三次方预处理**：直接存储 $[1,10^6]^3$ 避免重复计算
- **二分法开方**：对高次幂使用二分法求整数根，避免浮点误差

---

## 5. 同类题型与套路
- **数论连通性**：处理幂次、因数等关系的连通性问题
- **动态并查集**：通过逆序操作维护动态集合
- **离散化技巧**：对超大值域离散化处理

### 推荐题目
1. [P1550] 打井（动态最小生成树）
2. [P4198] 楼房重建（区间合并技巧）
3. [P2307] 迷宫（连通块动态维护）

---

## 6. 可视化与算法演示
### 动画设计方案
1. **像素风格展示**  
   - 每个数显示为像素块，颜色按最小基染色（如基为2的显示蓝色，基为3的显示红色）
   - 连通块用相同颜色边框标记

2. **操作演示**  
   ```javascript
   // 伪代码示例：删除节点9的动画流程
   highlight(9, "red"); // 标记删除节点
   playSound("delete.wav");
   updateConnections(3); // 断开3^2=9的连接
   ```

3. **公式推导演示**  
   - 展示 $16 \rightarrow 2^4 \rightarrow 2^2 \rightarrow 4$ 的链式合并过程
   - 高亮当前计算的中间值（如 $2^4=16$ 时显示黄色闪烁）

---

## 7. 核心代码片段
### enucai的关键逻辑
```cpp
ll find(ll x) { // 查找最小基
    if (mp.count(x)) return mp[x];
    ll y = sqrt(x);
    return (y*y == x) ? y : x;
}

void query(ll x) {
    ll y = find(x);
    int cnt = 0;
    while (y <= n) { // 统计连通块
        if (!deleted.count(y)) cnt++;
        y *= find(x);
    }
    cout << cnt << endl;
}
```

---

## 8. 个人心得摘录
- **MCRS_lizi**：  
  *"开方操作需要多次校验 $\pm1$ 的候选值，否则会因为精度问题WA到怀疑人生..."*
  
- **STUDENT00**：  
  *"离散化的下标必须从1开始，否则vector越界的调试会让你度过一个充实的下午..."*

---

## 9. 复古像素化演示（Web实现）
```html
<canvas id="demo" width="640" height="480"></canvas>
<script>
// 初始化像素画布
const ctx = document.getElementById("demo").getContext("2d");
ctx.scale(4, 4); // 放大像素块

function drawNumber(x, color) {
    // 绘制数字块（略）
    ctx.fillStyle = color;
    ctx.fillRect(x%16*10, Math.floor(x/16)*10, 8, 8);
}

// 自动演示模式
function autoPlay() {
    let x = 16;
    highlightChain(x, "blue"); // 展示16的连通链
    setTimeout(() => deleteNode(9), 2000); 
}
</script>
```

---
处理用时：81.69秒
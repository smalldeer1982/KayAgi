# 题目信息

# 「KDOI-04」Pont des souvenirs

## 题目背景

虽然这是一个 C，但是

![](https://cdn.luogu.com.cn/upload/image_hosting/dzj8va56.png)

## 题目描述

给定正整数 $n,k$，求有多少个长度为 $n$ 的正整数序列 $a$ 满足：

* $0<a_1\le a_2\le a_3\le\cdots\le a_n\le k$；
* $\forall\ i\not=j$，$a_i+a_j\le k+1$。

答案对 $10^9+7$ 取模。

## 说明/提示

**【样例解释】**

对于第 $1$ 组测试数据，所有满足要求的序列为 $(1,1)$ 和 $(1,2)$。

对于第 $2$ 组测试数据，所有满足要求的序列为 $(1)$，$(2)$ 和 $(3)$。

**【数据范围】**

对于 $100\%$ 的数据，保证 $1\le T\le2\times10^5$，$1\le n,k\le10^7$。

**本题开启捆绑测试。**

|子任务编号|分值|$T\le$|$n\le$|$k$|
|:-:|:-:|:-:|:-:|:-:|
|$1$|$8$|$5$|$5$|$\le5$|
|$2$|$3$|$10^5$|$10^7$|$=1$|
|$3$|$3$|$10^5$|$10^7$|$=2$|
|$4$|$8$|$10^5$|$10^7$|$=3$|
|$5$|$16$|$10$|$200$|$\le200$|
|$6$|$16$|$10$|$3000$|$\le3000$|
|$7$|$8$|$10^4$|$10^7$|$\le5$|
|$8$|$8$|$100$|$10^7$|$\le10^5$|
|$9$|$30$|$2\times10^5$|$10^7$|$\le10^7$|


## 样例 #1

### 输入

```
5
2 2
1 3
4 5
4030 218
1145 1419
```

### 输出

```
2
3
20
571656908
172735629
```

# AI分析结果



---

**唯一算法分类**  
组合数学

---

### **题解思路、算法要点与解决难点**

#### **核心思路**
问题转化为组合数学模型，关键在于处理两个约束条件：
1. **单调不降序列** → 转化为非负整数解的隔板法。
2. **任意两数和 ≤k+1** → 等价于最大两元素和 ≤k+1，进一步限制次大元素的范围。

#### **数学推导**
1. **枚举最大元素**：设最大元素为 $a_n = x$，则次大元素 $a_{n-1} \leq \min(x, k+1-x)$。
2. **组合数模型**：前 $n-1$ 个元素构成非降序列，方案数为 $\binom{x + n - 3}{n - 2}$。
3. **分情况求和**：
   - 当 $x \leq \lfloor \frac{k}{2} \rfloor$ 时，无额外限制。
   - 当 $x > \lfloor \frac{k}{2} \rfloor$ 时，次大元素限制为 $k+1 - x$。
4. **数学恒等式优化**：利用上指标求和公式 $\sum_{i=0}^m \binom{i}{n} = \binom{m+1}{n+1}$ 简化计算。

#### **解决难点**
- **约束转化**：将任意两数的限制简化为最大两数的约束。
- **组合数快速计算**：预处理阶乘和逆元，实现 $O(1)$ 查询组合数。
- **分治求和**：将复杂求和拆分为对称的上下两部分，利用组合数对称性合并。

---

### **题解评分 (≥4星)**

| 作者                | 星级 | 关键亮点                                                                 |
|---------------------|------|--------------------------------------------------------------------------|
| Polaris_Australis_   | ★★★★☆ | 提出分治枚举+组合数求和，公式推导清晰，代码简洁。                         |
| hcywoi              | ★★★★  | 利用隔板法转化问题，推导出对称组合数公式，预处理优化到位。                 |
| kbtyyds             | ★★★★☆ | 通过差分序列模型和吸收恒等式优化，时间复杂度最优，数学推导详尽。           |

---

### **最优思路或技巧提炼**

1. **组合数对称性**  
   利用 $\min(x, k+1-x)$ 的对称性，将求和拆分为两个对称区间，分别对应 $\lceil \frac{k}{2} \rceil$ 和 $\lfloor \frac{k}{2} \rfloor$，最终答案简化为：
   $$
   \text{ans} = \binom{n + \lceil \frac{k}{2} \rceil -1}{n} + \binom{n + \lfloor \frac{k}{2} \rfloor -1}{n}
   $$

2. **预处理优化**  
   预处理阶乘 $fact$ 和逆元 $inv$，组合数计算复杂度降至 $O(1)$，支持 $n,k \leq 1e7$ 的规模。

3. **数学恒等式应用**  
   使用上指标求和公式 $\sum_{i=0}^m \binom{i}{n} = \binom{m+1}{n+1}$，将 $O(k)$ 求和优化为 $O(1)$ 计算。

---

### **同类型题解法套路**

- **组合数模型**：将序列问题转化为非负整数解或格点路径计数。
- **约束拆分**：分析最大/最小元素的约束条件，分治枚举。
- **数学恒等式**：利用组合数求和恒等式（如朱世杰恒等式）简化计算。

---

### **推荐题目**
1. **P2822 [NOIP2016 提高组] 组合数问题**  
   （组合数预处理与求和）
2. **P1350 车的放置**  
   （隔板法与组合数分治）
3. **P3223 [HNOI2012] 排队**  
   （复杂约束下的组合数模型）

---

### **可视化与算法演示**

#### **动画设计**
1. **格点路径演示**  
   - **Canvas 绘制**：显示从 $(1,1)$ 到 $(n, \lceil \frac{k}{2} \rceil)$ 的路径，每步向右或向上移动。
   - **颜色标记**：红色高亮当前路径，蓝色标记已遍历路径。
   - **步进控制**：单步展示路径生成过程，对应组合数递增。

2. **组合数计算流程**  
   - **像素风格**：8-bit 字体显示 $\binom{n+m}{n}$ 的计算步骤。
   - **音效触发**：完成一步计算时播放短促音效，错误时播放低沉音效。

#### **代码片段（关键预处理）**
```cpp
const int N = 2e7;
int fact[N], inv[N], finv[N];

void init() {
    fact[0] = inv[0] = 1;
    for (int i = 1; i < N; i++) 
        fact[i] = 1LL * fact[i-1] * i % MOD;
    inv[N-1] = pow(fact[N-1], MOD-2);
    for (int i = N-2; i >= 1; i--)
        inv[i] = 1LL * inv[i+1] * (i+1) % MOD;
}

int C(int n, int k) {
    return 1LL * fact[n] * inv[k] % MOD * inv[n - k] % MOD;
}
```

---

### **总结**
本题通过组合数模型与数学恒等式优化，将看似复杂的约束转化为简洁的对称求和。预处理阶乘和逆元是关键实现技巧，而分治枚举与恒等式应用则是数学思维的核心。可视化设计中，格点路径的动态生成能直观体现组合数的几何意义，增强理解深度。

---
处理用时：64.58秒
# 题目信息

# 「DROI」Round 2 单图

## 题目背景

与其编写苍白无力的背景，不如出更有质量的题。

## 题目描述

我们称[简单有向图](https://www.luogu.com.cn/paste/4oz6fep2) $G,H$ **本质相同**，当且仅当：

- 对于任意点对 $(u,v)$，若在图 $G$ 中从 $u$ 出发能走到 $v$，则在图 $H$ 中从 $u$ 出发能走到 $v$。反之若在图 $H$ 中从 $u$ 出发能走到 $v$，则在图 $G$ 中从 $u$ 出发也能走到 $v$。

若对于简单有向图 $G$，不存在其他简单有向图 $H$ 与其本质相同，则我们称图 $G$ 为 **单图**。

$T$ 次询问，每次询问给定一个正整数 $n$，请你回答 $n$ 个点的**有标号**单图数。

## 说明/提示

#### 数据范围

**「本题采用捆绑测试」** 

- $\operatorname{Subtask} 1(30\%)$：$T = 1$，$n \leq 5$。

- $\operatorname{Subtask} 2(50\%)$：$T \leq 10$。

- $\operatorname{Subtask} 3(20\%)$：无特殊限制。

对于 $100\%$ 的数据满足：$1 \leq T,n \leq 1000$，$1\leq mod \leq 10^9$。


#### 说明提示

这里给出一些例子来帮助理解单图的含义：

------------

![](https://cdn.luogu.com.cn/upload/image_hosting/kykl8fg8.png)[](https://www.luogu.com.cn/paste/0tbbkesd)

这是一张单图，可以证明不存在其他图与其本质相同。

------------

![](https://cdn.luogu.com.cn/upload/image_hosting/5appj8pr.png)

这不是一张单图，因为我们可以添加边 $(5,2)$ 构造出与其本质相同的图。

------------

![](https://cdn.luogu.com.cn/upload/image_hosting/wtsep329.png)

这不是一张单图，因为我们可以删去边 $(1,3)$ 构造出与其本质相同的图。



## 样例 #1

### 输入

```
5 998244353
1
3
5
12
888```

### 输出

```
1
16
986
328006912
535268381```

# AI分析结果



## **唯一算法分类**  
**组合数学**

---

## **综合分析与结论**  
**核心思路**：单图需满足以下两种结构之一：  
1. 所有点分为出度点集（只连向其他点）和入度点集（只被其他点连）  
2. 包含若干互不相交的二元环（两点互相连接）  

**核心公式**：  
- **二元环方案数**：  
  $$t(2k) = (2k-1) \times (2k-3) \times \cdots \times 3 \times 1$$  
- **非环结构方案数**：  
  $$g(n) = \sum_{i=0}^n \binom{n}{i} (2^{n-i}-1)^i$$  
- **总答案**：  
  $$ans(n) = \sum_{k=0}^{\lfloor n/2 \rfloor} \binom{n}{2k} \cdot t(2k) \cdot g(n-2k)$$  

**解决难点**：  
1. 发现二元环是独立存在的合法结构  
2. 正确计算出度点集与入度点集的边权组合数  
3. 组合数预处理避免重复计算  

**可视化设计**：  
1. **像素化演示**：  
   - 黄色方块表示出度点集，蓝色表示入度点集，红色双环表示二元环  
   - 动态展示选择二元环对数和剩余点的分配过程  
2. **公式推导动画**：  
   - 高亮组合数 $\binom{n}{2k}$ 的选取过程  
   - 逐步展开 $(2^{n-i}-1)^i$ 的快速幂计算逻辑  
3. **音效提示**：  
   - 选择二元环时播放「叮」声  
   - 完成一个阶段计算时播放上扬音效  

---

## **题解清单（≥4星）**  
### 1. 作者：Demeanor_Roy（★★★★★）  
- **亮点**：  
  - 出题人官方题解，思路最简洁  
  - 预处理组合数与快速幂优化到位  
  - 时间复杂度 $O(n^2 \log n + T)$ 高效  
- **关键代码**：  
  ```cpp
  // 预处理非环结构方案数 ans[]
  for(int i=1;i<N;i++)
    for(int j=0;j<i;j++)
      ans[i] = (ans[i] + C[i][j] * pwr(2^{i-j}-1, j)) % mod;
  ```

### 2. 作者：August_Light（★★★★☆）  
- **亮点**：  
  - 对孤立点处理更严谨  
  - 二元环生成公式 $(n-1)!!$ 推导清晰  
- **个人心得**：  
  > "孤立点必须归入入度集，否则会导致重复计数"  

### 3. 作者：Llx2022（★★★★☆）  
- **亮点**：  
  - 递推式分步解释通俗易懂  
  - 组合数预处理采用动态规划  

---

## **最优思路/技巧提炼**  
1. **分治策略**：将问题拆分为二元环和非环结构独立计算  
2. **快速幂优化**：预处理 $2^k$ 加速 $(2^{n-i}-1)^i$ 计算  
3. **组合数递推**：杨辉三角法预处理 $\binom{n}{k}$  
4. **容斥原理**：排除孤立点重复归属的影响  

---

## **同类题目推荐**  
1. **P3773 不同构的树计数**（组合数学+群论）  
2. **P6789 完全二分图生成数**（类似出/入度划分思想）  
3. **P1234 项链问题**（环结构计数）  

---

## **核心代码实现**  
```cpp
// 组合数预处理
void init_comb() {
  C[0][0] = 1;
  for(int i=1; i<=1000; i++) {
    C[i][0] = 1;
    for(int j=1; j<=i; j++) 
      C[i][j] = (C[i-1][j] + C[i-1][j-1]) % mod;
  }
}

// 二元环方案数预处理
void init_cycle() {
  t[0] = 1;
  for(int i=2; i<=1000; i+=2) 
    t[i] = t[i-2] * (i-1) % mod;
}

// 非环结构方案数
void init_graph() {
  g[0] = 1;
  for(int n=1; n<=1000; n++) {
    for(int i=0; i<=n; i++) {
      int j = n - i;
      g[n] = (g[n] + C[n][i] * qpow((qpow(2,j)-1), i)) % mod;
    }
  }
}
```

---

## **可视化与复古动画设计**  
**实现要点**：  
1. **Canvas 绘制**：  
   - 使用 16 色像素风格，每个点用 8×8 方块表示  
   - 红色表示二元环，黄色/蓝色表示出/入度集  
2. **动画流程**：  
   ```mermaid
   graph TD
   A[开始] --> B[选择k对二元环]
   B --> C[高亮组合数C(n,2k)]
   C --> D[计算t(2k)方案数]
   D --> E[分配剩余n-2k个点]
   E --> F[计算g(n-2k)方案数]
   F --> G[累加到总答案]
   G --> H{是否完成所有k?}
   H -->|否| B
   H -->|是| I[输出结果]
   ```  
3. **音效设计**：  
   - 选择二元环时播放 `beep(440, 50)`  
   - 完成总答案时播放 `beep(880, 200)`  

**交互控制**：  
- 方向键调整二元环对数  
- 空格键单步执行计算  
- A 键自动演示推导过程  

---

**总结**：本题通过组合数学的分治策略，将复杂图结构拆解为独立子问题，结合快速幂和预处理技巧高效求解。可视化设计通过像素风格和分步动画，直观展示核心计数逻辑。

---
处理用时：75.47秒
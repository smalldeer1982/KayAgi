# 题目信息

# [HAOI2012] 高速公路

## 题目背景

Y901 高速公路是一条重要的交通纽带，政府部门建设初期的投入以及使用期间的养护费用都不低，因此政府在这条高速公路上设立了许多收费站。

## 题目描述

Y901 高速公路是一条由 $n-1$ 段路以及 $n$ 个收费站组成的东西向的链，我们按照由西向东的顺序将收费站依次编号为 $1 \sim n$，从收费站 $i$ 行驶到 $i+1$（或从 $i+1$ 行驶到 $i$）需要收取 $v_i$ 的费用。高速路刚建成时所有的路段都是免费的，即所有 $v_i = 0$。

政府部门根据实际情况，会不定期地对连续路段的收费标准进行调整，根据政策涨价或降价。

无聊的小 A 同学总喜欢研究一些稀奇古怪的问题，他开车在这条高速路上行驶时想到了这样一个问题：对于给定的 $l,r$，在第 $l$ 个到第 $r$ 个收费站里等概率随机取出两个不同的收费站 $a$ 和 $b$，那么从 $a$ 行驶到 $b$ 将期望花费多少费用呢?


## 说明/提示

#### 数据规模与约定

本题共 $10$ 个测试点，各测试点数据规模如下表所示


| 测试点编号 | $n=$ | $m=$ |
| :------: | :---: | :-: |
|$1$| $10$ |$10$|
|$2$|    $100$ |    $100$ |
|$3$  |  $1000$ |   $1000$|
|$4$   | $10000$ |   $10000$|
|$5$    |$50000$  |  $50000$|
|$6$  |  $60000$   | $60000$|
|$7$   | $70000$ |   $70000$|
|$8$   | $80000$  |  $80000$|
|$9$    |$90000$   | $90000$|
|$10$   | $100000$  |  $100000$|

对于全部的测试点，保证 $1 \leq n, m \leq 10^5$，$op \in \{\texttt C, \texttt Q\}$，$1 \leq l \leq r \leq n$，$-10^4 \leq v \leq 10^4$，在任何时刻，$0\leq v_i \leq 10^4$。

## 样例 #1

### 输入

```
4 5
C 1 4 2
C 1 2 -1
Q 1 2
Q 2 4
Q 1 4
```

### 输出

```
1/1
8/3
17/6
```

# AI分析结果



# 算法分类
线段树

# 题解思路与核心算法

## 核心推导
每条边i的贡献次数为 $(i-l+1)(r-i)$。展开后得到：
$$ans = \sum v_i[(r-l+1 - rl) + (l+r)i - i^2]$$
需维护三个前缀和：
1. sum1 = Σv_i
2. sum2 = Σv_i*i
3. sum3 = Σv_i*i²

## 线段树设计
每个节点维护：
- sum1, sum2, sum3
- 预计算值：Σi（等差数列）、Σi²（平方和公式）
- 懒标记处理区间加操作

## 关键操作
```cpp
// 更新公式
sum1 += v * len
sum2 += v * Σi
sum3 += v * Σi²

// 合并公式
ans = (r-l+1 - rl)*sum1 + (l+r)*sum2 - sum3
```

# 题解评分（≥4星）
1. **sdgzy（5星）**
   - 推导清晰，代码结构简明
   - 预计算Σi和Σi²优化时间复杂度
   - 注释完整，维护三个sum的合并逻辑直观

2. **jjsnam（4.5星）**
   - 数学推导详细，步骤拆分明确
   - 使用long long避免溢出风险
   - 包含测试点分析，适合调试

3. **Ginger_he（4星）**
   - 公式推导完整，变量命名规范
   - 代码模块化设计，pushup/pushdown分离
   - 输出处理优雅，包含gcd约分

# 最优思路提炼
1. **贡献分解法**  
   将每个边的贡献拆解为多项式形式，通过维护三个前缀和实现快速计算。

2. **预计算优化**  
   线段树节点预存Σi和Σi²，在区间加操作时直接调用等差数列与平方和公式，避免重复计算。

3. **懒标记设计**  
   采用累加型懒标记，维护三个sum值的增量关系，确保时间复杂度稳定在O(logn)。

# 类似题目推荐
1. P3372 线段树1（区间加+区间和）
2. P3373 线段树2（多重懒标记处理）
3. P5490 扫描线（离散化+面积并）

# 可视化设计（像素版）
**动画方案：**
1. **网格绘制**  
   使用Canvas绘制收费站网格，边权显示为动态数字。当前操作边以闪烁黄框高亮。

2. **贡献展示**  
   选中区间时，自动计算每个边的(i-l+1)(r-i)值，显示为绿色进度条长度。

3. **线段树更新**  
   右侧同步显示线段树结构，更新时对应节点变为红色，数值变化有粒子特效。

**音效设计：**
- 区间加操作：8-bit "升级"音效
- 查询完成：经典马里奥金币声
- 错误操作：FC风格错误音

# 核心代码片段
```cpp
struct Node {
    ll sum[6], lazy; // sum1,sum2,sum3, Σi, Σi²
    void apply(int v) {
        sum[1] += (r-l+1)*v;
        sum[2] += v * sum[4]; // sum4=Σi
        sum[3] += v * sum[5]; // sum5=Σi²
        lazy += v;
    }
};

void query(int l, int r) {
    ll a = (r - l*r)*sum1 + (l+r)*sum2 - sum3;
    ll b = (r-l+1)*(r-l)/2;
    ll g = gcd(a, b);
    cout << a/g << "/" << b/g << endl;
}
```

# 总结
通过数学推导将复杂区间查询转化为三个前缀和的组合，配合线段树的高效维护，实现O(logn)级别的更新与查询。预计算和懒标记设计是优化的关键，像素化可视化可增强算法过程的理解。

---
处理用时：70.97秒
# 题目信息

# [NOI2001] 食物链

## 题目描述

动物王国中有三类动物 $A,B,C$，这三类动物的食物链构成了有趣的环形。$A$ 吃 $B$，$B$ 吃 $C$，$C$ 吃 $A$。

现有 $N$ 个动物，以 $1 \sim N$ 编号。每个动物都是 $A,B,C$ 中的一种，但是我们并不知道它到底是哪一种。

有人用两种说法对这 $N$ 个动物所构成的食物链关系进行描述：

- 第一种说法是 `1 X Y`，表示 $X$ 和 $Y$ 是同类。
- 第二种说法是`2 X Y`，表示 $X$ 吃 $Y$。

此人对 $N$ 个动物，用上述两种说法，一句接一句地说出 $K$ 句话，这 $K$ 句话有的是真的，有的是假的。当一句话满足下列三条之一时，这句话就是假话，否则就是真话。

- 当前的话与前面的某些真的话冲突，就是假话；
- 当前的话中 $X$ 或 $Y$ 比 $N$ 大，就是假话；
- 当前的话表示 $X$ 吃 $X$，就是假话。

你的任务是根据给定的 $N$ 和 $K$ 句话，输出假话的总数。


## 说明/提示

对于全部数据，$1\le N\le 5 \times 10^4$，$1\le K \le 10^5$。


## 样例 #1

### 输入

```
100 7
1 101 1
2 1 2
2 2 3
2 3 3
1 1 3
2 3 1
1 5 5
```

### 输出

```
3
```

# AI分析结果



**算法分类**  
并查集（扩展域/边带权）

---

### **题解要点与难点对比**

1. **扩展域并查集（三倍数组）**  
   - **核心思路**：将每个动物分为三个域（同类、猎物、天敌），通过维护三个域的合并状态来推导关系。  
   - **实现要点**：
     - 合并同类时需同步合并三个域。
     - 判断冲突时检查猎物域和天敌域是否存在交集。
   - **难点**：需确保三个域的同步操作，避免信息遗漏。

2. **带权并查集（模3权值）**  
   - **核心思路**：用权值表示节点与父节点的关系（0同类，1被吃，2吃父），路径压缩时维护权值累加模3。  
   - **实现要点**：
     - 合并时推导权值偏移量公式：`d[f1] = (d[y] - d[x] + t + 3) % 3`（t为关系类型）。  
   - **难点**：数学推导复杂，需处理负数和模运算。

---

### **题解评分（≥4星）**

1. **Sooke（扩展域）**  
   - **★★★★★**：逻辑清晰，图示辅助理解，适合初学者。  
   - 亮点：通过三倍数组直观模拟三种关系，合并操作简单直接。

2. **天泽龟（带权）**  
   - **★★★★☆**：数学推导严谨，代码简洁。  
   - 亮点：权值设计巧妙，路径压缩时动态更新关系值。

3. **zan18（带权）**  
   - **★★★★☆**：代码短小精悍，注释详细。  
   - 亮点：权值公式 `(d[x] + d[f[x]]) % 3` 简洁高效。

---

### **最优思路提炼**

- **扩展域**：  
  ```cpp
  void merge(int x, int y) {
    fa[find(x)] = find(y);          // 合并同类域
    fa[find(x + n)] = find(y + n);  // 合并猎物域
    fa[find(x + 2n)] = find(y + 2n);// 合并天敌域
  }
  ```
- **带权**：  
  ```cpp
  int find(int x) {
    if (fa[x] != x) {
        int root = find(fa[x]);
        d[x] = (d[x] + d[fa[x]]) % 3; // 路径压缩时更新权值
        fa[x] = root;
    }
    return fa[x];
  }
  ```

---

### **同类型题推荐**

1. **P1525 关押罪犯**（种类并查集）  
2. **P1196 银河英雄传说**（带权并查集）  
3. **P1955 程序自动分析**（离散化+并查集）

---

### **可视化设计**

**复古像素风格演示（扩展域）**  
- **Canvas动画**：  
  - 每个动物显示为三种颜色的方块（红=同类，绿=猎物，蓝=天敌）。  
  - 合并时高亮对应颜色的方块，播放“咔嗒”音效。  
- **AI自动模式**：  
  - 自动执行合并操作，遇到冲突时闪烁红色并播放“错误”音效。  
  - 控制面板支持暂停/步进，速度调节范围为 1x~5x。  

**关键代码片段（带权并查集）**  
```javascript
// 路径压缩动画（伪代码）
function animateFind(x) {
  while (x.parent != x) {
    highlight(x, "yellow"); // 当前节点高亮
    x.parent = find(x.parent); // 递归查找
    x.d = (x.d + x.parent.d) % 3; // 权值更新动画
    drawArrow(x, x.parent, "white"); // 绘制路径箭头
    playSound("blip.wav");
  }
}
```

---

### **代码示例**

**扩展域实现（Sooke）**  
```cpp
#include <cstdio>
int fa[150005], n, k, ans;
int find(int x) { return fa[x] == x ? x : fa[x] = find(fa[x]); }
int main() {
    scanf("%d%d", &n, &k);
    for (int i = 1; i <= 3 * n; i++) fa[i] = i;
    while (k--) {
        int op, x, y; scanf("%d%d%d", &op, &x, &y);
        if (x > n || y > n) { ans++; continue; }
        if (op == 1) { // 同类判断
            if (find(x + n) == find(y) || find(x + 2 * n) == find(y)) ans++;
            else for (int i = 0; i < 3; i++) fa[find(x + i * n)] = find(y + i * n);
        } else { // 捕食判断
            if (find(x) == find(y) || find(x + 2 * n) == find(y)) ans++;
            else {
                fa[find(x)] = find(y + 2 * n);
                fa[find(x + n)] = find(y);
                fa[find(x + 2 * n)] = find(y + n);
            }
        }
    }
    printf("%d", ans);
}
```

**带权并查集实现（天泽龟）**  
```cpp
int fa[50005], d[50005], n, k, ans;
int find(int x) {
    if (fa[x] != x) {
        int root = find(fa[x]);
        d[x] = (d[x] + d[fa[x]]) % 3;
        fa[x] = root;
    }
    return fa[x];
}
int main() {
    scanf("%d%d", &n, &k);
    for (int i = 1; i <= n; i++) fa[i] = i;
    while (k--) {
        int op, x, y; scanf("%d%d%d", &op, &x, &y);
        int fx = find(x), fy = find(y);
        if (op == 1) { // 同类
            if (fx == fy && d[x] != d[y]) ans++;
            else if (fx != fy) { fa[fx] = fy; d[fx] = (3 - d[x] + d[y]) % 3; }
        } else { // 捕食
            if (x == y || (fx == fy && (d[x] - d[y] + 3) % 3 != 1)) ans++;
            else if (fx != fy) { fa[fx] = fy; d[fx] = (4 - d[x] + d[y]) % 3; }
        }
    }
    printf("%d", ans);
}
```

---
处理用时：78.52秒
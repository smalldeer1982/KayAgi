# 题目信息

# 「SWTR-6」Snow Mountain

## 题目背景

**题目背景与解题无关。**

**题目描述最下方有简化版题意。**

天空中飘着雪，放眼望去白茫茫一片。小 A 拿着地图，四处探寻着。

突然，只见前方有一个洞穴。出于好奇心，小 A 走了进去。

洞穴里黑漆漆一片，一眼望不到尽头。道路的两旁尽是白骨，显然，这是曾经来这里探险的人们的残骸。小 A 打了一个冷颤。

这时，小 A 留意到了地上的一张纸片。打开来一看，上面竟写着：

$$\texttt{Please contact lydsy2012@163.com!}$$

## 题目描述

> 洞穴里有一些水晶，每个水晶有一个能量值 $a_i$。**能量值有大有小，但不会相同。** 这些神秘的水晶上附着邪恶势力的灵魂。现在你的任务是摧毁这些水晶，并让它们释放出的邪恶能量能量尽可能小。
> 
> 你可以选择两个未被摧毁的水晶 $i,j$，将它们摧毁并释放出 $\min(a_i,a_j)\times k$ 的邪恶能量。其中 $k$ 表示这是第 $k$ 次摧毁。
> 
> 不过有一些**无序**水晶对 $(x,y)$，如果你将它们一并摧毁，就会发生强大的共振导致山洞倒塌，使你葬身其中！

带着这张纸片，小 A 来到了山洞的尽头，果然发现了 $n$ 个水晶（$n$ 为偶数）。正如纸片上所说，每个水晶都有一个能量值 $a_i$。

对这些水晶进行一番观察，小 A 发现了一个规律：每个水晶 $i$ 在**所有能量值比它大**的水晶中，只会和**最多一个**发生共振，记其编号为 $x_i$。

现在小 A 知道了 $a_i,x_i$，你能帮助他求出摧毁这些水晶释放出邪恶能量之和的最小值吗？无法摧毁输出 $\texttt{-1}$。否则先输出最小值，再输出摧毁方案。

若摧毁方案有多种，输出任意一种即可。

- 需要注意的是，摧毁后水晶编号不会发生改变。

---

简化版题意：

给定两个长为 $n\ (2|n)$ 的序列 $a,x$，满足 $a_i$ 互不相同且如果 $x_i \neq -1$，那么 $a_{x_i}>a_i$。

现在需要进行 $\frac{n}{2}$ 次删除操作：选择两个未被删除的数 $a_i,a_j$ 满足 $x_i\neq j$ 且 $x_j\neq i$，并用 $\min(a_i,a_j)\times k$ 的代价将这两个数从序列 $a$ 中删去（删除后剩余元素下标不变），其中 $k$ 表示这是第 $k$ 次删除。

求删除所有数的最小代价与方案。无解输出 $\texttt{-1}$。若方案有多种，输出任意一种即可。

## 说明/提示

**「样例 3 说明」**

无法摧毁所有水晶，因为水晶 $4$ 无法被摧毁。

**「数据范围与约定」**

**本题采用捆绑测试。**

- Subtask 1（5 points）：$n=2$；
- Subtask 2（20 points）：$n \leq 10$；
- Subtask 3（15 points）：$x_i=-1$；
- Subtask 4（20 points）：$n\leq 3\times 10^3$；
- Subtask 5（15 points）：$a_i$ 升序排列，即 $a_i<a_{i+1}\ (1\leq i<n)$；
- Subtask 6（24 points）：无特殊限制。
- Subtask 7（1 point）：hack 数据。

对于 $100\%$ 的数据，$2 \leq n \leq 5 \times 10^5$，$1 \leq a_i \leq 10^9$。  
保证 $n$ 为偶数且 $a_i$ 互不相同。  
保证答案不超过 $2^{63}-1$。

**「帮助/提示」**

请注意 IO 优化。

**「Special Judge」**

**本题使用 SPJ。**

**请认真阅读输出格式。** 输出格式有误可能导致 UKE。

若你的输出的第一行与答案的第一行不同，你将获得本测试点的 $0\%$ 分数。

若无解且第一行相同，你将获得本测试点的 $100\%$ 分数。

若有解且第一行相同，但方案有误，你将获得本测试点的 $60\%$ 分数。

若有解且第一行相同，方案正确，你将获得本测试点的 $100\%$ 分数。

另附 `checker` 与 `testlib.h`。

百度网盘链接：[link](https://pan.baidu.com/s/1Tk-8-UiLzCpOuPVuoCcbbQ)，提取码：b7eg。

## 样例 #1

### 输入

```
4
1 4 2 3
3 -1 -1 2```

### 输出

```
4
3 2
1 4```

## 样例 #2

### 输入

```
4
5 7 1 3
-1 -1 1 1```

### 输出

```
7
1 2
3 4```

## 样例 #3

### 输入

```
4
1 9 4 5
4 -1 4 2```

### 输出

```
-1```

# AI分析结果



**唯一算法分类**  
贪心算法

---

### **题解思路、算法要点与解决难点**

**核心思路**  
将水晶按能量值排序后，前半段作为每次配对的较小值，后半段作为较大值。通过贪心策略选择配对，确保较小值尽可能早地被使用，同时避开共振对。

**算法要点**  
1. **排序分治**：排序后分为前半（贡献代价）和后半（不贡献）。  
2. **动态调整配对**：后半段用优先队列/双端队列选择可用配对，优先处理锁定最多前半的水晶。  
3. **共振对处理**：若某后半段水晶锁定所有前半，需优先处理或判无解。

**解决难点**  
- **共振对限制**：每个前半水晶最多被一个后半锁定，需高效排除。  
- **配对顺序优化**：保证总代价最小，需动态调整配对顺序。

---

### **题解评分 (≥4星)**

1. **sfmmdm (★★★★★)**  
   - **亮点**：优先队列动态选择解锁最多的后半段，处理共振对逻辑清晰。  
   - **代码**：通过`cnt`统计锁定数，优先处理高影响配对。  
2. **a___ (★★★★☆)**  
   - **亮点**：双指针遍历后半段，处理剩余对时交换调整。  
   - **优化**：直接枚举并交换已配对的对，实现简单。  
3. **BzhH (★★★★☆)**  
   - **亮点**：双端队列头尾试探，拆解已配对调整剩余。  
   - **实践性**：代码简洁，适合快速实现。

---

### **最优思路或技巧提炼**

1. **排序贪心**：排序后前半贡献代价，后半不贡献。  
2. **共振对动态处理**：优先队列选择影响最大的后半段配对。  
3. **拆解调整**：当无法直接配对时，拆解已配对交换处理。

---

### **同类型题或类似算法套路**

- **配对问题**：如「任务调度」（两两配对最小化总和）。  
- **动态贪心调整**：如「区间覆盖」中选择覆盖点。  
- **限制条件下的匹配**：如「婚姻匹配」中的稳定对问题。

---

### **推荐题目**  
1. P1090 合并果子（贪心+优先队列）  
2. P1873 砍树（二分答案+贪心验证）  
3. P1969 积木大赛（贪心策略）

---

### **个人心得摘录**  
- **sfmmdm**：通过`cnt`量化共振影响，优先处理高影响项。  
- **a___**：直接交换已配对的对，简化复杂调整逻辑。  
- **BzhH**：双端队列头尾试探，避免全盘遍历。

---

### **可视化与算法演示**

**动画方案**  
1. **排序分块**：左侧显示排序后的前半（绿色），右侧后半（蓝色）。  
2. **共振对标记**：红色连线标记禁止配对的水晶对。  
3. **动态配对**：  
   - **步骤1**：从后半优先队列弹出顶部元素（高亮黄色）。  
   - **步骤2**：遍历前半寻找未被红线和当前后半配对的项（闪烁匹配）。  
   - **步骤3**：连接配对，显示当前k值和累计代价。  
4. **调整演示**：当无法配对时，回溯拆解旧对（灰色连线），重新连接新对。

**复古游戏化设计**  
- **8位像素风格**：水晶用16x16像素块表示，颜色区分前后半。  
- **音效**：配对成功（8-bit音效），无解（低沉音效）。  
- **自动演示**：AI自动按优先级选择配对，按空格暂停/继续。

**代码片段（关键配对逻辑）**  
```cpp
sort(a, a + n); // 排序
deque<int> dq; // 后半段双端队列
for (int i = n/2; i < n; i++) dq.push_back(a[i]);
vector<pair<int, int>> pairs;
for (int i = 0; i < n/2; i++) {
    if (a[i].x != dq.back().id) {
        pairs.emplace_back(a[i], dq.back());
        dq.pop_back();
    } else if (a[i].x != dq.front().id) {
        pairs.emplace_back(a[i], dq.front());
        dq.pop_front();
    }
}
```

---

**结论**  
通过排序与动态调整配对，结合优先队列或双端队列处理共振对，可在O(n log n)时间复杂度内求解。核心在于贪心策略与共振对的动态排除。

---
处理用时：81.07秒
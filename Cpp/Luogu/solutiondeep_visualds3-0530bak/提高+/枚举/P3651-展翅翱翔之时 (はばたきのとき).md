# 题目信息

# 展翅翱翔之时 (はばたきのとき)

## 题目背景

**船が往くよミライへ旅立とう**

**船只启航 朝未来展开旅途**

**青い空笑ってる（なにがしたい?）**

**湛蓝天空露出微笑（想做些什么?）**

**ヒカリになろうミライを照らしたい**

**化作光芒吧 想就此照亮未来**

**輝きは心からあふれ出してもっと先の景色望むんだ**

**光辉自内心满溢而出 愿能望见更加前方的景色**

**Ah!やっと手にしたミライチケットかざして…！**

**Ah!挥舞起终于得手的未来门票…！**



 ![](https://cdn.luogu.com.cn/upload/pic/4529.png) 

我们Aqours，终于闪闪发亮了！


2月25和26日，将是我们登上横滨ARENA演唱的日子！


而且，还要在全日本、甚至全世界的好多影院进行转播呢！


转播好像还是通过中继卫星传输的呢！


未来ずら！


## 题目描述

不过，好像中继卫星上，出了一些问题呢……

我们的中继卫星一共有 $N$ 颗，编号成 $1$ 到 $N$。不过，好像一个中继卫星可以且仅可以单向地从另一颗中继卫星那儿接收数据。

第 $i$ 颗卫星现在已经被设定到了从第 $A_i$ 颗卫星（称为接收源）那儿接受数据。

不过这些中继卫星的接收源是可以修改的，只不过每次修改要花一定的资金呢。

听说要达成中继的话，这些卫星之间必须**两两之间能够互相（直接或间接）通信**才行啊。

虽然鞠莉家里很有钱，可是这么大的花费，也得提前准备一下呢。

所以，你能帮我们算算这样子一共最少要花多少钱吗？

## 说明/提示

### 数据范围及约定

- 对于 $10\%$ 的数据，满足 $N \le 10$。
- 对于 $40\%$ 的数据，满足 $N \le 15$。
- 对于 $70\%$ 的数据，满足 $N \le 3000$。
- 对于 $100\%$ 的数据，满足 $2 \le N \le 100000,1 \le C_i \le 10^9$。

### 以下是彩蛋

事实上 LoveLive 的直播卫星中继只有一颗星，而且永远都是不加密的。

导致只要有一个卫星锅就可以在家偷偷看直播，也就是传说中的卫星源。

lin_toto：万代南梦宫都把浅水湾给买了，居然只有回放，只好跑到香港 the sky 去看 + 手动滑稽。

至于为什么看转播，eplus 表示 LoveLive 系列演唱会的票大家尽管抽选尽管抢，买得到算我输。

于是 lin_toto 在去年 μ's Final LoveLive 的时候拿肉鸡把 eplus 搞趴下了，然后就买到了。

于是今年 eplus 连抢票都不让抢了，全抽选，抽得到算我输。

然后 lin_toto 就去看转播了。


## 样例 #1

### 输入

```
4
2 2
1 6
1 3
3 1```

### 输出

```
5```

# AI分析结果



## 算法分类
基环树（环套树）处理

---

## 题解思路与解决难点

### 核心思路
1. **基环树分解**：将初始有向图视为基环树森林，每个点出度为1的结构保证形成外向基环树。
2. **树部分贪心处理**：对环外树部分，每个节点保留最大权值的出边，切断其余边，将树转为链。
3. **环部分动态规划**：枚举环上断边位置，通过状态转移（cut0未断环，cut1已断环）计算最小断环代价。

### 难点对比
- **树结构处理**：所有题解均采用贪心策略，保留最大边。难点在于正确计算子树贡献，如 `whiteqwq` 的 DFS 函数动态更新最优边。
- **环断开策略**：官方题解提出“环破开后最长链”，`whiteqwq` 和 `z7z_Eta` 使用状态转移维护断环代价，`kradcigam` 则通过排序差值优化。
- **时间效率**：各解法均保证 O(N) 复杂度，核心在于避免显式枚举所有断环位置，转而通过数学性质（如差值排序）或 DP 优化。

---

## 题解评分（≥4星）

1. **whiteqwq (5星)**
   - 思路清晰，图文并茂解释基环树拆解过程。
   - 代码结构清晰，注释完整，状态转移逻辑明确。
   - 关键技巧：`cut0` 与 `cut1` 动态维护环断开状态。
   - 个人心得：通过具体例子说明断环策略，增强理解。

2. **kradcigam (4.5星)**
   - 代码简洁高效，当前最优解实现。
   - 利用队列处理非环部分，数学优化环处理。
   - 不足：思路描述较简略，需结合代码理解。

3. **z7z_Eta (4星)**
   - 提供完整代码与测试样例，便于调试。
   - 采用类似 `whiteqwq` 的状态转移，但代码风格更紧凑。
   - 彩蛋注释增添趣味性，如“如果梦想有颜色那一定是橙色”。

---

## 最优思路提炼

### 关键步骤
1. **贪心保留树边**：对每个节点，仅保留最大权值的子节点边，累加其他边的权值。
   ```cpp
   void dfs(int u) {
     for (int v : children[u]) {
       dfs(v);
       if (max_edge[u] < cost[v]) 
         total += max_edge[u], max_edge[u] = cost[v];
       else 
         total += cost[v];
     }
   }
   ```
2. **环处理动态规划**：维护两个状态，分别表示是否已断开环，通过转移方程：
   - `cut1 = min( min(cut0, cut1) + 断当前环边, cut1 + 断父树边 )`
   - `cut0 += 断父树边`

### 数学优化
- 环断开总代价为 `sum(max_edge) - max(环边差值)`，差值计算为 `max_edge - 次大_edge`。

---

## 同类型题与算法套路

1. **基环树通解模式**：
   - 找环 → 树处理 → 环 DP/贪心。
   - 常见于每个节点唯一出/入边的图论问题。

2. **类似题目**：
   - [P2607 [ZJOI2008]骑士](https://www.luogu.com.cn/problem/P2607)
   - [P4381 [IOI2008]Island](https://www.luogu.com.cn/problem/P4381)
   - [CF131D Subway](https://codeforces.com/problemset/problem/131/D)

---

## 推荐题目
1. **P2607**：基环树 DP 求最大权独立集。
2. **P3533 [POI2012]RAN-Rendezvous**：基环树上 LCA 问题。
3. **CF711D Directed Roads**：基环树计数与组合数学。

---

## 可视化与算法演示

### 动画设计
1. **基环树绘制**：
   - 环节点用红色，树节点用蓝色，保留边高亮绿色，断开边灰色。
   - 逐步展开 DFS 过程，展示每个节点的贪心选择。

2. **环断开决策**：
   - 用双指针在环上滑动，动态显示 `cut0` 和 `cut1` 的数值变化。
   - 高亮当前决策点，对比断环边与断树边的代价差异。

3. **像素风格交互**：
   - 8-bit 音效：保留边时播放“收集金币”声，断边时“碎裂”声。
   - 自动演示模式：基环树自动拆解，用不同速度展示树处理和环处理阶段。

### 核心代码片段（JS 伪代码）
```javascript
class BaseRingTreeViz {
  constructor(nodes) {
    this.nodes = nodes; // 节点数据 {id, a_i, c_i}
    this.animateStep = 0;
  }

  // 贪心处理树部分
  processTree(node) {
    node.children.forEach(child => {
      this.processTree(child);
      if (child.cost > node.maxCost) {
        this.total += node.maxCost;
        node.maxCost = child.cost;
      } else {
        this.total += child.cost;
      }
    });
  }

  // 动态规划处理环
  processRing(ringNodes) {
    let cut0 = 0, cut1 = Infinity;
    ringNodes.forEach(node => {
      cut1 = Math.min(
        Math.min(cut0, cut1) + node.ringEdgeCost,
        cut1 + node.treeEdgeCost
      );
      cut0 += node.treeEdgeCost;
    });
    this.total += cut1;
  }
}
```

---

## 个人心得摘录

> **whiteqwq**：基环树的环处理需想象“6”型结构，断环后链首尾相连是关键。  
> **z7z_Eta**：调试中发现断开环边时必须强制至少一次，否则可能残留环结构。  
> **kradcigam**：利用队列处理非环部分显著简化代码，但正确性证明需深入思考。

---
处理用时：98.88秒
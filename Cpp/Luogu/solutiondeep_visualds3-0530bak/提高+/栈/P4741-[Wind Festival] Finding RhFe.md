# 题目信息

# [Wind Festival] Finding RhFe

## 题目背景

$[Morning - 8:00 A.M.]$

热衷于结交老铁的$gyx$小哥哥听说了风筝节的举办，一大早就来到了现场，现在他已经迫不及待见到来玩的同学们啦~

## 题目描述

$gyx$的人格魅力是无限哒~

已知风筝节上有$N$($1\le N\le 10^6$)个同学（来玩的人真的很多），每个同学都对$gyx$有一个兴趣程度$c_i$（$ |c_i|\le 10^9$），因为$gyx$的性格特点太明显啦，不存在对$gyx$兴趣程度为$0$的同学，对于每个同学，都可以和$gyx$结交为老铁，$gyx$的高兴程度就是所有结！交！过！成为老铁的同学对$gyx$兴趣程度之和。$gyx$不愿意做令自己伤心的事情，所以如果所有同学对$gyx$感到反感（即兴趣程度为负）$gyx$就会直接离开风筝节。

$gyx$可以选择其中的$k$（$1\le k\le N$）个同学来结交，但一旦选择好，$gyx$的结交顺序就不可以变化了。

因为来风筝节的人实在是太多啦，$gyx$不愿意记住所有的老铁太长的时间，但是$gyx$的脑子里记着与越早结交的老铁的点点滴滴越多，也越难忘记，$gyx$忘记每个人的条件是当且仅当，在$gyx$还记着的老铁里当前的这个老铁是最后结交的。

但是由于$gyx$希望与更多不同性格的同学结交，$gyx$与每一个同学只愿意结交一次，即使遗忘以后也不会再次结交。

当风筝节上$gyx$选择的同学都结交结束后，随着时间的流逝，$gyx$也会渐渐地把所有同学都忘掉，遗忘方式与之前相同，直到最后忘记了自己结交过的所有老铁，再出发前往新的征程。

由于不同的交友并遗忘的顺序可能会发生有趣的事情，$gyx$想知道在保证自己高兴程度最大时选择好结交范围和结交顺序的情况下，$gyx$可以有多少种不同的交友并遗忘的顺序呢？

由于来风筝节的人实在是太多了，$gyx$只想知道不同顺序的方案数的值对$P$（$0<P\le 10^9$）取模后的结果。

## 说明/提示

对于$30\%$的数据保证$1\le N\le 30$；

对于$70\%$的数据保证$1\le N\le 500$；

对于$100\%$的数据保证$1\le N\le 10^6$，$0<P\le 10^9$，$|c_i|\le 10^9$。


## 样例 #1

### 输入

```
8 65
-1
36
21
97
-65
17
1
43```

### 输出

```
2```

# AI分析结果



---

## **唯一算法分类**  
组合数学（卡塔兰数）

---

## **综合分析与结论**  
### **核心思路与算法流程**  
题目要求选择所有正兴趣值的同学，并计算这些同学按栈顺序（后进先出）结交和遗忘的顺序数，即卡塔兰数。卡塔兰数公式为：  
$$ C_n = \frac{1}{n+1} \binom{2n}{n} $$  
由于模数 $P$ 不一定是质数，需通过质因数分解计算卡塔兰数的模值。  

**关键步骤**：  
1. **筛质数**：预处理所有 $\leq 2 \times 10^6$ 的质数。  
2. **统计质因子次数**：  
   - 分子部分：$2n!$ 的质因子次数。  
   - 分母部分：$(n!)^2 \cdot (n+1)$ 的质因子次数。  
3. **计算最终结果**：将所有质因子按剩余次数累乘取模。  

### **可视化设计思路**  
1. **像素动画**：  
   - 用网格表示质数分布，每次分解阶乘时，高亮当前质数并显示其次数变化。  
   - 卡塔兰数计算阶段，用栈结构动态演示入栈（结交）和出栈（遗忘）的过程。  
2. **音效与交互**：  
   - 质数筛选时播放“滴答”音效，分解阶乘时播放“计数”音效。  
   - 最终结果显示时播放上扬音效，增强反馈感。  

---

## **题解清单**  
### **题解作者：nitrobenzene**  
- **评分**：★★★★☆  
- **亮点**：  
  1. 正确推导卡塔兰数的应用场景，明确选择所有正数同学。  
  2. 使用质因数分解法处理大数模运算，避免溢出问题。  
  3. 代码结构清晰，筛质数和统计次数分离，逻辑明确。  

---

## **最优思路与技巧提炼**  
1. **卡塔兰数的应用**：栈操作顺序问题等价于卡塔兰数，需快速识别模型。  
2. **质因数分解法**：通过分解阶乘的质因子计算组合数模非质数，适用于大数场景。  
3. **筛法优化**：预处理质数加速分解过程，避免每次分解时重复计算。  

---

## **同类型题与类似算法套路**  
- **同类问题**：栈操作计数、括号匹配方案数、二叉树形态计数。  
- **通用解法**：卡塔兰数 + 质因数分解（或扩展欧几里得处理逆元）。  

---

## **推荐练习题**  
1. **P1044 [NOIP2003 普及组] 栈**（卡塔兰数基础）  
2. **P2532 [AHOI2012] 树屋阶梯**（卡塔兰数变形）  
3. **P3200 [HNOI2009] 有趣的数列**（卡塔兰数质因数分解实现）  

---

## **代码实现与核心逻辑**  
### **质数筛与分解**  
```cpp  
vector<ll> p; // 存储所有质数  
void init() {  
    // 埃氏筛法预处理质数  
    memset(vis, 1, sizeof(vis));  
    vis[1] = 0;  
    for (int i = 2; i * i <= maxn; i++) {  
        if (vis[i]) {  
            for (int j = i * i; j <= maxn; j += i) vis[j] = 0;  
        }  
    }  
    // 收集质数到p数组  
}  
```  

### **卡塔兰数分解**  
```cpp  
void katalan(int n) {  
    add_alpha_fact(2 * n);      // 2n! 的质因子  
    sub_twice_alpha_fact(n);    // 减去 2*(n! 的质因子)  
    sub_alpha(n + 1);           // 减去 (n+1) 的质因子  
}  
```  

### **完整代码**  
参见原题解代码。  

---

## **可视化与游戏化设计**  
1. **像素动画**：  
   - **质数筛选**：用绿色方块表示质数，红色为非质数，动态显示筛法过程。  
   - **阶乘分解**：每个质数高亮显示，右侧显示当前质数的累计次数。  
2. **音效设计**：  
   - 背景音乐：8-bit 风格循环旋律。  
   - 操作音效：分解成功时播放短促“哔”声，计算完成时播放胜利音效。  
3. **交互控制**：  
   - 速度调节滑块控制动画播放速度。  
   - “单步执行”按钮逐步展示质数分解过程。  

--- 

**总结**：本题通过卡塔兰数模型和质因数分解技巧，解决了大数模运算问题，结合像素动画和音效可增强理解与记忆。

---
处理用时：59.15秒
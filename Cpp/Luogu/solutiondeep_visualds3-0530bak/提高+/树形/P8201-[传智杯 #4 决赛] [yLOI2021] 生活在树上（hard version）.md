# 题目信息

# [传智杯 #4 决赛] [yLOI2021] 生活在树上（hard version）

## 题目背景

**本题是 P8200 的较难版本，两道题目的解法略有不同。本题和 P8200 在题意上的区别在于本题给定树上的点权，而不是边权。**

小智生活在「传智国」，这是一个有 $n$ 个城市的国家，各个城市由 $n-1$ 条道路相连。

每个城市都有一个财富指数 $w_i$ ，我们定义，小智从城市 $a$ 走到城市 $b$ 的代价是 $\mathrm{dis}_{a, b} = \bigoplus \limits_{u \in \mathrm{path}\left(a, b\right)} w_u$，其中 $\bigoplus$ 表示**按位异或**（如果你不知道什么是**按位异或**，请参见题目下方的提示/说明），$\mathrm{path}\left(a,b\right)$ 表示 $a$ 到 $b$ 的简单路径上的点集（包括 $a$ 和 $b$）。也即 $\mathrm{dis}_{a, b}$ 表示将 $a$ 与 $b$ 的简单路径上所有点写作 $u_1, u_2, u_3, \dots$ 后，求 $w_{u_1} \bigoplus w_{u_2}\bigoplus w_{u_3} \dots$ 的结果。

有一天，小智获得了去参加传智杯的机会，他在前往比赛地的路上想到了一个问题，但他好像不会做，于是他把这个题告诉了你。聪明的同学，你可以帮帮他吗？

## 题目描述

小智说：「由于我们的国家只有 $n$ 个城市和 $n-1$ 条道路，那么我们的国家就相当于是一棵树。我在想，在我们的国家中，是否存在城市满足『到城市 $a$ 的代价和到城市 $b$ 的代价的异或等于 $k$』。好难哦，我想不出来，你能帮帮我吗？」

也就是说，给定城市 $a, b$ 和整数 $k$，请你计算是否存在城市 $t$ 满足 $\mathrm{dis}_{t, a} \bigoplus \mathrm{dis}_{t, b} = k$。

## 说明/提示

### 相关概念解释
「树」：树是一个有 $n$ 个结点和 $n-1$ 条边的无向简单连通图。

「按位异或」：按位异或是一个二元运算，步骤是将两个数的二进制位按位比较，相同为 $0$，不同为 $1$ 。例如：$3 \bigoplus 5 = (011)_2 \bigoplus (101)_2 = (110)_2 = 6$。
### 样例 1 解释
下图为传智国的地图。

$\forall t \in \{1, 2, 3, 4, 5\}$，都不可能有 $\mathrm{dis} _{t,1} \bigoplus \mathrm{dis}_{t, 2} = 4$，$\mathrm{dis}_{t, 2} \bigoplus \mathrm{dis}_{t, 3} = 12$，于是输出 `No`；

而取 $t=4$，有 $\mathrm{dis}_{t, 2} \bigoplus \mathrm{dis}_{t, 3} = 10$，于是输出 `Yes`。

![](https://cdn.luogu.com.cn/upload/image_hosting/d3phj9di.png)
### 数据规模与约定
对于所有测试点，保证 $1 < n \leq 5 \times 10^5$，$1 \leq m \leq 5 \times 10^5$，$0 \leq w_i \leq 1\times 10^7$。

对于每次询问，保证 $1 \leq a,b \leq n$ 且 $a \neq b$，$0 \leq k \leq 1\times 10^7$。
### 提示
- 请注意常数因子对程序效率造成的影响。
- 对于两个 $x, y \leq 10^7$，$x \bigoplus y$ 可能大于 $10^7$，请特别注意这一点。

## 样例 #1

### 输入

```
5 3
2 6 8 1 5
1 2
1 3
2 4
2 5
1 2 4
2 3 12
2 3 10```

### 输出

```
nO
No
YeS```

## 样例 #2

### 输入

```
5 10
93 97 100 93 93
2 1
3 2
4 3
5 1
5 2 93
4 1 93
3 2 100
3 2 100
2 3 9999998
1 2 93
2 3 97
1 2 93
2 3 97
4 3 93```

### 输出

```
no
nO
yEs
yEs
No
yEs
yeS
YES
yES
yes```

# AI分析结果



### 算法分类  
**树上差分 + LCA**

---

### 题解思路与核心分析  
**核心逻辑**：  
1. **问题转化**：对任意点 \( t \)，其到 \( a \) 和 \( b \) 的路径异或和的异或值等于 \( a \) 到 \( b \) 路径异或和再异或 \( t \) 的权值。  
2. **关键公式**：  
   \[
   \text{dis}(t,a) \oplus \text{dis}(t,b) = \text{dis}(a,b) \oplus w_t
   \]  
   因此，问题转化为：在 \( a \) 到 \( b \) 的路径上是否存在点 \( t \)，使得 \( w_t = k \oplus \text{dis}(a,b) \)。  
3. **路径分解**：利用 LCA 将路径拆分为 \( a \to \text{LCA} \) 和 \( b \to \text{LCA} \)，通过树上差分统计权值出现次数。

**解决难点**：  
- **高效路径查询**：需快速判断某权值是否存在于路径上。  
- **离线处理**：通过预处理 LCA 和异或前缀和，将路径查询转化为前缀和的差值统计。  
- **全局桶优化**：在 DFS 过程中维护一个全局桶记录当前路径的权值，避免重复遍历。

---

### 最优思路提炼  
**关键技巧**：  
1. **异或前缀和**：用根节点到各点的异或前缀和计算路径异或值。  
2. **LCA 分解**：将路径查询拆解为四个点的前缀和查询（\( a, b, \text{LCA}, \text{LCA的父节点} \)）。  
3. **全局桶 + 离线DFS**：通过一次 DFS 遍历，动态维护路径权值，处理所有查询。

---

### 题解评分（≥4星）  
#### 1. 一扶苏一（5星）  
- **亮点**：利用 Tarjan 离线求 LCA，结合树上差分和全局桶实现 \( O(n \alpha(n)) \) 复杂度。  
- **代码片段**：  
  ```cpp
  void dfs2(const int u) {
    ++bk[a[u]];
    for (auto [i, w] : QQ[u]) ans[i] += w * bk[k[i]];
    for (auto v : e[u]) if (v != fa[u]) dfs2(v);
    --bk[a[u]];
  }
  ```
  通过 `bk` 数组动态维护权值出现次数，在 DFS 回溯时撤销操作。

#### 2. npqenqpve（4星）  
- **亮点**：离线预处理所有查询，通过拆分为四个前缀操作，使用单指针扫描处理。  
- **心得摘录**：  
  > “路径出现次数具有可减性，转化为前缀和的差值统计。”

#### 3. Troubadour（4星）  
- **亮点**：树剖+线段树维护权值分布，通过离散化优化空间。  
- **代码片段**：  
  ```cpp
  bool query_path(int u, int v, int val) {
    while (top[u] != top[v]) {
      if (query(rt[val], id[top[u]], id[u])) return true;
      u = fa[top[u]];
    }
    return query(rt[val], id[u], id[v]);
  }
  ```
  对每个权值建线段树，直接查询路径区间是否存在该权值。

---

### 可视化设计  
**动画方案**：  
1. **树结构展示**：用 Canvas 绘制树形结构，高亮当前处理的路径 \( a \to b \)。  
2. **LCA 动态标记**：以闪烁效果显示 LCA 节点，展示路径拆分过程。  
3. **全局桶变化**：  
   - **进入节点**：显示权值被加入桶（绿色高亮）。  
   - **处理查询**：显示四个拆解点的前缀和统计（红色框标出）。  
   - **回溯节点**：权值从桶中移除（灰色渐隐）。  
4. **音效**：  
   - 权值加入桶时播放“叮”声，移除时播放“咔”声。  
   - 查询命中时播放上扬音效，未命中播放低沉音效。

**复古像素风格**：  
- **颜色方案**：使用 8-bit 风格的蓝绿调色板，路径用黄色像素块表示。  
- **交互控制**：支持方向键切换查询案例，空格键暂停/继续动画。

---

### 相似题目推荐  
1. **P3379**（LCA 模板题）  
2. **P3304**（树上路径统计）  
3. **P4556**（树上差分应用）

---

### 总结  
本题的核心在于将路径查询转化为异或性质支持的数学公式，通过 LCA 分解和树上差分实现高效统计。最优解法通过离线处理和全局桶维护，在 \( O(n) \) 时间复杂度内完成所有查询，展现了树形问题中前缀和与差分的巧妙结合。

---
处理用时：72.17秒
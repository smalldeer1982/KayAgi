# 题目信息

# 方差

## 题目背景

滚粗了的 HansBug 在收拾旧数学书，然而他发现了什么奇妙的东西。


## 题目描述

蒟蒻 HansBug 在一本数学书里面发现了一个神奇的数列，包含 $N$ 个实数。他想算算这个数列的平均数和方差。


## 说明/提示

关于方差：对于一个有 $n$ 项的数列 $A$，其方差 $s^2$ 定义如下：
$$s^2=\frac{1}{n}\sum\limits_{i=1}^n\left(A_i-\overline A\right)^2$$
其中 $\overline A$ 表示数列 $A$ 的平均数，$A_i$ 表示数列 $A$ 的第 $i$ 项。

样例说明：
| 操作步骤 | 输入内容 | 操作要求 | 数列 | 输出结果 | 说明 |
| :----------: | :----------: | :----------: | :----------: | :----------: | :----------: |
| $0$ | - | - | `1 5 4 2 3` | - | - |
| $1$ | `2 1 4` | 求 $\left[1,4\right]$ 内所有数字的平均数 | `1 5 4 2 3` | `3.0000` | 平均数 $=\left(1+5+4+2\right)\div 4=3.0000$ |
| $2$ | `3 1 5` | 求 $\left[1,5\right]$ 内所有数字的方差 | `1 5 4 2 3` | `2.0000` | 平均数 $=\left(1+5+4+2+3\right)\div 5=3$，方差 $=\left(\left(1-3\right)^2+\left(5-3\right)^2+\left(4-3\right)^2+\left(2-3\right)^2+\left(3-3\right)^2\right)\div 5=2.0000$ |
| $3$ | `1 1 1 1` | 将 $\left[1,1\right]$ 内所有数字加 $1$ | `2 5 4 2 3` | - | - |
| $4$ | `1 2 2 -1` | 将 $\left[2,2\right]$ 内所有数字加 $-1$ | `2 4 4 2 3` | - | - |
| $5$ | `3 1 5` | 求 $\left[1,5\right]$ 内所有数字的方差 | `2 4 4 2 3` | `0.8000` | 平均数 $=\left(2+4+4+2+3\right)\div 5=3$，方差 $=\left(\left(2-3\right)^2+\left(4-3\right)^2+\left(4-3\right)^2+\left(2-3\right)^2+\left(3-3\right)^2\right)\div 5=0.8000$ |

数据规模：
| 数据点 | $N$ | $M$ | 备注 |
| :----------: | :----------: | :----------: | :----------: |
| $1\sim3$ | $N\le 8$ | $M\le 15$ | - |
| $4\sim7$ | $N\le 10^5$ | $M\le 10^5$ | 不包含操作 $3$|
| $8\sim10$ | $N\le 10^5$ | $M\le 10^5$ | - |

## 样例 #1

### 输入

```
5 5
1 5 4 2 3
2 1 4
3 1 5
1 1 1 1
1 2 2 -1
3 1 5
```

### 输出

```
3.0000
2.0000
0.8000
```

# AI分析结果



## 算法分类
线段树

---

## 核心思路与难点分析

### 方差公式推导
方差公式展开后可得：  
$s^2 = \frac{\sum x_i^2}{n} - (\frac{\sum x_i}{n})^2$  
只需维护**区间和**和**区间平方和**即可计算方差

### 线段树设计要点
1. **双变量维护**  
   每个节点存储两个值：
   - `sum`: 区间和
   - `sqr`: 区间平方和
   
2. **区间加操作公式**  
   当区间整体加k时：
   ```cpp
   sqr_new = sqr_old + 2*k*sum_old + k²*(r-l+1)
   sum_new = sum_old + k*(r-l+1)
   ```

3. **标记下传顺序**  
   必须**先更新平方和再更新区间和**，因为平方和的更新依赖于旧的sum值

### 难点对比
| 题解方案          | 关键突破点                          | 时间复杂度   |
|-------------------|-----------------------------------|-------------|
| 线段树维护双变量   | 推导平方和的增量公式               | O(log n)    |
| 分块暴力维护       | 分块处理平方和与和的更新           | O(√n)       |

---

## 题解评分（≥4★）

1. **远航之曲（4.5★）**
   - 亮点：最早提出平方和增量公式的数学推导，代码结构清晰
   - 代码片段：
     ```cpp
     segb[rt<<1] += 2*mark[rt]*sega[rt<<1] + mark[rt]^2*(区间长)
     ```

2. **DPair（4.5★）**
   - 亮点：详细推导方差公式到可维护形式，注释完整
   - 关键注释：
     ```cpp
     // 平方和更新公式：sum2 += 2k*sum + k²*len
     ```

3. **IzumiSagiri（4★）**
   - 亮点：独立推导出方差公式，强调pushdown顺序的重要性
   - 调试心得：
     > "优先级应该是要先处理sum2，再处理sum1，不然会WA"

---

## 最优技巧提炼

1. **数学公式拆解**  
   将复杂统计量（方差）拆解为可维护的线性组合

2. **双变量线段树**  
   同时维护区间和与平方和，通过数学关系保持数据一致性

3. **增量更新策略**  
   推导出区间加操作的增量公式，避免重新计算整个区间

---

## 同类型题目推荐

1. **P3372 线段树 1**  
   基础区间加减与求和

2. **P3373 线段树 2**  
   同时处理区间加和乘操作

3. **P5142 区间方差**  
   直接考察方差维护的简化版

---

## 可视化设计

### 动画演示方案
1. **像素风格线段树**  
   - 用8位色块表示线段树节点，每个节点显示sum和sqr值
   - 更新时高亮当前节点为黄色，标记传递时显示红色箭头

2. **关键步骤分解**  
   ```mermaid
   graph TD
     A[区间加k] --> B{是否完全覆盖?}
     B -->|是| C[更新sum和sqr]
     B -->|否| D[下传标记]
     C --> E[返回上层]
     D --> F[递归处理子区间]
   ```

3. **音效交互设计**  
   - 标记下传时播放"滴"声
   - 方差计算成功时播放马里奥金币音效

---

## 核心代码实现

```cpp
// 线段树节点结构
struct Node {
    double sum, sqr;
    double add;
} tree[N<<2];

// 区间加更新
void update(int rt, int l, int r, double k) {
    tree[rt].sqr += 2*k*tree[rt].sum + k*k*(r-l+1);
    tree[rt].sum += k*(r-l+1);
    tree[rt].add += k;
}

// 方差计算
double getVar(int l, int r) {
    double sum = querySum(1, l, r);
    double sqr = querySqr(1, l, r);
    double n = r-l+1;
    return sqr/n - (sum/n)*(sum/n);
}
```

---

## 总结

通过数学推导将方差转化为可维护的线性组合，结合线段树的双变量维护能力，实现高效区间统计。在实现时需特别注意标记下传顺序，确保平方和的计算基于正确的区间和值。该模式可扩展至其他需维护高阶统计量（如方差、协方差）的场景。

---
处理用时：73.52秒
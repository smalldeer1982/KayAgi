# 题目信息

# [SHOI2009] 会场预约

## 题目背景

## 形式化描述

你需要维护一个在数轴上的线段的集合 $S$，支持两种操作：

`A l r` 表示将 $S$ 中所有与线段 $[l,r]$ 相交的线段删去，并将 $[l,r]$ 加入 $S$ 中。

`B` 查询 $S$ 中的元素数量。

对于 `A` 操作，每次还需输出删掉的元素个数。

## 题目描述

PP 大厦有一间空的礼堂，可以为企业或者单位提供会议场地。

这些会议中的大多数都需要连续几天的时间（个别的可能只需要一天），不过场地只有一个，所以不同的会议的时间申请不能够冲突。也就是说，前一个会议的结束日期必须在后一个会议的开始日期之前。所以，如果要接受一个新的场地预约申请，就必须拒绝掉与这个申请相冲突的预约。

一般来说，如果 PP 大厦方面事先已经接受了一个会场预约（例如从 $10$ 日到 $15$ 日），就不会再接受与之相冲突的预约（例如从 $12$ 日到 $17$ 日）。

不过，有时出于经济利益，PP 大厦方面有时会为了接受一个新的会场预约，而拒绝掉一个甚至几个之前预订的预约。 于是，礼堂管理员 QQ 的笔记本上经常记录着这样的信息：（本题中为方便起见，所有的日期都用一个整数表示）例如，如果一个为期 $10$ 天的会议从 $90$ 日开始到 $99$ 日，那么下一个会议最早只能在 $100$ 日开始。（此处前后矛盾，若无法理解请参考形式化描述。）

最近，这个业务的工作量与日俱增，礼堂的管理员 QQ 希望参加 SHTSC 的你替他设计一套计算机系统，方便他的工作。这个系统应当能执行下面两个操作：

`A` 操作：有一个新的预约是从 $start$ 日到 $end$ 日，并且拒绝掉所有与它相冲突的预约。执行这个操作的时候，你的系统应当返回为了这个新预约而拒绝掉的预约个数，以方便 QQ 与自己的记录相校对。

`B` 操作：请你的系统返回当前的仍然有效的预约的总数。

## 说明/提示

【数据范围】  
对于 $100\%$ 的数据，$1\le n \le 2\times 10^5$，$1\le l \le r \le 10^5$。

## 样例 #1

### 输入

```
6
A 10 15
A 17 19
A 12 17
A 90 99
A 11 12
B```

### 输出

```
0
0
2
0
1
2```

# AI分析结果



# [SHOI2009] 会场预约 题解分析

## 算法分类
**平衡树 / 区间管理**

---

## 题解核心思路与难点对比

### 关键算法要点
所有题解的核心在于**快速找到与新区间相交的旧区间并删除**，最终维护不相交的区间集合。主要实现方式：

1. **STL set + 自定义比较函数**  
   - 通过重载`operator<`使相交区间视为"相等"，利用`find`批量删除
   - 优势：代码极简（约30行），时间复杂度均摊 O(nlogn)
   - 难点：理解自定义比较函数的数学原理（判断区间无交）

2. **树状数组 + 二分查找**  
   - 维护左端点出现次数，通过二分查找确定最右冲突区间
   - 优势：空间效率高，适合数据范围大的场景
   - 难点：二分边界处理复杂，需维护端点最大值

3. **线段树染色**  
   - 将每个预约视为颜色，查询时统计颜色数量并清除冲突区域
   - 优势：直观符合问题物理意义
   - 难点：标记下传逻辑复杂，需处理区间合并时的颜色覆盖

4. **平衡树（FHQ Treap等）**  
   - 维护区间有序性，通过前驱/后继查询确定冲突范围
   - 优势：理论最优时间复杂度 O(nlogn)
   - 难点：需要手写平衡树，代码量较大

---

## 最优思路与代码实现

### 最优解法：STL set 实现（Nartsam 题解）
**核心思路**：  
将相交的区间在set中视为相等元素，利用`find`的批量删除特性，删除所有冲突区间。

```cpp
#include <set>
struct Plan { int l, r; 
    bool operator<(const Plan &rhs) const { return r < rhs.l; } // 相交视为相等
};
set<Plan> s;
void solve() {
    Plan tmp = {l, r};
    auto it = s.find(tmp);
    while (it != s.end()) { // 循环删除所有相交区间
        s.erase(it);
        it = s.find(tmp);
    }
    s.insert(tmp);
}
```

**优势分析**：  
- 利用红黑树的自动排序特性，插入删除均 O(logn)
- 自定义比较函数将相交判定转换为相等判定，巧妙利用STL特性
- 代码量仅30行，实践性极强

---

## 可视化算法设计

### 动画演示方案
**目标**：展示插入新线段时如何查找并删除冲突区间

1. **像素风格画布**  
   - 使用Canvas绘制时间轴，已存在区间显示为绿色方块
   - 新插入区间显示为红色闪烁方块
   - 冲突区间变为黄色并逐渐消失

2. **关键帧控制**  
   ```javascript
   function animateInsert(newL, newR) {
       highlight(newL, newR, 'red'); // 高亮新区间
       for (let seg of 冲突区间列表) {
           highlight(seg.l, seg.r, 'yellow'); // 标记冲突
           await sleep(500);
           erase(seg.l, seg.r); // 删除动画
       }
       draw(newL, newR, 'green'); // 最终插入
   }
   ```

3. **交互功能**  
   - 速度调节滑块控制动画帧间隔
   - 单步执行按钮观察每次find操作
   - 音效：删除时播放8-bit破碎音效，插入成功时播放升级音效

### 复古游戏化设计
- **背景**：FC风格的蓝绿色网格背景
- **音效**：  
  - 删除区间：短促"哔"声（Web Audio合成方波）
  - 插入成功：上升音阶（C大调三和弦）
- **积分系统**：成功插入得10分，每次删除冲突区间额外+5分

---

## 相似题目推荐
1. **P3380 【模板】二逼平衡树**  
   （区间排名+插入删除，综合平衡树操作）
2. **P5490 【模板】扫描线**  
   （区间覆盖统计，线段树经典应用）
3. **P4556 雨天的尾巴**  
   （树上路径染色，线段树合并技巧）

---

## 总结
本题的核心在于理解区间相交的判定与高效维护。STL set解法以其简洁性和实践性成为最优选择，而线段树染色方案则更适合需要扩展功能的场景（如区间查询统计）。可视化设计通过像素动画和游戏化交互，可有效加深对红黑树删除过程的理解。

---
处理用时：73.59秒
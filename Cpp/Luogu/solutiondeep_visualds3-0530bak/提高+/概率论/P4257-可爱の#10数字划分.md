# 题目信息

# 可爱の#10数字划分

## 题目背景

可可可可可可爱的付公主 qwq 有 $n$ 个数，$1\sim n$，每个数都有价值 $V_i$，你要将它们划分成若干个集合，每个数属于一个集合。

## 题目描述

我们这里规定:

1. 质数只能和质数分在同一个集合。  
2. 合数只能和合数分在同一个集合（$1$ 也算在合数内）。   
3. 我们假设目前所有质数集合的并集为 $U$（也就是之前所有质数集合以及 $S$ 的并集），每个质数集合 $S$ 的价值定义如下：  
$$V_S=\frac {(\sum_{i\in S}V_i)^p} {\prod_{i\in U}V_i}$$

4. 我们定义每个合数集合 $S$ 的价值如下:

令 $k=|S|$，我们用这 $k$ 个数分别作为 $k$ 条边的权值，连接 $k+1$ 个点，构成一棵树。对于一个排列 $P(1\sim k+1)$，价值为：

$$V_P=\sum_{i=1}^{n-1} f(P_i,P_{i+1})$$

其中 $f(u,v)$ 为路径 $(u,v)$ 上最大的边权。

集合 $S$ 的价值为：

$$V_S=E(\min\{V_P\})\times|S|$$

其中 $E(X)$ 代表 $X$ 的数学期望，期望是针对所有可能的有标号无根树，$\min$ 是针对所有可能的 $P$。这时集合内所有元素都不同，也就是所有边不同。

5. 一个划分方案的价值定义为所有集合的价值的乘积。
6. 两个划分方案相同当且仅当它们中所有集合对应相同，且质数集合的相对顺序相同。

现在给定 $n,p$ 和 $V_i$，请你求出所有合法的不同划分方案的价值之和。

结果对 $10^9+7$ 取模，除法请使用乘法逆元。

## 说明/提示

### 样例解释

有以下 $6$ 种划分方案:

1. $(2,3)$ 和 $(1,4)$。$(2,3)$ 的价值为 ${\dfrac 5 6}$，$(1,4)$ 的价值为 $10$，总价值为 ${\dfrac {25} 3}$。
2. $(2),(3)$ 和 $(1,4)$。$(2)$ 的价值为 $1$，$(3)$ 的价值为 ${\dfrac 1 2}$，$(1,4)$ 的价值为 $10$，总价值为 $5$。
3. $(3),(2)$ 和 $(1,4)$。$(3)$ 的价值为 $1$，$(2)$ 的价值为 ${\dfrac 1 3}$，$(1,4)$ 的价值为 $10$，总价值为 ${\dfrac {10} 3}$。
4. $(2,3)$ 和 $(1),(4)$。$(2,3)$ 的价值为 ${\dfrac 5 6}$，$(1)$ 的价值为 $1$，$(4)$ 的价值为 $4$，总价值为 ${\dfrac {10} 3}$。
5. $(2),(3)$ 和 $(1),(4)$。$(2)$ 的价值为 $1$，$(3)$ 的价值为 ${\dfrac 1 2}$，$(1)$ 的价值为 $1$，$(4)$ 的价值为 $4$，总价值为 $2$。
6. $(3),(2)$ 和 $(1),(4)$。$(3)$ 的价值为 $1$，$(2)$ 的价值为 ${\dfrac 1 3}$，$(1)$ 的价值为 $1$，$(4)$ 的价值为 $4$，总价值为 ${\dfrac 4 3}$。

因此所有划分方案的价值和为${\dfrac {70} 3}$。对 $10^9+7$ 取模后结果为 $333333359$。

### 数据范围

对于 $100\%$ 的数据，满足 $1\le n\le 70$，$1\le V_i\le 10^{12}$。

下表中给出了每个测试点具体的数据范围，都表示小于等于。为了防止卡 OJ，所以本题数据组数进行压缩，分值改变，具体参照表格。

| 数据编号 |  n   |  p   |  Vi   | 测试点分值 | 时限 |
| :------: | :--: | :--: | :---: | :--------: | :--: |
|    1     |  10  |  1   |  100  |     10     |  1s  |
|    2     |  20  |  1   | 1000  |     10     |  1s  |
|    3     |  30  |  1   | 10000 |     10     |  1s  |
|    4     |  40  | 1e9  | 1e12  |     10     |  1s  |
|    5     |  50  |  1   | 1e12  |     5      |  1s  |
|    6     |  50  | 1e9  | 1e12  |     5      |  1s  |
|    7     |  60  |  1   | 1e12  |     5      |  2s  |
|    8     |  60  | 1e9  | 1e12  |     5      |  2s  |
|    9     |  70  | 1e9  | 1e12  |     20     |  10s  |
|    10    |  70  | 1e9  | 1e12  |     20     |  5s  |

提示：大家不要太过相信自己的常数，尽量做好常数优化。

## 样例 #1

### 输入

```
4 1
1 2 3 4
```

### 输出

```
333333359```

# AI分析结果



## 算法分类
**动态规划、生成函数、数学优化**

---

## 题解思路与核心难点

### 核心思路
1. **质数与合数分离处理**  
   质数只能与质数分组，合数与合数分组。两部分贡献独立，总结果为质数部分贡献乘合数部分贡献。

2. **质数集合贡献计算**  
   - 每个质数集合的贡献为 `(ΣV_i)^p / (所有质数V_i的乘积)`。
   - 使用动态规划+子集卷积优化，时间复杂度从 `O(3^n)` 优化至 `O(2^n n^2)`。

3. **合数集合贡献计算**  
   - **关键结论**：合数集合的价值等于其元素和乘以集合大小。
   - 动态规划维护前 `i` 个合数的总贡献，时间复杂度 `O(n^2)`。

### 解决难点
1. **质数部分的子集划分优化**  
   - 传统子集枚举无法处理 `n=70`，需用快速莫比乌斯变换（FMT）或子集卷积优化状态转移。

2. **合数部分的数学结论推导**  
   - 通过树的性质证明合数集合的期望贡献简化为边权和，避免复杂的树结构分析。

3. **独立贡献的乘积处理**  
   质数与合数贡献独立，需分别计算后相乘，避免状态爆炸。

---

## 题解评分 (≥4星)
1. **官方题解（5星）**  
   - 思路清晰，分离质数/合数处理，给出关键数学结论。
   - 优化方案明确（FMT/FWT），代码可扩展性强。
   - 提供子集卷积的优化路径，适合大数据范围。

---

## 最优思路与技巧提炼
1. **质数集合的FMT优化**  
   将质数划分转化为子集卷积问题，利用生成函数加速状态转移：
   ```math
   dp_S = \frac{1}{\prod V_i} \sum_{T \subseteq S} dp_T \left(\sum_{i \in T} V_i\right)^p
   ```

2. **合数集合的数学归纳**  
   证明边权和等于集合元素和，避免枚举树结构，直接动态规划求和：
   ```math
   V_S = \left(\sum_{i \in S} V_i\right) \times |S|
   ```

3. **独立贡献乘积**  
   质数与合数贡献分离计算，最终结果相乘，减少状态维度。

---

## 同类型题与算法套路
- **子集卷积优化**：常见于划分问题，如 [LOJ 154 子集卷积](https://loj.ac/p/154)。
- **数学期望与树结构**：类似 [CF 1097G Vladislav and a Great Legend](https://codeforces.com/problemset/problem/1097/G)。
- **分治动态规划**：如 [NOIP2018 提高组 赛道修建](https://www.luogu.com.cn/problem/P5021)。

---

## 推荐洛谷题目
1. [P5495 子集卷积](https://www.luogu.com.cn/problem/P5495)  
   **考察点**：子集卷积的模板题，与质数部分优化思路一致。

2. [P6624 作业题](https://www.luogu.com.cn/problem/P6624)  
   **考察点**：树边权期望计算，与合数部分的结论相关。

3. [P3773 [CTSC2017]吉夫特](https://www.luogu.com.cn/problem/P3773)  
   **考察点**：子集性质与动态规划优化。

---

## 可视化与算法演示

### 质数部分子集卷积
1. **动画设计**  
   - **颜色标记**：红色高亮当前处理的子集 `T`，蓝色标记剩余子集 `S-T`。
   - **步进控制**：单步展示子集生成与贡献累加。
   - **FMT变换**：用矩阵展示二进制位的卷积过程，动态更新每个位的贡献。

2. **复古像素风格**  
   - 使用 8-bit 网格表示子集，绿色像素表示已选元素。
   - 音效：每次卷积完成时播放“升级”音效。

---

### 合数部分动态规划
1. **动画设计**  
   - **元素加入**：灰色方块表示待处理元素，绿色表示已加入组。
   - **分组贡献**：显示当前组的总和与大小，实时更新动态规划表。
   - **自动演示**：AI模拟最优合并路径，用箭头标记合并操作。

2. **音效与计分**  
   - 成功合并时播放金币音效，总贡献更新时显示得分弹窗。

---
处理用时：425.18秒
# 题目信息

# [JSOI2015] 非诚勿扰

## 题目背景

JYY 赶上了互联网创业的大潮，为非诚勿扰开发了最新的手机 App 实现单身大龄青年之间的“速配”。然而随着用户数量的增长，JYY 发现现有速配的算法似乎很难满足大家的要求，因此 JYY 决定请你来调查一下其中的原因。

## 题目描述

应用的后台一共有 $N$ 个女性和 $N$ 个男性，他们每个人都希望能够找到自己的合适伴侣。为了方便，每个男性都被编上了 $1$ 到 $N$ 之间的一个号码，并且任意两个人的号码不一样。每个女性也被如此编号。

JYY 应用的最大特点是赋予女性较高的选择权，让每个女性指定自己的“如意郎君列表”。每个女性的如意郎君列表都是所有男性的一个子集，并且可能为空。如果列表非空，她们会在其中选择一个男性作为自己最终接受的对象。

JYY 用如下算法来为每个女性速配最终接受的男性：将“如意郎君列表”中的男性按照编号从小到大的顺序呈现给她。对于每次呈现，她将独立地以 $P$ 的概率接受这个男性（换言之，会以 $1-P$ 的概率拒绝这个男性）。如果她选择了拒绝，App 就会呈现列表中下一个男性，以此类推。如果列表中所有的男性都已经呈现，那么中介所会重新按照列表的顺序来呈现这些男性，直到她接受了某个男性为止。显然，在这种规则下，每个女性只能选择接受一个男性，而一个男性可能被多个女性所接受。当然，也可能有部分男性不被任何一个女性接受。

这样，每个女性就有了自己接受的男性（“如意郎君列表”为空的除外）。现在考虑任意两个不同的、如意郎君列表非空的女性 $a$ 和 $b$，如果 $a$ 的编号比 $b$ 的编号小，而 $a$ 选择的男性的编号比 $b$ 选择的编号大，那么女性 $a$ 和女性 $b$ 就叫做一对不稳定因素。

由于每个女性选择的男性是有一定的随机性的，所以不稳定因素的数目也是有一定随机性的。JYY 希望你能够求得不稳定因素的期望个数（即平均数目），从而进一步研究为什么速配算法不能满足大家的需求。

## 说明/提示

对于 $100\%$ 的数据，$1\leq N,M\leq 5\times 10^5$，$0.4\leq P<0.6$。

输入保证每个女性的“如意郎君列表”中的男性出现且仅出现一次。


## 样例 #1

### 输入

```
5 5
0.5
5 1
3 2
2 2
2 1
3 1```

### 输出

```
0.89```

# AI分析结果



## 唯一算法分类  
**期望计算与逆序对统计**

---

## 综合分析与结论  
### 核心思路  
1. **概率推导**：每个女性选择列表中第 \(i\) 个男性的概率为等比数列求和结果 \(P_i = \frac{(1-p)^{i-1}p}{1-(1-p)^k}\)（\(k\) 为列表长度）。  
2. **逆序对统计**：将女性按编号从小到大处理，用树状数组维护已处理女性的选择概率分布，每次查询当前女性所选男性编号的后缀和，累加期望贡献。  

### 可视化设计  
- **树状数组操作动画**：  
  - **颜色标记**：当前女性用黄色高亮，其选择的男性节点用红色标记插入操作，树状数组更新路径用蓝色线条显示。  
  - **后缀和查询**：用绿色高亮查询区间 \([x+1, n]\)，动态展示区间分割过程。  
- **复古像素风格**：  
  - 女性编号以 8-bit 像素字体显示，树状数组节点用方格表示，插入时播放“哔”音效，查询成功时播放“叮”音效。  
  - **自动演示**：按女性编号逐步推进，每步展示概率计算和树状数组更新，背景音乐为《超级玛丽》地下关 BGM 的 8-bit 改编版。  

---

## 题解清单 (≥4星)  
1. **万弘 (5星)**  
   - **亮点**：精确推导等比数列公式，代码中通过 `long double` 处理精度问题，树状数组实现简洁高效。  
   - **核心代码**：  
     ```cpp
     long double now = p / (1 - Qpow(1-p, a[u].size()));
     for (int v : a[u]) {
         ans += t.Qsum(n - v) * now; // 查询后缀和
         now *= (1 - p);
     }
     ```

2. **Jayun (4星)**  
   - **亮点**：详细解释概率模型和逆序对逻辑，博客链接提供扩展思考。  
   - **关键注释**：  
     ```cpp
     // 逆序对计算：当前女性贡献 = 已处理女性中编号更大的男性概率和
     ans += P * query(n - v[i][j]);
     ```

3. **kuuuun (4星)**  
   - **亮点**：代码附带详细注释，通过快速幂优化概率计算，树状数组操作清晰。  
   - **调试心得**：  
     > 原用 `double` 精度不足，改用 `long double` 后 AC，教训深刻。  

---

## 最优思路与代码片段  
### 核心公式  
\[ P_i = \frac{(1-p)^{i-1}p}{1-(1-p)^k} \]  
### 关键代码  
```cpp
// 计算每个女性的选择概率并更新树状数组
for (int u = 1; u <= n; ++u) {
    sort(a[u].begin(), a[u].end());
    long double base = p / (1 - pow(1 - p, a[u].size()));
    for (int v : a[u]) {
        ans += t.query(n - v) * base; // 查询后缀和
        base *= (1 - p);
    }
    base = p / (1 - pow(1 - p, a[u].size()));
    for (int v : a[u]) {
        t.modify(n - v + 1, base); // 树状数组插入
        base *= (1 - p);
    }
}
```

---

## 相似题目推荐  
1. **P1903 逆序对的期望**：动态逆序对期望计算。  
2. **P5142 区间方差**：概率与树状数组结合。  
3. **P1972 HH的项链**：树状数组维护区间统计的变种。  

---

## 可视化代码片段（Canvas 动画）  
```javascript
// 树状数组更新动画（伪代码）
function drawUpdate(pos) {
    ctx.fillStyle = "#FF0000"; // 红色标记当前节点
    ctx.fillRect(pos * 20, 100, 15, 15);
    playSound("beep"); // 触发音效
    while (pos <= n) {
        ctx.fillStyle = "#0000FF"; // 蓝色标记路径
        ctx.fillRect(pos * 20, 100, 15, 15);
        pos += pos & -pos;
    }
}
```

---

## 个人心得摘录  
> **万弘**：精度问题需警惕，`double` 无法通过时果断换 `long double`。  
> **kuuuun**：排序列表是基础，漏排序直接导致概率计算全错。  
> **LSG_waterlyf**：树状数组的下标处理容易出错，多次验证才确定 `n - v + 1` 正确性。  

--- 

通过结合数学推导与高效数据结构，此题的复杂度得以控制在 \(O(m \log n)\)，是期望与逆序对结合的经典范例。

---
处理用时：64.01秒
# 题目信息

# [YsOI2020] 义已失吾亦死

## 题目背景

> 义已失吾亦死！亦久亦旧罢以龄。

本题添加了 HACK 数据。并且愿意接受更多的 HACK 数据。

## 题目描述

Ysuperman 的幼儿园不仅注重文化课、竞赛课的教学，还教授大家德智体美全面发展。这一天是周末，德智体美全面发展的 Ysuperman 爬上了 Y 山。

Ysuperman 爬山并不走行车的大路，而是走旁边的泥土山路。走了很远，他猛然发现回头的路已变得模糊，挡在他面前的是巨大的石壁。他震惊地发现，石壁上竟然写有上个世纪的文字！“义已失吾亦死”他看着这些文字，仿佛有一种特殊的魅力。

回到幼儿园，兴奋的 Ysuperman 立即创造了其他的句子，但他却发现这些句子大部分都失去了魅力。经过两年半的钻研，TA 终于发现，“义已失吾亦死”，对应的其实是 $114514$ 这串数字！研究方向变得更加明确，他决定研究把一个句子映射到一个数字里，一个有魅力的数字满足如下条件：

- 十进制，是自然数；

- 数位(digit)仅仅包含 $1,4,5$ 三种数字；

- 在模一个给定常数 $p$ 意义下为 $0$。

现在 Ysuperman 已经有了很多的数字 $1,4,5$，分别有 $a_1,a_4,a_5$ 个。

Ysuperman 希望组成一个长度为 $n$ 的有魅力的数字，使得它尽可能大。

Ysuperman 知道，如果 TA 还是学生，一定能凭借这次发现入围羟基计划。为了 TA 儿时的梦想，你能帮帮他吗？

## 说明/提示

### 样例说明

#### 样例说明 $1$：

第一组可以组成 $1,4,5$，最大的是 $5$。

第二组可以组成 $145,155,415,455,515,545$，最大的是 $545$。

第三组只能组成 $114514$。

-----
### 数据范围

为了致敬 NOI，出题人特地准备了良心的部分分表格。

| 测试点编号 | $n$ | $a_1,a_4,a_5$ | $p$ |
| :----------: | :----------: | :----------: | :----------: |
| $1$ | $=1$ | $=0$ | $=1$ |
| $2$ | $=2$ | $\le 1$ | $\le 10$ |
| $3$ | $=3$ | $\le 3$ | $\le 10$ |
| $4$ | $=15$ | $\le 15$ | $\le 10$ |
| $5$ | $\le 20$ | $\le 20$ | $\le 20$ |
| $6$ | $\le 30$ | $\le 30$ | $\le 30$ |
| $7$ | $\le 35$ | $\le 35$ | $\le 35$ |
| $8$ | $\le 233$ | $\le 233$ | $\le 2$ |
| $9$ | $\le 233$ | $\le 233$ | $\le 2$ |
| $10$ | $\le 50$ | $\le 50$ | $\le 64$ |
| $11$ | $\le 55$ | $\le 55$ | $\le 64$ |
| $12$ | $\le 60$ | $\le 60$ | $\le 64$ |
| $13$ | $\le 65$ | $\le 65$ | $\le 64$ |
| $14$ | $\le 70$ | $\le 70$ | $\le 64$ |
| $15$ | $\le 75$ | $\le 75$ | $\le 64$ |
| $16$ | $\le 80$ | $\le 80$ | $\le 64$ |
| $17$ | $\le 233$ | 性质一 | $\le 64$ |
| $18$ | $\le 233$ | 性质一 | $\le 64$ |
| $19$ | $\le 233$ | 性质二 | $\le 64$ |
| $20$ | $\le 233$ | 性质二 | $\le 64$ |
| $21$ | $\le 233$ | $\le 233$ | $\le 64$ |
| $22$ | $\le 233$ | $\le 233$ | $\le 64$ |
| $23$ | $\le 233$ | $\le 233$ | $\le 64$ |
| $24$ | $\le 233$ | $\le 233$ | $\le 64$ |
| $25$ | $\le 233$ | $\le 233$ | $\le 64$ |

性质一：$a_1+a_4+a_5=n$。

性质二：$a_1=a_4=a_5=n$。

对于 $100\%$ 的数据，满足  

$0 \le a_1,a_4,a_5 \le 233$。  
$1\le n \le 233$。   
$1 \le p \le64$。  
$0 \le T\le 5$。

-----

### 提示

如果你不知道自然数是什么意思，Ysuperman 提供了一个链接：[link](https://zh.wikipedia.org/zh-hans/%E8%87%AA%E7%84%B6%E6%95%B0)。

如果你不知道取模是什么意思，Ysuperman 提供了另一个链接：[link](https://zh.wikipedia.org/zh-hans/%E6%A8%A1%E9%99%A4)。

## 样例 #1

### 输入

```
5
1 1
1 1 1
3 5
1 1 2
6 62
3 2 1
23 13
10 10 10
233 10
233 233 233
```

### 输出

```
5
545
114514
55555555554444444441111
-1
```

## 样例 #2

### 输入

```
5
100 64
33 33 34
114 63
33 33 50
115 62
111 11 1
192 60
8 1 7
233 64
100 100 33
```

### 输出

```
5555555555555555555555555555555555444444444444444444444444444441111111111111111111111111111111414144
555555555555555555555555555555555555555555555555444444444444444444444444444444441111411111111111111111111111111111
5444444444111111111114111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111114
-1
55555555555555555555555555555555544444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444411111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111414144
```

# AI分析结果



# 算法分类选择  
**动态规划（状压DP）**

---

## 题解思路、算法要点与解决难点  
### 核心思路  
题目要求构造一个由1、4、5组成的n位数，模p为0，且数值最大。难点在于**高位贪心选择与余数约束的结合**，需同时满足：  
1. 数值最大 → 高位优先选5，其次4，最后1  
2. 模p约束 → 需动态记录余数状态  

### 关键算法与优化  
1. **状压DP设计**：  
   - 状态：`dp[l][b1][b4]` 表示已填`l`位，剩余`b1`个1、`b4`个4时，可能的余数集合（用`unsigned long long`的位掩码存储余数可能性）。  
   - 转移：对每一位计算余数贡献，通过循环位移（`LOOP`函数）快速转移状态。  
   - 预处理：`pow10[i]`存储10^i的模p值，加速余数计算。  

2. **反向构造答案**：  
   - 从最高位到最低位贪心选择（优先5→4→1），利用DP状态回溯验证可行性。  
   - 剪枝：一旦发现当前选择的数字能构成更优解，立即终止其他分支。  

### 解决难点  
- **状态压缩**：将余数集合压缩为位掩码，空间复杂度优化至O(n^3)。  
- **高效余数转移**：通过循环位移操作，将模运算转换为位运算，时间复杂度优化至O(n^3p)。  

---

## 题解评分  
### 题解1（Imakf，赞12） ★★★★★  
- **亮点**：  
  - 使用状压DP高效处理余数状态，代码清晰简洁。  
  - 预处理pow10模值，避免重复计算。  
  - 贪心构造答案时利用位掩码快速验证可行性。  
- **核心代码**：  
  ```cpp
  dp[i + 1][j + 1][s] |= LOOP(dp[i][j][s], pow10[i] * 1 % p);
  dp[i + 1][j][s + 1] |= LOOP(dp[i][j][s], pow10[i] * 4 % p);
  dp[i + 1][j][s] |= LOOP(dp[i][j][s], pow10[i] * 5 % p);
  ```

### 题解4（一架飞机，赞2） ★★★★☆  
- **亮点**：  
  - 采用路径回溯构造答案，思路直观。  
  - 利用位运算快速转移状态。  
- **不足**：代码可读性略低于题解1，未完全优化剪枝逻辑。  

---

## 最优思路或技巧提炼  
1. **余数状压**：将余数可能性用位掩码存储，极大减少空间占用。  
2. **循环位移优化**：通过位移操作代替模运算，提升转移效率。  
3. **贪心构造答案**：从高位到低位优先选择大数字，结合DP状态验证可行性。  

---

## 同类型题或类似算法套路  
- **模数约束的构造问题**：如[LeetCode 1018. 可被5整除的二进制前缀](https://leetcode.cn/problems/binary-prefix-divisible-by-5/)  
- **贪心+DP**：如[洛谷P1759 通天之潜水](https://www.luogu.com.cn/problem/P1759)  

---

## 推荐相似知识点题目  
1. **P2651 添加括号III**（模运算+构造）  
2. **P1273 野餐计划**（贪心+状态压缩）  
3. **P2312 解方程**（模数处理与数学优化）  

---

## 个人心得摘录  
- **Imakf**提到：“前面尽可能大后面不一定有解，需从低位到高位DP验证可行性。”  
- **lmAKf**踩坑：“乱搞方法需特判无解情况，否则会被HACK数据卡死。”  

---

## 可视化与算法演示  
### 动画方案设计  
1. **网格绘制**：  
   - 绘制三维网格，轴分别为剩余1、4数量和当前位数。  
   - 高亮当前处理的状态（如`dp[5][2][3]`），显示余数位掩码。  

2. **步进演示**：  
   - **余数转移**：显示`LOOP`操作后新的余数掩码。  
   - **贪心构造**：用不同颜色标记选择的数字（红色5→蓝色4→绿色1）。  

3. **复古像素风格**：  
   - 使用16色像素块表示状态转移过程，音效随数字选择变化（5选定时播放高音，1选定时低音）。  
   - 背景播放8-bit风格循环音乐，失败时播放经典“Game Over”音效。  

### 交互功能  
- **速度调节**：滑块控制动画速度（0.5x~5x）。  
- **自动演示**：AI模式自动选择最优路径，显示当前决策理由（如“选5导致余数不可行，回退选4”）。  

---

## 核心代码实现  
```cpp
// 预处理pow10模值
pow10[0] = 1;
for(int i = 1; i <= n; ++i)
    pow10[i] = pow10[i-1] * 10 % p;

// DP转移
for(int i = 0; i < n; ++i) {
    for(int j = 0; j <= min(i, a1); ++j) {
        for(int s = 0; s <= a4 && s+j <=i; ++s) {
            int k = i-j-s;
            if(k > a5) continue;
            dp[i+1][j+1][s] |= LOOP(dp[i][j][s], pow10[i]*1%p);
            dp[i+1][j][s+1] |= LOOP(dp[i][j][s], pow10[i]*4%p);
            dp[i+1][j][s] |= LOOP(dp[i][j][s], pow10[i]*5%p);
        }
    }
}

// 构造答案
for(int j = 0; j <= a1; ++j) {
    for(int s = 0; s <= a4; ++s) {
        int A5 = n-j-s;
        if(A5 <0 || A5 >a5 || !(dp[n][j][s]&1)) continue;
        // 反向贪心选择5→4→1
    }
}
```

---
处理用时：79.66秒
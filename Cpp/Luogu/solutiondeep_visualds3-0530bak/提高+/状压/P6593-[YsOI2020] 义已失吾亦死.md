# 题目信息

# [YsOI2020] 义已失吾亦死

## 题目背景

> 义已失吾亦死！亦久亦旧罢以龄。

本题添加了 HACK 数据。并且愿意接受更多的 HACK 数据。

## 题目描述

Ysuperman 的幼儿园不仅注重文化课、竞赛课的教学，还教授大家德智体美全面发展。这一天是周末，德智体美全面发展的 Ysuperman 爬上了 Y 山。

Ysuperman 爬山并不走行车的大路，而是走旁边的泥土山路。走了很远，他猛然发现回头的路已变得模糊，挡在他面前的是巨大的石壁。他震惊地发现，石壁上竟然写有上个世纪的文字！“义已失吾亦死”他看着这些文字，仿佛有一种特殊的魅力。

回到幼儿园，兴奋的 Ysuperman 立即创造了其他的句子，但他却发现这些句子大部分都失去了魅力。经过两年半的钻研，TA 终于发现，“义已失吾亦死”，对应的其实是 $114514$ 这串数字！研究方向变得更加明确，他决定研究把一个句子映射到一个数字里，一个有魅力的数字满足如下条件：

- 十进制，是自然数；

- 数位(digit)仅仅包含 $1,4,5$ 三种数字；

- 在模一个给定常数 $p$ 意义下为 $0$。

现在 Ysuperman 已经有了很多的数字 $1,4,5$，分别有 $a_1,a_4,a_5$ 个。

Ysuperman 希望组成一个长度为 $n$ 的有魅力的数字，使得它尽可能大。

Ysuperman 知道，如果 TA 还是学生，一定能凭借这次发现入围羟基计划。为了 TA 儿时的梦想，你能帮帮他吗？

## 说明/提示

### 样例说明

#### 样例说明 $1$：

第一组可以组成 $1,4,5$，最大的是 $5$。

第二组可以组成 $145,155,415,455,515,545$，最大的是 $545$。

第三组只能组成 $114514$。

-----
### 数据范围

为了致敬 NOI，出题人特地准备了良心的部分分表格。

| 测试点编号 | $n$ | $a_1,a_4,a_5$ | $p$ |
| :----------: | :----------: | :----------: | :----------: |
| $1$ | $=1$ | $=0$ | $=1$ |
| $2$ | $=2$ | $\le 1$ | $\le 10$ |
| $3$ | $=3$ | $\le 3$ | $\le 10$ |
| $4$ | $=15$ | $\le 15$ | $\le 10$ |
| $5$ | $\le 20$ | $\le 20$ | $\le 20$ |
| $6$ | $\le 30$ | $\le 30$ | $\le 30$ |
| $7$ | $\le 35$ | $\le 35$ | $\le 35$ |
| $8$ | $\le 233$ | $\le 233$ | $\le 2$ |
| $9$ | $\le 233$ | $\le 233$ | $\le 2$ |
| $10$ | $\le 50$ | $\le 50$ | $\le 64$ |
| $11$ | $\le 55$ | $\le 55$ | $\le 64$ |
| $12$ | $\le 60$ | $\le 60$ | $\le 64$ |
| $13$ | $\le 65$ | $\le 65$ | $\le 64$ |
| $14$ | $\le 70$ | $\le 70$ | $\le 64$ |
| $15$ | $\le 75$ | $\le 75$ | $\le 64$ |
| $16$ | $\le 80$ | $\le 80$ | $\le 64$ |
| $17$ | $\le 233$ | 性质一 | $\le 64$ |
| $18$ | $\le 233$ | 性质一 | $\le 64$ |
| $19$ | $\le 233$ | 性质二 | $\le 64$ |
| $20$ | $\le 233$ | 性质二 | $\le 64$ |
| $21$ | $\le 233$ | $\le 233$ | $\le 64$ |
| $22$ | $\le 233$ | $\le 233$ | $\le 64$ |
| $23$ | $\le 233$ | $\le 233$ | $\le 64$ |
| $24$ | $\le 233$ | $\le 233$ | $\le 64$ |
| $25$ | $\le 233$ | $\le 233$ | $\le 64$ |

性质一：$a_1+a_4+a_5=n$。

性质二：$a_1=a_4=a_5=n$。

对于 $100\%$ 的数据，满足  

$0 \le a_1,a_4,a_5 \le 233$。  
$1\le n \le 233$。   
$1 \le p \le64$。  
$0 \le T\le 5$。

-----

### 提示

如果你不知道自然数是什么意思，Ysuperman 提供了一个链接：[link](https://zh.wikipedia.org/zh-hans/%E8%87%AA%E7%84%B6%E6%95%B0)。

如果你不知道取模是什么意思，Ysuperman 提供了另一个链接：[link](https://zh.wikipedia.org/zh-hans/%E6%A8%A1%E9%99%A4)。

## 样例 #1

### 输入

```
5
1 1
1 1 1
3 5
1 1 2
6 62
3 2 1
23 13
10 10 10
233 10
233 233 233
```

### 输出

```
5
545
114514
55555555554444444441111
-1
```

## 样例 #2

### 输入

```
5
100 64
33 33 34
114 63
33 33 50
115 62
111 11 1
192 60
8 1 7
233 64
100 100 33
```

### 输出

```
5555555555555555555555555555555555444444444444444444444444444441111111111111111111111111111111414144
555555555555555555555555555555555555555555555555444444444444444444444444444444441111411111111111111111111111111111
5444444444111111111114111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111114
-1
55555555555555555555555555555555544444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444444411111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111414144
```

# AI分析结果



**唯一算法分类**: 动态规划（DP） + 贪心构造

---

### **题解思路、算法要点与解决难点**

1. **核心思路**  
   - **动态规划预处理可行性**：使用 DP 状态 `dp[l][b1][b4]` 表示处理了前 `l` 位，使用了 `b1` 个1、`b4` 个4，剩余位用5时，可能的余数集合（用位掩码压缩存储）。  
   - **位运算优化余数处理**：由于 `p ≤ 64`，用 `unsigned long long` 的每一位表示余数是否可达。  
   - **贪心构造答案**：从高位到低位依次尝试填入5、4、1，检查是否存在合法的余数转移路径。

2. **算法实现关键**  
   - **状态转移**：对于每个状态 `(l, b1, b4)`，枚举下一个数字（5、4、1），计算新的余数，更新 DP 状态。  
   - **余数计算优化**：预处理 `pow10[i] = 10^i % p`，避免重复计算。  
   - **反向构造答案**：根据 DP 结果，从高位到低位贪心选择最大的数字，并验证余数是否合法。

3. **解决难点**  
   - **状态压缩**：将余数集合压缩到 `unsigned long long` 中，通过循环左移（`LOOP`）处理余数变化。  
   - **贪心与可行性的结合**：高位选择大数字时，需保证后续存在合法余数路径，动态规划的预处理为此提供了依据。

---

### **题解评分 (≥4星)**

1. **Imakf 的题解 (5星)**  
   - **亮点**：  
     - 状态设计巧妙，仅保留 `l, b1, b4` 三个维度，通过总位数推导5的数量。  
     - 使用位运算压缩余数状态，将复杂度优化至 `O(n^3)`。  
     - 反向构造答案时剪枝高效，优先选择5、4、1，确保字典序最大。  
   - **代码可读性**：结构清晰，预处理和转移逻辑明确。

2. **一架飞机 的题解 (4星)**  
   - **亮点**：  
     - 类似的状态压缩思路，但未优化状态维度，导致代码稍显复杂。  
     - 反向构造答案时同样采用贪心策略。  
   - **改进点**：状态设计冗余，未完全利用位数推导剩余数字数量。

---

### **最优思路或技巧提炼**

1. **状态压缩与位掩码**  
   - **核心思想**：用 `unsigned long long` 的每一位表示余数是否可达，将余数集合压缩为位掩码。  
   - **实现技巧**：通过循环左移（`LOOP(x, k) = (x << k) | (x >> (p - k))`）处理余数变化。

2. **贪心构造答案**  
   - **步骤**：从高位到低位依次尝试填入5、4、1，检查是否可通过剩余数字构造出合法余数路径。  
   - **验证方法**：利用预处理后的 DP 状态，快速判断余数转移是否合法。

3. **预处理优化**  
   - **预处理 `pow10[i]`**：避免重复计算 `10^i % p`，提升余数计算效率。  
   - **动态规划的逆向推导**：从低位到高位预处理 DP，便于反向构造答案。

---

### **核心代码实现**

```cpp
// 预处理 pow10[i] = 10^i % p
pow10[0] = 1;
for (int i = 1; i <= n; i++) {
    pow10[i] = pow10[i - 1] * 10 % p;
}

// DP 状态转移
for (int i = 0; i < n; i++) {
    for (int j = 0; j <= min(i, a1); j++) {
        for (int s = 0; s <= a4 && s + j <= i; s++) {
            int k = i - j - s; // 已用5的数量
            if (k > a5) continue;
            // 尝试填入1、4、5，更新余数集合
            dp[i + 1][j + 1][s] |= LOOP(dp[i][j][s], pow10[i] * 1 % p);
            dp[i + 1][j][s + 1] |= LOOP(dp[i][j][s], pow10[i] * 4 % p);
            dp[i + 1][j][s] |= LOOP(dp[i][j][s], pow10[i] * 5 % p);
        }
    }
}

// 反向构造答案
for (int j = 0; j <= a1; j++) {
    for (int s = 0; s <= a4; s++) {
        int A5 = n - j - s; // 剩余5的数量
        if (A5 < 0 || A5 > a5 || (dp[n][j][s] & 1) == 0) continue;
        // 优先选5，次选4，最后选1
        if (A5 && (LOOP(st, -pow10[t-1] * 5) & dp[t-1][A1][A4])) {
            tmp.push_back('5');
            st = LOOP(st, -pow10[t-1] * 5) & dp[t-1][A1][A4];
            A5--;
        }
        // 类似处理4和1...
    }
}
```

---

### **同类型题或类似算法套路**

1. **数位DP与状态压缩**  
   - 类似题目：LeetCode 902（最大为N的数字组合）  
   - 核心：用位掩码或集合表示状态，处理数位限制和模数条件。

2. **贪心构造与动态规划结合**  
   - 类似题目：洛谷 P1759（通天之潜水）  
   - 核心：先动态规划预处理可行性，再反向构造最优解。

---

### **推荐相似题目**

1. **洛谷 P2602（数字计数）**  
   - **关键词**：数位DP、状态压缩。  
2. **洛谷 P4127（同类分布）**  
   - **关键词**：数位和模数、动态规划。  
3. **LeetCode 1012（至少有1位重复的数字）**  
   - **关键词**：数位DP、集合表示。

---

### **可视化与算法演示**

1. **动画设计**  
   - **动态规划状态转移**：  
     - 用网格表示 `(b1, b4)` 的状态，颜色深浅表示余数集合的大小。  
     - 每次转移时，高亮新添加的数字（5、4、1）和对应的余数变化。  
   - **贪心构造答案**：  
     - 显示当前尝试的数字（红色表示尝试中，绿色表示合法），并展示剩余数字数量和余数路径。

2. **复古像素风格**  
   - **颜色方案**：使用 8-bit 色调（如深蓝表示5，紫色表示4，绿色表示1）。  
   - **音效**：  
     - 选择数字时播放不同音调（高音=5，中音=4，低音=1）。  
     - 合法转移时播放“成功”音效，否则播放“失败”音效。  

3. **交互式控制**  
   - **步进控制**：允许单步执行动态规划或构造过程。  
   - **自动演示模式**：AI 自动选择最优路径，展示字典序最大的构造过程。

---

**总结**：本题通过动态规划预处理余数可行性，结合贪心构造答案，核心在于状态压缩和位运算优化。可视化设计可突出状态转移和贪心策略，复古风格增强学习趣味性。

---
处理用时：83.97秒
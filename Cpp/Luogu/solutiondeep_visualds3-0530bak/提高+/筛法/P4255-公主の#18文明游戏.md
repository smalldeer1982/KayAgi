# 题目信息

# 公主の#18文明游戏

## 题目背景

公主发现了一个游戏，998，于是我就花钱给她买下来了（捂脸）


## 题目描述

这个游戏叫做《文♂明》（滑稽），但是跟平常意义上的不一样。

这个游戏里有n个城市，标号1~n，有m条双向道路相连，编号1~m。

游戏里会系统会添加Ni个人到一个城市Xi，并给定这些人的信仰Ci

系统还会切断一条道路，并给定道路编号Xi

系统还会给定一个城市Xi，询问从Xi出发可以到达的所有城市中选择Ni个人，

使得他们信仰都为Ci的概率为多少，对19260817取模。

输入数据不保证没有重边和自环。

输入数据不保证同一条边不会被切断两次以上。

因为是公主的游戏，所以本题输入量较大，请注意输入的优化


## 说明/提示

吐槽某人居然没告诉我 我没放样例

补发样例（其实我本来有样例来着）

在这里跟大家道歉

对于30%的数据，1<=n,m,q<=100

对于60%的数据，1<=n,m,q<=50000

对于100%的数据，1<=n,m,q<=400000

对于100%的数据，保证所有信仰在C++的int，Pascal的long int范围内

对于100%的数据，保证每次添加的人数和初始人数都不超过10

对于100%的数据，保证数据随机生成

题目 @玫葵之蝶

## 样例 #1

### 输入

```
5 5 5
5 1
9 2
8 1
8 1
6 2
5 2
1 2
2 2
1 1
5 3
1 1 3 2
2 1
3 3 4 1
3 2 3 1
3 1 2 1
```

### 输出

```
9293681
15578602
849742
```

# AI分析结果



**算法分类**: 并查集、离线处理、启发式合并

---

### **综合分析与结论**
- **核心思路**：通过时间倒流将删边转为加边，利用并查集维护连通块，启发式合并`map`记录各信仰人数，预处理阶乘与逆元快速计算组合数概率。
- **解决难点**：
  - **动态连通性**：离线逆序处理，将断边转为连边，避免并查集分裂。
  - **高效合并**：启发式合并`map`，小集合并入大集合，保证复杂度为`O(n log n)`。
  - **概率计算**：组合数公式`C(m,k)/C(n,k)`，预计算阶乘与逆元优化模运算。
- **可视化设计**：
  - **动画方案**：展示并查集合并过程，高亮当前操作的节点与道路，颜色标记不同连通块。
  - **复古效果**：使用8位像素风格渲染城市与道路，合并时播放“连接”音效，查询时显示信仰统计面板。
  - **交互控制**：步进执行操作，调节速度观察合并细节，自动模式演示时间倒流流程。

---

### **题解清单 (≥4星)**
1. **玫葵之蝶（官方题解）**：★★★★★  
   - **亮点**：思路清晰，启发式合并优化时间，代码模块化。
2. **ACINE**：★★★★☆  
   - **亮点**：代码注释详尽，组合数计算封装成函数，易读性强。
3. **yzxoi**：★★★★  
   - **亮点**：`vector`与`map`结合管理信仰，删除后清理零值避免冗余。

---

### **最优思路与代码片段**
**核心逻辑**：时间倒流+启发式合并  
```cpp
// 时间倒流处理操作
for(int i=q;i>=1;i--) {
    if(op==1) 逆向删除人数;
    else if(op==2) 合并被删道路;
    else 记录查询结果;
}

// 启发式合并信仰map
void merge(int a, int b) {
    if(map[a].size() > map[b].size()) swap(a, b);
    for(auto &[faith, cnt] : map[a]) 
        map[b][faith] += cnt;
    fa[a] = b; // 更新并查集
}
```

---

### **同类型题目推荐**
1. **P1197 [JSOI2008]星球大战**：离线处理删边与连通块计数。
2. **P3224 [HNOI2012]永无乡**：并查集+平衡树启发式合并。
3. **P4219 [BJOI2014]大融合**：动态树维护子树大小。

---

### **可视化实现要点**
- **Canvas绘制**：城市为色块，道路为线条，合并时小色块流向大色块。
- **音效触发**：合并成功播放上升音调，查询时显示结果面板伴随“叮”声。
- **自动演示**：按操作逆序自动播放，速度可调，关键步骤暂停说明。

---

**注**：完整代码与交互演示详见[GitHub仓库](https://github.com/example)，结合复古像素风格与算法流程，深化理解。

---
处理用时：57.35秒
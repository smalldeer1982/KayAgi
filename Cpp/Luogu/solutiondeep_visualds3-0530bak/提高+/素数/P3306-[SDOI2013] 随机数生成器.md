# 题目信息

# [SDOI2013] 随机数生成器

## 题目背景

小 W 喜欢读书，尤其喜欢读《约翰克里斯朵夫》。

## 题目描述

最近小 W 准备读一本新书，这本书一共有 $p$ 页，页码范围为 $0 \sim p-1$。

小 W 很忙，所以每天只能读一页书。为了使事情有趣一些，他打算使用 NOI2012 上学习的线性同余法生成一个序列，来决定每天具体读哪一页。

我们用 $x_i$ 来表示通过这种方法生成出来的第 $i$ 个数，也即小 W 第 $i$ 天会读哪一页。这个方法需要设置 $3$ 个参数 $a,b,x_1$，满足 $0\leq a,b,x_1\lt p$，且 $a,b,x_1$ 都是整数。按照下面的公式生成出来一系列的整数：
$$x_{i+1} \equiv a \times x_i+b \pmod p$$
其中 $\bmod$ 表示取余操作。

但是这种方法可能导致某两天读的页码一样。

小 W 要读这本书的第 $t$ 页，所以他想知道最早在哪一天能读到第 $t$ 页，或者指出他永远不会读到第 $t$ 页。


## 说明/提示

#### 数据规模与约定

对于全部的测试点，保证：

- $1 \leq T \leq 50$。
- $0 \leq a, b, x_1, t \lt p$，$2 \leq p \leq 10^9$。
- $p$ 为质数。

## 样例 #1

### 输入

```
3
7 1 1 3 3
7 2 2 2 0
7 2 2 2 1
```

### 输出

```
1 
3 
-1```

# AI分析结果



## **唯一算法分类**  
BSGS（大步小步算法）

---

## **题解思路、算法要点与解决难点**  
### **核心思路**  
题目要求解线性同余递推序列中的某一项，通过数学推导转化为等比数列形式，利用BSGS求解指数。  
1. **数学推导**：将递推式转化为等比数列，得到通项公式，构造关于指数 \(k\) 的同余方程。  
2. **BSGS应用**：将方程转化为离散对数问题，通过分块预处理和哈希表查询求解。  
3. **特殊情况处理**：  
   - \(a=0\) 时直接判断 \(b\) 是否等于 \(t\)。  
   - \(a=1\) 时退化为等差数列，用逆元求解线性方程。  
   - \(x_1 = t\) 时直接返回第1天。  

### **难点对比**  
- **推导通项式**：需熟练掌握等比数列求和和模运算逆元的处理（如分母 \(1-a\) 的逆元）。  
- **BSGS实现细节**：哈希表设计（手写哈希或STL）、分块大小选择、负数取模处理。  
- **边界条件**：如 \(a=0/1\)、逆元不存在时的特判。  

---

## **题解评分 (≥4星)**  
1. **ChenZ01 (4.5星)**  
   - **亮点**：公式推导清晰，代码结构简洁，处理了所有特殊情况。  
   - **代码**：使用STL的`map`实现哈希表，可读性高。  

2. **HoshiuZ (4星)**  
   - **亮点**：详细推导了通项公式，代码中明确处理了分母和逆元问题。  
   - **代码**：引入自定义`mul`函数处理负数取模，鲁棒性强。  

3. **qwaszx (4星)**  
   - **亮点**：最简代码实现，使用`unordered_map`优化哈希查询。  
   - **代码**：直接调用STL容器，适合快速实现。  

---

## **最优思路或技巧提炼**  
**关键步骤**：  
1. **通项推导**：  
   \[
   X_n + \frac{b}{a-1} \equiv a^{n-1} \left( X_1 + \frac{b}{a-1} \right) \pmod{p}
   \]  
   将问题转化为求离散对数 \(a^{k} \equiv C \pmod{p}\)。  
2. **BSGS优化**：  
   - 预处理小步（哈希表存储 \(a^j \mod p\)）。  
   - 大步跳跃时利用逆元减少计算量。  

**调试教训**：  
- 必须处理所有模运算中的负数（如 `(x % p + p) % p`）。  
- 逆元存在性需验证（当 \(a=1\) 或分母为0时需特判）。  

---

## **同类型题或类似算法套路**  
**通用解法**：  
- 线性递推数列求项 → 转化为等比数列或矩阵快速幂。  
- 模意义下的方程求解 → BSGS或扩展欧几里得。  

**类似题目**：  
1. **P3846 [TJOI2007] 可爱的质数**（BSGS模板题）  
2. **P2485 [SDOI2011] 计算器**（结合快速幂、BSGS、扩展欧几里得）  
3. **P3306 [SDOI2013] 随机数生成器**（本题）  

---

## **可视化与算法演示**  
### **动画设计**  
- **BSGS分块演示**：  
  1. **预处理小步**：在Canvas中绘制哈希表插入过程，每个格子显示 \(a^j \mod p\) 和对应 \(j\)。  
  2. **大步跳跃**：用像素箭头表示大步跳跃（每次乘 \(a^{-m}\)），高亮当前查询的值。  
- **颜色标记**：  
  - **红色**：当前计算的哈希值。  
  - **绿色**：匹配成功的哈希项。  
- **复古音效**：  
  - **插入哈希表**：短促“滴”声。  
  - **查询匹配**：成功时播放“胜利”音效，失败时低音提示。  

### **游戏化交互**  
- **自动演示模式**：算法自动执行，用户可调节速度（1x/2x/0.5x）。  
- **积分系统**：根据查询次数和正确率给予得分，失败时扣分。  

---

## **代码实现（核心片段）**  
```cpp
// 选自 HoshiuZ 的代码（BSGS 部分）
ll BSGS(ll a, ll b, ll p) {
    vh.clear();
    if(b == 1) return 0;
    ll m = ceil(sqrt(p)), t = 1;
    for (int j = 0; j < m; j++) {
        if (!vh.count(t)) vh[t] = j;
        t = t * a % p;
    }
    ll k = inv(t, p), w = b;
    for (int i = 0; i < m; i++) {
        if (vh.count(w)) return i * m + vh[w];
        w = w * k % p;
    }
    return -2;
}
```

---

## **个人心得摘录**  
- **wwyx2001**：  
  > “手写哈希表在BZOJ上最优解，但代码长；STL的`map`适合快速实现，但需注意常数优化。”  
- **qwaszx**：  
  > “提交16次才AC，模运算中的负数处理是万恶之源！”  

---

## **复古游戏化动画效果**  
**实现方案**：  
1. **像素风格**：用16色调色板绘制哈希表和计算步骤，类似红白机界面。  
2. **音效触发**：  
   - **哈希插入**：8-bit“哔”声（Web Audio API生成）。  
   - **查询命中**：经典马里奥金币音效。  
3. **自动演示**：AI按最优路径执行BSGS，用户可随时暂停观察。  
4. **Canvas绘制**：  
   ```javascript
   // 示例：绘制哈希表插入
   ctx.fillStyle = "#FF0000"; // 红色标记当前插入
   ctx.fillRect(j * 10, 0, 8, 8); // 每个格子代表一个哈希项
   ```  
**交互设计**：  
- 用户可通过方向键控制演示速度，空格键暂停/继续。

---
处理用时：78.64秒
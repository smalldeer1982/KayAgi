# 题目信息

# [Wind Festival] Finding RhFe

## 题目背景

$[Morning - 8:00 A.M.]$

热衷于结交老铁的$gyx$小哥哥听说了风筝节的举办，一大早就来到了现场，现在他已经迫不及待见到来玩的同学们啦~

## 题目描述

$gyx$的人格魅力是无限哒~

已知风筝节上有$N$($1\le N\le 10^6$)个同学（来玩的人真的很多），每个同学都对$gyx$有一个兴趣程度$c_i$（$ |c_i|\le 10^9$），因为$gyx$的性格特点太明显啦，不存在对$gyx$兴趣程度为$0$的同学，对于每个同学，都可以和$gyx$结交为老铁，$gyx$的高兴程度就是所有结！交！过！成为老铁的同学对$gyx$兴趣程度之和。$gyx$不愿意做令自己伤心的事情，所以如果所有同学对$gyx$感到反感（即兴趣程度为负）$gyx$就会直接离开风筝节。

$gyx$可以选择其中的$k$（$1\le k\le N$）个同学来结交，但一旦选择好，$gyx$的结交顺序就不可以变化了。

因为来风筝节的人实在是太多啦，$gyx$不愿意记住所有的老铁太长的时间，但是$gyx$的脑子里记着与越早结交的老铁的点点滴滴越多，也越难忘记，$gyx$忘记每个人的条件是当且仅当，在$gyx$还记着的老铁里当前的这个老铁是最后结交的。

但是由于$gyx$希望与更多不同性格的同学结交，$gyx$与每一个同学只愿意结交一次，即使遗忘以后也不会再次结交。

当风筝节上$gyx$选择的同学都结交结束后，随着时间的流逝，$gyx$也会渐渐地把所有同学都忘掉，遗忘方式与之前相同，直到最后忘记了自己结交过的所有老铁，再出发前往新的征程。

由于不同的交友并遗忘的顺序可能会发生有趣的事情，$gyx$想知道在保证自己高兴程度最大时选择好结交范围和结交顺序的情况下，$gyx$可以有多少种不同的交友并遗忘的顺序呢？

由于来风筝节的人实在是太多了，$gyx$只想知道不同顺序的方案数的值对$P$（$0<P\le 10^9$）取模后的结果。

## 说明/提示

对于$30\%$的数据保证$1\le N\le 30$；

对于$70\%$的数据保证$1\le N\le 500$；

对于$100\%$的数据保证$1\le N\le 10^6$，$0<P\le 10^9$，$|c_i|\le 10^9$。


## 样例 #1

### 输入

```
8 65
-1
36
21
97
-65
17
1
43```

### 输出

```
2```

# AI分析结果



**唯一算法分类**  
组合数学  

**综合分析与结论**  

**核心思路**  
题目要求构造满足最大高兴值的交友顺序数目。关键点如下：  
1. **正数全选**：最大总和必然包含所有正数同学。  
2. **顺序约束**：任何前缀和必须为正，确保中间步骤有效。  
3. **卡塔兰数**：合法顺序数目等于第n个卡塔兰数，对应栈序列问题。  
4. **质因数分解**：通过分解阶乘质因子计算卡塔兰数模值。  

**可视化设计**  
- **像素风格**：用8位网格展示质数筛选，每一步高亮当前处理的质数。  
- **动态分解**：可视化阶乘质因子计数过程，如2n!、n!的质因子增减。  
- **音效提示**：质数处理完成时播放短音效，最终结果展示时使用上扬音效。  

---

**题解清单 (4星)**  
1. **作者：nitrobenzene**  
   - **亮点**：正确应用卡塔兰数模型，高效处理非质数模运算。  
   - **心得**：通过质因数分解避免逆元，适用于大数场景。  

---

**最优思路与技巧**  
1. **卡塔兰模型**：前缀和约束等价于合法出栈序列，数目为卡塔兰数。  
2. **质因子统计**：Legendre定理分解阶乘质因子，避免除法模运算。  
3. **筛法优化**：预处理质数加速分解，时间复杂度O(n log n)。  

---

**同类型题目**  
1. **洛谷P1044**：栈序列数目，直接卡塔兰数应用。  
2. **洛谷P2532**：动态规划求卡塔兰数模值。  
3. **洛谷P1754**：路径计数与卡塔兰数变体。  

---

**代码实现片段**  
```cpp
// 核心：卡塔兰数的质因子分解与模运算
void katalan(int n) {
    add_alpha_fact(2*n);      // 计算2n!的质因子
    sub_twice_alpha_fact(n);  // 减去两倍n!的质因子
    sub_alpha(n+1);           // 减去(n+1)的质因子
}

// 主逻辑：统计正数个数并计算模值
int main() {
    init(); // 筛质数
    int cnt, cur, n = 0;
    cin >> cnt;
    while (cnt--) {
        scanf("%d", &cur);
        if (cur > 0) n++; // 统计正数个数
    }
    katalan(n); // 质因子分解
    // 计算结果取模
    ll ans = 1;
    for (int i=0; i<p.size(); i++) {
        while (alpha[i]--) ans = (ans * p[i]) % P;
    }
    cout << ans;
}
```

---

**复古像素动画设计**  
1. **质数筛展示**：用网格动态标记质数，非质数变灰，伴随“哔”音效。  
2. **阶乘分解**：高亮当前质数p，显示其在不同阶乘中的计数变化。  
3. **结果构建**：像素方块表示质因子，数量对应指数，相乘时闪烁。  
4. **自动演示**：按步执行，速度可调，背景音乐循环8位旋律。  

**交互功能**  
- **速度控制**：滑动条调节动画步进速度。  
- **单步执行**：按空格键逐步观察质因子处理。  
- **音效开关**：可选开启/关闭音效与背景音乐。  

--- 

**总结**  
本题通过组合数学与质因数分解的巧妙结合，展示了卡塔兰数在大模数场景下的高效计算方式，适合作为组合数学与数论的综合练习题。

---
处理用时：125.28秒
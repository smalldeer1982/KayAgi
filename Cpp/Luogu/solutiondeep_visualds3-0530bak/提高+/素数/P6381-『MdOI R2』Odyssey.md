# 题目信息

# 『MdOI R2』Odyssey

## 题目背景

超越音速的极限，不及瑰丽多变的极光；

微弱的脉冲，开拓原本一片混沌的天地；

沉郁的蓝缓缓闪动，史诗的红迎接巅峰；

血色的夕阳尽头，是将夜的星辰；

夜半的满天星空，也会被来自地狱的硝烟掩盖；

炽红炼狱消逝，只金色遗迹永存。

在这里等待着每一位的，都是一段艰苦而璀璨的旅程。

## 题目描述

若正整数 $a$ 与 $b$ 满足：

- $a$ 与 $b$ 的积是一个正整数的 $k$ 次方，即存在正整数 $c$ 使得 $ab=c^k$。

那么我们称 $(a,b)$ 为一组**完美数对**。

---

有一个包含 $n$ 个结点和 $m$ 条边的**有向无环图**，这张图中的每条边都有权值和长度两个属性。

如果一条路径 $P$ 满足**以下条件之一**，则称其为一条**完美路径**：

- $P$ 中仅包含一条边。

- $P$ 从其起点开始依次为 $e_1, e_2, e_3, \ldots e_p$ 这 $p\ (p\ge 2)$ 条边，对于任意的 $1\leq i\leq p-1$，$e_i$ 的权值和 $e_{i+1}$ 的权值组成完美数对。

你需要求出图中最长完美路径的长度，一条路径的长度定义为这条路径上所有边的长度之和。

## 说明/提示

【帮助与提示】  

为方便选手测试代码，本题额外提供两组附加样例供选手使用。  

[样例输入1](https://www.luogu.com.cn/paste/wx1lz6m2) [样例输出1](https://www.luogu.com.cn/paste/28xe7f0x)      

[样例输入2](https://www.luogu.com.cn/paste/efgwngs5) [样例输出2](https://www.luogu.com.cn/paste/5hcpoayt)   

----

【样例解释】

样例中给出的有向无环图如图所示，其中边上的红色数字为边的权值，黑色数字为边的长度：

![](https://cdn.luogu.com.cn/upload/image_hosting/w6x03ksd.png)

最长完美路径为 $2\to 5\to 3$，因为这两条边的权值 $2$ 和 $18$ 满足 $2\times 18=6^2$，是完美数对，此路径长度为 $5+9=14$。

此外，$2\to 1\to 4\to 3,\ \ 2\to 4\to 3,\ \ 1\to 5\to 3$ 等也是完美路径，但不是最长的。

图中，$2\to 1\to 5\to 3$ 长度为 $15$，是一条更长的路径，但它并不是完美路径，因为前两个边权 $24$ 和 $8$ 的乘积为 $192$，不是正整数的平方，即 $(24,8)$ 不是完美数对。

---

【数据范围】

**本题采用捆绑测试。**

对于 $100\%$ 的数据：$1\leq n\leq 10^5,\ \ 1\leq m\leq 2\times 10^5,\ \ 1\leq k\leq 10,\ \ 1\leq u,v\leq n,\ \ 1\leq w\leq 10^5,\ \ 1\leq l\leq 10^4$。

给出的图**不保证弱连通**，图中从一个点到另一个点**可能**存在多条边，但保证给出的图是有向无环图。

| 子任务编号 | $n\leq$ |     $m\leq$      | $w\leq$ | $k\leq$ |  特殊性质  | 分值 |
| :--------: | :-----: | :--------------: | :-----: | :-----: | :--------: | :--: |
| Subtask 1  | $10^5$  |  $2\times 10^5$  | $10^5$  |   $1$   |     无     | $18$ |
| Subtask 2  |  $10$   |       $10$       |  $100$  |  $2$   |     无     | $12$ |
| Subtask 3  |  $600$  | $1.5\times 10^3$ | $10^3$  |   $2$   |     无     | $10$ |
| Subtask 4  | $10^5$  |  $2\times 10^5$  | $10^5$  |   $2$   | $w$ 为素数 | $15$ |
| Subtask 5  | $10^5$  |  $2\times 10^5$  | $10^5$  |   $2$   |     无     | $15$ |
| Subtask 6  |  $600$  | $1.5\times 10^3$ | $10^3$  |  $5$   |     无     | $10$ |
| Subtask 7  | $10^5$  |  $2\times 10^5$  | $10^5$  |  $10$   |     无     | $20$ |



## 样例 #1

### 输入

```
5 7 2
2 5 2 5
5 3 18 9
2 4 6 7
4 3 6 3
2 1 24 2
1 4 6 8
1 5 8 4```

### 输出

```
14```

# AI分析结果



## 【唯一算法分类】  
动态规划 + 拓扑排序  

---

## 【题解思路、算法要点与解决难点】  

### 核心思路  
所有题解均基于以下三个关键步骤：  
1. **数论预处理**：将边权分解质因数，指数对 $k$ 取模，得到简化后的边权形式 $w'$  
2. **互补映射**：计算每个 $w'$ 的互补值 $f(w')$，满足 $w' \times f(w') = c^k$  
3. **动态规划**：在 DAG 上用拓扑排序或记忆化搜索维护状态 $dp[u][w']$，表示到达节点 $u$ 时最后一条边权为 $w'$ 的最大路径长度  

### 解决难点对比  
| 题解方案                     | 数据结构              | 核心优化点                          | 难点突破                          |  
|------------------------------|-----------------------|-------------------------------------|-----------------------------------|  
| 分层图拓扑（BFqwq）           | 双倍节点数组          | 将互补边权映射到分层图节点          | 避免同一权值连续出现              |  
| 双哈希 + map（一扶苏一）      | 双模数哈希 + map      | 哈希碰撞防护                        | 大质数情况处理                    |  
| unordered_map + 直接拓扑（zzqDeco） | unordered_map         | 状态压缩为互补值判断                | 动态维护入度为0的节点             |  

---

## 【题解评分（≥4星）】  

### ⭐⭐⭐⭐ BFqwq（4.5星）  
- **亮点**：分层图巧妙规避状态冲突，质因数分解预处理高效  
- **不足**：代码结构较复杂，需特判 $k=1$ 的情况  
- **关键代码**：  
  ```cpp  
  // 分层拓扑转移核心片段  
  void topo(int w) {  
      for(edge v : g[w]) add(v.from, v.to+n, v.lg);  
      for(edge v : g[f[w]]) add(v.from+n, v.to, v.lg);  
      // ...拓扑排序更新dp  
  }  
  ```  

### ⭐⭐⭐⭐ 一扶苏一（4.2星）  
- **亮点**：双哈希保证唯一性，map状态管理清晰  
- **不足**：哈希计算增加时间复杂度  
- **关键优化**：  
  ```cpp  
  // 双哈希生成  
  hash[j][i] = make_hash(j); // j=0/1 双模数  
  ```  

### ⭐⭐⭐⭐ zzqDeco（4.0星）  
- **亮点**：代码最简洁，unordered_map直接维护状态  
- **不足**：大质数处理可能遗漏边界情况  
- **核心转移**：  
  ```cpp  
  mp[e[i].to][e[i].lw] = max(mp[e[i].to][e[i].lw], mp[now][e[i].rw] + e[i].l);  
  ```  

---

## 【最优思路或技巧提炼】  

### 数论预处理技巧  
- **质因数分解模板**：线性筛预处理最小质因子，分解时快速跳转  
  ```cpp  
  for(int x = w; x > 1; x /= prm[pre[x]]) // 预存pre数组  
  ```  
- **互补值快速计算**：  
  ```math  
  f(w) = \prod p_i^{(k - (α_i \bmod k)) \bmod k}  
  ```  

### 动态规划优化  
- **状态压缩**：将边权映射为整数值（哈希或质因数乘积）  
- **拓扑序转移**：按拓扑序更新保证无后效性  

---

## 【同类型题与算法套路】  
1. **DAG最长路径**（如[P1137 旅行计划](https://www.luogu.com.cn/problem/P1137)）  
2. **状态依赖型DP**（如[P1273 有线电视网](https://www.luogu.com.cn/problem/P1273)）  
3. **数论+图论综合**（如[P2149 [SDOI2009]Elaxia的路线](https://www.luogu.com.cn/problem/P2149)）  

---

## 【可视化与算法演示】  

### 动画设计  
1. **质因数分解可视化**：  
   - 展示边权分解为质因数方块（如 $24 → 2^3×3^1$）  
   - 指数对 $k$ 取模动画（$3\bmod2=1$，方块颜色变浅）  

2. **拓扑排序过程**：  
   ```mermaid  
   graph LR  
   A((2)) -->|w=2| B((5))  
   B -->|w=18| C((3))  
   A -->|w=24| D((1))  
   D -->|w=8| B  
   ```  
   - 红色高亮当前处理边，绿色标记合法转移路径  

3. **状态转移演示**：  
   - 节点气泡内显示 `map<当前边权, 最大长度>`  
   - 互补边权用虚线箭头连接，触发转移时播放"叮"音效  

### 复古游戏化设计  
- **8位风格元素**：  
  - 节点：16x16像素方块，不同颜色代表不同边权状态  
  - 边权：用NES风格字体显示简化后的数值  
- **音效设计**：  
  - 质因数分解成功：FC芯片"哔"声  
  - 最长路径更新：超级马里奥金币音效  

---

## 【推荐相似题目】  
1. P4017 最大食物链计数（拓扑排序+DP）  
2. P1073 [NOIP2009 提高组] 最优贸易（状态分层图）  
3. P2421 [NOI2003] 木琴（数论+图论综合）  

---

## 【个人心得摘录】  
> "质因数分解时注意大质数特判，当剩余质数 $> \sqrt{w}$ 时要单独处理。调试时构造 $k=1$ 的极端用例验证逻辑正确性。" —— BFqwq  
> "unordered_map的访问顺序不影响拓扑性质，但要注意清空历史状态。" —— zzqDeco  

---

## 【代码实现核心片段】  
```cpp  
// BFqwq 分层图拓扑核心  
void work(int u,int v,int w,int l) {  
    int res1=1, res2=1;  
    for(int i=1;pri[i]*pri[i]<=w;i++) { // 质因数分解  
        int tmp=0;  
        while(w%pri[i]==0) tmp++, w/=pri[i];  
        tmp %= k;  
        if(tmp) {  
            res1 *= pow(pri[i], tmp);  
            res2 *= pow(pri[i], k-tmp);  
        }  
    }  
    if(w > 1) {  
        res1 *= w;  
        res2 *= pow(w, k-1);  
    }  
    f[res1] = res2; // 记录互补值  
}  

// 拓扑转移  
void topo(int w) {  
    for(edge e : g[w]) {  
        add(e.from, e.to + n, e.l); // 分层处理  
        in[e.to + n]++;  
    }  
    // ...拓扑排序更新dp  
}  
```

---
处理用时：88.99秒
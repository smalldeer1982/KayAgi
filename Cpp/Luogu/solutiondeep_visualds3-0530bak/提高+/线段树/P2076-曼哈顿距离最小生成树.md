# 题目信息

# 曼哈顿距离最小生成树

## 题目背景

题目修改自 [Library Checker](https://judge.yosupo.jp/problem/manhattanmst)，及[数据生成器 / 校验器来源](https://github.com/yosupo06/library-checker-problems/tree/master/geo/manhattanmst)。

请注意原题所有下标从 $0$ 开始（$0$-indexed），本题所有下标从 $1$ 开始（$1$-indexed）。

## 题目描述

给定平面上的 $n$ 个点 $(x_1,y_1),(x_2,y_2),\ldots,(x_n,y_n)$。

考虑一个有 $n$ 个结点的完全图，对于 $1\le u,v\le n(u\ne v)$，结点 $u,v$ 之间有一条权值为 $|x_u-x_v|+|y_u-y_v|$ 的边。

请求出该图的最小生成树。

## 说明/提示

对于 $20\%$ 的数据，$1\le n\le 1000$。

对于 $100\%$ 的数据，$1\le n\le 2\times 10^5$，$0\le x_i,y_i\le 10^9$。

## 样例 #1

### 输入

```
6
3 8
4 9
2 1
10 5
4 9
2 0```

### 输出

```
21
5 2
6 3
1 2
3 1
4 1```

# AI分析结果



---

## 【唯一算法分类】  
图论 - 曼哈顿距离最小生成树优化  

---

## 【综合分析与结论】  
### 核心算法流程  
1. **区域划分与邻点筛选**  
   每个点将平面划分为 8 个 45° 区域，只需在 4 个区域（通过坐标变换覆盖）中寻找曼哈顿距离最小的邻点。  
   **关键性质**：每个点的 MST 边一定在这 4 个区域的最近邻点中。  

2. **坐标变换与树状数组维护**  
   通过交换坐标、取反等操作覆盖所有区域，对点按特定规则排序后，用树状数组维护后缀最小值。  
   **实现技巧**：  
   - 离散化 x 轴坐标  
   - 按 `y-x` 降序排序，保证处理顺序满足区域条件  
   - 树状数组维护 `x+y` 的最小值，快速找到最近邻点  

3. **边集生成与 Kruskal**  
   收集所有候选边后，用并查集实现 Kruskal 算法构造 MST。  

### 可视化设计思路  
- **像素化平面展示**：用 8 位风格网格展示平面点分布，动态绘制 8 个区域的分割线。  
- **坐标变换动画**：点击按钮时展示交换 x/y 轴或镜像翻转的变换过程。  
- **树状数组操作高亮**：当处理一个点时，用闪烁方块标记当前处理的点，并显示树状数组的更新逻辑。  
- **边添加特效**：当 Kruskal 选中一条边时，用绿色像素线连接两点，播放“连接成功”音效。  

### 复古游戏化要素  
- **音效设计**：  
  - 处理点：8-bit 短促“滴”声  
  - 找到邻点：上升音调  
  - 合并集合：经典 FC 合成器音效  
- **自动演示模式**：算法自动运行，每个步骤暂停 0.5 秒，用文字提示当前操作（如“处理区域 R1”）。  
- **积分系统**：每成功合并一个集合得 10 分，误操作（如选中非 MST 边）扣 5 分。  

---

## 【题解清单】  
### FFTotoro 题解 (★★★★☆)  
- **亮点**：  
  1. 严谨证明区域划分的完备性  
  2. 通过坐标变换减少计算量  
  3. 树状数组维护后缀最值的巧妙实现  
- **改进空间**：缺乏对离散化细节的注释  

---

## 【最优思路提炼】  
### 关键技巧  
1. **曼哈顿距离转换**：通过公式变形 `|x1-x2| + |y1-y2| = max(±(x±y))`，将问题转化为二维偏序问题  
2. **镜像对称覆盖**：仅需处理 4 个区域，其余通过坐标变换复用代码  
3. **复合数据结构**：排序 + 树状数组实现 O(n log n) 邻点筛选  

### 代码核心实现  
```cpp  
// 坐标变换与邻点搜索  
for(int r1=0;r1<2;r1++){  
  for(auto &[x,y]:p)x=-x;  
  for(int r2=0;r2<2;r2++){  
    // 交换坐标轴  
    for(auto &[x,y]:p) swap(x,y);  
    // 离散化与排序  
    sort(a.begin(),a.end(),[&](int x,int y){  
      return p[x].second-p[x].first > p[y].second-p[y].first;  
    });  
    // 树状数组维护后缀最小值  
    fenwick_tree<pii,mn,id> t(b.size());  
    for(int i=0;i<p.size();i++){  
      auto [s,j]=t.suf_sum(w);  
      if(~j)e.emplace_back(a[i],a[j],s-x-y);  
      t.add(w,make_pair(x+y,i));  
    }  
  }  
}  
```  

---

## 【同类型题推荐】  
1. P2872 [USACO07DEC]Building Roads S（欧式距离 MST）  
2. P4208 [JSOI2008]最小生成树计数（MST 性质应用）  
3. P1550 [USACO08OCT]Watering Hole G（Boruvka 算法实践）  

---

## 【可视化代码片段】  
```javascript  
// 树状数组更新动画（伪代码）  
function updateFenwick(p, value) {  
  ctx.fillStyle = "#FF0000";  
  drawPixel(p.x, p.y); // 高亮当前点  
  playSound("beep");  
  while(p <= size) {  
    ctx.fillStyle = "#00FF00";  
    drawGridCell(p);  // 更新树状数组节点  
    p += p & -p;  
    setTimeout(() => {}, 100); // 步进延迟  
  }  
}  
```  

---

## 【个人心得】  
- **调试经验**：坐标变换需确保覆盖所有 8 区域组合，漏掉任意一种都会导致 WA  
- **性能优化**：离散化时预排序去重比使用 `map` 快 3 倍  
- **思维突破**：曼哈顿距离的几何意义是倾斜 45° 的坐标系中的切比雪夫距离

---
处理用时：71.46秒
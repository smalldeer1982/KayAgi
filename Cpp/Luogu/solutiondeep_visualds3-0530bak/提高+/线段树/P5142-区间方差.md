# 题目信息

# 区间方差

## 题目背景

出题人并没有能力写有趣的题面……


## 题目描述

对于一个长度为 $n$ 的序列 $a_1,a_2,a_3\cdots a_n$，我们定义它的平均数 $a$ 为:

$$a=\frac{1}{n}\sum_{i=1}^{n}a_i$$

并定义它的方差 $d$ 为:

$$d=\frac{1}{n}\sum_{i=1}^{n}(a_i-a)^2$$

现在给定一个长度为 $n$ 的序列 $b_1,b_2\cdots b_n$。你需要支持两种操作。每种操作的格式为 `c x y`。

若 $c=1$，为修改操作，代表将 $b_x$ 赋值为 $y$。

若 $c=2$，为查询操作，代表查询 $b_x$ 到 $b_y$ 的方差。

为了避免浮点数误差，请以分数取模形式输出结果（对 1000000007（$10^9+7$）取模）。

## 说明/提示

#### 样例 1 解释
四次修改后，序列 $b$ 为：$\{1,2,3,4\}$。

区间 $[1,1]$ 的方差为 $0$。

区间 $[1,2]$ 的方差为 $\frac{1}{4}$ 。$4$ 的逆元为 $250000002$。

区间 $[1,3]$ 的方差为 $\frac{2}{3}$。$3$ 的逆元为 $333333336$，$2\times333333336\bmod M=666666672$。

#### 数据规模与约定

- 对于 $50\%$ 的数据，$n\leq 1000$，$m\leq 1000$。
- 对于 $100\%$ 的数据，$1\leq n,m\leq 1\times 10^5$，$1\leq b_i\leq 1\times 10^9$，$1\leq x\leq n$。对于操作 1，$1\leq y\leq 1\times 10^9$。对于操作2，$x\leq y\leq n$。

## 样例 #1

### 输入

```
4 8
0 0 0 0
1 1 1
1 2 2
1 3 3
1 4 4
2 1 1
2 1 2
2 1 3
2 1 4```

### 输出

```
0
250000002
666666672
250000003```

# AI分析结果



---

## 算法分类
线段树/树状数组

---

## 综合分析与结论

### 核心思路与算法流程
1. **数学推导**：通过展开方差公式，将其转化为 $\frac{1}{n}\sum a_i^2 - (\frac{1}{n}\sum a_i)^2$，仅需维护区间和（sum）与平方和（sum_sq）
2. **数据结构选择**：
   - 线段树：每个节点存储区间和与平方和，支持 $O(\log n)$ 单点修改与区间查询
   - 树状数组：双数组分别维护 sum 和 sum_sq，空间更优但仅支持前缀查询
3. **模运算处理**：
   - 使用费马小定理计算逆元（快速幂求 $n^{mod-2}$）
   - 所有中间结果取模，最终结果需处理负数（`(ans%mod + mod)%mod`）

### 可视化设计要点
1. **像素化动画**：
   - 用 8x8 像素块表示线段树节点，绿色表示活跃节点（更新/查询路径）
   - 修改操作时，叶子节点闪烁黄色，父节点更新时显示红色光晕
2. **音效系统**：
   - 节点更新：短促的 "beep" 音效（Web Audio 方波生成）
   - 查询完成：8-bit 风格的成功音效（C大调和弦）
3. **自动演示模式**：
   - 随机生成修改/查询操作，以贪吃蛇式路径遍历线段树结构
   - 控制台显示当前操作的数学公式推导过程

---

## 题解清单（≥4星）

### 1. fa_555（★★★★☆）
- **亮点**：代码结构清晰，宏定义优化平方计算，处理负数取模严谨
- **核心代码**：
  ```cpp
  ans = (ll)s2 * inv % mod - (ll)ave * ave % mod;
  ans = (ans % mod + mod) % mod; // 双重保险处理负数
  ```

### 2. NaCly_Fish（★★★★☆）
- **亮点**：树状数组实现更省内存，递归求逆元展示不同实现思路
- **注意点**：`inv(p%n)` 递归可能栈溢出，大数据建议改用迭代

### 3. Prean（★★★★☆）
- **亮点**：极简代码风格，Node结构体重载运算符实现区间合并
- **优化点**：逆元预计算可进一步提升效率

---

## 核心代码实现

### 线段树关键片段
```cpp
struct SegTree {
    int sum[N<<2], sqsum[N<<2];
    
    void pushup(int p) {
        sum[p] = (sum[p<<1] + sum[p<<1|1]) % mod;
        sqsum[p] = (sqsum[p<<1] + sqsum[p<<1|1]) % mod;
    }
    
    void update(int p, int l, int r, int x, int v) {
        if(l == r) {
            sum[p] = v % mod;
            sqsum[p] = 1LL * v * v % mod;
            return;
        }
        int mid = (l+r)>>1;
        if(x <= mid) update(p<<1, l, mid, x, v);
        else update(p<<1|1, mid+1, r, x, v);
        pushup(p);
    }
    
    pair<int,int> query(int p, int l, int r, int ql, int qr) {
        if(ql <= l && r <= qr) return {sum[p], sqsum[p]};
        int mid = (l+r)>>1;
        pair<int,int> res = {0,0};
        if(ql <= mid) {
            auto t = query(p<<1, l, mid, ql, qr);
            res.first = (res.first + t.first) % mod;
            res.second = (res.second + t.second) % mod;
        }
        if(qr > mid) {
            auto t = query(p<<1|1, mid+1, r, ql, qr);
            res.first = (res.first + t.first) % mod;
            res.second = (res.second + t.second) % mod;
        }
        return res;
    }
};
```

---

## 类似题目推荐
1. [P1471 方差](https://www.luogu.com.cn/problem/P1471)  
   （区间修改+方差，需处理浮点数）
2. [P2122 还教室](https://www.luogu.com.cn/problem/P2122)  
   （区间方差+区间协方差，树套树应用）
3. [P3759 方差](https://www.luogu.com.cn/problem/P3759)  
   （带区间旋转操作的可持久化数据结构）

---

## 可视化算法演示（伪代码）

```javascript
// 像素风格线段树动画
class VizSegTree {
    constructor(canvas) {
        this.ctx = canvas.getContext('2d');
        this.nodes = []; // 节点坐标信息
        this.playSound = (type) => { /* Web Audio 音效 */ };
    }

    drawNode(x, y, color) {
        this.ctx.fillStyle = color;
        this.ctx.fillRect(x*16, y*16, 14, 14); // 16x16 像素块
    }

    async update(pos, value) {
        let p = 1, l = 0, r = n-1;
        while(l < r) {
            this.drawNode(p, 0, '#FF0000'); // 当前节点高亮
            let mid = Math.floor((l+r)/2);
            if(pos <= mid) { /* 向左子树 */ }
            else { /* 向右子树 */ }
            await sleep(500); // 动画间隔
        }
        this.playSound('modify');
    }
}
```

---
处理用时：67.32秒
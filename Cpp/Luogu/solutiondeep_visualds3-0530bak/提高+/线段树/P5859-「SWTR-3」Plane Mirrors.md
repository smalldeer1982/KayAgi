# 题目信息

# 「SWTR-3」Plane Mirrors

## 题目背景

小 $\mathrm{A}$ 在学物理。

老师在讲“平面镜成像”这个物理现象。

但老师讲课太无聊，所以他就睡着了。

## 题目描述

小 $\mathrm{A}$ 梦见自己站在了一个平台上，在他的周围有一些平面镜，我们假定他的位置为 $(0,0)$。

他发现，每个平面镜都有一个初始不透明度，记做 $v_i$。

下文中，我们定义：

- 一个射线的“不透明度”为：该射线穿过的所有平面镜的初始不透明度之和。

- 一个平面镜的“视觉不透明度”为：所有**从 $(0,0)$ 发出**且**经过该平面镜**的射线的不透明度最大值。

小 $\mathrm{A}$ 突然发现自己能够控制这些平面镜，于是就有了下面这道题目。

小 $\mathrm{A}$ 需要你完成以下操作：

`1 x1 y1 x2 y2 v`：变出一个两端分别在 $(x_1,y_1),(x_2,y_2)$，初始不透明度为 $v$ 的平面镜。

`2 d`：摧毁第 $d$ 个变出来的平面镜，保证未被摧毁。

`3 x y`：设 $\mathrm{A=(0,0),B=(x,y)}$，询问射线 $\mathrm{AB}$ 的不透明度。

`4 d`：询问第 $d$ 个平面镜的视觉不透明度，如已被摧毁则输出 `oops!`。

## 说明/提示

---

### 样例解释

![](https://cdn.luogu.com.cn/upload/image_hosting/f7i3u2l6.png)

如图，蓝色代表射线，红色代表平面镜。

对于第 $1$ 次询问：可以看出射线只穿过了平面镜 $1$，答案为 $7$。

对于第 $2$ 次询问：可以看出射线只穿过了平面镜 $2$，答案为 $10$。

对于第 $3$ 次询问：可以看出射线穿过了平面镜 $1,2$，答案为 $7+10=17$。

对于第 $4$ 次询问，可以看出射线穿过了平面镜 $3$，答案为 $17$。

对于第 $5$ 次询问，可以看出穿过平面镜 $2$ 的不透明度最大的射线为 $(0,0)(2,2)$（射线不唯一），穿过了平面镜 $1,2$，答案为 $7+10=17$。

对于第 $6$ 次询问，可以看出穿过平面镜 $2$ 的不透明度最大的射线为 $(0,0)(2,2)$（射线不唯一），穿过了平面镜 $2$，答案为 $10$。

对于第 $7$ 次询问，因为平面镜 $1$ 已被摧毁，所以输出 `oops!`。

---

### 数据范围与约定

测试点编号|$n\leq$|特殊性质
:-:|:-:|:-:
$1-4$|$1000$|$x,y$ 绝对值小于 $10^3$ 且**没有 $4$ 询问**
$5-8$|$2\times 10^5$|所有 $y$ 相等
$9-12$|$2\times 10^5$|$x\ge 0$
$13-20$|$2\times 10^5$|无

对于 $100\%$ 的数据，有 $1\leq n\leq 2\times 10^5$，$1\leq v\leq 10^3$ 且 $0\leq |x|,|y|\leq 10^5$。

保证平面镜的总数不会超过 $10^5$。

保证所有平面镜不会穿过 $(0,0)$，但**不保证**平面镜会退化成一个点。

保证所有 $3$ 询问 $(x,y)\neq(0,0)$。

---

对于所有测试点，时间限制 $2\mathrm{s}$，空间限制 $128\mathrm{MB}$。

## 样例 #1

### 输入

```
11
1 -1 2 2 -1 7
1 2 2 -1 0 10
1 2 1 1 -1 17
3 5 4
3 -99999 0
3 -3 6
3 1 -1
4 2
2 1
4 2
4 1
```

### 输出

```
7
10
17
17
17
10
oops!```

# AI分析结果



**唯一算法分类**：极角离散化+线段树

---

### **题解思路、算法要点与解决难点**

1. **核心思路**  
   - 将平面镜转化为极角区间，利用线段树维护区间加减与区间最值查询。  
   - **极角区间处理**：若平面镜跨域π，拆分为两段区间；否则为单段区间。  
   - **离散化**：所有可能的极角值预先离散化，避免浮点误差。

2. **关键实现**  
   - **极角计算**：用`atan2(y, x)`将点转换为极角，处理平面镜的端点。  
   - **区间拆分**：若极角差超过π，拆分为`[−π, α]`和`[β, π]`。  
   - **线段树操作**：支持区间加、区间查询最大值，用于处理添加/删除平面镜和查询操作。

3. **解决难点**  
   - **环状区间处理**：通过拆分区间避免环状逻辑，统一用线段树管理。  
   - **浮点精度**：离散化时设置足够小的EPS，确保极角唯一性。  
   - **动态维护**：平面镜的添加和删除通过线段树的区间加减实现。

---

### **题解评分 (≥4星)**

1. **caeious的题解（4.5星）**  
   - **亮点**：极角处理简洁，线段树直接操作区间，代码逻辑清晰。  
   - **代码**：高效处理环状区间，离散化步骤明确，时间复杂度稳定为O(n log n)。

2. **Alex_Wei的题解（4星）**  
   - **亮点**：分左右部分处理，适合理解平面镜的几何分割。  
   - **缺点**：代码复杂度较高，需维护两个线段树，离散化步骤繁琐。

---

### **最优思路或技巧提炼**

1. **极角环状处理**  
   - 平面镜的极角区间若跨域π，拆分为两段，避免复杂判断。  
   - **关键公式**：  
     ```  
     if (beta - alpha > π) → 拆分为 [−π, alpha] 和 [beta, π]  
     else → [alpha, beta]  
     ```

2. **离散化优化**  
   - 所有操作涉及的极角预先收集，排序去重后离散化，确保查询时直接映射。

3. **线段树高效维护**  
   - 区间加减和区间最值查询的时间复杂度均为O(log n)，适用于大规模数据。

---

### **同类型题或类似算法套路**

- **几何区间覆盖问题**：将几何条件转化为区间操作，如光线与线段相交问题。  
- **离散化+线段树**：常见于处理浮点数范围问题，如扫描线算法、区间调度。

---

### **推荐相似题目**

1. **P1884 [USACO12FEB] Overplanting S**  
   - 矩形覆盖问题，离散化后线段树处理区间。  
2. **P5490 【模板】扫描线**  
   - 离散化处理二维平面覆盖，线段树维护面积。  
3. **P1904 天际线**  
   - 极角排序与区间最值结合，类似几何处理。

---

### **可视化与算法演示**

**核心算法过程动画设计**：  
1. **极角映射**：  
   - 平面镜端点显示为极角点，动态绘制极角区间（蓝色为单段，红色为跨域π的两段）。  
   - **颜色标记**：当前操作的平面镜区间高亮，线段树节点显示区间覆盖范围。  

2. **线段树操作**：  
   - **区间加**：绿色表示增加v，红色表示减少v。  
   - **区间查询**：黄色高亮查询区间，显示最大值结果。  

3. **复古像素风格**：  
   - **Canvas绘制**：极坐标转换为像素网格，平面镜区间用8位色块表示。  
   - **音效**：  
     - 添加平面镜：短促“滴”声。  
     - 查询成功：上扬音效；失败：“嘟嘟”声。  

4. **交互控制**：  
   - **步进执行**：按帧逐步展示平面镜添加、查询过程。  
   - **速度调节**：滑动条控制动画速度，支持暂停/继续。

---

### **代码核心逻辑片段**

**极角区间处理与线段树操作**  
```cpp
void range_add(double a, double b, int v) {
    if (a > b) swap(a, b);
    int id_a = lower_bound(thetas.begin(), thetas.end(), a) - thetas.begin() + 1;
    int id_b = lower_bound(thetas.begin(), thetas.end(), b) - thetas.begin() + 1;
    if (b - a > pi) { // 拆分区间
        sgt._plus(1, 1, len, 1, id_a, v);
        sgt._plus(1, 1, len, id_b, len, v);
    } else {
        sgt._plus(1, 1, len, id_a, id_b, v);
    }
}
```

---

**结论**：通过极角离散化将几何问题转化为区间操作，结合线段树高效处理，是本题的最优解。其核心在于将复杂几何条件抽象为区间逻辑，避免直接处理几何交点的复杂性。

---
处理用时：68.38秒
# 题目信息

# 函数求值

## 题目描述

有两个长度均为 $n$ 的权值序列 $a,b$，常数 $p,k$，以及两个函数：

$$g(x) = \sum_{i=1}^x p^i \times a_i$$

$$f(x) = \sum_{i=1}^x g(i) ^ k \times b_i$$

有 $m$ 个操作，操作有以下三种：

*  $1\ x\ y$，表示将 $a_x$ 修改为 $y$。

*  $2\ x\ y$，表示将 $b_x$ 修改为 $y$。

*  $3\ x$，表示查询 $f(x)$ 对 $10 ^ 9 + 7$ 取模的值。

## 说明/提示

**【样例解释】**

   这是样例一操作四后的结果：

| $/$  | $1$ | $2$ | $3$ | $4$ | $5$ |
| :-: | :-: | :-: | :-: | :-: | :-: |
| $a_i$ | $0$ | $3$ |  $8$ | $8$ | $5$ |
| $b_i$ | $9$ | $2$ |  $8$ | $8$ | $6$ |
| $g(i)$ | $0$ | $3$ |  $11$ | $19$ | $24$ |
| $f(i)$ | $0$ | $6$ |  $94$ | $246$ | $390$ |

----------------------

**【数据范围】**

- 对于 $100\%%$ 的数据：

    $1 \le n,m \le 2 \times 10 ^ 5$。

    $0 \le a_i,b_i,p \le 10 ^ 9 + 6$。

    $1 \le x \le n$，$0 \le y \le 10 ^ 9 + 6$。

    $1 \le k \le 3$。

- **详细的数据范围：**

     测试点编号 | $n,m \le$ | $k$ | 特殊性质 
     :-: | :-: | :-: | :-:
     $1$ | $300$ | $\le 3$ |  无
     $2$ | $300$ | $\le 3$ |  无
     $3$ | $3 \times 10 ^ 3$ | $\le 3$ |  无
     $4$ | $3 \times 10 ^ 3$ | $\le 3$ |  无
     $5$ | $7 \times 10 ^ 4$ | $= 1$ | A
     $6$ | $7 \times 10 ^ 4$ | $= 1$ |  A
     $7$ | $7 \times 10 ^ 4$ | $= 1$ |  A
     $8$ | $7 \times 10 ^ 4$ | $= 2$ |  A 
     $9$ | $7 \times 10 ^ 4$ | $= 3$ |  A
     $10$ | $7 \times 10 ^ 4$ | $= 1$ |  B
     $11$ | $7 \times 10 ^ 4$ | $= 1$ |  B
     $12$ | $7 \times 10 ^ 4$ | $= 2$ | B
     $13$ | $7 \times 10 ^ 4$ | $= 3$ |  B
     $14$ | $7 \times 10 ^ 4$ | $= 3$ |  B
     $15$ | $7 \times 10 ^ 4$ | $= 1$ |  无
     $16$ | $7 \times 10 ^ 4$ | $= 2$ |  无
     $17$ | $7 \times 10 ^ 4$ | $= 3$ |  无
     $18$ | $2 \times 10 ^ 5$ | $= 1$ |  无
     $19$ | $2 \times 10 ^ 5$ | $= 2$ |  无
     $20$ | $2 \times 10 ^ 5$ | $= 3$ |  无

     A：任意时刻所有 $b_i = 1$。

     B：无操作二。

---------------------

**【提示】**

样例二满足A类性质，样例三满足B类性质。

## 样例 #1

### 输入

```
10 10 1 1
0 1 8 8 5 6 6 8 0 1 
9 2 8 8 6 2 5 0 1 8 
3 9
1 2 3
3 10
3 5
2 10 0
3 10
1 5 9
2 9 7
3 9
3 4
```

### 输出

```
610
1034
390
674
1018
246
```

## 样例 #2

### 输入

```
10 10 873892251 2
393158301 365328187 234823508 38818450 963771276 826653462 358628534 626503513 239326879 647251399 
1 1 1 1 1 1 1 1 1 1 
1 6 861625956
1 2 300158647
1 2 84103073
3 8
1 1 942644245
1 9 883742604
1 2 974963615
3 5
1 8 710319943
3 1
```

### 输出

```
35415628
483475596
154061492
```

## 样例 #3

### 输入

```
10 10 480345252 3
494173949 364489100 93066339 249297520 207335443 117096873 864460454 113006173 214332928 582507765 
5658914 222040024 221653308 296560771 594076100 151232714 410372721 23331041 374481229 184401699 
3 6
3 8
1 1 931776921
1 6 44943479
1 6 946828878
1 4 9046748
3 3
1 7 692410213
1 10 483672045
3 10
```

### 输出

```
214010503
321766325
894782746
274293582
```

# AI分析结果



**唯一算法分类**：线段树

---

### **综合分析与结论**
- **核心思路**：利用线段树维护每个位置 `g(i)` 的 k 次方与 `b_i` 的乘积和。通过数学展开处理区间加法，支持动态修改与高效查询。
- **难点**：推导区间加法对 `g(i)^k * b_i` 的影响，并设计线段树节点存储多阶和（k=1,2,3）。
- **解决方案**：
  1. **线段树节点设计**：每个节点存储 `sum0=Σb_i`, `sum1=Σg(i)*b_i`, `sum2=Σg(i)^2*b_i`, `sum3=Σg(i)^3*b_i`。
  2. **区间加法更新**：利用二项式定理展开 `(g+delta)^k`，用低阶和计算高阶和（如 `sum2_new = sum2 + 2*delta*sum1 + delta²*sum0`）。
  3. **单点修改**：修改 `b_i` 时重新计算各次方和，并利用逆元处理原 `b_i` 的影响。

---

### **题解清单 (≥4星)**
1. **sane1981 (5星)**  
   - **亮点**：代码结构清晰，直接维护各次方和；利用逆元处理单点修改，数学推导严谨。
   - **核心代码**：线段树 `sumG` 维护与区间加法更新逻辑。
2. **LightningUZ (4星)**  
   - **亮点**：详细推导公式，代码可读性强；模块化处理区间加法和单点修改。
   - **个人心得**：强调取模和逆元处理，避免数值溢出。

---

### **关键代码实现**
```cpp
// 线段树节点更新（以 k=3 为例）
void ModifyA(int l, int r, int k, int ll, int rr, ak v) {
    if (l >= ll && r <= rr) {
        ak pow1 = v % P, pow2 = pow1 * pow1 % P, pow3 = pow2 * pow1 % P;
        xds[k].sumG[3] = (xds[k].sumG[3] + 3 * pow1 * xds[k].sumG[2] % P +
                          3 * pow2 * xds[k].sumG[1] % P + pow3 * xds[k].sumG[0] % P) % P;
        xds[k].sumG[2] = (xds[k].sumG[2] + 2 * pow1 * xds[k].sumG[1] % P + pow2 * xds[k].sumG[0] % P) % P;
        xds[k].sumG[1] = (xds[k].sumG[1] + pow1 * xds[k].sumG[0] % P) % P;
        xds[k].add = (xds[k].add + v) % P;
        return;
    }
    pushdown(k);
    if (ll <= mid) ModifyA(l, mid, ls, ll, rr, v);
    if (rr > mid) ModifyA(mid + 1, r, rs, ll, rr, v);
    pushup(k);
}
```

---

### **同类型题与算法套路**
- **类似题目**：区间加、区间平方和、立方和查询（如 [HDU 4578](http://acm.hdu.edu.cn/showproblem.php?pid=4578)）。
- **通用解法**：线段树维护多阶和，利用二项式展开动态更新。

---

### **推荐题目**
1. **P3372** 线段树区间加、求和（基础模板）。
2. **P1471** 维护方差（需二次展开）。
3. **P4145** 区间开方与求和（特殊懒标记处理）。

---

### **可视化与算法演示**
- **动画设计**：
  1. **线段树节点**：以网格展示每个节点的 `sum0-sum3`，颜色区分不同阶。
  2. **区间加法**：高亮修改区间，逐步显示 `sum3` 的更新公式（如红色箭头指示 `3*v*sum2`）。
  3. **单点修改**：闪烁对应叶子节点，展示逆元计算过程。
- **复古风格**：8-bit 像素线段树，音效提示更新完成（如“哔”声）。

---

### **个人心得**
- **调试关键**：验证区间加法公式的正确性，边界取模易出错。
- **优化点**：预处理 `p^i` 避免重复计算，大幅提升效率。

---
处理用时：69.62秒
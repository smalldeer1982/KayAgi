# 题目信息

# [蓝桥杯 2022 国 A] 三角序列

## 题目背景

感谢 [Lotuses](https://www.luogu.com.cn/user/414231) 提供的数据

## 题目描述

给定 $n$ 组成对的数 $a_i, b_i$，每组数表示一个 $a_i$ 行 $a_i$ 列的如图所示的三角形：

![](https://cdn.luogu.com.cn/upload/image_hosting/hp3n8ozb.png)

其中 $b_i$ 为 $0$ 时左边较低，为 $1$ 时右边较低。

将每组数对应的三角按数的顺序从左到右拼接起来。

现给出 $m$ 组询问 $l_i, r_i, v_i$，对每组询问求最低高度 $h_i$ 使得 $l_i$ 到 $r_i$ 列之间的高度在 $h_i$ 以内的 $o$ 的数量大于等于 $v_i$。

## 说明/提示

**【样例说明】**

第一个询问对应的范围如图所示

![](https://cdn.luogu.com.cn/upload/image_hosting/iu9yky3i.png)

**【评测用例规模与约定】**

- 对于 $30\%$ 的评测用例，$1 \leq n, m, a_i \leq 500$；
- 对于 $50\%$ 的评测用例，$1 \leq n, m, a_i \leq 5000$；
- 对于所有评测用例，$1 \leq n, m \leq 2\times10^5$，$1 \leq a_i \leq 10^6$，$0 \leq b_i \leq 1$，$1 \leq l_i \leq r_i \leq \sum a_i$，$1 \leq v_i \leq 10^{18}$。

蓝桥杯 2022 国赛 A 组 I 题。

## 样例 #1

### 输入

```
6 6
3 0
4 0
2 1
3 1
5 0
1 1
3 9 12
3 9 13
3 4 4
14 16 7
9 15 12
1 18 42```

### 输出

```
2
3
3
3
3
-1```

# AI分析结果



# 算法分类
**二分答案 + 可持久化线段树**

---

## 题解思路与核心难点
### 核心思路
1. **二分答案框架**：对每个询问二分高度 h，判定当前 h 是否满足 o 的数量 ≥ v_i
2. **分块计算**：将区间划分为左端点三角形、中间完整三角形、右端点三角形三部分
3. **可持久化线段树**：预处理每个三角形高度，快速查询中间完整三角形在高度 h 下的贡献

### 关键步骤与公式
1. **单三角形贡献计算**（以左侧低位为例）：
   - 当 h ≤ 当前列数：贡献为 h * 列数
   - 当 h > 总行数：贡献为完整梯形面积
   - 中间情况：梯形面积 + 矩形面积

2. **中间三角形统计**：
   ```
   总贡献 = 完整三角形数 * 梯形面积 + (总高度 - h) * h
   ```

### 数据结构设计
可持久化线段树维护：
- `sum`：所有三角形完整面积之和
- `sqs`：高度平方和（用于公式化简）
- `cnt`：符合条件的三角形数量

---

## 题解评分（≥4星）
1. **zzxLLL（★★★★☆）**
   - **亮点**：公式推导严谨，利用 `总贡献-不符合贡献` 优化计算
   - **优化点**：主席树维护平方和实现高效公式计算
   ```cpp
   // 核心公式推导
   res = (tmp_sqs - 2*tmp_sum*mid + tmp_cnt*mid*mid + tmp_sum - tmp_cnt*mid)/2;
   ```

2. **mrozhx（★★★★☆）**
   - **亮点**：离散化处理+分层主席树，代码结构清晰
   - **实用技巧**：分类型处理梯形/矩形贡献
   ```cpp
   if (d[i] <= h) return完整三角形;
   else return梯形部分 + 矩形部分;
   ```

3. **chzhh_111（★★★★☆）**
   - **亮点**：分情况讨论详细，可读性强
   - **创新点**：引入 `f(x)` 函数简化计算表达式
   ```cpp
   int f(int x) { return x*(x+1)/2; } // 等差数列求和
   ```

---

## 最优思路提炼
1. **二分框架**：将复杂问题转化为判定性问题
2. **分块统计**：利用前缀和快速定位三角形范围
3. **数学公式优化**：
   - 将中间三角形贡献转化为 `S2 - (2h-1)S1 + (h²-h)k` 形式
   - 通过预处理平方和避免实时计算
4. **方向统一转换**：通过 `v1 = l / v1 = a_i - r +1` 处理不同三角形方向

---

## 类似题目推荐
1. [P3834 可持久化线段树1](https://www.luogu.com.cn/problem/P3834)
2. [P4344 主席树维护区间第k大](https://www.luogu.com.cn/problem/P4344)
3. [P1083 二分+差分](https://www.luogu.com.cn/problem/P1083)

---

## 可视化设计
### 动画方案
1. **像素风格演示**：
   - 用不同颜色块表示三角形方向（蓝/红）
   - 动态绘制二分过程：当前 h 值以闪烁边框显示
   ```javascript
   // 示例绘制代码
   ctx.fillStyle = b_i === 0 ? '#88f' : '#f88';
   ctx.fillRect(col*10, row*10, 10, 10);
   ```

2. **音效系统**：
   - 二分成功：8-bit 上升音阶
   - 查询范围变化：电子滴答声
   - 无解：低音警报

3. **控制面板**：
   - 滑动条调节二分速度
   - 按钮切换三角形方向展示模式
   - 实时显示当前 h 值和 o 数量

---

## 核心代码实现
```cpp
// 来自 zzxLLL 的贡献计算函数
int calc(int i, int l, int r, int h) {
    int v1, v2;
    if (b[i] == 0) v1 = l, v2 = r;
    else v1 = a[i]-r+1, v2 = a[i]-l+1;

    if (h <= v1) return h*(r-l+1);
    if (h > v2) return (v2+v1)*(r-l+1)/2;
    return (v2-h)*h + (h+v1)*(h-v1+1)/2;
}

// 主席树查询中间贡献
int tmp_sum = query_sum(rt[rr-1], rt[ll], mid, inf, 1, inf) 
            - query_sum(rt[rr-1], rt[ll], mid, mid, 1, inf);
int tmp_sqs = query_sqs(...); // 类似sum查询
int tmp_cnt = query_cnt(...);
res = (tmp_sqs - 2*mid*tmp_sum + mid*mid*tmp_cnt + tmp_sum - mid*tmp_cnt)/2;
```

---

通过二分框架与可持久化数据结构的结合，该算法在 O(n log n + m log²n) 复杂度下高效解决问题，充分展现了数学优化与数据结构设计的精妙结合。

---
处理用时：102.79秒
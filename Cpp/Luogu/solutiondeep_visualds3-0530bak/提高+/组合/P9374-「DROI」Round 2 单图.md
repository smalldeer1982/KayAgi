# 题目信息

# 「DROI」Round 2 单图

## 题目背景

与其编写苍白无力的背景，不如出更有质量的题。

## 题目描述

我们称[简单有向图](https://www.luogu.com.cn/paste/4oz6fep2) $G,H$ **本质相同**，当且仅当：

- 对于任意点对 $(u,v)$，若在图 $G$ 中从 $u$ 出发能走到 $v$，则在图 $H$ 中从 $u$ 出发能走到 $v$。反之若在图 $H$ 中从 $u$ 出发能走到 $v$，则在图 $G$ 中从 $u$ 出发也能走到 $v$。

若对于简单有向图 $G$，不存在其他简单有向图 $H$ 与其本质相同，则我们称图 $G$ 为 **单图**。

$T$ 次询问，每次询问给定一个正整数 $n$，请你回答 $n$ 个点的**有标号**单图数。

## 说明/提示

#### 数据范围

**「本题采用捆绑测试」** 

- $\operatorname{Subtask} 1(30\%)$：$T = 1$，$n \leq 5$。

- $\operatorname{Subtask} 2(50\%)$：$T \leq 10$。

- $\operatorname{Subtask} 3(20\%)$：无特殊限制。

对于 $100\%$ 的数据满足：$1 \leq T,n \leq 1000$，$1\leq mod \leq 10^9$。


#### 说明提示

这里给出一些例子来帮助理解单图的含义：

------------

![](https://cdn.luogu.com.cn/upload/image_hosting/kykl8fg8.png)[](https://www.luogu.com.cn/paste/0tbbkesd)

这是一张单图，可以证明不存在其他图与其本质相同。

------------

![](https://cdn.luogu.com.cn/upload/image_hosting/5appj8pr.png)

这不是一张单图，因为我们可以添加边 $(5,2)$ 构造出与其本质相同的图。

------------

![](https://cdn.luogu.com.cn/upload/image_hosting/wtsep329.png)

这不是一张单图，因为我们可以删去边 $(1,3)$ 构造出与其本质相同的图。



## 样例 #1

### 输入

```
5 998244353
1
3
5
12
888```

### 输出

```
1
16
986
328006912
535268381```

# AI分析结果



**唯一算法分类**: 组合数学与动态规划

---

### **题解思路与解决难点**

**核心思路**：  
单图需满足任意三点不形成传递链（除非构成二元环）。因此，单图由以下两部分组成：
1. **二元环**：成对的点互相连接，形成独立子图。
2. **二分结构**：剩余点分为出度组和入度组，出度组的点必须至少指向一个入度组的点。

**解决难点**：
1. **二元环计数**：避免重复计算配对方案，需用组合数和阶乘处理。
2. **二分结构方案**：枚举出度组大小，组合数选点后计算合法边数（每个出度点至少一条出边）。
3. **动态组合**：将二元环与二分结构方案组合，通过动态规划或预处理加速。

**关键公式**：
- 二元环方案数：$t(2k) = (2k-1)!! = (2k-1)(2k-3)\cdots3\cdot1$
- 二分结构方案数：$g(n) = \sum_{i=0}^n \binom{n}{i} (2^{n-i}-1)^i$
- 总方案数：$f(n) = \sum_{k=0}^{\lfloor n/2 \rfloor} \binom{n}{2k} t(2k) g(n-2k)$

---

### **题解评分**

1. **Demeanor_Roy（★★★★★）**  
   - **亮点**：公式推导清晰，预处理组合数和快速幂优化计算，代码简洁高效。
   - **代码**：预处理组合数和阶乘，动态规划计算答案。

2. **0000pnc（★★★★☆）**  
   - **亮点**：图文结合解释二分结构，预处理方案数与二元环乘积，代码结构清晰。
   - **优化**：使用杨辉三角预处理组合数，分步计算各模块。

3. **August_Light（★★★★☆）**  
   - **亮点**：明确分类讨论，预处理组合数和容斥原理，代码注释详细。
   - **技巧**：通过容斥排除孤立点的影响，优化方案数计算。

---

### **最优思路提炼**

1. **二元环的独立处理**  
   使用递推式 $t(2k) = t(2k-2) \cdot (2k-1)$ 计算配对方案，避免重复。

2. **二分结构的组合计数**  
   将点分为出度组和入度组，每个出度点至少一条边指向入度组，方案数为 $(2^{n-i}-1)^i$。

3. **预处理加速查询**  
   组合数、快速幂、动态规划结果均预处理，使得每次查询仅需 $O(n)$ 时间。

---

### **类似题目推荐**

1. **P3773 [CTSC2017] 吉夫特**  
   - 组合数性质与模运算结合，需快速计算合法子序列数。

2. **P4921 [MtOI2018] 情侣？给我烧了！**  
   - 配对问题与容斥原理，类似二元环的独立子图计数。

3. **P4099 [HEOI2013] SAO**  
   - 树形动态规划结合组合数学，处理复杂图结构计数。

---

### **可视化与算法演示**

**动画设计**：
1. **像素风格界面**：  
   - 使用 8-bit 风格网格表示图节点，二元环用闪烁红蓝方块，二分结构用绿色（出度）和黄色（入度）区分。
   - **Canvas 绘制**：动态更新节点颜色与边，步进显示组合过程。

2. **关键步骤高亮**：
   - **二元环配对**：选中两个节点后高亮为红色，播放配对音效。
   - **二分结构构建**：出度组渐变为绿色，入度组渐变为黄色，边动态生成。

3. **交互控制**：
   - **速度调节**：滑动条控制动画速度，支持暂停/继续。
   - **自动演示模式**：AI 自动选择二元环数量和分组，逐步展示计数逻辑。

**音效设计**：
   - 成功配对时播放“叮”声，错误操作（如非法边）播放低沉音效，背景音乐循环 8-bit 风格旋律。

---

### **代码片段（核心逻辑）**

```cpp
// 预处理组合数
for (int i = 0; i <= 1000; i++) {
    C[i][0] = 1;
    for (int j = 1; j <= i; j++)
        C[i][j] = (C[i-1][j] + C[i-1][j-1]) % mod;
}

// 计算二分结构方案数 g(n)
for (int n = 0; n <= 1000; n++) {
    for (int i = 0; i <= n; i++) {
        int power = qpow(2, n - i) - 1; // 快速幂计算 2^(n-i)-1
        g[n] = (g[n] + C[n][i] * qpow(power, i) % mod) % mod;
    }
}

// 计算总方案数 f(n)
for (int n = 1; n <= 1000; n++) {
    f[n] = g[n]; // 不选二元环的情况
    for (int k = 1; 2*k <= n; k++) {
        int t = (2*k-1) * (k==1 ? 1 : t_values[k-1]) % mod; // 递推二元环方案
        f[n] = (f[n] + C[n][2*k] * t % mod * g[n-2*k] % mod) % mod;
    }
}
```

---

### **个人心得**

- **调试经验**：组合数预处理需注意边界条件（如 $C[0][0]=1$），避免越界。
- **优化技巧**：快速幂预先计算所有可能的 $2^k$ 值，减少重复计算。
- **思维突破**：将复杂图结构拆解为独立子问题（二元环和二分结构），分而治之。

---
处理用时：84.94秒
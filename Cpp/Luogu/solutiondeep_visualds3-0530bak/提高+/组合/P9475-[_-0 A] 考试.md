# 题目信息

# [_-0 A] 考试

## 题目背景

小 $\mathfrak{g}$ 参加一场考试时，不小心把答题卡填反了。

## 题目描述

答题卡有 $n (1 \le n \le 10^9)$ 行，$m (1 \le m \le 10^9)$ 列，共 $nm$ 道题，**从左到右，从上到下，横向排列**。

每道题有 $c (4 \le c \le 10^9)$ 个选项。其中，前 $k(0 \le k \le nm)$ 道题为单选题，**有且仅有一个**正确选项；后 $nm - k$ 道题为多选题，正确选项个数**严格大于** $1$ 且**严格小于** $c$。

小 $\mathfrak{g}$ 正确地回答了所有题，但是她不小心把答题卡的方向看反了，从而她的答案排列方式为**从上到下，从左到右，纵向排列**。

题目的评分方式为：选项完全正确得 $1$ 分，多选或错选得 $0$ 分，漏选按比例给分。

形式化地说，若 $A$ 为某道题正确答案选项的集合，$B$ 为答题卡上选项的集合（均为 $\{1,2,3,\cdots,c\}$ 的子集），则该题得分为：

$$\begin{cases}\frac{\lvert B \rvert}{\lvert A \rvert}&\text{if\quad}
B\sube A\\0&\text{otherwise}\end{cases}$$

小 $\mathfrak{g}$ 忘记考试的正确答案是什么了，于是她去问小 $\mathfrak{f}$，如果考试的正确答案在合法范围内等概率随机，那么自己期望得分是多少。由于结果可能很大，她只需要知道结果对 $10^9+7$ 取模的值。

**题目保证 $c$ 和 $2^c-c-2$ 都不是 $10^9+7$ 的倍数。**


但是小 $\mathfrak{f}$ 也不会，所以他来求助万能的你。

## 说明/提示

**样例 $1$ 解释：**

得分的期望为 $\frac{67}{25}$，对 $10^9+7$ 取模为 $760000008$。

一种可能的考试的正确答案依次为：

$\texttt{C,D,B,AD,ABD,BC}$

那么答题卡上应该填写：

| $\texttt{C}$ | $\texttt{D}$ | $\texttt{B}$ |
| :----------: | :----------: | :----------: |
| $\texttt{AD}$ | $\texttt{ABD}$ | $\texttt{BC}$ |

实际填写：

| $\texttt{C}$ | $\texttt{B}$ | $\texttt{ABD}$ |
| :----------: | :----------: | :----------: |
| $\texttt{D}$ | $\texttt{AD}$ | $\texttt{BC}$ |

答案为 $\texttt{C}$，填写 $\texttt{C}$，得 $1$ 分。

答案为 $\texttt{D}$，填写 $\texttt{B}$，得 $0$ 分。

答案为 $\texttt{B}$，填写 $\texttt{ABD}$，得 $0$ 分。

答案为 $\texttt{AD}$，填写 $\texttt{D}$，得 $\frac{1}{2}$ 分。

答案为 $\texttt{ABD}$，填写 $\texttt{AD}$，得 $\frac{2}{3}$ 分。

答案为 $\texttt{BC}$，填写 $\texttt{BC}$，得 $1$ 分。

综上，这种情况下，考试得分为：

$1+0+0+\frac{1}{2}+\frac{2}{3}+1=
\frac{19}{6}$ 分。

**本题采用捆绑测试且使用子任务依赖。**

| 编号 | 分值 | $n,m\le$ | $c\le$ | 性质 | 依赖 |
| :----------: | :----------: | :----------: | :----------: | :----------: | :----------: |
| $0$ | $0$ | N/A| N/A | 样例 | 无 |
| $1$ | $5$ | $10^9$ | $10^9$ | A | 无 |
| $2$ | $5$ | $2$ | $4$ | 无 | 无 |
| $3$ | $20$ | $10^3$ | $10$ | 无 | $2$ |
| $4$ | $15$ | $10^9$ | $10$ | 无 | $2,3$ |
| $5$ | $15$ | $10^3$ | $10^3$ | 无 | $2,3$ |
| $6$ | $15$ | $10^3$ | $10^5$ | 无 | $2,3,5$ |
| $7$ | $10$ | $10^3$ | $10^9$ | B | 无 |
| $8$ | $10$ | $10^3$ | $10^9$ | 无 | $2,3,5,6,7$ |
| $9$ | $5$ | $10^9$ | $10^9$ | 无 | $0,1,2,3,4,5,6,7,8$ |

特殊性质 A：$n=1$ 或 $m=1$

特殊性质 B：$k=nm-2$

## 样例 #1

### 输入

```
2 3 3 4```

### 输出

```
760000008```

## 样例 #2

### 输入

```
314159265 358979323 84626433832795028 841971693```

### 输出

```
465094894```

# AI分析结果



**算法分类**  
数学（组合数学、期望计算）、数论（模运算、快速幂、逆元）

---

### **题解思路与算法要点**

1. **期望的线性性**  
   总期望等于各题得分的期望之和，将问题分解为5类题分别计算。

2. **题号对应条件**  
   - 通过方程 $(i-1)m+j = (j-1)n+i$ 推导出 $i-1$ 与 $j-1$ 的比例关系。
   - 使用 $\gcd(n-1,m-1)$ 确定解的步长，最终得出题号对应的题数 $C_{eq}=g+1$。

3. **矩形区域交集计算**  
   - 将原题号和现题号的范围分解为多个矩形，计算交集的面积之和。
   - 分块处理快速计算满足条件的 $(i,j)$ 数量，避免枚举。

4. **期望得分计算**  
   - $S_{eq}=1$，$S_{11}=1/c$，$S_{12}=0$，$S_{21}=1/c$。
   - $S_{22}$ 通过组合数学和二项式定理化简，最终公式为 $\frac{3^c -3\cdot2^c +3}{2(2^c -c -2)^2}$。

5. **模运算处理**  
   - 使用快速幂计算大数幂次，逆元处理分母的模运算。

---

### **关键难点与解决**

1. **区域交集的快速计算**  
   - 原题解通过拆分矩形区域并计算交集，避免了暴力枚举，时间复杂度降为 $O(1)$。

2. **组合公式化简**  
   - $S_{22}$ 的推导涉及复杂的二项式展开和求导技巧，最终得到简洁表达式。

3. **大数处理与模运算**  
   - 针对 $n,m,c$ 的范围，采用数学公式直接计算，并利用费马小定理处理逆元。

---

### **最优思路提炼**

- **分类讨论**：将问题拆分为5类，分别处理各类型的贡献。
- **数学建模**：通过几何分析（矩形区域）快速计算符合条件的题数。
- **组合化简**：利用二项式定理将复杂求和转化为封闭表达式。
- **模运算优化**：使用快速幂和逆元处理大数运算，确保结果正确。

---

### **核心代码实现**

```cpp
#include <bits/stdc++.h>
using namespace std;
const int p = 1e9 + 7;

inline int qpow(int a, long long b) {
    int s = 1;
    while (b) {
        if (b & 1) s = (long long)s * a % p;
        a = (long long)a * a % p;
        b >>= 1;
    }
    return s;
}

int main() {
    int n, m, c;
    long long k;
    cin >> n >> m >> k >> c;
    long long nm = (long long)n * m;
    // 计算 C11' 的四个部分
    long long c11 = (k/m) * (k/n);
    c11 += min(k % m, (k/n));
    c11 += min(k % n, (k/m));
    if (k/m < k % n && k/n <= k % m) c11++;
    // 处理题号对应的部分
    int g = __gcd(n-1, m-1);
    long long step = (g == 0) ? 1 : (nm - 1) / g;
    long long ceq = g + 1;
    // 调整 C11 和 C22
    long long t = (k-1) * g / (nm - 1);
    c11 -= t + 1;
    t = (nm - k - 1) * g / (nm - 1);
    c22 = nm - c11 - (k - c11) * 2 - (t + 1);
    // 计算各期望得分
    int s11 = qpow(c, p-2);
    int s22_numerator = (qpow(3, c) - 3LL*qpow(2, c) + 3) % p;
    int s22_denominator = qpow((qpow(2, c) - c - 2) % p, 2 * (p-2) % (p-1));
    s22_numerator = (s22_numerator + p) % p;
    int s22 = (long long)s22_numerator * qpow(2, p-2) % p * s22_denominator % p;
    // 总答案
    int ans = ((ceq % p) + (c11 % p) * s11 % p + (c22 % p) * s22 % p) % p;
    cout << ans << endl;
    return 0;
}
```

---

### **可视化设计**

**动画方案**  
1. **网格绘制**：在 Canvas 上绘制答题卡网格，横向和纵向排列的题号动态对比。
2. **颜色标记**：
   - 绿色：题号对应的正确位置。
   - 红色：单选题填到多选题位置，反之亦然。
   - 黄色：双方均为多选题的交叉区域。
3. **动态计算**：
   - 分块显示原题号和现题号的范围矩形，高亮交集区域。
   - 步进展示各类题数的计算过程，伴随数值更新。

**复古像素风格**  
- 8位色调色板：使用经典绿色、红色、黄色像素块表示不同区域。
- 音效：计算正确时播放上升音调，错误时短促“哔”声，背景为低循环芯片音乐。

**交互功能**  
- 滑动条调节 $n, m, k, c$，实时更新动画和计算结果。
- 单步执行按钮逐步显示每个计算步骤，帮助理解分块逻辑。

---

### **相似题目推荐**
1. **P3194 [HNOI2008]水平可见直线** - 几何分块与区域计算。
2. **P1495 组合数问题** - 组合数学与模运算。
3. **P4549 【模板】裴蜀定理** - 最大公约数的应用。

---
处理用时：108.93秒
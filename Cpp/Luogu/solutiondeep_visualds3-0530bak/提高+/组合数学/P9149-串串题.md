# 题目信息

# 串串题

## 题目描述

给定长度分别为 $n,m$ 的整数序列 $A,B$ 和常数 $W,d$，序列从 $1$ 开始标号，保证 $A_i,B_i \in [1,W]$。

容易发现，我们有 $\binom{W}{d}$ 种方案选择 $[1,W]$ 中的 $d$ 个互不相同的整数。

对于每一种选择的方案，我们删去 $A$ 中出现的对应的 $d$ 种整数，令此时序列 $B$ 在序列 $A$ 中的出现次数为这次选择方案的权值。

你需要求所有的选择方案的权值和，对 ${10}^9+7$ 取模。

若对题意有疑问，请阅读样例及样例解释。

注：$\binom{a}{b}$ 表示组合数，含义为在 $a$ 个物品中**无序**地选择出 $b$ 个物品的方案数。

**请注意：我们并不会删除序列 $\bm{B}$ 中出现的对应整数。**

## 说明/提示

**【样例解释】**

在样例的第一组数据中：

1. 如果我们选择删去 $A$ 中的字符 $1$，$A$ 将变为 $\{2\}$，此时 $B$ 在 $A$ 中的出现次数为 $0$。
1. 如果我们选择删去 $A$ 中的字符 $2$，$A$ 将变为 $\{1,1,1\}$，此时 $B$ 在 $A$ 中的出现次数为 $2$。
1. 如果我们选择删去 $A$ 中的字符 $3$，$A$ 将变为 $\{1,1,2,1\}$，此时 $B$ 在 $A$ 中的出现次数为 $1$。

因此，第一组数据的答案为 $0+2+1=3$。

**再次提醒：我们并不会删除序列 $\bm{B}$ 中出现的对应整数。**

---

**【数据范围】**

对于 $100\%$ 的数据，$1 \le n,m,W \le {10}^6$，$1 \le d, A_i, B_j \le W$，$1 \le T \le 5$。

**本题采用捆绑测试且开启子任务依赖！**

| 子任务 | $n \le$ | $m \le$ | $W \le$ | 特殊性质 | 分数 | 依赖 |
| - | - | - | - | - | - | - |
| 1 | $10$ | $10$ | $5$ | | $10$ | \ |
| 2 | $1000$ | $1000$ | $5$ | | $20$ | 子任务 1 |
| 3 |  | | | A | $15$ | \ |
| 4 |  | | | B | $25$ | \ |
| 5 | | | | | $30$ | 子任务 1、2、3、4 |

特殊性质 A：保证 $d=1$。

特殊性质 B：令 $c$ 表示仅在序列 $A$ 中出现，而不在序列 $B$ 中出现的数字总数。保证 $c \le 5$。

## 样例 #1

### 输入

```
2
4 2 3 1
1 1 2 1
1 1
8 3 4 1
1 2 3 1 2 3 1 2
1 2 1
```

### 输出

```
3
2
```

# AI分析结果



**唯一算法分类**：组合数学 + 字符串匹配（KMP/Z算法） + 双指针滑动窗口

---

### **题解思路与算法要点**

**核心思路**：
1. **关键数与非关键数分离**：B中的数必须保留，因此仅考虑删除A中不在B中的数（非关键数）。
2. **字符串匹配**：将A中的关键数提取成新序列C，用KMP或Z算法找出所有B在C中的匹配位置。
3. **区间贡献计算**：对每个匹配区间，统计原A中对应区间内的非关键数种类数t，贡献为组合数C(c-t, d-t)，其中c是A中总非关键数种类。
4. **双指针维护区间**：滑动窗口统计每个匹配区间内的非关键数种类，保证时间复杂度线性。

**解决难点**：
- **高效匹配**：KMP/Z算法确保字符串匹配的线性时间复杂度。
- **动态统计种类数**：利用双指针和桶数组维护当前区间内的非关键数种类，避免重复遍历。
- **组合数预处理**：通过阶乘和逆元预处理实现O(1)组合数查询。

---

### **题解评分（≥4星）**
1. **Demeanor_Roy（5星）**  
   - **亮点**：代码结构清晰，双指针维护区间与桶计数实现高效；KMP预处理与匹配逻辑简洁。
   - **核心代码**：通过预处理阶乘和逆元，组合数计算快速；滑动窗口动态维护区间内的非关键数。

2. **离散小波变换°（4.5星）**  
   - **亮点**：详细推导组合数贡献公式，变量命名清晰；双指针维护区间逻辑与桶计数实现明确。
   - **优化**：直接使用原数组下标处理，减少空间占用。

3. **Mr_Az（4星）**  
   - **亮点**：代码注释详细，适合初学者理解；组合数计算部分单独封装，模块化清晰。
   - **改进点**：桶数组初始化逻辑可进一步优化。

---

### **最优思路提炼**
1. **关键数过滤**：提取A中的关键数生成新序列，避免无效匹配。
2. **KMP/Z算法匹配**：快速定位B在过滤后的序列中的位置。
3. **滑动窗口统计**：双指针动态维护原A中匹配区间内的非关键数种类，保证线性时间复杂度。
4. **组合数预处理**：阶乘与逆元预处理实现高效组合数计算。

---

### **同类型题与算法套路**
- **组合数学+字符串匹配**：如[CF1016E Rest In The Shades](https://codeforces.com/problemset/problem/1016/E)，需结合几何与字符串匹配。
- **双指针统计区间属性**：如[LeetCode 76. Minimum Window Substring](https://leetcode.com/problems/minimum-window-substring/)，动态维护区间内字符出现次数。
- **预处理逆元优化计算**：常见于组合数频繁查询问题，如[洛谷P3807 卢卡斯定理](https://www.luogu.com.cn/problem/P3807)。

---

### **推荐题目**
1. **P3375 【模板】KMP字符串匹配**  
   - **考察点**：KMP算法基础实现。
2. **P1495 曹冲养猪**  
   - **考察点**：组合数学与模运算结合。
3. **P1106 删数问题**  
   - **考察点**：贪心与双指针维护区间属性。

---

### **个人心得摘录**
- **调试教训**：需注意KMP的`nx`数组初始化，避免越界访问（如处理`B[m+1]`时需清空）。
- **优化技巧**：滑动窗口移动时，桶数组增减需判断是否影响种类数，避免重复计数。

---

### **可视化算法设计**
**动画方案**：
1. **像素风格展示**：  
   - **数据结构**：将A、B序列以8位像素块显示，关键数（绿色）、非关键数（红色）。
   - **KMP匹配**：高亮当前匹配位置，显示`nx`数组的跳转过程（仿红白机箭头动画）。
   - **双指针滑动**：左右指针（蓝色/黄色）动态移动，当前区间内非关键数以闪烁效果标记。

2. **音效交互**：  
   - **匹配成功**：播放8-bit胜利音效。
   - **指针移动**：步进时触发“嘀”声，桶更新时触发“咔哒”声。

3. **Canvas控制面板**：  
   - **步进控制**：按钮支持暂停/继续/单步，速度调节滑块（1x~5x）。
   - **自动演示**：AI模式自动执行算法，展示最优路径。

**代码片段（JS伪代码）**：
```javascript
// 初始化像素画布
const canvas = initCanvas("8bit-style");
drawArray(A, { keyColor: '#00FF00', nonKeyColor: '#FF0000' });

// KMP匹配动画
function animateKMP() {
    let i = 0, j = 0;
    while (i < C.length) {
        highlight(i, j); // 高亮当前比较位置
        if (j === B.length) {
            playSound('win'); // 匹配成功音效
            markMatch(i - B.length); // 标记匹配区间
        }
        // KMP跳转逻辑...
    }
}

// 双指针维护区间
function animateSlidingWindow(matchPositions) {
    let l = 1, r = 0, cnt = 0;
    for (const pos of matchPositions) {
        while (r < pos.end) {
            r++;
            if (isNonKey(A[r])) updateBucket(A[r], +1); // 更新桶并播放音效
        }
        while (l < pos.start) {
            if (isNonKey(A[l])) updateBucket(A[l], -1);
            l++;
        }
        highlightInterval(l, r); // 高亮当前区间
    }
}
```

---

**结论**：通过组合数学与字符串匹配的高效结合，双指针动态维护区间属性，实现线性时间复杂度求解。可视化设计通过复古像素风格与交互音效，增强算法理解与学习趣味性。

---
处理用时：85.38秒
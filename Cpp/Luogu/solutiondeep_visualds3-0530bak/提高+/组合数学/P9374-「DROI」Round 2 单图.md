# 题目信息

# 「DROI」Round 2 单图

## 题目背景

与其编写苍白无力的背景，不如出更有质量的题。

## 题目描述

我们称[简单有向图](https://www.luogu.com.cn/paste/4oz6fep2) $G,H$ **本质相同**，当且仅当：

- 对于任意点对 $(u,v)$，若在图 $G$ 中从 $u$ 出发能走到 $v$，则在图 $H$ 中从 $u$ 出发能走到 $v$。反之若在图 $H$ 中从 $u$ 出发能走到 $v$，则在图 $G$ 中从 $u$ 出发也能走到 $v$。

若对于简单有向图 $G$，不存在其他简单有向图 $H$ 与其本质相同，则我们称图 $G$ 为 **单图**。

$T$ 次询问，每次询问给定一个正整数 $n$，请你回答 $n$ 个点的**有标号**单图数。

## 说明/提示

#### 数据范围

**「本题采用捆绑测试」** 

- $\operatorname{Subtask} 1(30\%)$：$T = 1$，$n \leq 5$。

- $\operatorname{Subtask} 2(50\%)$：$T \leq 10$。

- $\operatorname{Subtask} 3(20\%)$：无特殊限制。

对于 $100\%$ 的数据满足：$1 \leq T,n \leq 1000$，$1\leq mod \leq 10^9$。


#### 说明提示

这里给出一些例子来帮助理解单图的含义：

------------

![](https://cdn.luogu.com.cn/upload/image_hosting/kykl8fg8.png)[](https://www.luogu.com.cn/paste/0tbbkesd)

这是一张单图，可以证明不存在其他图与其本质相同。

------------

![](https://cdn.luogu.com.cn/upload/image_hosting/5appj8pr.png)

这不是一张单图，因为我们可以添加边 $(5,2)$ 构造出与其本质相同的图。

------------

![](https://cdn.luogu.com.cn/upload/image_hosting/wtsep329.png)

这不是一张单图，因为我们可以删去边 $(1,3)$ 构造出与其本质相同的图。



## 样例 #1

### 输入

```
5 998244353
1
3
5
12
888```

### 输出

```
1
16
986
328006912
535268381```

# AI分析结果



---

### **唯一算法分类**  
组合数学 + 动态规划

---

### **综合分析与结论**  
**题目核心**：计算满足特定传递闭包唯一性的有向图（单图）数量。关键点在于避免存在可被增减的冗余边，同时处理特殊的二元环结构。

**核心难点**：  
1. **结构限制**：单图的每个节点必须满足入度或出度为0，或构成孤立的二元环。  
2. **组合计数**：需分治处理二元环与非二元环部分，避免重复/遗漏。  

**算法流程**：  
1. **预处理组合数**：通过杨辉三角计算所有可能的组合数。  
2. **动态规划预处理**：  
   - **非二元环部分**（`g[n]`）：枚举入度/出度节点数，计算合法边组合。  
   - **二元环部分**（`h[n]`）：递推计算二元环配对方案数。  
3. **合并结果**：枚举可能的二元环数量，组合两部分方案数。  

**可视化设计**：  
- **动画流程**：  
  1. 展示从n个点中选出k对二元环（高亮配对过程）。  
  2. 剩余点按入度/出度分组（颜色区分），动态显示连边组合。  
  3. 逐步累加方案数，通过颜色标记当前操作（选择/分组/连边）。  
- **复古像素风格**：  
  - **颜色方案**：红/蓝区分入度/出度节点，绿色高亮当前操作。  
  - **音效触发**：配对成功时播放上升音调，连边计算时播放点击声。  

---

### **题解清单（4星及以上）**  
1. **Demeanor_Roy（官方题解）★★★★☆**  
   - **亮点**：直接分治二元环与非环结构，代码简洁高效。  
   - **关键代码**：预处理组合数 + 动态规划计算`g`和`h`数组。  

2. **0000pnc ★★★★☆**  
   - **亮点**：详细推导二元环的配对公式，代码注释清晰。  
   - **心得摘录**："发现二元环必须完全孤立，否则会导致冗余边"。  

3. **August_Light ★★★★**  
   - **亮点**：通过容斥原理处理孤立点边界情况，数学推导严谨。  

---

### **最优思路提炼**  
1. **分治策略**：将问题分解为二元环和非环部分，独立计算后组合。  
2. **组合数优化**：预处理所有组合数避免重复计算。  
3. **动态规划递推**：  
   - 非环部分通过枚举入度/出度节点数快速计算。  
   - 二元环部分通过递推公式`h[2k] = (2k-1) * h[2k-2]`高效求解。  

---

### **同类型题推荐**  
1. **P3773 [组合数问题]**：预处理组合数模意义下的快速计算。  
2. **P2523 [排列计数]**：分治策略与递推优化的经典问题。  
3. **P6789 [有标号DAG计数]**：类似图的计数问题，需分治处理。  

---

### **代码片段（核心逻辑）**  
```cpp
// 预处理组合数
for (int i = 0; i <= 1000; i++) {
    C[i][0] = 1;
    for (int j = 1; j <= i; j++)
        C[i][j] = (C[i-1][j-1] + C[i-1][j]) % mod;
}

// 计算非环部分方案数 g[n]
for (int i = 0; i <= 1000; i++) {
    for (int j = 0; j <= i; j++) {
        int k = i - j;
        g[i] = (g[i] + C[i][j] * qpow(qpow(2, k) - 1, j)) % mod;
    }
}

// 计算二元环部分方案数 h[n]
h[0] = 1;
for (int i = 2; i <= 1000; i += 2)
    h[i] = h[i-2] * (i-1) % mod;

// 合并结果
int ans = 0;
for (int k = 0; k <= n; k += 2)
    ans = (ans + C[n][k] * h[k] % mod * g[n-k] % mod) % mod;
```

---

### **可视化与算法演示**  
**动画步骤**：  
1. **选择二元环**：从节点池中动态选取配对，红蓝交替高亮已选对。  
2. **分组剩余节点**：左侧节点（黄色）为出度组，右侧（紫色）为入度组。  
3. **连边计算**：显示每组节点的可能连边数（`2^k-1`），实时更新总方案数。  

**交互设计**：  
- **速度调节**：滑动条控制动画速度（100ms~2s）。  
- **音效反馈**：成功配对时播放8-bit音效，错误操作时短促“哔”声。  
- **自动演示模式**：AI自动遍历所有可能的二元环数量，展示最优解路径。  

---

**复古风格实现**：  
```javascript
// Canvas绘制示例（伪代码）
function drawStep(ctx, nodes, pairs) {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    // 绘制节点
    nodes.forEach((node, idx) => {
        ctx.fillStyle = node.highlight ? '#FF5555' : '#5555FF';
        ctx.fillRect(node.x, node.y, 16, 16);
    });
    // 绘制配对连线
    pairs.forEach(pair => {
        ctx.beginPath();
        ctx.moveTo(pair.a.x + 8, pair.a.y + 8);
        ctx.lineTo(pair.b.x + 8, pair.b.y + 8);
        ctx.strokeStyle = '#55FF55';
        ctx.stroke();
    });
}
```

---
处理用时：77.85秒
# 题目信息

# [NOI2005] 聪聪与可可

## 题目描述

在一个魔法森林里，住着一只聪明的小猫聪聪和一只可爱的小老鼠可可。虽然灰姑娘非常喜欢她们俩，但是，聪聪终究是一只猫，而可可终究是一只老鼠，同样不变的是，聪聪成天想着要吃掉可可。

一天，聪聪意外得到了一台非常有用的机器，据说是叫 GPS，对可可能准确的定位。有了这台机器，聪聪要吃可可就易如反掌了。于是，聪聪准备马上出发，去找可可。而可怜的可可还不知道大难即将临头，仍在森林里无忧无虑的玩耍。小兔子乖乖听到这件事，马上向灰姑娘报告。灰姑娘决定尽快阻止聪聪，拯救可可，可她不知道还有没有足够的时间。

整个森林可以认为是一个无向图，图中有 $N$ 个美丽的景点，景点从 $1$ 至 $N$ 编号。小动物们都只在景点休息、玩耍。在景点之间有一些路连接。

当聪聪得到 GPS 时，可可正在景点 $M$（$M \le N$）处。以后的每个时间单位，可可都会选择去相邻的景点（可能有多个）中的一个或停留在原景点不动。而去这些地方所发生的概率是相等的。假设有 $P$ 个景点与景点 $M$ 相邻，它们分别是景点 $R$、景点 $S$、……、景点 $Q$，在时刻 $T$ 可可处在景点 $M$，则在 $(T+1)$ 时刻，可可有 $1/(1 +P)$ 的可能在景点 $R$，有 $1/(1 +P)$ 的可能在景点 $S$，……，有 $1/(1 +P)$ 的可能在景点 $Q$，还有$1/(1 +P)$的可能停在景点 $M$。

我们知道，聪聪是很聪明的，所以，当她在景点 $C$ 时，她会选一个更靠近可可的景点，如果这样的景点有多个，她会选一个标号最小的景点。由于聪聪太想吃掉可可了，如果走完第一步以后仍然没吃到可可，她还可以在本段时间内再向可可走近一步。

在每个时间单位，假设聪聪先走，可可后走。在某一时刻，若聪聪和可可位于同一个景点，则可怜的可可就被吃掉了。

灰姑娘想知道，平均情况下，聪聪几步就可能吃到可可。而你需要帮助灰姑娘尽快的找到答案。

## 说明/提示

【样例说明 1】 

开始时，聪聪和可可分别在景点 1 和景点 4。 

第一个时刻，聪聪先走，她向更靠近可可(景点 4)的景点走动，走到景点 2， 然后走到景点 3；假定忽略走路所花时间。 

可可后走，有两种可能： 第一种是走到景点 3，这样聪聪和可可到达同一个景点，可可被吃掉，步数为 $1$，概率为$0.5$。
 
第二种是停在景点 4，不被吃掉。概率为 $0.5$。

到第二个时刻，聪聪向更靠近可可(景点 4)的景点走动，只需要走一步即和 可可在同一景点。因此这种情况下聪聪会在两步吃掉可可。 所以平均的步数是 $1\times 1/2 + 2\times 1/2 =1.5$ 步。

【样例说明 2】

森林如下图所示：

![](https://cdn.luogu.com.cn/upload/image_hosting/8uiq0ltc.png)

对于 50%的数据，$1≤N≤50$。  
对于所有的数据，$1≤N,E≤1000$。 

## 样例 #1

### 输入

```
4 3 
1 4 
1 2 
2 3 
3 4```

### 输出

```
1.500 
```

## 样例 #2

### 输入

```
9 9 
9 3 
1 2 
2 3 
3 4 
4 5 
3 6 
4 6 
4 7 
7 8 
8 9```

### 输出

```
2.167```

# AI分析结果



## 算法分类
动态规划（期望DP） + 最短路预处理

---

## 综合分析与结论
### 核心思路
1. **预处理猫的移动路径**  
   - 对每个节点i进行BFS/SPFA，计算所有节点j的最短距离dis[i][j]
   - 预处理nxt[i][j]：猫在i点、鼠在j点时，猫下一步最优移动方向（最短距离前提下选编号最小的节点）

2. **期望DP状态转移**  
   - 定义f[i][j]为猫在i、鼠在j时的期望步数
   - 状态转移分三种情况：
     - 猫鼠同点：f[i][j] = 0
     - 猫能在1~2步抓到鼠：f[i][j] = 1
     - 其他情况：f[i][j] = 1 + Σ(f[猫两步后的位置][鼠新位置] * 概率)

3. **记忆化搜索实现**  
   - 通过DFS递归计算f[i][j]，避免重复计算
   - 每次转移需计算鼠所有可能的移动方向（包括停留原地）

---

### 可视化设计要点
1. **核心动画展示**  
   - **节点图**：用网格展示N个景点，猫鼠用不同颜色像素块表示（猫红色，鼠蓝色）
   - **移动轨迹**：猫每次移动两步，路径用黄色高亮；鼠随机移动用闪烁绿色箭头表示
   - **期望计算**：右侧面板实时显示当前状态f[i][j]值，用数字气泡动画更新

2. **复古风格实现**  
   - **8位音效**：
     - 猫移动时播放"哔"短音
     - 鼠移动时播放"嘟"低音
     - 状态更新时用"叮"音效
   - **像素动画**：
     - 猫移动路径用黄色轨迹渐隐效果
     - 当前处理状态用闪烁边框标记

3. **交互控制**  
   - 支持拖拽调整初始位置
   - 速度调节滑块（0.5x~5x）
   - 单步执行按钮观察关键状态转移

---

## 题解清单（≥4★）
### 1. FREEH（5★）
- **亮点**：
  - 使用SPFA预处理最短路，时间复杂度更优
  - 清晰的预处理逻辑：nxt数组通过距离差推导
  - 状态转移公式推导严谨，注释清晰
```cpp
// 预处理nxt数组的核心逻辑
for (int i=1;i<=n;i++)
    for (int h=head[i];h!=-1;h=e[h].next){
        int t=e[h].t;
        for (int j=1;j<=n;j++)
            if (dis[i][j]-1==dis[t][j]) // 关键判断：是否在最短路径上
                nxt[i][j] = min(nxt[i][j],t);
    }
```

### 2. Booksnow（4.5★）
- **亮点**：
  - 逆向BFS预处理nxt数组，实现方式新颖
  - 详细注释解释了"猫走两步"的状态转移
  - 代码结构模块化，可读性强

### 3. 钱逸凡（4★）
- **亮点**：
  - 使用标准BFS预处理，适合教学理解
  - 状态转移公式数学表达清晰
  - 包含概率计算的数学推导注释

---

## 最优思路提炼
### 关键技巧
1. **最短路径预处理**  
   - 对每个节点i进行BFS，得到dis[i][*]数组
   - 推导nxt数组时，通过判断dis[i][j] == dis[k][j]+1（k是i的邻接点）确定最短路径上的节点

2. **记忆化搜索优化**  
   - 用visit数组标记已计算状态
   - 优先处理终止条件（i==j或两步可达）

3. **期望计算技巧**  
   ```math
   f[i][j] = 1 + \frac{1}{deg[j]+1}\left( f[sec][j] + \sum_{k∈adj[j]} f[sec][k] \right)
   ```
   - 其中sec = nxt[nxt[i][j]][j]（猫走两步后的位置）
   - deg[j]+1包含停留原地的概率

---

## 相似题目推荐
1. **P1850 换教室**  
   - 期望DP与图论结合，需预处理最短路

2. **P4550 收集邮票**  
   - 经典期望模型，状态转移与概率计算类似

3. **P6835 [Cnoi2020]线形生物**  
   - 图上游走的期望计算，需建立转移方程

---

## 核心代码实现
```cpp
// FREEH题解核心代码
double DFS(int u, int v) {
    if (visit[u][v]) return f[u][v];
    if (u == v) return 0;
    int fir = nxt[u][v], sec = nxt[fir][v];
    if (fir == v || sec == v) return 1; // 终止条件
    
    double sum = 0;
    for (int h = head[v]; h != -1; h = e[h].next) // 枚举鼠的移动
        sum += DFS(sec, e[h].t);
    sum += DFS(sec, v); // 停留原地
    
    visit[u][v] = true;
    return f[u][v] = sum / (p[v]+1) + 1; // +1表示当前步
}
```

---

## 可视化算法演示
### 动画步骤示例
1. **初始化阶段**  
   - 红色像素块（猫）在节点1，蓝色（鼠）在节点4
   - 显示dis[1][4]=3，nxt[1][4]=2

2. **第一次移动**  
   - 猫先移动两步：1→2→3（黄色轨迹）
   - 鼠随机移动：50%到3（结束），50%留在4
   - 右侧面板显示f[1][4] = 0.5*1 + 0.5*(...)

3. **递归计算**  
   - 当鼠留在4时，显示猫从3出发的第二次移动
   - 最终收敛到期望值1.5

### 控制面板功能
- **速度调节**：滑块控制动画帧间隔（100ms~2000ms）
- **高亮模式**：勾选后重点显示：
  - 当前计算的f[i][j]状态
  - 猫的移动路径
  - 鼠的概率分布

---
处理用时：72.73秒
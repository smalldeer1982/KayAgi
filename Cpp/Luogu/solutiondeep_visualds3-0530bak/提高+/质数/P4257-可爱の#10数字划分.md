# 题目信息

# 可爱の#10数字划分

## 题目背景

可可可可可可爱的付公主 qwq 有 $n$ 个数，$1\sim n$，每个数都有价值 $V_i$，你要将它们划分成若干个集合，每个数属于一个集合。

## 题目描述

我们这里规定:

1. 质数只能和质数分在同一个集合。  
2. 合数只能和合数分在同一个集合（$1$ 也算在合数内）。   
3. 我们假设目前所有质数集合的并集为 $U$（也就是之前所有质数集合以及 $S$ 的并集），每个质数集合 $S$ 的价值定义如下：  
$$V_S=\frac {(\sum_{i\in S}V_i)^p} {\prod_{i\in U}V_i}$$

4. 我们定义每个合数集合 $S$ 的价值如下:

令 $k=|S|$，我们用这 $k$ 个数分别作为 $k$ 条边的权值，连接 $k+1$ 个点，构成一棵树。对于一个排列 $P(1\sim k+1)$，价值为：

$$V_P=\sum_{i=1}^{n-1} f(P_i,P_{i+1})$$

其中 $f(u,v)$ 为路径 $(u,v)$ 上最大的边权。

集合 $S$ 的价值为：

$$V_S=E(\min\{V_P\})\times|S|$$

其中 $E(X)$ 代表 $X$ 的数学期望，期望是针对所有可能的有标号无根树，$\min$ 是针对所有可能的 $P$。这时集合内所有元素都不同，也就是所有边不同。

5. 一个划分方案的价值定义为所有集合的价值的乘积。
6. 两个划分方案相同当且仅当它们中所有集合对应相同，且质数集合的相对顺序相同。

现在给定 $n,p$ 和 $V_i$，请你求出所有合法的不同划分方案的价值之和。

结果对 $10^9+7$ 取模，除法请使用乘法逆元。

## 说明/提示

### 样例解释

有以下 $6$ 种划分方案:

1. $(2,3)$ 和 $(1,4)$。$(2,3)$ 的价值为 ${\dfrac 5 6}$，$(1,4)$ 的价值为 $10$，总价值为 ${\dfrac {25} 3}$。
2. $(2),(3)$ 和 $(1,4)$。$(2)$ 的价值为 $1$，$(3)$ 的价值为 ${\dfrac 1 2}$，$(1,4)$ 的价值为 $10$，总价值为 $5$。
3. $(3),(2)$ 和 $(1,4)$。$(3)$ 的价值为 $1$，$(2)$ 的价值为 ${\dfrac 1 3}$，$(1,4)$ 的价值为 $10$，总价值为 ${\dfrac {10} 3}$。
4. $(2,3)$ 和 $(1),(4)$。$(2,3)$ 的价值为 ${\dfrac 5 6}$，$(1)$ 的价值为 $1$，$(4)$ 的价值为 $4$，总价值为 ${\dfrac {10} 3}$。
5. $(2),(3)$ 和 $(1),(4)$。$(2)$ 的价值为 $1$，$(3)$ 的价值为 ${\dfrac 1 2}$，$(1)$ 的价值为 $1$，$(4)$ 的价值为 $4$，总价值为 $2$。
6. $(3),(2)$ 和 $(1),(4)$。$(3)$ 的价值为 $1$，$(2)$ 的价值为 ${\dfrac 1 3}$，$(1)$ 的价值为 $1$，$(4)$ 的价值为 $4$，总价值为 ${\dfrac 4 3}$。

因此所有划分方案的价值和为${\dfrac {70} 3}$。对 $10^9+7$ 取模后结果为 $333333359$。

### 数据范围

对于 $100\%$ 的数据，满足 $1\le n\le 70$，$1\le V_i\le 10^{12}$。

下表中给出了每个测试点具体的数据范围，都表示小于等于。为了防止卡 OJ，所以本题数据组数进行压缩，分值改变，具体参照表格。

| 数据编号 |  n   |  p   |  Vi   | 测试点分值 | 时限 |
| :------: | :--: | :--: | :---: | :--------: | :--: |
|    1     |  10  |  1   |  100  |     10     |  1s  |
|    2     |  20  |  1   | 1000  |     10     |  1s  |
|    3     |  30  |  1   | 10000 |     10     |  1s  |
|    4     |  40  | 1e9  | 1e12  |     10     |  1s  |
|    5     |  50  |  1   | 1e12  |     5      |  1s  |
|    6     |  50  | 1e9  | 1e12  |     5      |  1s  |
|    7     |  60  |  1   | 1e12  |     5      |  2s  |
|    8     |  60  | 1e9  | 1e12  |     5      |  2s  |
|    9     |  70  | 1e9  | 1e12  |     20     |  10s  |
|    10    |  70  | 1e9  | 1e12  |     20     |  5s  |

提示：大家不要太过相信自己的常数，尽量做好常数优化。

## 样例 #1

### 输入

```
4 1
1 2 3 4
```

### 输出

```
333333359```

# AI分析结果



## 唯一算法分类
动态规划（子集卷积优化）与图论期望模型

---

## 综合分析与结论

### 题解核心思路
1. **质数与合数分离处理**  
   质数集合与合数集合的价值计算相互独立，可分别计算后相乘。

2. **质数集合的贡献**  
   - 动态规划定义：`dp[S]` 表示质数集合 `S` 的划分方案总贡献  
   - 转移方程：`dp[S] = sum_{T⊆S} dp[T] * (sum V_T)^p / (prod V_S)`  
   - 优化：使用 FMT（快速莫比乌斯变换）将复杂度从 O(3^n) 降至 O(2^n n^2)

3. **合数集合的结论**  
   - 最小生成树边权和的期望等于所有边权之和  
   - 集合价值公式：`V_S = (sum边权) * |S|`  
   - 动态规划分组：背包问题处理合数分组

### 解决难点
- **质数子集划分的高效计算**：通过子集卷积处理重叠子集  
- **合数期望的数学推导**：利用最大生成树边权排序性质简化计算  
- **模数下的除法处理**：预计算所有可能的逆元

### 可视化设计思路
- **像素化分组动画**：  
  1. 质数以金色方块显示，合数以绿色方块显示  
  2. 动态展示质数子集生成过程（二进制状态高亮）  
  3. 合数分组时显示边权排序与累加过程  
- **音效触发**：  
  - 质数子集选中：8-bit "哔"声  
  - 合数分组完成：上扬音效  
  - 错误操作：短促低音  

---

## 题解清单（4.5星）

### 官方题解（4.5星）
- **亮点**：  
  1. 拆解问题为质数/合数独立子问题  
  2. 结合子集卷积与图论结论  
  3. 提供时间复杂度优化路径  
- **改进点**：样例推导可更详细

---

## 核心代码实现

### 质数部分 FMT 优化
```cpp
void FMT(vector<int>& dp, int n) {
    for (int i = 0; i < n; ++i)
        for (int S = 0; S < (1<<n); ++S)
            if (S >> i & 1)
                dp[S] = (dp[S] + dp[S^(1<<i)]) % MOD;
}
```

### 合数部分背包 DP
```cpp
vector<int> dp_comp(m+1, 0);
dp_comp[0] = 1;
for (int x : composite) {
    for (int i = m; i >= x; --i) {
        dp_comp[i] = (dp_comp[i] + dp_comp[i-x] * x % MOD) % MOD;
    }
}
```

---

## 同类型题目
1. **子集卷积应用**：LOJ 158. 子集卷积  
2. **生成树期望模型**：CF 888G Xor-MST  
3. **分治背包问题**：Luogu P4389 付公主的背包  

---

## 复古游戏化动画设计
- **颜色方案**：  
  - 质数：金色（#FFD700）  
  - 合数：绿色（#00FF00）  
  - 当前操作块：红色闪烁  
- **Canvas 绘制**：  
  1. 顶部显示质数二进制分组状态  
  2. 底部展示合数背包容量进度条  
- **AI 演示模式**：  
  - 自动优先选择最大质数子集  
  - 合数按降序填入背包  

---

## 个人心得
- **逆元预计算**：在 n=70 时需预处理 1~sumV 的逆元  
- **质数筛优化**：使用欧拉筛法处理 1e6 规模质数  
- **边界条件**：注意 p=1 与 p=1e9 时的快速幂差异

---
处理用时：67.97秒
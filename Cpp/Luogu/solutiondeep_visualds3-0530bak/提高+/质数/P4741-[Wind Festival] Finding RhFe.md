# 题目信息

# [Wind Festival] Finding RhFe

## 题目背景

$[Morning - 8:00 A.M.]$

热衷于结交老铁的$gyx$小哥哥听说了风筝节的举办，一大早就来到了现场，现在他已经迫不及待见到来玩的同学们啦~

## 题目描述

$gyx$的人格魅力是无限哒~

已知风筝节上有$N$($1\le N\le 10^6$)个同学（来玩的人真的很多），每个同学都对$gyx$有一个兴趣程度$c_i$（$ |c_i|\le 10^9$），因为$gyx$的性格特点太明显啦，不存在对$gyx$兴趣程度为$0$的同学，对于每个同学，都可以和$gyx$结交为老铁，$gyx$的高兴程度就是所有结！交！过！成为老铁的同学对$gyx$兴趣程度之和。$gyx$不愿意做令自己伤心的事情，所以如果所有同学对$gyx$感到反感（即兴趣程度为负）$gyx$就会直接离开风筝节。

$gyx$可以选择其中的$k$（$1\le k\le N$）个同学来结交，但一旦选择好，$gyx$的结交顺序就不可以变化了。

因为来风筝节的人实在是太多啦，$gyx$不愿意记住所有的老铁太长的时间，但是$gyx$的脑子里记着与越早结交的老铁的点点滴滴越多，也越难忘记，$gyx$忘记每个人的条件是当且仅当，在$gyx$还记着的老铁里当前的这个老铁是最后结交的。

但是由于$gyx$希望与更多不同性格的同学结交，$gyx$与每一个同学只愿意结交一次，即使遗忘以后也不会再次结交。

当风筝节上$gyx$选择的同学都结交结束后，随着时间的流逝，$gyx$也会渐渐地把所有同学都忘掉，遗忘方式与之前相同，直到最后忘记了自己结交过的所有老铁，再出发前往新的征程。

由于不同的交友并遗忘的顺序可能会发生有趣的事情，$gyx$想知道在保证自己高兴程度最大时选择好结交范围和结交顺序的情况下，$gyx$可以有多少种不同的交友并遗忘的顺序呢？

由于来风筝节的人实在是太多了，$gyx$只想知道不同顺序的方案数的值对$P$（$0<P\le 10^9$）取模后的结果。

## 说明/提示

对于$30\%$的数据保证$1\le N\le 30$；

对于$70\%$的数据保证$1\le N\le 500$；

对于$100\%$的数据保证$1\le N\le 10^6$，$0<P\le 10^9$，$|c_i|\le 10^9$。


## 样例 #1

### 输入

```
8 65
-1
36
21
97
-65
17
1
43```

### 输出

```
2```

# AI分析结果



**唯一算法分类**  
组合数学

---

**综合分析与结论**  
题目核心在于计算最大高兴值下的顺序方案数，转化为卡塔兰数问题。关键步骤包括：  
1. **选择策略**：必须选取所有正兴趣值的同学。  
2. **卡塔兰数推导**：结交顺序与遗忘顺序的组合数为第n个卡塔兰数，对应栈操作序列数。  
3. **模运算处理**：因模数P非质数，需对卡塔兰数进行质因数分解，逐质数计算指数后取模。  

**可视化设计思路**：  
- **动画方案**：  
  1. **栈操作模拟**：像素化显示同学入栈（结交）与出栈（遗忘）的流程，不同颜色区分正负兴趣值。  
  2. **质因数分解过程**：用网格展示每个质数在分子/分母中的指数变化，高亮当前处理的质数。  
- **复古风格**：8位像素音效提示质数处理完成，背景播放循环芯片音乐。  
- **控制面板**：支持调整动画速度，单步查看质数分解步骤。

---

**题解清单 (5星)**  
1. **题解作者：nitrobenzene**  
   - **亮点**：  
     - 正确推导卡塔兰数模型，处理非质数模数问题。  
     - 质因数分解实现高效，筛法预处理优化质数计算。  
   - **代码可读性**：函数分工明确，逻辑清晰。  

---

**核心代码实现**  
```cpp
// 筛法生成质数表
void init(){
    ll n=maxn;
    memset(vis,1,sizeof(vis));
    vis[1]=0;
    vis[2]=1;
    p.push_back(2); 
    for(int i=4;i<=n;i+=2) vis[i]=0;
    for(ll i=3;i*i<=n;i+=2){
        if(vis[i]){
            for(ll j=i*i;j<=n;j+=i) vis[j]=0;
        }
    }
    for(int i=3;i<=maxn;i+=2++){
        if(vis[i]) p.push_back(i); 
    }
    p.push_back(maxn); // 防越界
}

// 计算卡塔兰数质因数指数
void katalan(int n){
    add_alpha_fact(2*n);      // 处理分子(2n)!
    sub_twice_alpha_fact(n);  // 减去分母(n!)^2
    sub_alpha(n+1);           // 减去分母(n+1)
}
```

---

**同类型题与相似套路**  
- **组合数模非质数**：质因数分解法通用。  
- **卡塔兰数应用**：括号序列、栈操作、二叉树计数。  

**推荐题目**  
1. [P1044 栈](https://www.luogu.com.cn/problem/P1044)  
2. [P3200 有趣的数列](https://www.luogu.com.cn/problem/P3200)  
3. [P3807 卢卡斯定理](https://www.luogu.com.cn/problem/P3807)  

---

**个人心得摘录**  
- **质数筛优化**：预处理质数至2N避免分解越界。  
- **调试技巧**：验证卡塔兰数计算时需注意样例中的正数计数，避免逻辑错误。  

---

**复古游戏化动画实现要点**  
1. **像素风格**：  
   - **调色板**：16色，质数用不同颜色块表示。  
   - **Canvas绘制**：网格显示质数分解进度，当前操作质数高亮闪烁。  
2. **音效设计**：  
   - **分解完成**：短促“哔”声。  
   - **计算结束**：8-bit胜利旋律。  
3. **AI自动演示**：按质数从小到大自动播放分解过程，支持暂停/继续。

---
处理用时：122.26秒
# 题目信息

# [入门赛 #9] 最澄澈的空与海 (Hard Version)

## 题目背景

材料 1：

> 请小心地计算下面的算式：$138 - 108 \div 6 = ?$  
> 你大概难以置信，这个算式的计算结果竟然是 $5!$

材料 2：

> 对于一个正整数 $x$，$x! = 1 \times 2 \times \cdots \times (x - 1) \times x$。我们称 $x!$ 为 $x$ 的阶乘。  
> 特别的，$0! = 1$。

显然，「$138 - 108 \div 6 = 5$」是错误的，而「$(138 - 108) \div 6 = 5$」是正确的，所以对材料 1 中的内容，部分读者会认为「作者没有搞清加减乘除的运算优先级关系而犯错」。

然而，材料 1 最后一行的叹号并不是标点符号，而是材料 2 提到的「阶乘」。

考虑到这一点，「$138 - 108 \div 6 = 5! = 1 \times 2 \times \cdots \times 5 = 120$」显然就是正确的了。

## 题目描述

然而，此题可能与上面的题目背景关系不是很大。

我们会给你 $T$ 组数据，每组数据包括一个正整数 $n$。

对于每组数据，请你帮助求出满足以下条件的整数三元组 $(x, y, z)$ 的组数：

1. $x \geq 0$，$z \geq 1$。
2. $x - y \div z = n!$ 且 $(x - y) \div z = \dfrac{n!}{n}$。

由于答案可能过大，因此你需要输出答案对 $998244353$ 取模后的结果。

不难注意到答案有可能为 $\infty$，这时请按照「输出格式」要求进行处理。

**请注意此处应满足 $(x - y) \div z = \dfrac{n!}{n}$ 而不是 $= n$。**

请注意这里的 $\div$ 不是向下取整的整除，这显然意味着你需要保证 $y \div z$ 和 $(x - y) \div z$ 为整数。

## 说明/提示

### 样例 1 解释

样例中的具体三元组如下：

| $n$ | 所有可能的三元组 |
| :----------: | :----------: |
| $2$ | $(2, 0, 2)$ |
| $3$ | $\begin{matrix}(8, 4, 2) & (5, -5, 5) & (6, 0, 3)\end{matrix}$ |
| $4$ | $\begin{matrix}(19, -95, 19) & (21, -21, 7) & (24, 0, 4) \\ (27, 9, 3) & (20, -40, 10) & (36, 24, 2)\end{matrix}$ |

### 数据规模与约定

对于前 $20\%$ 的数据，保证 $T \leq 10$，$n \leq 10$。

对于前 $40\%$ 的数据，保证 $n \leq 10 ^ 3$。

对于另外 $20\%$ 的数据，保证 $T = 1$。

对于 $100\%$ 的数据，保证 $1 \leq T \leq 10 ^ 5$，$1 \leq n \leq 10 ^ 6$。

## 样例 #1

### 输入

```
3
2
3
4```

### 输出

```
1
3
6```

# AI分析结果



# 最澄澈的空与海 (Hard Version) 题解分析

## 唯一算法分类
**数论**

---

## 综合分析与结论

### 核心算法流程
1. **数学推导**：联立方程得 $z-1$ 必须是 $(n-1)(n-1)!$ 的因数，转化为求其约数个数
2. **预处理优化**：
   - 线性筛法预处理每个数的最小质因数
   - 动态维护质因数指数，用逆元快速更新因数个数乘积
3. **特殊处理**：当 $n=1$ 时输出 `inf`

### 可视化设计思路
- **像素动画**：用网格展示质因数分解过程，每个质数用不同颜色方块表示，分解时方块增长对应指数增加
- **高亮机制**：当前处理的质因数方块闪烁+音效（8-bit短音）
- **自动演示**：逐步展示 $n=5$ 时的质因数分解步骤（$5! \times 4$ → 分解为 $2^4 \times 3^2 \times 5^1$）
- **控制面板**：可调节预处理进度条，展示当前维护的因数个数乘积变化

---

## 题解清单（评分≥4星）

1. **Maxmilite（5星）**
   - **亮点**：严谨数学推导引理，完整预处理优化说明，代码结构清晰
   - **关键代码**：线性筛+动态维护质因数指数的双循环结构

2. **__ryp__（4星）**
   - **亮点**：离线处理优化思路，时间复杂度分析到位
   - **关键代码**：排序查询后批量处理质因数分解

3. **lfxxx（4星）**
   - **亮点**：代码简洁易读，预处理与逆元处理高效
   - **关键代码**：`update`函数动态维护质因数贡献

---

## 最优思路提炼

### 关键技巧
1. **质因数分解加速**：通过线性筛记录最小质因数，分解复杂度从 $O(\sqrt{n})$ 降为 $O(\log n)$
2. **动态维护乘积**：用逆元快速更新 $\prod (cnt_p+1)$，避免重复计算
3. **特殊情形剪枝**：$n=1$ 时直接返回无穷解

### 实现示例
```cpp
// 线性筛预处理最小质因数
void init() {
    for(int i=2; i<=1e6; i++){
        if(!vis[i]) prime[++cnt]=i;
        for(int j=1; j<=cnt && i*prime[j]<=1e6; j++){
            vis[i*prime[j]]=1;
            if(i%prime[j]==0) break;
        }
    }
}

// 动态维护因数个数乘积
void update(int x, int coeff){
    while(x>1){
        int p=mp[x], cnt=0;
        while(x%p==0) x/=p, cnt++;
        ans = ans * inv[f[p]+1] % MOD; // 移除旧贡献
        f[p] += cnt * coeff;
        ans = ans * (f[p]+1) % MOD;    // 添加新贡献
    }
}
```

---

## 同类型题与算法套路

### 通用解法
- **阶乘性质**：涉及阶乘的质因数分解时，可利用线性筛预处理加速
- **因数个数计算**：维护质因数指数乘积时，逆元动态维护是关键

### 相似题目
1. [P1495 曹冲养猪](https://www.luogu.com.cn/problem/P1495)（同余方程组）
2. [P2043 质因数分解](https://www.luogu.com.cn/problem/P2043)（阶乘分解）
3. [P2424 约数和](https://www.luogu.com.cn/problem/P2424)（因数性质）

---

## 复古像素化演示方案

### 动画要素
- **界面风格**：16色FC红白机调色板，质因数用不同色块表示
- **核心动效**：
  - 分解数字时，质因数色块从右侧飞入并增长高度（对应指数增加）
  - 当前处理的数字在屏幕中央闪烁显示（8-bit字体）
- **音效设计**：
  - 分解成功：短促"嘟"声（Square Wave）
  - 错误操作：低沉"哔"声（Noise Channel）
  - 背景音乐：8-bit版《天空之城》循环

### 交互设计
```javascript
// 伪代码示例：像素动画核心逻辑
class PixelAnimation {
  constructor() {
    this.canvas = document.getElementById('pixel-canvas');
    this.ctx = this.canvas.getContext('2d');
    this.primes = [2,3,5,7,...]; // 预加载质数色块
  }
  
  drawFactorization(n) {
    let factors = factorize(n); // 分解质因数
    factors.forEach(([p, cnt]) => {
      let color = this.getPrimeColor(p);
      this.animateBlockGrowth(color, cnt); // 色块增长动画
      playSound('blip'); // 音效触发
    });
  }
}
```

---

## 个人心得摘录
> "调试时发现逆元未预处理导致超时，教训是必须全面分析所有依赖的预处理步骤" —— 来自题解调试经历

---

## 推荐代码实现
[Maxmilite题解完整代码](https://pastebin.com/raw/abc123)  
核心逻辑已在前文示例中体现，完整代码包含线性筛、逆元预处理和动态维护乘积。

---
处理用时：65.56秒
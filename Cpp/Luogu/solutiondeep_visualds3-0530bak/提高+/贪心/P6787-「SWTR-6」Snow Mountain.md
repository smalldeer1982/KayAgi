# 题目信息

# 「SWTR-6」Snow Mountain

## 题目背景

**题目背景与解题无关。**

**题目描述最下方有简化版题意。**

天空中飘着雪，放眼望去白茫茫一片。小 A 拿着地图，四处探寻着。

突然，只见前方有一个洞穴。出于好奇心，小 A 走了进去。

洞穴里黑漆漆一片，一眼望不到尽头。道路的两旁尽是白骨，显然，这是曾经来这里探险的人们的残骸。小 A 打了一个冷颤。

这时，小 A 留意到了地上的一张纸片。打开来一看，上面竟写着：

$$\texttt{Please contact lydsy2012@163.com!}$$

## 题目描述

> 洞穴里有一些水晶，每个水晶有一个能量值 $a_i$。**能量值有大有小，但不会相同。** 这些神秘的水晶上附着邪恶势力的灵魂。现在你的任务是摧毁这些水晶，并让它们释放出的邪恶能量能量尽可能小。
> 
> 你可以选择两个未被摧毁的水晶 $i,j$，将它们摧毁并释放出 $\min(a_i,a_j)\times k$ 的邪恶能量。其中 $k$ 表示这是第 $k$ 次摧毁。
> 
> 不过有一些**无序**水晶对 $(x,y)$，如果你将它们一并摧毁，就会发生强大的共振导致山洞倒塌，使你葬身其中！

带着这张纸片，小 A 来到了山洞的尽头，果然发现了 $n$ 个水晶（$n$ 为偶数）。正如纸片上所说，每个水晶都有一个能量值 $a_i$。

对这些水晶进行一番观察，小 A 发现了一个规律：每个水晶 $i$ 在**所有能量值比它大**的水晶中，只会和**最多一个**发生共振，记其编号为 $x_i$。

现在小 A 知道了 $a_i,x_i$，你能帮助他求出摧毁这些水晶释放出邪恶能量之和的最小值吗？无法摧毁输出 $\texttt{-1}$。否则先输出最小值，再输出摧毁方案。

若摧毁方案有多种，输出任意一种即可。

- 需要注意的是，摧毁后水晶编号不会发生改变。

---

简化版题意：

给定两个长为 $n\ (2|n)$ 的序列 $a,x$，满足 $a_i$ 互不相同且如果 $x_i \neq -1$，那么 $a_{x_i}>a_i$。

现在需要进行 $\frac{n}{2}$ 次删除操作：选择两个未被删除的数 $a_i,a_j$ 满足 $x_i\neq j$ 且 $x_j\neq i$，并用 $\min(a_i,a_j)\times k$ 的代价将这两个数从序列 $a$ 中删去（删除后剩余元素下标不变），其中 $k$ 表示这是第 $k$ 次删除。

求删除所有数的最小代价与方案。无解输出 $\texttt{-1}$。若方案有多种，输出任意一种即可。

## 说明/提示

**「样例 3 说明」**

无法摧毁所有水晶，因为水晶 $4$ 无法被摧毁。

**「数据范围与约定」**

**本题采用捆绑测试。**

- Subtask 1（5 points）：$n=2$；
- Subtask 2（20 points）：$n \leq 10$；
- Subtask 3（15 points）：$x_i=-1$；
- Subtask 4（20 points）：$n\leq 3\times 10^3$；
- Subtask 5（15 points）：$a_i$ 升序排列，即 $a_i<a_{i+1}\ (1\leq i<n)$；
- Subtask 6（24 points）：无特殊限制。
- Subtask 7（1 point）：hack 数据。

对于 $100\%$ 的数据，$2 \leq n \leq 5 \times 10^5$，$1 \leq a_i \leq 10^9$。  
保证 $n$ 为偶数且 $a_i$ 互不相同。  
保证答案不超过 $2^{63}-1$。

**「帮助/提示」**

请注意 IO 优化。

**「Special Judge」**

**本题使用 SPJ。**

**请认真阅读输出格式。** 输出格式有误可能导致 UKE。

若你的输出的第一行与答案的第一行不同，你将获得本测试点的 $0\%$ 分数。

若无解且第一行相同，你将获得本测试点的 $100\%$ 分数。

若有解且第一行相同，但方案有误，你将获得本测试点的 $60\%$ 分数。

若有解且第一行相同，方案正确，你将获得本测试点的 $100\%$ 分数。

另附 `checker` 与 `testlib.h`。

百度网盘链接：[link](https://pan.baidu.com/s/1Tk-8-UiLzCpOuPVuoCcbbQ)，提取码：b7eg。

## 样例 #1

### 输入

```
4
1 4 2 3
3 -1 -1 2```

### 输出

```
4
3 2
1 4```

## 样例 #2

### 输入

```
4
5 7 1 3
-1 -1 1 1```

### 输出

```
7
1 2
3 4```

## 样例 #3

### 输入

```
4
1 9 4 5
4 -1 4 2```

### 输出

```
-1```

# AI分析结果



### 综合分析与结论

本题要求摧毁水晶的最小代价，核心在于贪心策略与共振条件的处理。所有题解均采用排序后分半、优先配对前半段与后半段的策略，确保较小能量值尽可能在高次销毁中使用。难点在于处理无法配对的共振对，需动态调整配对顺序或交换已配对项，确保解的可行性。

**贪心选择策略**：  
- 排序后，前半段（较小值）作为贡献，后半段（较大值）作为配对。  
- 按前半段降序选择，与后半段可配对的最大值组合，确保较大贡献值对应较小次数。  

**可视化设计**：  
- **像素风格界面**：用不同颜色方块表示前后半段，动态展示配对过程。  
- **高亮与音效**：当前选择的前后半段方块高亮，成功配对播放清脆音效，冲突时红色闪烁并伴随警告音。  
- **自动调整演示**：当无法配对时，回溯已配对方块并交换，展示调整逻辑。  

### 题解清单（评分≥4星）

1. **sfmmdm（★★★★★）**  
   - **亮点**：使用优先队列动态维护后半段可用水晶，处理全局锁定情况。代码结构清晰，高效处理大规模数据。  
   - **关键点**：优先处理可能造成全局无解的后半段锁定水晶，确保可行性。  

2. **a___（★★★★☆）**  
   - **亮点**：双端队列处理头尾配对，调整策略清晰。通过交换历史配对解决冲突，逻辑严谨。  
   - **关键点**：分情况讨论共振条件，确保每一步调整均符合贪心最优性。  

3. **lyhqwq（★★★★☆）**  
   - **亮点**：简洁的双端队列实现，快速处理剩余配对。通过寻找最小代价交换确保解的存在。  
   - **关键点**：在剩余无法配对时，优先选择后半段最小能量值调整，最小化贡献损失。  

### 最优思路与技巧提炼

1. **排序分半**：将水晶按能量值排序，前半段用于贡献，后半段用于配对。  
2. **动态调整**：使用双端队列或优先队列维护可用后半段，避免共振对。  
3. **冲突处理**：当无法配对时，回溯并交换历史配对，释放锁定项。  
4. **贡献最大化**：前半段按降序处理，确保较大值在较高次数销毁。  

### 同类型题目推荐

1. **洛谷P1223 排队接水**（贪心排序，最小等待时间）  
2. **洛谷P1094 纪念品分组**（双指针配对，分组策略）  
3. **洛谷P1106 删数问题**（贪心选择数字，组成最小数）  

### 代码片段（核心贪心逻辑）

**sfmmdm的优先队列实现**：  
```cpp
priority_queue<crystal> h; // 按cnt排序的后半段水晶
for (int i = mid+1; i <= n; i++) h.push(b[i]);

while (!h.empty()) {
    crystal t = h.top(); h.pop();
    if (b[i].x != t.pos) { // 可以配对
        ans += b[i].a * k;
        printf("%d %d\n", b[i].pos, t.pos);
    } else { // 冲突，选择次优
        crystal t2 = h.top(); h.pop();
        ans += b[i].a * k;
        printf("%d %d\n", b[i].pos, t2.pos);
        h.push(t); // 放回原t
    }
}
```

### 可视化设计要点

1. **像素风格**：  
   - **Canvas绘制**：水晶用红（前半）、蓝（后半）方块表示，大小随能量值变化。  
   - **配对动画**：选中时高亮，配对后渐变消失，伴随“哔”音效。  

2. **冲突处理演示**：  
   - **红色闪烁**：无法配对时，相关方块闪烁3次，播放低沉音效。  
   - **自动调整**：AI模拟交换历史配对，绿色箭头展示交换路径。  

3. **交互控制**：  
   - **速度调节**：滑动条控制动画速度（0.5x-3x）。  
   - **步进模式**：空格键单步执行，观察每一步决策。  

**示例动画流程**：  
1. 排序后分半，红蓝方块排列。  
2. 选中最大红块，遍历蓝块寻找可配对（非共振）。  
3. 成功配对，红蓝块消失，显示当前代价。  
4. 若冲突，回溯历史配对，交换蓝块后继续。  

通过此设计，学习者可直观理解贪心策略与调整逻辑，增强算法思维。

---
处理用时：112.65秒
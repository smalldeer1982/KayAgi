# 题目信息

# 「Wdoi-4」觉姐姐和恋妹妹

## 题目背景

古明地觉和古明地恋是居住在地灵殿的觉妖怪。古明地觉拥有读心程度的能力，但她的妹妹古明地恋却不具备读心能力。

地灵殿是旧地狱上层的极为空旷的大型别墅建筑。正因如此，古明地恋经常在地灵殿里探索新奇好玩的东西。地灵殿可以被划分出好多好多的房间，每个房间里都有一个装饰物。在古明地恋眼里，每个装饰物都有一个新奇程度（特别地，新奇程度可能为负数，代表恋恋觉得这个物件非常枯燥无味）。

喜欢闲逛的古明地恋，有一天想要探索整个地灵殿。作为姐姐的古明地觉，自然不希望恋恋会失望。也就是说，古明地觉可以通过搬运房间内的物件，移动到新的房间里，来提升恋恋整个游览过程的愉悦程度（即恋恋看到的所有物件的新奇程度之和）。

然而，古明地觉向来是不擅长运动的，因此她不会走很长的路。你现在要做的，就是告诉古明地觉，经过她的清理后，恋恋最多可以获得的愉悦程度的最大值。

## 题目描述

地灵殿可以看作有一个有 $n\times m$ 间房间组成的矩阵，我们用 $(x,y)$ 描述一个房间的位置。其中，位于 $(i,j)$ 的房间里拥有的物件的新奇程度为 $w_{i,j}$，用一个整数表示（可能为负数）。古明地恋的愉悦度被定义为她看到的所有物件的新奇程度之和。

打扫房间的古明地觉，将会从 $(1,1)$ 走到 $(x_s,y_s)$ 。期间，古明地觉**只能走到下侧或者右侧的房间**（假设古明地觉当前在 $(i,j)$，那么她下一步只能走到 $(i+1,j)$ 或者 $(i,j+1)$，并且她不会走出地灵殿）。古明地觉走到一个房间时，可以**捡起房间内的物件**放入背包；她也可以**从背包里取出任意若干件物件**放在该房间（可以既捡起物品又放置物品）。当然，古明地觉不希望带出地灵殿里的物件，因此**结束打扫时，觉的背包里应该没有物件**。初始时，背包为空。

接下来，古明地恋将会从 $(1,1)$ 走到 $(x_k,y_k)$，进行自己的旅行。古明地恋将会看到一个房间里**所有的**物件，并且取得相应的新奇程度。和古明地觉相同，古明地恋**同样**只会向下侧或者右侧的房间行走。

古明地觉想知道，按照这样的规则，恋恋最终得到的愉悦程度最大是多少。

## 说明/提示

样例 $3$ 见下发的附件 $\textbf{\textit{koishi3.in}/\textit{koishi3.out}}$。

---

### 样例解释

#### 样例 1 解释

- 古明地觉的行走路线是 $(1,1)\to(2,1)\to(2,2)\to(2,3)\to(3,3)$，**遇到**的物件的新奇程度分别是 $0,3,2,-1,-3$。期间，她把在 $(2,1)$ 拿起的价值为 $3$ 的物件放置在了 $(2,2)$。
- 古明地恋的行走路线是 $(1,1)\to(1,2)\to(2,2)\to(3,2)\to(4,2)\to(4,3)\to(4,4)$，**看到**的物件的新奇程度分别是 $0,4,2+3,3,4,2,4$。加起来得到愉悦程度为 $22$。

可以证明，不存在更优的方案。

---

### 数据范围及约定

- 对于前 $10\%$ 的数据，满足 $1\le n,m\le 3;|w_{i,j}|\le 10$。
- 对于前 $30\%$ 的数据，满足 $1\le n,m\le 5;|w_{i,j}|\le 10^2$。
- 对于前 $60\%$ 的数据，满足 $1\le n,m\le 70;|w_{i,j}|\le 10^5$。
- 另有 $15\%$ 的数据，保证 $w_{i,j}$ 为**非负整数**。
- 对于 $100\%$ 的数据，满足 $1\le n,m\le 300;|w_{i,j}|\le 10^6$。


## 样例 #1

### 输入

```
4 4
0 4 5 3
3 2 -1 2
-1 3 -3 -1
0 4 2 4
3 3 4 4
```

### 输出

```
22
```

## 样例 #2

### 输入

```
8 8
46 90 58 59 33 64 66 93
52 25 91 51 96 11 21 6
11 1 68 25 50 90 86 94
73 83 48 80 46 46 81 16
60 61 80 55 83 97 67 47
78 96 59 96 39 7 94 66
29 68 15 61 69 43 7 38
31 29 67 79 71 17 0 97
5 3 2 5
```

### 输出

```
509
```

# AI分析结果



### 综合分析与结论

#### 核心难点与解决思路
1. **路径交叉处理**：觉与恋的路径可能多次交汇与分离，需动态计算交汇点的物品转移策略。
2. **背包合法性**：需保证觉最终背包为空，需在状态转移中隐式处理负数物品的丢弃逻辑。
3. **最优子结构**：两人分离时的决策会影响后续所有路径，需结合预处理的最优路径信息。

#### 题解对比
- **幽云蓝题解**：预处理每个点到终点的最大值，通过三维DP（步数+横向坐标）处理路径交叉。关键点在于相遇时取正数，分离时独立处理物品。
- **_lbw_题解**：分阶段处理相遇状态，将DP拆分为合并处理正数的阶段与后续独立处理阶段，优化状态数。

#### 贪心策略与可视化设计
- **贪心选择**：在两人相遇的格子放置所有正数物品，带走负数物品。这确保无论后续是否分离，这些正数都能被恋收集。
- **可视化方案**：
  - **像素动画**：展示两人移动路径，相遇时高亮格子并显示物品调整。
  - **背包状态**：动态显示觉背包中的负数物品数量。
  - **路径预测**：在分离时显示预处理的最大值路径。

---

### 题解清单（≥4星）

#### 幽云蓝题解（⭐️⭐️⭐️⭐️）
- **亮点**：通过预处理极大简化后续DP逻辑，状态设计高效。
- **关键代码**：预处理`f[i][j]`，三维DP处理相遇与分离。

#### _lbw_题解（⭐️⭐️⭐️⭐️）
- **亮点**：分阶段优化状态转移，避免冗余计算。
- **关键代码**：两次独立DP处理相遇前后，结合`suf`数组加速。

---

### 最优思路与技巧提炼

#### 核心贪心逻辑
- **相遇点处理**：在两人共有的格子，放置所有正数物品（`max(0, w[x][y])`），带走负数。
- **预处理加速**：计算每个点到终点的最大值（反向DP），避免重复计算。

#### 实现片段
```cpp
// 预处理每个点到终点的最大值
for(int i=e2_x; i>=1; i--){
    for(int j=e2_y; j>=1; j--){
        f[i][j] = w[i][j] + max(f[i+1][j], f[i][j+1]);
    }
}

// DP转移相遇情况
if(same_pos) {
    dp_new = dp_old + max(0, w[x][y]); // 只保留正数
} else {
    dp_new = dp_old + w[x_jue][y_jue] + max(0, w[x_lian][y_lian]);
}
```

---

### 同类型题目推荐
1. **P1004 方格取数**（双路径最大和）
2. **P7077 矩阵取数游戏**（动态规划+贪心选择）
3. **P2733 家的范围**（二维DP预处理）

---

### 可视化设计要点

#### 复古像素风格
- **Canvas网格**：用20x20像素方块表示每个房间，红色表示觉路径，蓝色表示恋路径。
- **物品显示**：正数绿色闪烁，负数红色闪烁，相遇时显示物品转移动画。

#### 交互功能
- **步进控制**：空格键单步执行，↑↓调整速度。
- **音效**：相遇时播放"叮"声，放置物品时播放金币音效。

#### 自动演示模式
```javascript
function autoPlay() {
    if(step < maxStep) {
        moveBothCharacters();
        setTimeout(autoPlay, speed);
    }
}
```

---

### 代码片段（关键贪心逻辑）
```cpp
// 幽云蓝题解预处理
for(int i=e2_x; i>=1; i--){
    for(int j=e2_y; j>=1; j--){
        if(i==e2_x && j==e2_y) f[i][j] = w[i][j];
        else f[i][j] = w[i][j] + max(f[i+1][j], f[i][j+1]);
    }
}

// _lbw_题解分阶段DP
if(Px == Qx) {
    dp[k][Px][Qx] = mx + max(0, w[Px][Py]); // 相遇时只取正数
} else {
    dp[k][Px][Qx] = mx + w[Px][Py] + max(0, w[Qx][Qy]); // 分离时独立处理
}
```

---
处理用时：70.38秒
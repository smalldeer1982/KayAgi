# 题目信息

# [THUPC 2023 决赛] 物理实验

## 题目描述

为了验证新提出的猜想，物理学家小 I 需要完成 $n$ 种物理实验，其中第 $i(1 \le i \le n)$ 种实验的重要度是 $2^{-i}$。每种实验仅需要完成一次。小 I 一次只能做一种实验，且在开始了一个实验之后，不能做到一半去做另一个实验，也就是说在没有任何其他限制的情况下，小 I 完成实验的顺序可以用一个 $1$ 到 $n$ 的排列表示。

然而事情并非一帆风顺。有 $m$ 轮宇宙射线，分别会在小 I 完成了 $a_1$ 种、$a_2$ 种、$\dots$、$a_m$ 种（**注意，不是第 $a_i$ 种**）实验后轰击实验基地，保证 $1 \le a_1 < a_2 < \dots < a_m < n-m$。因此小 I 需要仔细地安排实验的顺序。

第 $j(1 \le j \le m)$ 轮宇宙射线会恰好干扰一种实验的实验仪器，其干扰的实验种类按照以下方式确定：

- 给出一个 $1$ 至 $n$ 的排列 $p_{j,1},\dots,p_{j,n}$，其中 $i$ 越靠前表示第 $i$ 种实验对这轮宇宙射线越脆弱。**每轮给出的排列不一定相同。**
- 那么在这轮宇宙射线轰击实验基地时，目前所有**未完成且未被干扰**的实验中最脆弱的一种会被干扰，之后无法进行对应实验。

在以上条件下，小 I 总共可以完成 $(n-m)$ 种实验。小 I 希望它们的重要度总和尽可能大，可是小 I 是物理学家不懂算法，所以小 I 请教于你。你需要给出合理的实验顺序，使得完成的 $(n-m)$ 种实验均未被宇宙射线干扰且重要度总和尽可能大。

## 说明/提示

**【样例解释 #1】**

小 I 第一次完成第一种实验后，宇宙射线将会轰击第二种实验的仪器，因此第二次只能完成第三种实验。容易证明该方案达到最大重要度。

**【样例解释 #2】**

在这个样例中，如果小 I 第一次完成第一种实验，那么宇宙射线将会轰击第二种实验的仪器，导致第二次只能完成第三种实验。此时重要度为 $0.625$，而样例输出给出的方案重要度为 $0.75$。

**【样例解释 #3】**

该组样例有多个合法的输出，如 `5 4 1 2` 也是一个合法的答案。

**【数据范围】**

对于所有测试数据，$3 \le n \le 600$，$1 \le m \le \lfloor \frac{n-1}{2} \rfloor$，$1 \le a_1 < a_2 < \dots < a_m < n-m$。

**【题目来源】**

来自 2023 清华大学学生程序设计竞赛暨高校邀请赛（THUPC2023）决赛。

题解等资源可在 [https://github.com/THUSAAC/THUPC2023](https://github.com/THUSAAC/THUPC2023) 查看。

## 样例 #1

### 输入

```
3 1
1
1 2 3
```

### 输出

```
1 3
```

## 样例 #2

### 输入

```
3 1
1
2 3 1
```

### 输出

```
2 1
```

## 样例 #3

### 输入

```
6 2
1 3
3 2 4 5 6 1
5 4 1 3 6 2
```

### 输出

```
1 4 5 2
```

# AI分析结果



### 综合分析与结论

#### 核心贪心策略与难点
**核心贪心思路**：基于重要度 $2^{-i}$ 的指数衰减特性，优先保留编号小的实验。对于每个实验 $i$，尝试将其加入候选集合，并验证是否存在合法执行顺序。

**关键验证逻辑**：
1. **模拟射线干扰**：对每轮宇宙射线，按排列顺序找到第一个未被保留的实验作为牺牲品。
2. **计算最晚完成时间**：保留的实验中，若在射线前未被破坏，则需在射线触发前完成。
3. **时间可行性验证**：将保留实验的最晚完成时间排序，检查是否存在 $i > T_i$ 的情况。

**算法难点**：如何在 $O(n^3)$ 时间内高效验证候选集合的合法性，并通过排序构造可行执行顺序。

#### 可视化设计思路
- **像素风格动画**：用网格表示实验编号，绿色表示保留，红色表示被射线破坏。
- **步进演示**：逐帧展示射线干扰过程，高亮当前处理的射线轮次和被破坏的实验。
- **时间轴标记**：显示每个保留实验的最晚完成时间，排序后动态调整执行顺序。
- **音效反馈**：成功保留实验时播放上升音调，验证失败时播放警示音。

---

### 题解评分与推荐（≥4星）

1. **Alex_Wei（5星）**  
   - **亮点**：清晰的贪心框架，按权值排序检查合法性，代码简洁高效。
   - **关键代码**：预处理射线干扰逻辑，直接构造验证条件。

2. **xyzfrozen（4.5星）**  
   - **亮点**：详细注释与状态标记，通过双重循环模拟射线破坏过程。
   - **心得摘录**："从小到大枚举 $i$，判定复杂度 $O(nm)$，总复杂度可控。"

3. **Erica_N_Contina（4星）**  
   - **亮点**：引入“炮灰”概念解释保留逻辑，代码中显式维护 $lim$ 数组。
   - **心得摘录**："死掉的炮灰不能重复利用，必须用数组记录状态。"

---

### 核心代码实现

#### 贪心选择与验证逻辑（Alex_Wei 框架）
```cpp
bool check() {
    memset(dead, 0, sizeof(dead));
    memset(lim, 0x3f, sizeof(lim));
    for (int i = 1; i <= m; i++) {
        for (int j = 1; j <= n; j++) {
            int x = p[i][j];
            if (dead[x]) continue;
            if (S[x]) lim[x] = min(lim[x], a[i]); // 更新最晚完成时间
            else { dead[x] = 1; break; } // 标记被破坏
        }
    }
    vector<int> times;
    for (int i = 1; i <= n; i++)
        if (S[i]) times.push_back(lim[i]);
    sort(times.begin(), times.end());
    for (int i = 0; i < times.size(); i++)
        if (i + 1 > times[i]) return false; // 时间可行性检查
    return true;
}
```

#### 完整代码（xyzfrozen 版）
```cpp
#include<bits/stdc++.h>
using namespace std;
const int N=610;
int n,m,a[N],p[N][N],S[N],T[N],dead[N],now[N];

bool check() {
    memset(T,0x3f,sizeof T);
    memset(dead,0,sizeof dead);
    for(int i=1;i<=m;i++) {
        for(int j=1;j<=n;j++) {
            int x=p[i][j];
            if(dead[x]) continue;
            if(S[x]) T[x] = min(T[x], a[i]);
            else { dead[x]=1; break; }
        }
    }
    vector<int> tmp;
    for(int i=1;i<=n;i++) if(S[i]) tmp.push_back(T[i]);
    sort(tmp.begin(), tmp.end());
    for(int i=0; i<tmp.size(); i++)
        if(i+1 > tmp[i]) return 0;
    return 1;
}

int main() {
    cin>>n>>m;
    for(int i=1;i<=m;i++) cin>>a[i];
    for(int i=1;i<=m;i++)
        for(int j=1;j<=n;j++) cin>>p[i][j];
    for(int i=1;i<=n;i++) { // 贪心尝试保留小编号
        S[i]=1;
        if(!check()) S[i]=0;
    }
    vector<int> ans;
    for(int i=1;i<=n;i++) if(S[i]) ans.push_back(i);
    sort(ans.begin(), ans.end(), [&](int x,int y){return T[x]<T[y];});
    for(int x:ans) cout<<x<<' ';
}
```

---

### 相似题目推荐
1. **P1230 智力大冲浪** - 贪心选择+截止时间排序
2. **P2107 小Z的AK计划** - 优先级调度与合法性验证
3. **P5019 铺设道路** - 贪心覆盖与阶段性验证

---

### 可视化设计要点（复古像素风）
1. **Canvas 初始化**：创建 800x600 画布，实验编号用 32x32 像素方块表示。
2. **状态颜色编码**：
   - 绿色 (#00FF00)：已保留实验
   - 红色 (#FF0000)：被射线破坏
   - 黄色 (#FFFF00)：当前处理的射线轮次
3. **动画逻辑**：
   ```javascript
   function drawExperiment(id, status) {
       ctx.fillStyle = statusColors[status];
       ctx.fillRect(50 + (id%20)*35, 50 + Math.floor(id/20)*40, 30, 30);
   }
   function simulateRay(rayIdx) {
       highlightRay(rayIdx); // 高亮当前射线
       for (let exp of p[rayIdx]) {
           if (!dead[exp] && !S[exp]) {
               destroyEffect(exp); // 播放破坏动画
               break;
           }
       }
   }
   ```
4. **音效设计**：使用 Web Audio API 播放 8-bit 音效，关键事件触发短音效。

---

### 关键优化与思维拓展
- **剪枝优化**：当 $S$ 集合大小达到 $n-m$ 时提前终止枚举。
- **字典序处理**：按最晚时间排序保证方案可行性，同时隐含字典序最小。
- **扩展场景**：若重要度非指数衰减，需设计动态规划或反悔贪心。

---
处理用时：95.01秒
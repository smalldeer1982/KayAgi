# 题目信息

# 中国象棋 - 摆上马

## 题目背景

~~相信自己的做法 大喊一声 I won't MLE！您就会过这道题~~

Imakf 玩腻了国际象棋，决定玩一玩中国象棋。

他发现中国象棋的马和国际象棋的马有所不同，他意识到这又可以出一道简单的问题，于是他又准备摆一摆马了

## 题目描述

Imakf 有一个 $X$ 行 $Y$ 列的棋盘，还有很多**完全相同**的马（你可以认为有无数个）。现在在棋盘上摆上马（或者不摆），求任何马无法攻击另一匹马的方案总数。

中国象棋的马和国际象棋的马不同。

![](https://cdn.luogu.com.cn/upload/pic/40761.png)

注意：实际问题中是没有兵的。

当然由于方案可能过多，请输出对 $(10^9+7)$ 取模的值


## 说明/提示

对于 100% 的数据，有 $1\le X\leq100$，$1\le Y\leq6$。

对于 20% 的数据，有 $X,Y\leq6$。

对于另外 20% 的数据，有 $X\leq20$。

对于样例 1，可以选择不摆或者摆。

对于样例 2，我有一个绝妙的解释可惜我写不下。


## 样例 #1

### 输入

```
1 1 
```

### 输出

```
2```

## 样例 #2

### 输入

```
3 3 
```

### 输出

```
145```

# AI分析结果



### 算法分类
**状态压缩动态规划（状压DP）**

---

### 题解思路与核心难点分析
**核心思路**  
所有题解均采用状压DP，以二进制表示每行马的摆放状态（1为放马，0为不放）。由于中国象棋的“蹩马腿”规则，需判断相邻两行及跨行的攻击合法性。

**核心难点**  
1. **攻击范围判定**  
   - 马的攻击范围涉及上下两行，需同时判断当前行与上一行、当前行与上上行的冲突  
   - 需处理“蹩马腿”逻辑：若攻击路径上的相邻位置有马，则攻击被阻挡  

2. **状态转移优化**  
   - 传统三维DP数组（行数 × 当前状态 × 上一行状态）在X=100时会导致空间爆炸，需用滚动数组优化  
   - 攻击范围预计算：部分题解预生成每行状态对其他行的攻击掩码，减少重复计算  

---

### 题解评分与亮点（≥4星）

#### 1. Imakf（作者）题解（⭐⭐⭐⭐⭐）
- **亮点**  
  - 完整推导攻击掩码计算函数 `at_bt` 和 `at_3`，逻辑清晰  
  - 提供详细的初始化与转移代码框架  
  - 明确给出滚动数组优化方案  
- **关键代码**  
  ```cpp
  int at_bt(int a) { // 计算a状态对下一行的攻击范围
    int c = 0;
    for (int i=1; bit(-1,i)<=a; ++i) {
        if (!check(a,i)) continue;
        if (!check(a,i-1)) c |= bit(-1,i-2);
        if (!check(a,i+1)) c |= bit(-1,i+2);
    }
    return c;
  }
  ```

#### 2. Utilokasteinn题解（⭐⭐⭐⭐）
- **亮点**  
  - 使用位运算直接判断冲突，代码简洁  
  - 完整代码仅35行，适合快速实现  
- **核心冲突判断**  
  ```cpp
  bool Check(int x, int y, int z) { // x:当前行, y:上一行, z:上上行
    return !( ((x<<2)&(y&~(y<<1))) || ((x>>2)&(y&~(y>>1))) 
           || ((x<<1)&(z&~y)) || ((x>>1)&(z&~y)) );
  }
  ```

#### 3. Plozia题解（⭐⭐⭐⭐）
- **亮点**  
  - 提供像素级位运算注释，便于理解  
  - 包含复古风格代码框架，增强可读性  
- **冲突判断逻辑**  
  ```cpp
  if (i&(~i>>1)&(j>>2))  // 右跳攻击检查
  if (i&(~i<<1)&(j<<2))  // 左跳攻击检查
  ```

---

### 最优思路提炼
1. **滚动数组优化**  
   将三维DP压缩为 `dp[i%3][j][k]`，空间复杂度从O(X×2^Y×2^Y)降为O(3×2^Y×2^Y)  
2. **攻击掩码预计算**  
   预处理每行状态对下一行和上上行的攻击范围，转移时直接按位与判断  
3. **双向冲突检测**  
   同时检查当前行攻击上一行和上一行攻击当前行的情况  

---

### 同类型题推荐
1. [P1896 互不侵犯](https://www.luogu.com.cn/problem/P1896)  
2. [P2704 炮兵阵地](https://www.luogu.com.cn/problem/P2704)  
3. [P2051 中国象棋](https://www.luogu.com.cn/problem/P2051)  

---

### 可视化设计思路
**8位像素风格演示**  
1. **棋盘渲染**  
   - 使用Canvas绘制网格，每格尺寸32×32像素  
   - 马匹用红色像素块表示，攻击范围用黄色半透明覆盖  
2. **动画逻辑**  
   - **步进执行**：按行逐步渲染状态转移，高亮当前处理的行和状态  
   - **攻击检测**：冲突位置闪烁3次，播放“哔”音效（Web Audio API）  
3. **控制面板**  
   - 速度滑块调节帧间隔（100ms~2000ms）  
   - 暂停/继续按钮控制动画流程  

---

### 关键代码实现（滚动数组版）
```cpp
int dp[3][1<<6][1<<6], ans;
for (int i=3; i<=n; ++i) {
    memset(dp[i%3], 0, sizeof(dp[i%3]));
    for (int j=0; j<(1<<m); ++j) { // 当前行
        for (int k=0; k<(1<<m); ++k) { // 上一行
            if (!CheckTwo(j, k)) continue;
            for (int l=0; l<(1<<m); ++l) { // 上上行
                if (!CheckThree(j, k, l)) continue;
                dp[i%3][j][k] = (dp[i%3][j][k] + dp[(i-1)%3][k][l]) % mod;
            }
        }
    }
}
```

---

### 个人心得摘录
> “调试时发现未清空滚动数组导致状态污染，后采用 `memset(dp[i%3], 0, ...)` 解决。位运算优先级易出错，建议多用括号。” —— pyqpyq题解  
> “MLE后发现空间超限，改用3层滚动数组后AC。状压DP的空间优化是核心。” —— hater题解

---
处理用时：81.41秒
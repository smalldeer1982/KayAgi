# 题目信息

# [NICA #3] 星空（Hard Version）

## 题目背景

**Easy Version 和 Hard Version 差别在于数据范围。**

## 题目描述

小 R 有一个长度为 $n$ 的序列 $a$，保证序列中的每个数都是 $2$ 的整数次幂。

小 M 有一个数 $x$，她希望重新排列序列 $a$，使得不存在一个 $i\in[1,n)$ 满足 $a_i+a_{i+1}>x$。重排的方式为：选择一个 $1\sim n$ 的排列 $p$，然后令新序列 $a'$ 满足 $a'_i=a_{p_i}$。$a'$ 即为重排后的序列。

现在你想要知道有多少种重排的方式能满足小 M 的要求。两种重排方式不同当且仅当选择的排列 $p$ 不同。

## 说明/提示

数据保证，$2 \leq n \leq 10^5$，$1 \leq a_i \leq 2^{60}$，$1 \leq x < 2^{63}$。

## 样例 #1

### 输入

```
6 46
4 8 8 16 32 32```

### 输出

```
144```

# AI分析结果



**唯一算法分类**：组合数学

---

**综合分析与结论**  
题目要求将2的幂次数列排列，使得相邻两数之和不大于x。核心思路是将数分为三类：最大值（B类）、与B相加超限的（A类）、其余（C类）。排列时，B类必须与C类相邻，A类不能与B类相邻。通过组合数学计算排列方式：

1. **分类处理**：确定B类（最高位对应的数），A类（与B相加超过x的数），C类（其余数）。
2. **排列组合**：  
   - 将C类排列，形成间隙插入B类。  
   - 在剩余间隙中插入A类，允许任意分布。  
   - 各阶乘相乘（考虑同类元素的排列顺序）。

**可视化设计**  
- **颜色标记**：红（B类）、蓝（A类）、绿（C类）。  
- **动画步骤**：  
  1. 展示分类结果。  
  2. 排列C类，显示间隙数（绿球间红线）。  
  3. 插入B类（红球）到选定的间隙。  
  4. 在剩余间隙插入A类（蓝球）。  
- **复古像素风格**：Canvas绘制球和间隙，音效提示插入操作，背景循环8-bit音乐。

---

**题解清单 (4星及以上)**  
1. **GTAH2333 (5星)**  
   - **关键亮点**：清晰的分类与组合数学公式，代码高效。  
   - **核心逻辑**：预处理阶乘逆元，将问题转化为排列组合计算。  
2. **ccxswl (4星)**  
   - **关键亮点**：直观的插板法解释，代码结构清晰。  
   - **个人心得**：注释详细解释组合数的意义，便于理解。

---

**最优思路提炼**  
1. **分类策略**：利用二进制最高位快速确定B类。  
2. **插空法**：C类排列后的间隙数决定B类插入方式。  
3. **组合优化**：使用阶乘和逆元预处理，实现O(1)组合数查询。

**同类型题推荐**  
- **洛谷P1771**：排列限制下的组合数问题。  
- **洛谷P2181**：几何与组合结合。  
- **洛谷P4071**：错位排列计数。

---

**代码片段**  
题解2的核心部分：  
```cpp
int ans = Cc(C + 1, B) * (A ? Cc(A + t - 1, t - 1) : 1) % mod;
ans *= fc[C] * fc[B] % mod * fc[A] % mod;
```
- **实现思想**：计算B类插入间隙的组合数，乘A类插入的插板法结果，最后乘各类阶乘。

---

**可视化实现要点**  
```javascript
// 示例：绘制C类排列与B类插入
function drawBalls(c, b, a) {
    let gaps = c + 1;
    // 绘制C类绿色球和间隙线
    // 选择b间隙插入红色球
    // 剩余间隙插入蓝色球，动态显示组合数变化
}
```
- **音效**：插入时播放“哔”声，错误时短促鸣叫。  
- **自动模式**：逐步插入，间隙高亮闪烁。  

---

**总结**  
通过分类与组合数学，将复杂排列问题转化为间隙插入问题，高效解决大规模数据下的计数需求。

---
处理用时：193.66秒
# 题目信息

# 随机数生成器

## 题目描述

HKE最近编写了一个函数 $\text{rand}(l,r)$，其中 $l,r$ 为正整数且 $l \le r$。这个函数会等概率返回区间 $[l,r]$ 中任意一个正整数。然后，他又编写了一个函数：

```cpp
int work(int x){
    if(x==1) return 0;
    else return work(rand(1,x))+1;
}
```
这段代码用pascal写起来就是：
```pascal
function work(x:integer):integer;
begin
    if x=1 then exit(0);
    else exit(work(rand(1,x))+1);
end;
```
现在给定一个正整数 $n$，请问 $\text{work}(n)$ 的返回值的期望值是多少？

期望的定义：假设 $\text{work}(n)$ 返回的所有可能的值为 $x_1,x_2,\dots ,x_k$，它们出现的概率分别为 $p_1,p_2,\dots,p_k$，则期望为：

$$\mathbb{E}=\sum_{i=1}^{k}x_i p_i$$


## 说明/提示

【样例 $1$ 解释】  
$\text{work}(2)$ 有 $1/2$ 的概率返回 $1$，有 $1/4$ 的概率返回 $2$，有 $1/8$ 的概率返回 $3$ ……  
则期望为 $1/2+2/4+3/8+ \dots =2$

【数据范围】  
对于 $30\%$ 的数据，$n \le 9$；  
对于 $50\%$ 的数据，$n \le 1000$；  
对于 $70\%$ 的数据，$n \le 1000000$；  
对于 $100\%$ 的数据，$1\le n < 2^{31}$。


## 样例 #1

### 输入

```
2```

### 输出

```
2.00000```

## 样例 #2

### 输入

```
3```

### 输出

```
2.50000```

## 样例 #3

### 输入

```
100000```

### 输出

```
13.09014```

# AI分析结果



## 算法分类
期望DP、递推与调和级数应用

---

## 题解思路与核心分析

### 核心递推式推导
所有题解均基于期望的线性性，得出关键递推式：  
$$F(n) = 1 + \frac{1}{n}\sum_{i=1}^nF(i)$$

### 解决难点
1. **消元转换**：通过移项消去等式中的当前项$F(n)$，得到仅含前$n-1$项和的表达式  
   $$F(n) = \frac{n}{n-1} + \frac{1}{n-1}\sum_{i=1}^{n-1}F(i)$$

2. **差分转化**：通过构造差分项$D(n) = F(n) - F(n-1)$，发现其规律$D(n) = \frac{1}{n-1}$，从而将问题转化为调和级数求和

3. **大数优化**：当$n > 10^6$时，利用调和级数与自然对数的关系$H_n \approx \ln n + \gamma$进行近似计算

---

## 题解评分 (≥4星)

### 5星题解：NaCly_Fish
- **亮点**：首推递推式转换，代码简洁，完美处理大数与小数的分界阈值  
- **代码**：阈值判断清晰，直接使用数学库函数计算自然对数

### 5星题解：Sooke
- **亮点**：通过差分法揭示调和级数本质，给出数学归纳法证明过程  
- **可视化提示**：在动画中可用红蓝双色区分$F(n)$和$D(n)$的变化

### 4星题解：Memory_of_winter
- **亮点**：详细推导每一步数学变换，代码包含精确的long double处理  
- **优化点**：代码中可加入更多注释增强可读性

---

## 最优思路提炼
**关键步骤**  
1. 从递归式推导出递推方程  
2. 通过差分发现调和级数规律  
3. 分治策略：小规模暴力累加，大规模近似公式  

**思维突破**  
- 将递归问题转化为递推问题  
- 发现调和级数与自然对数的深层联系  

---

## 相似题目推荐
1. **P1297 [国家集训队]单选错位**（期望计算与递推）  
2. **P4316 绿豆蛙的归宿**（DAG上的期望DP）  
3. **P1365 WJMZBMR打osu! / Easy**（期望的线性性应用）  

---

## 可视化算法设计

### 核心动画方案
**递推过程演示**  
- **网格布局**：左侧显示当前计算项$n$，右侧动态绘制调和级数累加曲线  
- **颜色标记**：  
  - 黄色高亮当前项$1/(n-1)$  
  - 红色线段表示自然对数$\ln n$逼近过程  
- **步进控制**：支持单步查看从$F(n)$到$F(n-1)$的递推分解  

**复古像素风格**  
- **8-bit 数字显示**：用16x16像素块动态刷新当前项和总和  
- **音效设计**：  
  - 每次累加项时播放短促"滴"声  
  - 切换大数模式时播放FC游戏过关音效  

---

## 核心代码实现
```cpp
#include <cstdio>
#include <cmath>
const double GAMMA = 0.57721566490153286;

double calculate(int n) {
    if(n == 1) return 0;
    if(n <= 1e6) {
        double sum = 0;
        for(int i=1; i<n; ++i) sum += 1.0/i;
        return sum + 1;
    }
    return log(n) + GAMMA + 1;
}

int main() {
    int n; scanf("%d", &n);
    printf("%.5f\n", calculate(n));
    return 0;
}
```

---

## 关键学习点
1. **调试经验**：当n=2时需要单独验证初始条件  
2. **数学直觉**：观察样例猜测调和级数模式  
3. **优化权衡**：1e6的阈值通过实验平衡精度与效率  

---

## 知识扩展
**调和级数近似公式的误差分析**  
$$\Delta = H_n - (\ln n + \gamma) \sim \frac{1}{2n} - \frac{1}{12n^2} + \cdots$$  
当n>1e6时，误差小于1e-6，满足题目精度要求

---
处理用时：69.58秒
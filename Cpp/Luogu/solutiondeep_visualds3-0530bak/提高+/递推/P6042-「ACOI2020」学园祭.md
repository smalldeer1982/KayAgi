# 题目信息

# 「ACOI2020」学园祭

## 题目背景

![T4](https://s2.ax1x.com/2020/01/12/lopWDS.md.png)

秋天，是学习之秋，食欲之秋，更是，学园祭之秋！随着时间流逝，学园祭也越来越近。终于等到这一天，可是没想到在冲绳岛上邂逅到女装的渚同学的勇次竟然来了！中村 莉櫻（Nakamura Rio）见到这个情况，忙给渚同学换上女装。没办法，勇次已经来了，于是渚同学鼓起勇气迈出了第一步。（为什么自顾自地加提示框啊喂！）

## 题目描述

莉櫻为了利用这个人傻钱多的少爷，尽全力提高消费额，努力地暗示渚同学。没办法，于是渚同学想了一下，提出了一个问题：

给出一个 $n$，定义：
$$
\Gamma(0)=1,\Gamma(n)={n!}
$$

$$
A_i^j=\frac{\Gamma(i)}{\Gamma(j)}
$$
求
$$
\sum_{i=1}^n \sum_{j=1}^i \sum_{k=1}^j \gcd(A_{i-j}^j \times \Gamma(j),A_{j-k}^k \times \Gamma(k)) 
$$

渚同学念着莉櫻举起的对话板上写的字：如果不能在规定时间回答出问题的话，就要把菜单全部买一遍哦！

尽管勇次钱多，但是他并不想吃得太多，因为这个问题有 $T$ 个小问题！

**由于答案可能太大，请将答案对 $10086001$ 取模。**

## 说明/提示

#### 数据范围
**本题采用捆绑测试**。

- Subtask 1（20 points）：$T \leq 10^3$，$n \leq 10^2$。   
- Subtask 2（30 points）：$T \leq 10^6$，$n \leq 5 \times 10^3$。  
- Subtask 3（50 points）：$T \leq 10^6$，$n \leq 10^6$。   

对于 $100\%$ 的数据，$1 \leq T,n \leq 10^6$。

## 样例 #1

### 输入

```
5
1
2
3
4
5
```

### 输出

```
1
4
10
20
36
```

# AI分析结果



### 【唯一算法分类】  
数学推导与前缀和优化

---

### 【题解思路、算法要点与解决难点】  
**核心推导**：  
原式通过化简发现所求为所有三元组 (i, j, k) 中 `min(i-j, j-k)!` 的和。通过变量替换和组合计数，转化为计算每个 `a` 对应的 `(n-2a)^2 * a!` 之和，极大降低了时间复杂度。

**关键步骤**：  
1. **公式化简**：利用 `gcd(a!, b!) = min(a,b)!` 将三重循环简化为单变量求和。  
2. **组合计数**：发现 `min(x,y)=a` 的组合数为 `(n-2a)^2`。  
3. **前缀和优化**：将求和式拆分为 `a!`、`a!*a`、`a!*a²` 的前缀和，实现 O(1) 查询。  

**解决难点**：  
- 如何高效统计 `min(x,y)=a` 的组合数目。  
- 通过完全平方公式拆解求和项，实现线性预处理。

---

### 【题解评分 (≥4星)】  
1. **Alex_Wei (★★★★★)**  
   - **亮点**：数学推导清晰，完全平方展开优化前缀和，代码简洁高效。  
   - **代码可读性**：结构清晰，预处理与查询分离。  

2. **WYXkk (★★★★☆)**  
   - **亮点**：通过找规律发现三次差分后的阶乘特性，代码极简。  
   - **不足**：推导过程较跳跃，对数学直觉要求高。  

3. **Christophe_ (★★★★☆)**  
   - **亮点**：详细拆解组合情况，公式推导严谨，代码模块化。  
   - **不足**：预处理部分冗余变量可优化。  

---

### 【最优思路或技巧提炼】  
**核心优化**：  
- **拆解求和式**：利用 `(n-2a)^2 = n² -4an +4a²`，将原式拆为三个独立前缀和，实现快速计算。  
- **预处理技巧**：线性计算阶乘及其加权前缀和，空间换时间。  

**代码实现关键**：  
```cpp
// 预处理阶乘及前缀和
fac[0] = pre1[0] = 1;
for (int i=1; i<=maxn; i++) {
    fac[i] = fac[i-1] * i % mod;
    pre1[i] = (pre1[i-1] + fac[i]) % mod;      // ∑a!
    pre2[i] = (pre2[i-1] + fac[i] * 4*i) % mod; // ∑4a·a!
    pre3[i] = (pre3[i-1] + fac[i] * 4*i*i) % mod; // ∑4a²·a!
}
// 查询时直接计算
ans = (pre1[a_max] * n % mod * n - pre2[a_max] * n + pre3[a_max]) % mod;
```

---

### 【同类型题或类似算法套路】  
1. **阶乘性质与组合计数**：如 [P1593 因子和](https://www.luogu.com.cn/problem/P1593)。  
2. **前缀和优化求和式**：如 [CF1542C Strange Function](https://codeforces.com/problemset/problem/1542/C)。  
3. **数学拆解与模运算**：如 [P4942 小凯的数字](https://www.luogu.com.cn/problem/P4942)。  

---

### 【可视化与算法演示】  
**动画设计**：  
1. **动态网格展示**：  
   - 用网格表示 `a` 从 0 到 `(n-1)/2` 的变化，每个格子显示 `a!*(n-2a)^2` 的值。  
   - **颜色标记**：绿色表示 `a!`，蓝色表示 `(n-2a)` 的平方，红色高亮当前累加的项。  

2. **复古像素风格**：  
   - **Canvas 绘制**：每个 `a` 对应一个像素块，大小随 `a!` 值增大而动态变化。  
   - **音效触发**：每次累加时播放 8-bit 音效，完成时播放胜利音效。  

3. **控制面板**：  
   - 调节动画速度，单步执行观察每项贡献。  
   - 显示当前 `n` 值和最终结果的计算过程。  

**交互示例**：  
![动画截图](https://via.placeholder.com/400x200/000/fff?text=动态展示a!与(n-2a)^2的贡献)

---

### 【推荐题目】  
1. **P1593 因子和**（数学推导与模运算）  
2. **CF1542C Strange Function**（前缀和优化）  
3. **P4942 小凯的数字**（快速幂与模性质）  

---

### 【个人心得摘录】  
- **Alex_Wei**：  
  > “拆开完全平方公式后，前缀和预处理变得直观，注意避免负数取模。”  
- **WYXkk**：  
  > “找规律虽快，但严谨推导才能应对变式题。”  

---

### 【完整代码】  
```cpp
#include<bits/stdc++.h>
using namespace std;
const int N=1e6+5, mod=10086001;
long long fac[N], pre1[N], pre2[N], pre3[N];

int main() {
    // 预处理阶乘及前缀和
    fac[0] = pre1[0] = 1;
    for(int i=1; i<=1e6; ++i) {
        fac[i] = fac[i-1] * i % mod;
        pre1[i] = (pre1[i-1] + fac[i]) % mod;
        pre2[i] = (pre2[i-1] + fac[i] * 4*i) % mod;
        pre3[i] = (pre3[i-1] + fac[i] * 4*i*i) % mod;
    }
    
    int T; scanf("%d", &T);
    while(T--) {
        int n; scanf("%d", &n);
        int a_max = (n-1)/2;
        long long ans = (pre1[a_max] * n % mod * n % mod 
                       - pre2[a_max] * n % mod 
                       + pre3[a_max] + mod) % mod;
        printf("%lld\n", ans);
    }
    return 0;
}
```

---
处理用时：91.78秒
# 题目信息

# 「Wdsr-2.7」天才⑨与数学递推式

## 题目描述

生活在雾之湖的冰精琪露诺，向来以智慧而著称。作为寺子屋的老学员，琪露诺可是对数学递推式了如指掌。

有一天，慧音老师想要考一考琪露诺。于是她写出了一个长度为 $m$ 的递推公式：

$$F_t=\sum_{i=1}^m K_i\times F_{t-i} \quad (t> m)$$

其中 $m,\{K_i\}$ 都是被给定的。不过，由于这个序列 $\{F_i\}$ 的初始 $m$ 项并没有被确定，所以可能存在无穷个满足这个递推式，但是初始 $m$ 项并不一致的递推数列。慧音打算选择其中 $q$ 个 $F$ ，来考考琪露诺对数列知识的掌握。

具体而言，慧音会依次告诉琪露诺，若干个 $\{F_i\}$ 的起始 $m$ 项。显然，这样就能生成无穷序列 $\{F_i\}$ 了。尽管如此，生成这么多序列并不好玩。于是慧音又创造了一个答案序列 $\{A_i\}$ ，满足初始时 $A_i=0$ 。

每当给出一个新的 $\{F_i\}$ ，慧音都要琪露诺使 $\{A_i\}$ 的第 $a,a+1,\cdots b-1,b$ 项分别加上 $F_1,F_2,F_3,\cdots,F_{b-a+1}$ 。

当然，慧音老师不想为难琪露诺，于是对于所有数字，只要输出其对 $p$ 取模的值即可。其中 $p$ 是一个被给定的常数。

---

形式化地讲述题面：给定 $n,q,m,p,\{K_1,K_2,\cdots ,K_m\}$ 。有 $q$ 次操作，每次给定一组 $a,b,\{G_1,G_2\cdots G_m\}$ ，求出无穷序列 $\{F_i\}$ ：

$$F_t=\begin{cases}
G_t & t\le m \cr
\sum_{i=1}^m K_iF_{t-i} & t>m
\end{cases}$$

然后令 $\forall i\in [a,b] ,A_i\gets A_i+F_{i-a+1}$ 。最后分别输出 $\{A_i\}$ 的前 $n$ 项对 $p$ 取模后的结果。

## 说明/提示

#### 样例解释

对于样例 $1$ ：

- 初始时， $\{A_i\}=\{0,0,0,0,0\}$。

- 第一步生成了一个 $\{F_i\}=\{1,1,2,3,5\}$ ，加至 $A_1,A_2,A_3$，此时 $\{A_i\}=\{1,1,2,0,0\}$。

- 第二步生成了一个 $\{F_i\}=\{1,1,2,3,5\}$ ，加至 $A_2,A_3,\cdots ,A_5$，此时 $\{A_i\}=\{1,2,3,2,3\}$。

- 第三步生成了一个 $\{F_i\}=\{2,0,2,2,4\}$ ，加至 $A_1,A_2,\cdots ,A_5$，此时 $\{A_i\}=\{3,2,5,4,7\}$。

对于样例 $2$ ，我们既没有一个绝妙的解释，又没有足够大的空间，于是我们写不下了。

#### 数据范围及约定

$$
\def\arraystretch{1.5}
\begin{array}{|c|c|c|c|c|}\hline
\textbf{Subtask} & \bm{n} & \bm{m} & \bm{q}& \textbf{分值}\cr\hline
1 & n\le  10^4 & m\le 10 & q\le 10^3 & 10 \cr\hline
2 & n\le  10^5 & m=1 & q\le 10^5  & 20\cr\hline
3 & n\le  10^5 & m=2 & q\le 10^5 & 20\cr\hline
4 & \text{无特殊限制} & \text{无特殊限制} & \text{无特殊限制}& 50 \cr\hline
\end{array}$$

- 对于 $100\%$ 的数据，满足 $ 1 \leq n\le 1\times 10^6;1\le q \leq 1.2 \times 10^5;1 \leq m \leq 15;1 \leq K_i,G_i,p \leq 10^8;1\le a\le b\le n$ 。

## 样例 #1

### 输入

```
5 3 2 114514
1 1
1 3 1 1
2 5 1 1
1 5 2 0```

### 输出

```
3 2 5 4 7```

## 样例 #2

### 输入

```
20 5 4 1919810
2 5 4 3
1 20 1 1 1 1
5 12 7 6 1 2
2 18 9 0 0 1
9 11 5 4 4 1
10 14 1 0 0 0```

### 输出

```
1 10 1 1 22 75 221 850 3176 11706 43324 160379 586060 249707 351705 931555 619201 372869 1800119 1750063
```

# AI分析结果



**唯一算法分类**  
线性递推与差分数组

---

**综合分析与结论**  

**核心思路**  
1. **线性叠加性质**：将每个操作的数列贡献转化为对差分数组的修正，利用线性性质统一处理。  
2. **单位脉冲响应预处理**：预处理数组E，E[i]表示初始为1时递推的系数，用于快速计算任意位置的贡献。  
3. **修正初始项**：通过调整初始项构造F̂，确保生成的数列符合递推式的前m项。  
4. **区间修正**：在差分数组的a和b+1位置添加修正量，限制操作影响范围。  

**可视化设计**  
- **动画流程**：  
  1. **预处理E数组**：像素块动态显示E[i]的递推计算过程。  
  2. **操作处理**：高亮a和b+1位置，显示F̂和Y数组的修正值插入差分数组。  
  3. **最终递推**：从左到右遍历，每个位置根据前m项更新当前值，像素块颜色渐变表示数值变化。  
- **复古风格**：  
  - **颜色方案**：绿色表示差分数组修改点，红色表示递推计算中的当前项。  
  - **音效**：插入差分时播放“滴”声，递推时播放“嘟”声，完成时8-bit音乐庆祝。  
- **交互控制**：支持暂停/继续，拖动进度条观察各阶段数据变化。  

---

**题解清单 (4.5星)**  
1. **作者：囧仙**  
   - **亮点**：  
     - 利用线性性质将操作叠加转化为差分修正，时间复杂度优化至O(n + q*m²)。  
     - 预处理单位脉冲响应，巧妙处理无限数列的区间截断。  
   - **个人心得**：通过逆向调整初始项消除递推干扰，实现精确贡献计算。  

---

**最优思路与技巧**  
1. **差分数组的区间修正**：将无限长的数列影响限制在[a, b]区间内，避免暴力计算。  
2. **线性叠加预处理**：通过E数组快速计算任意位置的贡献系数，类似卷积核。  
3. **修正项构造**：反向递推消除前项影响，确保生成的数列前m项严格匹配输入。  

---

**同类型题与套路**  
- **通用思路**：线性递推问题常可通过矩阵快速幂优化，但结合差分可进一步降维。  
- **类似题目**：  
  - **洛谷P1939【模板】矩阵加速数列**（矩阵快速幂基础）  
  - **洛谷P5488 差分与前缀和**（差分与生成函数结合）  
  - **洛谷P4723 线性递推**（Berlekamp-Massey算法）  

---

**推荐题目**  
1. **P1939** - 矩阵加速递推模板题。  
2. **P5488** - 差分与前缀和的高效结合。  
3. **P4723** - 线性递推的进阶算法实践。  

---

**代码片段**  
```cpp
// 预处理单位脉冲响应 E（代码中的 T 数组）
T[0] = 1;
for (int i = 1; i <= n + m; ++i) {
    for (int j = 1; j <= m; ++j) {
        if (i - j >= 0) {
            T[i] = (T[i] + 1LL * K[j] * T[i - j]) % p;
        }
    }
}

// 处理每个操作，构造修正项 X 和 Y
for (int j = m; j >= 1; --j) {
    for (int k = 1; k <= j; ++k) {
        X[j] = (X[j] - 1LL * X[j - k] * K[k] % p + p) % p;
    }
}
// 类似处理 Y 数组后，更新差分数组 D
```

---

**复古游戏化动画实现**  
```javascript
// 示例：Canvas绘制差分数组修正（伪代码）
function drawStep(canvasCtx, a, b, X, Y) {
    // 高亮 a~a+m-1 区域为绿色
    canvasCtx.fillStyle = '#00FF00';
    for (let i = 0; i < m; i++) {
        drawPixel(a + i, X[i + 1], canvasCtx);
    }
    // 高亮 b+1~b+m 区域为红色
    canvasCtx.fillStyle = '#FF0000';
    for (let i = 0; i < m; i++) {
        drawPixel(b + 1 + i, Y[i + 1], canvasCtx);
    }
    // 播放音效
    playSound('blip');
}
```

---
处理用时：99.86秒
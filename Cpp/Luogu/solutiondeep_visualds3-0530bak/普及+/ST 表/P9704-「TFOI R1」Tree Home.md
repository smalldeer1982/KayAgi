# 题目信息

# 「TFOI R1」Tree Home

## 题目背景

阳光开朗大男孩天才 Z 今天要向蕉太狼表白力！

众所周知，蕉太狼是一个很可爱的女孩纸。
从前的天才 Z 总是担心因为自己表白失败而受到别人的嘲笑。但是今天，天才 Z 就要做出自己一生中最重要的一件事，那就是真诚地表白，无论后果如何。

出乎意料，蕉太狼其实也喜欢着天才 Z！

天才 Z 开心得像个 0#。

但是没过多久，天才 Z 就被甩力，原因蕉太狼发现天才 Z 对自己的闺蜜有非分之想。

天才 Z 拿出了自己的树状家谱，问候起了自己的祖宗们。

## 题目描述

有一个由 $n - 1$ 条**带权无向边**连接成的有 $n$ 个节点的树，每个节点都有它对应的**编号**以及**权值** $v_{i}$，整棵树的根节点为编号为 $1$ 的节点。

令 $f(a, b, c) = (a - b) \times \left[a^2 + b^2 + a \times b + 3 \times c \times (a + b + c)\right]$，其中 $a,b,c$ 可以为任意整数。同时用 $d_i$ 表示 $i$ 到根节点的每条边的**边权**之和。

现在天才 Z 要进行 $T$ 次询问，每次询问给定四个正整数 $l_{1},r_{1},l_{2},r_{2}$，你要从**编号**在区间 $[l_{1}, r_{1}]$ 和 $[l_{2}, r_{2}]$ 的点中各选择一个点 $p$ 和 $q$，当然你选择的两个点需要保证 $p \neq q$。用 $r$ 表示 $p$ 和 $q$ 的最近公共祖先，要使得 $|f(d_{p} - d_{r}, d_{q} - d_{r}, d_{r})| + |v_{p} - v_{q}|$ 的值最大，而你需要对每次询问输出这个最大值。

## 说明/提示

#### 样例解释

对于第一次询问，我们在两个区间分别取 $4$ 号点和 $6$ 号点即可得出答案 $19211$。

对于第二次询问，两个区间都只能取一个节点，所以答案为 $3$。


#### 数据范围

**本题采用捆绑测试**。

- Subtask 1（5 points）：$1 \leqslant n, T \leqslant 10$。
- Subtask 2（10 points）：$1 \leqslant n, T \leqslant 100$。
- Subtask 3（30 points）：$1 \leqslant n, T \leqslant 3000$。
- Subtask 4（55 points）：无特殊限制。

对于所有数据，$1 \leqslant n, T \leqslant 2 \times 10^5$，$0 \leqslant |w| \leqslant 25$，$1 \leqslant v_{x} \leqslant 10^9$，$1 \leqslant l_{1} \leqslant r_{1} \leqslant n$，$1 \leqslant l_{2} \leqslant r_{2} \leqslant n$，保证树中最大深度不超过 $100$。

**注意：两个区间 $[l_{1}, r_{1}]$ 和 $[l_{2}, r_{2}]$ 可能有重合部分。**

## 样例 #1

### 输入

```
7 2
5 1 7 12 5 9 6
1 2 5
3 1 1
6 2 9
4 6 14
7 6 4
5 2 10
2 4 5 7
1 1 3 3```

### 输出

```
19211
3```

# AI分析结果



---

## 唯一算法分类
**区间最值查询（ST表）**

---

## 综合分析与结论

### 核心思路
通过数学推导将原式转化为曼哈顿距离最值问题，并利用 ST 表维护四个关键参数的区间最值：  
1. $A = d^3 + v$ 的区间最大值与最小值  
2. $B = d^3 - v$ 的区间最大值与最小值  

最终答案为：  
$$\max \left( \text{Max}(A_1) - \text{Min}(A_2),\ \text{Max}(B_1) - \text{Min}(B_2),\ \text{Max}(A_2) - \text{Min}(A_1),\ \text{Max}(B_2) - \text{Min}(B_1) \right)$$

### 解决难点
1. **数学推导**：将复杂函数化简为曼哈顿距离形式（关键突破）  
2. **数据结构选择**：通过 ST 表实现 $O(1)$ 查询，满足 $2 \times 10^5$ 规模的高效处理  
3. **区间重叠处理**：独立维护两区间的最值，避免重复计算  

### 可视化设计
1. **坐标系映射**：将节点映射为 $(d^3, v)$ 的二维点，用不同颜色标注两个查询区间  
2. **极值动态标记**：在坐标系中高亮当前区间的 Max(A)、Min(A)、Max(B)、Min(B)  
3. **曼哈顿距离连线**：用箭头动态连接两区间的极值组合，显示对应的计算过程  
4. **像素风格**：树结构以 8-bit 像素树呈现，节点参数用 16 色块表示  
5. **音效触发**：查询时播放“数据加载”音效，极值匹配时播放“命中”音效  

---

## 题解清单 (≥4星)

### 1. Super_Cube（5星）
**关键亮点**  
- ST 表封装为结构体，代码简洁高效  
- 预处理逻辑清晰，合并区间操作符重载优雅  
- 完整推导过程与代码完全对应  

### 2. longlong666（4星）
**关键亮点**  
- 分步骤推导公式，适合新手理解  
- 独立维护四个 ST 表，逻辑直观  
- 完整注释与变量命名规范  

### 3. ccxswl（4星）
**关键亮点**  
- 线段树实现，提供另一种数据结构思路  
- 函数式合并区间操作，代码模块化程度高  
- 对比 ST 表与线段树的实现差异  

---

## 核心代码实现（Super_Cube 题解）

```cpp
struct ST {
    struct node { // 维护四个极值
        long long v1, v2, v3, v4; // Max(A), Min(A), Max(B), Min(B)
        node operator+(const node& y) { // 区间合并
            return {
                std::max(v1, y.v1), std::min(v2, y.v2),
                std::max(v3, y.v3), std::min(v4, y.v4)
            };
        }
    } st[200005][20];
    
    void init() { // ST表初始化
        for(int i=1; i<=n; ++i) {
            st[i][0].v1 = st[i][0].v2 = 1LL*dis[i]*dis[i]*dis[i] + a[i];
            st[i][0].v3 = st[i][0].v4 = 1LL*dis[i]*dis[i]*dis[i] - a[i];
        }
        for(int j=1; (1<<j)<=n; ++j)
            for(int i=1; i+(1<<j)-1<=n; ++i)
                st[i][j] = st[i][j-1] + st[i+(1<<(j-1))][j-1];
    }
    
    node ask(int l, int r) { // 区间查询
        int k = std::__lg(r - l + 1);
        return st[l][k] + st[r - (1<<k) + 1][k];
    }
};
```

---

## 相似题目推荐
1. **P5098** - 曼哈顿距离最值（模板题）  
2. **P3865** - ST 表区间最值（数据结构基础）  
3. **P1972** - 区间统计问题（不同思路但同规模）  

---

## 可视化算法演示

### 动画流程
1. **树遍历**：DFS 过程动态显示，边权累加计算 $d$ 值  
2. **坐标映射**：将每个节点映射到 $(d^3, v)$ 坐标系，用不同颜色区分区间  
3. **极值标记**：  
   - 红色方块：当前区间的 Max(A)  
   - 蓝色方块：当前区间的 Min(A)  
   - 绿色三角：Max(B)  
   - 黄色三角：Min(B)  
4. **组合计算**：连线四个极值组合，实时显示计算结果  

### 复古风格实现
```javascript
// Canvas 绘制示例（伪代码）
function drawNode(x, y, type) {
    ctx.fillStyle = COLORS[type]; // 16色调色板
    ctx.fillRect(x*16, y*16, 14, 14); // 像素块绘制
    if(type === 'MAX_A') playSound('beep1'); // 音效触发
}

// 自动演示模式
function autoRun() {
    highlightNodes(query1); // 高亮区间1
    highlightNodes(query2); // 高亮区间2
    drawConnections(maxA1, minA2); // 绘制极值连线
    updateScore(calculateResult()); // 显示当前得分
}
```

---

## 个人心得摘录
> _"推式子时要敢于展开，看似复杂的表达式可能有惊人简化的可能。本题的关键在于发现 $d^3$ 的立方差公式，这是突破瓶颈的核心步骤。"_ —— Super_Cube  
> _"ST表预处理时合并操作要小心位运算，1<<j-1 容易写成 1<<(j-1)，这个坑让我调试了整整两小时"_ —— longlong666

---
处理用时：94.63秒
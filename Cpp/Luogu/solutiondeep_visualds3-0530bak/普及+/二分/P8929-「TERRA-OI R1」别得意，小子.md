# 题目信息

# 「TERRA-OI R1」别得意，小子

## 题目背景

战至中途，蓝紫色天空瞬间变为黑压压一片，噬神者身上一些紫色外壳开始脱落，化为更小的蟒蛇，这些小家伙从出现开始便不要命的向你冲过来，刚清理掉这些小家伙，迷雾中忽然涌现出一张血盆大口，噬神者正向你冲击而来......

## 题目描述

现给定一个有 $n$ 段的分段函数，每一段可能是一个一次函数或者一个二次函数，并有 $q$ 次询问，每次询问 $x=k$ 时 $y$ 的取值或是 $y=k$ 与函数有多少个交点。



## 说明/提示

#### 【样例解释 #1】

三段函数分别为 $y=x+2$，$y=x^2-2x+1$，$y=x$。

对于当 $x=4$ 时套入第二段函数可以得到结果为 $9$。

而直线 $y=5$ 只与第一段与第二段函数相交，并且各只有一个交点，所以结果为 $2$。

显而易见，第三个询问对应的直线不与函数相交。

第四个询问虽然与第一段函数交于 $x=0$ 的位置，但 $0$ 不在该函数区间内，故舍去。

------------

#### 【数据范围】

**本题采用捆绑测试。**

| Subtask | Score | $n,q\le$ | limit |
| :----------: | :----------: | :----------: | :----------: |
| $1$ | $10$ | $100$ | 无 |
| $2$ | $15$ | $10^3$ | $r_n\le 5\times 10^3$ |
| $3$ | $20$ | $2\times 10^5$ | 不存在询问 $2$ |
| $4$ | $25$ | $2\times 10^5$ | 不存在二次函数 |
| $5$ | $30$ | $2\times 10^5$ | 无 |

对于 $100\%$ 的数据，$1\le n,q\le 2\times 10^5$，$0\le l_i,r_i\le10^9$，$\forall i\in [1,n],r_i>l_i$ 。

所有的函数系数均在 **$64$ 位有符号整型变量**存储范围内，并且运算结果与每个函数式中任何一项的最大值与最小值不会超过 **$64$ 位有符号整型变量**存储范围。所有询问参数均在 **$32$ 位有符号整型变量**范围内。

（即 $-4\times 10^{18}\le k,a,b,c\le 4\times 10^{18}$，$-10^9\le x\le 10^9$）

------------
#### 【提示】

采用浮点数据时建议使用 long double，避免产生精度问题。

upd：添加一组 hack 数据，未通过会显示为“Unaccepted 100pts”。

## 样例 #1

### 输入

```
3 4
0 3 1 1 2
3 6 2 1 -2 1
6 10 1 1 0
1 4
2 5
2 114514
2 2```

### 输出

```
9
2
0
0```

## 样例 #2

### 输入

```
6 8
0 4 2 1 -4 0 
4 6 1 2 -10 
6 11 1 1 -19 
11 19 2 -1 -30 559 
19 29 1 1 -58 
29 38 1 1 -68 
1 11
2 4
2 -1
1 21
2 -5
2 2
1 34
2 1
```

### 输出

```
-8
1
4
-37
1
2
-34
2
```

# AI分析结果



---

## 唯一算法分类  
**二分**

---

## 题解思路与算法要点  
### 核心问题分析  
1. **操作1（求x=k时的y值）**  
   - 通过二分查找确定k所在函数区间，代入函数式计算  
2. **操作2（求y=k与分段函数的交点数量）**  
   - 对每个函数段的值域进行区间覆盖统计  
   - 一次函数：单调性决定值域区间  
   - 二次函数：根据对称轴拆分区间，分别处理开口方向和顶点情况  

### 二分算法关键点对比  
| 题解作者 | 二分区间确定 | 收缩条件 | 边界处理 | 时间复杂度 |  
|----------|--------------|----------|----------|------------|  
| MCRS_lizi | `l=1, r=n` | 比较区间端点与k的大小 | 严格判断区间包含性 | O(log n) |  
| kbtyyds | `l=1, r=n` | 比较k与右端点 | 直接定位区间右边界 | O(log n) |  
| jifbt | 隐式二分（`lower_bound`） | 标准库实现 | 无显式区间收缩 | O(log n) |  

**共性难点**：  
1. 二次函数顶点是否为整数影响交点数量  
2. 一次函数的区间开闭处理（左闭右开）  
3. 值域范围过大（-4e18 ~ 4e18）需离散化或稀疏存储  

---

## 题解评分（≥4星）  
### 1. MCRS_lizi（★★★★☆）  
- **亮点**：  
  - 通过`map`实现稀疏差分，避免离散化  
  - 二次函数顶点特判逻辑严谨（浮点精度处理）  
  - 完整注释与边界处理示例  
- **代码片段**：  
  ```cpp  
  void tag(int x) {  
    long double mid = -bb/(2*aa);  
    if (顶点在区间外) line(l,r,x);  
    else {  
      if (开口向下) upd顶点分界;  
      else 拆分区间;  
    }  
  }  
  ```

### 2. jifbt（★★★★☆）  
- **亮点**：  
  - 极简代码（<100行）  
  - 统一用`floor/ceil`处理开闭区间  
  - 通过排序前缀和快速查询  
- **核心逻辑**：  
  ```cpp  
  void add(int i, db l, db r) {  
    db x=calc(l), y=calc(r);  
    if (x<y) 添加区间 [floor(x)+1, floor(y)+1);  
    else 添加区间 [ceil(y), ceil(x));  
  }  
  ```

---

## 最优思路与技巧  
### 关键思维突破  
1. **值域区间的数学建模**  
   - 一次函数：单调性直接映射为值域区间  
   - 二次函数：拆分为对称轴两侧的单调区间处理  
2. **离散化优化**  
   - 用`map`或排序+去重压缩值域事件点  
3. **差分标记法**  
   - 在区间起点+1，终点后-1，前缀和统计覆盖次数  

### 代码实现技巧  
```cpp  
// 处理二次函数顶点  
long double mid = -b/(2.0*a);  
if (fabs(a*mid*mid + b*mid + c - (int)top) < 1e-9) {  
    // 顶点为整数的特判  
}  
```

---

## 同类题目推荐  
1. **P3382 【模板】三分法**（二次函数极值计算）  
2. **P1024 [NOIP2001 提高组] 一元三次方程求解**（分段函数交点）  
3. **P1908 逆序对**（离散化+树状数组，类似区间统计）  

---

## 可视化设计  
### 二分过程动画方案  
![二分动画示意图](https://example.com/binary-demo.gif)  
1. **像素风格展示**  
   - 区间 [left, right] 用绿色方块表示  
   - 当前 mid 用黄色高亮  
   - 比较结果用红/蓝箭头指示收缩方向  
2. **音效交互**  
   - `mid计算`：8-bit "beep" 音  
   - `找到区间`：胜利音效  
   - `越界错误`：低沉警告音  
3. **自动演示模式**  
   ```javascript  
   function autoPlay() {  
     while(left <= right) {  
       highlightMid();  
       playSound('beep');  
       updateInterval();  
     }  
   }  
   ```

---

## 代码实现核心（jifbt版）  
```cpp  
// 二分查找区间（操作1）  
int pos = lower_bound(l+1, l+n+1, k) - l - 1;  

// 值域差分处理（操作2）  
struct D { ll y, d; };  
vector<D> diff;  
void add(int i, db l, db r) {  
    db x=calc(i,l), y=calc(i,r);  
    if(x < y) diff.push_back({floor(x)+1, 1}, {floor(y)+1, -1});  
    else diff.push_back({ceil(y), 1}, {ceil(x), -1});  
}  
sort(diff.begin(), diff.end());  
```

---

**总结**：通过二分确定区间与差分处理值域覆盖是本题核心，需特别注意二次函数的数学性质与浮点精度处理。推荐结合`map`差分或排序前缀和的实现方式。

---
处理用时：85.33秒
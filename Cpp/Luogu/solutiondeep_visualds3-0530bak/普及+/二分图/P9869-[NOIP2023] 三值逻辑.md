# 题目信息

# [NOIP2023] 三值逻辑

## 题目描述

小 L 今天学习了 Kleene 三值逻辑。

在三值逻辑中，一个变量的值可能为：真（$\mathit{True}$，简写作 $\mathit{T}$）、假（$\mathit{False}$，简写作 $\mathit{F}$）或未确定（$\mathit{Unknown}$，简写作 $\mathit{U}$）。

在三值逻辑上也可以定义逻辑运算。由于小 L 学习进度很慢，只掌握了逻辑非运算 $\lnot$，其运算法则为：
$$\lnot \mathit{T} = \mathit{F}, \lnot \mathit{F} = \mathit{T}, \lnot\mathit{U} = \mathit{U}.$$

现在小 L 有 $n$ 个三值逻辑变量 $x_1,\cdots, x_n$。小 L 想进行一些有趣的尝试，于是他写下了 $m$ 条语句。语句有以下三种类型，其中 $\leftarrow$ 表示赋值：

1. $x_i \leftarrow v$，其中 $v$ 为 $\mathit{T}, \mathit{F}, \mathit{U}$ 的一种；
2. $x_i \leftarrow x_j$；
3. $x_i \leftarrow \lnot x_j$。

一开始，小 L 会给这些变量赋初值，然后按顺序运行这 $m$ 条语句。

小 L 希望执行了所有语句后，所有变量的最终值与初值都相等。在此前提下，小 L 希望初值中 $\mathit{Unknown}$ 的变量尽可能少。

在本题中，你需要帮助小 L 找到 $\mathit{Unknown}$ 变量个数最少的赋初值方案，使得执行了所有语句后所有变量的最终值和初始值相等。小 L 保证，至少对于本题的所有测试用例，这样的赋初值方案都必然是存在的。

## 说明/提示

**【样例解释 #1】**

第一组测试数据中，$m$ 行语句依次为

- $x_2 \leftarrow \lnot x_1$；
- $x_3 \leftarrow \lnot x_2$；
- $x_1 \leftarrow x_3$。

一组合法的赋初值方案为 $x_1 = \mathit{T}, x_2 = \mathit{F}, x_3 = \mathit{T}$，共有 $0$ 个$\mathit{Unknown}$ 变量。因为不存在赋初值方案中有小于 $0$ 个$\mathit{Unknown}$ 变量，故输出为 $0$。

第二组测试数据中，$m$ 行语句依次为

- $x_2 \leftarrow \lnot x_1$；
- $x_3 \leftarrow \lnot x_2$；
- $x_1 \leftarrow \lnot x_3$。

唯一的赋初值方案为 $x_1 = x_2 = x_3 = \mathit{U}$，共有 $3$ 个$\mathit{Unknown}$ 变量，故输出为 $3$。

第三组测试数据中，$m$ 行语句依次为

- $x_2 \leftarrow \mathit{T}$；
- $x_2 \leftarrow \mathit{U}$；

一个最小化 $\mathit{Unknown}$ 变量个数的赋初值方案为 $x_1 = \mathit{T}, x_2 = \mathit{U}$。$x_1 = x_2 = \mathit{U}$ 也是一个合法的方案，但它没有最小化 $\mathit{Unknown}$ 变量的个数。

**【样例解释 #2】**

该组样例满足测试点 $2$ 的条件。

**【样例解释 #3】**

该组样例满足测试点 $5$ 的条件。

**【样例解释 #4】**

该组样例满足测试点 $8$ 的条件。

**【数据范围】**

对于所有测试数据，保证：

- $1 \le t \le 6$，$1 \le n,m \le 10 ^ 5$；
- 对于每个操作，$v$ 为 `TFU+-` 中的某个字符，$1 \le i,j \le n$。

| 测试点编号 | $n,m\leq$ | $v$ 可能的取值 |
| :----------: | :----------: | :----------: |
| $1,2$ | $10$ | $\mathit{TFU+-}$ |
| $3$ | $10^3$ | $\mathit{TFU}$ |
| $4$ | $10^5$ | $\mathit{TFU}$ |
| $5$ | $10^3$ | $\mathit{U+}$ |
| $6$ | $10^5$ | $\mathit{U+}$ |
| $7$ | $10^3$ | $\mathit{+-}$ |
| $8$ | $10^5$ | $\mathit{+-}$ |
| $9$ | $10^3$ | $\mathit{TFU+-}$ |
| $10$ | $10^5$ | $\mathit{TFU+-}$ |

## 样例 #1

### 输入

```
1 3
3 3
- 2 1
- 3 2
+ 1 3
3 3
- 2 1
- 3 2
- 1 3
2 2
T 2
U 2
```

### 输出

```
0
3
1
```

# AI分析结果



## 算法分类
**并查集与图论**

---

## 综合分析与结论

### 核心思路与难点
- **核心目标**：找到满足终态等于初态的条件下，初值中 `U` 最少的方案。  
- **关键矛盾**：变量间的赋值关系可能形成 **循环依赖**（如 `x1←¬x2, x2←¬x1`），此时无法用 `T/F` 赋值，必须设为 `U`。  
- **解决难点**：高效处理变量间的等价关系（正/反向依赖）与奇环检测。  

### 核心算法流程
1. **变量关系建模**：  
   - 使用并查集维护变量间的 **正负关系**（如 `x_i = ±x_j`）。  
   - 或构建图结构，边权表示是否取反，通过 **奇环检测** 判断矛盾。  
2. **矛盾判定**：  
   - **并查集**：若变量 `x` 的祖先是 `-x`（路径上的取反次数为奇数），则 `x` 必须为 `U`。  
   - **图论**：若连通块中存在奇环，则该块所有变量必须为 `U`。  

### 可视化设计
- **动画方案**：  
  - **节点表示**：每个变量为像素化方块，颜色表示当前值（`T`-绿，`F`-红，`U`-灰）。  
  - **边表示**：正向依赖（蓝色箭头），反向依赖（红色箭头）。  
  - **高亮冲突**：检测到奇环时，连通块闪烁并变为灰色，播放“失败”音效。  
- **交互控制**：  
  - **步进执行**：单步展示赋值操作如何影响变量关系。  
  - **自动模式**：模拟算法自动合并并查集或遍历图结构。  

---

## 题解清单 (≥4星)

### 1. 哈哈人生（⭐⭐⭐⭐）  
- **亮点**：通过并查集维护变量正负关系，巧妙处理 `T/F/U` 为常量，代码简洁。  
- **核心代码**：  
  ```cpp
  int find(int x) {
      if (x == T || x == F) return x;
      if (book[n - x] || x == U) return U;
      // ... 处理路径压缩与正负标记
  }
  ```

### 2. August_Light（⭐⭐⭐⭐）  
- **亮点**：将 `T/F/U` 抽象为特殊节点，通过二分图判断奇环，逻辑清晰。  
- **核心代码**：  
  ```cpp
  bool is_bi_graph = 1;
  f[v] = f[u] ^ w; // DFS 染色判断奇环
  ```

### 3. _Dolphin_（⭐⭐⭐）  
- **亮点**：路径压缩时处理取反标志，DFS 检测自反环，但代码可读性稍低。  

---

## 最优思路与技巧

### 关键技巧
- **符号化处理**：将 `T/F` 设为极大值常量，`U` 设为 0，便于并查集处理正负。  
- **奇环检测**：通过边权异或（1 表示取反）判断矛盾，避免显式维护状态。  
- **虚点抽象**：将 `T/F/U` 作为特殊节点，简化图结构。  

### 同类型题推荐
1. **P1955 [NOI2015] 程序自动分析**（并查集处理等价关系）  
2. **P2024 [NOI2001] 食物链**（带权并查集处理三类关系）  
3. **P2661 [NOIP2015] 信息传递**（基环树找环）  

---

## 代码核心片段

### 并查集实现（哈哈人生）
```cpp
int find(int x) {
    if (x == T || x == F) return x;
    if (book[n - x] || x == U) return U;
    if (book[x + n]) return T;
    if (x < 0) {
        book[x + n] = 1;
        re = find(-fa[-x]); // 处理负值
        book[x + n] = 0;
    } else {
        book[x + n] = 1;
        re = fa[x] = find(fa[x]);
        book[x + n] = 0;
    }
    return re;
}
```

### 图论实现（August_Light）
```cpp
// 构建图结构并判断奇环
for (auto [v, w] : G1[u]) {
    if (vis[v]) {
        if (f[v] != (f[u] ^ w)) is_bi_graph = 0;
    } else {
        f[v] = (f[u] ^ w);
        siz += get_size(v);
    }
}
```

---

## 复古像素动画设计
- **风格**：8位像素，变量为 16x16 方块，边为箭头像素线条。  
- **音效**：  
  - **合并成功**：短促“哔”声（正向）或“嗡”声（反向）。  
  - **检测到 U**：低沉嗡鸣，方块变灰。  
- **自动演示**：按操作顺序逐步展示赋值与冲突检测，支持暂停/继续。  

---

## 个人心得
- **调试教训**：处理路径压缩时，负号标记需谨慎，否则导致死循环（如题解中 `book` 数组的偏移处理）。  
- **优化顿悟**：将 `T/F` 设为超出变量范围的常量，避免与正常变量冲突。

---
处理用时：79.82秒
# 题目信息

# [JRKSJ R2] Upper

## 题目描述

有 $n$ 张扑克，第 $i$ 张扑克上写有一个正整数 $a_i$。

现在要把扑克划分成若干个合法的连续子段，其中，一个连续子段 $[l,r]$ “合法”当且仅当这个子段同时满足两个条件： 

* $a_l< a_r$
* $\gcd(a_l,a_r)>1$ 

请问最多能划分多少段。如果没有合法的划分方案，输出 $-1$ 即可。

如果您不知道 $\gcd$ 是什么意思，请看“提示”部分。

## 说明/提示

### 数据范围
本题采用捆绑测试。

对于 $100\%$ 的数据，$2\le n\le 10^5$，$1\le a_i\le 10^9$。

| $\text{Subtask}$ | $n\le$ | $a_i\le$ | 特殊性质 | 分值 |
| :----------: | :----------: | :----------: | :----------: | :----------: |
| $1$ | $5$ | $10^9$ | 无 | $5$ |
| $2$ | $3\times10^3$ | $10^9$ | 无 | $15$ |
| $3$ | $2\times10^4$ | $10^6$ | 无 | $20$ |
| $4$ | $2\times 10^4$ | $10^9$ | 无 | $10$ |
| $5$ | $10^5$ | $10^9$ | 数据随机 | $10$ |
| $6$ | $10^5$ | $10^9$ | 无 | $40$ |

### 样例解释
对于样例 $1$，有且仅有一种划分方案 $\{2,1,8\},\{3,9\}$。\
对于样例 $2$，无合法的划分方案。

### 提示
对于两个正整数 $a,b$，$\gcd(a,b)$ 为它们的最大公因数，即满足既是 $a$ 的因数又是 $b$ 的因数的数中最大的数。

## 样例 #1

### 输入

```
5
2 1 8 3 9```

### 输出

```
2```

## 样例 #2

### 输入

```
5
5 4 3 2 1```

### 输出

```
-1```

## 样例 #3

### 输入

```
20
20 9 36 36 40 8 3 10 9 20 18 12 30 20 30 15 8 9 27 45```

### 输出

```
7```

# AI分析结果



## 算法分类选择
**线性DP**

---

## 题解思路、算法要点与解决难点

### 核心思路
题目要求将序列划分为满足条件（首尾元素递增且gcd>1）的连续子段，最大划分数。通过动态规划（DP）设计状态转移方程，并利用质因数分解与权值线段树优化转移过程。

### 算法要点
1. **状态定义**：设 `f[i]` 表示前 `i` 个元素的最大划分数。
2. **转移方程**：  
   `f[i] = max{ f[j-1] + 1 }`，其中 `j < i`，`a[j] < a[i]`，且 `gcd(a[j],a[i]) > 1`。
3. **质因数分解**：将 `a[i]` 分解质因数，仅需考虑其质因子集合。
4. **权值线段树优化**：为每个质因子维护动态开点线段树，存储 `a[j]` 离散化后的值与对应的 `f[j-1]`，快速查询区间最大值。

### 解决难点
1. **质因数筛选**：仅需分解到 `√V`，处理剩余的大质因子。
2. **高效查询**：利用线段树在 `O(log n)` 时间内查询满足 `a[j] < a[i]` 的最大 `f[j-1]`。
3. **空间优化**：动态开点线段树避免存储空节点，哈希表管理不同质因子的线段树根节点。

---

## 最优思路或技巧提炼
1. **质因数分解**：将 `gcd` 条件转化为质因子公共性，缩小查询范围。
2. **权值线段树分组维护**：按质因子分组，每组维护离散化后的数值与DP值映射。
3. **离散化处理**：压缩 `a` 的值域，降低线段树高度。
4. **动态开点**：避免预建线段树，按需创建节点，节省空间。

---

## 题解评分（≥4星）

### KazamaRuri（★★★★☆）
- **思路清晰**：直接分解质因子，线段树维护分组最大值。
- **代码简洁**：动态开点线段树实现紧凑，质因数分解优化到位。
- **核心代码**：
  ```cpp
  for (auto x:q[i]) { // 遍历质因子
      if (rt[x]) f[i] = max(f[i], ask(rt[x], 1, n, a[i]-1) + 1);
      if (f[i-1] >= 0) upd(rt[x], 1, n, a[i], f[i-1]);
  }
  ```

### ZillionX（★★★★★）
- **高效分解**：使用Exact Division优化质因数分解，提升速度。
- **最优解实践**：采用 `gp_hash_table` 管理质因子线段树，极致优化。
- **核心代码**：
  ```cpp
  for (int j=1; j<=dv[i][0]; j++) { // 遍历质因子
      if (T.rt[dv[i][j]]) f[i] = max(f[i], T.Qry(...));
      if (f[i-1] >= 0) T.Upd(...);
  }
  ```

---

## 可视化与算法演示（核心DP过程）
### 动画设计
1. **像素风格网格**：  
   - 每个质因子对应一个纵向线段树，用不同颜色区分（如红色=2，蓝色=3）。
   - DP数组横向展开，每个单元格表示 `f[i]`，颜色深浅表示值大小。

2. **关键步骤高亮**：  
   - **质因数分解**：当前 `a[i]` 分解为质因子时，对应线段树闪烁。
   - **线段树查询**：沿线段树路径向下，高亮查询路径（绿色边框）。
   - **DP更新**：成功找到更大 `f[i]` 时，单元格变为金色并播放音效。

3. **音效提示**：  
   - 分解质因子：短促“滴”声。
   - 线段树更新：轻微“咔嗒”声。
   - DP值更新：上扬“叮”声。

### 交互控制
- **步进控制**：允许暂停/继续，调整动画速度（0.5x~2x）。
- **自动演示**：AI模式自动展示最优路径，高亮关键质因子。

---

## 同类型题推荐
1. **P1970 花匠**：线性DP+条件分段，需维护递增/递减序列。
2. **P1020 导弹拦截**：最长不升子序列，可结合离散化与线段树优化。
3. **P3383 线性筛素数**：质因数分解前置知识，强化分解效率。

---
处理用时：87.36秒
# 题目信息

# 「Daily OI Round 1」Block

## 题目描述

给定一棵树，节点有颜色，在树上距离为 $2$ 的点连边（仍保留原来的边），求新图中颜色相同且连通的非空点集数量。由于答案可能非常大，您只需输出答案对 $10^9+7$ 取模的值。

点集连通的定义：对于图 $G(V,E)$，$V$ 的一个子集 $V'$ 是连通点集，当且仅当 $G(V',E')$ 是一个连通图，其中边集 $E'=\{(u,v)|(u,v)\in E\land u \in V'\land v\in V'\}$。

## 说明/提示

样例 1 中，原树如下图所示：

![](https://cdn.luogu.com.cn/upload/image_hosting/zmgrnwkh.png)

树上距离为 $2$ 的点连边后，新图如下图所示：

![](https://cdn.luogu.com.cn/upload/image_hosting/id3xc54a.png)

则 $8$ 个颜色相同且连通的非空点集分别是：$\{1\},\{2\},\{3\},\{4\},\{1,3\},\{1,4\},\{3,4\},\{1,3,4\}$。

**本题开启捆绑测试。**



|$\text{Subtask}$|分值|$n \le$| 特殊性质 | 子任务依赖 |
| :-----------: | :-------------:|:-----------: |:-----------: |:-----------: |
|$0$|$5$|$10^5$| A | 无 |
|$1$|$5$|$16$| 无 | 无 |
|$2$|$5$|$10^5$| B | 无 |
|$3$|$15$|$10^5$| C | 无 |
|$4$|$20$|$10^5$| D | 无 |
|$5$|$50$|$10^5$| 无 | $0\sim4$ |

- 特殊性质 A：所有节点的颜色不相同。
- 特殊性质 B：给出的树是菊花，具体地，第 $i$ 条边连接节点 $1$ 和节点 $i+1$。
- 特殊性质 C：给出的树是链，具体地，第 $i$ 条边连接节点 $i$ 和节点 $i+1$。
- 特殊性质 D：所有节点的颜色相同。


对于全部数据，满足 $2\leq n\leq 10^5$，$1\leq c_i\leq n$。

## 样例 #1

### 输入

```
4
1 2 1 1
1 2
2 3
2 4
```

### 输出

```
8```

## 样例 #2

### 输入

```
6
1 2 2 2 1 2
5 3
2 1
4 5
6 3
3 1
```

### 输出

```
14```

## 样例 #3

### 输入

```
16
1 1 2 1 1 2 2 2 1 1 2 1 1 1 2 1
12 8
14 9
10 8
1 16
7 12
6 1
14 8
3 1
12 5
1 13
12 2
1 12
15 8
11 5
4 12
```

### 输出

```
442```

## 样例 #4

### 输入

```
16
11 11 11 11 11 11 11 11 11 11 11 11 11 11 11 11
4 14
4 15
12 13
2 5
7 15
10 2
15 8
15 13
9 11
13 11
3 15
8 16
6 13
1 4
10 4```

### 输出

```
27454```

## 样例 #5

### 输入

```
9
3 3 2 3 2 4 2 3 3
1 2
2 3
3 4
4 5
5 6
6 7
7 8
8 9```

### 输出

```
16```

# AI分析结果



---

**算法分类**: 线性DP (树形动态规划)

---

### 综合分析与结论

#### 核心思路
题目要求在新图中统计颜色相同且连通的点集数量。新图的边由原树中距离为2的点构成，因此原树中兄弟节点（同父的两个子节点）和祖孙节点（父节点与孙子节点）在新图中直接相连。树形DP的核心思路是：
- **状态定义**：对每个节点 `u`，定义 `f[u]` 表示必须选 `u` 且颜色相同的连通块方案数。
- **状态转移**：遍历 `u` 的子节点 `v`，考虑是否选 `v`：
  - 若选 `v`，则需 `c[u]=c[v]`，贡献为 `f[v]`；
  - 若不选 `v`，则需选 `v` 的子节点 `w` 且 `c[u]=c[w]`，贡献为 `∏(f[w]+1)`。
- **答案统计**：除了 `∑f[u]`（选 `u` 的情况），还需统计不选 `u` 但选多个同色子树的方案，通过乘积减去单子树和空集的情况。

#### 解决难点
1. **连通性处理**：新图的连通性要求点集在原树中形成「距离不超过2」的连通结构。通过树形DP合并子树方案，确保所有选中的节点在新图中连通。
2. **颜色一致性**：转移时需严格判断颜色相同的情况，避免不同颜色的干扰。
3. **组合数学优化**：用乘积和减法统计至少选两个同色子树的方案，避免暴力枚举。

#### 可视化设计思路
- **动画方案**：以树形结构展示，高亮当前处理的节点 `u`，逐步展示其子节点的贡献合并过程。
- **颜色标记**：用不同颜色区分节点颜色，动态显示 `f[u]` 的更新和 `g` 数组的乘积过程。
- **复古像素风格**：用8位网格绘制树结构，每个节点显示 `f[u]` 的值，音效在状态更新时触发（如转移成功时播放上升音调）。

---

### 题解评分（≥4星）

1. **recollect_i（★★★★★）**  
   - **关键亮点**：状态转移方程简洁，通过两次遍历处理颜色乘积，避免干扰；代码结构清晰，高效利用辅助数组 `g`。
   - **个人心得**：通过维护 `g[c]` 的临时乘积，巧妙统计不选 `u` 的同色子树组合。

2. **by_chance（★★★★☆）**  
   - **关键亮点**：用 `g[c]` 维护颜色乘积，递归结束时统计答案；代码简洁但需注意父节点颜色传递。
   - **改进点**：未明确处理孙子节点的组合，可能导致部分情况遗漏。

3. **一只绝帆（★★★★☆）**  
   - **关键亮点**：明确分离选与不选 `u` 的情况，通过 `g[x]` 统计不选 `u` 的同色子树组合。
   - **改进点**：代码中嵌套循环较多，复杂度略高。

---

### 最优思路与核心代码

#### 最优思路提炼
- **状态设计**：`f[u]` 表示必须选 `u` 的方案数，`g[c]` 维护颜色为 `c` 的子树的组合。
- **转移方程**：
  ```plaintext
  f[u] = ∏ (选v的方案 + 不选v但选v的子节点方案)
  g[c] = ∏(f[v]+1) - ∑f[v] - 1  // 至少选两个同色子树
  ```
- **答案统计**：总答案为 `∑f[u] + ∑g[c]`。

#### 核心代码（recollect_i）
```cpp
void dp(int u, int fa) {
    f[u] = 1;
    for (int i = la[u]; i; i = ne[i]) {
        int v = en[i];
        if (v == fa) continue;
        dp(v, u);
        LL t = 1;
        // 处理v的子节点w
        for (int j = la[v]; j; j = ne[j]) {
            int w = en[j];
            if (w == u || c[w] != c[u]) continue;
            t = t * (f[w] + 1) % P;
        }
        if (c[v] == c[u]) t = (t + f[v]) % P;
        f[u] = f[u] * t % P;
    }
    // 统计不选u的同色子树方案
    for (int i = la[u]; i; i = ne[i]) {
        int v = en[i];
        if (v == fa) continue;
        g[c[v]] = g[c[v]] * (f[v] + 1) % P;
    }
    for (int i = la[u]; i; i = ne[i]) {
        int v = en[i];
        if (v == fa) continue;
        res = (res + g[c[v]] - 1) % P;
        g[c[v]] = 1; // 重置g数组
    }
}
```

---

### 类似题目推荐
1. **P1352 没有上司的舞会**（树形DP，状态分离选与不选）
2. **P2015 二叉苹果树**（树形DP，维护子树边权）
3. **P4516 潜入行动**（树形DP结合组合数学）

---

### 可视化与复古游戏化设计
- **像素风格**：用Canvas绘制树形网格，节点显示颜色和 `f[u]` 值。
- **音效设计**：
  - **转移成功**：8-bit上升音效（Web Audio API生成）。
  - **错误/无解**：短促“哔”声。
- **AI演示模式**：自动按DFS顺序遍历树，单步延时500ms，展示 `f[u]` 更新和 `g[c]` 乘积过程。

---

**答案**
经过对题解的分析与对比，最优解法采用树形DP，核心在于分离选与不选当前节点的状态，并通过组合数学优化统计同色子树方案。最终答案可通过递归计算 `f` 和 `g` 数组得出。

---
处理用时：102.58秒
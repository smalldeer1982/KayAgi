# 题目信息

# [NOI2011] 兔农

## 题目描述

农夫栋栋近年收入不景气，正在他发愁如何能多赚点钱时，他听到隔壁的小朋友在讨论兔子繁殖的问题。

问题是这样的：第一个月初有一对刚出生的小兔子，经过两个月长大后，这对兔子从第三个月开始，每个月初生一对小兔子。新出生的小兔子生长两个月后又能每个月生出一对小兔子。问第 $n$ 个月有多少只兔子？

聪明的你可能已经发现，第 $n$ 个月的兔子数正好是第 $n$ 个 Fibonacci（斐波那契）数。栋栋不懂什么是 Fibonacci 数，但他也发现了规律：第 $i+2$ 个月的兔子数等于第 $i$ 个月的兔子数加上第 $i+1$ 个月的兔子数。前几个月的兔子数依次为：

$$1,1,2,3,5,8,13,21,34,\ldots$$

栋栋发现越到后面兔子数增长的越快，期待养兔子一定能赚大钱，于是栋栋在第一个月初买了一对小兔子开始饲养。

每天，栋栋都要给兔子们喂食，兔子们吃食时非常特别，总是每 $k$ 对兔子围成一圈，最后剩下的不足 $k$ 对的围成一圈，由于兔子特别害怕孤独，从第三个月开始，如果吃食时围成某一个圈的只有一对兔子，这对兔子就会很快死掉。

我们假设死去的总是刚出生的兔子，那么每个月的兔子数仍然是可以计算的。例如，当 $k=7$ 时，前几个月的兔子数依次为：

$$1,1,2,3,5,7,12,19,31,49,80,\ldots$$

给定 $n$，你能帮助栋栋计算第 $n$ 个月他有多少对兔子么？由于答案可能非常大，你只需要告诉栋栋第 $n$ 个月的兔子对数除 $p$ 的余数即可。


## 说明/提示

|测试点编号|$n$|$k,p$|
|:-:|:-:|:-:|
|$1\sim 10$|$1\leq n\leq 50$|$2\leq k,p\leq1000$|
|$11$|$1\leq n\leq 80$|$2\leq k,p\leq 10^4$|
|$12,13$|$1\leq n\leq 1000$|$2\leq k,p\leq 10^4$|
|$14,15$|$1\leq n\leq 10^6$|$2\leq k,p\leq 10^6$|
|$16,17$|$1\leq n\leq 10^{18}$|$2\leq k,p\leq1000$|
|$18\sim 20$|$1\leq n\leq 10^{18}$|$2\leq k\leq 10^6$，$2\leq p\leq 10^9$|

对于 $100\%$ 的数据，$1\leq n\leq 10^{18}$，$2\leq k\leq 10^6$，$2\leq p\leq 10^9$。


## 样例 #1

### 输入

```
6 7 100```

### 输出

```
7```

## 样例 #2

### 输入

```
7 7 5```

### 输出

```
2```

# AI分析结果



**唯一算法分类**  
矩阵快速幂与数论（循环节检测、逆元）

---

### 综合分析与结论  
**核心思路**：  
1. **分段斐波那契数列**：每段起始值为 \( x \)，内部数列为 \( x, x, 2x, 3x, \dots \)，当 \( x \cdot \text{fib}(len) \equiv 1 \pmod{k} \) 时结束该段并减1。  
2. **逆元与循环节**：通过计算斐波那契数的逆元确定段长度，检测循环节以处理大规模 \( n \)。  
3. **矩阵快速幂**：将每段的状态转移封装为矩阵乘法，利用快速幂加速计算。

**可视化设计**：  
- **动画分步展示**：  
  1. 初始段（\( x=1 \)）的斐波那契增长，高亮模 \( k=1 \) 时的减1操作。  
  2. 循环节检测过程：动态显示各段起始值 \( x \) 的变化路径，标记已访问节点。  
  3. 矩阵状态转移：可视化矩阵乘法对当前兔子数的影响（如红框标记当前操作的矩阵元素）。  
- **复古像素风格**：  
  - 用 8-bit 风格绘制斐波那契数列段，每段用不同颜色块表示。  
  - 循环节路径以闪烁箭头连接，音效在检测到循环时播放短促“叮”声。  

---

### 题解清单 (≥4星)  
1. **TimWYZ（4.5⭐）**  
   - **亮点**：完整推导循环节性质，矩阵定义清晰，代码注释详细。  
   - **关键代码**：  
     ```cpp
     Matrix quickPower(Matrix a, ll b) { // 矩阵快速幂实现
       Matrix ret; ret.identity();
       while (b) { if (b&1) ret = ret * a; a = a * a; b >>= 1; }
       return ret;
     }
     ```
2. **wlzhouzhuan（4.0⭐）**  
   - **亮点**：代码高效简洁，预处理斐波那契模 \( k \) 的循环节。  
   - **技巧**：利用斐波那契循环节不超过 \( 6k \) 的性质优化预处理。  

3. **zqy1018（4.0⭐）**  
   - **亮点**：通过逆元快速定位段长度，矩阵分块处理循环节。  
   - **调试心得**：提到“代码实现难度大，需注意死循环分支”。  

---

### 最优思路与代码片段  
**核心逻辑**：预处理段长度与循环节，矩阵分块加速。  
```cpp
// 预处理每个 x 对应的段长度 len[x]
for (ll i = 3; ; i++) {
    fib[i] = (fib[i-1] + fib[i-2]) % k;
    if (fib[i] == 1 && fib[i-1] == 1) break;
    ll inv = getInv(fib[i], k);
    if (inv != -1) len[inv % k] = min(len[inv % k], i);
}

// 矩阵转移：正常段与减1段
Matrix tr1 = {{1,1,0}, {1,0,0}, {0,0,1}}; // 正常递推
Matrix tr2 = {{1,1,0}, {1,0,0}, {-1,0,1}}; // 减1操作
```

---

### 类似题目推荐  
1. **洛谷 P4000** - 斐波那契数列（模数循环节）  
2. **洛谷 P5171** - Earth Lord（矩阵快速幂与数论结合）  
3. **洛谷 P1516** - 青蛙的约会（扩展欧几里得求逆元）  

---

### 可视化与复古动画实现方案  
**Canvas 动画示例**：  
```javascript
// 绘制斐波那契段（伪代码）
function drawSegment(x, len) {
    for (let i = 0; i < len; i++) {
        drawPixelBlock(x * fib[i] % k, i); // 8-bit 风格方块
        if (i == len-1) playSound('beep'); // 段尾音效
    }
}
// 自动演示循环节检测
let currentX = 1, visited = new Set();
while (!visited.has(currentX)) {
    visited.add(currentX);
    drawPathArrow(currentX); // 绘制路径箭头
    currentX = nextX(currentX); // 计算下一段起始值
}
```

**音效设计**：  
- **步进音效**：短促“滴”声（每次矩阵乘法）。  
- **循环检测**：长“叮”声（检测到循环节）。  
- **错误处理**：低音“嘟”声（无逆元分支）。  

---

**总结**：通过数学建模将问题转化为分段斐波那契数列，利用矩阵快速幂与循环节检测高效处理大规模输入，是数论与动态规划结合的经典案例。

---
处理用时：79.84秒
# 题目信息

# 「HGOI-1」Build

## 题目背景

一次旅行，$\text{uuku}$ 到了一个奇怪的小镇。

## 题目描述

这个小镇将要和周围的其他小镇一共 $n$ 个小镇，一起修建一个能**连通**这 $n$ 个小镇，有 $m$ 条高速公路的交通网。其中每条高速公路都将会连接**不同的两个小镇**，即不存在一条高速公路的起点和终点相同。

但高速公路的修建费用是很高的，所以镇长们一致决定将共同承担高速公路的费用，所以他们希望修建的**总费用最小**。

而且由于不同小镇的基础设施建设情况不同，所以每个小镇在修建的费用也不同。经过协商，每条高速公路将由其所连接的两个小镇共同施工。每个小镇负责一半路程。为了同时结束整个施工过程，显然将会有小镇同时进行多条道路的施工，而施工的道路数量越多，所需要花费的价钱就越多。

经过计算，每个小镇施工的花费可以用函数表示，及对于小镇 $i$，有三个参数 $a_i$，$b_i$，$c_i$。对于 $i$ 小镇来说在修建其第 $j$ 条高速时，**这条**高速所需要的花费为 $a_ij^2+b_ij+c_i$。

现在，这些镇长想要 $\text{uuku}$ 给他们提供一个满足要求的**建造方案**，使**总价格最小**。

当然，$\text{uuku}$ 将这个问题交给了你。

## 说明/提示

#### 数据范围
本题采用**捆绑测试**，共有 $6$ 个 $\text{subtask}$，最终分数为所有 $\text{subtask}$ 分数之和。
$$
\def\arraystretch{1.5}
\begin{array}{|c|c|c|}\hline
\textbf{Task} & \textbf{Score} & \textbf{特殊限制} \cr\hline
1 & 10 & n,m\le 500  \cr\hline
2 & 20 &  n,m\le 5\times 10^3 \cr\hline
3 & 10 & \text{每个小镇的函数相同}\cr\hline
4 & 20 & a_i=0 \cr\hline
5 & 20 & m=n-1 \cr\hline
6 & 20 & \cr\hline
\end{array}
$$

对于 $100\%$ 的数据，$2\le n \le 2 \times 10^5$， $n-1 \le m \le 10^6$，$0 \le a_i$，$b_i$，$c_i \le 10^6$。

数据保证最小价格在 $\tt{long \ long}$ 范围内。

#### 说明

本题有 $\text{spj}$，价格正确可以获得 $30\%$ 的分数。每个 $\text{subtask}$ 取其中所有数据点得分的最小值。

如果你不会构造方案，也请你再输出最小价格后输出 $m$ 行，每行两个 $[1,n]$ 范围内的整数，防止 $\text{spj}$ 出现错误。

本题已添加 hack 数据，为 $\text{subtask7}$，该 $\text{subtask}$ 不计分数，但会影响是否 $\text{AC}$。

## 样例 #1

### 输入

```
4 4
1 2 3
2 3 4
3 4 5
4 5 6```

### 输出

```
114
1 2
1 2
1 3
3 4```

# AI分析结果



---

## 算法分类
**贪心算法、堆优化、构造**

---

## 题解思路与难点分析

### 核心思路
1. **度数分配贪心**：每个小镇的度数分配与其费用函数相关。用优先队列维护每个小镇修建下一条公路的增量费用，每次选最小增量。
2. **构造连通图**：将度数最小的点与最大的点连边，保证连通性且无自环。

### 解决难点
- **堆维护动态增量**：每次从堆中取出当前费用最小的点，更新其度数后重新计算下一条边的费用。
- **构造策略证明**：通过数学反证法证明构造方法的正确性，确保连边过程不会形成自环且保持连通。

---

## 题解评分
### uuku 题解（5星）
- **思路清晰**：明确指出度数分配与费用函数的独立性，提出堆维护策略。
- **构造严谨**：通过数学证明保证连通性和无自环，提供可行构造方法。
- **代码高效**：堆优化实现时间复杂度 $O(m \log n)$，适用于大数据范围。

---

## 最优思路提炼
1. **贪心堆维护**：每个点的费用增量是二次函数，用优先队列动态选择最小增量。
2. **度数极值连边**：构造时连接当前度数最小和最大的点，确保连通性。
3. **边界条件处理**：通过 `v[i].cnt--` 修正初始度数分配，避免溢出。

---

## 类似题目
1. **P3366 最小生成树**：贪心选择边，使用并查集维护连通性。
2. **P1090 合并果子**：堆优化贪心选择最小代价合并。
3. **P1546 最短网络 Agri-Net**：Kruskal算法与堆优化结合。

---

## 关键代码解析
```cpp
priority_queue<pli, vector<pli>, greater<pli>> q;
// 堆维护每个点的下一条边费用
for(int i = 1; i <= n; ++i) q.push(make_pair(v[i].get(), i));

while(du--) {
    now = q.top(); q.pop();
    ans += now.first;
    if(v[now.second].cnt < m) // 防止超过m条边
        q.push({v[now.second].get(), now.second});
}

// 构造连边
sort(v + 1, v + n + 1, cmp); // 按当前度数排序
int l = 1, r = n;
while(l < r) {
    cout << v[r].id << ' ' << v[l].id << '\n';
    v[r].cnt--, v[l].cnt--; // 更新度数
    if(v[l].cnt == 0) l++;
    if(v[r].cnt == 0) r--;
}
```

---

## 可视化设计
### 动态堆操作
- **颜色标记**：当前堆顶元素高亮为红色，连边操作中的两个点标记为绿色和蓝色。
- **步进控制**：用户可单步执行堆的弹出与压入，观察度数分配过程。
- **Canvas 网格**：用方格表示每个小镇，高度表示当前度数，颜色深浅表示费用。

### 复古像素风格
- **8位音效**：堆弹出时播放“滴”声，连边时播放“哔”声。
- **自动演示模式**：AI 按最优路径自动分配度数并连边，背景播放芯片音乐。
- **积分系统**：每正确分配一个度数得10分，错误操作扣分，积分影响背景音乐速度。

---

## 总结
通过贪心堆优化动态选择最小费用增量，结合极值连边构造，在保证连通性和无自环的条件下最小化总费用。其核心在于将复杂图论条件转化为度数分配的数学问题，并通过高效数据结构实现。

---
处理用时：65.34秒
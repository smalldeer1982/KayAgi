# 题目信息

# [JLOI2014] 松鼠的新家

## 题目描述

松鼠的新家是一棵树，前几天刚刚装修了新家，新家有$n$ 个房间，并且有 $n-1$ 根树枝连接，每个房间都可以相互到达，且俩个房间之间的路线都是唯一的。天哪，他居然真的住在“树”上。

松鼠想邀请小熊维尼前来参观，并且还指定一份参观指南，他希望维尼能够按照他的指南顺序，先去 $a_1$，再去 $a_2$，……，最后到 $a_n$，去参观新家。可是这样会导致重复走很多房间，懒惰的维尼不停地推辞。可是松鼠告诉他，每走到一个房间，他就可以从房间拿一块糖果吃。

维尼是个馋家伙，立马就答应了。现在松鼠希望知道为了保证维尼有糖果吃，他需要在每一个房间各放至少多少个糖果。

因为松鼠参观指南上的最后一个房间 $a_n$ 是餐厅，餐厅里他准备了丰盛的大餐，所以当维尼在参观的最后到达餐厅时就不需要再拿糖果吃了。

## 说明/提示

对于全部的数据，$2 \le n \le 3 \times 10^5$，$1 \le a_i \le n$。

## 样例 #1

### 输入

```
5
1 4 5 3 2
1 2
2 4
2 3
4 5```

### 输出

```
1
2
1
2
1```

# AI分析结果



# 算法分类  
**树上差分**

# 题解思路与核心分析  
## 核心算法流程  
1. **路径标记**：遍历访问序列，对每对相邻节点 `a[i]` 到 `a[i+1]` 的路径进行差分标记  
2. **LCA处理**：用倍增法求两节点最近公共祖先（LCA）  
3. **四元差分操作**：  
   ```c++  
   T[u]++, T[v]++, T[lca]--, T[father[lca]]--  
   ```  
4. **DFS统计**：通过一次DFS后序遍历累加子树差分值  

## 解决难点  
1. **重复计算**：所有中间节点被作为路径终点和起点各计算一次，最终需对 `a[2]~a[n]` 减1  
2. **餐厅特殊处理**：路径末节点需单独减1（通过统一减1操作实现）  
3. **高效路径更新**：差分标记避免了暴力遍历路径的O(n²)复杂度  

# 题解评分  
1. **dzz1537568241（5星）**  
   - 亮点：深度解析差分思想，可视化示例清晰，代码包含完整LCA实现  
   - 心得："学农时还要写题解" 体现实践与理论结合  

2. **asuldb（4星）**  
   - 亮点：代码注释明确，直接指出重复计算问题的解决方案  
   - 缺点：差分原理说明较简略  

3. **hyfhaha（4星）**  
   - 亮点：树剖+线段树实现完整，注释幽默（"小熊维尼啊，嘿嘿嘿"）  
   - 缺点：时间复杂度较高（O(n log²n)）  

# 关键代码实现  
```c++  
// 树上差分核心操作
void modify(int u, int v) {
    int lc = lca(u, v);
    T[u]++; T[v]++;
    T[lc]--;
    if(fa[lc]) T[fa[lc]]--;
}

// DFS统计子树和
void dfs_sum(int u) {
    for(int v : G[u]) {
        if(v == fa[u]) continue;
        dfs_sum(v);
        T[u] += T[v];
    }
}

// 主流程
for(int i=1; i<n; ++i) 
    modify(a[i], a[i+1]);
dfs_sum(root);
for(int i=2; i<=n; ++i) T[a[i]]--;
```

# 可视化设计  
## 动画方案  
1. **路径分解**：  
   - 红色高亮当前处理的路径 `a[i]->a[i+1]`  
   - 黄色闪烁显示LCA节点  
   - 绿色粒子效果表示差分标记传播  

2. **差分过程**：  
   ![差分演示](https://i.imgur.com/7XfWg3Q.gif)  
   - 步骤1：`T[u]++`（节点变红）  
   - 步骤2：`T[v]++`（节点变红）  
   - 步骤3：`T[lca]--`（LCA节点变蓝）  
   - 步骤4：`T[father[lca]]--`（父节点变蓝）  

3. **复古风格**：  
   - 8-bit音效：  
     - `哔~`（找到LCA）  
     - `叮~`（完成路径标记）  
   - 像素化节点图标（16x16像素）  
   - 背景音乐：FC版《松鼠大作战》BGM循环  

# 相似题目推荐  
1. [P3250/洛谷] 树上游戏（路径覆盖统计）  
2. [P2680/洛谷] 运输计划（最大路径优化+差分）  
3. [P1600/洛谷] 天天爱跑步（复杂路径标记+深度分析）  

# 思维拓展  
**差分本质**：将路径操作转化为端点操作，通过子树累加恢复真实值。该思想可拓展至：  
- 多维空间覆盖问题  
- 动态路径权重调整  
- 网络流量统计  

**调试技巧**：当差分结果异常时，可单独打印每个节点的四元操作记录，验证LCA计算与差分标记是否正确。

---
处理用时：66.22秒
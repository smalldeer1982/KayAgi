# 题目信息

# 「Wdoi-5」模块化核熔炉

## 题目背景

为了通过使用核聚变获得能源，守矢神社在旧地狱修建了巨大的核融合控制中心。控制中心形如双层八卦炉，通过各种电路紧密地调控着核融合的精密运行。获得了八咫鸟力量的阿空会在核反应炉的中心点燃神火。

但是正八边形的八卦炉并不利于进行拓展与维护。为了方便地实现电路，河童打算对核控制中心进行模块化改造，以实现核熔炉的维护。具体而言，河童打算将核控制中心设计成由若干个正六边形组成的巨大结构。

![](https://cdn.luogu.com.cn/upload/image_hosting/ohyfxv02.png)

被赋予了神力的阿空可以依次激发其中的一些模块，而这些被激发的模块会快速影响到一定范围内的其他的模块。通过模块间的链接实现能量的产生。

但是因为阿空脑袋空空，由于它已经激发了多次模块，它已经记不清每个模块当中产生的核融合程度了。你能帮帮它吗？

## 题目描述

核控制中心可以看作由若干个正六边形模块组成的六边形阵列。阵列当中每个模块都可以储存核融合能量（一个非负整数）。左图就是一个核控制中心示意图。

![](https://cdn.luogu.com.cn/upload/image_hosting/78y7b98x.png)

我们使用如下方式对控制中心中每个模块进行标号。

![](https://cdn.luogu.com.cn/upload/image_hosting/9ffz2m5o.png)

以阵列中心为原点延伸出三根射线作为三根轴，每两根轴之间的夹角为 $120\degree$。这三根轴将平面划分为了三个部分。每个模块都可以使用一个三元组 $(x,y,z)$ 描述它的坐标，表示从原点开始按如图所示的 $x,y,z$ 方向各走若干步之后到达的地方。为了防止出现多个坐标表示同一个模块的情况，做出如下规定：原点的坐标为 $(0,0,0)$；对于中心在坐标轴上的模块，它的坐标就是从原点向所在轴走过的距离；对于其他情况，我们将平面划分为了三个区域（如第二张图的红蓝绿三个区域），一个模块的坐标就是沿着它两侧的轴分别需要走的距离。例如模块 $P$ 的坐标为 $(2,4,0)$。容易发现，每个坐标唯一对应一个模块，一个模块唯一对应一个坐标。

同时定义，两个模块的**距离**为从一个模块到另一个模块需要经过模块（包括起点和终点）的最少个数。在第一张图中，红色部分的模块到其中心距离均不超过 $3$，绿色部分的模块到其中心距离均不超过 $3$，而蓝色部分的模块到其中心距离均不超过 $2$。

核控制中心可以视为到达原点距离不超过 $n$ 的模块组成的阵列。现在阿空会执行以下操作 $m$ 次：

- $\colorbox{f0f0f0}{\verb!x y z r k!}$ ：激活坐标为 $(x,y,z)$ 的模块。它会使控制中心中到它距离不超过 $r$ 的**所有**的模块的核融合能量增加 $k$。保证 $(x,y,z)$ 在控制中心当中。

现在需要求出，执行完 $m$ 个操作后，每个模块里核融合能量值。

## 说明/提示

样例 $2$ 见下发的附件 $\textbf{\textit{nuclear2.in/nuclear2.ans}}$。  
样例 $3$ 见下发的附件 $\textbf{\textit{nuclear3.in/nuclear3.ans}}$。满足特殊性质 $\text{A}$（见下文）。  
样例 $4$ 见下发的附件 $\textbf{\textit{nuclear4.in/nuclear4.ans}}$。满足特殊性质 $\text{B}$（见下文）。  
样例 $5$ 见下发的附件 $\textbf{\textit{nuclear5.in/nuclear5.ans}}$。

#### 样例 1 解释

如图所示（所有未标出数字的模块的核融合能量值均为 $0$）：

![](https://cdn.luogu.com.cn/upload/image_hosting/6y7bm2eb.png)



按照从左往右、从上往下的顺序依次输出每个数值，即可得到答案。

#### 数据范围及约定

本题共有 $20$ 个测试点，每个测试点 $5$ 分。最终分数为所有测试点分数之和。

$$
\def\arraystretch{1.5}
\begin{array}{|c|c|c|c|}\hline
\textbf{Task} & \bm{n\le } & \bm{m\le} & \textbf{特殊性质} \cr\hline
1\sim 3 & 10 & 10 & \text{A} \cr\hline
4\sim 7 & 100 & 300 & - \cr\hline
8\sim 10 & 800 & 3\times 10^5 & \text{B} \cr\hline
11\sim 14 & 800 & 3\times 10^5 & \text{A} \cr\hline
15\sim 20 & 800 & 3\times 10^5 & - \cr\hline
\end{array}
$$

**特殊性质** $\textbf{A}$：保证对于第 $i$ 次操作，被激活的模块到控制中心边缘上的模块的距离不小于 $r_i$。  
**特殊性质** $\textbf{B}$：保证对于第 $i$ 次操作，被激活的模块均为 $(0,0,0)$。

对于全部数据，保证 $n\le 800$，$m\le 3\times 10^5$，$1\le k_i\le 5\times 10^3$，$1\le r_i\le 10^9$。每次激活的模块都在控制中心里。

## 样例 #1

### 输入

```
4 3
0 1 1 3 4
3 0 3 3 3
1 0 0 2 2```

### 输出

```
4 4 4 0 4 4 4 4 3 4 4 4 4 7 3 0 4 4 6 9 3 3 0 4 6 6 5 3 0 0 2 2 3 0 0 0 0```

# AI分析结果



---

## 唯一算法分类  
**差分/前缀和与坐标转换**

---

## 综合分析与结论  

### 核心思路与难点  
1. **问题本质**：在正六边形网格上高效执行多次正六边形区域加操作，最终求各点值。  
2. **核心难点**：  
   - 六边形的几何特性难以直接应用传统二维差分。  
   - 数据规模大（n=800, m=3e5），需 O(m + n²) 复杂度。  
3. **解法核心**：  
   - **坐标转换**：将六边形网格映射到两个斜坐标系（左系和右系），使正六边形区域转化为平行四边形或矩形。  
   - **二维差分**：在转换后的坐标系中对矩形区域应用差分标记，最终前缀和恢复结果。  

### 可视化设计思路  
- **动画演示步骤**：  
  1. 显示原始六边形网格及操作区域。  
  2. 分解操作区域为左系和右系中的两个矩形，用不同颜色标记。  
  3. 展示差分标记过程（四个角点加减），用高亮色标注操作点。  
  4. 逐步前缀和恢复，最终合并两个坐标系的结果。  
- **复古像素风格**：  
  - 六边形网格用 8 位色块表示，坐标轴用对比色标出。  
  - 差分操作时播放“滴”音效，前缀和恢复时用渐变色填充。  
- **交互控制**：支持暂停/步进观察差分标记细节，速度调节适应学习节奏。  

---

## 题解清单（≥4星）  

1. **囧仙（★★★★☆）**  
   - **亮点**：详细图解坐标转换，代码实现简洁，逻辑清晰。  
   - **关键代码**：通过 `cnv1` 和 `cnv2` 函数实现坐标转换，二维差分标记。  

2. **WYXkk（★★★★☆）**  
   - **亮点**：提出斜坐标系拆分思路，强调差分标记的边界处理。  
   - **心得**：“直角型可拆分为横条和竖条，分别处理差分”。  

3. **zhongcy（★★★★☆）**  
   - **亮点**：完整代码实现，注释清晰，处理越界严谨。  
   - **代码结构**：分两个坐标系处理差分，最终合并结果。  

---

## 最优思路与技巧提炼  

### 关键步骤  
1. **坐标转换**：  
   - **左系**：标准坐标 (x,y,z) → (x-z+n, y-x+n)  
   - **右系**：标准坐标 (x,y,z) → (x-z+n, y-z+n)  
2. **差分标记**：  
   - 在左系和右系中分别对矩形区域的四角进行加减标记。  
3. **前缀和恢复**：  
   - 按行/列顺序进行前缀和，合并两坐标系结果。  

### 代码片段（zhongcy 题解核心）  
```cpp  
// 坐标转换为左系  
p = x - z + n; q = y - x + n;  
a[p][min(d,q+r-1)] -= k;  
a[max(1,p-r+1)][min(d,q+r-1)] += k;  
// ...类似处理其他边界  

// 右系同理  
p = x - z + n; q = y - z + n;  
b[p][min(d,q+r-1)] += k;  
b[min(d+1,p+r)][min(d,q+r-1)] -= k;  
// ...  

// 前缀和恢复  
for(int i=1;i<=d;i++) for(int j=1;j<=d;j++) a[i][j] += a[i-1][j];  
for(int i=1;i<=d;i++) for(int j=d;j>=1;j--) a[i][j] += a[i][j+1];  
```

---

## 类似题目推荐  

1. **P3397 地毯**  
   - 二维差分模板题，适合练习矩形区域加减。  

2. **P2280 [HNOI2003]激光炸弹**  
   - 二维前缀和求最大子矩阵和。  

3. **P2038 无线网络发射器选址**  
   - 二维区间加与查询，结合最值统计。  

---

## 可视化与游戏化设计  

### Canvas 动画设计  
- **六边形绘制**：用六边形网格库绘制初始状态，操作区域闪烁提示。  
- **坐标轴高亮**：左系和右系的坐标轴用红色/蓝色区分。  
- **差分标记特效**：标记点时显示“+k”/“-k”浮动文字，伴随音效。  

### 复古像素风格  
- **调色板**：使用 16 色，六边形用青/紫，操作用红/蓝。  
- **音效设计**：  
  - 标记差分：8-bit “哔”声。  
  - 完成操作：经典 FC 过关音效。  

### AI 自动演示  
- **自动播放模式**：按步骤展示坐标转换→差分→前缀和。  
- **关卡设计**：  
  - 关卡1：单个操作区域分解。  
  - 关卡2：多操作叠加后的结果合并。  

---

**通过坐标转换与差分技巧，将复杂几何问题转化为高效计算问题，是处理网格类题目的经典思路。**

---
处理用时：69.99秒
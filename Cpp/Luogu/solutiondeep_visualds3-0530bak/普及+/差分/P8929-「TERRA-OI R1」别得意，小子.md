# 题目信息

# 「TERRA-OI R1」别得意，小子

## 题目背景

战至中途，蓝紫色天空瞬间变为黑压压一片，噬神者身上一些紫色外壳开始脱落，化为更小的蟒蛇，这些小家伙从出现开始便不要命的向你冲过来，刚清理掉这些小家伙，迷雾中忽然涌现出一张血盆大口，噬神者正向你冲击而来......

## 题目描述

现给定一个有 $n$ 段的分段函数，每一段可能是一个一次函数或者一个二次函数，并有 $q$ 次询问，每次询问 $x=k$ 时 $y$ 的取值或是 $y=k$ 与函数有多少个交点。



## 说明/提示

#### 【样例解释 #1】

三段函数分别为 $y=x+2$，$y=x^2-2x+1$，$y=x$。

对于当 $x=4$ 时套入第二段函数可以得到结果为 $9$。

而直线 $y=5$ 只与第一段与第二段函数相交，并且各只有一个交点，所以结果为 $2$。

显而易见，第三个询问对应的直线不与函数相交。

第四个询问虽然与第一段函数交于 $x=0$ 的位置，但 $0$ 不在该函数区间内，故舍去。

------------

#### 【数据范围】

**本题采用捆绑测试。**

| Subtask | Score | $n,q\le$ | limit |
| :----------: | :----------: | :----------: | :----------: |
| $1$ | $10$ | $100$ | 无 |
| $2$ | $15$ | $10^3$ | $r_n\le 5\times 10^3$ |
| $3$ | $20$ | $2\times 10^5$ | 不存在询问 $2$ |
| $4$ | $25$ | $2\times 10^5$ | 不存在二次函数 |
| $5$ | $30$ | $2\times 10^5$ | 无 |

对于 $100\%$ 的数据，$1\le n,q\le 2\times 10^5$，$0\le l_i,r_i\le10^9$，$\forall i\in [1,n],r_i>l_i$ 。

所有的函数系数均在 **$64$ 位有符号整型变量**存储范围内，并且运算结果与每个函数式中任何一项的最大值与最小值不会超过 **$64$ 位有符号整型变量**存储范围。所有询问参数均在 **$32$ 位有符号整型变量**范围内。

（即 $-4\times 10^{18}\le k,a,b,c\le 4\times 10^{18}$，$-10^9\le x\le 10^9$）

------------
#### 【提示】

采用浮点数据时建议使用 long double，避免产生精度问题。

upd：添加一组 hack 数据，未通过会显示为“Unaccepted 100pts”。

## 样例 #1

### 输入

```
3 4
0 3 1 1 2
3 6 2 1 -2 1
6 10 1 1 0
1 4
2 5
2 114514
2 2```

### 输出

```
9
2
0
0```

## 样例 #2

### 输入

```
6 8
0 4 2 1 -4 0 
4 6 1 2 -10 
6 11 1 1 -19 
11 19 2 -1 -30 559 
19 29 1 1 -58 
29 38 1 1 -68 
1 11
2 4
2 -1
1 21
2 -5
2 2
1 34
2 1
```

### 输出

```
-8
1
4
-37
1
2
-34
2
```

# AI分析结果



## **算法分类**  
- 离散化与差分数组

---

## **题解思路、算法要点与解决难点**  
### **核心思路**  
1. **询问1 (x=k)**：二分查找k所在区间，代入对应函数计算。  
2. **询问2 (y=k)**：对每个函数的值域区间进行差分标记，预处理后通过前缀和快速查询。

### **关键步骤与难点**  
- **一次函数处理**：根据单调性确定值域区间 `[min, max]`，用差分标记覆盖的y值。  
- **二次函数处理**：  
  - **对称轴在区间外**：视为单调函数，直接处理值域。  
  - **对称轴在区间内**：拆分为两段单调区间，分别计算值域。  
  - **顶点精度处理**：判断顶点是否为整数，调整差分标记的开闭区间。  
- **离散化优化**：使用`map`或排序后的数组存储差分标记点，避免存储全部值域。

### **对比与优化**  
- **MCRS_lizi**：通过`map`自动离散化，处理二次函数顶点时用浮点精度判断是否为整数。  
- **jifbt**：直接拆分二次函数为两段，用排序后的差分数组高效查询。  
- **kbtyyds**：离散化后构建差分数组，分类讨论对称轴位置。  
- **聊机**：动态开点线段树（效率较低，不适用于大数据）。

---

## **题解评分 (≥4星)**  
1. **MCRS_lizi (5星)**  
   - 思路清晰，利用`map`离散化差分标记。  
   - 精准处理二次函数顶点精度问题。  
   - 代码可读性高，时间复杂度最优。  

2. **jifbt (4星)**  
   - 代码简洁，直接拆分二次函数为两段。  
   - 使用排序差分数组高效查询。  
   - 数学细节处理到位，但注释较少。  

3. **kbtyyds (4星)**  
   - 详细分类讨论二次函数值域。  
   - 离散化结合差分数组，逻辑严谨。  
   - 代码较长，但注释丰富。

---

## **最优思路或技巧提炼**  
1. **二次函数拆分**：将对称轴在区间内的二次函数拆分为两段单调区间处理。  
2. **顶点精度处理**：通过浮点误差判断顶点是否为整数，调整差分标记。  
3. **离散化差分**：用`map`或排序数组存储标记点，避免存储全部值域。  
4. **前缀和优化**：预处理差分数组为前缀和数组，单次查询时间复杂度O(1)。

---

## **同类型题或类似算法套路**  
- **分段函数处理**：通过离散化与差分覆盖区间（如 [CF1795D](https://codeforces.com/problemset/problem/1795/D)）。  
- **值域区间统计**：利用差分数组快速统计覆盖次数（如 [洛谷P3406](https://www.luogu.com.cn/problem/P3406)）。  
- **二次函数分类讨论**：对称轴位置与值域分析（如 [洛谷P1024](https://www.luogu.com.cn/problem/P1024)）。

---

## **推荐题目**  
1. [P1024 一元三次方程求解](https://www.luogu.com.cn/problem/P1024)  
2. [P3406 海底高铁](https://www.luogu.com.cn/problem/P3406)  
3. [CF1795D Toy Factory](https://codeforces.com/problemset/problem/1795/D)

---

## **个人心得摘录**  
- **MCRS_lizi**：  
  > “二次函数顶点是否为整数需要特别判断，否则会多算或少算交点。”  
- **聊机**：  
  > “动态开点线段树虽然直观，但内存和时间效率无法承受本题数据规模。”

---

## **可视化与算法演示**  
### **动画设计**  
1. **分步骤展示**：  
   - **Step 1**：绘制分段函数图像，高亮当前处理的函数段（红色为一次函数，蓝色为二次函数）。  
   - **Step 2**：对二次函数，动态绘制对称轴并拆分为两段（绿色虚线为对称轴）。  
   - **Step 3**：显示值域区间覆盖范围（半透明色块），并在右侧生成差分标记点。  
   - **Step 4**：用户输入y=k时，高亮覆盖区间，显示最终交点数。  

2. **复古像素风格**：  
   - **颜色方案**：红（一次函数）、蓝（二次函数）、绿（对称轴）、黄（覆盖区间）。  
   - **音效**：  
     - `标记生成`：8-bit “滴”声。  
     - `查询命中`：上扬音效。  
     - `无交点`：低沉音效。  

3. **交互控制**：  
   - **速度调节**：滑块控制动画速度。  
   - **单步执行**：手动触发拆分、标记、查询步骤。  

### **代码片段（关键逻辑）**  
```cpp
// 二次函数拆分与标记（MCRS_lizi 解法）
void tag(int x) {
    double mid = -b/(2.0*a); // 对称轴
    if (mid 在区间外) {
        处理单调区间;
    } else {
        double top = a*mid*mid + b*mid + c; // 顶点值
        if (顶点是整数) {
            调整差分标记开闭;
        }
        拆分左右区间并标记;
    }
}
```

---

## **总结**  
通过离散化差分与精准数学处理，将复杂的分段函数问题转化为高效区间统计问题。核心在于拆分二次函数值域并处理顶点精度，最终通过前缀和实现O(1)查询。

---
处理用时：71.26秒
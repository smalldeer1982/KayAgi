# 题目信息

# [USACO21JAN] Dance Mooves S

## 题目描述

Farmer John 的奶牛们正在炫耀她们的最新舞步！

最初，所有的 $N$ 头奶牛（$2≤N≤10^5$）站成一行，奶牛 $i$ 排在其中第 $i$ 位。舞步序列给定为 $K$ （$1≤K≤2\times10^5$）个位置对 $(a_1,b_1),(a_2,b_2),…,(a_K,b_K)$。在舞蹈的第 $i=1…K$ 分钟，位置 $a_i$ 与 $b_i$ 上的奶牛交换位置。同样的 $K$ 次交换在第 $K+1…2K$ 分钟发生，在第 $2K+1…3K$ 分钟再次发生，以此类推，无限循环。换言之， 

 - 在第 $1$ 分钟，位置 $a_1$ 与 $b_1$ 上的奶牛交换位置。
 - 在第 $2$ 分钟，位置 $a_2$ 与 $b_2$ 上的奶牛交换位置。
 - ……
 - 在第 $K$ 分钟，位置 $a_K$ 与 $b_K$ 上的奶牛交换位置。
 - 在第 $K+1$ 分钟，位置 $a_1$ 与 $b_1$ 上的奶牛交换位置。
 - 在第 $K+2$ 分钟，位置 $a_2$ 与 $b_2$ 上的奶牛交换位置。
 - 以此类推……

对于每头奶牛，求她在队伍中会占据的不同的位置数量。

## 说明/提示

 - 奶牛 $1$ 可以到达位置 $\{1,2,3,4\}$。
 - 奶牛 $2$ 可以到达位置 $\{1,2,3,4\}$。
 - 奶牛 $3$ 可以到达位置 $\{1,2,3\}$。
 - 奶牛 $4$ 可以到达位置 $\{1,2,3,4\}$。
 - 奶牛 $5$ 从未移动，所以她没有离开过位置 $5$。

#### 测试点性质：

 - 测试点 1-5 满足 $N≤100,K≤200$。
 - 测试点 6-10 满足 $N≤2000,K≤4000$。
 - 测试点 11-20 没有额外限制。

供题：Chris Zhang 

## 样例 #1

### 输入

```
5 4
1 3
1 2
2 3
2 4```

### 输出

```
4
4
3
4
1```

# AI分析结果



### 算法分类
置换环与并查集/DFS结合

---

### 题解思路与核心难点
**核心思路**：  
1. **一轮交换后形成置换环**：每头牛经过一轮K次交换后会到达新位置，所有位置构成置换环，环内牛的移动轨迹相同。  
2. **路径记录**：在每轮交换过程中，实时记录每头牛经过的位置。  
3. **环内集合合并**：同一置换环内的牛共享所有经过的位置，需合并这些位置集合。  

**解决难点**：  
- **高效合并路径集合**：直接模拟无限次交换不可行，需利用置换环特性将问题转化为有限次计算。  
- **数据结构优化**：使用并查集或DFS快速找到环，并用集合（如`set`）避免重复计数。  

---

### 题解评分 (≥4星)
1. **Skies的题解（5星）**  
   - **亮点**：利用并查集维护置换环，`vector`记录路径，`set`去重，代码简洁高效。  
   - **代码可读性**：逻辑清晰，注释明确。  

2. **Lonely_NewYear的题解（4星）**  
   - **亮点**：动态处理路径计数，避免重复初始化，时间复杂度优化至O(N+K)。  
   - **技巧**：通过`cnt`数组增量统计环内位置数量。  

3. **Aiopr_2378的题解（4星）**  
   - **亮点**：置换环与`set`结合，代码简短，逻辑直观。  
   - **优化**：直接记录最终位置并构建环，减少冗余计算。  

---

### 最优思路与技巧
1. **置换环检测**：通过并查集或DFS找出环结构，合并环内路径集合。  
2. **动态路径记录**：在每轮交换中实时记录位置，避免全量模拟。  
3. **集合去重**：使用`set`或`vector+排序去重`统计唯一位置数。  

**关键代码片段**（Skies的题解核心部分）：  
```cpp
// 模拟交换并记录路径
for (int i=1; i<=k; i++) {
    int x, y; scanf("%d%d", &x, &y);
    swap(a[x], a[y]);
    vc[a[x]].push_back(x);  // 记录交换后的位置
    vc[a[y]].push_back(y);
}

// 并查集合并置换环
for (int i=1; i<=n; i++) {
    int fx = find(i), fy = find(a[i]);
    if (fx != fy) fa[fx] = fy;
}

// 合并环内所有路径到set
for (int i=1; i<=n; i++) {
    for (auto pos : vc[i]) {
        ans[find(i)].insert(pos);
    }
}
```

---

### 类似题目与套路
- **P5149 会议座位**：置换环与逆序对计数。  
- **P2661 信息传递**：寻找最小环长度。  
- **P1522 牛的旅行**：图的连通性与路径合并。  

---

### 可视化与算法演示
**动画设计**：  
1. **置换环绘制**：以节点表示牛，箭头指向下一轮位置，不同环用颜色区分。  
2. **路径记录高亮**：每次交换时，高亮被交换的两个位置，并在对应牛的路径集合中添加新位置。  
3. **集合合并效果**：环内所有节点的路径集合动态合并，展示`set`去重过程。  

**复古像素风格**：  
- **颜色方案**：使用8位色（如红、蓝、绿）区分不同环。  
- **音效触发**：  
  - 每次交换时播放“哔”声。  
  - 环合并完成时播放“叮”声。  
- **Canvas动画**：网格展示牛的位置，环内节点以像素方块闪烁。  

---

### 个人心得摘录
- **路径记录顺序**：需注意交换后立即记录位置，否则会遗漏中间状态。  
- **环检测优化**：并查集比DFS更节省内存，适合大规模数据。  

---

### 推荐题目
1. [P5149 会议座位](https://www.luogu.com.cn/problem/P5149)  
2. [P2661 信息传递](https://www.luogu.com.cn/problem/P2661)  
3. [P1522 牛的旅行](https://www.luogu.com.cn/problem/P1522)  

--- 

**总结**：本题通过置换环与路径合并，高效解决了无限循环交换的位置统计问题，核心在于环结构的检测与集合操作的优化。

---
处理用时：93.69秒
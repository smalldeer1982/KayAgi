# 题目信息

# [NOI2011] 兔农

## 题目描述

农夫栋栋近年收入不景气，正在他发愁如何能多赚点钱时，他听到隔壁的小朋友在讨论兔子繁殖的问题。

问题是这样的：第一个月初有一对刚出生的小兔子，经过两个月长大后，这对兔子从第三个月开始，每个月初生一对小兔子。新出生的小兔子生长两个月后又能每个月生出一对小兔子。问第 $n$ 个月有多少只兔子？

聪明的你可能已经发现，第 $n$ 个月的兔子数正好是第 $n$ 个 Fibonacci（斐波那契）数。栋栋不懂什么是 Fibonacci 数，但他也发现了规律：第 $i+2$ 个月的兔子数等于第 $i$ 个月的兔子数加上第 $i+1$ 个月的兔子数。前几个月的兔子数依次为：

$$1,1,2,3,5,8,13,21,34,\ldots$$

栋栋发现越到后面兔子数增长的越快，期待养兔子一定能赚大钱，于是栋栋在第一个月初买了一对小兔子开始饲养。

每天，栋栋都要给兔子们喂食，兔子们吃食时非常特别，总是每 $k$ 对兔子围成一圈，最后剩下的不足 $k$ 对的围成一圈，由于兔子特别害怕孤独，从第三个月开始，如果吃食时围成某一个圈的只有一对兔子，这对兔子就会很快死掉。

我们假设死去的总是刚出生的兔子，那么每个月的兔子数仍然是可以计算的。例如，当 $k=7$ 时，前几个月的兔子数依次为：

$$1,1,2,3,5,7,12,19,31,49,80,\ldots$$

给定 $n$，你能帮助栋栋计算第 $n$ 个月他有多少对兔子么？由于答案可能非常大，你只需要告诉栋栋第 $n$ 个月的兔子对数除 $p$ 的余数即可。


## 说明/提示

|测试点编号|$n$|$k,p$|
|:-:|:-:|:-:|
|$1\sim 10$|$1\leq n\leq 50$|$2\leq k,p\leq1000$|
|$11$|$1\leq n\leq 80$|$2\leq k,p\leq 10^4$|
|$12,13$|$1\leq n\leq 1000$|$2\leq k,p\leq 10^4$|
|$14,15$|$1\leq n\leq 10^6$|$2\leq k,p\leq 10^6$|
|$16,17$|$1\leq n\leq 10^{18}$|$2\leq k,p\leq1000$|
|$18\sim 20$|$1\leq n\leq 10^{18}$|$2\leq k\leq 10^6$，$2\leq p\leq 10^9$|

对于 $100\%$ 的数据，$1\leq n\leq 10^{18}$，$2\leq k\leq 10^6$，$2\leq p\leq 10^9$。


## 样例 #1

### 输入

```
6 7 100```

### 输出

```
7```

## 样例 #2

### 输入

```
7 7 5```

### 输出

```
2```

# AI分析结果



# 算法分类
**矩阵快速幂 + 循环节探测**

---

## 题解思路与算法要点

### 核心思路
1. **分段递推**：将斐波那契数列按模 `k` 后出现 `1` 的位置分段，每段以相同起始数开始，满足 `x * fib(len) ≡ 1 (mod k)`，其中 `x` 是段起始数，`len` 是段长度。
2. **逆元与循环节**：利用扩展欧几里得算法判断是否存在逆元，若无逆元则进入死循环；否则预处理每段的起始数与长度，探测循环节。
3. **矩阵快速幂加速**：构建两种转移矩阵：
   - `tr1`：普通斐波那契递推矩阵。
   - `tr2`：包含减一操作的递推矩阵。
4. **分段处理**：分为循环节前、循环节内、剩余部分三个阶段，分别用矩阵快速幂加速计算。

### 解决难点
- **循环节探测**：通过预处理斐波那契数列模 `k` 的值，找到每个段的起始数对应的 `len`，记录顺序并检测循环。
- **无逆元处理**：当 `x` 与 `k` 不互质时，直接进入线性递推模式，避免死循环。
- **矩阵状态维护**：通过三维矩阵（包含常数项 `1`）处理减一操作，统一递推逻辑。

---

## 题解评分（≥4星）

### 1. TimWYZ（5星）
- **亮点**：完整推导循环节性质，清晰解释逆元与斐波那契段的关系，代码结构清晰。
- **代码可读性**：模块化处理矩阵运算，分段逻辑明确。
- **优化技巧**：预处理 `len[x]` 减少重复计算。

### 2. zqy1018（4星）
- **亮点**：简洁预处理斐波那契模数，代码紧凑。
- **实现技巧**：利用 `getinv` 快速计算逆元，优化循环节探测。

### 3. wlzhouzhuan（4星）
- **亮点**：矩阵实现高度优化，复古风格代码展示，预计算循环节长度。
- **优化技巧**：利用 `6k` 的斐波那契循环节长度上界，减少预处理时间。

---

## 最优思路与技巧提炼

### 关键技巧
1. **逆元与斐波那契段**：通过 `x * fib(len) ≡ 1 (mod k)` 反推段长度，利用扩展欧几里得算法快速计算。
2. **矩阵状态设计**：
   ```cpp
   // 普通递推矩阵 tr1
   [[1, 1, 0],
    [1, 0, 0],
    [0, 0, 1]]
   // 减一递推矩阵 tr2
   [[1, 1, 0],
    [1, 0, 0],
    [-1, 0, 1]]
   ```
3. **循环节跳跃**：将循环节的矩阵乘积预计算，快速幂处理大段循环。

### 代码片段（TimWYZ 核心逻辑）
```cpp
// 预处理段长度 len[x]
for (ll i = 3; ; i++) {
    f[i] = (f[i - 1] + f[i - 2]) % k;
    if (f[i] % k == 1 && len[1] > 1e18) len[1] = i;
    ll inv = getInv(f[i], k);
    if (inv != -1) len[inv % k] = min(len[inv % k], i);
}

// 矩阵快速幂处理分段
mat = mat * quickPower(tr1, len[seq[i]] - 1) * tr2;
```

---

## 相似题目推荐
1. **P1306 斐波那契公约数**（斐波那契性质与GCD结合）
2. **P1962 斐波那契数列**（矩阵快速幂模板题）
3. **P5175 数列**（含模运算的递推数列）

---

## 可视化与算法演示

### 动画设计
1. **像素风格界面**：
   - **网格显示**：每个格子表示一个月，颜色区分不同段（如蓝色为循环节前，绿色为循环节）。
   - **高亮当前段**：闪烁显示正在计算的段起始位置。
2. **矩阵运算动画**：
   - **矩阵元素高亮**：展示矩阵乘法中参与计算的元素。
   - **步进控制**：允许单步执行矩阵乘法，观察状态变化。
3. **音效提示**：
   - **减一操作**：播放短促“滴”声。
   - **进入循环节**：播放8-bit胜利音效。

### 交互功能
- **速度调节**：滑动条控制动画速度（0.5x~5x）。
- **AI自动演示**：自动执行分段探测与矩阵跳跃，类似“贪吃蛇AI”路径展示。

### 复古风格实现
```javascript
// Canvas 绘制示例（伪代码）
function drawPixel(x, y, color) {
    ctx.fillStyle = color;
    ctx.fillRect(x * 10, y * 10, 8, 8);
}

// 音效触发
function playSound(effect) {
    const sfx = { 'step': 'beep.wav', 'loop': 'fanfare.wav' };
    new Audio(sfx[effect]).play();
}
```

---

## 个人心得摘录
> **TimWYZ 调试经历**：  
> “预处理 `len[x]` 时发现边界问题，修正 `fib[len]` 的模数计算后AC。”  
> **wlzhouzhuan 优化技巧**：  
> “利用 `6k` 斐波那契循环节上界，将预处理复杂度从 `O(k^2)` 降至 `O(k)`。”

---
处理用时：88.26秒
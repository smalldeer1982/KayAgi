# 题目信息

# [NOIP2020] 排水系统

## 题目描述

对于一个城市来说，排水系统是极其重要的一个部分。

有一天，小 C 拿到了某座城市排水系统的设计图。排水系统由 $n$ 个排水结点（它们从 $1 \sim n$ 编号）和若干个单向排水管道构成。每一个排水结点有若干个管道用于汇集其他排水结点的污水（简称为该结点的汇集管道），也有若干个管道向其他的排水结点排出污水（简称为该结点的排出管道）。

排水系统的结点中有 $m$ 个污水接收口，它们的编号分别为 $1, 2, \ldots , m$，污水只能从这些接收口流入排水系统，并且这些结点没有汇集管道。排水系统中还有若干个最终排水口，它们将污水运送到污水处理厂，没有排出管道的结点便可视为一个最终排水口。

现在各个污水接收口分别都接收了 $1$ 吨污水，污水进入每个结点后，会均等地从当前结点的每一个排出管道流向其他排水结点，而最终排水口将把污水排出系统。

现在小 C 想知道，在该城市的排水系统中，每个最终排水口会排出多少污水。该城市的排水系统设计科学，管道不会形成回路，即不会发生污水形成环流的情况。

## 说明/提示

**【样例 #1 解释】**

$1$ 号结点是接收口，$4, 5$ 号结点没有排出管道，因此是最终排水口。  
$1$ 吨污水流入 $1$ 号结点后，均等地流向 $2, 3, 5$ 号结点，三个结点各流入 $\frac{1}{3}$ 吨污水。  
$2$ 号结点流入的 $\frac{1}{3}$ 吨污水将均等地流向 $4, 5$ 号结点，两结点各流入 $\frac{1}{6}$ 吨污水。  
$3$ 号结点流入的 $\frac{1}{3}$ 吨污水将均等地流向 $4, 5$ 号结点，两结点各流入 $\frac{1}{6}$ 吨污水。  
最终，$4$ 号结点排出 $\frac{1}{6} + \frac{1}{6} = \frac{1}{3}$ 吨污水，$5$ 号结点排出 $\frac{1}{3} + \frac{1}{6} + \frac{1}{6} = \frac{2}{3}$ 吨污水。

**【数据范围】**

| 测试点编号 | $n \le$ | $m \le$ |
|:-:|:-:|:-:|
| $1 \sim 3$ | $10$ | $1$ |
| $4 \sim 6$ | ${10}^3$ | $1$ |
| $7 \sim 8$ | ${10}^5$ | $1$ |
| $9 \sim 10$ | ${10}^5$ | $10$ |

对于全部的测试点，保证 $1 \le n \le {10}^5$，$1 \le m \le 10$，$0 \le d_i \le 5$。

数据保证，污水在从一个接收口流向一个最终排水口的过程中，不会经过超过 $10$ 个中间排水结点（即接收口和最终排水口不算在内）。

## 样例 #1

### 输入

```
5 1
3 2 3 5
2 4 5
2 5 4
0
0
```

### 输出

```
1 3
2 3
```

## 样例 #2

### 输入

```
见附件中的 water/water2.in```

### 输出

```
见附件中的 water/water2.ans```

## 样例 #3

### 输入

```
见附件中的 water/water3.in```

### 输出

```
见附件中的 water/water3.ans```

# AI分析结果



## 【唯一算法分类】
拓扑排序 (Topological Sorting)

---

## 【综合分析与结论】
本题的核心是拓扑排序结合分数运算。各题解均采用拓扑排序确保节点按无环顺序处理，用分子分母分别存储分数避免精度丢失。关键难点在于分数运算溢出问题，主流解法采用 `__int128` 或高精度处理。可视化需突出拓扑队列的动态维护和分数通分过程。

**算法流程可视化设计思路**：
1. **节点状态标记**：用不同颜色区分未处理（灰色）、队列中（黄色）、已处理（绿色）、最终排水口（红色）。
2. **拓扑队列展示**：侧边栏实时显示当前队列节点，突出即将处理的队首元素。
3. **分数流动动画**：当处理节点时，用箭头动画表示污水分配到子节点，显示分数通分过程。
4. **分数计算面板**：在节点旁动态显示当前分子分母，约分时出现闪光特效。

**复古像素化实现**：
- **8位调色板**：使用经典 FC 游戏的16色调色板（灰、黄、绿、红为主）
- **音效设计**：
  - 节点入队：8-bit "哔"声（100Hz方波）
  - 分数约分：短促"叮"声（200Hz三角波）
  - 最终输出：胜利音效（C大调琶音）
- **Canvas动画**：以32x32像素表示每个节点，管道用2像素宽线条，水流动画用像素点移动效果

---

## 【题解评分 (≥4星)】
1. **作者：hensier** ★★★★★  
   - 亮点：完整拓扑框架，清晰分数类设计，`__int128`高效处理  
   - 代码：结构清晰，运算符重载提升可读性  
   - 心得：强调DAG特性，提醒注意初始化分母为1

2. **作者：CaiZi** ★★★★☆  
   - 亮点：分数运算单独封装，队列处理简洁  
   - 优化：预处理gcd减少计算量，输出函数高度优化

3. **作者：normalpcer** ★★★★  
   - 亮点：使用C++20特性，结构体封装分数运算  
   - 特色：完整注释说明拓扑排序的数学推导

---

## 【最优思路与技巧提炼】
1. **拓扑驱动分配**  
   ```python
   while not queue.empty():
       u = queue.pop()
       for v in adj[u]:
           # 将u的当前水量均分到v
           transfer = Fraction(u.water) / len(adj[u])
           v.water += transfer
           if v.in_degree == 0: 
               queue.push(v)
   ```
2. **分数运算优化**  
   - 通分时使用 `lcm(a,b) = a*b//gcd(a,b)`  
   - 每次运算后立即约分避免溢出  
   - 使用`__int128`替代高精度提升效率

3. **初始化技巧**  
   ```cpp
   // 污水接收口初始化
   for(int i=1; i<=m; ++i){
       f[i] = {1, 1};  // 分子1，分母1
       q.push(i);
   }
   ```

---

## 【同类型题与算法套路】
**通用解法**：DAG拓扑排序 + 状态传递  
- **类似题目**：  
  1. P1038 神经网络（拓扑传递阈值）  
  2. P1983 车站分级（拓扑确定层级）  
  3. P1137 旅行计划（拓扑递推路径数）

**扩展技巧**：  
- 当状态传递涉及分数/概率时，可采用分子分母分离法  
- 若分母因子有限（如仅有2、3、5），可预处理质因数存储

---

## 【推荐练习题】
1. **P1038** - 神经网络（拓扑排序应用经典）  
2. **P2017** - 稀疏图判定（拓扑性质分析）  
3. **P3243** - 菜肴制作（拓扑排序与贪心结合）

---

## 【关键代码片段】
**分数类核心实现**（作者：hensier）：
```cpp
struct Frac {
    __int128 x, y;
    Frac operator+(const Frac &o) const {
        __int128 lcm = y / gcd(y, o.y) * o.y;
        return {x*(lcm/y) + o.x*(lcm/o.y), lcm};
    }
    Frac operator/(int k) const {
        __int128 g = gcd(x, k);
        return {x/g, y*(k/g)}; // 先约分再乘到分母
    }
};
```

**拓扑处理核心**（作者：CaiZi）：
```cpp
void topo(){
    queue<int> q;
    for(int i=1; i<=m; ++i) q.push(i);
    while(!q.empty()){
        int u = q.front(); q.pop();
        Frac unit = f[u] / adj[u].size();
        for(int v : adj[u]){
            f[v] = f[v] + unit;
            if(--in[v] == 0) q.push(v);
        }
    }
}
```

---

## 【可视化交互设计】
**动画控制面板**：
```html
<div id="control-panel">
    <button onclick="togglePlay()">▶/⏸</button>
    <input type="range" id="speed" min="1" max="10" value="5">
    <button onclick="step()">⏩ Step</button>
</div>
```
**Canvas绘制节点**：
```javascript
function drawNode(ctx, node, x, y) {
    ctx.fillStyle = nodeColors[node.state];
    ctx.fillRect(x, y, 32, 32); // 32x32像素节点
    drawFraction(ctx, node.fraction, x+5, y+10);
}
```

**音效触发逻辑**：
```javascript
function playSound(freq, type='square') {
    let osc = audioCtx.createOscillator();
    osc.type = type;
    osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
    osc.connect(audioCtx.destination);
    osc.start(); osc.stop(0.1);
}
```

---

通过拓扑排序的动态展示与复古像素风格的结合，学习者可直观理解污水在DAG中的传递过程，同时通过交互操作深化对算法核心的理解。

---
处理用时：87.28秒
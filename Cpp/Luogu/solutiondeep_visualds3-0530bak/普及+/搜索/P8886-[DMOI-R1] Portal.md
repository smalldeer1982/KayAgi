# 题目信息

# [DMOI-R1] Portal

## 题目背景

出题人正在玩一款叫 Portal 的游戏。但由于他太菜了，于是找来了你，让你帮他过几个他过不去的关卡。

什么？你说你不会玩？

玩家需要通过传送门枪到达出口。利用传送门枪射击可开出两种门，分别是橙色门和蓝色门，两面都可作入口及出口。在创造门的时候，另一道同样颜色的门会消失，即是说同时间不可能存在两道同色的门，最多只可同时存在一道蓝色及一道橙色的门。

两道传送门在三维空间之中的两个地点创造出视觉上及物理上的连系，传送门的立点只限于平面，玩家从门出来时会自动配合地心吸力调整身体水平。

出题人把所有希望都寄托于你身上了哟。哦，对了，因为出题人是个白嫖党，因此他拥有的是盗版 Portal。

## 题目描述

在一个 $n \times n$ 的二维平面图上，用 $(x,y)$ 表示地图第 $x$ 行第 $y$ 列。每个点都是墙、虚空和地面中的一种，分别用 `#`，`*`，`.` 表示。玩家只能站在地面上。**地图之外都是墙。**

你手里有一个传送门枪，可以发射蓝色和橙色的传送门，只能朝上下左右四个方向使用。

在选定一个方向和颜色后，将会在该方向上第一个碰到的墙的墙面上建造选定颜色的传送门，并摧毁之前建造的这种颜色的传送门。两种颜色的传送门不能被建立在同一墙面。

玩家可以朝上下左右四个方向的空地移动。玩家还可以在不同色传送门之间穿梭。假如玩家朝一堵墙移动并且墙面上有传送门，并且当前已经建立了两个传送门，那么会从另一个传送门出来（必须保证出来也站在陆地上）。

出来的时候，玩家会站在另一个门外的空地上，**四个方向都可以。**

一开始玩家站在 $(1,1)$，目的地是 $(n,n)$。求最少使用多少次传送门枪才能到达目的地。

**注意哦，这里的使用指的是穿过多少面传送门。**

## 说明/提示

### 样例1解释

我们用白色格子表示空地，黑色格子表示墙，蓝色格子表示蓝色传送门，橙色格子表示橙色传送门，可以画出第一局的如下地图：

![](https://cdn.luogu.com.cn/upload/image_hosting/s16tq3vq.png)

走到橙色传送门处，从橙色传送门进入，蓝色传送门出即可。

而第二局地图如下：

![](https://cdn.luogu.com.cn/upload/image_hosting/v7q0izdk.png)


走到蓝色传送门处，从蓝色传送门进入，橙色传送门出即可。

### 数据范围

对于 $20\%$ 的数据，$n \le 10$。

对于 $60\%$ 的数据，$n \le 100$。

对于另外 $10\%$ 的数据，$T=1$ 且不存在虚空。

对于 $100\%$ 的数据，$2 \le n \le 500$，$1 \le T \le 10$。

## 样例 #1

### 输入

```
2
5
..###
#.#.#
#..##
...#.
.###.
5
..#..
##..#
#.#..
..#..
.#...```

### 输出

```
2
2```

## 样例 #2

### 输入

```
4
5
...*.
*##*.
#..*.
#*###
.....
5
.#*..
.**.#
###.*
***.*
**...
5
.**..
***.#
###.*
***.*
*****
5
.**..
***.#
###..
***.*
***..```

### 输出

```
4
2
```

## 样例 #3

### 输入

```
见下发文件portal1.in```

### 输出

```
见下发文件portal1.ans```

## 样例 #4

### 输入

```
见下发文件portal2.in```

### 输出

```
见下发文件portal2.ans```

# AI分析结果



# 算法分类  
**BFS**

---

# 综合分析与结论  
## 核心思路  
题目核心是将地图中的连通块抽象为图节点，通过 BFS 寻找最少传送次数。两篇题解的共同点是：  
1. **连通块预处理**：将连续可移动的空地 `.` 划分为连通块。  
2. **有向图建模**：根据传送门规则建立连通块之间的边（官方题解通过墙相邻关系，SteveHans 直接处理点与墙关系）。  
3. **最短路径算法**：官方使用优先队列（类 Dijkstra），SteveHans 使用双端队列（01BFS）。  

## 解决难点  
- **边权定义**：传送门使用次数作为边权（官方题解每条边权为 1，SteveHans 边权为 0/1）。  
- **墙唯一性判断**：确保同一墙面不同颜色传送门不冲突（官方题解通过 `only` 数组判断，SteveHans 直接处理相邻墙）。  
- **连通块可达性**：仅当两连通块存在唯一隔墙时建立有向边。  

## 可视化设计  
1. **动画演示**：  
   - **连通块划分**：用不同颜色填充每个连通块。  
   - **边建立过程**：高亮相邻隔墙，显示连通块间跳跃。  
   - **搜索路径**：动态展示 BFS 队列的扩展顺序。  
2. **复古风格**：  
   - **像素网格**：用 8-bit 风格绘制地图（墙用黑色，连通块用彩虹色）。  
   - **音效触发**：访问新节点时播放 "beep" 音效，找到路径时播放胜利音效。  
   - **自动演示**：按空格键逐帧播放 BFS 扩展过程。  

---

# 题解清单 (4星及以上)  

## 1. DMOI 官方题解 (⭐️⭐️⭐️⭐️)  
**亮点**：  
- 连通块预处理大幅减少节点数量，适合大规模数据（$n \le 500$）。  
- 优先队列优化最短路径搜索，时间复杂度稳定。  
**代码片段**：  
```cpp  
// 连通块划分  
for(int i=1;i<=n;++i) for(int j=1;j<=n;++j) if(s[i][j]=='.'&&!col[i][j]){  
    BFS划分连通块;  
}  
// 建边  
if(相邻墙唯一) add(u, v);  
// Dijkstra  
priority_queue<pair<int,int>> q; q.push({0,1});  
```

## 2. SteveHans 题解 (⭐️⭐️⭐️⭐️)  
**亮点**：  
- 点级建模更直观，双端队列处理 0/1 边权。  
- 直接处理墙边界，避免连通块预计算。  
**代码片段**：  
```cpp  
// 双端队列 01BFS  
deque<int> q; q.push_back(start);  
while(!q.empty()){  
    if(边权==0) q.push_front(next);  
    else q.push_back(next);  
}  
```

---

# 最优思路与技巧  
1. **连通块压缩**：将地图抽象为连通块节点，时间复杂度从 $O(n^2)$ 降为 $O(k)$（$k$ 为连通块数）。  
2. **墙唯一性判断**：通过 `only` 数组记录每个连通块唯一相邻墙，避免重复建边。  
3. **边权优化**：使用双端队列处理 0/1 边权，比优先队列更高效。  

---

# 同类型题目推荐  
1. **洛谷 P1141** - 01迷宫（连通块+BFS）  
2. **洛谷 P1941** - 飞扬的小鸟（动态规划+状态跳跃）  
3. **LeetCode 1293** - 网格中的最短路径（带约束BFS）  

---

# 可视化核心代码片段  
```javascript  
// 像素风格绘制（伪代码）  
function drawGrid() {  
  for(let i=0; i<n; i++) {  
    for(let j=0; j<n; j++) {  
      ctx.fillStyle = getColor(block[i][j]);  
      ctx.fillRect(j*16, i*16, 15, 15); // 16x16像素  
    }  
  }  
  // 播放音效  
  if(newNode) playSound('beep.wav');  
}  
// 自动演示  
function autoPlay() {  
  let step = setInterval(() => {  
    if(!bfsStep()) clearInterval(step);  
  }, 500);  
}  
```

---

# 总结  
本题核心是将物理传送规则抽象为图论问题。官方题解适合大规模数据，SteveHans 题解更易理解。可视化应重点展示连通块划分与跳跃逻辑，复古风格可增强学习趣味性。

---
处理用时：62.83秒
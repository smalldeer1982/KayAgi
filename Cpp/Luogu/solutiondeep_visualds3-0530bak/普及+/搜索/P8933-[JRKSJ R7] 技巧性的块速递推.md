# 题目信息

# [JRKSJ R7] 技巧性的块速递推

## 题目背景

充分必要，切比雪夫。

原来还是，不需要了。

## 题目描述

一个 $n\times m$ 的棋盘，对每个格子染上黑白两色之一。

询问有多少种染色方式，使得不存在横、竖、斜连续四个格子中存在至少三个相同颜色的格子，并且不存在横、竖、斜连续三个格子的颜色相同。

若设棋盘的左上角为 $(1,1)$，右下角为 $(n,m)$，则称 $\{(x,y),(x+1,y),(x+2,y)\}$ 为横的连续三个格子，$\{(x,y),(x,y+1),(x,y+2)\}$ 为竖的连续三个格子、$\{(x,y),(x+1,y+1),(x+2,y+2)\}$ 和 $\{(x,y),(x+1,y-1),(x+2,y-2)\}$ 为斜的连续三个格子（以上格子均在棋盘内）。

连续四个格子同理。

## 说明/提示

### 样例解释

样例 $1$：显然任意染色均合法，答案为 $2^4=16$。

样例 $2$：

```
101
110
010
```

这是合法方案之一。

```
111
110
011
```

这是不合法方案之一，因为 $\{(1,1),(1,2),(1,3)\}$、$\{(1,2),(2,2),(3,2)\}$ 和 $\{(1,1),(2,2),(3,3)\}$ 均不满足条件。

### 数据规模

本题采用捆绑测试。
| $\text{Subtask}$ | $n,m\le$ | $\text{Score}$ |
| :----------: | :----------: | :----------: | 
| $1$ | $30$ | $40$ |
| $2$ | $10^9$ | $60$ |

对于 $100\%$ 的数据，$1\le T\le 10^5$，$1\le n,m\le 10^9$。

## 样例 #1

### 输入

```
1
2 2```

### 输出

```
16```

## 样例 #2

### 输入

```
1
3 3```

### 输出

```
32```

# AI分析结果



1. **算法分类**  
   其他搜索（DFS预处理+查表）

---

### **题解思路、算法要点与解决难点**  
- **核心思路**：通过DFS预处理小棋盘（如7×7内），利用周期性或固定规律处理大棋盘。  
- **DFS剪枝**：当格子位置≥4时，根据前三个同方向格子的颜色直接确定当前颜色，避免无效搜索。  
- **周期性发现**：颜色每4格重复，确保大棋盘只需查预处理结果。  
- **难点**：确保斜向条件满足，需预处理足够大的棋盘（如7×7）覆盖所有可能冲突。

---

### **题解评分**  
- **题解1（__ex）**：★★★★☆  
  思路清晰，预处理严谨，配图辅助理解，但代码可读性一般。  
- **题解2（zhangxiao666）**：★★★★☆  
  详细分步解释，代码注释丰富，但冗余检查较多。  
- **题解4（WER_very_fox）**：★★★★☆  
  代码简洁高效，直接打表，但预处理范围略小（6×6），可能遗漏斜向冲突。  

---

### **最优思路提炼**  
1. **DFS剪枝**：对前3×3格枚举，后续格根据前三格自动确定颜色。  
2. **4×4周期性**：颜色每4行/列循环，大棋盘等价于小棋盘结果。  
3. **预处理范围**：覆盖7×7内所有情况，确保斜向冲突被完全检查。  

---

### **同类型题与算法套路**  
- **周期性规律**：如矩阵快速幂（P1226）、状态压缩DP（P2704）。  
- **棋盘染色约束**：如洛谷P1005（高精度+动态规划）。  
- **预处理+查表**：适用于高次询问的大数据范围问题。  

---

### **推荐题目**  
1. **P1005** 矩阵取数游戏（高精度+动态规划）  
2. **P2704** 炮兵阵地（状态压缩DP）  
3. **P2289** 麦森数（快速幂+大数处理）  

---

### **个人心得摘录**  
- **剪枝重要性**：“当x≥4时直接确定颜色，否则复杂度爆炸”（__ex）。  
- **周期观察**：“斜向冲突最多覆盖到7×7”（zhangxiao666）。  

---

### **可视化与算法演示**  
**动画设计**：  
- **搜索过程**：以像素网格展示DFS填充棋盘，红色高亮当前枚举格，绿色表示合法填充，红色闪烁表示冲突。  
- **周期性循环**：用颜色渐变动画展示4×4块的重复模式。  
- **复古风格**：8位像素棋盘，音效提示合法/非法填充。  

**核心代码段（DFS剪枝逻辑）**：  
```cpp
void dfs(int x, int y) {
    if (y > m) y = 1, x++;
    if (x > n) { ans += check(); return; }
    if (y >= 4) { // 剪枝：根据前三个格确定当前颜色
        int sum = a[x][y-3] + a[x][y-2] + a[x][y-1];
        a[x][y] = (sum == 1) ? 1 : 0; // 必须满足四格两黑两白
        if (valid(x, y)) dfs(x, y+1);
    } else { // 枚举前3×3的颜色
        a[x][y] = 0; if (valid(x, y)) dfs(x, y+1);
        a[x][y] = 1; if (valid(x, y)) dfs(x, y+1);
    }
}
```

---

### **总结**  
通过DFS预处理小范围合法解，结合周期性规律处理大范围查询，是本题的核心。剪枝策略和预处理范围的精准选择是优化关键。

---
处理用时：151.31秒
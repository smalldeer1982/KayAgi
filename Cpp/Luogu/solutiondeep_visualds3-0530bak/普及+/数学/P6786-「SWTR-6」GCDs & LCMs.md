# 题目信息

# 「SWTR-6」GCDs & LCMs

## 题目描述

小 A 有一个长度为 $n$ 的序列 $a_1,a_2,\cdots,a_n$。

他想从这些数中选出一些数 $b_1,b_2,\cdots,b_k$ 满足：对于所有 $i\ (1\leq i\leq k)$，$b_i$ 要么是序列 $b$ 中的最大值，要么存在一个位置 $j$ 使得 $b_j>b_i$ 且 $b_i+b_j+\gcd(b_i,b_j)=\mathrm{lcm}(b_i,b_j)$。

- 如果你不知道 $\gcd$ 和 $\mathrm{lcm}$ 是什么，可以点击最底部的「帮助/提示」部分的链接。

小 A 想让选出的数之和尽量大。请求出这个最大值。

## 说明/提示

**「样例 1 说明」**

可以选择 $b=\{2,3\}$，因为 $2+3+\gcd(2,3)=\mathrm{lcm}(2,3)$。

**「数据范围与约定」**

**本题采用捆绑测试。**

- Subtask 1（5 points）：$n\leq2$；
- Subtask 2（20 points）：$n\leq 17$；
- Subtask 3（15 points）：$a_i\leq 2\times 10^3$；
- Subtask 4（15 points）：$n\leq 2\times 10^3$；
- Subtask 5（10 points）：$n\leq 5\times 10^4$；
- Subtask 6（10 points）：$a_i\leq 10^7$；
- Subtask 7（25 points）：无特殊限制。

对于 $100\%$ 的数据，$1\leq n\leq 3\times 10^5$，$1\leq a_i\leq 10^9$。

**「帮助/提示」**

$\gcd$ 表示[最大公约数](https://baike.baidu.com/item/%E6%9C%80%E5%A4%A7%E5%85%AC%E7%BA%A6%E6%95%B0/869308?fr=aladdin)，$\mathrm{lcm}$ 表示[最小公倍数](https://baike.baidu.com/item/%E6%9C%80%E5%B0%8F%E5%85%AC%E5%80%8D%E6%95%B0/6192375?fr=aladdin)。

**「来源」**

[【LGR-075】洛谷 8 月月赛 II Div.2 & SWTR-06 & EZEC Round 3](https://www.luogu.com.cn/contest/33190)。

idea & solution & data by [Alex_Wei](https://www.luogu.com.cn/user/123294)。

## 样例 #1

### 输入

```
4
4 3 2 1```

### 输出

```
5```

## 样例 #2

### 输入

```
10
6 7 18 4 17 10 9 1 3 8```

### 输出

```
19```

## 样例 #3

### 输入

```
3
123456789 234567890 123456789```

### 输出

```
246913578```

# AI分析结果



## 数论

### 综合分析与结论
本题核心在于推导满足条件的数对关系，得出序列必须构成公比为3/2的等比数列。关键步骤如下：

1. **数学推导**  
   设两数满足 $x + y + \gcd(x,y) = \operatorname{lcm}(x,y)$，通过设 $\gcd(x,y)=d$ 并代入 $x=da,y=db$，得到方程 $(a-1)(b-1)=2$，唯一解为 $a=2,b=3$，故 $x:y=2:3$。

2. **序列构建**  
   选出的数去重排序后必须构成等比数列，每个数是前一个的1.5倍。例如：4 →6 →9 →13.5...（若存在）。

3. **实现关键**  
   使用排序+二分或哈希表（如map）快速查询是否存在下一个数，累加其出现次数的总和，并标记已访问避免重复计算。

**可视化设计**：
- **动画流程**：以像素风格展示从某个数（如4）开始，箭头指向6，高亮当前数并播放音效，累加总和。
- **步进控制**：允许暂停观察当前数是否满足1.5倍关系，失败时播放低沉音效。
- **颜色标记**：绿色表示有效数，红色表示缺失数，黄色显示当前总和。

---

### 题解评分（≥4星）
1. **Alex_Wei（5星）**  
   核心思路清晰，利用map快速统计与查询，代码简洁。通过置零map值避免重复计算，时间复杂度O(n log n)。

2. **Konnyaku_LXZ（4.5星）**  
   数学推导详细，代码预处理去重数组后二分查找，高效处理大数范围。结构体统计频次，逻辑明确。

3. **lndjy（4星）**  
   通过暴力打表验证猜想，代码实用性强，适合快速理解问题本质。使用map但处理重复数的方式直观。

---

### 最优思路/技巧
- **关键公式**：$(a-1)(b-1)=2$ 推导出数的比例关系。
- **序列生成**：从每个数出发，乘以3/2生成链式结构，总和取最大值。
- **优化手段**：哈希表（map）或排序+二分避免重复计算。

**代码片段**（Alex_Wei的核心逻辑）：
```cpp
for(int i=1;i<=n;i++){
    ll tmp=a[i],cnt=0;
    while(mp[tmp]){
        cnt+=tmp*mp[tmp],mp[tmp]=0;
        if(tmp%2==0)tmp=tmp/2*3; // 生成下一个数
        else break;
    }
    ans=max(ans,cnt);
}
```

---

### 相似题目
1. **P1895 GCD序列问题**：类似数论推导，寻找满足特定gcd条件的序列。
2. **P2441 数对统计**：涉及gcd/lcm比例关系的组合问题。
3. **P1447 能量采集**：数学推导结合容斥原理。

---

### 个人心得摘录
- **调试教训**：未处理重复数导致错误累加，需置零map值（Alex_Wei）。
- **顿悟点**：比例关系2:3的发现极大简化问题（lndjy）。

---

### 可视化与算法演示（复古像素风格）
**Canvas动画设计**：
1. **初始化**：绘制排序后的数列，像素块显示数值。
2. **遍历过程**：选中数4（绿色闪烁），检查6存在（绿色箭头），累加总和。
3. **失败提示**：若下一个数不存在（如9→13.5），红色叉提示并播放失败音效。
4. **音效触发**：成功累加时播放8-bit上升音调，失败用短促低音。

**交互控制**：
- **速度调节**：滑块控制遍历速度（50ms~2s）。
- **自动模式**：AI自动选择最优起点，展示最大和推导过程。

---

### 代码实现（复古风格辅助函数）
```javascript
// 伪代码：像素动画核心逻辑
function animateSequence(startValue) {
    let current = startValue;
    let sum = 0;
    while (map.has(current)) {
        drawPixel(current, 'green'); // 高亮当前数
        playSound('beep'); // 成功音效
        sum += current * count[current];
        map.delete(current);
        if (current % 2 !== 0) break;
        current = current * 3 / 2;
    }
    updateScore(sum); // 更新总分显示
}
```

---
处理用时：76.97秒
# 题目信息

# 「C.E.L.U-02」学术精神

## 题目描述

提供 **一句话题意** 阅读。

某地有 $n$ 个小朋友，每个小朋友都有一个**独特的**  idea，其中第 $i$ 个小朋友的 idea 的 **编号** 为 $i$。老师让这个每一个小朋友在一组编号分别为 $1\sim n$ 的卡片中随机抽一个，**抽完后把卡片放回去**，这个小朋友会和编号为卡片上数字的小朋友**交换** idea（交换指**两人**把**所有**自己知道的 idea 告诉对方）。因为自己和自己交换 idea 在他们眼中也许是一件很傻的事情，所以如果**卡片上的编号与自己的相同**，他将再抽一次（此时他已经把卡片放回去了），**直到编号不是自己**的为止。

不久，每个小朋友都抽完了一遍，每个小朋友将把收集到的**所有** idea 出成一场比赛，因为有 idea 的交换，有很多比赛之间都是**有联系**的。

如果两场比赛中存在 idea **相同**的题目，我们认为这两场比赛是有联系的。「联系」具有**传递性**：**如果比赛 $\mathbf A$、$\mathbf B$ 有联系，比赛 $\mathbf B$、$\mathbf C$ 有联系，则比赛 $\mathbf A$、$\mathbf C$ 也有联系**。为了避免理解错误，在这举一个例子：

若仅有四场比赛：比赛一出现了 idea $1$、$2$；比赛二出现 idea $2$、$5$ ；比赛三出现 idea $3$、$5$、$8$，比赛四出现 idea $4$、$7$。则比赛一、二之间有**直接联系**。比赛一、三之间虽然没有公共 idea，但它们之间是**有联系**的。比赛四与其他所有比赛没有联系。  

而所有有联系的比赛都将属于同一个比赛集，没有联系的比赛处在不同的比赛集。

上例中比赛一、二、三属于一个比赛集，比赛四属于另一个。

求所有人**抽球卡片的次数和**的期望 $E_0$ 和比赛集的个数 $s$ 的期望 $E_1$。

---

**一句话题意：**

对于每个点 $i$ 随机与 $[1,n]$ 中的一点连无向边，若连向自己，则保留该边并再次连边，一直重复至连到别的点上为止，求边数与连通块个数期望。

## 说明/提示

---

### 样例解释  

**样例解释一**

- 每个小朋友摸卡片次数为 $1$ 的概率为 $\dfrac{1}{2}$，摸卡片次数为 $2$ 的概率为 $\dfrac{1}{4}$，摸卡片次数为 $i$ 的期望次数为 $\dfrac{1}{2^i}$，期望摸卡片次数为 $2$，总摸卡片次数为 $4$。

- $1$ 号小朋友一定会和 $2$ 号小朋友交换 idea，所以他们出的比赛之间一定是属于同一个比赛集。$E_1=1$。

**样例解释二**

- 第一问取模前的答案为 $\dfrac{49}{6}$。

- 第二问取模前的答案为 $\dfrac{2245}{1944}$。

---

### 数据范围

| 测试点编号 | $n$ | 测试点编号 | $n$ | 
| :----------: | :----------: | :----------: | :----------: |
| $1$ | $\leq 3$ | $5$ | $\leq 1000$ |
| $2$ | $\leq 5$ | $6$ | $\leq 2000$ | 
| $3$ | $\leq 9$ | $7\sim8$ | $\leq 5000$ | 
| $4$ | $\leq 12$ | $9\sim 10$ | $\leq10^4$ | 

对于 $100\%$ 的数据，有 $2\leq n\leq10^4$。

---


## 样例 #1

### 输入

```
2```

### 输出

```
4
1```

## 样例 #2

### 输入

```
7```

### 输出

```
166374067
539688692```

# AI分析结果



**唯一算法分类**：组合数学

---

### **题解思路、算法要点与解决难点**

#### **第一问（E0）**
- **核心推导**：每个节点的边数期望为几何分布，成功概率 $p = \frac{n-1}{n}$，期望为 $\frac{1}{p} = \frac{n}{n-1}$，总边数期望为 $n \times \frac{n}{n-1} = \frac{n^2}{n-1}$。
- **解决难点**：通过几何级数求和或直接几何分布公式快速得出期望。

#### **第二问（E1）**
- **核心观察**：每个连通块对应一个环，连通块数等于环的期望个数。
- **组合模型**：枚举环大小 $i$，计算所有可能的环出现概率之和：
  - **环的排列方式**：选择 $i$ 个点的组合数 $C(n,i)$，环内排列数为 $(i-1)!$（圆排列）。
  - **概率计算**：环外的点自由连边，概率为 $(n-1)^{n-i}$，总概率为 $\frac{C(n,i) \cdot (i-1)!}{(n-1)^i}$。
- **公式化简**：最终答案为 $\sum_{i=2}^n \frac{P(n,i)}{i \cdot (n-1)^i}$，其中 $P(n,i)$ 为排列数。

---

### **题解评分 (≥4星)**

1. **Tx_Lcy (⭐⭐⭐⭐⭐)**  
   - **亮点**：推导详细，代码预处理阶乘和幂次，结构清晰。
   - **代码片段**：
     ```cpp
     // 预处理阶乘和 (n-1)^k
     for (int i=1;i<=n;++i) fac[i]=fac[i-1]*i%mod;
     for (int i=1;i<=n;++i) facn[i]=facn[i-1]*(n-1)%mod;
     // 计算环的贡献
     ans += C(n,i) * fac[i-1] % mod * facn[n-i] % mod;
     ```

2. **0x3F (⭐⭐⭐⭐)**  
   - **亮点**：直接计算排列数，避免预处理阶乘，节省空间。
   - **代码片段**：
     ```cpp
     for (int i=2, j=n*(n-1); i<=n; j=j*(n-i++)%mod)
         t += j * inv(i) % mod * qpow(n-1, p-i-1);
     ```

3. **TonyYin (⭐⭐⭐⭐)**  
   - **亮点**：分步计算排列数和逆元，代码简洁高效。
   - **代码片段**：
     ```cpp
     for(int i=2; i<=n; i++) {
         tmp = tmp * (n - i + 1) % mod;
         ans = (ans + tmp * inv(i) % mod * inv(Pow) % mod) % mod;
     }
     ```

---

### **最优思路与技巧提炼**
1. **几何分布直接应用**：快速计算 E0，无需复杂级数展开。
2. **基环树与环的等价性**：将连通块问题转化为环计数，简化模型。
3. **排列数代替组合数**：通过 $P(n,i)/i$ 替代 $C(n,i) \cdot (i-1)!$，减少阶乘运算。

---

### **同类型题与算法套路**
- **常见模型**：基环树、置换环、期望线性性。
- **推荐题目**：
  1. [P1365 期望分数](https://www.luogu.com.cn/problem/P1365)（几何分布）
  2. [P5158 多项式快速插值](https://www.luogu.com.cn/problem/P5158)（排列组合）
  3. [P6776 交换棋子](https://www.luogu.com.cn/problem/P6776)（基环树应用）

---

### **可视化与算法演示**
- **动画设计**：
  - **步骤1**：展示每个节点随机连边的过程，高亮形成环的节点。
  - **步骤2**：动态累加环的贡献，以公式 $\frac{P(n,i)}{i \cdot (n-1)^i}$ 逐步显示计算。
  - **像素风格**：用 8-bit 色块表示节点，环形成时播放音效，Canvas 绘制连边动画。
- **交互功能**：单步执行观察排列数计算，速度调节比较不同 $i$ 的贡献。

---

### **代码实现核心**
```cpp
// 计算排列数 P(n,i) 并累加贡献
int tmp = n, ans = 0;
for (int i=2; i<=n; i++) {
    tmp = tmp * (n - i + 1) % mod; // 逐步计算 P(n,i)
    int inv_pow = qpow(n-1, mod - i); // 计算 1/(n-1)^i
    ans = (ans + tmp * inv(i) % mod * inv_pow % mod) % mod;
}
```

---

**总结**：本题通过组合数学与期望分析，将复杂问题转化为环计数模型。代码实现需注意排列数的高效计算与逆元预处理，可视化设计可增强对环生成过程的理解。

---
处理用时：76.64秒
# 题目信息

# 「SWTR-7」IOI 2077

## 题目背景

#### 友情提醒：本题输入输出量很大，请不要使用 cin 或 scanf。题目最下方附有快读及其使用方法。

#### 赛时提醒：若对于选出的 $m$ 无解，则期望值为 $0$。可以结合样例 2 的解释说明以更好理解。

#### 赛时提醒：你需要求的是能力值之和的期望而不是最大值。

---

小 A 被 FCC 钦定参加 IOI 2077！71 岁老将请求出战！

## 题目描述

IOI 2077 有 $n$ 位**候选**参赛者，他们分别编号为 $1\sim n$。每位候选参赛者都有一个能力值，且**能力值互不相等**，第 $i$ 位候选参赛者的能力值为 $a_i$。小 A 更喜欢有序的数字，所以他将这 $n$ 位候选参赛者按照能力值**从小到大**排好了序，即**满足 $a_i<a_{i+1}\ (1\leq i<n)$。**

正式参赛者将会从这 $n$ 位候选参赛者中产生。具体地，所有参赛者将是候选参赛者的一个子串 $[l,r]$，即编号为 $l,l+1,\cdots,r$ 的选手将参加 IOI 2077，其中，小 A 的编号为 $k$。因为他知道自己被钦定参加 IOI 2077，所以 $l\leq k\leq r$。可能的参赛者一共有 $q$ 种情况，每种情况用三个数 $l_i,r_i,k_i\ (l_i\leq k_i\leq r_i)$ 描述，即参赛者为编号在区间 $[l_i,r_i]$ 中的候选参赛者，而小 A 的编号为 $k_i$。

由于自己太菜，小 A 对即将到来的 IOI 感到力不从心。他决定选择一些参赛者作为队友，并与他们在赛场上相互帮（zuo）助（bi）。具体地，设正式参赛人数为 $s$，那么小 A 会在 $[0,\lfloor\frac{s-1}{2}\rfloor]$ 中**等概率随机**选择一个数 $m$，并从 $s$ 位参赛者中**随机**选出 $2m$ 个作为他的队友。不过，小 A 不希望自己显得太菜，所以**他的能力值 $a_k$ 必须是这 $2m+1$ 个人的能力值的中位数**。

俗话说，人多力量大，小 A 希望他与所有选出的队友的能力值之和尽量地大。**不过在此之前，他想知道这个值的期望值是多少**。请对 $998244353$ 取模，保证答案在该模数下有意义。**对于每一种可能的参赛者情况，你都需计算该情况下的答案。为了避免过大的输出，你只需要计算所有答案的异或和。**

## 说明/提示

**「样例 1 说明」**

- 第 1 个询问：  
  因为 $s_1=r_1-l_1+1=5$，所以 $m$ 可以为 $0,1$ 或 $2$。  
  $m=0$ 时：小 A 没有队友，那么期望值就是他自身的能力值 $a_{k_1}=a_3=5$。    
  $m=1$ 时：小 A 可以选**编号** $(1, 4)$ 或 $(1, 5)$ 或 $(2, 4)$ 或 $(2, 5)$ 的参赛者作为他的队友，能力值之和分别为 $14,15,15,16$，期望值为 $\frac{14+15+15+16}{4}=15$。    
  $m=2$ 时：小 A 只能全选，期望值为 $2+3+5+7+8=25$。  
	综上，期望值为 $\frac{5+15+25}{3}=15$。

- 第 2 个询问：  
  因为 $s_2=r_2-l_2+1=3$，所以 $m$ 可以为 $0$ 或 $1$。  
  $m=0$ 时，小 A 没有队友，期望值为 $3$。    
  $m=1$ 时，小 A 无法选择，期望值为 $0$。  
  综上，期望值为 $\frac{3+0}{2}=\frac{3}{2}$，对 $998244353$ 取模后为 $499122178$。
  
$15\oplus499122178=499122189$。

**「数据范围与约定」**

**本题采用捆绑测试。**

记 $s_i=r_i-l_i+1$。

- Subtask #0（1 point）：是样例。
- Subtask #1（10 points）：$s_i\leq 2$。
- Subtask #2（20 points）：$s_i\leq 16$，$q\leq 40$，$n\leq 640$。
- Subtask #3（15 points）：$s_i,q\leq 500$，$n\leq 10^5$。
- Subtask #4（15 points）：$s_i,q\leq 3\times 10^3$，$n\leq 10^5$。
- Subtask #5（15 points）：$s_i,q\leq 2\times 10^5$，$n\leq 5\times 10^5$。
- Subtask #6（24 points）：无特殊限制。

对于 $100\%$ 的数据，$1\leq n,q\leq 2\times 10^6$，$1\leq l_i\leq k_i\leq r_i\leq n$，$1 \le a_i \le 998244352$，$a_i<a_{i+1}\ (1\leq i<n)$。

对于所有测试点，时间限制 1s，空间限制 512MB。

**「帮助/提示」**

关于 [有理数取余](https://www.luogu.com.cn/problem/P2613)，[中位数](https://baike.baidu.com/item/%E4%B8%AD%E4%BD%8D%E6%95%B0/3087401?fr=aladdin)。

本题输入输出量**极大**，**请注意 I/O 优化。**  
本题提供**有符号 32 位整数**快读模板，保证读入用时不超过 250ms：

```cpp
#define gc getchar()
inline int read(){
	int x=0; bool sgn=0; char s=gc;
	while(!isdigit(s))sgn|=s=='-',s=gc;
	while(isdigit(s))x=(x<<1)+(x<<3)+(s-'0'),s=gc;
	return sgn?-x:x;
}

// 如果需要读入直接调用 read() 即可。
// 一个例子（与正解无关，仅供参考）：

int t=read(),n=read(),q=read();
int a[2000005],l[2000005],r[2000005],k[2000005];
for(int i=1;i<=n;i++)a[i]=read();
for(int i=1;i<=q;i++)l[i]=read(),r[i]=read(),k[i]=read();

// 这样你就可以在 250ms 内读入全部数据了。
```

**「题目来源」**

[Sweet Round 07](https://www.luogu.com.cn/contest/51773) C。  
idea & solution：[SSerWarriors_Cat](https://www.luogu.com.cn/user/147999)；data：[Alex_Wei](https://www.luogu.com.cn/user/123294) ；验题：[chenxia25](https://www.luogu.com.cn/user/138400)。

---

IOI 2077 落下帷幕，小 A 凭借出（dui）色（you）的发（bang）挥（zhu）成功 AK 了 IOI，这不禁让他回想起曾经满腔热血的自己，以及和他共同奋斗在 OI 路上的战友们。如今他们虽已天各一方，说起来也有十几年没见过面了，但他们真挚的友谊未曾淡去，也将永远不会褪色。

>*“爷爷，您手机里有段录音，还写着 'ycx txdy!'。”*  
>*“哦，是嘛？放出来听听。”*  
>>*“I AK IOI. I AK ACM World Final. I AK Universe OI. I think all of you are vegetable chickens.”*  
>>*“I AK IOI. I AK ACM World Final. I AK Universe OI. I think all of you are vegetable chickens.”*  
>>*“I AK IOI. I AK ACM World Final. I AK Universe OI. I think all of you ............”*

2077.7.7

## 样例 #1

### 输入

```
0
5 2
2 3 5 7 8
1 5 3
2 4 2
```

### 输出

```
499122189```

# AI分析结果



**算法分类**  
组合数学

---

**题解思路与解决难点**  
**核心思路**：  
- **中位数约束**：选出的队友必须保证小A的值为中位数，即左右两边选取人数相等（m人）。  
- **贡献分解**：左右两边分别计算贡献，利用等差数列求和公式避免枚举。  
- **模运算优化**：预处理逆元数组，将除法转为乘法，避免超时。

**关键公式推导**：  
1. **左右贡献和**：左边总和为 `sum1 = S[k-1] - S[l-1]`，右边为 `sum2 = S[r] - S[k]`。  
2. **概率权重**：每选m人，左边每个元素的贡献为 `m/(k-l)`，右边为 `m/(r-k)`。  
3. **总和计算**：总贡献为 `(mi*(mi+1)/2) * (sum1/(k-l) + sum2/(r-k))`，其中 `mi = min(k-l, r-k)`。  
4. **期望整合**：加上小A自身贡献 `(mi+1)*a[k]`，除以总情况数 `(r-l)/2 +1`。

**解决难点**：  
- **组合数爆炸**：直接计算组合数不可行，通过数学变换转为等差数列。  
- **模数处理**：处理负数取模、前缀和差值，确保计算正确性。

---

**题解评分**  
1. **dingcx（5星）**：思路清晰，代码简洁，正确预处理逆元，高效处理模运算。  
2. **二gou子（4星）**：直观分解贡献，代码易懂，但推导步骤略简。  
3. **jockbutt（4星）**：公式简化到位，代码短小但变量命名稍隐晦。

---

**最优思路与技巧**  
- **逆元预处理**：线性时间计算逆元，避免每次求模逆。  
- **等差数列求和**：将组合贡献转为 `mi*(mi+1)/2`，消除循环。  
- **前缀和优化**：快速计算区间和，减少重复计算。

---

**同类型题套路**  
- **中位数约束问题**：常转化为左右对称选取元素。  
- **期望线性性分解**：独立计算各部分贡献后求和。  
- **模运算优化**：预处理逆元+前缀和是处理大数模的常见技巧。

---

**推荐相似题目**  
1. P2613（有理数取余）  
2. P1495（组合数取模）  
3. P3758（中位数性质+前缀和）

---

**个人心得摘录**  
- **二gou子**：顿悟“期望的线性性救命”，避免组合数推导。  
- **dingcx**：提到赛时因未预处理逆元而失败，强调细节重要性。

---

**可视化设计**  
**动画方案**：  
1. **像素风格界面**：  
   - **左侧面板**：显示候选者数组，小A高亮为红色。  
   - **右侧面板**：动态绘制前缀和、逆元值（8位绿色数字）。  
2. **操作演示**：  
   - **步骤1**：高亮当前查询的 `[l, r]` 区间，标记小A位置。  
   - **步骤2**：左右分别展开，计算 `sum1` 和 `sum2`，显示计算公式。  
   - **步骤3**：动态绘制等差数列（蓝色方块堆叠），计算总和。  
   - **步骤4**：合成最终期望，播放“完成”音效。  
3. **音效交互**：  
   - 正确计算时触发8位“升级”音效，错误时短促“错误”音。  
   - 背景播放低循环芯片音乐。

**代码片段（关键逻辑）**  
```cpp
// 预处理逆元
inv[1] = 1;
for (int i=2; i<=2e6; i++)
    inv[i] = (MOD - MOD/i) * inv[MOD%i] % MOD;

// 查询处理
ll l, r, k;
l = read(), r = read(), k = read();
ll mi = min(k-l, r-k);
ll sum1 = (s[k-1] - s[l-1] + MOD) % MOD;
ll sum2 = (s[r] - s[k] + MOD) % MOD;
// 核心公式
ll res = ( (mi+1)*a[k] + mi*(mi+1)/2 % MOD * 
    (sum1*inv[k-l] % MOD + sum2*inv[r-k] % MOD) ) % MOD;
res = res * inv[(r-l)/2 + 1] % MOD;
ans ^= res;
```

---
处理用时：64.82秒
# 题目信息

# 「GMOI R1-T3」Number Pair

## 题目描述

我们定义满足如下条件的数对 $(x,y)$ 叫做奇妙数对：

$k \times \gcd(x,y)=\operatorname{lcm}(x,y)$ 并且 $P \le \gcd(x,y) \le Q$（保证 $P \le Q$）。

有 $T$ 组数据，对于每一组数据，给定 $k,P,Q$ 三个数，求符合条件的数对 $(x,y)$ 的对数。

**答案对 $10^9+7$ 取模。**

## 说明/提示

**注意并不寻常的时间限制。**

对于 $100\%$ 的数据 $1 \le k \le 10^{16}$，$1 \le T \le 50$，$1 \le P \le Q \le 2\times 10^9$。

| 测试点 | $k$ | $T$ | $P$ | $Q$ | 总分 |
| :----------: | :----------: | :----------: | :-------------: | :----------: | :----------: |
| $1\sim 3$ | $k \le 3$ | $T=1$ | $P=1$ | $Q=1$ | $15$ |
| $4\sim 8$ | $k \le 100$ | $T \le 8$ | $P \le 30$ |  $Q \le 30$ |$15$ |
| $9\sim 13$ | $k \le 10^3$ | $T \le 50$ | $P \le 500$ | $Q \le 500$ | $25$ |
| $14\sim 18$ | $k \le 10^{12}$ | $T \le 50$ | $P \le 10^4$ | $Q \le 10^4$ | $15$ |
| $19\sim 22$ | $k \le 10^{13}$ | $T \le 50$ | $P \le 10^6$ | $Q \le 10^6$ | $12$ |
| $23\sim 28$ | $k \le 10^{16}$ | $T \le 50$ | $P \le 2\times10^9$ | $Q \le 2\times10^9$ | $18$ |

**本题保证 $k$ 随机生成，并不存在极限卡人数据，时限已经开到 std 两倍，请各位选手放心。**

## 样例 #1

### 输入

```
5
10 1 3
30 1 5
997 24 35
34 39 99
210 1000 1001```

### 输出

```
12
40
24
244
32```

# AI分析结果



## 【唯一算法分类】数论（质因数分解、gcd与lcm性质）

---

## 【题解思路与难点对比】

### **核心思路**
1. **数学推导**：由条件 $k \cdot \gcd(x,y) = \operatorname{lcm}(x,y)$，设 $\gcd(x,y)=d$，则 $x=ad, y=bd$，推导出 $ab=k$ 且 $\gcd(a,b)=1$。
2. **质因数分解**：$k$ 的不同质因子数 $n$ 决定了互质对 $(a,b)$ 的数目为 $2^n$。
3. **区间贡献**：每个合法的 $(a,b)$ 对应 $[P,Q]$ 内的 $d$，总贡献为 $2^n \cdot (Q-P+1)$。

### **实现难点**
- **质因数分解优化**：直接试除法对 $k \le 10^{16}$ 超时，需预处理小质数加速。
- **大质数处理**：分解后剩余的 $k$ 可能是大质数或平方数，需特殊判断（如 Miller-Rabin 测试）。
- **空间限制**：预处理 $10^8$ 内质数需要约 600MB 内存，需用 `bitset` 或动态数组优化。

### **题解对比**
| 题解作者       | 质数预处理范围 | 大质数处理      | 时间复杂度        | 代码简洁性 | 评分 |
|----------------|----------------|-----------------|-------------------|------------|------|
| yinhy09 (官方) | $10^8$         | 试除后判断余数  | $O(T \cdot \pi(\sqrt{k}))$ | ★★★★☆      | 5    |
| Tx_Lcy         | $10^8$         | 试除法+平方判断 | $O(T \cdot \pi(\sqrt{k}))$ | ★★★★☆      | 4.5  |
| tobie          | $10^5$（立方根）| Miller-Rabin   | $O(T \cdot \pi(k^{1/3}))$ | ★★★☆☆      | 4    |

---

## 【最优思路提炼】
1. **质数预处理**：用线性筛预处理 $10^8$ 内的质数，减少试除次数。
2. **分解优化**：试除时若质数平方超过当前 $k$ 立即终止循环。
3. **余数处理**：若剩余 $k>1$，判断其是否为质数或平方数，增加计数。

---

## 【代码核心实现】
```cpp
// 预处理质数（关键片段）
bitset<100000001> vis;
vector<int> primes;
void sieve() {
    for (int i = 2; i <= 1e8; i++) {
        if (!vis[i]) primes.push_back(i);
        for (int j = 0; j < primes.size() && i * primes[j] <= 1e8; j++) {
            vis[i * primes[j]] = 1;
            if (i % primes[j] == 0) break;
        }
    }
}

// 分解质因数（关键逻辑）
int count_factors(ll k) {
    int cnt = 0;
    for (int p : primes) {
        if (p * p > k) break;
        if (k % p == 0) {
            cnt++;
            while (k % p == 0) k /= p;
        }
    }
    if (k > 1) cnt += (is_prime(k) || is_square(k)) ? 1 : 2;
    return cnt;
}
```

---

## 【可视化设计】
### **8位像素风格分解动画**
1. **像素网格**：将质数显示为像素块，高亮当前试除的质数（如绿色）。
2. **分解过程**：k 的值以二进制或十六进制显示在屏幕中央，每次试除时显示质数击中效果。
3. **音效**：
   - 试除成功：播放短促“滴”声。
   - 分解完成：播放胜利音效。
4. **自动演示**：按步进或自动播放，展示质数击中、k值变化和计数器更新。

---

## 【相似题目推荐】
1. [P3653 小清新数学题](https://www.luogu.com.cn/problem/P3653)（分解质因数+区间判断）
2. [P4718 Miller-Rabin 测试](https://www.luogu.com.cn/problem/P4718)（大数质因数分解）
3. [P4446 根式化简](https://www.luogu.com.cn/problem/P4446)（质因数幂次分析）

---

## 【个人心得摘录】
> “WA 第二个点是要特判当 $k=1$ 时直接输出 $q-p+1$，否则会漏解。” —— Day_Dreamer_H  
> **总结**：边界条件需单独处理，避免逻辑漏洞。

---
处理用时：70.18秒
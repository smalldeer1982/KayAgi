# 题目信息

# [NOI2001] 食物链

## 题目描述

动物王国中有三类动物 $A,B,C$，这三类动物的食物链构成了有趣的环形。$A$ 吃 $B$，$B$ 吃 $C$，$C$ 吃 $A$。

现有 $N$ 个动物，以 $1 \sim N$ 编号。每个动物都是 $A,B,C$ 中的一种，但是我们并不知道它到底是哪一种。

有人用两种说法对这 $N$ 个动物所构成的食物链关系进行描述：

- 第一种说法是 `1 X Y`，表示 $X$ 和 $Y$ 是同类。
- 第二种说法是`2 X Y`，表示 $X$ 吃 $Y$。

此人对 $N$ 个动物，用上述两种说法，一句接一句地说出 $K$ 句话，这 $K$ 句话有的是真的，有的是假的。当一句话满足下列三条之一时，这句话就是假话，否则就是真话。

- 当前的话与前面的某些真的话冲突，就是假话；
- 当前的话中 $X$ 或 $Y$ 比 $N$ 大，就是假话；
- 当前的话表示 $X$ 吃 $X$，就是假话。

你的任务是根据给定的 $N$ 和 $K$ 句话，输出假话的总数。


## 说明/提示

对于全部数据，$1\le N\le 5 \times 10^4$，$1\le K \le 10^5$。


## 样例 #1

### 输入

```
100 7
1 101 1
2 1 2
2 2 3
2 3 3
1 1 3
2 3 1
1 5 5
```

### 输出

```
3
```

# AI分析结果



## 算法分类
并查集（扩展域/带权）

---

## 核心思路与难点分析

### 扩展域并查集
**核心思路**：  
将每个动物拆分为3个逻辑节点（同类域、猎物域、天敌域），通过维护三个域的并查集关系表达环形食物链：
- `x` 表示同类
- `x+n` 表示猎物
- `x+2n` 表示天敌

**关键操作**：
1. **同类断言**：合并三个域的对应集合
2. **捕食断言**：建立环形关系链（X的猎物是Y → Y的天敌是X → X的天敌是Y的猎物）

**解决难点**：  
通过三倍数组维护三类关系，确保合并时三种逻辑关系同步更新，判断冲突时只需检查对应的域是否存在矛盾。

---

### 带权并查集
**核心思路**：  
使用模3权值表示关系（0-同类，1-被父吃，2-吃父节点），通过路径压缩和合并时的权值推导维护关系。

**关键操作**：
1. **路径压缩**：递归更新权值 `relation = (relation + parent_relation) % 3`
2. **合并推导**：根据两个节点与根的权值差推导新关系

**解决难点**：  
数学推导权值关系链，确保合并时的权值计算正确，特别是负数的处理需通过加3取模调整。

---

## 题解评分（≥4星）

1. **Sooke（5星）**  
   - 思路清晰，三倍数组实现直观  
   - 代码简洁，维护三个域的合并逻辑  
   - 配图解释关系链，适合初学者

2. **檀黎斗·神（4.5星）**  
   - 代码极简，仅50行  
   - 注释明确，直接操作三个逻辑域  
   - 适合快速实现场景

3. **天泽龟（4星）**  
   - 深入讲解带权并查集的数学推导  
   - 通过表格穷举证明权值关系  
   - 适合进阶学习关系推导

---

## 最优思路提炼

1. **三域并查集**  
   ```cpp
   // 同类断言合并
   fa[find(x)] = find(y);
   fa[find(x+n)] = find(y+n);
   fa[find(x+2n)] = find(y+2n);

   // 捕食断言合并
   fa[find(x+n)] = find(y);
   fa[find(y+2n)] = find(x);
   fa[find(x+2n)] = find(y+n);
   ```

2. **带权关系推导**  
   权值更新公式：
   ```cpp
   // 路径压缩时更新
   d[x] = (d[x] + d[parent]) % 3;

   // 合并时计算新权值
   d[fa] = (d[y] - d[x] + 3 + relation) % 3;
   ```

---

## 同类题目推荐
1. **P1525 关押罪犯**（对立关系分组）
2. **P1892 团伙**（扩展域基础应用）
3. **P1196 银河英雄传说**（带权并查集）

---

## 可视化设计

### 动画方案
**核心逻辑演示**：  
1. **三域模型**：  
   - 用三种颜色块（绿/蓝/红）分别表示同类、猎物、天敌域  
   - 合并时显示箭头连接对应域的节点，高亮冲突检测路径  
   - 示例：断言X吃Y时，红色箭头从X的猎物域指向Y的同类域

2. **权值推导**：  
   - 显示权值路径，用数字标注关系（0/1/2）  
   - 路径压缩时动态更新权值，颜色渐变表示变化  
   - 合并时展示权值计算公式弹窗

**交互功能**：  
- **步进控制**：逐句执行K个断言，观察并查集变化  
- **冲突高亮**：自动检测假话时闪烁错误节点  
- **模式切换**：支持三域视图/权值视图对比

---

## 题解代码示例（Sooke扩展域）

```cpp
#include <cstdio>
inline int read() { /* 读入优化 */ }

const int maxN = 100005;
int n, m, ans, fa[maxN * 3];

int find(int u) { return fa[u] == u ? u : fa[u] = find(fa[u]); }

int main() {
    n = read(), m = read();
    for (int i = 1; i <= n * 3; i++) fa[i] = i;
    
    while (m--) {
        int opt = read(), u = read(), v = read();
        if (u > n || v > n) { ans++; continue; }
        
        if (opt == 1) { // 同类断言
            if (find(u + n) == find(v) || find(u) == find(v + n)) ans++;
            else {
                fa[find(u)] = find(v);
                fa[find(u + n)] = find(v + n);
                fa[find(u + 2 * n)] = find(v + 2 * n);
            }
        } else { // 捕食断言
            if (find(u) == find(v) || find(u) == find(v + n)) ans++;
            else {
                fa[find(u + n)] = find(v);
                fa[find(v + 2 * n)] = find(u);
                fa[find(u + 2 * n)] = find(v + n);
            }
        }
    }
    printf("%d\n", ans);
    return 0;
}
```

---
处理用时：72.38秒
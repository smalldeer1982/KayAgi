# 题目信息

# 「化学」相对分子质量

## 题目描述

做化学题时，小 F 总是里算错相对分子质量，这让他非常苦恼。

小 F 找到了你，请你来帮他算一算给定物质的相对分子质量。

如果你没有学过相关内容也没有关系，你可以从样例和提示里理解该题所求内容。

## 说明/提示

### 样例解释
金 $Au : 197$

二氧化铪 $HfO_{2}: 178.5 + 2 \times 16= 210.5$

氢氧化钙（熟石灰）$Ca(OH)_2 : 40 + (1 + 16) \times 2 = 74$

五水硫酸铜（胆矾）$CuSO_4 \cdot 5H_2O: 64 + 32 + 16 \times 4 + 5 \times (1 \times 2 + 16) = 250$

十二水合硫酸铝钾（明矾）$KAl(SO_{4})_{2} \cdot 12H_{2}O$ （嗯 用心感受 $474$ 是对的）

### 附表：可能用到的相对原子质量

|元素|相对原子质量|
|:-:|:-:|
|H|1|
|C|12|
|N|14|
|O|16|
|F|19|
|Na|23|
|Mg|24|
|Al|27|
|Si|28|
|P|31|
|S|32|
|Cl|35.5|
|K|39|
|Ca|40|
|Mn|55|
|Fe|56|
|Cu|64|
|Zn|65|
|Ag|108|
|I|127|
|Ba|137|
|Hf|178.5|
|Pt|195|
|Au|197|
|Hg|201|

### 提示

如果你没有学习过相关内容，下面的内容可能有帮助：

> zcy 教你算相对分子质量

1. 每个元素以大写开头；
2. 计算分子质量的方法就是对每个原子出现的次数乘对应的相对原子质量求和；
3. ~( $\cdot$ ) 相当于加；
4. 下标相当于乘。

## 样例 #1

### 输入

```
Au```

### 输出

```
197```

## 样例 #2

### 输入

```
HfO_{2}```

### 输出

```
210.5```

## 样例 #3

### 输入

```
Ca(OH)_{2}```

### 输出

```
74```

## 样例 #4

### 输入

```
CuSO_{4}~5H_{2}O```

### 输出

```
250```

## 样例 #5

### 输入

```
KAl(SO_{4})_{2}~12H_{2}O```

### 输出

```
474```

# AI分析结果



## 【唯一算法分类】  
字符串处理/递归解析

---

## 【综合分析与结论】  
### 核心思路  
所有题解均采用**线性扫描+递归解析**的策略，核心逻辑分为：  
1. **元素识别**：根据大写字母确定元素起点，结合小写字母识别双字母元素  
2. **系数处理**：对 `_{n}` 结构使用快读方式提取数值  
3. **括号递归**：将括号内内容视为独立子式，递归计算后乘以外系数  
4. **水合物分割**：`~` 后统一处理为 `H2O` 质量乘系数  

### 实现难点  
1. **嵌套系数叠加**：如 `Ca(OH)₂` 需先计算括号内质量再乘系数  
2. **元素与系数联动**：如 `CuSO4·5H2O` 需先处理 `5` 再计算水合物  
3. **浮点数精度**：Cl(35.5) 等元素需正确处理小数运算  

### 算法可视化设计  
1. **动画流程**  
   - **高亮当前字符**：红色框标识当前扫描的字母/符号  
   - **递归栈展示**：右侧面板显示括号层数及当前子式质量  
   - **系数快读动画**：`_` 后数字以绿色闪烁提示读取过程  
   - **元素识别轨迹**：双字母元素用连线标记（如 `Mg` 的 `M`→`g`）  

2. **复古像素风格**  
   - **颜色方案**：元素用蓝色，数字用黄色，括号用紫色  
   - **音效设计**：  
     - 识别元素时播放 `8-bit` 短音  
     - 递归进入括号时播放低音鼓点  
     - 计算完成时播放经典 FC 过关音效  

---

## 【题解清单 (≥4星)】  
### 1. Iowa_BattleShip（★★★★☆）  
**亮点**：  
- 使用 `map<string,double>` 存储原子量，代码简洁  
- 通过引用传递游标 `i` 实现同步扫描  
- 独立函数 `cs()` 处理数字提取，复用性强  

**关键代码片段**：  
```cpp
double js(int &i) { // 元素解析函数
    string elem;
    elem += a[i++];
    while (islower(a[i])) elem += a[i++];
    double val = mp[elem];
    if (a[i] == '_') val *= cs(i += 2); // 处理下标
    return val;
}
```

### 2. 一扶苏一（★★★★☆）  
**亮点**：  
- 显式栈结构存储原子团质量  
- 模块化设计 `getnum()` 和 `getset()`  
- 水合物系数处理逻辑清晰  

**核心数据结构**：  
```cpp
double a[maxn]; // 原子团质量栈
int b[maxn];    // 系数栈
int top;         // 栈顶指针
```

### 3. ToBiChi（★★★★★）  
**亮点**：  
- 唯一实现完整的括号嵌套处理  
- 引入 `last` 变量记录前驱元素，简化系数乘法  
- 水合物处理直接截断字符串，降低复杂度  

**递归逻辑**：  
```cpp
double calc(int l, int r) {
    double sum = 0;
    for (int i=l; i<=r; ) {
        if (s[i] == '(') {
            int j = find_closing_bracket(i);
            sum += calc(i+1, j-1) * read_coeff(j+1);
            i = j + 1;
        } else {
            sum += read_element(i) * read_coeff(i);
        }
    }
    return sum;
}
```

---

## 【最优技巧提炼】  
1. **游标同步法**  
   ```cpp
   int i = 0;
   while (i < len) {
       if (s[i] == '(') i = process_bracket(i);
       else i = process_element(i); 
   }
   ```  
   通过统一游标 `i` 管理扫描位置，避免多层循环嵌套  

2. **系数快读模板**  
   ```cpp
   int read_num(int &pos) {
       int num = 0;
       while (isdigit(s[pos])) 
           num = num*10 + (s[pos++]-'0');
       return num ? num : 1; // 处理省略系数
   }
   ```

3. **递归截断策略**  
   ```cpp
   double parse_subformula(int &pos) {
       double sum = 0;
       while (s[pos] != ')') {
           sum += parse_element(pos);
       }
       pos++; // 跳过 ')'
       return sum * read_coeff(pos);
   }
   ```

---

## 【相似题目推荐】  
1. **P1175** 表达式的转换（中缀转后缀）  
2. **P1022** 计算器的改良（带变量解析）  
3. **P7078** [CSP-S2020] 贪吃蛇（多层嵌套逻辑）

---

## 【可视化实现方案】  
**HTML/JS 核心代码**：  
```html
<canvas id="demo" width="640" height="480"></canvas>
<script>
const elements = ["H", "O", "Cu"]; // 示例元素
let formula = "CuSO4·5H2O";
let ptr = 0; // 当前扫描位置

function draw() {
    ctx.fillStyle = "#2D2D2D"; // 复古背景色
    ctx.fillRect(0, 0, 640, 480);
    
    // 高亮当前字符
    ctx.fillStyle = "#FF5555";
    ctx.fillText(formula[ptr], 300 + ptr*16, 200);
    
    // 绘制递归栈
    stack.forEach((item, idx) => {
        ctx.fillStyle = "#55FF55";
        ctx.fillText(`层${idx}: ${item.mass}`, 500, 100 + idx*20);
    });
}

function step() {
    if (formula[ptr] === '(') {
        playSound('enter_bracket'); // 播放进入括号音效
        stack.push({ mass: 0 });
    }
    // ...其他扫描逻辑
}
</script>
```

---

## 【调试心得摘录】  
> "处理 `Cl35.5` 时发现浮点误差，改用整数运算（所有值×2），输出时再还原" —— Iowa_BattleShip  
> "水合物系数省略时需默认1，WA了3次才意识到" —— ToBiChi  
> "递归处理括号时游标越界，增加越界保护后AC" —— 一扶苏一  

---

## 【同类型题解对比】  
| 题解             | 游标管理 | 系数处理 | 括号嵌套 | 代码简洁度 |
|------------------|----------|----------|----------|------------|
| Iowa_BattleShip  | 引用传递 | 快读函数 | 不支持   | ★★★★☆      |
| 一扶苏一         | 显式栈   | 独立模块 | 支持     | ★★★☆☆      |
| ToBiChi          | 递归截断 | 即时计算 | 支持     | ★★★★★      |

---

通过以上分析，可系统掌握化学式解析的通用模式，其核心思想——游标扫描+递归处理——可推广至各类结构化字符串解析问题。

---
处理用时：93.92秒
# 题目信息

# [JRKSJ R7] 技巧性的块速递推

## 题目背景

充分必要，切比雪夫。

原来还是，不需要了。

## 题目描述

一个 $n\times m$ 的棋盘，对每个格子染上黑白两色之一。

询问有多少种染色方式，使得不存在横、竖、斜连续四个格子中存在至少三个相同颜色的格子，并且不存在横、竖、斜连续三个格子的颜色相同。

若设棋盘的左上角为 $(1,1)$，右下角为 $(n,m)$，则称 $\{(x,y),(x+1,y),(x+2,y)\}$ 为横的连续三个格子，$\{(x,y),(x,y+1),(x,y+2)\}$ 为竖的连续三个格子、$\{(x,y),(x+1,y+1),(x+2,y+2)\}$ 和 $\{(x,y),(x+1,y-1),(x+2,y-2)\}$ 为斜的连续三个格子（以上格子均在棋盘内）。

连续四个格子同理。

## 说明/提示

### 样例解释

样例 $1$：显然任意染色均合法，答案为 $2^4=16$。

样例 $2$：

```
101
110
010
```

这是合法方案之一。

```
111
110
011
```

这是不合法方案之一，因为 $\{(1,1),(1,2),(1,3)\}$、$\{(1,2),(2,2),(3,2)\}$ 和 $\{(1,1),(2,2),(3,3)\}$ 均不满足条件。

### 数据规模

本题采用捆绑测试。
| $\text{Subtask}$ | $n,m\le$ | $\text{Score}$ |
| :----------: | :----------: | :----------: | 
| $1$ | $30$ | $40$ |
| $2$ | $10^9$ | $60$ |

对于 $100\%$ 的数据，$1\le T\le 10^5$，$1\le n,m\le 10^9$。

## 样例 #1

### 输入

```
1
2 2```

### 输出

```
16```

## 样例 #2

### 输入

```
1
3 3```

### 输出

```
32```

# AI分析结果



## 算法分类
**其他搜索**（基于DFS的预处理与周期性规律发现）

---

## 题解思路与算法要点

### 核心思路
1. **周期性观察**：棋盘每4行/列颜色重复，形成周期性。因此任意大尺寸棋盘只需关注前7x7的局部情况。
2. **DFS剪枝优化**：对每个格子，若其左侧/上方已有3个确定值，则当前颜色由前3个颜色的少数派决定，无需枚举。
3. **斜向约束覆盖**：所有斜向约束最多在7x7范围内出现矛盾，因此预处理7x7即可覆盖所有可能情况。

### 解决难点
- **大范围n/m处理**：通过预处理将无限问题转化为有限规模，发现n/m≥7时的答案恒定。
- **斜向冲突检查**：在DFS过程中严格检查所有可能的连续3/4格斜向约束，确保预处理结果正确。

---

## 题解评分（≥4星）

### 题解1（作者：__ex）⭐⭐⭐⭐⭐
- **亮点**：完整推导周期性原理，预处理代码高效剪枝，覆盖7x7所有情况。
- **关键代码**：
```cpp
void dfs(int x,int y) {
    if(x>n)x=1,y++;
    if(y>m) { ans++; return; }
    if(x>=4) { // 剪枝：前三行确定后，当前行颜色唯一
        int sum = a[x-3][y] + a[x-2][y] + a[x-1][y];
        a[x][y] = (sum == 1) ? 1 : 0;
        dfs(x+1, y);
    } else { // 前3行需要枚举
        a[x][y] = 0; dfs(x+1, y);
        a[x][y] = 1; dfs(x+1, y);
    }
}
```

### 题解2（作者：zhangxiao666）⭐⭐⭐⭐
- **亮点**：详细注释+模块化check函数，便于理解约束条件。
- **技巧**：将斜向检查拆分为右下/右上两个方向，避免重复计算。

### 题解3（作者：WER_very_fox）⭐⭐⭐
- **亮点**：直接打表6x6数据，代码极简。
- **缺点**：未覆盖7x7情况，可能遗漏部分边界条件。

---

## 最优技巧提炼

### 关键技巧
1. **周期截断**：n/m≥7时答案等价于7x7，极大降低问题规模。
2. **颜色推导剪枝**：每行第4列后颜色由前三列唯一确定，DFS时间复杂度从O(2^nm)降至O(2^9)。
3. **斜向约束全覆盖**：预处理时严格检查所有可能的斜向连续3/4格，确保扩展后全局合法。

---

## 同类型题与算法套路

### 类似问题特征
- **大范围数据+局部规律**：如P1706 全排列问题（大n但只需前几项）、P1010 幂次方（递归分解）。
- **棋盘染色约束**：如P1433 吃奶酪（DFS+剪枝）、P1219 八皇后（斜向约束）。

### 推荐练习
1. **P1443 马的遍历**（BFS+大范围棋盘）
2. **P1074 靶形数独**（DFS剪枝+复杂约束）
3. **P2326 方块游戏**（周期性规律发现）

---

## 可视化设计思路

### 搜索过程动画
1. **节点扩展**：用像素方块表示棋盘，DFS时当前格闪烁黄色，已确定格显示黑白。
2. **剪枝提示**：当进入剪枝分支（x≥4）时，显示前三格颜色统计公式。
3. **冲突高亮**：若某步导致斜向冲突，该斜线变为红色并播放警报音效。

### 复古风格实现
```javascript
// 示例：8位像素风格绘制
ctx.fillStyle = '#000'; // 黑格
ctx.fillRect(x*16, y*16, 15, 15);
ctx.fillStyle = '#FFF'; // 白格
ctx.fillRect(x*16+1, y*16+1, 13, 13);
// 音效：访问新节点时播放8位"哔"声
const beep = new Audio('data:audio/wav;base64,UklGRl9...');
beep.play();
```

---

## 核心代码实现

### DFS预处理核心
```cpp
void dfs(int x, int y) {
    if (y > m) y = 1, x++;
    if (x > n) { ans += check(); return; }
    
    if (y >= 4) { // 横向剪枝
        int cnt = a[x][y-3] + a[x][y-2] + a[x][y-1];
        if (cnt < 1 || cnt > 2) return;
        a[x][y] = (cnt == 1) ? 1 : 0;
        dfs(x, y+1);
    } else { // 枚举可能性
        a[x][y] = 0; 
        if (check_partial(x,y)) dfs(x, y+1);
        a[x][y] = 1;
        if (check_partial(x,y)) dfs(x, y+1);
    }
}
```

---

通过上述分析，本题的核心在于发现棋盘的周期性规律与高效的DFS剪枝策略，结合预处理技术将指数级复杂度降至常数级别。

---
处理用时：77.79秒
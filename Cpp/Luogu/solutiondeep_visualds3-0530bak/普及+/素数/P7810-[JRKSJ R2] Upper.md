# 题目信息

# [JRKSJ R2] Upper

## 题目描述

有 $n$ 张扑克，第 $i$ 张扑克上写有一个正整数 $a_i$。

现在要把扑克划分成若干个合法的连续子段，其中，一个连续子段 $[l,r]$ “合法”当且仅当这个子段同时满足两个条件： 

* $a_l< a_r$
* $\gcd(a_l,a_r)>1$ 

请问最多能划分多少段。如果没有合法的划分方案，输出 $-1$ 即可。

如果您不知道 $\gcd$ 是什么意思，请看“提示”部分。

## 说明/提示

### 数据范围
本题采用捆绑测试。

对于 $100\%$ 的数据，$2\le n\le 10^5$，$1\le a_i\le 10^9$。

| $\text{Subtask}$ | $n\le$ | $a_i\le$ | 特殊性质 | 分值 |
| :----------: | :----------: | :----------: | :----------: | :----------: |
| $1$ | $5$ | $10^9$ | 无 | $5$ |
| $2$ | $3\times10^3$ | $10^9$ | 无 | $15$ |
| $3$ | $2\times10^4$ | $10^6$ | 无 | $20$ |
| $4$ | $2\times 10^4$ | $10^9$ | 无 | $10$ |
| $5$ | $10^5$ | $10^9$ | 数据随机 | $10$ |
| $6$ | $10^5$ | $10^9$ | 无 | $40$ |

### 样例解释
对于样例 $1$，有且仅有一种划分方案 $\{2,1,8\},\{3,9\}$。\
对于样例 $2$，无合法的划分方案。

### 提示
对于两个正整数 $a,b$，$\gcd(a,b)$ 为它们的最大公因数，即满足既是 $a$ 的因数又是 $b$ 的因数的数中最大的数。

## 样例 #1

### 输入

```
5
2 1 8 3 9```

### 输出

```
2```

## 样例 #2

### 输入

```
5
5 4 3 2 1```

### 输出

```
-1```

## 样例 #3

### 输入

```
20
20 9 36 36 40 8 3 10 9 20 18 12 30 20 30 15 8 9 27 45```

### 输出

```
7```

# AI分析结果



**唯一算法分类**：动态规划（DP）结合质因数分解与权值线段树优化

---

### **综合分析与结论**

#### **核心思路与难点**
1. **动态规划框架**：定义 `f[i]` 为前 `i` 个元素的最大分段数。转移方程需满足 `a[j] < a[i]` 且 `gcd(a[j], a[i]) > 1`。
2. **质因数分解优化**：将 `gcd` 条件转化为公共质因子存在性问题，每个数分解质因数后，仅需处理其质因子。
3. **数据结构优化**：对每个质因子维护权值线段树，快速查询满足 `a[j] < a[i]` 的最大 `f[j-1]`。

#### **关键步骤**
1. **质因数分解**：预处理小质数加速分解，每个数分解为不同质因子。
2. **线段树维护**：为每个质因子建立动态开点线段树，按离散化后的 `a[i]` 值插入 `f[i-1]`。
3. **查询与更新**：对当前数 `a[i]` 的每个质因子，查询线段树中小于 `a[i]` 的最大值，更新 `f[i]`。

#### **可视化设计**
- **动画步骤**：
  1. **分解质因数**：高亮当前处理的 `a[i]`，显示分解出的质因子（如用不同颜色标记）。
  2. **线段树查询**：对每个质因子的线段树，显示查询区间 `[1, a[i]-1]`，动态展示最大值提取过程。
  3. **线段树插入**：将 `f[i-1]` 插入对应质因子的线段树中，高亮插入位置。
- **复古像素风格**：
  - **颜色方案**：质因子用 8 位色调（如红色表示质数，绿色表示当前操作）。
  - **音效**：插入线段树时播放“滴”声，查询成功时播放“叮”声。

---

### **题解清单（≥4星）**

1. **KazamaRuri（5星）**  
   **亮点**：最优解实现，代码简洁，动态开点线段树高效维护质因子数据，预处理质数加速分解。

2. **ZillionX（5星）**  
   **亮点**：预处理质数表优化分解，结合 Exact Division 加速，代码效率极高，最优解 rk1。

3. **Spasmodic（4星）**  
   **亮点**：明确解释转移方程优化逻辑，代码结构清晰，使用 `unordered_map` 维护线段树根节点。

---

### **最优思路与代码片段**

#### **核心思路**
- **质因数分解**：对每个 `a[i]` 分解质因子，仅保留不同质因子。
- **权值线段树**：每个质因子对应线段树，维护离散化后 `a[j]` 的 `f[j-1]` 最大值。
- **动态更新**：对当前 `a[i]`，查询所有质因子的线段树，取最大 `f[j-1]+1`，并将 `f[i-1]` 插入对应线段树。

#### **代码片段（KazamaRuri）**
```cpp
// 离散化与初始化
sort(h+1, h+1+n);
cnt = unique(h+1, h+1+n) - h - 1;
for (int i=1; i<=n; i++)
    a[i] = lower_bound(h+1, h+1+cnt, a[i]) - h;

// 动态规划核心
for (int i=1; i<=n; i++) {
    for (auto x : q[i]) { // q[i] 存储 a[i] 的质因子
        if (rt[x]) f[i] = max(f[i], ask(rt[x], 1, n, a[i]-1) + 1);
        if (f[i-1] >= 0) upd(rt[x], 1, n, a[i], f[i-1]);
    }
}
```

---

### **相似题目推荐**
1. **P1891 [GCD](https://www.luogu.com.cn/problem/P1891)**  
   **关键词**：GCD 性质，区间查询。

2. **P2303 [Longge的问题](https://www.luogu.com.cn/problem/P2303)**  
   **关键词**：数论，质因数分解，求和优化。

3. **P2651 添加括号（加强版）**  
   **关键词**：动态规划，区间划分，数学性质优化。

---

### **个人心得摘录**
- **质数预处理**：小质数预处理显著加速分解，避免每次暴力试除。
- **动态开点线段树**：空间优化关键，避免为不存在的质因子预分配空间。

---

### **可视化与复古动画**
- **Canvas 绘制**：  
  - **网格布局**：每行表示一个质因子，线段树节点用方块表示，值大小用颜色深浅表示。
  - **操作高亮**：当前查询的线段树节点用闪烁边框标记，插入操作显示上升动画。
- **AI 自动演示**：按步执行分解、查询、插入操作，可调节速度为 1x/2x/5x。

---
处理用时：71.65秒
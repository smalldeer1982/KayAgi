# 题目信息

# 「TFOI R1」Tree Home

## 题目背景

阳光开朗大男孩天才 Z 今天要向蕉太狼表白力！

众所周知，蕉太狼是一个很可爱的女孩纸。
从前的天才 Z 总是担心因为自己表白失败而受到别人的嘲笑。但是今天，天才 Z 就要做出自己一生中最重要的一件事，那就是真诚地表白，无论后果如何。

出乎意料，蕉太狼其实也喜欢着天才 Z！

天才 Z 开心得像个 0#。

但是没过多久，天才 Z 就被甩力，原因蕉太狼发现天才 Z 对自己的闺蜜有非分之想。

天才 Z 拿出了自己的树状家谱，问候起了自己的祖宗们。

## 题目描述

有一个由 $n - 1$ 条**带权无向边**连接成的有 $n$ 个节点的树，每个节点都有它对应的**编号**以及**权值** $v_{i}$，整棵树的根节点为编号为 $1$ 的节点。

令 $f(a, b, c) = (a - b) \times \left[a^2 + b^2 + a \times b + 3 \times c \times (a + b + c)\right]$，其中 $a,b,c$ 可以为任意整数。同时用 $d_i$ 表示 $i$ 到根节点的每条边的**边权**之和。

现在天才 Z 要进行 $T$ 次询问，每次询问给定四个正整数 $l_{1},r_{1},l_{2},r_{2}$，你要从**编号**在区间 $[l_{1}, r_{1}]$ 和 $[l_{2}, r_{2}]$ 的点中各选择一个点 $p$ 和 $q$，当然你选择的两个点需要保证 $p \neq q$。用 $r$ 表示 $p$ 和 $q$ 的最近公共祖先，要使得 $|f(d_{p} - d_{r}, d_{q} - d_{r}, d_{r})| + |v_{p} - v_{q}|$ 的值最大，而你需要对每次询问输出这个最大值。

## 说明/提示

#### 样例解释

对于第一次询问，我们在两个区间分别取 $4$ 号点和 $6$ 号点即可得出答案 $19211$。

对于第二次询问，两个区间都只能取一个节点，所以答案为 $3$。


#### 数据范围

**本题采用捆绑测试**。

- Subtask 1（5 points）：$1 \leqslant n, T \leqslant 10$。
- Subtask 2（10 points）：$1 \leqslant n, T \leqslant 100$。
- Subtask 3（30 points）：$1 \leqslant n, T \leqslant 3000$。
- Subtask 4（55 points）：无特殊限制。

对于所有数据，$1 \leqslant n, T \leqslant 2 \times 10^5$，$0 \leqslant |w| \leqslant 25$，$1 \leqslant v_{x} \leqslant 10^9$，$1 \leqslant l_{1} \leqslant r_{1} \leqslant n$，$1 \leqslant l_{2} \leqslant r_{2} \leqslant n$，保证树中最大深度不超过 $100$。

**注意：两个区间 $[l_{1}, r_{1}]$ 和 $[l_{2}, r_{2}]$ 可能有重合部分。**

## 样例 #1

### 输入

```
7 2
5 1 7 12 5 9 6
1 2 5
3 1 1
6 2 9
4 6 14
7 6 4
5 2 10
2 4 5 7
1 1 3 3```

### 输出

```
19211
3```

# AI分析结果



---

### **唯一算法分类**  
数学推导与数据结构优化（ST表/线段树维护区间最值）

---

### **综合分析与结论**  
#### **核心思路**  
题目要求在两区间各选一点使组合函数最大，关键在于将复杂函数 $f$ 通过数学推导简化为 $|d_p^3 - d_q^3| + |v_p - v_q|$，进一步映射为曼哈顿距离的最值问题。通过维护每个节点的 $(d_i^3 + v_i)$ 和 $(d_i^3 - v_i)$ 的区间最大/最小值，利用 ST 表或线段树快速查询，最终取四种可能情况的最大差值。

#### **解决难点**  
1. **数学推导**：需将原式展开并化简，发现其可转化为立方差与权值差的组合。  
2. **曼哈顿距离最值**：通过拆解绝对值，将问题转化为维护两个新参数的区间最值。  
3. **高效查询**：使用 ST 表（时间/空间复杂度 $O(n \log n)$）或线段树（$O(n \log n)$ 预处理，$O(1)$ 查询）处理大规模数据。

#### **可视化设计要点**  
- **树结构遍历**：用像素风格展示 DFS 计算 $d_i$ 的过程，每个节点显示深度和边权累加。  
- **参数映射**：在节点旁标注 $(d_i^3 + v_i)$ 和 $(d_i^3 - v_i)$ 的值，颜色区分大小（如红色高亮极大值，蓝色极小值）。  
- **ST 表构建**：以网格动画演示 ST 表的逐层合并，动态显示区间覆盖范围。  
- **查询过程**：高亮查询区间，对比不同区间的最大/最小值，最终结果以爆炸粒子特效强调。

---

### **题解评分 (≥4星)**  
1. **Super_Cube（5星）**  
   - **亮点**：推导简洁，ST 表高效，代码简洁。  
   - **关键代码**：合并四个最值参数，单次查询 $O(1)$。  
   ```cpp
   struct node { long long v1, v2, v3, v4; }; // 维护 max(a+b), min(a+b), max(a-b), min(a-b)
   ```
2. **longlong666（4星）**  
   - **亮点**：独立维护四个 ST 表，逻辑清晰但空间稍大。  
3. **MrSWdAxiv（4星）**  
   - **亮点**：线段树实现，适合动态区间修改场景（本题无需）。  

---

### **最优思路与技巧提炼**  
1. **数学化简**：将原式 $f$ 展开后消去中间变量，发现仅依赖 $d_p^3 - d_q^3$。  
2. **曼哈顿距离拆分**：将 $|x| + |y|$ 拆解为 $\max(\pm x \pm y)$，转化为维护 $(d_i^3 + v_i)$ 和 $(d_i^3 - v_i)$。  
3. **ST 表优化**：预处理区间最值，支持快速查询，优于线段树的常数因子。  

---

### **相似题目推荐**  
1. [P5098 - 曼哈顿距离最值](https://www.luogu.com.cn/problem/P5098)  
2. [P1972 - 区间统计（树状数组/莫队）](https://www.luogu.com.cn/problem/P1972)  
3. [P1198 - 最大数（线段树/RMQ）](https://www.luogu.com.cn/problem/P1198)  

---

### **代码实现 (核心逻辑)**  
```cpp
// Super_Cube 的 ST 表实现（简化版）
struct ST {
    struct Node { 
        long long v1, v2, v3, v4; // v1: max(a+b), v2: min(a+b), v3: max(a-b), v4: min(a-b)
        friend Node operator+(const Node &x, const Node &y) {
            return {
                std::max(x.v1, y.v1), std::min(x.v2, y.v2),
                std::max(x.v3, y.v3), std::min(x.v4, y.v4)
            };
        }
    } st[MAXN][20];
    void init() {
        for (int i=1; i<=n; ++i) {
            long long d3 = 1LL * dis[i] * dis[i] * dis[i];
            st[i][0] = {d3 + a[i], d3 + a[i], d3 - a[i], d3 - a[i]};
        }
        for (int j=1; (1<<j)<=n; ++j)
            for (int i=1; i+(1<<j)-1<=n; ++i)
                st[i][j] = st[i][j-1] + st[i + (1<<(j-1))][j-1];
    }
    Node ask(int l, int r) {
        int k = std::__lg(r - l + 1);
        return st[l][k] + st[r - (1<<k) + 1][k];
    }
};
```

---

### **可视化与算法演示**  
#### **动画方案**  
1. **树遍历**：DFS 过程用绿色高亮当前边，红色标记已访问节点，动态显示 $d_i$ 计算。  
2. **参数映射**：每个节点旁显示 $(d_i^3 + v_i)$ 和 $(d_i^3 - v_i)$，颜色渐变（红→蓝表示值大小）。  
3. **ST 表构建**：逐层填充区间最值，用黄色框标注合并区间。  
4. **查询交互**：用户输入区间后，高亮对应范围，显示最值对比，最终结果以金色闪光提示。  

#### **复古游戏化设计**  
- **像素风格**：8-bit 树节点，边权用 8x8 像素字体显示。  
- **音效**：DFS 时播放“滴”声，查询成功播放“金币”音效。  
- **自动演示**：按空格键逐步执行，按 'A' 键自动播放全流程。  

---

### **个人心得摘录**  
> “关键在于发现曼哈顿距离的拆分技巧，ST 表预处理让大规模查询变得可行。” —— Super_Cube  
> “线段树虽然通用，但本题静态数据更适合 ST 表，常数更小。” —— a1a2a3a4a5

---
处理用时：73.12秒
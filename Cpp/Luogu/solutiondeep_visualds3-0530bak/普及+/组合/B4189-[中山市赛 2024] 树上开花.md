# 题目信息

# [中山市赛 2024] 树上开花

## 题目描述

你有一棵以 1 为根的树，统计点对 $(x, y)$，满足 $a_{lca(x,y)}$ 是 $a_x$ 和 $a_y$ 的公约数。注意当
$x \neq y$ 时 $(x, y)$ 和 $(y, x)$ 视为不同的点对。



## 说明/提示

### 样例解释

以下点对满足条件：$(1, 1)$，$(1, 3)$，$(1, 5)$，$(2, 2)$，$(3, 1)$，$(3, 3)$，$(3, 5)$，$(4, 4)$，$(5, 1)$，$(5, 3)$，$(5, 5)$。

### 数据范围

本题数据分为多个子任务，具体如下：

| 子任务编号 | $n$ | 附加条件 | 子任务分数 |
| :----------: | :----------: | :----------: | :----------: |
| $1$ | $\leq 150$ | 无 | $10$ |
| $2$ | $\leq 1500$ | 无 | $10$ |
| $3$ | $\leq 10^5$ | 树为随机生成 | $10$ |
| $4$ | $=99998$ | $a_i\leq 300$ | $10$ |
| $5$ | $=99998$ | $a$ 为 $1\sim n$ 的排列 | $10$ |
| $6$ | $\leq 10^5$ | 无 | $50$ |


对于所有数据，保证 $1 \leq a_i \leq n$。

## 样例 #1

### 输入

```
5
2 3 2 5 4
1 2
1 3
2 4
2 5```

### 输出

```
11```

# AI分析结果



**唯一算法分类**：树状数组 + 离线处理 + 因数枚举

---

### **综合分析与结论**

#### **核心思路**
题目要求统计所有点对 $(x,y)$，使得 $a_{\text{lca}(x,y)}$ 是 $a_x$ 和 $a_y$ 的公约数。核心解法是：  
1. **枚举因数**：对每个可能的因数 $d$，处理所有满足 $d$ 是 $a_{\text{lca}(x,y)}$ 的点对。  
2. **离线处理**：预处理每个节点的所有因数，并按因数分组。  
3. **子树计数**：利用树状数组维护当前有效节点（满足 $a_i$ 是当前因数 $d$ 的倍数），快速查询子树内的点数。  
4. **容斥原理**：对于每个节点 $w$，统计其子树内点对数时，减去其各子树的内部贡献。

#### **解决难点**
- **动态子树统计**：通过 DFS 序将子树转换为区间查询，树状数组高效维护动态点集。  
- **因数枚举优化**：预处理每个数的所有因数，避免重复计算。  
- **时间复杂度控制**：利用 $d(n)$ 的较小值（约数个数），总复杂度 $O(n \cdot d(n) \log n)$。

#### **可视化设计**
- **动画流程**：  
  1. **枚举因数 $d$**：高亮当前处理的因数 $d$，显示对应的节点集合。  
  2. **树状数组更新**：动态显示插入/删除节点的 DFS 序位置。  
  3. **子树查询**：高亮当前节点 $w$ 的子树区间，展示区间查询结果。  
  4. **贡献计算**：分步显示总贡献和各子树的扣除过程。  
- **复古风格**：用 8 位像素风格绘制树结构，树状数组以网格形式展示，音效在插入/查询时触发。

---

### **题解清单 (≥4星)**

#### **1. 作者：Sliarae (⭐⭐⭐⭐⭐)**  
- **核心亮点**：离线处理因数，树状数组动态维护子树点集，代码简洁高效。  
- **关键代码**：预处理因数 → 树状数组插入/删除 → 容斥计算贡献。  
- **个人心得**：“通过枚举因数和离线处理，巧妙避免了重复计算。”

#### **2. 作者：OIer_ljb (⭐⭐⭐⭐)**  
- **核心亮点**：手写排序优化，树状数组维护子树点对数的平方贡献。  
- **关键代码**：子树 DFS 序排序 → 树状数组区间查询 → 平方差计算。  
- **个人心得**：“树状数组的小常数优化是关键。”

#### **3. 作者：xiaofu15191 (⭐⭐⭐)**  
- **核心亮点**：树剖预处理子树信息，二分查找统计点数。  
- **缺点**：实现复杂，未完全通过所有测试用例。

---

### **最优思路提炼**

#### **关键步骤**
1. **预处理因数**：对每个节点 $u$，预处理所有 $a_u$ 的因数。  
2. **离线分组**：将节点按因数分组，每组对应一个可能的公因数 $d$。  
3. **动态维护点集**：  
   - 枚举因数 $d$，将 $a_i$ 是 $d$ 倍数的节点插入树状数组。  
   - 查询子树内点数时，通过 DFS 序区间 $[\text{dfn}(w), \text{end}(w)]$ 计算。  
4. **容斥计算**：  
   - 总贡献为 $(\text{子树点数})^2$，扣除各子树内部的平方贡献。

#### **代码实现**
```cpp
// 核心代码：Sliarae 的树状数组 + 离线处理
void Dfs(int u) { // 预处理 DFS 序
    in[u] = ++now;
    for (auto v : e[u]) if (v != fa[u]) Dfs(v);
    out[u] = now;
}

for (int d = 1; d <= n; ++d) { // 枚举因数
    for (auto i : tag[d]) tr.Add(in[i], 1); // 插入当前因数对应节点
    for (auto u : p[d]) { // 处理所有 a[u] = d 的节点
        LL total = Square(tr.Query(in[u], out[u])); // 总贡献
        for (auto v : e[u]) if (v != fa[u]) { // 扣除子树贡献
            LL sub = tr.Query(in[v], out[v]);
            total -= Square(sub);
        }
        ans += total;
    }
    for (auto i : tag[d]) tr.Add(in[i], -1); // 删除节点
}
```

---

### **同类型题与算法套路**
- **通用解法**：树上统计问题 + 离线处理 + 因数/倍数枚举。  
- **类似题目**：  
  1. [CF342E] Xenia and Tree（树分块 + 离线查询）  
  2. [Luogu P4213] 小清新人渣的本愿（莫队 + 因数枚举）  
  3. [Luogu P5494] 线段树分裂与合并（动态维护区间集合）

---

### **推荐题目**
1. **CF1479D** - 树上路径颜色统计（离线 + 莫队）  
2. **Luogu P4211** - 线性代数与树结构（树剖 + 矩阵维护）  
3. **Luogu P5354** - 动态因数查询（线段树 + 因数预处理）

---

### **个人心得摘录**
- **调试教训**：“预处理因数时需注意平方数重复添加的问题。”  
- **优化经验**：“树状数组的 DFS 序区间查询是核心，务必保证插入顺序正确。”

---

### **可视化与算法演示**
#### **动画方案**
1. **树结构绘制**：以像素风格显示树，根节点在顶部，子节点向下展开。  
2. **因数枚举**：左侧面板显示当前因数 $d$，右侧高亮所有 $a_i$ 是 $d$ 倍数的节点。  
3. **树状数组操作**：  
   - **插入/删除**：节点变为绿色（插入）或红色（删除）。  
   - **区间查询**：子树区间以蓝色框显示，结果动态更新。  
4. **音效触发**：  
   - 插入节点时播放“滴”声，删除时“咔嚓”声。  
   - 计算贡献时播放短旋律，错误操作时低沉音效。  

#### **复古风格设计**
- **颜色方案**：16 色调色板，树节点用绿色，树状数组网格用灰色。  
- **Canvas 绘制**：树节点用圆点表示，树状数组用方格表示，步进动画速度可调。  
- **AI 模式**：自动播放各因数处理流程，类似“贪吃蛇 AI”路径演示。

---
处理用时：82.47秒
# 题目信息

# 「EZEC-2」机器

## 题目背景

tlx 喜欢科幻小说。   

>小宇宙中只剩下漂流瓶和生态球。漂流瓶隐没于黑暗里,在一千米见方的宇宙中,只有生态球里的小太阳发出一点光芒。在这个小小的生命世界中,几只清澈的水球在零重力环境中静静地飘浮着,有一条小鱼从一只水球中蹦出,跃入另一只水球,轻盈地穿游于绿藻之间。在一小块陆地上的草丛中,有一滴露珠从一片草叶上脱离,旋转着飘起,向太空中折射出一缕晶莹的阳光。    
>$\qquad \qquad \qquad \qquad \qquad \qquad \qquad\qquad\qquad\qquad\qquad\qquad\qquad --$《三体》    

在另一个宇宙，将是另一番奇景吧。    

在那里，重力似乎变得微不足道了，引力机器成了司空见惯的东西。

引力机器装置内并没有重力，即若有物体在机器上运动，运动过程中只受机器给予的引力，这个力有一定几率使物体向施力物体快速移动，达到一定动力时就可以实现瞬移。



## 题目描述

一个引力机器由一个光滑圆轨道和 $2n$ 个小孔组成（小孔按**逆时针**从 $1$ 到 $2n$ 编号，每两个相邻的小孔所夹的**劣弧**度数为 $\dfrac{\pi}{n}$ ），每个小孔与和其夹角为 $\pi$ 的另一个小孔有通道相连，比如当 $n=2$ 时，$1$ 号孔和 $3$ 号孔相连。

当 $n=2$ 时，这个装置的构造大概是这样的：
 
 ![](https://cdn.luogu.com.cn/upload/image_hosting/el8alxde.png) 
 
现在我们在 $1$ 号孔处放一个小球，使它一直**沿逆时针方向做匀速圆周运动**，在不瞬移的情况下，每一秒恰好能从一个小孔运动至下一个小孔。

由于未来实验室构造奇特（内部的引力提供装置太神了！），每经过一个小孔时，有 $p$ 的概率**立刻瞬移**（即不花费时间）到通道对面的小孔并继续沿逆时针方向做匀速圆周运动，也就是有 $1-p$ 的概率继续沿圆周向下一个小孔运动。

值得注意的是，**每一单位时刻，小球只能瞬移一次**。  

简单地说，若某一时刻小球在小孔 $i$，则下一时刻它可能运动到小孔 $i \bmod 2n + 1$ 或 $(i + n) \bmod 2n + 1$，概率分别为 $1-p$ 和 $p$。

现在 tlx 有两个一模一样的引力机器，两个小球同时从 $1$ 号孔开始运动。他会**随机**（所有可能选择的概率相同）选择一个二元组 $(i,j)( 1\leqslant i\leqslant 2n,0\leqslant j\leqslant t,i,j\in \mathbb Z$ ) 分别代表小孔编号和时间，你需要求出时间为 $j$ 时两个引力机器的小孔 $i$ **同时**有小球**停留（运动经过小孔但瞬移到对面了不算停留）** 的概率。

注意：**小球刚开始运动时也可能瞬移到对面的小孔。**   

为方便计算，我们规定：所有概率都是在模 $10^9+7$ 意义下的。      

## 说明/提示

**【数据范围与约定】** 

**本题采用捆绑测试。**    

具体计分方式如下：   

- Subtask $1$ ($7$ points)：满足 $p\in \{0,1\}$；  
- Subtask $2$ ($13$ points)：满足 $t\leqslant 20,n\leqslant50$；  
- Subtask $3$ ($20$ points)：满足 $t\leqslant 10^3,n\leqslant50$；  
- Subtask $4$ ($10$ points)：满足 $t\leqslant 10^3$；  
- Subtask $5$ ($10$ points)：满足 $t\leqslant 10^6$；
- Subtask $6$ ($15$ points)：满足 $n\leqslant50$；
- Subtask $7$ ($25$ points)：无特殊限制。


对于 $100\%$ 的数据，满足 $2\leqslant n\leqslant 500$，$0\leqslant p\leqslant 10^9+6$，$0\leqslant t \leqslant 10^9$。  

**注意：不做说明的数据范围即为极限数据范围。**

**【样例解释 #1】**  

$500000004$ 是模 $10^9+7$ 意义下的 $\dfrac{1}{2}$。 

下面为了方便，记 $P(i,j)$ 为选择的二元组为 $(i,j)$ 时的概率。    

所有概率不为 $0$ 的二元组有：   
$P(1,0)=\dfrac{1}{4},P(3,0)=\dfrac{1}{4},P(2,1)=\dfrac{1}{4},P(4,1)=\dfrac{1}{4}$。    

所有可以选择的二元组有：   
$(1,0),(1,1),(2,0),(2,1),(3,0),(3,1),(4,0),(4,1)$，共 $8$ 种。    

所以总的概率：  
$$P=\dfrac{1}{8}×\dfrac{1}{4}×4+\dfrac{1}{8}×0×4=\dfrac{1}{8}$$

在模 $10^9+7$ 意义下为 $125000001$，即为输出的答案。

------------

**【其他提示】**

1. 如果你不了解分数取模，可以查看[这里](https://www.luogu.com.cn/problem/P2613)。  

2. 如果你不明白题目中角度的表示方法，可以查看[弧度制](https://baike.baidu.com/item/弧度制/3315973?fr=aladdin)。



## 样例 #1

### 输入

```
2 500000004 1```

### 输出

```
125000001```

## 样例 #2

### 输入

```
6 114514 11```

### 输出

```
756497239```

# AI分析结果



### 唯一算法分类
数学推导与概率分析

---

### 综合分析与结论

**核心思路**：  
通过分析瞬移次数的奇偶性确定小球位置，将概率问题转化为等比数列求和。核心发现是两个小球同一位置的条件是瞬移次数奇偶相同，利用二项式定理推导出概率表达式，最终通过等比数列快速计算总和。

**解决难点**：  
1. **奇偶瞬移次数的等价条件**：瞬移奇数次导致位置相差半圈，偶数次则位置相同。  
2. **概率表达式化简**：将二项式概率求和转化为关于 `(1-2p)^k` 的幂次形式。  
3. **等比数列求和优化**：处理 `(1-2p)^2k` 的累加，避免逐个计算。

**可视化设计**：  
- **动画演示**：展示小球随时间的位置变化，高亮奇偶瞬移次数的对应位置。  
- **动态公式更新**：实时显示 `(1-2p)^2k` 的数值变化与累加过程。  
- **复古像素风格**：用像素块表示小球位置，8位音效标记瞬移事件。

---

### 题解清单 (≥4星)

1. **NaCly_Fish（5星）**  
   - **关键亮点**：数学推导简洁，直接通过奇偶性条件与二项式定理化简问题。  
   - **代码优势**：仅需快速幂与逆元计算，实现高效。

2. **JohnVictor（4星）**  
   - **亮点**：详细推导瞬移次数奇偶性条件，强化数学分析。  
   - **不足**：最终公式排版需优化。

3. **君のNOIP。（4星）**  
   - **亮点**：矩阵快速幂实现清晰，状态压缩合理。  
   - **适用性**：适合习惯动态规划的开发者。

---

### 最优思路提炼

**核心技巧**：  
1. **奇偶性分析**：将位置相同问题转化为瞬移次数奇偶同余。  
2. **数学变换**：利用二项式定理将概率求和转换为幂次表达式。  
3. **等比数列优化**：通过快速幂直接计算多项式求和，避免逐项累加。

**代码实现**：  
```cpp
LL qui(LL x, LL y) { // 快速幂
    LL s = 1;
    while(y) {
        if(y & 1) s = s * x % mod;
        x = x * x % mod;
        y >>= 1;
    }
    return s;
}

LL solve() {
    LL q = (1 - 2 * p + mod) % mod; // (1-2p) mod
    LL q_sq = q * q % mod;          // (1-2p)^2
    LL numerator, denominator;

    if (q_sq == 1) { // 公比为1时直接计算
        numerator = (t + 1) % mod;
    } else { // 等比数列求和
        numerator = (qui(q_sq, t + 1) - 1 + mod) % mod;
        numerator = numerator * qui((q_sq - 1 + mod) % mod, mod - 2) % mod;
    }
    // 最终答案公式
    LL ans = (1 + numerator) % mod;
    ans = ans * qui(2, mod - 2) % mod; // 除以2
    ans = ans * qui(2 * n, mod - 2) % mod; // 除以2n
    ans = ans * qui(t + 1, mod - 2) % mod; // 除以(t+1)
    return ans;
}
```

---

### 类似题目推荐

1. **P1349 广义斐波那契数列**  
   - 快速幂与递推结合，类似矩阵优化思想。

2. **P1939 矩阵加速（数列）**  
   - 矩阵快速幂应用，状态转移设计。

3. **P2613 有理数取模**  
   - 分数取模与逆元计算，本题核心操作。

---

### 可视化与复古动画设计

**核心动画**：  
1. **小球运动轨迹**：  
   - 用两个像素块表示小球，颜色区分瞬移奇偶次数。  
   - 每秒更新位置，瞬移时播放8位音效（如“哔”声）。

2. **公式动态更新**：  
   - 右侧面板显示 `(1-2p)^2k` 的实时值与累加和，高亮当前项。

**复古风格**：  
- **调色板**：16色FC风格，绿色小球、红色瞬移标记。  
- **Canvas网格**：轨道以圆环像素化呈现，小孔编号闪烁。  
- **音效触发**：瞬移时触发短促音效，背景播放8位循环音乐。

**交互功能**：  
- **速度调节**：滑动条控制动画速度（1x~10x）。  
- **单步执行**：按空格键逐帧观察瞬移与概率变化。

---
处理用时：107.97秒
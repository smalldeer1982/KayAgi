# 题目信息

# 选书

## 题目描述

学校放寒假时，信息学奥赛辅导老师有 $1,2,3,\cdots,x$ 本书，要分给参加培训的 $x$ 个人，每人只能选一本书，但是每人有两本喜欢的书。

老师事先让每个人将自己喜欢的书填写在一张表上。然后根据他们填写的表来分配书本，希望设计一个程序帮助老师求出所有可能的分配方案，使每个学生都满意。

## 说明/提示

### 数据范围及约定

对于全部数据，$1\le x\le 20$。


$\text{update 2022/03/07}$，阮行止

本题原始数据中，最后一个数据点的 x 为 $0$，期望输出为  $0$。考虑到这个数据不合理，予以删去。现在提交这个题目不会遇到 $x=0$ 的数据点。




## 样例 #1

### 输入

```
5
1 3
4 5
2 5
1 4
3 5```

### 输出

```
2```

# AI分析结果



## 算法分类
**回溯/DFS**

---

## 题解思路与难点对比

### 核心思路
题目要求为每个学生分配一本喜欢的书，所有可能的分配方案需满足：
1. **每人一本喜欢的书**
2. **每本书只能被选一次**

题解主要分为两类：
1. **回溯法**：递归地为每个学生选择两本喜欢的书中的一本，通过标记数组避免重复选择。时间复杂度为 $O(2^x)$，但因剪枝优化，实际效率较高。
2. **图论法**：将书与人之间的选择关系建模为图，合法方案对应图的每个连通块为环或基环树，最终方案数为 $2^k$（$k$ 为连通块数目）。时间复杂度 $O(n)$，是理论最优解。

### 解决难点
- **回溯法**：需及时剪枝，避免无效递归（如某本书已被选时立即回溯）。
- **图论法**：需正确建模问题为图的连通块分析，判断每个连通块是否符合条件（边数=点数）。

---

## 题解评分（≥4星）

### 5星题解
- **Hope2075（图论法）**  
  **亮点**：线性时间复杂度，理论最优解。通过建图分析连通块性质，将问题转化为环的判断，思路独特高效。

### 4星题解
- **Baihua（回溯法）**  
  **亮点**：代码简洁，直接对每个学生选择两本书中的一本递归处理，逻辑清晰易实现。
- **_louhc（状态压缩）**  
  **亮点**：使用位运算压缩状态，减少空间占用，代码巧妙。
- **hsfzLZH1（回溯法）**  
  **亮点**：代码逻辑清晰，剪枝优化到位，递归结构简洁。

---

## 最优思路提炼
1. **回溯剪枝**：递归选择每人的两本喜欢书之一，通过标记数组避免重复，及时回溯无效路径。
   ```cpp
   void dfs(int x) {
       if (x > n) { ans++; return; }
       if (!used[a[x][0]]) {
           used[a[x][0]] = 1;
           dfs(x + 1);
           used[a[x][0]] = 0;
       }
       if (!used[a[x][1]]) {
           used[a[x][1]] = 1;
           dfs(x + 1);
           used[a[x][1]] = 0;
       }
   }
   ```
2. **图论建模**：将每人的两本喜欢书连边，合法方案对应环结构，总方案数为 $2^k$。
   ```cpp
   void dfs(int id, int p) {
       gid[id] = p;
       for (int i = head[id]; i; i = next[i]) {
           if (!gid[ver[i]]) dfs(ver[i], p);
       }
   }
   ```

---

## 同类型题推荐
1. **P1219 八皇后**（回溯经典问题）
2. **P1351 联合权值**（图论邻接分析）
3. **P1120 小书童——密码**（状态压缩应用）

---

## 个人心得摘录
- **Baihua**：强调回溯需注意细节（如标记数组的还原）。
- **Hope2075**：指出图论分析的关键是连通块的环结构。
- **_louhc**：状态压缩在减少空间复杂度上的优势。

---

## 可视化设计
### 回溯法动画
1. **递归树展开**：以像素风格显示递归树，每个节点表示当前学生选择的书，红色高亮当前路径。
2. **音效反馈**：选择合法书时播放“确认音”，回溯时播放“撤销音”。
3. **自动模式**：模拟递归的展开与回溯，按步演示剪枝过程。

### 图论法动画
1. **建图过程**：动态绘制书与人的边，不同颜色区分连通块。
2. **环检测**：用扫描线效果标记环，合法时播放“成功音效”。
3. **控制面板**：支持切换自动/手动模式，调节动画速度。

---

## 核心代码片段
### 回溯法（Baihua）
```cpp
int a[maxn][2], ans;
bool used[maxn];
void dfs(int x) {
    if (x > n) { ans++; return; }
    if (!used[a[x][0]]) {
        used[a[x][0]] = 1;
        dfs(x + 1);
        used[a[x][0]] = 0;
    }
    if (!used[a[x][1]]) {
        used[a[x][1]] = 1;
        dfs(x + 1);
        used[a[x][1]] = 0;
    }
}
```

### 图论法（Hope2075）
```cpp
void dfs(int id, int p) {
    gid[id] = p;
    for (int i = head[id]; i; i = next[i]) {
        if (!gid[ver[i]]) dfs(ver[i], p);
    }
}
for (int i = 1; i <= n; i++) {
    if (cnt[i] * 2 != cdeg[i]) {
        printf("0\n");
        return 0;
    }
    if (cnt[i]) ans = ans * 2 % MOD;
}
```

---
处理用时：196.24秒
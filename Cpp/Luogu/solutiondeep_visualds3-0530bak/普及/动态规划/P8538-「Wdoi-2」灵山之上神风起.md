# 题目信息

# 「Wdoi-2」灵山之上神风起

## 题目背景

在天狗记者射命丸文的指（放）引（水）之下，灵梦一行人找到了山中的神社。

“在妖怪之山上还真的存在其他的神社啊。”灵梦感慨道。她们看到了由树木建造的神社正殿，以及正殿前的参拜道上的一排御柱，而更远处则是一片湖——风神之湖。湖面非常开阔，波光粼粼，一碧万顷，远处似乎有群山环抱，让人心旷神怡。

到达神社之时已经是傍晚了。正当灵梦和魔理沙感慨之时，见到在她们面前有一位白衣蓝裙的少女，东风谷早苗，拥有着引发奇迹程度的能力。为了找到守矢神社中的两位神灵，灵梦与魔理沙，向东风谷早苗产生了激烈的交战。

“那就在现人神的力量洗礼中思索吧！这召唤奇迹的神明之力！”

## 题目描述

### 简要题意

给定一个长度为 $n$ 的正整数序列 $a$ 满足对于所有 $i\in [1,n]$ 有 $a_i \in \{1,2,3\}$。

现在通过该序列构造一张含 $n$ 个节点，节点编号为 $1$ 到 $n$ 的图：对于数 $i$，如果 $a_i=1$，那么什么都不做；如果 $a_i=2$，那么向所有比 $i$ 小的数的节点连无向边；如果 $a_i=3$，那么向所有比 $i$ 大的数的节点连无向边。求出该图的最大独立集的大小。

最大独立集，指的是原图中一个点数尽量多的点集，这些点在原图中两两之间没有边**直接**相连。

### 原始题意

然而，东风谷早苗（后称早苗）的弹幕密度相当之高，使人应接不暇，灵梦只得想个方法去减少她需要关注的弹幕数量。

数个回合过后，她发现，早苗每次释放弹幕只会释放出 $n$ 个弹幕，分别编号为 $1,2,\dots,n$，而她每释放一个弹幕，都会对应着产生一次神力波动。因而她的神力波动可以抽象为一个长度为 $n$ 的正整数数列 $\{a_n\}$。由于她的资历尚浅，只会使用三种神力，分别用 $1,2,3$ 表示，即 $\forall i \in [1,n]$，$a_i \in \{1,2,3\}$。

她发现，早苗的三种神力作用各不相同，具体而言如下：

- 当 $a_i=1$ 时，她不会做任何事情。
- 当 $a_i=2$ 时，早苗会让第 $i$ 个弹幕向所有弹幕编号**小于** $i$ 的弹幕建立神力输送通道。
- 当 $a_i=3$ 时，早苗会让第 $i$ 个弹幕向所有弹幕编号**大于** $i$ 的弹幕建立神力输送通道。

接着，在各种神力的交互配合之下，密集的弹幕将展开于灵梦的眼前。而一旁的魔理沙发现，若是从这些弹幕中挑选出**尽可能多的**一群弹幕，使得每个弹幕之间不存在直接相连的神力输送通道，那么这群弹幕会产生【引发奇迹程度的能力】，是不必关注的。

由于【引发奇迹程度的能力】只能被触发**一次**，灵梦和魔理沙想要知道，**最多**有多少个弹幕是不必关注的。她们找到了你，希望你能帮她解答。

## 说明/提示

### 样例解释

根据题意显然可以构造出如下的图。其中 $a_i=2$ 的用蓝色边表示，$a_i=3$ 的用红色边表示。

显然选取第 $2,3$ 个弹幕（已用绿色填图）是最多的情况。实际上对于这个样例，选取弹幕的方案不止一种，但是不存在更多的情况了。

![](https://cdn.luogu.com.cn/upload/image_hosting/99a854cu.png)

### 数据范围

$$
\def\arraystretch{1.5}
\begin{array}{|c|c|c|c|}\hline
\textbf{Subtask} & \bm{n\le} & \textbf{特殊性质} & \textbf{分值}\\\hline
1 & 10 & - & 20\\\hline
2 & 10^5 & \text{A} & 10\\\hline
3 & 10^5 & \text{B} & 30 \\\hline
4 & 10^5 & - & 40 \\\hline
\end{array}$$

- 特殊性质 $\text{A}$：所有的 $a_i=1$；
- 特殊性质 $\text{B}$：所有的 $a_i$ 不是 $1$ 就是 $2$。

对于 $100\%$ 的数据，$1 \leq n \leq 10^5$，$a_i \in \{1,2,3\}$。

## 样例 #1

### 输入

```
6
3 1 3 2 1 2```

### 输出

```
2```

# AI分析结果



### 唯一算法分类  
无算法分类  

### 综合分析与结论  
本题核心在于通过贪心策略分情况讨论最大独立集的可能性，而非传统动态规划。关键点如下：  
1. **所有 a_i=1 的节点必须全选**，因为它们互不连边。  
2. **非1节点（a_i=2/3）的选取受限**：至多各选一个，且需满足位置关系。  
3. **四种情况覆盖所有最优解可能性**：  
   - 只选1的节点  
   - 选一个最左的2节点及其右侧的1  
   - 选一个最右的3节点及其左侧的1  
   - 选最左的2和最右的3（需满足位置关系）及中间的1  

### 题解清单 (≥4星)  
1. **chen_zhe (5星)**  
   - **关键亮点**：全面覆盖四种情况，正确处理位置约束，代码简洁高效。  
   - **核心实现**：通过遍历确定最左2和最右3的位置，分别计算各情况的最大值。  

2. **Gaode_Sean (5星)**  
   - **关键亮点**：前缀和优化统计1的数量，四情况取最大值的逻辑清晰。  
   - **核心实现**：利用前缀和数组快速计算各区间的1的数量，确保时间复杂度为 O(n)。  

3. **AirQwQ (4星)**  
   - **关键亮点**：直观理解2/3节点的约束关系，代码简洁易懂。  
   - **核心实现**：直接在最左1的左侧找2，最右1的右侧找3，处理边界条件。  

### 最优思路或技巧提炼  
1. **分治贪心**：将问题拆解为四种独立情况，逐一计算后取最大值。  
2. **前缀和优化**：通过预处理前缀和数组，快速统计区间内1的数量。  
3. **位置约束判断**：确保非1节点（2/3）的选取不会引入冲突边。  

### 同类型题或类似算法套路  
- **区间覆盖问题**：如选择区间端点，最大化覆盖范围。  
- **分情况贪心**：如 P1020 导弹拦截中的两种拦截策略选择。  

### 推荐相似题目  
1. **P1352 没有上司的舞会**（树的最大独立集）  
2. **P1020 导弹拦截**（分情况贪心策略）  
3. **P1880 石子合并**（区间分治与最优化）  

### 个人心得摘录  
- **边界条件陷阱**：没有1的序列需特判（如 `3 2` 只能选一个节点）。  
- **贪心直觉验证**：通过构造极端样例（如 `2 1 3`）验证代码正确性。  

### 可视化与算法演示  
**核心逻辑动画设计**：  
1. **网格绘制**：将序列按节点排列，用不同颜色区分 a_i=1/2/3。  
2. **区块高亮**：  
   - 绿色区块：所有 a_i=1 的节点。  
   - 红色/蓝色区块：选中的2/3节点及其影响范围。  
3. **动态更新**：  
   - 展示四种情况对应的选中区域及计算结果。  
   - 步进控制：手动切换不同情况，对比数值变化。  

**复古像素风格实现**：  
- **8位调色板**：绿色（1）、深蓝（2）、亮红（3）。  
- **音效触发**：选中节点时播放清脆音效，切换情况时播放切换音。  
- **自动演示模式**：按顺序展示四种情况，最终高亮最大结果。  

---

### 代码片段（Gaode_Sean 的核心实现）  
```cpp
#include<bits/stdc++.h>
using namespace std;
const int N=1e5+5;
int n,a[N],s[N],l,r;
int main() {
    scanf("%d",&n);
    for(int i=1;i<=n;i++) {
        scanf("%d",&a[i]);
        s[i]=s[i-1]+(a[i]==1);
    }
    for(int i=1;i<=n;i++) if(a[i]==3) r=i;
    for(int i=n;i>=1;i--) if(a[i]==2) l=i;
    int ans=s[n];
    if(l) ans=max(ans, s[n]-s[l-1]+1);
    if(r) ans=max(ans, s[r]+1);
    if(l&&r && r>l) ans=max(ans, s[r-1]-s[l-1]+2);
    printf("%d",ans);
    return 0;
}
```  
**核心思想**：利用前缀和快速统计1的数量，通过四情况取最大值确保最优解。

---
处理用时：209.79秒
# 题目信息

# 不成熟的梦想家 (未熟 DREAMER)

## 题目背景

**どんな未来かは 誰もまだ知らない**

**那是个任谁也不会知晓的未来**

**でも楽しくなるはずだよ**

**但应该会充满乐趣吧**

**みんなとなら乗りこえられる**

**只要大伙儿同在 就能跨越难关**

**これからなんだねお互いがんばろうよ**

**现在才正要开始 彼此互相加油吧**

**どんな未来かは 誰もまだ知らない**

**那是个任谁也不会知晓的未来**

**でも楽しくしたホントに**

**不过真心期望能够充满着乐趣**

**みんなとなら無理したくなる**

**只要大伙儿同在 就会想将顾虑抛诸脑后**

**成長したいなまだまだ未熟DREAMER**

**愿能有所成长 如今还只是尚未成熟的梦想家**

 ![](https://cdn.luogu.com.cn/upload/pic/4493.png) 

Aqours的成员终于到齐了。


今天，是我们全员在一起的第一场演唱会。


大家都好好练习过了，相信一定会表现得很出色的。


不过，每个人的唱功也要尽量地接近才可以呢，如果太突出或者太落后，也是会影响表现的样子。


所以我们从隔壁的学园都市借来了一个发明，可以改变我们成员的唱功呢。


## 题目描述

我们Aqours的成员共有N+1人，他们会列成一队。

他们的唱功以A[0]到A[N]表示，A[i]$(0\le i \le N)$均给出。

学园都市的机器可以改变队列中连续多个成员的唱功值，并将其加上一个数Z，当然当Z是负数的时候就变成减去了。

我打算一共使用这个机器Q次，每次把第X到第Y号（$1\le X,Y\le10^6$）的成员都加上Z点唱功值。

而我们队伍的魅力值B，是这么算的：

一开始B=0，然后从第1号到第N号成员，

- 当$A_{i-1}<A_i$：$B = B-S\cdot|A_{i-1} - A_i|$
- 当$A_{i-1}>A_i$：$B = B+T\cdot|A_{i-1} - A_i|$
其中S和T是LoveLive组委会给我们的常数。

果然，我是バカチカ（笨蛋千歌）呢，所以作为领导我永远排在队伍的开头，唱功永远是0，机器也不会改到我头上呢。

你能帮我们算算，我**每次**使用完这个机器之后，成员的魅力B是多少吗？


## 说明/提示

30% 的数据 $N,Q\le 2000$,

另外20% 的数据 $S=T$

100%的数据 $N,Q\le 200000$；$1\le S,T,A_i\le10^6$；$|Z|\le 10^6$
请注意可能需要使用int64，cin/cout可能超时。

样例解释：

第一次变化后，

A 0 6 3 4 6

B -12 -3 -5 -9


#### 以下是彩蛋

没有。

哪来的那么多彩蛋？


## 样例 #1

### 输入

```
4 3 2 3
0
5
2
4
6
1 2 1
3 4 -3
1 4 2
```

### 输出

```
-9
-1
-5
```

# AI分析结果



---

## 唯一算法分类  
**差分数组**

---

## 综合分析与结论  
### 核心思路与难点  
**核心思路**：  
1. 将问题转化为差分数组维护相邻唱功差  
2. 每次区间修改只会影响差分数组的两个端点（X 和 Y+1）  
3. 预处理初始差分数组并计算总魅力值 B  
4. 每次修改仅更新两个端点的差分值和 B 的总值  

**解决难点**：  
- **区间修改的等效性**：发现区间内同时加减 Z 时，相邻差分值不变  
- **边界处理**：当 Y=N 时无需处理 Y+1 位置的差分值  
- **符号处理**：通过符号函数统一处理 S/T 的系数关系  

### 可视化设计要点  
**动画方案**：  
1. 用网格展示差分数组，初始为蓝色方块  
2. 修改区间[X,Y]时：  
   - 高亮 X 位置（红色闪烁）并加 Z  
   - 若 Y≠N，高亮 Y+1 位置（黄色闪烁）并减 Z  
3. 总魅力值 B 在右侧实时更新，显示变化量  
4. 每次操作播放 8-bit 音效：  
   - 区间选择时：短促 "beep"  
   - 数值变化时：不同音高的 "blip"  
   - 操作完成时：马里奥金币音效  

**复古风格**：  
- 使用 NES 调色板的深蓝（#306082）、红（#c42b3a）、黄（#ffd700）  
- 差分值用 16x16 像素方块表示，数值用 8-bit 字体渲染  
- 背景音乐采用《超级马里奥》地下关循环音乐  

---

## 题解清单（≥4星）  
### 1. lin_toto（5⭐️）  
**亮点**：  
- 直接指出差分数组的关键性质  
- 给出预处理差分数组的标准实现  
- 处理边界条件的逻辑清晰  

**代码核心**：  
```cpp
ans -= calc(A[x]); // 撤销原贡献
A[x] += z;         // 更新差分值
ans += calc(A[x]); // 加入新贡献
```

### 2. 顾z（5⭐️）  
**亮点**：  
- 类比 JOI 焚风现象题  
- 函数式处理符号计算  
- 代码简洁高效  

**代码核心**：  
```cpp
inline int calc(int x) {
    return x>0 ? -S*x : -T*x;
}
```

### 3. 风急风也清（4⭐️）  
**亮点**：  
- 差分公式推导过程详细  
- 包含手算验证表格  
- 强调开 long long 的重要性  

**代码核心**：  
```cpp
if(y < n) { // 边界条件判断
    ans -= f(d[y+1]); 
    d[y+1] -= z;
    ans += f(d[y+1]);
}
```

---

## 最优思路与技巧  
### 差分闪电战  
1. **预计算差分数组**：  
   ```math
   d[i] = A[i] - A[i-1]
   ```  
2. **魅力值转换**：  
   ```math
   B = \sum_{i=1}^n \begin{cases} 
   -S \cdot d[i] & (d[i]>0) \\ 
   -T \cdot |d[i]| & (d[i]<0) 
   \end{cases}
   ```  
3. **区间修改等效性**：  
   - 修改 [X,Y] 等效于：  
     ```cpp
     d[X] += z
     d[Y+1] -= z (if Y < N)
     ```  

### 思维跃迁  
- **符号统一**：将条件判断转换为符号函数，简化代码  
- **边界免疫**：Y=N 时的特殊处理避免越界  

---

## 同类型题目推荐  
1. P3368 【模板】树状数组 2（区间修改+单点查询）  
2. JOI 2017 焚风现象（差分应用经典题）  
3. P4231 三步必杀（二阶差分应用）

---

## 可视化核心代码（JS Canvas）  
```javascript
// 差分数组绘制
function drawDiff(ctx, dArr) {
  ctx.clearRect(0, 0, 800, 200);
  dArr.forEach((v, i) => {
    ctx.fillStyle = v > 0 ? '#c42b3a' : '#306082'; // 红/蓝区分正负
    ctx.fillRect(i*32 + 10, 100 - v*5, 24, 24);    // 高度映射数值
    ctx.fillText(v, i*32 + 15, 90 - v*5);          // 8-bit 字体
  });
}

// 修改动画
function animateModify(x, y, z) {
  blinkBlock(x, '#ffd700', () => {
    dArr[x] += z;
    updateB(); // 更新总魅力值
    if(y < n) blinkBlock(y+1, '#ffd700', () => dArr[y+1] -= z);
  });
}
```

---

## 调试心得摘录  
> **顾z**：  
> "注意当 y==n 时，魅力值是不用变的，这个边界卡了我 20 分钟"  
> **启示**：差分题必须画图验证边界条件  

> **mysssss**：  
> "开 int 导致 WA 了 20 次，long long 大法好！"  
> **教训**：大数据量必须用 64 位整型  

---

## 算法演示（复古版）  
**操作流程**：  
1. 初始界面显示差分数组的像素方块  
2. 用户输入 X=2,Y=3,Z=5 后：  
   - 第 2 方块红色闪烁并上移（+5）  
   - 第 4 方块黄色闪烁并下移（-5）  
3. 总魅力值显示从 -9 → -1 的动画  
4. 播放 "1UP" 音效表示成功  

**控制面板**：  
- 速度滑块：调节动画速度（1x-5x）  
- 暂停/步进：分析关键帧变化  
- 回放：重新观察特定操作  

通过将抽象的差分操作具象化为像素方块的移动与变色，辅以经典游戏音效，使算法学习过程更具沉浸感与趣味性。

---
处理用时：84.48秒
# 题目信息

# 「DBOI」Round 1 未完成的约定

## 题目背景

>  _生活快得停不下来_\
_璀璨的也最终衰败_\
_他感到负荷已过载_\
_车窗外_\
_天上大朵云彩_\
_追随他的速度跑得飞快_\
_不由自主比赛_\
——《笨小孩的道歉信》

不管多少个日夜，为你一直唱。

## 题目描述

$m^3$ 可以表示为 $m$ 个连续奇数的和 $(m \geqslant 1)$：  
$$
1^3 = 1\\
2^3 = 3 + 5\\
3^3 = 7 + 9 + 11\\
4^3 = 13 + 15 + 17 + 19\\
5^3 = 21 + 23 + 25 + 27 + 29\\
\cdots\cdots
$$

在左昂对奇数的狂热崇拜的影响下，苏信好写出来的歌只会是奇数长度。显然歌曲的长度不能是负数。

对于一首长度为 $x$ 的歌，它的悦耳值 $f(x)$ 满足将 $f(x)^3$ 按照上面的规律表示出来后，$x$ 是其中的一个加数。例如 $f(21) = 5, f(11) = 3,f(3) = 2$。

第二天，左昂前来参观，发现苏信好只写出来了一首歌，鄙夷不已。苏信好怒从心起，写出了以 $1\sim k$ 内所有长度为奇数的歌。

现在左昂想要知道苏信好所有歌的悦耳值之和，以预估他的狂热崇拜的效果。即：给定一个正奇数 $k(1\leqslant k< 2^{64})$，求 $s = \sum\limits_{i = 1}^{\frac{k + 1}{2}} f(2\times i - 1)$，即 $f(1) + f(3) + f(5) + \cdots +f(k)$。  

由于苏信好实在太生气，写出来的歌的悦耳值可能十分之大，你只需要输出 $s\bmod{10^9 + 7}$ 的结果。

**本题有多组数据。**

## 说明/提示


|  Subtask |  数据范围  | 分值 |
|:----:|:----:|:----:|
| Subtask 1 | $T=1$，$k< 2^{25}$ | $20$ |
| Subtask 2 | $T\leq 5$，$k< 2^{48}$ | $30$ |
| Subtask 3 | $T\leq 10^6$，$k < 2^{48}$ | $40$ |
| Subtask 4 | $T\leq 3\times 10^6$，$k < 2^{64}$ | $10$ |

**请注意常数因子对程序效率的影响。**

## 样例 #1

### 输入

```
1 114514 1919810 19950501 5```

### 输出

```
35```

## 样例 #2

### 输入

```
5 231421 523434 31243 5```

### 输出

```
50
30
40
55
35```

# AI分析结果



**唯一算法分类**  
数论

---

**综合分析与结论**  
本题要求计算特定奇数序列的悦耳值之和，核心在于数学推导与高效计算。关键步骤如下：

1. **数学推导**  
   - 每个m³对应m个连续奇数的和，起始奇数为m² - m +1。  
   - 对于奇数k，确定其所属的区间m（即f(k)），通过解方程得到：  
     \( p = \left\lfloor \frac{\sqrt{4k-3} +1}{2} \right\rfloor \)  
   - 总和分为前p-1项平方和与第p项的部分和：  
     \( s = \frac{(p-1)p(2p-1)}{6} + p \cdot \left( \frac{k - (p^2-p+1)}{2} +1 \right) \mod 10^9+7 \)

2. **难点与优化**  
   - **大数处理**：k接近2⁶⁴时，需用`long double`计算平方根避免溢出。  
   - **模运算优化**：分解因数处理分母6，利用逆元避免除法。  
   - **精度控制**：使用`sqrtl`确保计算精度。

3. **可视化设计**  
   - **动画演示**：分步展示p的计算、平方和分解、剩余项数量统计。  
   - **像素风格**：用8位色块表示计算步骤，音效提示关键操作（如找到p）。  
   - **交互面板**：允许调节速度观察公式推导与模运算细节。

---

**题解清单 (≥4星)**  
1. **StayAlone（5星）**  
   - 详细推导p的公式与边界条件，提出四舍五入简化计算，优化模运算分解。  
   - 代码高效处理大数，适合极端数据范围。  
   - 关键亮点：公式简洁，复杂度O(1)，正确处理溢出与精度。

2. **liuliucy（4星）**  
   - 正确分解平方和公式，利用`__int128`处理中间结果。  
   - 使用逆元优化模运算，但代码复杂度较高。  
   - 关键亮点：数学推导完整，适合理解底层逻辑。

---

**核心代码实现**  
```cpp
ull p = (sqrtl((long double)4*k -3) +1)/2; // 计算p值
// 计算前p-1项平方和
ull a = p-1, b = p, c = 2*p-1;
if (a%3 == 0) a /=3; else if (b%3 ==0) b /=3; else c /=3; // 分解因数3
if (a%2 ==0) a /=2; else if (b%2 ==0) b /=2; else c /=2; // 分解因数2
__int128 sum_sq = (__int128)a * b % mod * c % mod;
// 计算剩余项
ull count = ((k - (p*p -p +1)) /2 +1) % mod;
ull ans = (sum_sq + p * count) % mod;
```

---

**同类型题与套路**  
- **数论公式应用**：如连续奇数求和、平方数分解。  
- **大数处理**：利用数学性质避免直接计算大数。  
- **模运算优化**：分解逆元与因数简化运算。

**推荐题目**  
1. [P1045 麦森数](https://www.luogu.com.cn/problem/P1045)  
2. [P1463 反素数](https://www.luogu.com.cn/problem/P1463)  
3. [P1306 斐波那契公约数](https://www.luogu.com.cn/problem/P1306)

---

**个人心得摘录**  
- **调试教训**：直接计算4k-3可能溢出，需用long double提升精度。  
- **优化顿悟**：平方和公式分解因数可避免使用大数类型，显著提升效率。

---

**可视化与复古演示**  
1. **Canvas动画**  
   - **步骤1**：展示输入k，计算4k-3并高亮。  
   - **步骤2**：绘制sqrt结果，动态显示p的推导。  
   - **步骤3**：分块显示平方和计算，颜色区分a,b,c的分解。  
   - **步骤4**：动态绘制剩余项数量，播放完成音效。  

2. **8位风格**  
   - **调色板**：16色像素风格，绿色表示正确计算，红色提示溢出风险。  
   - **音效**：步进计算时播放短音，错误时蜂鸣声。  
   - **自动模式**：AI模拟推导过程，类似贪吃蛇自动寻路。

---
处理用时：185.16秒
# 题目信息

# [NICA #2] 亘久不变

## 题目背景

此世间，亘久不变之物若显真容，其必似华鸟风月般庄严凛然、隽美无二。

## 题目描述

给定 $n$ 个正整数 $a_i$ 与三个正整数 $x,y,p$，定义一次对**非负整数** $t$ 的变换为：

- 将 $t$ 替换为 $(xt+y)\bmod p$。

定义数 $t$ 是“$k$-不变”的，当且仅当其经过 $k$ 次变换后值不变。

小 Ran 希望知道给定的数组 $a$ 中有多少数是“$k$-不变”的，为了更加准确的知道答案，她会给出 $q$ 组 $k$ 进行询问。

## 说明/提示

数据保证，$1\le n\le 10^5$，$1\le p,q\le 10^3$，$1\le a_i,x,y,k_i\le 10^9$。

**注意 $p$ 不一定是质数。**

## 样例 #1

### 输入

```
5 2 3 7
2 3 4 5 6
5
1
2
3
4
5```

### 输出

```
1
1
5
1
1
```

## 样例 #2

### 输入

```
5 3 8 4
2 3 4 5 1
5
1
2
3
4
5```

### 输出

```
1
3
1
3
1```

# AI分析结果



---

**算法分类选择**  
数学分析 / 周期检测  

---

**综合分析与结论**  
**核心思路**：  
1. **预处理余数周期**：对于所有可能的余数（0 到 p-1），计算其经过变换后回到自身的最小周期。  
2. **快速查询统计**：对每个询问的 k，统计数组中满足「余数 < p」且「k 是余数周期倍数」的数的个数。  

**解决难点**：  
- 变换可能进入非初始循环，需判断是否存在有效周期。递归或循环遍历直到回到初始值或超过 p 次。  
- 大数处理：通过模运算将输入的 a_i 压缩到 0 到 p-1 范围内。  

**可视化设计**：  
- **网格表示余数环**：用 Canvas 绘制 0 到 p-1 的像素方块，颜色表示当前状态（未处理/周期有效/周期无效）。  
- **变换路径动画**：箭头动态显示余数变换路径，步进时高亮当前变换步骤。  
- **音效提示**：成功找到周期时播放 8-bit 音效，失败时播放短促音效。  

---

**题解清单 (≥4星)**  
当前题解存在递归栈溢出风险，建议改用循环实现，故暂不列具体题解。  

---

**最优思路与技巧**  
1. **模压缩**：所有数最终映射到 0 到 p-1，预处理仅需处理有限余数。  
2. **周期判断**：通过循环记录首次回到初始值的次数，避免递归深度问题。  
3. **因数判定**：k 必须为周期 d 的倍数，即 `d | k`，而非相反。  

---

**同类型题与算法套路**  
- **循环节问题**：如广义斐波那契数列的周期计算。  
- **模运算函数迭代**：如快速幂中的循环节分析（P1965 转圈游戏）。  

**推荐题目**：  
1. [洛谷 P1965] 转圈游戏  
2. [洛谷 P4156] 论战捆竹竿  
3. [洛谷 P1349] 广义斐波那契数列  

---

**代码实现（核心逻辑）**  
```cpp
int compute_cycle(int t, int x, int y, int p) {
    unordered_map<int, int> vis;
    int cnt = 0, current = t;
    while (true) {
        if (vis.count(current)) {
            // 发现循环但未回到起点，周期无效
            return INT_MAX;
        }
        if (current == t && cnt != 0) {
            return cnt; // 找到周期
        }
        if (cnt > p) return INT_MAX; // 超过 p 次未找到
        vis[current] = cnt;
        current = (x * current + y) % p;
        cnt++;
    }
}
```

---

**可视化与复古游戏化设计**  
1. **像素网格绘制**：  
   - 每个余数用 16x16 像素方块表示，颜色渐变表示当前状态。  
   - 红色：无效周期；绿色：有效周期；灰色：未处理。  
2. **AI 自动演示**：  
   - 自动遍历余数 0 到 p-1，步进展示变换路径。  
   - 支持暂停/继续，速度调节（慢/中/快）。  
3. **音效与积分**：  
   - 发现周期时播放「成功」音效，积分 +10。  
   - 失败时播放「错误」音效，积分 -5。  

**示例截图**：  
![复古像素风格余数环与路径动画示意图](visual-demo-url)  

---

**总结**  
本题核心在于数学建模与周期预处理，通过余数压缩和循环检测高效解决大数问题。实现时需注意递归深度限制，改用循环更稳妥。

---
处理用时：153.94秒
# 题目信息

# [NOI2001] 食物链

## 题目描述

动物王国中有三类动物 $A,B,C$，这三类动物的食物链构成了有趣的环形。$A$ 吃 $B$，$B$ 吃 $C$，$C$ 吃 $A$。

现有 $N$ 个动物，以 $1 \sim N$ 编号。每个动物都是 $A,B,C$ 中的一种，但是我们并不知道它到底是哪一种。

有人用两种说法对这 $N$ 个动物所构成的食物链关系进行描述：

- 第一种说法是 `1 X Y`，表示 $X$ 和 $Y$ 是同类。
- 第二种说法是`2 X Y`，表示 $X$ 吃 $Y$。

此人对 $N$ 个动物，用上述两种说法，一句接一句地说出 $K$ 句话，这 $K$ 句话有的是真的，有的是假的。当一句话满足下列三条之一时，这句话就是假话，否则就是真话。

- 当前的话与前面的某些真的话冲突，就是假话；
- 当前的话中 $X$ 或 $Y$ 比 $N$ 大，就是假话；
- 当前的话表示 $X$ 吃 $X$，就是假话。

你的任务是根据给定的 $N$ 和 $K$ 句话，输出假话的总数。


## 说明/提示

对于全部数据，$1\le N\le 5 \times 10^4$，$1\le K \le 10^5$。


## 样例 #1

### 输入

```
100 7
1 101 1
2 1 2
2 2 3
2 3 3
1 1 3
2 3 1
1 5 5
```

### 输出

```
3
```

# AI分析结果



## 算法分类
**种类并查集**

---

## 综合分析与结论

### 核心思路与难点
1. **扩展域并查集**（三倍数组法）：
   - 每个动物分为三个域：同类、猎物、天敌，通过合并三个域的集合维护环形关系
   - 难点：需同时合并三组关系，逻辑验证需判断跨域冲突
   - 可视化设计：用不同颜色区分三个域，动画展示合并时三个域的同步操作

2. **带权并查集**（模3权值法）：
   - 通过权值0/1/2表示与父节点的关系（同类/吃/被吃）
   - 难点：路径压缩时权值合并公式推导（如 `d[x] = (d[x] + d[fa]) % 3`）
   - 可视化设计：动态展示权值计算过程，高亮路径压缩时的权值更新

### 核心算法流程（扩展域法示例）
1. **合并同类**：
   - 合并 `x` 与 `y` 的同类域
   - 同步合并 `x+n` 与 `y+n`（猎物域）、`x+2n` 与 `y+2n`（天敌域）
2. **合并捕食关系**：
   - 合并 `x` 的猎物域与 `y` 的同类域
   - 合并 `x` 的天敌域与 `y` 的猎物域
   - 合并 `x` 的同类域与 `y` 的天敌域
3. **冲突检测**：
   - 若 `x` 的同类域与 `y` 的猎物域同集合 ⇒ 矛盾

---

## 题解清单（≥4星）

### 1. Sooke（扩展域法）⭐️⭐️⭐️⭐️⭐️
- **亮点**：三倍数组设计清晰，配图解释环形关系，代码规范易读
- **核心代码**：
  ```cpp
  if (opt == 1) { // 同类
    if (find(x + n) == find(y) || find(x) == find(y + n)) ans++;
    else merge(x, y), merge(x + n, y + n), merge(x + 2n, y + 2n);
  } else { // 捕食
    if (find(x) == find(y) || find(x) == find(y + n)) ans++;
    else merge(x + n, y), merge(x + 2n, y + n), merge(x, y + 2n);
  }
  ```

### 2. 天泽龟（带权并查集）⭐️⭐️⭐️⭐️
- **亮点**：推导权值公式，路径压缩时自动修正关系
- **关键公式**：
  ```cpp
  // 合并时权值计算
  re[f1] = (re[b] - re[a] + (d-1) + 3) % 3;
  ```

### 3. Strong_Jelly（扩展域精简版）⭐️⭐️⭐️⭐️
- **亮点**：代码极简（仅50行），三域合并逻辑高度压缩
- **个人心得**：指出“猎物的猎物是天敌”的隐含条件

---

## 最优思路提炼

### 关键技巧
1. **三域划分法**：通过三个域表示同类、猎物、天敌，逻辑验证只需跨域检测
2. **权值推导公式**：利用模3运算将环形关系转化为线性权值
3. **路径压缩优化**：在find时自动修正权值或域关系，确保后续查询正确性

### 同类型题拓展
- **对立关系**：P1525 关押罪犯（二倍数组处理敌对关系）
- **动态合并**：P1197 [JSOI2008]星球大战（逆向并查集）
- **权值维护**：P2267 小强的金字塔（带权并查集进阶）

---

## 可视化设计（扩展域法）

### 动画演示
1. **颜色标记**：
   - 同类域：绿色
   - 猎物域：红色
   - 天敌域：蓝色
2. **合并过程**：
   - 显示三组箭头同步合并，突出跨域连接
3. **冲突检测**：
   - 错误时闪烁冲突域，播放“失败”音效

### 复古像素风格
- **Canvas绘制**：
  - 动物节点为8-bit像素方块，三域用不同边框色区分
  - 合并时显示“连锁闪光”特效
- **音效**：
  - 正确合并：NES风格“叮”声
  - 错误提示：8-bit错误音效

---

## 核心代码（扩展域法）

```cpp
const int maxN = 5e4 * 3;
int fa[maxN];

void init() { for (int i=0; i<maxN; i++) fa[i] = i; }

int find(int x) { 
    return fa[x] == x ? x : fa[x] = find(fa[x]); 
}

// 合并x和y的同类域、猎物域、天敌域
void merge(int x, int y) {
    fa[find(x)] = find(y);
    fa[find(x + n)] = find(y + n);
    fa[find(x + 2*n)] = find(y + 2*n);
}

// 检查x是否吃y
bool check_eat(int x, int y) {
    return find(x) == find(y + n); // x的同类域与y的猎物域同集合
}
```

---

## 调试心得
- **常见错误**：未同步合并三域导致关系错乱
- **验证技巧**：随机生成测试数据，检查环形关系是否闭合（A→B→C→A）
- **优化经验**：带权法比三域法节省空间，但公式推导难度更大

---
处理用时：82.74秒
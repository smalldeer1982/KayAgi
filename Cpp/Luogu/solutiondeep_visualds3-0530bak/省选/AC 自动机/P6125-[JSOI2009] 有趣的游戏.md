# 题目信息

# [JSOI2009] 有趣的游戏

## 题目描述

小阳阳发明了一个有趣的游戏：有 $n$ 个玩家，每个玩家都有一个长度为 $l$ 的字母序列，任何两个玩家的字母序列不同。共有 $m$ 种不同的字母，所有的字母序列都由这 $m$ 种字母构成。为了方便，我们取大写字母的前 $m$ 个字母。   
例如 $m=3,l=4,\texttt{ABAA}$ 和 $\texttt{CBCA}$ 是两个合法的字母序列。       
现在由小阳阳来操控一台神奇的机器，每个时刻机器会随机产生一个字母，其中第 $i$ 种字母随机出来的概率为 $\dfrac{p_i}{q_i}$ ，显然 $\sum \limits_{k=1}^m \dfrac{p_i}{q_i}=1$。  
这样 $T$ 个时刻后机器会产生一个长度为 $T$ 的字母序列。  
如果某个时刻某个玩家发现自己的字母序列在机器产生的字母序列中出现了，“出现”的定义是玩家的字母序列是机器产生的字母序列中连续的一段，那么我们称这个玩家获胜，游戏结束。       
现在小阳阳感兴趣的一个问题是，每个玩家分别有多大的概率能获得这场游戏的胜利呢？  

## 说明/提示

$1 \leq n,l,m \leq 10$，$0 \leq p_i \leq q_i \leq 10$ 且 $\gcd(p,q) = 1$。

## 样例 #1

### 输入

```
3 2 2
1 2
1 2
AB
BA
AA```

### 输出

```
0.25
0.50
0.25```

## 样例 #2

### 输入

```
3 4 2
1 2
1 2
AABA
ABAA
BAAA```

### 输出

```
0.31
0.33
0.37```

# AI分析结果



---

## **唯一算法分类**  
**AC自动机与高斯消元**

---

## **题解思路、算法要点与解决难点**  
### **核心思路**
1. **AC自动机构建**：将所有玩家的字符串插入AC自动机，构建状态转移图与fail指针，便于快速匹配。
2. **概率建模**：将问题转化为在AC自动机上随机游走的过程，终止状态对应玩家获胜。
3. **方程组建立**：通过期望次数或概率转移建立线性方程组，利用高斯消元求解。

### **算法要点**
- **AC自动机**：处理字符串匹配，快速找到每个状态的所有可能转移。
- **期望次数模型**：设每个节点的期望经过次数为变量，终止节点的期望即为获胜概率。
- **高斯消元**：解线性方程组，处理状态间的循环依赖。

### **解决难点**
- **终止状态处理**：若某状态是终止节点（对应某玩家获胜），则其后续转移被截断。
- **方程组构造**：需正确表达每个节点的期望或概率与相邻节点的关系，避免遗漏初始条件（如根节点初始贡献）。

---

## **题解评分 (≥4星)**  
| 作者          | 评分 | 亮点与简评                                                                 |
|---------------|------|----------------------------------------------------------------------------|
| zzw4257       | ⭐⭐⭐⭐ | 通过期望次数模型避免概率建模的复杂性，思路清晰，代码逻辑完整。             |
| cyffff        | ⭐⭐⭐⭐ | 详细代码实现，AC自动机与高斯消元结合紧密，注释清晰。                       |
| tommy0221     | ⭐⭐⭐⭐ | 生成函数结合高斯消元，复杂度更低（O(n³)），数学推导深入，代码简洁。        |

---

## **最优思路或技巧提炼**  
### **关键思路**
- **期望替代概率**：设每个节点被访问的期望次数为变量，终止节点的期望即为概率，避免直接处理概率的循环依赖。
- **自动机与方程结合**：通过AC自动机的状态转移关系，自然导出线性方程组，利用高斯消元高效求解。

### **代码实现技巧**
- **方程构造**：根节点初始贡献为1，非根节点通过转移概率累加相邻节点的贡献。
- **稀疏矩阵处理**：部分题解优化高斯消元，减少无效计算（如忽略零系数项）。

---

## **同类型题与算法套路**  
- **字符串匹配+概率/期望**：如[P3211 [HNOI2013]游走](https://www.luogu.com.cn/problem/P3211)。
- **AC自动机+动态规划**：如[P4052 [JSOI2007]文本生成器](https://www.luogu.com.cn/problem/P4052)。
- **生成函数与高斯消元**：如[P3706 [SDOI2017]硬币游戏](https://www.luogu.com.cn/problem/P3706)。

---

## **推荐相似题目**  
1. **P3211 [HNOI2013]游走**：图上游走模型与高斯消元结合。
2. **P3706 [SDOI2017]硬币游戏**：生成函数与概率模型。
3. **P4052 [JSOI2007]文本生成器**：AC自动机结合动态规划。

---

## **可视化与算法演示**  
### **动画设计**
1. **AC自动机构建**：  
   - **像素网格**：用不同颜色表示节点状态（普通/终止）。  
   - **箭头动态绘制**：展示状态转移与fail指针的构建过程（如红色箭头表示fail跳转）。

2. **高斯消元过程**：  
   - **矩阵高亮**：当前消元行用黄色标记，主元素用闪烁红框标识。  
   - **音效提示**：每次行交换或消元操作时播放“哔”声，解出变量时播放成功音效。

3. **随机游走模拟**：  
   - **路径动态生成**：在AC自动机网格中，用绿色方块表示当前路径，遇到终止节点时触发爆炸特效。

### **交互功能**  
- **步进控制**：支持单步执行AC自动机构建或高斯消元步骤。  
- **参数调节**：允许调整随机字母生成概率，观察结果变化。  
- **复古风格**：采用8位像素字体，背景音乐为芯片风格循环曲。

---

## **代码片段（核心逻辑）**  
```cpp
// AC自动机构建（cyffff题解核心部分）
void insert(char *s, int n, int x) {
    int cur = 0;
    for (int i = 1; i <= n; i++) {
        int x = s[i] - 'A';
        if (!son[x]) son[x] = ++cnt;
        cur = son[x];
    }
    a[cur].endp = true; // 标记终止节点
}

// 高斯消元核心逻辑（pigstd题解）
void Gauss(int n) {
    for (int i = 1; i <= n; i++) {
        int k = i;
        for (int j = i + 1; j <= n; j++)
            if (fabs(A[j][i]) > fabs(A[k][i])) k = j;
        swap(A[i], A[k]);
        for (int j = 1; j <= n; j++) {
            if (i == j) continue;
            double res = A[j][i] / A[i][i];
            for (int l = i; l <= n + 1; l++)
                A[j][l] -= A[i][l] * res;
        }
    }
    // 解回代...
}
```

---

## **个人心得摘录**  
- **zzw4257**：  
  > “期望次数模型巧妙避开概率终止条件的复杂性，初始时根节点的+1是关键。”  
- **tommy0221**：  
  > “生成函数法需注意除以零的情况，调试时发现边界处理至关重要。”  

---

**答案总结**：AC自动机与高斯消元结合是本题最优解，核心在于合理建模与高效解方程。

---
处理用时：75.84秒
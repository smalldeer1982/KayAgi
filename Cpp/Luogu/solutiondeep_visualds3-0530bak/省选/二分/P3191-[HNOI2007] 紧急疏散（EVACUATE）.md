# 题目信息

# [HNOI2007] 紧急疏散（EVACUATE）

## 题目描述

发生了火警，所有人员需要紧急疏散！

假设这个房间是一个 $N \times M$ 的矩形区域。每个格子有三个状态：

- 一块空地，可以通行，用 `.` 表示。
- 一面墙，不可以通行，用 `X` 表示。
- 一扇门，人们可以从这里撤出房间，用 `D` 表示。

已知门一定在房间的边界上，并且边界上不会有空地。

最初，每块空地上都有一个人。疏散开始后，每块空地上就没有人数限制了（也就是说每块空地可以同时站无数个人）。

在疏散的时候，每一秒钟每个人都可以向上 / 下 / 左 / 右四个方向移动一格，当然他也可以站着不动。

由于门很窄，每一秒钟只能有一个人移动到门的位置，一旦移动到门的位置，就表示他已经安全撤离了。

现在的问题是：如果希望所有的人安全撤离，最短需要多少时间？或者告知根本不可能。

## 说明/提示

Update on 2015.1.12：新加数据一组。鸣谢：1756500824

对于 C++ 语言，请使用 `scanf` 读入字符矩阵！

## 样例 #1

### 输入

```
5 5
XXXXX
X...D
XX.XX
X..XX
XXDXX```

### 输出

```
3```

# AI分析结果



### 唯一算法分类  
**二分**

---

### 综合分析与结论  
**核心思路**：二分答案 + 最大流验证。  
- **二分过程**：在时间维度上二分，验证是否存在一个时间点使得所有人能在该时间内疏散。  
- **最大流建模**：  
  - **源点**连接所有空地（容量1，表示初始人数）  
  - **门拆点**：将每个门拆为 `mid` 个时间点，每个时间点连向汇点（容量1，限制每秒只能通过1人）  
  - **动态等待**：每个时间点的门向后一时间点的门连无限容量边，允许滞留人员等待后续时间  
  - **距离预处理**：BFS计算每个空地道每个门的最短距离，仅当距离 ≤ 二分值时连边  

**解决难点**：  
1. **拆点复杂度**：需合理处理门的时间分片，避免空间爆炸（如使用偏移量编码）  
2. **预处理优化**：BFS预处理所有空地道所有门的最短距离，避免多次重复计算  
3. **二分边界**：初始区间设为 `[0, 400]`，覆盖最坏情况（全图仅1门且所有人需绕行）  

---

### 题解清单 (≥4星)  
1. **Log_x (★★★★☆)**  
   - 亮点：清晰拆点逻辑，预处理距离优化，代码规范易读  
   - 关键代码：通过 `Judge(mid)` 函数动态建图，拆门为 `mid` 个时间点  

2. **JimmyLee (★★★★☆)**  
   - 亮点：分层建图避免多次重建流网络，逐步扩展时间层  
   - 心得：通过残量网络复用提升效率  

3. **香风智乃 (★★★☆☆)**  
   - 亮点：尝试费用流优化，但实际效率低于二分+最大流  

---

### 核心二分逻辑实现  
```cpp
int l = 0, r = 400, ans = -1;
while (l <= r) {
    int mid = (l + r) >> 1;
    if (check(mid)) { // 验证 mid 时间是否可行
        ans = mid;
        r = mid - 1;  // 收缩右边界
    } else {
        l = mid + 1;  // 收缩左边界
    }
}
```

---

### 可视化设计要点  
**复古像素风格动画**：  
1. **网格绘制**：Canvas 绘制房间网格，空地（绿色）、门（红色）、墙（灰色）  
2. **区间动态**：  
   - 左侧面板显示 `[left, mid, right]`，以像素方块表示当前搜索区间  
   - 每次收缩区间时触发 8-bit 音效（如 `beep` 声）  
3. **门拆点动画**：  
   - 门的时间分片以垂直排列的像素条表示，不同时间点高亮不同颜色  
   - 流量流动时，对应门的时间点闪烁黄色  
4. **自动演示模式**：  
   - AI 按帧逐步执行二分步骤，每步延迟 500ms  
   - 成功时播放胜利音效，失败时播放低沉音效  

---

### 同类型题目推荐  
1. **P3254 圆桌问题**（二分+网络流资源分配）  
2. **P2763 试题库问题**（分层建图与流量控制）  
3. **P2891 [USACO07OPEN]Dining**（多维度匹配与拆点技巧）  

---

### 个人心得摘录  
- **Log_x**：调试时发现门拆点后的索引偏移错误，通过打印中间图结构定位问题  
- **JimmyLee**：残量网络复用显著减少建图时间，但需注意每次新增层时的边重置  
- **香风智乃**：费用流在极端数据下 TLE，证实二分+最大流更优  

---

### 代码片段（Log_x 题解核心部分）  
```cpp
bool Judge(int mid) {
    // 动态建图逻辑
    for (int k = 1; k <= E; ++k) // 遍历所有门
        for (int i = 1; i <= n; ++i)
            for (int j = 1; j <= m; ++j)
                if (dis[k][i][j] <= mid) // 距离 ≤ mid 则连边
                    add(G[i][j], (k-1)*mid + R + dis[k][i][j], 1);
    // 门的时间分片连边
    for (int i = 1; i <= E; ++i)
        for (int j = 1; j <= mid; ++j) {
            add((i-1)*mid + R + j, des, 1); // 当前时间点连汇点
            if (j < mid) add((i-1)*mid + R + j, (i-1)*mid + R + j + 1, INF); // 向后等待
        }
    return MaxFlow() == R; // 总人数是否全疏散
}
```

---
处理用时：70.52秒
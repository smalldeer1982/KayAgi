# 题目信息

# [USACO20JAN] Falling Portals P

## 题目描述

有 $N$（$2 \leq N \leq 2 \times 10^5$）个世界，每个世界有一个传送门。初始时，世界 $i$（对于 $1 \leq i \leq N$）位于 $x$ 坐标 $i$，$y$ 坐标 $A_i$（$1 \leq A_i \leq 10^9$）。每个世界里还有一头奶牛。在时刻 $0$，所有的 $y$ 坐标各不相同，然后这些世界开始坠落：世界 $i$ 沿着 $y$ 轴负方向以 $i$ 单位每秒的速度移动。

在任意时刻，如果两个世界在某一时刻 $y$ 坐标相同（可能是非整数时刻），传送门之间就会“同步”，使得其中一个世界的奶牛可以选择瞬间传送到另一个世界。

对于每一个 $i$，在世界 $i$ 的奶牛想要去往世界 $Q_i$（$Q_i \neq i$）。帮助每头奶牛求出如果她以最优方案移动需要多少时间。

每个询问的输出是一个分数 $a/b$，其中 $a$ 和 $b$ 为互质的正整数，或者 $-1$，如果不可能到达。

## 说明/提示

### 样例解释

考虑原先在世界 $2$ 的奶牛的答案。在时刻 $2$ 世界 $1$ 和世界 $2$ 同步，所以奶牛可以前往世界 $1$。在时刻 $\frac{7}{2}$ 世界 $1$ 和世界 $3$ 同步，所以奶牛可以前往世界 $3$。

### 子任务

- 测试点 $2 \sim 3$ 满足 $N \leq 100$。
- 测试点 $4 \sim 5$ 满足 $N \leq 2000$。
- 测试点 $6 \sim 14$ 没有额外限制。

## 样例 #1

### 输入

```
4
3 5 10 2
3 3 2 1```

### 输出

```
7/2
7/2
5/1
-1```

# AI分析结果



### 唯一算法分类  
**二分**

---

### 综合分析与结论  
本题核心是几何模型转化与凸包维护，通过二分查找快速确定最优传送路径。各题解的核心思路是：  
1. **几何模型转化**：将每个世界视为直线（y = A_i - i*t），两直线交点为可传送的时间点。  
2. **凸包维护**：根据目标位置的高度关系，维护上凸包或下凸包（如 A_Q_i < A_i 时维护大斜率凸包）。  
3. **二分查找**：在凸包上二分查找满足条件的最优交点（即最早可传送到目标路径的时间）。  

**难点与解决方案**：  
- **凸包动态维护**：按 A_i 排序后插入凸包，保证单调性（如 honglan0301 的解法）。  
- **二分条件**：判断当前凸包线段是否允许传送到目标（通过斜率比较或交点时间比较）。  
- **边界处理**：若凸包不存在有效交点或无路径可达，返回 -1。  

**可视化设计思路**：  
1. **动画展示**：绘制所有直线及其交点，动态展示凸包构建过程。  
2. **高亮关键点**：  
   - 当前插入的直线（红色高亮）。  
   - 凸包栈顶元素（绿色高亮）。  
   - 二分查找的中间点（蓝色闪烁）。  
3. **区间收缩**：显示二分过程中 left/right/mid 的更新，并用箭头标记收缩方向。  
4. **复古像素风格**：用 8-bit 风格绘制直线网格，交点用像素方块表示，音效提示成功/失败。  

---

### 题解清单 (≥4星)  
1. **honglan0301（★★★★★）**  
   - **关键亮点**：代码简洁，直接维护凸包并二分查找，时间复杂度 O(n log n)。  
   - **核心代码**：  
     ```cpp  
     bool check(int x,int y,int k) {return (a[x]-a[k])*(y-k)<(a[y]-a[k])*(x-k);}  
     void ins(int x,bool zt) {  
         while(top&&(zt^(x>stk[top]))||top>1&&check(stk[top-1],stk[top],x)) top--;  
         stk[++top]=x;  
         // 二分逻辑省略  
     }  
     ```  
2. **xtx1092515503（★★★★☆）**  
   - **关键亮点**：通过倍增优化跳跃过程，预处理树上结构，理论复杂度最优。  
3. **KarmaticEnding（★★★★☆）**  
   - **关键亮点**：图解详细，从几何角度解释凸包生成，适合理解模型本质。  

---

### 最优思路/技巧提炼  
1. **凸包维护顺序**：按 A_i 从大到小插入，保证栈内元素的斜率单调性。  
2. **二分条件设计**：判断交点时间是否满足目标路径要求（如 `check(stk[mid], stk[mid-1], q[x])`）。  
3. **分治处理**：将 UP/DW 类问题分开处理，避免条件混杂。  

---

### 同类型题/算法套路  
1. **凸包动态维护**：如 [LC 218. 天际线问题](https://leetcode.com/problems/the-skyline-problem/)。  
2. **二分答案+几何模型**：如 [CF 660F. Bear and Bowling 4](https://codeforces.com/contest/660/problem/F)。  
3. **树/链上倍增**：如 [洛谷 P3304 直径](https://www.luogu.com.cn/problem/P3304)。  

---

### 推荐相似题目  
1. [P2742 [USACO5.1]圈奶牛](https://www.luogu.com.cn/problem/P2742)（凸包基础）  
2. [P2114 [NOI2016] 优秀的拆分](https://www.luogu.com.cn/problem/P2114)（二分+倍增）  
3. [CF 660F. Bear and Bowling 4](https://codeforces.com/contest/660/problem/F)（凸包优化DP）  

---

### 个人心得摘录  
- **KarmaticEnding**：插入凸包时需保证栈顶元素的交点单调性，否则会导致错误剪枝。  
- **Anonymely**：二分条件需注意分母为负时的符号处理，避免错误比较。  

---

### 可视化与算法演示（核心二分过程）  
**动画方案**：  
1. **初始化**：绘制所有直线，用不同颜色区分不同世界。  
2. **凸包构建**：动态插入直线，红色标记当前插入线，绿色标记栈顶线，灰色标记被弹出的线。  
3. **二分查找**：  
   - 黄色标记当前二分区间 [left, right]。  
   - 蓝色闪烁标记 mid 点，显示其与目标线的交点时间。  
   - 若 mid 满足条件，收缩右区间（右箭头动画）；否则收缩左区间（左箭头动画）。  
4. **结果展示**：找到交点后高亮路径，播放成功音效；若无解，显示红色“-1”并播放失败音效。  

**复古游戏化设计**：  
- **像素网格**：Canvas 绘制 16x16 像素网格，直线用 2px 粗线表示。  
- **音效**：  
  - 插入凸包时播放“哔”声。  
  - 二分收缩时播放“滴答”声。  
  - 成功/失败时播放 8-bit 风格胜利/失败旋律。  
- **自动演示**：按空格键切换手动/自动模式，自动模式下二分自动步进，速度可调。  

---

**示例代码（核心二分逻辑）**  
```cpp  
// 二分查找满足条件的最小交点时间（节选自 honglan0301 题解）  
if (zt^(a[q[x]] < a[x])) {  
    int l = 2, r = top;  
    while (l <= r) {  
        int mid = (l + r) >> 1;  
        if (check(stk[mid], stk[mid-1], q[x])) l = mid + 1;  
        else r = mid - 1;  
    }  
    // 计算最终分数  
}  
```

---
处理用时：70.63秒
# 题目信息

# 『MdOI R4』Balance

## 题目背景

可怜的 $\rm\textcolor {grey}{JohnVictor}$ 玩的卡组在平衡性调整中被削弱了，现在他掉了很多杯，他想知道什么样的一个世界才是真正平衡的。

于是就有了这题。

## 题目描述

给定长度为 $n$ 的，由整数构成的数组 $a,b,p,q$，并定义函数 $f(i,j)=\dfrac{a_i+b_j}{p_i+q_j}(1\le i,j\le n)$。

再给定两个整数 $x,y$，你需要求出一对 $(i,j)$，使得 $f(i,j)$ 在所有 $f(i,t)(t=1,2,\cdots,n)$ 中是第 $x$ 小的，在所有 $f(s,j)(s=1,2,\cdots,n)$ 中是第 $y$ 小的。 

在本题中，我们称一个数 $x$ 在序列 $c_{1\ldots n}$ 中是第 $k$ 小的，当且仅当在 $c$ 中有且仅有 $\alpha$ 个数 $y$ 满足 $y<x$，且有且仅有 $\beta$ 个数 $y$ 满足 $y\le x$，同时 $\alpha<k\le \beta$。

如果不存在这样的 $(i,j)$，请输出 `0 0`。

如果有多组这样的 $(i,j)$，输出任意一组即可。

由于平衡性的问题不是一次就能问清楚的，所以出题人会问你多次。

## 说明/提示

【样例解释 #1】
- $f(1,1)=1.2;f(1,2)=1.2;f(1,3)=1.25$。
- $f(2,1)=2;f(2,2)=2;f(2,3)=2\frac{1}{6}$。
- $f(3,1)=1;f(3,2)=1;f(3,3)=1$。

$f(1,3)$ 在 $f(1,1),f(1,2),f(1,3)$ 中是第 $3$ 小的，$f(1,3)$ 在 $f(1,3),f(2,3),f(3,3)$ 中是第 $2$ 小的。

【数据规模与约定】

**本题采用捆绑测试**

| 子任务编号 | $\sum n\le$         | $\vert a_i\vert ,\vert b_i\vert ,p_i,q_i\le$ | $(x,y)= $  | 分值  |
| ---------- | -------------- | -------------------- | ---------- | ----- |
| $1$        | $5\times 10^3$ | 无特殊限制           | 无特殊限制 | $10$  |
| $2$        | 无特殊限制     | $3$                  | 无特殊限制 | $10$  |
| $3$        | $10^5$         | 无特殊限制           | $(1,n)$        | $30 $ |
| $4$        | $10^5$         | 无特殊限制           | 无特殊限制 | $20$  |
| $5$        | 无特殊限制     | 无特殊限制           | 无特殊限制 | $30$  |

对于 $100\%$ 的数据，$1 \le x,y \le n \le 5 \times 10^5$，$\sum n \le 5 \times 10^5$，$|a_i|,|b_i|\le 10^9$，$0<p_i,q_i\le 10^9$，其中 $\sum n $ 表示所有数据中 $n$ 的和。

【提示与帮助】

本题读入量较大，请选手选择较快的读入方式。

## 样例 #1

### 输入

```
1
3 3 2
2 4 1 4
10 4 3 4
1 3 1 3
```

### 输出

```
1 3
```

# AI分析结果



**唯一算法分类**：二分

---

### **题解思路、算法要点与解决难点**

#### **核心思路**
将问题转化为二分查找可行解。通过设定中间值 `z`，判断是否存在满足 `x` 行和 `y` 列排名的 `(i,j)`。关键步骤包括：
1. **分数规划**：将分式 `f(i,j)` 转化为线性形式，构造 `a_i - z*p_i` 和 `b_j - z*q_j`。
2. **二分条件**：对每个 `z`，用 `nth_element` 快速找到第 `x` 小的行和第 `y` 小的列，检查对应元素和是否非负。
3. **边界处理**：调整二分区间直到满足精度要求。

#### **解决难点**
- **如何高效判断排名**：利用 `nth_element` 实现 O(n) 的快速选择。
- **避免精度问题**：通过多次二分迭代（如 50 次）确保精度足够。
- **处理大规模数据**：每次二分仅需线性时间，总复杂度为 O(n log M)，适用于 n=5e5。

---

### **题解评分 (≥4星)**
1. **JohnVictor 的题解**（5星）
   - **亮点**：代码简洁，直接二分+快速选择，时间复杂度最优。
   - **代码可读性**：清晰的变量命名，逻辑紧凑。
2. **VinstaG173 的题解**（4.5星）
   - **亮点**：与 JohnVictor 思路一致，代码更简短。
   - **优化点**：初始二分区间设为 ±1e14，避免极端值问题。
3. **双管荧光灯的题解**（4星）
   - **亮点**：几何思路巧妙，转换为斜率问题。
   - **实践性**：实现较复杂，但展示了不同的思维角度。

---

### **最优思路/技巧提炼**
1. **二分答案框架**：将原问题转化为二分查找可行解，适用于分式最值类问题。
2. **快速选择代替排序**：使用 `nth_element` 仅处理必要的部分排序，减少时间消耗。
3. **精度控制**：通过固定次数的二分迭代（而非基于精度差判断）避免浮点运算误差。

---

### **同类型题与算法套路**
- **通用二分模板**：适用于“求满足某条件的最小/最大值”问题。
- **类似题目**：
  - **洛谷 P1020**（导弹拦截，二分求最长不升子序列）
  - **洛谷 P2678**（跳石头，二分最小距离）
  - **LeetCode 410**（分割数组的最大值，二分+贪心验证）

---

### **推荐题目**
1. **P1020**：二分查找在动态规划中的应用。
2. **P2678**：经典二分答案题，验证函数设计。
3. **P4344**（SHOI2015 脑洞治疗仪）：二分+数据结构维护。

---

### **个人心得摘录**
- **JohnVictor**：调试中发现“反超时行列完全一致”，确保解一定存在。
- **双管荧光灯**：“将分式转换为几何问题，但需处理浮点比较的精度问题”。

---

### **可视化与算法演示**
#### **动画设计**
1. **区间变化**：在 Canvas 上绘制动态区间 [l, r]，`mid` 标记为红色方块。
2. **高亮变量**：
   - **绿色**：当前 `mid` 对应的 `x[s]` 和 `y[t]`。
   - **蓝色**：满足条件的区间收缩方向。
3. **步进控制**：允许单步执行，观察 `nth_element` 如何选择元素。
4. **音效**：每次更新 `mid` 时播放“滴”声，找到解时播放胜利音效。

#### **复古像素风格**
- **8位调色板**：使用经典绿、红、蓝三色。
- **网格绘制**：将二分区间映射为 8x8 像素块，每次收缩时更新颜色。
- **AI 自动演示**：模拟二分过程，每帧更新区间并触发音效。

---

### **核心代码片段**
```cpp
// JohnVictor 的二分逻辑
long double l = -2e7, r = 2e7;
rep(i, 1, 50) {
    mid = (l + r) / 2;
    // 计算当前中间值
    rep(i, 1, n) x[i].curr = x[i].a - mid * x[i].p;
    rep(i, 1, n) y[i].curr = y[i].a - mid * y[i].p;
    // 快速选择
    nth_element(x + 1, x + s, x + n + 1, cmp);
    nth_element(y + 1, y + t, y + n + 1, cmp);
    // 调整区间
    if (x[s].curr + y[t].curr > 0) l = mid;
    else r = mid;
}
cout << x[s].pl << " " << y[t].pl << endl;
```

---

### **总结**
本题通过二分答案框架，结合快速选择高效验证，解决了大规模数据下的分式排名问题。核心在于将分式转化为线性形式，并利用 `nth_element` 优化排序步骤。可视化设计通过动态区间和复古风格增强理解，适合教学演示。

---
处理用时：64.84秒
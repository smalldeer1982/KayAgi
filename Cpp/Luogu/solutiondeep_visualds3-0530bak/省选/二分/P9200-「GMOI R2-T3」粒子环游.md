# 题目信息

# 「GMOI R2-T3」粒子环游

## 题目背景

热爱珂学的小 Z 正在进行一项无聊的实验。

## 题目描述

实验室中有一个由 $n$ 个实验腔连接而成的环形轨道，其中第 $i$ 个实验腔顺时针连向第 $i+1$ 个实验腔（特别的，第 $n$ 个实验腔连向第 $1$ 个实验腔）。同时还有一个标号为 $n+1$ 的新建实验腔要接入这个环形轨道。它可以接在任意两个原本相连的实验腔之间。

第 $i$ 个实验腔可以将带电荷量为 $Q$ 的粒子运输到它的下一个实验腔，这个过程花费的能量为 $\vert Q \vert \times c_i$。除此之外，第 $i$ 个实验腔本身就存储了量为 $e_i$ 的电荷（电荷量有正负）。由于众所周知的电荷守恒定律，第 $n+1$ 个实验腔储存的电荷量与前 $n$ 个实验腔储存的总电荷量的代数和为 $0$。

小 Z 有一个原本不带电的粒子。等到第 $n+1$ 个实验腔接入轨道后，他要任选一个实验腔（包括第 $n+1$ 个）作为出发点，将粒子放入，并使之在实验腔的能量驱动下顺时针环游一周回到出发点。粒子每到达一个实验腔（包括出发点），它所带电荷量就会变成原来所带的电荷量和这个实验腔所储存的电荷量的代数和。

**注意：电荷量会先加上实验腔所含电荷量，再计算能量贡献。**

现在，小 Z 想知道，在所有接入新建实验腔并选定出发点的方案中，粒子环游一周所需的能量最少为多少？

## 说明/提示

样例 $1$ 解释：一种最优方案为将 $4$ 号实验腔接在 $3$ 号实验腔与 $1$ 号实验腔之间，以 $4$ 号实验腔为出发点，花费能量为 $ 1\times 2\ +\ 4\times 1\ + \vert -1 \vert \times 3 \ +\ 0 \times 2 =9$。

**本题采用 Subtask 捆绑测试。**

| Subtask | $n\le$ | $c_i\le$ | $\vert e_i\vert$ | 特殊性质 | 对应测试点 | 总分 |
| :----------: | :----------: | :----------: | :----------: | :----------: | :----------: | :----------: |
| $0$ | $300$ | $100$ | $100$ | $-$ | $1\sim 5$ | $10$ |
| $1$ | $10^3$ | $10^3$ | $10^3$ | $\bf A$ | $6\sim 7$ | $5$ |
| $2$ | $10^4$ | $10^4$ | $10^4$ | $-$ | $8\sim12$ | $15$ |
| $3$ | $10^5$ | $10^5$ | $10^5$ | $\bf B$ | $13\sim 16$ | $10$ |
| $4$ | $2.5\times 10^5$ | $10^5$ |$10^5$ | $-$ | $17\sim 25$ | $60$ |

特殊性质 $\bf A$：对于所有的 $i\in[1,n+1](i\in \Z)$，满足 $c_i=0$。

特殊性质 $\bf B$：对于所有的 $i\in[1,n+1](i\in \Z)$，满足 $c_i=1$。

对于 $100\%$ 的数据，$1\le n\le 2.5\times 10^5$，$0\le c_i\le 10^5$，$0\le |e_i|\le 10^5$。

保证答案在 long long 范围内。

## 样例 #1

### 输入

```
3
1 3 2 2
3 -5 1```

### 输出

```
9```

## 样例 #2

### 输入

```
12
4 7 7 8 8 4 5 5 9 10 1 1 10 
0 -5 7 8 1 -1 -6 8 2 4 10 8 ```

### 输出

```
509```

# AI分析结果



**唯一算法分类**：二分

---

### 题解思路与算法要点

1. **核心思路**  
   将问题转化为在数轴上选择最优起点（带权中位数），使得所有点的加权距离和最小。关键点在于：
   - 电荷量的前缀和视为数轴上的点，权值为对应的 `c_i`。
   - 插入新实验腔后，动态维护前缀和数组，并快速计算中位数位置。

2. **二分算法要点**  
   - **搜索区间**：所有可能的前缀和值构成的数轴。
   - **二分条件**：找到第一个满足左边权值总和 ≥ 右边权值总和的位置。
   - **区间收缩**：通过线段树或树状数组的二分功能快速定位中位数。

3. **解决难点**  
   - 动态维护前缀和数组的变化（插入位置调整）。
   - 高效计算绝对值贡献的总和，拆分为左右部分统计。

---

### 题解评分（≥4星）

1. **Aiopr_2378（5星）**  
   - **亮点**：动态开点线段树维护权值分布，直接二分查找中位数，代码简洁高效。
   - **关键代码**：
     ```cpp
     int findmid(int p, ll l, ll r, ll k) { // 线段树二分中位数
         if (!p) return 0;
         if (l == r) return l;
         ll mid = (l + r) >> 1;
         if (tree[ls].sz >= k) return findmid(ls, l, mid, k);
         return findmid(rs, mid + 1, r, k - tree[ls].sz);
     }
     ```

2. **yinhy09（4星）**  
   - **亮点**：离散化前缀和，用四个树状数组维护贡献，二分优化查询。
   - **优化点**：离散化减少空间，拆解绝对值贡献为分类统计。

3. **sqrtqwq（4星）**  
   - **亮点**：权值线段树维护带权点，代码逻辑清晰，动态插入处理巧妙。

---

### 最优思路与技巧

1. **关键思路**  
   - **带权中位数**：最优起点对应数轴上带权中位数的位置。
   - **动态维护**：插入新实验腔时，仅需调整相邻前缀和，数据结构高效更新。

2. **实现技巧**  
   - **线段树二分**：直接在线段树中二分查找中位数位置，避免显式排序。
   - **离散化优化**：预先离散化可能的前缀和值，降低时间复杂度。

---

### 类似题目与算法

- **同类型题**  
  - [P1168 中位数](https://www.luogu.com.cn/problem/P1168)：动态维护中位数。
  - [P1884 最大数](https://www.luogu.com.cn/problem/P1198)：线段树维护区间最大值。
  - [P1044 环状最大两段子段和](https://www.luogu.com.cn/problem/P1122)：环形结构的前缀和处理。

- **通用套路**  
  在动态数据集中维护中位数或带权中位数，常用线段树/树状数组结合二分。

---

### 可视化与算法演示

**动画设计**：
1. **数轴展示**：Canvas 绘制数轴，标记前缀和点及权值 `c_i`。
2. **中位数定位**：红色标记当前中位数，绿色为搜索区间。
3. **插入操作**：插入新点时，动态调整线段树结构并重新定位中位数。
4. **复古像素风**：8-bit 风格动画，音效提示中位数更新。

**关键代码（JS 伪代码）**：
```javascript
// 模拟线段树二分查找中位数
function findMedian(root, totalWeight) {
    let node = root, sum = 0;
    while (node.left || node.right) {
        if (node.left && sum + node.left.weight >= totalWeight / 2) {
            node = node.left;
        } else {
            sum += node.left?.weight || 0;
            node = node.right;
        }
    }
    return node.value;
}
```

---

### 个人心得摘录

- **调试教训**：离散化时要考虑所有可能的前缀和值，否则会遗漏边界情况。
- **优化顿悟**：插入位置调整仅影响相邻前缀和，无需全局重新计算。

---
处理用时：76.62秒
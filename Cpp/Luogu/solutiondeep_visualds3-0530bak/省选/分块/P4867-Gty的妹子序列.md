# 题目信息

# Gty的妹子序列

## 题目描述

Autumn 和 Bakser 又在研究 Gty 的妹子序列了！但他们遇到了一个难题。

对于一段妹子们，他们想让你帮忙求出这之内美丽度 $\in[a,b]$ 的妹子的美丽度的种类数。

为了方便，我们规定妹子们的美丽度全都在 $[1,n]$ 中。

给定一个长度为 $n(1\le n\leq 10^5)$ 的正整数序列 $s(1\le s_i\le n)$，对于 $m(1\le m\le 10^6)$ 次询问 $l,r,a,b$，每次输出 $s_l\cdots s_r$ 中，权值 $\in[a,b]$ 的权值的种类数。

## 说明/提示

【样例的部分解释】
 
`5 9 1 2 `
子序列为`4 1 5 1 2`  
在[1,2]里的权值有1,1,2，有2种，因此答案为2。  

`3 4 7 9`  
子序列为`5 1 ` 
在[7,9]里的权值有5，有1种，因此答案为1。  

`4 4 2 5`  
子序列为`1`  
没有权值在[2,5]中的，因此答案为0。  

`2 3 4 7`  
子序列为`4 5`  
权值在[4,7]中的有4,5，因此答案为2。  

建议使用输入/输出优化。  

## 样例 #1

### 输入

```
10 10
4 4 5 1 4 1 5 1 2 1
5 9 1 2
3 4 7 9
4 4 2 5
2 3 4 7
5 10 4 4
3 9 1 1
1 4 5 9
8 9 3 3
2 2 1 6
8 9 1 4```

### 输出

```
2
0
0
2
1
1
1
0
1
2```

# AI分析结果



**算法分类选择**  
`莫队算法 + 值域分块`

---

### **题解思路、算法要点与解决难点**

#### **核心思路对比**
1. **莫队算法**：几乎所有题解都基于莫队处理区间查询问题。通过将查询离线排序，将区间移动的复杂度均摊到O(n√n)。
2. **值域分块**：维护每个值域块内的颜色种类数，实现O(1)插入/删除和O(√n)查询，与莫队的复杂度完美匹配。
3. **树状数组尝试**：部分题解尝试用树状数组维护前缀和（如pomelo_nene），但复杂度O(n√n log n)难以通过极限数据。

#### **实现关键点**
- **分块策略**：
  - **区间分块**：莫队的块大小通常设为√n，优化奇偶排序（如VTloBong的`cmp`函数）。
  - **值域分块**：将值域分成√n块，每个块维护种类数（如`sum[]`数组）。
- **移动指针时的更新**：
  - **插入元素**：若元素首次出现，对应值域块的`sum`加1。
  - **删除元素**：若元素最后一次出现，对应值域块的`sum`减1。
- **查询优化**：
  - **部分块遍历**：查询值域区间时，只处理两端不完整块和中间完整块。

#### **解决难点**
- **时间与空间平衡**：值域分块以O(√n)查询换O(1)修改，总复杂度O(n√n + m√n)，避免树状数组的高log因子。
- **内存限制**：值域分块仅需O(n)空间，符合题目30MB限制。

---

### **题解评分 (≥4星)**

1. **VTloBong (5星)**  
   - 完整实现莫队+值域分块，代码简洁高效，包含奇偶排序优化。
   - 关键代码段：
     ```cpp
     bool cmp(query x,query y){
         return (x.l-1)/size==(y.l-1)/size?(((x.l-1)/size)&1?x.r<y.r:x.r>y.r ):(x.l-1)/size<(y.l-1)/size; 
     }
     ```
     通过奇偶性优化右端点移动顺序，减少指针跳变次数。

2. **Ireliaღ (4星)**  
   - 提出块大小动态调整公式`l = sqrt(n²/m)`，理论最优复杂度。
   - 代码中动态计算块大小：
     ```cpp
     block = sqrt(1.0 * n * n / m);
     ```

3. **Treaker (4星)**  
   - 代码高度模块化，值域分块与莫队分离，可读性强。
   - 查询时处理不完整块的循环逻辑清晰：
     ```cpp
     for(int i = l;i <= R[pos[l]];i ++) res += (c[i] > 0);
     ```

---

### **最优思路或技巧提炼**

1. **分块嵌套**：外层莫队分块处理区间移动，内层值域分块处理权值统计，实现双√n复杂度平衡。
2. **奇偶排序优化**：对莫队块内查询按奇偶性交替排序右端点，减少指针移动距离。
3. **动态块大小调整**：根据n和m关系计算理论最优块大小，提升实际运行效率。

---

### **同类型题推荐**
1. **P1972 [SDOI2009] HH的项链**  
   - 区间数颜色问题，可用莫队或离线树状数组。
2. **P4396 [AHOI2013] 作业**  
   - 区间值域内元素个数统计，需莫队+值域分块。
3. **P3730 曼哈顿交易**  
   - 带权值频率统计的区间查询，类似分块嵌套思路。

---

### **可视化与算法演示**

#### **核心算法流程动画设计**
1. **分块展示**：
   - **区间分块**：用不同颜色网格表示莫队的区间块，高亮当前处理的查询块。
   - **值域分块**：右侧面板显示值域分块，每个块标注当前种类数（如`sum[3]=2`）。
2. **指针移动动画**：
   - **左右指针**：用箭头标记`l`和`r`，移动时实时更新区间背景色。
   - **元素插入/删除**：元素高亮闪烁，对应值域块颜色加深/变淡。
3. **交互控制**：
   - **步进控制**：支持单步执行莫队移动或批量运行。
   - **速度调节**：滑动条调整动画速度，适应不同学习节奏。

#### **复古像素风格实现**
- **Canvas绘制**：
  ```javascript
  function drawBlock(x, y, color) {
      ctx.fillStyle = color;
      ctx.fillRect(x * 16, y * 16, 14, 14); // 16x16像素块，留2像素边框
  }
  ```
- **音效触发**：
  - **插入元素**：播放8-bit "滴"声（频率400Hz）。
  - **查询完成**：播放上升音阶（C大调音阶片段）。

---

### **个人心得摘录**
- **VTloBong的调试教训**：未离散化导致WA，强调输入数据范围的重要性。
- **囧仙的无奈**：理论最优解法因空间限制无法实现，体现算法与工程的权衡。

---

### **代码片段（VTloBong题解核心）**
```cpp
// 值域分块查询函数
inline int query(int l, int r) {
    int res = 0;
    if (pos[l] == pos[r]) {
        for (int i = l; i <= r; i++) res += (cnt[i] > 0);
        return res;
    }
    // 处理不完整块
    for (int i = l; i <= br[pos[l]]; i++) res += (cnt[i] > 0);
    for (int i = bl[pos[r]]; i <= r; i++) res += (cnt[i] > 0);
    // 处理完整块
    for (int i = pos[l] + 1; i < pos[r]; i++) res += num[i];
    return res;
}
```

---
处理用时：86.93秒
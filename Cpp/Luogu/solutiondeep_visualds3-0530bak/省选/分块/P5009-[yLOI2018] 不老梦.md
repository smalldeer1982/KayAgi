# 题目信息

# [yLOI2018] 不老梦

## 题目背景

> 于万人中万幸得以相逢，刹那间澈净明通。  
> 成为我所向披靡的勇气和惶恐，裂山海，堕苍穹。

——银临《不老梦》。

本题原名《毒瘤分块题》。

## 题目描述

扶苏非常喜欢一边听古风歌一边写毒瘤分块题。所以这个题的题面恶意卡了分块。

给你一个序列，这个序列中的每个数字有三个参数 $v_i,a_i,b_i$。这个序列中的数有一个非常神奇的有关时间的性质：每过一个时刻，序列中第 $i$ 个数字的值 $v_i$ 会增加 $a_i \times b_i$。

现在扶苏会对你做出一些询问和对序列进行一些修改。每次操作形如：

- 查询第 $t$ 时刻区间 $[l,r]$ 的 $v$ 之和是多少。
- 在第 $t$ 时刻修改区间 $[l,r]$ 内的 $a$，将之整体加上一个整数 $x$。
- 在第 $t$ 时刻修改区间 $[l,r]$ 内的 $b$，将之整体加上一个整数 $y$。
- 在第 $t$ 时刻修改区间 $[l,r]$ 内的 $v$，将之整体加上一个整数 $z$。

规定初始时刻为时刻 $0$。

## 说明/提示

#### 【样例输入输出 1 解释】

![qwq](https://cdn.luogu.com.cn/upload/pic/38337.png)


---

#### 【数据规模与约定】

**本题共有 $17$ 个测试点，各测试点不等分。每个测试点的 $n$ 的规模如下表**。

| 测试点编号 |         $n=$          | 测试点编号 | $n=$|
| :--------: | :-------------------: | :--------: | :-------------------: |
|    $1$     |          $6$          |    $10$    |      $10^5 + 2$       |
|    $2$     |         $10$          |   $11$    | $1.5 \times 10^5 + 2$ |
|    $3$     |         $100$         |  $12$    |      $10^5 + 3$       |
|    $4$     |        $10^3$         |  $13$    | $1.5 \times 10^5 + 3$ |
|    $5$     |    $3 \times 10^3$    | $14$    |  $2 \times 10^5 + 4$  |
|    $6$     |    $3 \times 10^3$    |   $15$    |  $5 \times 10^4 + 5$  |
|    $7$     |      $10^4 + 1$       |   $16$    |      $10^5 + 5$       |
|    $8$     |      $10^5 + 1$       |  $17$    |  $2 \times 10^5 + 5$  |
|    $9$     | $1.5 \times 10^5 + 1$ |

**各测试点分值**：

- 对于第 $1$ 到第 $14$ 个测试点，每个测试点 $5$ 分。
- 对于第 $15$ 到第 $17$ 个测试点，每个测试点 $10$ 分。

**各测试点 $m$ 的取值**：

- 对于测试点 $1$，$m = 10$。
- 对于测试点 $2$，$m = 50$。
- 对于第 $3$ 到第 $17$ 个测试点，$m = n$。

**各测试点特殊性质**：

- 对于所有 $n$ 末位数字为 $6$ 的测试点，满足性质：操作所用到的时刻从 $1$ 开始，每次增加 $1$。
- 对于所有 $n$ 末位数字为 $1$ 的测试点，满足性质：所有修改操作只涉及对 $a$ 的修改，且修改区间 $x = y$。
- 对于所有 $n$ 末位数字为 $2$ 的测试点，满足性质：所有修改操作只涉及对 $a$ 的修改。
- 对于所有 $n$ 末位数字为 $3$ 的测试点，满足性质：所有修改操作不涉及对 $v$ 的修改，且对于 $b$ 的修改满足 $x= y$。
- 对于所有 $n$ 末位数字为 $4$ 的测试点，满足性质：不存在修改操作。


对于全部的测试点，保证 $1 \leq x \leq y \leq n$，$1 \leq op \leq 4$，给出的所有数字都在 32 位带符号整形的范围内，$t$ 为正数，且按照严格的升序给出。

---

#### 【提示】

- 请注意数据读入对程序效率造成的影响。
- 请注意常数因子对程序效率造成的影响。
- $n$ 的末位数字可以帮助你快速判断测试点的特殊性质。
- 当你的答案为负时，请将其取模成非负数后再进行输出。




## 样例 #1

### 输入

```
5 5
1 2 3
4 5 6
7 8 9
10 11 12
13 14 15
2 1 1 3 2 
1 3 2 3
3 4 1 4 -3
4 5 1 3 -5
1 6 1 5```

### 输出

```
377
2708```

# AI分析结果



## **算法分类**  
线段树/树状数组  

---

## **综合分析与结论**  
### **题目核心逻辑与难点**  
- **动态时间影响**：每个时刻的 `v` 增量与 `a*b` 相关，且所有操作基于特定时间点，需维护时间戳与变量间的动态关系。  
- **多维度区间修改**：修改 `a/b/v` 的区间操作会相互影响，需设计标记系统处理叠加效果。  
- **标记下放顺序与公式推导**：线段树需维护 `∑v, ∑a, ∑b, ∑ab`，标记需精确计算增量对当前值的影响，且要考虑时间 `t` 的容斥修正。  

### **最优思路提炼**  
1. **线段树维护四元组**：`∑v, ∑a, ∑b, ∑ab`，通过公式推导将时间影响转化为标记叠加。  
2. **标记设计**：  
   - **`adda`**：记录 `a` 的增量及其对 `v` 的影响（`adda += x*t`）。  
   - **`addb`**：类似 `adda`，处理 `b` 的增量。  
   - **`addv`**：直接累加 `v` 的增量。  
3. **容斥思想**：修改 `a` 或 `b` 时，通过 `t` 计算当前操作对历史 `v` 的修正值（如 `v -= x*b*t`）。  

### **可视化设计思路**  
- **动画方案**：  
  - **线段树节点展示**：每个节点显示 `∑v, ∑a, ∑b, ∑ab` 及当前标记。  
  - **标记下放过程**：高亮被修改的区间，用箭头表示标记传递，颜色区分 `adda`（红色）、`addb`（蓝色）、`addv`（绿色）。  
  - **时间推移模拟**：显示时间 `t` 增长时 `∑ab` 的累加效果，并用动态公式展示 `v` 的变化。  
- **复古像素风格**：  
  - **8-bit 线段树**：用方格表示线段树节点，标记下放时触发像素闪烁特效。  
  - **音效提示**：标记下放时播放短促“滴”声，查询完成时播放上扬音调。  
  - **自动演示模式**：模拟随机操作序列，展示算法如何处理多标记叠加。  

---

## **题解清单 (≥4星)**  
1. **DDOSvoid 的题解 (★★★★☆)**  
   - **亮点**：完整维护四元组与多标记，推导标记下放公式，代码结构清晰。  
   - **核心代码**：  
     ```cpp  
     void update_adda(int i, int l, int r, int L, int R, ll v, ll t) {  
         if (L <= l && r <= R) {  
             T[i].v = (T[i].v - T[i].b * v * t) % mod;  
             T[i].a = (T[i].a + v * (r-l+1)) % mod;  
             T[i].adda += v * t;  
             T[i].Adda += v;  
             return;  
         }  
         // ... 标记下放与递归  
     }  
     ```  

2. **DPair 的题解 (★★★★☆)**  
   - **亮点**：简化标记系统，通过 `ta, tb, ts` 分离时间修正项，代码更易维护。  
   - **核心代码**：  
     ```cpp  
     inline void ua(int rt, int l, int r, int z, int p) {  
         Add(t[rt].ss, 1ll * t[rt].sb * z % MOD);  
         Sub(t[rt].s, 1ll * t[rt].sb * p % MOD);  
         // ... 更新标记  
     }  
     ```  

---

## **同类型题与推荐题目**  
1. **P3373 【模板】线段树 2**（区间乘加混合操作）  
2. **P1253 扶苏的问题**（区间加与区间赋值标记的优先级处理）  
3. **P4513 小白逛公园**（动态最大子段和，维护多维度信息）  

---

## **个人心得摘录**  
- **DDOSvoid**：  
  > “标记下放顺序非常关键，尤其是 `Adda` 和 `Addb` 对 `∑ab` 的影响，必须严格推导公式。”  
- **qingshu**：  
  > “容斥思想让我豁然开朗，将时间影响拆分为当前操作和历史修正，避免暴力计算。”  

---

## **可视化代码片段 (JS)**  
```javascript  
// 模拟线段树节点更新（像素风格）  
function drawNode(node, x, y) {  
    ctx.fillStyle = "#8B00FF"; // 紫色背景  
    ctx.fillRect(x, y, 50, 50);  
    ctx.fillStyle = "#FFFFFF";  
    ctx.fillText(`v:${node.v}`, x+5, y+15);  
    ctx.fillText(`a:${node.a}`, x+5, y+30);  
    // 触发标记动画  
    if (node.adda > 0) {  
        ctx.fillStyle = "#FF0000"; // 红色标记  
        ctx.fillText(`+a:${node.adda}`, x+5, y+45);  
    }  
}  
```  

---

## **总结**  
本题解通过线段树维护多变量与标记系统，将动态时间影响转化为数学公式，是复杂区间操作的经典案例。可视化设计结合复古风格与公式推导，可帮助理解多标记叠加的交互逻辑。

---
处理用时：89.18秒
# 题目信息

# 「Wdsr-2」白泽教育

## 题目背景

上白泽慧音在给雾之湖的妖精们讲课。

某天，慧音在上数学课时，提到了一种非常有趣的记号：**高德纳箭号表示法**。它可以用来描述非常巨大的数字。~~比如紫的年龄。~~

对于非负整数 $a, b$ 和正整数 $n$，高德纳箭号表示法的定义为：

$$a \uparrow^n b = \begin{cases}
1\ (b = 0) \\
a^b\ (n = 1\ \operatorname{and}\ b > 0) \\
a \uparrow^{n - 1} (a \uparrow^n (b - 1))\ (n > 1\ \operatorname{and}\ b > 0)
\end{cases}$$

一些简单的例子：

- $2 \uparrow 31 = 2^{31} = 2147483648$

- $2 \uparrow \uparrow 4 = 2^{2^{2^2}} = 2^{2^4} = 2^{16} = 65536$

注：
1. $a \uparrow b$ 与 $a \uparrow^1 b$ 相同；

2. $a \uparrow \uparrow b$ 与 $a \uparrow^2 b$ 相同；

3. 请注意幂运算的顺序。

## 题目描述

慧音希望琪露诺解决以下关于 $x$ 的方程：

$$a \uparrow^n x \equiv b \pmod p$$

其中，$a, n, b, p$ 为已知的常数，$x$ 为未知数。

琪露诺被高德纳箭号表示法搞得云里雾里的，但是她不想被头槌。你能帮帮她吗？

## 说明/提示

**本题开启捆绑测试。**

| Subtask | $n$ | $p$ | $T$ | 分值 | 时限 |
| :------: | :------: | :------: | :------: | :------: | :------: |
| $1$ | $n = 1$ | $2 \leq p \leq 10^9$ 且 $p$ 为质数 | $1 \leq T \leq 100$ | $15 \operatorname{pts}$ | $2.00 \operatorname{s}$ |
| $2$ | $n = 2$ | 无特殊限制 | $1 \leq T \leq 5 \times 10^3$ | $25 \operatorname{pts}$ | $1.00 \operatorname{s}$ |
| $3$ | $n = 3$ | 无特殊限制 | 无特殊限制 | $60 \operatorname{pts}$ | $2.00 \operatorname{s}$ |

对于 $100\%$ 的数据，$1 \leq a \leq 10^9$，$1 \leq n \leq 3$，$0 \leq b < p \leq 10^9$，$1 \leq T \leq 2 \times 10^4$。

## 样例 #1

### 输入

```
3
2 1 1 3
3 1 2 7
7 1 2 4```

### 输出

```
0
2
-1```

## 样例 #2

### 输入

```
3
2 2 4 7
3 2 4 6
5 2 1 3```

### 输出

```
2
-1
0```

## 样例 #3

### 输入

```
3
4 3 5 8
2 3 9 11
6 3 1 5```

### 输出

```
-1
3
0```

# AI分析结果



---

### 唯一算法分类  
**离散对数问题与扩展欧拉定理的综合应用**

---

### 综合分析与结论  
题目核心是求解高德纳箭号表示法的模方程，需针对不同 n 值设计算法。核心思路如下：

1. **n=1 (BSGS 算法)**  
   - 转换为离散对数问题，直接应用 BSGS 算法求解 $a^x \equiv b \mod p$。
   - 时间复杂度 $O(\sqrt{p})$，需处理质数模数的特例。

2. **n=2 (幂塔递归 + 扩展欧拉定理)**  
   - 预处理欧拉函数链 $p \rightarrow \varphi(p) \rightarrow \varphi(\varphi(p)) \rightarrow \dots \rightarrow 1$。
   - 递归计算幂塔时，用结构体保存当前值及是否溢出，判断是否需要加 $\varphi(m)$。
   - 枚举 x 的可能值（上限约 $O(\log p)$），逐层验证。

3. **n=3 (指数爆炸特判)**  
   - 观察 $a↑^3x$ 指数增长极快，仅需枚举 $x=0,1,2,3$ 等极小范围。
   - 预处理欧拉链后，递归计算高层箭号值，直接匹配结果。

**可视化设计思路**：
- **动画流程**：展示欧拉链生成过程，递归计算幂塔时高亮当前层数和模数。
- **像素风格**：用不同颜色块表示各层递归结果，音效标记溢出或匹配成功。
- **步进控制**：允许单步观察递归展开和模运算细节。

---

### 题解清单 (≥4星)
1. **Leasier（⭐⭐⭐⭐⭐）**  
   - **亮点**：全面覆盖三个子任务，递归结构清晰，预处理欧拉链与扩展欧拉定理实现精确。
   - **代码**：通过 `tetration` 和 `pentation` 函数分层处理箭号运算，结构清晰。

2. **LightningUZ（⭐⭐⭐⭐⭐）**  
   - **亮点**：针对 n=3 的极简特判，利用指数爆炸特性大幅减少计算量。
   - **心得**：强调处理边界条件（如 $a=2$ 的特殊情况）和调试经验。

3. **_Fontainebleau_（⭐⭐⭐⭐）**  
   - **亮点**：简洁的 `ptower` 函数实现幂塔计算，优化质因数分解加速欧拉函数计算。

---

### 核心代码实现  
**Leasier 的 `tetration` 函数（n=2 递归计算）**  
```cpp
Node tetration(int a, int n, int index) {
    if (phi[index] == 1) return new_node(0, true);
    if (n == 0) return new_node(1, false);
    Node x = tetration(a, n - 1, index + 1);
    if (x.flag) x.val += phi[index + 1]; // 扩展欧拉定理处理溢出
    return quick_pow(a, x.val, phi[index]);
}
```

**LightningUZ 的 n=3 特判逻辑**  
```cpp
if (a == 2) {
    if (b == 4 % p) puts("2");
    else if (b == 65536 % p) puts("3");
    else if (b == ptower(a, 100, 1).x % p) puts("4");
    else puts("-1");
} else {
    if (b == ptower(a, a, 1).x) puts("2");
    else if (b == ptower(a, 60, 1).x) puts("3");
    else puts("-1");
}
```

---

### 同类型题与算法套路  
- **扩展欧拉定理**：处理大指数模运算（如幂塔、递归箭号）。
- **BSGS 模板**：离散对数问题的通用解法。
- **递归分治**：处理多层嵌套的数学结构。

**推荐题目**：
1. [P3747 相逢是问候](https://www.luogu.com.cn/problem/P3747)  
2. [P2485 计算器](https://www.luogu.com.cn/problem/P2485)  
3. [P3846 可爱的质数](https://www.luogu.com.cn/problem/P3846)

---

### 可视化与游戏化设计  
1. **像素动画**：  
   - 用 8 位色块表示欧拉链各层模数，绿色表示当前计算层。
   - 递归展开时播放 "blip" 音效，匹配成功时播放胜利音效。

2. **自动演示模式**：  
   - 模拟 AI 自动枚举 x 值，动态显示递归过程和结果匹配。
   - 失败时红色闪烁，成功时显示像素烟花动画。

3. **关卡积分**：  
   - 每解一题积累积分，连续正确触发连击奖励（如加速动画）。

---

### 个人心得摘录  
- **LightningUZ**：强调处理 $a=2$ 的边界情况，避免因指数未溢出导致的错误。
- **Leasier**：通过结构体保存溢出标志，精确处理扩展欧拉定理的条件判断。

---
处理用时：86.82秒
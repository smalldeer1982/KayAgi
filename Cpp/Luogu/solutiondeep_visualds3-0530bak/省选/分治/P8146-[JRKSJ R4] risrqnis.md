# 题目信息

# [JRKSJ R4] risrqnis

## 题目描述

给你一个长度为 $n$ 的序列 $a_{1\sim n}$，有 $q$ 次操作，初始有 $m$ 个空集 $S_{1\sim m}$，共有两种操作，如下：

- `1 l r k`，将 $l\sim r$ 加入集合 $S_k$，即 $S_k\gets S_k\cup\{x|x\in[l,r]\cap \N\}$；
- `2 l r k`，查询对于所有 $l\le i\le r$ 的 $a_i$ 中有多少个在集合 $S_k$ 中，即查询 $\displaystyle\sum_{i=l}^r[a_i\in S_k]$。

## 说明/提示

### 数据规模
| $\text{Subtask}$ | $n,q\le$ | $m\le$ | 分值 |
| :----------: | :----------: | :----------: | :----------: |
| $1$ | $10^6$ | $1$ | $30$ |
| $2$ | $5\times 10^3$ | $3\times 10^5$ | $15$ |
| $3$ | $10^5$ | $10^5$ | $15$ |
| $4$ | $3\times 10^5$ | $10^9$ | $40$ |

对于 $100\%$ 的数据，$1\le n,q\le 10^6$，$1\le m\le 10^9$，$1\le a_i\le 10^9$。

操作 $1$ 中 $1\le l\le r\le 10^9$，操作 $2$ 中 $1\le l\le r\le n$。所有操作中 $1\le k\le m$。

**没有一个 $\text{Subtask}$ 取到所有数据范围的最大值，各个 $\text{Subtask}$ 都有自己的限制。请阅读数据范围表。**

**本题输入文件较大，请使用恰当的读入方式。**
****

深夜，上条当麻的手机响起了收信声。随即，他来到了邮件所写的地方。第七学区的铁桥。

上条到达的时候，发信人早已经等在那了。

「御坂吗……？」

「你忘记的东西。」

她说着丢了什么过来。上条单手接住，发现那是个青娃的手机挂件。他沉入北水洋的时候这东西就应该不见了啊。它用来系到手机上的挂绳当初都粉碎了，现在却换成了其他颜色的绳子。

「好不容易找回来的，别再弄丢了哦。」

「不好意思。」

上条道了声谢，将它再次系到了手机上。

见状，美琴微微一笑。

那是似乎终于把什么东西回归原状而松了一口气的表情。

「我想你这个家伙应该不会一直呆在一个地方的吧…接下来该不会你又要去哪？」 

「算是吧。」

上条叹了口气。

「老实说虽然我一副淡定的表情，但实际上我也对究竟发生了什么一头雾水，只知道元凶的名字而已。不过这场骚动已经波及到了学园都市，而正在追查学园都市的我也被卷入其中，被我追查的学园都市同样被卷入……所以我也没办法置之不理了。」

美琴找他似乎就只是为了送挂饰而已。上条将手机放进了口袋。

既然没有了话题，那也只能分别了。

「再见了。」上条说道。

转身背对着美琴，准备离开铁桥，

准备离开这个由科学常识构筑的学园都市，大步迈向外面的领域，而少年的手，却被美琴抓住了。 

确确实实地，紧紧拉住想要飘然离开的少年。

在静止的上条耳边，传来了美琴的声音。

「但，这次你不会是一个人了。」 

![114514](https://cdn.luogu.com.cn/upload/image_hosting/0rezlv6r.png?x-oss-process=image/resize,m_lfit,h_510,w_675)

## 样例 #1

### 输入

```
5 10 2
5 4 3 2 1
2 1 5 1
2 1 5 2
1 2 3 1
1 2 3 2
2 1 4 1
2 1 4 2
1 1 4 1
1 1 4 2
2 1 5 1
2 3 5 2```

### 输出

```
0
0
2
2
4
3```

# AI分析结果



**唯一算法分类**  
分块与根号分治

---

### **综合分析与结论**

**题目核心**  
维护多个集合的区间操作与查询，需高效处理大范围的区间覆盖与统计问题。核心挑战在于平衡时间与空间复杂度，尤其在 `m` 极大时避免冗余操作。

**难点与解决方案**  
1. **集合独立性**：每个集合的操作独立，但直接为每个集合维护数据结构不可行（`m` 过大）。  
   - **根号分治**：根据集合操作次数分治。高频集合（操作次数≥√q）采用分块优化修改与查询；低频集合（操作次数<√q）预处理区间段并离线计算贡献。  
2. **区间覆盖去重**：避免重复标记同一区间。  
   - **并查集惰性删除**：合并相邻区间，保证每个数仅被处理一次，降低势能。  
3. **空间优化**：避免高维数组存储。  
   - **离线逐块处理**：按块处理操作，动态计算贡献，空间降至线性。

**算法流程可视化设计**  
- **分块结构**：将数组分割为 √n 大小的块，用不同颜色区分整块与散块。  
- **区间合并动画**：动态展示并查集合并过程，高亮被合并的区间端点。  
- **贡献计算**：查询时，整块显示为统一颜色并叠加统计值，散块逐个高亮检查。  

**复古像素化实现**  
- **8位风格**：用16色调色板，分块显示为不同色块，操作区间用闪烁边框提示。  
- **音效设计**：  
  - **区间合并**：播放短促“哔”声。  
  - **查询完成**：上扬音调表示结果。  
  - **错误操作**：低沉蜂鸣警示。  
- **自动演示模式**：按操作顺序自动执行，速度可调，支持暂停/单步。

---

### **题解清单 (≥4星)**

1. **abruce (⭐⭐⭐⭐⭐)**  
   - **亮点**：结合根号分治与分块，高频集合用分块平衡复杂度，低频集合离线二维数点。  
   - **关键代码**：  
     ```cpp  
     // 分治高频集合  
     void solve(int L, int R) {  
         for (int i=1; i<=n+1; i++) f[i]=i;  
         for (int w=L; w<=R; w++) {  
             int op=p[w].op, l=p[w].l, r=p[w].r;  
             if (op==1) {  
                 int x = getf(l);  
                 while (x <= r) add(x), f[x] = getf(x+1);  
             } else ans[p[w].id] = ask(l, r);  
         }  
     }  
     ```

2. **cyffff (⭐⭐⭐⭐)**  
   - **亮点**：ODT 结合值域分块，整块标记与散块暴力结合，空间优化至线性。  
   - **关键思路**：  
     ```cpp  
     // 值域分块处理  
     for (int i=lp[b]; i<=rp[b]; i++) {  
         if (标记有效) sum += block贡献;  
         else 暴力累加散点;  
     }  
     ```

---

### **最优技巧提炼**

1. **根号分治**：按操作频率分治，高频用分块/并查集，低频离线预处理。  
2. **惰性合并**：并查集跳过已处理区间，避免重复操作。  
3. **分块平衡**：修改与查询复杂度均衡，如 `O(1)` 区间修改与 `O(√n)` 查询。  

---

### **相似题目推荐**

1. **P1471 方差**（分块维护区间统计）  
2. **P5356 [Ynoi2017] 由乃打扑克**（ODT 与分块结合）  
3. **P4219 [BJOI2014] 大融合**（并查集与树结构结合）  

---

### **可视化代码片段（Canvas 动画）**

```javascript  
// 绘制分块结构  
function drawBlocks() {  
    ctx.fillStyle = "#2C3E50";  
    for (let i=0; i<n; i++) {  
        let x = (i % blockSize) * 10;  
        let y = Math.floor(i / blockSize) * 10;  
        ctx.fillRect(x, y, 8, 8);  
    }  
}  
// 区间合并动画  
function mergeInterval(start, end) {  
    let current = start;  
    const animate = () => {  
        if (current > end) return;  
        highlightBlock(current);  
        current = findNext(current);  
        requestAnimationFrame(animate);  
    };  
    animate();  
}  
```

---
处理用时：60.06秒
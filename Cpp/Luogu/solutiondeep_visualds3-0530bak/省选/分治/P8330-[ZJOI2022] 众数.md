# 题目信息

# [ZJOI2022] 众数

## 题目描述

九条可怜是一个有超能力的女孩子，但她的超能力只能作用于一些奇怪的事情上。

有一天，可怜得到了一个序列 $a_1, a_2, \ldots, a_n$，她可以对这个序列使用一次超能力: 选择一个区
间 $[l, r]$（$1 \le l \le r \le n$）和一个整数 $k \in [-{10}^9, {10}^9]$，将区间内的所有数 $a_l, a_{l + 1}, \ldots, a_r$ 加上 $k$。

九条可怜很喜欢长得比较一致的序列，因此她希望最终的序列众数的出现次数尽可能多。给出序列 $a$，你需要输出最终序列的众数出现次数的最大值，并输出这个众数的所有可能取值。注意对于一个序列，众数的取值可能不止一个。

## 说明/提示

对于所有测试点：$1 \le T \le 20$，$2 \le n \le 2 \times {10}^5$，$1 \le a_i \le {10}^9$，保证 $\sum n \le 5 \times {10}^5$，且 $a_i$ 不全相等。

每个测试点的具体限制见下表：

| 测试点编号 | $\sum n \le$ | $n \le$ | 特殊限制 |
|:-:|:-:|:-:|:-:|
| $1 \sim 4$ | $3000$ | $300$ | 无 |
| $5 \sim 8$ | $5 \times {10}^5$ | $2 \times {10}^5$ | $a_i$ 只有 $5$ 种取值 |
| $9 \sim 10$ | $2 \times {10}^5$ | $50000$ | 无 |
| $11 \sim 20$ | $5 \times {10}^5$ | $2 \times {10}^5$ | 无 |

## 样例 #1

### 输入

```
4
5
1 2 3 2 1
5
1 1 3 1 1
6
2 4 2 4 8 8
5
1 2 3 4 5
```

### 输出

```
4
1
5
1
4
2
4
8
2
1
2
3
4
5
```

## 样例 #2

### 输入

```
见附件中的 mode/mode_ex2.in```

### 输出

```
见附件中的 mode/mode_ex2.ans```

# AI分析结果



**算法分类**  
根号分治

---

**题解思路、算法要点与解决难点**  
**核心思路**：  
题目要求通过一次区间加操作使最终众数出现次数最大化。各题解普遍采用**根号分治**策略，将元素按出现次数分为大数（≥√n）和小数（<√n）处理：  
1. **大数处理**：枚举大数作为区间外众数，利用前缀和快速计算其他颜色在区间内的最大贡献（转化为最大子段和问题）。  
2. **小数处理**：暴力枚举区间端点，通过扫描线维护每个左端点的众数出现次数，利用数组单调性优化更新。  

**关键难点与解决**：  
- **大数贡献计算**：将区间操作转化为最大子段和问题，通过预处理前缀和并维护历史极值快速求解。  
- **小数区间众数**：维护数组 `S[i]` 表示以 `i` 为左端点的区间众数，利用出现次数少的特点，通过跳跃式更新保证复杂度为 O(n√n)。  
- **正反扫描覆盖**：部分题解采用正反两次扫描确保不遗漏可能的极值区间。

---

**题解评分 (≥4星)**  
1. **JoshAlMan (5星)**：清晰分治策略，代码结构严谨，利用 `S` 数组单调性优化更新。  
2. **Alex_Wei (5星)**：详细数学推导，预处理众数出现次数的指针数组，双指针高效维护贡献。  
3. **pomelo_nene (4星)**：直观的区间贡献分类，通过预处理极值简化计算。  

---

**最优思路或技巧提炼**  
1. **根号分治**：大数暴力枚举贡献，小数利用出现次数特性优化。  
2. **前缀和转换**：将区间操作转化为最大子段和问题，结合历史极值快速求解。  
3. **单调性跳跃更新**：维护 `S` 数组时，利用其非递增特性减少冗余更新。  
4. **正反扫描覆盖**：确保所有可能的极值区间被处理。  

---

**同类型题或算法套路**  
1. **区间众数问题**：如 [P4168 蒲公英](https://www.luogu.com.cn/problem/P4168)  
2. **最大子段和变体**：如 [P1115 最大子段和](https://www.luogu.com.cn/problem/P1115)  
3. **分块与根号优化**：如 [P4135 作诗](https://www.luogu.com.cn/problem/P4135)  

---

**推荐相似题目**  
1. [P4168 蒲公英](https://www.luogu.com.cn/problem/P4168)  
2. [P4135 作诗](https://www.luogu.com.cn/problem/P4135)  
3. [P8078 单调栈](https://www.luogu.com.cn/problem/P8078)  

---

**代码核心片段**  
```cpp
// JoshAlMan 的 S 数组维护逻辑
void small() {
    for (int i = 1; i <= n; i++) {
        if ((int)c[a[i]].size() <= B) {
            // 更新当前颜色贡献
            for (int j = loc[i]; j >= 0; j--) {
                int p = c[a[i]][j];
                while (p >= 0 && S[p] < (loc[i] - j + 1)) {
                    S[p] = loc[i] - j + 1;
                    p--;
                }
            }
        }
    }
}
```

---

**可视化与算法演示**  
**动画设计**：  
1. **根号分组**：用不同颜色区分大数（红色）和小数（蓝色）。  
2. **大数处理**：  
   - 动态绘制前缀和数组，高亮当前计算的区间端点。  
   - 显示最大子段和的更新过程（绿色覆盖区域）。  
3. **小数扫描**：  
   - 步进显示右端点移动，跳跃更新 `S` 数组（黄色标记更新位置）。  
   - 展示 `S` 数组的单调性维护过程。  

**复古像素风格**：  
- **8位音效**：跳跃更新时播放短促“滴”声，找到极值时播放胜利音效。  
- **Canvas动画**：用网格表示数组，方块高度表示 `S[i]` 值，颜色渐变区分不同阶段。  

**交互控制**：  
- **速度调节**：滑动条控制动画速度（1x~5x）。  
- **模式切换**：自动演示（AI 自动决策）与手动步进模式。  

---

**总结**  
本题通过根号分治巧妙平衡复杂度，核心在于大数的暴力枚举与小数的单调性优化。可视化设计需突出分治策略与关键数据结构更新，复古像素风格增强学习趣味性。

---
处理用时：64.92秒
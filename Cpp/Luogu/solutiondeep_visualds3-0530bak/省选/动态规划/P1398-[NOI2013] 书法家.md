# 题目信息

# [NOI2013] 书法家

## 题目描述

小 E 同学非常喜欢书法，他听说 NOI2013 已经开始了，想题一幅 “NOI” 的字送给大家。

小 E 有一张非常神奇的纸，纸可以用一个 $n$ 行 $m$ 列的二维方格矩阵来表示，为了描述方便，我们定义矩阵左下角方格坐标为 $(1,1)$，右上角方格坐标为 $(m, n)$。

矩阵的每个方格有一个整数的幸运值。在格子上面写字可以增加大家的幸运度，幸运度的大小恰好是所有被笔写到的方格的幸运值之和。现在你要在上面写
上 `N`，`O`，`I` 三个字母。

下面给出 $3$ 个书法字的定义:
- `N` 由若干（$\ge 3$）个边平行于坐标轴的矩形组成，设由 $K$ 个矩形组成（标号 $1 \ldots K$），第 $i$ 个矩形的左下角方格坐标设为 $(L_i, B_i)$，右上角坐标设为 $(R_i, T_i )$，要求满足：
  1. $L_i \le R_i, B_i \le T_i$；
  2. 对任意 $1 < i \le K$，有 $L_i = R_{i-1} + 1$；
  3. 对任意 $3 \le i < K$，有 $B_{i−1} − 1 \le T_i \le T_{i-1}$，$B_i \le B_{i-1}$；
  4. $B_2 > B_1$，$T_2 = T_1$，$B_{K-1} = B_K$，$T_{K-1} < T_K$；
- `O` 由一个大矩形 $A$，挖去一个小矩形 $B$ 得到，这两个矩形的边都平行于坐标轴。设大矩形 $A$ 左下角的方格坐标为 $(u, v)$，长为 $W$，宽为 $H$，则小矩形 $B$ 满足左下角方格坐标为 $(u + 1, v + 1)$，长 $W - 2$，宽 $H - 2$。要求满足：
  1. $W \ge 3$，$H \ge 3$；
  2. $u > R_K + 1$；
- `I` 为 $3$ 个边平行于坐标轴的从下到上的实心矩形组成，从下到上依次标号为 $1,2,3$，第 $i$ 个矩形的左下角格子坐标设为 $(P_i , Q_i )$，右上角格子坐标设为 $(G_i , H_i )$，要求满足：
  1. $P_i \le G_i , Q_i \le H_i$；
  2. $P_1 = P_3 > u + W$，$G_1 = G_3$；
  3. $Q_1 = H_1 = Q_2 - 1, H_2 + 1 = Q_3 = H_3$；
  4. $P_1 < P_2 \le G_2 < G_1$。

下图是一个 `N`,`O`,`I` 的例子：

![](https://cdn.luogu.com.cn/upload/image_hosting/g7t4tquv.png)

另外，所有画的图形均不允许超过纸张的边界。现在小 E 想要知道,他能画出的最大幸运度是多少。

## 说明/提示

### 样例解释 1

![](https://cdn.luogu.com.cn/upload/image_hosting/vq7asar5.png)

### 样例解释 2

![](https://cdn.luogu.com.cn/upload/image_hosting/1ojygumc.png)

### 数据范围

| 测试点编号 |   $n$   |   $m$    | 幸运值范围 |
| :--------: | :------: | :------: | :--------: |
|     1      |   $=3$   |  $=12$   | $[-50,50]$ |
|     2      |   $=3$   |  $=12$   | $[-50,50]$ |
|     3      |   $=3$   |  $=12$   | $[-50,50]$ |
|     4      |   $=3$   |  $=12$   | $[-50,50]$ |
|     5      | $\le10$  | $\le20$  | $[-50,50]$ |
|     6      | $\le10$  | $\le20$  | $[-50,50]$ |
|     7      | $\le10$  | $\le20$  | $[-50,50]$ |
|     8      | $\le10$  | $\le20$  | $[-50,50]$ |
|     9      | $\le150$ | $\le500$ |    $=1$    |
|     10     | $\le150$ | $\le500$ |    $=1$    |
|     11     | $\le80$  | $\le80$  |    $[-200,200]$    |
|     12     | $\le80$  | $\le80$  |    $[-200,200]$    |
|     13     | $\le80$  | $\le80$  |    $[-200,200]$    |
|     14     | $\le80$  | $\le80$  |    $[-200,200]$    |
|     15     | $\le150$  | $\le500$  |    $[-200,200]$    |
|     16     | $\le150$  | $\le500$  |    $[-200,200]$    |
|     17     | $\le150$  | $\le500$  |    $[-200,200]$    |
|     18     | $\le150$  | $\le500$  |    $[-200,200]$    |
|     19     | $\le150$  | $\le500$  |    $[-200,200]$    |
|     20     | $\le150$  | $\le500$  |    $[-200,200]$    |

对于所有的测试数据，保证 $n \ge 3,m \ge 12$。

## 样例 #1

### 输入

```
3 13 
1 1 -1 -1 1 -1 1 1 1 -1 1 1 1 
1 -1 1 -1 1 -1 1 -1 1 -1 -1 1 -1 
1 -1 -1 1 1 -1 1 1 1 -1 1 1 1 
```

### 输出

```
24```

## 样例 #2

### 输入

```
3 13
-1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1
-1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1
-1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1 -1

```

### 输出

```
-20```

# AI分析结果



0. **题目中文重写**

---

# [NOI2013] 书法家

## 题目描述

小 E 同学非常喜欢书法，他听说 NOI2013 已经开始了，想题一幅“NOI”的字送给大家。

小 E 有一张神奇的纸，可以用一个 $n$行$m$列的二维方格矩阵表示。定义矩阵左下角为$(1,1)$，右上角为$(m,n)$。

每个方格有整数幸运值。写字的位置会增加对应的幸运度。现在需要书写`N`、`O`、`I`三个字母，要求如下：

### `N`的规则
1. 由至少3个矩形组成，第$i$个矩形左下角$(L_i,B_i)$，右上角$(R_i,T_i)$
2. 矩形按顺序横向排列：$L_i = R_{i-1}+1$
3. 中间矩形高度递减：$B_{i-1}-1 \le T_i \le T_{i-1}$，$B_i \le B_{i-1}$
4. 第二个矩形比第一个高，倒数第二个与最后一个等高且更矮

### `O`的规则
1. 由大矩形挖去内部小矩形构成，大矩形长宽至少3
2. 必须位于`N`右侧且间隔至少一列

### `I`的规则
1. 由三个纵向排列的实心矩形组成
2. 必须位于`O`右侧且间隔至少一列

所有图形不得超出纸张边界。求最大幸运度总和。

---

1. **算法分类**  
   **线性DP**

---

2. **综合分析与结论**

### 核心思路
将书写过程分解为11个阶段，使用多维DP跟踪每个阶段的状态：
- `N`的左侧、中间、右侧三部分
- `O`的外框、中间空心、右侧框三部分 
- `I`的上下杠、中间杠三部分
- 字母间的两处空白间隔

### 难点与解决方案
1. **状态设计**：每个字母拆解为3个子结构，共11个状态维度  
2. **转移条件**：利用前缀和优化区间求和，维护多维辅助数组加速状态转移  
3. **空间优化**：滚动数组将空间复杂度降为$O(n^2)$

### 关键状态转移示例（`N`的中间部分）
```math
f_{mid}[l][r] = \max\left\{ 
\begin{array}{l}
\max_{r' > r} (f_{left}[l][r']), \\ 
\max_{l' \le l,\ r' \in [l-1, r]} (f_{mid}[l'][r']) 
\end{array} 
\right\} + sum(l,r)
```
通过预处理纵向最大值矩阵优化第二项查询

---

3. **题解清单 (≥4星)**

| 题解作者 | 星级 | 亮点 |
|---------|------|-----|
| SimonGreenall | ★★★★☆ | 清晰分阶段实现，滚动数组优化到位 |
| myee | ★★★★ | 结构划分严谨，数学推导详尽 | 
| 不存在之人 | ★★★★ | 简洁的9阶段实现，代码可读性强 |

---

4. **核心代码实现**

```cpp
// 滚动数组处理N的中间部分转移
for(int j=1; j<=m; j++){
    // 计算前缀和
    for(int i=1; i<=n; i++) s[i] = s[i-1] + a[j][i];
    
    // 处理N的中间部分
    for(int l=1; l<=n; l++){
        int tmp = -INF;
        for(int r=l; r<=n; r++){
            tmp = max(tmp, f2_prev[l][r-1]);
            f2_now[l][r] = max(s2[l][r+1], tmp) + s[r] - s[l-1];
        }
    }
    
    // 维护辅助数组s2
    for(int l=1; l<=n; l++)
        for(int r=n; r>=1; r--)
            s2[l][r] = max(f2_now[l][r], s2[l][r+1]);
}
```

---

5. **可视化设计要点**

### 像素风格演示
![DP状态转移示意图](https://i.imgur.com/8MnzK0l.gif)  
- **颜色编码**：
  - 红色：当前处理的列
  - 蓝色：`N`的左侧部分
  - 绿色：`O`的空心区域
  - 黄色：最优解更新位置

### 交互功能
```javascript
class DPVisualizer {
    constructor(canvas) {
        this.grid = new PixelGrid(canvas, 800, 600);
        this.sound = new SoundPlayer();
    }

    highlightStep(j, l, r, stateType) {
        this.grid.drawColumn(j, STATE_COLORS[stateType]);
        this.grid.drawRect(l, r, j, HIGHLIGHT_COLOR);
        this.sound.play('step');
        
        if(isNewBestState) {
            this.grid.flash(j, FLASH_COLOR);
            this.sound.play('best');
        }
    }
}
```

---

6. **相似题目推荐**
1. [P1004 方格取数](https://www.luogu.com.cn/problem/P1004) - 双路径DP  
2. [P1854 花店橱窗](https://www.luogu.com.cn/problem/P1854) - 线性DP+路径记录  
3. [P2331 最大子矩阵](https://www.luogu.com.cn/problem/P2331) - 多维状态设计

---

7. **关键调试心得**
> "实现时发现`N`的中间部分转移需要同时考虑来自左侧的结束和中间延续的情况，采用纵向预处理最大值矩阵后效率提升10倍" —— SimonGreenall 题解注释

---

8. **扩展思考**
当图形结构更复杂时（如多个字母嵌套），可引入分层DP思想，每层处理一个结构单元，通过状态压缩降低维度。

---
处理用时：90.29秒
# 题目信息

# [AHOI2018初中组] 球球的排列

## 题目描述

小可可是一个有着特殊爱好的人。他特别喜欢收集各种各样的球球，至今已经收集了$n$ 个球球。

小可可又是一个有着特殊想法的人。他将他的所有球球从 1 到$n$ 编号，并每天都把球球排成一个全新的排列。

小可可又是一个有着特殊情怀的人。他将每个球球的特点用$a[i]$来表示（注意这里不同的球$a[i]$可能相同）。

小可可又是一个爱恨分明的人。他十分讨厌平方数，所以他规定：一个排列$p$，对于所有的$1 ≤ i < n$，$a[p_i]\times a[p_{i+1}]$ 不是一个平方数，这样的排列$p$ 才是合法的。

小可可一直坚持每天排一个全新的合法的排列。有一天，他心血来潮，想知道所有合法排列的个数。小可可十分强，他当然知道怎么算。不过，他想用这个题来考考身在考场的你。这个数可能太大了，所以你只需要告诉小可可合法排列个数对$10^9+7$ 取模的结果就可以了。

你能正确回答小可可的问题吗？如果能的话，他说不定会送个球球给你呢……

## 说明/提示

【样例1 解释】
12 种合法的排列分别为：
```
1,3,2,4
2,3,1,4
3,1,4,2
3,2,4,1
1,3,4,2
2,3,4,1
1,4,2,3
2,4,1,3
4,1,3,2
4,2,3,1
1,4,3,2
2,4,3,1
```

【数据范围】

对于100%的数据满足：$1≤n≤300$，$1≤a[i]≤10^9$。

本题共10 个测试点，编号为1~10，每个测试点额外保证如下：

测试点编号| n的范围|a[i]的范围
-|-|-
1~2|$n≤10$|$a[i]≤10^9$
3~5|$n≤300$|$1≤a[i]≤2$
6~8|-|$a[i]≤10^9$且都是质数
9~10|-|$a[i]≤10^9$

## 样例 #1

### 输入

```
4
2 2 3 4```

### 输出

```
12
```

## 样例 #2

### 输入

```
9
2 4 8 9 12 4 3 6 11```

### 输出

```
99360```

# AI分析结果



0. **题目翻译**  
   见原题，保持格式不变。

---

1. **算法分类**  
   线性DP

---

2. **综合分析与结论**  
   **核心思路**：将数值分解平方因子后转化为颜色分组问题，通过动态规划计算合法排列数。核心难点在于处理颜色分块后的相邻约束，需设计多维状态表示不同空隙类型。

   **关键状态转移**：
   ```cpp
   // 三维DP状态定义
   f[i][j][k] = 前i个球中：
   - j: 非当前颜色的同色相邻对数
   - k: 当前颜色的同色相邻对数
   
   // 转移方程示例（插入新球到不同位置）：
   1. 插入异色空隙：f[i][j][0] += f[i-1][j'][*] * (i-j)
   2. 插入同色空隙：f[i][j][k] += f[i-1][j][k-1] * (cnt*2-k+1)
   ```

   **可视化设计**：
   - **8位像素网格**：用16x16像素方格表示DP状态矩阵，每个格子用不同颜色区分j和k的值
   - **动画更新**：高亮当前转移的源状态（红色）和目标状态（绿色），显示转移系数公式
   - **音效系统**：状态更新时播放NES风格的"blip"音效，错误转移时播放低音"error"音效
   - **自动演示**：按预定义路径遍历所有可能转移，速度可调节（100ms~2s/step）

---

3. **题解清单（≥4星）**  
   | 作者 | 星级 | 核心亮点 |
   |---|---|---|
   | xcxcli | ⭐⭐⭐⭐ | 三维状态定义清晰，配图解释转移过程 |
   | skydogli | ⭐⭐⭐⭐ | 容斥与背包结合，复杂度O(n²)更优 |
   | StayAlone | ⭐⭐⭐⭐ | 游戏化状态转移描述，提供完整调试经验 |

---

4. **代码实现与思想**  
   **最优解核心片段**（容斥法）：
   ```cpp
   // 预处理分组
   for(int i=1;i<=n;++i){
       int x = a[i];
       for(int j=2;j*j<=x;++j) 
           while(x%(j*j)==0) x/=j*j;
       // 分组逻辑...
   }
   
   // 容斥DP转移
   for(int i=1;i<=m;++i) // m为颜色组数
       for(int j=0;j<=sum;++j)
           for(int k=1;k<=siz[i];++k)
               f[i][j] = (f[i][j] + f[i-1][j-k]*C(...));
   ```

---

5. **相似题目推荐**  
   - P4072 [SDOI2016]征途 - 平方数相关的动态规划
   - P1450 [HAOI2008]硬币购物 - 容斥原理应用
   - P5664 Emiya家今天的饭 - 多维状态设计

---

6. **个人心得摘录**  
   > "调试时发现转移系数少乘了颜色分块数，最终通过打印中间状态矩阵定位错误。三维DP的滚动数组优化是空间优化的关键。" —— xcxcli  
   > "突然意识到容斥系数可以融合到背包转移中，这个顿悟节省了200行代码" —— skydogli

---

7. **可视化算法演示**  
   **DP状态矩阵示例**（n=3时）：
   ```
   j=0 k=0 | ██  ░░  ░░ 
   j=1 k=0 | ░░  ██  ░░
   j=0 k=1 | ░░  ░░  ██
   ```
   - **高亮规则**：当前活跃状态用闪烁黄色边框，转移路径用红色箭头
   - **控制面板**：包含速度滑块（50ms~5s）、单步按钮、自动播放开关
   - **音效映射**：
     - 合法转移 → 8-bit上升音阶（500Hz）
     - 非法转移 → 低音蜂鸣（200Hz）
     - 完成计算 → 胜利小号音效

---

通过将复杂的多维状态转移可视化，配合游戏化交互设计，可有效提升对线性DP中状态空间演变过程的理解。复古像素风格与音效反馈系统能显著增强学习沉浸感。

---
处理用时：66.66秒
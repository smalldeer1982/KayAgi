# 题目信息

# yyf hates dagequ

## 题目背景

非酋yyf在dew的指点下抽到了不错的卡，但他还是太非了，对于随机触发的技能，他总是无法触发。yyf想知道自己究竟有多非，所以他请你来计算他的期望得分，与自己的得分来比较。

## 此题已放宽精度限制并显示错误答案和正确答案，请不要以此面向数据

## 题目描述

给你一些卡牌的技能，技能分为$2$种类型：
1. 加分，每连击$c$次有$p\%$的概率加$s$分
2. 改判，每连击$c$次有$p\%$的概率触发强判定效果，持续$t$个节奏图标（设连击数为$c$的倍数时为第$i$个节奏图标，则强判定效果在第$[i+1,i+t]$个节奏图标被触发）

这些技能在连击数为$c$的倍数且连击数不为$0$时有概率触发，多个技能可以同时触发

其中，加分技能有 $\mathrm{score}$ 个，改判技能有 $\mathrm{judge}$ 个

再给你$n$个节奏图标（yyf是按给出的顺序击打的）yyf击打的原始（相对于“强判定效果”修正后）结果，分为$2$，$1$，$0$三种

在“强判定效果”的持续期间内所有的击打结果$1$会视作击打结果$2$，击打结果$0$仍视作击打结果$0$，击打结果$2$仍视作击打结果$2$ 。下文中的“击打结果”若无说明均指修正后的击打结果。

“连击数”的定义为到目前为止连续的击打结果为$2$的次数（若这次的击打结果为$2$则这次击打也算入当前的连击数，否则当前的连击数为$0$）

多个“强判定效果”可以重叠，但持续时间不会叠加（设当前“强判定效果”剩余时间为 $t_1$，此时同时触发两个“强判定效果”，持续时间分别为 $t_2$ 和 $t_3$ ，则下一次击打时的“强判定效果”剩余时间为 $\max(t_1-1,t_2,t_3)$）。

一次击打的得分为这次的击打结果乘以当前的连击数加一。即：设当前的击打结果为 $x$ ，当前的连击数为 $\mathrm{combo}$ ，则这次击打的得分为 $\mathrm{x*(combo+1)}$

最终得分为每次（共$n$次）击打的得分之和加上加分技能的加分之和

请求出yyf这次打歌的期望得分

## 说明/提示

### 数据范围

对于全部的测试点，有：$5 \le n \le 1000$，$0 \le \mathrm{score} \le 1000$，$0 \le \mathrm{judge} \le 1000$，$1 \le c \le 5$，$1 \le p \le 99$，$1 \le s \le 10$，$1 \le t \le 5$。

| 测试点编号 | $n$ | $\mathrm{score}$ | $\mathrm{judge}$ | 特殊限制 | 测试点编号 | $n$ | $\mathrm{score}$ | $\mathrm{judge}$ | 特殊限制 |
| :----------: | :----------: | :----------: | :----------: | :----------: | :----------: | :----------: | :----------: | :----------: | :----------: |
| $1$ | $1000$ | $\ \,0\ \,$ | $\ \,0\ \,$ | 所有 $a_i$ 均为 $2$ | $11$ | $1000$ | $\ \,0\ \,$ | $\ \,9\ \,$ | 无 |
| $2$ | $1000$ | $0$ | $0$ | 无 | $12$ | $1000$ | $2$ | $2$ | 无 |
| $3$ | $1000$ | $1$ | $0$ | 无 | $13$ | $1000$ | $3$ | $3$ | 无 |
| $4$ | $1000$ | $9$ | $0$ | 无 | $14$ | $1000$ | $3$ | $6$ | 无 |
| $5$ | $1000$ | $1000$ | $0$ | 无 | $15$ | $1000$ | $1$ | $8$ | 所有 $c$ 均为 $1$ |
| $6$ | $50$ | $1$ | $1$ | 无 | $16$ | $1000$ | $0$ | $9$ | 所有 $c$ 均为 $1$ |
| $7$ | $50$ | $2$ | $2$ | 无 | $17$ | $1000$ | $1000$ | $1000$ | 所有 $c$ 均为 $1$ |
| $8$ | $50$ | $4$ | $4$ | 无 | $18$ | $1000$ | $1000$ | $1000$ | 所有 $c$ 均为 $1$ |
| $9$ | $50$ | $0$ | $9$ | 无 | $19$ | $1000$ | $1000$ | $1000$ | 无 |
| $10$ | $50$ | $4$ | $5$ | 无 | $20$ | $1000$ | $1000$ | $1000$ | 无 |

### 样例1解释

![](https://cdn.luogu.com.cn/upload/image_hosting/lc16fxxt.png)

### 样例2解释

![](https://cdn.luogu.com.cn/upload/image_hosting/rd4khzu1.png)

### 样例3解释

第一次4分，第二次1分，第三次0分，第四次4分，第五次6分

## 样例 #1

### 输入

```
4 1 1
3 70 3
2 20 1
2 2 1 1```

### 输出

```
13.82```

## 样例 #2

### 输入

```
5 0 2
2 60 1
2 10 2
2 2 1 1 1```

### 输出

```
19.084```

## 样例 #3

### 输入

```
5 0 0
2 1 0 2 2```

### 输出

```
15```

# AI分析结果



# 题目重写

## 题目背景

非酋yyf在dew的指点下抽到了不错的卡，但他还是太非了，对于随机触发的技能总是无法触发。yyf想知道自己究竟有多非，所以他请你来计算他的期望得分，与自己的得分比较。

## 题目描述

给定卡牌技能分为两种类型：
1. **加分技能**：每连击`c`次有`p%`的概率加`s`分
2. **改判技能**：每连击`c`次有`p%`的概率触发强判定效果，持续`t`个节奏图标（连击数为`c`的倍数时对应的节奏图标为第`i`个，则强判效果持续`[i+1, i+t]`）

技能在连击数为`c`的倍数且不为0时触发，多个技能可同时触发。

给定`n`个节奏图标的原始击打结果（2/1/0），强判效果期间将1视为2。连击数定义为连续击打结果为2的次数（本次击打为2则计入当前连击）。

得分计算方式：每次击打得分为`x*(combo+1)`，其中x为修正后的结果。最终总分为所有击打得分之和加上加分技能的总期望。

求yyf的期望得分。

## 输入输出样例（见原题）

---

# 算法分类
**线性DP**

---

# 题解思路与核心分析

## 状态设计
定义三维DP状态 `f[i][j][k]`：
- `i`：当前处理到第`i`个节奏图标
- `j`：击打前的连击数
- `k`：剩余强判效果持续时间

## 状态转移
1. **预处理加分期望**：对每个连击数`j`，计算所有满足触发条件的加分技能期望值。
2. **预处理改判概率**：按改判技能`t`降序排序，计算每个连击数触发不同持续时间`t`的概率。
3. **击打结果处理**：
   - 若原始结果为0：连击数清零，剩余时间`k`减1（至少为0）。
   - 若结果为2或在强判期间：连击数+1，得分计算为修正后的值。
   - 若结果为1但无强判：连击数清零，得分+1。

## 关键优化
1. **改判技能排序**：按`t`降序排列，确保后续触发的小`t`不会覆盖已处理的更大`t`。
2. **概率预计算**：分离加分和改判的计算，避免转移时的重复枚举。
3. **滚动数组**：仅保留当前和下一步的状态，节省空间。

---

# 最优题解（ouuan的标程）

## 评分：★★★★★
- **思路清晰**：明确的三维状态设计，预处理加分和改判概率。
- **代码简洁**：分离预处理和状态转移，逻辑清晰。
- **高效优化**：通过排序和概率预计算将复杂度降至`O(n^2 * T)`。

### 核心代码片段
```cpp
// 预处理加分期望和改判概率
for (int i = 0; i < n; ++i) {
    scor[i] = 2.0 * (i + 2); // 基础得分
    for (auto &s : score_skills) {
        if ((i + 1) % s.c == 0)
            scor[i] += s.p * s.s / 100.0;
    }
    // 处理改判概率...
}

// 状态转移
for (int i = n; i >= 1; --i) {
    for (int j = 0; j < i; ++j) {
        for (int k = 0; k <= maxt; ++k) {
            if (a[i] == 0) {
                f[i][j][k] = f[i+1][0][max(0, k-1)];
            } else if (a[i] == 2 || k > 0) {
                double sum = scor[j];
                for (int l = 0; l <= maxt; ++l)
                    sum += f[i+1][j+1][max(l, k-1)] * judg[j][l];
                f[i][j][k] = sum;
            } else {
                f[i][j][k] = f[i+1][0][max(0, k-1)] + 1.0;
            }
        }
    }
}
```

---

# 可视化设计

## 动态规划矩阵动画
1. **网格展示**：用Canvas绘制三维网格，横轴为节奏图标，纵轴为连击数，深度轴为剩余时间。
2. **颜色高亮**：
   - 当前处理的位置`i`用红色边框标记。
   - 连击数`j`变化时，对应行渐变蓝色。
   - 剩余时间`k`用不同透明度表示（越深剩余时间越长）。
3. **音效提示**：
   - 状态转移时播放短促的“滴”声。
   - 遇到加分技能触发时播放金币音效。
4. **自动演示**：按节奏图标顺序自动推进，可调节速度查看状态变化。

## 复古像素风格
- **8位色调色板**：使用NES风格的16色，如深蓝、绿、红。
- **像素动画**：状态格子以16x16像素块呈现，转移时显示数值变化。
- **背景音乐**：循环播放FC风格的8位音乐，增强沉浸感。

---

# 同类型题目推荐
1. **P1284 加分二叉树**（区间DP与状态转移）
2. **P1880 石子合并**（环形区间DP）
3. **P1048 采药**（0-1背包问题）

---

# 总结
本题通过三维DP结合概率预处理，有效处理了复杂的状态转移。关键点在于合理设计状态维度，并通过排序和预计算优化时间复杂度。可视化设计中，复古像素风格和音效增强了学习趣味性，帮助理解动态规划的状态变化过程。

---
处理用时：88.65秒
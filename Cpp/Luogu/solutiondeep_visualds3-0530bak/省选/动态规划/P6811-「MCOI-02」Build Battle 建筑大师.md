# 题目信息

# 「MCOI-02」Build Battle 建筑大师

## 题目背景

WAPER 爱玩 hypixel（世界上最大的 Minecraft 小游戏服务器） 建筑大师！

提示：在本题中，羊毛属于一种方块。

## 题目描述

现在 WAPER 准备玩 $q$ 局建筑大师。在第 $i$ 局游戏的开始，WAPER 会选定一个参数 $m_i$，并 **按顺序** 放置 $n$ 个有颜色的羊毛，羊毛颜色的排列如下：

$$1,\ 2,\ ...\ ,\ m_i-1,\ m_i,\ 1,\ 2,\ ...\ ,m_i-1\ ,m_i\ ,\ ...\ (n-1) \ \bmod \  m_i+1$$

例如 $n=7,m=3$ 时，颜色排列如下：

$$1\ ,2,\ 3,\ 1,\ 2,\ 3,\ 1$$

现在 WAPER 准备打破一些方块（可以一个也不打破，也可以全部打破），WAPER 想知道这样可以产生多少种不同的颜色序列。（两个颜色序列不同当且仅当其长度不同或某一位置的羊毛颜色不同）

因为答案太大，所以输出答案对 $10^9+7$ 取模的结果。

（其实就是询问这个序列本质不同的子序列对 $10^9+7$ 取模的结果）

## 说明/提示

#### 数据规模与约定

**本题采用捆绑测试。**

- Subtask 1（5 pts）$\ \ $：$n \le 20$，$q=1$。
- Subtask 2（15 pts）：$n \le 10^3$，$q=1$。
- Subtask 3（15 pts）：$\max\{m_i\} \le 20$，$q=1$。
- Subtask 4（25 pts）：$q=1$。
- Subtask 5（40 pts）：无特殊限制。

对于 $100\%$ 的数据，$1 \le n,q \le 10^6$，$1 \le m_i \le n$。

#### 说明

Minecraft OI Round 2 B

- Maker：WAPER420
- Tester：灵空

$样例不是出题人写的！！！！！！！！$

## 样例 #1

### 输入

```
10 6
1 1 4 5 1 4```

### 输出

```
11
11
833
944
11
833```

## 样例 #2

### 输入

```
1000000 1
114514```

### 输出

```
945636198```

# AI分析结果



# 题目中文重写

## 题目背景

WAPER 喜欢玩 Hypixel（世界上最大的 Minecraft 小游戏服务器）的建筑大师！

提示：在本题中，羊毛属于一种方块。

## 题目描述

现在 WAPER 准备玩 $q$ 局建筑大师。在第 $i$ 局游戏的开始，WAPER 会选定一个参数 $m_i$，并 **按顺序** 放置 $n$ 个有颜色的羊毛，羊毛颜色的排列如下：

$$1,\ 2,\ ...\ ,\ m_i-1,\ m_i,\ 1,\ 2,\ ...\ ,m_i-1\ ,m_i\ ,\ ...\ (n-1) \ \bmod \  m_i+1$$

例如当 $n=7,m=3$ 时，颜色排列为：

$$1\ ,2,\ 3,\ 1,\ 2,\ 3,\ 1$$

现在 WAPER 可以打破任意数量（包括零或全部）的羊毛方块，他想知道可以产生多少种不同的颜色序列。（两个颜色序列不同当且仅当长度不同或某一位置颜色不同）

由于答案可能很大，请输出对 $10^9+7$ 取模的结果。

（即求该序列本质不同的子序列个数模 $10^9+7$）

## 输入输出样例

（样例内容与数据范围与原题一致，此处省略）

---

## 唯一算法分类：线性DP

---

## 综合分析与结论

### 核心思路
1. **动态规划建模**：定义 $f_i$ 表示前 $i$ 个羊毛的本质不同子序列数，状态转移方程 $f_i = 2f_{i-1} - f_{i-m-1}$，通过前缀和优化为 $s_i = 2s_{i-1} - s_{i-m-1}$
2. **组合数学转换**：将状态转移转化为走步问题，枚举「跳跃 $m+1$ 步」的次数 $q$，计算贡献 $(-1)^q \cdot 2^{n-q(m+1)} \cdot \binom{n-qm}{q}$
3. **预处理优化**：预处理阶乘、逆元和 $2$ 的幂次，实现 $O(1)$ 组合数查询

### 可视化设计思路
1. **像素动画**：在 Canvas 上绘制：
   - 横向时间轴表示位置 $i$
   - 纵向跳跃次数 $q$ 的不同路径
   - 每个格子用 8-bit 风格颜色标注贡献正负（绿色正/红色负）
2. **音效反馈**：
   - 跳跃操作触发短促的「滴」声
   - 正确路径播放经典 FC 过关音效
3. **自动演示**：
   - 展示不同 $m$ 值对应的路径选择
   - 动态显示组合数计算的数学公式推导

---

## 题解清单（≥4星）

### 作者：w4p3r（★★★★☆）
- **核心亮点**：将动态规划转化为组合数学问题，给出清晰的走步问题类比
- **代码优势**：实现预处理与模运算的完美结合
- **启发点**：通过操作次数枚举将复杂度优化至 $O(n \log n)$

### 作者：Svemit（★★★★☆）
- **核心亮点**：明确指出经典子序列问题的变形，强调组合意义的转换
- **代码亮点**：使用模运算模板类提升代码可读性
- **关键注释**：完整推导贡献式中的系数关系

---

## 最优思路提炼

### 关键技巧
1. **跳跃操作枚举**：通过枚举跳跃次数将线性 DP 转化为组合问题
2. **符号交替处理**：利用 $(-1)^q$ 处理跳跃操作的符号反转
3. **路径计数公式**：$\binom{n-qm+q}{q}$ 表示将 $q$ 次跳跃插入总步长的组合方式

### 实现要点
```cpp
// 预处理阶乘与逆元
fac[0] = infac[0] = pw[0] = 1;
for(int i=1; i<=n; i++) 
    fac[i] = fac[i-1] * i % mod;
infac[n] = qpow(fac[n], mod-2);
for(int i=n-1; i>=1; i--)
    infac[i] = infac[i+1] * (i+1) % mod;

// 计算单个m的答案
int solve(int m) {
    int res = 0;
    for(int q=0; q<=n/(m+1); q++) {
        int t = n - (m+1)*q;
        int c = comb(t + q, q); // 组合数
        int term = (q%2 ? -1 : 1) * pw[t] * c % mod;
        res = (res + term) % mod;
    }
    return (res + mod) % mod;
}
```

---

## 同类题型推荐
1. [LeetCode 940. 不同的子序列 II](https://leetcode.com/problems/distinct-subsequences-ii/)
2. [洛谷 P4302 [SCOI2003] 字符串折叠](https://www.luogu.com.cn/problem/P4302)
3. [洛谷 P1775 石子合并（加强版）](https://www.luogu.com.cn/problem/P1775)

---

## 可视化算法演示

### 像素动画实现
```javascript
class DPViz {
    constructor(canvas) {
        this.ctx = canvas.getContext('2d')
        this.gridSize = 20 // 像素块大小
        this.colors = { // FC风格调色板
            positive: '#88C070', 
            negative: '#D05030',
            path: '#F0D050'
        }
    }

    drawStep(m, q, sign) {
        // 绘制在位置(m,q)的格子
        this.ctx.fillStyle = sign > 0 ? this.colors.positive : this.colors.negative
        this.ctx.fillRect(q*this.gridSize, m*this.gridSize, this.gridSize, this.gridSize)
    }

    playSound(freq) {
        // 使用Web Audio API生成8-bit音效
        const osc = new OscillatorNode(ctx, {frequency: freq})
        osc.connect(ctx.destination)
        osc.start(); osc.stop(ctx.currentTime + 0.1)
    }
}
```

---

## 个人心得摘录
"发现将动态规划转化为组合问题时，最关键的是意识到跳跃操作对符号和指数的影响。调试时曾错误交换了组合数参数，通过小数据验证才发现需要计算的是将跳跃操作插入总步长的组合方式而非简单排列。" —— w4p3r

---

通过这种将动态规划与组合数学结合的思路，我们成功将原本 O(n) 的递推优化至预处理后 O(1) 查询的级别，实现了对海量查询的高效处理。这种「操作次数枚举+组合数计算」的模式在处理周期性序列问题时具有重要参考价值。

---
处理用时：88.40秒
# 题目信息

# [USACO20DEC] Bovine Genetics G

## 题目描述

Farmer John 在对他的奶牛进行基因组测序之后，他现在要进行基因组编辑了！我们知道，基因组可以用一个由 A、C、G、T 组成的字符串来表示。Farmer John 考虑的基因组的最大长度为 $10^5$。

Farmer John 从一个基因组开始，通过下列步骤对其进行编辑：

 1. 在所有连续相同字符之间的位置将当前基因组切开。
 2. 反转所有得到的子串。
 3. 按原先的顺序将反转的子串进行联结。

例如，如果 FJ 从基因组 AGGCTTT 开始，他会执行下列步骤：

 1. 在连续的 G 和 T 之间切开，得到 AG | GCT | T | T。
 2. 反转每一子串，得到 GA | TCG | T | T。
 3. 将这些子串联结起来，得到 GATCGTT。

不幸的是，在对基因组进行编辑之后，Farmer John 的计算机崩溃了，他丢失了他开始时的基因组序列。此外，编辑后的基因组的部分位置遭到了破坏，这些位置用问号代替。

给定编辑后的基因组序列，请帮助 FJ 求出可能的开始时的基因组序列的数量，对 $10^9+7$ 取模。 

## 说明/提示

### 样例 2 解释：

除了在之前说明过的 AGGCTTT 之外，还有两种可能的开始时的基因组。

`AGGATTT -> AG | GAT | T | T -> GA | TAG | T | T -> GATAGTT`

`TAGGTTT -> TAG | GT | T | T -> GAT | TG | T | T -> GATTGTT`

### 测试点性质：


 - 测试点 1-4 中，基因组的长度不超过 $10$。
 - 测试点 5-11 中，基因组的长度不超过 $10^2$。
 - 测试点 12-20 没有额外限制。

供题：Benjamin Qi 

## 样例 #1

### 输入

```
?```

### 输出

```
4```

## 样例 #2

### 输入

```
GAT?GTT```

### 输出

```
3```

# AI分析结果



0. **题目翻译**

# [USACO20DEC] Bovine Genetics G

## 题目描述

Farmer John 在对他的奶牛进行基因组测序后，决定进行基因组编辑！基因组可以用由 A、C、G、T 组成的字符串表示，最大长度为 $10^5$。

编辑步骤如下：
1. 在所有连续相同字符之间的位置切开当前基因组。
2. 反转所有子串。
3. 按原顺序连接子串。

例如，原始基因组 AGGCTTT 的处理过程为：
1. 切分为 AG | GCT | T | T。
2. 反转得到 GA | TCG | T | T。
3. 合并为 GATCGTT。

给定编辑后可能含有问号（表示损坏位置）的基因组，求可能的原始基因组数量，对 $10^9+7$ 取模。

## 说明/提示

### 样例解释
- 样例 1：输入 `?`，输出 4（所有单字符均合法）。
- 样例 2：输入 `GAT?GTT`，输出 3（存在三种原始串满足条件）。

---

1. **算法分类选择**  
**线性DP**

---

2. **综合分析与结论**  
**核心思路**：  
- **状态设计**：`dp[i][a][b][c]` 表示处理到第 `i` 个字符时，最后一段的最后一个字符为 `a`，首字符为 `b`，倒数第二段首字符为 `c` 的方案数。  
- **转移条件**：  
  - 若新字符 `d` ≠ 当前段尾 `a`，则扩展当前段：`dp[i][d][b][c] += dp[i-1][a][b][c]`  
  - 若当前段尾 `a` = 倒数第二段首 `c`，可分割新段：`dp[i][d][d][b] += dp[i-1][a][b][c]`  
- **初始状态**：第一个字符的四种可能初始化。  
- **答案统计**：所有 `dp[n][a][b][a]` 的和（最后一段首尾相同）。

**可视化设计**：  
- **动画方案**：以网格展示 `dp[i][a][b][c]` 状态矩阵，高亮当前字符 `i` 和转移路径。  
- **复古风格**：  
  - **像素网格**：用 16 色绘制 DP 状态，每个格子表示一种状态组合。  
  - **音效**：状态转移时播放 8-bit 音效，成功分割时触发高音调。  
  - **自动演示**：按字符顺序逐步展开状态更新，支持暂停/步进。  

---

3. **题解清单 (≥4星)**  
- **pmt2018 (⭐⭐⭐⭐⭐)**：  
  - 清晰的状态定义与转移方程，代码结构简洁。  
  - 注释完整，初始化和答案统计处理巧妙。  
- **IamZZ (⭐⭐⭐⭐)**：  
  - 提供详细问题分析，代码变量命名清晰。  
  - 通过双重循环处理问号枚举，逻辑直观。  
- **DYYqwq (⭐⭐⭐⭐)**：  
  - 图解辅助理解状态转移，代码实现简洁高效。  

---

4. **代码粘贴与核心实现思想**  
**核心代码（pmt2018）**：  
```cpp
int dp[maxn][4][4][4]; // 状态定义
for (int i = 2; i <= n; i++) {
    for (int a = 0; a < 4; a++) { // 当前字符候选
        if (s[i] != '?' && s[i] != to[a]) continue;
        for (int b = 0; b < 4; b++) {
            for (int c = 0; c < 4; c++) {
                for (int la = 0; la < 4; la++) { // 前一段的最后一个字符
                    if (la != a) // 扩展当前段
                        add(dp[i][a][b][c], dp[i-1][la][b][c]);
                    if (la == c) // 分割新段
                        add(dp[i][a][a][b], dp[i-1][la][b][c]);
                }
            }
        }
    }
}
```

---

5. **同类型题与算法套路**  
- **通用模式**：多维度状态记录连续区间特征（如首尾字符）。  
- **类似题目**：  
  - LeetCode 139（单词拆分）  
  - CF 1327D（循环节计数）  

---

6. **推荐题目**  
- [P4170 涂色](https://www.luogu.com.cn/problem/P4170)  
- [P4302 字符串折叠](https://www.luogu.com.cn/problem/P4302)  
- [P4349 字符串](https://www.luogu.com.cn/problem/P4349)  

---

7. **个人心得摘录**  
- **pmt2018**：强调状态压缩与字符集大小的关系，避免误判时间复杂度。  
- **DYYqwq**：通过画图辅助理解状态转移，减少思维盲区。  

---

8. **可视化与算法演示**  
**动画实现伪代码**：  
```javascript
// Canvas 绘制状态网格
function drawDPGrid() {
    for (let a = 0; a < 4; a++) {
        for (let b = 0; b < 4; b++) {
            for (let c = 0; c < 4; c++) {
                // 根据 dp[i][a][b][c] 的值设置颜色深浅
                ctx.fillStyle = `hsl(${dpValue * 30}, 70%, 50%)`;
                ctx.fillRect(a * 20, b * 20 + c * 80, 18, 18);
            }
        }
    }
}
// 音效触发
function playSound(type) {
    if (type === 'merge') beep(440, 50);
    else if (type === 'split') beep(880, 50);
}
```

---

**最终结论**：通过四维动态规划精确跟踪分割状态，结合字符集小的特点实现高效计算，是线性DP在多条件约束下的经典应用。

---
处理用时：102.75秒
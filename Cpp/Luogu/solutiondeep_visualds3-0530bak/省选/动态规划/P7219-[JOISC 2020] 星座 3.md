# 题目信息

# [JOISC 2020] 星座 3

## 题目背景

> 蓝蓝的天空银河里       
有只小白船      
船上有棵桂花树      
白兔在游玩      
桨儿桨儿看不见      
船上也没帆        
飘呀飘呀飘向西天      
渡过那条银河水       
走向云彩国         
走过那个云彩国      
再向哪儿去         
在那遥远的地方        
闪着金光         
晨星是灯塔          
照呀照得亮      
晨星是灯塔         
照呀照得亮 

**本题被卡空间的可以尝试使用 C++14 通过**

## 题目描述

JOI 君去拍照，拍了一张大小为 $N \times N$ 的图片，第 $i$ 列第 $j$ 行的格子称为格子 $(i,j)$。

图里有白色的小白船，黄色的星星（天知道为啥星星是黄色的），黑色的空格（天知道这空格是啥），第 $i$ 列自下往上数到第 $A_i$ 行的格子里都是小白船，另外有 $M$ 颗星星，第 $i$ 颗星星在格子 $(X_i,Y_i)$，除了小白船和星星，其他格子都是空格。

现在 JOI 君定义满足下面的一个矩阵为星座：

1. 不包含小白船
2. 至少包含 $2$ 颗星星

JOI 君已经看星座看了 114514 年了，他厌烦了，所以他要把图片中的一些星星涂黑变成黑色空格，涂黑第 $i$ 颗星星会让图片增加 $C_i$ 的不自然度。求不存在星座的最小不自然度。

## 说明/提示

#### 样例 1 解释

把第三颗星星涂黑即可。

#### 样例 2 解释

把第三颗和第四颗星星涂黑即可。

#### 子任务

|子任务|特殊性质|分数|
|:-:|:-:|:-:|
|$1$|$N,M \le 300$|$14$|
|$2$|$N,M \le 2000$|$21$|
|$3$|无|$65$|

对于 $100\%$ 的数据，$1 \le N,M \le 2 \times 10^5$，$1 \le A_i,X_i,Y_i \le N$，$1 \le C_i \le 10^9$，$A_{X_i}<Y_i$，没有相同位置的星星。

#### 说明

翻译自 [第１９回日本情報オリンピック　春季トレーニング合宿](https://www.ioi-jp.org/camp/2020/2020-sp-tasks/index.html) [Day3 A 星座3](https://www.ioi-jp.org/camp/2020/2020-sp-tasks/day3/constellation3.pdf)。

## 样例 #1

### 输入

```
5
1 3 4 2 3
3
1 5 3
4 3 2
2 4 2```

### 输出

```
2```

## 样例 #2

### 输入

```
7
5 6 2 3 6 7 6
5
7 7 5
3 3 7
3 7 10
1 7 6
4 7 8```

### 输出

```
16```

## 样例 #3

### 输入

```
8
6 8 5 7 3 4 2 1
10
8 2 9
6 6 7
8 3 18
5 8 17
8 5 3
5 5 3
5 4 8
1 8 13
1 7 5
7 4 13```

### 输出

```
44```

# AI分析结果



# 题目翻译

## [JOISC 2020] 星座 3

### 题目背景

> 蓝蓝的天空银河里  
有只小白船  
船上有棵桂花树  
白兔在游玩  
桨儿桨儿看不见  
船上也没帆  
飘呀飘呀飘向西天  
渡过那条银河水  
走向云彩国  
走过那个云彩国  
再向哪儿去  
在那遥远的地方  
闪着金光  
晨星是灯塔  
照呀照得亮  
晨星是灯塔  
照呀照得亮 

**本题被卡空间的可以尝试使用 C++14 通过**

### 题目描述

JOI 君拍摄了一张大小为 $N \times N$ 的图片，其中第 $i$ 列自下往上数到第 $A_i$ 行的格子都是白色的小白船。图片中还有 $M$ 颗黄色星星，第 $k$ 颗位于 $(X_k, Y_k)$ 格子（保证 $Y_k > A_{X_k}$）。其余格子为黑色空格。

定义一个"星座"为满足以下条件的矩阵区域：
1. 不包含任何小白船格子
2. 至少包含两个星星

JOI 君希望用最小总代价删除若干星星，使得图片中不再存在任何星座。删除第 $k$ 颗星星的代价为 $C_k$，求最小总代价。

### 输入输出格式

#### 输入格式
第一行输入 $N$  
第二行输入 $A_1,A_2,...,A_N$  
第三行输入 $M$  
接下来 $M$ 行每行三个整数 $X_k,Y_k,C_k$

#### 输出格式
输出一个整数表示最小总代价

### 样例解释

#### 样例1
输入：
```
5
1 3 4 2 3
3
1 5 3
4 3 2
2 4 2
```
输出：
```
2
```
解释：删除第三个星星即可消除所有可能星座

### 数据范围
- $1 \le N,M \le 2 \times 10^5$
- $1 \le C_k \le 10^9$
- 所有星星位置不重复

---

## 算法分类
**无算法分类**  
（核心解法涉及贪心策略、区间维护、笛卡尔树等综合技巧）

---

## 综合分析与结论

### 核心思路与难点
1. **问题转化**：将星座消除转化为图论中的最大权独立集问题，即选择保留的星星需满足两两之间被白色区域分隔。
2. **贪心策略**：按纵坐标升序处理星星，动态维护每个位置下方区域的决策代价，通过树状数组进行区间更新。
3. **区间维护**：使用并查集维护当前行的连续可用区间，快速计算每个星星的影响范围。
4. **反悔机制**：当保留当前星星时，通过树状数组记录"反悔值"（当前选择比下方区域更优的差额），实现动态调整。

### 可视化设计思路
1. **网格绘制**：用 Canvas 绘制 $N \times N$ 网格，白色区域用浅蓝色填充，星星用黄色圆点表示。
2. **动态扫描**：自底向上逐行扫描，高亮当前处理的星星及其影响区间（红色矩形框）。
3. **数据结构展示**：侧边栏同步显示树状数组的更新过程，用柱状图表示每个位置的累计代价。
4. **音效反馈**：
   - 删除星星时播放"碎裂"音效（8-bit 短促音）
   - 区间更新时播放"滴答"提示音
   - 最优解达成时播放经典 FC 过关音效

---

## 题解清单（≥4★）

### 1. awapwq233（4.5★）
**亮点**：  
- 利用并查集维护横向连通区间  
- 树状数组实现动态区间加值  
- 代码简洁（83ms 最优解）  
**核心代码**：
```cpp
for(int i=1; i<=n; i++) {
    for(auto b : s[i]) {
        ll v = qry(b.first);
        if(v >= b.second) ans += b.second;
        else {
            ans += v;
            add(l.find(b.first)+1, b.second-v);
            add(r.find(b.first), v-b.second);
        }
    }
    for(auto x : h[i]) // 合并区间
        l.fa[x]=x-1, r.fa[x]=x+1;
}
```

### 2. 冷月葬T魂（4.2★）
**亮点**：  
- 引入反悔贪心模型  
- 精确证明反悔操作的数学基础  
**关键步骤**：  
当保留当前星星时，树状数组记录差额 $c_i - \sum cost$，后续若其他星星需要覆盖此区域，差额会自动抵消历史决策。

### 3. Saliеri（4.0★）
**亮点**：  
- 笛卡尔树建模区间最值  
- 线段树合并维护 DP 状态  
**状态转移**：  
$$f_{u,h} = \max \begin{cases} 
\max_{h'\leq a_u}(f_{lson,h'} + f_{rson}) \\
\max_{h' > a_u}(f_{lson,h} + \max f_{rson})
\end{cases}$$

---

## 最优技巧提炼

### 区间影响维护
每个星星的影响范围是向上延伸的极大矩形。通过纵坐标升序处理，保证后续操作不会破坏已维护的区间结构。

### 反悔式更新
树状数组的区间加减操作实际上维护了"保留当前决策"与"采纳历史决策"之间的差额，当后续出现更优解时可自动修正。

### 并查集压缩路径
横向合并已处理区间时，并查集的路径压缩保证每个位置只需访问一次，时间复杂度严格 $O(\alpha(n))$。

---

## 相似题目推荐
1. [P1880 石子合并](https://www.luogu.com.cn/problem/P1880)  
   （区间 DP 与环形处理）
2. [P5490 扫描线](https://www.luogu.com.cn/problem/P5490)  
   （矩形面积并的线段树维护）
3. [P6246 线段](https://www.luogu.com.cn/problem/P6246)  
   （贪心选择不相交区间）

---

## 个人心得摘录
> "处理纵坐标升序是关键——这保证每个星星的决策不会影响到下方已处理的区域，从而将二维问题转化为一维区间维护" —— 冷月葬T魂

> "笛卡尔树的每个节点对应一个极大矩形区域，这种层次结构天然适合分治策略" —— Saliеri

---

## 可视化代码片段（Canvas动画）

```javascript
// 绘制星星和影响范围
function drawStar(ctx, x, y, color='yellow') {
    ctx.fillStyle = color;
    ctx.beginPath();
    ctx.arc(x*30+15, (n-y)*30+15, 5, 0, Math.PI*2);
    ctx.fill();
}

// 树状数组更新动画
function animateBIT(pos, delta) {
    let bar = document.getElementById(`bit-${pos}`);
    bar.style.height = (parseInt(bar.style.height) + delta*0.1) + 'px';
    bar.style.backgroundColor = delta > 0 ? '#ff0000' : '#00ff00';
}
```

---

## 复古像素风格设计
- **调色板**：16色 FC 风格（宝蓝、明黄、草绿、亮红）
- **网格绘制**：30x30 像素格子，1px 黑色边框
- **音效**：  
  - 星星删除：NES 爆炸音效（时长 0.3s）  
  - 区间合并：经典金币收集音  
  - 错误操作：FC 战斗失败音

---
处理用时：96.15秒
# 题目信息

# 狩猎（2021 CoE-II D）

## 题目描述

母狮 $\text{Dina}$ 的领地里有固定的 $n$ 个狩猎点，第 $i$ 个狩猎点有 $p_i$ 的概率可以捕捉到猎物，$\text{Dina}$ 的巢穴和 $n$ 个狩猎点相互之间存在若干条直接连接的双向道路。

每天早晨，$\text{Dina}$ 从她的巢穴出发，随机选择一个与巢穴相邻的狩猎点 $u$ 进行一次捕猎，如果她未捕捉到猎物，她会随机选择一个与当前狩猎点 $u$ 相邻的其他狩猎点 $v$ 继续进行一次捕猎，如果在狩猎点 $v$ 仍未捕捉到猎物，$\text{Dina}$ 会按照前述过程继续捕猎。如果在某个狩猎点捕捉到了猎物，$\text{Dina}$ 会立即返回巢穴，结束捕猎。若当前狩猎点 $u$ 与巢穴相邻，而与其他狩猎点不相邻，$\text{Dina}$ 也会选择立即返回巢穴，然后从与巢穴相邻的狩猎点中，随机选择一个狩猎点继续上述捕猎过程。$\text{Dina}$ 在每个狩猎点只进行一次捕猎，然后离开，但后续可能还会回到该狩猎点再次进行捕猎。在本题环境下，如果地点 $u$ 和地点 $v$ 之间有一条直接连接的双向道路，称地点 $u$ 和地点 $v$ **相邻**，否则称地点 $u$ 和地点 $v$ **不相邻**。

令巢穴的编号为 $0$，$n$ 个狩猎点的编号从 $1$ 到 $n$，$\text{Dina}$ 从编号为 $u$ 的地点到达另外一个编号为 $v$ 的地点需要消耗 $h_{u,v}$ 体力和 $t_{u,v}$ 时间。在第 $i$ 个狩猎点每进行一次捕猎，$\text{Dina}$ 会消耗 $h_i$ 体力和 $t_i$ 时间。每当 $\text{Dina}$ 到达某个狩猎点并进行一次捕猎后，她会评估自己的体力消耗和时间花费，如果体力消耗已经达到（或超过）限值 $H$，她就选择立即返回巢穴结束捕猎。如果时间花费已经达到（或超过）限值 $T$，她也会选择立即返回巢穴结束捕猎。$\text{Dina}$ 只有在到达狩猎点并进行一次捕猎后才进行评估，在任何其他时刻均不会进行评估。如果当前位于巢穴，她会在到达巢穴时就进行评估，因为巢穴并无猎物可供捕捉。

需要注意，$\text{Dina}$ 在沿着两个地点间的双向道路移动的过程中并不会评估，因此可能会出现以下情形：到达某个狩猎点且尚未进行捕猎时，$\text{Dina}$ 已消耗的体力或者已花费的时间已经超过限值。在这种情形下，$\text{Dina}$ 仍然会进行一次捕猎，之后再进行评估。

当 $\text{Dina}$ 因为捕猎成功、体力消耗或时间花费达到（或超过）相应限值、当前狩猎点与其他狩猎点不相邻而返回巢穴时，她总会选择一条具有最少时间花费的路径。如果存在多条具有最少时间花费的路径返回巢穴，她会选择其中体力消耗最少的路径。$\text{Dina}$ 在返回巢穴的过程中不会进行捕猎。

将 $\text{Dina}$ 从巢穴出发，因满足以下三个条件之一：

- 捕猎成功
- 体力消耗达到（或超过）限值 $H$
- 时间花费达到（或超过）限值 $T$

返回到达巢穴并结束捕猎的过程称为一次狩猎。给出巢穴和狩猎点之间的道路、每条道路所需要消耗的体力和花费的时间、每个狩猎点进行一次捕猎能够捕获猎物的概率以及所需消耗的体力、花费的时间，试确定 $\text{Dina}$ 完成一次狩猎所消耗体力和花费时间的平均值。

## 说明/提示

**子任务测试采用捆绑方式计分。**

**样例说明**

输入 #1

![](https://cdn.luogu.com.cn/upload/image_hosting/62vbngdn.png)

该输入只包含一个狩猎点，从巢穴到狩猎点 $1$ 之间的道路需要消耗 $2$ 体力和 $3$ 时间，体力的限值为 $10$，时间的限值为 $20$，在狩猎点 $1$ 进行一次捕猎需要消耗 $1$ 体力和 $2$ 时间，在狩猎点 $1$ 捕获猎物的概率为 $1.00$，即一定会捕捉到猎物。容易知道，进行一次狩猎所消耗的体力和花费时间的平均值分别为 $5.0=(2+1+2) \times 100\%$ 和 $8.0=(3+2+3) \times 100\%$。

输入 #2

![](https://cdn.luogu.com.cn/upload/image_hosting/k4q1qkwr.png)

相较于第一组输入，新增了两个狩猎点，但只有狩猎点 $1$ 和狩猎点 $2$ 与巢穴有直接道路相连。三个狩猎点之间无直接道路相连，但狩猎点 $1$ 可以间接通过巢穴与狩猎点 $2$ 连通。从巢穴到狩猎点 $2$ 的道路需要消耗 $4$ 体力和 $5$ 时间，在狩猎点 $2$ 进行一次捕猎需要消耗 $2$ 体力和 $3$ 时间。在狩猎点 $1$ 捕获猎物的概率为 $1.00$，即一定会捕捉到猎物，因此 $\text{Dina}$ 会立即返回巢穴并结束狩猎。在狩猎点 $2$ 捕获猎物的概率为 $0.50$，即有 $50\%$ 的概率会捕捉到猎物，但由于狩猎点 $2$ 没有其他狩猎点与之直接连通，因此不管在狩猎点 $2$ 是否捕获到猎物，$\text{Dina}$ 都会选择立即返回巢穴，在返回巢穴时，已经消耗 $10$ 体力，根据题意，不管 $\text{Dina}$ 是否已经捕捉到了猎物，她都会结束狩猎。由于是随机选择，故在巢穴时选择狩猎点 $1$ 和 $2$ 进行狩猎的概率均为 $50\%$，根据计算可知，进行一次狩猎所消耗的体力和花费时间的平均值分别为 $7.5=(2+1+2) \times 50\%+(4+2+4) \times 50\%$ 和 $10.5=(3+2+3) \times 50\%+(5+3+5) \times 50\%$。

------------

**数据范围**

- Subtask $1$：$n=1$，$10$ 分。
- Subtask $2$：$1 \le n \le 20$，每个狩猎点和其他狩猎点均无直接道路相连，$20$ 分。
- Subtask $3$：无特殊限制，$70$ 分。

对于 $100\%$ 的数据，$1 \le n \le 200$，$1 \le h_i \le 10$，$1 \le t_i \le 10$，$0 \le p_i \le 1$，$1 \le m \le \text{min}(n (n+1) / 2$，$2000$)，$1 \le h_{u,v} \le 20$，$1 \le t_{u,v} \le 20$，$1 \le H \le 200$，$1 \le T \le 200$。

------------

**约定**

- 地点 $u$ 和地点 $v$ 之间至多有一条直接连接的双向道路，两个地点之间的直连双向道路不会重复给出。
- 忽略 $\text{Dina}$ 进行评估所需要的时间。
- 在输入中，表示概率 $p_i$ 的数值是一个具有两位小数的实数。

## 样例 #1

### 输入

```
1
1 2 1.00
1
0 1 2 3
10 20```

### 输出

```
5.0 8.0```

## 样例 #2

### 输入

```
3
1 2 1.00
2 3 0.50
3 4 0.70
2
0 1 2 3
0 2 4 5
10 20```

### 输出

```
7.5 10.5```

# AI分析结果



0. **题目翻译**

---

# 狩猎（2021 CoE-II D）

## 题目描述

母狮 $\text{Dina}$ 的领地里有固定的 $n$ 个狩猎点，第 $i$ 个狩猎点有 $p_i$ 的概率可以捕捉到猎物。$\text{Dina}$ 的巢穴（编号为 $0$）和 $n$ 个狩猎点（编号 $1$ 到 $n$）之间通过双向道路连接。

每日早晨，$\text{Dina}$ 从巢穴出发，按以下规则捕猎：
1. **初始移动**：随机选择与巢穴相邻的狩猎点 $u$ 进行捕猎
2. **捕猎判定**：若在 $u$ 未捕获猎物，则随机选择与 $u$ 相邻的其他狩猎点 $v$ 继续捕猎
3. **终止条件**：捕猎成功、体力消耗 $\geq H$ 或时间消耗 $\geq T$ 时立即返回巢穴
4. **返回路径**：选择耗时最短的路径返回，若多条路径耗时相同则选体力消耗最少的

每个狩猎点的捕猎消耗为 $h_i$ 体力和 $t_i$ 时间，道路移动消耗为 $h_{u,v}$ 体力和 $t_{u,v}$ 时间。求完成一次狩猎的**平均体力消耗**和**平均时间消耗**。

---

1. **唯一算法分类**  
**线性DP**（三维状态动态规划）

---

2. **综合分析与结论**

### 核心思路与难点
- **状态设计**：以三维状态 $(u, h, t)$ 表示当前所在节点、已消耗体力和时间
- **期望计算**：通过概率加权不同分支路径的期望值
- **路径预处理**：用 Dijkstra 算法预计算各节点到巢穴的最优返回路径
- **记忆化搜索**：避免重复计算相同状态的期望值

### 可视化设计要点
- **DP 矩阵更新动画**：以网格展示 $(h, t)$ 维度的状态转移，用颜色梯度表示不同节点的期望值
- **高亮转移路径**：用箭头标注从 $(u, h, t)$ 到 $(v, h', t')$ 的转移方向，红色箭头表示捕猎成功分支，蓝色表示失败分支
- **复古像素风格**：用 8-bit 像素块表示状态节点，绿色像素表示合法状态，红色表示超限状态
- **音效提示**：在状态更新时播放 "哔" 声，成功返回巢穴时播放上扬音效

---

3. **题解清单**  
**⭐️⭐️⭐️⭐️⭐️ [metaphysis 题解]**
- **亮点**：清晰的三维状态转移设计 + 记忆化剪枝优化
- **关键代码**：通过 `dfs(u, h, t)` 递归计算期望值，结合预处理的最短路径表
- **优化点**：优先队列预处理返回路径，时间复杂度 $O(N \cdot H \cdot T)$

---

4. **代码实现核心逻辑**

### 预处理最短路径（Dijkstra 变种）
```cpp
priority_queue<edge> q;
dH[0] = dT[0] = 0;
q.push(edge(0, 0, 0));
while (!q.empty()) {
    edge e1 = q.top(); q.pop();
    for (auto e2 : edges[e1.v]) {
        if (dT[e2.v] > dT[e1.v]+e2.t || 
           (dT[e2.v] == dT[e1.v]+e2.t && dH[e2.v] > dH[e1.v]+e2.h)) {
            dT[e2.v] = dT[e1.v] + e2.t;
            dH[e2.v] = dH[e1.v] + e2.h;
            q.push(edge(e2.v, dH[e2.v], dT[e2.v]));
        }
    }
}
```

### 记忆化搜索核心
```cpp
void dfs(int u, int h, int t) {
    if (visited[u][h][t]) return;
    visited[u][h][t] = 1;
    
    // 捕猎成功分支
    hp[u][h][t] += p[u] * (h + dH[u]);
    elapsed[u][h][t] += p[u] * (t + dT[u]);
    
    // 失败且未超限分支
    if (!neighbours[u]) {
        dfs(0, h + dH[u], t + dT[u]);
        hp[u][h][t] += (1-p[u]) * hp[0][h+dH[u]][t+dT[u]];
    } else {
        for (auto e : edges[u]) {
            dfs(e.v, h+e.h+hi[e.v], t+e.t+ti[e.v]);
            hp[u][h][t] += (1-p[u])/neighbours[u] * 
                          hp[e.v][h+e.h+hi[e.v]][t+e.t+ti[e.v]];
        }
    }
}
```

---

5. **同类问题与扩展**
- **期望 DP 通式**：CF148D Bag of mice（概率龙虎斗）
- **状态剪枝优化**：洛谷P1850 换教室（多维状态+期望计算）
- **路径预处理技巧**：AOJ 0189 Convenient Location（多源最短路径）

**推荐练习题**：  
1. 洛谷 P4316 绿豆蛙的归宿（期望DP）  
2. 洛谷 P1850 换教室（状态转移+概率）  
3. 洛谷 P1613 跑路（最短路预处理）  

---

6. **可视化实现伪代码**
```javascript
// 像素画布初始化
const canvas = new PixelCanvas(800, 600, 8); 
canvas.setPalette([
    [0,0,0], [255,0,0], [0,255,0], // 黑/红/绿
]);

// 状态更新动画
function animateDP(u, h, t) {
    canvas.clear();
    drawGrid(H, T); // 绘制 h-t 网格
    canvas.fillBlock(h, t, 2); // 红色标记当前状态
    for (auto e : edges[u]) {
        let [h2, t2] = [h+e.h, t+e.t];
        canvas.drawArrow(h,t, h2,t2, 1); // 绿色箭头
    }
    playSound('blip'); 
}
```

---
处理用时：88.88秒
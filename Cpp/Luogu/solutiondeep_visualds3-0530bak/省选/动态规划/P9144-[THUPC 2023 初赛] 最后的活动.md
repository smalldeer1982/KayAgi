# 题目信息

# [THUPC 2023 初赛] 最后的活动

## 题目背景

各位亲爱的《La Lumière: Scarlet Intense Flame》玩家：

感谢您一直给予《La Lumière: Scarlet Intense Flame》的支持与厚爱。我们非常遗憾地宣布，《La Lumière: Scarlet Intense Flame》将于 2023 年 3 月 5 日 16:00 停止运营服务。

停止运营相关时间表如下：

……

## 题目描述

元老级二次元手游《La Lumière: Scarlet Intense Flame》将于今年 3 月停止运营服务。作为这款游戏的忠实玩家，小 S 希望能在游戏的最后一次活动中刷到一个特殊的分数，以此为近十年来与这款游戏共度的难忘时光画上一个圆满的句号。

《La Lumière: Scarlet Intense Flame》中的每种活动都有其独特的规则，而最后一次活动是 Chase Festival。在 Chase Festival 中，玩家需要多次攻略每次随机生成的多层迷宫，每次退出迷宫时根据在迷宫中各层击杀怪物的评价独立结算本次随机迷宫的分数。每次挑战迷宫时的流程简化如下：

1. 选择挑战的随机迷宫的难度。小 S 是这款游戏的资深玩家，因此在本题中假定小 S 总是挑战最高难度的迷宫。最高难度的迷宫最深为 $N$ 层。确定难度后，从随机生成的迷宫的第 1 层开始挑战。

2. 进行第 $i$ 层的挑战。挑战第 $i$ 层时，小 S 有可能挑战失败，挑战成功并获得普通评价，或者挑战成功并获得高评价。如果小 S 选择保守的挑战策略，则有 $p_{i,0}$ 的概率挑战失败，有 $p_{i,1}$ 的概率挑战成功并获得普通评价，有 $p_{i,2}$ 的概率挑战成功并获得高评价；如果小 S 选择激进的挑战策略，则有 $q_{i,0}$ 的概率挑战失败，有 $q_{i,1}$  的概率挑战成功并获得普通评价，有 $q_{i, 2}$ 的概率挑战成功并获得高评价。
   
   - 获得普通评价时，在当前层获得 $s_{i,1}$ 的分数；获得高评价时，在当前层获得 $s_{i,2}$ 的分数。这部分获得的分数**不会直接加算**到玩家的总分数中，而是**在退出迷宫时结算**。如果挑战成功，且当前不是最后一层（$i<N$），则跳转到第 3 步，选择是否继续挑战；否则（$i=N$），退出迷宫并跳转到第 4 步进行结算。
   
   - 如果挑战失败，则强制退出迷宫，跳转到第 4 步。

3. 如果当前不是最后一层，玩家可以选择是否继续挑战下一层。如果选择继续，则返回第 2 步；否则退出当前迷宫，跳转到第 4 步进行结算。

4. 本次迷宫的分数结算：如果因为失败而强制退出，则当前层不获得任何奖励，且**本次迷宫中之前各层**累积的分数需要乘上惩罚系数 $c$（为了使最终分数为整数，游戏会对惩罚后的分数先求和再下取整）；除了强制退出之外，玩家主动退出或者通关迷宫后退出都可以获得全部尚未结算的分数。

小 S 想得到的目标分数是一个比较大的分数，因此小 S 需要先大量刷最高难度的迷宫，再在接近目标分数时根据当前剩余的分数选择相对稳定的策略，以确保活动结束时能恰好获得目标分数。小 S 不会编程，因此小 S 找到了你，希望你能帮忙计算当剩余分数在 $1$ 至 $M$ 分之间，仅按照上述的流程挑战迷宫，并采用最佳策略时，最终能够恰好达到目标分数的最大概率。

## 说明/提示

#### 子任务

对于 $100\%$ 的数据，保证 $1\le N\le 6$，$1\le M\le 10000$，$0\le c'\le 100$，$1\le s_{i,1}\le s_{i, 2}\le 10000$，$0\le u_{i, 0}, u_{i, 1}, u_{i, 2}, v_{i, 0}, v_{i, 1}, v_{i, 2}\le 10000$，$u_{i,1}+u_{i,2}\ge 1$，$v_{i,1}+v_{i,2}\ge 1$。

#### 提示

《La Lumière: Scarlet Intense Flame 2》将于 2023 年春暖花开的时节与大家相见！

#### 题目来源

来自 2023 清华大学学生程序设计竞赛暨高校邀请赛（THUPC2023）初赛。

题解等资源可在 <https://github.com/THUSAAC/THUPC2023-Pre> 查看。

## 样例 #1

### 输入

```
2 8 50
3 4 0 1 1 0 1 1
4 5 1 2 1 1 1 2
```

### 输出

```
0.125000000000000000 0.140625000000000000 0.515625000000000000 0.564453125000000000 0.135009765625000000 0.328369140625000000 0.548858642578125000 0.625278472900390625
```

## 样例 #2

### 输入

```
见附件中的 2.in```

### 输出

```
见附件中的 2.ans```

# AI分析结果



---

**题目重写**

# [THUPC 2023 初赛] 最后的活动

## 题目背景

各位亲爱的《La Lumière: Scarlet Intense Flame》玩家：

感谢您一直以来的支持与厚爱。我们遗憾地宣布，《La Lumière: Scarlet Intense Flame》将于 2023 年 3 月 5 日 16:00 停止运营。

……

## 题目描述

元老级二次元手游《La Lumière: Scarlet Intense Flame》将于今年 3 月停服。作为忠实玩家，小 S 希望在最后一次活动中刷到特定分数，为这段时光画上句号。

在 Chase Festival 活动中：

1. 选择最高难度迷宫（最深 $N$ 层），从第 1 层开始挑战。
2. 每层挑战可能失败、普通评价或高评价：
   - 保守策略：失败概率 $p_{i,0}$，普通 $p_{i,1}$，高评价 $p_{i,2}$
   - 激进策略：失败概率 $q_{i,0}$，普通 $q_{i,1}$，高评价 $q_{i,2}$
   - 普通/高评价分别获得 $s_{i,1}/s_{i,2}$ 分，**退出时结算**
3. 非最后一层可主动选择继续或退出
4. 结算规则：
   - 失败退出：当前层无奖励，之前总分乘惩罚系数 $c$ 后下取整
   - 其他退出：获得全部未结算分数

求剩余分数 $1$ 至 $M$ 分时，采用最优策略恰好达成的最大概率。

---

**算法分类**  
线性DP

---

**综合分析与结论**

### 核心思路与难点
1. **状态设计**  
   定义 $f[i]$ 表示恰好获得 $i$ 分的最大概率。初始 $f[0]=1$，递推时需考虑每层策略选择带来的分数变化。

2. **转移方程**  
   递归计算每层两种策略的期望概率，取最大值：
   ```math
   f[i] = \max_{\text{策略}} \left( \sum \text{分支概率} \times \text{对应分数概率} \right)
   ```
   具体通过 DFS 遍历每层选择，在失败/继续/退出间决策。

3. **自环处理**  
   当一轮迷宫得分 $0$ 时，转移方程出现 $f[i]$ 依赖自身。通过**二分初始值**迭代求解，利用概率系数 $\in [0,1)$ 的收敛性逐步逼近真实值。

4. **复杂度优化**  
   - 迷宫层数 $N \leq 6$，决策树规模 $O(2^N)$ 可接受
   - 分数范围 $M \leq 1e4$，结合二分迭代 $30$ 轮，总复杂度 $O(2^N M \log \epsilon^{-1})$

### 可视化设计
1. **像素化 DP 矩阵**  
   - 用 16 色像素风格绘制 $f[0..M]$ 数组，初始为灰色
   - 更新 $f[i]$ 时，对应格子闪烁黄色，数值渐变为绿色（概率高）或红色（低）

2. **音效系统**  
   - 每次二分迭代：播放 8-bit "blip" 音效
   - 找到更优解：上升音阶
   - 迭代结束：长音提示

3. **自动演示模式**  
   - 按分数升序自动播放更新过程
   - 支持暂停/加速，展示当前层决策树展开

---

**题解清单 (5星)**  

1. **Alex_Wei 题解** ⭐⭐⭐⭐⭐  
   **亮点**：  
   - 清晰定义 DFS 递归结构，自然表达分层决策  
   - 巧妙用二分破解自环依赖  
   - 代码简洁，利用 lambda 封装分数检查  

2. **Eraine 题解** ⭐⭐⭐⭐  
   **亮点**：  
   - 理论证明二分法的收敛性  
   - 通过误差分析解释迭代方向选择  

---

**最优思路提炼**  

1. **分层决策树+记忆化**  
   递归模拟每层选择，缓存中间结果避免重复计算。

2. **二分法破环**  
   将含自环的方程 $f[i] = g(f[i])$ 转化为求不动点问题，通过 30 次二分迭代达到 $1e-9$ 精度。

3. **策略择优**  
   在保守与激进策略间取概率最大值，体现动态规划的最优子结构。

---

**同类型题目推荐**  
1. [P1850 换教室](https://www.luogu.com.cn/problem/P1850) - 概率DP+期望计算  
2. [P6835 [CSP-S 2020] 函数调用](https://www.luogu.com.cn/problem/P6835) - 分层调用+拓扑处理  
3. [P4548 [CTSC2006] 歌唱王国](https://www.luogu.com.cn/problem/P4548) - 概率生成函数+KMP  

---

**代码核心实现**  
```cpp
double dfs(int pos, int acc, int aim) {
  if(pos > n) return 0;
  auto F = [&](int c) {return c > aim ? 0 : f[aim - c];};
  // 计算继续挑战或退出的最大概率
  double p1 = max(F(acc + s1[pos]), dfs(pos + 1, acc + s1[pos], aim));
  double p2 = max(F(acc + s2[pos]), dfs(pos + 1, acc + s2[pos], aim));
  // 两种策略的期望计算
  double u = u0[pos] * F(sc) + u1[pos] * p1 + u2[pos] * p2;
  double v = v0[pos] * F(sc) + v1[pos] * p1 + v2[pos] * p2;
  return max(u, v);
}
// 二分求 f[i]
for(int i = 1; i <= m; i++) {
  double l = 0, r = 1;
  for(int _ = 0; _ <= 30; _++) {
    double m = (l + r) / 2;
    f[i] = m;
    if(dfs(1, 0, i) < m) r = m;
    else l = m;
  }
  printf("%.9lf ", f[i]);
}
```

---

**可视化 JS 片段**  
```javascript
// 像素格子渲染
function drawDPGrid() {
  ctx.fillStyle = "#334";
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  for(let i = 0; i <= M; i++) {
    const color = interpolateColor(f[i]); // 根据概率值插值颜色
    ctx.fillStyle = color;
    ctx.fillRect((i % 50)*12, Math.floor(i/50)*12, 10, 10);
  }
}

// 音效触发
function playSound(type) {
  const freq = type === 'update' ? 440 + currentIter*10 : 880;
  osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
}
```

---

**个人心得**  
- **调试教训**：初始未考虑分数下取整，导致概率偏移  
- **顿悟点**：将迷宫挑战视为多阶段决策，每层独立计算策略  
- **优化技巧**：预处理概率归一化，避免重复除法运算

---
处理用时：99.00秒
# 题目信息

# 「Wdsr-2」白泽教育

## 题目背景

上白泽慧音在给雾之湖的妖精们讲课。

某天，慧音在上数学课时，提到了一种非常有趣的记号：**高德纳箭号表示法**。它可以用来描述非常巨大的数字。~~比如紫的年龄。~~

对于非负整数 $a, b$ 和正整数 $n$，高德纳箭号表示法的定义为：

$$a \uparrow^n b = \begin{cases}
1\ (b = 0) \\
a^b\ (n = 1\ \operatorname{and}\ b > 0) \\
a \uparrow^{n - 1} (a \uparrow^n (b - 1))\ (n > 1\ \operatorname{and}\ b > 0)
\end{cases}$$

一些简单的例子：

- $2 \uparrow 31 = 2^{31} = 2147483648$

- $2 \uparrow \uparrow 4 = 2^{2^{2^2}} = 2^{2^4} = 2^{16} = 65536$

注：
1. $a \uparrow b$ 与 $a \uparrow^1 b$ 相同；

2. $a \uparrow \uparrow b$ 与 $a \uparrow^2 b$ 相同；

3. 请注意幂运算的顺序。

## 题目描述

慧音希望琪露诺解决以下关于 $x$ 的方程：

$$a \uparrow^n x \equiv b \pmod p$$

其中，$a, n, b, p$ 为已知的常数，$x$ 为未知数。

琪露诺被高德纳箭号表示法搞得云里雾里的，但是她不想被头槌。你能帮帮她吗？

## 说明/提示

**本题开启捆绑测试。**

| Subtask | $n$ | $p$ | $T$ | 分值 | 时限 |
| :------: | :------: | :------: | :------: | :------: | :------: |
| $1$ | $n = 1$ | $2 \leq p \leq 10^9$ 且 $p$ 为质数 | $1 \leq T \leq 100$ | $15 \operatorname{pts}$ | $2.00 \operatorname{s}$ |
| $2$ | $n = 2$ | 无特殊限制 | $1 \leq T \leq 5 \times 10^3$ | $25 \operatorname{pts}$ | $1.00 \operatorname{s}$ |
| $3$ | $n = 3$ | 无特殊限制 | 无特殊限制 | $60 \operatorname{pts}$ | $2.00 \operatorname{s}$ |

对于 $100\%$ 的数据，$1 \leq a \leq 10^9$，$1 \leq n \leq 3$，$0 \leq b < p \leq 10^9$，$1 \leq T \leq 2 \times 10^4$。

## 样例 #1

### 输入

```
3
2 1 1 3
3 1 2 7
7 1 2 4```

### 输出

```
0
2
-1```

## 样例 #2

### 输入

```
3
2 2 4 7
3 2 4 6
5 2 1 3```

### 输出

```
2
-1
0```

## 样例 #3

### 输入

```
3
4 3 5 8
2 3 9 11
6 3 1 5```

### 输出

```
-1
3
0```

# AI分析结果



---

## **唯一算法分类**  
**数论与扩展欧拉定理应用**

---

## **综合分析与结论**  
### **核心思路**
题目要求解高德纳箭号表示法的模方程，需分情况处理不同箭头层数（n=1,2,3）：
1. **n=1**：转化为离散对数问题，直接使用大步小步算法（BSGS）。
2. **n=2**：幂塔结构，需递归应用扩展欧拉定理，预处理欧拉函数链，枚举可能的解。
3. **n=3**：高阶递归结构，结合特判和欧拉函数快速收敛特性，枚举有限解。

### **解决难点**
- **幂塔计算**：通过预处理欧拉函数链（φ(p), φ(φ(p)), ...），将幂塔模运算转化为递归调用。
- **扩展欧拉定理**：判断指数是否超过当前模数，决定是否加 φ(p)。
- **特判优化**：对 a=2 或小数值情况单独处理，避免无效计算。

### **可视化设计**
1. **BSGS算法**：动态分块显示哈希表构建与匹配过程，高亮当前搜索的块。
2. **欧拉函数链**：树状结构展示模数递减过程，颜色标记当前递归层级。
3. **递归计算箭头操作**：像素动画模拟箭号展开，音效提示递归终止或解找到。

---

## **题解清单（≥4星）**
1. **LightningUZ（5星）**  
   - 亮点：特判优化逻辑清晰，代码简洁，预处理欧拉函数高效。  
   - 代码片段：  
     ```cpp
     if (a == 2) { // 特判a=2的情况
         if (b == 4 % p) puts("2");
         else if (b == 65536 % p) puts("3");
         else if (b == ptower(a, 100, 1).x % p) puts("4");
         else puts("-1");
     }
     ```

2. **Leasier（4星）**  
   - 亮点：分Subtask详细讨论，递归结构体记录溢出标志。  
   - 核心代码：  
     ```cpp
     Node tetration(int a, int n, int index) {
         if (phi[index] == 1) return new_node(0, true);
         if (n == 0) return new_node(1, false);
         Node x = tetration(a, n - 1, index + 1);
         if (x.flag) x.val += phi[index + 1];
         return quick_pow(a, x.val, phi[index]);
     }
     ```

3. **_Fontainebleau_（4星）**  
   - 亮点：筛法预处理小范围欧拉函数，优化质因数分解。  
   - 代码片段：  
     ```cpp
     int getphi(int x) { // 分解质因数求phi
         int vl = x;
         for (int i = 1; i <= cnt && prime[i] * prime[i] <= x; i++)
             if (x % prime[i] == 0) {
                 vl -= vl / prime[i];
                 while (x % prime[i] == 0) x /= prime[i];
             }
         if (x > 1) vl -= vl / x;
         return vl;
     }
     ```

---

## **最优思路提炼**
1. **扩展欧拉定理递归应用**：预处理模数链，递归计算幂塔时动态判断是否加 φ(p)。
2. **特判边界条件**：针对 a=2 或小数值单独处理，避免复杂递归。
3. **枚举有限解**：利用欧拉函数快速收敛到1的特性，限制枚举范围。

---

## **同类题目推荐**
1. **P4139 上帝与集合的正确用法**（幂塔模运算）
2. **P3747 相逢是问候**（递归幂塔与扩展欧拉定理）
3. **P3846 [TJOI2007] 可爱的质数**（BSGS模板题）

---

## **个人心得摘录**
- **LightningUZ**：调试时发现模数2、4、6的特殊情况，需单独验证。
- **Leasier**：递归中维护溢出标志是正确处理扩展欧拉定理的关键。

---

## **可视化与算法演示**
### **动画设计**
1. **BSGS分块搜索**：
   - **Canvas网格**：将哈希表构建过程分块显示，绿色块表示已匹配，红色块表示当前搜索。
   - **音效**：匹配成功时播放上扬音效。

2. **欧拉函数链递归**：
   - **树状结构**：每个节点显示当前模数，边标记递归方向，递归终止时节点变灰。
   - **步进控制**：允许单步执行递归，观察模数递减过程。

3. **复古像素风格**：
   - **8位调色板**：使用经典FC颜色（绿、红、蓝）标记不同操作。
   - **音效**：递归调用时播放“滴”声，找到解时播放胜利音效。

### **代码片段（JS Canvas）**
```javascript
function drawBSGSGrid(ctx, blocks, matchIndex) {
    blocks.forEach((block, i) => {
        ctx.fillStyle = i === matchIndex ? '#FF0000' : '#00FF00';
        ctx.fillRect(i * 20, 0, 18, 18);
    });
}
```

---

## **总结**
通过结合扩展欧拉定理、预处理模数链和特判优化，本题解高效处理了高德纳箭号的模方程。可视化设计通过动态递归树和像素动画，直观展示了算法核心流程。

---
处理用时：82.58秒
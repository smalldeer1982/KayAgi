# 题目信息

# [ICPC 2014 WF] Maze Reduction

## 题目描述

Jay 经营着一个小型嘉年华，里面有各种游乐设施。不幸的是，最近发生的过山车事故、厕所的水灾以及小丑事件使得 Jay 的嘉年华在公众中声誉不佳。由于付费顾客减少和收入下降，他需要削减一些成本以维持经营。

嘉年华中最大的吸引点之一是一个大型且复杂的迷宫。它由各种圆形房间组成，这些房间通过狭窄、曲折的走廊连接。游客们喜欢在其中迷路并尝试绘制地图。Jay 注意到，有些房间可能实际上是相同的。如果是这样，他可以在不被人注意的情况下缩小迷宫的规模。

如果你被放置在房间 $A$ 或 $B$ 中（并且你知道迷宫的地图），仅通过探索迷宫无法判断你是从 $A$ 还是 $B$ 开始的，那么两个房间 $A$ 和 $B$ 就是实际上相同的。每个房间的走廊出口均匀分布，你不能在房间中做标记或留下任何东西（特别是，你无法判断你是否曾经访问过它）。房间的唯一识别特征是它们的出口数量。走廊也足够曲折，以至于彼此无法区分，但当你进入一个房间时，你知道你是从哪个走廊来的，因此可以通过它们在房间周围出现的顺序进行一些导航。

Jay 向嘉年华迷宫协会求助。那就是你！编写一个程序来确定迷宫中所有实际上相同的房间集合。

## 说明/提示

时间限制：2000 毫秒，内存限制：1048576 kB。

国际大学生程序设计竞赛（ACM-ICPC）世界总决赛 2014。

题面翻译由 ChatGPT-4o 提供。

## 样例 #1

### 输入

```
13
2 2 4
3 1 3 5
2 2 4
3 1 3 6
2 2 6
2 4 5
2 8 9
2 7 9
2 7 8
2 11 13
2 10 12
2 11 13
2 10 12
```

### 输出

```
2 4
5 6
7 8 9 10 11 12 13
```

## 样例 #2

### 输入

```
6
3 3 4 5
0
1 1
1 1
2 1 6
1 5
```

### 输出

```
none
```

# AI分析结果



---

### **算法分类**
- **图的结构哈希与同构判断**

---

### **题解思路与算法要点**
#### **核心思路**
1. **结构哈希递推**  
   - 定义三维哈希数组 `f[k][x][i]` 表示从房间 `x` 的第 `i` 条边出发，走 `k` 步后的哈希值。  
   - 初始时，`f[0][x][i]` 为房间 `x` 的出口数量（即每个入口的初始哈希值相同）。  
   - 通过递推公式生成哈希：  
     ```  
     f[k][x][i] = hash(f[k-1][y][j])  
     ```  
     其中 `y` 是 `x` 的第 `i` 条边指向的房间，`j` 是 `y` 到 `x` 的边编号，遍历顺序保证环形结构的信息被捕获。

2. **循环移位的最小表示法**  
   - 每个房间的哈希序列（所有入口的最终哈希值）需要统一为循环移位后字典序最小的排列，以消除起始边的影响。  
   - 例如，哈希序列 `[A,B,C]` 的循环移位可能有 `[B,C,A]` 或 `[C,A,B]`，最小表示法将其统一为字典序最小的形式。

3. **等价类判断**  
   - 若两个房间的最小表示哈希序列相同，则它们等价。  
   - 最终输出所有等价类集合。

#### **解决难点**
- **递归依赖问题**：房间的等价性依赖其邻居的等价性，通过动态规划递推解决。  
- **循环移位的统一表示**：最小表示法确保不同起点但结构相同的房间被正确分类。  
- **哈希冲突处理**：使用模运算和大质数乘法降低冲突概率。

---

### **题解评分（4.5星）**
- **思路清晰度**：⭐️⭐️⭐️⭐️  
  递推哈希与最小表示法的结合巧妙，但递推公式的推导需较强图论背景。  
- **代码可读性**：⭐️⭐️⭐️  
  变量命名简洁，但三维数组操作稍显复杂。  
- **算法优化**：⭐️⭐️⭐️⭐️⭐️  
  哈希递推与最小表示法的时间复杂度为 `O(n^3)`，适用于题目数据规模。  
- **实践可操作性**：⭐️⭐️⭐️⭐️  
  代码逻辑清晰，但需注意循环移位的实现细节。

---

### **最优思路与技巧提炼**
1. **动态哈希递推**  
   - 通过递推计算哈希，逐步捕获房间的全局结构信息。  
   - 每次迭代合并邻居的哈希值，确保最终哈希反映房间的拓扑结构。

2. **最小表示法**  
   - 将循环序列统一为字典序最小的形式，解决起点不固定的问题。  
   - 实现方式：复制序列到双倍长度，滑动窗口寻找最小起始点。

3. **哈希函数设计**  
   - 使用 `hash(a, b) = a * 19260817 + b` 确保不同结构的哈希值差异显著。

---

### **同类型题与算法套路**
- **通用解法**：  
  适用于需要判断图/树同构的问题，通过哈希递推或特征编码统一结构表示。  
- **类似题目**：  
  - P5043 【模板】树同构（哈希判断树结构等价）  
  - P3979 遥远的国度（树结构哈希与路径处理）  
  - CF763A Timofey and a tree（树的结构特征判断）

---

### **推荐洛谷题目**
1. **P5043 【模板】树同构**  
   - 哈希法判断树同构的模板题，需设计树的结构哈希。  
2. **P3979 遥远的国度**  
   - 树哈希与动态路径处理结合。  
3. **CF763A Timofey and a tree**  
   - 判断树是否存在根节点，使得子树颜色统一。

---

### **可视化与算法演示**
#### **动画设计**
1. **动态哈希递推**  
   - **颜色标记**：每个房间用不同颜色表示哈希值，随迭代次数 `k` 变化。  
   - **步进控制**：用户可调节 `k` 的值，观察哈希值如何从初始状态逐步传播。  
   - **高亮路径**：当前计算的边用闪烁箭头表示，显示哈希值的合并过程。

2. **最小表示法生成**  
   - **循环序列展开**：将房间的哈希序列复制为双倍长度，滑动窗口高亮当前比较位置。  
   - **字典序比较**：用红色框标记最小起始点，绿色框标记当前候选位置。

3. **像素风格与音效**  
   - **8位像素房间**：每个房间显示为像素方块，颜色表示哈希值的不同。  
   - **音效触发**：  
     - 哈希更新时播放短促的“滴”声。  
     - 等价类形成时播放上扬音效。  
   - **自动演示模式**：AI自动执行递推步骤，用户可暂停观察哈希传播路径。

#### **交互设计**  
- **控制面板**：  
  - 滑动条调节递推步数 `k`。  
  - 按钮切换自动/手动模式。  
- **Canvas 绘制**：  
  - 房间以网格布局显示，边用像素线条连接。  
  - 当前活跃的边和哈希值用高亮色标记。

---

### **代码核心片段**
```cpp
// 哈希递推核心逻辑
for (int k = 1; k <= n; k++) {
    for (int x = 1; x <= n; x++) {
        for (int i = 1; i <= cnt[x]; i++) {
            int y = to[x][i];
            for (int j = id[y][x]; j <= cnt[y]; j++) {
                f[k][x][i] = hash(f[k][x][i], f[k - 1][y][j]);
            }
            for (int j = 1; j < id[y][x]; j++) {
                f[k][x][i] = hash(f[k][x][i], f[k - 1][y][j]);
            }
        }
    }
}

// 最小表示法生成
void calc_mnsw(Mod* s, Mod* res, int slen) {
    for (int i = 1; i <= slen; i++) {
        tmp[i] = tmp[i + slen] = s[i];
    }
    int resp = 1;
    for (int i = 1, j, k; i <= slen;) {
        for (j = i, k = i + 1; k <= (slen << 1) && tmp[j] <= tmp[k]; k++) {
            j = (tmp[j] == tmp[k] ? j + 1 : i);
        }
        while (i <= j) {
            i += k - j;
            resp = (i <= slen ? i : resp);
        }
    }
    for (int i = 1; i <= slen; i++) {
        res[i] = tmp[resp + i - 1];
    }
}
```

---

### **总结**
通过动态哈希递推与最小表示法的结合，高效解决了迷宫房间的等价类判断问题。该思路可扩展至其他图或树的结构等价性问题，哈希函数设计与递推逻辑是关键创新点。

---
处理用时：85.92秒
# 题目信息

# [CSP-S 2022] 星战

## 题目描述

在这一轮的星际战争中，我方在宇宙中建立了 $n$ 个据点，以 $m$ 个单向虫洞连接。我们把终点为据点 $u$ 的所有虫洞归为据点 $u$ 的虫洞。

战火纷飞之中这些虫洞很难长久存在，敌人的打击随时可能到来。这些打击中的有效打击可以分为两类：

1. 敌人会摧毁某个虫洞，这会使它连接的两个据点无法再通过这个虫洞直接到达，但这样的打击无法摧毁它连接的两个据点。
2. 敌人会摧毁某个据点，由于虫洞的主要技术集中在出口处，这会导致该据点的所有还未被摧毁的虫洞被一同摧毁。而从这个据点出发的虫洞则**不会摧毁**。

注意：摧毁只会导致虫洞不可用，而不会消除它的存在。

为了抗击敌人并维护各部队和各据点之间的联系，我方发展出了两种特种部队负责修复虫洞：

- A 型特种部队则可以将某个特定的虫洞修复。
- B 型特种部队可以将某据点的所有损坏的虫洞修复。

考虑到敌人打击的特点，我方并未在据点上储备过多的战略物资。因此只要这个据点的某一条虫洞被修复，处于可用状态，那么这个据点也是可用的。

我方掌握了一种苛刻的空间特性，利用这一特性我方战舰可以沿着虫洞瞬移到敌方阵营，实现精确打击。

为了把握发动反攻的最佳时机，指挥部必须关注战场上的所有变化，为了寻找一个能够进行反攻的时刻。总指挥认为：

- 如果从我方的任何据点出发，在选择了合适的路线的前提下，可以进行无限次的虫洞穿梭（可以多次经过同一据点或同一虫洞），那么这个据点就可以**实现反击**。
- 为了使虫洞穿梭的过程连续，尽量减少战舰在据点切换虫洞时的质能损耗，当且仅当**只有一个从该据点出发的虫洞可用**时，这个据点可以**实现连续穿梭**。
- 如果我方所有据点都可以**实现反击**，也都可以**实现连续穿梭**，那么这个时刻就是一个绝佳的**反攻**时刻。

总司令为你下达命令，要求你根据战场上实时反馈的信息，迅速告诉他当前的时刻是否能够进行一次**反攻**。

## 说明/提示

**【样例解释 \#1】**

虫洞状态可以参考下面的图片, 图中的边表示存在且未被摧毁的虫洞：

![](https://cdn.luogu.com.cn/upload/image_hosting/giqzyc7r.png)

**【样例 \#2】**

见附件中的 `galaxy/galaxy2.in` 与 `galaxy/galaxy2.ans`。

**【样例 \#3】**

见附件中的 `galaxy/galaxy3.in` 与 `galaxy/galaxy3.ans`。

**【样例 \#4】**

见附件中的 `galaxy/galaxy4.in` 与 `galaxy/galaxy4.ans`。

**【数据范围】**

对于所有数据保证：$1 \le n \le 5 \times {10}^5$，$1 \le m \le 5 \times {10}^5$，$1 \le q \le 5 \times {10}^5$。

| 测试点 | $n \le$ | $m \le$ | $q \le$ | 特殊限制 |
| :-----------: | :-----------: | :-----------: | :-----------: | :-----------: |
| $1 \sim 3$ | $10$ | $20$ | $50$ | 无 |
| $4 \sim 8$ | ${10}^3$ | ${10}^4$ | ${10}^3$ | 无 |
| $9 \sim 10$ | $5 \times {10}^5$ | $5 \times {10}^5$ | $5 \times {10}^5$ | 保证没有 $t = 2$ 和 $t = 4$ 的情况 |
| $11 \sim 12$ | $5 \times {10}^5$ | $5 \times {10}^5$ | $5 \times {10}^5$ | 保证没有 $t = 4$ 的情况 |
| $13 \sim 16$ | ${10}^5$ | $5 \times {10}^5$ | $5 \times {10}^5$ | 无 |
| $17 \sim 20$ | $5 \times {10}^5$ | $5\times 10^5$ | $5 \times {10}^5$ | 无 |

## 样例 #1

### 输入

```
3 6
2 3
2 1
1 2
1 3
3 1
3 2
11
1 3 2
1 2 3
1 1 3
1 1 2
3 1 3
3 3 2
2 3
1 3 1
3 1 3
4 2
1 3 2
```

### 输出

```
NO
NO
YES
NO
YES
NO
NO
NO
YES
NO
NO
```

# AI分析结果



**唯一算法分类**：哈希（随机权值）

---

### **题解思路与解决难点**

1. **核心思路**  
   所有题解均利用**随机权值哈希**将“每个点出度为1”转化为哈希值匹配问题：
   - **关键变量**：为每个节点随机权值，维护当前所有激活边的起点权值和（`sum`）与目标值（所有节点权值和）。
   - **操作处理**：通过动态调整每个点的入边权值和（`cur[v]`），实现 O(1) 复杂度处理操作（如批量删除/恢复入边）。

2. **解决难点**  
   - **操作2/4的高效处理**：直接维护出度不可行，但通过预处理每个点的初始入边权值和（`full[v]`），批量操作转化为重置 `cur[v]` 的值。
   - **哈希冲突避免**：随机权值极大降低冲突概率，确保“总和相等”与“出度全为1”的充要性。

---

### **最优思路提炼**

**哈希转换法**  
- **数据结构**：每个点 `v` 维护其当前入边的权值和 `cur[v]` 和初始值 `full[v]`。
- **操作实现**：
  - **单边修改**：直接增减 `cur[v]` 和全局 `sum`。
  - **批量修改**：`sum` 减去 `cur[v]` 后重置 `cur[v]`（操作2）或恢复为 `full[v]`（操作4）。
- **验证条件**：`sum == 目标值`（所有节点权值和）。

---

### **题解评分（≥4星）**

1. **dbxxx（⭐⭐⭐⭐⭐）**  
   - **亮点**：完整解释哈希正确性，代码简洁高效，附样例分析与复杂度证明。
   - **代码**：使用 `std::mt19937` 生成权值，维护总和与目标值对比。

2. **Cxny（⭐⭐⭐⭐）**  
   - **亮点**：提出异或哈希优化，结合奇偶性判断，代码更短。
   - **代码**：维护异或和 `nw` 与总和 `tot` 双重验证。

3. **xfrvq（⭐⭐⭐⭐）**  
   - **亮点**：直接维护入边权值和，代码极简，逻辑清晰。
   - **代码**：仅需 30 行，高效处理所有操作。

---

### **可视化算法演示**

**核心动画设计**  
1. **像素网格表示**：每个节点显示为像素块，颜色深浅表示当前出度状态（绿色=1，红色≠1）。
2. **权值变化动画**：操作触发时，对应边的起点权值以粒子效果飞入/飞出目标节点的 `cur[v]` 区域。
3. **全局哈希值对比**：顶部进度条显示当前 `sum` 与目标值，匹配时播放胜利音效（8-bit风格）。
4. **自动演示模式**：AI模拟随机操作，展示哈希值的动态调整过程。

**复古交互元素**  
- **音效**：操作成功（↑音调）、失败（↓音调）、权值变化（短“滴”声）。
- **积分系统**：连续正确判断得分，错误扣分，增强游戏化体验。

---

### **代码片段（dbxxx题解核心）**

```cpp
mt19937 rng(time(0));
int val[N], full[N], cur[N], sum, target;

// 初始化
for (int i=1; i<=n; i++) {
    val[i] = rng(); 
    target += val[i];
}
for (每条边u->v) {
    full[v] += val[u];
    cur[v] += val[u];
    sum += val[u];
}

// 处理操作
void handle_op(int t, int u, int v=0) {
    if (t == 1) sum -= val[u], cur[v] -= val[u];
    else if (t == 2) sum -= cur[u], cur[u] = 0;
    else if (t == 3) sum += val[u], cur[v] += val[u];
    else sum += full[u] - cur[u], cur[u] = full[u];
    cout << (sum == target ? "YES" : "NO");
}
```

---

### **相似题目推荐**

1. [P1972 - HH的项链](https://www.luogu.com.cn/problem/P1972)（区间颜色统计，哈希+前缀和）
2. [P3834 - 可持久化线段树](https://www.luogu.com.cn/problem/P3834)（动态维护集合特征）
3. [P3369 - 普通平衡树](https://www.luogu.com.cn/problem/P3369)（哈希优化查询）

---

### **个人心得摘录**

> “哈希的思维难度高于暴力，但实现更简洁。考场上需跳出维护出度的直觉，通过数学性质转换问题。” —— dbxxx

---

### **总结**

通过哈希将动态维护问题转化为数学等式验证，是处理大规模图操作的高效方法。结合游戏化可视化，可直观展示算法核心逻辑与实时状态变化。

---
处理用时：68.05秒
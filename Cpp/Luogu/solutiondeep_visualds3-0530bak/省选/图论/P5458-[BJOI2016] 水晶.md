# 题目信息

# [BJOI2016] 水晶

## 题目背景

不用惊慌，今天的题都不是小强出的。  

——融入了无数心血的作品，现在却不得不亲手毁掉，难以体会他的心情啊。

——那也是没有办法的事情，能量共振不消除的话…… 

望着已经被装上炸药的水晶，02放下了望远镜，看向了手中的共振分析报告。  

还是会有一些水晶，幸存下来的…… 也许吧。

## 题目描述

地图由密铺的六边形单元组成，每个单元与其他六个单元相邻。  

为了方便起见，我们用坐标 $(x,y,z)$ 描述一个单元的位置，表示从原点开始按如图所示的 $x,y,z$ 方向各走若干步之后到达的地方。  

有可能有两个坐标描述同一个单元，比如 $(1,1,1)$ 和 $(0,0,0)$ 描述的都是原点。

![](https://cdn.luogu.com.cn/upload/image_hosting/dd1hb5vv.png)

显然 $(x,y,z)$ 单元和 $(x+1,y,z)$，$(x-1,y,z)$ ，$(x,y+1,z)$，$(x,y-1,z)$，$(x,y,z+1)$，$(x,y,z-1)$ 相邻。  

有 $N$ 块水晶位于地图的单元内，第 $i$ 块水晶位于坐标 $(x_i, y_i, z_i)$ 所表示的单元中，并拥有 $c_i$ 的价值，每个单元内部可能会有多块水晶。  

地图中，有一些单元安装有能量源。如下图，任何满足 $x+y+z$ 是 $3$ 的整数倍的坐标所描述的单元内都安装有能量源。  

![](https://cdn.luogu.com.cn/upload/image_hosting/9x4o6dhs.png)

有能量源的单元中的水晶价值将会额外增加 $10\%$。如果三块水晶所在的单元满足特定排列，那么它们将会引发共振。 

共振分两种，$a$ 共振和 $b$ 共振。  

$a$ 共振：如果三块水晶所在的单元两两相邻地排成一个三角形，那么会引起 $a$ 共振。   

![](https://cdn.luogu.com.cn/upload/image_hosting/48uc3ey4.png)

图中每一个三角形表示这三个单元各有一块水晶将会发生一个 $a$ 共振。  

$b$ 共振：如果三块水晶所在的单元依次相邻地排成一条长度为 $2$ 的直线段，且正中间的单元恰好有能量源，那么会引起b共振。  

![](https://cdn.luogu.com.cn/upload/image_hosting/2b47zl09.png)

图中粉红色线段表示这三个单元各有一块水晶将会发生一个 $b$ 共振，黑色线段表示即使这三个单元有水晶也不会发生 $b$ 共振。  

现在你要炸掉一部分水晶，使得任何共振都不会发生的前提下，剩余水晶的价值总和最大。

## 说明/提示

【样例 $1$ 说明】   

四块水晶排成一个菱形，没有 $b$ 共振，有 $2$ 处 $a$ 共振，分别是 $1,2,4$ 号水晶和 $1,3,4$ 号水晶形成的三角形。 
因此，为了消除两处 $a$ 共振，有如下 $3$ 种方案：

1. 炸掉 $1$ 号水晶，留下 $2,3,4$ 号水晶，总剩余价值 $5+7+13=25$
2. 炸掉 $4$ 号水晶，留下 $1,2,3$ 号水晶，总剩余价值 $11 \times(1+10\%)+5+7=24.1$   
3. 炸掉 $2,3$ 号水晶，留下$1,4$ 号水晶，总剩余价值 $11 \times (1+10\%)+13=25.1$  

因此我们采用第三种方案，最大总剩余价值为$25.1$。    

【数据范围】  

$1\le N \le 50000$    
$1\le c_i \le 1000$   
$-1000 \le x_i,y_i,z_i \le 1000$   

## 样例 #1

### 输入

```
4
0 0 0 11
1 0 0 5
0 1 0 7
0 0 -1 13```

### 输出

```
25.1```

# AI分析结果



## 算法分类
网络流 - 最小割

---

## 题解分析与结论

### 核心思路与算法要点
1. **坐标转换**：将三维坐标转换为二维 $(x-z, y-z)$ 解决坐标重复问题
2. **能量源分类**：根据 $(x+y+z)\%3$ 将点分为三类（能量源、黑白节点）
3. **最小割建模**：
   - 每个节点拆分为入点/出点，边权为水晶价值
   - 能量源作为中间节点建立无限容量的连接边
   - 源点连接黑节点，汇点连接白节点，形成共振路径约束

### 解决难点对比
| 题解差异点          | disangan233                         | CaoXian                          |
|-------------------|-------------------------------------|----------------------------------|
| **拆点方式**        | 将节点拆为入点/出点，直接连接源汇       | 按模3值划分三类节点建立链式连接      |
| **共振处理**        | 枚举所有相邻能量源建立连接边           | 自动推导共振路径约束               |
| **浮点处理**        | 保留浮点运算                          | 全部转换为整数运算                  |
| **数据结构**        | 使用map处理坐标合并                   | 哈希表+结构体存储节点信息            |

---

## 最优题解推荐 (≥4⭐)

### 1. disangan233（⭐⭐⭐⭐⭐）
- **亮点**：清晰的map坐标处理，完整的浮点精度控制
- **核心代码**：
```cpp
void link(int a,int b,int c) {
    add_edge(S,a<<1,inf); add_edge(a<<1|1,b<<1,inf);
    add_edge(b<<1|1,c<<1,inf); add_edge(c<<1|1,T,inf);
}
```
- **思路**：将三类节点形成链式连接，通过INF边强制共振路径

### 2. Kketchup（⭐⭐⭐⭐）
- **亮点**：复古像素风可视化方案，音效提示关键操作
- **创新点**：使用Canvas绘制六边形网格，8位音效提示割边操作

### 3. TYxxj（⭐⭐⭐⭐）
- **亮点**：黑白染色理论推导，精细处理相邻关系
- **技巧**：将能量源六边形作为中间节点，建立双向约束

---

## 关键代码实现
disangan233 核心拆点逻辑：
```cpp
for(auto &p : points) {
    int mod = (p.x + p.y) % 3;
    if(mod == 0) { // 能量源
        add_edge(in[p.id], out[p.id], p.value * 1.1); 
        for(auto &neighbor : adj[p.id]) {
            if(neighbor.mod == 1) add_edge(out[p.id], in[neighbor.id], INF);
            if(neighbor.mod == 2) add_edge(out[neighbor.id], in[p.id], INF);
        }
    } else {
        add_edge(in[p.id], out[p.id], p.value);
    }
}
```

---

## 可视化设计

### 像素风动画方案
1. **网格绘制**：
   ```javascript
   const HEX_RADIUS = 20;
   function drawHex(ctx, x, y) {
       ctx.beginPath();
       for(let i=0; i<6; i++) {
           const angle = i * Math.PI/3;
           ctx.lineTo(x + HEX_RADIUS*Math.cos(angle), 
                      y + HEX_RADIUS*Math.sin(angle));
       }
       ctx.strokeStyle = '#8B8B83';
       ctx.stroke();
   }
   ```
2. **状态高亮**：
   - 红色闪烁：当前被割断的节点
   - 蓝色流动：网络流中的活跃路径
   - 绿色边框：能量源节点

3. **音效设计**：
   ```javascript
   const cutSound = new Audio('data:audio/wav;base64,UklGRl9...');
   function playCutEffect() {
       cutSound.currentTime = 0;
       cutSound.play();
   }
   ```

---

## 相似题目推荐
1. P2774 方格取数问题（网络流最小割经典）
2. P3358 最长k可重区间集（链式网络流建模）
3. P4001 [ICPC-Beijing 2006]狼抓兔子（平面图最小割）

---

## 个人心得摘录
> "调试时发现浮点精度丢失导致WA，改用全整数运算后AC。关键点在于将价值乘以10存储，最终输出时再除以10" —— CaoXian

> "坐标合并逻辑容易出错，必须确保(x-z,y-z)的唯一性。使用map前先规范化坐标是关键" —— disangan233

---

## 算法演示示例
**步骤演示**：
1. 初始化六边形网格，三类节点着色（黑/红/白）
2. 显示所有可能共振三角形（黄色高亮）
3. 动态绘制网络流边（蓝色线条表示INF边）
4. 红色闪烁显示被割断的节点
5. 实时更新剩余总价值显示

**交互控制**：
- 速度滑块：调节算法执行速度
- 暂停/继续：观察中间状态
- 单步执行：查看每步割边选择

---
处理用时：59.13秒
# 题目信息

# 【化学】实验

## 题目背景

小 Z 紧张地坐在了一张化学实验桌前，进行着化学实验。

教室里又传来了一阵哀叹声：

我…我好像又错了…我能再试一次吗?

## 题目描述

在她的面前，摆放着 $n$ 个试管。试管里装着不明液体。对于每种不明液体，有 $2$ 个已知的化学属性：$a$ 和 $b$。第 $i$ 种液体的两个属性值分别为 $a_i$ 和 $b_i$。

现在，老师给她布置了 $m$ 个实验。

对于每一次实验，有一个参照量 $x$（第 $i$ 次实验的参照量记作 $x_i$）。她需要把不明液体分成尽可能多的组，且满足：任意两种不同组的液体$i$和$j$， $\operatorname{gcsd(a_i,a_j)}$ 都不能大于 $x^2$。

其中 $\operatorname{gcsd}$ 代表他们的最大公约平方数。$k$是两个数的公约平方数，当且仅当满足以下两个条件：

- $k$ 为这两个数的公约数；

- $k$ 为完全平方数。

而最大公约平方数 $\operatorname{gcsd}$ 为所有满足条件的 $k$ 中的最大者。

形象的说， $\operatorname{gcsd}$ 可以理解成两个数的最大公约数的算术平方根的整数因式部分的平方。

例如：

求 $\operatorname{gcsd(24,64)}$，就是先求出 $24,64$ 的最大公约数，是 $8$ ，然后 $\sqrt 8=2\sqrt 2$，其整数因式是 $2$，所以 $\operatorname{gcsd(24,64)}=2^2=4$。

她还需要在分组数最多的情况下，使自己的实验得分最大。

实验得分的定义：对于每一种试剂，定义其得分 $c_i$ 为 $b_i$ 分解质因数之后最大的**指数**。

例如：$b_i=12=2^2\times 3^1$，$c_i=\max\{2,1\}=2$。

$b_i=90=2^1\times 3^2\times 5^1$，$c_i=\max\{1,2,1\}=2$。

而实验得分即为所有组内的 $c_i$ 的最大值之和。

当然，她的 $IQ$ 并不高，所以需要请求你的帮助。

## 说明/提示

#### 样例解释 #1

$b_1=2=2^1,c_1=1$。

$b_2=4=2^2,c_2=2$。

$b_3=6=2^1\times 3^1,c_3=\max\{1,1\}=1$。

$b_4=8=2^3,c_4=3$。

$b_5=10=2^1\times 5^1,c_5=\max\{1,1\}=1$。

当 $x=2$ 时，可分为三组：$\{1,2,4\},\{3\},\{5\}$。

实验得分为$\max\{1,2,3\}+\max\{1\}+\max\{1\}=5$。

----------

#### 数据范围

**「本题采用捆绑测试」**

| subtask | $n\le$ | $m\le$ | $a_i \le$ | $b_i\le$ | $x \le$ | 分值 |
| :-----------: | :-----------: | :-----------: | :-----------: | :-----------: | :-----------: |:-----------:|
| $1$ | $4$ | $6$ | $100$ | $4 \times 10^4$ | $100$ | $5$ |
| $2$ | $8$ | $7$ | $20$ | $10^3$ | $10$ | $5$ |
| $3$ |$20$ | $30$ | $50$ | $8 \times 10^3$ | $100$ | $10$ |
| $4$ |$100$ | $60$ | $100$ | $4 \times 10^4$ | $10^3$ | $10$ |
| $5$ |$5 \times 10^3$ | $110$ |  $10^3$| $10^5$ | $4 \times 10^3$ | $10$ |
| $6$ |$2 \times 10^4$ | $250$ | $3 \times 10^3$ | $10^6$ | $3 \times 10^3$ | $10$ |
| $7$ |$ 5 \times 10^4$| $10^3$ | $10^4$ | $2 \times 10^7$ | $1.5 \times 10^4$ | $15$ |
| $8$ |$10^5$  | $8 \times 10^3$ | $2 \times 10^4$ | $2 \times 10^7$ | $2.2 \times 10^4$ | $15$ |
| $9$ |$2 \times 10^5$  | $2 \times 10^5$ | $4 \times 10^4$ | $2 \times 10^7$ | $3 \times 10^4$ | $20$ |


对于 $100\%$ 的数据：

$1 \le n,m \le 2\times 10^5$，$2 \le a_i \le 4\times 10^4$，$2 \le b_i \le 2\times 10^7$，$2 \le x \le 3\times 10^4$。

我$\dots$我好像又错了$\dots$我能再试一次吗?

## 样例 #1

### 输入

```
5 5
36 72 4 9 16
2 4 6 8 10
2 3 4 5 6
```

### 输出

```
3 5
4 7
4 7
4 7
5 8```

# AI分析结果



---

## 算法分类  
**数论与并查集**

---

## 综合分析与结论  
### 核心思路  
1. **问题转化**：将 `gcsd` 转化为 `gcd(h(a_i), h(a_j)) ≤ x`，其中 `h(a_i)` 为 `a_i` 的最大平方因子算术平方根。  
2. **图论模型**：将液体视为节点，`gcd(h(a_i), h(a_j)) > x` 时连边，求最大连通块数量。  
3. **预处理优化**：  
   - 线性筛预处理 `h(a_i)` 和 `c_i`（最大质因数指数）。  
   - 逆序处理查询，动态维护并查集以减少重复计算。  
4. **动态合并**：从大 `x` 到小 `x` 合并，每次将 `h(a_i)` 的倍数合并，维护连通块数量及得分。  

### 解决难点  
1. **高效计算 `h(a_i)` 和 `c_i`**：通过线性筛在 `O(n)` 时间预处理，避免分解质因数的重复计算。  
2. **多查询优化**：逆序处理 `x`，利用并查集的合并操作逐步减少连通块数，实现 `O(α(n))` 复杂度。  
3. **内存优化**：通过共用 `char` 类型存储 `st` 和 `sm`，降低空间占用。  

### 可视化设计  
1. **并查集合并动画**：  
   - **像素网格**：每个节点表示为像素块，颜色表示所属连通块。  
   - **高亮操作**：合并时用闪烁边框标记当前操作的 `h(a_i)` 和其倍数。  
   - **动态统计**：右侧面板实时显示连通块数和得分。  
2. **复古音效**：  
   - 合并时播放短促的「哔」声，得分更新时播放上扬音效。  
3. **自动演示模式**：  
   - 逐步增加 `x`，展示合并过程，支持暂停/步进观察细节。  

---

## 题解清单 (≥4星)  
### 1. 鏡音リン (⭐⭐⭐⭐⭐)  
**关键亮点**：  
- 线性筛预处理 `h(a_i)` 和 `c_i`，时间复杂度最优。  
- 逆序并查集合并，完美适配多查询场景。  
- 代码精简，内存优化到位。  

### 2. Singulet31258 (⭐⭐⭐⭐)  
**关键亮点**：  
- 详细推导 `gcsd` 的数学性质，理论分析透彻。  
- 提供暴力与线性筛双解法，适合不同数据规模。  

---

## 核心代码实现  
### 鏡音リン的预处理与合并逻辑  
```cpp  
// 线性筛预处理 h(a_i) 和 c_i  
void prime() {  
    for (int i = 2; i < M; i++) {  
        if (!s[i]) {  
            pr.push_back(i);  
            s[i] = i;  
            st[i] = 1;  
            if (i < L) h[i] = 1;  
        }  
        for (int j : pr) {  
            if (i*j >= M) break;  
            s[i*j] = j;  
            st[i*j] = (s[i] == j) ? st[i]+1 : 1;  
            if (i*j < L) h[i*j] = (s[i] == j && st[i] & 1) ? h[i]*j : h[i];  
            if (i % j == 0) break;  
        }  
    }  
    // 计算 sm（即 c_i）  
    for (int i = 2; i < M; i++) {  
        for (int j : pr) {  
            if (i*j >= M) break;  
            st[i*j] = std::max(st[i], st[i*j]);  
            if (i % j == 0) break;  
        }  
    }  
}  

// 动态合并并查集  
for (int i = R-1; i >= 2; i--) {  
    ans[i] = co[i] + cnt;  
    bool mg = false;  
    f[i] = i; p[i] = mv[i];  
    cnt = cnt + (pair) {1, mv[i]};  
    for (int j = 2; i*j < R; j++) if (mv[i*j]) {  
        int x = fa(i), y = fa(i*j);  
        if (x != y) {  
            mg = true;  
            f[x] = y;  
            cnt.x--;  
            cnt.y -= std::min(p[x], p[y]);  
            p[y] = std::max(p[x], p[y]);  
        }  
    }  
}  
```  

---

## 相似题目推荐  
1. **P1495 曹冲养猪**（中国剩余定理 + 合并条件）  
2. **P1525 关押罪犯**（并查集 + 分组约束）  
3. **P2421 部落划分**（图论连通块 + 动态合并）  

---

## 个人心得摘录  
> "线性筛的内存优化是关键，用 `char` 代替 `int` 节省了 75% 空间。逆序处理查询时需注意 `h(a_i)` 的倍数合并顺序，否则会重复计算得分。" —— 鏡音リン  

---

## 可视化算法演示（复古像素风格）  
### 实现要点  
1. **Canvas 绘制**：  
   - 每个液体表示为 16x16 像素块，颜色哈希其 `h(a_i)` 值。  
   - 合并时绘制动态连线，颜色渐变表示权值 `gcd`。  
2. **音效触发**：  
   - 合并时播放 `8-bit` 合成音效，不同 `x` 对应不同音调。  
3. **自动演示逻辑**：  
   ```javascript  
   function autoRun(x) {  
       let timer = setInterval(() => {  
           if (x <= 0) clearInterval(timer);  
           mergeGroups(x);  
           x--;  
       }, 500); // 控制速度  
   }  
   ```  
4. **交互面板**：  
   - 滑动条调节 `x`，按钮控制暂停/继续/重置。

---
处理用时：67.94秒
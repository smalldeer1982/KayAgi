# 题目信息

# [SDOI2013] 方程

## 题目描述

给定方程
$x_1+x_2+\dots +x_{n}=m$。

我们对第 $1 \sim n_1$ 个变量进行一些限制： $x_{1} \le a_{1},x_{2} \le a_{2},\dots, x_{n_1} \le a_{n_1}$。

我们对第 $n_1+1\sim n_1+n_2$ 个变量进行一些限制： $x_{n_1+1} \ge a_{n_1+1},x_{n_1+2} \ge a_{n_1+2},\dots,x_{n1+n2} \ge a_{n_1+n_2}$。

求：在满足这些限制的前提下，该方程正整数解的个数。答案可能很大，请输出对 $p$ 取模后的答案。

## 说明/提示

**【样例解释】**

对于第一组数据，三组解为 $(1,3,2)，(1,4,1),(2,3,1) $。  
对于第二组数据，六组解为 $(1,1,3),(1,2,2),(1,3,1),(2,1,2),(2,2,1),(3,1,1)$。

![](https://cdn.luogu.com.cn/upload/pic/17621.png)

对于 $100\%$ 的数据，$1\le T \le 5$，$1\le m, n \le 10^9$，$1 \le a_i \le m$，$0 \le n_1,n_2 \le \min(8, m)$ 且 $n_1 + n_2 \le n$，$1\le p \le 437367875$。

## 样例 #1

### 输入

```
3 10007
3 1 1 6
3 3
3 0 0 5

3 1 1 3
3 3
```

### 输出

```
3
6
0
```

# AI分析结果



### 算法分类
组合数学、容斥原理、扩展卢卡斯定理

---

### 题解思路与核心难点解析
**核心思路**：  
1. **处理下界限制**：将每个变量 $x_i \geq a_i$ 转换为 $x_i' = x_i - (a_i-1) \geq 1$，调整总资源 $m$ 为 $m' = m - \sum (a_i-1)$。  
2. **处理上界限制**：通过容斥原理，枚举哪些变量违反上界 $x_i \leq a_i$，视为新下界 $x_i \geq a_i+1$，计算对应组合数并加减。  
3. **组合数计算**：使用扩展卢卡斯定理处理模数非质数的情况，分解 $p$ 为质因数幂，分别计算后合并结果。

**解决难点**：  
- **容斥的符号控制**：根据违反条件的变量数量确定加减符号。  
- **扩展卢卡斯的优化**：预处理阶乘、分解模数 $p$ 的质因数减少重复计算。

---

### 题解评分（≥4星）
1. **kkksx（5星）**  
   - **亮点**：代码结构清晰，预处理模数质因数分解，二进制枚举容斥子集。  
   - **优化**：提前分解模数，避免重复计算质因数。

2. **gyh20（4.5星）**  
   - **亮点**：递归实现容斥，记忆化处理阶乘提升效率。  
   - **心得**：通过分解模数类型打表加速，适合固定模数场景。

3. **RootMirzayanov（4星）**  
   - **亮点**：代码简洁，预处理阶乘避免重复计算。  
   - **技巧**：直接处理模数分解后的质因数，减少运行时计算。

---

### 最优思路与技巧提炼
1. **容斥与下界转换**：  
   - 将下界限制转化为资源调整，上界限制通过容斥转为反向下界。  
   - 二进制枚举子集实现容斥，时间复杂度 $O(2^{n_1})$，适用于 $n_1 \leq 8$。

2. **扩展卢卡斯优化**：  
   - **阶乘预处理**：对每个质因数幂预先计算不含该质因数的阶乘。  
   - **质因数分解提前处理**：针对固定模数提前分解，避免重复计算。

```cpp
// 核心代码片段：扩展卢卡斯计算组合数
ll exLucas(ll n, ll m, ll p) {
    ll res = 0, pk;
    for (ll pi : primes) { // 分解后的质因数列表
        pk = power(pi, cnt[pi]); // 质因数pi的幂
        ll c = C(n, m, pi, pk);  // 计算C(n,m) mod pk
        res = (res + crt(c, pk)) % p; // 中国剩余定理合并
    }
    return res;
}
```

---

### 相似题目推荐
1. **P2181 礼物**  
   - 组合数模非质数，需扩展卢卡斯定理。

2. **P4766 [CERC2014] Outer space invaders**  
   - 容斥与区间动态规划结合。

3. **P3793 由乃与大母神原型和偶像崇拜**  
   - 复杂约束下的组合计数，需分治优化。

---

### 可视化与算法演示
**动画设计**：  
1. **像素风格界面**：  
   - 使用 8-bit 风格网格表示变量限制，红色块代表上界，绿色块代表下界。  
   - 当前操作的子集变量闪烁显示，右侧面板实时更新剩余资源 $m'$。

2. **扩展卢卡斯分解过程**：  
   - **分解质因数**：显示模数 $p$ 分解为 $p_1^{k_1}p_2^{k_2}...$，每个质因数用不同颜色高亮。  
   - **阶乘计算**：递归树展示阶乘分解步骤，标记去除质因子的位置。

3. **音效与交互**：  
   - **操作音效**：枚举子集时播放短促“点击”声，计算完成时播放成功音效。  
   - **自动模式**：点击“AI Run”自动演示所有容斥情况，速度可调。

---

**示例代码（扩展卢卡斯预处理）**  
```javascript
// 质因数分解预处理
function preprocessMod(p) {
    primes = [];
    for (let i = 2; i * i <= p; i++) {
        if (p % i === 0) {
            let pk = 1;
            while (p % i === 0) { pk *= i; p /= i; }
            primes.push({ pi: i, pk: pk });
        }
    }
    if (p > 1) primes.push({ pi: p, pk: p });
}
```

---

### 总结与个人心得
**关键教训**：  
- **调试扩展卢卡斯**：注意阶乘计算时排除质因子的倍数，递归终止条件易错。  
- **容斥符号处理**：奇数次违反需减去，偶数次需加上，符号反转容易遗漏。

**心得摘录**：  
> “扩展卢卡斯的常数优化至关重要，预处理质因数和阶乘模块可大幅提升性能。” —— kkksx

> “二进制枚举容斥比DFS更直观，但需注意子集生成顺序。” —— gyh20

---
处理用时：118.57秒
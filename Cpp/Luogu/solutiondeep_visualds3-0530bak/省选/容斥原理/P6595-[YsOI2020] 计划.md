# 题目信息

# [YsOI2020] 计划

## 题目背景

相信大家已经知道了这样几个事实：  
- Ysuperman 是很有钱。

- Ysuperman 一直都很善于制定计划。

- Ysuperman 管理着一个幼儿园。

- Ysuperman 收藏了一些零食。

- 每一天，TA 可能会心血来潮地想要有计划地吃掉 TA 的零食。


## 题目描述

Ysuperman 现在有 $n$ 份零食，对**每份**零食而言，TA 每一天有 $P$ 的概率对 TA 的这份零食做出计划，TA 每做出一份计划后的 $T$ 天后，TA 将会将这一份零食给吃掉。需要特殊说明的是，如果在Ysuperman制定计划前已经对该份零食做出计划，则实际会按照**第一份计划的时间**将零食吃掉。

不幸的是，幼儿园内贪吃的小朋友会破坏这一计划。  幼儿园内有 $m$ 个小朋友，TA 们觊觎着 Ysuperman 的零食。对于**每份**零食，每天会有 $p_i$ 的概率被第 $i$ 个小朋友偷吃。如果这份零食在某位小朋友偷吃之前被吃掉了，那么相应地，这位小朋友就偷吃不了。**如果有一份零食在计划完成前被偷吃，那么，相关计划就无法实现了。**

现在 Ysuperman 要对 TA 的计划进行风险评估，TA 悬赏了 $114514pts$ ，这个项目在经过层层转包后来到了您的手上，现在已经算出了各概率在模意义下的值。经过各方协商，您如果解决了这个问题，您可以获得 $ 100pts $ 。您需要告诉 TA **Ysuperman 能期望吃掉多少份零食，以及 Ysuperman 的零食期望在多少天后被吃完** 。

**如果一份零食被某位小朋友吃掉了，那么这份零食就不属于Ysuperman了。**

需要注意的是，Ysuperman每天制定计划的时间在小朋友偷吃糖果**之前**。

Ysuperman 认为浮点数的精度误差太大，所以你只需要输出答案**对 $998244353$ 取模**的结果。

## 说明/提示

### 样例说明

#### 样例说明 $1$:

在取模前的其中一种可能情况为：
```cpp
5 8 11  
0.1  
0.1 0.2 0.3 0.4 0.5 0.6 0.7 1
```
该情况下，小朋友会在第一天中偷吃完所有的零食。

#### 样例说明 $2$:

在取模前的一种可能情况为：
```cpp
3 5 0  
1  
1 1 1 1 1
```

该情况下，Ysuperman 会在第一天计划并吃完所有的零食。

#### 样例说明 $3$:

在取模前的一种可能的情况为：

```cpp
2 2 0  
0.5  
0.5 0.5
```
在此情况下，答案为 $\dfrac{8}{7}$ 和 $\dfrac{80}{63}$。

由于解答过程较为复杂，所以请聪明的读者自行思考。


------------
### 数据范围

**如果您只答对了某个测试点两问中的任意一问，您可以获得这个测试点 $ 25\% $ 的分数。**

以下是致敬 $\text{NOI}$ 的部分分表格：
| 测试点编号 | $n$ | $m$ | $T$ | $P$ | 特殊性质 |
| :-----------: | -----------: | -----------: | -----------: | -----------: | :-----------: |
| 1 | $=1$ | $=1$ | $=0$ | 无其它约束 | 无 |
| 2 | $=1$ | $=10$ | $=1$ | $=1$ | $1$ |
| 3 | $=1$ | $\le100$ | $=227$ | $=1$ | $2$ |
| 4 | $\le 20$ | $\le 1000$ | $=4$ | 无其它约束 | 无 |
| 5 | $\le 100$ | $\le 1000$ | $=4$ | 无其它约束 | 无 |
| 6 | $\le 1000$ | $\le 1000$ | $=227$ | $=0$ | $1$ |
| 7 | $\le 100000$ | $\le 100000$ | $=233$ | $=1$ | $2$ |
| 8 | $\le1919820$ | $=114514$ | $=2333$ | $=0$ | $2$ |
| 9 | $\le1919820$ | $=114514$ | $=2333$ | $=0$ | $2$ |
| 10 | $=100000$ | $=100000$ | $=3$ | 无其它约束 | $2$ |
| 11 | $=114514$ | $=114514$ | $=3$ | 无其它约束 | 无 |
| 12 | $\le1919820$ | $=114514$ | $=0$ | 无其它约束 | $2$ |
| 13 | $\le 1919820$ | $=1$ | $\le 227$ | 无其它约束 | 无 |
| 14 | $\le 1919820$ | $\le114514$ | $\le 227$ | 无其它约束 | $2$ |
| 15 | $\le 1919820$ | $=1$ | $\le 500$ | $=1$ | 无 |
| 16 | $\le 1919820$ | $\le 114514$ | $\le 500$ | $=1$ | 无 |
| 17 | $\le 1919820$ | $\le 114514$ | $\le 500$ | $=1$ | 无 |
| 18 | $\le 1919820$ | $\le 114514$ | $=0$ | 无其它约束 | 无 |
| 19 | $\le 1919820$ | $\le 114514$ | $=0$ | 无其它约束 | 无 |
| 20 | $\le 100000$ | $\le 100000$ | $\le 500$ | 无其它约束 | $2$ |
| 21 | $\le 100000$ | $\le 100000$ | $\le 500$ | 无其它约束 | 无 |
| 22 | $\le 100000$ | $\le 100000$ | $\le 500$ | 无其它约束 | 无 |
| 23 | $\le 1919820$ | $\le 114514$ | $\le 2333$ | 无其它约束 | 无 |
| 24 | $\le 1919820$ | $\le 114514$ | $\le 2333$ | 无其它约束 | 无 |
| 25 | $\le 1919820$ | $\le 114514$ | $\le 2333$ | 无其它约束 | $2$ |

对于 $100\%$ 的数据，满足 $ 1\le n\le 1919820,1\le m \le 114514,0\le T \le 2333,0\le P< 998244353,1\le p_i<998244353$


特殊性质 $1$：存在一个 $i$ 使得$p_i=1$。

特殊性质 $2$：所有的 $p_i$ 都相等。

## 样例 #1

### 输入

```
5 8 11
13482572 
299473306 598946612 898419918 199648871 499122177 798595483 99824436 1```

### 输出

```
0 1```

## 样例 #2

### 输入

```
3 5 0
1
1 1 1 1 1```

### 输出

```
3 1```

## 样例 #3

### 输入

```
2 2 0
499122177
499122177 499122177```

### 输出

```
855638018 507044752```

## 样例 #4

### 输入

```
11 4 514
1919810
1919810 1919810 1919810 1919810```

### 输出

```
550831570 75142974```

## 样例 #5

### 输入

```
100000 20 227
2020
2000 2001 2002 2003 2004 2005 2006 2007 2008 2009 2010 2011 2012 2013 2014 2015 2016 2017 2018 2019```

### 输出

```
808786679 861511854```

# AI分析结果



---

### 唯一算法分类  
概率与期望、生成函数、min-max容斥  

---

### 题解思路与难点对比  
#### 核心逻辑  
1. **零食存活模型**：每份零食每天有概率 $r = \prod (1-p_i)$ 不被偷吃，前 $T$ 天仅考虑偷吃，$T+1$ 天后同时考虑 Ysuperman 的计划（概率 $P$）和偷吃。  
2. **第一问**：计算每个零食在存活 $T$ 天后被 Ysuperman 吃掉的概率，最终期望为 $n \cdot \frac{r^T P}{(1 - (1-P)r)}$。  
3. **第二问**：使用 min-max 容斥，将最大时间期望转为子集的最小时间期望的加权和，利用生成函数处理无穷时间求和。  

#### 难点与关键点  
- **时间分段处理**：前 $T$ 天与后续时间需分开计算概率，涉及不同条件下的存活率。  
- **无穷级数求和**：利用等比数列公式化简 $\sum_{i=0}^\infty q^i$ 为 $\frac{1}{1-q}$，处理模意义下的分母逆元。  
- **组合数优化**：预处理阶乘与逆元，快速计算 $\binom{n}{k}$，应对 $n \leq 2 \times 10^6$ 的大数据。  

#### 题解对比  
- **lmAKf**：直接推导答案表达式，代码简洁但推导跳跃，需结合注释理解。  
- **Iratis**：分步详细推导，明确分段求和与 min-max 应用，适合数学验证。  
- **clamee**：代码结构复杂，部分推导可能存在边界问题，但提供了组合数优化的实现。  

---

### 题解评分（≥4星）  
1. **lmAKf（★★★★☆）**  
   - 思路清晰，代码高效，但缺乏详细推导注释。  
   - 亮点：快速处理组合数与无穷级数，模运算优化到位。  
2. **Iratis（★★★★★）**  
   - 分步数学推导严谨，适合理解概率模型，代码稍冗长但逻辑明确。  
   - 个人心得：“观察到零食独立，分开处理”点明关键。  

---

### 最优思路提炼  
1. **存活概率压缩**：将多天偷吃合并为单日存活概率 $r$，减少计算维度。  
2. **时间分段生成函数**：前 $T$ 天和后续时间分别用生成函数求和，避免无限循环。  
3. **min-max 容斥转化**：将最大期望转为子集加权和，利用对称性简化计算。  

---

### 类似题目与算法  
- **概率模型**：[CF235B Let's Play Osu!](https://www.luogu.com.cn/problem/CF235B)  
- **min-max 容斥**：[LOJ6354 最差记者 3](https://loj.ac/p/6354)  
- **模意义期望**：[ABC279Ex Sum of Prod](https://atcoder.jp/contests/abc279/tasks/abc279_h)  

---

### 可视化设计  
1. **时间轴动画**：  
   - **前 T 天**：红色标记偷吃风险，绿色显示存活。  
   - **后续时间**：蓝色高亮 Ysuperman 计划触发，黄色表示成功吃掉。  
2. **像素风格**：  
   - **Canvas 网格**：每个零食为一行，时间轴横向滚动，存活为亮块，被吃为暗块。  
   - **音效**：计划触发时播放“叮”，被偷吃时播放“咔嚓”。  
3. **自动演示**：  
   - 调整 $P$ 和 $T$ 参数，观察期望值动态变化，结合控制面板调节速度。  

---

### 核心代码（lmAKf 题解）  
```cpp
int fpow(int x, int k) { // 快速幂
    int ans = 1, base = x;
    while (k) {
        if (k & 1) ans = ans * base % P;
        base = base * base % P, k >>= 1;
    } return ans;
}

int ans1 = n * fpow(q, T) % P * p % P * fpow(1 - u, P-2) % P; // 第一问核心

// Min-Max 容斥处理第二问
for (int k = 1; k <= n; ++k) {
    int rp = C(n, k) * ((k+1) & 1 ? -1 : 1);
    int tk = fpow(q, k), mS = fpow(tk, T);
    int S1 = (1 - fpow(tk, T+1)) * fpow(1 - tk, P-2) % P; // 前 T 天求和
    int S2 = mS * fpow(1 - fpow(u, k), P-2) % P; // 后续时间
    ans2 = (ans2 + (S1 + S2) * rp) % P;
}
```

---

### 个人心得  
- **边界处理**：当 $q=0$ 且 $T \neq 0$ 时，所有零食在前 $T$ 天必被偷吃，需特判。  
- **调试教训**：模运算中减法需显式转为正数，如 `(a - b + P) % P`。  

--- 

通过结合概率模型与组合数学，此题在模意义下的期望计算展现了数学推导与算法优化的精妙结合。

---
处理用时：142.59秒
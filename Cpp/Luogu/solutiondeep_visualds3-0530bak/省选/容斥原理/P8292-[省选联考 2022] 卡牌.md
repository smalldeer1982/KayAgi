# 题目信息

# [省选联考 2022] 卡牌

## 题目描述

小 A 有 $n$ 张卡牌，编号为 $1, 2, \ldots, n$。每张卡牌上写着一个正整数，第 $i$ 张卡牌上的正整数为 $s_i$。

现在有 $m$ 轮游戏，第 $i$ 轮游戏会给出 $c_i$ 个质数，小 A 需要选择任意多张卡牌，使得这些卡牌上面的正整数的乘积能被该轮游戏给出的每个质数整除。

这当然难不倒小 A，于是他开始思考一个更难的问题，对于每一轮游戏，他有多少种卡牌的选法。

这给小 A 整不会了，于是他只能来求助你，你只需要告诉他答案模 $998244353$ 的值即可。两种选法 A 和 B 互不相同当且仅当存在一张卡牌在 A 中被选择但在 B 中未被选择或者存在一张卡牌在 B 中被选择但在 A 中未被选择。注意：牌面上的数字相同但编号不相同的两张卡牌被视为不同的卡牌。

## 说明/提示

**【样例解释 #1】**

第一轮游戏：除了以下 $5$ 种方案外其它方案都可行：什么都不选、选 $2$、选 $5$、选 $46$、选 $2$ 和 $46$。所以答案为 $2^5 - 5 = 27$。

第二轮游戏：只要选了 $46$，其它卡牌选不选均可，所以答案为 $2^4 = 16$。

**【数据范围】**

对于 $100 \%$ 的数据，$1 \le n \le {10}^6$，$1 \le s_i \le 2000$，$1 \le m \le 1500$，$1 \le c_i, \sum_i c_i \le 18000$，$2 \le p_{i, j} \le 2000$。

| 测试点 | $n \le$ | $m \le$ | $\sum_i c_i \le$ | 其他限制 |
|:-:|:-:|:-:|:-:|:-:|
| $1 \sim 2$ | $10$ | $10$ | $20$ | $s_i \le 30$ |
| $3 \sim 5$ | $10$ | $20$ | $50$ | 无 |
| $6 \sim 8$ | ${10}^6$ | $1500$ | $10000$ | $s_i \le 30$ |
| $9 \sim 11$ | $10000$ | $1000$ | $5000$ | $s_i \le 500$ |
| $12 \sim 13$ | $1000$ | $100$ | $1000$ | 无 |
| $14 \sim 17$ | $5000$ | $600$ | $7000$ | 无 |
| $18 \sim 20$ | ${10}^6$ | $1500$ | $18000$ | 无 |

## 样例 #1

### 输入

```
5
10 2 10 5 46
4
2 2 5
2 2 23
1 3
1 23```

### 输出

```
27
16
0
16```

## 样例 #2

### 输入

```
见附件中的 card/card2.in```

### 输出

```
见附件中的 card/card2.ans```

# AI分析结果



### 算法分类  
**根号分治 + 状态压缩容斥**

---

### 题解思路与核心难点  
**核心思路**  
1. **质数根号分治**：将质数分为小质数（≤43）和大质数（>43），每个数至多有一个大质因子  
2. **状态压缩**：对小质数的包含情况用 13 位二进制压缩（2^13=8192 种状态）  
3. **容斥处理**：对每个询问，枚举未覆盖的小质数集合，计算对应的合法方案数  
4. **大质数独立处理**：对大质数要求至少选一个时，用乘法原理单独处理其贡献  

**解决难点**  
- **复杂度的平衡**：通过根号分治将指数复杂度限制在 2^13 的可接受范围  
- **动态预处理**：预处理每个质数在不同状态下的贡献（如 `f[i][j]` 表示质数i在状态j下的贡献）  
- **快速幂优化**：通过预计算 2 的幂次加速集合运算  

---

### 题解评分（≥4星）  
**1. lg_zhou（5星）**  
- 亮点：清晰的根号分治实现，预处理小质数状态后直接容斥  
- 关键代码：`f[i][j]` 预处理每个质数的状态贡献  

**2. Alex_Wei（5星）**  
- 亮点：引入 FWT 优化集合卷积，理论分析透彻  
- 核心代码：`f = FWT(IFWT(f) - IFWT(f/fwt_i))` 的巧妙变换  

**3. EnofTaiPeople（4星）**  
- 亮点：简洁的位运算实现，适合快速理解核心逻辑  
- 关键代码：`f[i][s] = (f[i][s] + f[i][s^(1<<j)]*(2^cnt-1))`  

---

### 最优思路提炼  
**关键技巧**  
1. **状态映射**：将质数集合映射到二进制位，如 `s |= 1<<(pid[p]-1)`  
2. **贡献分离**：将大质数的贡献预处理为 `2^cnt - 1` 的形式（必须选至少一个）  
3. **动态逆元**：预处理每个质数贡献的逆元，快速处理排除该质数的情况  

**思维突破点**  
- 发现大质数间的独立性，允许分治处理每个质数的乘法贡献  
- 利用容斥将「必须包含所有质数」转化为「排除未覆盖的子集」  

---

### 同类题目推荐  
1. [P2150 NOI2015 寿司晚宴](https://www.luogu.com.cn/problem/P2150)  
   - 相似点：质数分组+状态压缩  
2. [P3750 省选联考2017 分手是祝愿](https://www.luogu.com.cn/problem/P3750)  
   - 相似点：容斥与状态转移结合  
3. [P4221 省选联考2020 魔法商店](https://www.luogu.com.cn/problem/P4221)  
   - 相似点：集合运算的快速处理  

---

### 可视化设计（核心算法演示）  
**动画方案**  
1. **像素风格界面**：  
   - 小质数用 8x8 像素块表示颜色（如红色代表2，蓝色代表3）  
   - 大质数用闪烁的黄色方块表示  
   - 当前处理状态用绿色边框高亮  

2. **关键步骤演示**：  
   ```python
   # 伪代码逻辑
   for 质数p in 询问集合:
       绘制p对应的像素块
       if p是小质数:
           高亮状态位s的对应bit
       else:
           显示该质数对应的卡牌集合，并标记必须选至少一个
   ```
   
3. **音效设计**：  
   - 选中小质数时播放短促的「哔」声  
   - 处理大质数时播放上升音阶  
   - 容斥计算完成时播放胜利音效  

4. **交互控制**：  
   - 速度滑块调节状态转移速度  
   - 点击任意质数显示其贡献计算过程  

---

### 核心代码实现（lg_zhou 解法）  
```cpp
void init(){
    // 预处理每个数的质因子状态
    for(int i=2;i<=2000;i++){
        for(int j=1;j<=cnt;j++){ // cnt为质数总数
            if(i%p[j]==0){
                if(j <=13) q[i] |= (1<<j-1); // 小质数状态
                v[i].push_back(j); // 记录所有质因子
            }
        }
    }
}

void query_processing(){
    // 容斥主逻辑
    for(int j=0;j<(1<<13);j++){
        if((j|required)!=required) continue;
        int total = base_count[j];
        ll res = 1;
        for(auto p : big_primes){ // 处理大质数
            res = res * (pow2[f[j][p]] - 1) % mod;
            total -= f[j][p];
        }
        res = res * pow2[total] % mod; // 剩余自由选择
        ans += (popcount(j)%2 ? -1 : 1) * res; // 容斥系数
    }
}
```

---

### 总结  
本题通过**根号分治**将问题分解为可处理的规模，结合**状态压缩**和**容斥原理**高效计算方案数。其核心在于：  
1. 利用小质数数量少的特性进行状态压缩  
2. 利用大质数的独立性进行分组乘法处理  
3. 通过预处理优化重复计算  

可视化设计应重点展示质数分组与状态转移过程，帮助理解如何将指数复杂度问题转化为多项式可解的形式。

---
处理用时：103.80秒
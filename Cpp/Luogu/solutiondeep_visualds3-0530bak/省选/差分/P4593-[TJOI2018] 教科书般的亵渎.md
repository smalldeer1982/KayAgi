# 题目信息

# [TJOI2018] 教科书般的亵渎

## 题目描述

小豆喜欢玩游戏，现在他在玩一个游戏遇到这样的场面，每个怪的血量为 $a_i$，且每个怪物血量均不相同，小豆手里有无限张“亵渎”。亵渎的效果是对所有的怪造成 $1$ 点伤害，如果有怪死亡，则再次施放该法术。我们认为血量为 $0$ 怪物死亡。

小豆使用一张“亵渎”会获得一定的分数，分数计算如下，在使用一张“亵渎”之后，每一个被亵渎造成伤害的怪会产生 $x^k$，其中 $x$ 是造成伤害前怪的血量为 $x$ 和需要杀死所有怪物所需的“亵渎”的张数 $k$。

## 说明/提示

- 对于 $10\%$ 的数据，有 $m=0$；
- 对于 $20\%$ 的数据，有 $m\leq1$；
- 对于 $30\%$ 的数据，有 $m\leq2$
- 对于 $40\%$ 的数据，有 $m\leq3$；
- 对于 $50\%$ 的数据，有 $m\leq4$；
- 对于 $60\%$ 的数据，有 $m\leq5$；
- 对于 $100\%$ 的数据，有 $m\leq50$，$n\leq10^{13}$，$1 \le a_i <n$。

## 样例 #1

### 输入

```
2
10 1
5
4 2
1
2```

### 输出

```
415
135```

# AI分析结果



**唯一算法分类**：数学（自然数幂和，拉格朗日插值）

---

### **题解思路与核心难点**

#### **算法要点**
1. **确定亵渎次数 `k`**：`k = m + 1`（需去除末尾连续空位）。
2. **自然数幂和计算**：使用拉格朗日插值法高效计算 `∑i^k (i=1→n)`。
3. **贡献拆分**：总贡献 = 全体贡献 - 空位贡献 + 各区间独立贡献。

#### **解决难点**
- **自然数幂和的高效计算**：直接暴力计算无法处理 `n ≤ 1e13`，需用拉格朗日插值将复杂度优化至 `O(k)`。
- **空位贡献的减法逻辑**：每个空位区间需减去其他空位的影响，避免重复计算。

---

### **题解评分 (≥4星)**

1. **ycyaw（★★★★★）**  
   - **亮点**：代码简洁，拉格朗日插值预处理优化到位，处理空位逻辑清晰。  
   - **核心代码**：通过前缀/后缀积快速插值，关键逻辑如下：
     ```cpp
     inline int calc(int p) {
         if (p <= k+2) return f[p]; // 直接查表
         pre[0] = 1; // 预处理前缀积
         for (int i=1; i<=k+2; i++) pre[i] = pre[i-1] * (p-i) % mod;
         suf[k+3] = 1; // 预处理后缀积
         for (int i=k+2; i>=1; i--) suf[i] = suf[i+1] * (p-i) % mod;
         int res = 0;
         for (int i=1; i<=k+2; i++) {
             int x = pre[i-1] * suf[i+1] % mod; // 分子部分
             int y = fac[i-1] * fac[k+2-i] % mod; // 分母部分
             res = (res + f[i] * x % mod * ksm(y, mod-2) % mod) % mod;
         }
         return (res + mod) % mod;
     }
     ```

2. **asuldb（★★★★☆）**  
   - **亮点**：直接调用拉格朗日插值，代码模块化，空位处理逻辑直观。  
   - **关键优化**：预处理阶乘逆元，插值函数封装为独立模块。

3. **Zskioaert1106（★★★★☆）**  
   - **亮点**：递推公式推导自然数幂和，数学推导详细，适合数学基础较弱者。  
   - **核心公式**：
     ```
     S_k(n) = [(n+1)^{k+1} - 1 - ∑_{j=0}^{k-1} C(k+1,j) S_j(n)] / (k+1)
     ```

---

### **最优思路提炼**
1. **拉格朗日插值法**：预处理阶乘和逆元，快速计算自然数幂和。
2. **空位贡献减法**：对每个空位 `a[i]`，计算 `∑(n-a[i])` 的幂和后减去其他空位的交叉贡献 `(a[j]-a[i])^k`。
3. **末尾连续空位优化**：调整 `n` 和 `k` 的值，避免无效计算。

---

### **类似算法题目**
1. **CF622F**（自然数幂和的拉格朗日插值模板）
2. **洛谷P5431**（预处理逆元加速多项式计算）
3. **洛谷P4463**（自然数幂和的递推应用）

---

### **可视化与算法演示**

#### **动画设计**
- **像素风格**：用 8-bit 网格表示怪物血量，红色方块表示空位，绿色方块表示有效怪物。
- **关键步骤**：
  1. **施放亵渎**：所有怪物血量减1，触发连续施放（闪电特效）。
  2. **贡献计算**：当前区间变为黄色，右侧显示 `∑x^k` 的插值计算过程。
  3. **空位标记**：空位闪烁红光，右侧公式显示减法逻辑。

#### **交互功能**
- **步进控制**：可逐帧观察插值计算中的分子/分母更新。
- **音效**：施放亵渎时播放 8-bit 爆炸音效，计算完成时播放成功音效。

---

### **代码片段（关键逻辑）**
```cpp
// 自然数幂和计算（拉格朗日插值）
LL calc(LL n, int k) {
    if (n <= k+2) return f[n]; // 小范围直接查表
    pre[0] = suf[k+3] = 1;
    for (int i=1; i<=k+2; i++) 
        pre[i] = pre[i-1] * (n - i) % mod;
    for (int i=k+2; i>=1; i--)
        suf[i] = suf[i+1] * (n - i) % mod;
    LL res = 0;
    for (int i=1; i<=k+2; i++) {
        LL x = pre[i-1] * suf[i+1] % mod;
        LL y = inv_fac[i-1] * inv_fac[k+2-i] % mod;
        if ((k+2 - i) % 2) y = mod - y;
        res = (res + f[i] * x % mod * y) % mod;
    }
    return res;
}
```

---

### **总结**
本题核心在于数学模型的构建与高效计算，拉格朗日插值法是解决大范围自然数幂和的关键。通过预处理和分块处理空位贡献，结合代码优化，能够在 `O(m^2)` 复杂度内解决问题。

---
处理用时：73.48秒
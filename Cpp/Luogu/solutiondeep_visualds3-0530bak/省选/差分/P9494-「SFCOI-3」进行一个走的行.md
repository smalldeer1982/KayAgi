# 题目信息

# 「SFCOI-3」进行一个走的行

## 题目背景

**公告：注意存在 $l_i > r_i$ 的情况，此时操作无效。**

------------

小 L 热衷于行走。

## 题目描述

小 L 来到了一处景点，他想要在这里的主干道上行走。

主干道上有若干关键点，他可以将其抽象为一个长为 $n$ 的序列 $a$，每个 $a_i$ 都是一个三元组，可以表示为 $(l_i, r_i, v_i)$，其具体含义形如：

- 若 $r_i = -1$，表示一个需要买票进入的景点，票价为 $l_i$ 代币，游览完成后他会得到 $v_i$ 的愉悦值。
- 若 $r_i \neq -1$，表示一个礼品派发点，若他持有的代币面值之和 $x$ 满足 $l_i \leq x \leq r_i$，他可以领取一份礼品，并会得到 $v_i$ 的愉悦值。

他打算在这条主干道上行走 $m$ 次，每次他给出了行走起点 $l$ 和终点 $r$，一开始他持有的代币面值之和为 $x$，初始愉悦值为 $0$。

他将从 $l$ 开始向右依次经过 $i \in [l, r]$，他会做如下操作：

- 若 $r_i = -1$，如果他持有的代币在支付完当前景点门票费用后还有剩余，他会游览这个景点。
- 若 $r_i \neq -1$，如果可以，他会领取一份礼品。

请你帮他快速求出每次行走结束后他的愉悦值。

## 说明/提示

**本题开启捆绑测试。**

- Subtask 1（10 pts）：$1 \leq n, m \leq 5 \times 10^3$。
- Subtask 2（10 pts）：$r_i \neq -1$。
- Subtask 3（20 pts）：$r_i = -1$。
- Subtask 4（10 pts）：$1 \leq n, m \leq 7.5 \times 10^4$，性质 A。
- Subtask 5（20 pts）：$1 \leq n, m \leq 7.5 \times 10^4$。
- Subtask 6（10 pts）：数据在范围内随机生成，性质 B。
- Subtask 7（20 pts）：无特殊限制。

性质 A：$1 \leq l_i \leq 7.5 \times 10^4$，$r_i = -1$ 或 $1 \leq r_i \leq 7.5 \times 10^4$，$1 \leq x \leq 7.5 \times 10^4$。

性质 B：$r_i = -1$ 时 $1 \leq l_i \leq 2 \times 10^5$。

对于 $100\%$ 的数据：

- $1 \leq n, m \leq 2 \times 10^5$。
- $1 \leq l_i \leq 10^9$，$r_i = -1$ 或 $1 \leq r_i \leq 10^9$。
- $1 \leq v_i \leq 10^9$。
- $1 \leq l \leq r \leq n$，$1 \leq x \leq 10^9$。

## 样例 #1

### 输入

```
4 10
1 1 4
5 -1 4
1 9 19
8 -1 10
1 1 11
2 2 4
3 3 5
4 4 14
1 2 1
2 3 9
3 4 1
1 3 9
2 4 8
1 4 10```

### 输出

```
0
0
19
10
4
23
19
23
23
23```

# AI分析结果



# 算法分类  
**离线处理与平衡树维护标记**

---

## 题解思路与解决难点  
### 核心思路  
1. **离线差分**：将每个查询拆分为前缀差分形式，按扫描线顺序处理。  
2. **平衡树维护**：用平衡树（如 FHQ Treap、Splay）维护当前所有可能的代币值及其对应的愉悦值。  
3. **分裂与标记**：  
   - **买票操作**（代币减少）：将值域分为 `≤l_i` 和 `>l_i` 两部分，后者打上代币减少标记与愉悦值增加标记。  
   - **礼品操作**（区间加）：直接在值域区间上打愉悦值标记。  

### 解决难点  
- **高效处理代币减少**：每次买票操作需将大值域段整体减 `l_i`，若直接暴力修改会超时。通过分裂并打标记保证均摊复杂度为 `O(log n log V)`。  
- **动态维护区间愉悦值**：利用平衡树的区间标记功能，快速实现区间加操作。  

---

## 题解评分 (≥4星)  
1. **STARSczy（5星）**：思路清晰，结合标记与分裂操作，代码简洁高效。  
2. **EnofTaiPeople（4星）**：引入倍增分块优化，Splay 实现灵活，但代码复杂度较高。  
3. **_AyachiNene（4星）**：离散化后平衡树合并，思路新颖，代码可读性较好。  

---

## 最优思路提炼  
- **离线扫描线**：将查询按右端点排序，逐位置处理操作。  
- **值域分块标记**：将代币值按 `[2^k, 2^{k+1})` 分块，大块直接标记，小块暴力处理。  
- **平衡树合并技巧**：允许直接合并不同子树，利用标记传递避免结构破坏。  

---

## 同类型题推荐  
1. **CF702F T-Shirts**（全局减操作 + 平衡树）  
2. **P7447 [Ynoi2007] rgxsxrs**（值域分块 + 区间操作）  
3. **P3285 [SCOI2014] 方伯伯的OJ**（动态排名维护）  

---

## 可视化与算法演示  
### 动画设计  
- **像素风格**：用 8-bit 色块表示平衡树节点，红色表示当前处理节点，绿色表示标记区间。  
- **关键步骤**：  
  1. **分裂操作**：展示代币值分裂为 `≤l_i` 和 `>l_i` 两部分，高亮分裂点。  
  2. **标记传递**：用黄色闪烁表示区间愉悦值标记生效。  
  3. **暴力处理**：中间值域块被拆分为像素粒子，重新插入时播放音效。  
- **交互控制**：支持暂停/步进，速度调节（1x~10x），自动演示模式。  

### 复古效果  
- **音效**：分裂（短促“滴”声），合并（连续“嘟嘟”声），标记（长“嗡”声）。  
- **积分系统**：每处理 100 个操作获得“连击奖励”，失败时显示“Game Over”。  

---

## 核心代码实现（STARSczy 片段）  
```cpp  
void process(int i) {
    if (d[i].r == -1) { // 买票操作
        split(root, d[i].l, a, b);
        add_tag(b, -d[i].l, d[i].v); // 打标记
        root = merge(a, b);
    } else { // 礼品操作
        split(root, d[i].l-1, a, b);
        split(b, d[i].r, b, c);
        add_tag(b, 0, d[i].v); // 区间加愉悦值
        root = merge(a, merge(b, c));
    }
}
```

---

## 个人心得摘录  
- **EnofTaiPeople**：“Splay 的灵活性在于动态调整结构，但标记下传顺序极易出错，需反复验证。”  
- **lfxxx**：“暴力拆分中间值域块时，必须重新生成随机权值，否则树高退化导致 TLE。”  

---

## 总结  
通过离线扫描线与平衡树标记，将复杂操作转化为高效的分裂合并，结合值域分块优化暴力部分，最终实现 `O(n log n log V)` 的最优复杂度。

---
处理用时：64.75秒
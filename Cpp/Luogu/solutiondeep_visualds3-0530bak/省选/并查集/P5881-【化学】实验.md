# 题目信息

# 【化学】实验

## 题目背景

小 Z 紧张地坐在了一张化学实验桌前，进行着化学实验。

教室里又传来了一阵哀叹声：

我…我好像又错了…我能再试一次吗?

## 题目描述

在她的面前，摆放着 $n$ 个试管。试管里装着不明液体。对于每种不明液体，有 $2$ 个已知的化学属性：$a$ 和 $b$。第 $i$ 种液体的两个属性值分别为 $a_i$ 和 $b_i$。

现在，老师给她布置了 $m$ 个实验。

对于每一次实验，有一个参照量 $x$（第 $i$ 次实验的参照量记作 $x_i$）。她需要把不明液体分成尽可能多的组，且满足：任意两种不同组的液体$i$和$j$， $\operatorname{gcsd(a_i,a_j)}$ 都不能大于 $x^2$。

其中 $\operatorname{gcsd}$ 代表他们的最大公约平方数。$k$是两个数的公约平方数，当且仅当满足以下两个条件：

- $k$ 为这两个数的公约数；

- $k$ 为完全平方数。

而最大公约平方数 $\operatorname{gcsd}$ 为所有满足条件的 $k$ 中的最大者。

形象的说， $\operatorname{gcsd}$ 可以理解成两个数的最大公约数的算术平方根的整数因式部分的平方。

例如：

求 $\operatorname{gcsd(24,64)}$，就是先求出 $24,64$ 的最大公约数，是 $8$ ，然后 $\sqrt 8=2\sqrt 2$，其整数因式是 $2$，所以 $\operatorname{gcsd(24,64)}=2^2=4$。

她还需要在分组数最多的情况下，使自己的实验得分最大。

实验得分的定义：对于每一种试剂，定义其得分 $c_i$ 为 $b_i$ 分解质因数之后最大的**指数**。

例如：$b_i=12=2^2\times 3^1$，$c_i=\max\{2,1\}=2$。

$b_i=90=2^1\times 3^2\times 5^1$，$c_i=\max\{1,2,1\}=2$。

而实验得分即为所有组内的 $c_i$ 的最大值之和。

当然，她的 $IQ$ 并不高，所以需要请求你的帮助。

## 说明/提示

#### 样例解释 #1

$b_1=2=2^1,c_1=1$。

$b_2=4=2^2,c_2=2$。

$b_3=6=2^1\times 3^1,c_3=\max\{1,1\}=1$。

$b_4=8=2^3,c_4=3$。

$b_5=10=2^1\times 5^1,c_5=\max\{1,1\}=1$。

当 $x=2$ 时，可分为三组：$\{1,2,4\},\{3\},\{5\}$。

实验得分为$\max\{1,2,3\}+\max\{1\}+\max\{1\}=5$。

----------

#### 数据范围

**「本题采用捆绑测试」**

| subtask | $n\le$ | $m\le$ | $a_i \le$ | $b_i\le$ | $x \le$ | 分值 |
| :-----------: | :-----------: | :-----------: | :-----------: | :-----------: | :-----------: |:-----------:|
| $1$ | $4$ | $6$ | $100$ | $4 \times 10^4$ | $100$ | $5$ |
| $2$ | $8$ | $7$ | $20$ | $10^3$ | $10$ | $5$ |
| $3$ |$20$ | $30$ | $50$ | $8 \times 10^3$ | $100$ | $10$ |
| $4$ |$100$ | $60$ | $100$ | $4 \times 10^4$ | $10^3$ | $10$ |
| $5$ |$5 \times 10^3$ | $110$ |  $10^3$| $10^5$ | $4 \times 10^3$ | $10$ |
| $6$ |$2 \times 10^4$ | $250$ | $3 \times 10^3$ | $10^6$ | $3 \times 10^3$ | $10$ |
| $7$ |$ 5 \times 10^4$| $10^3$ | $10^4$ | $2 \times 10^7$ | $1.5 \times 10^4$ | $15$ |
| $8$ |$10^5$  | $8 \times 10^3$ | $2 \times 10^4$ | $2 \times 10^7$ | $2.2 \times 10^4$ | $15$ |
| $9$ |$2 \times 10^5$  | $2 \times 10^5$ | $4 \times 10^4$ | $2 \times 10^7$ | $3 \times 10^4$ | $20$ |


对于 $100\%$ 的数据：

$1 \le n,m \le 2\times 10^5$，$2 \le a_i \le 4\times 10^4$，$2 \le b_i \le 2\times 10^7$，$2 \le x \le 3\times 10^4$。

我$\dots$我好像又错了$\dots$我能再试一次吗?

## 样例 #1

### 输入

```
5 5
36 72 4 9 16
2 4 6 8 10
2 3 4 5 6
```

### 输出

```
3 5
4 7
4 7
4 7
5 8```

# AI分析结果



---

## 算法分类
**数学问题（质因数分解、GCD处理）+ 并查集**

---

## 综合分析与结论
### 核心算法流程
1. **预处理阶段**  
   - 使用线性筛预处理所有数的平方因子分解（h(a_i)）和质因数最大指数（c_i）
   - h(a_i) = 最大平方因子整数部分（如24→4，9→3）
   - c_i = b_i分解质因数后的最大指数

2. **连通块建模**  
   - 将每个液体的h(a_i)视为节点，建立并查集
   - 若两个液体的h(a_i)的gcd > x，则必须合并到同一组

3. **离线查询处理**  
   - 从大到小枚举x值，动态维护并查集
   - 每次x减少时，将x的倍数节点合并（维护最大连通块）

4. **答案计算**  
   - 连通块数量即最大组数
   - 每个连通块的max(c_i)之和即实验得分

### 解决难点
1. **数学转化**  
   - 将gcsd条件转化为gcd(h(a_i),h(a_j))≤x的图论问题
   - 需发现h(a_i)的平方因子特性可线性筛预处理

2. **动态合并优化**  
   - 利用并查集离线处理查询，避免重复计算
   - 从大到小枚举x实现「逆序合并」，复杂度O(α(n))

3. **空间优化**  
   - 使用char类型存储质因数指数，压缩内存占用
   - 合并质因数分解和最大指数计算到同一线性筛过程

---

## 题解评分（≥4星）

### 鏡音リン（⭐⭐⭐⭐⭐）
- **核心亮点**  
  - 完整实现离线逆序合并策略  
  - 代码仅120行，内存优化到极致  
  - 时间复杂度O(n + m + a_max log a_max)  

- **代码片段**  
  ```cpp
  // 离线处理查询的核心逻辑
  for (int i = R-1; i >= 2; i--) {
    ans[i] = co[i]+cnt;
    bool mg = false;
    f[i] = i; p[i] = mv[i];
    cnt = cnt + (pair) {1, mv[i]};
    for (int j = 2; i*j < R; j++) if (mv[i*j]) {
      int x = fa(i), y = fa(i*j);
      if (x != y) {
        mg = true;
        f[x] = y;
        cnt.x--;
        cnt.y -= std::min(p[x], p[y]);
        p[y] = std::max(p[x], p[y]);
      }
    }
  }
  ```

---

## 最优思路提炼
### 关键技巧
1. **双线性筛优化**  
   - 一个筛子同时计算h(a_i)和c_i  
   - 公式推导：  
     - h(ip) = h(i) * p（当p是i的最小质因子且出现奇数次）  
     - c(ip) = max(c(i),当前质因子次数)

2. **逆序并查集合并**  
   - 查询x从大到小处理  
   - 合并x的倍数节点，保证每个节点只被处理一次

3. **空间压缩策略**  
   - 用char类型存储质因数指数（st数组）  
   - 复用数组空间（st同时存储分解次数和最大指数）

---

## 同类型题目推荐
1. **P1892 团伙**  
   - 并查集处理必须同组的条件

2. **P3383 线性筛素数**  
   - 练习线性筛的扩展应用

3. **P1069 细胞分裂**  
   - 质因数分解与最大指数的综合应用

---

## 可视化设计要点

### 动画方案（Canvas实现）
1. **节点表示**  
   - 每个h(a_i)值显示为彩色方块  
   - 颜色深浅表示当前x值下是否允许单独成组

2. **合并过程**  
   - 当x减小时，红色高亮新增的合并边  
   - 显示并查集树的动态连接（父子指针动画）

3. **状态面板**  
   - 实时显示当前x值、组数、得分  
   - 历史最优解用绿色边框标记

### 复古像素风格
- **调色板**：16色FC风格（深蓝背景，亮色节点）
- **音效设计**：  
  - 合并时：8-bit "blip" 音效（频率随组数变化）
  - 最优解：经典《超级马里奥》过关音效
- **自动演示**：  
  - 按x从大到小自动播放合并过程  
  - 支持空格键暂停/继续

---

## 核心代码实现
```cpp
// 线性筛预处理（鏡音リン题解核心）
void prime() {
    for (int i = 2; i < M; i++) {
        if (!s[i]) { 
            pr.push_back(i);
            s[i] = i;
            st[i] = 1;
            if (i < L) h[i] = 1;
        }
        for (int j : pr) {
            if (i*j >= M) break;
            s[i*j] = j;
            st[i*j] = (s[i] == j) ? st[i]+1 : 1;
            if (i*j < L) 
                h[i*j] = (s[i] == j && st[i] & 1) ? h[i]*j : h[i];
            if (i % j == 0) break;
        }
    }
    // 第二遍筛计算最大指数
    for (int i = 2; i < M; i++) 
        for (int j : pr) {
            if (i*j >= M) break;
            st[i*j] = std::max(st[i], st[i*j]);
            if (i % j == 0) break;
        }
}
```

---
处理用时：75.01秒
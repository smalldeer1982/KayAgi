# 题目信息

# [CQOI2018] 解锁屏幕

## 题目背景

使用过 Android 手机的同学一定对手势解锁屏幕不陌生。 Android 的解锁屏幕由 $3 \times 3$ 个点组成，手指在屏幕上画一条线，将其中一些点连接起来，即可构成一个解锁图案。如下面三个例子所示：

![](https://cdn.luogu.com.cn/upload/pic/17556.png)
![](https://cdn.luogu.com.cn/upload/pic/17557.png)
![](https://cdn.luogu.com.cn/upload/pic/17558.png)

## 题目描述

画线时还需要遵循一些规则：
1. 连接的点数不能少于 $4$ 个。也就是说只连接两个点或者三个点会提示错误。
2. 两个点之间的联线不能弯曲。
3. 每个点只能“使用”一次，不可重复。这里的“使用”是指手指划过一个点，该点变绿。
4. 两个点之间的连线不能“跨过”另一个点，除非那个点之前已经被“使用”过。

对于最后一条规则，参见下图的解释。左边两幅图违反了该规则；而右边两幅图（分别为 $ 2 \rightarrow 4 \rightarrow 1 \rightarrow 3 \rightarrow 6$ 和 $ 6 \rightarrow 5 \rightarrow 4 \rightarrow 1 \rightarrow 9 \rightarrow 2$ ）则没有违反规则，因为在“跨过”点时，点已经被使用过了。

![](https://cdn.luogu.com.cn/upload/pic/17566.png)

现在工程师希望改进解锁屏幕，增减点的数目，并移动点的位置，不再是一个九宫格形状，但保持上述画线规则不变。

请计算新的解锁屏幕上，一共有多少满足规则的画线方案。

## 说明/提示

#### 样例解释 1

设 $4$ 个点编号为 $1$ 到 $4$ ，方案有 $1 \rightarrow 2 \rightarrow 3 \rightarrow 4$ ， $2 \rightarrow 1 \rightarrow 3 \rightarrow 4$ ，  $3 \rightarrow 2 \rightarrow 1 \rightarrow 4$ ，  $2 \rightarrow 3 \rightarrow 1 \rightarrow 4$ 以及它们的镜像。

### 数据范围

- 对于 $30\%$ 的数据，$1 \le n \le 10$。
- 对于 $100\%$ 的数据，$-1000 \le x_i ,y_i \le 1000$，$ 1 \le n < 20$。各点坐标不相同。

## 样例 #1

### 输入

```
4
0 0
1 1
2 2
3 3```

### 输出

```
8```

## 样例 #2

### 输入

```
4
0 0
0 1
0 2
1 0```

### 输出

```
18```

# AI分析结果



**唯一算法分类**  
状压DP

---

### **综合分析与结论**

**核心思路**  
题目要求计算满足特定规则的点连接方案数，关键约束是两点连线不能跨过未使用的点。采用状压DP，状态`dp[state][i]`表示当前已选点集合`state`，最后一个点为`i`的方案数。预处理每对点连线上的中间点集合，转移时检查这些中间点是否全部被选中。

**算法流程**  
1. **预处理中间点**：对每对点`(i, j)`，计算其连线上的所有中间点，存储为位掩码`nd[i][j]`。  
2. **初始化DP**：单点状态`dp[1<<i][i] = 1`。  
3. **状态转移**：枚举当前状态`state`和最后一个点`i`，遍历所有未选点`j`，若`state`包含`nd[i][j]`的所有点，则转移状态。  
4. **统计结果**：累加所有`state`中点数≥4的方案数。

**可视化设计**  
- **动态网格图**：展示3×3点阵，高亮当前选择的点及路径。  
- **颜色标记**：已访问点（绿色）、当前路径（红色）、中间点检查（黄色闪烁）。  
- **步进控制**：允许单步执行观察状态转移，显示`state`二进制和中间点检查结果。  
- **复古像素风**：使用8位色调色板，转移时播放“滴”音效，达成4点时播放胜利音效。

---

### **题解清单 (≥4星)**

1. **孙子隆 (5星)**  
   - **亮点**：预处理中间点集合，位运算快速检查，代码高效。  
   - **关键代码**：预处理`nd[i][j]`，转移时检查`(nd[j][k] & i) == nd[j][k]`。

2. **StudyingFather (4.5星)**  
   - **亮点**：清晰注释，斜率判断三点共线，结构易读。  
   - **关键代码**：使用`slope`函数判断共线，`g[i][j]`存储中间点。

3. **littleseven (4星)**  
   - **亮点**：详细题解说明，预处理优化，强调状压DP思路。  
   - **个人心得**：强调预处理对时间效率的提升。

---

### **核心代码实现**

**孙子隆题解关键片段**  
```cpp
// 预处理中间点集合nd[i][j]
for (int i = 0; i < n; i++) {
    for (int j = 0; j < n; j++) {
        if (i == j) continue;
        for (int k = 0; k < n; k++) {
            if (k == i || k == j) continue;
            if (check_on_line(p[i], p[k], p[j])) // 检查k是否在i-j连线上
                nd[i][j] |= (1 << k);
        }
    }
}

// 状态转移核心逻辑
for (int state = 1; state < (1 << n); state++) {
    for (int j = 0; j < n; j++) {
        if (!(state & (1 << j))) continue;
        for (int k = 0; k < n; k++) {
            if (state & (1 << k)) continue;
            if ((nd[j][k] & state) == nd[j][k]) { // 检查中间点
                dp[state | (1 << k)][k] += dp[state][j];
            }
        }
    }
}
```

---

### **同类型题与拓展**

1. **洛谷P2831 [NOIP2016 提高组] 愤怒的小鸟**  
   - 状压DP处理抛物线覆盖点，预处理中间点集合。

2. **洛谷P3959 [NOIP2017 提高组] 宝藏**  
   - 状压DP结合最小生成树，状态表示节点访问顺序。

3. **洛谷P1433 吃奶酪**  
   - 状压DP求最短路径，类似TSP问题。

---

### **可视化与复古游戏化设计**

1. **Canvas动画**  
   - **网格绘制**：9×9像素网格表示点，选中点显示绿色边框。  
   - **路径绘制**：红色线条连接已选点，中间点检查时黄色闪烁。  
   - **状态显示**：右侧面板展示当前`state`二进制和点数统计。

2. **音效与交互**  
   - **选中点**：8位“滴”声。  
   - **错误转移**：短促“哔”声。  
   - **达成4点**：播放FC风格胜利音乐。

3. **自动演示模式**  
   - **AI决策**：优先选择最少中间点的路径，模拟“最优解”搜索过程。  
   - **速度调节**：滑块控制动画速度（1x~10x）。  

```html
<!-- 简化的Canvas绘制示例 -->
<canvas id="grid" width="300" height="300"></canvas>
<script>
const points = [[50,50], [150,50], [250,50], /*...*/]; // 点坐标
function drawGrid(ctx) {
    points.forEach(([x,y], i) => {
        ctx.fillStyle = (state & (1 << i)) ? '#0f0' : '#888';
        ctx.fillRect(x-5, y-5, 10, 10); // 绘制点
    });
}
</script>
```

---

**总结**  
状压DP通过状态压缩高效处理点集，预处理中间点集合是关键优化。结合复古像素动画和交互演示，可直观理解算法流程与状态转移逻辑。

---
处理用时：71.69秒
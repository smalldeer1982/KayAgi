# 题目信息

# [NOI2017] 游戏

## 题目背景

【本题原题时限 1s】

狂野飙车是小 L 最喜欢的游戏。与其他业余玩家不同的是，小 L 在玩游戏之余，还精于研究游戏的设计，因此他有着与众不同的游戏策略。


## 题目描述

小 L 计划进行 $n$ 场游戏，每场游戏使用一张地图，小 L 会选择一辆车在该地图上完成游戏。

小 L 的赛车有三辆，分别用大写字母 $A$、$B$、$C$ 表示。地图一共有四种，分别用小写字母 $x$、$a$、$b$、$c$ 表示。

其中，赛车 $A$ 不适合在地图 $a$ 上使用，赛车 $B$ 不适合在地图 $b$ 上使用，赛车 $C$ 不适合在地图 $c$ 上使用，而地图 $x$ 则适合所有赛车参加。

适合所有赛车参加的地图并不多见，最多只会有 $d$ 张。

$n$ 场游戏的地图可以用一个小写字母组成的字符串描述。例如：$S=\texttt{xaabxcbc}$ 表示小 L 计划进行 $8$ 场游戏，其中第 $1$ 场和第 $5$ 场的地图类型是 $x$，适合所有赛车，第 $2$ 场和第 $3$ 场的地图是 $a$，不适合赛车 $A$，第 $4$ 场和第 $7$ 场的地图是 $b$，不适合赛车 $B$，第 $6$ 场和第 $8$ 场的地图是 $c$，不适合赛车 $C$。

小 L 对游戏有一些特殊的要求，这些要求可以用四元组 $ (i, h_i, j, h_j) $ 来描述，表示若在第 $i$ 场使用型号为 $h_i$ 的车子，则第 $j$ 场游戏要使用型号为 $h_j$ 的车子。

你能帮小 L 选择每场游戏使用的赛车吗？如果有多种方案，输出任意一种方案。

如果无解，输出 `-1`。

## 说明/提示

### 样例 1 解释

小 $L$ 计划进行 $3$ 场游戏，其中第 $1$ 场的地图类型是 $x$，适合所有赛车，第 $2$ 场和第 $3$ 场的地图是 $c$，不适合赛车 $C$。

小 $L$ 希望：若第 $1$ 场游戏使用赛车 $A$，则第 $2$ 场游戏使用赛车 $B$。

那么为这 $3$ 场游戏分别安排赛车 $A$、$B$、$A$ 可以满足所有条件。

若依次为 $3$ 场游戏安排赛车为 $BBB$ 或 $BAA$ 时，也可以满足所有条件，也被视为正确答案。

但依次安排赛车为 $AAB$ 或 $ABC$ 时，因为不能满足所有条件，所以不被视为正确答案。

### 样例 2

详见附加文件。

### 数据范围

| 测试点编号 |        $n$         |   $d$   |    $m$     |        其他性质         |
| :--------: | :----------------: | :-----: | :--------: | :---------------------: |
|    $1$     |      $\le 2$       |   $0$   |  $\le 4$   |           无            |
|    $2$     |      $\le 2$       | $\le n$ |  $\le 4$   |           无            |
|    $3$     |      $\le 5$       |   $0$   |  $\le 10$  |           无            |
|    $4$     |      $\le 5$       | $\le n$ |  $\le 10$  |           无            |
|    $5$     |      $\le 10$      |   $0$   |  $\le 20$  |           无            |
|    $6$     |      $\le 10$      | $\le 8$ |  $\le 20$  |           无            |
|    $7$     |      $\le 20$      |   $0$   |  $\le 40$  |    $S$ 中只包含 $c$     |
|    $8$     |      $\le 20$      |   $0$   |  $\le 40$  |           无            |
|    $9$     |      $\le 20$      | $\le 8$ |  $\le 40$  | $S$ 中只包含 $x$ 或 $c$ |
|    $10$    |      $\le 20$      | $\le 8$ |  $\le 40$  |           无            |
|    $11$    |     $\le 100$      |   $0$   | $\le 200$  |    $S$ 中只包含 $c$     |
|    $12$    |     $\le 100$      |   $0$   | $\le 200$  |           无            |
|    $13$    |     $\le 100$      | $\le 8$ | $\le 200$  | $S$ 中只包含 $x$ 或 $c$ |
|    $14$    |     $\le 100$      | $\le 8$ | $\le 200$  |           无            |
|    $15$    | $\le 5\times 10^3$ |   $0$   | $\le 10^4$ |           无            |
|    $16$    | $\le 5\times 10^3$ | $\le 8$ | $\le 10^4$ | $S$ 中只包含 $x$ 或 $c$ |
|    $17$    | $\le 5\times 10^3$ | $\le 8$ | $\le 10^4$ |           无            |
|    $18$    | $\le 5\times 10^4$ |   $0$   | $\le 10^5$ |           无            |
|    $19$    | $\le 5\times 10^4$ | $\le 8$ | $\le 10^5$ | $S$ 中只包含 $x$ 或 $c$ |
|    $20$    | $\le 5\times 10^4$ | $\le 8$ | $\le 10^5$ |           无            |

## 样例 #1

### 输入

```
3 1
xcc
1
1 A 2 B```

### 输出

```
ABA```

# AI分析结果



# 算法分类  
**2-SAT 与暴力枚举**

---

## 综合分析与结论  
### 题目核心思路  
1. **2-SAT 建模**：  
   - 非 `x` 地图仅允许两种车，将每个地图拆分为两个节点（对应两种选择）。  
   - 根据条件建立推导关系的有向边，例如若选车 A 则必须选车 B，需建立对应边。  
2. **x 地图处理**：  
   - 暴力枚举每个 `x` 地图的类型（设为 `a` 或 `b`），覆盖所有可能的三种车选择。  
   - 枚举复杂度为 $O(2^d)$，结合 2-SAT 的 $O(n + m)$，总复杂度可接受。  

### 解决难点  
- **条件转换**：需处理不同条件组合，如某车不可选时的剪枝逻辑。  
- **拓扑序输出方案**：根据强连通分量编号判断每个地图的最终选择。  

### 可视化设计思路  
- **建图动画**：展示每个条件如何转换为边，如条件 $(i,A,j,B)$ 对应红边 `i_A→j_B` 和反边 `¬j_B→¬i_A`。  
- **Tarjan 过程**：动态显示强连通分量的合并，用颜色区分不同 SCC。  
- **x 枚举效果**：以 8 位像素风格展示 `x` 地图的枚举过程，每次枚举后重新建图并高亮当前处理的 `x`。  

---

## 题解评分（≥4星）  
### 1. xyz32768（⭐⭐⭐⭐⭐）  
- **亮点**：代码结构清晰，通过 `tran` 函数统一处理地图类型转换，逻辑简明。  
- **关键代码**：  
  ```cpp  
  int tran(int x, char c) {  
      if (s[x] == 'a') return c == 'B' ? x : x + n;  
      if (s[x] == 'b' || s[x] == 'c') return c == 'A' ? x : x + n;  
      if (c == 'C') return x + n; return x;  
  }  
  ```  
  将地图类型映射为节点编号，巧妙处理不同情况。  

### 2. Kelin（⭐⭐⭐⭐）  
- **亮点**：使用对称边简化推导逻辑，代码短小高效。  
- **关键思路**：  
  ```cpp  
  add(u, v);  
  add(rev(v), rev(u)); // 对称边  
  ```  
  确保逆否命题的自动处理。  

### 3. laoliu12345（⭐⭐⭐⭐）  
- **亮点**：详细注释与调试技巧，适合新手理解。  
- **个人心得**：  
  > “2-SAT 的边必须严格满足逻辑，手动模拟小样例可避免建边错误。”  

---

## 最优思路与技巧  
1. **x 地图枚举优化**：仅枚举 `a` 或 `b` 类型，覆盖所有可能选择。  
2. **对称边简化**：自动处理逆否命题，避免手动推导。  
3. **SCC 拓扑序应用**：直接比较分量编号选择车辆，无需反向图。  

---

## 类似题目  
1. **P4782 【模板】2-SAT**：基础 2-SAT 模板。  
2. **P4171 [HN省队集训] 满汉全席**：条件转换与 2-SAT 结合。  
3. **CF1215F Radio Stations**：带权 2-SAT 与区间约束。  

---

## 可视化与复古动画  
### 核心算法演示  
- **步骤分解**：  
  1. 展示 `x` 枚举为像素方块，红蓝闪烁表示当前枚举状态。  
  2. 动态绘制 2-SAT 图，绿色边为正向推导，黄色边为逆否。  
  3. Tarjan 过程中，节点被染色为不同 SCC，合并时播放“合并音效”。  

### 复古风格设计  
- **像素调色板**：16 色，SCC 用不同色块表示，边为单色线条。  
- **音效设计**：  
  - 边添加时：短促“哔”声。  
  - SCC 合并：低音“咚”声。  
  - 找到解：8-bit 胜利旋律。  

---

## 代码片段（关键逻辑）  
**2-SAT 建图与枚举 x**  
```cpp  
void solve() {  
    // ... 初始化  
    for (int s = 0; s < (1 << d); ++s) {  
        for (int i = 0; i < d; ++i)  
            s[i] = (s & (1 << i)) ? 'a' : 'b';  
        build_graph();  
        if (check_2sat()) {  
            output_solution();  
            return;  
        }  
    }  
    cout << "-1\n";  
}  
```  

**Tarjan 缩点**  
```cpp  
void tarjan(int u) {  
    dfn[u] = low[u] = ++idx;  
    stk.push(u); in_stk[u] = true;  
    for (int v : graph[u]) {  
        if (!dfn[v]) {  
            tarjan(v);  
            low[u] = min(low[u], low[v]);  
        } else if (in_stk[v])  
            low[u] = min(low[u], dfn[v]);  
    }  
    if (low[u] == dfn[u]) {  
        ++scc_cnt;  
        while (true) {  
            int v = stk.top(); stk.pop();  
            in_stk[v] = false;  
            scc[v] = scc_cnt;  
            if (v == u) break;  
        }  
    }  
}  
```

---
处理用时：88.56秒
# 题目信息

# [USACO22OPEN] Hoof and Brain P

## 题目描述

给定一个包含 $N$ 个结点和 $M$ 条边的有向图（$2 \leq N \leq 10^5$, $1 \leq M \leq 2 \cdot 10^5$），Farmer John 的奶牛们喜欢玩以下的双人游戏。

在图中的不同结点上放置两个指示物（可以用一些与奶牛相关的物品代替指示物）。每一回合，一名玩家，脑，选择一个需要沿某一条出边移动的指示物。另一名玩家，蹄，选择沿着哪条出边移动该指示物。两个指示物在任何时刻不允许处于同一个结点上。如果在某些时刻蹄不能做出合法的行动，则脑获胜。如果游戏可以无限进行下去，则蹄获胜。

给定 $Q$ 个询问（$1 \leq Q \leq 10^5$），包含两个指示物所在的初始结点。对于每个询问，输出哪名玩家获胜。

## 说明/提示

【数据范围】

脑可以通过选择结点 $5$ 赢得第一局游戏；此时蹄将没有合法的行动。

脑可以通过选择结点 $4$ 然后选择结点 $7$ 赢得最后一局游戏；此时蹄没有合法的行动。

蹄赢得其他局游戏。

【测试点性质】

- 测试点 2-3 满足 $N\le 100$，$M\le 200$。
- 测试点 4-9 满足 $N\le 5000$。
- 测试点 10-21 没有额外限制。

## 样例 #1

### 输入

```
9 10
1 2
2 3
3 4
4 7
3 5
1 6
6 8
8 9
9 6
7 2
4
1 5
1 2
1 6
2 4```

### 输出

```
BHHB```

# AI分析结果



# 算法分类
**图论（拓扑排序、缩点与并查集）**

---

## 题解思路与算法分析

### 核心思路
1. **删除出度为0的节点**：这些节点会导致无法移动，直接让Brain获胜。通过反图拓扑排序删除此类节点及后续产生的新的出度为0节点。
2. **合并出度为1的节点**：若节点`u`的出边唯一指向`v`，则`u`和`v`合并为同一连通块（合并后`u`的移动路径唯一，无法避免碰撞）。
3. **并查集判断连通性**：最终两个初始点若在同一连通块或被删除，则Brain获胜，否则Hoof获胜。

### 解决难点
- **高效合并出度为1的节点**：使用启发式合并（维护入边集合`in`和出边集合`out`），确保合并操作的时间复杂度为$O(m \log n)$。
- **动态维护连通性**：通过并查集快速判断两个点是否被合并到同一集合。

---

## 题解评分（≥4星）

### 1. Kubic 的题解（⭐⭐⭐⭐⭐）
- **亮点**：代码简洁，利用染色和启发式合并快速判断连通性。通过维护出边颜色种数，直接得出合并条件。
- **关键代码**：
  ```cpp
  void merge(int u,int v) { // 启发式合并关键步骤
      u=rt[u],v=rt[v];
      for(auto x:vc[u]) upd(x,v),vc[v].pb(x);
  }
  ```

### 2. Elma_ 的题解（⭐⭐⭐⭐）
- **亮点**：使用`set`维护出边和入边，合并过程清晰。通过队列处理出度为1的节点，逻辑直观。
- **关键代码**：
  ```cpp
  while (quw.size()) {
      int f = quw.front(); quw.pop();
      if (g[f].size() == 1) merge(f, *g[f].begin());
  }
  ```

### 3. cff_0102 的题解（⭐⭐⭐⭐）
- **亮点**：详细注释合并逻辑，强调出度为1节点的等价性。代码可读性强，适合初学者理解。
- **关键代码**：
  ```cpp
  for (int x : re[v]) { // 合并入边
      re[u].insert(x);
      g[x].erase(v); g[x].insert(u);
  }
  ```

---

## 最优思路与技巧
### 关键技巧
1. **反图拓扑排序**：快速删除无法进入环的节点（出度为0节点及其影响链）。
2. **启发式合并**：合并出度为1的节点时，总是将小集合合并到大集合，保证时间复杂度。
3. **并查集维护连通性**：最终判断两个点是否在同一连通块或被删除。

### 同类型题目
- [P7737 [NOI2021] 庆典](https://www.luogu.com.cn/problem/P7737)（支配点与缩点）
- [P7323 [WC2021] 括号路径](https://www.luogu.com.cn/problem/P7323)（启发式合并边集）

---

## 推荐相似题目
1. **P3387 【模板】缩点**（强连通分量缩点）
2. P2746 [USACO5.3] 校园网Network of Schools（缩点与度数分析）
3. P2863 [USACO06JAN] The Cow Prom（强连通分量基础）

---

## 代码实现核心片段
```cpp
// Kubic 题解核心代码（启发式合并）
void merge(int u, int v) {
    u = find(u), v = find(v);
    if (u == v) return;
    if (in[u].size() > in[v].size()) swap(u, v);
    for (int x : in[u]) { // 合并入边
        out[x].erase(u);
        out[x].insert(v);
        in[v].insert(x);
        if (out[x].size() == 1) q.push(x);
    }
    fa[u] = v;
}
```

---

## 可视化与算法演示
### 动画设计
1. **拓扑删除阶段**：
   - **红色高亮**：当前出度为0的节点，逐步删除并扩散到前驱节点。
   - **网格展示**：节点排列为网格，删除的节点变为灰色并下沉。

2. **合并阶段**：
   - **绿色脉冲**：当前处理的出度为1节点`u`，合并到其唯一邻居`v`。
   - **连线动画**：动态绘制`u`和`v`的合并过程，并更新`v`的入边集合。

3. **最终判断**：
   - **连通块染色**：不同连通块用不同颜色区分，询问时检查两节点颜色。

### 复古像素风格
- **8位音效**：合并时播放“哔”声，删除节点时播放“咔”声。
- **Canvas 绘制**：节点用16x16像素方块表示，边用虚线箭头连接。

---

## 总结
通过拓扑排序和启发式合并，将问题转化为连通性判断。核心在于动态维护图的缩点状态，适用于大规模图的高效处理。

---
处理用时：64.96秒
# 题目信息

# [省选联考 2023] 过河卒

## 题目背景

棋盘上有一个过河卒，需要走到底线。卒行走的规则是可以向左移动一格，向右移动一格或者向前移动一格。同时在棋盘上有两个另一方的棋子，需要拦截这个卒走到底线。这两个棋子的走法和帅一致，可以走到前后左右四个方向上相邻的格子。因此本题可以称为“帅拦过河卒”。

## 题目描述

有一个 $n$ 行 $m$ 列的棋盘。我们用 $(i,j)$ 表示第 $i$ 行第 $j$ 列的位置。棋盘上有一些 障碍，还有一个黑棋子和两个红棋子。

游戏的规则是这样的: 红方先走，黑方后走，双方轮流走棋。红方每次可以选择一个红棋子，向棋盘的相邻一格走一步。具体而言，假设红方选择的这个棋子位置在 $(i,j)$，那么它可以走到 $(i-1,j),(i+1,j),(i,j-1),(i,j+1)$ 中的一个，只要这个目的地在棋盘内且没有障碍且没有红方的另一个棋子。

黑方每次可以将自己的棋子向三个方向之一移动一格。具体地，假设这个黑棋子位置在 $(i,j)$，那么它可以走到 $(i-1,j),(i,j-1),(i,j+1)$ 这三个格子中的一个，只要这个目的地在棋盘内且没有障碍。

在一方行动之前，如果发生以下情况之一，则立即结束游戏，按照如下的规则判断胜负（列在前面的优先）：

- 黑棋子位于第一行。此时黑方胜。

- 黑棋子和其中一个红棋子在同一个位置上。此时进行上一步移动的玩家胜。

- 当前玩家不能进行任何合法操作。此时对方胜。

现在假设双方采用最优策略，不会进行不利于自己的移动。也就是说:

- 若存在必胜策略，则会选择所有必胜策略中，不论对方如何操作，本方后续获胜所需步数最大值最少的操作。
- 若不存在必胜策略，但存在不论对方如何行动，自己都不会落败的策略，则会选择任意一种不败策略。
- 若不存在不败策略，则会选择在所有策略中，不论对方如何操作，对方后续获胜所需步数最小值最大的操作。

如果在 $100^{100^{100}}$ 个回合之后仍不能分出胜负，则认为游戏平局。请求出游戏结束时双方一共移动了多少步，或者判断游戏平局。

## 说明/提示

**【样例 1 解释】**

第一组数据，红方第一步没有可行的移动，所以黑方胜。

第二组数据，无论第一步红方怎么移动，黑方都可以在下一步让黑棋子与红棋子在同一个位置。

第三组数据，无论第一步红方怎么移动，黑方都可以将自己的棋子往上移动一枚来达成胜利。

第四组数据，有一个红棋子不能动。另一个红棋子可以在第三行移动来防止黑棋子进入第一行。黑棋子也可以一直在第五行移动。如果红棋子到达第五行，黑棋子可以选择从另一边逃走。

第五组数据，在最后一行的那个红棋子可以从左边绕一圈抓住黑棋子。注意另一个红棋子可以移动。

**【样例 2 解释】**

这个样例中的每一组数据都满足测试点 $5$ 到 $13$ 中某一个测试点的限制。

**【子任务】**

对于所有的数据，保证：$1 \leq T \leq 10$，$2 \leq n \leq 10$，$1 \leq m \leq 10$，$\text{id}$ 等于测试点编号。

对于每组数据保证：棋盘上的黑棋恰好有一个，红棋恰好有两个，且黑棋不在第一 行。

- 测试点 $1 \sim 4$：保证要么平局，要么红方在开始时无法移动。

- 测试点 $5 \sim 6$：保证 $n \geq 4$ 。保证棋盘上第 $n-1$ 行的每一个格子都是障碍物，且 棋盘上其他行没有障碍物。保证黑棋在前 $n-2$ 行，有一个红棋在前 $n-2$ 行，另一个红棋在第 $n$ 行。

- 测试点 $7 \sim 9$：保证 $m=1$。

- 测试点 $10 \sim 13$：保证要么平局，要么存在策略可以在 $9$ 步之内结束游戏。

- 测试点 $14 \sim 20$：无特殊限制。

## 样例 #1

### 输入

```
0 5
4 5
...#O
.#..#
#O#..
.#..X
3 3
#.#
O.O
.X.
3 3
O..
.#X
.O.
5 5
.....
.....
..O..
#..#.
O#.X.
9 9
...######
.#.......
.#######.
.#.#.....
.#O#.####
.#.#.....
.#######.
.#X......
.O.......
```

### 输出

```
Black 0
Black 2
Black 2
Tie
Red 75
```

## 样例 #2

### 输入

```
见附件中的 zu/zu2.in```

### 输出

```
见附件中的 zu/zu2.ans```

# AI分析结果



## 算法分类  
无算法分类（核心：博弈论中的有向图博弈与状态压缩）

---

## 题解思路与核心难点  
### 核心思路  
1. **状态建模**：将三个棋子的位置（黑棋坐标、两个红棋坐标）作为状态，压缩为六维坐标 `(bx, by, rx1, ry1, rx2, ry2)`  
2. **胜负判定传播**：  
   - 终结状态（黑棋在第一行/红黑重合/无法移动）直接标记胜负  
   - 非终结状态通过反向边建立博弈图，利用拓扑排序的 BFS 更新胜负态  
3. **步数计算**：必胜态取后继的最小步数，必败态取后继的最大步数  
4. **平局判定**：未被拓扑排序处理的剩余状态即为循环僵持  

### 解决难点  
- **状态爆炸**：通过红棋对称性剪枝（强制 `rx1 <= rx2`）减少状态数  
- **胜负传播顺序**：BFS 过程中优先处理必胜态，确保步数最优性  
- **环处理**：未被标记的状态自动判定为平局  

---

## 题解评分 (≥4星)  
1. **yllcm（5星）**  
   - **亮点**：代码简洁，通过 `id[]` 数组实现状态压缩，显式建图与 BFS 层次更新步数  
   - **代码可读性**：结构清晰，注释少但逻辑自洽  
2. **樱雪喵（4.5星）**  
   - **亮点**：强调红棋对称性剪枝，显式建图时处理红棋移动的等价性  
   - **调试提示**：提醒注意红棋重合的边界条件  
3. **cymrain07（4星）**  
   - **亮点**：使用 `hsh` 函数哈希化状态，通过 `bel[]` 数组标记当前行动方  

---

## 最优思路与技巧  
1. **红棋对称性剪枝**：强制 `rx1 <= rx2`，减少一半状态数  
2. **隐式建图**：不显式存储边，通过移动规则动态生成后继状态  
3. **胜负态传播**：  
   - 必胜态：存在至少一个必败后继  
   - 必败态：所有后继均为必胜态  
4. **步数优化**：BFS 队列中首次出现必胜态时更新最小步数，最后一次出现必败态时更新最大步数  

---

## 类似题目与套路  
1. **P6560 [SBCOI2020] 时光的流逝**：反向建图的拓扑排序博弈  
2. **P4101 [HEOI2014] 人人尽说江南好**：对称性剪枝与状态分析  
3. **P2734 [USACO3.3] 游戏 A Game**：双人博弈的最优步数计算  

---

## 代码核心片段  
```cpp
// yllcm 题解的关键代码（胜负态传播）
void bfs() {
    queue<int> q;
    for (int i = 0; i < tot; i++) if (vis[i]) q.push(i);
    while (!q.empty()) {
        int u = q.front(); q.pop();
        for (int i = head[u]; i; i = nxt[i]) {
            int v = to[i];
            if (vis[v]) continue;
            in[v]--;
            if (g[u] == 0) { // u是必败态，v标记为必胜
                g[v] = 1; f[v] = f[u] + 1;
                vis[v] = true; q.push(v);
            } else if (in[v] == 0) { // 所有后继为必胜，v标记为必败
                g[v] = 0; f[v] = f[u] + 1;
                vis[v] = true; q.push(v);
            }
        }
    }
}
```

---

## 可视化设计  
### 动画方案  
1. **棋盘绘制**：  
   - 使用 Canvas 绘制网格，黑棋用黑色方块，红棋用红色方块，障碍为灰色  
   - 当前操作方高亮（红方：红色边框，黑方：黑色边框）  
2. **状态传播动画**：  
   - 被标记为必胜态时，棋子闪烁绿色；必败态闪烁红色  
   - 拓扑队列中的状态用半透明覆盖色表示处理顺序  
3. **复古像素风格**：  
   - 8-bit 音效：状态更新时播放短促“滴”声，胜负判定时播放经典 FC 过关音效  
   - 像素字体显示步数，右侧面板展示当前状态胜负标记  

### 交互控制  
- **步进模式**：空格键单步执行 BFS 传播  
- **自动播放**：调整速度滑块控制 BFS 处理速度  
- **棋盘视角**：拖动棋盘可查看不同区域的状态标记  

---

## 个人心得摘录  
> **船酱魔王**：  
> “考试不要死磕 T1，不要对自己的代码能力过于自信... 在考场上因为一个红棋重合判断错误，爆零后痛定思痛。”  
> **核心教训**：边界条件（如红棋移动后的位置重合）需单独验证  

---

## 相似题目推荐  
1. **P6560**：弱化版，仅需胜负判定  
2. **P3182 [HAOI2016] 棋子攻击**：状态压缩与博弈结合  
3. **P2148 [SDOI2009] E&D**：对称性分析与胜负传播

---
处理用时：68.21秒
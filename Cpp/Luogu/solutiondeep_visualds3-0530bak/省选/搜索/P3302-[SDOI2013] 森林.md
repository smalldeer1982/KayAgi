# 题目信息

# [SDOI2013] 森林

## 题目描述

小 Z 有一片森林，含有 $N$ 个节点，每个节点上都有一个非负整数作为权值。初始的时候，森林中有 $M$ 条边。

小Z希望执行 $T$ 个操作，操作有两类：

 - `Q x y k` 查询点 $x$ 到点 $y$ 路径上所有的权值中，第 $k$ 小的权值是多少。此操作保证点 $x$ 和点 $y$ 连通，同时这两个节点的路径上至少有 $k$ 个点。
 - `L x y` 在点 $x$ 和点 $y$ 之间连接一条边。保证完成此操作后，仍然是一片森林。

为了体现程序的在线性，我们把输入数据进行了加密。设 $lastans$ 为程序上一次输出的结果，初始的时候 $lastans$ 为 $0$。

对于一个输入的操作 `Q x y k`，其真实操作为 `Q x^lastans y^lastans k^lastans`。

对于一个输入的操作 `L x y`，其真实操作为 `L x^lastans y^lastans`。其中 `^` 运算符表示异或，等价于 Pascal 中的 `xor` 运算符。

请写一个程序来帮助小 Z 完成这些操作。

## 说明/提示

**样例解释**

对于第一个操作 `Q 8 7 3`，此时 $lastans=0$，所以真实操作为 `Q 8^0 7^0 3^0`，也即 `Q 8 7 3`。点 $8$ 到点 $7$ 的路径上一共有 $5$ 个点，其权值为 $4\ 1\ 1\ 2\ 4$。这些权值中，第三小的为 $2$，输出 $2$，$lastans$ 变为 $2$。

对于第二个操作 `Q 3 5 1` ，此时 $lastans=2$，所以真实操作为 `Q 3^2 5^2 1^2`，也即 `Q 1 7 3`。点 $1$ 到点 $7$ 的路径上一共有 $4$ 个点，其权值为 $1\ 1\ 2\ 4$ 。这些权值中，第三小的为 $2$，输出 $2$，$lastans$ 变为 $2$。之后的操作类似。

-----
**数据范围**

| 测试点编号  | $N,M,T$ 的上界 |  `L` 操作   |  `Q` 操作  | 形态 |
| :---------: | :------------: | :---------: | :--------: | :--: |
|     $1$     |      $20$      |     N/A     |    N/A     | N/A  |
|     $2$     |     $200$      |     N/A     |    N/A     | N/A  |
|  $3\sim 4$  | $4\times 10^4$ | 无 `L` 操作 |    N/A     |  链  |
|  $5\sim 6$  | $8\times 10^4$ | 无 `L` 操作 |    N/A     |  链  |
|  $7\sim 9$  | $8\times 10^4$ | 无 `L` 操作 | 保证 $k=1$ | N/A  |
| $10\sim 11$ | $4\times 10^4$ |     N/A     | 保证 $k=1$ | N/A  |
| $12\sim 13$ | $8\times 10^4$ |     N/A     | 保证 $k=1$ | N/A  |
| $14\sim 15$ | $4\times 10^4$ | 无 `L` 操作 |    N/A     | N/A  |
| $16\sim 17$ | $8\times 10^4$ | 无 `L` 操作 |    N/A     | N/A  |
|    $18$     | $4\times 10^4$ |     N/A     |    N/A     | N/A  |
| $19\sim 20$ | $8\times 10^4$ |     N/A     |    N/A     | N/A  |

注：N/A 表示没有特殊性。

对于 $100\%$ 的测试数据，所有节点的编号在 $1\sim N$ 的范围内。节点上的权值 $\le 10^9$。$M<N$。

## 样例 #1

### 输入

```
1
8 4 8
1 1 2 2 3 3 4 4
4 7
1 8
2 4
2 1
Q 8 7 3
Q 3 5 1
Q 10 0 0
L 5 4
L 3 2
L 0 7
Q 9 2 5
Q 6 1 6```

### 输出

```
2 
2
1
4
2```

# AI分析结果



**算法分类：其他搜索（主席树+启发式合并）**

---

### **题解思路与核心难点**
- **核心思路**：  
  1. **主席树维护路径信息**：每个节点的主席树继承父节点，记录根到该节点的权值分布，查询时通过 `x+y-lca-fa(lca)` 四棵树差分得到路径信息。
  2. **启发式合并**：连边时将较小树合并到较大树中，暴力重构较小树的主席树和倍增数组，保证总复杂度为 $O(n \log^2 n)$。
  3. **倍增数组更新**：合并时需重新计算较小树节点的深度和祖先信息，确保 LCA 查询的正确性。

- **解决难点**：
  - **动态连边与 LCA 维护**：合并后需重新构建倍增数组，避免因树结构变化导致的错误。
  - **主席树版本管理**：每次合并后，较小树的节点基于新父节点重建主席树版本，保证路径信息正确。

---

### **题解评分（≥4星）**
1. **玫葵之蝶（5星）**：  
   - 详细说明启发式合并与倍增数组更新，代码结构清晰，注释完整。  
   - **关键代码**：在 `dfs` 中同时更新倍增数组和主席树，确保合并后信息正确。
2. **IC_QQQ（4星）**：  
   - 强调倍增数组的更新陷阱，提供测试用例分析，代码可读性高。  
   - **核心贡献**：指出倍增数组需预计算足够层数，避免 LCA 计算错误。
3. **ez_lcw（4星）**：  
   - 代码简洁，合并逻辑明确，适合快速实现。  
   - **亮点**：使用并查集维护树大小，合并时直接重构较小树。

---

### **最优技巧提炼**
1. **主席树差分查询**：利用四棵树差分快速计算路径权值分布。
2. **启发式合并优化**：将小树合并到大树，减少重构次数，保证复杂度。
3. **边合并边更新倍增数组**：在 `dfs` 过程中动态更新祖先信息，避免后续查询错误。

---

### **同类题目推荐**
1. **P2633 Count on a tree**：静态树路径第k小，同款主席树差分。
2. **P4197 Peaks**：路径第k大，需结合并查集与线段树合并。
3. **P3302 [SDOI2013]森林**：本题自身，练习动态树维护。

---

### **可视化与算法演示**
- **搜索过程动画**：
  - **节点合并**：用不同颜色标记小树节点逐步并入大树的流程。
  - **LCA计算**：高亮路径节点，显示倍增跳跃过程。
  - **主席树差分**：动态展示四棵树相加/相减得到路径信息。
- **复古像素风格**：
  - **Canvas绘制**：树节点以8位方块表示，合并时播放“连接音效”，查询时显示路径闪烁。
  - **音效触发**：节点访问（短促“滴”声），成功查询（胜利音效）。
- **交互控制**：支持暂停/步进，调整合并速度，对比BFS/DFS遍历差异。

---

### **核心代码片段（启发式合并+主席树）**
```cpp
void dfs(int u, int father, int rt) {
    st[u][0] = father;
    for (int k = 1; k <= 16; k++) // 更新倍增数组
        st[u][k] = st[st[u][k-1]][k-1];
    son[rt]++; // 更新树大小
    insert(root[u], root[father], 1, size, Hash(a[u])); // 主席树继承
    for (int i = head[u]; i; i = e[i].next) {
        int v = e[i].to;
        if (v != father) dfs(v, u, rt);
    }
}

// 合并两棵树
void link(int x, int y) {
    int u = find(x), v = find(y);
    if (son[u] < son[v]) swap(u, v);
    dfs(y, x, u); // 重构小树的主席树和倍增数组
}
```

---

### **总结**
本题需结合主席树维护路径信息与启发式合并处理动态连边，难点在于高效更新树结构和保证LCA正确。核心思想是通过差分查询和暴力重构小树实现复杂度平衡。可视化设计可增强对合并与查询过程的理解，复古风格提升学习趣味性。

---
处理用时：76.63秒
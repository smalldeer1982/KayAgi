# 题目信息

# 「Stoi2029」以父之名

## 题目背景

> 以父之名判决  
> 那感觉没有适合字汇  
> 就像边笑边掉泪  
> 凝视着完全的黑  
> 阻挡悲剧蔓延的悲剧会让我沉醉  
> ——《[以父之名](https://www.bilibili.com/video/BV1fx411N7bU?p=36)》

## 题目描述

地狱里有 $n$ 个罪人在等待判决，编号为 $1$ 至 $n$。罪人们之间有 $m$ 条罪的联系，编号为 $1$ 至 $m$，每条联系 的值为 $1$ 或 $2$ 且恰好连接两个罪人。

称一个罪人的自负度为他和其他所有罪人之间联系的值之和。两个罪人之间可能不止有一条联系，此时这些联系的值都应该被计算。由于这些罪人承受了太多的罪恶，他们变得不和谐。具体地，每个罪人的自负度都是奇数。

现在，神明将要对他们进行判决。判决的具体方式为：将每条联系都进行定向，使得这条联系所连接的两个罪人中的一个受到惩罚，另一个受到救赎，它们的值均为这条联系的值。

由于神明秉承父的仁慈，希望罪人们更加均等地接受惩罚和救赎，于是他规定判决后每个罪人所受到的惩罚和救赎值总和之差的绝对值必须恰好为 $1$。

由于神明工作繁忙，因此他以父之名要求你为他找到一种判决的方法。由于父的指示不会有错，所以一定存在一种这样的方法。

---

#### 题意简述

给定一个 $n$ 个点 $m$ 条边的无向图，边权均为 $1$ 或 $2$。保证每个点所相连的边权值之和均为奇数。你需要将这些边定向，使每个点的入边权值和与出边权值和之差的绝对值恰为 $1$。保证有解。输出任意一种方案。

## 说明/提示

#### 样例解释

定向后的图如下：

![](https://cdn.luogu.com.cn/upload/image_hosting/uhz96nbm.png)

更多样例详见题目附件 `trial_sample.zip`。

------

#### 数据范围

**本题采用捆绑测试。**

- 特殊性质 A：边权均为 $1$，且任意两点之间只存在一条简单路径，且没有重边。
- 特殊性质 B：同一个点至多只有一条边权为 $1$ 和一条边权为 $2$ 的边相连。

| Subtask | 分值 | $1\le n \le$ | $1\le m \le$ | 特殊性质 | 
| :-: | :-: | :-: | :-: | :-: |
| $1$ | $7$ | $10$ | $15$ | 无 | 
| $2$ |  $20$ |$10^3$ | $3\times10^3$ | 无 |
| $3$ |  $20$ |$3 \times 10^5$ | $3 \times 10^5$ | A |
| $4$ | $20$ |$3 \times 10^5$ | $3 \times 10^5$ | B | 
| $5$ |  $33$ |$10^6$ | $3 \times 10^6$ | 无 |

对于 $100\%$ 的数据，$1 \le u_i,v_i \le n \le 10^6$，$1 \le m \le 3 \times 10^6$，$w_i \in \{1,2\}$。

在题目附件 `trial_sample.zip` 中：

- `trial_sample1.in` 即为样例 #1。
- `trial_sample2.in` 满足特殊性质 A。
- `trial_sample3.in` 满足特殊性质 B。
- `trial_sample4.in` 不满足特殊性质。

另外该目录下还有 `checker.exe`。

------

#### 提示

**本题输入输出量较大，请使用较快的输入输出方式。**

本题提供 [Special Judge 源码](https://www.luogu.com.cn/paste/7albhubs)和 `checker.exe`，供选手调试。Windows 下使用方法为:  
命令行在目标文件夹输入指令：
```
checker.exe data.in data.out data.out
```
其中 `data.in` 是输入数据文件，`data.out` 是程序运行结果文件。观察评判结果即可。

- `Perfect answer.` 表示答案正确。
-  `Wrong answer on node x, and the difference is d.` 表示答案错误，其中节点 $x$ 的入边权值和与出边权值和之差的绝对值为 $d$ 而不为 $1$。
- `Invalid answer.` 表示输出的字符串长度不正确或输出非法字符。

请务必保证**输出格式正确**，否则 Special Judge 可能会返回 Unknown Error 等不可预估的结果。

## 样例 #1

### 输入

```
4 5
1 2 1
1 3 2
2 3 1
2 4 1
4 1 2
```

### 输出

```
00100
```

# AI分析结果



### 唯一算法分类
**DFS（基于欧拉回路构造）**

---

### 综合分析与结论
**核心思路**：  
题目要求将边定向使得每个点的入边权值和与出边权值和之差的绝对值为 1。通过添加虚点构造欧拉回路，利用 DFS 遍历优先选择相同权值的边，确保每个点差值为 1。

**难点与解决**：  
1. **度数奇偶性**：每个点度数之和为奇数，但欧拉回路要求全偶数度数。通过虚点连接奇度数点，将总度数变为偶数。  
2. **权值配对**：DFS 遍历时优先选择与入边权值相同的出边，保证抵消后差值为 1。  
3. **高效实现**：需用链式前向星存储边，并通过当前弧优化避免重复访问。

**可视化设计**：  
1. **节点与边**：用像素风格绘制节点（红点表示虚点），边按权值（1/2）区分颜色（绿/蓝）。  
2. **DFS 过程**：展示当前访问节点（黄色高亮），已访问边标记为灰色，优先选择同色边。  
3. **音效与动画**：  
   - 访问新节点时播放“滴”声，选择同权值边时播放“咔”声。  
   - 完成回路后播放胜利音效，虚边自动消失。  
4. **交互控制**：支持步进执行，可调节速度观察欧拉路径形成。

---

### 题解清单（≥4星）

1. **Konnyaku_LXZ（⭐⭐⭐⭐⭐）**  
   - **亮点**：简洁的欧拉回路构造，优先权值匹配策略，代码高效。  
   - **关键代码**：  
     ```cpp
     void dfs(int u, int pre) {
         while (now[u][pre] && e[now[u][pre]].ans != -1) 
             now[u][pre] = nxt[now[u][pre]];
         if (!now[u][pre]) pre = 3 - pre; // 切换权值
         e[now[u][pre]].ans = 0; // 定向当前边
         dfs(e[now[u][pre]].to, pre); // 递归处理
     }
     ```

2. **Leasier（⭐⭐⭐⭐）**  
   - **亮点**：分离权值 1/2 的边分别处理，双图结构清晰。  
   - **关键代码**：  
     ```cpp
     void dfs(int u, int op) {
         for (int i = cur_edge[u][op]; i < vec[u][op].size();) {
             int v = vec[u][op][i].to;
             ans[vec[u][op][i].id] = 0; // 记录方向
             dfs(v, op); // 继续遍历
         }
     }
     ```

3. **DengDuck（⭐⭐⭐⭐）**  
   - **亮点**：虚边动态添加，代码简短易实现。  
   - **关键代码**：  
     ```cpp
     for (int i = 1; i <= n; i++) 
         if (deg[i] % 2) add(n+1, i, 1); // 连接虚点
     dfs(1, 1); // 启动欧拉回路
     ```

---

### 最优思路与技巧提炼
1. **虚点构造欧拉回路**：将奇度数点连向虚点，使全图度数变为偶数。  
2. **权值优先策略**：DFS 遍历时优先选择与入边同权值的边，确保抵消后差值为 1。  
3. **链式前向星优化**：用 `now` 数组记录当前处理到的边，避免重复访问。

---

### 同类型题推荐
1. **P7771（欧拉路径）**：求有向图的欧拉路径。  
2. **P2731（骑马修栅栏）**：无向图欧拉回路模板题。  
3. **CF1610F**：类似权值定向问题，需构造合法方案。

---

### 个人心得摘录
> “这题有亿点点卡常。” —— Konnyaku_LXZ  
> **总结**：链式前向星的当前弧优化是避免超时的关键，需注意递归深度可能导致的栈溢出。

---

### 可视化与算法演示
**动画方案**：  
1. **初始化**：显示原图节点和边，虚点用红色标记。  
2. **DFS 遍历**：当前节点高亮为黄色，已访问边变灰，优先选择同色边（绿色或蓝色）。  
3. **虚边处理**：完成回路后虚边自动隐藏，展示最终定向结果。  

**复古风格实现**：  
```javascript
// 伪代码：Canvas 绘制像素节点
function drawNode(x, y, color) {
    ctx.fillStyle = color;
    ctx.fillRect(x * 16, y * 16, 14, 14); // 16x16 像素方块
}
// 播放音效
function playSound(type) {
    if (type === 'visit') new Audio('blip.wav').play();
    else if (type === 'success') new Audio('fanfare.wav').play();
}
```

---

**核心结论**：通过虚点构造欧拉回路并优先匹配权值的 DFS 策略，是解决此类图定向问题的最优方法，兼具高效性与简洁性。

---
处理用时：71.97秒
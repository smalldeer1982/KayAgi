# 题目信息

# 「SWTR-8」扫雷计数

## 题目背景

2020 年 6 月的某一天，小 A 在等待网络加载的过程中打开了扫雷，从此便一发不可收拾。

小 A 是一个任何事都喜欢做到极致的人，玩游戏也不例外：他不惜花费大量时间不断尝试打破记录。一个个夜晚就在熟练的 `Alt + G + N` 中过去了。

> “这把有戏，前五十个雷只用了不到四十五秒”。他心里想着，紧握鼠标的手微微颤抖。
>
> “快，快，快 …… 还有最后二十个雷 ……”。
>
> 游戏的关键时刻，他难以按捺激动的心情。直到他遇到了二选一。
>
> 他愣了一下，随后迅速按下最后两块空地当中的一个。
> 
> 一束横贯屏幕的白色激光缓缓扫过，他知道自己打破了记录 …… [整整十二秒](https://cdn.luogu.com.cn/upload/image_hosting/1seixkiz.png)！巨大的惊喜让他跳了起来。
>
> 2020.6.19

## 题目描述

以下是简化后的扫雷游戏规则：

- 定义连通为 **八连通**。
- 如果打开雷，所有雷 **全部同时爆炸**，游戏结束。
- 如果打开空地，若其周围没有雷，则递归打开周围八个方块。
- [如图](https://cdn.luogu.com.cn/upload/image_hosting/kjjqs2v1.png)，点开任意红色框内方块均形成当前局面。


给定一张 $n\times m$ 的初始地图。小 A 决定搜出所有可能的局面，并找到最优鼠标点击顺序，从而速通这张地图。

为设置合适的数组大小，小 A 需要知道有多少种不同局面。对 $998244353$ 取模。

- 如果方块是雷，它有爆炸和未爆炸两种状态；如果方块是空地，它有打开和未打开两种状态。
- 两个局面不同，当且仅当存在方块状态不同。
- 保证周围无雷的空地形成不超过 $37$ 个连通块。

## 说明/提示

**「样例解释」**

用 `.` 表示未打开的方块，`+` 表示打开的方块，`*` 表示未爆炸的雷，`!` 表示爆炸的雷。

样例 1 的所有 4 种局面为 `.*   +*   .!   +!`。

样例 2 的所有 20 种局面为
```plain
0
..*
...
   
1
++*  .+*  ..!  ..*  ..*
++.  ...  ...  .+.  ..+  
   
2
++!  ++*  .+!  .+*  .+*  ..!  ..!  ..*
++.  +++  ...  .+.  ..+  .+.  ..+  .++
   
3
++!  .+!  .+!  .+*  ..!
+++  .+.  ..+  .++  .++
   
4
.+!
.++
```

数字描述了最少点击次数。

**「数据范围与约定」**

**本题采用捆绑测试。**

设周围无雷的空地形成 $d$ 个连通块。

- Subtask #1（15 points）：$nm\leq 21$。
- Subtask #2（4 points）：地图中只有一个雷。
- Subtask #3（5 points）：$d = 0$。
- Subtask #4（6 points）：$d = 1$。
- Subtask #5（7 points）：$d = 2$。
- Subtask #6（8 points）：$d \leq 17$。依赖 Subtask #1，#2，#3，#4，#5。
- Subtask #7（9 points）：$d \leq 23$。依赖 Subtask #6。
- Subtask #8（16 points）：$d\leq 27$。依赖 Subtask #7。
- Subtask #9（17 points）：$d\leq 33$。依赖 Subtask #8。
- Subtask #10（13 points）：无特殊限制。依赖 Subtask #9。

对于 $100\%$ 的数据：

- $1\leq n, m\leq 500$。
- $0\leq d\leq 37$。
- **不保证** 地图中有雷或空地。

**「题目来源」**

- [Sweet Round 8](https://www.luogu.com.cn/contest/73382) D
- Idea & Solution：[Alex_Wei](https://www.luogu.com.cn/user/123294)。
- Tester：[chenxia25](https://www.luogu.com.cn/user/138400) & [asmend](https://www.luogu.com.cn/user/21658)。

感谢 [Elegia](https://www.luogu.com.cn/user/21423) 对本题做出的贡献。

## 样例 #1

### 输入

```
0
1 2
.*```

### 输出

```
4```

## 样例 #2

### 输入

```
0
2 3
..*
...```

### 输出

```
20```

## 样例 #3

### 输入

```
0
4 4
..*.
.*..
*...
....```

### 输出

```
2112```

## 样例 #4

### 输入

```
0
7 6
..*...
......
*...**
......
..*...
......
......```

### 输出

```
5041530```

# AI分析结果



# 算法分类
其他搜索

## 题解思路与解决难点
### 核心思路
将周围无雷的空地连通块建模为图中的节点，周围有雷且相邻多个连通块的格子视为边。通过状态压缩搜索所有可能的连通块选择方案，并计算其对最终状态的贡献。

### 难点对比
1. **连通块交互建模**：每个周围有雷的格子可能连接至多两个连通块，需处理跨连通块的影响。
2. **指数级状态优化**：面对最多37个连通块，通过平面图边数限制（最多3n条边）和分治搜索策略降低复杂度。
3. **贡献叠加方式**：雷爆炸贡献独立因子，连通块选择通过乘积形式叠加，需处理递归打开的空地状态。

### 解决策略
- **平面图分治**：将图分解为独立子图分别处理，利用哈希表缓存子问题结果。
- **位掩码状态压缩**：用`bitset`表示已处理的连通块，动态规划剪枝。
- **贡献预计算**：预处理每个连通块和边的权值（2的幂次），搜索中累乘。

## 题解评分（≥4星）
1. **dead_X 题解（5星）**
   - **亮点**：平面图边数优化+分治搜索，最慢点仅25ms。
   - **代码**：位运算处理状态压缩，哈希表优化记忆化。
   - **心得**：通过度排序选择搜索顺序显著提升效率。

## 最优思路提炼
1. **连通块-边模型**：将每个连通块视为节点，跨块影响的格子建模为边。
2. **权值乘积叠加**：每个连通块贡献2^size，边贡献2^count，独立处理选择与否的乘积。
3. **分治搜索策略**：按节点度排序，优先处理高连接节点，分解图为独立子图。

## 类似题目
1. [P1278 单词游戏](https://www.luogu.com.cn/problem/P1278)（状态压缩+搜索）
2. [P3959 宝藏](https://www.luogu.com.cn/problem/P3959)（图的分层搜索）
3. [P2831 愤怒的小鸟](https://www.luogu.com.cn/problem/P2831)（状态压缩+几何建模）

## 可视化设计
### 复古像素动画方案
1. **网格绘制**：Canvas绘制500x500网格，连通块用不同色块表示（8色调色板）。
2. **搜索过程**：
   - **当前节点**：闪烁红色边框
   - **已处理边**：蓝色线条动态延伸
   - **贡献计算**：右侧面板实时显示当前权值乘积
3. **音效**：
   - 选择节点：8-bit "哔"声
   - 完成子图：上升音阶
   - 错误选择：低沉嗡鸣

### 核心代码片段
```cpp
// 分治搜索核心逻辑
int dfs(int x, const bs& s) {
    if (x == n) return 1;
    if (mp[x].count(s)) return mp[x][s];
    
    // 处理选择当前连通块
    bs g = s;
    int u = id[x], ex = 1;
    g[u] = 1;
    for (int v : e[u]) {
        if (rk[v] < rk[u] && !g[to[u][v]]) {
            ex = 1ll * ex * emul[u][v] % p;
            g[to[u][v]] = 1;
        }
    }
    
    // 递归计算子问题
    int res = 0;
    if (sg[x].size() > 1) {
        int z = 1;
        for (bs &i : sg[x]) 
            z = 1ll * z * dfs(x+1, g|i) % p;
        res = (res + z) % p;
    }
    // ...（处理不选择的情况）
    return mp[x][s] = res;
}
```

## 结论
通过将扫雷局面抽象为平面图搜索问题，结合分治策略与状态压缩，在O(2^d)复杂度下高效求解。其核心在于建模时的创造性转化与搜索顺序的优化选择。

---
处理用时：69.38秒
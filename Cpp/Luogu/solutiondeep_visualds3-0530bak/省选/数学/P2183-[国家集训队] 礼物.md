# 题目信息

# [国家集训队] 礼物

## 题目背景

一年一度的圣诞节快要来到了。每年的圣诞节小 E 都会收到许多礼物，当然他也会送出许多礼物。不同的人物在小 E 心目中的重要性不同，在小 E 心中分量越重的人，收到的礼物会越多。

## 题目描述

小 E 从商店中购买了 $n$ 件礼物，打算送给 $m$ 个人，其中送给第 $i$ 个人礼物数量为 $w_i$。请你帮忙计算出送礼物的方案数（两个方案被认为是不同的，当且仅当存在某个人在这两种方案中收到的礼物不同）。由于方案数可能会很大，你只需要输出模 $P$ 后的结果。


## 说明/提示

### 样例 1 解释
以 `/` 分割，`/` 前后分别表示送给第一个人和第二个人的礼物编号。$12$ 种方案详情如下：
```plain
1/23 1/24 1/34
2/13 2/14 2/34
3/12 3/14 3/24
4/12 4/13 4/23
```
### 数据规模与约定
设 $P= \prod_{i=1}^t p_i^{c_i}$，$p_i$ 为质数。

对于 $15\%$ 的数据，$n\leq 15$，$m\leq 5$，$p_i^{c_i}\leq 10^5$。

在剩下的 $85\%$ 数据中，约有 $60\%$ 的数据满足 $t\leq 2$，$c_i=1$，$p_i\leq 10^5$，约有 $30\%$ 的数据满足 $p_i\leq 200$。

对于 $100\%$ 的数据，$1\leq n\leq 10^9$，$1\leq m\leq 5$，$1\leq p_i^{c_i}\leq 10^5$，$1\leq w_i \leq P\leq 10^9$。


## 样例 #1

### 输入

```
100
4 2
1
2
```

### 输出

```
12```

## 样例 #2

### 输入

```
100
2 2
1
2```

### 输出

```
Impossible
```

# AI分析结果



## 数学分类选择
**组合数学**

---

## 题解思路、算法要点与解决难点

### 核心数学逻辑
本题要求计算多个组合数乘积模非质数的结果，核心是扩展卢卡斯定理 (ExLucas)。难点在于：
1. **大数阶乘取模**：当模数非质数时，无法直接使用逆元。需将模数分解为质因数幂后分别处理。
2. **质因子提取与递归计算**：将阶乘中的质因子分离，递归计算剩余部分的乘积。
3. **中国剩余定理合并**：对每个质因子幂计算结果后合并为最终答案。

### 关键公式与步骤
1. **组合数公式**：
   \[
   \text{ans} = \prod_{i=1}^m C_{n - \sum_{j=1}^{i-1} w_j}^{w_i} \mod P
   \]
2. **阶乘分解**：
   \[
   n! = p^k \cdot \left( \prod_{\substack{1 \le i \le p^k \\ i \not\equiv 0 \ (\text{mod}\ p)}} i \right)^{\left\lfloor \frac{n}{p^k} \right\rfloor} \cdot \text{剩余部分} \cdot \left( \left\lfloor \frac{n}{p} \right\rfloor! \right)
   \]
3. **中国剩余定理合并**：
   \[
   \text{ans} \equiv \sum \left( a_i \cdot \frac{P}{p_i^{c_i}} \cdot \text{inv}\left( \frac{P}{p_i^{c_i}}, p_i^{c_i} \right) \right) \mod P
   \]

---

## 题解评分 (≥4星)

### 作者：___new2zy___ (★★★★★)
- **亮点**：详细推导扩展卢卡斯原理，代码模块化清晰，包含阶乘递归、质因子计数等关键函数。
- **代码**：完整实现ExLucas分解与合并逻辑，注释丰富。

### 作者：eee_hoho (★★★★☆)
- **亮点**：简洁的公式推导，代码中重点突出组合数拆分和递归计算。
- **不足**：缺少部分调试注释。

### 作者：CG__HeavenHealer (★★★★☆)
- **亮点**：代码结构紧凑，包含快速幂和逆元优化，适合快速参考。
- **不足**：理论推导较少。

---

## 最优思路或技巧提炼

### 核心步骤
1. **分解模数**：将P分解为质因数幂形式 \( P = \prod p_i^{c_i} \)。
2. **计算组合数模 \( p_i^{c_i} \)**：
   - 提取阶乘中的质因子p，递归计算剩余部分。
   - 使用逆元和快速幂处理非因子部分。
3. **合并结果**：应用中国剩余定理合并各质因子幂的解。

### 优化技巧
- **预处理阶乘**：对每个质因数幂预处理部分乘积，减少重复计算。
- **递归深度控制**：分解阶乘时通过递归快速剥离质因子。

---

## 同类型题及通用套路

### 常见套路
- **模数分解**：处理非质数模时优先分解质因数。
- **质因子剥离**：递归计算阶乘中质因子的贡献。
- **逆元与合并**：使用扩展欧几里得求逆元，中国剩余定理合并。

### 推荐题目
1. **P3807**：卢卡斯定理模板题。
2. **P4720**：扩展卢卡斯定理直接应用。
3. **P3301**：组合数取模与质因数分解结合。

---

## 可视化与算法演示设计

### 动画流程
1. **分解模数P**：像素动画展示质因数分解过程，如P=100分解为\(2^2 \times 5^2\)。
2. **阶乘递归计算**：
   - 高亮当前质因子p，递归剥离p的倍数。
   - 显示剩余部分的乘积计算。
3. **合并结果**：中国剩余定理分步合并，颜色标记各分量。

### 复古像素风格
- **Canvas绘制**：用16色块表示质因子，递归树结构展示阶乘分解。
- **音效设计**：
  - 分解成功：8-bit上升音效。
  - 错误提示：短促蜂鸣声。

---

## 核心代码实现

### 扩展卢卡斯关键函数
```cpp
int exLucas(int n, int m, int p) {
    int res = 0, x = p;
    for (int i = 2; i*i <= x; ++i) {
        if (x % i == 0) {
            int pk = 1;
            while (x % i == 0) pk *= i, x /= i;
            res = (res + crt(C(n, m, i, pk), pk, p)) % p;
        }
    }
    if (x > 1) res = (res + crt(C(n, m, x, x), x, p)) % p;
    return res;
}
```

### 阶乘计算与质因子剥离
```cpp
int factorial(int n, int p, int pk) {
    if (n == 0) return 1;
    int ans = 1;
    for (int i = 1; i <= pk; ++i) 
        if (i % p) ans = ans * i % pk;
    ans = pow(ans, n/pk, pk);
    for (int i = 1; i <= n%pk; ++i) 
        if (i % p) ans = ans * i % pk;
    return ans * factorial(n/p, p, pk) % pk;
}
```

---

## 总结
本题通过扩展卢卡斯定理将组合数问题转化为质因子幂下的计算，结合递归剥离和合并策略，有效解决了大数阶乘模非质数的难题。实现时需注意质因子分解的完整性和递归效率，适合作为组合数学与数论的综合训练。

---
处理用时：71.93秒
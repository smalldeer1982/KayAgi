# 题目信息

# [ZJOI2011] 看电影

## 题目描述

到了难得的假期，小白班上组织大家去看电影。但由于假期里看电影的人太多，很难做到让全班看上同一场电影。最后大家在一个偏僻的小胡同里找到了一家电影院，但这家电影院分配座位的方式很特殊，具体方式如下：

电影院的座位共有 $K$ 个，并被标号为 $1 \sim K$。每个人买完票后会被随机指定一个座位，具体来说是从 $1 \sim K$ 中等概率随机选取一个正整数，设其为 $L$。

如果编号 $L$ 的座位是空位，则这个座位就分配给此人，否则将 $L$ 加一，继续前面的步骤；如果不存在编号 $L$ 的座位，则该人只能站着看电影，即所谓的站票。

小白班上共有 $N$ 人（包括小白自己），作为数学爱好者，小白想知道全班都能够有座位的概率是多少。


## 说明/提示

对于 $100 \%$ 的数据，$1 \leq T \leq 50$，$1 \leq N,K \leq 200$。

## 样例 #1

### 输入

```
3
1 1
2 1
2 2```

### 输出

```
1 1
0 1
3 4
```

# AI分析结果



## 算法分类
**组合数学**

---

## 题解思路与解决难点
### 核心数学方法
**关键公式推导**：  
通过构造环形座位模型，将问题转化为圆排列问题：
1. 虚构一个座位 $k+1$，将座位连成环，总排列数为 $(k+1)^n$  
2. 环的等价排列数为 $(k+1)^{n-1}$（去重循环移位）  
3. 合法方案需满足虚构座位无人，即从剩余的 $k+1-n$ 个空位断开环，故乘以 $(k+1-n)$  
4. 概率公式为：  
$$
\frac{(k+1)^{n-1}(k+1-n)}{k^n}
$$

**解决难点**：  
- **环形模型构造**：通过增加虚拟座位避免边界判断  
- **高精度计算**：分子分母可能极大，需实现高精度乘法和约分  
- **约分优化**：仅需计算 $(k+1-n)$ 与 $k^n$ 的公约数，避免全量高精度 GCD

---

## 题解评分（≥4星）
### SoyTony（4.5星）
- **亮点**：  
  - 完整推导环形模型数学逻辑  
  - 高精度实现包含快速幂、模运算、约分优化  
  - 代码结构清晰，注释详细  
```cpp
// 关键代码：高精度快速幂与约分
largenum q_pow(largenum x, int p) {
    largenum res; // 高精度快速幂
    while(p) {
        if(p&1) res = res * x;
        x = x * x; p >>= 1;
    }
    return res;
}
int g = tmp % m; // 低精度优化公约数计算
```

### 一只书虫仔（4星）
- **亮点**：  
  - Python 代码简洁，利用内置高精度  
  - 特判处理清晰，逻辑直接  
```python
# Python 代码核心逻辑
if n > k: print("0 1")
else:
    c = ((k+1)**(n-1)) * (k+1-n)
    d = k ** n
    e = math.gcd(c, d)
```

### K8He（4星）
- **亮点**：  
  - 压位高精度实现，性能优化  
  - 分步约分减少计算量  
```cpp
// 压位高精度乘法（16位进制）
void mul1(int x) {
    int pre = 0;
    for(int i=1; i<=len1; i++) {
        tmp = op1[i] * x + pre;
        op1[i] = tmp % mod;
        pre = tmp / mod;
    }
    if(pre) op1[++len1] = pre;
}
```

---

## 最优思路提炼
1. **环形模型转换**：  
   - 虚构座位 $k+1$ 连成环，避免边界条件判断  
   - 通过圆排列去重得到 $(k+1)^{n-1}$  
2. **合法方案计算**：  
   - 从 $k+1-n$ 个空位断开环，保证虚构座位无人  
3. **高精度优化**：  
   - 仅对 $(k+1-n)$ 与 $k^n$ 求公约数，避免全量高精度运算  

---

## 同类型题与套路
**通用组合数学套路**：  
- **圆排列去重**：处理循环等价性问题（如 [P2523](https://www.luogu.com.cn/problem/P2523)）  
- **虚拟元素构造**：添加辅助元素简化边界条件（如本题的 $k+1$ 号座位）  
- **高精度优化**：分块压位、模运算降维  

**推荐题目**：  
1. [P2523 Problem c](https://www.luogu.com.cn/problem/P2523)（座位合法性判定）  
2. [P1386 座位安排](https://www.luogu.com.cn/problem/P1386)（环形排列计数）  
3. [P2152 SDOI2009 SuperGCD](https://www.luogu.com.cn/problem/P2152)（高精度优化）

---

## 可视化设计
### 动画演示步骤
1. **环形模型构建**：  
   - 初始显示 $k$ 个座位，动态添加虚拟座位 $k+1$ 并连成环  
   - 颜色标记虚拟座位为半透明  
2. **排列过程**：  
   - 随机生成 $n$ 个初始位置，动态展示向后寻找座位的过程  
   - 合法时标记绿色，冲突时红色闪烁提示  
3. **断环操作**：  
   - 高亮 $k+1-n$ 个空位，动态断开环并展开为链  
   - 显示公式更新：$(k+1)^{n-1} \times (k+1-n)$  

### 复古像素风格
- **Canvas 绘制**：  
  - 座位用 16x16 像素方块表示，已占座红色，空座绿色  
  - 虚拟座位灰色半透明，环形连接线为蓝色虚线  
- **音效**：  
  - 成功找到座位时播放 8-bit 上升音效  
  - 冲突时播放短促 "error" 音效  

### 交互功能
- **步进控制**：按空格键逐步执行排列、断环、公式更新  
- **自动模式**：AI 模拟不同 $n,k$ 组合，对比结果差异  

---

## 核心代码实现
### SoyTony 的高精度快速幂
```cpp
largenum q_pow(largenum x, int p) {
    largenum res;
    res.num[0] = res.num[1] = 1; // 初始化为单位元
    while(p) {
        if(p & 1) res = res * x; // 高精度乘法
        x = x * x;
        p >>= 1;
    }
    return res;
}
```

### 一只书虫仔的 Python 约分
```python
import math
n, k = map(int, input().split())
if n > k:
    print("0 1")
else:
    numerator = (k+1)**(n-1) * (k+1 -n)
    denominator = k**n
    gcd = math.gcd(numerator, denominator)
    print(f"{numerator//gcd} {denominator//gcd}")
```

---

## 个人心得摘录
> "构造环形模型时，突然意识到虚拟座位可以统一处理边界条件，避免了复杂的逐座位检查。这种转化思维在组合题中非常关键。"  
> —— SoyTony

> "Python 的高精度特性让代码简洁，但要注意特判 $n>k$，否则会输出负数导致 WA。"  
> —— 一只书虫仔

---
处理用时：77.37秒
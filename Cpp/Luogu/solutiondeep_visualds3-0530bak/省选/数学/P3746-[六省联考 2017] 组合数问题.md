# 题目信息

# [六省联考 2017] 组合数问题

## 题目描述

组合数 $C_n^m$ 表示的是从 $n$ 个互不相同的物品中选出 $m$ 个物品的方案数。举个例子， 从 $(1, 2, 3)$ 三个物品中选择两个物品可以有 $(1, 2)$，$(1, 3)$，$(2, 3)$ 这三种选择方法。根据组合数的定义，我们可以给出计算组合数  $C_n^m$  的一般公式：

$$ C_n^m = \frac {n!} {m! \ (n - m)!}  $$

其中 $n! = 1 \times 2 \times \cdots \times n$。（特别地，当 $n = 0$ 时，$n! = 1$；当 $m > n$ 时，$C_n^m = 0$。）

小葱在 NOIP 的时候学习了 $C_i^j$ 和 $k$ 的倍数关系，现在他想更进一步，研究更多关于组合数的性质。小葱发现，$C_i^j$ 是否是 $k$ 的倍数，取决于 $C_i^j \bmod k$ 是否等于 $0$，这个神奇的性质引发了小葱对 $\mathrm{mod}$ 运算（取余数运算）的兴趣。现在小葱选择了是四个整数 $n, p, k, r$，他希望知道

$$\left( \sum_{i = 0}^\infty C_{nk}^{ik + r} \right) \bmod p,$$

即

$$\left( C_{nk}^{r} + C_{nk}^{k + r} + C_{nk}^{2k + r} + \cdots + C_{nk}^{(n - 1)k + r}  + C_{nk}^{nk + r} + \cdots \right) \bmod p$$

的值。

## 说明/提示

对于 $30\%$ 的测试点，$1 \leq n, k \leq 30$，$p$ 是质数；   
对于另外 $5\%$ 的测试点，$p = 2$；  
对于另外 $5\%$ 的测试点，$k = 1$；  
对于另外 $10\%$ 的测试点，$k = 2$；  
对于另外 $15\%$ 的测试点，$1 \leq n \leq 10^3, 1 \leq k \leq 50$，$p$ 是质数；  
对于另外 $15\%$ 的测试点，$1 \leq n \times k \leq 10^6$，$p$ 是质数；  
对于另外 $10\%$ 的测试点，$1 \leq n \leq 10^9, 1 \leq k \leq 50$，$p$ 是质数；  
对于 $100\%$ 的测试点，$1 \leq n \leq 10^9, 0 \leq r < k \leq 50, 2 \leq p \leq 2^{30} - 1$。


## 样例 #1

### 输入

```
2 10007 2 0```

### 输出

```
8```

## 样例 #2

### 输入

```
20 10007 20 0```

### 输出

```
176```

# AI分析结果



1. **算法分类**  
   组合数学

2. **题解思路与难点分析**  
   **核心思路**：将组合数求和转换为多项式系数提取问题，利用循环卷积快速幂加速计算。  
   **关键公式**：  
   $$ \sum_{i\equiv r\ (\text{mod}\ k)} \binom{nk}{i} = [x^r]\left((1+x)^{nk} \bmod (x^k-1)\right) $$  
   **解决难点**：  
   - 发现组合数求和对应生成函数模意义下的循环卷积特性  
   - 将指数级运算转换为可快速计算的矩阵/多项式快速幂形式  
   - 处理模运算中的余数周期性问题  

3. **题解评分（≥4星）**  
   ⭐⭐⭐⭐⭐ **jiangly**：生成函数+循环卷积快速幂，O(k²logn) 时间最优  
   ⭐⭐⭐⭐ **Karry5307**：预处理杨辉三角优化循环卷积，代码可读性较强  
   ⭐⭐⭐⭐ **Marser**：矩阵快速幂思路直观，时间复杂度 O(k³logn) 仍可接受  

4. **最优思路实现**  
   核心代码（jiangly 解法）：
   ```cpp
   vector<int> operator*(const vector<int> &lhs, const vector<int> &rhs) {
       vector<int> result(k);
       for (int i = 0; i < k; ++i)
           for (int j = 0; j < k; ++j)
               result[(i + j) % k] = (result[(i + j) % k] + 1LL * lhs[i] * rhs[j]) % p;
       return result;
   }
   ```

5. **同类题目推荐**  
   - P3803 【模板】多项式乘法（FFT）  
   - P4929 【模板】矩阵快速幂  
   - P3338 [ZJOI2014]力（生成函数应用）

6. **可视化设计**  
   **像素动画方案**：  
   - 左侧显示 (1+x)^m 展开式，右侧显示模 x^k-1 后的多项式  
   - 快速幂步骤分解：  
     1. 初始化多项式 a = [1,1,0,...]  
     2. 每次平方操作：显示卷积过程，颜色标记相加项  
     3. 最终提取 x^r 系数时闪烁高亮  
   - 音效设计：  
     - 卷积运算时播放 8-bit 合成音  
     - 完成快速幂时播放经典 FC 过关音效  

7. **复古游戏化实现片段**  
   ```javascript
   // 生成函数快速幂动画
   class PolynomialAnim {
       constructor(k) {
           this.canvas = document.createElement('canvas');
           this.ctx = this.canvas.getContext('2d');
           this.k = k;
           this.pixels = [];
       }

       drawStep(coeff, stepName) {
           // 绘制像素化系数矩阵
           coeff.forEach((c, i) => {
               this.ctx.fillStyle = `hsl(${c*30},70%,50%)`;
               this.ctx.fillRect(i*16, this.stepY*16, 16, 16);
           });
           playSound('blip'); // 触发8-bit音效
       }
   }
   ```

8. **关键数学过程动画**  
   **步骤演示**：  
   1. 初始化：显示 (1+x)^1 mod (x²-1) = [2,0]（k=2）  
   2. 快速幂步骤：  
      - 平方操作：([1,1] * [1,1]) mod (x²-1) → [2,2]  
      - 合并指数：通过颜色渐变展示卷积过程  
   3. 最终结果：提取 r=0 的系数，显示最终答案8（样例1）  

   **交互设计**：  
   - 按空格键单步执行快速幂  
   - 拖拽滑块调节动画速度（0.5x~4x）  
   - 右键点击矩阵元素查看详细运算过程

---
处理用时：67.03秒
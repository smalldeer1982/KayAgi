# 题目信息

# 公主の#19准备月考

## 题目背景

公主在玩完游戏后，也要月考了。（就算是公主也要月考啊QWQ）


## 题目描述

公主的文综太差了，全校排名1100+（全校就1100多人），她分析了好久，发现她如果把所有时间放在选择题上，得分会比较好一点。

文综题目共有n个，编号从1到n

公主给每个题目算出来了一个预估值Ai，她认为，一段连续题目的答案会在它们的预估值的gcd和lcm之间；有时候她的想法不同了，一些题目的预估值会改变；有时候，会出现多选题，多选题的答案数量就是一段连续题目答案的预估值的公约数的个数。

具体来说，对于一个数列，有四种操作：

L x y p 表示公主询问区间[x,y]的数字的lcm对p取模之后的值

G x y p 表示公主询问区间[x,y]的数字的gcd对p取模之后的值

C x y c 表示公主改变区间[x,y]的数字的值，统一为c

S x y p 表示公主询问区间[x,y]的数字的公因数个数对p取模之后的值

公主月考不能挂科，不然她就不能学习OI了（假的），所以请你帮帮她吧！


## 说明/提示

对于30%的数据，1<=n,q<=1000

对于另外20%的数据，1<=n<=1000，1<=q<=100000

对于另外20%的数据，1<=n<=100000，1<=q<=100000，保证没有修改操作

对于100%的数据，1<=n<=300000，1<=q<=300000

保证任何时刻每个题目的预估值都在[1,100]之间，答案取模之后不超过int


## 样例 #1

### 输入

```
10 10
42 68 35 1 70 25 79 59 63 65 
L 2 6 28
L 2 6 43
G 2 7 5
G 3 4 83
L 7 9 96
G 2 7 39
S 3 8 100
L 4 5 12
G 4 4 65
L 2 4 69```

### 输出

```
0
32
1
1
75
1
1
10
1
34```

# AI分析结果



**唯一算法分类**：数论

---

### **题解思路与算法要点**
1. **核心数学方法**：
   - **质因数分解**：将每个数的质因数次数用二进制位压缩存储（如2^6需3位，3^4需3位）。
   - **位运算优化**：通过按位与（`&`）计算GCD（取最小值），按位或（`|`）计算LCM（取最大值）。
   - **线段树维护**：每个节点存储区间的GCD/LCM压缩状态，支持区间修改和查询。

2. **关键公式推导**：
   - **因数个数计算**：若GCD的质因数分解为∏p_i^k_i，则因数个数为∏(k_i+1)。
   - **快速幂取模**：计算最终结果时需对每个质数的k次幂取模，避免溢出。

3. **解决难点**：
   - **状态压缩设计**：针对不同质数的最大次数，设计紧凑的二进制位分配（总31位）。
   - **懒标记处理**：区间覆盖时需快速生成新的GCD/LCM状态，并保证合并效率。

---

### **题解评分 (≥4星)**
1. **Vingying的题解（4.5星）**  
   - 利用int压缩质数状态，通过位运算合并，代码效率极高。  
   - 预处理质数分解加速查询，常数优化到位。  
   - 代码较长但逻辑清晰，适合深入学习。

2. **官方题解（4星）**  
   - 理论分析透彻，明确质数次数存储的位分配规则。  
   - 提供多种解法思路（如_rqy的替代方法），扩展性强。

3. **Maniac丶坚果的题解（4星）**  
   - 使用long long存储35位，简化位运算逻辑。  
   - 代码简洁，通过`&`和`|`直接合并区间，可读性高。

---

### **最优思路提炼**
- **质因数位压缩**：将质数次数映射到固定二进制位，实现O(1)合并。
- **线段树设计**：每个节点存储压缩后的GCD/LCM状态，支持区间修改与查询。
- **快速分解与重构**：预处理质数分解表，查询时快速计算模值。

---

### **同类型题与解法套路**
- **通用套路**：值域较小时，质因数分解+状态压缩+线段树维护。
- **类似题目**：
  1. 洛谷P1890（区间GCD查询）
  2. 洛谷P7244（区间LCM计数）
  3. 洛谷P5278（动态区间GCD/LCM）

---

### **个人心得摘录**
- **Vingying**：注意数据范围的特殊性（如模数=1时需额外取模）。  
- **Maniac丶坚果**：长整型位运算虽直观，但需处理更多边界情况。  
- **Hadtsti**：直接记录质数次数更易调试，但牺牲了部分效率。

---

### **可视化与算法演示**
**动画设计**：  
1. **质因数分解**：将数值分解为质因数方块（如2→红色块，3→绿色块），高度表示次数。
2. **位压缩过程**：将方块转换为二进制位，例如2^3→二进制`110`，显示为三格红色像素。
3. **线段树合并**：
   - **GCD合并**：取各质数最小次数，对应位取`&`操作，低亮度显示被舍弃的位。
   - **LCM合并**：取最大次数，对应位取`|`操作，高亮新增的位。
4. **查询计算**：将压缩位还原为实际值，动态显示快速幂计算过程。

**复古风格实现**：  
- **8位像素UI**：用16色调色板，质因数方块使用不同颜色，线段树节点显示为像素网格。
- **音效设计**：合并成功时播放8位音效，错误操作触发“哔”声。
- **自动推导模式**：AI自动分解数值并展示位运算过程，类似贪吃蛇路径演示。

---

### **代码片段（核心逻辑）**
```cpp
// 质因数压缩（Vingying题解）
int cal(int tmp) {
    int i=0; memset(cnt,0,sizeof cnt);
    while(tmp>1) {
        if(tmp%pri[i]==0) { tmp/=pri[i]; cnt[i]++; continue; }
        i++;
    }
    int v=0;
    for(int i=0;i<25;++i) v|=(cnt[i]<<b[i]);
    return v;
}

// 线段树合并GCD（Maniac题解）
void pushup(int x) {
    lc[x] = lc[x<<1] | lc[x<<1|1];
    g[x] = g[x<<1] & g[x<<1|1];
}
```

---

### **推荐题目**
1. **P1890** - 区间GCD查询与修改  
2. **P5278** - 动态数集的GCD/LCM  
3. **P7244** - 区间LCM计数问题

---
处理用时：63.52秒
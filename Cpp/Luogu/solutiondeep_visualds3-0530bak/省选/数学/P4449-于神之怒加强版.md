# 题目信息

# 于神之怒加强版

## 题目描述

给定 $n,m,k$，计算

$$\sum_{i=1}^n \sum_{j=1}^m \gcd(i,j)^k$$

对 $10^9 + 7$ 取模的结果。

## 说明/提示

#### 数据规模与约定

对于全部的测试点，保证 $1 \leq T \leq 2 \times 10^3$，$1 \leq n, m, k \leq 5 \times 10^6$。

## 样例 #1

### 输入

```
1 2
3 3```

### 输出

```
20```

# AI分析结果



### 数论

---

#### **题解思路与算法分析**
1. **核心推导**  
   原式通过莫比乌斯反演转化为：  
   $$\sum_{T=1}^n \lfloor \frac{n}{T} \rfloor \lfloor \frac{m}{T} \rfloor \sum_{d|T} d^k \mu(\frac{T}{d})$$  
   关键函数 $G(T) = \sum_{d|T} d^k \mu(T/d)$ 是积性函数，可用线性筛预处理。

2. **难点与突破口**  
   - **积性函数构造**：发现 $G(T)$ 是 $id_k * \mu$ 的卷积形式，证明其积性。  
   - **线性筛优化**：处理质数幂时的递推公式 $G(p^c) = p^{k(c-1)}(p^k - 1)$。  
   - **数论分块**：预处理前缀和后，对 $\lfloor \frac{n}{T} \rfloor$ 分块计算。

---

#### **关键思路/技巧**
- **莫比乌斯反演转换**：将 $\gcd$ 条件转化为整除条件。  
- **积性函数性质**：利用 $id_k$ 和 $\mu$ 的积性简化卷积计算。  
- **线性筛递推**：分情况讨论质数、质数幂的 $G(T)$ 值，避免直接分解质因数。  

---

#### **题解评分 (≥4星)**

| 题解作者 | 评分 | 亮点 |
|---------|------|-----|
| 滑大稽   | ⭐⭐⭐⭐ | 详细推导积性函数递推式，代码含两种筛法 |
| Wolfycz | ⭐⭐⭐⭐ | 简洁代码，强调数论分块与筛法结合 |
| GKxx    | ⭐⭐⭐⭐⭐ | 最简推导路径，高效筛法实现 |

---

#### **代码实现与注释**
```cpp
void init(int k) {
    g[1] = 1;
    for(int i = 2; i < MAXN; i++) {
        if(!vis[i]) {
            prime[tot++] = i;
            int pk = qpow(i, k); // 预计算i^k
            g[i] = (pk - 1 + MOD) % MOD; // G(p) = p^k - 1
        }
        for(int j = 0; j < tot && i*prime[j] < MAXN; j++) {
            vis[i*prime[j]] = 1;
            if(i % prime[j] == 0) {
                // i包含prime[j]时：G(i*p) = G(i) * p^k
                g[i*prime[j]] = g[i] * qpow(prime[j], k) % MOD;
                break;
            }
            // 互质时：G(i*p) = G(i) * G(p)
            g[i*prime[j]] = g[i] * g[prime[j]] % MOD;
        }
    }
    // 前缀和预处理数论分块
    for(int i = 1; i < MAXN; i++) 
        sum[i] = (sum[i-1] + g[i]) % MOD;
}
```

---

#### **同类题目推荐**
1. **P2522 [HAOI2011]Problem b**  
   （莫比乌斯反演 + 二维前缀和）  
2. **P3312 [SDOI2014]数表**  
   （积性函数筛法 + 离线查询）  
3. **P3768 简单的数学题**  
   （高阶数论分块 + 杜教筛应用）

---

#### **可视化设计思路**
**动画方案**：  
1. **分块过程**：  
   - 用色块动态显示 $\lfloor n/T \rfloor$ 的取值区间，红框标记当前块的 $[l, r]$。  
   - 侧边栏实时显示当前块贡献值 $(sum[r] - sum[l-1]) * \lfloor n/T \rfloor \lfloor m/T \rfloor$。  

2. **筛法演示**：  
   - 网格中每个数字高亮其最小质因数，红色标记质数。  
   - 处理 $i=6$ 时，分解为 $2 \times 3$，显示 $g[6] = g[2] \times g[3]$。  

**复古风格**：  
- 8-bit 字体显示公式，关键步骤配FC音效（如质数发现时播放上升音阶）。  
- Canvas绘制筛法过程，质数用绿色像素块，合数用灰色渐变动画。  

---

#### **个人心得摘录**
> "研究了一下午才搞懂积性函数的递推关系，发现线性筛中质数幂的处理是关键。当i被质数整除时，必须分情况推导递推式，否则会重复计算导致错误。"  
> —— 滑大稽的调试经验  

> "将原式转化为狄利克雷卷积形式后，代码实现变得异常简洁，但数学推导的严谨性是保证正确性的前提。"  
> —— GKxx的优化思路

---
处理用时：65.41秒
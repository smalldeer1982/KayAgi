# 题目信息

# 【XR-1】快乐肥宅

## 题目背景

小粉兔的机房里面有 $n$ 个快乐肥宅，但小粉兔自己并不是，他看着这些快乐肥宅，非常羡慕，于是他想研究一下这些快乐肥宅的体重。

## 题目描述

每个快乐肥宅第 $0$ 天的体重都等于 $1$。第 $i$ 个快乐肥宅的体重记作 $w_i$，则一开始 $w_i = 1$。

第 $i$ 个快乐肥宅有一个专属的快乐指数 $k_i$，这表示他每天刚起床后，体重会是上一天的体重的 $k_i$ 倍。

肥宅们是有觉悟的，第 $i$ 个肥宅有一个专属的觉醒体重 $g_i$，这表示一旦他的体重**大于** $g_i$，他就会去健身房健身，每次减掉自己 $g_i$ 的体重，直到体重小于等于 $g_i$。

健身后，肥宅们会在机房见面，他们发现有时各自的体重会变得很有趣。

有一天，肥宅们发现各自的体重形成了等差数列！

另一天，肥宅们发现各自的体重形成了等比数列！

肥宅们心想，如果 $n$ 个快乐肥宅的体重 $\{w_1, w_2, \ldots, w_n\}$ 恰好形成序列 $\{r_1, r_2, \ldots, r_n\}$，至少需要经过多少天呢？

不过如果肥宅们等了很久都没有等到这一天，他们会认为这是不可能的。

## 说明/提示

【样例 $1$ 说明】

下表是两个肥宅在第 $0$ 天至第 $7$ 天时的体重变化表：

| 天数 | 肥宅 $1$ 的体重 | 肥宅 $2$ 的体重 | 解释 |
| :--: | :--: | :--: | :--: |
| $0$ | $1$ | $1$ | 第 $0$ 天每个肥宅的体重都是 $1$ |
| $1$ | $4$ | $2$ | 肥宅 $1$ 的体重是上一天的 $4$ 倍，肥宅 $2$ 的体重是上一天的 $2$ 倍 |
| $2$ | $2$ | $4$ | 肥宅 $1$ 的体重是上一天的 $4$ 倍，为 $16$，他发现自己的体重超过了 $7$，于是去了两次健身房，把体重减少了 $2\times 7=14$ |
| $3$ | $1$ | $3$ | 这一天肥宅 $1$ 和肥宅 $2$ 都去了一次健身房 |
| $4$ | $4$ | $1$ | 肥宅 $2$ 去了一次健身房 |
| $5$ | $2$ | $2$ | 肥宅 $1$ 去了两次健身房 |
| $6$ | $1$ | $4$ | 肥宅 $1$ 去了一次健身房 |
| $7$ | $4$ | $3$ | 肥宅 $2$ 去了一次健身房 |

可以看出在第 $7$ 天时肥宅的体重形成了序列 $\{4, 3\}$。

【数据规模与约定】

Subtask 1（20 points）：$n \le 50$，$g_i \le 50$。  
Subtask 2（20 points）：$g_i$ 为质数。  
Subtask 3（20 points）：$g_i \le 10^3$。  
Subtask 4（20 points）：$r_i \in \{1, g_i\}$。  
Subtask 5（20 points）：无特殊限制。

对于 $100\%$ 的数据，$1 \le n \le 10^3$，$1 \le k_i, r_i \le g_i \le 10^7$。

## 样例 #1

### 输入

```
2
4 7 4
2 5 3```

### 输出

```
7```

## 样例 #2

### 输入

```
2
4 7 3
2 5 3```

### 输出

```
Impossible```

## 样例 #3

### 输入

```
2
4 7 1
2 5 1```

### 输出

```
0```

## 样例 #4

### 输入

```
3
14 60 44
6 50 6
1029 91287 87318```

### 输出

```
101```

## 样例 #5

### 输入

```
1
6 65536 65536```

### 输出

```
16```

## 样例 #6

### 输入

```
2
2 2 2
2 3 1
```

### 输出

```
2
```

# AI分析结果



### **算法分类**  
高次同余方程求解（exBSGS + exCRT）

---

### **综合分析与结论**  
**核心思路**：将每个肥宅的体重变化转化为高次同余方程，使用 exBSGS 求解每个方程的最小解与循环周期，再用 exCRT 合并所有方程的解，最终找到满足所有条件的最小天数。

**核心难点**：  
1. **方程解的结构**：每个方程可能有唯一解（尾巴部分）或无限周期解（循环部分），需分类处理。  
2. **溢出风险**：合并解时模数可能极大（超过 `1e9`），需在合并过程中判断可行性。  
3. **最小解约束**：合并后的解需满足所有方程的最小天数要求，需调整解的大小。

**可视化设计**：  
- **动画方案**：  
  - 展示每个方程解的结构（如“尾巴”和循环部分），用不同颜色标记。  
  - 合并解时动态显示模数的扩展过程，高亮当前合并的方程。  
- **像素风格**：  
  - 使用 8-bit 风格展示方程解的结构（如循环长度、尾巴长度）。  
  - 音效提示解的存在性（成功音效）或无解（失败音效）。  
- **交互控制**：  
  - 步进执行 exCRT 合并过程，允许调整速度观察模数变化。  

---

### **题解清单 (≥4星)**  
1. **小粉兔（5星）**  
   - **亮点**：详细推导方程解的结构，优化合并过程，代码清晰且处理溢出高效。  
   - **核心代码**：  
     ```cpp  
     pii ExBSGS(int a, int b, int m) {  
         // ... (处理尾巴和循环部分)  
         return mp(x % y + o, y);  
     }  
     ```  
   - **心得**：“在合并解时，若模数超过 `1e9` 则无需继续合并，直接验证可行性。”

2. **lingfunny（4星）**  
   - **亮点**：明确阶的计算逻辑，代码模块化，但未处理大模数合并时的优化。  
   - **核心代码**：  
     ```cpp  
     int findm(int a, int b, int p) {  
         // 计算循环周期  
     }  
     ```  

3. **mango09（4星）**  
   - **亮点**：使用 `unordered_map` 存储 BSGS 结果，代码简洁，但复杂度较高。  

---

### **最优思路与技巧**  
1. **exBSGS 分治**：  
   - 分离方程的“尾巴”和循环部分，分别处理唯一解和周期解。  
   - 关键变量：尾巴长度 `o`，循环周期 `z`。  
2. **exCRT 合并优化**：  
   - 合并过程中若模数超过 `1e9`，停止合并并直接验证当前解。  
3. **最小解调整**：  
   - 合并后的解需满足 `x ≥ max(各方程最小解)`，通过模数扩展调整。  

---

### **类似题目推荐**  
1. **P3846 [TJOI2007] 可爱的质数**（BSGS 模板）  
2. **P2485 [SDOI2011] 计算器**（高次同余与线性方程结合）  
3. **P4777 【模板】扩展中国剩余定理**（exCRT 模板）  

---

### **可视化实现关键代码（伪代码）**  
```javascript  
// 8-bit 风格动画（Canvas）  
function drawRhoStructure(tail, cycle) {  
    ctx.fillStyle = "#FF0000"; // 红色标记尾巴  
    drawGrid(tail);  
    ctx.fillStyle = "#0000FF"; // 蓝色标记循环  
    drawCycle(cycle);  
}  

// exCRT 合并过程动画  
function mergeSolutions(mod1, mod2) {  
    if (mod1 * mod2 > 1e9) playSound("overflow");  
    // ... 动态显示模数合并  
}  
```  

---

### **个人心得摘录**  
- **调试教训**：处理模数时必须检查 `gcd`，否则逆元计算会出错。  
- **优化技巧**：合并解时若模数过大，直接跳过后续合并步骤。

---
处理用时：57.55秒
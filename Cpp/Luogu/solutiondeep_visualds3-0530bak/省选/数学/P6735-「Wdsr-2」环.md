# 题目信息

# 「Wdsr-2」环

## 题目描述

Kagamine Rin 有一个圆环，上面均匀分布着 $n$ 个点，这些点之间连接着 $m$ 条线段。

突然有一天，这些线段全都不见了。

Rin 想要找回这些线段，但是她不记得线段的分布。她只记得，这些线段中任意两条都不相交。

**注意：只在端点处相交不算相交；重合不算相交。** 下面的样例解释有助于理解本题中的定义。

Rin 有时还会记得一些额外的信息，她可能还会告诉你每个点上连接的线段数。

现在 Rin 想要知道，符合她的记忆的方案数有多少种。由于结果可能很大，你只需要输出答案对 $1000000007$ 取模的结果（模数是一个质数）。


## 说明/提示

样例解释：

![](https://cdn.luogu.com.cn/upload/image_hosting/82pgikk2.png)

**Update：上图第二行第三个画错了，它的竖应该在右边**


如上图，有 $20$ 种方案满足样例 $1$ 的要求，而只有最后两种方案满足样例 $2$ 的要求。

------

**本题采用捆绑测试**，数据范围遵守如下约定：

subtask | $n\le$ | $m\le$ | $type$ | 分数
:-:|:-:|:-:|:-:|:-:
$0$ | $8$ | $8$ | $0$ | $10$
$1$ | $50$ | $50$ | $0$ | $10$
$2$ | $4000$ | $4000$ | $0$ | $15$
$3$ | $8$ | $8$ | $1$ | $10$
$4$ | $50$ | $50$ | $1$ | $15$
$5$ | $600$ | $600$ | $1$ | $20$
$6$ | $4000$ | $4000$ | $1$ | $20$

对于所有数据，有 $2\le n\le 4000,1\le m\le 4000,type\in \{0,1\}, a_i \ge 0$。若 $type=1$ 则保证 $\sum_{i=1}^na_i=2m$。

## 样例 #1

### 输入

```
4 2 0
```

### 输出

```
20
```

## 样例 #2

### 输入

```
4 2 1
1 1 1 1
```

### 输出

```
2
```

# AI分析结果



**算法分类**  
组合数学、动态规划  

---

**题解思路与解决难点**  
**核心思路**  
- **Type=0**：转化为不相交弦的组合问题。利用卡特兰数变形，推导出组合数公式：  
  $$ans = \frac{\binom{n+m-2}{n-2} \cdot \binom{n+m-1}{n-2}}{n-1}$$  
  预处理组合数实现高效计算。  
- **Type=1**：动态规划解决带度数约束的合法匹配。定义状态 `dp[i][j]` 表示前 `i` 个点已连 `j` 条边的方案数。转移时枚举当前点可连边数 `k`，需满足 `k ≤ a[i+1]` 且 `k ≤ 剩余度数`（即 $\sum_{l=1}^i a_l - 2j$）。

**关键难点**  
1. **Type=0 的组合推导**：将圆环拆解为链结构，发现其与卡特兰数的关联。  
2. **Type=1 的状态转移**：确保度数约束与不相交条件，需精确计算剩余可用度数。  
3. **复杂度优化**：通过递推前缀和或压缩枚举范围，将复杂度控制为 $O(nm)$。

---

**题解评分**  
1. **鏡音リン的题解（4.5星）**  
   - 思路清晰，详细推导递推式与组合公式。  
   - 代码未直接给出，但数学分析透彻，适合理论理解。  
2. **tzl_Dedicatus545的题解（4星）**  
   - 直接应用组合公式，代码简洁高效。  
   - 动态规划实现简明，适合快速编码。  

---

**最优思路与技巧**  
1. **组合数学转化**：将环问题拆解为链，利用已知数列（如卡特兰数）快速求解。  
2. **动态规划状态设计**：以 `dp[i][j]` 表示前 `i` 点连 `j` 边，通过剩余度数约束保证合法性。  
3. **枚举剪枝**：利用 `min(a[i+1], sum-2j)` 限制枚举范围，避免无效计算。

---

**同类型题与算法套路**  
- **不相交线段计数**：类似括号匹配或卡特兰数问题（如 [CF1264D2]）。  
- **带约束动态规划**：背包问题的变种，需结合度数约束设计转移条件。

---

**推荐练习题**  
1. P1044 [NOIP2003 普及组] 栈（卡特兰数应用）  
2. P4381 [IOI2008] Island（环结构拆解）  
3. P1352 没有上司的舞会（树形DP与约束处理）  

---

**代码核心实现**  
```cpp
// Type=0 组合数解法
void Solve0() {
    // 预处理组合数 C(n, k)
    Init0();
    ll ans = (C[n+m-2][n-2] * C[n+m-1][n-2]) % MOD;
    ans = ans * inv[n-1] % MOD;
    cout << ans << endl;
}

// Type=1 动态规划解法
void Solve1() {
    dp[0][0] = 1;
    int sum = 0;
    for (int i = 0; i < n; ++i) {
        sum += a[i];
        for (int j = 0; j <= m; ++j) {
            if (!dp[i][j]) continue;
            int rem = sum - 2 * j; // 剩余可用度数
            for (int k = 0; k <= min(a[i], rem); ++k) {
                if (j + k > m) continue;
                dp[i+1][j+k] = (dp[i+1][j+k] + dp[i][j]) % MOD;
            }
        }
    }
    cout << dp[n][m] << endl;
}
```

---

**可视化设计**  
**复古像素动画方案**  
1. **Canvas 绘制**：  
   - 圆环以 8-bit 像素风格渲染，点用彩色方块表示。  
   - 动态规划状态以网格显示，当前状态 `(i, j)` 高亮为黄色。  
2. **音效反馈**：  
   - 转移成功时播放短促“哔”声，错误转移（如 `k` 超限）播放低沉音效。  
   - 完成计算时播放 8-bit 胜利音乐。  
3. **AI 自动演示**：  
   - 按帧逐步推进 `i` 和 `j`，展示 `dp[i][j]` 的更新过程。  
   - 控制面板支持暂停/继续，速度调节（慢/中/快）。  

**关键帧示例**  
- **初始状态**：圆环静止，`dp[0][0] = 1` 显示为绿色方块。  
- **转移过程**：当前点 `i` 闪烁，`k` 条边以线段动态连接，对应 `dp[i+1][j+k]` 更新为橙色。  
- **结束状态**：最终答案 `dp[n][m]` 放大显示，背景烟花特效。

---
处理用时：97.59秒
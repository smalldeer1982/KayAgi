# 题目信息

# 「MCOI-02」Build Battle 建筑大师

## 题目背景

WAPER 爱玩 hypixel（世界上最大的 Minecraft 小游戏服务器） 建筑大师！

提示：在本题中，羊毛属于一种方块。

## 题目描述

现在 WAPER 准备玩 $q$ 局建筑大师。在第 $i$ 局游戏的开始，WAPER 会选定一个参数 $m_i$，并 **按顺序** 放置 $n$ 个有颜色的羊毛，羊毛颜色的排列如下：

$$1,\ 2,\ ...\ ,\ m_i-1,\ m_i,\ 1,\ 2,\ ...\ ,m_i-1\ ,m_i\ ,\ ...\ (n-1) \ \bmod \  m_i+1$$

例如 $n=7,m=3$ 时，颜色排列如下：

$$1\ ,2,\ 3,\ 1,\ 2,\ 3,\ 1$$

现在 WAPER 准备打破一些方块（可以一个也不打破，也可以全部打破），WAPER 想知道这样可以产生多少种不同的颜色序列。（两个颜色序列不同当且仅当其长度不同或某一位置的羊毛颜色不同）

因为答案太大，所以输出答案对 $10^9+7$ 取模的结果。

（其实就是询问这个序列本质不同的子序列对 $10^9+7$ 取模的结果）

## 说明/提示

#### 数据规模与约定

**本题采用捆绑测试。**

- Subtask 1（5 pts）$\ \ $：$n \le 20$，$q=1$。
- Subtask 2（15 pts）：$n \le 10^3$，$q=1$。
- Subtask 3（15 pts）：$\max\{m_i\} \le 20$，$q=1$。
- Subtask 4（25 pts）：$q=1$。
- Subtask 5（40 pts）：无特殊限制。

对于 $100\%$ 的数据，$1 \le n,q \le 10^6$，$1 \le m_i \le n$。

#### 说明

Minecraft OI Round 2 B

- Maker：WAPER420
- Tester：灵空

$样例不是出题人写的！！！！！！！！$

## 样例 #1

### 输入

```
10 6
1 1 4 5 1 4```

### 输出

```
11
11
833
944
11
833```

## 样例 #2

### 输入

```
1000000 1
114514```

### 输出

```
945636198```

# AI分析结果



### 唯一算法分类
组合数学与动态规划优化

---

### 综合分析与结论
**核心思路**：将动态规划递推式转化为组合数学问题，通过预处理阶乘、逆元和快速幂，枚举特定操作次数计算答案。  
**关键难点**：  
1. 从递推式 $s_i = 2s_{i-1} - s_{i-m-1}$ 推导出组合意义模型。  
2. 发现路径计数中符号与权值的交替变化规律。  
**解决核心**：  
- 将操作分解为走1步（权值×2）和走$(m+1)$步（权值×-1）。  
- 枚举操作次数$i$，计算贡献 $(-1)^i \cdot 2^{n-i(m+1)} \cdot C(n - i(m+1) + i, i)$。  

**可视化设计**：  
- **像素动画**：用网格表示步数，红色块表示走1步，蓝色块表示走$(m+1)$步，每次操作触发闪烁特效。  
- **音效**：走1步时播放升调，走$(m+1)$步时播放降调，计算贡献时播放金币音效。  
- **控制面板**：可调节动画速度，高亮当前步数、剩余步数和组合数计算区域。  

---

### 题解清单（评分≥4星）
1. **w4p3r（5星）**  
   - **亮点**：清晰推导组合模型，给出路径计数类比，代码简洁高效。  
   - **心得引用**：“这trick不是挺常见的嘛”——暗示需积累组合转换经验。  

2. **Svemit（4星）**  
   - **亮点**：直接引入经典子序列DP模型，简化推导过程。  
   - **代码优势**：使用模数封装类提升可读性。  

3. **gghack_Nythix（4星）**  
   - **亮点**：详细分步解析递推式来源，强调序列周期性特性。  

---

### 最优思路提炼
**核心技巧**：  
1. **组合意义转换**：将递推式转化为路径操作模型，权值变化与符号交替结合。  
2. **预处理优化**：阶乘、逆元、快速幂的$O(n)$预处理，支持组合数$O(1)$查询。  
3. **调和级数枚举**：每个$m$的查询时间为$O(n/m)$，总复杂度$O(n \log n)$。  

---

### 同类型题与算法套路
**类似问题**：  
- 带周期性约束的不同子序列计数。  
- 递推式含固定偏移量（如$s_i = a \cdot s_{i-1} + b \cdot s_{i-k}$）的优化。  

**通用解法**：  
- 寻找递推式的组合或矩阵快速幂优化。  
- 利用模数特性预处理关键数学结构（阶乘、逆元）。  

---

### 推荐题目
1. **P3811 【模板】乘法逆元**  
   - 快速计算逆元是本题组合数预处理的基础。  

2. **P1303 黑匣子**  
   - 涉及递推式优化与数学转换。  

3. **P4302 [SCOI2003] 字符串折叠**  
   - 不同子序列问题的变种，需类似优化思路。  

---

### 代码核心逻辑
**预处理与主函数**：  
```cpp
// 预处理阶乘、逆元、2的幂次
fac[0] = two[0] = 1;
for(int i=1; i<=N; i++) {
    fac[i] = fac[i-1] * i % mod;
    two[i] = two[i-1] * 2 % mod;
}
inv[N] = ksm(fac[N], mod-2); // 费马小定理求逆元
for(int i=N-1; i>=0; i--) inv[i] = inv[i+1] * (i+1) % mod;

// 计算单个m的答案
int solve(int m) {
    int res = 0;
    for(int i=0; i <= n/(m+1); i++) {
        int steps = n - (m+1)*i;
        int cnt = two[steps] * C(steps + i, i) % mod;
        res = (res + (i%2 ? -cnt : cnt)) % mod;
    }
    return (res + mod) % mod;
}
```

---

### 复古像素动画设计
**实现要点**：  
1. **Canvas布局**：  
   - 顶部显示当前$m$值，中间用20×20网格表示步数，已走路径标记为绿色，当前操作块高亮。  
2. **音效触发**：  
   - `walk1_sound.play()`：走1步时播放（8-bit短促“哔”声）。  
   - `walkm_sound.play()`：走$(m+1)$步时播放（低音“咚”声）。  
3. **自动演示模式**：  
   - 每次随机选择走1步或$(m+1)$步，路径超出$n$时回退，最终显示贡献计算过程。  

**交互示例**：  
```javascript
function drawStep(x, steps, m) {
    ctx.fillStyle = "#00FF00"; // 绿色路径
    ctx.fillRect(x%20 * 15, Math.floor(x/20) * 15, 14, 14);
    if (steps === 1) {
        playBeep(440); // 走1步音效（440Hz）
    } else {
        playBeep(220); // 走m+1步音效（220Hz）
    }
}
```

---
处理用时：75.00秒
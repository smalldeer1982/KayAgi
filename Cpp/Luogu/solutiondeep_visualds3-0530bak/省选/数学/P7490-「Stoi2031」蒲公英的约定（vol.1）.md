# 题目信息

# 「Stoi2031」蒲公英的约定（vol.1）

## 题目背景

> 一起长大的约定 那样清晰 拉过勾的我相信 说好要一起旅行 是你如今 唯一坚持的任性 ——《蒲公英的约定》

## 题目描述

清和如在玩游戏。她们有 $n$ 丛 **蒲公英**，每丛分别有 $s_i$ 朵。这些 **蒲公英** 有一个神奇的性质：有一个给定的常数 $\sigma \in (0,1)$，$x$ 朵 **蒲公英** 会分出 $\lfloor \sigma x \rfloor$ 朵为一组，剩下 $x-\lfloor \sigma x \rfloor$ 朵继续分组，直到分出的组没有 **蒲公英** 即 $\lfloor \sigma x \rfloor=0$ 为止。她们称这种现象为 **任性**。现在她们的每丛 **蒲公英** 都有 **任性** 的现象。她们的游戏规则如下：从清开始，两人轮流进行 **旅行**。一次 **旅行** 为选择一丛 **蒲公英** 并吹散这一丛的第一组中的若干朵 **蒲公英**，至少要吹一朵，至多吹的朵数为第一组的朵数，即不能吹散除第一组外的 **蒲公英**。当第一组为空时，其下一组成为第一组。若这一丛只剩下一组 **蒲公英**，这一丛不能再被选定。每丛 **蒲公英** 都不能被选定时，游戏结束，当前轮到的人落败。她们想知道如果清第一次 **旅行** 时等概率选择其中一丛可吹散的 **蒲公英** 再等概率选择吹散的朵数后两人都按最优策略操作，那么清的胜率 $x \bmod 20190816170251$ 的值将会是多少。

与 vol.2 的区别是，**蒲公英** 在被吹散一部分后 **不会** 重新分组。

## 说明/提示

#### 简述版题意：

有 $n$ 丛 **蒲公英**，第 $i$ 丛有 $s_i$ 朵。给定实数 $\sigma$，每丛会分为若干组，第 $j$ 组有 $t_j$ 朵，且满足 $t_j=\left\lfloor \sigma\left(s_i - \sum\limits_{k=1}^{j-1}t_k\right) \right\rfloor$，当 $t_j=0$ 时不再分组。两人轮流操作，每次操作可以选择一丛 **蒲公英**，并选择一个整数 $c \in t_j$，从这丛 **蒲公英** 中吹散 $c$ 朵，将 $t_j$ 变为 $t_j-c$，其中 $j$ 为操作之前这丛 **蒲公英** 中满足 $t_j \neq 0$ 的最小正整数。必须至少吹一朵，不能操作者败。求先手第一步等概率选择任意一丛可操作的 **蒲公英** 再等概率选择吹散的朵数后两人都采取最优策略时先手的胜率 $x \bmod{20190816170251}$ 的值。

#### 样例解释：

对于样例 $1$，清无法操作，胜率为 $0$。

对于样例 $2$，初始局面为 $\{0;1\},\{2,1,1,1,0;2\},\{1,0;2\}$，清可以选择第 $2$ 丛并在两种操作中选择吹散 $2$ 朵变成 $\{0;1\},\{1,1,1,0;2\},\{1,0;2\}$，选择第 $3$ 丛没有可取胜的策略，且第 $1$ 丛不能选择，总胜率为 $\dfrac{\frac{1}{2}+0}{2}=\dfrac{1}{4}$。

#### 数据范围：

**本题采用捆绑测试，各个 Subtask 的分数与限制如下。**

| Subtask No. | $n \le$ | $s_i \le$ | $\sigma$ 限制 | 分值 |
| :-----------: | :-----------: | :-----------: | :-----------: | :-----------: |
| $1$ | $3 \times 10^5$ | $10^{10}$ | $\sigma=\dfrac{\sqrt{2}+1}{3}$ | $10$ |
| $2$ | $3 \times 10^5$ | $10^{10}$ | $\sigma=\dfrac{\sqrt{3}+1}{5}$ | $10$ |
| $3$ | $3 \times 10^5$ | $10^{10}$ | $\sigma=\dfrac{\sqrt{5}-1}{2}$ | $10$ |
| $4$ | $100$ | $1$ | 无 | $3$ |
| $5$ | $100$ | $100$ | $\sigma=\dfrac{1}{2}$ | $7$ |
| $6$ | $100$ | $10^6$ | 无 | $13$ |
| $7$ | $3 \times 10^5$ | $10^{10}$ | $\sigma \ge \dfrac{1}{2}$ | $47$ |

对于 $100\%$ 的数据，$1 \le n \le 3 \times 10^5,1 \le s_i \le 10^{10},1 \le p<q \le 10^9$。

**本题读入量较大，可以选择使用比赛描述中的快速读入模板以加快读入速度。**

## 样例 #1

### 输入

```
4 3
1 1 1
1 6
```

### 输出

```
0
```

## 样例 #2

### 输入

```
6 3
1 7 3
1 3
```

### 输出

```
5047704042563
```

# AI分析结果



---

## 算法分类
博弈论/SG函数

---

## 综合分析与结论

### 核心思路
题目本质是博弈论中的 Nim 变种，每个蒲公英丛的博弈状态可以转化为 SG 函数值。核心难点在于快速计算每个数 s_i 的 SG 值，并通过异或求整体博弈状态。

**算法流程**：
1. **SG 函数推导**：对每个数 x，计算其首组大小 t1 = ⌊σx⌋。通过数学归纳发现 SG(x) 的取值规则：
   - 若后续分组的 SG 值等于 t1，则 SG(x) = t1 - 1
   - 否则 SG(x) = t1
2. **胜负判定**：所有丛 SG 值的异或和 d。若 d=0 则先手必败；否则统计每个丛 i 的 SG 值异或 d 后是否 ≤ 当前组大小 t1，计算概率贡献。

### 可视化设计
**复古像素动画方案**：
- **网格展示**：将每个蒲公英丛表示为像素方块，颜色深浅表示当前 SG 值。异或总和以动态数字显示在顶部。
- **操作高亮**：点击丛时触发动画：首组数值 t1 闪烁，SG 值计算过程以公式气泡呈现。
- **音效反馈**：计算 SG 值时播放 8-bit 音阶，异或和变化时播放短促电子音。
- **自动演示**：按空格键启动 AI 自动推演，用贪吃蛇式路径遍历各丛的 SG 计算逻辑。

---

## 题解清单（五星）

### 题解作者：VinstaG173（★★★★★）
**核心亮点**：
1. **数学归纳法**：通过数学推导将 SG 计算优化到 O(1) 复杂度，避免递归。
2. **位运算优化**：利用奇偶性判断简化条件分支。
3. **高效预处理**：针对特殊 σ 值预计算分数，提升大数处理效率。

**代码亮点**：
```cpp
inline ll sg(ll x) {
    ll t = _sigma(x);
    if (!t) return 0;
    return t - (((x - _tau(t) - 1) / t) & 1);
}
```
通过位运算判断奇偶性，实现无分支的条件计算。

---

## 最优思路提炼

### 关键技巧
1. **SG 快速计算**：发现 SG(x) 仅取决于首组大小 t1 和后续奇偶性，无需递归。
2. **异或性质应用**：总异或非零时，每个丛的合法操作数即其 t1 中满足 `(SG[i] ^ d) ≤ t1` 的个数。
3. **模逆元预处理**：使用扩展欧几里得算法快速计算概率的模逆元，避免浮点运算。

---

## 类似题目推荐
1. **P2148 [SDOI2009] E&D**：分组博弈与 SG 函数的经典问题。
2. **P2575 高手过招**：状态压缩与 SG 函数的结合应用。
3. **P2964 [USACO09NOV] Coin Game**：概率与博弈的综合题型。

---

## 可视化代码片段

```javascript
// 8-bit 风格 Canvas 绘制
function drawSGAnimation(si, t1, sg) {
    ctx.fillStyle = '#8BDBFF'; // 浅蓝背景
    ctx.fillRect(x, y, 32, 32);
    ctx.fillStyle = '#FF6B6B'; // 红色方块表示 t1
    ctx.fillRect(x + 4, y + 4, t1 * 2 % 28, 24);
    // 播放音效
    beep(440 + sg * 20, 50);
}
```

---

## 个人心得摘录
> “本题的关键在于发现 SG 函数的取值与首组大小的奇偶性相关，而非传统递归计算。调试时通过小数据验证了 `(x−τ(t)−1)/t` 的奇偶性规律，最终实现 O(1) 计算。” —— VinstaG173

---

## 复古动画设计
- **调色板**：采用 FC 经典的 16 色模式，红色表示可操作丛，绿色表示已处理。
- **AI 演示逻辑**：自动遍历每个丛的 SG 计算，路径采用 A* 算法模拟“最优路径选择”。
- **积分系统**：每正确计算一个 SG 值得 10 分，异或和正确时触发连击奖励音效。

---
处理用时：74.34秒
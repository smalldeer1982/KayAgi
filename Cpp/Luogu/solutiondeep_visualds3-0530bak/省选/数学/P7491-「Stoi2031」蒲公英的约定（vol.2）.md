# 题目信息

# 「Stoi2031」蒲公英的约定（vol.2）

## 题目背景

> 一起长大的约定 那样清晰 拉过勾的我相信 说好要一起旅行 是你如今 唯一坚持的任性 ——《蒲公英的约定》

## 题目描述

清和如在玩游戏。她们有 $n$ 丛 **蒲公英**，每丛分别有 $s_i$ 朵。这些 **蒲公英** 有一个神奇的性质：有一个给定的常数 $\sigma \in (0,1)$，$x$ 朵 **蒲公英** 会分出 $\lfloor \sigma x \rfloor$ 朵为一组，剩下 $x-\lfloor \sigma x \rfloor$ 朵继续分组，直到分出的组没有 **蒲公英** 即 $\lfloor \sigma x \rfloor=0$ 为止。她们称这种现象为 **任性**。现在她们的每丛 **蒲公英** 都有 **任性** 的现象。她们的游戏规则如下：从清开始，两人轮流进行 **旅行**。一次 **旅行** 为选择一丛 **蒲公英** 并吹散这一丛的第一组中的若干朵 **蒲公英**，至少要吹一朵，至多吹的朵数为第一组的朵数，即不能吹散除第一组外的 **蒲公英**。当第一组为空时，其下一组成为第一组。若这一丛只剩下一组 **蒲公英**，这一丛不能再被选定。每丛 **蒲公英** 都不能被选定时，游戏结束，当前轮到的人落败。她们想知道如果清第一次 **旅行** 时等概率选择其中一丛可吹散的 **蒲公英** 再等概率选择吹散的朵数后两人都按最优策略操作，那么清的胜率 $x \bmod{20190816170251}$ 的值将会是多少。

与 vol.1 的区别是，**蒲公英** 在被吹散一部分后 **会** 重新分组。

## 说明/提示

#### 简述版题意：

有 $n$ 丛 **蒲公英**，第 $i$ 丛有 $s_i$ 朵。给定实数 $\sigma$，两人轮流操作，每次操作可以选择一丛 **蒲公英**，并选择一个整数 $c \in (0,\sigma s]$，从这丛 **蒲公英** 中吹散 $c$ 朵，其中 $s$ 为操作之前这丛 **蒲公英** 的朵数。必须至少吹一朵，不能操作者败。求先手第一步等概率选择任意一丛可操作的 **蒲公英** 再等概率选择吹散的朵数后两人都采取最优策略时先手的胜率 $x \bmod{20190816170251}$ 的值。

#### 样例解释：

对于样例 $1$，清无法操作，胜率为 $0$。

对于样例 $2$，清可以选择第 $2$ 丛并在两种操作中选择吹散 $2$ 朵变成 $1,5,3$，或选择第 $3$ 丛并选择唯一的操作变成 $1,7,2$，且第 $1$ 丛不能选择，总胜率为 $\dfrac{\frac{1}{2}+1}{2}=\dfrac{3}{4}$。

#### 数据范围：

**本题采用捆绑测试，各个 Subtask 的分数与限制如下。**

| Subtask No. | $n \le$ | $s_i \le$ | $\sigma$ 限制 | 分值 |
| :-----------: | :-----------: | :-----------: | :-----------: | :-----------: |
| $1$ | $3 \times 10^5$ | $10^{10}$ | $\sigma=\dfrac{\sqrt{2}+1}{3}$ | $10$ |
| $2$ | $3 \times 10^5$ | $10^{10}$ | $\sigma=\dfrac{\sqrt{3}+1}{5}$ | $10$ |
| $3$ | $3 \times 10^5$ | $10^{10}$ | $\sigma=\dfrac{\sqrt{5}-1}{2}$ | $10$ |
| $4$ | $100$ | $1$ | 无 | $3$ |
| $5$ | $100$ | $100$ | $\sigma=\dfrac{1}{2}$ | $7$ |
| $6$ | $100$ | $10^6$ | 无 | $13$ |
| $7$ | $3 \times 10^5$ | $10^{10}$ | $\sigma \ge \dfrac{1}{2}$ | $47$ |

对于 $100\%$ 的数据，$1 \le n \le 3 \times 10^5,1 \le s_i \le 10^{10},1 \le p<q \le 10^9$。

**本题读入量较大，可以选择使用比赛描述中的快速读入模板以加快读入速度。**

## 样例 #1

### 输入

```
4 3
1 1 1
1 6
```

### 输出

```
0
```

## 样例 #2

### 输入

```
6 3
1 7 3
1 3
```

### 输出

```
15143112127689
```

# AI分析结果



---

## 唯一算法分类
**博弈论/SG函数**

---

## 综合分析与结论

### 题解核心思路
1. **SG函数推导**：通过数学分析发现，每个蒲公英数量`x`的SG值存在递归规律。当`x`属于特定集合时，SG值递归到更小的规模；否则直接计算为`floor(σx)`。
2. **胜负判断**：计算所有蒲公英SG值的异或和`d`。若`d=0`则先手必败；否则统计每个合法操作的胜率贡献。
3. **逆元优化**：使用扩展欧几里得算法快速计算模逆元，处理概率的分数取模。

### 核心难点与解决方案
- **数学建模**：通过引理证明SG值的递推关系，避免逐层模拟分组过程。
- **高效计算**：递归求解SG值时，利用`τ=σ/(1-σ)`的数学性质快速缩小问题规模。
- **概率统计**：对每个合法操作的贡献进行模运算累加，避免精度丢失。

### 可视化设计思路
1. **像素动画**：用8位风格网格表示蒲公英丛，动态显示SG值计算过程。
2. **高亮关键步骤**：递归调用时用闪光效果标记当前计算的`x`和对应的`τ`值。
3. **音效互动**：播放短音效表示分组变化，异或和计算时用不同音调区分胜负分支。
4. **自动演示模式**：模拟AI自动选择最优操作路径，展示异或和变化对胜负的影响。

---

## 题解清单 (4星)

### 题解作者：VinstaG173（4星）
**关键亮点**：
- 通过严密的数学归纳推导SG函数递推式。
- 处理大数时采用`__int128`避免溢出。
- 预计算参数优化不同σ场景的性能。

---

## 代码核心逻辑

### SG函数计算
```cpp
ll sg(ll x) {
    if (!_sigma(x)) return 0; // 无法操作时SG=0
    ll y = _mu(x);            // 计算τ相关的中间值
    ll t = _tau(y) + 1;       // 判断是否属于特殊集合A
    return (t == x) ? sg(y) : _sigma(x); // 递归或直接返回
}
```

### 逆元计算（扩展欧几里得）
```cpp
LL exgcd(LL a, LL b, LL &x, LL &y) {
    if (!b) { x=1; y=0; return a; }
    LL d = exgcd(b, a%b, y, x);
    y -= a/b*x; return d;
}
LL _inv(LL a) {
    LL x, y;
    exgcd(ntf, a, x, y);
    return (y % ntf + ntf) % ntf; // 保证逆元非负
}
```

---

## 相似题目推荐
1. **P3185 分裂游戏** - 多堆博弈与SG函数应用
2. **P2964 硬币游戏** - 概率博弈与逆元计算
3. **P2575 高手过招** - 状态压缩与SG分析

---

## 个人心得摘录
> "通过构造数学引理避免暴力计算，是处理大规模博弈问题的关键。调试时需特别注意σ的分数形式转换与取整边界。"

---

## 可视化算法演示（伪代码）
```javascript
// 初始化Canvas与音效
const canvas = initCanvas(800, 600);
const sfx = loadSound('8bit_click.wav');

// 自动演示SG计算
function autoPlay(x) {
    let steps = [];
    while (x > 0) {
        let y = Math.floor(x * tau);
        steps.push({x, y});
        if (x === y + 1) x = y; // 递归情况
        else break;
    }
    animateSteps(steps); // 逐步高亮变化
}

// 动画效果
function animateSteps(steps) {
    steps.forEach((step, i) => {
        setTimeout(() => {
            drawHighlight(step.x, COLORS[i % 5]); // 不同颜色标记递归层
            sfx.play(); // 播放音效
        }, i * 500);
    });
}
```

---

**注**：完整代码与音效资源需结合HTML/CSS实现交互式动画，允许用户单步调试或自动播放。

---
处理用时：63.85秒
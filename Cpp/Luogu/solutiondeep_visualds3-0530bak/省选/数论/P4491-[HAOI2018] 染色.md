# 题目信息

# [HAOI2018] 染色

## 题目背景

HAOI2018 Round2 第二题

## 题目描述

为了报答小 C 的苹果，小 G 打算送给热爱美术的小 C 一块画布，这块画布可以抽象为一个长度为 $N$ 的序列，每个位置都可以被染成 $M$ 种颜色中的某一种。

然而小 C 只关心序列的 $N$ 个位置中出现次数恰好为 $S$ 的颜色种数，如果恰好出现了 $S$ 次的颜色有 $K$ 种，则小 C 会产生 $W_k$ 的愉悦度。

小 C 希望知道对于所有可能的染色方案，他能获得的愉悦度的和对 $1004535809$
取模的结果是多少。

## 说明/提示

特殊性质: $\forall 1 \le i \le m, W_i = 0$。

对于 $100\%$ 的数据，满足 $1 \le N \le 10 ^ 7$，$1 \le M \le 10 ^ 5$，$1 \le S \le 150$，$0 \le W_i < 1004535809$。

![Data](https://cdn.luogu.com.cn/upload/pic/18057.png)


## 样例 #1

### 输入

```
8 8 3
3999 8477 9694 8454 3308 8961 3018 2255 4910```

### 输出

```
524070430```

## 样例 #2

### 输入

```
见 sample.zip/data2.in```

### 输出

```
见 sample.zip/data2.ans```

# AI分析结果



---

## 【算法分类】
**二项式反演 + NTT**

---

## 【题解思路与难点分析】

### **核心思路**
1. **定义与反演**  
   设 $F[k]$ 为**至少**有 $k$种颜色出现 $S$ 次的方案数，通过二项式反演得到**恰好** $k$ 种的方案数 $G[k]$：
   $$
   G[k] = \sum_{i=k}^{lim} (-1)^{i-k} \binom{i}{k} F[i]
   $$
   其中 $lim = \min(m, \lfloor n/S \rfloor)$。

2. **计算 $F[k]$**  
   $F[k]$ 的计算包括：
   - 选 $k$ 种颜色：$\binom{m}{k}$
   - 分配位置：$\binom{n}{kS} \cdot \frac{(kS)!}{(S!)^k}$
   - 剩余位置填色：$(m-k)^{n-kS}$
   $$
   F[k] = \binom{m}{k} \cdot \frac{n!}{(S!)^k (n-kS)!} \cdot (m-k)^{n-kS}
   $$

3. **NTT优化卷积**  
   将反演式转换为卷积形式：
   $$
   G[k] \cdot k! = \sum_{i=k}^{lim} \frac{(-1)^{i-k}}{(i-k)!} \cdot (F[i] \cdot i!)
   $$
   构造多项式 $A(x) = F[i] \cdot i!$ 和 $B(x) = \frac{(-1)^i}{i!}$，通过NTT计算卷积后取对应项。

### **解决难点**
- **复杂度优化**：暴力计算 $O(m^2)$ 无法处理 $m \leq 1e5$，NTT将复杂度降至 $O(m \log m)$。
- **大数处理**：预处理阶乘和逆元，处理模数下的组合数计算。
- **多项式反转**：将 $A$ 反转后与 $B$ 卷积，以匹配差卷积形式。

---

## 【题解评分（≥4星）】
1. **command_block（5星）**  
   - **亮点**：详细推导二项式反演过程，代码结构清晰，NTT实现高效。  
   - **代码**：预处理阶乘优化，反转数组处理差卷积。

2. **λᴉʍ（4.5星）**  
   - **亮点**：容斥思路明确，代码简洁，注释详细。  
   - **技巧**：利用 `reverse` 处理多项式，降低思维难度。

3. **Great_Influence（4星）**  
   - **亮点**：暴力容斥转NTT的推导完整，代码可读性强。  
   - **优化**：预处理组合数时避免重复计算。

---

## 【最优思路提炼】
1. **二项式反演转换**：将“恰好”问题转化为“至少”的容斥计算。
2. **多项式卷积优化**：利用NTT加速差卷积形式的求和。
3. **预处理技巧**：
   - 阶乘与逆元预处理 $O(n)$。
   - 组合数拆解为多项式项，减少重复计算。

---

## 【相似题目推荐】
1. **P4491 [HAOI2018]染色**（本题）
2. **P3338 [ZJOI2014]力**（差卷积应用）
3. **P5488 差分与前缀和**（NTT优化组合计数）

---

## 【代码核心实现】
```cpp
// 预处理阶乘与逆元
void Init() {
    fac[0] = 1;
    for (int i = 1; i <= limNum; i++) fac[i] = fac[i-1] * i % mod;
    ifac[limNum] = powM(fac[limNum], mod-2);
    for (int i = limNum; i; i--) ifac[i-1] = ifac[i] * i % mod;
}

// 计算F[k]
inline ll clacF(int x) {
    return C(m, x) * fac[n] % mod * powM(ifac[S], x) % mod 
           * ifac[n - S*x] % mod * powM(m - x, n - S*x) % mod;
}

// NTT卷积计算
NTT(A, 1); NTT(B, 1);
for (int i = 0; i < n; i++) A[i] = 1LL * A[i] * B[i] % mod;
NTT(A, 0); reverse(A, A + lim + 1);

// 结果累加
ll ans = 0;
for (int i = 0; i <= lim; i++)
    ans = (ans + A[i] * ifac[i] % mod * w[i]) % mod;
```

---

## 【可视化设计】
### **动画演示方案**
1. **像素风格界面**  
   - **颜色块**：用不同颜色表示已选颜色（S次）和自由颜色。
   - **网格布局**：Canvas绘制n个格子的染色过程，高亮当前操作的格子。

2. **关键步骤高亮**  
   - **步骤1（选颜色）**：红色边框标记当前选择的颜色。
   - **步骤2（分配位置）**：绿色闪烁显示S个位置分配。
   - **步骤3（自由填充）**：蓝色渐变动画填充剩余位置。

3. **NTT过程可视化**  
   - **多项式乘法**：显示A和B多项式的系数变化，卷积结果实时更新。
   - **差卷积反转**：箭头动画表示数组反转操作。

### **音效与交互**
- **音效**：分配位置时播放“点击”音效，卷积完成时播放完成音效。
- **控制面板**：滑动条调节动画速度，按钮单步执行反演步骤。

---

## **代码实现（复古像素动画片段）**
```javascript
// Canvas绘制染色过程
function drawGrid() {
    ctx.clearRect(0, 0, width, height);
    for (let i = 0; i < n; i++) {
        ctx.fillStyle = colors[i % m];
        ctx.fillRect(i * cellSize, 0, cellSize, cellSize);
        if (i % S === 0) { // 高亮S次颜色
            ctx.strokeStyle = '#FF0000';
            ctx.strokeRect(i * cellSize, 0, cellSize, cellSize);
        }
    }
}
// 8-bit音效
function playSound(effect) {
    const osc = audioCtx.createOscillator();
    osc.frequency.setValueAtTime(effect === 'place' ? 440 : 880, audioCtx.currentTime);
    osc.connect(audioCtx.destination);
    osc.start(); osc.stop(audioCtx.currentTime + 0.1);
}
```

---
处理用时：79.41秒
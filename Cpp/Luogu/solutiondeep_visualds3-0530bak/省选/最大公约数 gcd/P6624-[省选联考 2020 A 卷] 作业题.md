# 题目信息

# [省选联考 2020 A 卷] 作业题

## 题目描述

小 W 刚刚在离散数学课学习了生成树的知识：一个无向图 $G=(V,E)$ 的生成树 $T$ 为边集 $E$ 的一个大小为 $|V|-1$ 的子集，且保证 $T$ 的生成子图在 $G$ 中连通。

小 W 在做今天的作业时被这样一道题目难住了：

给定一个 $n$ 个顶点 $m$ 条边（点和边都从 $1$ 开始编号）的无向图 $G$，保证图中无重边和无自环。每一条边有一个正整数边权 $w_i$，对于一棵 $G$ 的生成树 $T$，定义 $T$ 的价值为：$T$ 所包含的边的边权的最大公约数乘以边权之和，即：

$$
val(T)=\left(\sum\limits_{i=1}^{n-1} w_{e_i}\right) \times \gcd(w_{e_1},w_{e_2},\dots,w_{e_{n-1}})
$$

其中 $e_1,e_2,\dots,e_{n-1}$ 为 $T$ 包含的边的编号。

小 W 需要求出 $G$ 的所有生成树 $T$ 的价值之和，他做了很久也没做出来，请你帮帮他。由于答案可能很大，你只需要给出答案对 $998244353$ 取模后的结果。

## 说明/提示

【样例解释 $1$】

$G$ 共有三棵生成树：

$T_1=\{(1,2),(2,3)\}$，价值为 $10\times 2=20$。

$T_2=\{(1,2),(1,3)\}$，价值为 $16\times 4=64$。

$T_3=\{(1,3),(2,3)\}$，价值为 $18\times 6=108$。

总和为 $192$。

【数据规模】

$10\%$ 的数据满足：$m\leq 15$。

另有 $20\%$ 的数据满足：$m \leq n$。

另有 $20\%$ 的数据满足：$w_i$ 均相同。

另有 $20\%$ 的数据满足：$w_i$ 均为质数。

$100\%$ 的数据满足：$1\leq n\leq 30, 1\leq m \leq \frac {n(n-1)}{2}, 1\leq w_i \leq 152501$。

## 样例 #1

### 输入

```
3 3
1 2 4
2 3 6
1 3 12```

### 输出

```
192```

# AI分析结果



**唯一算法分类**：矩阵树定理

---

**综合分析与结论**：

本题核心在于利用矩阵树定理处理生成树的边权和，结合欧拉反演消除gcd的干扰。关键步骤如下：

1. **欧拉反演**：将生成树的gcd转化为枚举因数d，使用$\varphi(d)$求和。
2. **边权转化**：构造一次多项式$w_ex+1$，矩阵树定理的行列式一次项系数即为边权和。
3. **多项式运算**：在模$x^2$意义下定义加减乘除，处理行列式中的多项式运算。
4. **优化剪枝**：仅对满足边数≥n-1的因数d进行矩阵计算。

**可视化设计**：
- **矩阵元素高亮**：用红色标记当前主元行，蓝色标记消元行，绿色显示非零元素。
- **多项式动画**：以像素方块表示$a+bx$，左侧显示$a$（黄色），右侧显示$b$（青色）。
- **复古音效**：在交换行时播放跳跃音效，行列式计算完成时触发胜利音效，消元步骤播放点击声。

---

**题解清单 (≥4星)**：

1. **Froggy (⭐⭐⭐⭐⭐)**  
   - 关键亮点：清晰分步推导+多项式运算代码实现  
   - 代码中通过`pair<int,int>`表示多项式，重载运算符实现行列式计算

2. **1saunoya (⭐⭐⭐⭐)**  
   - 详细解释反演过程与多项式除法推导  
   - 提供完整代码并处理了逆元边界情况

3. **s_r_f (⭐⭐⭐⭐)**  
   - 引入容斥思想优化计算  
   - 实现时采用并查集预判连通性减少无效计算

---

**最优思路与技巧**：

1. **欧拉反演转化gcd**  
   $\gcd(w_1,...,w_k)=\sum_{d|w_i}\varphi(d)$，将二维约束转为一维枚举。

2. **边权的多项式表示**  
   定义$w\to (1, w)$，利用$(a+bx)(c+dx)\equiv (ad+bc)x + bd \mod x^2$性质，使行列式一次项系数为边权和。

3. **模意义下的逆元计算**  
   对$(a+bx)$的逆元公式推导：$a^{-1} - a^{-2}b x$，避免多项式求逆的高复杂度。

---

**同类型题与算法套路**：

1. **生成树边权和问题**  
   通用解法：构造形如$(1+wx)$的多项式，利用矩阵树定理求一次项系数。

2. **带权值的生成树计数**  
   类似题目：P6622 [省选联考 2021 A卷] 矩阵游戏（矩阵树定理处理乘积）

---

**推荐题目**：

1. [P6178【模板】Matrix-Tree 定理](https://www.luogu.com.cn/problem/P6178)  
   （矩阵树定理基础应用）

2. [P3317 [SDOI2014]重建](https://www.luogu.com.cn/problem/P3317)  
   （边权为概率的生成树积和）

3. [P5296 [北京省选集训2019]生成树计数](https://www.luogu.com.cn/problem/P5296)  
   （生成树边权和的高级应用）

---

**代码片段（多项式运算核心）**：

```cpp
typedef pair<int,int> pii;
pii operator/(const pii &a, const pii &b) {
    int inv = qpow(b.fi, MOD-2); // 计算常数项逆元
    int iv2 = 1ll * inv * inv % MOD;
    return { 
        (1ll * a.fi * inv % MOD - 1ll * a.se * b.se % MOD * iv2 % MOD + MOD) % MOD,
        1ll * a.se * inv % MOD 
    };
}

int calc(int d) {
    // 构建矩阵
    for (auto e : edges[d]) {
        int u = e.u, v = e.v, w = e.w;
        mat[u][u] += {1, w}; mat[v][v] += {1, w};
        mat[u][v] -= {1, w}; mat[v][u] -= {1, w};
    }
    // 行列式计算（返回一次项系数）
    return gauss(n-1).second; 
}
```

---

**个人心得摘录**：

> "在调试时发现，当矩阵的常数项为0但一次项非零时，需要特殊处理除法。这时实际上在模$x^2$下存在逆元，但传统高斯消元会误判为不可逆。通过交换行优先选择常数项非零的行解决了这一问题。" ——摘自题解评论区

---

**可视化与算法演示**：

1. **像素风格矩阵**  
   每个矩阵元素显示为16x16像素块，左上角显示常数项（黄色数字），右下角显示一次项（青色数字）。

2. **消元过程动画**  
   - 当前主元行用闪烁红框标记  
   - 消元行逐步减去主元行的倍数，对应像素块产生颜色渐变效果  
   - 每次行交换时播放8-bit "jump"音效（频率=300Hz）

3. **自动演示模式**  
   点击"AI Run"后，算法自动选择主元并高亮当前操作，速度可调（慢/正常/极速）。

[点击此处体验交互式可视化演示](https://www.luogu.com.cn/paste/demo)（虚构链接）

---
处理用时：72.60秒
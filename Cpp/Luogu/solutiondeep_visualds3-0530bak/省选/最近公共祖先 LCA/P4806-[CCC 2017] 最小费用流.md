# 题目信息

# [CCC 2017] 最小费用流

## 题目描述

 **译自 [CCC2017](https://cemc.math.uwaterloo.ca/contests/computing/2017/index.html) Senior T4「[Minimum Cost Flow](https://cemc.math.uwaterloo.ca/contests/computing/2017/stage%201/seniorEF.pdf)」**

Watermoo 中有编号为 $1,2,\dots,N$ 的建筑物。其中还有 $M$ 条管道将建筑物两两连接。由于城市规划的疏漏，$1$ 号建筑是全市唯一的污水处理厂。每条管道可能是*活动的*或是*非活动的*。如果建筑 $1$ 通过活动管道直接或是间接地与其他每个建筑连通，则称活动管道集是一个有效的方案。（每条管道将两个建筑直接连接。如果建筑 $X$ 直接或间接连接建筑 $Y$，且建筑 $Y$ 直接或间接连接建筑 $Z$，那么我们说 $X$ 和 $Z$ 间接连接。）

Watermoo 的市政府正在使用一个 $N-1$ 条管道组成的显然有效的方案，但是这使得政府已经透支很多经费了！每条管道都有各自的月维修费，这是在其活动时必须支付的，一个有效方案的总成本为所有有效管道的维修费的总和。（非活动的管道不花费一分钱。）

此外，一个好消息是：Watermoo 大学的研究人员开发出了一种不完善的管道推进器，你可以在一条管道上使用它。它将从 $C$ 到 $\mathrm{max}(0,C-D)$ 降低该管道的维修成本，$D$ 为该推进器的强度。

市政府希望将成本降到最低，同时也希望你能尽快完成这个任务。每天，城市会允许你激活一条管道并关闭另一条管道。问：你需要多少天才能使一组活动管道形成一个有效方案并使其在所有有效方案和推进方案中费用最小？

请注意，在你规划的过程中方案可能会无效，但是到最后，他应该是一个有效的方案。

## 说明/提示

#### 样例解释 1
因为 $D=0$，所以管道推进器一无是处。

第一天，你应当关闭建筑 $2$ 到 $3$ 的管道并激活建筑 $4$ 到 $1$ 的管道。

#### 样例解释 2
一个可行的解为：首先在连接建筑 $1,2$ 的管道上安装推进器，使成本降低到 $3$。第一天，以连接 $1,3$ 的管道替换连接 $2,3$ 的管道。第二天，以连接 $1,5$ 的管道替换连接 $1,4$ 的管道。

此外，在连接 $1,3$ 或连接 $1,5$ 的管道上安装推进器毫无意义。这样做将会使得该管道的维修成本为 $0$，最优的费用为 $11$ （如你所见，我们已经找到了费用为 $10$ 的方案）。

#### 样例解释 3
初始的方案即最优方案。请注意整数上溢。

对于 $\frac3{15}$ 的数据，$N \le 8,M \le 28,D=0$。

对于另外 $\frac5{15}$ 的数据，$N \le 1\ 000,M \le 5\ 000,D=0$。

对于另外 $\frac3{15}$ 的数据，$D=0$。

对于另外 $\frac2{15}$ 的数据，$N \le 1\ 000,M \le 5\ 000$。

## 样例 #1

### 输入

```
4 4 0
1 2 1
2 3 2
3 4 1
4 1 1```

### 输出

```
1```

## 样例 #2

### 输入

```
5 6 2
1 2 5
2 3 5
1 4 5
4 5 5
1 3 1
1 5 1```

### 输出

```
2```

## 样例 #3

### 输入

```
4 4 0
1 2 715827882
2 3 715827882
3 4 715827882
4 1 715827884```

### 输出

```
0```

# AI分析结果



---

### 唯一算法分类
**最小生成树（Kruskal算法应用）**

---

### 综合分析与结论
**核心思路**：  
本题要求在生成树中选择一条边应用推进器，使得总费用最小且黑边最多。关键在于：  
1. **构造最小生成树**：优先选权值小、黑边的边，保证初始解最优。  
2. **替换优化**：寻找不在生成树中的黑边，替换生成树中的白边，需满足总费用不变且黑边数量增加。  
3. **LCA预处理**：快速查询路径上的最大边，判断是否可替换。

**可视化设计**：  
- **动画流程**：展示 Kruskal 算法选边过程，高亮最终生成树的最大边（红色）。  
- **替换演示**：用绿色标记候选黑边，查找其路径上的最大白边（黄色），若满足条件则替换。  
- **交互面板**：可调节速度观察选边、替换逻辑，并显示当前黑边数量与天数。

**复古像素风格**：  
- **Canvas 网格**：建筑物为像素方块，活动管道用绿色线段，非活动用灰色。  
- **音效触发**：选边时播放短音效，替换成功时播放上扬音效。  
- **自动演示**：按算法步骤自动执行，展示最优解的推导过程。

---

### 题解清单（≥4星）
1. **Graphcity（5星）**  
   - **亮点**：完整处理替换条件，LCA高效查询路径最大边，代码结构清晰。  
   - **关键代码**：通过倍增法预处理路径最大值，枚举候选边判断替换可行性。

---

### 核心代码实现
```cpp
// Kruskal 构造生成树（优先黑边）
sort(Edge+1, Edge+m+1);
For(i,1,m) {
    int u=Edge[i].u, v=Edge[i].v;
    if(Find(u) != Find(v)) {
        fa[Find(u)] = Find(v);
        if(!Edge[i].typ) cnt++; // 统计黑边
        G.Addedge(u, v, i); // 建树
    }
}

// LCA 预处理路径最大值
void dfs(int x, int f) {
    fa[x] = anc[x][0] = f;
    num[x][0] = val[x]; // 路径上的边索引
    For(i,1,19) {
        anc[x][i] = anc[anc[x][i-1]][i-1];
        num[x][i] = fmin(num[x][i-1], num[anc[x][i-1]][i-1]);
    }
    // ... 遍历子节点
}

// 判断替换边
For(i,1,m) {
    if(vis[i] || Edge[i].typ==1) continue; // 非生成树中的黑边
    int id = G.LCA(u, v); // 路径上的最大边
    if(Edge[id].typ==0) continue; // 原边是黑边则无法替换
    if (sum == Edge[id].w + min(d, Edge[i].w) - Edge[i].w)
        ans = cnt + 1; // 可增加黑边数
}
printf("%d\n", n-1 - ans); // 天数 = 白边数量
```

---

### 同类型题与算法套路
**类似问题**：  
- 次小生成树：替换一条边保持生成树性质。  
- 动态最小生成树：权值变化后快速调整。  
- 瓶颈生成树：关注路径上的最大边。

**通用解法**：  
1. **Kruskal + 路径查询**：通过预处理路径最大值优化替换判断。  
2. **边权调整策略**：贪心选择最大边进行权值削减。

---

### 推荐题目
1. **P3366 【模板】最小生成树**  
2. **P4180 [BJWC2010] 严格次小生成树**  
3. **P1967 货车运输（最大边查询）**

---

### 个人心得摘录
- **调试教训**：初始未考虑权值相等时的黑边优先级，导致生成树黑边数错误。  
- **优化技巧**：LCA倍增法将路径查询复杂度从 O(N) 降至 O(logN)。  
- **思维突破**：替换边需总费用不变，转化为数学条件 `sum == ...` 是关键。

---

### 可视化算法演示
**动画设计**：  
1. **初始生成树构建**：逐步连接边，绿色高亮选中边，红色标记最大边。  
2. **推进器应用**：最大边权值减少，显示新费用。  
3. **替换边检测**：候选黑边闪烁，路径上黄色标记最大白边，替换后黑边+1。  

**复古元素**：  
- **8位音效**：选边“哔”，替换成功“叮”。  
- **像素建筑**：编号显示在方块顶部，管道用不同颜色区分活动状态。  
- **自动模式**：按空格键暂停/继续，方向键调整速度。

---
处理用时：112.00秒
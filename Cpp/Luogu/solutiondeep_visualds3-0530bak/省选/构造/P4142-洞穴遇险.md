# 题目信息

# 洞穴遇险

## 题目背景

**ZRQ**在洞穴中准备采集矿物的时候遇险了！洞穴**要塌了**！

题目来源：[zhoutb2333](https://www.luogu.org/space/show?uid=31564)


## 题目描述

整个洞穴是一个$N*N$的方格图，每个格子形如$(X,Y),1 \le X,Y \le N$。其中$X$表示从上到下的行数，$Y$表示从左到右的列数。$(1,1)$在左上角,$(1,N)$在右上角，$(N,1)$在左下角，$(N,N)$在右下角。


满足$X+Y$为奇数格子的有一个不稳定度$V_{X,Y},X+Y$为偶数的格子的不稳定度为$0$。


**ZRQ**现在手里恰巧有$M$个可以支撑洞穴的柱子，柱子的力量可以认为是无穷大。


只要支撑住了一个格子那么这个格子的不稳定度将降为$0$。


每个柱子是$L$型的，它除了要占据当前的格子外，还需要占据两个相邻的格子（这三个格子形成$L$型,可以选择任意方向放置，一共有$4$个方向）。



 ![](https://cdn.luogu.com.cn/upload/pic/13049.png) 

**柱子占据相邻的格子不会降低其不稳定度（换句话说就是柱子只有在拐角处有力量）**。


有些格子的顶已经塌下来了，无法在其位置放置柱子了，这些格子也不能被占据了。这样已经塌了的格子有$K$个（他们的不稳定度都为$0$,**即使$X+Y$为奇数，塌下来的格子的不稳定度也会为$0$**）。


**ZRQ**想问你，在放置一些柱子后 ，最小的不稳定度之和为多少（可以不将$M$个柱子都放完）。


## 说明/提示

共$10$个测试点，每个点$10$分，计$100$分。


对于测试点$1$~$3$，有$1 \le N \le 6$


对于测试点$4$~$7$，有$1 \le N \le 11$


对于测试点$8$~$10$，有$1 \le N \le 50$


对于所有测试点，$0 \le M \le \frac{N^2}{3}, 0 \le K \le N^2, 0 \le V_{X,Y} \le 10^6$


**样例#1解释：**

显然无法让任意两个不稳定的格子都被拐角覆盖，于是将$(2,1)$用拐角覆盖住即可。这样剩余的不稳定度为$V_{1,2}+V_{2,3}+V_{3,2}=1+1+1=3$。

**样例#2解释：**

一个都放不下，这样剩余的不稳定度为$V_{1,2}+V_{2,3}+V_{3,2}=2+4+3=9$。


## 样例 #1

### 输入

```
3 3 1
0 1 0
2 0 1
0 1 0
1 3```

### 输出

```
3```

## 样例 #2

### 输入

```
3 3 4
0 2 0
0 0 4
0 3 0
1 3
2 1
2 2
3 1```

### 输出

```
9```

# AI分析结果



## 算法分类
**费用流（网络流）**

---

## 题解思路与核心难点

### 核心思路
1. **问题转化**：将最小化剩余不稳定度转化为最大化消除的不稳定度之和。
2. **网格分类**：
   - 将格子按 `X+Y` 奇偶性分为两类（黑点/白点），只有黑点（不稳定点）能作为柱子拐角。
   - 白点进一步按列奇偶性分为奇数列白点（灰点）和偶数列白点（白点）。
3. **网络流建模**：
   - 黑点拆分为入点和出点，中间连边费用为负的该点不稳定度，表示消除此点。
   - 源点连接灰点，灰点连接相邻黑点的入点；黑点的出点连接相邻白点，白点连接汇点。
4. **费用流控制**：每次增广选择费用最小的路径（即消除最大的不稳定度），当费用不再减少时停止增广。

### 解决难点
- **形状限制**：L型柱子需覆盖两个不同奇偶列的白点，通过灰点和白点的分层建模确保结构合法。
- **塌陷格子处理**：在连边时跳过塌陷格子。
- **费用流优化**：当增广路径费用非负时提前终止，避免无效增广。

---

## 题解评分（≥4星）

### 题解1（作者：zhoutb2333，赞13）
**⭐⭐⭐⭐⭐**  
- **亮点**：完整建模四层网络结构，通过反向思考处理费用正负，代码逻辑清晰。
- **关键代码**：动态调整流量和费用，使用`dis[t] > 0`终止增广。

### 题解4（作者：yizhiming，赞0）
**⭐⭐⭐⭐**  
- **亮点**：详细拆解灰点、白点、黑点关系，引入虚拟源点控制柱子数量上限。
- **关键代码**：`spfa`函数中优先处理负权边，确保每次增广最优。

---

## 最优思路提炼

### 关键步骤
1. **黑白染色与拆点**：黑点拆为入点/出点，中间连边费用为不稳定度的负值。
2. **分层连边**：
   ```python
   源点 → 灰点 → 黑点入 → 黑点出 → 白点 → 汇点
   ```
3. **费用流控制**：每次增广后检查费用是否仍为负，否则停止。

### 示例代码（核心建图）
```cpp
// 黑点拆点
add(get(i,j,1), get(i,j,2), 1, -v[i][j]);

// 灰点（奇数列白点）连接相邻黑点
if (j % 2 == 1) {
    add(s, get(i,j,0), 1, 0);
    for (相邻方向) add灰点到黑点入;
}

// 白点（偶数列）连接汇点
else {
    add(get(i,j,3), t, 1, 0);
    for (相邻方向) add黑点出到白点;
}
```

---

## 同类型题与算法套路

### 相似算法
- **二分图最大权匹配**：如任务分配问题，通过费用流建模。
- **网格覆盖问题**：如骨牌覆盖，转化为网络流路径覆盖。

### 推荐题目
1. **P3358 最长k可重区间集**（费用流建模覆盖问题）
2. **P4014 分配问题**（二分图最大权匹配）
3. **P4009 汽车加油行驶**（分层图网络流）

---

## 可视化与算法演示

### 动画设计
1. **网格绘制**：Canvas绘制N×N网格，黑点红色，灰点浅蓝，白点深蓝，塌陷点黑色。
2. **网络流动态**：
   - 节点高亮：增广路径上的节点按层渐变色（源点绿，汇点紫）。
   - 边流动：显示当前增广路径的流量和费用。
3. **像素风格**：
   - 使用8-bit音效：增广成功（↑音调），失败（↓音调）。
   - 网格更新：柱子放置后，对应格子闪烁并显示消除的不稳定度。

### 交互功能
- **步进控制**：允许单步执行增广，观察路径选择。
- **参数调节**：动态调整M值，实时显示剩余不稳定度。

---

## 个人心得摘录

> **zhoutb2333的调试经验**：  
> “构造反例时发现不能单纯追求最大流，必须优先保证费用最优。调整终止条件后AC。”

> **yizhiming的顿悟**：  
> “将二类格子按列奇偶性拆分是关键，否则无法满足L型结构限制。”

---

## 核心算法代码

### 费用流核心（SPFA + 回溯）
```cpp
bool spfa() {
    // 初始化dis数组
    while (!q.empty()) {
        int u = q.front(); q.pop();
        for (遍历邻接边) {
            if (边可通 && dis[v] > dis[u] + 费用) {
                更新dis[v]和前驱;
                if (!in队列) 入队;
            }
        }
    }
    return dis[t] < INF;
}

void mcmf() {
    while (spfa() && m > 0) {
        if (dis[t] >= 0) break; // 关键终止条件
        int flow = 回溯路径计算最小流量;
        mincost += flow * dis[t];
        m -= flow;
    }
}
```

### 塌陷点处理（代码片段）
```cpp
bool check(int x, int y) {
    return !(x < 1 || y < 1 || x > n || y > n || v[x][y] == -1);
}
```

---
处理用时：76.15秒
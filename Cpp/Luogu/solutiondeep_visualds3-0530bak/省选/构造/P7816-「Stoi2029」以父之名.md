# 题目信息

# 「Stoi2029」以父之名

## 题目背景

> 以父之名判决  
> 那感觉没有适合字汇  
> 就像边笑边掉泪  
> 凝视着完全的黑  
> 阻挡悲剧蔓延的悲剧会让我沉醉  
> ——《[以父之名](https://www.bilibili.com/video/BV1fx411N7bU?p=36)》

## 题目描述

地狱里有 $n$ 个罪人在等待判决，编号为 $1$ 至 $n$。罪人们之间有 $m$ 条罪的联系，编号为 $1$ 至 $m$，每条联系 的值为 $1$ 或 $2$ 且恰好连接两个罪人。

称一个罪人的自负度为他和其他所有罪人之间联系的值之和。两个罪人之间可能不止有一条联系，此时这些联系的值都应该被计算。由于这些罪人承受了太多的罪恶，他们变得不和谐。具体地，每个罪人的自负度都是奇数。

现在，神明将要对他们进行判决。判决的具体方式为：将每条联系都进行定向，使得这条联系所连接的两个罪人中的一个受到惩罚，另一个受到救赎，它们的值均为这条联系的值。

由于神明秉承父的仁慈，希望罪人们更加均等地接受惩罚和救赎，于是他规定判决后每个罪人所受到的惩罚和救赎值总和之差的绝对值必须恰好为 $1$。

由于神明工作繁忙，因此他以父之名要求你为他找到一种判决的方法。由于父的指示不会有错，所以一定存在一种这样的方法。

---

#### 题意简述

给定一个 $n$ 个点 $m$ 条边的无向图，边权均为 $1$ 或 $2$。保证每个点所相连的边权值之和均为奇数。你需要将这些边定向，使每个点的入边权值和与出边权值和之差的绝对值恰为 $1$。保证有解。输出任意一种方案。

## 说明/提示

#### 样例解释

定向后的图如下：

![](https://cdn.luogu.com.cn/upload/image_hosting/uhz96nbm.png)

更多样例详见题目附件 `trial_sample.zip`。

------

#### 数据范围

**本题采用捆绑测试。**

- 特殊性质 A：边权均为 $1$，且任意两点之间只存在一条简单路径，且没有重边。
- 特殊性质 B：同一个点至多只有一条边权为 $1$ 和一条边权为 $2$ 的边相连。

| Subtask | 分值 | $1\le n \le$ | $1\le m \le$ | 特殊性质 | 
| :-: | :-: | :-: | :-: | :-: |
| $1$ | $7$ | $10$ | $15$ | 无 | 
| $2$ |  $20$ |$10^3$ | $3\times10^3$ | 无 |
| $3$ |  $20$ |$3 \times 10^5$ | $3 \times 10^5$ | A |
| $4$ | $20$ |$3 \times 10^5$ | $3 \times 10^5$ | B | 
| $5$ |  $33$ |$10^6$ | $3 \times 10^6$ | 无 |

对于 $100\%$ 的数据，$1 \le u_i,v_i \le n \le 10^6$，$1 \le m \le 3 \times 10^6$，$w_i \in \{1,2\}$。

在题目附件 `trial_sample.zip` 中：

- `trial_sample1.in` 即为样例 #1。
- `trial_sample2.in` 满足特殊性质 A。
- `trial_sample3.in` 满足特殊性质 B。
- `trial_sample4.in` 不满足特殊性质。

另外该目录下还有 `checker.exe`。

------

#### 提示

**本题输入输出量较大，请使用较快的输入输出方式。**

本题提供 [Special Judge 源码](https://www.luogu.com.cn/paste/7albhubs)和 `checker.exe`，供选手调试。Windows 下使用方法为:  
命令行在目标文件夹输入指令：
```
checker.exe data.in data.out data.out
```
其中 `data.in` 是输入数据文件，`data.out` 是程序运行结果文件。观察评判结果即可。

- `Perfect answer.` 表示答案正确。
-  `Wrong answer on node x, and the difference is d.` 表示答案错误，其中节点 $x$ 的入边权值和与出边权值和之差的绝对值为 $d$ 而不为 $1$。
- `Invalid answer.` 表示输出的字符串长度不正确或输出非法字符。

请务必保证**输出格式正确**，否则 Special Judge 可能会返回 Unknown Error 等不可预估的结果。

## 样例 #1

### 输入

```
4 5
1 2 1
1 3 2
2 3 1
2 4 1
4 1 2
```

### 输出

```
00100
```

# AI分析结果



# 【算法分类】
欧拉回路

# 【题解思路与难点分析】

**核心思路**：  
利用虚点构造欧拉回路，通过优先选择同权值边确保每个点的入出差为1。关键步骤包括：
1. 添加虚点连接所有度数为奇数的点，使全图度数变为偶数；
2. 构建欧拉回路时优先选择与入边权值相同的边；
3. 去掉虚边后，原图每个点的入出权值差恰好为1。

**算法要点**：
- 虚边构造：每个度数为奇数的点与虚点连一条权值1的边，保证新图所有点度数为偶数。
- 欧拉回路遍历：用链式前向星存储边，维护每个点的两种权值边的当前弧指针，优先选择与入边同权的边。

**解决难点**：
- **度数奇偶性平衡**：通过虚边调整度数奇偶性，使欧拉回路存在。
- **高效遍历优化**：使用当前弧优化（跳过已访问边）确保时间复杂度为 $O(m)$。
- **权值匹配策略**：优先选择相同权值的出边，保证最终差值合法。

# 【题解评分（≥4星）】
1. **Konnyaku_LXZ（5星）**  
   - 思路清晰，代码高效，利用链式前向星和当前弧优化。  
   - 关键代码片段逻辑紧凑，优先选择同权值边的策略明确。

2. **DengDuck（4星）**  
   - 代码简洁，与Konnyaku思路一致，注释较少但实现规范。  
   - 个人心得提到手摸验证正确性，增强可理解性。

3. **Leasier（4星）**  
   - 分权值处理欧拉回路，代码模块化程度高。  
   - 注释详细，适合初学者逐步理解。

# 【最优思路提炼】
**关键技巧**：  
1. **虚点构造**：将度数奇点转化为偶点，使欧拉回路存在。  
2. **权值优先遍历**：在欧拉回路中优先匹配相同权值边，确保差值条件。  
3. **当前弧优化**：跳过已处理边，保证线性时间复杂度。

**代码核心逻辑（Konnyaku_LXZ）**：  
```cpp
void dfs(int u, int pre) {
    while (now[u][pre] && e[now[u][pre]].ans != -1) 
        now[u][pre] = nxt[now[u][pre]]; // 当前弧优化
    if (!now[u][pre]) pre = 3 - pre; // 切换权值
    // 选择可用边并递归
    e[now[u][pre]].ans = 0; 
    dfs(e[now[u][pre]].to, e[now[u][pre]].val);
}
```

# 【相似题目推荐】
1. **CF1610F** - 类似边权定向问题，需构造合法方案。  
2. **P7816** - 图论定向，要求入出差条件。  
3. **LG-P3511** - 利用欧拉回路解决度数平衡问题。

# 【可视化算法演示】

**动画设计**：  
1. **像素风格渲染**：  
   - 节点用8位像素圆点表示，虚点用闪烁黄色标记。  
   - 边权1/2分别用绿色/蓝色线条，当前遍历边高亮红色。  

2. **遍历过程演示**：  
   - **步进控制**：用户可逐帧查看欧拉回路的构建步骤。  
   - **音效提示**：选择边时播放“哔”声，完成回路时播放胜利音效。  

**Canvas交互示例**：  
```javascript
// 伪代码：欧拉回路遍历动画
function drawEulerTour(u, prevW) {
    let edges = getAvailableEdges(u, prevW);
    for (let edge of edges) {
        if (!edge.visited) {
            highlightEdge(edge, 'red'); // 高亮当前边
            playSound('beep'); 
            edge.visited = true;
            drawEulerTour(edge.to, edge.w);
            drawArrow(edge.direction); // 绘制定向箭头
        }
    }
}
```

**复古音效设计**：  
- **选择边**：8-bit短促“哔”声（Web Audio合成）。  
- **完成回路**：经典马里奥过关音效。  
- **错误提示**：低沉故障音。

# 【总结】
本题解通过构造虚点与欧拉回路的巧妙结合，解决了复杂的边权定向问题。其核心在于将原问题转化为欧拉回路存在性，并通过优先权值匹配策略保证条件成立。该思路在图论中具有广泛适用性，如网络流、路径覆盖等问题均可借鉴类似技巧。

---
处理用时：74.87秒
# 题目信息

# [IOI 2007] pairs 动物对数

## 题目描述

Mirko 和 Slavko 正在玩动物玩具的游戏。 首先，他们要在下图给出的三种玩具模板中选择一种。三种模板分别由一维、二维和三维的网格点（在图中用圆圈表示）组成。 

![](https://cdn.luogu.com.cn/upload/pic/20672.png )

接下来Mirko 把 $N$ 个小动物玩具放到选中的模板的网格点上。

动物玩具可以走一步到达与它相邻的网格点上（在图中相邻的点之间有一条小短线相连）。两个网格点之间的距离定义为**从一个网格点到另一个网格点所需要移动的最小步数**。

如果两个动物之间的距离小于等于$D$，则它们之间可以互相听见。Slavko 的任务是计算在模板上有多少对动物可以互相听得见。

给定模板的类型、所有动物的位置以及数字$D$，写一个程序计算有多少对动物可以互相听得见。 

## 说明/提示

在30分的测试数据中, 动物数目 $N$ 最多是 $1 000$。

如果成功通过了某一种模板（一维、二维或者三维）的全部测试数据，将会得到至少30分。

对于input 1的解释： 假设动物按给出的顺序编号为$1$到$6$。$4$对互相能够听得到的动物分别是:
- 1-5 ( 距离是5)
- 1-6 ( 距离是2)
- 2-3 ( 距离是0)
- 5-6 ( 距离是3)

对于input 2 的解释：$8$对动物分别是:
- 1-2 ( 距离是2)
- 1-4 ( 距离是4)
- 1-5 ( 距离是3)
- 2-3 ( 距离是3)
- 2-4 ( 距离是4)
- 3-4 ( 距离是3)
- 3-5 ( 距离是4)
- 4-5 ( 距离是3)

## 样例 #1

### 输入

```
1 6 5 100 
25 
50 
50 
10 
20 
23 ```

### 输出

```
4```

## 样例 #2

### 输入

```
2 5 4 10 
5 2 
7 2 
8 4 
6 5 
4 4 ```

### 输出

```
8```

## 样例 #3

### 输入

```
3 8 10 20 
10 10 10 
10 10 20 
10 20 10 
10 20 20 
20 10 10 
20 10 20 
20 20 10 
20 20 20 ```

### 输出

```
12```

# AI分析结果



# [IOI 2007] pairs 动物对数

## 算法分类
**曼哈顿距离转切比雪夫距离 + 滑动窗口 + 多维前缀和**

---

## 题解思路与核心难点

### 关键算法流程
1. **曼哈顿距离转切比雪夫距离**  
   将原坐标转换为新坐标系，将曼哈顿距离转化为切比雪夫距离的最大值问题：
   - **B=1**：直接排序后双指针滑动窗口
   - **B=2**：坐标变换 $(x, y) \rightarrow (x+y, x-y)$，按新x轴排序后用树状数组维护y轴区间
   - **B=3**：坐标变换 $(x,y,z) \rightarrow (x+y+z, x+y-z, x-y+z, -x+y+z)$，按第一维排序后用三维前缀和或分层二维前缀和

2. **滑动窗口优化**  
   对转换后的第一维进行排序，维护满足距离条件的滑动窗口，将问题降维至剩余维度。

3. **多维区间查询**  
   - B=2：树状数组维护区间和
   - B=3：预处理每层二维前缀和（M=75时更优），或使用三维树状数组差分查询

### 解决难点对比
| 维度 | 转换方式                     | 数据结构/方法                | 时间复杂度       |
|------|------------------------------|------------------------------|------------------|
| B=1  | 无需转换                     | 双指针滑动窗口               | O(n)             |
| B=2  | $(x, y) \rightarrow (x+y, x-y)$ | 排序+树状数组                | O(n log m)       |
| B=3  | 四维切比雪夫坐标             | 分层二维前缀和（M小场景最优） | O(nm + m³)       |

---

## 最优思路与技巧
1. **曼哈顿转切比雪夫的核心公式**  
   ```math
   \text{曼哈顿距离} = \max(\text{各转换维度差的绝对值})
   ```

2. **分层预处理法（B=3）**  
   预处理每层二维前缀和，对每个点枚举可能的层数，计算合法区域：
   ```cpp
   // 预处理三维前缀和
   for(int z=1; z<=m; z++)
     for(int x=1; x<=2m; x++)
       for(int y=1; y<=2m; y++)
         sum[z][x][y] += sum[z][x-1][y] + sum[z][x][y-1] - sum[z][x-1][y-1];
   
   // 查询三维立方体
   ans += sum[z][x2][y2] - sum[z][x1-1][y2] - sum[z][x2][y1-1] + sum[z][x1-1][y1-1];
   ```

3. **树状数组维护动态区间（B=2）**  
   滑动窗口移动时动态更新树状数组，高效处理区间求和：
   ```cpp
   while(j <= i && new_x[i] - new_x[j] > D) {
       tree.remove(new_y[j]); 
       j++;
   }
   ans += tree.query(y_range);
   tree.add(new_y[i]);
   ```

---

## 题解评分（≥4星）
1. **圣嘉然（4.5★）**  
   - 亮点：三维树状数组实现完整，代码结构清晰  
   - 代码：[三维树状数组差分查询](#)

2. **清远学会（4.2★）**  
   - 亮点：B=3分层前缀和思路直观，适合小M场景  
   - 代码：[分层预处理+二维前缀和](#)

3. **Ynoi（4.0★）**  
   - 亮点：三维处理采用暴力分层，代码可读性极佳  
   - 代码：[枚举层数+二维前缀和](#)

---

## 同类型题目推荐
1. **P3964 [TJOI2013]松鼠聚会**（曼哈顿转切比雪夫）
2. **P3188 [HNOI2007]梦幻岛宝珠**（多维背包+分层处理）
3. **P4397 [JLOI2014]聪明的燕姿**（高维数论+降维技巧）

---

## 可视化设计
### 复古像素风动画方案
1. **坐标转换演示**  
   - **Canvas网格**：原坐标与切比雪夫坐标同步显示，用不同颜色标记转换过程  
   - **音效**：坐标变换时播放8-bit "blip" 音效

2. **滑动窗口动态**  
   - **高亮区域**：当前窗口内的点用黄色方块，移出点用红色闪烁  
   - **控制面板**：速度滑块调节动画步进速度，支持暂停/继续

3. **三维分层展示**  
   - **Z轴切换**：方向键切换当前显示的Z层，合法区域用半透明绿色覆盖  
   - **自动模式**：AI自动遍历所有层并统计结果，背景音乐循环播放《超级玛丽》风格BGM

---

## 个人心得摘录
> "调试三维树状数组时，差分公式写错两次... 最终通过手绘立方体容斥图才理清逻辑" —— 圣嘉然  
> "发现M=75时暴力预处理反而比高维数据结构更快，降维打击的胜利" —— 清远学会

---

## 核心代码片段（B=3分层前缀和）
```cpp
// 预处理每层二维前缀和
for(int z=1; z<=m; z++) 
    for(int x=1; x<=2*m; x++)
        for(int y=1; y<=2*m; y++)
            sum[z][x][y] += sum[z][x-1][y] + sum[z][x][y-1] - sum[z][x-1][y-1];

// 统计每个点的贡献
for(auto p : points) {
    for(int dz=-D; dz<=D; dz++) {
        int cz = p.z + dz;
        if(cz <1 || cz>m) continue;
        int remain = D - abs(dz);
        int x1 = max(1, p.x - remain), x2 = min(2*m, p.x + remain);
        int y1 = max(1, p.y - remain), y2 = min(2*m, p.y + remain);
        ans += sum[cz][x2][y2] - sum[cz][x1-1][y2] - sum[cz][x2][y1-1] + sum[cz][x1-1][y1-1];
    }
}
ans = (ans - n) / 2; // 去除自身并处理重复计数
```

---
处理用时：91.84秒
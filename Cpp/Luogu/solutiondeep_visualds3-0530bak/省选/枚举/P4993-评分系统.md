# 题目信息

# 评分系统

## 题目背景

答疑请到：https://www.luogu.org/discuss/show?postid=79498

由于时限等问题，请大家重交一遍这道题

本题时限开至2s

样例：https://files.cnblogs.com/files/ztz11/yl.rar

---

众所周知，luogu 有题目难度的评分系统，用户在通过题目后可以选择题目难度以及算法标签，来完善 luogu 的题库。

![](https://cdn.luogu.com.cn/upload/pic/40327.png)

（原注：以下内容非真实评分数据，纯属作者编造，仅供娱乐使用。）

## 题目描述

Menteur-Hxy 同学很不老实，为了实现 NOIp 前 AC $100$ 道黑题的目标，他决定雇佣一些水军，最少雇佣 $1$ 个水军。

每个水军都有一个能力值 $x_i$，表示该水军可以解决难度最高为 $x_i$ 的题目。这些水军十分尽职尽责，在通过这道题目后都会给题目评最高难度。当然，luogu 的正常用户也会做题，他们会正常地评分。现在，我们给你所有水军的能力值以及每道题正常用户的评分记录，请你求出有多少种选择水军的方案，可以使这道题的评分变为黑题。因为答案可能过大，最终请输出答案数 $\bmod p$ 的值。

评分计算公式：去掉一个最高分，去掉一个最低分后求平均分。

**【表一：投票信息】**

| 投票编号 | 对应难度 | 分数贡献 |
| :------: | :------: | :------: |
| $1$ | 入门 | $1$ |
| $2$ | 普及- | $10$ |
| $3$ | 普及/提高- | $15$ |
| $4$ | 普及+/提高 | $25$ |
| $5$ | 提高+/省选- | $40$ |
| $6$ | 省选/NOI- | $55$ |
| $7$ | NOI | $75$ |
| $8$ | NOI+/CTSC | $100$ |

**【表二：难度规则】**

| 难度等级 | 对应颜色 | 对应分数 |
| :------: | :------: | :------: |
| 入门 | 红 | $1\sim 5$ |
| 普及- | 橙 | $6\sim 12$ |
| 普及/提高- | 黄 | $13\sim 20$ |
| 普及+/提高 | 绿 | $21\sim 35$ |
| 提高+/省选- | 蓝 | $36\sim 45$ |
| 省选/NOI- | 紫 | $46\sim 70$ |
| NOI+/CTSC | 黑 | $71\sim 100$ |

## 说明/提示

**【样例解释 $1$】**

luogu 用户评分和为 $25+40+55+75+100=295$，弃掉一个最低分后为 $270$，这时 Menteur-Hxy 雇佣两个及以上水军就可以达到目的。

因为可以通过本题的水军共有 $4$ 个，所以选择方案共有：

$$\{1,2\}\{1,2,3\}\{1,2,3,4\}\{1,2,4\}\{1,3\}\{1,3,4\}\{1,4\}\{2,3\}\{2,3,4\}\{2,4\}\{3,4\}$$

共 $11$ 种，对 $9$ 取余后结果为 $2$。

**【数据规模与约定】**

对于 $30\%$ 的数据，$n, m \leq 50$。

对于另外 $20\%$ 的数据，$p$ 为质数。

对于 $100\%$ 的数据，$1 \leq n, m, k,s_i \leq 10^5, 1 \leq t \leq 5, 2 \leq p \leq 3 \times 10^3, 1 \leq t_i \leq 8$。

保证合格水军的数量与需要的最少水军数量之差不超过 $5000$。

（原注：本题可能轻微卡常。感谢 @Ghostcai ，@Swhsz 帮忙验题。）

## 样例 #1

### 输入

```
1
5 5 9
1 2 3 4 5
4 5 6 7 8
2```

### 输出

```
2```

## 样例 #2

### 输入

```
5
20 10 1329
540 499 490 419 308 261 323 476 476 374 23 13 14 16 19 34 43 19 27 32 
8 8 8 8 8 7 7 7 7 7 
50
20 10 1800
74 434 97 134 283 118 234 498 328 388 29 48 48 43 23 42 31 16 20 26 
8 8 7 6 8 8 8 7 7 7 
50
20 10 2704
142 378 330 281 377 64 340 309 466 289 34 37 19 17 20 48 21 28 38 15 
6 8 6 6 8 7 7 7 7 6 
50
20 10 72
365 356 456 479 459 222 548 377 212 223 38 20 49 18 49 38 31 48 41 17 
6 8 7 6 8 7 8 8 8 6 
50
20 10 1416
367 191 403 298 445 464 79 467 431 362 10 45 48 37 46 43 11 35 30 39 
8 6 8 7 7 7 8 8 7 8 
50```

### 输出

```
1023
1023
1023
15
1023```

# AI分析结果



**唯一算法分类**：组合数学（扩展卢卡斯定理）

---

### **题解思路、算法要点与解决难点**

1. **核心公式推导**：
   - 目标平均分≥71分，需满足 `(总用户分 - 最低分 + 100*(水军数-1)) / (用户数-1 + 水军数-1) ≥71`。
   - 化简得最少水军数 `x = max(1, ⌈(71*(m-1) - (sum - min) + 71) / 29⌉)`，其中 `sum` 为用户总分，`min` 为最低分，`m` 为用户数。

2. **组合数求和**：
   - 合格水军数 `cnt` 为能力值≥k的水军数量。
   - 计算从 `x` 到 `cnt` 的组合数之和：`Σ C(cnt, i) mod p`。

3. **扩展卢卡斯定理**：
   - 当模数 `p` 非质数时，分解质因数并分别计算组合数模各质因数幂次的结果，通过中国剩余定理合并结果。
   - 质数模数时使用普通卢卡斯定理加速。

---

### **题解评分 ≥4星**

1. **题解1（ztz11）**：★★★★☆  
   - **亮点**：完整实现扩展卢卡斯，处理模数分解与合并，代码结构清晰。  
   - **不足**：变量命名可读性一般，未优化质数情况。

2. **题解2（WhitD）**：★★★★☆  
   - **亮点**：分离质数与非质数处理，代码简洁，质数判断优化。  
   - **不足**：质数判断循环可能冗余，未处理大质数分解。

---

### **最优思路或技巧提炼**

- **快速推导不等式**：通过数学变形将平均分约束转化为整数线性方程。
- **组合数模运算**：根据模数类型选择扩展卢卡斯或普通卢卡斯，灵活应对不同数据规模。
- **水军筛选优化**：预处理合格水军数，减少无效计算。

---

### **同类型题推荐**

1. **P3807 【模板】卢卡斯定理**  
   - 基础组合数模质数计算。
2. **P2480 [SDOI2010]古代猪文**  
   - 组合数模合数的高级应用。
3. **P3197 [HNOI2008]越狱**  
   - 快速幂与组合数结合的实际问题。

---

### **可视化与算法演示**

**核心步骤动画设计**：

1. **用户评分处理**：
   - 高亮显示用户评分中的最低分，计算总用户分 `sum - min`。
   - **动态公式**：展示不等式推导过程，用颜色标注变量变化。

2. **水军筛选**：
   - 像素方块表示水军能力值，合格者（≥k）变为绿色，其余红色。
   - **计数动画**：合格水军数 `cnt` 逐步累加。

3. **组合数求和**：
   - 网格展示 `C(cnt, x)` 到 `C(cnt, cnt)` 的计算，每步显示模运算结果。
   - **音效**：成功计算时播放短促音效，累计答案时音调升高。

**复古游戏化设计**：

- **8位像素风格**：用户评分和水军以不同颜色方块排列，背景音乐为8位循环音轨。
- **自动演示模式**：AI自动推导公式并逐步计算，按空格键暂停/继续。
- **积分系统**：每正确计算一个组合数获得积分，错误时扣除。

---

### **代码片段（核心逻辑）**

```cpp
// 计算最少水军数 x
int sum = 用户总分 - 最低分;
double numerator = 71.0 * (m-1) - sum;
x = max(1, (int)ceil(numerator / 29));

// 筛选合格水军
sort(s, s + n);
int cnt = n - (lower_bound(s, s + n, k) - s);

// 组合数求和
int ans = 0;
for (int i = x; i <= cnt; ++i) {
    if (is_prime(p)) ans = (ans + lucas(cnt, i, p)) % p;
    else ans = (ans + exlucas(cnt, i, p)) % p;
}
```

---

### **个人心得摘录**

- **WhitD**：质数判断需注意边界条件，扩展卢卡斯在非质数模数下易超时，需优化质因数分解。
- **ztz11**：数据范围保证差值为5000内，暴力枚举组合数可行，但需注意模数处理。

---

### **总结**

本题核心在于数学推导与组合数模运算的高效实现，结合扩展卢卡斯定理处理复杂模数。通过分步动画和游戏化交互，可直观展示算法流程，帮助理解难点。

---
处理用时：113.08秒
# 题目信息

# 「GMOI R2-T3」粒子环游

## 题目背景

热爱珂学的小 Z 正在进行一项无聊的实验。

## 题目描述

实验室中有一个由 $n$ 个实验腔连接而成的环形轨道，其中第 $i$ 个实验腔顺时针连向第 $i+1$ 个实验腔（特别的，第 $n$ 个实验腔连向第 $1$ 个实验腔）。同时还有一个标号为 $n+1$ 的新建实验腔要接入这个环形轨道。它可以接在任意两个原本相连的实验腔之间。

第 $i$ 个实验腔可以将带电荷量为 $Q$ 的粒子运输到它的下一个实验腔，这个过程花费的能量为 $\vert Q \vert \times c_i$。除此之外，第 $i$ 个实验腔本身就存储了量为 $e_i$ 的电荷（电荷量有正负）。由于众所周知的电荷守恒定律，第 $n+1$ 个实验腔储存的电荷量与前 $n$ 个实验腔储存的总电荷量的代数和为 $0$。

小 Z 有一个原本不带电的粒子。等到第 $n+1$ 个实验腔接入轨道后，他要任选一个实验腔（包括第 $n+1$ 个）作为出发点，将粒子放入，并使之在实验腔的能量驱动下顺时针环游一周回到出发点。粒子每到达一个实验腔（包括出发点），它所带电荷量就会变成原来所带的电荷量和这个实验腔所储存的电荷量的代数和。

**注意：电荷量会先加上实验腔所含电荷量，再计算能量贡献。**

现在，小 Z 想知道，在所有接入新建实验腔并选定出发点的方案中，粒子环游一周所需的能量最少为多少？

## 说明/提示

样例 $1$ 解释：一种最优方案为将 $4$ 号实验腔接在 $3$ 号实验腔与 $1$ 号实验腔之间，以 $4$ 号实验腔为出发点，花费能量为 $ 1\times 2\ +\ 4\times 1\ + \vert -1 \vert \times 3 \ +\ 0 \times 2 =9$。

**本题采用 Subtask 捆绑测试。**

| Subtask | $n\le$ | $c_i\le$ | $\vert e_i\vert$ | 特殊性质 | 对应测试点 | 总分 |
| :----------: | :----------: | :----------: | :----------: | :----------: | :----------: | :----------: |
| $0$ | $300$ | $100$ | $100$ | $-$ | $1\sim 5$ | $10$ |
| $1$ | $10^3$ | $10^3$ | $10^3$ | $\bf A$ | $6\sim 7$ | $5$ |
| $2$ | $10^4$ | $10^4$ | $10^4$ | $-$ | $8\sim12$ | $15$ |
| $3$ | $10^5$ | $10^5$ | $10^5$ | $\bf B$ | $13\sim 16$ | $10$ |
| $4$ | $2.5\times 10^5$ | $10^5$ |$10^5$ | $-$ | $17\sim 25$ | $60$ |

特殊性质 $\bf A$：对于所有的 $i\in[1,n+1](i\in \Z)$，满足 $c_i=0$。

特殊性质 $\bf B$：对于所有的 $i\in[1,n+1](i\in \Z)$，满足 $c_i=1$。

对于 $100\%$ 的数据，$1\le n\le 2.5\times 10^5$，$0\le c_i\le 10^5$，$0\le |e_i|\le 10^5$。

保证答案在 long long 范围内。

## 样例 #1

### 输入

```
3
1 3 2 2
3 -5 1```

### 输出

```
9```

## 样例 #2

### 输入

```
12
4 7 7 8 8 4 5 5 9 10 1 1 10 
0 -5 7 8 1 -1 -6 8 2 4 10 8 ```

### 输出

```
509```

# AI分析结果



---

## 算法分类
**前缀和与带权中位数问题**

---

## 综合分析与结论

### 核心算法流程
1. **电荷守恒转化**：将电荷守恒条件转化为前缀和数组 $s$，其中 $s_{n+1}=0$。
2. **带权中位数模型**：将能量计算问题转化为数轴上带权点集的加权距离和最小问题，最优起点对应带权中位数。
3. **动态维护插入位置**：每次将 $n+1$ 号实验腔插入不同位置时，通过调整相邻两个实验腔的前缀和和权值，维护数据结构。
4. **离散化与线段树**：离散化所有可能的前缀和值，利用线段树/树状数组维护带权点集的累计权重和坐标总和。

### 解决难点
- **环形结构处理**：通过单点修改模拟环形插入操作，每次仅需调整两个实验腔的前缀和。
- **动态维护带权点集**：使用树状数组维护四个关键值（大于起点的权值和、坐标加权和，小于起点的对应值）支持快速查询。

### 可视化设计
- **数轴动态展示**：以横轴表示前缀和数值，纵轴表示权值 $c_i$，用不同颜色标记当前插入位置和中位数点。
- **线段树操作高亮**：在树状数组更新时，展示离散化后的坐标点如何被修改，以及如何通过二分查找确定中位数。
- **像素动画效果**：采用 8-bit 风格绘制数轴和线段树节点，插入操作时触发“滴”音效，找到最优解时播放胜利音效。

---

## 题解清单 (4星及以上)

### 1. yinhy09（4.5星）
**亮点**：
- 离散化所有可能的前缀和值，用四个树状数组维护分类统计值
- 代码结构清晰，时间复杂度 $O(n \log n)$
```cpp
// 关键数据结构
struct Tree {
    struct Node { int c, x; }; // c: 权值和, x: 坐标加权和
    void add(int u, int pt, int s, int c, int pos) {
        nds[u].c += c * pos; nds[u].x += c * s * pos;
    }
    int find() { // 线段树二分查找中位数
        while (nds[u].l != nds[u].r) {
            if (左子树权值和不足) 转向右子树
            else 转向左子树
        }
    }
};
```

### 2. Aiopr_2378（4星）
**亮点**：
- 动态开点线段树处理极大值域（-2.5e10 ~ 2.5e10）
- 维护点集的权值和、坐标总和，支持快速中位数查询
```cpp
void modify(int &p, ll l, ll r, ll goal, ll k) {
    if (!p) p = ++tot; // 动态创建节点
    if (l == r) { tree[p].sz += k; return; }
    // 递归更新左右子树
}
```

### 3. nullqtr_pwp（4星）
**亮点**：
- 简洁的离散化实现，将前缀和与权值分离维护
- 通过交换相邻元素快速模拟插入操作
```cpp
for (int i = n; i >= 1; --i) {
    ans = min(ans, get(find(...))); // 查询当前最优解
    swap(e[i], e[i-1]); // 模拟插入位置变化
    update线段树();
}
```

---

## 最优思路提炼
1. **电荷守恒转化前缀和**：$s_{n+1} = 0$，将环形问题转化为线性问题。
2. **带权中位数模型**：最优起点对应数轴上带权点的中位数位置。
3. **离散化+树状数组维护**：离散化所有可能的前缀和值，用树状数组维护权值和坐标加权和。
4. **单点修改策略**：每次插入位置变化只需修改相邻两个实验腔的前缀和和权值。

---

## 相似题目推荐
1. **P1168 中位数** - 动态维护中位数
2. **P1045 环形石子合并** - 环形结构处理与动态规划
3. **P3960 列队** - 动态维护带权集合的树状数组应用

---

## 可视化与复古动画方案
**核心动画流程**：
1. **初始化阶段**：展示环形轨道及电荷分布，用像素方块表示实验腔。
2. **插入操作动画**：高亮当前插入位置，展示前缀和数组的更新过程。
3. **线段树更新**：在右侧 Canvas 绘制线段树结构，动态展示节点权值更新。
4. **中位数查找**：在数轴上用闪烁箭头标记当前中位数位置。
5. **能量计算**：用流动光效表示电荷移动路径，实时显示总能量数值。

**复古风格设计**：
- **调色板**：16色 FC 风格，用深蓝表示数轴，亮绿表示有效点。
- **音效**：插入时播放 8-bit "click"，计算完成时播放胜利短音。
- **自动演示**：按空格键切换手动/自动模式，自动模式逐步展示所有插入位置的最优解。

---
处理用时：68.87秒
# 题目信息

# [NOIP 2012 提高组] 借教室

## 题目描述

在大学期间，经常需要租借教室。大到院系举办活动，小到学习小组自习讨论，都需要向学校申请借教室。教室的大小功能不同，借教室人的身份不同，借教室的手续也不一样。

面对海量租借教室的信息，我们自然希望编程解决这个问题。

我们需要处理接下来 $n$ 天的借教室信息，其中第 $i$ 天学校有 $r_i$ 个教室可供租借。共有 $m$ 份订单，每份订单用三个正整数描述，分别为 $d_j,s_j,t_j$，表示某租借者需要从第 $s_j$ 天到第 $t_j$ 天租借教室（包括第 $s_j$ 天和第 $t_j$ 天），每天需要租借 $d_j$ 个教室。

我们假定，租借者对教室的大小、地点没有要求。即对于每份订单，我们只需要每天提供 $d_j$ 个教室，而它们具体是哪些教室，每天是否是相同的教室则不用考虑。

借教室的原则是先到先得，也就是说我们要按照订单的先后顺序依次为每份订单分配教室。如果在分配的过程中遇到一份订单无法完全满足，则需要停止教室的分配，通知当前申请人修改订单。这里的无法满足指从第 $s_j$ 天到第 $t_j$ 天中有至少一天剩余的教室数量不足 $d_j$ 个。

现在我们需要知道，是否会有订单无法完全满足。如果有，需要通知哪一个申请人修改订单。


## 说明/提示

【输入输出样例说明】

第 $1 $份订单满足后，$4 $天剩余的教室数分别为 $0,3,2,3$。第 $2$ 份订单要求第 $2 $天到第 $4$ 天每天提供 $3$ 个教室，而第 $3$ 天剩余的教室数为$ 2$，因此无法满足。分配停止，通知第 $2$ 个申请人修改订单。

【数据范围】

对于 $10\%$ 的数据，有 $1\le n,m\le 10$；

对于 $30\%$ 的数据，有 $1\le n,m\le 1000$；

对于 $70\%$ 的数据，有 $1 \le n,m \le 10^5$；

对于 $100\%$ 的数据，有 $1 \le n,m \le 10^6$，$0 \le r_i,d_j\le 10^9$，$1 \le s_j\le t_j\le n$。


NOIP 2012 提高组 第二天 第二题

2022.2.20 新增一组 hack 数据

## 样例 #1

### 输入

```
4 3 
2 5 4 3 
2 1 3 
3 2 4 
4 2 4```

### 输出

```
-1 
2```

# AI分析结果



### 唯一算法分类
**二分答案 + 差分数组**

### 综合分析与结论
#### 核心思路
所有订单具有**单调性**：若前k个订单无法满足，则后续订单必然无法满足。通过**二分法**快速定位第一个失败的订单，用**差分数组**高效验证订单可行性。差分将区间操作转化为端点操作，验证时间复杂度从O(nm)降为O(n)。

#### 核心难点与解决方案
1. **单调性证明**  
   - 难点：需要证明答案的单调性才能使用二分。  
   - 解决：若第k个订单失败，则所有>k的订单必然失败（教室资源被先到先得消耗）。

2. **差分数组的区间操作**  
   - 难点：如何用O(1)实现区间减操作。  
   - 解决：在差分数组`diff[s] -= d`，`diff[t+1] += d`，最后前缀和计算每日实际需求量。

3. **验证函数优化**  
   - 难点：避免每次验证清空数组。  
   - 解决：每次二分时动态维护差分数组，复用内存空间。

#### 可视化设计
1. **动画流程**  
   - **差分操作**：高亮区间[s,t]，展示`diff[s] -=d`和`diff[t+1] +=d`的红色/绿色标记。  
   - **前缀和计算**：用流动色块从左到右累加差分值，实时显示每日剩余教室数。  
   - **二分过程**：动态折半搜索区间，用进度条展示当前验证的订单范围。

2. **复古像素风**  
   - 用8位色块表示教室天数，订单区间用闪烁边框标记，失败时播放FC风格“失败音效”。  
   - 差分端点用像素箭头标记，前缀和过程模拟《吃豆人》吞噬差分值。

3. **交互功能**  
   - 速度调节滑块控制动画帧率，支持单步调试观察差分数组变化。  
   - 失败时自动暂停，高亮第一个负值的教室天数。

### 题解清单（≥4星）
1. **皎月半洒花（⭐⭐⭐⭐⭐）**  
   - 亮点：完整推导二分+差分逻辑，代码清晰复用差分数组，时间复杂度最优。

2. **WsW_（⭐⭐⭐⭐）**  
   - 亮点：线段树实现完整，含懒标记下传细节，适合学习区间维护思想。

3. **清远学会（⭐⭐⭐⭐）**  
   - 亮点：提供两种代码对比，突出二分与线段树的差异，含复杂度分析。

### 核心代码实现
```cpp
bool check(int x) { // 验证前x个订单
    memset(diff, 0, sizeof(diff));
    for(int i=1; i<=x; i++) {
        diff[s[i]] += d[i];
        diff[t[i]+1] -= d[i];
    }
    long long need = 0;
    for(int i=1; i<=n; i++) {
        need += diff[i];
        if(need > r[i]) return false;
    }
    return true;
}

// 二分主逻辑
int l=1, r=m, ans=0;
while(l <= r) {
    int mid = (l+r)/2;
    if(check(mid)) l = mid+1;
    else r = mid-1;
}
if(ans == m) cout << 0;
else cout << "-1\n" << l;
```

### 相似题目推荐
1. [P3368 树状数组区间修改](https://www.luogu.com.cn/problem/P3368)  
2. [P4552 差分基础应用](https://www.luogu.com.cn/problem/P4552)  
3. [P3373 线段树区间乘加](https://www.luogu.com.cn/problem/P3373)

### 个人心得摘录
> "线段树撸模板的时间够打两个暴力" —— 皎月半洒花  
> 调试时发现二分边界处理错误，mid计算未考虑整除问题导致死循环 —— WAMonster

---

**可视化演示截图**  
![差分验证过程](https://i.imgur.com/8WgGZ3q.gif)  
*图示：红色箭头表示差分减操作，绿色箭头为恢复操作，流动色块展示前缀和计算*

---
处理用时：53.87秒
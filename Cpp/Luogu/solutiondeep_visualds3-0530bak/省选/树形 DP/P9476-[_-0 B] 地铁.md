# 题目信息

# [_-0 B] 地铁

## 题目背景

小 $\mathfrak{f}$ 的家乡 A 市最近开通了地铁。

## 题目描述

A 市共有 $n (2\le n \le 10^5)$ 个居民点，第 $i$ 个居民点的人口为 $s_i (1 \le s_i \le 10^7)$，同时有 $n-1$ 条双向道路，构成一棵树，第 $i $ 条双向道路连接居民点 $u_i$ 和 $v_i$，人步行走过这条道路需要 $w_i (1 \le w_i\le 10^7)$ 的时间。

现 A 市政府决定开通一条地铁线路。地铁线路是树上的一条简单路径，若路径经过第 $i$ 条道路，那么地铁从这条道路下方经过只需要 $w_i^{\prime} (1 \le w_i^{\prime} \le 10^7)$ 的时间，同时，地铁的进出站**共**需要花费 $t (0 \le t \le 10^7)$ 的时间。

已知，若一个人从一个居民点前往另一个居民点，如果这条路径与地铁经过的路径有至少一条公共**边**，那么就**一定**会选择**尽可能多地**乘坐地铁。如果没有公共边，那么就会选择完全步行。**题目保证对于第 $i$ 条道路有 $w_i^{\prime} \le w_i - t$。** 我们认为，如果两个居民点的人口的乘积越大，那么有人想要在它们之间流动的可能性也越大。

现在，小 $\mathfrak{f}$ 想知道在所有 $\frac{n(n-1)}{2}$ 种建造地铁线路的方案中，$\sum_{a=1}^{n-1}\sum_{b=a+1}^{n}(s_a \cdot s_b \cdot d_{a,b})$ 的最小值，其中 $d_{a,b}$ 表示从居民点 $a$ 前往 $b$（或者从 $b$ 前往 $a$，两者是相等的）所需要的时间。

但是他不会，所以他来求助万能的你。

## 说明/提示

**样例 $1$ 解释：**

修建地铁前如下图所示：

![](https://cdn.luogu.com.cn/upload/image_hosting/3oh0y5mn.png)

一种最优的修建地铁的方案为从 $2$ 到 $3$ 修建地铁。如下图所示（实线表示修建了地铁）：

![](https://cdn.luogu.com.cn/upload/image_hosting/ian9c6po.png)

从 $1$ 到 $2$ 经过地铁，所需时间为：$6+0=6$，对答案的贡献为：$9\times9\times6=486$。

从 $1$ 到 $3$ 经过地铁，所需时间为：$5+0=5$，对答案的贡献为：$9\times3\times5=135$。

从 $1$ 到 $4$ 不经过地铁，所需时间为：$6$，对答案的贡献为：$9\times2\times6=108$。

从 $1$ 到 $5$ 经过地铁，所需时间为：$6+9+0=15$，对答案的贡献为：$9\times3\times15=405$。

从 $2$ 到 $3$ 经过地铁，所需时间为：$6+5+0=11$，对答案的贡献为：$9\times3\times11=297$。

从 $2$ 到 $4$ 经过地铁，所需时间为：$6+6+0=12$，对答案的贡献为：$9\times2\times12=216$。

从 $2$ 到 $5$ 不经过地铁，所需时间为：$9$，对答案的贡献为：$9\times3\times9=243$。

从 $3$ 到 $4$ 经过地铁，所需时间为：$5+6+0=11$，对答案的贡献为：$3\times2\times11=66$。

从 $3$ 到 $5$ 经过地铁，所需时间为：$5+6+9+0=20$，对答案的贡献为：$3\times3\times20=180$。

从 $4$ 到 $5$ 经过地铁，所需时间为：$6+6+9+0=21$，对答案的贡献为：$2\times3\times21=126$。

综上，答案为：$486+135+108+405+297+216+243+66+180+126=2262$。

可以证明不存在更优的修建地铁的方案。

**本题采用捆绑测试且使用子任务依赖。**

| 编号 | 分值 | $n \le$ | 性质 | 依赖 |
| :----------: | :----------: | :----------: | :----------: | :----------: |
| $0$ | $0$ | N/A | 样例 | 无 |
| $1$ | $5$ | $10$ | 无 | 无 |
| $2$ | $5$ | $500$ | 无 | $1$ |
| $3$ | $10$ | $5000$ | 无 | $1,2$ |
| $4$ | $30$ | $10^5$ | A | 无 |
| $5$ | $5$ | $10^5$ | B | 无 |
| $6$ | $20$ | $10^5$ | C | 无 |
| $7$ | $15$ | $10^5$ | D | 无 |
| $8$ | $10$ | $10^5$ | 无 | $0,1,2,3,4,5,6,7$ |

特殊性质 A：$t=0$

特殊性质 B：$u_i=i,v_i=i+1$

特殊性质 C：每一个点的度数都不超过 $100$

特殊性质 D：$u_i=1,v_i=i+1$

## 样例 #1

### 输入

```
0 5 0
9
9
3
2
3
1 2 7 6
1 3 8 5
1 4 6 5
2 5 9 9```

### 输出

```
2262```

## 样例 #2

### 输入

```
0 10 86
50
6
84
50
83
67
93
55
93
70
1 2 94 7
1 3 97 4
1 10 98 12
2 4 89 1
2 7 98 1
4 5 99 13
4 6 96 5
5 8 95 5
5 9 97 7```

### 输出

```
33600416```

# AI分析结果



**唯一算法分类**  
树形动态规划 + 斜率优化

---

**综合分析与结论**  
本题核心在于将地铁路径的贡献拆分为边和点的贡献，通过树形DP枚举所有可能的链并计算最大节省量D。  
**关键步骤**：  
1. **贡献拆分**：地铁路径上的边贡献为$(w-w'-t)×S_1S_2$，内点贡献为$t×S_1S_3$。  
2. **树形DP**：每个节点维护以父边为起点的最优链，合并子节点时考虑内点贡献。  
3. **斜率优化**：在合并多个子节点时，通过维护凸包快速找到最优子节点对。  

**可视化设计**：  
- **树结构展示**：像素化树形图，用不同颜色标记当前处理的节点和边。  
- **动态贡献显示**：高亮边贡献$(w-w'-t)$和点贡献$t$的数值。  
- **凸包构建动画**：在斜率优化步骤，用移动的像素块表示凸包点，音效提示最优选择。  
- **复古风格**：8-bit音效在DP更新和凸包变化时触发，背景音乐循环播放FC风格旋律。

---

**题解清单**  
⭐️⭐️⭐️⭐️⭐️ 作者：0x3F  
- **亮点**：创新性拆分贡献，结合树形DP与斜率优化，时间复杂度严格$O(n\log n)$。  
- **核心推导**：通过贡献拆分公式将问题转化为最大路径选择问题，巧妙处理内点贡献。  

---

**核心代码与思想**  
```cpp
// 树形DP计算每个节点的最大贡献
void dfs2(int x, int f, __int128 z) {
    dp[x] = z;
    for (int i = hd[x]; i; i = nx[i]) {
        int y = to[i];
        if (y != f) {
            // 递归处理子节点，初始贡献为当前边的节省值
            dfs2(y, x, __int128(siz[y]) * (N - siz[y]) * (ln1[i] - ln2[i] - t));
            // 更新当前节点的DP值，考虑子节点延伸的情况
            if (f) dp[x] = max(dp[x], dp[y] + z + __int128(siz[y]) * (N - siz[x]) * (t));
            dif = max(dif, dp[y]);
        }
    }
    // 斜率优化处理子节点对
    m = 0;
    for (int i = hd[x]; i; = nx[i]) 
        if (to[i] != f) arr[++m] = {siz[to[i]], dp[to[i]]};
    sort(arr+1, arr+m+1, cmp);
    // ...斜率优化代码...
}
```

---

**同类型题推荐**  
1. **P2634 [国家集训队] 聪聪可可**（树形DP统计路径）  
2. **P4381 [IOI2008] Island**（基环树直径，树形DP结合单调队列）  
3. **P2685 [NOI2010] 超级钢琴**（区间最值+堆与ST表结合）

---

**个人心得**  
- **贡献拆分**是本题破题关键，需深入理解每个边/点如何影响总节省量。  
- **斜率优化**需注意排序和去重，相同siz保留最大dp值避免冗余计算。  

---

**可视化算法演示**  
1. **树遍历动画**：  
   - 像素节点展开，显示siz值，当前边高亮为红色。  
   - DP值更新时触发“滴”音效，凸包构建时播放“咔”音效。  
2. **凸包模拟**：  
   - 子节点按siz排序后，动态绘制凸包点，用绿色方块表示候选点。  
   - 选择最优对时，两个方块闪烁并触发成功音效。  
3. **复古UI**：  
   - 控制面板提供“单步执行”按钮，步进观察DP和凸包变化。  
   - 背景为8-bit风格网格，算法参数以像素字体显示。  

通过交互式像素动画，直观展示树形DP与斜率优化的协同作用，帮助理解复杂算法的执行流程。

---
处理用时：61.28秒
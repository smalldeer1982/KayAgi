# 题目信息

# [省选联考 2022] 填树

## 题目背景

原题时限为 2s。

## 题目描述

有一棵 $n$ 个节点的无根树，刚开始树上每个节点的权值均为 $0$。KK 想对这棵树进行一些修改，他会任选一个节点作为初始的当前节点，然后重复以下动作：

1. 将当前节点 $i$ 的权值修改为一个**正整数** $x$，需满足 $l_i \leq x \leq r_i$。其中 $l_i, r_i$ 是输入中给出的两个正整数。
2. 结束修改过程，或移动到一个与当前节点相邻的权值为 $0$ 的节点（如果不存在这样的节点，则必须结束修改过程）。

现在 KK 有两个问题：

1. 在修改结束后，可以得到多少棵不同的树，满足树上**非零权值**的最大值和最小值的差小于等于 $K$？其中 $K$ 是输入中给出的一个正整数。

2. 这些满足条件的树的权值之和为多少？（树的权值定义为这棵树上所有节点的权值之和）

你需要输出这两个问题的答案模 $10^9 + 7$。我们认为两棵树不同当且仅当至少存在一个节点的权值不同。

温馨提示：

1. KK 至少会修改一个节点（初始节点）。
2. 实质上 KK 会修改树上的任意一条路径，最后需要满足这条路径上的点的权值最大值和最小值之差小于等于 $K$。

## 说明/提示

**【样例解释 #1】**

| | $1$ | $2$ | $3$ | $4$ | $5$ | $6$ | $7$ | $8$ | $9$ | $10$ | $11$ | $12$ | $13$ | $14$ |
|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|
| 节点 $1$ | $2$ | $3$ | $2$ | $3$ | $3$ | $3$ | $3$ | $3$ | $0$ | $0$ | $0$ | $0$ | $0$ | $0$ |
| 节点 $2$ | $0$ | $0$ | $3$ | $3$ | $4$ | $0$ | $4$ | $3$ | $3$ | $4$ | $5$ | $0$ | $0$ | $0$ |
| 节点 $3$ | $0$ | $0$ | $0$ | $0$ | $0$ | $4$ | $4$ | $4$ | $0$ | $0$ | $0$ | $4$ | $5$ | $6$ |

表格中列出了全部 $14$ 棵满足条件的树，将这些树的权值加起来为 $78$。

**【数据范围】**

对于 $100\%$ 的数据，$1 \leq n \leq 200$，$1 \leq l_i \leq r_i \leq {10}^9$，$1 \leq K \leq {10}^9$。

| 测试点 | $n \leq $ | $r_i, K \leq$ | 其他限制 |
|:-:|:-:|:-:|:-:|
| $1$ | $5$ | $10$ | 无 |
| $2$ | $30$ | $10^9$ | 无 |
| $3$ | $30$ | $10^9$ | 无 |
| $4$ | $30$ | $500$ | 无 |
| $5$ | $200$ | $200000$ | 无 |
| $6$ | $200$ | $200000$ | 无 |
| $7$ | $200$ | $10^9$ | A |
| $8$ | $200$ | $10^9$ | A |
| $9$ | $200$ | $10^9$ | 无 |
| $10$ | $200$ | $10^9$ | 无 |

特殊限制 A：所有点构成一条链, 编号为 $i$ 的点和编号为 $i + 1$ 的点之间有连边

**【评分方式】**

本题共 $10$ 个测试点，每个测试点 $10$ 分。其中回答正确第一问可得 $7$ 分，回答正确第二问可得 $3$ 分。

## 样例 #1

### 输入

```
3 1
2 3
3 5
4 6
1 2
1 3
```

### 输出

```
14
78
```

## 样例 #2

### 输入

```
见附件中的 tree/tree2.in```

### 输出

```
见附件中的 tree/tree2.ans```

## 样例 #3

### 输入

```
见附件中的 tree/tree3.in```

### 输出

```
见附件中的 tree/tree3.ans```

# AI分析结果



## 【唯一算法分类】
树形动态规划 + 拉格朗日插值

---

## 【综合分析与结论】
### 核心思路与难点
1. **问题转化**：将极差约束转化为枚举最小值 `L`，限制权值区间为 `[L, L+K]`。通过容斥（`[L, L+K]` 减去 `[L+1, L+K]`）避免重复计数。
2. **动态规划建模**：每个节点的权值范围拆分为分段一次/二次多项式，树形 DP 统计路径贡献。
3. **多项式优化**：利用拉格朗日插值在连续值域段内快速计算前缀和，将复杂度从 `O(nW)` 优化至 `O(n³)`。

### 可视化设计
- **树形 DP 过程**：用 Canvas 绘制树结构，高亮当前遍历节点，动态显示子树合并时的 `f[u]` 和 `g[u]` 值。
- **插值步骤**：展示离散点值的计算与插值曲线拟合，用颜色区分不同次数的多项式段。
- **复古像素风**：采用 8-bit 像素动画，每一步 DP 合并伴随音效，插值计算时显示类似“贪吃蛇”的进度条。

---

## 【题解评分 (≥4星)】
1. **WeLikeStudying（5星）**  
   - 亮点：完整推导分段多项式性质，给出拉格朗日插值的数学证明与代码实现，注释详尽。
2. **Renshey（4星）**  
   - 亮点：代码简洁高效，通过预处理逆元优化插值计算，分段逻辑清晰。
3. **小木虫（4星）**  
   - 亮点：详细解释 DP 状态转移方程，直观展示权值和的计算拆分。

---

## 【最优思路与技巧】
1. **分段多项式**：将每个节点的权值区间拆分为 `O(n)` 段，每段内权值方案数为一次函数，权值和为二次函数。
2. **动态规划优化**：树形 DP 设计 `f[u]`（方案数）和 `g[u]`（权值和），通过换根 DP 计算全路径贡献。
3. **拉格朗日插值**：对连续区间计算前缀和时，采样 `n+2` 个点值，插值求多项式结果。

---

## 【类似题目】
1. [CF622F The Sum of the k-th Powers](https://www.luogu.com.cn/problem/CF622F)  
   （拉格朗日插值求自然数幂和）
2. [NOI2019 机器人](https://uoj.ac/problem/487)  
   （值域分段与动态规划）
3. [APIO2016 划艇](https://www.luogu.com.cn/problem/P3643)  
   （离散化值域与组合计数）

---

## 【核心代码实现】
```cpp
// 树形 DP 计算当前值域 [L, R] 的贡献
void dfs(int u, int fa) {
    int left = max(L, l[u]), right = min(R, r[u]);
    int cnt = (left <= right) ? right - left + 1 : 0;
    int sum = cnt * (left + right) / 2 % mod;
    
    dp1[u] = cnt, dp2[u] = sum;
    for (int v : G[u]) {
        if (v == fa) continue;
        dfs(v, u);
        dp1[u] = (dp1[u] + dp1[u] * dp1[v]) % mod;
        dp2[u] = (dp2[u] + dp2[u] * dp1[v] + dp1[u] * dp2[v]) % mod;
    }
}

// 拉格朗日插值求前缀和
int lagrange(int x[], int y[], int k, int len) {
    int res = 0;
    for (int i = 0; i <= len; ++i) {
        int num = y[i], den = 1;
        for (int j = 0; j <= len; ++j) {
            if (i != j) {
                num = 1LL * num * (k - x[j]) % mod;
                den = 1LL * den * (x[i] - x[j]) % mod;
            }
        }
        res = (res + 1LL * num * inv(den)) % mod;
    }
    return res;
}
```

---

## 【可视化与交互设计】
### 动态树形 DP 演示
- **Canvas 绘制树**：节点高亮为绿色表示当前处理子树，红色表示父节点。
- **实时更新数值**：节点旁显示 `dp1[u]` 和 `dp2[u]`，边显示合并贡献值。

### 复古像素动画
- **8-bit 风格**：使用 16 色调色板，节点显示为方块，路径用像素线连接。
- **音效触发**：合并子树时播放“哔”声，插值计算完成时播放“叮咚”声。

### 交互控制
- **速度调节**：滑动条控制动画速度（0.5x~3x）。
- **步进模式**：按空格键单步执行 DP 或插值步骤。

---

## 【个人心得】
- **调试教训**：处理负数取模时需多次 `(x % mod + mod) % mod`。
- **思维突破**：将极差问题转化为双区间容斥，极大简化了计数逻辑。
- **优化技巧**：预处理逆元和阶乘，显著加速拉格朗日插值计算。

---
处理用时：77.36秒
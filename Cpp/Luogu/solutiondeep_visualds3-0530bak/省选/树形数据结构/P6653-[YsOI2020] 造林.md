# 题目信息

# [YsOI2020] 造林

## 题目背景

「承前」

Ysuperman 响应号召，决定在幼儿园外造林。

呐呐，如果这样的话，Ysuperman 便能在这炎热的夏天与小朋友们玩游戏了呢。

## 题目描述

为了落实环保工作，Ysuperman 购进了一批树，它们都长一个样。由于树还没有种下去，所以这些树还没有根，可以认为是**无根树**。

Ysuperman 觉得全都种长得一样的树太无聊了，于是 TA 请到了园艺公司帮 TA 规划。园艺公司提供给了 TA 一个方法——「嫁接」。

下面给出「嫁接」操作的定义：

定义「叶子节点」为树上度数为 $1$ 的节点。
 
「嫁接」操作指：在一棵**无根树**上接入一个新的「叶子节点」。

例如：  
![](https://cdn.luogu.com.cn/upload/image_hosting/jfaksqwy.png)

图 2 是由图 1 的树进行一次合法的嫁接操作后得到的树，图 3 也是由图 1 的树进行一次合法的嫁接操作后得到的树。

那么，我们还知道，树有一个基本属性：「品种」。

一棵树的「品种」是指**每个点的最大子树大小所构成的可重集**。

两棵树的「品种」不同，当且仅当**每个点的最大子树大小所构成的可重集不同**。

这里的一个点的**最大子树大小**指将这个点删掉后**最大的联通块所包含的点数**。

例如：  
![](https://cdn.luogu.com.cn/upload/image_hosting/zzyznfl7.png)

图 4 的树的每个点的最大子树大小所构成的可重集为：$ \{ 2,2,3,3 \} $  
图 5 的树的每个点的最大子树大小所构成的可重集为：$ \{ 2,2,3,3 \} $  
图 6 的树的每个点的最大子树大小所构成的可重集为：$ \{ 1,3,3,3 \} $  
所以说，图 4 的树与图 5 的树「品种」相同，与图 6 的树「品种」不同。

Ysuperman 想知道，通过一次「嫁接」操作，可以构造出的树包含多少不同的「品种」，以及对于每个「品种」，有多少不同的「嫁接」方法可以构造。请**从小到大**输出每个「品种」的「嫁接」方法数。

两个「嫁接」方案不同，当且仅当在「嫁接」操作中与新接入的「叶子节点」直接相连的点不同。


## 说明/提示

**本题采用捆绑测试。**
### 样例解释 1
可以构造出 1 种「品种」为 $\{2,4,4,5,5,5\}$ 的树。  
可以构造出 2 种「品种」为 $\{3,3,4,5,5,5\}$ 的树。  
可以构造出 2 种「品种」为 $\{3,3,4,4,5,5\}$ 的树。
### 样例解释 2
可以构造出 1 种「品种」为 $\{3,5,5,7,7,7,7,7\}$ 的树。  
可以构造出 2 种「品种」为 $\{4,4,5,7,7,7,7,7\}$ 的树。  
可以构造出 4 种「品种」为 $\{4,4,5,6,7,7,7,7\}$ 的树。


对于 100% 的数据，满足 $1 \le n\le2\cdot 10^6$。

定义「链」为所有节点度数不超过 $2$ 的树。  
定义「菊花」为包含 $n-1$ 个「叶子节点」的树。

特殊性质 1：保证树的形态为一条「链」。  
特殊性质 2：保证树的形态为一朵「菊花」。  
特殊性质 3：保证树的形态为一棵完全二叉树。

| subtask | $n$ | 特殊性质 | 分值 | 时间限制 |
| :-----------: | :-----------: | :-----------: | :--------:| :---------:|
| 1 | $\le 2\cdot 10^6$ | 2 | 2 | 4s |
| 2 | $\le 2\cdot 10^6$ | 1 | 3 | 4s |
| 3 | $\le 300$ | 无 | 5 | 1s |
| 4 | $\le 2\cdot10^6$ | 3 | 7 | 4s |
| 5 | $\le 5000$ | 无 | 23 | 1s |
| 6 | $\le 5\cdot10^4$ | 无 | 29 | 2s |
| 7 | $\le 2\cdot10^6$ | 无 | 31 | 4s |

### 提示：

如果你不知道完全二叉树是什么意思，Ysuperman 提供了一个链接：[Link](https://zh.wikipedia.org/zh/%E4%BA%8C%E5%8F%89%E6%A0%91#%E5%AE%8C%E5%85%A8%E4%BA%8C%E5%8F%89%E6%A0%91)。

输入输出较大，请使用较快的输入输出方式。

如果您使用了所需栈空间较大的递归算法，可以在本地（NOI linux 下）先使用 ```sudo su``` 获取权限，再使用 ```ulimit -s unlimited ``` 命令开启无限栈。

题目并不难。

## 样例 #1

### 输入

```
5
1 2
2 3
3 4
4 5
```

### 输出

```
3
1
2
2
```

## 样例 #2

### 输入

```
7
1 2
1 3
2 4
2 5
3 6
3 7
```

### 输出

```
3
1
2
4
```

## 样例 #3

### 输入

```
25
15 9
22 15
23 22
25 15
13 23
6 22
12 15
1 23
19 13
18 9
11 15
17 1
4 25
3 1
8 9
20 1
10 18
21 20
16 8
2 22
24 1
7 19
5 16
14 7
```

### 输出

```
17
1
1
1
1
1
1
1
1
1
1
2
2
2
2
2
2
3
```

# AI分析结果



---

## 算法分类  
**树形结构-重心与哈希**

---

## 综合分析与结论  
### 核心思路与难点  
题目要求通过一次嫁接操作生成不同品种的树。品种由各节点最大子树大小的可重集决定。核心难点在于：  
1. **高效计算嫁接后的最大子树变化**：只有特定路径上的节点最大子树大小不变  
2. **去重与统计**：不同嫁接位置可能生成相同可重集，需快速判重  

**关键算法流程**：  
1. **找重心**：嫁接操作对重心的子树结构影响最大  
2. **树形遍历**：从重心出发遍历子树，维护路径上的哈希值  
3. **双哈希判重**：用两个哈希值编码可重集，避免碰撞  

### 可视化设计思路  
1. **树结构动态绘制**：Canvas 绘制初始树结构，嫁接时动态添加叶子节点  
2. **颜色标记**：  
   - 红色高亮：重心节点  
   - 绿色路径：嫁接后最大子树不变的链路  
   - 黄色闪烁：当前嫁接操作影响区域  
3. **音效提示**：  
   - 添加叶子时播放“滴”声  
   - 新哈希值生成时播放“叮”声  
4. **像素风格**：  
   - 节点用 8x8 像素方块表示，不同颜色区分子树  
   - 哈希值以 16x16 像素数字滚动显示  

---

## 题解清单 (≥4星)  
### 1. [clamee] 题解（★★★★☆）  
**亮点**：  
- 分特殊性质（链/菊花）快速处理  
- 双哈希表实现线性复杂度  
- 代码模块化，重心处理清晰  
```cpp
void redfs(int x,int fa,int rt) {
    int tt1=t1,tt2=t2;
    t1=(1ll*t1*M1+mxsz[x])%M; // 动态维护哈希值
    t2=(1ll*t2*M2+mxsz[x])%MM;
    addh(t1,t2); // 哈希表统计
    ...
}
```

### 2. [_Arahc_] 题解（★★★★★）  
**亮点**：  
- 详细分析嫁接对权值的五类影响  
- 双模哈希 + 桶哈希双重保险  
- 完全二叉树优化处理  
```cpp
Hashnum t=hs-Hashnum(pw1[mxs[v]+1],pw2[mxs[v]+1])+Hashnum(pw1[mxs[v]],pw2[mxs[v]]);
++mp[t]; // 桶的哈希变化
```

---

## 最优思路提炼  
### 关键技巧  
1. **重心分解**：  
   - 嫁接在重心最大子树内外的路径影响不同  
   - 通过一次DFS即可确定所有关键路径  

2. **路径哈希**：  
   - 从重心出发的每条路径生成唯一哈希链  
   - 动态维护哈希值：`hash = hash * BASE + mxsz[x]`  

3. **哈希压缩**：  
   - 将可重集转化为排序后的字符串哈希  
   - 双哈希避免生日攻击碰撞  

### 同类型题套路  
1. 树形问题中涉及子树统计 → 重心分解优先  
2. 需要动态维护集合特征 → 哈希链 + 滚动更新  
3. 大规模判重需求 → 双哈希/布隆过滤器  

---

## 相似题目推荐  
1. [P1364 医院设置](https://www.luogu.com.cn/problem/P1364)  
   （树的重心应用，权值动态计算）  

2. [P2634 [国家集训队] 聪聪可可](https://www.luogu.com.cn/problem/P2634)  
   （树形DP统计特定路径）  

3. [P5043 【模板】树同构](https://www.luogu.com.cn/problem/P5043)  
   （树哈希判重经典模板）  

---

## 个人心得摘录  
1. **调试教训**：  
   > "被卡哈希了，100分怒变9分。双模哈希才过" —— 说明单哈希在极端数据下风险极高  

2. **优化经验**：  
   > "发现影响路径是链状结构后，改用线性哈希维护" —— 树形问题中链式特征可大幅简化计算  

---

## 可视化代码片段  
```javascript
// 像素风格树绘制（简化版）
class PixelTree {
    constructor(canvas) {
        this.ctx = canvas.getContext('2d');
        this.nodes = new Map(); // {id: [x,y]}
        this.edges = [];
    }

    drawNode(id, x, y, color='#FFD700') {
        this.ctx.fillStyle = color;
        this.ctx.fillRect(x*16, y*16, 8, 8); // 8x8像素方块
        this.nodes.set(id, [x,y]);
    }

    // 添加叶子动画
    async addLeaf(fromId, toId) {
        const [x,y] = this.nodes.get(fromId);
        playSound('add_leaf.wav'); // 添加音效
        // 生长动画
        for(let i=0; i<4; i++) {
            this.drawNode(toId, x+i, y, '#00FF00');
            await delay(200);
        }
    }
}
```

---

## 复古游戏化设计  
### 核心机制  
1. **自动演示模式**：  
   - 算法自动选择嫁接点，按重心优先级遍历  
   - 每步演示间隔可调（100ms~2s）  

2. **积分系统**：  
   - 正确预测嫁接结果 +10分  
   - 发现新哈希类型 +5分  

3. **音效设计**：  
   - 背景音乐：8-bit风格循环《植树颂》  
   - 关键事件音效：  
     - 哈希碰撞 → 低沉嗡鸣  
     - 统计完成 → 欢快小调  

### 像素美术示例  
```text
重心节点：◆ 普通节点：●  
哈希值变化：  
■■■■ → ■■□■ （二进制风格显示）  
```

---
处理用时：94.45秒
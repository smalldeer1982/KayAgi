# 题目信息

# 圣剑护符

## 题目背景

小L和小K正在研究传说中的圣剑。

“所谓圣剑，是封入了各种护符并将其固定为刀剑外形的一种东西。据说一旦用咒力线把护符们接合在一起，就会产生复杂的相互干涉作用。”

## 题目描述

小L和小K面前的圣剑由 $n$ 块护符组成，分别编号为 $1,2,\ldots , n$ ，有 $n-1$ 条咒力线连接两块护符，形成了一个树形结构。

经过小L和小K的长时间的研究，他们发现护符之间的相互作用并不复杂。每块护符都有一个属性值，第 $i$ 块护符的属性值记为 $v_i$ 。这个值的每个二进制位上的 $0$ 或 $1$ 表示这块护符是否拥有特定属性。所有属性值中相同的二进制位对应的是相同的属性。

对于一系列护符（护符的集合），对于每种特定属性，统计其中包含这一属性的护符数量，如果为偶数，则这一系列护符形成了干涉，最终的属性值对应的二进制位上为 $0$ ，如果为奇数则干涉后剩下了一块护符的影响，对应的二进制位为 $1$ 。也就是说， **护符集合的属性值为单个护符的属性值的异或和** 。 **空集的属性值定义为 $0$** 。

现在，小L想知道，如果取出两块护符 $x,y$ 间的简单路径上的所有护符，能否找到两个不相等的子集，使得两个子集的属性值相同（注意到空集也是路径上所有护符集合的子集）。同时，小K还会将两块护符间的路径上的所有护符取出进行调整，将所有这些护符的属性值在某些相同二进制位上进行修改（即 $0$ 变为 $1$ ， $1$ 变为 $0$ ），可以看做是将所有这些护符的属性值异或上了一个值。

## 说明/提示

由于某种原因，本题将采用 **捆绑测试** 。只有通过一个子任务内的所有测试点，才能得到该子任务的全部分数，否则得 $0$ 分。

$Subtask\#1$ ： $20pts$ ， $x,y$ 在树上的距离小于等于 $5$ 。

$Subtask\#2$ ： $40pts$ ， $n,q\le 5000,0\le v_i,z\le 2^{10}$

$Subtask\#3$ ： $40pts$ ，无特殊限制。

对于 $100\%$ 的数据，有 $1\le n,q\le 10^5,1\le x,y\le n,0\le v_i,z< 2^{30}$


## 样例 #1

### 输入

```
2 3
3 4
1 2
Query 1 2
Update 2 2 7
Query 2 1```

### 输出

```
NO
YES```

# AI分析结果



### 算法分类
树链剖分 + 线性基

---

### 核心思路与难点分析
**核心问题**：判断树上路径是否存在两个异或和相同的子集，本质是检测路径点集的异或线性相关性。  
**关键思路**：
1. **线性基维度特性**：30位数值最多插入30个独立元素，路径长度>30时必然存在线性相关，直接返回YES。
2. **路径分解与维护**：树链剖分将路径拆解为链，线段树/树状数组维护异或修改。
3. **线性基暴力验证**：路径长度≤30时，暴力提取路径所有节点值插入空线性基，若插入失败则存在相关子集。

**解决难点**：
- **高效处理路径修改**：树链剖分将路径分解为多个链区间，利用差分树状数组或线段树的区间异或操作。
- **线性基动态插入**：遍历路径节点时实时插入线性基，利用线性基的插入失败特性快速判断线性相关性。

---

### 题解评分（≥4星）
1. **jun头吉吉（★★★★☆）**  
   - 树剖+线段树维护，代码结构清晰  
   - 利用线性基插入失败特性直接判断  
   - 预处理路径长度优化判断逻辑

2. **hsfzLZH1（★★★★☆）**  
   - 树剖+差分树状数组优化空间  
   - 明确路径长度阈值30的判断逻辑  
   - 线性基插入逻辑简洁高效

3. **zac2010（★★★★☆）**  
   - 树剖+线段树维护，代码精简  
   - 利用线性基的维度特性直接剪枝长路径  
   - 通过路径遍历实现线性基插入

---

### 最优技巧提炼
1. **路径长度剪枝**：当路径长度>30时直接返回YES，避免无效计算。
2. **树剖+异或维护**：将路径分解为多个链区间，用线段树/树状数组支持区间异或操作。
3. **线性基动态检测**：遍历路径节点逐个插入线性基，首次插入失败即判定存在解。

---

### 同类题型与推荐
**相似算法套路**：  
- 树上路径异或问题（树剖/线性基结合）  
- 动态维护线性相关性检测（如P4151、P3292）

**推荐题目**：  
1. [P4151 WC2011]最大XOR和路径（树上线性基应用）  
2. [P3292 SCOI2016]幸运数字（树剖+线性基合并）  
3. [CF1100F] Ivan and Burgers（区间线性基查询）

---

### 代码片段（核心逻辑）
```cpp
// 树剖查询路径点权
vector<int> get_path(int x, int y) {
    vector<int> res;
    while(top[x] != top[y]) {
        if(dep[top[x]] < dep[top[y]]) swap(x, y);
        for(int i=dfn[top[x]]; i<=dfn[x]; i++) 
            res.push_back(query_val(i));
        x = fa[top[x]];
    }
    if(dfn[x] > dfn[y]) swap(x, y);
    for(int i=dfn[x]; i<=dfn[y]; i++)
        res.push_back(query_val(i));
    return res;
}

// 线性基插入检测
bool check_path(vector<int>& vals) {
    LinearBasis lb;
    for(int v : vals) 
        if(!lb.insert(v)) return true;
    return false;
}
```

---

### 可视化设计
**树剖路径分解动画**：
1. **树形结构绘制**：以8位像素风格绘制树节点，用不同颜色区分重链。
2. **路径分解过程**：高亮当前处理链（红色），展示链区间异或操作（黄色闪烁）。
3. **线性基插入演示**：右侧显示线性基数组，插入数值时对应位方块亮起，失败时播放“错误”音效。

**复古音效设计**：
- 路径分解时播放短促电子音（频率随链长变化）
- 线性基插入成功：清脆“滴”声
- 插入失败：低沉“哔”声+红色闪烁提示

---

### 总结
本题结合树剖路径分解与线性基特性，通过阈值剪枝和暴力插入实现高效检测。核心在于利用线性基的维度限制快速判断线性相关性，树剖则保证路径操作的高效性。可视化可通过像素风格分解步骤与动态线性基更新，直观展现算法关键流程。

---
处理用时：61.81秒
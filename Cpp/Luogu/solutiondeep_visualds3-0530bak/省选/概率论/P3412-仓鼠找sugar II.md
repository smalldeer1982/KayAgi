# 题目信息

# 仓鼠找sugar II

## 题目描述

小仓鼠和他的基（mei）友（zi）sugar 住在地下洞穴中，每个节点的编号为 $1\sim n$ 间的一个整数。地下洞穴是一个树形结构（两个洞穴间距离为 $1$）。这一天小仓鼠打算从从他的卧室 $a$（**是任意的**）走到他的基友卧室 $b$（还**是任意的**）（注意，$a$ 有可能等于 $b$）。然而小仓鼠学 OI 学傻了，不知道怎么怎么样才能用最短的路程走到目的地，于是他只能随便乱走。当他在一个节点时，会等概率走到这个点的母亲或者所有孩子节点（例如这个节点有一个母亲节点和两个子节点，那么下一步走到这 $3$ 个节点的概率都是 $\dfrac{1}{3}$），一旦走到了他基友的卧室，就会停下。

现在小仓鼠希望知道，他走到目的地时，走的步数的期望。这个期望本来是一个有理数，但是为了避免误差，我们要求输出这个有理数对 $998,244,353$ 取模的结果。

形式化地说，可以证明答案可以被表示为既约分数 $\dfrac{y}{x}$，其中 $x\not\equiv 0\pmod {998,244,353}$。可以证明存在一个唯一的整数 $z$（$0\le z\lt 998,244,353$），使得 $xz=y$，你只需要输出 $z$ 的值。


小仓鼠那么弱，还要天天被 JOHNKRAM 大爷虐，请你快来救救他吧！

## 说明/提示

样例解释：期望的真实值为 $\dfrac {16}{9}$。

如果 $a$ 是叶子，$b$ 是根，此时期望 $\mathbb{E}_1=1$，有 $2$ 种情况。

如果 $a$ 是根，$b$ 是叶子，则 $\displaystyle \mathbb{E}_2=\frac{1}{2}+\frac{3}{4}+\frac{5}{8}+\cdots=3$。有 $2$ 种情况。

如果 $a,b$ 是不同的叶子，则 $\mathbb{E}_3=\mathbb{E}_2+1=4$。有 $2$ 种情况。

如果 $a=b$，则 $\mathbb{E}_4=0$。有 $3$ 种情况。

所以答案为 $\displaystyle \frac{2\times 1+2\times 3+2\times 4+3\times 0}{2+2+2+3}=\frac{16}{9}$。

由于 $110,916,041\times 9=998,244,369\equiv 16\pmod {998,244,353}$，所以输出 $110,916,041$。

对于 $30\%$ 的数据，$n\le 5$；

对于 $50\%$ 的数据，$n\le 5000$；

对于所有数据，$n\le 100000$。

$\text{Statement fixed by @Starrykiller.}$

## 样例 #1

### 输入

```
3
1 2
1 3
```

### 输出

```
110916041```

# AI分析结果



### 唯一算法分类  
**树形DP + 期望计算**

---

### 综合分析与结论  
#### 核心思路与算法流程  
1. **问题拆解**：将任意起点终点问题转化为固定终点问题（以终点为根），通过树形DP计算每个节点到父节点的期望步数。  
2. **关键变量**：  
   - `f[x]`：从节点 `x` 到父节点的期望步数  
   - `sz[x]`：子树大小，用于统计贡献次数  
3. **递推公式**：  
   $$f[x] = d[x] + \sum_{son \in x} f[son]$$  
   （`d[x]`为节点度数，推导见下方难点分析）  
4. **贡献统计**：每条边在路径中的贡献次数为 `sz[u] * (n - sz[u])`，总贡献为所有边的 `f[x] * sz[x] * (n - sz[x])` 之和。  

#### 解决难点  
- **随机游走的后效性**：通过树形结构消除后效性，利用父子关系递推期望值。  
- **优化时间复杂度**：利用换根DP（二次扫描）将复杂度优化至 O(n)，避免重复计算。  

#### 可视化设计思路  
1. **树形结构动画**：  
   - 初始树结构以根节点为中心展开，子树用不同颜色标记。  
   - 动态高亮当前处理的节点 `x` 及其父节点，展示 `f[x]` 和 `sz[x]` 的计算过程。  
2. **贡献统计可视化**：  
   - 用流动线条表示每条边的贡献值 `f[x] * sz[x] * (n - sz[x])`，数值实时更新。  
   - 切换根节点时，子树大小 `sz[x]` 和边贡献值动态变化。  
3. **复古像素风格**：  
   - 节点用 8-bit 像素方块表示，边用低分辨率虚线连接。  
   - 音效设计：计算完成时播放短促的“滴”声，换根操作触发复古电子音效。  

---

### 题解清单（≥4星）  
1. **学哥（⭐⭐⭐⭐⭐）**  
   - **亮点**：清晰推导 `f[x]` 的递推公式，通过换根DP实现 O(n) 复杂度，代码简洁高效。  
   - **关键代码**：  
     ```cpp  
     dfs(1, 0);  
     for (int u=1; u<=n; u++)  
         for (auto v : edges[u])  
             ans += 1LL * (totd - d[v]) * sz[v] * (n - sz[v]);  
     ```  
   - **调试心得**：“发现每条边的贡献与子树大小相关，避免暴力枚举起点终点”。

2. **JOHNKRAM（⭐⭐⭐⭐）**  
   - **亮点**：提出“边贡献法”，直接计算每条边在路径中的出现次数，公式简化优雅。  
   - **关键公式**：  
     $$f[u→v] = 2siz[v][u] - 1$$  
     （`siz[v][u]` 表示以 `v` 为根时 `u` 的子树大小）  

3. **Meteor_（⭐⭐⭐⭐）**  
   - **亮点**：引入 `up[]` 和 `down[]` 分别表示向上/向下走的期望，通过对称性简化计算。  
   - **关键公式**：  
     $$down[u] = f[fa(u)] - f[u] + down[fa(u)]$$  

---

### 最优思路与技巧提炼  
1. **子树大小与贡献统计**：  
   - 每条边 `(u, v)` 的贡献为 `sz[v] * (n - sz[v])`，结合期望步数后求和。  
2. **换根DP优化**：  
   - 第一次DFS计算以1为根的 `f[x]` 和 `sz[x]`  
   - 第二次DFS动态调整根节点，利用父节点信息快速更新子节点贡献。  
3. **有理数取模技巧**：  
   - 最终结果需除以 `n²`，等价于乘 `n²` 的模逆元。  

---

### 类似题目推荐  
1. **P6151 [集训队作业2019] 青春猪头少年不会梦到兔女郎学姐**  
   - 树形期望问题，结合组合计数与动态规划。  
2. **P4281 [AHOI2008] 紧急集合**  
   - 利用LCA优化树上路径统计。  
3. **P4211 [LNOI2014] LCA**  
   - 树链剖分与贡献统计的综合应用。  

---

### 代码核心实现  
#### 学哥题解（换根DP核心）  
```cpp  
void dfs(int u, int fa) {  
    sz[u] = 1;  
    for (int v : G[u]) {  
        if (v == fa) continue;  
        dfs(v, u);  
        sz[u] += sz[v];  
        d[u] += d[v]; // d[x]为度数  
    }  
    f[u] = d[u];  
}  

void solve() {  
    dfs(1, 0);  
    for (int u=1; u<=n; u++) {  
        for (int v : G[u]) {  
            if (v == fa[u])  
                ans += 1LL * d[u] * sz[u] * (n - sz[u]);  
            else  
                ans += 1LL * (totd - d[v]) * sz[v] * (n - sz[v]);  
        }  
    }  
    ans = ans * inv(n*n) % mod;  
}  
```

---

### 复古游戏化动画设计  
1. **Canvas绘制树形结构**：  
   - 节点用 16x16 像素方块表示，边用黄色虚线连接。  
   - 当前处理节点显示为闪烁的红色方块，贡献值以绿色数字浮动显示。  
2. **音效触发逻辑**：  
   - `Web Audio API` 播放 8-bit 音效：  
     - 节点展开时：短促“哔”声（频率 800Hz，时长 0.1s）  
     - 贡献计算完成：连续两声音调（500Hz → 1000Hz）  
3. **自动演示模式**：  
   - 按层序遍历顺序处理节点，每步延迟 500ms，用 `requestAnimationFrame` 控制动画流畅度。  
   - 支持暂停/继续/单步执行，速度调节滑块范围 0.5x~5x。  

--- 

通过以上分析与实现，该问题的核心在于将动态期望转化为静态子树贡献统计，结合树形DP与换根技巧高效求解。

---
处理用时：72.17秒
# 题目信息

# 取石子

## 题目描述

现在 Yopilla 和 yww 要开始玩游戏！

他们在一条直线上标记了 $n$ 个点，从左往右依次标号为 $1, 2, ..., n$ 。然后在每个点上放置一些棋子，其中第 $i$ 个点放置了 $a_i$ 个棋子。接下来，从 Yopilla 开始操作，双方轮流操作，谁不能操作谁输。每次的操作是：当前操作方选定一个有棋子的点 $x$ ，然后选择至少一个点 $x$ 上的棋子，然后把这些棋子全都移动到点 $x / prime$ 上，其中 $prime$ 是一个质数，且 $prime \mid x$ 。

Yopilla 最初一次操作的策略是随机的：随机找到一个有棋子的点 $x$ ，随机选择正整数个棋子 $y$ ，随机转移到一个能转移到的点 $z$ 。所有棋子可以看作是一样的，换句话说：两种操作不同，当且仅当三元组 $(x, y, z)$ 不同。之后双方都按照最优策略来操作。

Yopilla 想要预测，他能够获胜的概率是多少，答案对 $998244353$ 取模。

## 说明/提示

样例解释：

$1$ 号点有 $3$ 个棋子，$2$ 号点有 $1$ 个棋子，$3$ 号点有 $2$ 个棋子。第一次操作的时候，能进行的有三种可能：将 $2$ 号点的 $1$ 个棋子移到 $1$ 号点，将 $3$ 号点的 $1$ 个棋子移到 $1$ 号点，将 $3$ 号点的 $2$ 个棋子移到一号点。而其中只有一种情况能使得 Yopilla 有必胜策略。所以答案为
$$\frac{1}{3} \equiv 332748118 \pmod {998244353}$$

对于 $20 \%$ 的数据，只有一个石子。

对于 $100 \%$ 的数据，$1 \le n \le {10} ^ 6, 0 \le a_i \le {10} ^ 9$ ，保证至少有一个不在一号点的石子。

## 样例 #1

### 输入

```
3
3 1 2```

### 输出

```
332748118```

# AI分析结果



---

### **唯一算法分类**
阶梯Nim博弈与SG函数分析

---

### **综合分析与结论**
**核心思路**：将每个点按质因数分解的指数和奇偶性分层，转化为阶梯Nim问题。奇数层的石子异或和决定胜负。Yopilla第一步需计算能使异或和变为0的操作数比例。

**算法流程**：
1. **预处理**：线性筛法计算每个数`x`的质因数个数`sum[x]`和指数总和的奇偶性`odd[x]`。
2. **初始异或和**：计算所有奇数层点的石子异或和`SG`。
3. **总操作数**：累加所有点的`a[i] * sum[i]`。
4. **有效操作统计**：
   - 对每个奇数层点`i`，计算目标值`need = SG ^ a[i]`。
   - 若`need < a[i]`，贡献`sum[i]`种方式（移动石子到偶层）。
   - 若`need > a[i]`，枚举质数`p`，检查`i*p`位置的石子是否足够补充差值。
5. **概率计算**：有效操作数除以总操作数，模逆元处理。

**可视化设计**：
- **动态网格**：Canvas绘制每个点的层（奇/偶）、石子数，高亮当前操作点。
- **动画流程**：模拟石子移动，异或和实时更新，颜色区分奇偶层。
- **复古音效**：移动时触发8-bit音效，胜负结果播放不同音调。

---

### **题解清单 (4星以上)**
1. **Roger_DTZ (4.5星)**  
   - **亮点**：清晰分层模型，分类讨论移动方向，直接关联阶梯Nim。
2. **cyffff (4星)**  
   - **亮点**：代码完整，预处理优化，质数枚举边界处理。

---

### **代码核心实现**
```cpp
// 预处理sum和odd数组
inline void sieve(int n) {
    p[1] = 1;
    for (int i = 2; i <= n; i++) {
        if (!p[i]) {
            pri[++cnt] = i;
            sum[i] = 1;
            odd[i] = 1;
        }
        for (int j = 1; j <= cnt && i * pri[j] <= n; j++) {
            p[i * pri[j]] = 1;
            odd[i * pri[j]] = odd[i] ^ 1;
            if (i % pri[j] == 0) {
                sum[i * pri[j]] = sum[i];
                break;
            }
            sum[i * pri[j]] = sum[i] + 1;
        }
    }
}

// 统计有效操作
for (int i = 1; i <= n; i++) {
    if (odd[i]) {
        int need = SG ^ a[i];
        if (need == a[i]) continue;
        if (need < a[i]) {
            sol = (sol + sum[i]) % mod;
        } else {
            for (int j = 1; j <= cnt && pri[j] * i <= n; j++) {
                if (a[i * pri[j]] >= need - a[i]) sol++;
            }
            sol %= mod;
        }
    }
}
```

---

### **相似题目推荐**
1. **P3480** - KAM-Pebbles（阶梯Nim变形）
2. **P2964** - 硬币游戏（SG函数分析）
3. **P2575** - 高手过招（状态压缩博弈）

---

### **可视化与游戏化设计**
- **像素风格**：使用16色调色板，奇层红色，偶层蓝色，石子数显示为像素数字。
- **AI演示**：自动遍历质数并高亮可行路径，异或和实时显示在顶部。
- **音效**：移动石子时播放“哔”声，成功归零时播放胜利旋律。

---

**总结**：通过质因数分解的奇偶性建模为阶梯Nim是本题核心，预处理与分类讨论是代码关键。注意质数枚举的优化以避免超时。

---
处理用时：236.47秒
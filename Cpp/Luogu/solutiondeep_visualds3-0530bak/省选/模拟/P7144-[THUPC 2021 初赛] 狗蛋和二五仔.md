# 题目信息

# [THUPC 2021 初赛] 狗蛋和二五仔

## 题目背景

**那女孩对我说**  
**代价为十辆铲车**

## 题目描述

小 E 喜欢和老师变换着花样玩牌。最近，他们又发明了一种叫做“狗蛋和二五仔”的玩法。

规则是这样的：

游戏开始时小 E 和老师各有 $30$ 点体力值，手上各有 $2$ 张牌。所有的牌是完全相同的。每个玩家的面前都可以放置牌，开始时双方面前没有任何牌。

双方轮流进行操作。玩家在每个自己的回合开始时先抽一张牌。“抽一张牌”的操作指的是，如果手上的牌的数量小于 $3$ 张，则再抓一张牌放在手上；如果手上恰好有 $3$ 张牌，则不能再抓牌。操作分为 $4$ 种类型。

- 技能。让自己的体力值 $- 2$，然后抽一张牌。
- 攻击。具体地，玩家可以选择一张放在自己面前的**本回合还未攻击过**的牌，选择对方面前的一张牌同归于尽，或者选择一张放在自己面前的**本回合还未攻击过**的牌，让对方的体力值 $- 3$。如果是后者，则将这张选择的牌标记为已攻击。
- 打牌。如果你面前的牌的数量小于 $4$ 张，且手上有牌才能进行此操作。先进行下面的过程 $3$ 次：
  - 随机选择一个角色，让它的体力值 $- 1$。这个角色可以是自己、对方或者某一方面前的一张牌。如果双方场上的牌一共有 $k$ 张，那么选择到任何一个角色的概率为 $\frac{1}{k + 2}$。如果该角色是一张牌且体力值变为了 $0$，那么将它摧毁；如果该角色是一个玩家且体力值变为了 $0$，那么该玩家直接输掉游戏。
  
  在进行完 $3$ 次后将手上的一张牌放在自己面前。牌的体力值为 $2$。这张牌在本回合中被认为已攻击过。
- 结束回合，接下来轮到对方的回合。

一回合中，玩家可以进行多次操作，但是技能和打牌的操作次数**之和**不能超过 $O$。除了结束回合，这些操作没有顺序限制，比如你可以先打一张牌，然后使用技能，然后再打一张牌。在结束回合之前，玩家需要进行至少一次任意的操作才能结束回合。

在任何时刻如果有玩家的体力值小于或等于 $0$，那么该玩家输掉游戏。

游戏进行了几个回合后，现在轮到了小 E 的回合开始前。小 E 想让你帮他分析，如果双方都采用最优策略，那么现在自己赢的概率是多少。

## 说明/提示

**【样例解释 #1】**

回合开始，小 E 抽一张牌。此时小 E 手上有 $2$ 张牌，老师手上没有牌，双方的面前都没有牌。双方的体力值均为 $1$。这时，最优策略下，小 E 不能使用技能，因为使用后会因为自己的体力值小于等于 $0$ 而输掉游戏；小 E 不能攻击，因为自己面前没有牌；小 E 也不能结束回合，因为本回合他还没有进行任何操作。所以小 E 的最优策略是打一张牌，这时会随机选到小 E 或者老师中的一个角色，让他体力值 $- 1$ 然后输掉游戏。所以小 E 的获胜概率为 $0.5$。

**【子任务】**

保证 $1\le T\le 351493,3\le O \le 5$ 。

**【后记】**

最后小 E 还是战胜了老师。

**“老师你术士玩多了就知道怎么玩了，你打得还不够多。”**

**“吹牛现在都流行这么吹的吗？兄弟你知道我术士多少胜场嘛，啊？我跟你说全世界没有一个人术士比我胜场多的。”**

**【题目来源】**

来自 2021 清华大学学生程序设计竞赛暨高校邀请赛（THUPC2021）初赛。

题解等资源可在 <https://github.com/THUSAAC/THUPC2021-pre> 查看。

## 样例 #1

### 输入

```
1 5
1 1
0
0
0 1
```

### 输出

```
0.500000000
```

## 样例 #2

### 输入

```
1 4
5 14
1 1
1 1
1 0
```

### 输出

```
0.041879441
```

# AI分析结果



### 算法分类
**博弈论（对抗搜索） + 记忆化搜索**

---

### 题解思路与核心分析
#### 核心状态建模
- **状态压缩**：将双方血量、手牌数、桌面牌状态（攻击标记与血量）、操作次数等压缩为有限维度参数。
- **关键参数**：
  - 双方血量 `n, m`（范围 1~20）
  - 手牌数 `x, y`（通过 `min(x+1,3)` 优化）
  - 桌面牌状态（未攻击/已攻击的 1血/2血牌，压缩为哈希值）
  - 剩余操作次数 `d` 和是否已操作标记 `flg`

#### 解决难点
1. **状态爆炸**：通过将牌的数量与状态组合哈希（如 `F(a,b) = a*(11-a)/2 + b`）压缩维度。
2. **随机攻击处理**：在打牌操作中，通过递归模拟三次随机攻击的期望概率，并将最后一步结果记忆化。
3. **对抗博弈转移**：通过 `1 - dfs(...)` 实现回合切换，确保双方均采取最优策略。

#### 算法流程
1. **记忆化搜索**：以当前状态为起点，枚举所有合法操作（技能、攻击、打牌、结束）。
2. **递归计算期望**：对打牌操作的随机攻击，递归所有可能路径并计算概率加权平均。
3. **剪枝优化**：通过哈希判断状态是否已计算，避免重复搜索。

---

### 题解评分与亮点
#### 题解1（dead_X） ★★★★☆
- **亮点**：
  - 清晰的变量命名与状态划分，可读性较高。
  - 通过 `att()` 函数分离随机攻击计算，逻辑模块化。
- **优化**：手动合并部分参数（如 `F(x,y)`）减少状态数。

#### 题解2（anke2017） ★★★★★
- **亮点**：
  - 极致的参数压缩（如 `num_rar` 合并手牌数）。
  - 预处理函数（如 `get_anum()`）加速哈希计算。
  - 通过 `state` 位操作合并操作次数与标记。
- **优化**：使用 `unsigned int` 与内存对齐减少缓存失效。

---

### 最优思路提炼
1. **状态压缩**：将多维度状态编码为整数，利用哈希表或预处理函数快速存取。
2. **对抗转移公式**：`max(1 - 对方最优解)` 实现双方回合交替与最优策略。
3. **分治处理随机性**：将随机攻击分解为独立子问题，递归计算期望值。

---

### 同类型题与套路
- **对抗搜索**：棋类游戏（如围棋、五子棋）的 minimax 算法。
- **状态压缩**：动态规划中的轮廓压缩（如插头DP）。
- **概率期望**：随机过程的状态转移（如马尔可夫链）。

#### 推荐题目
1. **P2592 [ZJOI2008] 生日聚会**（状态压缩与概率）
2. **P4363 [九省联考2018] 一双木棋**（对抗搜索 + 轮廓哈希）
3. **P2473 [SCOI2008] 奖励关**（期望DP + 状态压缩）

---

### 代码核心实现
#### 关键函数（题解2）
```cpp
float get_ans(int n, int m, int crd_rar, int seta, int setb, int state) {
    // 结束回合：切换对方回合并反转状态
    if ((state&1) && seta < 16) 
        res = max(res, 1 - get_ans(m, n, ...));
    // 技能操作：扣血抽牌
    if (n >= 2 && ...) 
        res = max(res, get_ans(n-2, m, ...));
    // 打牌操作：触发随机攻击
    if (...) 
        res = max(res, get_now(...));
    // 攻击操作：枚举牌与目标
    if (get_anum(seta>>4)) 
        res = max(res, get_ans(...));
}
```

---

### 可视化设计
#### 复古像素风格演示
1. **界面元素**：
   - **角色面板**：像素化血条（红/蓝）、手牌图标（卡牌精灵图）。
   - **桌面牌区**：方格展示牌的血量（颜色区分 1/2 血）和攻击状态（闪烁标记）。
2. **动画逻辑**：
   - **攻击特效**：目标牌抖动 + 血条减少，伴随 8-bit 音效。
   - **随机攻击**：三个骰子滚动动画，最终高亮命中目标。
3. **交互控制**：
   - **暂停/步进**：Space 键暂停，方向键单步执行。
   - **自动模式**：AI 自动选择最优操作，显示决策路径（如箭头指向目标）。

#### 音效设计
- **攻击音效**：短促 "beep"（类似 FC 射击游戏）。
- **胜利/失败**：经典《超级马里奥》过关/死亡音效。
- **背景音乐**：循环播放 8-bit 风格战斗 BGM。

---

### 总结
该题通过状态压缩与记忆化搜索，将复杂的博弈过程转化为可控的状态空间。核心挑战在于高效处理随机性与对抗策略，而代码通过模块化设计和参数优化实现了高效求解。可视化方案以复古风格增强交互体验，帮助理解算法流程。

---
处理用时：69.99秒
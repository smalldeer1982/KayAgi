# 题目信息

# [THUPC 2023 决赛] 那些脑海里最珍贵的

## 题目背景

E.Space：设定很怪，别问为什么，问就是看附件。

_没有人听懂的傻话_

_还记得吗_

_写满青春的围墙_

_好努力练习的倔强_

_浅浅伤疤_

_勇敢是我们的翅膀_

_——张韶涵《还记得吗》_

## 题目描述

故事的世界观大概是这样的。这个世界的人分为三类，根据其某种特点被直接命名为 Weak，Average 和 Strong。你可以理解为这是一个关于种族或者职业的分类。

两个队伍之间发生了一场回合制战斗。你知道双方做了什么，现在希望你把所有的细节还原出来。

下面是本题的一些技术细节。

**【人物】**

一个人有以下几种属性值：「种族」、「等级」、「体力上限」、「基础攻击指数」、「基础防御指数」、「主动技能等级」、「被动技能等级」。其中「体力上限」、「基础攻击指数」、「基础防御指数」完全由「种族」和「等级」决定。但是为了输入方便，本题中所有信息都会给出。在战斗中，每个人有一个「体力值」。在战斗开始时，「体力值」等于「体力上限」。当「体力值」小于等于 $0$ 时这个人就会「倒下」。对于同一个「种族」而言，「体力上限」、「基础攻击指数」、「基础防御指数」大致随「等级」指数增长。每个人持有一把「武器」。「武器」的细节在下一节给出。

**【武器】**

「武器」的属性只有两种：「武器类型」和「武器攻击力」。所有「武器」都有「普通攻击」和「特殊攻击」两种攻击方式。发起「攻击」指使用这两种方式中的任意一种。「普通攻击」的效果与「武器类型」无关，但不同的「武器类型」有着不同的「特殊攻击」效果。「武器」有三种类型，分别叫做「B」、「G」、「M」。

**【战场与队伍】**

交战双方的每一方包含不超过 $6$ 名队员，一字排开，从西到东的编号分别为 $5,3,1,2,4,6$（若不足 $6$ 名则删去较大的若干个编号）。方便起见，就叫两队为「南队」和「北队」。

**【回合】**

每个「回合」中，只有一个人可以「行动」。第奇数个「回合」是「南队」的队员「行动」，第偶数个「回合」是「北队」的队员「行动」。第一个「回合」和第二个「回合」中，「行动」的人是队伍里未「倒下」的编号最小的人。之后的「回合」中，若本队中没有编号比本队上一个「行动」的人大且未「倒下」的人，则由本队中编号最小的未「倒下」的人「行动」。否则由编号大于本队上一个「行动」者的人中，编号最小且未「倒下」的人「行动」。若一个队伍中的所有队员均已「倒下」，则判另一个队伍「胜利」。

**【行动】**

「行动」一共有三种。当前「回合」中「行动」的人必须选择三种之一来完成。

1. 「普通攻击」；
2. 「特殊攻击」；
3. 「主动技能」。

这些「行动」的效果会在之后介绍。「特殊攻击」和「主动技能」是有次数限制的，但是在本题中，保证所有「行动」均合法，所以你不需要考虑这个限制。

**【伤害计算】**

「伤害」指的是因为「普通攻击」或「特殊攻击」而造成的「体力值」减少。

「伤害」，即「体力值」减少的量，由「攻击强度」和受到「伤害」的人的「防御指数」决定。

一个人的「防御指数」等于这个人的「基础防御指数」乘以队伍的「防御加成」。

具体地，若一个人受到「攻击强度」为 $x$ 的「伤害」，那么这个人的「体力值」就会减少 $y$。其中 $y$ 的值等于 $x$ 除以这个人的「防御指数」下取整。

「攻击强度」等于「基础攻击强度」乘以发起「攻击」的人的「技能加成」乘以队伍的「攻击加成」乘以「种族克制加成」乘以「方位加成」。这些概念会在之后介绍。

**【普通攻击】**

选择一个敌方未「倒下」的队员作为「目标」。「目标」受到「基础攻击强度」为发起「攻击」的人的「基础攻击指数」乘「武器攻击力」的「伤害」。

**【特殊攻击】**

选择一个敌方未「倒下」的队员作为「目标」。

「武器」有三种，不同「武器类型」的「特殊攻击」效果如下：

- 「B」：「目标」受到「基础攻击强度」为发起「攻击」的人的「基础攻击指数」乘「武器攻击力」乘 $125\%$ 的「伤害」。
- 「G」：「目标」和「目标」东西两侧与「目标」距离最近的各一名未「倒下」的队员（如果存在）均受到「基础攻击强度」为发起「攻击」的人的「基础攻击指数」乘「武器攻击力」乘 $x\%$ 的「伤害」。其中 $x$ 的值等于 $135$ 除以将要受到「伤害」的人数。「伤害」按照「目标」、「目标」西侧、「目标」东侧的顺序计算。注意如果过程中有人「倒下」，那么这个人的「被动技能」将不再对该顺序中位于这个人之后的人的「伤害」结算起作用。特别地，所有「伤害」的「方位加成」以「目标」的「躲闪方位」来计算。
- 「M」：「目标」受到「基础攻击强度」为发起「攻击」的人的「基础攻击指数」乘「武器攻击力」乘 $115\%$ 的「伤害」。「目标」东西两侧与「目标」距离最近的各一名未「倒下」的队员（如果存在）分别受到「基础攻击强度」为发起「攻击」的人的「基础攻击指数」乘「武器攻击力」乘 $23\%$ 的「伤害」。「伤害」按照「目标」、「目标」西侧、「目标」东侧的顺序计算。注意如果过程中有人「倒下」，那么这个人的「被动技能」将不再对该顺序中位于这个人之后的人的「伤害」结算起作用。特别地，所有「伤害」的「方位加成」以「目标」的「躲闪方位」来计算。

**【技能】**

「技能」分为「主动技能」和「被动技能」。每个「种族」的人都有一个「主动技能」和一个「被动技能」。「技能」的效果因「种族」和「技能等级」的不同而不同。「技能等级」为一个 $0$ 到 $5$ 之间的整数。「技能等级」为 $0$ 表示没有该「技能」。

使用「主动技能」需要选择一个人作为「技能目标」。

「主动技能」描述如下：（$1$ 到 $5$ 级的「技能」效果由斜杠隔开，保证使用「主动技能」的人的「主动技能等级」不为 $0$）

- 「Weak 种族」：使本队一名未「倒下」的队员的「体力值」增加这名队员的「体力上限」乘以 $10\%/12\%/15\%/17\%/20\%$ 下取整。
- 「Average 种族」：选择一名敌方未「倒下」的队员，在使用该「主动技能」这一队的「回合」结束时，其「体力值」减去其「体力上限」的 $6\%/7\%/8\%/9\%/10\%$ 下取整。该效果持续 $3$ 个回合，即会触发 $3$ 次。若该队员已有同类型（可以是不同等级）的「技能」施加的效果，那么这个效果将会覆盖之前的效果。
- 「Strong 种族」：使本队一名未「倒下」的队员的「技能加成」变为 $2.1/2.17/2.24/2.32/2.4$。

一名队员的「被动技能」只有当该队员未「倒下」时才能发挥效果，「倒下」之后不再发挥效果。

「被动技能」描述如下：

- 「Weak 种族」：在本队的「回合」开始时，本队所有未「倒下」的成员的「体力值」增加该成员「体力上限」的 $1.3\%/1.6\%/1.9\%/2.2\%/2.5\%$。若本队有多名队员有这个「技能」，这个效果的数值可以相加至最多 $5\%$。超过 $5\%$ 按照 $5\%$ 计算。「体力值」增加的量在效果叠加后需要下取整。
- 「Average 种族」：队伍的「防御加成」初始为 $1$。该技能使队伍的「防御加成」增加 $0.01/0.02/0.03/0.04/0.05$。若本队有多名队员有这个「技能」，这个效果的数值可以相加至最多 $0.1$。超过 $0.1$ 按照 $0.1$ 计算。
- 「Strong 种族」：队伍的「攻击加成」初始为 $1$。该技能使队伍的「攻击加成」增加 $0.01/0.02/0.03/0.04/0.05$。若本队有多名队员有这个「技能」，这个效果的数值可以相加至最多 $0.1$。超过 $0.1$ 按照 $0.1$ 计算。

一名队员的「体力值」增加时，不能超过这名队员的「体力上限」。若增加后的「体力值」超过了「体力上限」，则把这次增加「体力值」的效果改为将这名队员的「体力值」变成这名队员的「体力上限」。

**【技能加成】**

战斗开始时，所有人的「技能加成」都是 $1$。只有两种方式能够改变「技能加成」：

- 「Strong 种族」的「主动技能」。见「技能」的描述。
- 当一个人发起「攻击」且计算完这次「攻击」的所有「伤害」之后，这个人的「技能加成」变为 $1$。

**【种族克制加成】**

「种族克制加成」与发起「攻击」的人的「种族」以及受到「伤害」的人的「种族」有关。「种族克制加成」的值如下表：


| 发起「攻击」方/受到「伤害」方 | Weak  | Average | Strong |
| :---------------------------: | :---: | :-----: | :----: |
|             Weak              | $1.0$ |  $0.9$  | $1.1$  |
|            Average            | $1.1$ |  $1.0$  | $0.9$  |
|            Strong             | $0.9$ |  $1.1$  | $1.0$  |



**【方位加成】**

在「攻击」时，发起「攻击」的一方有一个「攻击方位」，「攻击」的「目标」有一个「躲闪方位」。「攻击方位」和「躲闪方位」分别为一个 $1$ 到 $6$ 之间的整数。当「攻击方位」为 $a$，「躲闪方位」为 $d$ 时，「方位加成」的值由下表所示：


| $(a-d)\bmod 6$ | 「方位加成」 |
| :------------: | :----------: |
|      $0$       |    $1.25$    |
|   $1$ 或 $5$   |    $1.00$    |
|   $2$ 或 $4$   |    $0.75$    |
|      $3$       |    $0.00$    |



## 说明/提示

**【样例 #2】**

见题目目录下的 *2.in* 与 *2.ans*。

**【样例解释 #2】**

这个样例，无疑是善良的出题人无私的馈赠。中间忘了。出题人相信，这个美妙的样例，可以给拼搏于 AC 这道题的逐梦之路上的你，提供一个有力的援助。

**【数据范围】**

保证 $1\le n,m \le 6$。

保证 $1\le T \le 50000$。

保证「武器攻击力」的范围在 $300$ 到 $80000$ 之间。

「体力上限」「基础攻击指数」「基础防御指数」的范围见下表。

| 「种族」与「等级」 | 「体力上限」 | 「基础攻击指数」 | 「基础防御指数」 |
| :----------------: | :----------: | :--------------: | :--------------: |
|     Weak Lv.1      |   $100000$   |    $0.75000$     |    $0.010000$    |
|    Average Lv.1    |    $5000$    |    $0.80000$     |    $0.20000$     |
|    Strong Lv.1     |    $100$     |     $1.0000$     |     $10.000$     |
|    Weak Lv.100     |  $7807514$   |     $1.0089$     |    $0.10464$     |
|   Average Lv.100   |   $252234$   |     $1.3108$     |     $1.8101$     |
|   Strong Lv.100    |    $3512$    |     $1.6385$     |     $125.11$     |

 

**【后记】**

_有一天我将会老去_

_希望你会觉得满意_

_我没有 对不起那个_

_十五岁的自己_

_——刘若英《继续-给十五岁的自己》_

**【题目来源】**

来自 2023 清华大学学生程序设计竞赛暨高校邀请赛（THUPC2023）决赛。

题解等资源可在 [https://github.com/THUSAAC/THUPC2023](https://github.com/THUSAAC/THUPC2023) 查看。

## 样例 #1

### 输入

```
2 1
Strong Lv=90 maxhp=2451 atk=15588e-4 def=96931e-3 skillLv=5 passivesklLv=5 M weaponatk=80000e0
Strong Lv=100 maxhp=3512 atk=16385e-4 def=12511e-2 skillLv=5 passivesklLv=5 G weaponatk=80000e0
Weak Lv=1 maxhp=100000 atk=75000e-5 def=10000e-6 skillLv=5 passivesklLv=5 B weaponatk=80000e0
3
Skill target=2
Specialattack target=1 atkpos=3 ddgpos=3
Specialattack target=1 atkpos=5 ddgpos=5
```

### 输出

```
South 1 applied Strong skill to South 2
North: 100000/100000
South: 2451/2451 3512/3512

South 1 took 1063 damage from North 1 -> 1388/2451
North: 100000/100000
South: 1388/2451 3512/3512

North 1 took 52556526 damage from South 2 -> 0/100000
North: 0/100000
South: 1388/2451 3512/3512

Team South won.
```

# AI分析结果



### **算法分类**  
**模拟**

---

### **题解思路与难点对比**  
**核心思路**：  
1. **状态建模**：用结构体/类存储角色属性（血量、攻击、防御、技能等级等）、武器类型、队伍加成等。  
2. **回合调度**：根据回合奇偶性选择队伍，按规则确定行动角色。  
3. **伤害计算**：综合攻击强度（武器×基础攻击×种族克制×方位加成）与防御指数（基础防御×队伍加成）计算伤害。  
4. **技能处理**：主动技能（回血、持续伤害、技能加成）与被动技能（队伍加成叠加）的触发与覆盖。  

**解决难点**：  
1. **被动技能动态更新**：角色死亡后需重新计算队伍加成（如 `Average` 的防御加成）。  
2. **特殊攻击范围判定**：`G/M` 武器需递归查找东西两侧存活目标。  
3. **浮点数精度控制**：使用科学计数法解析输入，通过 `eps` 避免精度误差。  
4. **状态同步**：攻击后需立即重置技能加成，处理 `Average` 的持续伤害。  

---

### **题解评分（≥4星）**  
1. **向晚大魔王（5星）**：  
   - **亮点**：结构体分层清晰，`recalc()` 统一处理被动技能，浮点误差处理严谨。  
   - **个人心得**：强调“不造成生命值增加的回复不输出”，避免多余输出。  

2. **fush（4星）**：  
   - **亮点**：模块化函数（`BasicAttack`/`SpecialAttack`），通过 `CheckDead` 统一处理死亡逻辑。  
   - **代码结构**：将伤害计算封装为 `Attack()` 函数，减少重复代码。  

3. **Phartial（4星）**：  
   - **亮点**：使用 `enum` 管理种族和武器类型，预处理方位克制表加速计算。  
   - **调试技巧**：输入后输出角色数据验证，避免解析错误。  

---

### **最优思路与技巧提炼**  
1. **预处理表格**：  
   - 种族克制、方位加成等用二维数组预存，直接查表计算。  
   ```cpp
   const double Race[4][4] = {/* 预存克制系数 */};
   const double dir[] = {1.25, 1, 0.75, 0, 0.75, 1}; // 方位加成
   ```
2. **动态更新队伍加成**：  
   - 角色死亡时遍历队伍成员重新计算被动技能总和。  
   ```cpp
   void recalc() {
       Aexatk = Aexdef = 1;
       for (角色存活) Aexdef += Average被动值; // 防御加成
   }
   ```
3. **递归查找相邻目标**：  
   - 特殊攻击时通过链表或位置数组快速定位东西两侧目标。  
   ```cpp
   int left = 目标位置 -1; while (left≥1 && 死亡) left--; // 西侧存活者
   ```

---

### **类似题目推荐**  
1. **P2482 猪国杀**：复杂卡牌效果与状态模拟。  
2. **P7147 雀魂麻将**：牌型组合与状态判断。  
3. **P7078 蚯蚓队列**：动态优先级队列与增量更新。  

---

### **可视化与复古动画设计**  
**核心流程动画**：  
1. **角色站位**：用像素网格显示队伍排列（西→东），高亮当前行动角色。  
2. **攻击范围**：`G` 武器攻击时用扩散波纹动画标记目标和两侧角色。  
3. **伤害数值**：以浮动文字显示伤害，红色为扣血，绿色为回血。  

**复古风格实现**：  
- **Canvas 绘制**：角色用 16x16 像素方块，不同颜色区分种族（Weak-蓝、Average-黄、Strong-红）。  
- **音效设计**：  
  - `BasicAttack`: 短促“哔”声，`SpecialAttack`: 爆炸音效。  
  - 技能释放：魔法吟唱音效，持续伤害触发“滴答”声。  

**交互功能**：  
- **步进控制**：空格键单步执行，观察每回合状态变化。  
- **自动演示**：AI 按最优策略选择攻击目标（如优先击杀低血量）。  

```javascript
// 伪代码：Canvas 绘制角色  
function drawRole(x, y, role) {
  ctx.fillStyle = role.race === "Weak" ? "#00F" : "#FF0";
  ctx.fillRect(x*32, y*32, 30, 30); // 32x32 网格
  ctx.fillText(`HP:${role.hp}`, x*32+5, y*32+15); // 显示血量
}
```

---

**总结**：本题通过精细的状态管理模拟战斗流程，关键点在于动态更新队伍属性和处理复杂攻击逻辑。可视化设计可通过复古像素风格与音效增强理解，帮助掌握回合制模拟的核心逻辑。

---
处理用时：83.63秒
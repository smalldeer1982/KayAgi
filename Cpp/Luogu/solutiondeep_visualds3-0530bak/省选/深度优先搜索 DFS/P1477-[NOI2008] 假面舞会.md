# 题目信息

# [NOI2008] 假面舞会

## 题目描述

一年一度的假面舞会又开始了，栋栋也兴致勃勃的参加了今年的舞会。

今年的面具都是主办方特别定制的。每个参加舞会的人都可以在入场时选择一个自己喜欢的面具。每个面具都有一个编号，主办方会把此编号告诉拿该面具的人。

为了使舞会更有神秘感，主办方把面具分为 $k$（$k\geq 3$）类，并使用特殊的技术将每个面具的编号标在了面具上，只有戴第 $i$ 类面具的人才能看到戴第 $i+1$  类面具的人的编号，戴第 $k$ 类面具的人能看到戴第 $1$ 类面具的人的编号。

参加舞会的人并不知道有多少类面具，但是栋栋对此却特别好奇，他想自己算出有多少类面具，于是他开始在人群中收集信息。

栋栋收集的信息都是戴第几号面具的人看到了第几号面具的编号。如戴第 $2$ 号面具的人看到了第 $5$ 号面具的编号。栋栋自己也会看到一些编号，他也会根据自己的面具编号把信息补充进去。

由于并不是每个人都能记住自己所看到的全部编号，因此，栋栋收集的信息不能保证其完整性。现在请你计算，按照栋栋目前得到的信息，至多和至少有多少类面具。由于主办方已经声明了 $k\geq 3$，所以你必须将这条信息也考虑进去。


## 说明/提示

- 对于 $50\%$ 的数据，满足 $n \leq 300$，$m \leq 10^3$；
- 对于 $100\%$ 的数据，满足 $n \leq 10^5$，$m \leq 10^6$。


## 样例 #1

### 输入

```
6 5
1 2
2 3
3 4
4 1
3 5```

### 输出

```
4 4
```

## 样例 #2

### 输入

```
3 3
1 2
2 1
2 3```

### 输出

```
-1 -1
```

# AI分析结果



---

## **算法分类**: 图论 (环检测与GCD处理)

---

## **综合分析与结论**

### **核心思路**
- **建图方式**：每个边正向权1，反向权-1，确保遍历整个连通块。
- **环处理**：DFS遍历时，记录节点距离，若二次访问同一节点，计算距离差作为环长，求所有环长的GCD。
- **链处理**：无环时统计各连通块最长链长度之和。
- **结果判断**：若存在环且GCD≥3，最大值是GCD，最小值是其最小≥3的因数；否则判断链总和是否≥3。

### **难点与解决**
- **关键难点**：正确处理相交环、链差等情况，确保所有环被检测。
- **解决方案**：反向边权-1允许遍历反向路径，环长计算为两次访问的距离差绝对值，统一处理所有环结构。

---

## **题解清单 (≥4星)**

1. **StudyingFather (5星)**  
   - **亮点**：代码简洁，清晰处理环和链的逻辑，利用GCD合并所有环长。  
   - **核心代码**：DFS中计算环长差，维护全局GCD。

2. **water_tomato (4星)**  
   - **亮点**：数学证明反向边正确性，详细分析不同环结构对GCD的影响。  
   - **核心代码**：与StudyingFather类似，强调正确性证明。

3. **SS80194 (4星)**  
   - **亮点**：通过DFS生成树分析边类型，证明反向边处理复杂环的正确性。  
   - **核心代码**：类似，但提供更详细的图论分析。

---

## **核心代码实现**

### **DFS找环与计算GCD**
```cpp
void dfs(int u, int d) {
    if (dis[u]) {
        ans = gcd(ans, abs(d - dis[u])); // 环长计算
        return;
    }
    dis[u] = d;
    vis[u] = 1;
    for (auto i : e[u]) dfs(i.v, d + i.w); // 遍历邻接边
}
```

### **处理无环链长**
```cpp
for (int i = 1; i <= n; i++) {
    if (!vis[i]) {
        maxv = -INF, minv = INF;
        dfs(i, 1); // 遍历连通块
        res += maxv - minv + 1; // 最长链统计
    }
}
```

---

## **同类型题与算法套路**
- **相似问题**：涉及环检测、路径约束下的分类问题。
- **通用解法**：  
  1. 双向建图处理路径约束。  
  2. DFS/BFS遍历计算环特征。  
  3. 数学方法（如GCD）合并多个约束条件。

---

## **推荐题目**
1. **P2661 信息传递** (环检测)  
2. **P3196 图的同构** (图结构分析)  
3. **P2734 游戏** (GCD与路径约束)

---

## **可视化设计**

### **动画方案**
- **节点状态**：未访问（灰色）、当前访问（红色）、已访问（绿色）。
- **环高亮**：检测到环时，路径变为黄色，显示环长和当前GCD值。
- **步进控制**：可暂停/继续，调整速度观察DFS遍历顺序。

### **复古像素风格**
- **颜色方案**：8-bit调色板（灰、红、绿、黄）。
- **音效**：发现环时播放“叮”声，完成连通块时播放短旋律。
- **Canvas绘制**：节点为像素方块，边为动态线条，环路径闪烁。

---

## **个人心得摘录**
- **StudyingFather**：反向边的权值设计是关键，确保所有路径被覆盖。
- **water_tomato**：数学证明虽复杂，但确保代码的正确性。
- **SS80194**：DFS生成树的分析帮助理解反向边的作用。

---

**总结**：通过双向建图和DFS遍历，统一处理环和链的结构，结合GCD与链长统计，高效解决面具分类问题。

---
处理用时：60.39秒
# 题目信息

# [ZJOI2012] 小蓝的好友

## 题目背景

终于到达了这次选拔赛的最后一题，想必你已经厌倦了小蓝和小白的故事。

为了回馈各位比赛选手，此题的主角是贯穿这次比赛的关键人物——小蓝的好友。

在帮小蓝确定了旅游路线后，小蓝的好友也不会浪费这个难得的暑假。

与小蓝不同，小蓝的好友并不想将时间花在旅游上，而是盯上了最近发行的即时战略游戏——SangoCraft。

但在前往通关之路的道路上，一个小游戏挡住了小蓝的好友的步伐。

## 题目描述


“国家的战争其本质是抢夺资源的战争”是整款游戏的核心理念，这个小游戏也不例外。

简单来说，用户需要在一块 $R\times C$ 的长方形土地上选出一块子矩形。

而系统随机生成了 $N$ 个资源点，第 $i$ 个资源点的坐标为 $(x_i,y_i)$。

位于用户所选的长方形土地上的资源点越多，给予用户的奖励也越多。

悲剧的是，小蓝的好友虽然拥有着极其优秀的能力，但同时也有着极差的 RP，小蓝的好友所选的区域总是没有一个资源点。

终于有一天，小蓝的好友决定投诉这款游戏的制造厂商，为了搜集证据，小蓝的好友想算出至少包含一个资源点的区域的数量。

具体的说，你需要计算有多少个四元组 $(LB,DB,RB,UB)$ 满足 $1\le LB\le RB\le R,1\le DB\le UB\le C$ ，且存在一个 $i$ 使得 $LB\le x_i\le RB,DB\le y_i\le UB$ 均成立。

作为小蓝的好友，这自然是你分内之事。

## 说明/提示

#### 数据规模与约定

- 对于 $20\%$ 的数据，$N\le 50$。
- 对于 $40\%$ 的数据，$N\le 2\times 10^3$。
- 对于 $100\%$ 的数据，$1\le R,C\le 4\times 10^4$，$1\le N\le 10^5$，题目保证资源点的位置两两不同，且位置为随机生成。

## 样例 #1

### 输入

```
5 5 4
1 2
2 3
3 5
4 1
```

### 输出

```
139```

# AI分析结果



# 算法分类  
扫描线 + 笛卡尔树/FHQ Treap  

---

## 核心算法分析  
### 关键思路  
1. **补集转换**：总矩形数 $R(R+1)C(C+1)/4$ 减去不含资源点的矩形数  
2. **扫描线维护**：从上到下逐行扫描，维护每列下方最近的资源点高度  
3. **笛卡尔树优化**：以列号为二叉搜索树键值，资源点高度为堆权值，利用Treap动态维护区间最大值贡献  

### 算法流程  
1. 预处理资源点，按行排序  
2. 初始化笛卡尔树（每列初始高度为0）  
3. 逐行扫描时更新当前行的资源点高度  
4. 计算贡献公式：$\sum (s_{ls}+1)(s_{rs}+1)h$  
5. 总贡献累加后与总矩形数作差  

### 可视化设计  
**像素化动画步骤**：  
1. **资源点分布**：用红色像素块标记资源点  
2. **扫描线移动**：黄色横线从上向下逐行扫描  
3. **笛卡尔树构建**：  
   - 根节点用绿色高亮  
   - 左右子树用蓝/紫色区分  
   - 节点尺寸动态变化（根据子树大小）  
4. **贡献计算**：  
   - 当前节点用闪烁特效  
   - 贡献值用气泡文字实时显示  
   - 公式中的 $(s_{ls}+1)(s_{rs}+1)$ 用连线标注  

---

## 题解评分  
### [流水行船CCD] ⭐⭐⭐⭐⭐  
- **亮点**：完整推导笛卡尔树贡献公式，FHQ Treap实现优雅  
- **代码**：合并split/merge操作，维护ans字段清晰  
```cpp  
void pu(int x){
    tr[x].sz=1+tr[ls].sz+tr[rs].sz;
    tr[x].ans= tr[ls].ans+js(tr[x].pri-tr[ls].pri,tr[ls].sz);
    tr[x].ans+=tr[rs].ans+js(tr[x].pri-tr[rs].pri,tr[rs].sz);
}  
```  

### [ButterflyDew] ⭐⭐⭐⭐  
- **亮点**：图示清晰解释扫描线原理  
- **技巧**：将空列视为第0行资源点简化边界处理  

### [feecle6418] ⭐⭐⭐⭐  
- **亮点**：仅82行极简实现，核心逻辑浓缩  
```cpp  
ans += c*(c+1)/2*i - qry();  
```  

---

## 同类型题目推荐  
1. **P4147 玉蟾宫**（最大子矩形问题）  
2. **P1972 [SDOI2009]HH的项链**（区间统计问题）  
3. **P5490 矩形面积并**（扫描线经典问题）  

---

## 可视化实现方案  
**Canvas动画关键代码**：  
```javascript  
function drawTreap(node, x, y, level) {
    if (!node) return;
    ctx.fillStyle = node === current ? '#FFD700' : '#00FF00';
    ctx.fillRect(x, y, 30, 30); 
    ctx.fillText(`${node.h}|${node.sz}`, x+5, y+20);
    drawTreap(node.left, x-50/(level+1), y+50, level+1);
    drawTreap(node.right, x+50/(level+1), y+50, level+1);
}
```  

**音效触发逻辑**：  
- **节点旋转**：播放8-bit "blip"音效  
- **贡献更新**：播放上升音阶  
- **扫描线移动**：循环低音脉冲  

---

## 总结  
最优解法结合扫描线与动态笛卡尔树，在随机数据下达到 $O(R \log C)$ 复杂度。关键突破点是将二维问题转化为一维序列维护，通过Treap的堆性质高效计算区间最大值的组合贡献。同类问题可借鉴这种"维护极值贡献"的思考模式。

---
处理用时：54.86秒
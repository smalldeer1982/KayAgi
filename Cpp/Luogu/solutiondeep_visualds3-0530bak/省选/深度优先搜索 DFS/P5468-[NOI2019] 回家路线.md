# 题目信息

# [NOI2019] 回家路线

## 题目背景

本题原题数据强度较低，若想要测试较强数据可以去 [P6302](https://www.luogu.com.cn/problem/P6302)，除数据范围外均与原题相同。

## 题目描述

猫国的铁路系统中有 $n$ 个站点，从 $1 - n$ 编号。小猫准备从 $1$ 号站点出发，乘坐列车回到猫窝所在的 $n$ 号站点。它查询了能够乘坐的列车，这些列车共 $m$ 班，从$1 - m$编号。小猫将在 $0$ 时刻到达 $1$ 号站点。对于 $i$ 号列车，它将在时刻 $p_i$ 从站点 $x_i$ 出发，在时刻 $q_i$ 直达站点 $y_i$，小猫只能在时刻 $p_i$ 上 $i$ 号列车，也只能在时刻 $q_i$ 下 $i$ 号列车。小猫可以通过多次换乘到达 $n$ 号站点。一次换乘是指对于两班列车，假设分别为 $u$ 号与 $v$ 号列车，若 $y_u = x_v$ 并且 $q_u \leq p_v$，那么小猫可以乘坐完 $u$ 号列车后在 $y_u$ 号站点等待 $p_v - q_u$ 个时刻，并在时刻 $p_v$ 乘坐 $v$ 号列车。

小猫只想回到猫窝并且减少途中的麻烦，对此它用烦躁值来衡量。

- 小猫在站点等待时将增加烦躁值，对于一次 $t (t \geq 0)$ 个时刻的等待，烦躁值将增加 $At^2 + Bt + C$，其中 $A, B,C$ 是给定的常数。注意：小猫登上第一班列车前，即从 $0$ 时刻起停留在 $1$ 号站点的那些时刻也算作一次等待。

- 若小猫最终在时刻 $z$ 到达 $n$ 号站点，则烦躁值将再增加 $z$。

形式化地说，若小猫共乘坐了 $k$ 班列车，依次乘坐的列车编号可用序列 $s_1, s_2, \cdots , s_k$表示。该方案被称作一条可行的回家路线，当且仅当它满足下列两个条件：

1. $x_{s1} = 1$ , $y_{sk} = n$

2. 对于所有 $j (1 \leq j < k)$，满足 $y_{sj} = x_{s_{j+1}}$ 且 $q_{sj}\leq p_{s_{j+1}}$

对于该回家路线，小猫得到的烦躁值将为：

$$q_{s_k}+(A\times p_{s_1}^2+B\times p_{s_1}+C)+\sum_{j=1}^{k-1}(A(p_{s_{j+1}}-q_{s_j})^2+B(p_{s_{j+1}}-q_{s_j})+C)$$

小猫想让自己的烦躁值尽量小，请你帮它求出所有可行的回家路线中，能得到的最
小的烦躁值。题目保证至少存在一条可行的回家路线。


## 说明/提示

### 更多样例

您可以通过附加文件获得更多样例。

#### 样例 3

见附加文件的 `route/route3.in` 与 `route/route3.ans`。

该样例的数据类型与最终测试点 $5 \sim 8$ 一致。

#### 样例 4

见附加文件的 `route/route4.in` 与 `route/route4.ans`。

该样例的数据类型与最终测试点 $11 \sim 14$ 一致。

#### 样例 5

见附加文件的 `route/route5.in` 与 `route/route5.ans`。

该样例的数据类型与最终测试点 $18 \sim 20$ 一致。

### 样例 1 解释

共有三条可行的回家路线：

- 依次乘坐 1，4 号列车，得到的烦躁值为：$10 + (1 \times 3^2 + 5 \times 3 + 10) + (1 \times (9 - 4)^2 + 5 \times (9 - 4) + 10)= 104$
- 依次乘坐 2，4 号列车，得到的烦躁值为：$10 + (1 \times 5^2 + 5 \times 5 + 10) + (1 \times (9 - 7)^2 + 5 \times (9 - 7) + 10)= 94$
- 依次乘坐 3，4 号列车，得到的烦躁值为：$10 + (1 \times 6^2 + 5 \times 6 + 10) + (1 \times (9 - 8)^2 + 5 \times (9 - 8) + 10)= 102$

第二条路线得到的烦躁值最小为 $94$。

### 数据范围

对于所有测试点：$2\le n\le 10^5,1\le m\le 2\times 10^5,0 \le A \le 10 , 0 \le B, C \le 10^6,1 \le x_i, y_i \le n , x_i \neq y_i , 0 \le p_i < q_i \le 10^3$。

每个测试点的具体限制见下表：

| 测试点编号  |        $n$         |          $m$          | $A,B,C$ 的特殊限制 | 其他特殊条件 |
| :---------: | :----------------: | :-------------------: | :----------------: | :----------: |
|  $1\sim 2$  |     $\le 100$      |        $=n-1$         |         无         | $y_i=x_i+1$  |
|  $3\sim 4$  |     $\le 100$      | $\le 100$ |     $A=B=C=0$      | $y_i=x_i+1$  |
|  $5\sim 8$  | $\le 2\times 10^3$ |  $\le 4\times 10^3$   |     $A=B=C=0$      |  $x_i<y_i$   |
|     $9$     | $\le 2\times 10^3$ |  $\le 4\times 10^3$   |      $A=B=0$       |  $x_i<y_i$   |
|    $10$     | $\le 2\times 10^3$ |  $\le 4\times 10^3$   |       $A=0$        |  $x_i<y_i$   |
| $11\sim 14$ | $\le 2\times 10^3$ |  $\le 4\times 10^3$   |         无         |      无      |
|    $15$     |     $\le 10^5$     |  $\le 2\times 10^5$   |      $A=B=0$       |      无      |
| $16\sim 17$ |     $\le 10^5$     |  $\le 2\times 10^5$   |       $A=0$        |      无      |
| $18\sim 20$ |     $\le 10^5$     |  $\le 2\times 10^5$   |         无         |      无      |

## 样例 #1

### 输入

```
3 4 1 5 10
1 2 3 4
1 2 5 7
1 2 6 8
2 3 9 10```

### 输出

```
94```

## 样例 #2

### 输入

```
4 3 1 2 3
1 2 2 3
2 3 5 7
3 4 7 9```

### 输出

```
34```

# AI分析结果



### 唯一算法分类
动态规划 + 斜率优化

---

### 综合分析与结论
**核心思路**：将列车班次视为事件，按时间排序后通过斜率优化维护凸包，快速寻找最优决策点。  
**关键难点**：二次函数导致的非线性优化、时间与空间双重约束下的决策单调性维护。  
**解决方案**：  
1. 将问题转化为凸包维护问题，通过斜率比较快速筛选最优决策点  
2. 按时间顺序处理事件（到达和出发），动态维护各站点的凸包  
3. 利用决策单调性避免重复计算，时间复杂度优化至 O(m log m)

**可视化设计**：  
- **动画方案**：以时间轴为横坐标，显示各站点的凸包维护过程。用不同颜色标记：  
  - 红色：当前处理的列车班次  
  - 绿色：凸包中的有效决策点  
  - 蓝色：被弹出的过期决策点  
- **交互功能**：  
  - 步进控制观察凸包插入/弹出过程  
  - 滑动时间轴查看不同时刻的站点状态  
- **像素风格**：用8位网格表示站点，像素块大小表示烦躁值，音效提示凸包更新事件  

---

### 题解清单 (4星及以上)
1. **Great_Influence（5⭐）**  
   - 亮点：首创事件分拆思想，提出凸包维护框架  
   - 代码：使用 vector 按站点维护凸包，时间复杂度 O(m + T)  
   - 核心代码片段：  
     ```cpp
     void ins(int pos, int i) {
         while (队列中存在可优化的点) 弹出队尾;
         插入新决策点;
     }
     ```

2. **yzhang（4.5⭐）**  
   - 亮点：详细推导斜率优化方程，提供完整代码  
   - 关键公式：  
     $$Y_j = dp[j] + Aq_j^2 - Bq_j$$  
     $$K_i = 2Ap_i$$  
   - 调试心得：发现斜率比较符号写反导致错误，强调验证几何意义的重要性  

3. **Shallowy（4⭐）**  
   - 亮点：通过决策单调性证明保证正确性  
   - 代码技巧：用双端队列维护凸包，时间复杂度 O(m log q_max)  

---

### 最优技巧提炼
1. **事件分时处理**：将到达/出发事件按时间排序，避免状态混乱  
2. **凸包斜率优化**：将二次函数转化为线性比较，维护下凸包快速决策  
3. **空间压缩**：按站点而非时间维度维护状态，空间复杂度降至 O(n)  

---

### 同类型题拓展
1. **换乘问题通用解法**：时间排序 + 决策单调性维护  
2. **带二次代价的路径规划**：斜率优化转化为几何问题  

---

### 相似题目推荐
1. [P6302](https://www.luogu.com.cn/problem/P6302) - 原题数据加强版  
2. [P3199](https://www.luogu.com.cn/problem/P3199) - 环形公路（决策单调性应用）  
3. [P2305](https://www.luogu.com.cn/problem/P2305) - 购票（树形结构+斜率优化）  

---

### 可视化核心代码示例
```javascript
// 凸包维护动画演示（简化版）
class ConvexHullAnim {
  constructor(canvas) {
    this.points = []; // 当前决策点集
    this.ctx = canvas.getContext('2d');
  }

  addPoint(newPoint) {
    while (this.points.length >= 2 && 
           cross(lastTwoPoints, newPoint) <= 0) {
      this.points.pop(); // 弹出非凸点
      playSound('pop');  // 触发音效
    }
    this.points.push(newPoint);
    drawPoint(newPoint, '#00ff00'); // 绿色标记新点
  }
}
```

---

### 调试心得摘录
> "斜率符号写反导致WA两个点，画图验证发现凸包方向错误后修正比较条件" —— Shallowy  
> "暴力剪枝时发现p_i范围只有1e3，果断改用时间分层DP" —— Froggy  

---

### 复古像素动画参数
- **调色板**：16色FC风格（绿-决策点，红-当前操作，蓝-时间轴）  
- **音效设计**：  
  - 插入决策点：8-bit "coin" 音效  
  - 弹出决策点：短促爆破音  
  - 找到最优解：经典马里奥过关音乐片段

---
处理用时：62.94秒
# 题目信息

# 「Stoi2029」以父之名

## 题目背景

> 以父之名判决  
> 那感觉没有适合字汇  
> 就像边笑边掉泪  
> 凝视着完全的黑  
> 阻挡悲剧蔓延的悲剧会让我沉醉  
> ——《[以父之名](https://www.bilibili.com/video/BV1fx411N7bU?p=36)》

## 题目描述

地狱里有 $n$ 个罪人在等待判决，编号为 $1$ 至 $n$。罪人们之间有 $m$ 条罪的联系，编号为 $1$ 至 $m$，每条联系 的值为 $1$ 或 $2$ 且恰好连接两个罪人。

称一个罪人的自负度为他和其他所有罪人之间联系的值之和。两个罪人之间可能不止有一条联系，此时这些联系的值都应该被计算。由于这些罪人承受了太多的罪恶，他们变得不和谐。具体地，每个罪人的自负度都是奇数。

现在，神明将要对他们进行判决。判决的具体方式为：将每条联系都进行定向，使得这条联系所连接的两个罪人中的一个受到惩罚，另一个受到救赎，它们的值均为这条联系的值。

由于神明秉承父的仁慈，希望罪人们更加均等地接受惩罚和救赎，于是他规定判决后每个罪人所受到的惩罚和救赎值总和之差的绝对值必须恰好为 $1$。

由于神明工作繁忙，因此他以父之名要求你为他找到一种判决的方法。由于父的指示不会有错，所以一定存在一种这样的方法。

---

#### 题意简述

给定一个 $n$ 个点 $m$ 条边的无向图，边权均为 $1$ 或 $2$。保证每个点所相连的边权值之和均为奇数。你需要将这些边定向，使每个点的入边权值和与出边权值和之差的绝对值恰为 $1$。保证有解。输出任意一种方案。

## 说明/提示

#### 样例解释

定向后的图如下：

![](https://cdn.luogu.com.cn/upload/image_hosting/uhz96nbm.png)

更多样例详见题目附件 `trial_sample.zip`。

------

#### 数据范围

**本题采用捆绑测试。**

- 特殊性质 A：边权均为 $1$，且任意两点之间只存在一条简单路径，且没有重边。
- 特殊性质 B：同一个点至多只有一条边权为 $1$ 和一条边权为 $2$ 的边相连。

| Subtask | 分值 | $1\le n \le$ | $1\le m \le$ | 特殊性质 | 
| :-: | :-: | :-: | :-: | :-: |
| $1$ | $7$ | $10$ | $15$ | 无 | 
| $2$ |  $20$ |$10^3$ | $3\times10^3$ | 无 |
| $3$ |  $20$ |$3 \times 10^5$ | $3 \times 10^5$ | A |
| $4$ | $20$ |$3 \times 10^5$ | $3 \times 10^5$ | B | 
| $5$ |  $33$ |$10^6$ | $3 \times 10^6$ | 无 |

对于 $100\%$ 的数据，$1 \le u_i,v_i \le n \le 10^6$，$1 \le m \le 3 \times 10^6$，$w_i \in \{1,2\}$。

在题目附件 `trial_sample.zip` 中：

- `trial_sample1.in` 即为样例 #1。
- `trial_sample2.in` 满足特殊性质 A。
- `trial_sample3.in` 满足特殊性质 B。
- `trial_sample4.in` 不满足特殊性质。

另外该目录下还有 `checker.exe`。

------

#### 提示

**本题输入输出量较大，请使用较快的输入输出方式。**

本题提供 [Special Judge 源码](https://www.luogu.com.cn/paste/7albhubs)和 `checker.exe`，供选手调试。Windows 下使用方法为:  
命令行在目标文件夹输入指令：
```
checker.exe data.in data.out data.out
```
其中 `data.in` 是输入数据文件，`data.out` 是程序运行结果文件。观察评判结果即可。

- `Perfect answer.` 表示答案正确。
-  `Wrong answer on node x, and the difference is d.` 表示答案错误，其中节点 $x$ 的入边权值和与出边权值和之差的绝对值为 $d$ 而不为 $1$。
- `Invalid answer.` 表示输出的字符串长度不正确或输出非法字符。

请务必保证**输出格式正确**，否则 Special Judge 可能会返回 Unknown Error 等不可预估的结果。

## 样例 #1

### 输入

```
4 5
1 2 1
1 3 2
2 3 1
2 4 1
4 1 2
```

### 输出

```
00100
```

# AI分析结果



---

### **唯一算法分类**  
**欧拉回路构造**

---

### **综合分析与结论**  

#### **核心思路**  
所有题解核心围绕**奇偶性调整**与**欧拉回路构造**展开。每个点的边权和为奇数，转化为欧拉回路问题：添加虚边使度数全为偶数，构造回路时优先匹配相同权值的边，确保每个点的入出权值差绝对值为1。

#### **难点对比**  
1. **虚边处理**：需确保虚边不影响原图条件，Konnyaku_LXZ 的解法通过虚点连接奇度数点，使得新图存在欧拉回路，正确性由奇度点数量为偶数保证。  
2. **遍历策略**：优先选择与入边同权值的边，避免权值不匹配导致差值无法满足。例如，Konnyaku_LXZ 在 DFS 时优先处理相同权值边。  
3. **复杂度优化**：部分题解（如 VinstaG173）通过剖链拆环优化，但实现复杂；而欧拉回路方法直接线性遍历，更适合大数据范围。

#### **最优解法提炼**  
**虚点 + 欧拉回路 + 同权优先遍历**：  
1. 添加虚边使所有点度数变为偶数。  
2. 构造欧拉回路，遍历时优先选择与入边权值相同的出边。  
3. 删除虚边后，原图每个点的入出差自然为1。

---

### **题解清单 (≥4星)**  
1. **Konnyaku_LXZ (5星)**  
   - **亮点**：完整解释虚点作用与遍历策略，代码高效。  
   - **关键代码**：优先选择同权边，当前弧优化避免重复遍历。  
   ```cpp
   void dfs(int u, int pre) {
       while (now[u][pre] && e[now[u][pre]].ans != -1) now[u][pre] = nxt[now[u][pre]];
       if (!now[u][pre]) { pre = (pre == 1 ? 2 : 1); /* 略 */ }
       // 优先同权边，后异权边
   }
   ```
2. **_fairytale_ (4星)**  
   - **亮点**：简洁实现，直接建立虚点，优先同权边遍历。  
   - **代码片段**：  
   ```cpp
   void dfs(int u, int op) {
       auto f = [&](int op) { /* 优先遍历权值 op 的边 */ };
       f(op); f(op ^ 1); // 处理剩余边
   }
   ```
3. **DengDuck (4星)**  
   - **心得**：通过虚边抵消奇度点，强调欧拉回路正确性证明。  
   - **关键逻辑**：虚边仅在构造回路时存在，删除后差值自然为1。

---

### **代码实现关键**  
**Konnyaku_LXZ 的核心代码逻辑**  
```cpp
void dfs(int u, int pre) {
    // 优先选择与入边权值相同的出边
    while (now[u][pre] && e[now[u][pre]].ans != -1) 
        now[u][pre] = nxt[now[u][pre]];
    if (!now[u][pre]) {
        pre = (pre == 1 ? 2 : 1); // 切换权值
        while (now[u][pre] && e[now[u][pre]].ans != -1) 
            now[u][pre] = nxt[now[u][pre]];
    }
    if (!now[u][pre]) return;
    // 标记边方向并递归
    e[now[u][pre]].ans = 0; 
    e[now[u][pre]^1].ans = 1;
    dfs(e[now[u][pre]].to, pre);
}
```

---

### **同类型题推荐**  
1. **CF1610F**：类似边权奇偶性定向问题。  
2. **P7816**：需调整边权和的奇偶性，构造特定差值。  
3. **P7361**：无向图边定向，满足出入度差约束。

---

### **可视化设计思路**  
#### **复古像素动画演示**  
1. **数据结构展示**：  
   - **节点**：像素方块表示，颜色区分实点（蓝色）与虚点（灰色）。  
   - **边**：权值1（绿色线条），权值2（黄色线条），虚边（半透明）。  
2. **算法过程**：  
   - **步骤1**：添加虚边，动态绘制虚点与奇度点的连接。  
   - **步骤2**：DFS遍历，高亮当前边（红色），优先选择同权边。  
   - **步骤3**：删除虚边，显示每个点的入出差值（浮动数字）。  
3. **音效与交互**：  
   - **音效**：选择边时播放“哔”声，完成回路时播放胜利音效。  
   - **控制**：支持暂停/继续，调整动画速度（1x, 2x, 0.5x）。  

#### **Canvas 实现伪代码**  
```javascript
function drawEulerPath(ctx, graph) {
    let current = 1; // 起点
    let lastWeight = 1; // 初始权值
    while (true) {
        let edge = findNextEdge(current, lastWeight); // 找同权边
        if (!edge) {
            lastWeight = (lastWeight === 1 ? 2 : 1); // 切换权值
            edge = findNextEdge(current, lastWeight);
        }
        if (!edge) break;
        ctx.strokeStyle = edge.weight === 1 ? "green" : "yellow";
        drawArrow(edge.from, edge.to); // 绘制定向箭头
        playSound("beep"); 
        current = edge.to;
        lastWeight = edge.weight;
    }
}
```

---

### **个人心得摘录**  
- **Konnyaku_LXZ**：虚点的度数为偶数，保证全图可构造欧拉回路，是正确性关键。  
- **VinstaG173**：拆链剖环需细致处理边权交替，调试时需验证链结构合法性。  
- **DengDuck**：虚边仅在构造阶段存在，删除后不影响原图条件，顿悟后代码简洁性提升。  

--- 

**答案生成完毕。**

---
处理用时：70.26秒
# 题目信息

# [SCOI2009] 围豆豆

## 题目背景

四川NOI2009省选


## 题目描述

是不是平时在手机里玩吃豆豆游戏玩腻了呢？最近MOKIA手机上推出了一种新的围豆豆游戏，大家一起来试一试吧。


游戏的规则非常简单，在一个N×M的矩阵方格内分布着D颗豆子，每颗豆有不同的分值Vi。游戏者可以选择任意一个方格作为起始格，每次移动可以随意的走到相邻的四个格子，直到最终又回到起始格。最终游戏者的得分为所有被路径围住的豆豆的分值总和减去游戏者移动的步数。矩阵中某些格子内设有障碍物，任何时刻游戏者不能进入包含障碍物或豆子的格子。游戏者可能的最低得分为0，即什么都不做。


注意路径包围的概念，即某一颗豆在路径所形成的多边形（可能是含自交的复杂多边形）的内部。下面有两个例子：

 
 ![](https://cdn.luogu.com.cn/upload/pic/1690.png) 

第一个例子中，豆在路径围成的矩形内部，所以豆被围住了。第二个例子中，虽然路径经过了豆的周围的8个格子，但是路径形成的多边形内部并不包含豆，所以没有围住豆子。

布布最近迷上了这款游戏，但是怎么玩都拿不了高分。聪明的你决定写一个程序来帮助他顺利通关。


## 说明/提示

50%的数据满足1≤D≤3。

100%的数据满足1≤D≤9，1≤N, M≤10，-10000≤Vi≤10000。


## 样例 #1

### 输入

```
3 8

3

30 -100 30

00000000

010203#0

00000000

```

### 输出

```
38```

# AI分析结果



**唯一算法分类**  
状态压缩BFS

---

**综合分析与结论**  
本题核心在于将几何判定转化为位运算状态转移，结合最短路算法进行动态规划。关键要点包括：  
1. **射线定理**：通过豆豆右侧竖直移动判定包围状态，奇数次跨越射线触发状态翻转  
2. **状压设计**：用D位二进制数表示9个豆豆的包围状态，异或操作高效切换状态  
3. **BFS/SPFA优化**：以步长为边权跑最短路，维护每个坐标点的最小步数  

**可视化设计要点**：  
- **网格动画**：在10x10网格中，用不同颜色区分路径（蓝色）、豆豆（黄色）、障碍（红色）  
- **射线标记**：从每个豆豆右侧延伸红色虚线，高亮触发状态变化的竖直移动（绿色闪光）  
- **状态面板**：实时显示当前二进制状态、已包围豆豆总分、步数消耗  
- **复古风格**：采用FC红白机配色（#FF6B6B、#4ECCA3等），移动时播放8bit音效，得分更新时触发NES过关音效  

---

**题解清单 (≥4星)**  
1. **hzoi_liuchang (5星)**  
   - 亮点：完整推导射线定理数学原理，清晰注释状态转移代码，指出vis数组初始化陷阱  
   - 引用调试心得：*"错解因未重置vis数组，导致后续搜索提前终止，出现负例"*  

2. **Mr_HY43205 (4星)**  
   - 亮点：SPFA松弛操作可视化代码，预处理得分数组提升效率  
   - 关键代码：`dp()`函数中通过坐标差判定射线跨越  

3. **lsj2009 (4星)**  
   - 亮点：数学归纳法证明射线定理，强调状态定义为"奇偶性"而非直接包围  

---

**核心代码片段**  
射线状态转移函数（来自hzoi_liuchang）：  
```cpp
int solve(int mx,int my,int nx,int ny,int ms) {
    int ns = ms;
    for(int i=1; i<=d; i++) {
        // 上下移动且路径在豆豆右侧时触发异或
        if( ((mx==ax[i] && nx<ax[i]) || (mx<ax[i] && nx==ax[i])) && ny>ay[i] ) 
            ns ^= (1<<(i-1));
    }
    return ns;
}
```

---

**同类型题推荐**  
1. **P2622 关灯问题II** - 状压BFS经典题  
2. **P1879 [USACO06NOV]Corn Fields G** - 网格状压DP  
3. **P3959 [NOIP2017 提高组] 宝藏** - 状态压缩与图遍历结合  

---

**个人心得摘录**  
> "射线定理看似简单，但实现时要严格限定为竖直移动触发。水平移动不计入跨越，这是避免误判的关键。" —— hzoi_liuchang  
> "状压DP本质是暴力美学，用二进制魔法将几何判定压缩为位运算" —— Mambason  

---

**可视化算法演示**  
```javascript
// 伪代码：Canvas绘制移动路径与状态更新
function drawStep(ctx, x, y, newState) {
    // 高亮当前格子
    ctx.fillStyle = '#4ECCA3';
    ctx.fillRect(x*30, y*30, 28, 28);
    
    // 绘制射线跨越动画
    beans.forEach(bean => {
        if (crossVertical(prevPos, {x,y}, bean)) {
            playSound('bit_click'); // 8bit音效
            ctx.strokeStyle = '#FF6B6B';
            ctx.beginPath();
            ctx.moveTo(bean.x*30 +15, bean.y*30);
            ctx.lineTo(width, bean.y*30);
            ctx.stroke();
        }
    });
    
    // 更新状态面板
    document.getElementById('state-bin').textContent = newState.toString(2);
}
```

---
处理用时：61.26秒
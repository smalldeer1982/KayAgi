# 题目信息

# [THUPC 2023 决赛] 老虎机

## 题目描述

小 I 经营着一个电玩城，最近引进的新型老虎机深受欢迎。

作为经营者，小 I 首先需要设定老虎机的状态。老虎机的状态为一个三元组 $(l,S,\mathbf{p})$，其中

- $l$ 是一个正整数；
- $S$ 是一个非空字符串集合，其中所有的字符串均是长度为 $l$ 的 01 串；
- $\mathbf{p}$ 是一个长度为 $l$ 的实数序列 $p_0,p_1,\dots,p_{l-1}$，其中对于任意 $0 \le i \le l - 1$，$0 < p_i \le 1$。

设定好状态后即可开始游戏。每一轮游戏的流程如下：

- 玩家首先获得老虎机的状态 $(l,S,\mathbf{p})$。
- 老虎机内部选择一个串 $s \in S$ 作为答案串，玩家需要通过与老虎机进行若干次交互得到答案串。
  - 每一次交互中，玩家投入一个游戏币并拉下老虎机的拉杆，然后老虎机的界面中会出现一个长度为 $l$ 的信息串 $t$。对于 $0 \le i \le l - 1$，$t_i$ 有 $p_i$ 的概率为 $s_i$，有 $(1-p_i)$ 的概率为 `?`。
  - 交互过程中生成信息串进行的所有随机过程两两独立。
- 当玩家可以根据**老虎机的状态和交互得到的若干信息串**唯一确定答案串后，即可将答案串输入老虎机并结束游戏、获得奖励。

小 I 设定好了一个状态，但还不知道设定多少奖励。为了让奖励和难度匹配，小 I 想知道：对于 $S$ 中的每个串 $t$，在玩家以最优策略游玩（即一旦可以唯一确定答案串就结束游戏）的情况下，若答案串为 $t$，玩家期望需要投入多少游戏币。

由于小 I 不喜欢实数，你需要将答案对 $998244353$ 取模。

## 说明/提示

**【样例解释 #1】**

- 对于第一组测试数据，每一次交互有 $\frac{5000}{10000} = \frac{1}{2}$ 的概率知道答案串是 $0$ 还是 $1$，有 $\frac{1}{2}$ 的概率不能获得信息，因此期望游戏币数为 $\sum_{i=1}^{+\infty} \frac{i}{2^i} = 2$。
- 对于第二组测试数据，每一次交互都可以得到字符串的第二位，有 $\frac{1}{10000}$ 的概率得到字符串的第一位。第二个字符串为答案串时可以通过字符串的第二位唯一确定，而其他两个字符串为答案串时必须要得到字符串的第一位。
- 对于第三组测试数据，由于 $|S| = 1$，所以不需要任何交互就可以确定答案串。
- 对于第四组测试数据，我有一个绝妙的解释，可这里空间太小写不下。

**【数据范围】**

对于所有测试数据，$1 \le T \le 10$，$1 \le l \le 15$，$1 \le n \le 2^l$，$1 \le c_i \le 10^4$，$s_1,\dots,s_n$ 为两两不同的长度为 $l$ 的 01 串。

**【后记】**

“喂喂喂，未成年人不准进入电玩城！什么？你们说你们要进去学算法竞赛？谁信你的鬼话！”

**【题目来源】**


来自 2023 清华大学学生程序设计竞赛暨高校邀请赛（THUPC2023）决赛。

题解等资源可在 [https://github.com/THUSAAC/THUPC2023](https://github.com/THUSAAC/THUPC2023) 查看。

## 样例 #1

### 输入

```
4
1 2
5000
0
1
2 3
1 10000
00
01
10
1 1
1
1
3 4
8888 7777 5555
000
010
101
110
```

### 输出

```
2
2
10000
1
10000
0
209031157
194428714
835313860
674719626
```

# AI分析结果



---

### 算法分类
**概率期望 & 状态压缩动态规划**

---

### 题解对比与核心分析

#### **题解共同点**
1. **状态压缩表示**：用二进制或三进制表示已知位置集合（如 `001?` 表示为三进制数）
2. **期望拆分**：利用期望线性性，将总期望拆分为所有非合法状态的贡献之和
3. **合法状态判定**：通过动态规划或递推确定每个状态是否能唯一确定答案串
4. **模运算优化**：概率转化为模 998244353 下的分数，使用逆元处理除法

#### **关键差异**
| 题解 | 状态表示 | 合法状态判定方法 | 预处理优化 |
|-----|---------|-----------------|----------|
| Alex_Wei | 二进制集合超集 | 超集 DP，`f_S` 和 `g_S` 辅助计算 | 超集枚举 O(3^l) |
| __stick | 三进制（0/1/?） | lowbit 递推处理未知位 | 三进制 lowbit 预处理 |
| tzl_Dedicatus545 | 三进制状态 | 类似 lowbit 的递推逻辑 | 状态转移图建模 |

#### **解决难点**
1. **指数级状态处理**：通过三进制 lowbit 递推或超集 DP 高效处理 3^l 量级状态
2. **合法状态快速判定**：利用递推合并子状态的结果，避免暴力枚举所有可能字符串
3. **概率与期望计算**：预处理 `val[s] = p[s]/(1-p[s])` 实现 O(1) 查询状态停留期望

---

### 题解评分 (≥4星)
1. **Alex_Wei（★★★★☆）**
   - 亮点：理论推导完整，超集 DP 优化清晰
   - 不足：代码未展示具体实现细节
2. **__stick（★★★★☆）**
   - 亮点：附带完整代码，三进制 lowbit 预处理实现巧妙
   - 不足：思路描述较简略

---

### 最优思路与技巧
1. **期望拆分技巧**：总期望 = 所有非终止状态的概率 × 停留时间
2. **三进制 lowbit**：快速找到最低未知位，递推合并子状态
3. **逆元预处理**：所有 `1/(1-p)` 提前计算，避免重复求逆
4. **合法状态压缩**：用三进制数唯一性快速判定能否确定答案

---

### 同类型题目推荐
1. [P2473](https://www.luogu.com.cn/problem/P2473)（状态压缩期望 DP）
2. [P4548](https://www.luogu.com.cn/problem/P4548)（概率与逆元结合）
3. [P6835](https://www.luogu.com.cn/problem/P6835)（动态规划处理状态转移图）

---

### 可视化设计思路
**8位像素风格状态转移动画**
1. **网格绘制**：每个格子代表一位，颜色表示已知（绿/红）或未知（灰）
2. **音效触发**：
   - 确定一位：8-bit "点击" 音效
   - 合法状态：胜利音效 + 闪光特效
3. **自动演示模式**：
   - 按 BFS 顺序展开状态转移
   - 右下角显示当前状态编码与累计期望
4. **交互控制**：
   - 方向键切换焦点状态
   - A 键手动触发一次随机采样
   - START 键切换自动播放

---

### 核心代码实现（__stick 题解）
```c++
// 预处理三进制 lowbit
po[0]=1;
for(int i=1;i<=15;i++) po[i]=po[i-1]*3;
for(int i=0;i<po[15];i++){
    lowbit[i]=-1;
    for(int j=0,x=i;j<15;j++,x/=3)
        if(x%3==2){ lowbit[i]=j; break; }
    rev[i] = ...; // 计算已知位掩码
}

// 动态规划计算状态概率
for(int s=0;s<(1<<L);s++){
    int pp=1;
    for(int i=0;i<L;i++) 
        if((~s)>>i&1) pp=mul(pp,1+mod-p[i]);
    val[s] = mul(pp, ksm(mod+1-pp)); // 关键公式
}

// 合法状态判定递推
for(int s=0;s<po[L];s++){
    if(~lowbit[s]){
        int u=id[s-po[lowbit[s]]], v=id[s-po[lowbit[s]]*2];
        id[s] = (u==v) ? u : -1; // 合并子状态
    }
    if(id[s]>0) ans[id[s]] += val[...];
}
```

---

### 关键公式推导
1. **状态停留期望**：`t_S = 1/(1-p_S)`，其中 `p_S = ∏_{i∉S}(1-p_i)`
2. **转移概率**：`P(S→T) = (∏_{i∈T\S}p_i) * ∏_{i∉T}(1-p_i) / (1-p_S)`
3. **模逆元优化**：`1/(1-p_S) ≡ (1-p_S)^(mod-2) mod 998244353`

---

### 调试技巧
1. **小数据验证**：对 l=1 的情况手工计算验证
2. **中间输出**：打印三进制状态与对应 id 的映射关系
3. **概率归一检查**：确保所有状态概率之和为 1

---

**总结**：本题通过将期望问题转化为状态空间上的动态规划，结合巧妙的位运算优化，在可接受的时间复杂度内解决了指数级状态数问题。其核心在于对问题本质的深刻理解和数学工具的灵活运用。

---
处理用时：85.50秒
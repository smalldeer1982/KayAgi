# 题目信息

# 基地建设

## 题目背景

在茫茫宇宙中……

## 题目描述

有一群生物 ccj，他们发现了一个超星系群。其中有 $n$ 个恒星，$m$ 条双向星际航线，每条星际航线都需要消耗 $val_i$ 的燃料值。两个恒星不属于同一个星系当且仅当他们之间没有任何航线，且没有任何路径可以到达。只有每个恒星才可以为飞船补充燃料。每次航行的路线都是一条简单路径。由于燃料系统过于简陋，每个燃料罐只能用于一次航行。他们的首长 ccj 想在其中一个恒星上建立基地。但是 ccj 花了太多钱购买高速飞船，没有太多钱购买燃料罐，所以他对于两个恒星之间的航行一定选择最经济的航行方式，购买最小的燃料罐。他想问你，在基地要备多少的燃料总量，使得在任意一个恒星上建立基地都能从那个基地分别到达那个星系的其他所有恒星。

但是，这个超星系群发生了战争，一些黑洞改变了这里的空间结构。这群生物只知道每条航线花费的燃料值，找不到连接的两个恒星。但是他们的科学家发现了一个性质：每个战争有一个标志值 $q$，航线有不同的排列方式，对于其中一种排列，第 $i$ 条航线连接着 $((q^{i} \bmod 2^{32}+i \times val_i) \bmod n+n) \bmod n+1$ 和 $((q^{i} \bmod 2^{32}-i \times val_i) \bmod n+n) \bmod n+1$ 两个恒星。**运算方式为无符号整型运算**。如果连接的两个恒星一样，说明科学家计算有误，忽略这条航线。ccj 的目标改变了。他想知道对于所有星系的构成情况，最少需要准备多少的燃料总量，使得在这种结构中，在任意一个恒星上建立基地都能分别到达该结构下那个恒星所处星系的其他所有恒星。

你需要输出航线排列顺序。


## 说明/提示

**样例解释：**

这 $5$ 条航线分别是：

$2$ 与 $2$ 往返，花费燃料 $5$

$1$ 与 $1$ 往返，花费燃料 $4$

$3$ 与 $3$ 往返，花费燃料 $2$

$2$ 与 $2$ 往返，花费燃料 $3$

$1$ 与 $2$ 往返，花费燃料 $1$

前四条航线被忽略，故有四个恒星系，$\{1,2\},\{3\},\{4\},\{5\}$

基地建在 $1$ 时，从 $1$ 到 $2$ 需要购买燃料量为 $1$ 的燃料罐，可以发现，没有其他比这个更优的答案。

$2 \le n \le 100\quad 1 \le m \le 40\quad 0 \le q \le 10^9\quad 0 \le val_i \le 1000$

你的答案只需要比std优秀或者和std一样且方案正确即可

1~4数据都为最优答案，5~10数据都为次优答案

~~此题会给出第10个数据的输入~~
[输入数据](https://www.luogu.org/paste/3xkq6bar)

详细范围参见”标程“

数据均为随机构造，请注意常数！

## 样例 #1

### 输入

```
3 5 2
1 2 3 4 5
```

### 输出

```
1
5
4
2
3
1
```

# AI分析结果



---

**唯一算法分类**：模拟退火 + 最小生成树

---

### 综合分析与结论

#### 核心算法流程
1. **排列生成**：通过模拟退火调整边的顺序，生成不同的图结构。
2. **最小生成树构建**：对当前排列的边排序，使用 Kruskal 算法生成 MST。
3. **贡献计算**：在并查集中维护子树大小，计算每条边对总燃料量的贡献。
4. **评估优化**：模拟退火根据当前解的评估值（总燃料量）决定是否接受新解。

#### 解决难点
- **理论转化**：将燃料总量问题转化为图论中的最小生成树路径最大值问题。
- **高效计算**：通过并查集动态维护子树大小，避免暴力遍历所有点对。
- **排列优化**：用模拟退火处理高维离散空间搜索，跳出局部最优解。

#### 可视化设计
- **动画效果**：
  - **像素风格**：用 16 色网格表示恒星，边以不同颜色区分是否在 MST 中。
  - **并查集合并**：高亮当前合并的子树，显示 `size` 变化和贡献叠加。
  - **模拟退火**：左下角显示温度曲线和当前最优解，右上角展示排列交换动画。
- **音效提示**：
  - **接受新解**：播放 8-bit 上升音效（频率 440Hz）。
  - **拒绝新解**：播放低沉音效（频率 220Hz）。
  - **找到更优解**：触发短促胜利音效。

---

### 题解清单（≥4星）

#### 阿廖（★★★★☆）
- **关键亮点**：
  1. 理论推导完整，明确 Kruskal 重构树与贡献计算的关系。
  2. 参数设置合理，初温与降温系数经过调优。
  3. 贡献计算公式 `q[lson] = q[x] + size[rson] * val[x]` 简洁高效。

#### MeowScore（★★★★★）
- **关键亮点**：
  1. 提供完整代码实现，直接展示并查集与贡献计算逻辑。
  2. 使用时间倒流技巧，避免删边操作。
  3. 引入卡时机制（1.8秒），平衡时间与精度。

---

### 最优思路与代码

#### 核心代码（贡献计算部分）
```cpp
ll calc() {
    gen(); // 生成当前排列的边
    sort(g2 + 1, g2 + m + 1, cmp); // 按边权排序
    for (int i = 1; i <= n; i++) uf[i] = i, sz[i] = 1, val[i] = 0;
    ll res = 0;
    for (int i = 1; i <= m; i++) {
        int x = find(g2[i].x), y = find(g2[i].y);
        if (x == y) continue;
        val[x] = max(val[x] + g2[i].z * sz[y], val[y] + g2[i].z * sz[x]);
        sz[x] += sz[y];
        uf[y] = x;
        res = max(res, val[x]);
    }
    return res;
}
```

#### 核心思想
- **并查集维护**：动态合并子树并记录 `size`。
- **贡献传递**：每条边的贡献为 `左子树大小 × 右子树大小 × 边权`，通过 `val[x]` 累加。

---

### 相似题目推荐
1. **P1396** 营救（最小生成树路径最大值）
2. **P1967** 货车运输（最大生成树+LCA）
3. **P2502** [HAOI2006]旅行（枚举边权阈值）

---

### 个人心得摘录
> “模拟退火的初温设得太低会导致无法跳出局部最优，调参时发现降温系数从 0.99 改为 0.999 后效果显著。”  
> —— MeowScore 调试日志

---

### 复古像素化演示方案
1. **初始化**：Canvas 绘制 100x100 网格，每个恒星用 8x8 像素方块表示。
2. **边连接动画**：用绿色线段表示有效边，红色表示自环（忽略）。
3. **MST 构建**：已选边闪烁黄色，合并子树时播放 “哔” 音效。
4. **模拟退火面板**：右下角显示当前温度和解的评估值，字体为 8-bit 风格。
5. **自动演示模式**：AI 每 0.5 秒执行一次排列交换，按空格键切换手动/自动。

---
处理用时：69.61秒
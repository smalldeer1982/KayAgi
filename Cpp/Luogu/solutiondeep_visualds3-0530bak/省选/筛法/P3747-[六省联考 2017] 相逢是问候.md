# 题目信息

# [六省联考 2017] 相逢是问候

## 题目描述

> Informatik verbindet dich und mich.  
> 信息将你我连结。

B 君希望以维护一个长度为 $n$ 的数组，这个数组的下标为从 $1$ 到 $n$ 的正整数。

一共有 $m$ 个操作，可以分为两种：

- `0 l r` 表示将第 $l$ 个到第 $r$ 个数（ $a_l,a_{l+1} ...a_r$）中的每一个数 $a_i$ 替换为 $c^{a_i}$，即 $c$ 的 $a_i$ 次方，其中 $c$ 是输入的一个常数，也就是执行赋值 $a_i = c^{a_i}$。

- `1 l r` 求第 $l$ 个到第 $r$ 个数的和，也就是输出： $\sum_{i=l}^{r}a_i$

因为这个结果可能会很大，所以你只需要输出结果 $\bmod \space p$ 的值即可。


## 说明/提示

【数据范围】  

对于 $0\%$ 的测试点，和样例一模一样；

对于另外 $10\%$ 的测试点，没有修改；

对于另外 $20\%$ 的测试点，每次修改操作只会修改一个位置（也就是 $l = r$ ），并且每个位置至多被修改一次；

• 对于另外 $10\%$ 的测试点， $p = 2$；

对于另外 $10\%$ 的测试点， $p = 3$；

对于另外 $10\%$ 的测试点， $p = 4$；

对于另外 $20\%$ 的测试点， $1\le n,m \le 100$；

对于 $100\%$ 的测试点， $1\le n,m \le 5\times 10^4$，$1 \le p \le 10^8$，$0< c < p$，$0 \le a_i < p$。


## 样例 #1

### 输入

```
4 4 7 2
1 2 3 4
0 1 4
1 2 4
0 1 4
1 1 3```

### 输出

```
0
3```

## 样例 #2

### 输入

```
1 40 19910626 2
0
0 1 1
1 1 1
0 1 1
1 1 1
0 1 1
1 1 1
0 1 1
1 1 1
0 1 1
1 1 1
0 1 1
1 1 1
0 1 1
1 1 1
0 1 1
1 1 1
0 1 1
1 1 1
0 1 1
1 1 1
0 1 1
1 1 1
0 1 1
1 1 1
0 1 1
1 1 1
0 1 1
1 1 1
0 1 1
1 1 1
0 1 1
1 1 1
0 1 1
1 1 1
0 1 1
1 1 1
0 1 1
1 1 1
0 1 1
1 1 1```

### 输出

```
1
2
4
16
65536
11418102
18325590
13700558
13700558
13700558
13700558
13700558
13700558
13700558
13700558
13700558
13700558
13700558
13700558
13700558```

# AI分析结果



## 算法分类
**线段树 + 扩展欧拉定理 + 势能分析**

---

## 题解思路与核心难点

### 核心思路
1. **扩展欧拉定理**：解决幂塔运算模运算问题，核心公式：
   $$ a^b \bmod p = \begin{cases} 
   a^{b \bmod \phi(p) + \phi(p)} \bmod p & b \geq \phi(p) \\
   a^b \bmod p & \text{否则}
   \end{cases} $$
2. **模数快速衰减**：反复取 $\phi(p)$ 至多 $\log p$ 次变为 1，此时幂塔结果恒定。
3. **线段树势能优化**：记录区间最小修改次数，超过阈值后不再更新。

### 解决难点
1. **快速幂优化**：光速幂预处理 $c^{k}$ 和 $c^{k \cdot \sqrt{V}}$，实现 $O(1)$ 计算 $c^x \bmod m$。
2. **递归层数限制**：预处理 $\phi(p)$ 链，计算时按链层级递归。
3. **区间操作优化**：线段树维护区间和与修改次数，暴力修改叶子节点。

---

## 题解评分（≥4星）

### 1. Luan_233（⭐⭐⭐⭐⭐）
- **亮点**：详细推导扩展欧拉定理应用，预处理光速幂，线段树维护区间最小修改次数。
- **代码优化**：分块处理快速幂，避免重复计算。

### 2. s_r_f（⭐⭐⭐⭐）
- **简洁性**：代码结构清晰，预处理模数链和光速幂。
- **核心思想**：直接维护每个元素的修改次数，暴力更新。

### 3. 花淇淋（⭐⭐⭐⭐）
- **可视化设计**：提出像素化动画方案，音效与关卡设计增强趣味性。
- **代码实现**：预处理 $\phi$ 链，快速幂分块优化。

---

## 最优思路与技巧
1. **光速幂预处理**：将指数分块为高位和低位，预处理 $c^{k}$ 和 $c^{k \cdot \sqrt{V}}$，实现 $O(1)$ 快速幂。
2. **势能分析**：每个元素最多修改 $\log p$ 次，线段树记录区间最小修改次数，超过后跳过更新。
3. **模数链预处理**：预处理 $\phi(p) \to \phi(\phi(p)) \to \dots \to 1$ 的链式结构。

---

## 类似题目推荐
1. **P4139 上帝与集合的正确用法**：递归应用扩展欧拉定理计算幂塔模数。
2. **P4145 上帝造题的七分钟2**：势能分析 + 区间暴力修改。
3. **CF906D Power Tower**：扩展欧拉定理处理幂塔问题。

---

## 可视化与算法演示
### 核心动画设计
1. **模数链展示**：以树状图展示 $\phi(p) \to \phi(\phi(p)) \to \dots \to 1$ 的衰减过程。
2. **线段树操作**：
   - **颜色标记**：当前修改的区间节点（红色高亮），叶子节点修改次数（绿色计数器）。
   - **步进控制**：单步执行区间更新，观察修改次数阈值触发。
3. **光速幂计算**：动态分块展示高位和低位快速幂拼接过程。

### 复古像素风格
- **Canvas 绘制**：线段树以 8-bit 像素网格呈现，修改操作伴随“哔”音效。
- **音效设计**：
  - 成功修改：短促“叮”声。
  - 达到阈值：低沉“咚”声。
- **自动演示**：AI 模拟区间修改，展示幂塔计算结果稳定过程。

---

## 代码片段（Luan_233 题解核心部分）
```cpp
// 预处理光速幂
void pre_work() {
    LL tmp = p; phi[0] = p;
    while (tmp != 1) tmp = calc_phi(tmp), phi[++mint] = tmp;
    phi[++mint] = 1;
    for (int j = 0; j <= mint; ++j) {
        pow1[0][j] = 1;
        for (int i = 1; i <= 10000; ++i) {
            pow1[i][j] = pow1[i-1][j] * c % phi[j];
        }
    }
}

// 线段树更新
void update(int L, int R, int l, int r, int cur) {
    if (ti[cur] >= mint) return;
    if (L == R) {
        ti[cur]++;
        val[cur] = dfs(v[cur], 0, ti[cur]) % p;
        return;
    }
    // 递归左右子树
    if (左子树需更新) update(...);
    if (右子树需更新) update(...);
}
```

---

## 总结
本题通过扩展欧拉定理将幂塔问题转化为递归模数计算，结合线段树势能分析优化时间复杂度。预处理光速幂和模数链是核心优化手段，推荐通过类似题目巩固递归与区间处理能力。

---
处理用时：66.83秒
# 题目信息

# 评分系统

## 题目背景

答疑请到：https://www.luogu.org/discuss/show?postid=79498

由于时限等问题，请大家重交一遍这道题

本题时限开至2s

样例：https://files.cnblogs.com/files/ztz11/yl.rar

---

众所周知，luogu 有题目难度的评分系统，用户在通过题目后可以选择题目难度以及算法标签，来完善 luogu 的题库。

![](https://cdn.luogu.com.cn/upload/pic/40327.png)

（原注：以下内容非真实评分数据，纯属作者编造，仅供娱乐使用。）

## 题目描述

Menteur-Hxy 同学很不老实，为了实现 NOIp 前 AC $100$ 道黑题的目标，他决定雇佣一些水军，最少雇佣 $1$ 个水军。

每个水军都有一个能力值 $x_i$，表示该水军可以解决难度最高为 $x_i$ 的题目。这些水军十分尽职尽责，在通过这道题目后都会给题目评最高难度。当然，luogu 的正常用户也会做题，他们会正常地评分。现在，我们给你所有水军的能力值以及每道题正常用户的评分记录，请你求出有多少种选择水军的方案，可以使这道题的评分变为黑题。因为答案可能过大，最终请输出答案数 $\bmod p$ 的值。

评分计算公式：去掉一个最高分，去掉一个最低分后求平均分。

**【表一：投票信息】**

| 投票编号 | 对应难度 | 分数贡献 |
| :------: | :------: | :------: |
| $1$ | 入门 | $1$ |
| $2$ | 普及- | $10$ |
| $3$ | 普及/提高- | $15$ |
| $4$ | 普及+/提高 | $25$ |
| $5$ | 提高+/省选- | $40$ |
| $6$ | 省选/NOI- | $55$ |
| $7$ | NOI | $75$ |
| $8$ | NOI+/CTSC | $100$ |

**【表二：难度规则】**

| 难度等级 | 对应颜色 | 对应分数 |
| :------: | :------: | :------: |
| 入门 | 红 | $1\sim 5$ |
| 普及- | 橙 | $6\sim 12$ |
| 普及/提高- | 黄 | $13\sim 20$ |
| 普及+/提高 | 绿 | $21\sim 35$ |
| 提高+/省选- | 蓝 | $36\sim 45$ |
| 省选/NOI- | 紫 | $46\sim 70$ |
| NOI+/CTSC | 黑 | $71\sim 100$ |

## 说明/提示

**【样例解释 $1$】**

luogu 用户评分和为 $25+40+55+75+100=295$，弃掉一个最低分后为 $270$，这时 Menteur-Hxy 雇佣两个及以上水军就可以达到目的。

因为可以通过本题的水军共有 $4$ 个，所以选择方案共有：

$$\{1,2\}\{1,2,3\}\{1,2,3,4\}\{1,2,4\}\{1,3\}\{1,3,4\}\{1,4\}\{2,3\}\{2,3,4\}\{2,4\}\{3,4\}$$

共 $11$ 种，对 $9$ 取余后结果为 $2$。

**【数据规模与约定】**

对于 $30\%$ 的数据，$n, m \leq 50$。

对于另外 $20\%$ 的数据，$p$ 为质数。

对于 $100\%$ 的数据，$1 \leq n, m, k,s_i \leq 10^5, 1 \leq t \leq 5, 2 \leq p \leq 3 \times 10^3, 1 \leq t_i \leq 8$。

保证合格水军的数量与需要的最少水军数量之差不超过 $5000$。

（原注：本题可能轻微卡常。感谢 @Ghostcai ，@Swhsz 帮忙验题。）

## 样例 #1

### 输入

```
1
5 5 9
1 2 3 4 5
4 5 6 7 8
2```

### 输出

```
2```

## 样例 #2

### 输入

```
5
20 10 1329
540 499 490 419 308 261 323 476 476 374 23 13 14 16 19 34 43 19 27 32 
8 8 8 8 8 7 7 7 7 7 
50
20 10 1800
74 434 97 134 283 118 234 498 328 388 29 48 48 43 23 42 31 16 20 26 
8 8 7 6 8 8 8 7 7 7 
50
20 10 2704
142 378 330 281 377 64 340 309 466 289 34 37 19 17 20 48 21 28 38 15 
6 8 6 6 8 7 7 7 7 6 
50
20 10 72
365 356 456 479 459 222 548 377 212 223 38 20 49 18 49 38 31 48 41 17 
6 8 7 6 8 7 8 8 8 6 
50
20 10 1416
367 191 403 298 445 464 79 467 431 362 10 45 48 37 46 43 11 35 30 39 
8 6 8 7 7 7 8 8 7 8 
50```

### 输出

```
1023
1023
1023
15
1023```

# AI分析结果



---

## 唯一算法分类  
**组合数学/数论**

---

## 综合分析与结论  
### 核心算法流程  
1. **推导最小水军数**：  
   - 根据用户评分计算总分与最低分  
   - 通过不等式推导所需水军数：  
     $$\frac{sum - min + 100(x-1)}{m + x - 2} \ge 71$$  
     解得：$x \ge \max(1, \lceil \frac{71m - sum + min -42}{29} \rceil)$  
2. **筛选合格水军**：  
   - 仅保留能力值 ≥k 的水军，统计总数 cnt  
3. **组合数求和**：  
   - 计算 $\sum_{i=x}^{cnt} \binom{cnt}{i} \mod p$  
4. **模数处理**：  
   - 质数模用 Lucas 定理加速计算  
   - 非质数模用扩展 Lucas 分解质因数 + 中国剩余定理合并  

### 可视化设计思路  
- **动画步骤**：  
  1. 展示用户评分转化为总分的计算过程  
  2. 动态推导不等式，高亮关键变量（sum, min, m）  
  3. 筛选水军时，用颜色区分合格/淘汰的水军  
  4. 组合数计算阶段：  
     - 分解模数为质因数幂（如 $p = 2^3 \cdot 5$）  
     - 对每个质因数幂，分步显示组合数 $\binom{cnt}{i} \mod p_i^{k_i}$  
     - 最后用 CRT 合并结果，高亮合并公式  
- **复古像素风格**：  
  - 使用 8-bit 字体显示数学公式  
  - 组合数计算时播放 FC 风格音效（如选择质因数时触发"滴"声）  
  - 合格水军用绿色方块表示，淘汰用红色  

---

## 题解清单（≥4星）  
### 1. WhitD 题解（★★★★☆）  
**关键亮点**：  
- 独立推导最小水军数的数学表达式  
- 根据模数类型智能选择 Lucas/exLucas  
- 代码结构清晰，变量命名规范  

**核心代码**：  
```cpp  
// 判断质数优化计算  
if(is_p(p))  
    for(x;x<=cnt;++x) ans=(ans+lucas(cnt,x,p));  
else  
    for(x;x<=cnt;++x) ans=(ans+exlucas(cnt,x,p));  
```

### 2. ztz11 题解（★★★★☆）  
**关键亮点**：  
- 预处理水军能力值排序优化筛选  
- 完整实现扩展 Lucas 的分解与合并  

**优化技巧**：  
```cpp  
// 排序后快速筛选合格水军  
sort(nl+1,nl+n1+1,cmp);  
for(rii=1;i<=n1;i++)  
    if(nl[i]<zx) cnt--;  
```

---

## 最优思路与技巧提炼  
### 关键公式推导  
**最小水军数**：  
$$x = \max(1, \lceil \frac{71m - (sum - min) -42}{29} \rceil)$$  
- 分子表示总分缺口，分母 29 是 100-71（最高分与阈值差）  

### 组合数优化  
- **质数模**：Lucas 定理递归分解组合数到模数进制  
- **非质数模**：  
  1. 分解模数为 $p = \prod p_i^{k_i}$  
  2. 对每个 $p_i^{k_i}$ 计算组合数模  
  3. 中国剩余定理合并结果  

### 工程实践  
- **合格水军筛选**：排序后二分查找临界点，复杂度优化到 $O(n \log n)$  
- **循环边界**：保证 $x \geq 1$ 避免无效计算  

---

## 同类型题推荐  
1. **P3807【模板】卢卡斯定理** - 基础 Lucas 定理实现  
2. **P4720【模板】扩展卢卡斯** - 非质数模组合数模板  
3. **P4369 组合数问题** - 组合数求和与模运算结合  

---

## 个人心得摘录  
- **WhitD 调试经验**：  
  > "扩展 Lucas 在 #4 测试点 TLE，改用质数判断优化后通过"  
  - 启示：模数类型预判可大幅优化时间  

- **ztz11 数据设计**：  
  > "保证合格水军数量与 x 之差 ≤5000"  
  - 循环次数可控，避免暴力组合数求和超时  

---

## 可视化代码片段（JS 伪代码）  
```javascript  
// 像素动画：CRT 合并过程  
function animateCRT() {  
  const factors = primeFactors(p);  
  factors.forEach((pk, i) => {  
    drawGrid(pk, color[i]); // 每个质因数用不同颜色  
    playSound('blip');  
  });  
  let result = 0;  
  factors.forEach(([pi, ki]) => {  
    const mi = p / pi**ki;  
    const ci = (comb % pi**ki) * mi * inv(mi, pi**ki);  
    result += ci;  
    highlight(pi, ki, ci); // 高亮当前项  
  });  
  drawFinal(result % p);  
}  
```  

---

## 复古游戏化设计  
- **音效触发**：  
  - 质因数分解成功：8-bit "胜利"音效  
  - 组合数计算错误：短促"爆炸"声  
- **积分系统**：  
  - 每正确合并一个质因数 +100 分  
  - 连续正确触发 2x 连击倍率  
- **AI 演示模式**：  
  - 自动推导公式，用箭头动画引导视线  
  - 伪代码逐行高亮，配合打字机音效

---
处理用时：73.75秒
# 题目信息

# 「EZEC-3」四月樱花

## 题目背景

$$又到樱花曼舞的春日，$$

$$花蕾，像无数星星闪烁在枝头含春嬉戏，$$

$$心有灵犀；$$

$$又是为花吹雪的季节，$$

$$花蕊，引万千蜂蝶赶树梢抱春絮语，$$

$$心有念想。$$

$$开了，一夜乍起，$$

$$火树樱花汇聚开遍山野好似茫茫沧海；$$

$$大地樱花，$$

$$赏心悦目怒放层林尽染好似朵朵云霞；$$

$$纵有三千烦恼，$$

$$不过灿烂阳光下释然地娓娓一笑；$$

$$纵有万般郁闷，$$

$$不如和煦暖风里淡淡地悠悠一了；$$



[——《四月樱花》](http://music.163.com/song?id=1355079681&userid=587823498)

![樱花](https://cdn.luogu.com.cn/upload/image_hosting/g5m4h8a3.png)

## 题目描述

在樱花盛开的四月，```Muxii``` 望着满天飘落的樱花，向身旁的 ```ZZH``` 问道：

“究竟有多少朵樱花在这个四月飘落？”

```ZZH``` 答道：“樱花飘落的朵数 $s$ 与时间 $t$ 有如下关系：

$$s=\prod_{x=1}^t\prod_{y|x}\frac{y^{d(y)}}{\prod_{z|y}(z+1)^2}$$

其中 $d(y)$ 表示 $y$ 的约数个数。”

但作为一个~~文科生~~萌新，```Muxii``` 显然无法清楚地知道具体的数目，因此他只好继续向 ```ZZH``` 询问这个问题的答案。

由于数量可能很大，所以你只需要替 ```ZZH``` 告诉 ```Muxii``` 他所需要的答案对 $p$ 取模的结果就好了。

## 说明/提示

**「样例 1 说明」**

代入计算可得答案为 $\frac1{2073600}$，由于 $2073600$ 在模 $998244353$ 意义下的逆元为 $648735108$，故最终答案为 $1×648735108\bmod998244353 = 648735108$。

**「数据范围与约定」**

**数据保证答案的最简表示中分母不含 $p$ 和 $p$ 的倍数。**

对于所有数据，保证 $1\leq t\leq 2.5×10^9$，$9.9×10^8<p<1.1×10^9$ 且 $p$ 为质数。
|子任务编号|$t≤$|分值|
|:-:|:-:|:-:|
|$1$|$10^3$|$5$|
|$2$|$10^4$|$5$|
|$3$|$2×10^5$|$10$|
|$4$|$2×10^6$|$20$|
|$5$|$10^7$|$20$|
|$6$|$10^8$|$20$|
|$7$|$2.5×10^9$|$20$|

注：本题采用**捆绑测试**，即必须通过单个子任务的所有测试点才可获得该子任务的分数。

## 样例 #1

### 输入

```
4 998244353```

### 输出

```
648735108```

## 样例 #2

### 输入

```
10 1000000007```

### 输出

```
872041698```

# AI分析结果



**唯一算法分类**：数论（分块技术）

---

### **题解思路、算法要点与解决难点**

**核心推导**：  
1. **式子的化简**：将原式转化为 $\prod_{z=1}^t \frac{z^2}{(z+1)^2}$ 的指数形式，其中指数为 $\sum_{y=1}^{\lfloor t/z \rfloor} \lfloor \frac{t}{yz} \rfloor$。  
2. **分块嵌套**：外层对 $z$ 分块，内层对 $\lfloor t/z \rfloor$ 分块，总时间复杂度优化至 $O(t^{2/3})$。  
3. **预处理优化**：通过线性筛或枚举倍数预处理前 $n^{2/3}$ 的约数个数和 $\sigma(n)$，剩余部分用分块计算。

**解决难点**：  
- **分块嵌套的时间复杂度分析**：通过积分证明分块嵌套的总复杂度为 $O(t^{3/4})$，进一步预处理优化至 $O(t^{2/3})$。  
- **连乘积的快速计算**：利用 $\prod_{z=l}^r \frac{z}{z+1} = \frac{l}{r+1}$ 简化乘积计算，避免逐个相乘。

---

### **题解评分（≥4星）**

1. **ZigZagKmp（★★★★★）**  
   - **亮点**：完整推导分块嵌套过程，代码简洁且附预处理优化。  
   - **关键代码**：  
     ```cpp
     for(ui l=1,r;l<=n;l=r+1){
         r=n/(n/l);
         ans = ans * ksm(l * inv(r+1), calc(n/l)) % mod;
     }
     ```

2. **George1123（★★★★☆）**  
   - **亮点**：使用杜教筛优化 $\sigma(n)$ 计算，适合大范围数据。  
   - **关键代码**：  
     ```cpp
     int D(int n){ // 杜教筛求σ(n)前缀和
         if(n < M) return d[n];
         if(mp.count(n)) return mp[n];
         int res = n * (n+1) / 2;
         for(int l=2,r; l<=n; l=r+1){
             r = n/(n/l);
             res -= D(n/l) * (r-l+1);
         }
         return mp[n] = res;
     }
     ```

3. **peterwuyihong（★★★★☆）**  
   - **亮点**：手推公式发现 $\frac{z}{z+1}$ 的连乘积可化简为 $\frac{l}{r+1}$。  
   - **个人心得**：“推了三天柿子，发现代码只有10行”——强调公式推导的重要性。

---

### **最优思路或技巧提炼**

1. **分块嵌套**：  
   - 外层分块 $z$，内层分块 $\lfloor t/z \rfloor$，总时间复杂度 $O(t^{2/3})$。  
2. **约数个数和的快速计算**：  
   - 预处理前 $n^{2/3}$ 的 $\sigma(n)$，剩余部分用分块计算。  
3. **连乘积化简**：  
   - $\prod_{z=l}^r \frac{z}{z+1} = \frac{l}{r+1}$，避免逐项计算。

---

### **同类型题推荐**

1. **洛谷P2261 [CQOI2007]余数求和**（分块基础）  
2. **洛谷P1403 [AHOI2005]约数研究**（约数函数性质）  
3. **SPOJ DIVCNT1**（分块嵌套与杜教筛结合）

---

### **可视化与算法演示**

**动画设计**：  
1. **分块过程演示**：  
   - **颜色标记**：用红色高亮当前分块区间 $[l,r]$，蓝色标记内层分块区间。  
   - **步进控制**：允许单步观察每个分块的贡献计算（如 $\frac{l}{r+1}$ 的连乘）。  
   - **数据面板**：实时显示当前 $z$ 的范围、$\sigma(\lfloor t/z \rfloor)$ 的值和总乘积结果。

2. **复古像素风格实现**：  
   - **Canvas绘制**：分块区间显示为像素方块，算法执行时方块闪烁（红色→绿色）。  
   - **音效设计**：  
     - 分块切换时播放8位“滴”声，计算完成时播放上升音阶。  
     - 背景音乐：FC经典《超级马里奥》地下关BGM循环播放。  
   - **自动演示模式**：AI自动分块，控制台输出类似“Stage Clear!”的提示。

---

### **代码实现（关键片段）**

**ZigZagKmp的核心分块代码**：  
```cpp
for(ui l=1,r;l<=n;l=r+1){
    r = n / (n/l);
    ui invr = 1llu * l * ksm((r+1) % mod, mod-2) % mod;
    invr = 1llu * invr * invr % mod;
    ans = 1llu * ans * ksm(invr, calc(n/l)) % mod;
}
```

---

### **个人心得摘录**

1. **调试教训**：  
   - “预处理范围选 $n^{2/3}$ 而非 $n^{1/2}$，否则TLE到怀疑人生”（ZigZagKmp）。  
2. **公式推导的重要性**：  
   - “80%时间在推柿子，20%时间写代码，结果代码只有10行”（peterwuyihong）。  
3. **分块哲学**：  
   - “分块就像切蛋糕，外层切大块，内层切小块，总刀数不超过 $O(n^{2/3})$”（George1123）。

---

**可视化演示链接**（假设存在）：  
`https://algovis.com/april-cherry-blossom`  
（包含分块动画、复古音效和自动演示模式）

---
处理用时：71.28秒
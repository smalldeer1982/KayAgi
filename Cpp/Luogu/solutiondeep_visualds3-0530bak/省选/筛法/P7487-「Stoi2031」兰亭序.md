# 题目信息

# 「Stoi2031」兰亭序

## 题目背景

> 无关风月 我题序等你回 悬笔一绝 那岸边浪千叠 情字何解 怎落笔都不对 而我独缺 你一生的了解 ——《兰亭序》

## 题目描述

月非常喜欢复数，尤其喜欢形如 $e^{2\pi it}$ 的复数。她选择了两个正整数 $n,k$，并将 $1+e^{\frac{2\pi i x_1 \dots x_k}{n}}$ 称为 $(x_1,\dots,x_k)$ 的 **绝对度**，所有满足 $1 \le x_i \le n$ $(i \in \{1,2,\dots,k\})$ 的 $(x_1,\dots,x_k)$ 的 **绝对度** 之积称为 $(n,k)$ 的 **无关度**。现在她想请你帮她对 $t \in \{1,2,\dots,k\}$ 求出 $(n,t)$ 的 **无关度** $ans \bmod{335544323}$。由于回答太多的数太麻烦，你只要回答她所有答案进行异或运算后的结果。

## 说明/提示

#### 简述版题意：

给定 $n,k$，对 $1 \le t \le k$ 求

$$\prod_{x_1=1}^{n}\prod_{x_2=1}^{n}\dots\prod_{x_t=1}^{n}\left( 1+e^{\frac{2\pi ix_1x_2\dots x_t}{n}} \right) \bmod{335544323}$$

输出所有 $k$ 个答案的异或和。

其中 $e^{it}=\cos{t}+i\sin{t}$ 对所有 $t \in \mathbb{R}$ 成立，$i$ 为虚数单位，满足 $i^2=-1$。

#### 样例解释：

对于第一组样例，$t=1,2$ 时答案分别为 $2,35184372088832$，取模后为 $2,201012021$，异或和为 $201012023$。

对于第二组样例，$t=1,2,3$ 时答案均为 $2$，异或和为 $2$。

限于篇幅，剩下的样例不作解释说明。

#### 数据范围：

**本题采用捆绑测试，各个 Subtask 的限制与分值如下：**

| Subtask No. | $n \le$ | $k \le$ | 特殊限制 | 分值 |
| :-----------: | :-----------: | :-----------: | :-----------: | :-----------: |
| $1$ | $10$ | $1$ | 无 | $7$ |
| $2$ | $1$ | $10$ | 无 | $7$ |
| $3$ | $10$ | $2$ | 无 | $7$ |
| $4$ | $10^{18}$ | $10^5$ | $n$ 为偶数 | $7$ |
| $5$ | $10$ | $10$ | $n^k \le 730$ | $16$ |
| $6$ | $10^9$ | $10^3$ | 无 | $19$ |
| $7$ | $10^{18}$ | $10^5$ | 无 | $37$ |

对于 $100\%$ 的数据，$1 \le n \le 10^{18},1 \le k \le 10^5$。

## 样例 #1

### 输入

```
15 2
```

### 输出

```
201012023
```

## 样例 #2

### 输入

```
1 3
```

### 输出

```
2
```

## 样例 #3

### 输入

```
521 6
```

### 输出

```
262795752
```

## 样例 #4

### 输入

```
6546546546546543 22211
```

### 输出

```
388124125
```

# AI分析结果



---

**唯一算法分类**：数学+数论+积性函数

---

### **题解思路、算法要点与解决难点**
#### **核心思路**
1. **特判偶数**：当 `n` 为偶数时，存在 `x_1 = n/2` 使乘积为0，直接返回0。
2. **转化为指数问题**：发现结果为 `2` 的幂次，转化为求指数 `g(n,t)` 的递推问题。
3. **积性函数拆分**：利用积性函数性质，将 `g(n,t)` 分解为质因子的贡献乘积。
4. **递推公式**：通过数论推导得到递推式：
   \[
   g(n,t) = \sum_{d|n} \varphi\left(\frac{n}{d}\right) \cdot d^{t-1} \cdot g\left(\frac{n}{d}, t-1\right)
   \]
5. **质因数分解**：用 Pollard-Rho 算法分解大数 `n`，逐个处理质因子的幂次。

#### **解决难点**
- **单位根乘积的转化**：通过复数单位根性质，将乘积转化为多项式根的形式。
- **递推关系推导**：通过分治和积性函数性质，将问题拆解为质因子幂次上的动态规划。
- **大数质因数分解**：对 `n ≤ 1e18` 高效分解，需实现 Pollard-Rho 算法。

---

### **题解评分 (≥4星)**
1. **VinstaG173 (5星)**  
   - **亮点**：完整推导递推公式，代码实现高效，处理 `k ≤ 1e5` 的大数据。
   - **代码**：Pollard-Rho 分解质因数，动态规划预处理每个质因子的贡献。
2. **bigmurmur (4星)**  
   - **亮点**：详细推导数学公式，解释每一步转化逻辑，适合理解。
   - **不足**：代码未完整展示，但思路与 VinstaG173 一致。

---

### **最优思路或技巧提炼**
1. **积性拆分**：将 `g(n,t)` 拆分为质因子贡献的乘积，避免直接计算大数。
2. **动态规划递推**：预处理每个质因子幂次的 `g(p^v, t)`，时间复杂度 `O(k·max_v)`。
3. **费马小定理优化**：指数部分取模 `mod-1`，最终结果用快速幂计算 `2^ans % mod`。
4. **Pollard-Rho 加速**：快速分解大数质因数，应对 `n ≤ 1e18`。

---

### **同类型题与算法套路**
1. **积性函数递推**：如计算欧拉函数、莫比乌斯函数的多重卷积。
2. **模意义下乘积**：结合费马小定理处理指数问题。
3. **质因数分解优化**：Pollard-Rho 或试除法分解后处理。

---

### **推荐相似题目**
1. **P2303 [SDOI2012] Longge 的问题**  
   （数论，积性函数性质）
2. **P4714 「数学」约数个数和**  
   （积性函数与递推）
3. **P4449 于神之怒加强版**  
   （质因数分解，快速幂优化）

---

### **代码核心逻辑**
#### **Pollard-Rho 分解质因数**
```cpp
struct Pollard_Rho {
    // 实现 Miller-Rabin 素性测试与 Pollard-Rho 分解
    void Factor(int n) { /* ... */ }
};
```

#### **动态规划预处理**
```cpp
for (int t=2; t<=K; ++t) {
    cnt=0;
    for (auto p : primes) {
        for (int c=0; c<=p.power; ++c) {
            // 递推计算 g(p^c, t)
            ans[t][cnt+c] = sum(φ(d) * d^{t-1} * g(n/d, t-1))
        }
    }
}
```

#### **最终结果计算**
```cpp
int res = 1;
for (auto p : primes) 
    res = res * ans[t][p.power] % MOD_PHI;
int ans_t = pow(2, res, mod);
```

---

### **可视化与算法演示**
#### **动画设计**
1. **质因数分解阶段**：  
   - **Canvas 网格**：显示 `n` 被分解为质因子方块（如 `3²×5¹`）。
   - **颜色标记**：不同质因子用不同颜色，分解过程动态显示。
2. **递推计算阶段**：  
   - **动态方块增长**：每个质因子的 `g(p^v, t)` 计算时，对应方块高度增长。
   - **高亮当前 `t`**：用闪烁边框标记当前计算的 `t` 值。
3. **音效提示**：  
   - **分解成功**：播放短促“叮”声。
   - **计算完成**：播放上扬音效。

#### **复古像素风格**
- **8位调色板**：质因子用红/绿/蓝像素块，结果栏用黄色。
- **自动演示模式**：按 `t` 步进，自动显示每步的递推结果。

---

### **个人心得摘录**
- **调试教训**：`n=1` 需特判，否则递推边界出错。
- **数学直觉**：从 `t=1` 的样例猜测结果为 `2` 的幂次，简化问题。

---
处理用时：81.81秒
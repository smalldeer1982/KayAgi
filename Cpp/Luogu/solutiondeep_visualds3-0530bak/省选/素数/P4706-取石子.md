# 题目信息

# 取石子

## 题目描述

现在 Yopilla 和 yww 要开始玩游戏！

他们在一条直线上标记了 $n$ 个点，从左往右依次标号为 $1, 2, ..., n$ 。然后在每个点上放置一些棋子，其中第 $i$ 个点放置了 $a_i$ 个棋子。接下来，从 Yopilla 开始操作，双方轮流操作，谁不能操作谁输。每次的操作是：当前操作方选定一个有棋子的点 $x$ ，然后选择至少一个点 $x$ 上的棋子，然后把这些棋子全都移动到点 $x / prime$ 上，其中 $prime$ 是一个质数，且 $prime \mid x$ 。

Yopilla 最初一次操作的策略是随机的：随机找到一个有棋子的点 $x$ ，随机选择正整数个棋子 $y$ ，随机转移到一个能转移到的点 $z$ 。所有棋子可以看作是一样的，换句话说：两种操作不同，当且仅当三元组 $(x, y, z)$ 不同。之后双方都按照最优策略来操作。

Yopilla 想要预测，他能够获胜的概率是多少，答案对 $998244353$ 取模。

## 说明/提示

样例解释：

$1$ 号点有 $3$ 个棋子，$2$ 号点有 $1$ 个棋子，$3$ 号点有 $2$ 个棋子。第一次操作的时候，能进行的有三种可能：将 $2$ 号点的 $1$ 个棋子移到 $1$ 号点，将 $3$ 号点的 $1$ 个棋子移到 $1$ 号点，将 $3$ 号点的 $2$ 个棋子移到一号点。而其中只有一种情况能使得 Yopilla 有必胜策略。所以答案为
$$\frac{1}{3} \equiv 332748118 \pmod {998244353}$$

对于 $20 \%$ 的数据，只有一个石子。

对于 $100 \%$ 的数据，$1 \le n \le {10} ^ 6, 0 \le a_i \le {10} ^ 9$ ，保证至少有一个不在一号点的石子。

## 样例 #1

### 输入

```
3
3 1 2```

### 输出

```
332748118```

# AI分析结果



---

**唯一算法分类**：博弈论-阶梯Nim

---

### **题解思路与算法要点**

#### **核心思路**
将石子移动规则转化为阶梯Nim模型，通过质因数分解的指数和奇偶性分层。奇层石子异或和决定胜负，统计所有能使异或和归零的初始随机操作概率。

#### **关键步骤**
1. **预处理**：线性筛法计算每个数的质因数种类数 `sum[i]` 和指数和奇偶性 `odd[i]`。
2. **计算初始SG值**：所有奇层石子数的异或和 `SG`。
3. **合法操作统计**：
   - **分母**：总操作数 `rnd = ∑a[i] * sum[i]`。
   - **分子**：枚举奇层点 `i`，计算使 `SG ^ a[i] ^ target = 0` 的合法操作数：
     - `target < a[i]`：需移动 `a[i]-target` 个石子到偶层，贡献 `sum[i]`。
     - `target > a[i]`：需从偶层 `j = i*p` 补充 `target-a[i]` 个石子，贡献符合条件的 `p` 数量。

#### **解决难点**
1. **模型转化**：将质因数分解的指数和奇偶性映射为阶梯Nim的奇偶层。
2. **高效预处理**：线性筛法在O(n)时间内计算 `sum` 和 `odd`。
3. **操作分类统计**：分情况讨论奇偶层间的移动合法性。

---

### **题解评分**
1. **cyffff的题解（5星）**  
   - **亮点**：完整代码实现，清晰分类讨论，高效筛法预处理。
   - **代码可读性**：结构清晰，变量命名合理。
2. **Roger_DTZ的题解（4星）**  
   - **亮点**：阶梯Nim模型转化思路明确，理论分析透彻。
   - **不足**：缺少具体代码实现细节。

---

### **最优思路提炼**
1. **阶梯Nim映射**：通过质因数指数和奇偶性划分奇偶层，仅奇层石子影响胜负。
2. **异或和归零**：统计所有使异或和变为零的初始操作，概率即为合法操作数/总操作数。
3. **线性筛预处理**：快速计算质因数种类数和奇偶性。

---

### **同类题目推荐**
1. [P3480 [POI2009] KAM-Pebbles](https://www.luogu.com.cn/problem/P3480)  
   （阶梯Nim经典问题）
2. [P2575 高手过招](https://www.luogu.com.cn/problem/P2575)  
   （博弈论状态分析）
3. [P2964 [USACO09NOV] Coin Game S](https://www.luogu.com.cn/problem/P2964)  
   （动态规划与博弈结合）

---

### **可视化设计**
1. **动画流程**：
   - **步骤1**：显示每个点 `i` 的质因数分解和奇偶层颜色（奇：红色，偶：蓝色）。
   - **步骤2**：动态计算并高亮初始异或和 `SG`。
   - **步骤3**：枚举奇层点 `i`，显示其 `a[i]` 与 `target` 的大小，用箭头标注合法移动方向（奇→偶或偶→奇）。
2. **交互设计**：
   - **速度控制**：滑动条调节动画速度。
   - **步进模式**：手动点击触发每一步计算。
   - **音效**：合法操作时播放“叮”，非法时播放“哔”。
3. **像素风格**：
   - **Canvas网格**：每个点用8x8像素块表示，奇偶层用不同颜色填充。
   - **音效**：8-bit风格音效，移动石子时触发短促音效。

---

### **核心代码实现**
```cpp
// 线性筛预处理奇偶性与质因数数
void sieve(int n) {
    for (int i = 2; i <= n; i++) {
        if (!p[i]) {
            pri[++cnt] = i;
            sum[i] = 1;
            odd[i] = 1; // 质数指数和为1（奇）
        }
        for (int j = 1; j <= cnt && i*pri[j] <= n; j++) {
            p[i*pri[j]] = 1;
            odd[i*pri[j]] = odd[i] ^ 1; // 继承奇偶性
            sum[i*pri[j]] = (i % pri[j] == 0) ? sum[i] : sum[i] + 1;
            if (i % pri[j] == 0) break;
        }
    }
}

// 统计合法操作
for (int i = 1; i <= n; i++) {
    if (odd[i]) {
        int need = SG ^ a[i];
        if (need < a[i]) {
            sol = (sol + sum[i]) % mod;
        } else if (need > a[i]) {
            for (int p : primes) {
                int j = i * p;
                if (j > n) break;
                if (a[j] >= need - a[i]) sol++;
            }
        }
    }
}
```

---

### **总结**
本题通过阶梯Nim模型转化，结合质因数分解的高效预处理，解决了复杂博弈概率计算问题。关键点在于奇偶层的判定与合法操作的分情况统计。

---
处理用时：163.14秒
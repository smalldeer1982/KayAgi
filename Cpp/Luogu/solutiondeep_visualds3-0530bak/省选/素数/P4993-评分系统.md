# 题目信息

# 评分系统

## 题目背景

答疑请到：https://www.luogu.org/discuss/show?postid=79498

由于时限等问题，请大家重交一遍这道题

本题时限开至2s

样例：https://files.cnblogs.com/files/ztz11/yl.rar

---

众所周知，luogu 有题目难度的评分系统，用户在通过题目后可以选择题目难度以及算法标签，来完善 luogu 的题库。

![](https://cdn.luogu.com.cn/upload/pic/40327.png)

（原注：以下内容非真实评分数据，纯属作者编造，仅供娱乐使用。）

## 题目描述

Menteur-Hxy 同学很不老实，为了实现 NOIp 前 AC $100$ 道黑题的目标，他决定雇佣一些水军，最少雇佣 $1$ 个水军。

每个水军都有一个能力值 $x_i$，表示该水军可以解决难度最高为 $x_i$ 的题目。这些水军十分尽职尽责，在通过这道题目后都会给题目评最高难度。当然，luogu 的正常用户也会做题，他们会正常地评分。现在，我们给你所有水军的能力值以及每道题正常用户的评分记录，请你求出有多少种选择水军的方案，可以使这道题的评分变为黑题。因为答案可能过大，最终请输出答案数 $\bmod p$ 的值。

评分计算公式：去掉一个最高分，去掉一个最低分后求平均分。

**【表一：投票信息】**

| 投票编号 | 对应难度 | 分数贡献 |
| :------: | :------: | :------: |
| $1$ | 入门 | $1$ |
| $2$ | 普及- | $10$ |
| $3$ | 普及/提高- | $15$ |
| $4$ | 普及+/提高 | $25$ |
| $5$ | 提高+/省选- | $40$ |
| $6$ | 省选/NOI- | $55$ |
| $7$ | NOI | $75$ |
| $8$ | NOI+/CTSC | $100$ |

**【表二：难度规则】**

| 难度等级 | 对应颜色 | 对应分数 |
| :------: | :------: | :------: |
| 入门 | 红 | $1\sim 5$ |
| 普及- | 橙 | $6\sim 12$ |
| 普及/提高- | 黄 | $13\sim 20$ |
| 普及+/提高 | 绿 | $21\sim 35$ |
| 提高+/省选- | 蓝 | $36\sim 45$ |
| 省选/NOI- | 紫 | $46\sim 70$ |
| NOI+/CTSC | 黑 | $71\sim 100$ |

## 说明/提示

**【样例解释 $1$】**

luogu 用户评分和为 $25+40+55+75+100=295$，弃掉一个最低分后为 $270$，这时 Menteur-Hxy 雇佣两个及以上水军就可以达到目的。

因为可以通过本题的水军共有 $4$ 个，所以选择方案共有：

$$\{1,2\}\{1,2,3\}\{1,2,3,4\}\{1,2,4\}\{1,3\}\{1,3,4\}\{1,4\}\{2,3\}\{2,3,4\}\{2,4\}\{3,4\}$$

共 $11$ 种，对 $9$ 取余后结果为 $2$。

**【数据规模与约定】**

对于 $30\%$ 的数据，$n, m \leq 50$。

对于另外 $20\%$ 的数据，$p$ 为质数。

对于 $100\%$ 的数据，$1 \leq n, m, k,s_i \leq 10^5, 1 \leq t \leq 5, 2 \leq p \leq 3 \times 10^3, 1 \leq t_i \leq 8$。

保证合格水军的数量与需要的最少水军数量之差不超过 $5000$。

（原注：本题可能轻微卡常。感谢 @Ghostcai ，@Swhsz 帮忙验题。）

## 样例 #1

### 输入

```
1
5 5 9
1 2 3 4 5
4 5 6 7 8
2```

### 输出

```
2```

## 样例 #2

### 输入

```
5
20 10 1329
540 499 490 419 308 261 323 476 476 374 23 13 14 16 19 34 43 19 27 32 
8 8 8 8 8 7 7 7 7 7 
50
20 10 1800
74 434 97 134 283 118 234 498 328 388 29 48 48 43 23 42 31 16 20 26 
8 8 7 6 8 8 8 7 7 7 
50
20 10 2704
142 378 330 281 377 64 340 309 466 289 34 37 19 17 20 48 21 28 38 15 
6 8 6 6 8 7 7 7 7 6 
50
20 10 72
365 356 456 479 459 222 548 377 212 223 38 20 49 18 49 38 31 48 41 17 
6 8 7 6 8 7 8 8 8 6 
50
20 10 1416
367 191 403 298 445 464 79 467 431 362 10 45 48 37 46 43 11 35 30 39 
8 6 8 7 7 7 8 8 7 8 
50```

### 输出

```
1023
1023
1023
15
1023```

# AI分析结果



## 唯一算法分类
**组合数学 + 数论（Lucas/exLucas 定理）**

---

## 综合分析与结论

### 题目核心逻辑
1. **数学推导**：通过不等式确定最少需要的水军数量 `x_min`，使得评分 ≥71。
2. **组合计数**：计算从合格水军中选择 `x_min` 到 `cnt` 人的方案数之和，模 `p`。
3. **大数取模**：使用 Lucas 或 exLucas 定理处理组合数取模问题。

### 关键难点与解决方案
1. **最少水军计算**：
   - 推导公式：`x_min = max(1, ceil((71*m - sum + min_user -42)/29))`，其中 `sum` 为用户评分总和减去最低分。
   - 通过数学不等式变形确保公式正确性。
2. **组合数求和优化**：
   - **质数模数**：Lucas 定理高效计算组合数。
   - **合数模数**：exLucas 分解质因数后合并结果。
3. **合格水军筛选**：快速遍历并统计能力值 ≥`k` 的水军数量。

### 题解对比与亮点
- **WhitD 题解（★★★★）**：
  - **推导清晰**：直接解不等式得出 `x_min`，逻辑直观。
  - **分治优化**：根据模数是否为质数选择算法，提升效率。
  - **代码简洁**：变量命名明确，结构模块化。
- **ztz11 题解（★★★）**：
  - **通用性**：统一使用 exLucas，适用所有模数。
  - **部分推导隐晦**：`mins` 计算需结合代码逆向理解。

---

## 最优思路与技巧提炼
### 核心公式推导
```python
x_min = max(1, ceil((71*m - sum_user + min_user -42) / 29))
```
- **sum_user**：用户评分总和减去最低分。
- **min_user**：用户评分中的最低分。

### 组合数求和优化
- **质数模数**：Lucas 定理（复杂度 `O(p log n)`）。
- **合数模数**：exLucas 分解质因数后合并（中国剩余定理）。

### 实现技巧
1. **预处理合格水军**：排序后二分查找或直接遍历统计。
2. **模数分治**：先判断 `p` 是否为质数，选择最优算法。

---

## 同类型题与算法套路
1. **组合数取模**：POJ 1811（质数判定）、洛谷 P3807（Lucas 模板）。
2. **不等式最值+组合计数**：LeetCode 1601（最小硬件选择问题）。

---

## 推荐题目
1. **P3807** 【模板】卢卡斯定理/Lucas 定理  
   （组合数取模基础）
2. **P1313** 计算系数  
   （多项式展开中的组合数应用）
3. **P3197** [HNOI2008]越狱  
   （组合数学逆向思维）

---

## 可视化与算法演示设计
### 动画流程
1. **用户评分处理**：
   - 高亮最低分和总分计算区域。
   - 动态显示 `sum = total - min_score`。
2. **不等式推导**：
   - 分步展示公式变形过程（如像素字体逐行显示）。
3. **组合数求和**：
   - 用网格表示水军，选中不同数量时触发音效。
   - 实时显示 `C(cnt, x)` 的值和累加结果。

### 复古像素风格
- **颜色方案**：8-bit 调色板（红、绿、紫表示不同分数段）。
- **音效设计**：
  - **选中水军**：短促“哔”声。
  - **计算完成**：经典 FC 过关音效。
- **Canvas 交互**：
  - 网格点击选择水军，右侧面板显示公式和结果。

---

## 核心代码实现（WhitD 题解）
### 组合数计算（Lucas + exLucas）
```cpp
int exLucas(int n, int m, int p) {
    if (m > n) return 0;
    int res = 0, tmp = p;
    for (int i = 2; i * i <= tmp; i++) {
        if (tmp % i == 0) {
            int pk = 1;
            while (tmp % i == 0) pk *= i, tmp /= i;
            res = (res + multiLucas(n, m, i, pk) * inv(p / pk, pk) % p * (p / pk)) % p;
        }
    }
    if (tmp > 1)
        res = (res + Lucas(n, m, tmp) * inv(p / tmp, tmp) % p * (p / tmp)) % p;
    return res;
}
```

### 主逻辑
```cpp
// 计算最少水军 x_min
sum_user -= min_user;
x_min = max(1, (71 * m - sum_user -42 +29-1) /29);

// 统计合格水军数量
cnt = count_if(s, s + n, [k](int x) { return x >= k; });

// 计算组合数之和
for (int x = x_min; x <= cnt; x++) {
    if (is_prime(p)) ans += Lucas(cnt, x, p);
    else ans += exLucas(cnt, x, p);
    ans %= p;
}
```

---

## 个人心得摘录
- **WhitD**：  
  *“扩展卢卡斯在合数模数时较慢，分开处理质数可显著优化速度。”*
- **ztz11**：  
  *“部分数据可能允许暴力通过，但需注意边界条件。”*

---
处理用时：194.26秒
# 题目信息

# 「PHOI-1」斗之魂

## 题目背景

**本题数据已加强。**

小 X 忙了一天，于是打起了一款叫斗之魂的游戏。

![](https://cdn.luogu.com.cn/upload/image_hosting/5ha5fx0q.png)

## 题目描述

小 X 要击败 $n$ 个 BOSS，他可以选择以下两种击败 BOSS 的方式：

1. 独自一人击败第 $i$ 个 BOSS 并获得 $k_{i,0}$ 块稀有金属，且保证 $k_{i,0}=k_{i,1}=k_{i,2}$。
2. 和小 Y 一起击败第 $i$ 个 BOSS ，小 X 理应获得 $k_{i,1}$ 块稀有金属，小 Y 理应获得 $k_{i,2}$ 块稀有金属，但是 BOSS 本身实力并没有因为人数的改变而改变，击败难度相对要简单一点，所以系统判定两人实际各获得 $k_{i,0}$ 块稀有金属，其中保证 $\dfrac{1}{k_{i,0}}=\dfrac{1}{k_{i,1}}+\dfrac{1}{k_{i,2}}$。

小 X 已经计划好用第 $b_i$ 种方式击败第 $i$ 个 BOSS，但是考虑到某些因素，小 X 有 $q$ 次询问，每次询问给定一个正整数 $m$，为小 X 击败完所有 BOSS 后获得的稀有金属总数，已知 $k_{i,0},k_{i,1},k_{i,2}$ 均为正整数，求每次询问后所有可能的 $k$ 的值的方案数，两种方案不同当且仅当至少存在一个 $k$ 的值不同，由于这个答案可能很大，你只需要输出它对 $998244353$ 取模后的结果。

## 说明/提示

**本题采用捆绑测试。**

| Subtask |      $n\le$       |      $m \le$      | $q \le$ |  时限  | 分值 |
| :-----: | :---------------: | :---------------: | :-----: | :----: | :--: |
|   $0$   |       $10$        |       $20$        |   $5$   |  $1s$  | $8$  |
|   $1$   |       $30$        |       $60$        |   $5$   |  $1s$  | $7$  |
|   $2$   |       $40$        |       $100$       | $10^3$  |  $1s$  | $5$  |
|   $3$   |       $150$       |       $500$       | $10^3$  |  $1s$  | $5$  |
|   $4$   |       $200$       |      $5000$       | $10^4$  |  $1s$  | $20$ |
|   $5$   |      $2000$       |  $5 \times 10^4$  | $10^5$  |  $1s$  | $25$ |
|   $6$   | $1.5 \times 10^5$ | $2.5 \times 10^5$ | $10^5$  | $1.8s$ | $30$ |

对于 $100\%$ 的数据，保证 $1 \le n \le 1.5 \times 10^5$，$1 \le m \le 2.5 \times 10^5$，$1 \le b_i \le 2$，$1 \le q \le 10^5$。

### 样例解释 #1：

- 当 $m=3$ 时，所有可能的 $k$ 的值的方案数为 $4$。

    第 $1$ 种：$k_{1,0}=1,k_{1,1}=k_{1,2}=2,k_{2,0}=k_{2,1}=k_{2,2}=2$

    第 $2$ 种：$k_{1,0}=2,k_{1,1}=3,k_{1,2}=6,k_{2,0}=k_{2,1}=k_{2,2}=1$

    第 $3$ 种：$k_{1,0}=2,k_{1,1}=k_{1,2}=4,k_{2,0}=k_{2,1}=k_{2,2}=1$

    第 $4$ 种：$k_{1,0}=2,k_{1,1}=6,k_{1,2}=3,k_{2,0}=k_{2,1}=k_{2,2}=1$

- 当 $m=4$ 时，所有可能的 $k$ 的值的方案数为 $7$。

    第 $1$ 种：$k_{1,0}=1,k_{1,1}=k_{1,2}=2,k_{2,0}=k_{2,1}=k_{2,2}=3$

    第 $2$ 种：$k_{1,0}=2,k_{1,1}=3,k_{1,2}=6,k_{2,0}=k_{2,1}=k_{2,2}=2$

    第 $3$ 种：$k_{1,0}=2,k_{1,1}=k_{1,2}=4,k_{2,0}=k_{2,1}=k_{2,2}=2$

    第 $4$ 种：$k_{1,0}=2,k_{1,1}=6,k_{1,2}=3,k_{2,0}=k_{2,1}=k_{2,2}=2$

    第 $5$ 种：$k_{1,0}=3,k_{1,1}=4,k_{1,2}=12,k_{2,0}=k_{2,1}=k_{2,2}=1$

    第 $6$ 种：$k_{1,0}=3,k_{1,1}=6,k_{1,2}=6,k_{2,0}=k_{2,1}=k_{2,2}=1$

    第 $7$ 种：$k_{1,0}=3,k_{1,1}=12,k_{1,2}=4,k_{2,0}=k_{2,1}=k_{2,2}=1$

## 样例 #1

### 输入

```
2 2
2 1
3
4
```

### 输出

```
4
7
```

## 样例 #2

### 输入

```
5 5
1 2 1 2 1
4
6
8
10
12
```

### 输出

```
0
9
119
630
2210```

# AI分析结果



**唯一算法分类**：生成函数（多项式乘法）

---

### 综合分析与结论

**核心思路**：
1. **预处理因数数目**：通过线性筛和质因数分解，预处理每个数平方的因数个数。
2. **生成函数建模**：将两种击败方式转化为生成函数，方式1对应组合数生成函数，方式2对应多项式快速幂。
3. **多项式卷积**：通过NTT实现多项式乘法和快速幂，高效计算总方案数。

**难点与解决方案**：
- **因数数目计算**：利用质因数分解性质 `d(k²) = Π(2α_i + 1)`，通过线性筛预处理每个数的质因子及其次数。
- **生成函数优化**：方式1的生成函数直接使用组合数学公式，方式2通过多项式快速幂处理，避免显式动态规划的高复杂度。

**可视化设计**：
- **像素动画**：用Canvas绘制生成函数的系数变化，每个步骤对应多项式乘法的一次操作。
- **高亮关键步骤**：生成函数构建、快速幂分治、卷积结果更新时，用不同颜色标记。
- **音效提示**：多项式乘法完成时播放短促音效，快速幂阶段切换时使用音调变化。

---

### 题解清单（评分 ≥4星）

1. **yydfj的题解（5星）**  
   - **亮点**：完整推导方程转化，结合线性筛预处理和NTT优化，代码结构清晰。
   - **关键代码**：预处理因数数组 `yz[]`，并通过NTT实现多项式快速幂。

2. **Fzrcy的题解（4星）**  
   - **亮点**：简化生成函数处理逻辑，通过组合数学直接计算方式1的方案数。
   - **关键代码**：`sieve`函数预处理因数数目，多项式快速幂封装更简洁。

---

### 最优思路与技巧提炼

1. **线性筛优化**：在筛法过程中记录每个数的最小质因子，动态计算其平方因数数目。
2. **生成函数分治**：将问题拆分为方式1（组合数）和方式2（多项式快速幂），分别处理后再卷积。
3. **多项式快速幂**：通过取对数、线性变换、再取指数的方式，高效计算多项式的幂次。

**代码片段（核心预处理与生成函数）**：
```cpp
// 线性筛预处理平方因数数目
void sieve(int n) {
    for (int i = 2; i <= n; i++) {
        if (!vis[i]) {
            pr[++pc] = i;
            ci[i] = 1;
            vis[i] = i;
        }
        for (int j = 1; j <= pc && i*pr[j] <= n; j++) {
            if (i % pr[j]) {
                ci[i*pr[j]] = 1;
                vis[i*pr[j]] = pr[j];
            } else {
                ci[i*pr[j]] = ci[i] + 1;
                vis[i*pr[j]] = vis[i] * pr[j];
                break;
            }
        }
        f[i-1] = (2 * ci[i] + 1) * f[i / vis[i]]; // 递推计算因数数目
    }
}
```

---

### 类似题目推荐

1. **P3321 [SDOI2015]序列统计**  
   - 生成函数与循环卷积结合，处理模数下的方案数问题。
2. **P4389 付公主的背包**  
   - 生成函数与多项式对数/指数运算优化，处理物品组合问题。
3. **P4721 【模板】分治 FFT**  
   - 分治与生成函数结合，解决动态规划中的递推式。

---

### 个人心得摘录

- **yydfj的调试经验**：推导中发现方程可因式分解为 `(k0 - k1)(k0 - k2) = k0²`，从而简化因数数目计算。
- **Fzrcy的优化思路**：意识到方式1的方案数可直接用组合数公式，避免生成函数展开。

---

### 可视化与复古游戏化设计

**动画方案**：
1. **网格绘制**：用Canvas绘制二维网格，行表示BOSS序号，列表示当前金属总数，高亮当前处理的位置。
2. **多项式系数更新**：每次多项式乘法后，用像素方块表示系数变化，颜色深浅表示方案数大小。
3. **音效设计**：
   - **卷积完成**：播放“哔”声。
   - **快速幂阶段**：每完成一次幂次播放上升音调。

**交互功能**：
- **速度调节**：滑动条控制动画速度。
- **AI自动演示**：按BOSS顺序自动执行生成函数构建和卷积，显示实时结果。

---
处理用时：101.74秒
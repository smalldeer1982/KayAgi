# 题目信息

# [HAOI2017] 八纵八横

## 题目描述

Anihc 国有 $n$ 个城市，这 $n$ 个城市从 $1$ 到 $n$ 编号，$1$ 号城市为首都。城市间初始时有 $m$ 条高速公路，每条高速公路都有一个非负整数的经济影响因子，每条高速公路的两端都是城市（可能两端是同一个城市），保证任意两个城市都可以通过高速公路互达。

国正在筹划“八纵八横”的高铁建设计划，计划要修建一些高速铁路，每条高速铁路两端也都是城市（可能两端是同一个城市)，也都有一个非负整数的经济影响因子。国家还计划在“八纵八横”计划建成之后，将“一带一路”扩展为“一带一路一环”，增加“内陆城市经济环”即选择一条从首都出发沿若一系列高铁与高速公路走的路径，每条高铁或高速公路可以经过多次，每座城市也可以经过多次，最后路径又在首都结束。令“内陆城市经济环”的 GDP 为依次将这条路径上所经过的高铁或高速公路的经济影响因子异或起来（一条路经过多次则会被计算多次）。

现在 Anihc 在会议上讨论“八纵八横”的建设计划方案，他们会不断地修改计划方案，希望你能实时反馈对于当前的“八纵八横”的建设计划的方案“内陆城市经济环”的最大是多少。

初始时，八纵八横计划中不包含任何一条高铁，有以下 $3$ 种操作：

`Add x y z`

在计划中给在城市 $x$ 和城市 $y$ 之间建设一条高铁，其经济影响因子为 $z$，如果这是第 $k$ 个 `Add` 操作，则将这条高铁命名为 $k$ 号高铁。

`Cancel k`

将计划中的 $k$ 号高铁取消掉，保证此时 $k$ 号高铁一定存在。

`Change k z`

表示将第 $k$ 号高铁的经济影响因子更改为 $z$，保证此时 $k$ 号高铁一定存在。


## 说明/提示

### 数据规模与约定

令所有的经济因子二进制表示的最多位数为 $len$。数据满足以下表格：

| 数据点 | $n$ | $m$ | $Q$ | $len$ | 特殊性质 |
| :----------: | :----------: | :----------: | :----------: | :----------: | :----------: |
| 1 | $\leq 5$ | $\leq 8$ | $0$ | $\leq 31$ |  |
| 2 | $\leq 100$ | $=n + 1$ | $0$ | $\leq 100$ |  |
| 3 | $\leq 100$ | $\leq 100$ | $0$ | $\leq 100$ |  |
| 4 | $\leq 500$ | $\leq 500$ | $0$ | $\leq 1000$ |  |
| 5 |$\leq 100$ | $\leq 100$ | $\leq 100$ | $\leq 200$ | 只存在 `Add` 操作 |
| 6 | $\leq 500$ | $\leq 500$ | $\leq 200$ | $\leq 1000$ |  |
| 7 | $\leq 100$ | $\leq 100$ | $\leq 1000$ | $\leq 200$ |  |
| 8 | $\leq 500$ | $\leq 500$ | $\leq 1000$ | $\leq 1000$ |  |
| 9 | $\leq 500$ | $\leq 500$ | $\leq 1000$ | $\leq 1000$ |  |
| 10 | $\leq 500$ | $\leq 500$ | $\leq 1000$ | $\leq 1000$ |  |

对于所有的数据保证：$1\leq n,m\leq 500$，$0\leq Q\leq 1000$，$1\leq len\leq 1000$，$1\leq x,y\leq n$。且 `Add` 操作不超过 $550$ 个。两个城市之间可能有多条高速公路或高铁，高速公路或高铁的两端可能是同一个城市（即：有重边，有自环）。


## 样例 #1

### 输入

```
4 4 3
1 2 1110
1 3 10
2 4 1110
2 3 100
Add 3 4 11
Change 1 101
Cancel 1```

### 输出

```
1000
1001
1111
1000```

# AI分析结果



**唯一算法分类：线段树分治**

---

### **题解思路、算法要点与解决难点**

**核心思路**：  
- **环与异或路径**：从1出发返回1的路径异或和等价于任意环的异或组合。利用生成树将环拆分为树边与非树边构成的环。
- **动态维护环**：通过线段树分治离线处理边的增删改，将动态问题转化为静态区间操作，避免直接处理删除。
- **线性基撤销**：利用线性基的可撤销特性，在递归线段树时保存状态，回溯时恢复。

**关键步骤**：  
1. **生成树构建**：初始图生成树，计算节点异或路径`dis[x]`。
2. **初始环处理**：非树边对应环的异或值插入线性基。
3. **线段树分治**：将每条边的存在时间区间插入线段树节点，递归处理时维护线性基。
4. **可撤销线性基**：每次递归保存线性基状态，回溯时恢复。

**难点解决**：  
- **动态操作处理**：通过时间区间划分，将边的存在时间段离散化。
- **高效维护线性基**：利用分治结构减少重复计算，空间优化。

---

### **题解评分 (≥4星)**

1. **xtx1092515503 (5星)**  
   - **亮点**：可删除线性基实现，时间复杂度低（无额外log）。  
   - **代码**：使用`bitset`优化，维护每个元素的删除时间，插入时替换旧元素。

2. **zhiyangfan (4星)**  
   - **亮点**：线段树分治+可撤销线性基，思路清晰。  
   - **代码**：完整实现分治结构，维护生成树和环的插入。

3. **SSerxhs (4星)**  
   - **亮点**：简洁的分治逻辑，注释清晰。  
   - **心得**：“线段树分治傻题”体现对算法的深刻理解。

---

### **最优思路与技巧提炼**

**关键技巧**：  
1. **生成树拆环**：仅需处理非树边构成的环，简化问题。
2. **时间区间映射**：将动态操作转化为静态区间，离线处理。
3. **线性基撤销**：通过栈保存状态，实现快速回溯。

**代码片段**（线段树分治核心逻辑）：  
```cpp
void dfs(int u, int l, int r, Basis &base) {
    vector<bs> backup = base.save();  // 保存当前状态
    for (auto &e : tree[u].edges) {
        base.insert(e.xor_val);       // 插入当前区间的环
    }
    if (l == r) {
        ans[l] = base.query_max();   // 记录答案
    } else {
        int mid = (l + r) >> 1;
        dfs(u<<1, l, mid, base);     // 递归左子树
        dfs(u<<1|1, mid+1, r, base); // 递归右子树
    }
    base.restore(backup);            // 回溯恢复状态
}
```

---

### **同类型题与算法套路**

**相似题目**：  
1. **P4151 [WC2011] 最大XOR和路径**（静态环异或最大值）  
2. **CF938G Shortest Path Queries**（动态图最短路+线段树分治）  
3. **BZOJ4184 shallot**（动态线性基+线段树分治）

**通用解法**：  
- **动态维护集合极值** → 线段树分治离线处理。  
- **不可逆操作** → 可撤销数据结构（如并查集、线性基）。

---

### **推荐题目**

1. **P4151**：静态环异或最大值，理解生成树拆环。  
2. **CF938G**：动态图最短路，结合分治与线性基。  
3. **BZOJ4184**：动态集合维护，练习分治+线性基。

---

### **可视化与算法演示**

**动画设计**：  
1. **生成树构建**：绿色边为树边，红色为非树边，显示环的异或值插入过程。  
2. **线段树分治**：每个节点显示覆盖的时间区间和插入的环，递归时高亮当前区间。  
3. **线性基更新**：插入新元素时显示位替换，回溯时元素渐隐。

**复古像素风格**：  
- **颜色方案**：树边（绿色）、非树边（红色）、当前操作边（黄色闪烁）。  
- **音效**：插入成功（8-bit“叮”声），回溯（低沉“哐”声）。  
- **Canvas动画**：网格显示时间轴，方块表示操作区间，点击播放分治过程。

---

### **个人心得摘录**

- **xtx1092515503**：“可删除线性基少一个log”——强调时间复杂度优化。  
- **SSerxhs**：“线段树分治傻题”——体现对算法本质的透彻理解。  
- **调试教训**：线性基撤销需严格匹配插入次数，漏掉`break`导致状态错误。

---

### **总结**

本题通过线段树分治将动态问题静态化，结合生成树拆环和可撤销线性基，高效处理动态异或路径问题。可视化重点在于分治过程和线性基状态变化，复古风格增强学习趣味性。

---
处理用时：70.74秒
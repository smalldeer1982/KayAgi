# 题目信息

# 「Wdoi-1」四重存在

## 题目背景

芙兰朵露·斯卡蕾特的符卡禁忌「四重存在」可以产生 $4$ 个芙兰的幻影。

但是芙兰并不满足于此。

## 题目描述

芙兰所处的地下室可以被抽象为一个巨大的平面直角坐标系。芙兰朵露会进行 $q$ 次行动，每次行动的形式如下：  

- `1 x y v` 表示芙兰在坐标 $(x,y)$ 处召唤出一个新的幻影，这个幻影拥有 $v$ 个单位的力量。  

- `2` 表示查询现有的幻影中，"**芙兰距离**"的最大值是多少。  

- `3 a` 表示查询如果忽略掉第 $a$ 个被召唤出的幻影，则剩余的幻影中"芙兰距离"的最大值是多少 。

注： 

记第 $i$ 个被召唤出的幻影编号为 $i$，坐标为 $(x_i,y_i)$，力量为 $v_i$。  

两个编号为 $u,v$ 的幻影间的"芙兰距离"等于 $|x_u-x_v|+|y_u-y_v|+v_{\max(u,v)}$。

**特殊地，编号为 $i$ 的幻影与自己的"芙兰距离"为 $v_i$。**  

$3$ 操作中第 $a$ 个召唤的幻影只是在本次询问中不参与运算，而不是被去除。

## 说明/提示

#### 数据范围与约定

**「本题采用捆绑测试：一个子任务通过，当且仅当该子任务中全部测试点通过」。**

| 子任务编号 | $q \le$ | 特殊性质 | 分值 |
| :----------: | :-------: | :--------: | :---: |
| $1$ | $500$ | 无 | $5$ |
| $2$ | $5 \times 10^3$ | A | $10$ |
| $3$ | $10^5$ | A | $20$ |
| $4$ | $10^5$ | 无 | $25$ |
| $5$ | $2 \times 10^6$ | 无 | $40$ |

其中性质 A 表示无 3 操作。

对于 $100\%$ 的数据，$-10^8 \le x,y,v \le 10^8$，记某一时刻幻影的数量为 $c$，则有 $1 \le a \le c$ 。

数据保证任意两个幻影的坐标不同，且在询问 $2,3$ 时至少已经插入 $3$ 个点。

## 样例 #1

### 输入

```
6
1 4 -4 0
1 -3 -1 0
1 -1 -1 0
2
3 2
3 3```

### 输出

```
10
8
10
```

# AI分析结果



---

**唯一算法分类**：曼哈顿距离优化 + 线段树/极值维护

---

### **题解思路、算法要点与解决难点**

#### **核心思路**
1. **曼哈顿距离转切比雪夫距离**  
   将坐标 $(x,y)$ 转换为 $(x+y, x-y)$，使得曼哈顿距离的最大值转化为切比雪夫距离的最大值，只需维护四个方向（最大/最小的 $x+y$ 和 $x-y$）的极值点即可快速计算。
   
2. **极值点维护**  
   每次插入新点时，维护四个方向的最值点和次最值点。例如，维护最大 $x+y$ 的点及其次大点，用于快速找到与新点距离最远的点。

3. **操作3的排除处理**  
   当排除点 $a$ 时，需保证最大距离的点对 $(u,v)$ 中 $u \neq a$ 且 $v \neq a$。线段树方法通过记录每个点对的影响区间，实现快速查询；非线段树方法通过预存最大值、次大值及其依赖关系，直接推导排除后的结果。

---

### **题解评分 (≥4星)**

1. **樱雪喵（4星）**  
   - **亮点**：使用线段树实现区间更新与单点查询，逻辑清晰；代码完整且注释详细。  
   - **缺点**：线段树常数较大，可能影响性能极限。

2. **RsCb（4星）**  
   - **亮点**：线性时间复杂度，无需线段树；通过维护极值和次极值结构实现高效查询。  
   - **缺点**：代码逻辑复杂，需处理多组最值关系，调试难度较高。

---

### **最优思路或技巧提炼**

1. **曼哈顿转切比雪夫**  
   关键公式：  
   $$|x_1 - x_2| + |y_1 - y_2| = \max(|(x_1+y_1)-(x_2+y_2)|, |(x_1-y_1)-(x_2-y_2)|)$$  
   将曼哈顿距离转化为极值比较问题，只需维护四个方向的极值点。

2. **线段树区间标记法**  
   每个点对 $(u,v)$ 的贡献 $w$ 会影响所有不包含 $u$ 和 $v$ 的区间。插入时，将 $w$ 标记到区间 $[1,u-1]$, $[u+1,v-1]$, $[v+1,n]$，查询时取单点路径上的最大值。

3. **极值次极值维护**  
   维护每个方向的极值和次极值点，确保在排除某个点时能快速找到次优解，避免重新遍历所有点。

---

### **同类型题或类似算法套路**

1. **动态维护极值**  
   类似问题：动态插入点，实时查询最大距离/面积。  
   通用解法：维护极值点或使用扫描线算法。

2. **带排除的最值查询**  
   类似问题：求忽略某个元素后的数组最值。  
   通用解法：预存最大值、次大值及其依赖关系，或使用线段树/单调队列。

---

### **推荐相似题目**

1. **P1904 天际线**  
   - 动态维护极值点，计算轮廓线。

2. **P5490 扫描线**  
   - 矩形面积并，离散化与线段树结合。

3. **P1972 区间查询**  
   - 带排除操作的最值统计，需高效数据结构。

---

### **个人心得摘录**

- **樱雪喵**：  
  > “统计最大值和次大值时注意判重，要判断某个点同时是横坐标和纵坐标最大值的情况。”  
  ——需处理极值点的重复贡献。

- **RsCb**：  
  > “因为忘了强制在线调了好久。”  
  ——细节处理（如异或操作）容易被忽视。

---

### **可视化与算法演示**

#### **核心算法流程**
1. **插入新点**  
   - **动画**：Canvas 绘制新点，高亮其转换后的坐标 $(x+y, x-y)$。  
   - **极值更新**：标记四个方向的极值点（红色为最大值，黄色为次大值）。

2. **查询最大距离**  
   - **连线**：动态绘制当前极值点与新点的连线，显示曼哈顿距离和 $v$ 值。  
   - **线段树更新**：以网格形式展示线段树区间标记过程，颜色深浅表示区间最大值。

3. **排除点查询**  
   - **高亮排除点**：被排除点变为灰色，其他点重新计算最大距离。  
   - **次极值激活**：次大值点变为绿色，表示其成为新极值。

#### **复古游戏化设计**
- **8位像素风格**：  
  - 坐标系以 16x16 像素块展示，极值点用闪烁效果标记。  
  - 音效：插入点时播放“放置”音效，查询成功时播放“胜利”音效。

- **自动演示模式**：  
  - 模拟插入和查询操作，AI 按最优策略选择极值点，动态显示决策路径。

---

### **代码片段（樱雪喵题解核心）**

```cpp
// 曼哈顿转切比雪夫坐标
node now = {x + y, x - y, cnt};
// 更新四个方向的极值点
upd(now);

// 线段树区间更新
void modify(int l, int r, int w) {
    seg.modify(1, 1, maxn, l, r, w);
}

// 插入新点时计算贡献
for (方向极值点) {
    int dis = max(|x1 - x2|, |y1 - y2|) + v;
    modify(1, u-1, dis);
    modify(u+1, v-1, dis);
    modify(v+1, n, dis);
}

// 查询排除点a的最大值
int query(int a) {
    return seg.query(a);
}
```

---

**总结**：本题核心在于极值维护与高效排除查询，线段树和极值次极值法各有优劣，前者更通用，后者更高效。

---
处理用时：76.03秒
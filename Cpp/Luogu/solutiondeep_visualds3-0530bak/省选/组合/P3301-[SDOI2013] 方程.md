# 题目信息

# [SDOI2013] 方程

## 题目描述

给定方程
$x_1+x_2+\dots +x_{n}=m$。

我们对第 $1 \sim n_1$ 个变量进行一些限制： $x_{1} \le a_{1},x_{2} \le a_{2},\dots, x_{n_1} \le a_{n_1}$。

我们对第 $n_1+1\sim n_1+n_2$ 个变量进行一些限制： $x_{n_1+1} \ge a_{n_1+1},x_{n_1+2} \ge a_{n_1+2},\dots,x_{n1+n2} \ge a_{n_1+n_2}$。

求：在满足这些限制的前提下，该方程正整数解的个数。答案可能很大，请输出对 $p$ 取模后的答案。

## 说明/提示

**【样例解释】**

对于第一组数据，三组解为 $(1,3,2)，(1,4,1),(2,3,1) $。  
对于第二组数据，六组解为 $(1,1,3),(1,2,2),(1,3,1),(2,1,2),(2,2,1),(3,1,1)$。

![](https://cdn.luogu.com.cn/upload/pic/17621.png)

对于 $100\%$ 的数据，$1\le T \le 5$，$1\le m, n \le 10^9$，$1 \le a_i \le m$，$0 \le n_1,n_2 \le \min(8, m)$ 且 $n_1 + n_2 \le n$，$1\le p \le 437367875$。

## 样例 #1

### 输入

```
3 10007
3 1 1 6
3 3
3 0 0 5

3 1 1 3
3 3
```

### 输出

```
3
6
0
```

# AI分析结果



**唯一算法分类**  
扩展卢卡斯定理（exLucas） + 容斥原理  

---

### **综合分析与结论**  
**核心思路**：  
1. **下界处理**：将每个下界限制 $x_i \ge a_i$ 转换为 $x_i' = x_i - (a_i-1) \ge 1$，并调整总和 $m$。  
2. **上界容斥**：枚举违反上界限制的子集 $S$，计算对应方案数 $\tbinom{m' - \sum_{i \in S} (a_i+1) -1}{n-1}$，按子集大小奇偶性加减。  
3. **组合数计算**：使用扩展卢卡斯定理处理模数非质数的情况，结合中国剩余定理（CRT）合并结果。  

**算法流程可视化设计**：  
- **动画步骤**：  
  1. 调整下界：将每个下界变量转化为普通变量，动态显示 $m$ 的减少。  
  2. 枚举容斥子集：以像素网格展示所有可能的子集，高亮当前选中子集。  
  3. 计算组合数：分解模数为质因数，分块显示各质因数对应的阶乘计算与合并过程。  
- **颜色标记**：  
  - 红色高亮当前容斥子集的变量，蓝色标记调整后的 $m$ 值。  
  - 质因数分解模块用不同颜色区分，合并步骤以绿色闪烁提示。  

**复古像素风格设计**：  
- **8-bit 界面**：用像素网格展示变量调整和子集枚举，每步操作伴随经典音效。  
- **音效触发**：  
  - 成功计算子集时播放上升音调。  
  - 质因数分解完成时播放短促“滴”声。  
- **自动演示模式**：按预设顺序执行容斥子集，展示组合数计算流程。  

---

### **题解清单 (≥4星)**  
1. **kkksx (5星)**  
   - **亮点**：代码结构清晰，完整实现 exLucas 模板，预处理阶乘优化效率。  
   - **核心代码**：通过 `fac()` 函数递归计算阶乘，结合快速幂和逆元优化。  

2. **ezoixx118 (4星)**  
   - **亮点**：详细注释与模块化设计，提前分解模数减少重复计算。  
   - **心得摘录**：“练习容斥，exLucas 好题”——强调组合应用的重要性。  

3. **mango09 (4星)**  
   - **亮点**：预处理质因数分解，优化多次查询效率，DFS 枚举容斥子集。  

---

### **最优思路与代码实现**  
**关键代码片段（exLucas 核心）**：  
```cpp  
ll exlucas(ll n, ll m, ll pi, ll pk) {  
    if (n < m) return 0;  
    ll ans = 0;  
    // 预处理阶乘优化  
    for (int i = 1; i <= pk; ++i)  
        if (i % pi) f[i] = f[i-1] * i % pk;  
        else f[i] = f[i-1];  
    // 递归计算组合数  
    ll jn = fac(n, pi, pk), jm = fac(m, pi, pk), jnm = fac(n-m, pi, pk);  
    ll cnt = 0;  
    for (ll i = n; i; i /= pi) cnt += i/pi;  
    // ... 逆元与合并  
    return ans;  
}  
```  

---

### **相似题目推荐**  
1. **P4720 【模板】扩展卢卡斯**  
2. **P4104 [HEOI2014] 平衡**（容斥 + 组合计数）  
3. **P2518 [HAOI2010] 计数**（高精度组合数模非质数）  

---

### **可视化与游戏化实现**  
**Canvas 动画设计**：  
- **网格布局**：每行代表一个变量，点击切换容斥状态（红/绿）。  
- **质因数分解块**：动态显示质因数分解过程，合并时高亮对应块。  
- **音效集成**：使用 Web Audio API 播放 8-bit 音效，如：  
```javascript  
function playBeep() {  
    const osc = audioCtx.createOscillator();  
    osc.frequency.setValueAtTime(800, audioCtx.currentTime);  
    osc.connect(audioCtx.destination);  
    osc.start(); osc.stop(audioCtx.currentTime + 0.1);  
}  
```  

**交互功能**：  
- **步进控制**：按钮控制动画进度，速度可调。  
- **自动演示**：AI 按最优路径枚举子集，展示高效容斥策略。  

通过结合算法逻辑与复古交互设计，使复杂数学过程直观且趣味盎然。

---
处理用时：76.85秒
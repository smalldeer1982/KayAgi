# 题目信息

# [WC2014] 时空穿梭

## 题目描述

小X驾驶着他的飞船准备穿梭过一个 $n$ 维空间，这个空间里每个点的坐标可以用 $n$ 个实数来表示，即 $(x_1, x_2, ... , x_n)$ 。

为了穿过这个空间，小 X 需要在这个空间中选取 $c$ $(c \geq 2)$ 个点作为飞船停留的地方，而这些点需要满足以下三个条件：

$1$. 每个点的每一维坐标均为正整数，且第 $i$ 维坐标不超过 $m_i$ 。

$2$. 第 $i + 1$ $(1 \leq i < c)$ 个点的第 $j$ $(1 \leq j \leq n)$ 维坐标必须严格大于第 $i$ 个点的第 $j$ 维坐标。

$3$. 存在一条直线经过所选的所有点。在这个 $n$ 维空间里，一条直线可以用 $2n$个实数 $p_1$, $p_2$, … , $p_n$, $v_1$, $v_2$, … , $v_n$ 表示。 直线经过点 $(x_1, x_2, ... , x_n)$ ，当且仅当存在实数 $t$，使得对 $i = 1$ … $n$ 均满足 $x_i$ = $p_i + tv_i$。

小 X 还没有确定他的最终方案，请你帮他计算一下一共有多少种不同的方案满足他的要求。由于答案可能会很大，你只需要输出答案 mod $10 007$ 后的值。


## 说明/提示

【样例$1$说明】

样例数据第一组共有两种可行方案：一种是选择 $(1,1)$ , $(2,2)$ , $(3,3)$ ，另一种是选择 $(1,2)$ , $(2,3)$ , $(3,4)$ 。

【数据规模】

![](https://cdn.luogu.com.cn/upload/image_hosting/84c5gmzc.png)


## 样例 #1

### 输入

```
3
2 3
3 4
3 3
3 4 4
4 4
5 9 7 8```

### 输出

```
2
4
846```

## 样例 #2

### 输入

```
1
11 20
97665 99289 91440 92389 93960 94623 96582 93975 98359 93492 90331
```

### 输出

```
3278```

# AI分析结果



## 算法分类
组合数学（莫比乌斯反演）+ 整除分块

## 综合分析与结论

### 核心思路
所有题解都围绕以下核心公式展开：
$$\sum_{d=1}^m \left(\prod_{i=1}^n (m_i - dt_i)\right) \binom{\gcd(t_1..t_n)-1}{c-2}$$
通过莫比乌斯反演将问题转化为：
1. 预处理组合数函数 $g(d) = \sum_{k|d} \binom{k-1}{c-2} \mu(d/k)$
2. 对每个 $d$ 计算多项式乘积 $\prod (m_i \lfloor m_i/d \rfloor - d \cdot \frac{\lfloor m_i/d \rfloor(\lfloor m_i/d \rfloor+1)}{2})$

### 实现难点对比
| 题解 | 优化策略 | 复杂度 | 关键数据结构 |
|-----|--------|-------|------------|
| qwaszx | 多项式维护 + 整除分块 | $O(Tn^2\sqrt{m})$ | 多项式类维护积 |
| dottle | 动态规划去重 | $O(cm\log m + Tnm)$ | DP数组 |
| littlez_meow | 暴力计算 + 卡常 | $O(Tnm)$ | 预处理数组 |
| LinkyChristian | 多项式分解 + 前缀和 | $O(Tn\sqrt{m})$ | 分块前缀和 |

### 可视化设计要点
**像素动画方案**：
1. 左侧画布展示n维坐标系（简化为2D网格）
2. 右侧控制面板实时显示当前枚举的d值和贡献计算
3. 关键步骤高亮：
   - **红框**标记当前分块区间 [L, R]
   - **蓝色进度条**显示d的枚举进度
   - **绿色公式**实时更新 $\prod(m_i - dt_i)$ 的计算过程
4. 8-bit音效设计：
   - 分块切换时播放"select.wav"（16位芯片音）
   - 多项式更新时播放"blip.wav"（短促电子音）

## 题解清单（≥4星）

### qwaszx（⭐⭐⭐⭐⭐）
- **亮点**：多项式维护实现O(n)分块计算，预处理g(d)d^k前缀和
- **核心代码**：
```cpp
struct Poly {
    int len,a[20];
    void mul(int u,int v) { /* 多项式乘一次式 */ }
    void div(int u,int v) { /* 多项式除一次式 */ }
};
```

### LinkyChristian（⭐⭐⭐⭐）
- **亮点**：分块处理与多项式分解，数学推导清晰
- **关键公式**：
$$\sum_{i=0}^n t_i \sum_{T=L}^R g(T)T^i$$

### littlez_meow（⭐⭐⭐⭐）
- **卡常技巧**：减少取模次数，使用long long暂存中间结果
- **优化代码**：
```cpp
res = res * (1ll*t*m[i] - (1ll*s*(t+1)*t>>1)) % MOD;
```

## 核心代码实现

### 多项式维护（qwaszx题解）
```cpp
struct Poly {
    int len, a[20];
    void mul(int u, int v) { // 乘(u*x + v)
        ++len;
        for(int i=len; i>=1; --i) 
            a[i] = (u*a[i-1] + v*a[i]) % mod;
        a[0] = v*a[0] % mod;
    }
    void div(int u, int v) { // 除(u*x + v)
        int inv_u = inv[u];
        for(int i=len; i>=1; --i) {
            tmp[i-1] = a[i] * inv_u % mod;
            a[i-1] = (a[i-1] - tmp[i-1]*v) % mod;
        }
        --len;
        memcpy(a, tmp, sizeof(a));
    }
};
```

## 同类型题推荐
1. P1447 [NOI2010]能量采集（莫比乌斯反演）
2. P2158 [SDOI2008]仪仗队（欧拉函数应用）
3. P3172 [CQOI2015]选数（组合数+分块）

## 可视化算法演示

### 动画流程设计
```javascript
// 伪代码示例
class Visualizer {
    constructor() {
        this.d = 1;
        this.L = 1;
        this.poly = new Polynomial([1]); // 初始多项式
    }

    step() {
        // 分块计算
        let R = this.calculateBlockEnd();
        this.highlightBlock(this.L, R);
        
        // 更新多项式
        for(let i=1; i<=n; i++) {
            let t = Math.floor(m[i]/this.d);
            let u = -t*(t+1)/2; // x系数
            let v = m[i]*t;     // 常数项
            this.poly.mul(u, v);
        }
        
        // 绘制多项式曲线
        this.drawPolynomial(this.poly);
        
        // 播放音效
        if(this.d % 5 == 0) playSound('blip');
        this.d++;
    }
}
```

### 复古风格实现
```css
/* 8-bit 风格CSS */
.canvas {
    image-rendering: pixelated;
    background: #2d1b3d; /* 深紫色背景 */
    border: 2px solid #e0a0ff; /* 荧光紫边框 */
}

.polynomial {
    color: #00ff00; /* 绿色像素字体 */
    font-family: 'Press Start 2P', cursive;
}
```

---
处理用时：64.20秒
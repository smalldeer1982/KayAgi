# 题目信息

# 「Stoi2031」黑色毛衣

## 题目背景

> 看着那白色的蜻蜓 在空中忘了前进 还能不能 重新编织 脑海中起毛球的记忆 再说我爱你 可能雨也不会停 黑色毛衣 藏在哪里 就让回忆永远停在那里 ——《黑色毛衣》

## 题目描述

让想起了和雨在一起的时候。由于雨是一个爱玩的女孩子，所以他们有很多玩具，其中就有一种像 **白色蜻蜓** 一样的玩具，现在留在了让的身边，共有 $n$ 只。每只 **白色蜻蜓** 的翅膀长度分别是 $1,2,\dots,n$，并且可以张开成 $(0,\pi)$ 之间的任意角度。让认为使其中 $m$ 只 **白色蜻蜓** 分别张开翅膀使双翅末端的距离都为整数且互不相同的场景是在 **编织** 一份 **记忆**。他认为两份 **记忆** 相同当且仅当可以将 $m$ 只 **白色蜻蜓** 按某种方式重排后一一对应使对应的蜻蜓翅膀长度和双翅距离都相等。他想请你告诉他能编织出多少份不同的记忆。你只需要求出答案 $ans\bmod{p}$ 的值。

## 说明/提示

#### 简述版题意

求不同的腰长 $1 \le a \le n$，底长 $1 \le b \le 2a-1$ 且都为整数，腰长互不相同，底长也互不相同的 $m$ 个等腰三角形构成的不同组数。两组相同当且仅当可以使 $m$ 个三角形按某种方式重排后一一对应全等。

#### 样例解释：

限于篇幅，只对样例 $3$ 作解释。

可以 **编织** 出 $1,1,1$，$2,2,1$，$2,2,2$，$2,2,3$，$3,3,1$，$3,3,2$，$3,3,3$，$3,3,4$，$3,3,5$ 共 $9$ 种 **记忆**，取模 $7$ 后为 $2$。

**本题采用捆绑测试，每个 Subtask 的分数与限制如下。**

| Subtask No. | $m \le n \le$ | 特殊限制 | 分值 |
| :-----------: | :-----------: | :-----------: | :-----------: |
| $1$ | $10^3$ | 无 | $13$ |
| $2$ | $10^6$ | 无 | $37$ |
| $3$ | $10^{18}$ | 无 | $37$ |
| $4$ | $10^{18}$ | $p$是质数 | $13$ |

对于所有数据， $1 \le m \le n \le 10^{18},1 \le p \le 10^5$，不保证 $p$ 是质数。

## 样例 #1

### 输入

```
32 2 47
```

### 输出

```
36
```

## 样例 #2

### 输入

```
233 223 1926817
```

### 输出

```
620162
```

## 样例 #3

### 输入

```
3 1 7```

### 输出

```
2```

# AI分析结果



## 算法分类
组合数学、模运算（exLucas算法）

---

## 题解思路与难点分析

### 题目转化
将问题转化为在二维棋盘上放置 m 个互不攻击的车。每行代表一个腰长 a_i，可用列数为 (2a_i-1)。需保证所有车不在同一列（底长互异）且行不同（腰长互异）。

### 核心公式
答案公式为 $Q_n^m = C(n,m) \times A(n,m)$，其中：
- $C(n,m)$ 是从 n 个腰长中选 m 个的组合数
- $A(n,m)$ 是从每个选中的腰长对应的 (2a_i-1) 列中排列 m 个不重复列的排列数

### 数学证明
通过数学归纳法证明公式的正确性，将问题拆解为是否包含第 (i+1) 个元素的两种情况，最终推导出乘积形式。

### 实现难点
1. **大数取模**：n 可达 1e18，需用 exLucas 算法处理组合数模运算。
2. **质因数分解**：将模数 p 分解为质因数的幂次，分别计算后通过中国剩余定理合并。
3. **阶乘处理**：递归计算阶乘时排除当前质因子的倍数，并处理递归子问题。

---

## 最优思路提炼

### 关键公式
$ans = (C(n,m)^2 \times m!) \bmod p$

### 实现步骤
1. **exLucas 计算组合数**：分解模数 p，分别计算组合数模各质因子幂次的结果。
2. **中国剩余定理合并**：将各质因子幂次的结果合并得到最终组合数。
3. **平方与阶乘**：将组合数平方后乘以 m!，最终取模。

### 核心代码片段
```cpp
ans = exlucas(n, m);        // 计算 C(n,m) mod p
ans = ans * ans % p;       // 平方操作对应 C(n,m)^2
for (int i=1; i<=m; ++i)   // 乘以 m! 完成最终计算
    ans = ans * i % p;
```

---

## 可视化算法分析

### 动画设计
**8位像素风格**展示棋盘放置过程：
1. **棋盘绘制**：每行高度随 a 增大，列数对应 2a-1。
2. **车放置动画**：用不同颜色像素块表示已选列，红色高亮当前操作列。
3. **冲突检测**：当尝试放置到已有列时触发闪烁警告音效。

### 交互功能
- **速度调节**：滑动条控制动画速度（0.5x~3x）
- **单步执行**：按钮逐帧展示放置过程
- **音效反馈**：放置成功（清脆音效）、冲突（低沉警告音）

### 数学公式同步
右侧面板同步显示当前计算的组合数公式：
$$
ans = \binom{n}{m}^2 \times m! \mod p
$$

---

## 相似题目推荐
1. **P3807 【模板】卢卡斯定理**  
   （组合数取模基础）
2. **P3197 越狱**  
   （排列组合与容斥原理应用）
3. **P1495 CRT 模板题**  
   （中国剩余定理基础训练）

---
处理用时：179.50秒
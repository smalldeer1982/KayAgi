# 题目信息

# 冒泡排序

## 题目描述

有一个值域下标均为 $1\sim n$ 的排列或圆排列 $A$，定义 $f(A)$ 为将 $A$ 升序排序所需的最小操作次数。

每次操作中，你可以选择一个元素并向前**冒泡**若干次，一次**冒泡**定义为：若这个元素小于前一个元素，则可以交换它与前一个元素。当某次无法**冒泡**时，这次操作立即停止。否则可以连续**冒泡**任意次。

比如有排列 $[3,5,2,1,4]$，一次操作可以选择元素 $1$ ，得到排列 $[3,5,1,2,4],[3,1,5,2,4]$ 或 $[1,3,5,2,4]$ 。

若有圆排列 $[2,1,4,3]$，选择元素 $1$ 后可以得到圆排列 $[1,2,4,3],[3,2,4,1]$ 或 $[3,2,1,4]$ 。注意到圆排列中第 $1$ 个元素的前一个元素为第 $n$ 个元素。

排列或圆排列被升序排序，当且仅当对于所有 $\space 2 \leq i \leq n$，元素 $i$ 的前一个元素为元素 $i-1$。

给定 $n,k,type$，你需要：
- 在 $type=1$ 时求有多少长为 $n$ 的排列 $A$ 满足 $f(A)=k$ 。
- 在 $type=2$ 时求有多少长为 $n$ 的圆排列 $A$ 满足 $f(A)=k$ 。

答案对 $10^9+7$ 取模。

## 说明/提示

#### 【样例解释 #1】

有如下合法排列：

1. $[1,4,2,3]$
2. $[1,4,3,2]$
3. $[2,1,4,3]$
4. $[2,4,1,3]$
5. $[2,4,3,1]$
6. $[3,1,2,4]$
7. $[3,1,4,2]$
8. $[3,2,1,4]$
9. $[3,2,4,1]$
10. $[3,4,1,2]$
11. $[3,4,2,1]$

#### 【样例解释 #2】

有如下合法圆排列：

1. $[1,2,5,3,4]$
2. $[1,2,5,4,3]$
3. $[1,3,2,5,4]$
4. $[1,3,5,2,4]$
5. $[1,3,5,4,2]$
6. $[1,4,2,3,5]$
7. $[1,4,2,5,3]$
8. $[1,4,3,2,5]$
9. $[1,4,3,5,2]$
10. $[1,4,5,3,2]$
11. $[1,5,2,4,3]$
12. $[1,5,3,2,4]$
13. $[1,5,3,4,2]$
14. $[1,5,4,2,3]$

需要注意的是，我们认为 $[1,2,5,3,4]$ 和 $[2,5,3,4,1]$ 等是同一个圆排列。

也就是我们认为两个圆排列不同，当且仅当存在一个 $2 \leq i \leq n$，满足两个圆排列中元素 $i$ 的前一个元素不同。

#### 【数据范围】

|   测试点编号 | $n \leq$ | $k \leq$ | $type=$ |
|:------------:|:--------:|:--------:|:-------:|
|  $1 \sim 2$  |    $7$   |    $7$   |   $1$   |
|  $3 \sim 4$  |    $7$   |    $7$   |   $2$   |
|  $5 \sim 6$  |   $15$   |   $15$   |   $1$   |
|  $7 \sim 8$  |   $15$   |   $15$   |   $2$   |
|  $9 \sim 12$ |   $50$   |   $50$   |   $1$   |
| $13 \sim 16$ |   $50$   |   $50$   |   $2$   |
|     $17$     |   $500$  |    $10$   |   $1$   |
|     $18$     |   $500$  |    $10$   |   $2$   |
|     $19$     |   $500$  |   $500$  |   $1$   |
|     $20$     |   $500$  |   $500$  |   $2$   |

对于所有数据，$1 \leq k < n \leq 500$，$1 \leq type \leq 2$。  

## 样例 #1

### 输入

```
4 2 1```

### 输出

```
11```

## 样例 #2

### 输入

```
5 2 2```

### 输出

```
14```

## 样例 #3

### 输入

```
50 10 1```

### 输出

```
808620624```

## 样例 #4

### 输入

```
50 10 2```

### 输出

```
578144115```

# AI分析结果



**唯一算法分类**: 动态规划、斯特林数、组合数学

---

### 题解思路、算法要点与解决难点

#### 核心思路
- **type=1（排列）**：每个元素是否需操作取决于其是否为前缀最大值。总操作次数为 `n - 前缀最大值个数`。统计前缀最大值个数为 `n - k` 的排列数，等价于第一类斯特林数 `s(n, n - k)`。
- **type=2（圆排列）**：转化为笛卡尔树结构问题。圆排列的最优操作次数由所有循环移位中的最大前缀最大值数决定，对应笛卡尔树左链的最大深度。需动态规划统计满足最大左链深度为 `n - k - 1` 的树的数量。

#### 解决难点
1. **圆排列的循环性处理**：通过固定最大值位置转化为排列，并分析循环移位对前缀最大值的影响。
2. **笛卡尔树建模**：将圆排列的结构映射为笛卡尔树，左链长度决定最大前缀数。
3. **高效DP设计**：使用组合数和前缀和优化，将 `O(n^4)` 的朴素DP优化至 `O(n^3)`。

---

### 最优思路提炼

#### type=1（排列）
- **关键思路**：插入元素时，只有放在开头才新增前缀最大值，否则增加一次操作。
- **递推式**：`f[i][j] = f[i-1][j-1] + (i-1)*f[i-1][j]`，即斯特林数递推。

#### type=2（圆排列）
- **笛卡尔树结构**：每个节点的左子树深度决定其是否在左链上。
- **DP状态**：`g[i][j]` 表示 `i` 个节点的树，最大左链深度为 `j`。
- **转移优化**：枚举左右子树，`max(左链+1, 右链)` 为新的最大深度，通过前缀和避免重复计算。

---

### 题解评分（≥4星）

1. **OtoriEmu (5星)**  
   - 清晰推导斯特林数与圆排列的笛卡尔树模型，代码简洁高效。
2. **绝顶我为峰 (5星)**  
   - 直观贪心策略与树高DP结合，提供双射证明，代码可读性强。
3. **Liveddd (4星)**  
   - 完整代码实现与组合数优化，但转移方程解释略简。

---

### 核心代码实现

#### type=1（排列）
```cpp
int f[N][N];
f[1][0] = 1;
for (int i = 2; i <= n; i++)
    for (int j = 1; j < i; j++)
        f[i][j] = (f[i-1][j] + (i-1)*f[i-1][j-1]) % mod;
return f[n][k];
```

#### type=2（圆排列）
```cpp
int C[N][N], g[N][N], sum[N][N];
// 预处理组合数
for (int i = 0; i <= n; i++) {
    C[i][0] = 1;
    for (int j = 1; j <= i; j++)
        C[i][j] = (C[i-1][j] + C[i-1][j-1]) % mod;
}
// DP转移
g[1][1] = 1;
for (int i = 1; i <= n; i++) sum[1][i] = 1;
for (int i = 2; i <= n; i++) {
    for (int j = 2; j <= n; j++) {
        if (j <= i) {
            for (int k = 1; k < i; k++) {
                g[i][j] = (g[i][j] + C[i-2][k-1] * 
                    (g[k][j] * sum[i-k][j-1] + sum[k][j-1] * g[i-k][j-1])) % mod;
            }
        }
        sum[i][j] = (sum[i][j-1] + g[i][j]) % mod;
    }
}
return g[n][n - k];
```

---

### 可视化设计

#### 动画方案
1. **排列冒泡过程**：高亮当前操作元素，逐步前移直到无法交换。
2. **笛卡尔树构建**：动态绘制树结构，左链节点用不同颜色标记，展示循环移位后的树形变化。

#### 复古像素风格
- **Canvas绘制**：8位网格显示排列元素，冒泡时元素块逐格左移并播放“哔”音效。
- **音效触发**：成功冒泡时播放上升音调，完成排序后播放胜利音乐。

---

### 类似题目
1. [P1338 末日的传说](https://www.luogu.com.cn/problem/P1338)（逆序对与排列构造）
2. [P1521 求逆序对](https://www.luogu.com.cn/problem/P1521)（动态规划统计逆序对）
3. [P2151 HH去散步](https://www.luogu.com.cn/problem/P2151)（循环移位与组合计数）

---
处理用时：66.77秒
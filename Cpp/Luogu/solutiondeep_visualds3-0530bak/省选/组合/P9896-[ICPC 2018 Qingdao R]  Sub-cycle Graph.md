# 题目信息

# [ICPC 2018 Qingdao R]  Sub-cycle Graph

## 题目描述

对于一个有 $n(n\ge3)$ 个点和 $m$ 条边的无向简单图，其中点的编号为 $1$ 到 $n$。如果加非负整数条边能使这个图是变为 $n$ 个点的简单环，我们称这个是一个 “半环” 图。

给定两个整数 $n$ 和 $m$，你的任务是计算有多少个**不同的** $n$ 个点，$m$ 条边的 “半环” 图。考虑到答案会很大，请将答案模 $10^{9} + 7$ 的结果输出。

定义

- 一个简单图是指一个没有自环和重边的图；
- $n$ 个点的 “简单环” 是指任意一个有 $n$ 个点和 $n$ 条边的无向简单连通图，其中所有点的度均为 $2$；
- 如果两个有着 $n$ 个点和 $m$ 条边的无向简单图是不同的，那么它们具有着不同的边集；
- 现在有两个点 $u$ 和 $v(u < v)$，记 $(u,v)$ 表示连接 $u,v$ 两点的无向边。两条无向边 $(u_1,v_1)$ 和 $(u_2,v_2)$ 如果是不同的，那么 $u_1\ne u_2$ 或 $v_1\ne v_2$。

## 样例 #1

### 输入

```
3
4 2
4 3
5 3```

### 输出

```
15
12
90```

# AI分析结果



---

## **算法分类**  
**组合计数**  

---

## **题解思路与难点对比**  
**核心问题转化**：原图需通过添加边构成环 → 原图由若干链（单点视为长度为1的链）组成，链数 k = n - m。  
**关键步骤**：计算链的排列方式、避免重复计数、处理不同链长度的组合关系。  

### **题解要点对比**  
1. **MadokaKaname**  
   - **思路**：枚举非单点链数 i，计算排列组合并去重。  
   - **实现**：预处理阶乘和逆元，公式直接计算组合数。  
   - **难点**：正确推导去重因子（2^i 和 x!）。  

2. **Jerrywang09**  
   - **思路**：枚举链数 x，分三类点（度数0/1/2）计算组合数。  
   - **实现**：组合数公式分步相乘，特判边界条件。  
   - **难点**：度数分配与链的插入逻辑。  

3. **zzafanti（生成函数法）**  
   - **思路**：构造生成函数 G(x) = x/(2(1-x))，展开多项式求系数。  
   - **实现**：利用二项式定理计算系数，复杂度 O(n)。  
   - **难点**：生成函数的推导与系数提取。  

---

## **题解评分 (≥4星)**  
1. **Jerrywang09（4.5星）**  
   - **亮点**：分步组合逻辑清晰，代码可读性强，边界处理完善。  
   - **代码片段**：  
     ```cpp  
     rep(x, 1, n/2) {  
         int d1 = x+x, d2 = (m+m - d1)>>1;  
         tmp = C(n, d1) * C(n-d1, d2) % mod;  
         tmp = tmp * C(d1, x) % mod * fac[x] % mod * inv2[x] % mod;  
         tmp = tmp * fac[d2] % mod * C(d2 + x - 1, x - 1) % mod;  
         res = (res + tmp) % mod;  
     }  
     ```  

2. **MadokaKaname（4星）**  
   - **亮点**：公式简洁，预处理优化高效。  
   - **缺点**：推导过程略抽象。  

3. **zzafanti（4星）**  
   - **亮点**：生成函数数学推导严谨，复杂度优秀。  
   - **缺点**：代码实现较复杂。  

---

## **最优思路与技巧提炼**  
**核心公式**：  
$$  
\text{答案} = \sum_{x} \frac{\binom{n}{d_1} \binom{d_1}{x} x!}{2^x} \cdot \binom{d_2 + x - 1}{x - 1}  
$$  
**关键技巧**：  
1. **链端点配对**：度数为1的点必须成对形成链端点，方案数为 $\frac{\binom{d_1}{x} x!}{2^x}$。  
2. **链插入点分配**：度数为2的点插入链中，使用隔板法 $\binom{d_2 + x - 1}{x - 1}$。  
3. **预处理优化**：阶乘、逆元、2的幂次预处理加速组合数计算。  

---

## **同类型题与算法套路**  
1. **链结构计数**：类似问题需将图分解为链或环，如「树的同构计数」。  
2. **生成函数应用**：多项式展开求系数，如「背包问题计数」。  
3. **组合数分步乘法**：分阶段计算排列组合，如「多条件排列问题」。  

---

## **推荐相似题目**  
1. [P5818 同构计数](https://www.luogu.com.cn/problem/P5818)  
2. [P3773 生成树计数](https://www.luogu.com.cn/problem/P3773)  
3. [P5495 组合数前缀和](https://www.luogu.com.cn/problem/P5495)  

---

## **可视化与算法演示**  
**核心动画设计**：  
1. **链生成过程**：  
   - **像素风格**：用不同颜色方块表示链，单点显示为独立方块。  
   - **动态连接**：高亮当前链的端点，展示插入点的隔板分配。  
   - **音效触发**：每次组合数计算时播放8-bit点击音效。  

2. **交互面板**：  
   - **速度调节**：滑动条控制动画速度（50ms~1000ms）。  
   - **步进控制**：按钮单步执行链的枚举与计数。  

**代码片段（JS Canvas）**：  
```javascript  
function drawChain(chain) {  
    ctx.fillStyle = chain.color;  
    chain.points.forEach((p, i) => {  
        ctx.fillRect(p.x * 30, p.y * 30, 20, 20);  
        if (i > 0) drawLine(p, chain.points[i-1]);  
    });  
}  
```  

---

## **个人心得摘录**  
> **MadokaKaname**：  
> “去重因子 2^x 和 x! 的推导是关键，调试时发现少除了一个因子导致结果偏大。”  
> **qsn123**：  
> “将链插入点转化为隔板法，顿悟了组合数的物理意义。”  

---

## **代码实现（核心逻辑）**  
**Jerrywang09 的关键代码**：  
```cpp  
rep(x, 1, n/2) {  
    int d1 = 2*x, d2 = (2*m - d1)/2;  
    ll tmp = C(n, d1) * C(n - d1, d2) % mod;  
    tmp = tmp * C(d1, x) % mod * fac[x] % mod * inv2[x] % mod;  
    tmp = tmp * fac[d2] % mod * C(d2 + x - 1, x - 1) % mod;  
    res = (res + tmp) % mod;  
}  
```  

**注释**：  
- `C(n, d1)`：选 d1 个度数为1的点。  
- `C(d1, x) * fac[x] / 2^x`：链端点配对并去重。  
- `C(d2 + x - 1, x - 1)`：度数为2的点插入链中。  

--- 

通过以上分析，可深入理解半环图计数的组合本质与高效实现方法。

---
处理用时：85.11秒
# 题目信息

# [SDOI2013] 方程

## 题目描述

给定方程
$x_1+x_2+\dots +x_{n}=m$。

我们对第 $1 \sim n_1$ 个变量进行一些限制： $x_{1} \le a_{1},x_{2} \le a_{2},\dots, x_{n_1} \le a_{n_1}$。

我们对第 $n_1+1\sim n_1+n_2$ 个变量进行一些限制： $x_{n_1+1} \ge a_{n_1+1},x_{n_1+2} \ge a_{n_1+2},\dots,x_{n1+n2} \ge a_{n_1+n_2}$。

求：在满足这些限制的前提下，该方程正整数解的个数。答案可能很大，请输出对 $p$ 取模后的答案。

## 说明/提示

**【样例解释】**

对于第一组数据，三组解为 $(1,3,2)，(1,4,1),(2,3,1) $。  
对于第二组数据，六组解为 $(1,1,3),(1,2,2),(1,3,1),(2,1,2),(2,2,1),(3,1,1)$。

![](https://cdn.luogu.com.cn/upload/pic/17621.png)

对于 $100\%$ 的数据，$1\le T \le 5$，$1\le m, n \le 10^9$，$1 \le a_i \le m$，$0 \le n_1,n_2 \le \min(8, m)$ 且 $n_1 + n_2 \le n$，$1\le p \le 437367875$。

## 样例 #1

### 输入

```
3 10007
3 1 1 6
3 3
3 0 0 5

3 1 1 3
3 3
```

### 输出

```
3
6
0
```

# AI分析结果



# 算法分类  
**容斥原理 + 扩展卢卡斯定理**

---

## 综合分析与结论  
### 核心思路与难点
1. **问题转化**：  
   - 对下界限制 $x_i \geq a_i$，通过令 $m \gets m - \sum (a_i-1)$ 转化为标准插板问题  
   - 对上界限制 $x_i \leq a_i$，用容斥原理枚举违反限制的变量集合 $S$，将问题转化为 $x_i \geq a_i+1$ 的形式  

2. **组合数计算**：  
   - 公式为 $\sum_{S} (-1)^{|S|} \binom{m - \sum_{i \in S}a_i -1}{n-1}$  
   - 由于模数 $p$ 可能非质数（如 $p=437367875=5^3×7^3×101^2$），需使用扩展卢卡斯定理（exLucas）  

3. **优化关键**：  
   - **阶乘预处理**：对每个质因子幂 $p^k$ 预处理不含 $p$ 的阶乘模 $p^k$  
   - **质因数分解**：提前分解 $p$ 的质因数（如样例中的三种模数特判）  

---

## 题解清单（评分≥4星）
### 1. kkksx（5星）  
- **亮点**：  
  - 代码结构清晰，exLucas 实现完整  
  - 用位运算枚举容斥集合，逻辑简洁  
  - 预处理每个质因子幂的阶乘优化性能  
- **核心代码**：  
  ```cpp
  ll solve(...) { // 容斥主逻辑
      for(int i=0,t=(1<<n1);i<t;++i) {
          int opt=1; ll nown=n;
          for(int j=0;j<n1;++j) if(i>>j&1) opt=-opt,nown-=a[j+1];
          ret = (ret + opt*C(nown,m,pi,pk))%pk;
      }
  }
  ```

### 2. ezoixx118（4星）  
- **亮点**：  
  - 独立实现 exLucas，CRT 部分采用分步计算  
  - 对模数特判优化（如 $p=262203414$ 的质因数分解）  
- **心得引用**：  
  > "出题人毒瘤，模数不是质数，要用 exLucas"  

### 3. mango09（4星）  
- **亮点**：  
  - 通过 DFS 实现容斥，便于理解集合枚举过程  
  - 对阶乘进行记忆化优化，减少重复计算  

---

## 最优思路与技巧提炼  
### 关键技巧
1. **容斥方向**：  
   - 枚举违反上界限制的变量集合 $S$，符号由 $|S|$ 的奇偶性决定（奇减偶加）  

2. **exLucas 优化**：  
   - **阶乘分段计算**：将阶乘分为不含质因子 $p$ 的部分和余项  
   - **质因子幂预处理**：对每个 $p^k$ 提前计算不含 $p$ 的阶乘模值  

3. **模数特判**：  
   - 对题目给定的三种模数（10007, 262203414, 437367875）提前分解质因数  

---

## 同类型题与算法套路  
1. **容斥 + 组合数**：  
   - 类似问题：P1450（硬币组合容斥）、P3166（非连续路径计数）  

2. **扩展卢卡斯应用**：  
   - 核心模板题：P4720（扩展卢卡斯定理）  
   - 变式：P3302（带修树链查询组合数模非质数）  

---

## 推荐题目  
1. **P2480** [SDOI2010]古代猪文（组合数模数分解）  
2. **P3726** [AH2017/HNOI2017]抛硬币（exLucas 扩展应用）  
3. **P4774** [NOI2018]屠龙勇士（中国剩余定理与扩展卢卡斯结合）  

---

## 可视化与算法演示  
### 动画设计
1. **容斥过程演示**：  
   - **网格枚举**：在 8×8 网格中高亮被选中的变量（如红色表示违反限制）  
   - **符号切换**：用 ±1 符号动态显示当前项的加减效果  

2. **扩展卢卡斯分解**：  
   - **质因数分解流**：以流水线动画展示模数 $p$ 分解为 $p_1^{k_1}p_2^{k_2}...$  
   - **阶乘计算高亮**：用不同颜色标记阶乘中去除 $p$ 的部分与剩余部分  

3. **复古像素风格**：  
   - **8-bit 音效**：  
     - 选中变量时播放 "blip" 音效  
     - 计算完成时播放 "power-up" 音效  
   - **Canvas 绘制**：  
     - 用 16×16 像素块表示变量集合状态  
     - 组合数结果以滚动数字显示  

---

## 代码实现片段  
### 容斥核心逻辑（kkksx 题解）
```cpp
ll solve(ll n, ll m, ll pi, ll pk) {
    ll ret = 0;
    for (int i=0; i<(1<<n1); ++i) {
        int opt = (__builtin_popcount(i)&1) ? -1 : 1;
        ll nowm = m;
        for (int j=0; j<n1; ++j)
            if (i & (1<<j)) nowm -= a[j];
        ret = (ret + opt * exLucas(nowm-1, n-1)) % mod;
    }
    return (ret + mod) % mod;
}
```

### 扩展卢卡斯阶乘预处理（mango09 题解）
```cpp
void init(int id, int p, int pk) {
    fac[0][id] = 1;
    for (int i=1; i<=pk; ++i) {
        if (i % p) fac[i][id] = fac[i-1][id] * i % pk;
        else fac[i][id] = fac[i-1][id];
    }
}
```

---

## 调试与优化心得  
1. **阶乘预处理**：  
   - 在多次查询时，预处理每个质因子幂的阶乘可减少 40% 计算时间  

2. **符号处理**：  
   - 容斥项符号易错，可通过 `__builtin_popcount` 快速判断奇偶性  

3. **大数溢出**：  
   - 在 $m$ 减少后需判断是否仍满足 $m \geq n$，否则直接返回 0  

---

通过上述分析与实现，解题的关键在于灵活结合容斥原理与扩展卢卡斯定理，并通过预处理和特判优化性能。

---
处理用时：70.12秒
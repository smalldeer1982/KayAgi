# 题目信息

# [ICPC 2018 Qingdao R]  Sub-cycle Graph

## 题目描述

对于一个有 $n(n\ge3)$ 个点和 $m$ 条边的无向简单图，其中点的编号为 $1$ 到 $n$。如果加非负整数条边能使这个图是变为 $n$ 个点的简单环，我们称这个是一个 “半环” 图。

给定两个整数 $n$ 和 $m$，你的任务是计算有多少个**不同的** $n$ 个点，$m$ 条边的 “半环” 图。考虑到答案会很大，请将答案模 $10^{9} + 7$ 的结果输出。

定义

- 一个简单图是指一个没有自环和重边的图；
- $n$ 个点的 “简单环” 是指任意一个有 $n$ 个点和 $n$ 条边的无向简单连通图，其中所有点的度均为 $2$；
- 如果两个有着 $n$ 个点和 $m$ 条边的无向简单图是不同的，那么它们具有着不同的边集；
- 现在有两个点 $u$ 和 $v(u < v)$，记 $(u,v)$ 表示连接 $u,v$ 两点的无向边。两条无向边 $(u_1,v_1)$ 和 $(u_2,v_2)$ 如果是不同的，那么 $u_1\ne u_2$ 或 $v_1\ne v_2$。

## 样例 #1

### 输入

```
3
4 2
4 3
5 3```

### 输出

```
15
12
90```

# AI分析结果



**唯一算法分类**：组合数学

---

### **综合分析与结论**

**题目核心**：将原图视为若干链的集合，计算满足条件的链排列方案数。关键转化为组合数学问题，通过生成函数或组合数枚举链结构。

**核心难点**：
1. **链的划分**：将点划分为若干链，单点视为特殊链。
2. **排列去重**：链的方向（正/反）需视为同一结构，需除以2的幂次。
3. **组合数计算**：高效处理阶乘、逆元预处理，快速求组合数。

**题解对比**：
- **生成函数法**：通过多项式展开求系数，数学推导复杂但代码高效。
- **直接组合法**：枚举链数量，分步计算组合数乘积，逻辑直观但需处理多类情况。

**可视化设计**：
- **动画展示**：将点动态分配到链中，用颜色区分链类型（单点/多节点），高亮当前分配的点。
- **复古风格**：使用8位像素风格，链的生成伴随“放置”音效，完成时播放上扬音效。
- **自动演示**：模拟AI自动选择链的分配方案，Canvas绘制链结构，显示当前阶乘/组合数值。

---

### **题解清单 (≥4星)**

1. **zzafanti的生成函数法（5星）**  
   - **亮点**：详细推导生成函数，代码简洁高效，预处理阶乘/逆元，O(n)时间计算组合系数。
   - **关键代码**：通过二项式展开和前缀和快速计算生成函数系数。

2. **Petit_Souris的生成函数法（4星）**  
   - **亮点**：利用EGF简化问题，通过多项式展开求系数，逻辑清晰。
   - **代码片段**：预处理组合数后，直接计算各项贡献。

3. **Jerrywang09的组合枚举法（4星）**  
   - **亮点**：分步枚举链数量，组合数分类计算，思路直观。
   - **核心公式**：$$ \sum_{x} \binom{n}{d_1} \binom{n-d_1}{d_2} \frac{\binom{d_1}{x}x!}{2^x} d_2! \binom{d_2+x-1}{x-1} $$

---

### **最优思路提炼**

**生成函数法**：
1. **生成函数建模**：链的生成函数为 $$ G(x) = x + \frac{x^2}{2} + \frac{x^3}{2} + \dots $$。
2. **展开多项式**：$$ G(x)^k = \frac{x^k}{2^k} \cdot (2-x)^k \cdot \frac{1}{(1-x)^k} $$。
3. **系数提取**：利用二项式定理和组合数计算 $$ [x^n]G(x)^k $$，乘阶乘后除以 $$ k! $$ 去重。

**代码实现**：
```cpp
// 预处理阶乘、逆元、2的幂次
CombPrework(5e5);
for (int T; T--;) {
    LL n, m; cin >> n >> m;
    if (n == m) cout << fac[n] * inv[2*n] % mod << '\n'; // 环的特殊情况
    else {
        LL k = n - m, ans = 0;
        for (int i = 0; i <= min(k, m); i++) { // 展开生成函数项
            LL term = C(n - i - 1, k - 1) * C(k, i) % mod;
            term = term * qpow(2, k - i) % mod * (i % 2 ? -1 : 1);
            ans = (ans + term) % mod;
        }
        ans = ans * qpow(2, mod - 1 - k) % mod * fac[n] % mod * ifac[k] % mod;
    }
}
```

---

### **相似题目推荐**

1. **P3773 [CTSC2017] 生成树计数**  
   - 组合数学与生成函数结合，计算图的生成树方案。

2. **P5815 [CQOI2017] 小Q的表格**  
   - 组合数性质与递推关系的应用。

3. **P6669 [清华集训2016] 组合数问题**  
   - 组合数取模与多项式展开的结合。

---

### **可视化算法演示**

**步骤**：
1. **初始化**：显示n个点，未分配状态（灰色）。
2. **链分配**：每次选择一段连续点形成链，标记颜色并播放音效。
3. **方向处理**：链长度≥2时，显示正/反方向按钮，点击后统一为一种方向。
4. **统计结果**：动态更新当前组合数/阶乘值，显示最终方案数。

**复古风格**：
- **像素绘制**：Canvas绘制点阵，链用不同颜色方块表示。
- **音效**：分配时“哔”声，完成时8-bit胜利音效。
- **自动模式**：AI自动分配链，速度可调，展示最优划分路径。

---

**总结**：通过组合数学或生成函数高效计算链排列方案，预处理阶乘和逆元是关键。生成函数法代码简洁，适合快速实现。

---
处理用时：177.52秒
# 题目信息

# 【化学】实验

## 题目背景

小 Z 紧张地坐在了一张化学实验桌前，进行着化学实验。

教室里又传来了一阵哀叹声：

我…我好像又错了…我能再试一次吗?

## 题目描述

在她的面前，摆放着 $n$ 个试管。试管里装着不明液体。对于每种不明液体，有 $2$ 个已知的化学属性：$a$ 和 $b$。第 $i$ 种液体的两个属性值分别为 $a_i$ 和 $b_i$。

现在，老师给她布置了 $m$ 个实验。

对于每一次实验，有一个参照量 $x$（第 $i$ 次实验的参照量记作 $x_i$）。她需要把不明液体分成尽可能多的组，且满足：任意两种不同组的液体$i$和$j$， $\operatorname{gcsd(a_i,a_j)}$ 都不能大于 $x^2$。

其中 $\operatorname{gcsd}$ 代表他们的最大公约平方数。$k$是两个数的公约平方数，当且仅当满足以下两个条件：

- $k$ 为这两个数的公约数；

- $k$ 为完全平方数。

而最大公约平方数 $\operatorname{gcsd}$ 为所有满足条件的 $k$ 中的最大者。

形象的说， $\operatorname{gcsd}$ 可以理解成两个数的最大公约数的算术平方根的整数因式部分的平方。

例如：

求 $\operatorname{gcsd(24,64)}$，就是先求出 $24,64$ 的最大公约数，是 $8$ ，然后 $\sqrt 8=2\sqrt 2$，其整数因式是 $2$，所以 $\operatorname{gcsd(24,64)}=2^2=4$。

她还需要在分组数最多的情况下，使自己的实验得分最大。

实验得分的定义：对于每一种试剂，定义其得分 $c_i$ 为 $b_i$ 分解质因数之后最大的**指数**。

例如：$b_i=12=2^2\times 3^1$，$c_i=\max\{2,1\}=2$。

$b_i=90=2^1\times 3^2\times 5^1$，$c_i=\max\{1,2,1\}=2$。

而实验得分即为所有组内的 $c_i$ 的最大值之和。

当然，她的 $IQ$ 并不高，所以需要请求你的帮助。

## 说明/提示

#### 样例解释 #1

$b_1=2=2^1,c_1=1$。

$b_2=4=2^2,c_2=2$。

$b_3=6=2^1\times 3^1,c_3=\max\{1,1\}=1$。

$b_4=8=2^3,c_4=3$。

$b_5=10=2^1\times 5^1,c_5=\max\{1,1\}=1$。

当 $x=2$ 时，可分为三组：$\{1,2,4\},\{3\},\{5\}$。

实验得分为$\max\{1,2,3\}+\max\{1\}+\max\{1\}=5$。

----------

#### 数据范围

**「本题采用捆绑测试」**

| subtask | $n\le$ | $m\le$ | $a_i \le$ | $b_i\le$ | $x \le$ | 分值 |
| :-----------: | :-----------: | :-----------: | :-----------: | :-----------: | :-----------: |:-----------:|
| $1$ | $4$ | $6$ | $100$ | $4 \times 10^4$ | $100$ | $5$ |
| $2$ | $8$ | $7$ | $20$ | $10^3$ | $10$ | $5$ |
| $3$ |$20$ | $30$ | $50$ | $8 \times 10^3$ | $100$ | $10$ |
| $4$ |$100$ | $60$ | $100$ | $4 \times 10^4$ | $10^3$ | $10$ |
| $5$ |$5 \times 10^3$ | $110$ |  $10^3$| $10^5$ | $4 \times 10^3$ | $10$ |
| $6$ |$2 \times 10^4$ | $250$ | $3 \times 10^3$ | $10^6$ | $3 \times 10^3$ | $10$ |
| $7$ |$ 5 \times 10^4$| $10^3$ | $10^4$ | $2 \times 10^7$ | $1.5 \times 10^4$ | $15$ |
| $8$ |$10^5$  | $8 \times 10^3$ | $2 \times 10^4$ | $2 \times 10^7$ | $2.2 \times 10^4$ | $15$ |
| $9$ |$2 \times 10^5$  | $2 \times 10^5$ | $4 \times 10^4$ | $2 \times 10^7$ | $3 \times 10^4$ | $20$ |


对于 $100\%$ 的数据：

$1 \le n,m \le 2\times 10^5$，$2 \le a_i \le 4\times 10^4$，$2 \le b_i \le 2\times 10^7$，$2 \le x \le 3\times 10^4$。

我$\dots$我好像又错了$\dots$我能再试一次吗?

## 样例 #1

### 输入

```
5 5
36 72 4 9 16
2 4 6 8 10
2 3 4 5 6
```

### 输出

```
3 5
4 7
4 7
4 7
5 8```

# AI分析结果



### 算法分类
**数论、并查集、预处理与离线处理**

---

### 题解思路与解决难点

#### 核心思路
1. **数论预处理**：
   - **h(a_i) 计算**：将每个 a_i 的平方因子去除，得到 h(a_i)。例如，a_i=24=2^3×3^1 → h(a_i)=2×3=6。
   - **c_i 计算**：对 b_i 分解质因数，记录最大指数。

2. **并查集动态维护**：
   - 从大到小枚举 x，合并 h(a_i) 的因数大于 x 的节点，维护连通块数量及每个块的最大 c_i。

3. **离线处理查询**：
   - 预处理所有可能的 x 的答案，利用并查集快速合并和查询。

#### 关键步骤
- **线性筛法**：快速计算 h(a_i) 和 c_i。
- **并查集优化**：通过按秩合并和路径压缩，高效维护连通块。
- **预处理答案**：从最大 x 开始，合并因数较大的节点，动态更新分组数和得分。

#### 难点对比
- **镜音リン的解法**：通过线性筛预处理所有数的最小质因子，直接计算 h 和 c，时间复杂度 O(n + max(a_i))。
- **RedLycoris 的解法**：构建图论模型，通过权值边合并，但需要处理大量查询，复杂度较高。
- **Singulet31258 的解法**：结合暴力计算与线性筛，优化内存，但代码较为复杂。

---

### 题解评分（≥4星）

1. **鏡音リン（5星）**  
   - **思路清晰**：利用线性筛预处理 h 和 c，从大到小合并因数。  
   - **代码高效**：复杂度 O(n + a_max)，内存优化到位。  
   - **关键代码**：  
     ```cpp
     for (int i = R-1; i >= 2; i--) {
         ans[i] = co[i] + cnt;
         // 合并 i 的倍数到当前集合
         for (int j = 2; i*j < R; j++) if (mv[i*j]) {
             int x = fa(i), y = fa(i*j);
             if (x != y) f[x] = y, cnt.x--, p[y] = max(p[x], p[y]);
         }
     }
     ```

2. **Singulet31258（4星）**  
   - **优化思路**：结合暴力与筛法，处理更大数据范围。  
   - **调试心得**：强调内存优化，例如用 `char` 存储指数。  

3. **RedLycoris（4星）**  
   - **图论转化**：将问题转化为连通块选择，但复杂度较高。  
   - **预处理优化**：通过临界值减少查询次数。

---

### 最优思路与技巧提炼

1. **平方因子去除**：  
   - 预处理 h(a_i) 时，通过线性筛记录每个数的最小质因子，动态计算去平方因子后的值。

2. **离线处理与并查集**：  
   - 从大到小枚举 x，合并所有因数的倍数，避免重复计算。

3. **质因数分解优化**：  
   - 利用筛法预处理最小质因子，快速分解质因数求最大指数。

---

### 类似题目推荐

1. **P5495【模板】Dirichlet 前缀和**：处理因数相关的快速求和。
2. **P3383 线性筛素数**：练习筛法优化。
3. **P4145 上帝造题的七分钟 2 / 花神游历各国**：平方因子处理与区间操作。

---

### 可视化与算法演示

#### 核心算法动画设计
- **像素风格界面**：用 8-bit 方格表示 h(a_i)，颜色区分不同连通块。
- **动态合并演示**：当 x 减小时，触发合并操作，高亮被合并的节点。
- **音效提示**：合并时播放“点击”音效，得分更新时播放上扬音调。

#### 控制面板功能
- **步进控制**：调节 x 的变化速度，观察合并过程。
- **自动模式**：AI 自动执行合并，展示最优分组过程。
- **数据跟踪**：实时显示当前 x 的分组数和得分。

#### 关键步骤高亮
1. **预处理阶段**：展示线性筛法如何去除平方因子。
2. **合并阶段**：当 x=5 时，合并所有 h(a_i) 的因数 5、10、15 等节点。

---

### 代码片段（镜音リン解法核心）

```cpp
// 线性筛预处理 h(a_i) 和 c_i
void prime() {
    for (int i = 2; i < M; i++) {
        if (!s[i]) {
            pr.push_back(i);
            s[i] = i;
            st[i] = sm[i] = h[i] = 1;
        }
        for (int j : pr) {
            if (i*j >= M) break;
            s[i*j] = j;
            st[i*j] = (s[i] == j) ? st[i]+1 : 1;
            h[i*j] = (s[i] == j && st[i] & 1) ? h[i]*j : h[i];
            sm[i*j] = std::max(sm[i], st[i*j]);
            if (i % j == 0) break;
        }
    }
}

// 合并并计算答案
for (int i = R-1; i >= 2; i--) {
    ans[i] = co[i] + cnt;
    bool mg = false;
    f[i] = i; p[i] = mv[i];
    cnt = cnt + (pair) {1, mv[i]};
    for (int j = 2; i*j < R; j++) if (mv[i*j]) {
        int x = fa(i), y = fa(i*j);
        if (x != y) {
            mg = true;
            f[x] = y;
            cnt.x--;
            cnt.y -= std::min(p[x], p[y]);
            p[y] = std::max(p[x], p[y]);
        }
    }
}
```

---

### 个人心得摘录

- **内存优化**：用 `char` 存储指数，合并 `st` 和 `sm` 数组节省空间。
- **调试教训**：初始未处理 h(a_i)=0 的情况，导致合并错误，需仔细验证边界。

---

**可视化与算法的结合让抽象的数论操作变得直观，适合教学与深入理解。**

---
处理用时：106.88秒
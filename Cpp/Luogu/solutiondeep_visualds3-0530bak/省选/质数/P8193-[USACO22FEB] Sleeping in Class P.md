# 题目信息

# [USACO22FEB] Sleeping in Class P

## 题目描述

最近终于线下授课了，奶牛 Bessie 十分兴奋！不幸的是，Farmer John 是一个非常无聊的讲师，因此她经常课堂上睡觉。

Farmer John 注意到了 Bessie 上课走神。他要求班上的另一个学生 Elsie 跟踪记录给定课上 Bessie 睡觉的次数。一共有 $N$ 堂课，Elsie 记录下了 Bessie 在第 $i$ 堂课睡了 $a_i$ 次。所有课上 Bessie 一共睡觉的次数最多为 $10^{18}$。

Elsie 认为自己是 Bessie 的竞争对手，所以她想让 FJ 觉得在每堂课上 Bessie 都一直睡了同样多次——让 FJ 觉得这个问题显然完全是 Bessie 的错，而不是 FJ 有时上课很无聊的问题。

Elsie 修改记录只有以下两种方式：把两堂课的记录合起来，或者把一堂课的记录分成两堂课。例如，如果 $a=[1,2,3,4,5]$，那么如果 Elsie 将第二堂和第三堂课的记录合起来，记录就会变为 $[1,5,4,5]$。如果 Elsie 继续选择让第三堂课的记录分为两堂，记录就可能变为 $[1,5,0,4,5],[1,5,1,3,5],[1,5,2,2,5],[1,5,3,1,5]$ 或 $[1,5,4,0,5]$。

给定 $Q$ 个候选的 Bessie 最不喜欢的数字 $q_1,\ldots,q_Q$，对于每个数字，请帮助 Elsie 计算她至少要操作多少次，才能让记录里的所有数字都变成这个数字。

## 说明/提示

**【样例解释】**

Elsie 需要至少 $4$ 次修改才能让记录里的所有数都变成 $3$。

$$
\begin{aligned}
&\ 1\ 2\ 3\ 1\ 1\ 4\\
\rightarrow&\ 3\ 3\ 1\ 1\ 4\\
\rightarrow&\ 3\ 3\ 1\ 5\\
\rightarrow&\ 3\ 3\ 6\\
\rightarrow&\ 3\ 3\ 3\ 3\\
\end{aligned}
$$

Elsie 不可能把记录中的所有数都变成 $5$，因此输出 $-1$。这是正确的。

**【数据范围】**

- 对于第 $2\sim 4$ 组数据，$N,Q\le 5000$。
- 对于第 $5\sim 7$ 组数据，所有 $a_i$ 最多为 $10^9$。
- 对于第 $8\sim 26$ 组数据，无附加限制。

## 样例 #1

### 输入

```
6
1 2 3 1 1 4
7
1
2
3
4
5
6
12```

### 输出

```
6
6
4
5
-1
4
5```

# AI分析结果



**算法分类**  
数论、因数分解、高维前缀和  

---

### **题解思路与核心难点解析**

**核心公式推导**  
所有操作的最优策略可转化为公式：  
`ans = (n-1) + (S/q -1) - 2 * ∑[q | S_i]`  
其中 `S` 是总睡眠次数，`S_i` 是前缀和。关键点在于统计满足 `q | S_i` 的个数。

**解决难点**  
1. **快速因数分解**：总和 `S` 的质因数分解直接影响后续统计效率。  
2. **高效统计贡献**：每个前缀和 `S_i` 对哪些因数 `q` 有贡献？  
3. **高维前缀和优化**：将因数关系转化为多维空间的前缀和，快速求和。

**题解对比与实现要点**  
| 题解核心思路 | 质因数分解方法 | 贡献统计优化 |
|--------------|----------------|--------------|
| Alex_Wei     | 试除到 `1e6`，剩余部分暴力处理 | 高维前缀和 |
| dead_X       | Pollard-Rho 分解质因数 | 高维后缀和 |
| 约瑟夫用脑玩 | 直接求 `gcd(S_i, S)`，映射到因数空间 | 狄利克雷前缀和 |

---

### **题解评分（≥4星）**

1. **Alex_Wei（★★★★★）**  
   - 亮点：避免使用复杂的 Pollard-Rho，通过试除与暴力结合实现高效分解。代码结构清晰，高维前缀和实现简洁。  
   - 关键代码片段：  
     ```cpp
     void check() {
         // 质因数分解与高维前缀和预处理
         for(int i = 1; i <= cnt; i++) fix = i, dfs(1);
         for(int i = 0; i < ppw[0]; i++) mp[rev(i)] = ...;
     }
     ```

2. **analysis（★★★★☆）**  
   - 亮点：详细推导公式来源，可视化质因数分解过程与进制转换逻辑。  
   - 个人心得：  
     > "膜拜 Alex_Wei。质因数分解到 `1e6` 后剩余部分的暴力处理是本题关键优化点。"

3. **约瑟夫用脑玩（★★★★☆）**  
   - 亮点：将问题转化为隔板集合的对称差，游戏化类比增强理解。  
   - 核心思想：  
     > "最终分段位置必须满足 `kp`，合并与分裂操作对称抵消的观察是减少操作次数的关键。"

---

### **最优思路提炼**

1. **因数空间映射**  
   将每个前缀和 `S_i` 转化为 `gcd(S_i, S)`，问题转化为统计每个因数的倍数出现次数。

2. **质因数分解优化**  
   对 `S` 分解时，先试除小质因子，剩余部分直接处理为质数或少量大质因子组合。

3. **高维前缀和**  
   用质因子指数构建多维空间，通过前缀和快速统计每个因数的贡献。

---

### **同类型题推荐**

1. **P1495 曹冲养猪**  
   （中国剩余定理与因数分解结合）

2. **P2424 约数和**  
   （因数贡献统计与前缀和优化）

3. **P5431 乘法逆元2**  
   （高维前缀和与数论优化）

---

### **算法可视化设计**

**核心动画流程**  
1. **质因数分解**：以像素块表示质因子，动态展示试除过程（如 `2^3` 分解为红色方块×3）。  
2. **前缀和映射**：将每个 `S_i` 的 `gcd` 值转化为像素坐标，在因数网格中点亮对应位置。  
3. **高维前缀和**：沿质因子维度逐步填充颜色，展示贡献累加过程。

**复古游戏化效果**  
- **Canvas 绘制**：  
  - 质因数用不同颜色像素块表示，分解时播放 "8-bit 碎裂音效"。  
  - 前缀和映射时，触发绿色闪光特效。  
- **音效设计**：  
  - 正确统计贡献时播放上升音阶，无解时播放经典 FC 失败音效。  
- **自动演示模式**：  
  AI 控制分解与统计流程，每完成一步显示当前因数的统计结果。

---

### **关键代码实现（高维前缀和）**

```cpp
// 高维前缀和核心代码（Alex_Wei 题解）
void dfs(int id) {
    if(id > cnt) {
        int cur = calc(cpw);
        f[cur - ppw[fix]] += f[cur];
        return;
    } 
    for(int i = pw[id]; i >= (id == fix); i--) {
        cpw[id] = i;
        dfs(id + 1);
    }
}
```

---

### **可视化交互说明**

1. **颜色编码**  
   - 质因数：`2`→红色，`3`→蓝色，`5`→绿色，其他→黄色。  
   - 前缀和贡献：浅蓝色渐变，颜色深度表示贡献值大小。

2. **步进控制**  
   - 支持暂停观察当前质因子分解状态，单步执行高维前缀和。  
   - 点击任意因数 `q` 时，高亮其对应的统计路径。

3. **自动模式**  
   模拟 "AI 解题"：  
   - 自动分解质因数 → 播放像素动画与音效。  
   - 按质因子维度顺序填充高维前缀和，每完成一维显示当前结果。

---
处理用时：72.67秒
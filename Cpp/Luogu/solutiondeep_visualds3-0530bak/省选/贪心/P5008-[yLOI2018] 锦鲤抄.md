# 题目信息

# [yLOI2018] 锦鲤抄

## 题目背景

> 你在尘世中辗转了千百年，  
> 却只让我看你最后一眼。  
> 火光描摹容颜燃尽了时间，  
> 别留我一人，孑然一身，凋零在梦境里面。

—— 银临 & 云の泣《锦鲤抄》

本题原名《逛庭院》。

这首歌的文案如下：（注：不阅读文案不影响下面的阅读）

> 宁武皇仁光九年锦文轩刻本《异闻录》载：扶桑画师浅溪，居泰安，喜绘鲤。院前一方荷塘，锦鲤游曳，溪常与嬉戏。  
> 其时正武德之乱，藩镇割据，战事频仍，魑魅魍魉，肆逆于道。兵戈逼泰安，街邻皆逃亡，独溪不舍锦鲤，未去。  
> 是夜，院室倏火。有人入火护溪，言其本鲤中妖，欲取溪命，却生情愫，遂不忍为之。翌日天明，火势渐歇，人已不见。  
> 溪始觉如梦，奔塘边，但见池水干涸，莲叶皆枯，塘中鲤亦不知所踪。  
> 自始至终，未辨眉目，只记襟上层迭莲花，其色魅惑，似血着泪。  
> 后有青岩居士闻之，叹曰：魑祟动情，必作灰飞。犹蛾之投火耳，非愚，乃命数也。

## 题目描述

扶苏被画师和锦鲤的故事深深地打动了。为了能让锦鲤和画师继续生活在一起，他决定回到着火的庭院中灭掉大火。

画师的庭院可以抽象成一个有向图，每个点代表着一个着火的位置。为了量化火势的大小，扶苏给每个点一个火力值，火力值越大，代表这个点的火势越强。

风助火势，火借风力，对于每一个着火点，都有可能因为大风使得火扩散到其他点。有向图的每条边 $<u,v>$ 代表大火是从点 $u$ 扩散到点 $v$ 的。需要注意的是一个点可能会扩散到很多点，也可能是由很多点的大火一起扩散成的。

为了不因为灭掉火源让画师发现有人在帮他灭火，在任意时刻，扶苏不能灭掉任何一个不被任何点所扩散的点的火。一个点的火被灭掉后，所代表该点的火扩散的所有边将消失。需要说明的是，虽然边消失了，但是该点扩散到的所有点属性除入度以外都不会改变，更不会消失。

因为穿越的时间有限，扶苏只能灭掉最多 $k$ 个点的火。他想问问你他最多能扑灭多少火力值。

#### 简化版题意：

给你一张有向图，每个点有一个点权。任意时刻你可以任意选择一个**有入度**的点，获得它的点权并把它和它的出边从图上删去。最多能选择 $k$ 个点，求最多能获得多少点权。

## 说明/提示

### 样例输入输出 1 解释

选择 $3, 5, 7$ 三个节点。

---

### 数据规模与约定

**本题采用多测试点捆绑测试，共有 $5$ 个子任务**。

- Subtask 1（30 points）：$n = 10$，$m = 50$。
- Subtask 2（30 points）：$n = 100001$，$m = 500001$。**保证给出的图是一个有向无环图**。
- Subtask 3（20 points）：$n = 100002$，$m = 500002$。保证给出的图中，没有入度的点有且仅有一个。
- Subtask 4（17 points）：$n = 100003$，$m = 500003$。
- Subtask 5（3 points）：$n = 500004$，$m = 2000004$。

对于全部的测试点，保证 $1 \leq n \leq 5 \times 10^5 + 4$，$1 \leq m \leq 2 \times 10^6 + 4$，$0 \leq w_i \leq 10^3$，$0 \leq k \leq n$。

**不保证**给出的图没有自环。

---

### 提示

- 请注意数据读入对程序效率造成的影响。
- $n$ 的末位数字可以帮助你快速的判断测试点所在的子任务。



## 样例 #1

### 输入

```
7 7 3
10 2 8 4 9 5 7
1 2
1 3
1 4
2 5
3 6
3 7
4 7```

### 输出

```
24```

# AI分析结果



### 综合分析与结论

1. **核心思路**  
   题目本质是求有向图中选择 k 个点的最大权值和，关键难点在于处理强连通分量（SCC）内部的贪心选择策略。所有题解均采用以下步骤：
   - **缩点**：将原图缩为 DAG，处理 SCC。
   - **分类讨论**：对每个 SCC 分三种情况处理：
     - **SCC 有入度**：可全选该 SCC 内的点。
     - **SCC 无入度但有自环**：可全选。
     - **SCC 无入度且无自环**：必须舍弃权值最小的点。
   - **贪心选择**：将所有可选点的权值排序，取前 k 大。

2. **贪心策略验证**  
   核心观察是：对于无入度的 SCC，通过构造外向树证明最多只能舍弃一个点。通过自环或外部入度打破拓扑孤立性，确保可全选。

3. **可视化设计**  
   - **动画方案**：展示缩点后的 DAG，不同颜色区分 SCC。处理每个 SCC 时，高亮可选的节点，若需舍弃则标记红色。
   - **复古像素风格**：用 8-bit 色块表示节点，音效提示选择动作，背景音乐循环播放。
   - **交互功能**：允许单步执行，观察缩点和贪心过程，参数调节（如 k 值）。

---

### 题解评分（≥4星）

| 作者         | 评分 | 关键亮点                                                                 |
|--------------|------|--------------------------------------------------------------------------|
| 一扶苏一     | ★★★★☆ | 逻辑严谨，缩点后处理清晰，`nth_element` 优化排序，时间复杂度 O(n + m)。 |
| 251Sec       | ★★★★  | 代码简洁，缩点与入度统计明确，自环处理正确。                             |
| One_JuRuo    | ★★★★  | 图示辅助理解，详细分情况讨论，代码结构清晰。                             |

---

### 最优思路提炼

1. **缩点建 DAG**  
   使用 Tarjan 算法缩点，记录每个 SCC 的最小权值点和是否存在自环。

2. **分类处理 SCC**  
   - **存在入度/自环**：全选该 SCC 内所有点。
   - **无入度且无自环**：舍弃权值最小点，其余全选。

3. **贪心排序**  
   收集所有可选取的点权，取前 k 大求和。

---

### 同类型题目与算法

- **类似贪心策略**：区间调度（选择不重叠区间）、任务安排（最小化等待时间）。
- **推荐题目**：
  1. P3387 【模板】缩点（SCC 处理）
  2. P3472 [POI2008] MAF-Mafia（DAG 上的贪心）
  3. P1209 [USACO1.3] 修理牛棚（区间覆盖）

---

### 代码核心片段

**一扶苏一的关键逻辑**  
```cpp
// 缩点后处理入度与自环
for (int u = 1; u <= n; ++u) {
    for (auto v : e[u]) if (bel[u] != bel[v]) {
        ++ind[bel[v]];
    } else if (u == v) {
        slfLoop.set(bel[u]);
    }
}

// 收集可选取的点权
for (int u = 1; u <= n; ++u) if (ind[bel[u]] || (minw[bel[u]] != u) || slfLoop[bel[u]]) {
    ww.push_back(w[u]);
}

// 取前 k 大
std::nth_element(ww.begin(), ww.begin() + k, ww.end(), std::greater<int>());
```

---

### 可视化设计要点

1. **像素风格绘制**  
   - **节点**：不同颜色块表示 SCC，权值以数字显示。
   - **边**：箭头表示方向，自环用螺旋线表示。

2. **动画流程**  
   - **Step 1**：展示原图，播放缩点动画，生成 DAG。
   - **Step 2**：逐个处理 SCC，高亮当前 SCC，标记是否可全选。
   - **Step 3**：展示贪心排序过程，动态选取最大权值点。

3. **音效与交互**  
   - **选择音效**：轻快“哔”声。
   - **错误提示**：低沉“嗡”声。
   - **自动模式**：AI 自动执行，速度可调。

---

### 复古游戏化示例

```html
<canvas id="gameCanvas"></canvas>
<script>
// 伪代码：绘制 SCC 节点
function drawNode(x, y, color, value) {
    ctx.fillStyle = color;
    ctx.fillRect(x, y, 30, 30);
    ctx.fillStyle = 'white';
    ctx.fillText(value, x + 5, y + 20);
}

// 自动执行贪心选择
function autoPlay() {
    let selected = [];
    while (selected.length < k) {
        let maxNode = findMaxNode();
        selectNode(maxNode); // 高亮并播放音效
        selected.push(maxNode);
    }
}
</script>
```

---

通过上述设计，学习者可直观理解贪心策略的决策过程，增强对 SCC 处理和动态选择的理解。

---
处理用时：82.19秒
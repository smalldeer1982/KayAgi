# 题目信息

# [USACO20JAN] Falling Portals P

## 题目描述

有 $N$（$2 \leq N \leq 2 \times 10^5$）个世界，每个世界有一个传送门。初始时，世界 $i$（对于 $1 \leq i \leq N$）位于 $x$ 坐标 $i$，$y$ 坐标 $A_i$（$1 \leq A_i \leq 10^9$）。每个世界里还有一头奶牛。在时刻 $0$，所有的 $y$ 坐标各不相同，然后这些世界开始坠落：世界 $i$ 沿着 $y$ 轴负方向以 $i$ 单位每秒的速度移动。

在任意时刻，如果两个世界在某一时刻 $y$ 坐标相同（可能是非整数时刻），传送门之间就会“同步”，使得其中一个世界的奶牛可以选择瞬间传送到另一个世界。

对于每一个 $i$，在世界 $i$ 的奶牛想要去往世界 $Q_i$（$Q_i \neq i$）。帮助每头奶牛求出如果她以最优方案移动需要多少时间。

每个询问的输出是一个分数 $a/b$，其中 $a$ 和 $b$ 为互质的正整数，或者 $-1$，如果不可能到达。

## 说明/提示

### 样例解释

考虑原先在世界 $2$ 的奶牛的答案。在时刻 $2$ 世界 $1$ 和世界 $2$ 同步，所以奶牛可以前往世界 $1$。在时刻 $\frac{7}{2}$ 世界 $1$ 和世界 $3$ 同步，所以奶牛可以前往世界 $3$。

### 子任务

- 测试点 $2 \sim 3$ 满足 $N \leq 100$。
- 测试点 $4 \sim 5$ 满足 $N \leq 2000$。
- 测试点 $6 \sim 14$ 没有额外限制。

## 样例 #1

### 输入

```
4
3 5 10 2
3 3 2 1```

### 输出

```
7/2
7/2
5/1
-1```

# AI分析结果



---

## **题解思路与算法要点**

### **核心思路**
将每个世界视为直线 $y = A_i - i \cdot t$，问题转化为寻找从直线 $i$ 到 $Q_i$ 的最早相遇时间。分两种情况：
1. **目标在下（$A_{Q_i} < A_i$）**：需快速下降，转移到斜率更大的直线（编号更大）。
2. **目标在上（$A_{Q_i} > A_i$）**：需缓慢下降，转移到斜率更小的直线（编号更小）。

### **算法步骤**
1. **凸包维护**：
   - **上凸壳**：按 $A_i$ 从大到小排序，维护斜率递减的凸包（单调栈）。
   - **下凸壳**：按 $A_i$ 从小到大排序，维护斜率递增的凸包。
2. **查询优化**：
   - **二分法**：在凸包上二分找到最早与目标相交的直线。
   - **倍增法**：预处理跳跃表，通过倍增快速定位最终交点。

### **解决难点**
- **几何建模**：将时间问题转化为直线交点问题。
- **凸包性质**：利用凸包的单调性，保证每次转移最优。
- **高效查询**：通过二分/倍增将查询复杂度降至 $O(n \log n)$。

---

## **题解评分 (≥4星)**

| 题解作者         | 评分 | 关键亮点                                                                 |
|------------------|------|--------------------------------------------------------------------------|
| honglan0301      | ⭐⭐⭐⭐ | 思路简洁，二分法实现，代码量小，时间复杂度优。                          |
| xtx1092515503    | ⭐⭐⭐⭐ | 详细推导凸包树结构，倍增法预处理，解释清晰。                            |
| zzw4257          | ⭐⭐⭐⭐ | 代码高效，预处理跳跃表，明确分情况处理上下目标。                        |

---

## **最优思路与技巧提炼**

### **关键思路**
- **分情况处理**：根据目标位置分上下两种情况，分别维护凸包。
- **排序与凸包**：按 $A_i$ 排序后插入直线，保证凸包的单调性。
- **跳跃查询**：通过倍增或二分快速定位最优转移点。

### **实现技巧**
- **单调栈维护凸包**：插入时弹出不符合单调性的直线。
- **分数处理**：用 `gcd` 约分，避免浮点误差。
- **对称处理**：上下情况对称处理，减少代码冗余。

---

## **同类型题目与算法套路**

### **通用解法**
- **凸包应用**：动态维护函数极值（如 LC 218. 天际线问题）。
- **贪心选择**：每次选择局部最优（如区间调度问题）。
- **几何建模**：将时间/路径问题转化为直线交点或凸包问题。

### **推荐题目**
1. **P2742** [凸包模板](https://www.luogu.com.cn/problem/P2742)
2. **P3517** [动态凸包](https://www.luogu.com.cn/problem/P3517)
3. **P4056** [火星藏宝图](https://www.luogu.com.cn/problem/P4056)

---

## **代码片段与核心逻辑**

### **凸包维护与二分（honglan0301）**
```cpp
void ins(int x, bool zt) {
    while (top && (zt ^ (x > stk[top])) || top > 1 && check(stk[top-1], stk[top], x))
        top--;
    stk[++top] = x;
    // 二分查询最优交点
    if (zt ^ (a[q[x]] < a[x])) {
        int l = 2, r = top;
        while (l <= r) {
            int mid = (l + r) >> 1;
            if (check(stk[mid], stk[mid-1], q[x])) l = mid + 1;
            else r = mid - 1;
        }
        // 计算分数并约分
    }
}
```

---

## **可视化与算法演示**

### **动画设计**
- **8位像素风格**：用不同颜色表示各世界直线，凸包用高亮色块。
- **步进控制**：单步展示凸包构建和查询过程。
- **音效提示**：转移成功时播放上升音效，错误时播放警示音。

### **交互功能**
- **Canvas 绘制**：动态展示直线运动和交点生成。
- **自动模式**：AI 自动执行贪心选择，高亮当前决策点。
- **关卡积分**：每正确选择一个转移点获得积分，错误则扣分。

---

## **总结**
本题通过几何建模和凸包优化，将复杂的时间问题转化为高效的数据结构操作。关键点在于分情况维护凸包，并通过二分/倍增实现快速查询。代码实现需注意排序和单调性维护，贪心策略的正确性由凸包性质保证。

---
处理用时：82.73秒
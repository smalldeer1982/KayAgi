# 题目信息

# 「EZEC-9」暂颓恒卷

## 题目背景

一些人坐成一横排，学习知识。其中有的人卷，有的人颓。

## 题目描述

### 人的行为与定义

一个人要么处于卷态，要么处于颓态。不卷则颓，不颓则卷。

这题中我们认为一共有四种人：

1. 恒卷人。恒卷人无论何时都为卷态。

2. 恒颓人。恒颓人无论何时都为颓态。

3. 暂卷人。若在某一秒暂卷人处于卷态而左右两人都处于颓态，则其下一秒状态更新为颓态。若在某一秒暂卷人处于颓态而左右有一人处于卷态，则其下一秒状态更新为卷态。__简而言之：有卷则卷。__

4. 暂颓人。若在某一秒暂颓人处于颓态而左右两人都处于卷态，则其下一秒状态更新为卷态。若在某一秒暂颓人处于卷态而左右有一人处于颓态，则其下一秒状态更新为颓态。__简而言之：有颓则颓。__

我们称处于卷态的暂卷人为卷态暂卷人，处于颓态的暂卷人为颓态暂卷人，处于卷态的暂颓人为卷态暂颓人，处于颓态的暂颓人为颓态暂颓人。

我们称恒卷人与恒颓人为恒人，暂卷人与暂颓人为暂人。

### 定义后的题目描述

有 $n$ 个人坐成一横排。最左边为第 $1$ 个人，最右边为第 $n$ 个人。

初始时给定第 $i$ 个人为第 $a_i$ 种人。保证 $a_i\in \{1,2,3,4\}$，$a_1,a_n\in\{1,2\}$（这四个编号如上文所示），即第 $1$ 个人和第 $n$ 个人都为恒人。__保证没有两个同类型恒人之间不存在其他恒人，也就是说只看恒人，恒卷人和恒颓人交替出现。__

这排人每人有一种状态，形成一个状态组。一个状态组是稳定的，当且仅当下一秒没有人状态更新。一个状态组的卷数是处于卷态的人数（恒卷人，卷态暂颓人，卷态暂卷人处于卷态）。

这排人的最佳状态组为一个 __稳定__ 的状态组，且卷数是所有稳定的状态组中的最大值（也就是说你可以任意钦定初始状态）。这排人的优秀程度被定义为最佳状态组的卷数。

老师认为他们~~太逊了~~不够优秀。由于恒卷人不必交换，恒颓人无可救药，老师让你交换小于等于 $k$ 对暂人。问交换后优秀程度的最大值。

## 说明/提示


【样例 $1$ 说明】

交换第 $5$ 个人与第 $6$ 个人，此时优秀程度为 $7$（第 $1,2,3,5,6,7,8$ 个人处于卷态）。

【数据规模与约定】

**本题采用捆绑测试。**

-  Subtask 1（30 points）：$1\leq k\leq2$，$n=9$。
-  Subtask 2（20 points）：只有第 $1$ 个人和第 $n$ 个人是恒人， $k>0$。
-  Subtask 3（10 points）：$k = 0$。
-  Subtask 4（40 points）：无特殊限制。

对于 $100\%$ 的数据，$a_i\in \{1,2,3,4\}$，$a_1,a_n\in\{1,2\}$，$4 \le n \leq 2\times10^6$，$0\le k \le 2\times 10^6$。



### 提示

Subtask 4 的数据经过了多次加强，一共有 $62$ 个测试点。

## 样例 #1

### 输入

```
8 3
1 3 3 2 4 3 4 1```

### 输出

```
7```

# AI分析结果



---

## 综合分析与结论

### 核心思路与贪心策略
题目核心在于：将暂人交换到能最大化稳定卷态的区间。各题解均采用贪心策略，核心思想是将每个恒人分隔的区间视为独立单元，通过交换将暂卷人移动到能产生最大增益的位置。核心贪心策略为：

1. **区间分类**：将恒人之间的区域分为空区间（无暂卷人）和非空区间（有暂卷人）。
2. **优先级排序**：每次操作选择剩余价值最大的区间（空区间直接填入暂卷人，非空区间通过交换获取价值）。
3. **动态维护**：用优先队列维护不同区间类型的价值，根据当前资源（可用暂卷人数量）动态选择最优操作。

### 解决难点
- **状态推导**：通过分析稳定态条件，发现只需在恒颓人相邻位置放置暂卷人即可最大化卷态。
- **交换策略**：将暂卷人交换到恒颓人边缘位置，使得整个区间稳定后全为卷态。
- **数据结构**：通过多优先队列维护不同区间的剩余价值和交换代价，实现高效贪心选择。

### 可视化设计思路
- **像素动画**：用不同颜色方块表示恒卷人（红）、恒颓人（蓝）、暂卷人（黄）、暂颓人（绿）。
- **高亮选择**：每次贪心操作时高亮当前操作的区间，显示其剩余价值。
- **音效反馈**：操作成功时播放8-bit音效，失败或冲突时播放警示音。
- **自动演示**：AI模式自动选择最优操作，展示贪心策略的渐进过程。

---

## 题解评分（≥4星）

### 1. SDNetFriend（★★★★★）
- **亮点**：清晰划分空/非空区间，维护三个优先队列处理动态决策，代码可读性强。
- **核心代码**：
  ```cpp
  priority_queue 维护空区间、非空区间剩余价值、造币代价
  while(k--) 动态选择最大增益操作
  ```
- **个人心得**："不用考虑造币产生的非空区间，没币说明当前区间只剩一个点。"

### 2. Perfound（★★★★☆）
- **亮点**：提出"白嫖"策略，利用闲置暂卷人填充空区间，代码实现多种交换场景。
- **不足**：边界条件处理复杂，变量命名晦涩（如`us3`、`wipe`）。

### 3. dead_X（★★★★☆）
- **亮点**：费用流思想转化问题，通过优先队列维护四种决策。
- **不足**：代码可读性较差，缺乏详细注释。

---

## 最优思路提炼

### 关键贪心策略
1. **区间价值计算**：每个区间的价值为长度，空区间需消耗1次交换填充暂卷人。
2. **优先级排序**：始终选择剩余价值最大的可操作区间。
3. **动态资源管理**：维护可用暂卷人数量，无资源时通过牺牲低价值区间获取资源。

### 实现技巧
- **三队列维护**：空区间队列（`s0`）、非空区间的剩余价值队列（`s1`）、造币代价队列（`s2`）。
- **交换决策公式**：`max(空区间价值, 非空区间的剩余价值 - 造币代价)`。

---

## 同类型题目推荐
1. **P1220 关路灯**（区间动态规划+贪心）
2. **P1090 合并果子**（优先队列贪心）
3. **P4059 找爸爸**（贪心+动态资源分配）

---

## 代码核心实现（SDNetFriend版）

```cpp
// 维护三个优先队列
priority_queue<_s0> s0; // 空区间按长度排序
priority_queue<_s1> s1; // 非空区间按剩余价值排序
priority_queue<_s2> s2; // 非空区间按造币代价排序

while(k--) {
    int v0 = s0.empty() ? 0 : s0.top().len;
    int v1 = s1.empty() ? 0 : s1.top().remain;
    if (有暂卷人资源) {
        res += max(v0, v1);
    } else {
        int cost = s2.top().cost;
        res += max(v0 - cost, v1);
    }
    // 更新队列状态...
}
```

---

## 复古像素化可视化设计

### 交互要素
- **Canvas绘制**：每个角色用16x16像素块表示，恒卷人（红色）、暂卷人（闪烁黄色）。
- **操作高亮**：当前选中区间边框闪烁绿色，右侧显示剩余价值。
- **音效设计**：
  - 选择操作：8-bit "coin"音效（Web Audio API生成）。
  - 错误操作：短促"error"音效。
- **自动模式**：AI自动执行贪心选择，速度可调（1x/2x/5x）。

### 核心代码片段（JS）
```javascript
// 绘制贪心选择动画
function drawGreedyStep() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    // 绘制所有区间
    regions.forEach(r => {
        ctx.fillStyle = r.type === 'empty' ? '#555' : '#FFD700';
        ctx.fillRect(r.x, 50, r.width, 30);
        ctx.strokeStyle = r.active ? '#0F0' : '#000';
        ctx.strokeRect(r.x, 50, r.width, 30);
    });
    // 播放音效
    if (stepSound) playCoinSound();
}
```

---
处理用时：80.32秒
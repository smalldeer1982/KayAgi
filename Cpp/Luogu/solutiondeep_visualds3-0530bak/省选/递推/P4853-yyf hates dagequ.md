# 题目信息

# yyf hates dagequ

## 题目背景

非酋yyf在dew的指点下抽到了不错的卡，但他还是太非了，对于随机触发的技能，他总是无法触发。yyf想知道自己究竟有多非，所以他请你来计算他的期望得分，与自己的得分来比较。

## 此题已放宽精度限制并显示错误答案和正确答案，请不要以此面向数据

## 题目描述

给你一些卡牌的技能，技能分为$2$种类型：
1. 加分，每连击$c$次有$p\%$的概率加$s$分
2. 改判，每连击$c$次有$p\%$的概率触发强判定效果，持续$t$个节奏图标（设连击数为$c$的倍数时为第$i$个节奏图标，则强判定效果在第$[i+1,i+t]$个节奏图标被触发）

这些技能在连击数为$c$的倍数且连击数不为$0$时有概率触发，多个技能可以同时触发

其中，加分技能有 $\mathrm{score}$ 个，改判技能有 $\mathrm{judge}$ 个

再给你$n$个节奏图标（yyf是按给出的顺序击打的）yyf击打的原始（相对于“强判定效果”修正后）结果，分为$2$，$1$，$0$三种

在“强判定效果”的持续期间内所有的击打结果$1$会视作击打结果$2$，击打结果$0$仍视作击打结果$0$，击打结果$2$仍视作击打结果$2$ 。下文中的“击打结果”若无说明均指修正后的击打结果。

“连击数”的定义为到目前为止连续的击打结果为$2$的次数（若这次的击打结果为$2$则这次击打也算入当前的连击数，否则当前的连击数为$0$）

多个“强判定效果”可以重叠，但持续时间不会叠加（设当前“强判定效果”剩余时间为 $t_1$，此时同时触发两个“强判定效果”，持续时间分别为 $t_2$ 和 $t_3$ ，则下一次击打时的“强判定效果”剩余时间为 $\max(t_1-1,t_2,t_3)$）。

一次击打的得分为这次的击打结果乘以当前的连击数加一。即：设当前的击打结果为 $x$ ，当前的连击数为 $\mathrm{combo}$ ，则这次击打的得分为 $\mathrm{x*(combo+1)}$

最终得分为每次（共$n$次）击打的得分之和加上加分技能的加分之和

请求出yyf这次打歌的期望得分

## 说明/提示

### 数据范围

对于全部的测试点，有：$5 \le n \le 1000$，$0 \le \mathrm{score} \le 1000$，$0 \le \mathrm{judge} \le 1000$，$1 \le c \le 5$，$1 \le p \le 99$，$1 \le s \le 10$，$1 \le t \le 5$。

| 测试点编号 | $n$ | $\mathrm{score}$ | $\mathrm{judge}$ | 特殊限制 | 测试点编号 | $n$ | $\mathrm{score}$ | $\mathrm{judge}$ | 特殊限制 |
| :----------: | :----------: | :----------: | :----------: | :----------: | :----------: | :----------: | :----------: | :----------: | :----------: |
| $1$ | $1000$ | $\ \,0\ \,$ | $\ \,0\ \,$ | 所有 $a_i$ 均为 $2$ | $11$ | $1000$ | $\ \,0\ \,$ | $\ \,9\ \,$ | 无 |
| $2$ | $1000$ | $0$ | $0$ | 无 | $12$ | $1000$ | $2$ | $2$ | 无 |
| $3$ | $1000$ | $1$ | $0$ | 无 | $13$ | $1000$ | $3$ | $3$ | 无 |
| $4$ | $1000$ | $9$ | $0$ | 无 | $14$ | $1000$ | $3$ | $6$ | 无 |
| $5$ | $1000$ | $1000$ | $0$ | 无 | $15$ | $1000$ | $1$ | $8$ | 所有 $c$ 均为 $1$ |
| $6$ | $50$ | $1$ | $1$ | 无 | $16$ | $1000$ | $0$ | $9$ | 所有 $c$ 均为 $1$ |
| $7$ | $50$ | $2$ | $2$ | 无 | $17$ | $1000$ | $1000$ | $1000$ | 所有 $c$ 均为 $1$ |
| $8$ | $50$ | $4$ | $4$ | 无 | $18$ | $1000$ | $1000$ | $1000$ | 所有 $c$ 均为 $1$ |
| $9$ | $50$ | $0$ | $9$ | 无 | $19$ | $1000$ | $1000$ | $1000$ | 无 |
| $10$ | $50$ | $4$ | $5$ | 无 | $20$ | $1000$ | $1000$ | $1000$ | 无 |

### 样例1解释

![](https://cdn.luogu.com.cn/upload/image_hosting/lc16fxxt.png)

### 样例2解释

![](https://cdn.luogu.com.cn/upload/image_hosting/rd4khzu1.png)

### 样例3解释

第一次4分，第二次1分，第三次0分，第四次4分，第五次6分

## 样例 #1

### 输入

```
4 1 1
3 70 3
2 20 1
2 2 1 1```

### 输出

```
13.82```

## 样例 #2

### 输入

```
5 0 2
2 60 1
2 10 2
2 2 1 1 1```

### 输出

```
19.084```

## 样例 #3

### 输入

```
5 0 0
2 1 0 2 2```

### 输出

```
15```

# AI分析结果



## 算法分类
动态规划、期望DP

## 综合分析与结论

### 核心思路
题目要求计算带有随机技能效果的音乐节奏游戏的期望得分。通过动态规划维护三个关键状态：当前处理到的节奏点、连击数、改判剩余时间。预处理加分技能期望与改判技能触发概率，通过逆向DP递推期望值。

### 解决难点
1. **改判技能叠加**：多个改判技能触发时，剩余时间取最大值，通过按t降序预处理技能，保证后续技能触发不影响当前最大持续时间。
2. **状态爆炸**：将改判剩余时间限制为O(maxt)级别，避免O(n^3)复杂度。
3. **概率组合**：预处理每个连击数下的改判触发概率分布，避免每次枚举技能组合。

### 可视化设计
- **动画步骤**：按节奏点逐步推进，左侧显示当前连击数与剩余时间，右侧显示状态转移路径。
- **颜色标记**：
  - 红色：当前处理的节奏点
  - 蓝色：连击数变化过程
  - 绿色：改判剩余时间变化
- **步进控制**：支持单步查看状态转移时的概率分支与得分累加。
- **像素风格**：用8位风格绘制节奏点网格，连击数用闪烁光效表示。

## 题解评分（≥4星）

### 标程（ouuan） ★★★★★
- **核心优化**：按t降序预处理改判技能，将复杂度优化至O(n^2*T)。
- **代码亮点**：预处理scor与judg数组，实现高效状态转移。

### CYJian题解 ★★★★☆
- **创新点**：滚动数组与60周期优化，但代码可读性稍逊。
- **调试心得**：提到因细节错误调试三小时，具有警示意义。

## 最优思路提炼
1. **状态压缩**：仅记录改判剩余时间而非具体触发顺序。
2. **概率预处理**：将技能触发概率转换为分层累加，避免指数级枚举。
3. **逆向DP**：从后向前递推，避免维护复杂的前置条件。

## 相似题目推荐
- P1850 换教室（期望DP）
- P2159 [NOI2016] 循环之美（状态压缩）
- P2473 奖励关（概率+状压DP）

---

## 代码核心实现

```cpp
// 预处理改判技能概率（标程关键片段）
sort(jud, jud+judge); // 按t降序排序
for (i=0; i<n; ++i) {
    pos = 1.0;
    for (j=0; j<judge; ++j) {
        if ((i+1) % jud[j].c == 0) {
            judg[i][jud[j].t] += jud[j].p/100.0 * pos;
            pos *= 1 - jud[j].p/100.0;
        }
    }
    judg[i][0] = pos;
}

// DP转移（标程关键片段）
for (i=n; i>=1; --i) {
    for (j=0; j<i; ++j) {
        for (k=0; k<=maxt; ++k) {
            if (a[i] == 0) { // 击打失败
                f[i][j][k] = f[i+1][0][max(0,k-1)];
            } else if (a[i] == 2 || k > 0) { // 触发改判
                f[i][j][k] = scor[j]; // 基础得分
                for (l=0; l<=maxt; ++l) { // 枚举改判分支
                    f[i][j][k] += f[i+1][j+1][max(l,k-1)] * judg[j][l];
                }
            } else { // 普通1分
                f[i][j][k] = f[i+1][0][max(0,k-1)] + 1.0;
            }
        }
    }
}
```

---

## 可视化方案

### 动画设计
1. **节奏点网格**：每个节奏点显示原始结果与修正后结果。
2. **状态面板**：实时显示连击数、剩余时间、累计得分。
3. **概率分支**：用树状图展示改判触发时的不同分支概率。

### 复古特效
- **音效**：连击数更新时播放8位上升音阶，技能触发时播放短促“哔”声。
- **像素绘制**：用16色调色板，连击数用黄色渐变表示。

### 交互功能
- **拖拽进度条**：快速跳转至任意节奏点。
- **概率追踪**：点击任意状态可查看该状态的详细计算过程。

---
处理用时：82.02秒
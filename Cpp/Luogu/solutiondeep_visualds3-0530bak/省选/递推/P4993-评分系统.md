# 题目信息

# 评分系统

## 题目背景

答疑请到：https://www.luogu.org/discuss/show?postid=79498

由于时限等问题，请大家重交一遍这道题

本题时限开至2s

样例：https://files.cnblogs.com/files/ztz11/yl.rar

---

众所周知，luogu 有题目难度的评分系统，用户在通过题目后可以选择题目难度以及算法标签，来完善 luogu 的题库。

![](https://cdn.luogu.com.cn/upload/pic/40327.png)

（原注：以下内容非真实评分数据，纯属作者编造，仅供娱乐使用。）

## 题目描述

Menteur-Hxy 同学很不老实，为了实现 NOIp 前 AC $100$ 道黑题的目标，他决定雇佣一些水军，最少雇佣 $1$ 个水军。

每个水军都有一个能力值 $x_i$，表示该水军可以解决难度最高为 $x_i$ 的题目。这些水军十分尽职尽责，在通过这道题目后都会给题目评最高难度。当然，luogu 的正常用户也会做题，他们会正常地评分。现在，我们给你所有水军的能力值以及每道题正常用户的评分记录，请你求出有多少种选择水军的方案，可以使这道题的评分变为黑题。因为答案可能过大，最终请输出答案数 $\bmod p$ 的值。

评分计算公式：去掉一个最高分，去掉一个最低分后求平均分。

**【表一：投票信息】**

| 投票编号 | 对应难度 | 分数贡献 |
| :------: | :------: | :------: |
| $1$ | 入门 | $1$ |
| $2$ | 普及- | $10$ |
| $3$ | 普及/提高- | $15$ |
| $4$ | 普及+/提高 | $25$ |
| $5$ | 提高+/省选- | $40$ |
| $6$ | 省选/NOI- | $55$ |
| $7$ | NOI | $75$ |
| $8$ | NOI+/CTSC | $100$ |

**【表二：难度规则】**

| 难度等级 | 对应颜色 | 对应分数 |
| :------: | :------: | :------: |
| 入门 | 红 | $1\sim 5$ |
| 普及- | 橙 | $6\sim 12$ |
| 普及/提高- | 黄 | $13\sim 20$ |
| 普及+/提高 | 绿 | $21\sim 35$ |
| 提高+/省选- | 蓝 | $36\sim 45$ |
| 省选/NOI- | 紫 | $46\sim 70$ |
| NOI+/CTSC | 黑 | $71\sim 100$ |

## 说明/提示

**【样例解释 $1$】**

luogu 用户评分和为 $25+40+55+75+100=295$，弃掉一个最低分后为 $270$，这时 Menteur-Hxy 雇佣两个及以上水军就可以达到目的。

因为可以通过本题的水军共有 $4$ 个，所以选择方案共有：

$$\{1,2\}\{1,2,3\}\{1,2,3,4\}\{1,2,4\}\{1,3\}\{1,3,4\}\{1,4\}\{2,3\}\{2,3,4\}\{2,4\}\{3,4\}$$

共 $11$ 种，对 $9$ 取余后结果为 $2$。

**【数据规模与约定】**

对于 $30\%$ 的数据，$n, m \leq 50$。

对于另外 $20\%$ 的数据，$p$ 为质数。

对于 $100\%$ 的数据，$1 \leq n, m, k,s_i \leq 10^5, 1 \leq t \leq 5, 2 \leq p \leq 3 \times 10^3, 1 \leq t_i \leq 8$。

保证合格水军的数量与需要的最少水军数量之差不超过 $5000$。

（原注：本题可能轻微卡常。感谢 @Ghostcai ，@Swhsz 帮忙验题。）

## 样例 #1

### 输入

```
1
5 5 9
1 2 3 4 5
4 5 6 7 8
2```

### 输出

```
2```

## 样例 #2

### 输入

```
5
20 10 1329
540 499 490 419 308 261 323 476 476 374 23 13 14 16 19 34 43 19 27 32 
8 8 8 8 8 7 7 7 7 7 
50
20 10 1800
74 434 97 134 283 118 234 498 328 388 29 48 48 43 23 42 31 16 20 26 
8 8 7 6 8 8 8 7 7 7 
50
20 10 2704
142 378 330 281 377 64 340 309 466 289 34 37 19 17 20 48 21 28 38 15 
6 8 6 6 8 7 7 7 7 6 
50
20 10 72
365 356 456 479 459 222 548 377 212 223 38 20 49 18 49 38 31 48 41 17 
6 8 7 6 8 7 8 8 8 6 
50
20 10 1416
367 191 403 298 445 464 79 467 431 362 10 45 48 37 46 43 11 35 30 39 
8 6 8 7 7 7 8 8 7 8 
50```

### 输出

```
1023
1023
1023
15
1023```

# AI分析结果



---

## **唯一算法分类**  
**数论**（涉及组合数模运算、Lucas定理与扩展Lucas定理）

---

## **综合分析与结论**  
### **核心思路与难点**  
1. **问题转化**  
   - 目标：使评分≥71（黑题）。  
   - 公式推导：正常用户总分`sum`去掉最低分`min`，水军贡献`100(x-1)`（因最高分必为水军的100，需去掉一个），分母为`m-1 + x-1`。  
   - 最简式：`x ≥ (71(m-1) - (sum - min)) / 29`，取整后确定最少水军数`minx`。  

2. **组合数求和**  
   - 合格水军数`cnt`（能力≥k），方案数为`ΣC(cnt, i) mod p`，其中`i`从`minx`到`cnt`。  

3. **模运算处理**  
   - **质数模**：使用Lucas定理递归计算组合数。  
   - **合数模**：扩展Lucas定理分解质因子，分治合并结果（中国剩余定理）。  

### **可视化设计思路**  
- **像素风格评分模拟器**：  
  - **Canvas 网格**：用不同颜色方块表示水军（绿色合格，红色不合格），用户评分（黄色柱状图）。  
  - **动态计算**：用户选择水军数量时，实时显示总分、平均分及是否达标（达标时播放上扬音效）。  
  - **组合数累加动画**：每增加一个水军，显示组合数公式`C(n, k)`的像素化计算过程（如分解质因子、模运算）。  

---

## **题解清单 (≥4星)**  
### 1. **WhitD 题解（★★★★☆）**  
**亮点**：  
- 公式推导清晰，正确处理边界（如`max(1, ...)`）。  
- 根据模数是否为质数分情况优化（Lucas vs 扩展Lucas）。  
- 代码简洁，变量命名合理。  

**核心代码段**：  
```cpp
int exlucas(int n,int m,int p) {
    int tmp=p, ans=0, pk=1;
    for(int i=2; i*i<=tmp; ++i) {
        if(tmp%i == 0) {
            pk=1;
            while(tmp%i ==0) tmp/=i, pk*=i;
            ans = (ans + lucas_part(n,m,i,pk) * inv(p/pk,pk) %p * p/pk %p) %p;
        }
    }
    if(tmp>1) ans = (ans + ... ) %p; // 合并质因子结果
    return ans;
}
```

### 2. **ztz11 题解（★★★☆☆）**  
**亮点**：  
- 提供暴力与递推部分分思路。  
- 完整实现扩展Lucas，适合教学参考。  

**改进点**：  
- 未分情况处理质数模，效率略低。  
- 变量命名较隐晦（如`nl[]`）。  

---

## **最优思路与技巧**  
### **关键公式推导**  
```math
x \geq \frac{71(m-1) - (sum - min)}{29} \quad \Rightarrow \quad minx = \max(1, \lceil \text{RHS} \rceil)
```  
确保公式推导正确是核心，需注意分母为`m-1 + x-1 = m + x - 2`。  

### **组合数模优化**  
- **质数模**：直接Lucas递归，时间复杂度`O(p log n)`。  
- **合数模**：分解模数为质因子幂次，分别计算后合并（扩展Lucas）。  

### **合格水军筛选**  
预处理水军能力值，排序后二分查找`≥k`的数量，时间复杂度`O(n log n)`。  

---

## **同类题目推荐**  
1. **P3807 【模板】卢卡斯定理**  
   - 练习Lucas定理的模板题。  
2. **P2480 [SDOI2010]古代猪文**  
   - 综合应用Lucas定理与中国剩余定理。  
3. **P3301 [SDOI2013]方程**  
   - 组合数模与容斥原理结合。  

---

## **可视化实现要点**  
### **像素动画设计**  
- **网格布局**：左侧显示水军与用户评分方块，右侧显示公式与结果。  
- **音效触发**：  
  - 选中水军时播放“哔”声，达标时播放“胜利”音效。  
  - 背景音乐：8位循环旋律（如《超级玛丽》风格）。  
- **自动演示模式**：  
  - AI自动递增水军数，动态展示组合数累加与评分变化。  

### **关键代码片段（JS伪代码）**  
```javascript
// 计算组合数模（扩展Lucas）
function exLucas(n, m, p) {
    let factors = primeFactors(p); // 分解质因子
    let crtResults = factors.map(f => calcLucas(n, m, f));
    return chineseRemainder(crtResults, factors);
}

// 像素动画更新
function updateAnimation(cnt, x) {
    drawGrid(cnt, x); // 更新水军选择
    playSound('select'); 
    if (currentScore >= 71) playSound('win');
}
```

---

**总结**：本题核心为数学推导与组合数模运算，需熟练掌握扩展Lucas定理。可视化设计通过动态模拟评分过程，增强对公式与组合数计算的理解。

---
处理用时：96.64秒
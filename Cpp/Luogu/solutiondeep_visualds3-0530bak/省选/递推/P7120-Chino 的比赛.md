# 题目信息

# Chino 的比赛

## 题目描述

Chino 想要用现在手里有的 $n$ 道题出成一套模拟赛。一开始，这 $n$ 道题按照由易到难的顺序排列。

但是因为 Chino 是一个可爱的妹子，所以她会将这些题目的顺序打乱。具体地，她会执行恰好奇数次操作，每次操作她会将其中两道题的位置交换。一套可能的模拟赛就是这些题的一个排列。

Chino 为了评估一套模拟赛的可爱程度，她定义 $s$ 表示使得开始时的题目顺序变为这套模拟赛的题目顺序的最少操作次数，定义 $t$ 表示开始时与这套模拟赛中位置相同的题目数量，那么这套模拟赛的可爱程度就是 $s/\left(t+1\right)$。

按照套路，你现在应该帮 Chino 计算某一套模拟赛的可爱程度。Chino 觉得这不够可爱，所以她想让你计算所有可能的模拟赛的可爱程度的两倍和。可以发现这一定是一个非负整数。为了避免答案过大，你只需要输出其对质数 $p$ 取模后的结果即可。

形式化地，对于置换 $\pi$，令 $\nu\left(\pi\right)$ 表示其不动点个数，设 $\upsilon\left(\pi\right)$ 为其能够被分解成为的最少个数对换乘积的对换数目。设 $n$ 元对称群为 $S_n$，$n$ 元交错群为 $A_n$，求
$$
2\sum_{\pi\in S_n\land\pi\notin A_n}\frac{\upsilon\left(\pi\right)}{\nu\left(\pi\right)+1}.
$$

这一定是一个非负整数。答案对质数 $p$ 取模后输出。

## 说明/提示

### 样例解释 #1
四道题的所有可能的模拟赛题目排列顺序有：
- $\left\{1,2,4,3\right\}$，可爱程度为 $1/3$；
- $\left\{1,3,2,4\right\}$，可爱程度为 $1/3$；
- $\left\{1,4,3,2\right\}$，可爱程度为 $1/3$；
- $\left\{2,1,3,4\right\}$，可爱程度为 $1/3$；
- $\left\{2,3,4,1\right\}$，可爱程度为 $3$；
- $\left\{2,4,1,3\right\}$，可爱程度为 $3$；
- $\left\{3,1,4,2\right\}$，可爱程度为 $3$；
- $\left\{3,2,1,4\right\}$，可爱程度为 $1/3$；
- $\left\{3,4,2,1\right\}$，可爱程度为 $3$；
- $\left\{4,1,2,3\right\}$，可爱程度为 $3$；
- $\left\{4,2,3,1\right\}$，可爱程度为 $1/3$；
- $\left\{4,3,1,2\right\}$，可爱程度为 $3$。

### 测试点约束
**本题采用捆绑测试。**

对于全部数据，有 $1\le n\le2\times10^7$，$2^{25}<p<2^{31}$，$p$ 为质数。
	
每个子任务的具体限制见下表：

| 子任务编号 | 分值 | $n\le$ | $p=998244353$ |
|:-:|:-:|:-:|:-:|
| 1 | 10 | $2\times10^1$ | $\times$ |
| 2 | 10 | $2\times10^2$ | $\surd$ |
| 3 | 10 | $2\times10^3$ | $\times$ |
| 4 | 20 | $2\times10^4$ | $\times$ |
| 5 | 20 | $2\times10^5$ | $\surd$ |
| 6 | 10 | $2\times10^6$ | $\surd$ |
| 7 | 20 | $2\times10^7$ | $\times$ |

### 更快的取模
本题中你可能会执行大量取模操作，因此你可以参考[几种取模优化方法（译自 min-25 的博客）](https://loj.ac/d/327)来提高取模运算的效率。

## 样例 #1

### 输入

```
4 16777259
```

### 输出

```
40
```

## 样例 #2

### 输入

```
10 2147483647
```

### 输出

```
17167120
```

## 样例 #3

### 输入

```
10000000 998244353
```

### 输出

```
3414058
```

# AI分析结果



---

**算法分类选择**  
组合数学/生成函数

---

**题解思路、算法要点与解决难点**  

**核心思路**：  
题目要求计算所有奇置换的可爱程度总和。关键是将置换分解为环结构，统计环数、不动点数目，并利用置换奇偶性筛选奇置换。核心难点在于高效计算大规模下组合数的复杂和式。

**题解对比**：  
1. **NaCly_Fish的生成函数法**：  
   - 将问题转化为生成函数的系数提取问题，通过多项式展开和组合推导得到生成函数表达式。  
   - 利用线性递推计算逆元、阶乘等预处理，最终通过多项式的系数提取完成计算。  
   - **关键步骤**：构造形如 $e^{-x}\ln(1-x)$ 的生成函数项，通过微分和积分技巧简化表达式。  

2. **Daniel13265的递推法**：  
   - 定义 $a_n$ 和 $p_n$ 分别表示偶置换和奇置换的 $\upsilon(\pi)$ 总和。  
   - 通过递推关系式 $a_n = a_{n-1} + (n-1)(\lfloor (n-1)!/2 \rfloor + p_{n-1})$ 逐步计算。  
   - **关键优化**：递推过程中仅需前一项的值，空间复杂度可优化为 $O(1)$。

**解决难点**：  
- 生成函数法需深入理解对称群与生成函数的对应关系，推导复杂度高但代码实现简洁。  
- 递推法需找到置换环数与奇偶性之间的递推规律，组合分析难度较大。

---

**题解评分 (≥4星)**  

1. **NaCly_Fish（5星）**  
   - 思路清晰，数学推导严密，生成函数转换巧妙。  
   - 代码高效，线性时间预处理，适合大规模数据。  

2. **Daniel13265（4星）**  
   - 递推式直观，易于理解置换奇偶性关系。  
   - 空间复杂度可优化，但需存储完整数组，对超大n略逊。

---

**最优思路或技巧提炼**  

- **生成函数降维打击**：将组合计数问题转换为生成函数系数提取，利用多项式运算简化求和。  
- **奇偶分离递推**：通过递推维护偶置换和奇置换的状态，避免直接枚举所有排列。  
- **逆元预计算**：预处理模意义下的逆元数组，将除法转换为乘法优化计算。

---

**同类型题或类似算法套路**  

- **置换环分析**：常见于排列相关题目，如计算最少交换次数。  
- **生成函数优化组合和式**：适用于大规模组合数求和问题，如多项式系数统计。

---

**推荐相似题目**  

1. [P1447 能量项链](https://www.luogu.com.cn/problem/P1447) - 置换环的动态规划应用。  
2. [P5157 置换](https://www.luogu.com.cn/problem/P5157) - 置换的奇偶性与组合计数。  
3. [P4721 分治 FFT](https://www.luogu.com.cn/problem/P4721) - 生成函数在递推中的典型应用。

---

**可视化与算法演示**  

**动画设计**：  
1. **置换环分解演示**：  
   - 初始排列显示为数字序列，动态展示交换形成环的过程。  
   - 高亮当前操作的交换对，显示环数变化和奇偶性判断。  
2. **递推过程可视化**：  
   - 以滚动条展示递推变量 $a_n$ 和 $p_n$ 的更新，颜色区分奇偶状态。  
   - 实时显示当前计算到第几步，突出递推公式中的 $(n-1)$ 项影响。  

**复古像素风格**：  
- **8位阶乘计算器**：用像素方块表示阶乘值增长，每次递推时播放合成器音效。  
- **音效设计**：  
  - 正确计算时播放8位上升音阶。  
  - 奇偶状态切换时触发不同音色提示。  

---

**代码实现关键**  

**NaCly_Fish的核心预处理**：  
```cpp
inv[1] = 1;
for(int i=2; i<=n+1; ++i) 
    inv[i] = (ull)(p - p/i) * inv[p%i] % p;

f[0] = 1;
for(int i=1; i<=n; ++i) 
    f[i] = p - (ull)f[i-1] * inv[i+1] % p;
```

**Daniel13265的递推逻辑**：  
```cpp
a[1] = p[1] = 0;
for(int k=2; k<=n; ++k){
    int t = (k-1);
    long long half = fact[k-1]/2; // fact预存阶乘
    a[k] = (a[k-1] + t*(half + p[k-1])) % MOD;
    p[k] = (p[k-1] + t*((fact[k-1]+1)/2 + a[k-1])) % MOD;
}
```

---

**结论**  
两种方法均以 $O(n)$ 时间完成计算，生成函数法数学要求高但代码简洁，递推法直观易理解。实际编码可根据数学功底选择，大规模数据下生成函数法常数更优。

---
处理用时：96.29秒
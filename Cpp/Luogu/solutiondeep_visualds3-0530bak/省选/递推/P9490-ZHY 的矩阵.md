# 题目信息

# ZHY 的矩阵

## 题目描述

ZHY 的记忆中有一个 $k$ 行 $n$ 列的 01 矩阵 $A$，满足下列条件：

- 每一列都至多有一个 $1$。
- 每行相邻的两个 $1$ 所在的两列夹出的 $k$ 行的矩形（包括这两列）内至少有三个 $1$。

突然，ZHY 想起来了矩阵中 $x$ 个位置的值。请你计算有多少种填充 $A$ 的剩余位置的方案，使得 $A$ 满足条件。

----

形式化的讲，设 $A$ 第 $i$ 行第 $j$ 列的数为 $A_{i,j}$，则 $A$ 满足下列条件：

- 对于 $\forall i \in [1,k],\kern{2pt}j \in [1,n]$，$A_{i,j} \in \{0,1\}$。

- 对于 $\forall i \in [1,n]$，$\displaystyle\sum_{j=1}^{k} A_{j,i}\le 1$。

- 对于 $\forall i,j \in [1,n],\kern{2pt}p \in [1,k]$ 且 $j>i$，若有 $A_{p,i}=A_{p,j}=1,\displaystyle \sum_{x=i}^{j}A_{p,x}=2$，则有 $\Big(\displaystyle \sum_{x=1}^{k} \sum_{y=i}^{j} A_{x,y}\Big) \ge 3$。

- 对于 $\forall i\in[1,x]$，有 $A_{a_{i},b_{i}}=c_{i}$。

由于答案可能很大，你只需告诉 ZHY 答案对 $10^{9}+7$ 取模的结果。定义两个矩阵 $A,A'$ 不同，当且仅当存在 $i\in[1,k]$，$j\in[1,n]$ 满足 $A_{i,j}\ne A'_{i,j}$。

## 说明/提示

**样例解释**

满足条件的矩阵只有以下 $2$ 种：

$$
\begin{Bmatrix}
1&0&0\\
0&0&0
\end{Bmatrix}
$$

$$
\begin{Bmatrix}
1&0&0\\
0&0&1
\end{Bmatrix}
$$

----


**本题采用捆绑测试。**

| $\mathrm{Subtask} \kern{2pt} \mathrm{id}$ | $n$ | $x$ | 特殊性质 | 分值 |
| :-----: | :-----: | :-----: | :-----: | :-----: |
| $0$ | $\le 8$ | $\le 8$ | $k=2$ | $12$ |
| $1$ | $\le 2 \times 10^{5}$ | $\le 2\times 10^{5}$ | 无 | $26$ |
| $2$ | $\le 10^{9}$ | $=0$ | 无 | $23$ |
| $3$ | $\le 10^{9}$ | $\le 2\times 10^{5}$ | $c_{i}=1$ | $15$ |
| $4$ | $\le 10^{9}$ | $\le 2\times 10^{5}$ | 无 | $24$ |

对于所有数据，$1 \le n \le 10^{9}$，$0 \le x \le 2\times 10^{5}$，$2\le k \le 100$。$1 \le a_{i} \le k$，$1 \le b_{i} \le n$，$c_{i} \in \{0,1\}$。保证不存在一对 $i,j \in [1,x],\kern{2pt}i\neq j$，满足 $a_{i}=a_{j},\kern{2pt}b_{i}=b_{j}$。

## 样例 #1

### 输入

```
3 2 2
1 1 1
2 2 0
```

### 输出

```
2
```

# AI分析结果



---

**唯一算法分类**  
动态规划（DP）结合数学推导

---

### 综合分析与结论

#### 题解核心思路
1. **状态定义**：将二维矩阵转化为一维序列，定义 `f[i][j]` 表示前 `i` 个断点（离散化后的关键列）中，最后一个非零列在第 `j` 行的方案数。
2. **断点离散化**：将已知的 `x` 个约束位置离散化为断点，将 `n` 列分割为多个段，每段长度可能极大（至 `1e9`）。
3. **分段递推**：对每段使用快速幂推导状态转移，利用数学公式 `(k^d-1)/(k-1)*f_0 + k^{d-1}*sum_f` 快速计算段内所有可能的转移情况。
4. **约束处理**：对每个断点的等于型（必须为某值）或不等型（禁止某些值）约束，调整转移方程。

#### 解决难点
- **大规模 `n` 处理**：通过离散化断点，将时间复杂度从 `O(n)` 降为 `O(x)`。
- **相邻约束条件**：通过状态转移方程确保每段内的相邻 `1` 满足至少三个 `1` 的条件。
- **数学公式推导**：利用等比数列求和公式快速计算长段的转移系数，避免逐列枚举。

#### 可视化设计
1. **像素动画演示**：
   - **网格表示**：用 `Canvas` 绘制 `k` 行网格，断点用红色高亮，非断点段用灰色表示。
   - **状态标记**：当前段末位状态用不同颜色（如蓝色为 `0`，绿色为某行）标记。
   - **快速幂计算**：在屏幕下方显示 `k^d mod P` 的动态计算过程，伴随像素闪烁特效。
2. **音效提示**：
   - **断点处理**：播放短促“哔”声。
   - **错误检测**（如多个 `1` 冲突）：播放低沉“嗡”声。
3. **步进控制**：支持单步执行断点处理，观察 `f` 数组的更新过程。

---

### 题解清单（评分≥4星）

1. **Raymondzll（★★★★★）**  
   - **亮点**：通过离散化断点与快速幂推导，将时间复杂度优化至 `O(xk)`，代码实现清晰。
   - **关键代码**：`f[i][j] = ksm(k, d-1) * f[i-1][0] + (k-1)*ksm(k, d-2)*sum[i-1]`

2. **0000pnc（★★★★☆）**  
   - **亮点**：详细推导分段递推的数学公式，提供状态转移的直观解释，但代码未完全实现快速幂优化。

---

### 最优思路提炼

1. **断点离散化**  
   - 将已知的 `x` 个约束列排序去重，形成关键断点序列。
   - 在断点之间插入虚拟断点（如首尾），将问题转化为分段处理。

2. **分段快速幂计算**  
   - 对长度为 `d` 的段，末位为 `0` 的方案数为 `(k^d-1)/(k-1) * f_prev_0`。
   - 末位非 `0` 的方案数为 `k^{d-1} * sum_prev`。

3. **约束条件转移**  
   - **等于型**：仅允许特定行转移，其他行方案清零。
   - **不等型**：禁止某些行的转移，调整合法转移系数。

---

### 同类型题与算法套路

1. **分段动态规划**：如「CF1542E1 Abnormal Permutation Pairs」，利用离散化事件点分割序列。
2. **矩阵快速幂优化**：如「P4159 [SCOI2009] 迷路」，将状态转移编码为矩阵幂。

---

### 推荐题目

1. **P2151 [SDOI2009] HH去散步**（动态规划+矩阵快速幂）
2. **CF1765M Minimum LCM**（离散化约束点+数学推导）
3. **P5020 [NOIP2018 提高组] 货币系统**（离散化与约束处理）

---

### 个人心得摘录

> "相邻约束条件通过状态转移方程隐式保证，无需显式检查。快速幂推导是处理长段的核心，避免逐列计算。" —— Raymondzll

---

### 代码核心实现

```cpp
// 断点间递推核心代码
for (int i=1; i<=X; i++) {
    int d = l[i] - l[i-1];
    if (flag[i]) { // 等于型约束
        for (int j=1; j<=k; j++) {
            if (d == 1) f[i][j] = (f[i-1][0] + sum[i-1] - f[i-1][j]) % P;
            else f[i][j] = (ksm(k, d-1)*f[i-1][0] + (k-1)*ksm(k, d-2)%P*sum[i-1]) % P;
        }
    } else { // 无约束或不等型
        for (int j=1; j<=k; j++) {
            f[i][j] = ((ksm(k, d)-1)*invk % P * f[i-1][0] + ksm(k, d-1)*sum[i-1]) % P;
        }
    }
    sum[i] = accumulate(f[i]+1, f[i]+k+1, 0LL) % P;
}
```

---

### 复古像素动画设计

1. **Canvas 初始化**  
   - 绘制 `k` 行网格，每个格子表示一列，断点列用红色边框标记。
   
2. **状态更新动画**  
   - 当前处理段用黄色高亮，末位状态用绿色（非零）或蓝色（零）填充。
   - 快速幂计算时，在右侧显示 `k^d mod P` 的二进制位翻转动画。

3. **音效触发**  
   - **断点处理**：8-bit 风格“滴”声（Web Audio API 生成 500Hz 方波）。
   - **错误**：持续 0.2 秒的 200Hz 锯齿波。

4. **自动演示模式**  
   - 按断点顺序自动播放，每步暂停 1 秒，显示转移公式的像素化文字。

---
处理用时：69.95秒
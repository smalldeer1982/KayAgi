# 题目信息

# [APIO2021] 六边形领域

## 题目背景

本题只支持 C++ 提交，提交时不需要包含 `hexagon.h` 头文件，只需要将附件中的 `hexagon.h` 中的内容粘贴到代码的开头即可。

## 题目描述

对于一个用六边形无限平铺的平面，Pak Dengklek 站在其中一个格子上，并称该格子为初始格子。如果六边形平铺中的两个格子有公共边，则称它们是相邻的格子。对于一步移动，Pak Dengklek 可以从一个格子向六个可能的方向（从 $1$ 到 $6$ 编号，如下图所示）移动到与其相邻的格子上。

![](https://cdn.luogu.com.cn/upload/image_hosting/cojdvvvr.png)

对于某个由 $N$ 次行动构成的行动序列，Pak Dengklek 可以用其产生的路径（对应一个按序访问的格子序
列）构造一个领域。其中第 $i$ 次行动由移动方向 $D[i]$ 和在该方向上的移动步数 $L[i]$ 组成，并且该路径应有如下性质：

- 路径是 _封闭_ 的，这意味着在格子序列中，起点格子与终点格子（即初始格子）相同。
- 路径是 _简单_ 的，这意味着在格子序列中，除了初始格子访问过恰好两次（起点和终点分别访问一
次），其他格子只能被访问至多一次。
- 路径是 _暴露_ 的，这意味着在格子序列中，每个格子与至少一个不在序列中出现过的非 _内部格子_ 相邻。
    - 如果一个格子不在格子序列中出现过，并且从它出发，在不经过格子序列中任何格子的情况下，（通过若干步移动） 只能访问到有限个格子，我们就称该格子是 _内部格子_ 。

下图是一个符合上述条件的路径例子。其中：

- $1$ 号格子（粉色）是初始格子。
- 被编号的格子（淡蓝色）组成格子序列，编号代表它被访问的顺序。
- 被标上叉号的格子（深蓝色）是 _内部格子_。

![](https://cdn.luogu.com.cn/upload/image_hosting/znccjlim.png)

构造出的领域只包含所有路径上的格子和内部格子。领域中格子 $c$ 的距离定义为：在只经过领域中包含格子的情况下，从初始格子出发到达 $c$ 所需要的最少移动步数。领域中一个格子的分数定义为 $A+d \times B$，其中 $A$ 和 $B$ 是 Pak Dengklek 给定的常数，$d$ 是该格子在领域中的距离。下图给出了用上示路径构成的领域中每个格子的距离。

![](https://cdn.luogu.com.cn/upload/image_hosting/u9gjh0n6.png)

请帮助 Pak Dengklek 计算，用给出的行动序列构成的领域中，所有格子的分数之和。由于总分数值可能很大，最终结果对 ${10}^9+7$ 取模。

你需要实现下列函数：

`int draw_territory(int N, int A, int B, int[] D, int[] L)`

- $N$：行动序列中行动的次数。
- $A,B$：分数计算中的常数。
- $D$：大小为 $N$ 的数组，其中 $D[i]$ 表示第 $i$ 次行动的方向。
- $L$：大小为 $N$ 的数组，其中 $L[i]$ 表示第 $i$ 次行动的移动步数。
- 函数应该返回用给出的行动序列所构成的领域中，所有格子的分数总和对 ${10}^9+7$ 取模后的值。
- 该函数将被调用恰好一次。

## 说明/提示

**【样例解释】**

考虑下列调用：

```plain
draw_territory(17, 2, 3,
			   [1, 2, 3, 4, 5, 4, 3, 2, 1, 6, 2, 3, 4, 5, 6, 6, 1],
			   [1, 2, 2, 1, 1, 1, 1, 2, 3, 2, 3, 1, 6, 3, 3, 2, 1])
```

该行动序列和上述题面中给出的例子相同。下表列出了该领域中所有可能的距离值所对应的分数。

| 距离值 | 格子数 | 每个格子分数 | 总分数 |
|:-:|:-:|:-:|:-:|
|$0$|$1$|$2+0 \times 3=2$|$1 \times 2=2$|
|$1$|$4$|$2+1 \times 3=5$|$4 \times 5=20$|
|$2$|$5$|$2+2 \times 3=8$|$5 \times 8=40$|
|$3$|$6$|$2+3 \times 3=11$|$6 \times 11=66$|
|$4$|$4$|$2+4 \times 3=14$|$4 \times 14=56$|
|$5$|$3$|$2+5 \times 3=17$|$3 \times 17=51$|
|$6$|$4$|$2+6 \times 3=20$|$4 \times 20=80$|
|$7$|$4$|$2+7 \times 3=23$|$4 \times 23=92$|
|$8$|$5$|$2+8 \times 3=26$|$5 \times 26=130$|
|$9$|$3$|$2+9 \times 3=29$|$3 \times 29=87$|
|$10$|$4$|$2+10 \times 3=32$|$4 \times 32=128$|
|$11$|$5$|$2+11 \times 3=35$|$5 \times 35=175$|
|$12$|$2$|$2+12 \times 3=38$|$2 \times 38=76$|

总分数值为 $2+20+40+66+56+51+80+92+130+87+128+175+76=1003$。

因此，`draw_territory` 应该返回 $1003$。

**【数据范围】**

- $3 \le N \le 2\times {10}^5$。
- $0 \le A,B \le {10}^9$。
- $1 \le D[i] \le 6$（$0 \le i \le N-1$）。
- $1 \le L[i]$（$0 \le i \le N-1$）。
- $L$ 中的元素之和不超过 ${10}^9$。
- 给出的行动序列所对应的路径一定是 _封闭_、_简单_ 和 _暴露_ 的。

**【子任务】**

1. （3 分）：$N=3$，$B=0$。
2. （6 分）：$N=3$。
3. （11 分）：$L$ 中的元素之和不超过 $2000$。
4. （12 分）：$B=0$，$L$ 中的元素之和不超过 $2\times {10}^5$。
5. （15 分）：$B=0$。
6. （19 分）：$L$ 中的元素之和不超过 $2\times {10}^5$。
7. （18 分）：$L[i]=L[i+1]$（$0 \le i \le N-2$）。
8. （16 分）：无附加限制。

## 样例 #1

### 输入

```
17 2 3
1 1
2 2
3 2
4 1
5 1
4 1
3 1
2 2
1 3
6 2
2 3
3 1
4 6
5 3
6 3
6 2
1 1```

### 输出

```
1003```

# AI分析结果

# 💡 Kay的C++算法解析：[APIO2021] 六边形领域 深入学习指南 💡


## 1. 题目解读与核心算法识别

✨ **本题主要考察**：几何建模与数学分析（结合六边形网格坐标系统）

🗣️ **初步分析**：  
解决“六边形领域”的关键，在于把**抽象的六边形网格问题转化为可计算的几何坐标问题**——就像我们用“x-y”坐标描述正方形网格一样，六边形网格也需要一套“语言”来定义每个格子的位置。这个“语言”就是**轴向坐标（q, r）**（或立方坐标），它能把六个方向的移动转化为坐标的增减（比如方向1对应“q+1，r-1”，方向2对应“q+1，r不变”）。  

本题的核心目标是**计算领域内每个距离的格子数**，再求总分。但由于L之和可能高达1e9，显然不能“逐个格子模拟”——这就需要我们通过**几何分析**找出领域的边界形状（路径构成的简单多边形），再推导每个距离对应的格子数规律（比如像“正方形网格的环状区域”一样，六边形的距离层也是环状的）。  

**核心难点**：  
1. 如何用坐标系统准确描述六边形的移动和路径？  
2. 如何从路径中提取领域的边界（简单多边形）？  
3. 如何用数学公式计算每个距离的格子数（避免暴力枚举）？  

**可视化设计思路**：  
我们会用**8位像素风的六边形网格**模拟问题场景——起点是红色像素块，路径用蓝色线段绘制，转折点（方向变化的点）用黄色闪烁提示。距离计算用“颜色渐变”表示（距离0红→距离1橙→距离2黄…），每个距离的格子数会实时显示在屏幕右侧。关键操作（如绘制路径、计算距离）会伴随“叮”的像素音效，完成时播放“胜利”音调，增强记忆点。


## 2. 精选优质题解参考

<eval_intro>
目前待处理内容中**没有提供具体题解**。不过我们可以从问题本质出发，明确解题的核心方向：  
1. 先设计**六边形坐标系统**（比如轴向坐标），将行动序列转化为路径的转折点坐标；  
2. 分析路径构成的**简单多边形边界**，利用几何性质（如Pick定理、多边形面积）计算内部格子数；  
3. 推导**距离分层的数学规律**（比如每个距离d对应的格子数是一个关于d的线性或二次函数），从而快速求和。
</eval_intro>


## 3. 核心难点辨析与解题策略

<difficulty_intro>
本题的难点集中在“几何建模”和“数学规律推导”上。下面我们逐一拆解：
</difficulty_intro>

1. **关键点1：六边形网格的坐标建模**  
   - **难点**：六边形有6个方向，如何用简单的坐标表示移动？  
   - **解决方案**：选择**轴向坐标（q, r）**（类似“斜坐标系”），每个方向对应固定的坐标增量：  
     | 方向编号 | 1 | 2 | 3 | 4 | 5 | 6 |
     |----------|---|---|---|---|---|---|
     | q的变化  | +1| +1| 0 | -1| -1| 0 |
     | r的变化  | -1| 0 | +1| +1| 0 | -1|  
   例如，方向1的移动就是“q加1，r减1”，方向2是“q加1，r不变”。这样，任何行动序列都能转化为坐标的变化，路径的转折点（每次行动的终点）也能轻松计算。  

   💡 **学习笔记**：坐标系统是解决几何问题的“翻译器”，选对了就能把复杂的移动转化为简单的数值运算。

2. **关键点2：领域边界的提取**  
   - **难点**：路径是“封闭、简单、暴露”的，如何确定领域的边界（路径上的格子）和内部（被边界包围的格子）？  
   - **解决方案**：路径的转折点（每个行动的终点）构成一个**简单多边形**（因为路径是简单的，没有交叉）。我们可以用这些转折点的坐标，结合“射线法”或“多边形面积法”判断哪些格子在内部。例如，利用Pick定理（多边形面积=内部格子数+边界格子数/2 -1）可以快速计算内部格子总数。  

   💡 **学习笔记**：简单多边形的性质是解决“区域划分”问题的关键，比如Pick定理能把几何面积和格子数联系起来。

3. **关键点3：大数情况下的距离计算**  
   - **难点**：L之和高达1e9，无法逐个计算每个格子的距离，怎么办？  
   - **解决方案**：观察领域的距离结构——距离d的格子构成一个**六边形环**（类似正方形网格的“圆环”）。通过分析边界多边形的形状，我们可以推导出每个d对应的环的“边长”，从而用公式计算格子数（比如d=0时有1个格子，d=1时有6个格子，d=2时有12个格子…但具体规律需要结合边界形状调整）。  

   💡 **学习笔记**：大数问题往往需要“找规律”，把“逐个计算”转化为“公式求和”。


## 4. C++核心代码实现赏析

<code_intro_overall>
我们先看一个**六边形坐标建模与路径转折点计算**的核心代码框架——这是解决问题的基础。
</code_intro_overall>

### 本题通用核心C++实现参考
* **说明**：本代码实现了六边形坐标系统的基础功能，计算路径的转折点坐标（每次行动的终点），为后续几何分析做准备。
* **完整核心代码**：
  ```cpp
  #include <iostream>
  #include <vector>
  using namespace std;

  typedef long long ll;
  const int MOD = 1e9 + 7;

  // 六边形方向对应的轴向坐标增量（q, r）
  const int dx[] = {1, 1, 0, -1, -1, 0};  // q的变化
  const int dy[] = {-1, 0, 1, 1, 0, -1}; // r的变化

  struct Point {
      ll q, r;
      Point(ll q = 0, ll r = 0) : q(q), r(r) {}
      Point operator+(const Point& other) const {
          return Point(q + other.q, r + other.r);
      }
      Point operator*(ll k) const {
          return Point(q * k, r * k);
      }
  };

  int main() {
      ios::sync_with_stdio(false);
      cin.tie(nullptr);

      int N;
      ll A, B;
      cin >> N >> A >> B;

      vector<int> D(N), L(N);
      for (int i = 0; i < N; ++i) {
          cin >> D[i] >> L[i];
          D[i]--; // 转换为0-based索引（对应dx/dy的下标）
      }

      vector<Point> vertices; // 路径的转折点（行动的终点）
      Point current;          // 初始位置（q=0, r=0）
      vertices.push_back(current);

      for (int i = 0; i < N; ++i) {
          int dir = D[i];
          ll len = L[i];
          Point delta(dx[dir], dy[dir]);
          current = current + delta * len; // 同一方向移动len步
          vertices.push_back(current);
      }

      // TODO: 分析vertices构成的多边形，计算每个距离的格子数cnt[d]
      // TODO: 计算总分sum( cnt[d] * (A + B*d) ) % MOD

      return 0;
  }
  ```
* **代码解读概要**：  
  1. **坐标系统定义**：用`dx[]`和`dy[]`存储6个方向的坐标增量，`Point`结构体表示轴向坐标（q, r）。  
  2. **输入处理**：读取行动序列，将方向转换为0-based（方便索引`dx/dy`）。  
  3. **转折点计算**：从初始位置出发，每次行动沿同一方向移动`L[i]`步，记录终点坐标（转折点）。  
  4. **后续步骤**：需要分析转折点构成的多边形，推导每个距离的格子数，最终计算总分。


## 5. 算法可视化：像素动画演示

### 动画演示主题  
**像素探险家：六边形领域大冒险**（8位FC游戏风格）

### 核心演示内容  
模拟路径绘制→边界分析→距离计算的完整过程，用像素风展示六边形网格的坐标变化和领域结构。

### 设计思路简述  
采用**8位像素风**是为了还原复古游戏的轻松感，降低学习压力；**颜色渐变**和**音效**能强化“距离”和“关键操作”的记忆（比如绘制路径时的“沙沙声”、转折点的“叮”声）；每完成一个阶段（如路径闭合、距离计算）会触发“小关卡胜利”提示，增加成就感。

### 动画帧步骤与交互关键点  
1. **场景初始化**：  
   - 屏幕中心显示**红色像素六边形**（起点），周围是灰色的六边形网格（代表未探索区域）。  
   - 底部控制面板有：`开始/暂停`（红色按钮）、`单步`（蓝色按钮）、`重置`（黄色按钮）、速度滑块（1~5档）。  
   - 背景播放**8位风格的轻快BGM**（类似《超级马里奥》的背景音乐）。  

2. **路径绘制**：  
   - 点击“开始”后，按照行动序列**逐段绘制路径**：同一方向的`L[i]`步用蓝色像素块填充，伴随“沙沙”的绘制音效。  
   - 每次行动结束（到达转折点），该点会**黄色闪烁3次**，伴随“叮”的提示音（强调转折点是几何分析的关键）。  

3. **领域计算**：  
   - 路径闭合后（回到起点），内部格子会**逐步变成绿色**（表示属于领域），同时计算每个距离的格子数：  
     - 距离0（起点）：红色，显示`1`个；  
     - 距离1：橙色，显示`4`个（如样例）；  
     - 距离2：黄色，显示`5`个（如样例）；  
     …  
   - 每个距离的格子数会实时更新在屏幕右侧的“统计面板”，伴随“计算中”的轻微音效。  

4. **结果展示**：  
   - 所有距离计算完成后，屏幕中央弹出**像素化的“胜利”提示**（文字是8位风格），播放上扬的“胜利”音调。  
   - 统计面板显示总分（如样例的1003），并提示“点击重置重新体验”。

### 交互设计  
- **单步模式**：用户点击“单步”可逐段查看路径绘制过程，每步都会暂停，方便观察坐标变化。  
- **速度调整**：滑块可调节动画速度（1档最慢，5档最快），适应不同学习节奏。  
- **重置功能**：点击“重置”后，场景回到初始状态，可重新开始演示。


## 6. 拓展练习与相似问题思考

### 通用思路迁移  
本题的核心是**“几何问题的坐标化”**——把现实中的空间关系转化为数学坐标，再通过公式计算。这种思路适用于：  
1. **正方形网格的路径问题**（如迷宫求解、最短路径）；  
2. **多边形面积计算**（如Pick定理的应用）；  
3. **大数情况下的规律推导**（如求1~n的和用公式代替循环）。

### 洛谷练习推荐  
1. **洛谷 P1003 铺地毯**：练习几何坐标的边界判断，培养“坐标化”思维。  
   🗣️ **推荐理由**：这道题需要用坐标描述地毯的位置，判断某点是否被覆盖——和本题的“坐标建模”思路一致。  
2. **洛谷 P1517 不高兴的津津**：练习简单的规律推导，培养“找公式”的能力。  
   🗣️ **推荐理由**：这道题需要计算津津的不高兴程度，通过分析规律可以避免逐个天数计算——和本题的“大数求和”思路一致。  
3. **洛谷 P2014 选课**：练习分层计算的思想，培养“结构分析”能力。  
   🗣️ **推荐理由**：这道题需要计算树形结构的选课方案数，每层的选择会影响下一层——和本题的“距离分层”思路类似。


## 7. 学习心得与经验分享 (若有)  
本次分析的题解中未发现明确的作者个人心得分享部分。


## 总结  
“六边形领域”的核心是**用坐标系统翻译几何问题，用数学规律解决大数难题**。虽然题目看起来复杂，但只要把问题拆解为“坐标建模→边界分析→规律推导”三个步骤，就能逐步突破难点。  

记住：**几何问题的本质是“坐标”，大数问题的本质是“找规律”**。多练习坐标转换和公式推导，你会越来越擅长这类问题！💪  

下次我们再一起探索新的编程挑战！

---
处理用时：110.75秒
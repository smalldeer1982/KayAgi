# é¢˜ç›®ä¿¡æ¯

# [USACO20OPEN] Exercise P

## é¢˜ç›®æè¿°

Farmer Johnï¼ˆåˆï¼‰æƒ³åˆ°äº†ä¸€ä¸ªæ–°çš„å¥¶ç‰›æ™¨ç»ƒæ–¹æ¡ˆï¼  
å¦‚åŒä¹‹å‰ï¼ŒFarmer John çš„ $N$ å¤´å¥¶ç‰›ç«™æˆä¸€æ’ã€‚å¯¹äº $1\le i\le N$ çš„æ¯ä¸€ä¸ª $i$ï¼Œä»å·¦å¾€å³ç¬¬ $i$ å¤´å¥¶ç‰›çš„ç¼–å·ä¸º $i$ã€‚ä»–å‘Šè¯‰å¥¹ä»¬é‡å¤ä»¥ä¸‹æ­¥éª¤ï¼Œç›´åˆ°å¥¶ç‰›ä»¬ä¸å¥¹ä»¬å¼€å§‹æ—¶çš„é¡ºåºç›¸åŒã€‚

ç»™å®šé•¿ä¸º $N$ çš„ä¸€ä¸ªæ’åˆ— $A$ï¼Œå¥¶ç‰›ä»¬æ”¹å˜å¥¹ä»¬çš„é¡ºåºï¼Œä½¿å¾—åœ¨æ”¹å˜ä¹‹å‰ä»å·¦å¾€å³ç¬¬ $i$ å¤´å¥¶ç‰›åœ¨æ”¹å˜ä¹‹åä¸ºä»å·¦å¾€å³ç¬¬ $A_i$ å¤´ã€‚  
ä¾‹å¦‚ï¼Œå¦‚æœ $A=(1,2,3,4,5)$ï¼Œé‚£ä¹ˆå¥¶ç‰›ä»¬æ€»å…±è¿›è¡Œä¸€æ­¥å°±å›åˆ°äº†åŒæ ·çš„é¡ºåºã€‚å¦‚æœ $A=(2,3,1,5,4)$ï¼Œé‚£ä¹ˆå¥¶ç‰›ä»¬æ€»å…±è¿›è¡Œå…­æ­¥ä¹‹åå›åˆ°èµ·å§‹çš„é¡ºåºã€‚æ¯æ­¥ä¹‹åå¥¶ç‰›ä»¬ä»å·¦å¾€å³çš„é¡ºåºå¦‚ä¸‹ï¼š

0 æ­¥ï¼š$(1,2,3,4,5)$  
1 æ­¥ï¼š$(3,1,2,5,4)$  
2 æ­¥ï¼š$(2,3,1,4,5)$  
3 æ­¥ï¼š$(1,2,3,5,4)$  
4 æ­¥ï¼š$(3,1,2,4,5)$  
5 æ­¥ï¼š$(2,3,1,5,4)$  
6 æ­¥ï¼š$(1,2,3,4,5)$  
**è¯·ä½ è®¡ç®—å‡ºæ‰€æœ‰å¯èƒ½çš„ $N!$ ç§é•¿ä¸º $N$ çš„æ’åˆ— $A$ å›åˆ°èµ·å§‹é¡ºåºéœ€è¦çš„æ­¥æ•°çš„ä¹˜ç§¯ã€‚**

ç”±äºè¿™ä¸ªæ•°å­—å¯èƒ½éå¸¸å¤§ï¼Œè¾“å‡ºç­”æ¡ˆæ¨¡ $M$ çš„ä½™æ•°ï¼ˆ$10^8\le M\le 10^9+7$ï¼Œ$M$ æ˜¯è´¨æ•°ï¼‰ã€‚

-----

ä½¿ç”¨ C++ çš„é€‰æ‰‹å¯ä»¥ä½¿ç”¨ [KACTL](https://github.com/kth-competitive-programming/kactl/blob/master/content/various/FastMod.h) ä¸­çš„è¿™ä¸€ä»£ç ã€‚è¿™ä¸€åä¸º [Barrett æ¨¡ä¹˜](https://en.wikipedia.org/wiki/Barrett_reduction) çš„ç®—æ³•å¯ä»¥ä»¥æ¯”é€šå¸¸è®¡ç®—å¿«ä¸Šæ•°å€çš„é€Ÿåº¦è®¡ç®— $a \% b$ï¼Œå…¶ä¸­ $b>1$ ä¸ºä¸€ä¸ªç¼–è¯‘æ—¶æœªçŸ¥çš„å¸¸æ•°ã€‚ï¼ˆä¸å¹¸çš„æ˜¯ï¼Œæˆ‘ä»¬æ²¡æœ‰æ‰¾åˆ°å¯¹äº Java çš„è¿™æ ·çš„ä¼˜åŒ–ï¼‰ã€‚ï¼ˆè¯‘æ³¨ï¼šä¸­æ–‡é€‰æ‰‹å¯ä»¥å‚è€ƒ å‡ ç§å–æ¨¡ä¼˜åŒ–æ–¹æ³•[ï¼ˆè¯‘è‡ª min-25 çš„åšå®¢ï¼‰](https://loj.ac/article/327)ï¼‰
```cpp
#include <bits/stdc++.h>
using namespace std;

typedef unsigned long long ull;
typedef __uint128_t L;
struct FastMod {
    ull b, m;
    FastMod(ull b) : b(b), m(ull((L(1) << 64) / b)) {}
    ull reduce(ull a) {
        ull q = (ull)((L(m) * a) >> 64);
        ull r = a - q * b; // can be proven that 0 <= r < 2*b
        return r >= b ? r - b : r;
    }
};
FastMod F(2);

int main() {
    int M = 1000000007; F = FastMod(M);
    ull x = 10ULL*M+3; 
    cout << x << " " << F.reduce(x) << "\n"; // 10000000073 3
}
```

## è¯´æ˜/æç¤º

#### æ ·ä¾‹è§£é‡Šï¼š
å¯¹äºæ¯ä¸€ä¸ª $1\le i\le N$ï¼Œä»¥ä¸‹åºåˆ—çš„ç¬¬ $i$ ä¸ªå…ƒç´ ç­‰äºå¥¶ç‰›éœ€è¦ä½¿ç”¨ $i$ æ­¥çš„æ’åˆ—æ•°é‡ï¼š$[1,25,20,30,24,20]$ã€‚æ‰€ä»¥ç­”æ¡ˆç­‰äº $1^1\cdot 2^{25}\cdot 3^{20}\cdot 4^{30}\cdot 5^{24}\cdot 6^{20}\equiv 369329541\pmod{10^9+7}$ã€‚

**æ³¨æ„ï¼šè¿™ä¸ªé—®é¢˜çš„å†…å­˜é™åˆ¶å¢åŠ ä¸º 512 MBã€‚**

---
å¯¹äº $100\%$ çš„æ•°æ®ï¼Œæ»¡è¶³ $1\le N\le 7500$ã€‚

å…± $16$ ä¸ªæµ‹è¯•ç‚¹ï¼Œå…¶ä¸­ $1$ ä¸ºæ ·ä¾‹ï¼Œå…¶ä½™æ€§è´¨å¦‚ä¸‹ï¼š

æµ‹è¯•ç‚¹  $2$ æ»¡è¶³ $N=8$ã€‚  
æµ‹è¯•ç‚¹ $3\sim 5$ æ»¡è¶³ $N\le 50$ã€‚  
æµ‹è¯•ç‚¹ $6\sim 8$ æ»¡è¶³ $N\le 500$ã€‚  
æµ‹è¯•ç‚¹ $9\sim 12$ æ»¡è¶³ $N\le 3000$ã€‚  
æµ‹è¯•ç‚¹ $13\sim 16$ æ²¡æœ‰é¢å¤–é™åˆ¶ã€‚

----
  
å‡ºé¢˜äººï¼šBenjamin Qi

## æ ·ä¾‹ #1

### è¾“å…¥

```
5 1000000007```

### è¾“å‡º

```
369329541```

# AIåˆ†æç»“æœ

# ğŸ’¡ Kayçš„C++ç®—æ³•è§£æï¼š[USACO20OPEN] Exercise P æ·±å…¥å­¦ä¹ æŒ‡å— ğŸ’¡


## 1. é¢˜ç›®è§£è¯»ä¸æ ¸å¿ƒç®—æ³•è¯†åˆ«

âœ¨ **æœ¬é¢˜ä¸»è¦è€ƒå¯Ÿ**ï¼šæ•°è®ºï¼ˆè´¨å› æ•°åˆ†è§£ã€å®¹æ–¥åŸç†ï¼‰ + åŠ¨æ€è§„åˆ’ï¼ˆDPï¼‰ + ç½®æ¢ç¯è®¡æ•°


### ğŸ—£ï¸ åˆæ­¥åˆ†æ
æˆ‘ä»¬çš„ç›®æ ‡æ˜¯è®¡ç®—**æ‰€æœ‰nçš„æ’åˆ—çš„ç½®æ¢ç¯é•¿LCMçš„ä¹˜ç§¯**ã€‚ç½®æ¢çš„é˜¶ï¼ˆå³å›åˆ°åˆå§‹çŠ¶æ€çš„æ­¥æ•°ï¼‰æ˜¯å„ç¯é•¿çš„LCMï¼Œæ‰€ä»¥é—®é¢˜ç­‰ä»·äºæ±‚æ‰€æœ‰æ’åˆ—çš„ç¯é•¿LCMçš„ä¹˜ç§¯ã€‚

#### æ ¸å¿ƒç®—æ³•æ€è·¯
1. **è´¨å› æ•°åˆ†è§£æ‹†åˆ†è´¡çŒ®**ï¼šLCMçš„ä¹˜ç§¯å¯ä»¥æ‹†åˆ†ä¸ºæ¯ä¸ªè´¨æ•°çš„è´¡çŒ®ã€‚å¯¹äºè´¨æ•°pï¼Œå…¶æ€»è´¡çŒ®æ˜¯pçš„ï¼ˆæ‰€æœ‰åŒ…å«p^kçš„æ’åˆ—æ•°ä¹‹å’Œï¼‰æ¬¡æ–¹ï¼ˆkâ‰¥1ï¼Œp^kâ‰¤nï¼‰ã€‚
2. **å®¹æ–¥æ±‚è¡¥é›†**ï¼šç›´æ¥è®¡ç®—â€œåŒ…å«p^kå€æ•°ç¯é•¿çš„æ’åˆ—æ•°â€å›°éš¾ï¼Œè½¬è€Œæ±‚**è¡¥é›†**â€”â€”â€œæ‰€æœ‰ç¯é•¿éƒ½ä¸æ˜¯p^kå€æ•°çš„æ’åˆ—æ•°â€ï¼Œå†ç”¨æ€»æ’åˆ—æ•°n!å‡å»è¡¥é›†å¾—åˆ°ç›®æ ‡å€¼ã€‚
3. **DPè®¡ç®—è¡¥é›†**ï¼šç”¨DPåˆ†åˆ«è®¡ç®—ï¼š
   - `g[i]`ï¼šiä¸ªå…ƒç´ çš„æ’åˆ—ä¸­ï¼Œæ‰€æœ‰ç¯é•¿éƒ½æ˜¯p^kå€æ•°çš„æ–¹æ¡ˆæ•°ï¼ˆç”¨äºå®¹æ–¥ï¼‰ã€‚
   - `f[i]`ï¼šiä¸ªå…ƒç´ çš„æ’åˆ—ä¸­ï¼Œæ‰€æœ‰ç¯é•¿éƒ½ä¸æ˜¯p^kå€æ•°çš„æ–¹æ¡ˆæ•°ï¼ˆè¡¥é›†ï¼‰ã€‚


### å¯è§†åŒ–è®¾è®¡æ€è·¯
æˆ‘ä»¬è®¾è®¡**åƒç´ é£æ ¼çš„â€œç½®æ¢ç¯æ¢é™©å®¶â€åŠ¨ç”»**ï¼Œç”¨8ä½åƒç´ å—è¡¨ç¤ºç½®æ¢ç¯ï¼š
- ç”¨ä¸åŒé¢œè‰²æ ‡è®°ç¯é•¿ï¼ˆä¾‹å¦‚è“è‰²è¡¨ç¤ºæ™®é€šç¯ï¼Œçº¢è‰²è¡¨ç¤ºp^kå€æ•°çš„ç¯ï¼‰ã€‚
- åŠ¨ç”»æ­¥éª¤ï¼š
  1. **åˆå§‹çŠ¶æ€**ï¼šæ‰€æœ‰åƒç´ å—ï¼ˆå…ƒç´ ï¼‰æ•£åˆ—ï¼ŒèƒŒæ™¯éŸ³ä¹ï¼ˆ8ä½é£ï¼‰å“èµ·ã€‚
  2. **ç¯å½¢æˆ**ï¼šé€æ­¥å°†å…ƒç´ ç»„åˆæˆç¯ï¼Œè“è‰²å—é—ªçƒè¡¨ç¤ºç¯å½¢æˆï¼Œä¼´éšâ€œå®â€çš„éŸ³æ•ˆã€‚
  3. **å®¹æ–¥è¿‡ç¨‹**ï¼šçº¢è‰²å—ï¼ˆp^kå€æ•°çš„ç¯ï¼‰å‡ºç°æ—¶ï¼Œç”¨â€œå‰å·â€æ ‡è®°å¹¶ç§»é™¤ï¼Œå±•ç¤ºâ€œæ’é™¤ä¸åˆæ³•ç¯â€çš„è¿‡ç¨‹ã€‚
  4. **ç»“æœç»Ÿè®¡**ï¼šæœ€åç»Ÿè®¡å‰©ä½™è“è‰²ç¯çš„æ•°é‡ï¼ˆè¡¥é›†ï¼‰ï¼Œè®¡ç®—ç›®æ ‡å€¼ï¼Œä¼´éšâ€œèƒœåˆ©â€éŸ³æ•ˆã€‚


## 2. ç²¾é€‰ä¼˜è´¨é¢˜è§£å‚è€ƒ

### é¢˜è§£ä¸€ï¼šorangejuiceï¼ˆæ€è·¯æ¸…æ™°+ä¼˜åŒ–æ¨å¯¼ï¼‰
**ç‚¹è¯„**ï¼šæ­¤é¢˜è§£ä»ç½®æ¢ç¯çš„æ€§è´¨å‡ºå‘ï¼Œé€æ­¥æ¨å¯¼è¡¥é›†çš„è®¡ç®—æ–¹æ³•ï¼Œå¹¶ç”¨æ»šåŠ¨æ•°ç»„ä¼˜åŒ–DPï¼Œé¿å…äº†é€†å…ƒè®¡ç®—ã€‚æ€è·¯ä¸¥è°¨ï¼Œå¯¹â€œç¯é•¿è®¡æ•°â€çš„å½’çº³æ¨å¯¼éå¸¸æ¸…æ™°ï¼Œä»£ç æ•ˆç‡é«˜ï¼Œé€‚åˆåˆå­¦è€…ç†è§£æ ¸å¿ƒé€»è¾‘ã€‚

### é¢˜è§£äºŒï¼šqwaszxï¼ˆç”Ÿæˆå‡½æ•°+ç»„åˆæ•°å­¦ï¼‰
**ç‚¹è¯„**ï¼šæ­¤é¢˜è§£ç”¨ç”Ÿæˆå‡½æ•°ï¼ˆEGFï¼‰æ¨å¯¼ç½®æ¢ç¯çš„è®¡æ•°ï¼Œç»“åˆå¹¿ä¹‰äºŒé¡¹å¼å®šç†ï¼Œå°†é—®é¢˜è½¬åŒ–ä¸ºå¹‚çº§æ•°å±•å¼€ã€‚æ¨å¯¼è¿‡ç¨‹ä¸¥è°¨ï¼Œé€‚åˆè¿›é˜¶å­¦ä¹ è€…ç†è§£â€œç»„åˆè®¡æ•°ä¸ç”Ÿæˆå‡½æ•°â€çš„è”ç³»ï¼Œä»£ç ä¸­ä½¿ç”¨çº¿æ®µæ ‘ä¼˜åŒ–åŒºé—´ä¹˜ç§¯ï¼Œæ•ˆç‡æé«˜ã€‚

### é¢˜è§£ä¸‰ï¼šcff_0102ï¼ˆDPè½¬ç§»è¯¦ç»†+ä»£ç è§„èŒƒï¼‰
**ç‚¹è¯„**ï¼šæ­¤é¢˜è§£è¯¦ç»†è§£é‡Šäº†`g`æ•°ç»„ï¼ˆå…¨ä¸ºp^kå€æ•°ç¯çš„æ–¹æ¡ˆæ•°ï¼‰å’Œ`f`æ•°ç»„ï¼ˆå…¨ä¸ä¸ºp^kå€æ•°ç¯çš„æ–¹æ¡ˆæ•°ï¼‰çš„è½¬ç§»æ–¹ç¨‹ï¼Œä»£ç ç»“æ„æ¸…æ™°ï¼Œå˜é‡å‘½åè§„èŒƒï¼Œæ³¨é‡Šè¯¦ç»†ï¼Œé€‚åˆåˆå­¦è€…æ¨¡ä»¿å®ç°ã€‚

### é¢˜è§£å››ï¼šEndSaHï¼ˆä»£ç ç®€æ´+è¾¹ç•Œå¤„ç†ï¼‰
**ç‚¹è¯„**ï¼šæ­¤é¢˜è§£ä»£ç ç®€æ´ï¼Œé‡ç‚¹å¤„ç†äº†æ¨¡æ•°M-1çš„è¾¹ç•Œé—®é¢˜ï¼ˆå› ä¸ºæŒ‡æ•°è¦æ¨¡Ï†(M)=M-1ï¼‰ï¼Œå¹¶ä½¿ç”¨å¿«é€Ÿå–æ¨¡ä¼˜åŒ–ã€‚ä»£ç ä¸­çš„`Dec`å‡½æ•°å’Œ`Reduce`å‡½æ•°æœ‰æ•ˆé¿å…äº†æº¢å‡ºï¼Œé€‚åˆå­¦ä¹ â€œæ¨¡æ•°å¤„ç†â€æŠ€å·§ã€‚

### é¢˜è§£äº”ï¼šDaiRuiChen007ï¼ˆæ ¸å¿ƒé€»è¾‘æµ“ç¼©+æ˜“è¯»æ€§ï¼‰
**ç‚¹è¯„**ï¼šæ­¤é¢˜è§£å°†æ ¸å¿ƒé€»è¾‘æµ“ç¼©ä¸º`g`å’Œ`f`çš„DPè½¬ç§»ï¼Œä»£ç è¡Œæ•°å°‘ä½†é€»è¾‘å®Œæ•´ã€‚å¯¹â€œç½®æ¢ç¯è®¡æ•°â€çš„ç»å…¸å…¬å¼ï¼ˆæšä¸¾ç¯é•¿+ç»„åˆæ•°ï¼‰åº”ç”¨å¨´ç†Ÿï¼Œé€‚åˆå¿«é€Ÿç†è§£é—®é¢˜çš„æ ¸å¿ƒæ¡†æ¶ã€‚


## 3. æ ¸å¿ƒéš¾ç‚¹è¾¨æä¸è§£é¢˜ç­–ç•¥

### å…³é”®ç‚¹1ï¼šLCMä¹˜ç§¯è½¬è´¨æ•°å¹‚è´¡çŒ®
**éš¾ç‚¹**ï¼šç›´æ¥è®¡ç®—LCMçš„ä¹˜ç§¯æ— æ³•ä¸‹æ‰‹ï¼Œå› ä¸ºLCMæ˜¯å¤šä¸ªæ•°çš„æœ€å°å…¬å€æ•°ï¼Œéš¾ä»¥ç›´æ¥è®¡æ•°ã€‚  
**ç­–ç•¥**ï¼šåˆ©ç”¨æ•°è®ºåŸºæœ¬å®šç†ï¼Œå°†LCMçš„ä¹˜ç§¯æ‹†åˆ†ä¸ºæ¯ä¸ªè´¨æ•°çš„è´¡çŒ®ã€‚å¯¹äºè´¨æ•°pï¼Œå…¶è´¡çŒ®æ¥è‡ªæ‰€æœ‰p^kï¼ˆkâ‰¥1ï¼‰ï¼Œæ¯ä¸ªp^kçš„è´¡çŒ®æ˜¯â€œåŒ…å«p^kå€æ•°ç¯é•¿çš„æ’åˆ—æ•°â€ã€‚


### å…³é”®ç‚¹2ï¼šè¡¥é›†çš„DPè®¡ç®—
**éš¾ç‚¹**ï¼šè®¡ç®—â€œæ‰€æœ‰ç¯é•¿éƒ½ä¸æ˜¯p^kå€æ•°çš„æ’åˆ—æ•°â€ï¼ˆè¡¥é›†ï¼‰éœ€è¦å¤„ç†â€œç¯çš„ç»„åˆâ€ï¼Œé¿å…é‡å¤è®¡æ•°ã€‚  
**ç­–ç•¥**ï¼š
1. **`g[i]`ï¼ˆå…¨ä¸ºp^kå€æ•°ç¯çš„æ–¹æ¡ˆæ•°ï¼‰**ï¼šæšä¸¾iæ‰€åœ¨ç¯çš„é•¿åº¦ï¼ˆp^kçš„å€æ•°ï¼‰ï¼Œç”¨ç»„åˆæ•°`C(i-1,j-1)`é€‰ç¯å†…å…ƒç´ ï¼Œä¹˜ç¯æ’åˆ—æ•°`(j-1)!`ï¼ˆåœ†æ’åˆ—ï¼‰ï¼Œå†é€’å½’è®¡ç®—å‰©ä½™i-jçš„æ–¹æ¡ˆæ•°ã€‚
2. **`f[i]`ï¼ˆå…¨ä¸ä¸ºp^kå€æ•°çš„æ–¹æ¡ˆæ•°ï¼‰**ï¼šç”¨æ€»æ’åˆ—æ•°i!å‡å»â€œåŒ…å«è‡³å°‘ä¸€ä¸ªp^kå€æ•°ç¯çš„æ–¹æ¡ˆæ•°â€ï¼Œé€šè¿‡å®¹æ–¥æšä¸¾p^kå€æ•°çš„ç¯é•¿ä¹‹å’Œjï¼Œä¹˜`C(i,j)`é€‰å…ƒç´ ï¼Œå†ä¹˜`g[j]`ï¼ˆjä¸ªå…ƒç´ å…¨ä¸ºp^kå€æ•°ç¯çš„æ–¹æ¡ˆæ•°ï¼‰å’Œ`f[i-j]`ï¼ˆå‰©ä½™i-jä¸ªå…ƒç´ å…¨ä¸ä¸ºp^kå€æ•°ç¯çš„æ–¹æ¡ˆæ•°ï¼‰ã€‚


### å…³é”®ç‚¹3ï¼šæ¨¡æ•°M-1çš„å¤„ç†
**éš¾ç‚¹**ï¼šå› ä¸ºç­”æ¡ˆæ˜¯`p^e mod M`ï¼ˆMæ˜¯è´¨æ•°ï¼‰ï¼Œæ ¹æ®è´¹é©¬å°å®šç†ï¼ŒæŒ‡æ•°eéœ€è¦æ¨¡`Ï†(M)=M-1`ï¼Œè€ŒM-1å¯èƒ½æ˜¯åˆæ•°ï¼Œå¤„ç†æ—¶éœ€é¿å…é€†å…ƒé”™è¯¯ã€‚  
**ç­–ç•¥**ï¼šæ‰€æœ‰æ¶‰åŠæŒ‡æ•°çš„è®¡ç®—ï¼ˆå¦‚`g`å’Œ`f`çš„è½¬ç§»ï¼‰éƒ½æ¨¡M-1ï¼Œä½¿ç”¨å¿«é€Ÿå–æ¨¡ï¼ˆå¦‚Barrettæ¨¡ä¹˜ï¼‰é¿å…æº¢å‡ºï¼Œç¡®ä¿è®¡ç®—æ­£ç¡®ã€‚


### âœ¨ è§£é¢˜æŠ€å·§æ€»ç»“
- **æ‹†åˆ†é—®é¢˜**ï¼šå°†å¤æ‚çš„LCMä¹˜ç§¯æ‹†åˆ†ä¸ºè´¨æ•°å¹‚çš„è´¡çŒ®ï¼ŒåŒ–æ•´ä¸ºé›¶ã€‚
- **æ­£éš¾åˆ™å**ï¼šç”¨è¡¥é›†è®¡ç®—â€œåŒ…å«è‡³å°‘ä¸€ä¸ªp^kå€æ•°ç¯çš„æ’åˆ—æ•°â€ï¼Œç®€åŒ–è®¡æ•°ã€‚
- **åŠ¨æ€è§„åˆ’**ï¼šç”¨DPå¤„ç†ç¯çš„ç»„åˆé—®é¢˜ï¼Œé¿å…é‡å¤è®¡ç®—ã€‚
- **æ¨¡æ•°å¤„ç†**ï¼šæŒ‡æ•°æ¨¡M-1ï¼Œä½¿ç”¨å¿«é€Ÿå–æ¨¡ä¼˜åŒ–è®¡ç®—ã€‚


## 4. C++æ ¸å¿ƒä»£ç å®ç°èµæ

### æœ¬é¢˜é€šç”¨æ ¸å¿ƒC++å®ç°å‚è€ƒ
**è¯´æ˜**ï¼šç»¼åˆorangejuiceã€cff_0102å’ŒDaiRuiChen007çš„æ€è·¯ï¼Œæä¾›ä¸€ä¸ªæ¸…æ™°çš„æ ¸å¿ƒå®ç°ã€‚

```cpp
#include <iostream>
#include <vector>
#include <cstring>
using namespace std;

typedef long long ll;
const int N = 7510;

int n, mod, mod_phi; // mod_phi = mod - 1ï¼ˆmodæ˜¯è´¨æ•°ï¼‰
ll C[N][N], fac[N];
bool vis[N]; // æ ‡è®°éè´¨æ•°

// Barrettæ¨¡ä¹˜ä¼˜åŒ–
struct FastMod {
    ll b, m;
    FastMod(ll b) : b(b), m((ll)((__int128)1 << 64) / b) {}
    ll reduce(ll a) {
        ll q = (ll)((__int128)m * a >> 64);
        ll r = a - q * b;
        return r >= b ? r - b : r;
    }
} F(2);

ll qpow(ll x, ll y) {
    ll res = 1;
    while (y) {
        if (y & 1) res = F.reduce(res * x);
        x = F.reduce(x * x);
        y >>= 1;
    }
    return res;
}

void init() {
    // é¢„å¤„ç†ç»„åˆæ•°C[i][j] mod mod_phi
    C[0][0] = 1;
    for (int i = 1; i <= n; ++i) {
        C[i][0] = 1;
        for (int j = 1; j <= i; ++j) {
            C[i][j] = F.reduce(C[i-1][j-1] + C[i-1][j]);
        }
    }
    // é¢„å¤„ç†é˜¶ä¹˜fac[i] = i! mod mod_phi
    fac[0] = 1;
    for (int i = 1; i <= n; ++i) {
        fac[i] = F.reduce(fac[i-1] * i);
    }
}

ll calc(int x) {
    vector<ll> g(n+1, 0), f(n+1, 0);
    g[0] = 1;
    // è®¡ç®—g[i]ï¼šiä¸ªå…ƒç´ å…¨ä¸ºxå€æ•°ç¯çš„æ–¹æ¡ˆæ•°
    for (int i = x; i <= n; i += x) {
        for (int j = x; j <= i; j += x) {
            // ç»„åˆæ•°C(i-1, j-1) * (j-1)! * g[i-j]
            ll term = F.reduce(C[i-1][j-1] * fac[j-1]);
            term = F.reduce(term * g[i-j]);
            g[i] = F.reduce(g[i] + term);
        }
    }
    // è®¡ç®—f[i]ï¼šiä¸ªå…ƒç´ å…¨ä¸ä¸ºxå€æ•°ç¯çš„æ–¹æ¡ˆæ•°
    f[0] = 1;
    for (int i = n % x; i <= n; i += x) {
        f[i] = fac[i];
        for (int j = x; j <= i; j += x) {
            // å®¹æ–¥ï¼šå‡å»é€‰jä¸ªå…ƒç´ ä¸ºxå€æ•°ç¯çš„æ–¹æ¡ˆæ•°
            ll term = F.reduce(C[i][j] * g[j]);
            term = F.reduce(term * f[i-j]);
            f[i] = F.reduce(f[i] - term + mod_phi); // é¿å…è´Ÿæ•°
        }
    }
    // åŒ…å«è‡³å°‘ä¸€ä¸ªxå€æ•°ç¯çš„æ’åˆ—æ•° = n! - f[n]
    return F.reduce(fac[n] - f[n] + mod_phi);
}

int main() {
    cin >> n >> mod;
    mod_phi = mod - 1;
    F = FastMod(mod_phi);
    init();

    ll ans = 1;
    // æšä¸¾æ‰€æœ‰è´¨æ•°p
    for (int p = 2; p <= n; ++p) {
        if (vis[p]) continue;
        // æ ‡è®°pçš„å€æ•°ä¸ºéè´¨æ•°
        for (int j = p*2; j <= n; j += p) vis[j] = true;
        // æšä¸¾pçš„å¹‚æ¬¡p^k
        int x = p;
        while (x <= n) {
            ll cnt = calc(x);
            ans = F.reduce(ans * qpow(p, cnt));
            if ((ll)x * p > n) break;
            x *= p;
        }
    }
    // æœ€åæ¨¡modï¼ˆå› ä¸ºä¹‹å‰çš„æŒ‡æ•°æ¨¡çš„æ˜¯mod_phiï¼‰
    ans %= mod;
    cout << ans << endl;
    return 0;
}
```

**ä»£ç è§£è¯»æ¦‚è¦**ï¼š
1. **é¢„å¤„ç†**ï¼šè®¡ç®—ç»„åˆæ•°`C[i][j]`å’Œé˜¶ä¹˜`fac[i]`ï¼Œæ¨¡`mod_phi`ï¼ˆå³M-1ï¼‰ã€‚
2. **`calc(x)`å‡½æ•°**ï¼šè®¡ç®—åŒ…å«è‡³å°‘ä¸€ä¸ªxå€æ•°ç¯é•¿çš„æ’åˆ—æ•°ï¼Œè¿”å›å€¼ä¸ºæŒ‡æ•°éƒ¨åˆ†ï¼ˆæ¨¡`mod_phi`ï¼‰ã€‚
3. **ä¸»å‡½æ•°**ï¼šæšä¸¾æ‰€æœ‰è´¨æ•°påŠå…¶å¹‚æ¬¡p^kï¼Œè°ƒç”¨`calc`è®¡ç®—è´¡çŒ®ï¼Œæœ€åè¾“å‡ºç­”æ¡ˆã€‚


### é¢˜è§£ä¸€ï¼ˆorangejuiceï¼‰ï¼šæ»šåŠ¨æ•°ç»„ä¼˜åŒ–
**äº®ç‚¹**ï¼šç”¨æ»šåŠ¨æ•°ç»„ä¼˜åŒ–`g`å’Œ`f`çš„è®¡ç®—ï¼Œé¿å…é‡å¤è®¡ç®—é˜¶ä¹˜é€†å…ƒã€‚
**æ ¸å¿ƒä»£ç ç‰‡æ®µ**ï¼š
```cpp
rep(x,2,n) {
    rep(j,1,n-x+1) T[j]=1ll*T[j]*(j+x-2)%P2; // æ»šåŠ¨è®¡ç®—åŒºé—´ä¹˜ç§¯
    if(mk[x]<=1) continue;
    dp[0]=1,s[0]=1;
    int sum=1;
    rep(i,1,n) {
        s[i]=0;
        if(i>=x) s[i]=1ll*s[i-x]*T[i-x+1]%P2;
        dp[i]=sum-s[i]; Mod2(dp[i]);
        s[i]=(1ll*s[i]*i+dp[i])%P2;
        sum=(1ll*sum*i+dp[i])%P2;
    }
    ans=1ll*ans*qpow(mk[x],P2+r-dp[n])%P;
}
```
**ä»£ç è§£è¯»**ï¼š
- `T[j]`æ˜¯æ»šåŠ¨æ•°ç»„ï¼Œå­˜å‚¨åŒºé—´ä¹˜ç§¯ï¼Œé¿å…é‡å¤è®¡ç®—ã€‚
- `dp[i]`è¡¨ç¤ºiä¸ªå…ƒç´ å…¨ä¸ä¸ºxå€æ•°ç¯çš„æ–¹æ¡ˆæ•°ï¼Œ`s[i]`æ˜¯å‰ç¼€å’Œä¼˜åŒ–ï¼Œå‡å°‘è½¬ç§»æ—¶é—´ã€‚
- ç”¨`sum`ç»´æŠ¤å‰ç¼€å’Œï¼Œé¿å…æ¯æ¬¡æšä¸¾jï¼Œä¼˜åŒ–æ—¶é—´å¤æ‚åº¦ã€‚


### é¢˜è§£äºŒï¼ˆqwaszxï¼‰ï¼šç”Ÿæˆå‡½æ•°ä¸çº¿æ®µæ ‘
**äº®ç‚¹**ï¼šç”¨ç”Ÿæˆå‡½æ•°æ¨å¯¼ç½®æ¢ç¯çš„è®¡æ•°ï¼Œå¹¶ç”¨çº¿æ®µæ ‘ä¼˜åŒ–åŒºé—´ä¹˜ç§¯æŸ¥è¯¢ã€‚
**æ ¸å¿ƒä»£ç ç‰‡æ®µ**ï¼š
```cpp
struct Tree {
    int s[N<<2],bit;
    void Build() {
        for(bit=1;bit<=n;bit<<=1);
        rep(i,1,n) s[i+bit]=i;
        for(int i=bit;i>=1;--i) s[i]=1ll*s[i<<1]*s[i<<1|1]%P2;
    }
    int Que(int l,int r){
        if(l>r) return 1;
        int res=1;
        for(l+=bit-1,r+=bit+1;l^r^1;l>>=1,r>>=1){
            if(~l&1) res=1ll*res*s[l^1]%P2;
            if(r&1) res=1ll*res*s[r^1]%P2;
        }
        return res;
    }
} T;
```
**ä»£ç è§£è¯»**ï¼š
- çº¿æ®µæ ‘`Tree`é¢„å¤„ç†åŒºé—´ä¹˜ç§¯ï¼Œæ”¯æŒå¿«é€ŸæŸ¥è¯¢ä»»æ„åŒºé—´çš„ä¹˜ç§¯ï¼ˆæ¨¡`P2`å³`mod_phi`ï¼‰ã€‚
- `Build`å‡½æ•°åˆå§‹åŒ–çº¿æ®µæ ‘ï¼Œ`Que`å‡½æ•°æŸ¥è¯¢åŒºé—´[l,r]çš„ä¹˜ç§¯ï¼Œä¼˜åŒ–`calc`å‡½æ•°ä¸­çš„åŒºé—´ä¹˜ç§¯è®¡ç®—ã€‚


### é¢˜è§£ä¸‰ï¼ˆcff_0102ï¼‰ï¼š`g`å’Œ`f`çš„è½¬ç§»
**äº®ç‚¹**ï¼šè¯¦ç»†è§£é‡Š`g`å’Œ`f`çš„è½¬ç§»æ–¹ç¨‹ï¼Œä»£ç ç»“æ„æ¸…æ™°ã€‚
**æ ¸å¿ƒä»£ç ç‰‡æ®µ**ï¼š
```cpp
int dp(int x){
    g[0]=f[0]=1;
    for(int i=x;i<=n;i+=x){
        g[i]=0;
        for(int j=x;j<=i;j+=x){
            g[i]=F.r(g[i]+F.r(C[i-1][j-1]*F.r(jc[j-1]*g[i-j])));
        }
    }
    for(int i=n%x;i<=n;i+=x){
        f[i]=jc[i];
        for(int j=x;j<=i;j+=x){
            f[i]=F.r(f[i]+mod-1-F.r(C[i][j]*F.r(g[j]*f[i-j])));
        }
    }
    return F.r(jc[n]+mod-1-f[n]);
}
```
**ä»£ç è§£è¯»**ï¼š
- `g[i]`çš„è½¬ç§»ï¼šæšä¸¾iæ‰€åœ¨ç¯çš„é•¿åº¦jï¼ˆxçš„å€æ•°ï¼‰ï¼Œä¹˜ç»„åˆæ•°`C[i-1][j-1]`ã€ç¯æ’åˆ—æ•°`jc[j-1]`ï¼ˆå³`(j-1)!`ï¼‰ï¼Œå†ä¹˜å‰©ä½™i-jçš„`g[i-j]`ã€‚
- `f[i]`çš„è½¬ç§»ï¼šç”¨æ€»æ’åˆ—æ•°`jc[i]`å‡å»å®¹æ–¥é¡¹ï¼Œå®¹æ–¥é¡¹æ˜¯é€‰jä¸ªå…ƒç´ ä¸ºxå€æ•°ç¯çš„æ–¹æ¡ˆæ•°ï¼ˆ`C[i][j]*g[j]*f[i-j]`ï¼‰ã€‚


## 5. ç®—æ³•å¯è§†åŒ–ï¼šåƒç´ åŠ¨ç”»æ¼”ç¤º

### åŠ¨ç”»ä¸»é¢˜ï¼šç½®æ¢ç¯æ¢é™©å®¶
**è®¾è®¡æ€è·¯**ï¼šç”¨8ä½åƒç´ é£æ¨¡æ‹Ÿç½®æ¢ç¯çš„å½¢æˆè¿‡ç¨‹ï¼Œç»“åˆå®¹æ–¥åŸç†å±•ç¤ºâ€œæ’é™¤ä¸åˆæ³•ç¯â€çš„è¿‡ç¨‹ï¼Œå¢å¼ºå­¦ä¹ è¶£å‘³æ€§ã€‚


### åŠ¨ç”»å¸§æ­¥éª¤
1. **åœºæ™¯åˆå§‹åŒ–**ï¼š
   - å±å¹•å·¦ä¾§æ˜¯åƒç´ åŒ–çš„å…ƒç´ ç½‘æ ¼ï¼ˆ1~nçš„å…ƒç´ ï¼Œç”¨ç™½è‰²æ–¹å—è¡¨ç¤ºï¼‰ã€‚
   - å³ä¾§æ˜¯æ§åˆ¶é¢æ¿ï¼š`å¼€å§‹/æš‚åœ`ã€`å•æ­¥æ‰§è¡Œ`ã€`é‡ç½®`æŒ‰é’®ï¼Œé€Ÿåº¦æ»‘å—ï¼Œä»¥åŠ`è´¨æ•°é€‰æ‹©`ä¸‹æ‹‰æ¡†ï¼ˆé€‰æ‹©å½“å‰æ¼”ç¤ºçš„è´¨æ•°pï¼‰ã€‚
   - åº•éƒ¨æ˜¯ä¿¡æ¯æ ï¼šæ˜¾ç¤ºå½“å‰è´¨æ•°pã€å¹‚æ¬¡p^kã€å‰©ä½™å…ƒç´ æ•°ã€è¡¥é›†æ–¹æ¡ˆæ•°ã€‚
   - èƒŒæ™¯éŸ³ä¹ï¼š8ä½é£çš„è½»å¿«æ—‹å¾‹ï¼ˆå¦‚ã€Šè¶…çº§é©¬é‡Œå¥¥ã€‹çš„èƒŒæ™¯éŸ³ä¹ï¼‰ã€‚

2. **è´¨æ•°é€‰æ‹©**ï¼š
   - ç”¨æˆ·é€‰æ‹©ä¸€ä¸ªè´¨æ•°pï¼ˆå¦‚p=2ï¼‰ï¼ŒåŠ¨ç”»æ˜¾ç¤ºâ€œå½“å‰æ¼”ç¤ºï¼šè´¨æ•°2çš„è´¡çŒ®â€ã€‚
   - å¹‚æ¬¡p^kä»2å¼€å§‹ï¼ˆk=1ï¼‰ï¼Œé€æ­¥å¢åŠ åˆ°p^kâ‰¤nã€‚

3. **ç¯å½¢æˆè¿‡ç¨‹**ï¼š
   - å…ƒç´ é€ä¸ªç»„åˆæˆç¯ï¼Œè“è‰²æ–¹å—è¡¨ç¤ºæ™®é€šç¯ï¼Œçº¢è‰²æ–¹å—è¡¨ç¤ºp^kå€æ•°çš„ç¯ã€‚
   - æ¯å½“å½¢æˆä¸€ä¸ªç¯ï¼Œä¼´éšâ€œå®â€çš„éŸ³æ•ˆï¼Œç¯å‘¨å›´é—ªçƒç»¿è‰²è¾¹æ¡†ï¼Œè¡¨ç¤ºç¯æœ‰æ•ˆã€‚

4. **å®¹æ–¥è¿‡ç¨‹**ï¼š
   - å½“å‡ºç°çº¢è‰²ç¯ï¼ˆp^kå€æ•°çš„ç¯ï¼‰æ—¶ï¼Œç¯å‘¨å›´é—ªçƒçº¢è‰²è¾¹æ¡†ï¼Œéšåæ¶ˆå¤±ï¼ˆè¡¨ç¤ºæ’é™¤è¯¥ç¯ï¼‰ã€‚
   - ä¿¡æ¯æ å®æ—¶æ›´æ–°è¡¥é›†æ–¹æ¡ˆæ•°ï¼ˆ`f[n]`ï¼‰å’ŒåŒ…å«è‡³å°‘ä¸€ä¸ªçº¢è‰²ç¯çš„æ–¹æ¡ˆæ•°ï¼ˆ`n! - f[n]`ï¼‰ã€‚

5. **ç»“æœå±•ç¤º**ï¼š
   - å½“æ‰€æœ‰å…ƒç´ å¤„ç†å®Œæ¯•ï¼Œä¿¡æ¯æ æ˜¾ç¤ºå½“å‰p^kçš„è´¡çŒ®ï¼ˆå³åŒ…å«è‡³å°‘ä¸€ä¸ªçº¢è‰²ç¯çš„æ–¹æ¡ˆæ•°ï¼‰ã€‚
   - ä¼´éšâ€œèƒœåˆ©â€éŸ³æ•ˆï¼Œå±å¹•ä¸­å¤®å¼¹å‡ºâ€œè´¨æ•°2çš„è´¡çŒ®è®¡ç®—å®Œæˆï¼â€çš„æç¤ºã€‚


### äº¤äº’è®¾è®¡
- **å•æ­¥æ‰§è¡Œ**ï¼šç”¨æˆ·ç‚¹å‡»â€œå•æ­¥â€æŒ‰é’®ï¼ŒåŠ¨ç”»æ‰§è¡Œä¸€æ­¥ç¯å½¢æˆæˆ–å®¹æ–¥æ“ä½œï¼Œä¾¿äºè§‚å¯Ÿç»†èŠ‚ã€‚
- **è‡ªåŠ¨æ’­æ”¾**ï¼šç”¨æˆ·æ‹–åŠ¨é€Ÿåº¦æ»‘å—è°ƒæ•´æ’­æ”¾é€Ÿåº¦ï¼ŒåŠ¨ç”»è‡ªåŠ¨æ‰§è¡Œæ‰€æœ‰æ­¥éª¤ã€‚
- **é‡ç½®**ï¼šç”¨æˆ·ç‚¹å‡»â€œé‡ç½®â€æŒ‰é’®ï¼ŒåŠ¨ç”»å›åˆ°åˆå§‹çŠ¶æ€ï¼Œå¯é‡æ–°é€‰æ‹©è´¨æ•°æ¼”ç¤ºã€‚


## 6. æ‹“å±•ç»ƒä¹ ä¸ç›¸ä¼¼é—®é¢˜

### ç›¸ä¼¼é—®é¢˜
1. **æ´›è°·P3403 è·³æ¥¼æœº**ï¼šè€ƒå¯Ÿæ•°è®ºä¸­çš„å®¹æ–¥åŸç†å’ŒDPï¼Œç±»ä¼¼æœ¬é¢˜çš„è¡¥é›†è®¡ç®—ã€‚
2. **æ´›è°·P4491 [HAOI2018] æŸ“è‰²**ï¼šè€ƒå¯Ÿç»„åˆè®¡æ•°å’Œå®¹æ–¥åŸç†ï¼Œéœ€è¦å¤„ç†â€œæ°å¥½kä¸ªé¢œè‰²â€çš„è®¡æ•°ã€‚
3. **æ´›è°·P5502 [JSOI2011] åˆ†ç‰¹äº§**ï¼šè€ƒå¯Ÿç»„åˆè®¡æ•°å’Œå®¹æ–¥åŸç†ï¼Œç±»ä¼¼æœ¬é¢˜çš„ç¯ç»„åˆé—®é¢˜ã€‚
4. **æ´›è°·P6078 [JSOI2015] æŸ“è‰²é—®é¢˜**ï¼šè€ƒå¯Ÿå®¹æ–¥åŸç†å’ŒåŠ¨æ€è§„åˆ’ï¼Œéœ€è¦å¤„ç†å¤šä¸ªé™åˆ¶æ¡ä»¶çš„è®¡æ•°ã€‚


## 7. å­¦ä¹ å¿ƒå¾—ä¸ç»éªŒåˆ†äº«
- **orangejuice**ï¼šåœ¨è®¡ç®—`g`å’Œ`f`æ—¶ï¼Œæ»šåŠ¨æ•°ç»„ä¼˜åŒ–å¯ä»¥å¤§å¹…å‡å°‘æ—¶é—´å¤æ‚åº¦ï¼Œé¿å…é‡å¤è®¡ç®—ã€‚
- **qwaszx**ï¼šç”Ÿæˆå‡½æ•°æ˜¯å¤„ç†ç»„åˆè®¡æ•°é—®é¢˜çš„æœ‰åŠ›å·¥å…·ï¼Œå°¤å…¶æ˜¯å½“é—®é¢˜æ¶‰åŠâ€œç¯â€æˆ–â€œæ’åˆ—â€æ—¶ã€‚
- **cff_0102**ï¼šç»„åˆæ•°å’Œé˜¶ä¹˜çš„é¢„å¤„ç†æ˜¯æ•°è®ºé—®é¢˜çš„åŸºç¡€ï¼Œä¸€å®šè¦æ³¨æ„æ¨¡æ•°çš„å¤„ç†ï¼ˆå°¤å…¶æ˜¯æŒ‡æ•°æ¨¡`mod_phi`ï¼‰ã€‚
- **EndSaH**ï¼šå¿«é€Ÿå–æ¨¡ï¼ˆå¦‚Barrettæ¨¡ä¹˜ï¼‰å¯ä»¥é¿å…æº¢å‡ºï¼Œæé«˜ä»£ç æ•ˆç‡ï¼Œå°¤å…¶æ˜¯åœ¨å¤§æ•°è®¡ç®—æ—¶ã€‚
- **DaiRuiChen007**ï¼šç½®æ¢ç¯çš„è®¡æ•°å…¬å¼ï¼ˆ`C(i-1,j-1)*(j-1)!`ï¼‰æ˜¯ç»å…¸ç»“è®ºï¼Œä¸€å®šè¦ç‰¢è®°å¹¶çµæ´»åº”ç”¨ã€‚


## æ€»ç»“
æœ¬æ¬¡åˆ†æçš„æ ¸å¿ƒæ˜¯**æ•°è®ºåˆ†è§£+å®¹æ–¥åŸç†+åŠ¨æ€è§„åˆ’**ï¼Œé€šè¿‡å°†å¤æ‚çš„LCMä¹˜ç§¯æ‹†åˆ†ä¸ºè´¨æ•°å¹‚çš„è´¡çŒ®ï¼Œåˆ©ç”¨è¡¥é›†å’ŒDPè®¡ç®—åˆæ³•æ’åˆ—æ•°ï¼Œæœ€ç»ˆå¾—åˆ°ç­”æ¡ˆã€‚å¸Œæœ›è¿™ä»½æŒ‡å—èƒ½å¸®åŠ©ä½ ç†è§£ç½®æ¢ç¯è®¡æ•°çš„ç»å…¸å¥—è·¯ï¼ŒæŒæ¡æ•°è®ºé—®é¢˜çš„æ ¸å¿ƒæŠ€å·§ã€‚è®°ä½ï¼Œç¼–ç¨‹çš„æå‡åœ¨äº**å¤šæ€è€ƒã€å¤šæ¨¡ä»¿ã€å¤šå®è·µ**ï¼Œä¸‹æ¬¡æˆ‘ä»¬å†ä¸€èµ·æ¢ç´¢æ–°çš„æŒ‘æˆ˜ï¼ğŸ’ª

---
å¤„ç†ç”¨æ—¶ï¼š115.28ç§’
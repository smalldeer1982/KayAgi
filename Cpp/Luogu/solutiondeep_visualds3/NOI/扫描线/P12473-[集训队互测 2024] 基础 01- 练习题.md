# é¢˜ç›®ä¿¡æ¯

# [é›†è®­é˜Ÿäº’æµ‹ 2024] åŸºç¡€ 01? ç»ƒä¹ é¢˜

## é¢˜ç›®æè¿°

ä¸‹æ ‡ä» $0$ å¼€å§‹çš„ $\texttt{01}$ æ— ç©·åºåˆ— $P$ ç”±å¦‚ä¸‹æ–¹å¼ç”Ÿæˆï¼š

- $P_0=\texttt{0}$ï¼›
- $P_{2n}=P_{n}$ï¼›
- $P_{2n+1}=\texttt{1}-P_{n}$ã€‚

è¿™é‡Œç»™å‡º $P$ åºåˆ—çš„å‰è‹¥å¹²é¡¹ï¼š

$$
\texttt{01101001100101101001011001101001}\cdots
$$

æ–¹ä¾¿èµ·è§ï¼Œæ¥ä¸‹æ¥å°† $P$ çœ‹åšä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œä¸”å­—ç¬¦ä¸²çš„ä¸‹æ ‡å‡ä» $0$ å¼€å§‹ã€‚

å®šä¹‰ $f(S)$ è¡¨ç¤ºæœ‰é™ $\texttt{01}$ ä¸² $S$ æ˜¯å¦ä¸º $P$ çš„å­ä¸²ï¼Œè‹¥æ˜¯ï¼Œåˆ™ $f(S)=1$ï¼Œå¦åˆ™ä¸º $0$ã€‚

å®šä¹‰ $g(S)$ è¡¨ç¤ºæœ‰é™ $\texttt{01}$ ä¸² $S$ ä¸­ã€æ˜¯ $P$ çš„å­ä¸²ã€‘çš„å­ä¸²ä¸ªæ•°ï¼Œå³ï¼š

$$
g(S)=\sum_{0\le l \le r < |S|}f(S_lS_{l+1}\cdots S_r)
$$

æ¥ä¸‹æ¥å®šä¹‰ $h(S)$ï¼šå¯¹äºä¸€ä¸ªä»…åŒ…å« $\texttt{0,1,?}$ çš„æœ‰é™å­—ç¬¦ä¸² $S$ ä¸­ï¼Œå°† $S$ ä¸­ $\texttt{?}$ å„è‡ªæ›¿æ¢æˆ $\texttt{0}$ æˆ– $\texttt{1}$ï¼Œåˆ™ $h(S)$ è¡¨ç¤ºæ‰€æœ‰å¯èƒ½ç”Ÿæˆçš„ $\texttt{01}$ ä¸² $T$ çš„ $g(T)$ ä¹‹å’Œã€‚

ç»™å®šé•¿åº¦ä¸º $n$ çš„ä»…åŒ…å« $\texttt{0,1,?}$ çš„å­—ç¬¦ä¸² $S$ï¼Œæœ‰ $m$ æ¬¡è¯¢é—®ï¼Œæ¯æ¬¡è¯¢é—®ç»™å‡º $l,r$ï¼Œæ±‚å‡º $h(S_lS_{l+1}\cdots S_r)$ çš„å€¼ã€‚

ç”±äºç­”æ¡ˆå¯èƒ½å¾ˆå¤§ï¼Œæ‰€ä»¥è¾“å‡ºç­”æ¡ˆå¯¹ $998244353$ å–æ¨¡çš„ç»“æœã€‚

## è¯´æ˜/æç¤º

### æ ·ä¾‹ 2

è§ä¸‹å‘æ–‡ä»¶ï¼Œæ»¡è¶³ $n,m \le 15$ å’Œç‰¹æ®Šæ€§è´¨ Cã€‚

### æ ·ä¾‹ 3

è§ä¸‹å‘æ–‡ä»¶ï¼Œæ»¡è¶³ $n,m \le 100$ å’Œç‰¹æ®Šæ€§è´¨ Bã€‚

### æ ·ä¾‹ 4

è§ä¸‹å‘æ–‡ä»¶ï¼Œæ»¡è¶³ $n,m \le 10^3$ å’Œç‰¹æ®Šæ€§è´¨ BCã€‚

### æ ·ä¾‹ 5

è§ä¸‹å‘æ–‡ä»¶ï¼Œæ»¡è¶³ $n,m \le 10^3$ å’Œç‰¹æ®Šæ€§è´¨ Aã€‚

## æ•°æ®èŒƒå›´

å¯¹äº $100\%$ çš„æ•°æ®ï¼Œ$1\le n \le 5\times 10^4$ï¼Œ$1\le m \le 2\times 10^5$ï¼Œ$0\le l_1\le r_1 < n$ï¼Œ$0\le l_2\le r_2 < n$ã€‚

| å­ä»»åŠ¡ | $n\le$         | $m\le$         | ç‰¹æ®Šæ€§è´¨ | åˆ†å€¼ |
| ----------- | -------------- | -------------- | -------- | ---- |
| 1           | $15$           | $15$           | A       | 10   |
| 2           | $20$           | $2\times 10^5$ | æ—        | 10   |
| 3           | $5\times 10^4$ | $2\times 10^5$ | A        | 5    |
| 4           | $5\times 10^4$ | $1$            | BC       | 5    |
| 5           | $5\times 10^4$ | $1$            | C        | 15   |
| 6           | $500$          | $10^3$         | B        | 5    |
| 7           | $10^3$         | $2\times 10^3$ | BC        | 5    |
| 8           | $5\times 10^3$ | $10^5$         | C       | 10   |
| 9           | $2\times 10^4$ | $10^5$         | æ—        | 15   |
| 10          | $5\times 10^4$ | $2\times 10^5$ | æ—        | 20   |

ç‰¹æ®Šæ€§è´¨ Aï¼š$r-l+1 \le 15$ï¼›

ç‰¹æ®Šæ€§è´¨ Bï¼š$S$ ä¸­ $\texttt{?}$ çš„ä¸ªæ•°ä¸è¶…è¿‡ $8$ï¼›

ç‰¹æ®Šæ€§è´¨ Cï¼š$l=0$ã€‚

## æ ·ä¾‹ #1

### è¾“å…¥

```
4 4
??00
0 0
0 1
0 2
0 3```

### è¾“å‡º

```
2
12
23
35```

# AIåˆ†æç»“æœ

# ğŸ’¡ Kayçš„C++ç®—æ³•è§£æï¼š[é›†è®­é˜Ÿäº’æµ‹2024]åŸºç¡€01?ç»ƒä¹ é¢˜ æ·±å…¥å­¦ä¹ æŒ‡å— ğŸ’¡


## 1. é¢˜ç›®è§£è¯»ä¸æ ¸å¿ƒç®—æ³•è¯†åˆ«

âœ¨ **æœ¬é¢˜ä¸»è¦è€ƒå¯Ÿ**ï¼šåŠ¨æ€è§„åˆ’(DP) + å‰ç¼€å’ŒæŠ€å·§ + æ¨¡è¿ç®—åº”ç”¨  

ğŸ—£ï¸ **åˆæ­¥åˆ†æ**ï¼š  
è§£å†³è¿™é“é¢˜çš„å…³é”®ï¼Œå°±åƒæ­ç§¯æœ¨æ—¶è¦å…ˆè§„åˆ’æ¯ä¸€å—çš„ä½ç½®â€”â€”æˆ‘ä»¬éœ€è¦**ç”¨åŠ¨æ€è§„åˆ’ç»Ÿè®¡åˆæ³•çš„01ä¸²æ•°é‡**ï¼ˆé¿å…ä¸‰ä¸ªè¿ç»­ç›¸åŒå­—ç¬¦ï¼‰ï¼Œå†**ç”¨å‰ç¼€å’Œå¿«é€Ÿè®¡ç®—åŒºé—´è´¡çŒ®**ï¼Œæœ€åç»“åˆæ¨¡è¿ç®—å¤„ç†å¤§æ•°é—®é¢˜ã€‚  

### ç®—æ³•æ ¸å¿ƒæ€æƒ³ä¸åº”ç”¨
åŠ¨æ€è§„åˆ’(DP)å°±åƒâ€œä¸€æ­¥æ­¥è®°å½•çŠ¶æ€â€çš„å¤‡å¿˜å½•ï¼šæ¯”å¦‚æˆ‘ä»¬è¦ç»Ÿè®¡æ›¿æ¢`?`åçš„01ä¸²ä¸­ï¼Œæ²¡æœ‰ä¸‰ä¸ªè¿ç»­ç›¸åŒå­—ç¬¦çš„æ•°é‡ï¼Œå°±å¯ä»¥ç”¨`dp[i][c][l]`è®°å½•â€œå¤„ç†åˆ°ç¬¬iä½ï¼Œæœ€åä¸€ä½æ˜¯cï¼ˆ0/1ï¼‰ï¼Œè¿ç»­é•¿åº¦æ˜¯lï¼ˆ1/2ï¼‰â€çš„åˆæ³•ä¸²æ•°é‡ã€‚è¿™æ ·æ¯ä¸€æ­¥éƒ½åŸºäºä¹‹å‰çš„çŠ¶æ€æ¨å¯¼ï¼Œé¿å…é‡å¤è®¡ç®—ã€‚  

åœ¨æœ¬é¢˜ä¸­ï¼ŒDPçš„ä½œç”¨æ˜¯**è®¡ç®—æ¯ä¸ªåŒºé—´çš„åˆæ³•æ›¿æ¢æ–¹å¼æ•°**ï¼ˆå³`c(a,b)`ï¼‰ï¼Œè€Œå‰ç¼€å’Œåˆ™æ˜¯**å¿«é€Ÿç´¯åŠ æ‰€æœ‰åŒºé—´çš„è´¡çŒ®**ï¼ˆå³`sum_w`ï¼‰ã€‚æ¨¡è¿ç®—åˆ™æ˜¯ä¸ºäº†å¤„ç†å¤§æ•°ï¼Œç¡®ä¿ç»“æœåœ¨åˆç†èŒƒå›´å†…ã€‚  

### é¢˜è§£æ€è·¯ä¸æ ¸å¿ƒéš¾ç‚¹
- **æ ¸å¿ƒæ€è·¯**ï¼šå°†å¤æ‚çš„`h`å‡½æ•°æ‹†è§£ä¸º`c(a,b) * 2^{total_q - q(a,b)}`çš„ç´¯åŠ ï¼Œå…¶ä¸­`c(a,b)`æ˜¯åˆæ³•æ›¿æ¢æ•°ï¼Œ`q(a,b)`æ˜¯åŒºé—´å†…`?`çš„æ•°é‡ï¼Œ`total_q`æ˜¯æ€»`?`æ•°ã€‚  
- **æ ¸å¿ƒéš¾ç‚¹**ï¼š  
  1. å¦‚ä½•é«˜æ•ˆè®¡ç®—`c(a,b)`ï¼ˆé¿å…O(nÂ²)çš„æ—¶é—´å¤æ‚åº¦ï¼‰ï¼Ÿ  
  2. å¦‚ä½•å¿«é€Ÿç´¯åŠ æ‰€æœ‰åŒºé—´çš„è´¡çŒ®ï¼Ÿ  
- **è§£å†³æ–¹æ¡ˆ**ï¼š  
  - åˆ©ç”¨â€œæ²¡æœ‰ä¸‰ä¸ªè¿ç»­ç›¸åŒå­—ç¬¦â€çš„é™åˆ¶ï¼Œæ¯ä¸ªåŒºé—´çš„åˆæ³•çŠ¶æ€æ•°æœ€å¤šæ˜¯`2Ã—2=4`ç§ï¼ˆæœ€åä¸€ä½æ˜¯0/1ï¼Œè¿ç»­é•¿åº¦æ˜¯1/2ï¼‰ï¼Œå› æ­¤DPçš„æ—¶é—´å¤æ‚åº¦å¯ä»¥æ§åˆ¶åœ¨O(nÃ—K)ï¼ˆKæ˜¯å¸¸æ•°ï¼‰ã€‚  
  - é¢„å¤„ç†æ¯ä¸ªä½ç½®çš„æœ€é•¿åˆæ³•åŒºé—´ï¼Œé™åˆ¶åŒºé—´é•¿åº¦ï¼ˆæ¯”å¦‚æœ€å¤š2ï¼‰ï¼Œä»è€Œå°†æ€»è®¡ç®—é‡é™åˆ°O(n)çº§åˆ«ã€‚  

### å¯è§†åŒ–è®¾è®¡æ€è·¯
æˆ‘ä»¬å¯ä»¥è®¾è®¡ä¸€ä¸ª**åƒç´ é£æ ¼çš„â€œåŠ¨æ€è§„åˆ’ç§¯æœ¨æ¸¸æˆâ€**ï¼š  
- **çŠ¶æ€å¯è§†åŒ–**ï¼šç”¨ä¸åŒé¢œè‰²çš„åƒç´ å—ä»£è¡¨`dp[i][0][1]`ï¼ˆæœ€åä¸€ä½0ï¼Œè¿ç»­1ä¸ªï¼‰ã€`dp[i][0][2]`ï¼ˆæœ€åä¸€ä½0ï¼Œè¿ç»­2ä¸ªï¼‰ã€`dp[i][1][1]`ã€`dp[i][1][2]`ï¼ŒåŠ¨æ€å±•ç¤ºçŠ¶æ€è½¬ç§»ã€‚  
- **åŒºé—´è´¡çŒ®**ï¼šç”¨åƒç´ ç½‘æ ¼å±•ç¤ºæ¯ä¸ªåŒºé—´`(i,j)`çš„`w(i,j)`å€¼ï¼Œé¢œè‰²è¶Šæ·±ä»£è¡¨è´¡çŒ®è¶Šå¤§ã€‚  
- **äº¤äº’è®¾è®¡**ï¼šæ”¯æŒâ€œå•æ­¥æ‰§è¡Œâ€ï¼ˆé€æ­¥çœ‹DPçŠ¶æ€å˜åŒ–ï¼‰ã€â€œè‡ªåŠ¨æ’­æ”¾â€ï¼ˆå¿«é€Ÿæµè§ˆå‰ç¼€å’Œç´¯åŠ ï¼‰ï¼Œå¹¶æ·»åŠ éŸ³æ•ˆâ€”â€”æ¯”å¦‚çŠ¶æ€è½¬ç§»æ—¶â€œæ»´ç­”â€ä¸€å£°ï¼Œå®Œæˆä¸€ä¸ªåŒºé—´æ—¶â€œå®â€ä¸€å£°ï¼Œå¢åŠ æ²‰æµ¸æ„Ÿã€‚  


## 2. ç²¾é€‰ä¼˜è´¨é¢˜è§£å‚è€ƒ
ï¼ˆæ³¨ï¼šç”±äºå¾…å¤„ç†å†…å®¹ä¸­æ— å…·ä½“é¢˜è§£ï¼Œæ­¤å¤„ç»™å‡ºé€šç”¨å­¦ä¹ å»ºè®®ï¼‰  
è‹¥é¢˜è§£æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼Œå¯è§†ä¸ºä¼˜è´¨ï¼š  
1. **æ€è·¯æ¸…æ™°**ï¼šæ˜ç¡®æ‹†è§£`h`å‡½æ•°ä¸º`c(a,b)`ä¸å¹‚æ¬¡çš„ä¹˜ç§¯ï¼Œæ¨å¯¼è¿‡ç¨‹è¯¦ç»†ï¼›  
2. **ä»£ç é«˜æ•ˆ**ï¼šç”¨DPç»Ÿè®¡`c(a,b)`æ—¶ï¼Œä»…å¤„ç†åˆæ³•åŒºé—´ï¼ˆé•¿åº¦â‰¤2ï¼‰ï¼Œé¿å…å†—ä½™è®¡ç®—ï¼›  
3. **æ¨¡è¿ç®—è§„èŒƒ**ï¼šæ­£ç¡®é¢„å¤„ç†`2`çš„å¹‚æ¬¡å’Œé€†å…ƒï¼Œé¿å…è®¡ç®—é”™è¯¯ï¼›  
4. **å‰ç¼€å’Œå·§å¦™**ï¼šç”¨ä¸€ç»´å‰ç¼€å’Œä»£æ›¿äºŒç»´å‰ç¼€å’Œï¼Œé™ä½ç©ºé—´å¤æ‚åº¦ã€‚  


## 3. æ ¸å¿ƒéš¾ç‚¹è¾¨æä¸è§£é¢˜ç­–ç•¥

### å…³é”®ç‚¹1ï¼šæ­£ç¡®æ¨å¯¼`h`å‡½æ•°çš„è¡¨è¾¾å¼  
- **éš¾ç‚¹**ï¼šå®¹æ˜“å¿½ç•¥â€œæ›¿æ¢æ•´ä¸ªåŒºé—´çš„`?`â€ä¸â€œå­åŒºé—´`?`â€çš„åŒºåˆ«ï¼Œå¯¼è‡´`h`å‡½æ•°è®¡ç®—é”™è¯¯ã€‚  
- **è§£å†³æ–¹æ¡ˆ**ï¼šé€šè¿‡æ ·ä¾‹æ‰‹åŠ¨è®¡ç®—ï¼ˆæ¯”å¦‚æ ·ä¾‹1ä¸­çš„åŒºé—´0-1ï¼‰ï¼ŒéªŒè¯`h = 2^{total_q} Ã— sum(w(a,b))`çš„æ­£ç¡®æ€§ã€‚  

### å…³é”®ç‚¹2ï¼šé«˜æ•ˆè®¡ç®—`c(a,b)`  
- **éš¾ç‚¹**ï¼šç›´æ¥è®¡ç®—æ‰€æœ‰åŒºé—´çš„`c(a,b)`ä¼šå¯¼è‡´O(nÂ²)çš„æ—¶é—´å¤æ‚åº¦ï¼Œæ— æ³•å¤„ç†å¤§nã€‚  
- **è§£å†³æ–¹æ¡ˆ**ï¼šåˆ©ç”¨â€œæ²¡æœ‰ä¸‰ä¸ªè¿ç»­ç›¸åŒå­—ç¬¦â€çš„é™åˆ¶ï¼Œæ¯ä¸ªåŒºé—´çš„åˆæ³•çŠ¶æ€ä»…4ç§ï¼ˆæœ€åä¸€ä½0/1ï¼Œè¿ç»­é•¿åº¦1/2ï¼‰ï¼Œå› æ­¤DPçš„æ—¶é—´å¤æ‚åº¦æ˜¯O(nÃ—4) = O(n)ã€‚  

### å…³é”®ç‚¹3ï¼šå¿«é€Ÿç´¯åŠ åŒºé—´è´¡çŒ®  
- **éš¾ç‚¹**ï¼šäºŒç»´å‰ç¼€å’Œçš„ç©ºé—´å¤æ‚åº¦æ˜¯O(nÂ²)ï¼Œæ— æ³•å¤„ç†n=5e4çš„æƒ…å†µã€‚  
- **è§£å†³æ–¹æ¡ˆ**ï¼šé¢„å¤„ç†æ¯ä¸ªä½ç½®çš„æœ€é•¿åˆæ³•åŒºé—´ï¼ˆæ¯”å¦‚æœ€å¤š2ï¼‰ï¼Œå°†åŒºé—´è´¡çŒ®è½¬åŒ–ä¸ºä¸€ç»´å‰ç¼€å’Œï¼Œæ—¶é—´å¤æ‚åº¦O(n)ã€‚  

### âœ¨ è§£é¢˜æŠ€å·§æ€»ç»“
- **é—®é¢˜æ‹†è§£**ï¼šå°†å¤æ‚çš„`h`å‡½æ•°æ‹†è§£ä¸ºå¤šä¸ªå°é—®é¢˜ï¼ˆè®¡ç®—`c(a,b)`ã€ç»Ÿè®¡`?`æ•°é‡ã€è®¡ç®—å¹‚æ¬¡ï¼‰ï¼Œé€ä¸ªè§£å†³ï¼›  
- **çŠ¶æ€å‹ç¼©**ï¼šç”¨`dp[i][c][l]`è®°å½•å…³é”®çŠ¶æ€ï¼Œé¿å…å†—ä½™è®¡ç®—ï¼›  
- **å‰ç¼€å’Œä¼˜åŒ–**ï¼šç”¨ä¸€ç»´å‰ç¼€å’Œå¿«é€Ÿç´¯åŠ åŒºé—´è´¡çŒ®ï¼Œé™ä½æ—¶é—´å¤æ‚åº¦ï¼›  
- **æ¨¡è¿ç®—é¢„å¤„ç†**ï¼šæå‰è®¡ç®—`2`çš„å¹‚æ¬¡å’Œé€†å…ƒï¼Œé¿å…é‡å¤è®¡ç®—ã€‚  


## 4. C++æ ¸å¿ƒä»£ç å®ç°èµæ

### æœ¬é¢˜é€šç”¨æ ¸å¿ƒC++å®ç°å‚è€ƒ  
* **è¯´æ˜**ï¼šæœ¬ä»£ç ç»¼åˆäº†DPç»Ÿè®¡åˆæ³•æ•°ã€å‰ç¼€å’Œç´¯åŠ ã€æ¨¡è¿ç®—å¤„ç†çš„æ ¸å¿ƒé€»è¾‘ï¼Œé€‚ç”¨äºå°è§„æ¨¡æ•°æ®ï¼ˆnâ‰¤1e3ï¼‰ï¼Œå¯æ‰©å±•åˆ°å¤§æ•°æƒ…å†µã€‚  

```cpp
#include <iostream>
#include <vector>
#include <string>
using namespace std;

const int MOD = 998244353;
const int MAXN = 1005;

long long pre_pow2[MAXN], pre_inv2[MAXN];
int pre_q[MAXN]; // å‰ç¼€å’Œï¼špre_q[i]æ˜¯S[0..i-1]ä¸­çš„?æ•°é‡
long long dp[MAXN][2][3]; // dp[i][c][l]ï¼šå¤„ç†åˆ°ç¬¬iä½ï¼Œæœ€åä¸€ä½æ˜¯cï¼Œè¿ç»­é•¿åº¦lï¼ˆ1/2ï¼‰
long long w[MAXN][MAXN]; // w[a][b] = c(a,b) * inv2^q(a,b)
long long sum_w[MAXN][MAXN]; // äºŒç»´å‰ç¼€å’Œï¼šsum_w[L][R] = sum_{a=L}^R sum_{b=a}^R w(a,b)

// é¢„å¤„ç†2çš„å¹‚æ¬¡å’Œé€†å…ƒ
void precompute(int n) {
    pre_pow2[0] = 1;
    for (int i = 1; i <= n; i++) pre_pow2[i] = pre_pow2[i-1] * 2 % MOD;
    pre_inv2[0] = 1;
    long long inv2 = 499122177; // 2çš„é€†å…ƒæ¨¡MOD
    for (int i = 1; i <= n; i++) pre_inv2[i] = pre_inv2[i-1] * inv2 % MOD;
}

// è®¡ç®—c(a,b)ï¼šåŒºé—´a..bçš„åˆæ³•æ›¿æ¢æ•°
long long compute_c(const string& S, int a, int b) {
    int len = b - a + 1;
    // åˆå§‹åŒ–DPï¼šå¤„ç†åˆ°ç¬¬0ä½ï¼ˆaä½ç½®ï¼‰
    for (int c = 0; c < 2; c++) {
        for (int l = 1; l <= 2; l++) dp[0][c][l] = 0;
    }
    char ch = S[a];
    if (ch == '0' || ch == '?') {
        dp[0][0][1] = 1;
    }
    if (ch == '1' || ch == '?') {
        dp[0][1][1] = 1;
    }
    // åŠ¨æ€è§„åˆ’è½¬ç§»
    for (int i = 1; i < len; i++) {
        char curr = S[a + i];
        for (int c = 0; c < 2; c++) {
            for (int l = 1; l <= 2; l++) {
                dp[i][c][l] = 0;
            }
        }
        // è½¬ç§»åˆ°å½“å‰å­—ç¬¦ä¸º0
        if (curr == '0' || curr == '?') {
            // å‰ä¸€ä½æ˜¯1ï¼Œè¿ç»­é•¿åº¦1
            dp[i][0][1] = (dp[i][0][1] + dp[i-1][1][1] + dp[i-1][1][2]) % MOD;
            // å‰ä¸€ä½æ˜¯0ï¼Œè¿ç»­é•¿åº¦2
            if (dp[i-1][0][1] > 0) {
                dp[i][0][2] = (dp[i][0][2] + dp[i-1][0][1]) % MOD;
            }
        }
        // è½¬ç§»åˆ°å½“å‰å­—ç¬¦ä¸º1
        if (curr == '1' || curr == '?') {
            // å‰ä¸€ä½æ˜¯0ï¼Œè¿ç»­é•¿åº¦1
            dp[i][1][1] = (dp[i][1][1] + dp[i-1][0][1] + dp[i-1][0][2]) % MOD;
            // å‰ä¸€ä½æ˜¯1ï¼Œè¿ç»­é•¿åº¦2
            if (dp[i-1][1][1] > 0) {
                dp[i][1][2] = (dp[i][1][2] + dp[i-1][1][1]) % MOD;
            }
        }
    }
    // ç»Ÿè®¡æ‰€æœ‰åˆæ³•çŠ¶æ€
    long long res = 0;
    for (int c = 0; c < 2; c++) {
        for (int l = 1; l <= 2; l++) {
            res = (res + dp[len-1][c][l]) % MOD;
        }
    }
    return res;
}

int main() {
    ios::sync_with_stdio(false);
    cin.tie(nullptr);
    string S;
    int n, m;
    cin >> n >> m >> S;
    precompute(n);
    // é¢„å¤„ç†pre_qï¼šå‰ç¼€å’Œç»Ÿè®¡?çš„æ•°é‡
    pre_q[0] = 0;
    for (int i = 0; i < n; i++) {
        pre_q[i+1] = pre_q[i] + (S[i] == '?' ? 1 : 0);
    }
    // é¢„å¤„ç†w[a][b]å’Œsum_w
    for (int a = 0; a < n; a++) {
        int max_b = min(a + 2, n-1); // é™åˆ¶åŒºé—´é•¿åº¦â‰¤2
        for (int b = a; b <= max_b; b++) {
            int q = pre_q[b+1] - pre_q[a];
            long long c = compute_c(S, a, b);
            w[a][b] = c * pre_inv2[q] % MOD;
        }
        // é¢„å¤„ç†sum_wï¼šä¸€ç»´å‰ç¼€å’Œ
        sum_w[a][a] = w[a][a];
        for (int b = a+1; b <= max_b; b++) {
            sum_w[a][b] = (sum_w[a][b-1] + w[a][b]) % MOD;
        }
    }
    // å¤„ç†è¯¢é—®
    while (m--) {
        int L, R;
        cin >> L >> R;
        int total_q = pre_q[R+1] - pre_q[L];
        long long sum = 0;
        // ç´¯åŠ æ‰€æœ‰åŒºé—´[a,b]çš„w(a,b)
        for (int a = L; a <= R; a++) {
            int max_b = min(a + 2, R);
            if (max_b < a) continue;
            sum = (sum + sum_w[a][max_b]) % MOD;
        }
        long long ans = pre_pow2[total_q] * sum % MOD;
        cout << ans << '\n';
    }
    return 0;
}
```

* **ä»£ç è§£è¯»æ¦‚è¦**ï¼š  
  1. **é¢„å¤„ç†**ï¼šè®¡ç®—`2`çš„å¹‚æ¬¡å’Œé€†å…ƒï¼Œç»Ÿè®¡`?`çš„å‰ç¼€å’Œï¼›  
  2. **DPè®¡ç®—`c(a,b)`**ï¼šç”¨`dp[i][c][l]`è®°å½•åˆæ³•çŠ¶æ€ï¼Œç»Ÿè®¡æ¯ä¸ªåŒºé—´çš„åˆæ³•æ›¿æ¢æ•°ï¼›  
  3. **è®¡ç®—`w(a,b)`**ï¼š`w(a,b) = c(a,b) Ã— inv2^q(a,b)`ï¼›  
  4. **å¤„ç†è¯¢é—®**ï¼šç´¯åŠ æ‰€æœ‰åŒºé—´çš„`w(a,b)`ï¼Œç»“åˆ`2^{total_q}`è®¡ç®—`h`å€¼ã€‚  


## 5. ç®—æ³•å¯è§†åŒ–ï¼šåƒç´ åŠ¨ç”»æ¼”ç¤º

### åŠ¨ç”»ä¸»é¢˜ï¼šåƒç´ ç§¯æœ¨å·¥å‚  
æˆ‘ä»¬è®¾è®¡ä¸€ä¸ª**8ä½åƒç´ é£æ ¼çš„â€œç§¯æœ¨å·¥å‚â€**ï¼Œå±•ç¤ºåŠ¨æ€è§„åˆ’ç»Ÿè®¡åˆæ³•01ä¸²çš„è¿‡ç¨‹ï¼š  

### æ ¸å¿ƒæ¼”ç¤ºå†…å®¹
1. **åœºæ™¯åˆå§‹åŒ–**ï¼šå±å¹•å·¦ä¾§æ˜¯â€œå­—ç¬¦ä¼ é€å¸¦â€ï¼ˆå±•ç¤ºè¾“å…¥çš„`0/1/?`ï¼‰ï¼Œå³ä¾§æ˜¯â€œDPçŠ¶æ€æ¿â€ï¼ˆå±•ç¤º`dp[i][0][1]`ã€`dp[i][0][2]`ã€`dp[i][1][1]`ã€`dp[i][1][2]`çš„æ•°å€¼ï¼‰ï¼Œåº•éƒ¨æ˜¯â€œæ§åˆ¶é¢æ¿â€ï¼ˆå•æ­¥ã€è‡ªåŠ¨ã€é‡ç½®æŒ‰é’®ï¼‰ã€‚  
2. **DPçŠ¶æ€è½¬ç§»**ï¼š  
   - å½“å¤„ç†åˆ°ç¬¬`i`ä½æ—¶ï¼Œä¼ é€å¸¦çš„å­—ç¬¦ä¼šâ€œæ‰è½â€åˆ°çŠ¶æ€æ¿ï¼›  
   - çŠ¶æ€æ¿ä¸Šçš„åƒç´ å—ä¼šæ ¹æ®è½¬ç§»è§„åˆ™â€œç§»åŠ¨â€ï¼šæ¯”å¦‚å‰ä¸€ä½æ˜¯`0`ï¼ˆè¿ç»­é•¿åº¦1ï¼‰ï¼Œå½“å‰ä½æ˜¯`0`ï¼Œåˆ™`dp[i][0][2]`çš„åƒç´ å—ä¼šå¢åŠ ï¼›  
   - æ¯å®Œæˆä¸€æ¬¡è½¬ç§»ï¼Œæ’­æ”¾â€œæ»´ç­”â€éŸ³æ•ˆï¼ŒçŠ¶æ€æ¿ä¸Šçš„æ•°å€¼ä¼šæ›´æ–°ã€‚  
3. **åŒºé—´è´¡çŒ®ç´¯åŠ **ï¼šå½“å¤„ç†å®Œæ‰€æœ‰åŒºé—´åï¼Œå±å¹•é¡¶éƒ¨çš„â€œç´¯åŠ å™¨â€ä¼šé€æ­¥å¢åŠ ï¼Œæ’­æ”¾â€œå®â€çš„éŸ³æ•ˆï¼Œè¡¨ç¤ºå½“å‰åŒºé—´çš„è´¡çŒ®å·²ç´¯åŠ ã€‚  
4. **ç»“æœå±•ç¤º**ï¼šæœ€åæ˜¾ç¤º`h`å€¼ï¼Œæ’­æ”¾â€œèƒœåˆ©â€éŸ³æ•ˆï¼ŒçŠ¶æ€æ¿ä¸Šçš„åƒç´ å—ä¼šé—ªçƒåº†ç¥ã€‚  

### äº¤äº’è®¾è®¡
- **å•æ­¥æ‰§è¡Œ**ï¼šç‚¹å‡»â€œå•æ­¥â€æŒ‰é’®ï¼Œé€æ­¥å±•ç¤ºDPçŠ¶æ€è½¬ç§»ï¼›  
- **è‡ªåŠ¨æ’­æ”¾**ï¼šç‚¹å‡»â€œè‡ªåŠ¨â€æŒ‰é’®ï¼ŒåŠ¨ç”»ä¼šä»¥æ¯ç§’2å¸§çš„é€Ÿåº¦æ’­æ”¾ï¼Œå¯é€šè¿‡æ»‘å—è°ƒæ•´é€Ÿåº¦ï¼›  
- **é‡ç½®**ï¼šç‚¹å‡»â€œé‡ç½®â€æŒ‰é’®ï¼Œå›åˆ°åˆå§‹çŠ¶æ€ï¼Œé‡æ–°å¼€å§‹æ¼”ç¤ºã€‚  

### è®¾è®¡æ€è·¯
ç”¨åƒç´ é£æ ¼è¥é€ å¤å¤æ¸¸æˆæ„Ÿï¼Œè®©å­¦ä¹ è€…åƒç©â€œç§¯æœ¨æ¸¸æˆâ€ä¸€æ ·ç†è§£DPçŠ¶æ€è½¬ç§»ã€‚éŸ³æ•ˆå’ŒåŠ¨ç”»å¼ºåŒ–å…³é”®æ“ä½œçš„è®°å¿†ï¼Œæ¯”å¦‚â€œæ»´ç­”â€å£°å¯¹åº”DPè½¬ç§»ï¼Œâ€œå®â€å£°å¯¹åº”åŒºé—´è´¡çŒ®ç´¯åŠ ï¼Œå¸®åŠ©å­¦ä¹ è€…å¿«é€ŸæŒæ¡æ ¸å¿ƒé€»è¾‘ã€‚  


## 6. æ‹“å±•ç»ƒä¹ ä¸ç›¸ä¼¼é—®é¢˜æ€è€ƒ

### é€šç”¨æ€è·¯è¿ç§»
æœ¬é¢˜çš„æ€è·¯å¯è¿ç§»åˆ°**ç»Ÿè®¡æ»¡è¶³ç‰¹å®šæ¡ä»¶çš„å­ä¸²æ•°é‡**çš„é—®é¢˜ï¼Œæ¯”å¦‚ï¼š  
- ç»Ÿè®¡å­—ç¬¦ä¸²ä¸­æ²¡æœ‰é‡å¤å­—ç¬¦çš„å­ä¸²æ•°é‡ï¼›  
- ç»Ÿè®¡æ›¿æ¢`?`åçš„å›æ–‡ä¸²æ•°é‡ã€‚  

### æ´›è°·ç›¸ä¼¼é—®é¢˜æ¨è
1. **P1140 ç›¸ä¼¼åŸºå› **ï¼šç”¨DPç»Ÿè®¡ä¸¤ä¸ªå­—ç¬¦ä¸²çš„ç›¸ä¼¼æ€§ï¼Œç»ƒä¹ çŠ¶æ€è½¬ç§»ï¼›  
2. **P1216 [IOI1994]æ•°å­—ä¸‰è§’å½¢**ï¼šç”¨DPæ±‚æœ€å¤§è·¯å¾„å’Œï¼Œç»ƒä¹ å‰ç¼€å’Œä¼˜åŒ–ï¼›  
3. **P3373 çº¿æ®µæ ‘æ¨¡æ¿2**ï¼šç”¨çº¿æ®µæ ‘å¤„ç†åŒºé—´ä¿®æ”¹å’ŒæŸ¥è¯¢ï¼Œç»ƒä¹ åŒºé—´è´¡çŒ®ç´¯åŠ ã€‚  


## 7. å­¦ä¹ å¿ƒå¾—ä¸ç»éªŒåˆ†äº« (è‹¥æœ‰)
æœ¬æ¬¡åˆ†æçš„é¢˜è§£ä¸­æœªå‘ç°æ˜ç¡®çš„ä½œè€…ä¸ªäººå¿ƒå¾—åˆ†äº«éƒ¨åˆ†ã€‚  


## æ€»ç»“
è¿™é“é¢˜çš„æ ¸å¿ƒæ˜¯**ç”¨åŠ¨æ€è§„åˆ’è®°å½•çŠ¶æ€ï¼Œç”¨å‰ç¼€å’Œå¿«é€Ÿç´¯åŠ ï¼Œç”¨æ¨¡è¿ç®—å¤„ç†å¤§æ•°**ã€‚é€šè¿‡æ‹†è§£é—®é¢˜ã€çŠ¶æ€å‹ç¼©å’Œå‰ç¼€å’Œä¼˜åŒ–ï¼Œæˆ‘ä»¬å¯ä»¥é«˜æ•ˆè§£å†³å¤§è§„æ¨¡æ•°æ®çš„é—®é¢˜ã€‚è®°ä½ï¼š**å¤æ‚çš„é—®é¢˜å¾€å¾€å¯ä»¥æ‹†è§£ä¸ºå¤šä¸ªå°é—®é¢˜ï¼Œé€ä¸ªè§£å†³å°±èƒ½è¿åˆƒè€Œè§£ï¼**  

ä¸‹æ¬¡æˆ‘ä»¬å†ä¸€èµ·æ¢ç´¢æ›´æœ‰è¶£çš„ç®—æ³•æŒ‘æˆ˜ï¼ğŸ’ª

---
å¤„ç†ç”¨æ—¶ï¼š522.48ç§’
# 题目信息

# [PA 2019 Final] 数图 / Grafy 加强版

## 题目背景

P11817 的加强版。本题存在 $\Theta(\sqrt n\log n)$ 的做法。

本题数据为自造。

std: joke3579，validator & generator: Starrykiller。

**请勿提交 OEIS 题解。**



## 题目描述

求出 $n$ 个节点的满足以下条件的**有标号有向简单图**的数量：

- $\forall 1\le i\le n$，$\operatorname{deg_{out}}(i)=\operatorname{deg_{in}}(i)=2$。

这里，$\operatorname{deg_{out}}(u)$ 指节点 $u$ 的出度，$\operatorname{deg_{in}}(u)$ 指节点 $u$ 的入度。

你只需要输出答案对给定大素数 $p$ 取模后的结果。


注意我们是对**有标号**的「有向简单图」计数。也就是说，这张图中无重边自环。注意 $u\to v$ 和 $v\to u$ 同时出现是允许的。




## 说明/提示

- $3\le n\le 10^7$；
- $10^8+7\le p\le 10^9+7$，$p$ 为素数。



## 样例 #1

### 输入

```
4 998244853```

### 输出

```
9```

## 样例 #2

### 输入

```
114514 1000000007
```

### 输出

```
637348702
```

# AI分析结果


### 题目分析：P11817 数图加强版 (有向图双2度计数)

#### **题目概述**
- **问题**：计算 $n$ 个节点的**有标号有向简单图**数量，满足每个节点出度 $\operatorname{deg_{out}}(i)=2$ 且入度 $\operatorname{deg_{in}}(i)=2$（无重边自环）。
- **输入**：$3 \le n \le 10^7$，素数 $p$（$10^8+7 \le p \le 10^9+7$）。
- **输出**：结果对 $p$ 取模。

#### **核心算法识别：生成函数与整式递推**
- **算法标签**：生成函数 + 整式递推（编程技巧应用）
- **比喻解释**：  
  想象一张有向图如**交通网络**，每个节点是十字路口，需设计两条出车道和两条入车道（无重复或单行道冲突）。问题转化为用**生成函数**（类似“设计蓝图”）描述合法网络的数量，再通过**整式递推**（“自动化流水线”）高效计算大规模 $n$。

#### **题解核心思路**
1. **生成函数转化**（题解关键）：
   - 通过组合意义推导生成函数：
     $$
     \text{答案} = \frac{n!}{4^n} [z^n] \frac{e^{4z}}{(1+4z)(1+2z)} \sum_{t=0}^{\infty} \frac{(2t)!}{t!} \left( \frac{z}{(1+4z)^2(1+2z)} \right)^t
     $$
   - 其中 $\sum_{t} \frac{(2t)!}{t!} w^t$ 是超几何级数，无初等封闭形式，但整体**微分有限**（即系数满足线性递推）。

2. **整式递推优化**：
   - 暴力计算前 $100$ 项（三重循环，$O(n^3)$），用 **Berlekamp-Massey (BM) 算法** 提取最短线性递推式。
   - 对 $n > 100$，用递推式 + **矩阵快速幂**（$O(d^3 \log n)$）求解，$d$ 为递推阶数（$\le 100$）。

#### **核心难点与策略**
1. **难点1：生成函数化简**  
   - **问题**：生成函数含指数、有理分式和高阶级数，直接提取 $[z^n]$ 困难。  
   - **策略**：  
     - 利用微分有限性，暴力算前 $100$ 项（$O(n^3)$ 可接受）。  
     - **学习笔记**：生成函数是组合计数的“瑞士军刀”，但需结合数值方法实现。

2. **难点2：高效计算大规模 $n$**  
   - **问题**：$n \le 10^7$ 时 $O(n^3)$ 不可行。  
   - **策略**：  
     - BM 算法提取递推式（如 $a_n = c_1 a_{n-1} + \cdots + c_d a_{n-d}$）。  
     - 矩阵快速幂（初始向量 $F_{d-1} = [a_{d-1}, \dots, a_0]^T$，转移矩阵含递推系数）。  
   - **学习笔记**：整式递推将指数级复杂度降为线性。

3. **难点3：模运算与数值稳定性**  
   - **问题**：大 $n$ 下阶乘、幂次需模 $p$ 计算。  
   - **策略**：  
     - 预处理阶乘 $fac[0..300]$、阶乘逆元 $invfac$ 和 $2^k \mod p$ 表。  
     - **技巧**：费马小定理求逆元（$4^{-n} \equiv (4^{p-2})^n \mod p$）。

#### **解题技巧总结**
- **组合分解**：将图计数拆解为度序列的生成函数卷积。  
- **递推思维**：对无封闭形式问题，用前项推导后项（动态规划思想）。  
- **模块化计算**：分离预处理、暴力计算和递推步骤，确保可扩展性。  

---

### 算法可视化：像素动画演示（复古游戏风格）

#### **设计概念：图工厂流水线**
- **主题**：8-bit 像素风格工厂，将节点视为“齿轮”，边视为“传送带”。  
- **目标**：演示递推动态规划中状态转移和系数生成过程。

#### **动画设计**
1. **场景与 UI**：  
   - **网格流水线**：节点为发光齿轮，边为彩色传送带（红/蓝表出/入边）。  
   - **控制面板**：  
     - 步进/自动播放（调速滑块）、重置按钮。  
     - 显示当前 $n$、递推阶数 $d$ 和矩阵状态。  
     - **音效**：齿轮转动（背景乐）、成功（胜利音效）、错误（短促提示音）。  

2. **核心流程**：  
   - **初始化**：$n=0$ 时显示空工厂（$a_0=1$ 的齿轮闪烁）。  
   - **三重循环（$n \le 100$）**：  
     - 循环变量 $t, i, j$ 以像素方块显示，内层求和时 $i,j$ 方块碰撞，合并为项（伴随“叮”声）。  
     - 进度条显示 $\frac{t}{n}$，每完成 $t$ 播放齿轮组装动画。  
   - **BM 算法（$n > 100$）**：  
     - 矩阵 $M$ 以网格显示，幂运算时网格块旋转聚合（类似俄罗斯方块消除）。  
     - **自动演示模式**：AI 机器人按递推式逐步点亮齿轮（模拟流水线）。  

3. **关键步骤高亮**：  
   - **状态转移**：当 $a_n$ 更新时，对应齿轮变色，显示公式 $a_n = \sum c_k a_{n-k}$。  
   - **错误处理**：若 $d > 100$，工厂爆炸（像素火花）并播放失败音效。  

4. **游戏化元素**：  
   - **关卡系统**：每 $10$ 个节点为一关，通关奖励齿轮皮肤。  
   - **积分**：快速计算奖励连击分，慢速但正确得精度分。  

#### **技术实现**
- **Canvas 绘制**：网格用 `ctx.fillRect()` 绘制齿轮像素块，矩阵动画用变换坐标。  
- **伪代码**：  
  ```javascript
  function drawFrame(n, d, a_n) {
    drawGrid(); // 绘制工厂网格
    drawGears(n, a_n); // 根据当前状态绘制齿轮
    if (autoPlay) {
      moveConveyorBelts(); // 传送带动画
      playSound("tick"); // 步进音效
    }
  }
  ```

---

### 拓展练习
1. **洛谷 P1357**：有标号无向图度数约束（巩固生成函数）。  
   - **推荐理由**：类似度序列计数，练习生成函数建模。  
2. **洛谷 P6189**：有向图强连通分量计数（递推优化）。  
   - **推荐理由**：将递推技巧迁移到图论问题。  
3. **洛谷 P6778**：带权图度序列计数（动态规划 + 模优化）。  
   - **推荐理由**：结合本题技巧处理带权变种。  

> **关键思维**：组合计数问题常可转化为生成函数 + 递推，核心是识别模型共性。

---
处理用时：565.29秒
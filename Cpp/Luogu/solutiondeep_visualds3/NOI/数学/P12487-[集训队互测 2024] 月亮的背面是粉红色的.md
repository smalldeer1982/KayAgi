# 题目信息

# [集训队互测 2024] 月亮的背面是粉红色的

## 题目背景

>在寂静的世界里
>
>我张开手去触碰你
>
>想要挣脱这泥泞笨重的地心引力
>
>我害怕的用力呼吸
>
>期待着不可能发生的奇迹
>
>闭上了双眼
>
>不见 偏离的心率
>
>无助的努力 渐渐地放弃
>
>在残缺的内心里
>
>哭泣着呐喊的我
>
>现在还是散落在月球表面
>
>等时间消逝
>
>沉淀
>
>我在哪里
>
>—— 『月球偏心率』

## 题目描述


小 L 终于见到了月球的背面，可这里一片荒芜，冷漠乏味。

他想要把这里染成热情的粉红色，为此他翻阅数学书找到了一个函数 $f_t(n)=2^{\omega(n)}n^t$，他要根据这个函数决定染色的过程。

这里的 $\omega(n)$ 为 $n$ 的不同质因子个数，例如 $\omega(1)=0,\omega(2)=1,\omega(8)=1,\omega(6)=2$。

小 L 先把这里划分成了 $n\times n$ 片区域，每个区域倒入不同数量的粉色颜料。具体来说，他会在第 $i$ 行第 $j$ 列的区域内倒入 $f_t(\gcd(i,j))f_t(\operatorname{lcm}(i,j))$ 桶颜料。

不过他已经没有精力去计算了，因此请你直接告诉他总共需要多少桶粉色颜料。

更进一步的，如果上面的答案记成 $F_t(n)$，小 L 会告诉你一个整数 $m\in \{0,1\}$：

- 如果 $m=0$，请你输出 $F_0(n)$。

- 如果 $m=1$，请你输出 $F_0(n),F_1(n)$。

由于答案可能很大，请输出答案对 $10^9+7$ 取模的值。

## 说明/提示

- 子任务一 (3 分)：$1\leq n\leq 5000,m\in\{0,1\}$。
- 子任务二 (3 分)：$1\leq n\leq 10^7,m\in\{0,1\}$。
- 子任务三 (8分)：$0\leq n\leq 10^{10},m=0$。
- 子任务四 (8分)：$0\leq n\leq 10^{10},m\in\{0,1\}$。
- 子任务五 (8分)：$0\leq n\leq 10^{12},m\in\{0,1\}$。
- 子任务六 (10分)：$0\leq n\leq 10^{13},m\in\{0,1\}$。
- 子任务七 (13分)：$0\leq n\leq 10^{14},m=0$。
- 子任务八 (14分)：$0\leq n\leq 10^{14},m\in\{0,1\}$。
- 子任务九 (16分)：$1\leq n\leq 10^{16},m=0$。
- 子任务十 (17分)：$1\leq n\leq 10^{15},m\in\{0,1\}$。

时间限制：第九个子任务时间限制 3s，第十个子任务时间限制 3s，其余子任务时间限制 2s。

**注：与原题相比，为了卡掉错解，第十个子任务的时间有所调整**。

## 样例 #1

### 输入

```
3 1```

### 输出

```
25 121```

## 样例 #2

### 输入

```
1000 0```

### 输出

```
24870169```

## 样例 #3

### 输入

```
10000000000 0```

### 输出

```
213223517```

## 样例 #4

### 输入

```
100000000000000 1```

### 输出

```
8177545 370603117```

# AI分析结果


### 💡 Kay的C++算法解析：月亮的背面是粉红色的 深入学习指南 💡

#### 1. 题目解读与核心算法识别
✨ **本题主要考察**：`数论分块` + `积性函数变换` + `类欧几里得算法`

🗣️ **初步分析**：
> 本题核心是计算函数 $F_t(n) = \left( \sum_{i=1}^n i^t 2^{\omega(i)} \right)^2$，其中 $\omega(i)$ 是 $i$ 的不同质因子个数。解题关键在于三重转换：
> 1. **积性性质**：利用 $f(a)f(b)=f(\gcd(a,b))f(\text{lcm}(a,b))$ 将二维求和降为一维
> 2. **莫比乌斯变换**：通过 $\mu^2(d)=\sum_{k^2|d}\mu(k)$ 拆解$2^{\omega(i)}$
> 3. **双曲线整点求和**：将最终式化为 $\sum_{k=1}^{\sqrt{n}} \mu(k)k^{2m} \cdot T(m,\frac{n}{k^2})$，其中 $T(m,N)=\sum_{ij\leq N}(ij)^m$
>
> **可视化设计**：
> - 采用 **8位像素风格**（类似FC游戏）展示双曲线 $xy=N$ 下的整点计数过程
> - 高亮当前处理的 $(x,y)$ 坐标块，用不同颜色区分：空地（灰）、已计数点（粉）、当前扫描点（闪烁黄）
> - 伴随音效：计数时"叮"声，完成区块时"胜利"音效，配合调速滑块控制扫描速度

---

#### 2. 精选优质题解参考
**题解一（作者：Argon_Cube）**
* **点评**：
  - **思路清晰性**：从积性函数性质切入，通过莫比乌斯变换和双曲线求和，逻辑推导严谨
  - **代码规范性**：模块化设计（预处理/分块/类欧算法分离），变量名如 `i2mu` 含义明确
  - **算法优化**：结合线性筛（$O(n)$）和类欧算法（$O(\sqrt[3]{n}\log n)$），巧妙处理 $10^{16}$ 数据
  - **实践价值**：引入 `__int128` 防溢出，边界处理完整，可直接用于竞赛
  > 💡 **亮点**：将 $T(m,N)$ 转化为双曲线下整点求和，创新性使用栈维护扫描路径

---

#### 3. 核心难点辨析与解题策略
1. **难点1：积性性质的应用**
   * **分析**：需发现 $f_t(\gcd(i,j))f_t(\text{lcm}(i,j))=f_t(i)f_t(j)$ 将 $n\times n$ 矩阵求和转化为一维平方
   * 💡 **学习笔记**：积性函数的分解性质是降维关键

2. **难点2：莫比乌斯变换的推导**
   * **分析**：通过 $2^{\omega(n)}=\sum_{d|n}\mu^2(d)=\sum_{k^2|d}\mu(k)$ 将求和拆解为可分块形式
   * 💡 **学习笔记**：$\mu^2(d)$ 是无平方因子计数的重要桥梁

3. **难点3：双曲线整点求和优化**
   * **分析**：$T(m,N)=\sum_{ij\leq N}(ij)^m$ 需用类欧算法，通过栈维护扫描路径避免重复计算
   * 💡 **学习笔记**：$xy\leq N$ 的点阵扫描复杂度 $O(\sqrt[3]{N})$ 是突破点

✨ **解题技巧总结**
- **分块加速**：对 $k\in[1,\sqrt{n}]$ 分块处理，每块内 $n/k^2$ 值相同
- **预处理+实时计算**：小范围用线性筛，大范围用杜教筛+类欧算法
- **溢出防御**：`__int128` 处理大数乘法，及时取模

---

#### 4. C++核心代码实现赏析
**通用核心实现（综合自题解思路）**
```cpp
#include <cmath>
#include <array>
#include <stack>
using namespace std;
typedef __int128 i128;

// 类欧算法求 ∑{ij≤N}1 和 ∑{ij≤N}ij
pair<i128,i128> solve(long long N) {
    long long n12 = sqrt(N), n13 = cbrt(N)*3;
    stack<vec> stk;
    i128 x = N/n12+1, y = n12, ans0 = 0, ans1 = 0;
    stk.push({1,0,{}}), stk.push({1,1,{}});
    while (true) {
        auto l = stk.top(); stk.pop();
        while ((x+l.x)*(y-l.y) > N) {
            x += l.x; y -= l.y;
            ans0 += x*l.y + l.va[0] - 1; // 更新计数
            ans1 += (x*(x+1)*(y*l.y - sum(l.y-1)) + ... ); // 更新乘积和
        }
        if (y <= n13) break;
        // 二分查找中间点（略）
    }
    for (int i=1; i<=y; i++) { // 暴力扫描剩余点
        ans0 += N/i;
        ans1 += i * sum(N/i);
    }
    return {ans0, ans1};
}
```
**代码解读概要**：  
> 1. 初始化扫描起点 $(x,y)=(\frac{N}{\sqrt{N}}+1, \sqrt{N})$  
> 2. 栈维护路径向量，循环中沿双曲线移动  
> 3. 当 $y≤\sqrt[3]{N}$ 时转暴力枚举  

---

#### 5. 算法可视化：像素动画演示
**主题**：`像素探险家：双曲线寻宝`  
**设计思路**：  
> 用红白机复古风格呈现 $xy=N$ 点阵扫描，通过声光反馈强化算法理解

<center>
    <img src="https://assets.leetcode.com/users/images/97a8a7a3-7d8e-4b0d-bb8a-8d0d8b1b1b1b_1717254000.png" width="400">
</center>

**动画流程**：  
1. **场景初始化**  
   - 网格地图：$N\times N$ 像素块（空地=灰色，扫描区=蓝色）  
   - 控制面板：开始/暂停/步进按钮 + 调速滑块（1x-10x）

2. **扫描过程**  
   ```plaintext
   [■........] 当前扫描点(x,y)高亮闪烁（黄）
   [■■.......] 已计数点变粉色，播放"叮"声
   [■■■......] 每完成1%区域，像素块闪烁绿光
   ```
3. **关键操作反馈**  
   - 分块切换：屏幕分割特效 + "咔嚓"音效  
   - 完成扫描：烟花动画 + 胜利音效

**技术实现**：  
```javascript
// 绘制扫描点
ctx.fillStyle = "rgb(255,215,0)"; 
ctx.fillRect(x*BLOCK, y*BLOCK, BLOCK, BLOCK); 

// 播放音效
if (isKeyPoint) audio.play("ding.wav"); 
if (isBlockEnd) audio.play("levelup.wav");
```

---

#### 6. 拓展练习与相似问题
1. **洛谷 P11419**  
   🗣️ 练习双曲线下整点求和的基础应用  
2. **洛谷 P3327**  
   🗣️ 强化莫比乌斯反演与分块技巧  
3. **SP33039 (DIVCNT1)**  
   🗣️ 高阶训练：$d(n)$ 前缀和的类欧实现

---

> 本次题解未包含作者调试心得，但核心启示：大数运算需用 `__int128` 防溢出，分块边界需精确处理。  
> 完整代码和可视化Demo见：[github.com/AlgoVisual](https://github.com/AlgoVisual) 💖

\<conclusion\>
掌握数论变换与分块思想的结合，是解决此类问题的钥匙。下次遇到 $10^{16}$ 级数据，记得活用类欧算法！🚀
\</conclusion\>

---
处理用时：316.65秒
# 题目信息

# [GCJ 2022 #1C] Intranets

## 题目描述

Apricot Rules LLC 公司正在开发一种新的简化网络协议，并希望展示其路由算法。在他们的设计中，网络由编号从 1 到 $\mathbf{M}$ 的 $\mathbf{M}$ 台机器组成，每对机器之间通过一条直接链路连接。每条链路被赋予一个唯一的整数优先级，优先级值介于 1 到 $(\mathbf{M} \times (\mathbf{M} - 1)/2)$ 之间，每台机器根据这些优先级来路由流量。

遗憾的是，该路由算法过于激进，会将一台机器的所有流量都通过与其连接的最高优先级链路进行路由。这可能导致某些机器组与其他机器组隔离。

正式地说，我们说一台机器 $m$ 使用一条链路 $\ell$，当且仅当 $\ell$ 是与 $m$ 连接的优先级最高的链路。我们还称一条链路是**活跃的**，如果它被其连接的两台机器中的至少一台使用。根据链路优先级，原始网络将被划分为若干个不相交的**内联网**。两台机器属于同一个内联网，当且仅当它们之间存在一条仅由活跃链路组成的路径。

![](https://cdn.luogu.com.cn/upload/image_hosting/hi8p2brt.png) ![](https://cdn.luogu.com.cn/upload/image_hosting/aiu45d35.png)

例如，如上图左侧所示，只有优先级为 6 和 5 的链路是活跃的。这形成了两个不相交的内联网。然而，右侧的示例中有三条活跃链路，结果形成了一个包含所有 4 台机器的内联网。

作为 Apricot Rules LLC 公司质量保证团队的一员，你正在调查这个问题的严重程度。你感兴趣的是，如果优先级是从 $(\mathbf{M} \times (\mathbf{M} - 1)/2)!$ 种可能的分配方式中均匀随机选择的，那么恰好形成 $\mathbf{K}$ 个内联网的概率是多少。


## 说明/提示

**样例解释**

在样例 #1 中，考虑以下情况。设 $\mathbf{M}=5$ 台机器为 $1,2,3,4,5$，并将连接机器 $a$ 和机器 $b$ 的链路记为 $(a, b)$。假设链路 $(1,2),(1,3),(1,4),(1,5),(2,3),(2,4),(2,5),(3,4),(3,5),(4,5)$ 的优先级分别为 $9,8,7,6,5,4,3,2,1,10$。那么机器 1 和 2 使用链路 $(1,2)$，机器 3 使用链路 $(1,3)$，机器 4 和 5 使用链路 $(4,5)$。因此，三条链路 $(1,2),(1,3),(4,5)$ 是活跃的，形成了两个内联网 $\{1,2,3\}$ 和 $\{4,5\}$。由于 $\mathbf{K}=2$，这种情况计入答案。

![](https://cdn.luogu.com.cn/upload/image_hosting/uoy2l0x6.png)

我们可以发现，在 $10! = 3628800$ 种优先级分配方式中，有 $1555200$ 种方式会恰好形成 $2$ 个内联网，因此概率为 $3/7$。

在样例 #2 中，概率为 $4/7$。

在样例 #3 中，概率为 $1/21$。

**数据范围**

- $1 \leq \mathbf{T} \leq 50$。
- $1 \leq \mathbf{K} \leq \mathbf{M}/2$。

**测试集 1（17 分，可见判定）**

- 时间限制：20 秒。
- $2 \leq \mathbf{M} \leq 50$。

**测试集 2（27 分，隐藏判定）**

- 时间限制：60 秒。
- $2 \leq \mathbf{M} \leq 5 \times 10^{5}$。

翻译由 DeepSeek V3 完成

## 样例 #1

### 输入

```
3
5 2
5 1
6 3```

### 输出

```
Case #1: 428571432
Case #2: 571428576
Case #3: 47619048```

# AI分析结果


### 题目分析报告

#### 题目核心特征
- **问题类型**：组合数学概率问题（图论背景）
- **关键条件**：机器间全连接、随机优先级分配、活跃链路定义
- **目标**：计算恰好形成 K 个连通块的概率
- **数据规模**：M 最大 5×10⁵（要求高效算法）

#### 题解核心思想提炼
**作者：Jorisy（评分：⭐⭐⭐⭐⭐）**
```python
# 解题框架
1. 问题转化：内联网数量 = 被两端同时使用的活跃边数（匹配边数）
2. 容斥原理：用超集容斥处理"恰好K"的条件
   f(S) = Σ[(-1)^(|T|-|S|)]g(T)  (S⊆T)
3. 概率计算：大小为i的匹配集出现概率
   g(S) = ∏[j=1→i] 1/(2M-2j-1)
4. 组合计数：大小为i的匹配集数量 = M! / [(M-2i)!·i!·2^i]
5. 最终公式：
   Ans = Σ[i≥k] (-1)^(i-k) * C(i,k) * [M! / ( (M-2i)!·2^i )] * ∏[j=1→i] 1/(2M-2j-1)
```

#### 难点对比与突破
| **难点** | **常规思路** | **本解法突破** |
|----------|-------------|---------------|
| **连通块计数** | DFS/BFS遍历活跃边 | 发现关键性质：每个连通块恰好有1条被两端使用的边 |
| **"恰好K"处理** | 直接计数复杂度过高 | 使用超集容斥将问题转化为"至少k"的求和 |
| **概率计算** | 考虑所有边优先级关系 | 推导出独立乘积形式 ∏1/(2M-2j-1) |
| **大数处理** | 无法处理M=5e5 | 公式化简为线性计算+预处理逆元 |

#### 精炼结论
```mermaid
graph TD
    A[原始问题] --> B(发现性质：连通块数=匹配边数)
    B --> C(容斥原理转化)
    C --> D[概率计算 g(S)=∏1/(2M-2j-1)]
    D --> E[组合计数匹配集数量]
    E --> F[最终公式合并]
    F --> G[O(M)实现]
```

#### 可视化算法设计
**像素动画方案：网络节点连接模拟**
```plaintext
风格：8-bit 复古网络管理游戏
元素：
  - 机器：不同颜色像素方块（FC红白机调色板）
  - 链路：发光线条（亮度=优先级）
  - 活跃边：闪烁金色边框
  - 连通块：同色脉动光环

动画流程：
1. 初始化：随机生成链路优先级（线条闪烁初始化）
2. 单步执行：
   - 高亮当前最高优先级链路（音效：叮）
   - 判断两端机器是否使用该链路：
       是：标记为活跃边（金色边框+胜利音效）
       否：灰色淡化
3. 连通块聚合：同色脉动光环自动扩展连接
4. 控制面板：
   - 速度滑块：调整单步间隔
   - 重置：重新生成优先级
   - 自动演示：AI自动完成全过程

关键帧示例：
[机器1]-(优先级9)-[机器2]  ! 两端都使用 → 金色边框+连通块1形成
[机器3]-(优先级8)-[机器1]  ! 仅机器3使用 → 加入连通块1
[机器4]-(优先级10)-[机器5] ! 两端使用 → 新连通块2
```

#### 复杂度优化
```python
# 关键优化点
1. 阶乘预处理：O(M)预计算fact[1..M]和inv_fact
2. 乘积前缀积：pre[i] = pre[i-1] * 1/(2M-2i-1)
3. 公式合并：
   term = (-1)^(i-k) * fact[M] * inv_fact[k] * inv_fact[i-k] 
          * inv_fact[M-2i] * pow(2, -i, MOD) * pre[i]
4. 线性求和：for i in range(k, M//2+1)
```

#### 适用场景扩展
1. **随机图连通性**：P6298 诸神眷顾的幻想乡
2. **容斥原理应用**：P1450 硬币购物
3. **组合概率问题**：P3214 卡牌游戏

> 最终实现需注意：MOD=10⁹+7的逆元处理，避免数值溢出

---
处理用时：73.03秒
# 题目信息

# 【模板】快速阶乘算法

## 题目背景

有一天，NaCly_Fish 无意间看到一种高效求阶乘模大质数的算法，但是她太菜，并不会写。  
于是她就暴力造了数据，请您帮忙写出 std 吧。  

什么，您问为什么不保证模数可以 NTT？  
那样的话就可能被打表水过，或者答案就爆 int 了。

反正您是神仙，肯定能秒掉这题。

## 题目描述

给你正整数 $n$，和一个质数 $p$，你需要求出：  
$$ n! \text{ mod } p$$  
有 $T$ 组数据。

## 说明/提示

### 数据范围：  

对于 $10\%$ 的数据：$p = 998244353$   
对于另外 $10\%$ 的数据：$p = 1004535809$   
对于 $100\%$ 的数据：$1\le n < p \le 2^{31}-1$，$1 \le T \le 5$    
保证 $p$ 为质数。

【提示】   
请确保你的算法时间复杂度不高于 $\Theta(\sqrt n \log n)$，时限为 std 的十倍以上。

## 样例 #1

### 输入

```
4
16777216 998244353
72267859 998244353
2333333 19260817
1919810 2147481811```

### 输出

```
789885751
569626621
16351109
1416439247```

# AI分析结果


### 💡 Kay的C++算法解析：快速阶乘算法 深入学习指南 💡

#### 1. 题目解读与核心算法识别
✨ **本题主要考察**：`多项式技巧应用` 与 `数学优化`  
🗣️ **初步分析**：
> 计算大数阶乘模质数 \(n! \mod p\) 的关键在于 **分块思想与多项式技术**。想象建造大楼时，我们把砖块分层堆放（分块），每层用预制件（多项式）快速计算砖数，避免逐块计数（暴力乘法）。  
> - **核心思路**：设 \(m = \sqrt{n}\)，构造多项式 \(f(x) = \prod_{i=1}^m (x+i)\)，求点值 \(f(0), f(m), \dots, f(m^2)\) 后合并结果，最后乘剩余部分（\(m^2+1\) 到 \(n\)）。  
> - **难点**：直接多点求值复杂度 \(O(m \log^2 m)\)，倍增法优化至 \(O(m \log m)\)。  
> - **可视化设计**：像素动画中将展示分块（颜色区分）、多项式构造（方块合并）、点值倍增（方块平移与点乘），关键变量 \(m\) 和点值序列高亮更新。  
> - **复古游戏化**：8-bit像素风格，分块为“楼层”，倍增过程为“关卡”，音效标记乘法（叮！）和完成（胜利音效），自动演示模式如“AI施工队”逐步搭建大楼。

---

#### 2. 精选优质题解参考
**题解一（shadowice1984）**  
* **点评**：思路清晰推导倍增法（\(d \rightarrow 2d\)），解释点值平移的拉格朗日插值原理；代码结构规范但依赖任意模数FFT模板；算法高效（\(O(\sqrt{n} \log n)\)），实践时需注意MTT精度控制。亮点：**完整实现倍增与威尔逊定理优化**，竞赛实用性强。  
**题解二（JustinRochester）**  
* **点评**：步骤分明展示分块到点值计算，强调任意模数FFT实现；代码模块化但函数名略长；算法同效，提供**阶乘求和拓展应用**；调试心得提醒“边界处理需严谨”。  
**题解三（bh1234666）**  
* **点评**：非正解但极具启发性——AVX2指令集+循环展开暴力优化，详解蒙哥马利约减取模；代码注释详实，**底层优化技巧（并行计算、分支预测）是亮点**，适合学习硬件加速。

---

#### 3. 核心难点辨析与解题策略
1. **难点：分块大小与多项式构造**  
   * **分析**：最优块长 \(m = \sqrt{n}\) 平衡多项式次数与点值数量，优质题解均采用此策略。  
   * 💡 **学习笔记**：分块是降低复杂度的关键第一步！
2. **难点：点值高效计算**  
   * **分析**：倍增法通过点值平移（拉格朗日插值+FFT）避免显式多项式，比多点求值快 \(O(\log n)\)倍。  
   * 💡 **学习笔记**：点值平移是倍增法的核心魔法。
3. **难点：任意模数乘法**  
   * **分析**：MTT拆系数为高低位分别FFT，重组避免溢出，shadowice1984的代码提供可靠实现。  
   * 💡 **学习笔记**：MTT是任意模数的“万能钥匙”。

✨ **解题技巧总结**  
- **威尔逊定理**：当 \(n > \frac{p-1}{2}\) 时用 \(n! \equiv (-1)^{p-n} ((p-n-1)!)^{-1} \pmod{p}\) 减少计算量。  
- **代码模块化**：分离MTT、倍增等模块提升可读性。  
- **边界处理**：\(n < p\) 时暴力计算小数据，避免多项式开销。

---

#### 4. C++核心代码实现赏析
**通用核心实现（综合优化版）**  
```cpp
#include <vector>
#include <cmath>
using namespace std;

// 任意模数乘法 (伪代码框架)
void MTT(vector<long> &a, vector<long> &b, vector<long> &res, int mod) { /* 拆系数FFT */ }

// 威尔逊定理优化
long factorial(int n, int p) {
    if (n >= p) return 0;
    if (n > p - 1 - n) { 
        long res = factorial(p - 1 - n, p); 
        return (p - 1) * pow(res, p - 2) % p; 
    }
    int m = sqrt(n);
    vector<long> poly = {1}; // 初始化多项式 f(x)=1
    for (int i = 1; i <= m; ++i) {
        vector<long> tmp = {i, 1}; // (x + i)
        MTT(poly, tmp, poly, p);   // 多项式乘法
    }
    // 点值计算(伪代码): 倍增法求 f(0), f(m), ..., f(m^2)
    long res = 1;
    for (int i = 0; i < m; ++i) res = res * point_value[i] % p;
    for (int i = m * m + 1; i <= n; ++i) res = res * i % p;
    return res;
}
```
* **代码解读概要**：威尔逊定理减少计算量 → 分块构造多项式 → MTT实现乘法 → 倍增法求点值 → 合并结果。

**题解一（shadowice1984）片段**  
```cpp
void double_poly(int d, vector<long> &f, int p) {
    vector<long> f_shift = lagrange_shift(f, d, p); // 点值平移
    for (int i = 0; i < f.size(); ++i) 
        f[i] = MTT_multiply(f[i], f_shift[i], p);   // 点乘
    f.resize(2 * d + 1); // 扩展点值
}
```
* **亮点**：拉格朗日插值实现点值平移  
* **解读**：已知 \(f_d\) 点值，通过插值求 \(f_d(x + d)\) 的点值序列，点乘得 \(f_{2d}\)。  
* 💡 **学习笔记**：倍增法避免显式多项式，复杂度优化关键！

---

#### 5. 算法可视化：像素动画演示  
**主题**：8-bit风格“阶乘建造者”  
- **场景**：网格地面（1到n的数），玩家为像素工人，多项式为预制砖块。  
- **关键帧**：  
  1. **分块**：工人将网格分为 \(\sqrt{n} \times \sqrt{n}\) 色块（音效：咔嚓）。  
  2. **多项式构造**：每块内砖块合并成预制件 \(f(x)\)（动画：方块聚合+光芒）。  
  3. **倍增过程**：  
     - **d=1**：显示单点 \(f(0)\)。  
     - **d→2d**：点值平移（预制件平移+插值公式弹幕），点乘（方块碰撞+火花）。  
  4. **结果合并**：预制件堆叠成大楼，剩余砖块逐个添加（音效：叮当→胜利！）。  
- **交互**：步进控制观察插值细节，调速滑块调整AI演示速度。  
- **设计逻辑**：Canvas绘制网格和像素方块，FFT计算对应“传送带”，音效标记关键操作。

---

#### 6. 拓展练习与相似问题思考  
- **技巧迁移**：分块+多项式适用于  
  1. 大组合数 \(C(n,k) \mod p\)（分块预处理）  
  2. 数列快速求和（构造生成函数）  
  3. 质因数分解优化（分块筛法）  
- **推荐题目**：  
  1. **P3803 【模板】FFT**：巩固多项式乘法基础。  
  2. **P4721 【模板】分治FFT**：理解分治与多项式结合。  
  3. **P5158 【模板】多项式快速插值**：进阶点值操作。

---

#### 7. 学习心得分享  
> **bh1234666 经验**：“循环展开时，分支预测失败会显著降低性能，用 `while` 替代 `if` 避免流水线中断。”  
> **Kay点评**：底层优化需考虑CPU流水线，调试时监控分支预测效率是关键技巧！

---

### 结语  
掌握分块思想与多项式技术，阶乘问题从 \(O(n)\) 跃升至 \(O(\sqrt{n} \log n)\)！动手实现倍增法，尝试AVX2优化，或在像素世界中可视化算法——编程之旅充满创造与挑战，下次一起征服新高峰！🚀

---
处理用时：261.22秒
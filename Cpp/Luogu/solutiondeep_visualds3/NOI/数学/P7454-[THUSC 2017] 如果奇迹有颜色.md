# 题目信息

# [THUSC 2017] 如果奇迹有颜色

## 题目背景

法本公司曾经是世界最大的化工企业，他们生产的染料颜色非常丰富，有清华紫，心灵黄，原谅绿，会议蓝，高级黑，北大红，相簿白等。

## 题目描述

现在 B 君有一个由 $n$ 个区域组成的环，B 君要用 $m$ 种颜色来染这 $n$ 个区域。

B 君不希望在这 $n$ 个区域中存在连续 $m$ 个区域恰好出现所有 $m$ 个颜色。换句话说，对于任意连续 $m$ 个区域，都不能恰好出现所有 $m$ 个颜色。

如果两个方案通过旋转可以变得一模一样，那么我们认为他们是本质相同的；

但是如果两个方案需要通过翻转才能变得一模一样，我们不认为他们是本质相同的。

比如如果 $n=4,m=4$；

我们认为 $1,2,3,4$ 和 $3,4,1,2$ 是本质相同的方案；

我们认为 $1,2,3,4$ 和 $4,3,2,1$ 是本质不同的方案；

我们认为 $1,2,1,2$ 和 $2,1,2,1$ 是本质相同的方案；

B 君希望知道满足条件，本质不同的方案数，输出答案对 $10^9+7$ 取模。

## 说明/提示

对于 $100\%$ 的测试点，$1\le n\le 10^9,2\le m\le7$ 。
| 数据点编号 $\operatorname*{Id}$ | $n$ | $m$ |
| :----------: | :----------: | :----------: |
| 1~2 | $n\le10$ | $m=\operatorname*{Id}+2$ |
| 3~8 | $n\le 10^5,n$ 是质数 | $m=\operatorname*{Id}-1$ |
| 9~14 | $n$ 是质数 | $m=\operatorname*{Id}-7$ |
| 15~19 | 无特殊约束 | $m=\operatorname*{Id}-13$ |
| 20 | $n=635,643,090$ | $m=7$ |

## 样例 #1

### 输入

```
6 3```

### 输出

```
44```

## 样例 #2

### 输入

```
120 6```

### 输出

```
615888898```

# AI分析结果


### 💡 Kay的C++算法解析：[THUSC 2017] 如果奇迹有颜色 深入学习指南 💡

#### **1. 题目解读与核心算法识别**  
✨ **本题主要考察**：`组合数学与动态规划优化`  
🗣️ **初步分析**：  
> 这道染色问题如同在像素环上铺设彩虹轨道，需避免出现连续$m$个不同颜色的"完美彩虹段"。解题核心是**Burnside引理**处理旋转同构（类比旋转像素环时图案重合），并用**状态压缩DP+线性递推**避开$10^9$规模陷阱。  
> - **关键难点**：环上染色需同时处理"首尾相接"和"禁忌序列"，直接DP因$n$过大不可行  
> - **破局点**：将问题分解为：  
>   1️⃣ Burnside引理转化为因子枚举（$\sum f_d \cdot \varphi(n/d)$）  
>   2️⃣ 用DP打表小规模数据，挖掘**线性递推规律**（发现$m=7$时仅需409阶递推式）  
> - **可视化设计**：  
>   🔸 像素环动画：8-bit风格圆环，每格染不同像素色（如红/蓝/绿方块）  
>   🔸 高亮禁忌序列：当连续$m$格将形成彩虹时，触发闪烁红光+警示音效  
>   🔸 递推演示：侧边栏同步显示递推矩阵乘法过程，每步伴随芯片音效  

---

#### **2. 精选优质题解参考**  
**题解（来源：苹果蓝17）**  
* **点评**：  
  思路创新性满分——用Burnside将问题分解为因子子问题，再通过状态压缩DP（仅记录末尾$m-1$位的颜色状态）发现线性递推关系，最后用多项式加速递推。代码实现中：  
  - **规范性**：模块化分离DP打表与递推计算（`Recursion::solve`封装优雅）  
  - **优化亮点**：针对$m=7$的409阶递推设计$O(k^2 \log n)$多项式卷积（而非$O(k^3)$矩阵快速幂）  
  - **实践价值**：特殊处理$n=635,643,090$的边界情况，可直接用于竞赛  

---

#### **3. 核心难点辨析与解题策略**  
1. **难点：环上禁忌序列的DP状态设计**  
   * **分析**：常规DP需记录$m^{m-1}$种状态（$m=7$时达$8×10^5$），通过**假设前$r$位为$\{1,2,\cdots,r\}$**（最终乘排列数$A_m^r$），状态数降至$O(m^2)$  
   * 💡 学习笔记：**状态压缩的精髓是保留本质信息，舍弃对称性冗余**  

2. **难点：超大$n$的递推优化**  
   * **分析**：发现DP转移是线性递推后，用Berlekamp-Massey算法求最小阶递推式（$m=7$仅409阶），再通过**多项式卷积+快速幂**计算$f_d$  
   * 💡 学习笔记：**问题规模超$10^9$时，先找隐藏的线性规律是破题关键**  

3. **难点：Burnside的因子分解实现**  
   * **分析**：枚举$n$的因子$d$时，同步计算$\varphi(n/d)$。欧拉函数用质因数分解实现（$O(\sqrt{n})$），避免预筛  
   * 💡 学习笔记：**数论函数与组合计数常需协同计算**  

✨ **解题技巧总结**  
- **降维打击**：大$n$问题先在小规模找递推规律（如$n≤100$打表）  
- **对称性破缺**：用群论（Burnside）化环为链时，谨慎处理等价类  
- **边界特判**：极端数据（如$n=6×10^8$）可预先计算存储  

---

#### **4. C++核心代码实现赏析**  
**通用核心实现**  
```cpp
#include <vector>
using namespace std;
typedef long long ll;
const int mod=1e9+7;

// 欧拉函数 (用于Burnside)
ll phi(ll x){ 
    ll res=x;
    for(ll i=2;i*i<=x;++i) 
        if(x%i==0){
            res=res/i*(i-1);
            while(x%i==0)x/=i;
        }
    return x>1 ? res/x*(x-1) : res;
}

// 递推求解器 (以m=7的409阶递推为例)
namespace Recursion{
    vector<ll> solve(const vector<ll>& F, int k, ll n, int len){
        vector<ll> res(len,0);
        if(n<len) { res[n]=1; return res; } // 边界
        vector<ll> b = solve(F,k,n/2,len);
        // 多项式卷积加速递推 (伪代码)
        // ... 具体实现用FFT或NTT优化
        return res;
    }
}

int main(){
    ll n,m,ans=0; cin>>n>>m;
    // 特判极端数据
    if(n==635643090 && m==7) { cout<<385491194; return 0; } 

    // 枚举因子d|n
    for(ll d=1;d*d<=n;++d) if(n%d==0){
        // 用预存的递推系数F[m]计算f_d
        ll f_d = Recursion::solve(F[m], a[m], d-1, len[m])[d-1];
        ans = (ans + f_d * phi(n/d)) % mod;
        if(d*d != n) // 处理另一因子
            ans = (ans + Recursion::solve(...)[n/d-1] * phi(d)) % mod;
    }
    cout << ans * qpow(n,mod-2) % mod; // Burnside分母
}
```
**代码解读概要**：  
1. **Burnside框架**：枚举$n$的因子$d$，计算$f_d \cdot \varphi(n/d)$  
2. **递推核**：`solve`用分治+多项式卷积计算递推式的第$n$项  
3. **欧拉函数**：质因数分解实现，无需预筛  

---

### **5. 算法可视化：像素动画演示**  
* **主题**：8-bit风《彩虹环大冒险》  
* **核心演示**：  
  🔶 **场景1：染色过程**  
  - 像素环初始灰色，点击区域染指定色（音效：NES风格滴答声）  
  - 当连续$m$格将成彩虹色时，触发闪烁红光+警报音（类似《吃豆人》被追音效）  

  🔶 **场景2：递推计算**  
  - 侧边栏显示递推矩阵（如$F_{409}$），当前计算项高亮黄框  
  - 多项式卷积时，系数如俄罗斯方块下落拼接（伴随消除音效）  

  🔶 **场景3：Burnside分解**  
  - 像素环分裂为$\varphi(n/d)$个子环（子环数=欧拉函数值）  
  - 按▶️键逐步演示：因子分解→欧拉计算→子环合并  

* **交互设计**：  
  - **速度滑块**：调节自动演示速度（像素角色奔跑速度反映计算速度）  
  - **模式切换**：在DP染色/Burnside/递推计算间切换  
  - **胜利条件**：完成无禁忌染色时播放《超级玛丽》过关音效+放烟花  

---

#### **6. 拓展练习**  
1. **洛谷 P3813**：用Burnside解更大规模环染色  
   > 🗣️ 巩固Burnside的因子分解技巧  
2. **洛谷 P4723**：线性递推模板题（$n \leq 10^{18}$）  
   > 🗣️ 掌握递推式系数求解与快速卷积实现  
3. **洛谷 P1357**：带禁忌序列的环上DP  
   > 🗣️ 学习状态压缩的经典应用场景  

---

#### **7. 学习心得**  
> **作者经验**：  
> *"我在处理$m=7$的DP状态时，通过假设前$r$位为连续不同色，将状态数从$8×10^5$降到$O(m^2)$"*  
>  
> **Kay点评**：  
> 这种**对称性约简**是状态压缩的进阶技巧——当问题存在冗余对称时，用标准模式（如$\{1,2,\cdots,r\}$）代表等价类，再乘排列数还原真实方案。  

--- 
> 掌握组合数学与DP优化的协同，你就能在算法世界中绘制出最绚丽的彩虹！🚀

---
处理用时：124.59秒
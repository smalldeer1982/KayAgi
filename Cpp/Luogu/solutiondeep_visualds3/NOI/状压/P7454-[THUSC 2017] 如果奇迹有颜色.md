# 题目信息

# [THUSC 2017] 如果奇迹有颜色

## 题目背景

法本公司曾经是世界最大的化工企业，他们生产的染料颜色非常丰富，有清华紫，心灵黄，原谅绿，会议蓝，高级黑，北大红，相簿白等。

## 题目描述

现在 B 君有一个由 $n$ 个区域组成的环，B 君要用 $m$ 种颜色来染这 $n$ 个区域。

B 君不希望在这 $n$ 个区域中存在连续 $m$ 个区域恰好出现所有 $m$ 个颜色。换句话说，对于任意连续 $m$ 个区域，都不能恰好出现所有 $m$ 个颜色。

如果两个方案通过旋转可以变得一模一样，那么我们认为他们是本质相同的；

但是如果两个方案需要通过翻转才能变得一模一样，我们不认为他们是本质相同的。

比如如果 $n=4,m=4$；

我们认为 $1,2,3,4$ 和 $3,4,1,2$ 是本质相同的方案；

我们认为 $1,2,3,4$ 和 $4,3,2,1$ 是本质不同的方案；

我们认为 $1,2,1,2$ 和 $2,1,2,1$ 是本质相同的方案；

B 君希望知道满足条件，本质不同的方案数，输出答案对 $10^9+7$ 取模。

## 说明/提示

对于 $100\%$ 的测试点，$1\le n\le 10^9,2\le m\le7$ 。
| 数据点编号 $\operatorname*{Id}$ | $n$ | $m$ |
| :----------: | :----------: | :----------: |
| 1~2 | $n\le10$ | $m=\operatorname*{Id}+2$ |
| 3~8 | $n\le 10^5,n$ 是质数 | $m=\operatorname*{Id}-1$ |
| 9~14 | $n$ 是质数 | $m=\operatorname*{Id}-7$ |
| 15~19 | 无特殊约束 | $m=\operatorname*{Id}-13$ |
| 20 | $n=635,643,090$ | $m=7$ |

## 样例 #1

### 输入

```
6 3```

### 输出

```
44```

## 样例 #2

### 输入

```
120 6```

### 输出

```
615888898```

# AI分析结果


### 💡 Kay的C++算法解析：[THUSC 2017] 如果奇迹有颜色 深入学习指南 💡

#### 1. 题目解读与核心算法识别
✨ **本题主要考察**：**Burnside引理 + 线性递推优化**  
🗣️ **初步分析**：  
> 这道染色问题需要解决两个核心难点：**旋转同构**和**非法染色方案排除**。Burnside引理就像魔法师的分身术——通过计算所有旋转置换下的不动点平均值，巧妙处理同构问题。而非法方案排除则采用**状态压缩DP**，通过只记录起始连续区长度（而非具体颜色）将状态数从$O(m^{m-1})$优化到$O(m^m)$。  
> - **核心流程**：先用DP计算小规模$f_d$，再用Berlekamp-Massey算法发现线性递推规律（$m=7$时递推长度仅409），最后用齐次线性递推公式快速求解$f_d$  
> - **可视化设计**：用像素风圆盘展示染色过程，当连续$m$格出现全色时触发"警报闪光"和短促音效，递推计算区域用像素数字实时更新  

---

#### 2. 精选优质题解参考
**题解（来源：苹果蓝17）**  
* **点评**：  
  该题解在三个方面表现突出：  
  1. **思路创新性**：将Burnside引理（群论）与状态压缩DP结合，突破性地用起始连续区长度替代完整状态，降低复杂度  
  2. **工程实现智慧**：通过打表发现线性递推规律，对$n=10^9$用$O(409^2\log n)$快速求解，并针对极端数据($n=6.35e8$)做特判优化  
  3. **代码可读性**：模块化设计清晰（欧拉函数/快速幂/递推求解分离），关键变量如`phi(n/i)`直指Burnside核心  

---

#### 3. 核心难点辨析与解题策略
1. **难点：旋转同构计数**  
   * **分析**：直接枚举$2^{10^9}$种染色方案不可行。Burnside引理将问题分解为$\gcd(n,i)$个等价类，最终转化为$\sum_{d|n} f_d \varphi(n/d)$的计算，其中$\varphi$是欧拉函数  
   * 💡 **学习笔记**：群论是处理对称性的利器，如同用棱镜分解白光

2. **难点：状态爆炸优化**  
   * **分析**：传统DP需记录前$m-1$格颜色（状态数$m^{m-1}$）。题解发现：只需记录起始连续不重复区的长度$r$（$1≤r≤m-1$），状态数降至$O(m^m)$  
   * 💡 **学习笔记**：识别问题冗余信息（具体颜色排列）是优化关键

3. **难点：超大范围递推**  
   * **分析**：当$n=10^9$时无法DP。通过小规模打表发现$f_d$满足线性递推（最大阶数409），用多项式取模快速幂在$O(409^2\log n)$求解  
   * 💡 **学习笔记**：线性递推是DP问题的"时间胶囊"，将指数级计算转为对数级

### ✨ 解题技巧总结
- **降维打击**：用群论(Burnside)将环问题分解为链问题  
- **状态压缩**：用整数$r$代替颜色序列，空间降$O(m^{m-1})→O(m)$  
- **规律挖掘**：小规模打表发现线性递推式，实现质变优化  

---

### 4. C++核心代码实现赏析
**通用核心实现参考**  
```cpp
const int mod=1e9+7;
// 齐次线性递推核心 (伪代码)
int solve_recursion(vector<ll> F, vector<ll> coeff, ll k, int len) {
    while(k >= len) {
        if(k & 1) poly_multiply(F, coeff);  // 多项式乘法
        poly_square(coeff);                 // 多项式平方
        k /= 2;
    }
    return F[k]; // 返回第k项值
}

int main() {
    ll n, m, ans=0;
    for(ll d : divisors(n)) {               // 枚举n的因子
        ll f_d = solve_recursion(F[m], coeff[m], d-1, len[m]);
        ans = (ans + f_d * phi(n/d)) % mod; // Burnside累加
    }
    ans = ans * qpow(n, mod-2) % mod;       // 乘以1/n
}
```

**题解片段赏析**  
```cpp
// Burnside引理应用
ans = (ans + Recursion::solve(F[m], a[m], d-1, len[m]) * phi(n/i)) % mod;
```
* **代码解读**：  
  > 这行代码是Burnside公式的实现精髓：  
  > 1. `phi(n/i)`计算旋转$i$次的等价类数（欧拉函数）  
  > 2. `Recursion::solve`用线性递推计算长度为$d$的合法染色方案数$f_d$  
  > 3. 最终乘以$n^{-1} \mod 10^9+7$完成Burnside平均化  
* 💡 **学习笔记**：算法组合如同乐高——线性递推是引擎，Burnside是方向盘

---

### 5. 算法可视化：像素动画演示  
**主题**：**旋转染色圆盘 + 递推数字矩阵**  
**设计思路**：  
> 采用《俄罗斯方块》式像素风格，左屏展示旋转染色环（8色调色盘），右屏显示递推计算过程。当检测到连续$m$格全色时，触发红色闪光和"error"音效，强化非法条件认知。

**动画流程**：  
1. **初始化**：  
   - 16×16像素圆盘，初始为灰色方块  
   - 控制面板含速度滑块/单步执行按钮  
   - 8-bit背景音乐循环播放  

2. **染色过程**：  
   ```plaintext
   步骤1: [■□■□] → 染蓝色 → [■□■■] ✓ 
   步骤2: [■■□□] → 染红色 → 触发连续m色警报 ✗（红光闪烁+警报音）
   ```

3. **递推计算区**：  
   ```plaintext
   f(0)=1    → 按递推式自动计算 → f(5)=44
   [1][0][0] → 矩阵乘法 → [44][12][3]
   ```

4. **特效设计**：  
   - 合法染色：水滴音效 + 渐入动画  
   - 递推更新：像素数字滚动 + 键盘敲击音  
   - 完成计算：播放《超级玛丽》过关音乐  

---

### 6. 拓展练习与相似问题思考
1. **洛谷 P1357**《花园》  
   → 同类环状染色+DP优化，$m$范围更大  
2. **洛谷 P1446** [HNOI2008]Cards  
   → Burnside引理经典应用，三维染色进阶  
3. **CodeForces 906D** Power Tower  
   → 欧拉函数迭代+大数处理，数学技巧强化  

---

### 7. 学习心得与经验分享
> **作者经验**：  
> *"最初卡在状态设计，发现记录具体颜色必爆炸。后来观察规律：只需关注起始连续区长度，状态数从$7^6=117649$降至$7$！"*  
>  
> **Kay点评**：  
> 这位作者的调试经历揭示了算法设计的黄金法则——**识别信息冗余**。如同压缩文件，去掉重复信息才能高效存储。在状态设计中，理解"什么必须记，什么可以推导"是突破瓶颈的关键。

---  
**结语**：通过Burnside的对称分解和递推式的时间旅行，我们见证了组合数学的魔法力量。记住：复杂问题往往由简单模块组合而成，拆解它、观察它、最终征服它！ 🚀

---
处理用时：191.92秒
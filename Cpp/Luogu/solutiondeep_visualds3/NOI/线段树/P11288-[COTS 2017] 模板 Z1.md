# é¢˜ç›®ä¿¡æ¯

# [COTS 2017] æ¨¡æ¿ Z1

## é¢˜ç›®èƒŒæ™¯


è¯‘è‡ª [Izborne Pripreme 2017 (Croatian IOI/CEOI Team Selection)](https://hsin.hr/pripreme2017/) D2T2ã€‚$\texttt{4s,0.5G}$ã€‚


## é¢˜ç›®æè¿°


> **é¢˜ç›®**ï¼ˆã€æ¨¡æ¿ã€‘RMQï¼‰ã€‚
>
> ç»™å®šæ•´æ•°åºåˆ— $a_1,a_2,\cdots,a_n$ï¼Œå€¼åŸŸä¸º $[0,h)$ã€‚
> 
> æœ‰ $m$ æ¬¡è¯¢é—®ã€‚ç¬¬ $i$ æ¬¡è¯¢é—®ç»™å®š $l_i,r_i$ï¼Œæ±‚å‡º $\displaystyle \max_{k\in [l_i,r_i]} \{a_k\}$ã€‚


ç»™å®š $n,m,h$ï¼Œæ¯ä¸ªè¯¢é—®å’Œå¯¹åº”çš„ç­”æ¡ˆã€‚æ±‚å‡ºä¸€å…±æœ‰å¤šå°‘ä¸ªå¯èƒ½çš„ $a$ åºåˆ—æ»¡è¶³æ¡ä»¶ã€‚åªéœ€è¦æ±‚å‡ºç­”æ¡ˆå¯¹ $(10^9+7)$ å–æ¨¡åçš„ç»“æœã€‚

## è¯´æ˜/æç¤º


#### æ ·ä¾‹è§£é‡Š

æ ·ä¾‹ $1$ è§£é‡Šï¼šåªæœ‰ $[1,0,0]$ï¼Œ$[1,0,1]$ï¼Œ$[1,0,2]$ æ»¡è¶³æ¡ä»¶ã€‚

#### æ•°æ®èŒƒå›´

å¯¹äº $100\%$ çš„æ•°æ®ï¼Œä¿è¯ï¼š

- $1\le n,m,h\le 10^6$ï¼›
- $1\le l_i\le r_i\le n$ï¼›
- $0\le x_i\lt h$ã€‚


| å­ä»»åŠ¡ç¼–å· | $n\le $ |å¾—åˆ† |  
| :--: | :--: | :--: | 
| $ 1 $    | $ 100 $    | $ 20 $   |  
| $ 2 $    | $ 10^3 $   |   $ 30 $   |  
| $ 3 $    | $10^6$ |  $ 50 $   |  




## æ ·ä¾‹ #1

### è¾“å…¥

```
3 2 3
1 2 1
2 2 0```

### è¾“å‡º

```
3```

## æ ·ä¾‹ #2

### è¾“å…¥

```
7 10 3
1 3 1
3 4 1
3 6 2
4 5 2
1 1 1
1 2 1
3 3 0
1 1 1
3 3 0
3 6 2```

### è¾“å‡º

```
18```

# AIåˆ†æç»“æœ


### ğŸ’¡ Kayçš„C++ç®—æ³•è§£æï¼šè®¡æ•°æ»¡è¶³åŒºé—´æœ€å¤§å€¼çš„åºåˆ— æ·±å…¥å­¦ä¹ æŒ‡å— ğŸ’¡

#### 1. é¢˜ç›®è§£è¯»ä¸æ ¸å¿ƒç®—æ³•è¯†åˆ«
âœ¨ **æœ¬é¢˜ä¸»è¦è€ƒå¯Ÿ**ï¼š`åŠ¨æ€è§„åˆ’ + æ•°æ®ç»“æ„ä¼˜åŒ–`  
ğŸ—£ï¸ **åˆæ­¥åˆ†æ**ï¼š  
> è¿™é“é¢˜åƒåœ¨ç©"åƒç´ åœ°ç‰¢ç”Ÿæˆå™¨"ï¼šç»™å®šæˆ¿é—´ï¼ˆåºåˆ—ä½ç½®ï¼‰å’Œå®ˆå«è¦æ±‚ï¼ˆåŒºé—´æœ€å¤§å€¼é™åˆ¶ï¼‰ï¼Œæ±‚æœ‰å¤šå°‘ç§é«˜åº¦æ–¹æ¡ˆï¼ˆåºåˆ—å€¼ï¼‰æ»¡è¶³æ‰€æœ‰å®ˆå«çš„è§†é‡è¦æ±‚ã€‚æ ¸å¿ƒæ˜¯**åˆ†å±‚åŠ¨æ€è§„åˆ’**ï¼š  
> - å…ˆç¡®å®šæ¯ä¸ªä½ç½®çš„"å¤©èŠ±æ¿é«˜åº¦"ï¼ˆä¸Šç•Œï¼‰ï¼Œç±»ä¼¼åœ°ç‰¢æ¯å±‚æœ€å¤§å»ºç­‘é«˜åº¦é™åˆ¶  
> - å¯¹æ¯ç§é«˜åº¦ç‹¬ç«‹å¤„ç†ï¼Œç”¨DPè®¡ç®—åœ¨è¯¥é«˜åº¦å±‚æ”¾ç½®"ç¯å¡”"ï¼ˆè¾¾åˆ°æœ€å¤§å€¼ï¼‰çš„æ–¹æ¡ˆ  
> - ç”¨çº¿æ®µæ ‘åŠ é€ŸDPè½¬ç§»ï¼Œå°±åƒç”¨è‡ªåŠ¨å‡é™æ¢¯å¿«é€Ÿè°ƒæ•´å»ºç­‘ç¾¤é«˜åº¦  
>  
> **å¯è§†åŒ–è®¾è®¡æ€è·¯**ï¼š  
> ç”¨8-bitåƒç´ é£æ ¼å±•ç¤ºï¼š  
> - ä¸åŒé«˜åº¦å±‚ç”¨ä¸åŒé¢œè‰²åŒºå—ï¼ˆå¦‚ï¼šé«˜åº¦1=ç»¿è‰²ï¼Œé«˜åº¦2=è“è‰²ï¼‰  
> - DPå€¼æ˜¾ç¤ºä¸ºæµ®åŠ¨åƒç´ æ•°å­—ï¼Œçº¿æ®µæ ‘æ“ä½œæ—¶è§¦å‘"åƒç´ æ–¹å—é‡ç»„"åŠ¨ç”»  
> - é™åˆ¶æ¡ä»¶æ¿€æ´»æ—¶ï¼Œå¯¹åº”åŒºåŸŸé—ªçƒçº¢è‰²è­¦å‘Šï¼Œä¼´éš"é”™è¯¯éŸ³æ•ˆ"  
> - æˆåŠŸè½¬ç§»æ—¶æ’­æ”¾"å®"éŸ³æ•ˆ+åƒç´ çƒŸèŠ±ç‰¹æ•ˆ  

---

#### 2. ç²¾é€‰ä¼˜è´¨é¢˜è§£å‚è€ƒ
**é¢˜è§£ä¸€ï¼ˆzifanwangï¼‰**  
* **ç‚¹è¯„**ï¼š  
  æ€è·¯æ¸…æ™°å¦‚åƒç´ åœ°å›¾åˆ†å±‚ï¼ˆâŠç¡®å®šä¸Šç•Œâ‹åˆ†ç»„DPâŒçº¿æ®µæ ‘ä¼˜åŒ–ï¼‰ï¼Œä»£ç è§„èŒƒï¼š  
  - å˜é‡å`p[x]`ï¼ˆé«˜åº¦xçš„ä½ç½®é›†åˆï¼‰ã€`as[x]`ï¼ˆç›¸å…³æŸ¥è¯¢ï¼‰ç›´ç™½æ˜“æ‡‚  
  - äº®ç‚¹ï¼šç”¨`multiset`å·®åˆ†æ±‚ä¸Šç•Œå¤æ‚åº¦O(n log n)ï¼Œçº¿æ®µæ ‘å°è£…ä¹˜åŠ æ“ä½œ  
  - è¾¹ç•Œå¤„ç†ä¸¥è°¨ï¼ˆå¦‚`c[r]=max(c[r],l)`ç¡®ä¿é™åˆ¶æœ‰æ•ˆæ€§ï¼‰  
  - å®è·µä»·å€¼é«˜ï¼šå®Œæ•´å¤„ç†ç¦»æ•£åŒ–â†’åˆ†ç»„â†’DPå…¨æµç¨‹  

---

#### 3. æ ¸å¿ƒéš¾ç‚¹è¾¨æä¸è§£é¢˜ç­–ç•¥
1. **éš¾ç‚¹1ï¼šä¸Šç•ŒåŠ¨æ€ç¡®å®š**  
   * **åˆ†æ**ï¼šæ¯ä¸ªä½ç½®çš„ä¸Šç•Œæ˜¯è¦†ç›–å®ƒçš„æ‰€æœ‰æŸ¥è¯¢æœ€å°å€¼ï¼Œéœ€é«˜æ•ˆè®¡ç®—  
   * ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šå·®åˆ†+å¹³è¡¡æ ‘ï¼ˆmultisetï¼‰æ˜¯åŠ¨æ€ç»´æŠ¤æå€¼çš„åˆ©å™¨  

2. **éš¾ç‚¹2ï¼šåˆ†å±‚DPçŠ¶æ€è®¾è®¡**  
   * **åˆ†æ**ï¼šå¯¹æ¯ç»„é«˜åº¦xï¼Œå®šä¹‰`f[i]`è¡¨ç¤ºç»„å†…æœ€åä¸€ä¸ªè¾¾å³°ä½ç½®ä¸ºiçš„æ–¹æ¡ˆæ•°  
   * ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼š"æœ€åä¸€ä¸ªå³°å€¼"è®¾è®¡é¿å…é‡å¤ç»Ÿè®¡ï¼Œæ˜¯åŒºé—´æœ€å¤§å€¼è®¡æ•°çš„å…³é”®æŠ€å·§  

3. **éš¾ç‚¹3ï¼šé™åˆ¶æ¡ä»¶å®æ—¶æ¸…é™¤**  
   * **åˆ†æ**ï¼šå½“å¤„ç†ä½ç½®pæ—¶ï¼Œéœ€æ¸…é™¤å·¦ç«¯ç‚¹>pçš„æ— æ•ˆçŠ¶æ€ï¼ˆ`upd(1,0,c[i])`ï¼‰  
   * ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šé™åˆ¶è§¦å‘æ—¶ç«‹å³æ¸…é™¤çŠ¶æ€ï¼Œé¿å…åç»­æ— æ•ˆè½¬ç§»  

### âœ¨ è§£é¢˜æŠ€å·§æ€»ç»“
- **æŠ€å·§1ï¼šç¦»æ•£åŒ–åˆ†ç»„** â†’ å°†é—®é¢˜åˆ†è§£ä¸ºç‹¬ç«‹å­é—®é¢˜ï¼ˆä¸åŒé«˜åº¦å±‚ï¼‰  
- **æŠ€å·§2ï¼šDPçŠ¶æ€æœºè®¾è®¡** â†’ "æœ€åå³°å€¼"çŠ¶æ€é¿å…åæ•ˆæ€§  
- **æŠ€å·§3ï¼šæ•°æ®ç»“æ„åŠ é€Ÿ** â†’ çº¿æ®µæ ‘O(log n)å®ŒæˆåŒºé—´ä¹˜/åŠ /æ¸…é›¶  

---

#### 4. C++æ ¸å¿ƒä»£ç å®ç°èµæ
**é€šç”¨æ ¸å¿ƒå®ç°**  
```cpp
#include<bits/stdc++.h>
#define rep(i,a,b) for(int i=a;i<=b;i++)
const int N=1e6+5, mod=1e9+7;
int n,q,h,up[N]; // up[i]:ä½ç½®içš„ä¸Šç•Œ
std::vector<int> pos_by_val[N], queries_by_val[N];
std::multiset<int> active_queries;

void precalc_up_bound() {
    rep(i,1,n) {
        for(int x:queries_at[i]) active_queries.insert(x);
        for(int x:queries_end[i+1]) active_queries.erase(active_queries.find(x));
        up[i] = active_queries.empty() ? h-1 : *active_queries.begin();
    }
}

struct SegmentTree {
    ll t[N<<2], mul[N<<2] = {1};
    void push(int p) { 
        if(mul[p]!=1) {
            t[p]=t[p]*mul[p]%mod;
            mul[p*2]=mul[p*2]*mul[p]%mod;
            mul[p*2+1]=mul[p*2+1]*mul[p]%mod;
            mul[p]=1;
    }}
    void update(int p,int l,int r,int ql,int qr,ll v) { ... }
} seg;

ll solve_group(int val) {
    auto& pos = pos_by_val[val]; // è¯¥ç»„ä½ç½®
    seg.clear(); seg.update(1,0,0,1); // åˆå§‹åŒ–f[0]=1
    for(int i=0; i<pos.size(); ++i) {
        seg.update(1,0,i,val); // ä¹˜valï¼šé€‰æ‹©<val
        seg.update(1,i+1,i+1,seg.query_sum(0,i)); // åŠ å’Œï¼šé€‰æ‹©=val
        for(auto lim:queries_by_val[val]) 
            if(lim.r == pos[i]) 
                seg.update(1,0,lim.l_pos,0); // æ¸…é™¤éæ³•çŠ¶æ€
    }
    return seg.total_sum();
}
```

**é¢˜è§£ä¸€ä»£ç äº®ç‚¹**  
```cpp
// å·®åˆ†ç»´æŠ¤æ´»åŠ¨æŸ¥è¯¢é›†åˆ
for(int j:s1[i]) s.insert(j);      // è¿›å…¥åŒºé—´
for(int j:s2[i]) s.erase(s.find(j)); // ç¦»å¼€åŒºé—´
up[i] = s.size()?*s.begin():m;    // å–æœ€å°å€¼

// çº¿æ®µæ ‘å°è£…ä¹˜åŠ æ“ä½œ
void tag(int p,ll x){ t[p]=t[p]*x%mod, f[p]=f[p]*x%mod; }
void add(int p,int x,int y){ /* å•ç‚¹åŠ  */ }
```

---

#### 5. ç®—æ³•å¯è§†åŒ–ï¼šåƒç´ åŠ¨ç”»æ¼”ç¤º  
![Pixel Demo](https://via.placeholder.com/600x300/222/ccc?text=8-bit+Pixels+Animation)  
* **ä¸»é¢˜**ï¼š"å¡”é˜²å»ºç­‘å¸ˆ"â€”â€”åœ¨8-bitç½‘æ ¼åŸå»ºé€ æ»¡è¶³è§†é‡é™åˆ¶çš„ç¯å¡”  
* **å…³é”®å¸§è®¾è®¡**ï¼š  
  1. **åˆå§‹åŒ–**ï¼šç½‘æ ¼ä½ç½®æ˜¾ç¤ºä¸ºç°è‰²æ–¹å—ï¼Œå½“å‰é«˜åº¦å±‚ç”¨è‰²å—æ ‡æ³¨  
  2. **DPè½¬ç§»**ï¼š  
     - `<xé€‰æ‹©`ï¼šæ‰€æœ‰æ–¹å—å˜æš—å¹¶ç¼©æ”¾ï¼Œæ’­æ”¾"å“”"éŸ³æ•ˆ  
     - `=xé€‰æ‹©`ï¼šå½“å‰æ–¹å—å‘å‡ºå°„çº¿è¿æ¥ä¹‹å‰æ–¹å—ï¼Œè§¦å‘"å®"éŸ³æ•ˆ  
  3. **é™åˆ¶æ¿€æ´»**ï¼šçº¢è‰²æ‰«æçº¿æ¸…é™¤éæ³•åŒºåŸŸï¼Œä¼´éšè­¦æŠ¥éŸ³  
  4. **çº¿æ®µæ ‘æ“ä½œ**ï¼šå±å¹•ä¸‹æ–¹æ˜¾ç¤ºæ ‘ç»“æ„ï¼ŒèŠ‚ç‚¹åˆå¹¶æ—¶åƒç´ é‡ç»„  
* **äº¤äº’æ§åˆ¶**ï¼š  
   - ç©ºæ ¼é”®å•æ­¥æ‰§è¡Œ  
   - æ–¹å‘é”®è°ƒæ•´é€Ÿåº¦  
   - "R"é”®é‡ç½®å…³å¡  

---

#### 6. æ‹“å±•ç»ƒä¹ ä¸ç›¸ä¼¼é—®é¢˜
1. **æ´›è°· P1972 [SDOI2009]HHçš„é¡¹é“¾**ï¼ˆåŒºé—´å”¯ä¸€æ€§è®¡æ•°ï¼‰  
   â†’ å·©å›ºç¦»çº¿æŸ¥è¯¢+æ ‘çŠ¶æ•°ç»„æŠ€å·§  
2. **æ´›è°· P4113 [HEOI2012]é‡‡èŠ±**ï¼ˆåŒºé—´é¢œè‰²å‡ºç°æ¬¡æ•°é™åˆ¶ï¼‰  
   â†’ å¼ºåŒ–å·®åˆ†æ€æƒ³åº”ç”¨  
3. **æ´›è°· P3224 [HNOI2012]æ°¸æ— ä¹¡**ï¼ˆåŠ¨æ€åŒºé—´æå€¼ç»´æŠ¤ï¼‰  
   â†’ å­¦ä¹ å¹³è¡¡æ ‘ç»´æŠ¤æå€¼  

---

#### 7. å­¦ä¹ å¿ƒå¾—åˆ†äº«
> **é¢˜è§£ä½œè€…ç»éªŒ**ï¼š  
> â€œæœ€åˆæœªåŠæ—¶æ¸…é™¤éæ³•çŠ¶æ€å¯¼è‡´WAï¼Œç”¨æ–­è¨€éªŒè¯é™åˆ¶è§¦å‘æ—¶æœºæ‰è§£å†³â€  
>  
> **Kayç‚¹è¯„**ï¼š  
> è¿™éªŒè¯äº†**é˜²å¾¡æ€§ç¼–ç¨‹**çš„ä»·å€¼ï¼šåœ¨å…³é”®æ“ä½œå‰ï¼ˆå¦‚`upd(1,0,c[i])`ï¼‰æ·»åŠ ä½ç½®æ£€æŸ¥æ–­è¨€ï¼Œèƒ½å¿«é€Ÿå®šä½è¾¹ç•Œé”™è¯¯ã€‚æ¨èå­¦ä¹ `assert(l_pos>=0 && l_pos<=current_index)`æŠ€å·§  

---

é€šè¿‡æœ¬æŒ‡å—ï¼Œä½ å·²æŒæ¡åŒºé—´æœ€å¤§å€¼è®¡æ•°çš„æ ¸å¿ƒæŠ€å·§â€”â€”åƒæ­ä¹é«˜èˆ¬åˆ†å±‚å»ºé€ ï¼Œç”¨æ•°æ®ç»“æ„åŠ é€ŸéªŒè¯ï¼ ğŸ® ä¸‹æ¬¡æŒ‘æˆ˜è§ï¼

---
å¤„ç†ç”¨æ—¶ï¼š145.81ç§’
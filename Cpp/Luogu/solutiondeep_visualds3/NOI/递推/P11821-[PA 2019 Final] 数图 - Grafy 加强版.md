# 题目信息

# [PA 2019 Final] 数图 / Grafy 加强版

## 题目背景

P11817 的加强版。本题存在 $\Theta(\sqrt n\log n)$ 的做法。

本题数据为自造。

std: joke3579，validator & generator: Starrykiller。

**请勿提交 OEIS 题解。**



## 题目描述

求出 $n$ 个节点的满足以下条件的**有标号有向简单图**的数量：

- $\forall 1\le i\le n$，$\operatorname{deg_{out}}(i)=\operatorname{deg_{in}}(i)=2$。

这里，$\operatorname{deg_{out}}(u)$ 指节点 $u$ 的出度，$\operatorname{deg_{in}}(u)$ 指节点 $u$ 的入度。

你只需要输出答案对给定大素数 $p$ 取模后的结果。


注意我们是对**有标号**的「有向简单图」计数。也就是说，这张图中无重边自环。注意 $u\to v$ 和 $v\to u$ 同时出现是允许的。




## 说明/提示

- $3\le n\le 10^7$；
- $10^8+7\le p\le 10^9+7$，$p$ 为素数。



## 样例 #1

### 输入

```
4 998244853```

### 输出

```
9```

## 样例 #2

### 输入

```
114514 1000000007
```

### 输出

```
637348702
```

# AI分析结果


### 💡 Kay的C++算法解析：有向图双度计数 深入学习指南 💡

#### 1. 题目解读与核心算法识别
✨ **本题主要考察**：`组合数学与生成函数技术`  
🗣️ **初步分析**：  
> 本题要求计算满足**所有节点出度=入度=2**的有向简单图数量。核心难点在于处理图的对称性和度约束，避免重复计数。生成函数技术如同"化学方程式"：将复杂约束分解为原子操作（如度分配、环结构），再组合成生成函数表达式。关键步骤包括：
> - 将图分解为环结构，用生成函数表示环的排列方案
> - 通过指数型生成函数（EGF）组合环结构
> - 处理边界条件（如环长≥3）  
> 可视化方案将设计为**8位像素风图论实验室**：用闪烁像素块表示节点，动态展示环的生成过程，高亮当前计算的环长（如红色边框）和边添加过程（黄色连线）。当新环形成时播放"马里奥金币音效"，错误配置触发"宝可梦战斗失败"音效。

#### 2. 精选优质题解参考
**题解（NaCly_Fish）**  
* **点评**：  
  1. **思路清晰性**：从多重和式出发，通过组合意义转化为生成函数，推导路径清晰。将复杂约束分解为四个维度（i,j,k,t）的卷积，再通过EGF化简，逻辑链完整。  
  2. **算法优化**：利用代数变换将Θ(n³)暴力求和优化为Θ(1)的封闭形式（`e^{4z}/(1+4z)(1+2z)`），并通过复合函数ODE求解，复杂度降至Θ(√n log n)。  
  3. **代码实践**：伪代码展示核心推导步骤，变量命名规范（如`[z^n]`表示提取系数），边界处理严谨（如`t!`处理阶乘）。  
  **亮点**：生成函数与组合意义的完美映射，如将`(2t)!/t!`解释为环结构的对称性计数。

#### 3. 核心难点辨析与解题策略
1. **难点：约束条件组合爆炸**  
   - 分析：同时满足出/入度=2且无重边，直接枚举边会导致状态空间指数级增长  
   - 解法：转化为环分解模型（节点仅属于一个环），通过生成函数自动满足约束
   - 💡 学习笔记：图计数问题中，环分解是处理均匀度的利器

2. **难点：生成函数复合计算**  
   - 分析：复合函数`G(z/((1+4z)^2(1+2z)))`的系数提取需解ODE  
   - 解法：建立一阶线性ODE `4w²G' + (2w-1)G + 1 = 0` 并迭代求解
   - 💡 学习笔记：微分有限级数复合代数函数时，必存在多项式阶ODE

3. **难点：整式递推构造**  
   - 分析：暴力计算小规模样例找递推式时，高斯消元易数值不稳定  
   - 解法：用Berlekamp-Massey算法从初始值反推最小阶递推  
   - 💡 学习笔记：整式递推是连接组合表达式与线性算法的桥梁

#### 4. C++核心代码实现赏析
```cpp
#include <vector>
const int MAX_N = 1e7+10;

// 线性递推求解生成函数系数
void solve(int n, int p, int &ans) {
    vector<int> c(MAX_N, 0);
    c[0] = 1;  // 初值: [x^0]G=1
    // 迭代计算生成函数系数
    for (int m = 1; m <= n; ++m) {
        // ODE离散化: c_{m} = ( (m-1)c_{m-1} + 2c_{m-2} ) / m
        c[m] = (1LL * (m-1) * c[m-1] + 2LL * c[m-2]) % p;
        c[m] = 1LL * c[m] * pow(m, p-2, p) % p; // 模逆元
    }
    // 组合环结构计数
    int sum = 0;
    for (int k = 0; 2*k <= n; ++k) {
        int term = 1LL * (k%2 ? p-1 : 1) * pow(fact[k], p-2, p) % p; // (-1)^k/k!
        term = 1LL * term * c[n-2*k] % p;
        sum = (sum + term) % p;
    }
    ans = 1LL * fact[n] * pow(pow(4, n, p), p-2, p) % p * sum % p;
}
```
**关键代码解读**：  
1. **ODE离散化**：  
   - 将生成函数导数转化为递推式`c[m] = ((m-1)c_{m-1} + 2c_{m-2})/m`  
   - 类比：微分方程离散化类似泰勒级数截断，精度由阶数保证  
2. **环结构组合**：  
   - `(-1)^k/k! * c_{n-2k}` 对应环长≥3的指数型生成函数  
   - 像搭积木：k个环的生成函数=单个环的GF^k / k! (消除顺序)  
3. **模运算优化**：  
   - 使用费马小定理求逆元（`pow(x,p-2,p)`）  
   - 预计算阶乘避免重复计算  

#### 5. 算法可视化：像素动画演示
* **主题**：`宝可梦图环探险`  
* **核心流程**：  
  1. **初始化**：8-bit风格网格，节点为像素精灵球，控制面板含速度滑块  
  2. **环生成动画**：  
     - 随机未访问节点闪烁绿光 -> 深度优先遍历扩展环  
     - 新边添加时触发"精灵球捕获"音效，形成环时播放"进化成功"音效  
  3. **数据结构可视化**：  
     - 栈用垂直像素柱表示，当前节点标为闪烁光标  
     - 度数组用柱状图实时更新，出/入度分别用←/→箭头表示  
  4. **自动演示模式**：AI按最优扩展策略生成环，通关后显示"图鉴收集进度"  

#### 6. 拓展练习与相似问题
1. **思维迁移**：  
   - 环分解：P2661 [信息传递]（有向环检测）  
   - 度约束图：P4549 【模板】有标号无向图计数  
   - 生成函数应用：P5158 多项式复合  

2. **洛谷推荐**：  
   1. P6689 序列计数 - `同质环结构计数，强化生成函数思维`  
   2. P4000 生成树计数 - `将度约束转化为生成函数系数`  
   3. P5157 旅行者 - `环分解在路径规划的应用`

> 通过本指南，我们深入剖析了度约束图计数的组合本质。记住：复杂约束常蕴含优雅的代数结构，生成函数是打开这扇大门的金钥匙！下次挑战见！🚀

---
处理用时：649.31秒
# 题目信息

# 【模板】常系数非齐次线性递推

## 题目背景

NaCly\_Fish 一到机房，所有做题的人便都看着她笑。有的叫道，“鱼鱼，你怎么又爆零了！”她不回答，对教练说：“要两道数学题，一道数据结构。”便打开电脑。他们又故意的高声嚷道，“你怎么连 exgcd 都写不对了！”......

NaCly\_Fish 自己知道不能和同机房的神仙们谈天，便只好向隔壁初一的说话。有一回对我说道，“你学过 OI 么？”我略略点一点头。他说，“学过 OI，...... 我便考你一考。常系数线性齐次递推，怎样算的？”我想，机房垫底 AFO 的人，也配考我么？便回过脸去，不再理会。NaCly\_Fish 等了许久，很恳切的说道，“不会算罢？…… 我教给你，记着！这算法应该好好记着，将来比赛的时候，做题要用。”我懒懒的答她道，“谁要你教，不是把递推系数写在矩阵第一列，剩下斜着放 $1$，再快速幂么？”NaCly\_Fish 显出极高兴的样子，将两个指头的长指甲敲着课桌，点头说，“对呀对呀！...... 这还有四样求法，你知道么？”......
****  
NaCly\_Fish 看见了这题，她根本不会做。  
看在她那么菜的份上，请您做了这题，帮帮她吧。

## 题目描述

已知递推式：  

$$a_n = P(n) + \sum\limits_{i=1}^k f_i \times a_{n-i}$$  

其中 $P(x)$ 是一个 $m$ 次多项式。

给定 $f_1,f_2,\dots,f_k$，$a_0,a_1,\dots,a_{k-1}$，和 $P(x)$ 的各项系数，求 $a_n$。  
答案对 $998244353$ 取模。

## 说明/提示

【数据范围】  
对于 $100\%$ 的数据，$1\le n \le 10^9$，$1\le m,k \le 30000$。    
除第一行外，输入的所有数在 $[0,998244353)$ 范围内。  

数据有一定梯度。

## 样例 #1

### 输入

```
40 5 6
1 2 3 5 8 13
1 3 4 9 6 7
1 1 4 5 1 4```

### 输出

```
349344375```

# AI分析结果


### 题目解读与核心算法识别  
✨ **本题主要考察**：`生成函数与多项式技巧` + `线性递推`  

🗣️ **初步分析**：  
> 解决"常系数非齐次线性递推"的关键在于将非齐次问题转化为齐次递推。这就像拆解一个复杂机械：先将外部干扰（多项式项）通过差分消除，再对齐次核心部件（递推式）进行快速组装。核心步骤：  
> 1. **差分转化**：对非齐次项做$m+1$阶差分，转化为齐次递推（增加$m+1$维）  
> 2. **序列扩展**：用多项式求逆+多点求值计算扩展项 $a_k \sim a_{k+m}$  
> 3. **线性递推**：通过特征多项式快速幂求解$a_n$  
> **难点**：多项式操作复杂度高（求逆/多点求值），差分转化需严谨推导  
> **可视化设计**：  
>   - 8位像素风格展示"多项式工厂"：左侧输入系数（像素块），右侧递推系数（传送带）  
>   - 差分阶段：像素箭头消除非齐次项（"咔嚓"音效）  
>   - 求逆阶段：多项式进入"逆机器"翻转（水流声+翻转声）  
>   - 递推阶段：矩阵快速幂如火焰燃烧（像素网格动态更新）  
>   - 交互：步进控制+调速滑块，成功时放像素烟花（胜利音效）  

---

### 精选优质题解参考

**题解一（NaCly_Fish）**  
* **点评**：完整实现生成函数解法，思路清晰如流水线：  
  1. 推导严谨：用$P(n)$构造$b_n$序列，生成函数转化 $A(x)=\frac{B(x)}{1-F(x)}$  
  2. 代码规范：模块化封装多项式操作（求逆/卷积/多点求值）  
  3. 算法优化：$O(n\log n)$复杂度处理$n≤10^9$  
  4. 实践价值：提供可运行代码，边界处理完善（如$b_n$分段计算）  
  **亮点**：将非齐次转化与线性递推无缝衔接，调试心得隐含在边界处理中  

**题解二（Spasmodic）**  
* **点评**：革命性优化方案：  
  1. 创新点：新线性递推算法直接处理特征多项式  
  2. 代码精炼：核心仅10行，封装多项式操作  
  3. 效能突出：耗时仅为常规解法50%  
  4. 关键技巧：对首一多项式特判（`if(f[0]!=1) f=-f`）  
  **亮点**：突破矩阵分块限制，演示算法优化的极致  

---

### 核心难点辨析与解题策略

1. **难点1：非齐次项转化**  
   * **分析**：需通过$m+1$阶差分消除$P(n)$。关键推导：  
     $p_mn^m = a_n - \sum_{i=0}^{m-1}p_in^i - \sum_{i=1}^k f_i a_{n-i}$  
     **变量**：差分阶数$m+1$，多项式系数$p_i$  
   * 💡 **学习笔记**：差分是消除多项式非齐次项的万能钥匙  

2. **难点2：多项式操作瓶颈**  
   * **分析**：求逆/多点求值占90%耗时。优化方案：  
     - 分治FFT计算$b_n$（NaCly_Fish）  
     - 延迟求值（Spasmodic）  
     **数据结构**：`vector`存储系数，`NTT`加速卷积  
   * 💡 **学习笔记**：多项式操作如同管道，优化数据流是关键  

3. **难点3：高维递推求解**  
   * **分析**：转化后递推维数增至$m+k+1$。解决方案：  
     - 特征多项式快速幂（$O(\log n)$）  
     - 避免显式矩阵乘法（Spasmodic）  
     **变量**：特征多项式$G(x)=\prod(\lambda-1)^{m+1}(\lambda^k-\sum f_i\lambda^{k-i})$  
   * 💡 **学习笔记**：特征多项式是线性递推的"DNA"  

### ✨ 解题技巧总结  
- **降维打击**：高阶差分转化问题维度（$m+1$阶差分）  
- **管道优化**：多项式操作流式处理（求逆→卷积→求值）  
- **代数即武器**：特征多项式快速幂替代矩阵运算  
- **边界即生命**：分段计算$b_n$（$n<k$卷积/$n≥k$多点求值）  

---

### C++核心代码实现赏析

**通用核心实现**（综合最优解法）  
```cpp
vector<int> solve(int n, int m, int k, vector<int> a, vector<int> f, vector<int> P) {
    // 1. 构造b序列
    vector<int> b(k+m+1);
    for(int i=k; i<=k+m; ++i) b[i] = polyEval(P, i); // 多点求值
    for(int i=0; i<k; ++i) 
        for(int j=0; j<=i; ++j) 
            b[i] = (b[i] - 1LL*f[j]*a[i-j]) % mod;  // 卷积计算
    
    // 2. 多项式求逆 A = B/(1-F)
    auto F_inv = polyInverse(polySub({1}, f)); 
    auto A = polyMul(F_inv, b); // 生成函数求解a序列
    
    // 3. 特征多项式快速幂
    auto G = polyMul(genCharPoly(f), genDiffPoly(m+1)); // 特征多项式
    return polyModPow(G, n, A); // 线性递推求a_n
}
```

**题解一（NaCly_Fish）片段赏析**  
```cpp
// 生成函数法求A(x)
void solve() {
    poly F_inv = polyInverse(1 - F); // 求逆核心
    poly A = F_inv * B;              // 生成函数乘积
    poly G = constructCharPoly(f, m); 
    poly res = polyModPow(G, n, A);  // 递推求解
}
```
* **亮点**：模块化封装多项式操作  
* **学习笔记**：`polyInverse`和`polyModPow`是多项式两大核武器  

**题解二（Spasmodic）片段赏析**  
```cpp
mi poly::LNRR(const poly& P, const vec& a, int n) {
    poly f = ((shift(1)-1)*F);      // 构造特征多项式
    if(f[0] != 1) f = -f;           // 首一多项式特判
    return f.shift(-1).LHRR(a, n);  // 新线性递推
}
```
* **亮点**：四行实现核心递推，特判处理首一多项式  
* **学习笔记**：代数特判可简化问题（$\lambda^n \bmod f \equiv \lambda^n \bmod (-f)$）  

---

### 算法可视化：像素动画演示  
**主题**：8位机"多项式工厂"流水线  

**关键帧设计**：  
1. **原料输入**（像素块堆叠）：  
   - 左区：$P(x)$系数(彩色块) + 递推系数$f_i$(传送带)  
   - 右区：初始值$a_0,\dots,a_{k-1}$(像素管)  
   *音效*：经典FC物品拾取声  

2. **差分车间**（核心难点演示）：  
   ``` 
   for i from m downto 0:
       像素箭头点击P[i] -> 分解为i+1个小块  
       新块流入右侧传送带（差分音效"咔嚓"）
   ```
   *高亮*：$p_mn^m$项红色闪烁  

3. **多项式逆工厂**：  
   - 管道输入$1-F(x)$ → 机械臂翻转系数 → 输出$1/(1-F(x))$  
   *动画*：管道中系数块旋转180°（水流声+机械翻转声）  

4. **线性递推熔炉**：  
   ``` 
   while n > 0:
      if(n奇): 火焰喷出熔合A与G (音效:轰隆)
      G *= G (像素火焰膨胀)  
      n //= 2 (右侧二进制条递减)
   ```
   *进度*：底部8位二进制显示当前$n$  

5. **成品输出**：  
   - 成功：$a_n$像素块镀金弹出（胜利音效+烟花）  
   - 失败：系数块碎裂（短促警示音）  

**交互控制面板**：  
- 步进/暂停/重置 + 速度滑块(1x~16x)  
- "AI演示"模式：自动播放全流程（类贪吃蛇AI路径）  

---

### 拓展练习与相似问题  
1. **洛谷P4723**：常系数齐次线性递推（基础训练）  
   *推荐理由*：巩固特征多项式快速幂  

2. **洛谷P5800**：多项式多点求值（进阶挑战）  
   *推荐理由*：突破本题的性能瓶颈  

3. **洛谷P4000**：生成函数应用（思维跃迁）  
   *推荐理由*：深化$A(x)=B(x)/(1-F(x))$的模型理解  

---

### 学习心得  
> **来自NaCly_Fish的调试经验**：  
> "边界$b_n$分段计算时，$n<k$需卷积而$n≥k$需多点求值，漏掉$k$导致WA3次"  
> **Kay总结**：分段函数是多项式问题的常见陷阱，务必  
> 1. 用`assert`验证分段点  
> 2. 手写$k=0,1$边界测试用例  

---  
通过本指南，你已掌握非齐次递推的"转化→求值→递推"三部曲。记住：多项式操作是武器库，差分是瑞士军刀，而特征多项式是核弹发射密码！下次挑战见 💪

---
处理用时：172.35秒
# 题目信息

# [国家集训队] 稳定婚姻

## 题目描述

我们已知 $n$ 对夫妻的婚姻状况，称第 $i$ 对夫妻的男方为 $B_i$，女方为 $G_i$。若某男 $B_i$ 与某女 $G_j$ 曾经交往过（无论是大学，高中，亦或是幼儿园阶段，$i \le j$），则当某方与其配偶（即 $B_i$ 与 $G_i$ 或 $B_j$ 与 $G_j$）感情出现问题时，他们有私奔的可能性。不妨设 $B_i$ 和其配偶 $G_i$ 感情不和，于是 $B_i$ 和 $G_j$ 旧情复燃，进而 $B_j$ 因被戴绿帽而感到不爽，联系上了他的初恋情人 $G_k$ ……一串串的离婚事件像多米诺骨牌一般接踵而至。若在 $B_i$ 和 $G_i$ 离婚的前提下，这 $2n$ 个人最终依然能够结合成 $n$ 对情侣，那么我们称婚姻 $i$ 为不安全的，否则婚姻 $i$ 就是安全的。

给定所需信息，你的任务是判断每对婚姻是否安全。

## 说明/提示

对于 $20\%$ 的数据，$n \le 20$；

对于 $40\%$ 的数据，$n \le 100$，$m \le 400$；

对于 $100\%$ 的数据，所有姓名字符串中只包含英文大小写字母，大小写敏感，长度不大于 $8$，保证每对关系只在输入文件中出现一次，输入文件的最后 $m$ 行不会出现未在之前出现过的姓名，这 $2n$ 个人的姓名各不相同，$1 \le n \le 4000$，$0 \le m \le 20000$。

## 样例 #1

### 输入

```
2
Melanie Ashley
Scarlett Charles
1
Scarlett Ashley```

### 输出

```
Safe
Safe```

## 样例 #2

### 输入

```
2
Melanie Ashley
Scarlett Charles
2
Scarlett Ashley
Melanie Charles```

### 输出

```
Unsafe
Unsafe```

# AI分析结果


# 💡 Kay的C++算法解析：稳定婚姻 深入学习指南 💡

<introduction>
今天我们来分析"稳定婚姻"这道C++编程题。这道题考察图论中的强连通分量算法，帮助我们理解婚姻关系网络的稳定性。本指南将带大家梳理解题思路，掌握核心算法实现。
</introduction>

## 1. 题目解读与核心算法识别

✨ **本题主要考察**：`图论-强连通分量`

🗣️ **初步分析**：
> 解决"稳定婚姻"问题的关键在于理解人际关系网络中的环状结构。想象婚姻关系是连接男女的"桥梁"，而旧情人关系是隐藏的"备用小路"。当一对夫妻离婚（桥梁断裂）时，如果存在一条通过旧情人关系形成的环形小路，让所有人重新配对，那么这段婚姻就是不安全的。

- 核心解法是将婚姻关系建模为有向图：夫妻关系用"女→男"方向表示，旧情人关系用"男→女"方向表示。这样，如果一对夫妻在同一个强连通分量中，说明存在替代路径，婚姻不安全
- 主要难点在于建图策略的确定和强连通分量的高效检测
- 可视化设计将采用像素风格展示：用蓝色像素块表示女性，绿色表示男性，夫妻关系用蓝色连线，情人关系用红色虚线。Tarjan算法执行时，当前处理节点高亮黄色，栈内节点闪烁，发现强连通分量时整环闪烁绿色并播放胜利音效

---

## 2. 精选优质题解参考

<eval_intro>
我从思路清晰度、代码规范性和算法效率等角度筛选出以下优质题解，帮助大家理解不同解法精髓。
</eval_intro>

**题解一 (来源：雨季)**
* **点评**：此解法采用Tarjan算法求强连通分量，思路清晰完整。建图策略（夫妻：女→男；情人：男→女）巧妙形成交替路径，完美捕捉环状关系。代码规范：变量名如`belong`直观体现节点所属分量，边界处理严谨。亮点在于简洁高效的建图逻辑和完整的Tarjan实现，复杂度O(n+m)最优，可直接用于竞赛。

**题解二 (来源：ahawzlc)**
* **点评**：同样使用Tarjan算法，但突出优势是附有详细示意图解析建图原理。用像素风格图例展示男女节点和关系边，帮助初学者直观理解环状结构的形成。代码中`f`数组存储名字，`v`映射名字到编号，结构清晰。亮点是将抽象算法具象化，强化理解。

**题解三 (来源：Baihua)**
* **点评**：提供独特的二分图匹配视角。核心思路是模拟离婚后尝试重新匹配：拆散一对夫妻后跑匈牙利算法，若成功匹配则说明婚姻不安全。虽然复杂度O(n²)不及Tarjan，但亮点在于直接模拟题目描述的过程，提供另一种解题思路。

---

## 3. 核心难点辨析与解题策略

<difficulty_intro>
解决本题需突破以下三个关键难点，结合优质题解的策略如下：
</difficulty_intro>

1.  **难点：关系网络的建图策略**
    * **分析**：如何将婚姻和情人关系转化为有向边？优质解法采用统一规则：夫妻边女→男，情人边男→女。这样能形成"女→男(夫妻)→女(情人)→男(夫妻)..."的交替路径，使环状结构对应不稳定婚姻。关键是用`map`存储名字到编号的映射，女方编号1~n，男方n+1~2n
    * 💡 **学习笔记**：好的建图策略能将实际问题转化为标准图论模型

2.  **难点：环状结构的高效检测**
    * **分析**：使用Tarjan算法求强连通分量。关键是用栈追踪DFS路径，通过`dfn`和`low`数组判断分量根节点。当`dfn[u]==low[u]`时，从栈顶到u的所有节点构成一个强连通分量
    * 💡 **学习笔记**：Tarjan的精髓在于DFS过程中实时更新low值，通过单次遍历检测所有分量

3.  **难点：字符串到节点编号的映射**
    * **分析**：利用STL的`map`或`unordered_map`将字符串名字映射为整数编号。夫妻对共享关联编号（如女方i对应男方i+n）
    * 💡 **学习笔记**：映射处理是图论题的常见技巧，能有效处理非数字节点

### ✨ 解题技巧总结
<summary_best_practices>
通过本题可总结以下通用解题技巧：
</summary_best_practices>
- **关系网络转化为图模型**：将人际关系抽象为节点和边，观察环状结构
- **交替方向建图**：对两种类型的关系采用相反方向，自然形成检测环
- **分量染色法**：用Tarjan等算法为强连通分量染色，快速判断节点关联性
- **模拟验证法**：当效率允许时（如匈牙利解法），直接模拟题目描述的过程

---

## 4. C++核心代码实现赏析

<code_intro_overall>
以下是基于优质题解提炼的通用核心实现，完整展示Tarjan解法框架：
</code_intro_overall>

**本题通用核心C++实现参考**
* **说明**：综合雨季和ahawzlc的题解优化，包含字符串映射、建图、Tarjan算法和判断逻辑的完整实现
* **完整核心代码**：
    ```cpp
    #include <iostream>
    #include <map>
    #include <stack>
    #include <algorithm>
    #include <cstring>
    using namespace std;
    const int N = 8000, M = 50000;
    
    map<string, int> nameToId;
    struct Edge { int to, next; } edges[M];
    int head[N], dfn[N], low[N], scc[N];
    bool inStack[N];
    int n, m, cnt = 0, idx = 0, sccCnt = 0;
    stack<int> stk;
    
    void addEdge(int u, int v) {
        edges[++cnt] = {v, head[u]};
        head[u] = cnt;
    }
    
    void tarjan(int u) {
        dfn[u] = low[u] = ++idx;
        stk.push(u); inStack[u] = true;
        for (int i = head[u]; i; i = edges[i].next) {
            int v = edges[i].to;
            if (!dfn[v]) {
                tarjan(v);
                low[u] = min(low[u], low[v]);
            } else if (inStack[v]) {
                low[u] = min(low[u], dfn[v]);
            }
        }
        if (dfn[u] == low[u]) {
            sccCnt++;
            while (true) {
                int v = stk.top(); stk.pop();
                inStack[v] = false;
                scc[v] = sccCnt;
                if (u == v) break;
            }
        }
    }
    
    int main() {
        cin >> n;
        string girl, boy;
        // 建立夫妻关系 (女->男)
        for (int i = 1; i <= n; i++) {
            cin >> girl >> boy;
            nameToId[girl] = i;          // 女方编号: 1~n
            nameToId[boy] = i + n;       // 男方编号: n+1~2n
            addEdge(i, i + n);           // 女->男
        }
        
        cin >> m;
        // 建立情人关系 (男->女)
        for (int i = 1; i <= m; i++) {
            cin >> girl >> boy;
            addEdge(nameToId[boy], nameToId[girl]); // 男->女
        }
        
        // Tarjan求强连通分量
        memset(dfn, 0, sizeof(dfn));
        for (int i = 1; i <= 2 * n; i++) {
            if (!dfn[i]) tarjan(i);
        }
        
        // 判断每对夫妻是否在同一分量
        for (int i = 1; i <= n; i++) {
            if (scc[i] == scc[i + n]) 
                cout << "Unsafe" << endl;  // 同一分量->不安全
            else 
                cout << "Safe" << endl;    // 不同分量->安全
        }
        return 0;
    }
    ```
* **代码解读概要**：
    > 代码分为四个部分：(1) 用`map`进行名字到编号的映射；(2) 建立夫妻关系（女→男）和旧情人关系（男→女）；(3) 使用Tarjan算法求强连通分量，通过栈和DFS追踪环状结构；(4) 对每对夫妻判断是否在同一强连通分量中

---
<code_intro_selected>
下面分析各优质题解的核心代码片段：
</code_intro_selected>

**题解一 (雨季)**
* **亮点**：简洁的建图逻辑和完整的Tarjan实现
* **核心代码片段**：
    ```cpp
    // 建图部分
    for (int i = 1; i <= n; ++i) {
        cin >> gir >> boy;
        cou[gir] = i;      // 女方映射
        cou[boy] = i + n;  // 男方映射
        add(i, i + n);     // 夫妻边: 女->男
    }
    for (int i = 1; i <= m; ++i) {
        cin >> gir >> boy;
        add(cou[boy], cou[gir]); // 情人边: 男->女
    }
    // 判断逻辑
    if (belong[i] == belong[i + n]) 
        printf("Unsafe\n");
    ```
* **代码解读**：
    > 这段代码的核心在于清晰的映射策略：夫妻共享关联编号（如女方i对应男方i+n）。建图时夫妻边用女→男方向，情人边用男→女方向，形成交替路径。Tarjan后只需比较夫妻节点的`belong`值是否相同
* 💡 **学习笔记**：统一编号规则能简化后续处理

**题解二 (ahawzlc)**
* **亮点**：图示化解释建图原理
* **核心代码片段**：
    ```cpp
    // 图示辅助的建图解释
    /*
      夫妻关系: 女 -> 男 (例: Melanie -> Ashley)
      情人关系: 男 -> 女 (例: Ashley -> Scarlett)
      形成环: Melanie->Ashley->Scarlett->Charles->Melanie
    */
    add(v[a], v[b]); // 实际建图代码
    ```
* **代码解读**：
    > 虽然代码本身与雨季类似，但作者通过像素风格示意图展示环的形成过程：蓝色女性节点指向绿色男性节点（夫妻），绿色男性节点指向红色女性节点（情人），最终形成闭环。这种视觉辅助极大帮助理解
* 💡 **学习笔记**：复杂算法配合示意图能事半功倍

**题解三 (Baihua)**
* **亮点**：模拟离婚重匹配的直观解法
* **核心代码片段**：
    ```cpp
    // 匈牙利算法判断
    for (int i = 1; i <= n; i++) {
        Clean(vis, 0);
        Match[Match[i]] = 0; // 拆散夫妻
        if (DFS(i))          // 尝试重新匹配
            printf("Unsafe\n");
        else
            printf("Safe\n");
        Match[Match[i]] = i; // 恢复关系
    }
    ```
* **代码解读**：
    > 这种解法直接模拟题目场景：拆散一对夫妻后，尝试用匈牙利算法为男方寻找新伴侣。如果存在增广路径则说明婚姻不安全。虽然复杂度较高(O(n²))，但直观展示问题本质
* 💡 **学习笔记**：当数据规模较小时，模拟法可作替代方案

-----

## 5. 算法可视化：像素动画演示 (核心部分)

\<visualization\_intro\>
为了让Tarjan算法过程更直观，我设计了"爱情迷宫探险"像素动画方案。通过8-bit复古风格展示算法每一步操作，帮助大家形象理解强连通分量的检测过程。
\</visualization\_intro\>

  * **动画演示主题**：`像素探险家在关系迷宫中寻找稳定婚姻`

  * **核心演示内容**：`Tarjan算法执行过程，包括DFS遍历、栈操作和强连通分量识别`

  * **设计思路简述**：采用FC红白机风格像素画面，蓝色女性节点和绿色男性节点分布在地图。夫妻关系用蓝色锁链连接，情人关系用红色虚线。算法执行时，当前节点高亮黄色，递归路径显示为光轨，栈操作可视化（入栈像素块压入，出栈弹出）。发现强连通分量时整环闪烁绿色并播放胜利音效，强化环状结构的识别。

  * **动画帧步骤与交互关键点**：

    1.  **场景初始化**：
        - 8-bit像素网格：女性(蓝色方块)、男性(绿色方块)随机分布
        - 控制面板：开始/暂停、单步执行、速度滑块、重置按钮
        - 状态显示区：当前节点、栈内容、分量计数
        - 背景：循环播放8-bit风格BGM

    2.  **DFS遍历过程**：
        - 当前节点闪烁黄色边框，向外发射探测射线
        - 递归访问邻居时，显示彩色光轨路径
        - 节点入栈时：像素块被"吸入"底部栈区，播放"滴"声
        - 实时更新dfn/low值显示在节点上方

    3.  **关键操作可视化**：
        - **回溯更新low值**：当递归返回时，显示low值更新线（橙色虚线）
        - **发现栈中祖先**：若遇到已访问节点，显示红色警报边框，播放提示音
        - **分量识别**：当dfn[u]==low[u]时，栈顶到u的节点集体闪烁绿色，播放胜利音效，然后染成同色

    4.  **游戏化元素**：
        - 每发现一个强连通分量，右上角积分+100
        - 连续发现分量触发"连击"效果，播放激昂音效
        - 最终根据发现分量数显示评级（S/A/B/C）
        - 提供"AI演示"模式自动展示全过程

    5.  **信息同步**：
        - 右侧代码区高亮当前执行的伪代码行
        - 底部日志区显示文字解说："正在访问节点X"、"发现环状结构"等
        - 关键操作时弹出像素风格对话框解释原理

\<visualization\_conclusion\>
通过这种融合像素艺术和游戏元素的动画，Tarjan算法的抽象过程变得可见可感。大家不仅能观察DFS的递归路径，还能直观理解强连通分量如何通过dfn/low值的比较被识别出来。
\</visualization\_conclusion\>

-----

## 6. 拓展练习与相似问题思考

\<similar\_problems\_intro\>
掌握稳定婚姻的解法后，可尝试以下相似问题巩固图论技能：
\</similar\_problems\_intro\>

  * **通用思路迁移**：
    - 强连通分量算法可用于检测任何关系网络中的循环依赖
    - 二分图匹配适合解决两类对象的配对问题
    - 建图技巧是解决图论问题的核心能力

  * **练习推荐 (洛谷)**：
    1.  **P2661 信息传递**  
        🗣️ **推荐理由**：最小环检测问题，可直接应用Tarjan算法，巩固强连通分量基础
        
    2.  **P3386 二分图最大匹配**  
        🗣️ **推荐理由**：二分图匹配模板题，可练习匈牙利算法，理解题解三的替代解法
        
    3.  **P2341 受欢迎的牛**  
        🗣️ **推荐理由**：强连通分量经典应用，学习分量收缩后的DAG处理技巧

-----

## 7. 学习心得与经验分享 (若有)

\<insights\_intro\>
题解中的经验分享是宝贵的学习资源，我提炼了以下要点：
\</insights\_intro\>

> **雨季的调试经验**：  
> "最初在分量判断时混淆了节点编号，后通过打印中间dfn/low值定位错误"  
>   
> **Kay的点评**：  
> 图论问题中，清晰的节点编号方案至关重要。建议：  
> 1. 为不同类别节点设计编号规则（如本题女方1~n，男方n+1~2n）  
> 2. 调试时输出关键数组（dfn/low）的中间状态  
> 3. 对小规模样例手工模拟算法过程  

-----

\<conclusion\>
本次"稳定婚姻"题解分析就到这里。关键是要理解：通过合理建图将实际问题转化为强连通分量检测，Tarjan算法的高效实现，以及可视化对理解抽象算法的帮助。记住，编程能力的提升在于持续学习和勇于实践！💪
\</conclusion\>
```

---
处理用时：180.27秒
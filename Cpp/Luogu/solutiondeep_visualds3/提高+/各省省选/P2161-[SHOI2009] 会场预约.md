# 题目信息

# [SHOI2009] 会场预约

## 题目背景

**形式化题意：**

你需要维护一个在数轴上的线段的集合 $S$，支持两种操作：

`A l r` 表示将 $S$ 中所有与线段 $[l,r]$ 相交的线段删去，并将 $[l,r]$ 加入 $S$ 中。

`B` 查询 $S$ 中的元素数量。

对于 `A` 操作，每次还需输出删掉的元素个数。

## 题目描述

PP 大厦有一间空的礼堂，可以为企业或者单位提供会议场地。

这些会议中的大多数都需要连续几天的时间（个别的可能只需要一天），不过场地只有一个，所以不同的会议的时间申请不能够冲突。也就是说，前一个会议的结束日期必须在后一个会议的开始日期之前。所以，如果要接受一个新的场地预约申请，就必须拒绝掉与这个申请相冲突的预约。

一般来说，如果 PP 大厦方面事先已经接受了一个会场预约（例如从 $10$ 日到 $15$ 日），就不会再接受与之相冲突的预约（例如从 $12$ 日到 $17$ 日）。

不过，有时出于经济利益，PP 大厦方面有时会为了接受一个新的会场预约，而拒绝掉一个甚至几个之前预订的预约。 于是，礼堂管理员 QQ 的笔记本上经常记录着这样的信息：（本题中为方便起见，所有的日期都用一个整数表示）例如，如果一个为期 $10$ 天的会议从 $90$ 日开始到 $99$ 日，那么下一个会议最早只能在 $100$ 日开始。（此处前后矛盾，若无法理解请参考形式化描述。）

最近，这个业务的工作量与日俱增，礼堂的管理员 QQ 希望参加 SHTSC 的你替他设计一套计算机系统，方便他的工作。这个系统应当能执行下面两个操作：

`A` 操作：有一个新的预约是从 $start$ 日到 $end$ 日，并且拒绝掉所有与它相冲突的预约。执行这个操作的时候，你的系统应当返回为了这个新预约而拒绝掉的预约个数，以方便 QQ 与自己的记录相校对。

`B` 操作：请你的系统返回当前的仍然有效的预约的总数。

## 说明/提示

【数据范围】  
对于 $100\%$ 的数据，$1\le n \le 2\times 10^5$，$1\le l \le r \le 10^5$。

## 样例 #1

### 输入

```
6
A 10 15
A 17 19
A 12 17
A 90 99
A 11 12
B```

### 输出

```
0
0
2
0
1
2```

# AI分析结果


### 题目分析：会场预约（[SHOI2009]）

#### 题目背景
维护一个互不重叠的区间集合，支持两种操作：
- `A l r`：插入新区间 `[l, r]`，删除所有与其重叠的区间，返回删除的区间数量。
- `B`：查询当前区间数量。

#### 核心算法识别：区间维护与快速查找
- **算法分类**：区间管理，使用 **平衡树（STL set）** 维护有序区间集。
- **核心思想**：将区间按左端点排序，插入新区间时，通过二分查找定位可能重叠的区间（左端点≤新区间右端点且右端点≥新区间左端点），循环删除所有重叠区间。

#### 精选优质题解参考
1. **STL set解法（作者：fffasttime）**
   - **思路**：自定义区间比较规则（按左端点排序），利用 `lower_bound` 定位首个左端点≥新区间左端点的区间，向前后双向检查重叠。
   - **亮点**：
     - 代码简洁（仅50行），利用STL降低实现难度。
     - 双向检查确保不漏掉任何重叠区间（左在新区间左侧或右侧）。
     - 每个区间最多被删除一次，时间复杂度 `O(n log n)`。
   - **代码规范性**：变量名清晰（`l`、`r`），结构体运算符重载规范。
   - **实践价值**：适合竞赛快速实现，边界处理严谨（检查迭代器有效性）。

2. **线段树染色解法（作者：CodyTheWolf）**
   - **思路**：将时间轴离散化，用线段树维护区间颜色。插入时清除区间内所有颜色并统计数量，再染色新区间。
   - **亮点**：
     - 直观体现“染色”概念，删除即清空颜色。
     - 时间复杂度 `O(n log n)`，但常数较大。
   - **缺点**：代码较长（100+行），需维护多个数组（颜色、懒标记）。

#### 核心难点辨析与解题策略
1. **难点1：高效查找重叠区间**
   - **分析**：暴力检查所有区间 `O(n)` 不可行。需利用区间有序性二分。
   - **解决**：`set` 按左端点排序，`lower_bound` 定位首个可能重叠的区间，双向扩展检查。

2. **难点2：删除后维护数据一致性**
   - **分析**：删除区间需确保 `set` 迭代器有效，且不漏判。
   - **解决**：循环内先查找后删除，每次重新定位迭代器。

3. **难点3：处理完全覆盖的区间**
   - **分析**：新区间可能覆盖多个小区间。
   - **解决**：循环删除直到无重叠，确保完全清理。

#### C++核心代码实现（STL set版）
```cpp
#include <iostream>
#include <set>
using namespace std;

struct Interval {
    int l, r;
    bool operator<(const Interval& rhs) const {
        return l < rhs.l; // 按左端点升序
    }
};

int main() {
    int n;
    cin >> n;
    set<Interval> s;
    char op;
    int l, r;

    while (n--) {
        cin >> op;
        if (op == 'A') {
            cin >> l >> r;
            Interval tmp = {l, r};
            int cnt = 0;

            // 循环删除所有重叠区间
            while (true) {
                auto it = s.lower_bound(tmp); // 首个左端点≥tmp.l的区间
                // 检查右侧重叠：it左端点≤tmp.r
                if (it != s.end() && it->l <= r) {
                    s.erase(it);
                    cnt++;
                    continue;
                }
                // 检查左侧重叠：前一个区间右端点≥tmp.l
                if (it != s.begin()) {
                    it--; // 前一个区间（左端点<tmp.l）
                    if (it->r >= l) {
                        s.erase(it);
                        cnt++;
                        continue;
                    }
                }
                break;
            }
            s.insert(tmp); // 插入新区间
            cout << cnt << endl;
        } else {
            cout << s.size() << endl; // 输出当前区间数
        }
    }
    return 0;
}
```

#### 算法可视化：像素动画演示
- **主题**：`区间维护模拟器`（复古像素风格）
- **核心演示**：
  1. **初始化**：时间轴为空白网格，控制面板含“单步/播放”按钮。
  2. **插入新区间**：
     - 高亮新区间 `[l, r]`（蓝色像素块），播放“叮”音效。
     - **查找重叠**：向左/向右扩展红色箭头，标记检查的区间。
     - **删除重叠**：重叠区间变为红色闪烁后消失，伴随“咔嚓”音效。
  3. **结果展示**：新区间变为绿色，播放“胜利”音效。
- **交互设计**：
  - **步进控制**：支持调整速度，观察二分查找过程。
  - **数据结构可视化**：用不同颜色方块表示区间，动态更新。
- **游戏化**：每完成一次插入视为“关卡”，积分奖励。

#### 拓展练习
1. **相似问题**：
   - **P2894** 酒店预订：动态分配连续房间。
   - **P3353** 流星雨：区间覆盖最大值。
   - **CF817F** 区间赋值与查询。
2. **洛谷推荐**：
   - **P3372** 线段树区间加（基础线段树）。
   - **P3369** 普通平衡树（巩固STL set）。
   - **P1908** 逆序对（树状数组应用）。

---

### 总结
- **最优解法**：`STL set` 实现简洁高效，适合竞赛。
- **关键点**：自定义排序规则 + 双向重叠检查。
- **学习价值**：理解区间有序性如何优化查找，掌握STL在算法中的应用。

---
处理用时：200.37秒
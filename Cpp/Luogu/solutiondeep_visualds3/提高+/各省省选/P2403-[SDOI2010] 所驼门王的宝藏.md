# 题目信息

# [SDOI2010] 所驼门王的宝藏

## 题目描述

在宽广的非洲荒漠中，生活着一群勤劳勇敢的羊驼家族。被族人恭称为“先知”的 AlpacaL.Sotomon 是这个家族的领袖，外人也称其为“所驼门王”。所驼门王毕生致力于维护家族的安定与和谐，他曾亲自率军粉碎河蟹帝国主义的野蛮侵略，为族人立下赫赫战功。所驼门王一生财宝无数，但因其生性节俭低调，他将财宝埋藏在自己设计的地下宫殿里，这也是今天 Henry Curtis 故事的起点。Henry 是一个爱财如命的贪婪家伙，而又非常聪明，他费尽心机谋划了这次盗窃行动，破解重重机关后来到这座地下宫殿前。

整座宫殿呈矩阵状，由 $R \times C$ 间矩形宫室组成，其中有 $N$ 间宫室里埋藏着宝藏，称作藏宝宫室。宫殿里外、相邻宫室间都由坚硬的实体墙阻隔，由一间宫室到达另一间只能通过所驼门王独创的移动方式——传送门。所驼门王为这 $N$ 间藏宝宫室每间都架设了一扇传送门，没有宝藏的宫室不设传送门，所有的宫室传送门分为三种：

1. “横天门”：由该门可以传送到同行的任一宫室；
2. “纵寰门”：由该门可以传送到同列的任一宫室；
3. “任意门”：由该门可以传送到以该门所在宫室为中心周围 $8$ 格中任一宫室（如果目标宫室存在的话）。

深谋远虑的 Henry 当然事先就搞到了所驼门王当年的宫殿招标册，书册上详细记录了每扇传送门所属宫室及类型。而且，虽然宫殿内外相隔，但他自行准备了一种便携式传送门，可将自己传送到殿内任意一间宫室开始寻宝，并在任意一间宫室结束后传送出宫。整座宫殿只许进出一次，且便携门无法进行宫室之间的传送。不过好在宫室内传送门的使用没有次数限制，每间宫室也可以多次出入。

现在 Henry 已经打开了便携门，即将选择一间宫室进入。为得到尽多宝藏，他希望安排一条路线，使走过的不同藏宝宫室尽可能多。请你告诉 Henry 这条路线最多行经不同藏宝宫室的数目。

## 说明/提示

数据规模和约定：

![](https://cdn.luogu.com.cn/upload/pic/1594.png)


## 样例 #1

### 输入

```
10 7 7
2 2 1
2 4 2
1 7 2
2 7 3
4 2 2
4 4 1
6 7 3
7 7 1
7 5 2
5 2 1```

### 输出

```
9```

# AI分析结果


### 题目分析：SDOI2010 所驼门王的宝藏

#### 题目核心
- **问题类型**：图论问题，涉及强连通分量（SCC）和 DAG 上的动态规划。
- **核心算法**：Tarjan 缩点 + 拓扑排序 + 动态规划。
- **难点**：优化建图以避免 O(n²) 的边数，处理三种传送门的特殊连边方式。
- **数据规模**：n ≤ 10⁵，R, C ≤ 10⁶，需高效建图。

#### 建图优化策略
1. **横天门（同行传送）**：
   - 将同一行的所有横天门连成环，确保互相可达。
   - 从环中任选一点（如第一个）向该行其他非横天门点连边，避免 O(n²) 连边。
2. **纵寰门（同列传送）**：
   - 类似横天门，将同一列的所有纵寰门连成环。
   - 从环中任选一点向该列其他非纵寰门点连边。
3. **任意门（周围8格）**：
   - 使用 `map<pair<int, int>, int>` 存储坐标到点的映射。
   - 对每个任意门枚举周围8个方向，若存在藏宝宫室则连边。

#### 算法流程
1. **输入处理**：
   - 读入 n, R, C 及每个藏宝宫室的坐标 (x, y) 和门类型。
   - 使用 map 存储坐标到点编号的映射。
2. **建图**：
   - **横天门处理**：按行排序，行内将横天门排前。遍历每行，将横天门连成环，环头连向该行其他点。
   - **纵寰门处理**：按列排序，列内将纵寰门排前。类似行处理建环和连边。
   - **任意门处理**：枚举每个类型为3的点周围的8个方向，通过 map 检查存在性并连边。
3. **Tarjan 缩点**：
   - 求强连通分量，记录每个 SCC 的大小（点权为原始节点数）。
4. **DAG 重建**：
   - 遍历原图边，若两端点在不同 SCC，则在 DAG 中连边（去重边）。
   - 计算每个 SCC 的入度。
5. **拓扑排序 + DP**：
   - 初始化：入度为0的 SCC 入队，dp[i] = size[i]。
   - 拓扑过程中更新 dp：dp[v] = max(dp[v], dp[u] + size[v])。
   - 答案取所有 dp 的最大值。

#### 时间复杂度
- **建图**：O(n log n)（排序和 map 操作）。
- **Tarjan**：O(n + m)，其中 m 是优化后的边数（≤ 8n）。
- **拓扑 DP**：O(n + m)。

#### 关键技巧
- **环优化**：避免同行/列门的两两连边，降边数至 O(n)。
- **map 查询**：任意门连边时高效检查周围点。
- **去重边**：DAG 重建时用 set 或哈希表去重。

#### 可视化算法设计（像素动画）
- **风格**：8位像素风（FC 红白机风格），网格表示宫室。
- **动画内容**：
  - **初始化**：绘制 R×C 网格，不同颜色区分三类门（横天门红、纵寰门蓝、任意门绿）。
  - **建图阶段**：
    - 横天门行内连边：显示红色线条连成环，环头向同行的其他点延伸黄线。
    - 任意门连边：绿色门闪烁后向周围8格延伸射线，命中则显示连线。
  - **SCC 收缩**：强连通分量收缩为彩色大像素块，块大小反映分量点数。
  - **拓扑 DP**：DAG 节点按拓扑序点亮，dp 值实时显示在节点上方。
- **交互控制**：
  - 步进/暂停/速度调节。
  - 高亮当前操作：如建环时高亮当前行，SCC 收缩时闪烁当前分量。
- **音效**：连边时“滴”声，SCC 收缩时“咔嚓”声，dp 更新时上升音调。

#### 核心难点对比
1. **建图优化**：
   - **暴力建边**：O(n²) 边数不可行。
   - **环优化**：将同行/列门连成环，边数降至 O(n)。
   - **虚点法**：为行/列建虚点（需离散化），边数 O(n) 但常数较大。
2. **SCC 与 DP**：
   - **Tarjan 正确性**：需确保缩点后 DAG 无环。
   - **DP 转移**：dp[v] 依赖所有前驱 u 的最大 dp[u]，拓扑序保证无后效性。

#### 精炼结论
- **最优解法**：环优化建图 + Tarjan + 拓扑 DP，时间复杂度 O(n log n)，空间 O(n)。
- **关键洞见**：利用环结构避免冗余边，map 高效处理任意门连边。
- **适用性**：适用于大规模稀疏图，类似问题（如网格传送）可借鉴。

#### 拓展练习
1. **相似问题**：
   - **洛谷 P2146 [NOI2015] 软件包管理器**：树链剖分 + DFS 序。
   - **洛谷 P3387 缩点**：模板题，练习 SCC 和 DAG DP。
   - **洛谷 P3627 [APIO2009] 抢掠计划**：SCC 缩点后求带权最长路。
2. **进阶挑战**：
   - **动态版本**：支持动态增加宫室，增量维护 SCC 和 DP 值。
   - **三维扩展**：立方体网格中的传送门，优化建图策略。

通过此分析，学习者可掌握图论优化技巧，理解 SCC 和 DAG DP 的应用，并通过可视化深化对算法流程的理解。

---
处理用时：137.88秒
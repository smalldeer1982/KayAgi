# é¢˜ç›®ä¿¡æ¯

# [SDOI2019] å¿«é€ŸæŸ¥è¯¢

## é¢˜ç›®æè¿°

ç»™å®šä¸€ä¸ªé•¿åº¦ä¸º $n$ çš„æ•´æ•°æ•°åˆ—ï¼Œé‡Œé¢çš„å…ƒç´ ä¾æ¬¡ç¼–å·ä¸º $a_1,~a_2,~a_3,~\dots,~a_n$ã€‚åˆå§‹çš„æ—¶å€™ï¼Œæ‰€æœ‰å…ƒç´ éƒ½ä¸ºé›¶ã€‚ç°åœ¨æŒ‰ç…§æ—¶é—´é¡ºåºæä¾›äº†è‹¥å¹²æ¬¡å…³äºè¿™ä¸ªæ•°åˆ—çš„ä¿®æ”¹æˆ–è¯¢é—®ï¼Œæ¯ä¸€æ¬¡ä¿®æ”¹æˆ–è¯¢é—®ä¸€å®šä¸ºä»¥ä¸‹å…­ç§æƒ…å†µä¹‹ä¸€ï¼š

- **1 i val** ï¼šå°† $a_i$ èµ‹å€¼ä¸ºç»™å®šæ•´æ•° $val$ï¼›

- **2 val** ï¼šå°†æ‰€æœ‰å…ƒç´ åŒæ—¶åŠ ä¸Š $val$ï¼›

- **3 val** ï¼šå°†æ‰€æœ‰å…ƒç´ åŒæ—¶ä¹˜ä¸Š $val$ï¼›

- **4 val** ï¼šå°†æ‰€æœ‰å…ƒç´ åŒæ—¶èµ‹å€¼ä¸º $val$ï¼›

- **5 i** ï¼šè¯¢é—®ç¬¬ $i$ ä¸ªå…ƒç´  $a_i$ ç°åœ¨çš„å€¼æ˜¯å¤šå°‘ï¼›

- **6** ï¼šè¯¢é—®ç°åœ¨æ‰€æœ‰å…ƒç´ çš„å’Œã€‚

## è¯´æ˜/æç¤º

å­ä»»åŠ¡$1$ï¼šï¼ˆ$50$åˆ†ï¼‰$1\le  n\le 500000$ï¼Œ$1\le q\le 10^5$ ä¸” $1\le t\le 5$ï¼Œæ‰€æœ‰åœ¨è¾“å…¥ä¸­å‡ºç°çš„$val$  æ»¡è¶³$-10^9\le val\le 10^9$ï¼Œæ‰€æœ‰$a_i$å’Œ$b_i$æ»¡è¶³$0\le a_i,b_i\le 10^9$

å­ä»»åŠ¡$2$ï¼šï¼ˆ$50$åˆ†ï¼‰$1\le n\le 10^9$ï¼Œ$1\le q\le 10^5$ ä¸” $1\le~t~\le~100$ï¼Œæ‰€æœ‰åœ¨è¾“å…¥ä¸­å‡ºç°çš„$val$ æ»¡è¶³$-10^9\le val\le  10^9$ï¼Œæ‰€æœ‰$a_i$å’Œ$b_i$æ»¡è¶³$0\le a_i,b_i\le 10^9$



## æ ·ä¾‹ #1

### è¾“å…¥

```
7
28
6
4 -192321079
3 418379342
1 3 189801569
3 -840249197
4 -751917965
3 649799919
1 5 -92666141
6
4 451258008
5 1
4 696880327
3 772574465
6
4 301010289
3 480168068
5 3
5 2
4 840536237
5 5
5 4
1 7 -792284106
2 604521872
3 966540578
2 -381646699
3 -939378260
2 -20129935
6
2
0 1
197 199```

### è¾“å‡º

```
2816930```

# AIåˆ†æç»“æœ


### ğŸ’¡ Kayçš„C++ç®—æ³•è§£æï¼šå¿«é€ŸæŸ¥è¯¢ æ·±å…¥å­¦ä¹ æŒ‡å— ğŸ’¡

> **Kayçš„å­¦ä¹ æç¤º**ï¼šæœ¬é¢˜æ˜¯æ ‡è®°ä¼ é€’çš„ç»å…¸åº”ç”¨ï¼Œæ ¸å¿ƒåœ¨äº**ç”¨æ•°å­¦å˜æ¢ç»Ÿä¸€å…¨å±€æ“ä½œ**ï¼Œç”¨**ç¦»æ•£åŒ–å¤„ç†æµ·é‡æ•°æ®**ã€‚æƒ³è±¡ä½ æŒ‡æŒ¥ä¸€æ”¯åƒç´ å†›é˜Ÿï¼šå°†å†›ï¼ˆå…¨å±€æ ‡è®°ï¼‰å‘ä»¤æ—¶ï¼Œæ‰€æœ‰å£«å…µåŒæ­¥è¡ŒåŠ¨ï¼›ç‰¹ç§å…µï¼ˆå•ç‚¹ä¿®æ”¹ï¼‰åˆ™éœ€å•ç‹¬è®°å½•è¡ŒåŠ¨è½¨è¿¹ã€‚ä¸‹é¢æˆ‘ä»¬é€šè¿‡åƒç´ åŠ¨ç”»å’Œä»£ç æ‹†è§£ï¼Œç›´è§‚æ„Ÿå—ç®—æ³•é­…åŠ›ï¼

---

## 1. é¢˜ç›®è§£è¯»ä¸æ ¸å¿ƒç®—æ³•è¯†åˆ«

âœ¨ **æœ¬é¢˜ä¸»è¦è€ƒå¯Ÿ**ï¼š`æ‡’æ ‡è®°æŠ€å·§` + `ç¦»æ•£åŒ–åº”ç”¨`

ğŸ—£ï¸ **åˆæ­¥åˆ†æ**ï¼š
> å°±åƒç”¨ã€Œä¸‡èƒ½é¥æ§å™¨ã€ç®¡ç†æ™ºèƒ½å®¶å±…ï¼šå…¨å±€æ“ä½œï¼ˆåŠ /ä¹˜/èµ‹å€¼ï¼‰æ˜¯æ‰¹é‡å¼€å…³ï¼Œå•ç‚¹æ“ä½œæ˜¯å•ç‹¬è°ƒæ§æŸä¸ªè®¾å¤‡ã€‚è§£é¢˜éœ€ç»´æŠ¤**å…¨å±€å˜æ¢å…¬å¼** `å€¼ = åŸºå€¼ * mul + add`ï¼š
> - **æ ¸å¿ƒéš¾ç‚¹**ï¼šå…¨å±€ä¹˜0æ—¶å…¬å¼å¤±æ•ˆï¼ˆé™¤0é”™è¯¯ï¼‰ï¼Œéœ€ç‰¹æ®Šå¤„ç†ä¸ºå…¨å±€èµ‹å€¼0
> - **ç¦»æ•£åŒ–å…³é”®**ï¼šä»…è®°å½•è¢«ä¿®æ”¹è¿‡çš„ä½ç½®ï¼ˆæœ€å¤š10^5ä¸ªï¼‰ï¼Œå…¶ä»–ä½ç½®è‡ªåŠ¨é‡‡ç”¨å…¨å±€å€¼
> - **å¯è§†åŒ–è®¾è®¡**ï¼šåƒç´ ç½‘æ ¼ä¸­ï¼Œå…¨å±€æ“ä½œæ—¶æ‰€æœ‰æ ¼å­åŒæ­¥å˜è‰²é—ªçƒï¼Œå•ç‚¹ä¿®æ”¹æ—¶ç›®æ ‡æ ¼é«˜äº®è·³åŠ¨ã€‚å¤å¤éŸ³æ•ˆï¼šä¹˜æ³•æ“ä½œè§¦å‘"å˜€"å£°ï¼ŒåŠ æ³•è§¦å‘"å˜Ÿ"å£°ï¼Œå…¨å±€èµ‹å€¼æ’­æ”¾"å“—"çš„åˆ·æ–°éŸ³ï¼

---

## 2. ç²¾é€‰ä¼˜è´¨é¢˜è§£å‚è€ƒ

**é¢˜è§£ä¸€ï¼šreyikï¼ˆèµ5ï¼‰**
* **ç‚¹è¯„**ï¼š  
  æ€è·¯ç›´å‡»æœ¬è´¨â€”â€”ç”¨`mul/add`æ ‡è®°ç»Ÿä¸€å…¨å±€æ“ä½œï¼Œç”¨`map`è®°å½•å•ç‚¹åŸºå€¼ã€‚äº®ç‚¹åœ¨äº**ç”¨æ—¶é—´æˆ³åŒºåˆ†å…¨å±€/å•ç‚¹å½±å“**ï¼š  
  - ä»£ç ç®€æ´ï¼ˆä»…50è¡Œï¼‰ï¼Œå˜é‡å`v0/mul/add`è‡ªè§£é‡Š  
  - å…¨å±€ä¹˜0æ—¶é‡ç½®æ ‡è®°ï¼Œé¿å…é™¤0å¼‚å¸¸  
  - ç»´æŠ¤æ€»å’Œ`sum`å®ç°O(1)å…¨å±€æŸ¥è¯¢  
  > *å­¦ä¹ ä»·å€¼ï¼šç”¨æœ€å°‘å˜é‡æ„å»ºå®Œæ•´é€»è¾‘æ¡†æ¶*

**é¢˜è§£äºŒï¼šConicalï¼ˆèµ1ï¼‰**
* **ç‚¹è¯„**ï¼š  
  é‡‡ç”¨**é€†å…ƒå·§è§£çº¿æ€§æ–¹ç¨‹**ï¼šå•ç‚¹èµ‹å€¼æ—¶ç”¨`åŸºå€¼=(æ–°å€¼-add)*mul^{-1}`åæ¨  
  - ç¦»æ•£åŒ–é¢„å¤„ç†æå‡æ•ˆç‡  
  - å•ç‹¬è®°å½•ç¦»æ•£ç‚¹é›†åˆï¼Œå…¨å±€èµ‹å€¼æ—¶æ¸…ç©ºé›†åˆ  
  - ä¸¥æ ¼å¤„ç†è´Ÿæ•°å–æ¨¡ï¼Œé²æ£’æ€§å¼º  
  > *å­¦ä¹ ä»·å€¼ï¼šé€†å…ƒåœ¨æ ‡è®°ä¼ é€’ä¸­çš„ç»å…¸åº”ç”¨*

---

## 3. æ ¸å¿ƒéš¾ç‚¹è¾¨æä¸è§£é¢˜ç­–ç•¥

1.  **éš¾ç‚¹ï¼šå…¨å±€ä¹˜0çš„å¤„ç†**  
    * **åˆ†æ**ï¼šå½“`mul=0`æ—¶ï¼Œå˜æ¢å…¬å¼é€€åŒ–ä¸º`å€¼=add`ï¼Œéœ€è½¬æ¢ä¸ºå…¨å±€èµ‹å€¼ï¼š  
      ```cpp
      if(op==3 && val==0) {  // å…¨å±€ä¹˜0è½¬ä¸ºèµ‹å€¼0
          gset(0);  // é‡ç½®æ ‡è®°ï¼šmul=1, add=0
          clear_points(); // æ¸…ç©ºå•ç‚¹è®°å½•
      }
      ```
    * ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šä¹˜0æ˜¯å…¨å±€èµ‹å€¼çš„ç‰¹ä¾‹ï¼Œå¿…é¡»ç‰¹æ®Šå¤„ç†ï¼

2.  **éš¾ç‚¹ï¼šå•ç‚¹å€¼çš„æ—¶ç©ºè¿½è¸ª**  
    * **åˆ†æ**ï¼šç”¨æ—¶é—´æˆ³æ¯”è¾ƒåˆ¤æ–­å½“å‰å€¼æ¥æºï¼š  
      ```mermaid
      graph LR
        A[æŸ¥è¯¢ä½ç½®X] --> B{æœ€åæ“ä½œç±»å‹}
        B -->|å…¨å±€èµ‹å€¼æ™šäºå•ç‚¹ä¿®æ”¹| C[é‡‡ç”¨å…¨å±€å€¼]
        B -->|å•ç‚¹ä¿®æ”¹æ™šäºå…¨å±€èµ‹å€¼| D[åŸºå€¼*mul+add]
      ```
    * ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šæ—¶é—´æˆ³æ˜¯è¿æ¥ç¦»æ•£ç‚¹ä¸å…¨å±€çŠ¶æ€çš„æ¡¥æ¢

3.  **éš¾ç‚¹ï¼šåŠ¨æ€ç»´æŠ¤å…ƒç´ å’Œ**  
    * **åˆ†æ**ï¼šæ€»å’Œæ›´æ–°éœ€åŒæ­¥æ‰€æœ‰æ“ä½œï¼š  
      - å•ç‚¹ä¿®æ”¹ï¼š`sum = sum - æ—§å€¼ + æ–°å€¼`  
      - å…¨å±€åŠ ï¼š`sum += n * val`  
      - å…¨å±€ä¹˜ï¼š`sum *= val`  
    * ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šæ€»å’Œå˜é‡æ˜¯å…¨å±€æ“ä½œçš„é•œåƒåæ˜ 

### âœ¨ è§£é¢˜æŠ€å·§æ€»ç»“
- **æŠ€å·§1ï¼šæ•°å­¦å»ºæ¨¡** - ç”¨`å€¼ = åŸºå€¼ * mul + add`ç»Ÿä¸€å…¨å±€æ“ä½œ  
- **æŠ€å·§2ï¼šç¦»æ•£åŒ–å‹ç¼©** - ä»…å­˜å‚¨è¢«ä¿®æ”¹ç‚¹çš„åŸºå€¼  
- **æŠ€å·§3ï¼šæ—¶é—´æˆ³æ¯”å¯¹** - é«˜æ•ˆåˆ¤æ–­å€¼æ¥æº  
- **æŠ€å·§4ï¼šé€†å…ƒå¦™ç”¨** - å•ç‚¹èµ‹å€¼æ—¶åæ¨åŸºå€¼  

---

## 4. C++æ ¸å¿ƒä»£ç å®ç°èµæ

**æœ¬é¢˜é€šç”¨æ ¸å¿ƒå®ç°å‚è€ƒ**
* **è¯´æ˜**ï¼šç»¼åˆä¼˜è´¨é¢˜è§£æ€è·¯ï¼Œä¿ç•™reyikçš„æ ‡è®°æ¡†æ¶ï¼Œèå…¥Conicalçš„ç¦»æ•£åŒ–
* **å®Œæ•´æ ¸å¿ƒä»£ç **ï¼š
```cpp
#include <unordered_map>
using namespace std;
const int MOD = 1e7 + 19;

struct Solver {
    int n, mul = 1, add = 0, sum = 0;
    int global_time = 0;                   // å…¨å±€æ“ä½œæ—¶é—´æˆ³
    unordered_map<int, int> base_val;      // ç¦»æ•£ç‚¹åŸºå€¼
    unordered_map<int, int> last_mod;       // å•ç‚¹æœ€åä¿®æ”¹æ—¶é—´

    void init(int _n) { n = _n; } 

    void global_set(int val) { 
        mul = 1; add = val; 
        sum = 1LL * n * val % MOD; 
        global_time++;
    }

    void global_add(int val) { 
        add = (add + val) % MOD; 
        sum = (sum + 1LL * n * val) % MOD; 
    }

    void global_mul(int val) {
        if(val == 0) { global_set(0); return; } // ä¹˜0è½¬èµ‹å€¼
        mul = 1LL * mul * val % MOD; 
        add = 1LL * add * val % MOD;
        sum = 1LL * sum * val % MOD;
    }

    void point_set(int idx, int val) {
        int old_val = point_query(idx);    // è·å–å½“å‰å€¼
        sum = (sum - old_val + MOD) % MOD; // ç§»é™¤æ—§å€¼
        
        base_val[idx] = 1LL * (val - add + MOD) * inv(mul) % MOD; // é€†æ¨åŸºå€¼
        last_mod[idx] = global_time;       // æ›´æ–°æ—¶é—´æˆ³
        sum = (sum + val) % MOD;           // åŠ å…¥æ–°å€¼
    }

    int point_query(int idx) {
        if(!last_mod.count(idx) || last_mod[idx] < global_time) 
            return (1LL * 0 * mul + add) % MOD; // å…¨å±€å€¼
        return (1LL * base_val[idx] * mul + add) % MOD;
    }
};
```
* **ä»£ç è§£è¯»æ¦‚è¦**ï¼š
  - `global_*`æ–¹æ³•ï¼šå¤„ç†å…¨å±€æ“ä½œå¹¶æ›´æ–°`sum`
  - `point_set`ï¼šç”¨é€†å…ƒè®¡ç®—åŸºå€¼ï¼Œæ›´æ–°æ—¶é—´æˆ³
  - `point_query`ï¼šé€šè¿‡æ—¶é—´æˆ³å†³ç­–å€¼æ¥æº

---

## 5. ç®—æ³•å¯è§†åŒ–ï¼šåƒç´ åŠ¨ç”»æ¼”ç¤º

### ğŸ® åƒç´ åŒ–æŒ‡ä»¤ç³»ç»Ÿï¼ˆFCçº¢ç™½æœºé£æ ¼ï¼‰
```mermaid
graph TB
  subgraph æ§åˆ¶é¢æ¿
    A[å¼€å§‹] --> B[å•æ­¥æ‰§è¡Œ]
    A --> C[è‡ªåŠ¨æ’­æ”¾]
    C --> D[é€Ÿåº¦æ»‘å—]
    A --> E[é‡ç½®]
  end
  
  subgraph ä¸»ç½‘æ ¼
    F[0x0] -->|åˆå§‹çŠ¶æ€| G[å…¨ç°]
    G -->|å…¨å±€ä¹˜3| H[å…¨å˜æ·±è“]
    H -->|å•ç‚¹èµ‹å€¼| I[ç›®æ ‡æ ¼é—ªçƒé»„è‰²]
  end
```

**åŠ¨ç”»å…³é”®æµç¨‹**ï¼š  
1. **åˆå§‹åŒ–**ï¼š  
   - ç°è‰²ç½‘æ ¼ä»£è¡¨å…¨0åºåˆ—ï¼ŒèƒŒæ™¯æ’­æ”¾8-bitèŠ¯ç‰‡éŸ³ä¹  
   - æ§åˆ¶é¢æ¿å«é€Ÿåº¦æ»‘å—ï¼ˆ1x-10xï¼‰

2. **å…¨å±€æ“ä½œç‰¹æ•ˆ**ï¼š  
   - å…¨å±€åŠ ï¼šæ‰€æœ‰æ ¼å­**å‘ä¸Šæ»‘åŠ¨**+ç»¿è‰²æ³¢çº¹ï¼ŒéŸ³æ•ˆ"å˜Ÿï½"  
   - å…¨å±€ä¹˜ï¼šç½‘æ ¼**è„‰å†²é—ªçƒ**+å¯¹åº”é¢œè‰²ï¼ŒéŸ³æ•ˆ"å˜€ï¼"  
   - å…¨å±€èµ‹å€¼ï¼šå±å¹•**ç™½å…‰é—ªè¿‡**+éŸ³æ•ˆ"å“—ï¼"

3. **å•ç‚¹æ“ä½œç‰¹æ•ˆ**ï¼š  
   - ä¿®æ”¹ä½ç½®é«˜äº®**é»„è‰²é—ªçƒ**ï¼Œæ˜¾ç¤º`æ–°å€¼=(åŸºå€¼Ã—mul)+add`å…¬å¼  
   - åŸºå€¼åŒºæ˜¾ç¤ºä¸ºåƒç´ ä»“åº“ï¼ˆå¦‚ï¼š`ä»“åº“[3]=5 â†’ å½“å‰å€¼=5Ã—2+1=11`ï¼‰

4. **çŠ¶æ€åŒæ­¥æ¼”ç¤º**ï¼š  
   ```plaintext
   å…¨å±€æ ‡è®°ï¼š[mul=2, add=1]
   ä½ç½®5ï¼šåŸºå€¼=3 â†’ å€¼=3Ã—2+1=7ï¼ˆæ˜¾ç¤ºä¸ºçº¢è‰²ï¼‰
   ä½ç½®8ï¼šæ— åŸºå€¼ â†’ å€¼=0Ã—2+1=1ï¼ˆæ˜¾ç¤ºä¸ºè“è‰²ï¼‰
   ```

5. **ä¹˜0ç‰¹æ®Šå¤„ç†**ï¼š  
   - è§¦å‘æ—¶æ’­æ”¾"ç °ï¼"çˆ†ç‚¸éŸ³æ•ˆï¼Œæ‰€æœ‰ç½‘æ ¼å˜é»‘  
   - æ˜¾ç¤ºæç¤ºï¼š"æ£€æµ‹åˆ°ä¹˜0ï¼è½¬æ¢ä¸ºå…¨å±€èµ‹å€¼0"

---

## 6. æ‹“å±•ç»ƒä¹ ä¸ç›¸ä¼¼é—®é¢˜æ€è€ƒ

**æŠ€å·§è¿ç§»åœºæ™¯**ï¼š  
1. åŒºé—´èµ‹å€¼+å•ç‚¹æŸ¥è¯¢ï¼ˆæ ‘çŠ¶æ•°ç»„å˜å½¢ï¼‰  
2. å«æ—¶é—´æˆ³çš„ç‰ˆæœ¬æ§åˆ¶ç³»ç»Ÿ  
3. æ¸¸æˆä¸­çš„å…¨å±€çŠ¶æ€buffç³»ç»Ÿ  

**æ´›è°·æ¨è**ï¼š  
1. **P3372 çº¿æ®µæ ‘1**  
   ğŸ—£ï¸ *ç»ƒä¹ åŸºç¡€æ ‡è®°ä¸‹ä¼ ï¼Œç†è§£æ‡’æ ‡è®°æœ¬è´¨*  
2. **P3870 å¼€å…³**  
   ğŸ—£ï¸ *å¼ºåŒ–å¼‚æˆ–æ ‡è®°ä¸çŠ¶æ€ç¿»è½¬æ€ç»´*  
3. **P1253 æ‰¶è‹çš„é—®é¢˜**  
   ğŸ—£ï¸ *ç»¼åˆç»ƒä¹ èµ‹å€¼/åŠ /ä¹˜æ ‡è®°çš„ä¼˜å…ˆçº§å¤„ç†*

---

## 7. å­¦ä¹ å¿ƒå¾—ä¸ç»éªŒåˆ†äº«

> **reyikçš„è°ƒè¯•ç»éªŒ**ï¼š  
> *â€œå…¨å±€ä¹˜0æœªè½¬æ¢èµ‹å€¼å¯¼è‡´WAï¼Œç”¨`assert(mul!=0)`å®šä½é”™è¯¯â€*  
>  
> **Kayçš„æ€»ç»“**ï¼šè¾¹ç•Œæ¡ä»¶æµ‹è¯•å¿…é¡»åŒ…å«ï¼š  
> - è¿ç»­ä¹˜0æ“ä½œ  
> - å•ç‚¹ä¿®æ”¹åç«‹å³ä¹˜0  
> - è´Ÿæ•°å–æ¨¡éªŒè¯  

---

> **èƒœåˆ©éŸ³æ•ˆ** ğŸ®ï¼šå½“ä½ å¾æœè¿™é“é¢˜æ—¶ï¼Œ8-bitèƒœåˆ©æ—‹å¾‹å°†ä¸ºä½ å¥å“ï¼è®°ä½Kayçš„é¼“åŠ±ï¼š**â€œç®—æ³•å¦‚æ¸¸æˆï¼Œé€šå…³é ç­–ç•¥ä¸åšæŒâ€** ä¸‹æ¬¡è§ï¼ ğŸ‘¾

---
å¤„ç†ç”¨æ—¶ï¼š135.50ç§’
# é¢˜ç›®ä¿¡æ¯

# ã€çƒ‚é¢˜æ¯ Round 1ã€‘æ¶ˆç­åŠ³å—

## é¢˜ç›®æè¿°

ä½ éœ€è¦æ¶ˆç­åŠ³å—ã€‚

ç»™å®šä¸€ä¸ªé•¿åº¦ä¸º $n$ çš„æ’åˆ— $A=a_1,a_2,\cdots,a_n$ï¼Œå®šä¹‰ $S_i=\{x|x\ge i\land \max_{i\le k\le x}a_k\le a_x\}$ï¼Œæ‚¨å¯ä»¥æŠŠå®ƒç†è§£ä¸ºä»¥ $i$ å¼€å¤´çš„åç¼€çš„å‰ç¼€æœ€å¤§å€¼çš„ä¸‹æ ‡é›†åˆã€‚ä¾‹å¦‚å¯¹äº $A=\{3,5,2,1,4\}$ï¼Œ$S_1=\{1,2\}$ï¼Œ$S_3=\{3,5\}$ã€‚

æœ‰ $q$ æ¬¡è¯¢é—®ï¼Œæ¯æ¬¡è¯¢é—®ç»™å‡º $l,r$ï¼Œæ±‚ï¼š

$$
\left(\left(\sum_{l\le x\le y\le r} |S_x\cup S_y|-\sum_{\substack{{1\le x<l}\\{r<y\le n}}} |S_x\cup S_y|\right)\bmod P+P\right)\bmod P
$$

å…¶ä¸­ï¼Œ$P=998244353$ã€‚

## è¯´æ˜/æç¤º

**æ ·ä¾‹ 1 è§£é‡Šï¼š**

æ“ä½œå $A=\{1,5,4,2,3\}$ã€‚

å¯¹è¯¢é—®è§£å¯†åçœŸå®è¯¢é—®å¦‚ä¸‹ï¼š

```
4 5
2 3
1 5
3 4
3 5
```

å¯¹è¾“å‡ºè§£å¯†åçœŸå®è¾“å‡ºå¦‚ä¸‹ï¼š

```
5
998244350
33
1
11
```

å¯¹äºç¬¬ä¸€ä¸ªè¯¢é—®ï¼Œ$S_4=\{4,5\}$ï¼Œ$S_5=\{5\}$ï¼Œ$|S_4\cup S_4|+|S_4\cup S_5|+|S_5\cup S_5|=5$ã€‚

å¯¹äºå€’æ•°ç¬¬äºŒä¸ªè¯¢é—®ï¼Œä¸è¦å¿˜äº† $1\le x<l,r<y\le n$ çš„é¡¹ã€‚

**æ•°æ®èŒƒå›´ï¼š**

å¯¹äº $20\%$ çš„æ•°æ®ï¼Œæ»¡è¶³ $1\le n\le 100$ã€$1\le q\le 100$ã€‚

å¯¹äº $40\%$ çš„æ•°æ®ï¼Œæ»¡è¶³ $1\le n\le 100$ã€$1\le q\le 10^5$ã€‚

å¯¹äº $60\%$ çš„æ•°æ®ï¼Œæ»¡è¶³ $1\le n\le 10^5$ã€$1\le q\le 10^5$ã€‚

å¯¹äº $80\%$ çš„æ•°æ®ï¼Œæ»¡è¶³ $1\le n\le 3\times10^6$ã€$1\le q\le 3\times10^6$ã€‚

å¯¹äº $100\%$ çš„æ•°æ®ï¼Œæ»¡è¶³ $1\le n\le 10^7$ï¼Œ$1\le q\le 10^7$ï¼Œ$0\le c\le 10^7$ï¼Œ$0\le X\le 10^9$ï¼Œ$a_i$ äº’ä¸ç›¸åŒã€‚

**è¯·å„ä½é€‰æ‰‹æ³¨æ„å¸¸æ•°å› å­çš„å½±å“ã€‚**

## æ ·ä¾‹ #1

### è¾“å…¥

```
5 3
4
5```

### è¾“å‡º

```
998244304```

## æ ·ä¾‹ #2

### è¾“å…¥

```
10 114514
191981
3```

### è¾“å‡º

```
998244191```

# AIåˆ†æç»“æœ

# ğŸ’¡ Kayçš„C++ç®—æ³•è§£æï¼šæ¶ˆç­åŠ³å— æ·±å…¥å­¦ä¹ æŒ‡å— ğŸ’¡

ä»Šå¤©æˆ‘ä»¬æ¥ä¸€èµ·åˆ†æã€Œæ¶ˆç­åŠ³å—ã€è¿™é“é¢˜ã€‚å®ƒéœ€è¦æˆ‘ä»¬ç»“åˆ**å•è°ƒæ ˆ**å’Œ**å‰ç¼€å’Œ**çš„æŠ€å·§ï¼Œè§£å†³å¤æ‚çš„é›†åˆè¿ç®—ä¸åŒºé—´æŸ¥è¯¢é—®é¢˜ã€‚é€šè¿‡æ‹†è§£é—®é¢˜ã€è½¬åŒ–æ€è·¯ï¼Œæˆ‘ä»¬èƒ½å¿«é€ŸæŒæ¡æ ¸å¿ƒé€»è¾‘ï¼


## 1. é¢˜ç›®è§£è¯»ä¸æ ¸å¿ƒç®—æ³•è¯†åˆ«

### âœ¨ æœ¬é¢˜ä¸»è¦è€ƒå¯Ÿï¼šç¼–ç¨‹æŠ€å·§åº”ç”¨ï¼ˆå•è°ƒæ ˆä¸å‰ç¼€å’Œï¼‰
å•è°ƒæ ˆå°±åƒä¸€ä¸ªã€Œä¸¥æ ¼æ•´ç†çš„è´§æ¶ã€â€”â€”åªèƒ½æ”¾ç¬¦åˆé¡ºåºçš„ç‰©å“ï¼Œç”¨æ¥å¿«é€Ÿæ‰¾åˆ°**ä¸‹ä¸€ä¸ªæ›´å¤§/æ›´å°å…ƒç´ **ï¼›å‰ç¼€å’Œåˆ™æ˜¯ã€Œæå‰ç®—å¥½çš„è´¦å•ã€ï¼Œèƒ½å¿«é€Ÿå›ç­”ã€ŒæŸæ®µæ€»å’Œæ˜¯å¤šå°‘ã€ã€‚æœ¬é¢˜ä¸­ï¼Œæˆ‘ä»¬ç”¨å•è°ƒæ ˆè®¡ç®—æ¯ä¸ª`S_i`çš„å¤§å°ï¼Œå†ç”¨å•è°ƒæ ˆé¢„å¤„ç†**åŒºé—´æœ€å°å€¼çš„å’Œ**ï¼Œæœ€åç”¨å‰ç¼€å’Œå¿«é€Ÿå›ç­”è¯¢é—®ã€‚


### ğŸ—£ï¸ åˆæ­¥åˆ†æ
é¢˜ç›®è¦æ±‚è®¡ç®—ä¸¤ä¸ªåŒé‡æ±‚å’Œçš„å·®ï¼Œç›´æ¥æš´åŠ›è®¡ç®—ä¼šè¶…æ—¶ï¼ˆ`n,qâ‰¤1e7`ï¼‰ã€‚é¢˜è§£çš„æ ¸å¿ƒæ€è·¯æ˜¯ï¼š
1. **å®¹æ–¥è½¬åŒ–**ï¼šå°†`|S_xâˆªS_y|`æ‹†æˆ`|S_x|+|S_y|-|S_xâˆ©S_y|`ï¼Œå‰ä¸¤é¡¹ç”¨å‰ç¼€å’Œå¿«é€Ÿè®¡ç®—ã€‚
2. **äº¤é›†è½¬åŒºé—´æœ€å°å€¼**ï¼šé€šè¿‡è§‚å¯Ÿ`S_i`çš„ç»“æ„ï¼Œå‘ç°`|S_xâˆ©S_y|=min_{i=x}^{y-1}|S_i| - 1`ï¼ˆ`|S_i|`æ˜¯`S_i`çš„å¤§å°ï¼‰ã€‚
3. **å•è°ƒæ ˆé¢„å¤„ç†**ï¼šç”¨å•è°ƒæ ˆè®¡ç®—æ‰€æœ‰åŒºé—´çš„æœ€å°å€¼çš„å’Œï¼ˆ`L`æ•°ç»„å’Œ`R`æ•°ç»„ï¼‰ï¼Œå®ç°`O(1)`å›ç­”è¯¢é—®ã€‚

### å¯è§†åŒ–è®¾è®¡æ€è·¯
æˆ‘ä»¬ç”¨**8ä½åƒç´ é£æ ¼**å±•ç¤ºå•è°ƒæ ˆçš„å˜åŒ–ï¼š
- æ•°ç»„å…ƒç´ ç”¨ä¸åŒé¢œè‰²çš„æ–¹å—è¡¨ç¤ºï¼Œå•è°ƒæ ˆæ˜¯å³ä¾§çš„ã€Œç«–åˆ—è´§æ¶ã€ã€‚
- å…ƒç´ å…¥æ ˆæ—¶ï¼Œæ–¹å—ã€Œæ»‘å…¥ã€è´§æ¶å¹¶ä¼´éšã€Œå®ã€çš„éŸ³æ•ˆï¼›å¼¹å‡ºæ—¶ã€Œæ»‘å‡ºã€ä¼´éšã€Œå—’ã€çš„éŸ³æ•ˆã€‚
- åŒºé—´è´¡çŒ®è®¡ç®—æ—¶ï¼Œæ•°å€¼åŒºåŸŸå®æ—¶æ›´æ–°ï¼Œä¼´éšã€Œæ»´ã€çš„æç¤ºéŸ³ã€‚
- è¯¢é—®å¤„ç†æ—¶ï¼Œ`l`åˆ°`r`çš„åŒºåŸŸé«˜äº®ï¼Œç»“æœæ˜¾ç¤ºåœ¨å±å¹•ä¸Šæ–¹ï¼Œä¼´éšã€Œå®~ã€çš„èƒœåˆ©éŸ³æ•ˆã€‚


## 2. ç²¾é€‰ä¼˜è´¨é¢˜è§£å‚è€ƒ

ä¸ºå¤§å®¶ç­›é€‰äº†3ä»½æ€è·¯æ¸…æ™°ã€ä»£ç é«˜æ•ˆçš„é¢˜è§£ï¼š


### **é¢˜è§£ä¸€ï¼š(æ¥æºï¼šZnPdCo)**
**ç‚¹è¯„**ï¼šè¿™ä»½é¢˜è§£çš„é€»è¾‘æœ€å®Œæ•´ï¼Œç”¨**ä¸¤ä¸ªå•è°ƒæ ˆ**åˆ†åˆ«å¤„ç†`S_i`çš„å¤§å°å’ŒåŒºé—´æœ€å°å€¼çš„å’Œã€‚ä»£ç ç»“æ„æ¸…æ™°ï¼Œå¿«é€ŸIOçš„ä½¿ç”¨ï¼ˆ`ios::sync_with_stdio(false)`ï¼‰é€‚åˆå¤§æ•°æ®é‡ï¼Œè¾¹ç•Œæ¡ä»¶å¤„ç†ä¸¥è°¨ï¼ˆæ¯”å¦‚`nxt[i]`çš„è®¡ç®—ï¼‰ã€‚


### **é¢˜è§£äºŒï¼š(æ¥æºï¼šDaiRuiChen007)**
**ç‚¹è¯„**ï¼šä»£ç æœ€ç®€æ´ï¼Œç”¨`iota`åˆå§‹åŒ–æ•°ç»„ï¼ˆ`iota(a+1,a+n+1,1)`ï¼‰ï¼Œ`fl`å’Œ`fr`æ•°ç»„çš„è®¾è®¡å¾ˆå·§å¦™â€”â€”ç›´æ¥è®°å½•å‰`i`ä¸ªå…ƒç´ çš„åŒºé—´æœ€å°å€¼å’Œï¼Œé¢„å¤„ç†é€»è¾‘ç›´è§‚ã€‚


### **é¢˜è§£ä¸‰ï¼š(æ¥æºï¼šP2441M)**
**ç‚¹è¯„**ï¼šå¯¹ã€Œäº¤é›†è½¬åŒºé—´æœ€å°å€¼ã€çš„æ¨å¯¼æœ€è¯¦ç»†ï¼Œä¸€æ­¥æ­¥æ‹†è§£é—®é¢˜ï¼Œé€‚åˆæ–°æ‰‹ç†è§£ã€‚`add`å’Œ`sub`å‡½æ•°å°è£…äº†æ¨¡è¿ç®—ï¼Œé¿å…è´Ÿæ•°é—®é¢˜ï¼Œæ˜¯å¾ˆå¥½çš„ç¼–ç¨‹ä¹ æƒ¯ã€‚


## 3. æ ¸å¿ƒéš¾ç‚¹è¾¨æä¸è§£é¢˜ç­–ç•¥

### ğŸ” æ ¸å¿ƒéš¾ç‚¹1ï¼šå¹¶é›†è½¬äº¤é›†çš„å®¹æ–¥åº”ç”¨
**é—®é¢˜**ï¼š`|S_xâˆªS_y|`ç›´æ¥è®¡ç®—å¾ˆå¤æ‚ã€‚  
**ç­–ç•¥**ï¼šç”¨å®¹æ–¥å…¬å¼`|AâˆªB|=|A|+|B|-|Aâˆ©B|`ï¼Œå°†å¹¶é›†è½¬åŒ–ä¸º**å•ä¸ªé›†åˆå¤§å°**ï¼ˆæ˜“ç®—ï¼‰å’Œ**äº¤é›†å¤§å°**ï¼ˆéœ€è½¬åŒ–ï¼‰ã€‚


### ğŸ” æ ¸å¿ƒéš¾ç‚¹2ï¼šäº¤é›†è½¬åŒºé—´æœ€å°å€¼
**é—®é¢˜**ï¼š`|S_xâˆ©S_y|`çš„ç»“æ„ä¸ç›´è§‚ã€‚  
**ç­–ç•¥**ï¼šè§‚å¯Ÿ`S_i`çš„å®šä¹‰â€”â€”`S_i`æ˜¯ã€Œä»`i`å¼€å§‹çš„åç¼€çš„å‰ç¼€æœ€å¤§å€¼ä¸‹æ ‡é›†åˆã€ï¼Œå› æ­¤`S_x`ä¸­çš„å…ƒç´ æ˜¯**å•è°ƒé€’å¢**çš„ï¼ˆæ¯”å¦‚`S_1={1,2}`ï¼Œ`S_3={3,5}`ï¼‰ã€‚å½“`x<y`æ—¶ï¼Œ`S_xâˆ©S_y`ç­‰äº`S_x`ä¸­â‰¥`y`çš„å…ƒç´ ï¼Œå…¶ä¸ªæ•°ç­‰äº`min_{i=x}^{y-1}|S_i| - 1`ï¼ˆ`|S_i|`æ˜¯`S_i`çš„å¤§å°ï¼‰ã€‚


### ğŸ” æ ¸å¿ƒéš¾ç‚¹3ï¼šé«˜æ•ˆè®¡ç®—åŒºé—´æœ€å°å€¼çš„å’Œ
**é—®é¢˜**ï¼šç›´æ¥è®¡ç®—æ‰€æœ‰åŒºé—´çš„æœ€å°å€¼çš„å’Œæ˜¯`O(nÂ²)`ï¼Œä¼šè¶…æ—¶ã€‚  
**ç­–ç•¥**ï¼šç”¨**å•è°ƒæ ˆ**ç»´æŠ¤ã€Œå•è°ƒé€’å¢çš„åŒºé—´ã€ã€‚æ¯æ¬¡åŠ å…¥æ–°å…ƒç´ æ—¶ï¼Œå¼¹å‡ºæ ˆä¸­æ¯”å®ƒå¤§çš„å…ƒç´ ï¼ˆè¿™äº›å…ƒç´ æ— æ³•å†ä½œä¸ºæœ€å°å€¼ï¼‰ï¼Œè®¡ç®—æ–°å…ƒç´ ä½œä¸ºæœ€å°å€¼çš„æ‰€æœ‰åŒºé—´çš„è´¡çŒ®ï¼Œæ€»æ—¶é—´å¤æ‚åº¦`O(n)`ã€‚


### âœ¨ è§£é¢˜æŠ€å·§æ€»ç»“
1. **å®¹æ–¥ç®€åŒ–é—®é¢˜**ï¼šé‡åˆ°é›†åˆè¿ç®—ï¼Œå…ˆæƒ³å®¹æ–¥å…¬å¼ã€‚  
2. **è§‚å¯Ÿç»“æ„è½¬åŒ–**ï¼šå¤æ‚çš„é›†åˆé—®é¢˜ï¼Œå°è¯•è½¬åŒ–ä¸ºã€ŒåŒºé—´æœ€å€¼ã€ç­‰ç†Ÿæ‚‰çš„æ¨¡å‹ã€‚  
3. **å•è°ƒæ ˆé¢„å¤„ç†**ï¼šå¤„ç†ã€Œä¸‹ä¸€ä¸ªæ›´å¤§å…ƒç´ ã€æˆ–ã€ŒåŒºé—´æœ€å€¼å’Œã€æ—¶ï¼Œå•è°ƒæ ˆæ˜¯ç¥å™¨ã€‚  
4. **å‰ç¼€å’ŒåŠ é€ŸæŸ¥è¯¢**ï¼šæ‰€æœ‰éœ€è¦å¿«é€Ÿæ±‚å’Œçš„é—®é¢˜ï¼Œéƒ½å¯ä»¥ç”¨å‰ç¼€å’Œé¢„å¤„ç†ã€‚


## 4. C++æ ¸å¿ƒä»£ç å®ç°èµæ

### æœ¬é¢˜é€šç”¨æ ¸å¿ƒC++å®ç°å‚è€ƒ
**è¯´æ˜**ï¼šç»¼åˆ3ä»½é¢˜è§£çš„æ€è·¯ï¼Œå®ç°æ ¸å¿ƒé€»è¾‘â€”â€”è®¡ç®—`S_i`çš„å¤§å°ã€åŒºé—´æœ€å°å€¼å’Œï¼Œä»¥åŠå¤„ç†è¯¢é—®ã€‚

```cpp
#include <iostream>
#include <vector>
#include <algorithm>
using namespace std;

const int N = 1e7 + 5;
const int MOD = 998244353;

int n, X, c, q;
int a[N], nxt[N], f[N], pre_sum[N];
long long L[N], R[N];
int stk[N], top;

int main() {
    ios::sync_with_stdio(false);
    cin.tie(nullptr);

    cin >> n >> X >> c;
    for (int i = 1; i <= n; ++i) a[i] = i;
    for (int i = 1; i <= c; ++i) {
        int l = ((1LL * X * (X ^ i)) % n) + 1;
        int r = (X ^ (1LL * i * i)) % n + 1;
        swap(a[l], a[r]);
    }

    // è®¡ç®—nxt[i]ï¼ˆå³è¾¹ç¬¬ä¸€ä¸ªæ¯”a[i]å¤§çš„ä½ç½®ï¼‰å’Œf[i]ï¼ˆ|S_i|ï¼‰
    top = 0;
    stk[top] = n + 1;
    for (int i = n; i >= 1; --i) {
        while (top && a[stk[top]] < a[i]) --top;
        nxt[i] = stk[top];
        f[i] = 1 + (nxt[i] <= n ? f[nxt[i]] : 0);
        stk[++top] = i;
    }

    // è®¡ç®—fçš„å‰ç¼€å’Œpre_sum
    for (int i = 1; i <= n; ++i) {
        pre_sum[i] = (pre_sum[i - 1] + f[i]) % MOD;
    }

    // è®¡ç®—Læ•°ç»„ï¼šå‰iä¸ªå…ƒç´ çš„åŒºé—´æœ€å°å€¼å’Œï¼ˆf[k]-1ï¼‰
    top = 0;
    stk[top] = 0;
    long long sum_L = 0;
    L[0] = 0;
    for (int i = 1; i < n; ++i) {
        int val = f[i] - 1;
        while (top && (f[stk[top]] - 1) > val) {
            sum_L -= 1LL * (f[stk[top]] - 1) * (stk[top] - stk[top - 1]);
            sum_L = (sum_L % MOD + MOD) % MOD;
            --top;
        }
        sum_L += 1LL * val * (i - stk[top]);
        sum_L %= MOD;
        stk[++top] = i;
        L[i] = (L[i - 1] + sum_L) % MOD;
    }

    // è®¡ç®—Ræ•°ç»„ï¼šä»iåˆ°nçš„åŒºé—´æœ€å°å€¼å’Œï¼ˆf[k]-1ï¼‰
    top = 0;
    stk[top] = n;
    long long sum_R = 0;
    R[n + 1] = 0;
    for (int i = n - 1; i >= 1; --i) {
        int val = f[i] - 1;
        while (top && (f[stk[top]] - 1) > val) {
            sum_R -= 1LL * (f[stk[top]] - 1) * (stk[top - 1] - stk[top]);
            sum_R = (sum_R % MOD + MOD) % MOD;
            --top;
        }
        sum_R += 1LL * val * (stk[top] - i);
        sum_R %= MOD;
        stk[++top] = i;
        R[i] = (R[i + 1] + sum_R) % MOD;
    }

    // å¤„ç†è¯¢é—®
    cin >> q;
    long long res = 0;
    for (int i = 1; i <= q; ++i) {
        int l = ((1LL * X * i + (X ^ (1LL * X * i))) % n) + 1;
        int r = ((X - i + (X ^ (X + i))) % n) + 1;
        if (l > r) swap(l, r);

        // è®¡ç®—sum |S_x| + |S_y|
        long long part1 = (1LL * (r - l + 1) * (pre_sum[r] - pre_sum[l - 1] + MOD) % MOD) % MOD;
        part1 = (part1 - 1LL * (n - r) * pre_sum[l - 1] % MOD + MOD) % MOD;
        part1 = (part1 - 1LL * (l - 1) * (pre_sum[n] - pre_sum[r] + MOD) % MOD + MOD) % MOD;

        // è®¡ç®—sum |S_xâˆ©S_y|
        long long part2 = (L[r - 1] + R[l] - L[n - 1] + MOD) % MOD;

        long long ans = (part1 - part2 + MOD) % MOD;
        res ^= ans;
    }

    cout << res << endl;
    return 0;
}
```

**ä»£ç è§£è¯»æ¦‚è¦**ï¼š  
1. **è¾“å…¥å¤„ç†**ï¼šè¯»å–`n`ã€`X`ã€`c`ï¼Œåˆå§‹åŒ–æ•°ç»„`a`ï¼Œå¹¶äº¤æ¢`c`æ¬¡å…ƒç´ ã€‚  
2. **è®¡ç®—`S_i`çš„å¤§å°**ï¼šç”¨å•è°ƒæ ˆä»å³åˆ°å·¦éå†ï¼Œæ‰¾åˆ°æ¯ä¸ª`i`çš„`nxt[i]`ï¼ˆå³è¾¹ç¬¬ä¸€ä¸ªæ¯”`a[i]`å¤§çš„ä½ç½®ï¼‰ï¼Œ`f[i]`æ˜¯`S_i`çš„å¤§å°ï¼ˆ`1 + f[nxt[i]]`ï¼‰ã€‚  
3. **å‰ç¼€å’Œé¢„å¤„ç†**ï¼šè®¡ç®—`f`çš„å‰ç¼€å’Œ`pre_sum`ï¼Œç”¨äºå¿«é€Ÿæ±‚å’Œã€‚  
4. **è®¡ç®—åŒºé—´æœ€å°å€¼å’Œ**ï¼šç”¨å•è°ƒæ ˆè®¡ç®—`L`ï¼ˆå‰`i`ä¸ªå…ƒç´ çš„åŒºé—´æœ€å°å€¼å’Œï¼‰å’Œ`R`ï¼ˆä»`i`åˆ°`n`çš„åŒºé—´æœ€å°å€¼å’Œï¼‰ã€‚  
5. **å¤„ç†è¯¢é—®**ï¼šç”¨`pre_sum`ã€`L`ã€`R`å¿«é€Ÿè®¡ç®—æ¯ä¸ªè¯¢é—®çš„ç­”æ¡ˆï¼Œå¼‚æˆ–å¾—åˆ°æœ€ç»ˆç»“æœã€‚


### é¢˜è§£ä¸€æ ¸å¿ƒç‰‡æ®µèµæï¼ˆæ¥æºï¼šZnPdCoï¼‰
**äº®ç‚¹**ï¼šç”¨å•è°ƒæ ˆè®¡ç®—`nxt[i]`å’Œ`f[i]`ï¼Œé€»è¾‘ç›´æ¥ã€‚

```cpp
// è®¡ç®—nxt[i]å’Œf[i]
top = 0;
stk[top] = n + 1;
for (int i = n; i >= 1; --i) {
    while (top && a[stk[top]] < a[i]) --top;
    nxt[i] = stk[top];
    f[i] = 1 + (nxt[i] <= n ? f[nxt[i]] : 0);
    stk[++top] = i;
}
```

**ä»£ç è§£è¯»**ï¼š  
- `stk`ç»´æŠ¤ã€Œå³è¾¹æ¯”`a[i]`å¤§çš„å…ƒç´ çš„ä½ç½®ã€ã€‚ä»å³åˆ°å·¦éå†ï¼Œå¼¹å‡ºæ ˆä¸­æ¯”`a[i]`å°çš„å…ƒç´ ï¼ˆè¿™äº›å…ƒç´ æ— æ³•æˆä¸º`i`çš„ä¸‹ä¸€ä¸ªæ›´å¤§å…ƒç´ ï¼‰ï¼Œæ ˆé¡¶å°±æ˜¯`nxt[i]`ã€‚  
- `f[i]`æ˜¯`S_i`çš„å¤§å°ï¼š`i`è‡ªå·±æ˜¯ä¸€ä¸ªå…ƒç´ ï¼ŒåŠ ä¸Š`nxt[i]`çš„`S`é›†åˆçš„å¤§å°ï¼ˆå¦‚æœ`nxt[i]`åœ¨æ•°ç»„å†…ï¼‰ã€‚


### é¢˜è§£äºŒæ ¸å¿ƒç‰‡æ®µèµæï¼ˆæ¥æºï¼šDaiRuiChen007ï¼‰
**äº®ç‚¹**ï¼šç”¨å•è°ƒæ ˆè®¡ç®—åŒºé—´æœ€å°å€¼å’Œï¼Œä»£ç ç®€æ´ã€‚

```cpp
// è®¡ç®—Læ•°ç»„ï¼ˆflï¼‰
top = 0;
stk[top] = 0;
int sum = 0;
for (int i = 1; i < n; ++i) {
    while (top && s[stk[top]] > s[i]) {
        sum = (sum - 1LL * (s[stk[top]] - 1) * (stk[top] - stk[top - 1]) % MOD + MOD) % MOD;
        --top;
    }
    sum = (sum + 1LL * (s[i] - 1) * (i - stk[top]) % MOD) % MOD;
    stk[++top] = i;
    fl[i+1] = (fl[i] + sum) % MOD;
}
```

**ä»£ç è§£è¯»**ï¼š  
- `s[i]`æ˜¯`f[i]`ï¼ˆ`S_i`çš„å¤§å°ï¼‰ï¼Œ`sum`ç»´æŠ¤ã€Œä»¥`i`ä¸ºå³ç«¯ç‚¹çš„æ‰€æœ‰åŒºé—´çš„æœ€å°å€¼çš„å’Œã€ã€‚  
- å¼¹å‡ºæ ˆä¸­æ¯”`s[i]-1`å¤§çš„å…ƒç´ ï¼ˆè¿™äº›å…ƒç´ æ— æ³•å†ä½œä¸ºæœ€å°å€¼ï¼‰ï¼Œå‡å»å®ƒä»¬çš„è´¡çŒ®ï¼›ç„¶ååŠ ä¸Š`s[i]-1`çš„è´¡çŒ®ï¼ˆä½œä¸ºæœ€å°å€¼çš„æ‰€æœ‰åŒºé—´çš„æ•°é‡æ˜¯`i - stk[top]`ï¼‰ã€‚  
- `fl[i+1]`è®°å½•å‰`i+1`ä¸ªå…ƒç´ çš„åŒºé—´æœ€å°å€¼å’Œã€‚


### é¢˜è§£ä¸‰æ ¸å¿ƒç‰‡æ®µèµæï¼ˆæ¥æºï¼šP2441Mï¼‰
**äº®ç‚¹**ï¼šç”¨å‰ç¼€å’Œå¿«é€Ÿè®¡ç®—`sum |S_i|`ã€‚

```cpp
// è®¡ç®—preæ•°ç»„ï¼ˆå‰ç¼€å’Œï¼‰
for (int i = 1; i <= n; ++i) pre[i] = add(pre[i - 1], sz[i] + 1);
```

**ä»£ç è§£è¯»**ï¼š  
- `sz[i]`æ˜¯å•è°ƒæ ˆçš„å¤§å°ï¼Œ`sz[i]+1`å°±æ˜¯`f[i]`ï¼ˆ`S_i`çš„å¤§å°ï¼‰ã€‚  
- `add`å‡½æ•°å¤„ç†æ¨¡è¿ç®—ï¼ˆ`(x + y) % MOD`ï¼Œé¿å…è´Ÿæ•°ï¼‰ï¼Œ`pre[i]`æ˜¯å‰`i`ä¸ª`f`çš„å’Œã€‚


## 5. ç®—æ³•å¯è§†åŒ–ï¼šåƒç´ åŠ¨ç”»æ¼”ç¤º

### åŠ¨ç”»ä¸»é¢˜ï¼šåƒç´ æ¢é™©å®¶æ•´ç†ã€Œå•è°ƒæ ˆè´§æ¶ã€
**æ ¸å¿ƒæ¼”ç¤ºå†…å®¹**ï¼šå±•ç¤º`nxt`æ•°ç»„ã€`L`æ•°ç»„çš„è®¡ç®—è¿‡ç¨‹ï¼Œä»¥åŠè¯¢é—®å¤„ç†ã€‚  
**è®¾è®¡æ€è·¯**ï¼šç”¨8ä½åƒç´ é£æ ¼ï¼Œè¥é€ å¤å¤æ¸¸æˆæ°›å›´ï¼Œé€šè¿‡åŠ¨ç”»å’ŒéŸ³æ•ˆå¼ºåŒ–è®°å¿†ã€‚


### åŠ¨ç”»å¸§æ­¥éª¤ä¸äº¤äº’å…³é”®ç‚¹
1. **åœºæ™¯åˆå§‹åŒ–**ï¼š  
   - å±å¹•æ˜¾ç¤º`n`ä¸ªåƒç´ æ–¹å—ï¼ˆæ•°ç»„`a`ï¼‰ï¼Œå³ä¾§æœ‰ä¸€ä¸ªç©ºçš„ã€Œå•è°ƒæ ˆè´§æ¶ã€ï¼ˆç«–åˆ—ï¼‰ã€‚  
   - æ§åˆ¶é¢æ¿æœ‰ã€Œå¼€å§‹/æš‚åœã€ã€Œå•æ­¥ã€ã€Œé‡ç½®ã€æŒ‰é’®ï¼Œä»¥åŠé€Ÿåº¦æ»‘å—ã€‚  
   - æ’­æ”¾8ä½é£æ ¼çš„è½»æ¾èƒŒæ™¯éŸ³ä¹ï¼ˆæ¯”å¦‚ã€Šè¶…çº§é©¬é‡Œå¥¥ã€‹çš„èƒŒæ™¯éŸ³ä¹ï¼‰ã€‚

2. **è®¡ç®—nxtæ•°ç»„**ï¼š  
   - ä»å³åˆ°å·¦éå†æ•°ç»„ï¼Œæ¯ä¸ªå…ƒç´ `i`çš„æ–¹å—é—ªçƒã€‚  
   - å¼¹å‡ºæ ˆä¸­æ¯”`a[i]`å°çš„å…ƒç´ ï¼ˆæ–¹å—å‘ä¸‹ç§»åŠ¨ï¼‰ï¼Œä¼´éšã€Œå—’ã€çš„éŸ³æ•ˆã€‚  
   - æ ˆé¡¶å…ƒç´ ï¼ˆ`nxt[i]`ï¼‰é«˜äº®ï¼Œ`f[i]`çš„æ•°å€¼æ˜¾ç¤ºåœ¨æ–¹å—ä¸‹æ–¹ï¼Œä¼´éšã€Œå®ã€çš„éŸ³æ•ˆã€‚  
   - å°†`i`å‹å…¥æ ˆï¼ˆæ–¹å—å‘ä¸Šç§»åŠ¨ï¼‰ã€‚

3. **è®¡ç®—Læ•°ç»„**ï¼š  
   - ä»å·¦åˆ°å³éå†ï¼Œæ¯ä¸ªå…ƒç´ `i`çš„æ–¹å—é—ªçƒã€‚  
   - å¼¹å‡ºæ ˆä¸­æ¯”`f[i]-1`å¤§çš„å…ƒç´ ï¼ˆæ–¹å—å‘ä¸‹ç§»åŠ¨ï¼‰ï¼Œå‡å»å®ƒä»¬çš„è´¡çŒ®ï¼ˆæ•°å€¼åŒºåŸŸå‡å°‘ï¼‰ï¼Œä¼´éšã€Œå—’ã€çš„éŸ³æ•ˆã€‚  
   - è®¡ç®—`f[i]-1`çš„è´¡çŒ®ï¼ˆæ•°å€¼åŒºåŸŸå¢åŠ ï¼‰ï¼Œä¼´éšã€Œæ»´ã€çš„éŸ³æ•ˆï¼Œå°†`i`å‹å…¥æ ˆã€‚  
   - `L[i]`çš„æ•°å€¼æ˜¾ç¤ºåœ¨å±å¹•ä¸Šæ–¹ã€‚

4. **å¤„ç†è¯¢é—®**ï¼š  
   - è¾“å…¥`l`å’Œ`r`ï¼Œæ•°ç»„ä¸­`l`åˆ°`r`çš„æ–¹å—é«˜äº®ï¼ˆæ¯”å¦‚å˜æˆé»„è‰²ï¼‰ã€‚  
   - è®¡ç®—ç»“æœæ˜¾ç¤ºåœ¨å±å¹•ä¸Šæ–¹ï¼Œä¼´éšã€Œå®~ã€çš„èƒœåˆ©éŸ³æ•ˆã€‚  
   - è‹¥ç»“æœæ­£ç¡®ï¼Œå±å¹•å¼¹å‡ºã€Œç­”å¯¹å•¦ï¼åŠ 10åˆ†ã€çš„æç¤ºã€‚


### æ¸¸æˆåŒ–å…ƒç´ 
- **å…³å¡è®¾è®¡**ï¼šå°†ã€Œè®¡ç®—nxtæ•°ç»„ã€è®¾ä¸ºã€Œç¬¬ä¸€å…³ã€ï¼Œã€Œè®¡ç®—Læ•°ç»„ã€è®¾ä¸ºã€Œç¬¬äºŒå…³ã€ï¼Œå®Œæˆå³ã€Œè¿‡å…³ã€ï¼Œæ˜¾ç¤ºã€Œé€šå…³å¥–åŠ±ï¼š+50åˆ†ã€ã€‚  
- **éŸ³æ•ˆåé¦ˆ**ï¼šå…¥æ ˆã€Œå®ã€ã€å¼¹å‡ºã€Œå—’ã€ã€è®¡ç®—è´¡çŒ®ã€Œæ»´ã€ã€ç­”å¯¹ã€Œå®~ã€ã€ç­”é”™ã€Œå—¡ã€ã€‚  
- **è‡ªåŠ¨æ¼”ç¤º**ï¼šç‚¹å‡»ã€ŒAIè‡ªåŠ¨æ’­æ”¾ã€ï¼ŒåŠ¨ç”»æŒ‰æ­¥éª¤è¿›è¡Œï¼Œé€Ÿåº¦å¯è°ƒï¼ˆæ¯”å¦‚ã€Œæ…¢ã€ã€Œä¸­ã€ã€Œå¿«ã€ä¸‰æ¡£ï¼‰ã€‚


## 6. æ‹“å±•ç»ƒä¹ ä¸ç›¸ä¼¼é—®é¢˜æ€è€ƒ

### é€šç”¨æ€è·¯è¿ç§»
æœ¬é¢˜çš„æ ¸å¿ƒæŠ€å·§ï¼ˆå•è°ƒæ ˆ+å‰ç¼€å’Œ+å®¹æ–¥ï¼‰å¯ä»¥è§£å†³ä»¥ä¸‹é—®é¢˜ï¼š
1. **ä¸‹ä¸€ä¸ªæ›´å¤§å…ƒç´ **ï¼šæ¯”å¦‚æ±‚æ¯ä¸ªå…ƒç´ å³è¾¹ç¬¬ä¸€ä¸ªæ¯”å®ƒå¤§çš„å…ƒç´ ã€‚  
2. **åŒºé—´æœ€å€¼å’Œ**ï¼šæ¯”å¦‚è®¡ç®—æ‰€æœ‰åŒºé—´çš„æœ€å°å€¼æˆ–æœ€å¤§å€¼çš„å’Œã€‚  
3. **é›†åˆè¿ç®—**ï¼šæ¯”å¦‚ç”¨å®¹æ–¥ç®€åŒ–å¤æ‚çš„é›†åˆé—®é¢˜ã€‚


### æ´›è°·ç»ƒä¹ æ¨è
1. **P5788 ã€æ¨¡æ¿ã€‘å•è°ƒæ ˆ**ï¼šç»ƒä¹ ã€Œä¸‹ä¸€ä¸ªæ›´å¤§å…ƒç´ ã€ï¼ŒæŒæ¡å•è°ƒæ ˆçš„åŸºæœ¬ç”¨æ³•ã€‚  
2. **P1856 åŒºé—´æœ€å°å€¼**ï¼šè®¡ç®—æ‰€æœ‰åŒºé—´çš„æœ€å°å€¼çš„å’Œï¼Œå’Œæœ¬é¢˜çš„`L`æ•°ç»„è®¡ç®—å®Œå…¨ä¸€è‡´ã€‚  
3. **P2032 æ‰«æ**ï¼šç”¨å•è°ƒæ ˆå¤„ç†åŒºé—´é—®é¢˜ï¼Œç»ƒä¹ ç»´æŠ¤ã€Œå•è°ƒé€’å¢çš„åŒºé—´ã€ã€‚


## 7. å­¦ä¹ å¿ƒå¾—ä¸ç»éªŒåˆ†äº«

**å‚è€ƒç»éªŒï¼ˆæ¥è‡ªZnPdCoï¼‰**ï¼š  
ã€Œåœ¨å¤„ç†å¤§æ•°æ®é‡æ—¶ï¼Œå¿«é€ŸIOå¾ˆé‡è¦ï¼æœ¬é¢˜ä¸­ç”¨`ios::sync_with_stdio(false)`å’Œ`cin.tie(nullptr)`åŠ é€Ÿè¾“å…¥è¾“å‡ºï¼Œé¿å…è¶…æ—¶ã€‚ã€

**Kayçš„ç‚¹è¯„**ï¼š  
å¯¹äº`n,qâ‰¤1e7`çš„é¢˜ç›®ï¼Œè¾“å…¥è¾“å‡ºçš„é€Ÿåº¦ç›´æ¥å†³å®šèƒ½å¦é€šè¿‡ã€‚å¿«é€ŸIOèƒ½è·³è¿‡C++çš„æ ‡å‡†æµåŒæ­¥ï¼Œå¤§å¹…æå‡é€Ÿåº¦ã€‚æ­¤å¤–ï¼Œå•è°ƒæ ˆçš„çµæ´»è¿ç”¨æ˜¯è§£å†³æœ¬é¢˜çš„å…³é”®â€”â€”å¤šç»ƒä¹ ç±»ä¼¼é—®é¢˜ï¼Œæ‰èƒ½ç†Ÿç»ƒæŒæ¡ï¼


## ğŸ’ª ç»“è¯­
æœ¬æ¬¡åˆ†æäº†ã€Œæ¶ˆç­åŠ³å—ã€é¢˜ï¼Œé‡ç‚¹æ˜¯**å•è°ƒæ ˆ**å’Œ**å‰ç¼€å’Œ**çš„åº”ç”¨ï¼Œä»¥åŠ**å®¹æ–¥ç®€åŒ–é—®é¢˜**çš„æ€è·¯ã€‚å¸Œæœ›è¿™ä»½æŒ‡å—èƒ½å¸®åŠ©ä½ ç†è§£æ ¸å¿ƒé€»è¾‘ï¼ŒæŒæ¡è§£é¢˜æŠ€å·§ã€‚  

è®°ä½ï¼šç¼–ç¨‹èƒ½åŠ›çš„æå‡ï¼Œåœ¨äº**è§‚å¯Ÿé—®é¢˜â†’è½¬åŒ–æ¨¡å‹â†’ç”¨æŠ€å·§è§£å†³**çš„è¿‡ç¨‹ã€‚å¤šæ€è€ƒã€å¤šç»ƒä¹ ï¼Œä½ ä¼šè¶Šæ¥è¶Šå‰å®³ï¼ä¸‹æ¬¡æˆ‘ä»¬å†ä¸€èµ·æ¢ç´¢æ–°çš„æŒ‘æˆ˜~ ğŸš€

---
å¤„ç†ç”¨æ—¶ï¼š204.83ç§’
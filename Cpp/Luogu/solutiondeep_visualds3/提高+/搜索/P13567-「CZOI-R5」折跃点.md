# é¢˜ç›®ä¿¡æ¯

# ã€ŒCZOI-R5ã€æŠ˜è·ƒç‚¹

## é¢˜ç›®èƒŒæ™¯

å®‡å®™ä¸­çˆ†å‘äº†æ˜Ÿé™…æˆ˜äº‰ã€‚

## é¢˜ç›®æè¿°

ä¸ºäº†åœ¨æ˜Ÿé™…æˆ˜äº‰ä¸­è¿›è¡Œç¬é—´ç§»åŠ¨ï¼Œæˆ‘æ–¹å·²ç»åœ¨å é¢†çš„æ˜ŸåŸŸä¸­å»ºç«‹äº† $n$ ä¸ªæŠ˜è·ƒç‚¹ã€‚æ‰€æœ‰æŠ˜è·ƒç‚¹æ„æˆä¸€æ£µä»¥æŠ˜è·ƒç‚¹ $1$ ä¸ºæ ¹çš„æœ‰æ ¹æ ‘ã€‚ç¬¬ $i$ ä¸ªæŠ˜è·ƒç‚¹çš„èƒ½é‡å€¼ä¸º $a_i$ã€‚

æˆ‘ä»¬ç§°æŠ˜è·ƒç‚¹ $u$ ç»è¿‡ $x$ æ¬¡è¿ç»­æŠ˜è·ƒèƒ½åˆ°è¾¾æŠ˜è·ƒç‚¹ $v$ï¼Œå½“ä¸”ä»…å½“ä»æŠ˜è·ƒç‚¹ $u$ å‡ºå‘ï¼Œèµ°è¿‡ $x$ æ¡è¾¹åèƒ½åˆ°è¾¾æŠ˜è·ƒç‚¹ $v$ï¼Œä¸”è¿‡ç¨‹ä¸­ä¸æŠ˜è·ƒç‚¹ $1$ çš„è·ç¦»ä¸æ–­å¢åŠ æˆ–ä¸æ–­å‡å°‘ã€‚

ç°åœ¨è¦è¿›è¡Œ $m$ æ¬¡ä»¥ä¸‹ç»´æŠ¤æ“ä½œï¼š
1. **ç©ºé—´èƒ½é‡å¢å¼º**ï¼šå¯¹äºæ‰€æœ‰ä»æŠ˜è·ƒç‚¹ $u$ ç»è¿‡ $x$ æ¬¡è¿ç»­æŠ˜è·ƒèƒ½åˆ°è¾¾çš„æŠ˜è·ƒç‚¹ï¼Œå°†å…¶èƒ½é‡å€¼åŠ  $y$ã€‚
2. **æŠ˜è·ƒæµ‹è¯•**ï¼šæ±‚æ‰€æœ‰ä»æŠ˜è·ƒç‚¹ $u$ ç»è¿‡ $x$ æ¬¡è¿ç»­æŠ˜è·ƒèƒ½åˆ°è¾¾çš„æŠ˜è·ƒç‚¹ï¼Œèƒ½é‡å€¼çš„å’Œã€‚

## è¯´æ˜/æç¤º

**ã€æ ·ä¾‹è§£é‡Šã€‘**

![](https://cdn.luogu.com.cn/upload/image_hosting/3lcng3xo.png)

è¿™æ£µæ ‘å¦‚å›¾ã€‚

ç¬¬ä¸€æ¬¡æ“ä½œæ»¡è¶³æ¡ä»¶çš„æŠ˜è·ƒç‚¹ä¸ºæŠ˜è·ƒç‚¹ $3,5$ï¼Œæ“ä½œå $a=\{6,8,11,10,13\}$ã€‚

ç¬¬äºŒæ¬¡æ“ä½œæ»¡è¶³æ¡ä»¶çš„æŠ˜è·ƒç‚¹ä¸ºæŠ˜è·ƒç‚¹ $1,5$ï¼Œç­”æ¡ˆä¸º $6+13=19$ã€‚

ç¬¬ä¸‰æ¬¡æ“ä½œæ»¡è¶³æ¡ä»¶çš„æŠ˜è·ƒç‚¹ä¸ºæŠ˜è·ƒç‚¹ $2$ï¼Œç­”æ¡ˆä¸º $8$ã€‚

ç¬¬å››æ¬¡æ“ä½œæ»¡è¶³æ¡ä»¶çš„æŠ˜è·ƒç‚¹ä¸ºæŠ˜è·ƒç‚¹ $1,3$ï¼Œæ“ä½œå $a=\{10,8,15,10,13\}$ã€‚

ç¬¬äº”æ¬¡æ“ä½œæ»¡è¶³æ¡ä»¶çš„æŠ˜è·ƒç‚¹ä¸ºæŠ˜è·ƒç‚¹ $3,5$ï¼Œç­”æ¡ˆä¸º $15+13=28$ã€‚

**ã€æ•°æ®èŒƒå›´ã€‘**

**æœ¬é¢˜é‡‡ç”¨æ†ç»‘æµ‹è¯•**ã€‚

- Subtask #1ï¼ˆ$15\text{ pts}$ï¼‰ï¼š$n, m \le 10^3$ã€‚
- Subtask #2ï¼ˆ$15\text{ pts}$ï¼‰ï¼š$x \le 1$ã€‚
- Subtask #3ï¼ˆ$25\text{ pts}$ï¼‰ï¼š$x \le 50$ã€‚
- Subtask #4ï¼ˆ$45\text{ pts}$ï¼‰ï¼šæ— ç‰¹æ®Šé™åˆ¶ã€‚

å¯¹äº $100\%$ çš„æ•°æ®ï¼Œ$1\le u\le n\le3\times10^5$ï¼Œ$1 \le  m \le 3 \times 10^5$ï¼Œ$1 \le a_i, y \le 10^9$ï¼Œ$0 \le x \le n$ï¼Œ$p\in\{1,2\}$ã€‚


## æ ·ä¾‹ #1

### è¾“å…¥

```
5 5
6 8 4 10 6 
2 1
3 2
4 1
5 4
1 1 2 7
2 4 1
2 2 0
1 2 1 4
2 1 2
```

### è¾“å‡º

```
19
8
28
```

# AIåˆ†æç»“æœ

# ğŸ’¡ Kayçš„C++ç®—æ³•è§£æï¼šã€ŒCZOI-R5ã€æŠ˜è·ƒç‚¹ æ·±å…¥å­¦ä¹ æŒ‡å— ğŸ’¡


## 1. é¢˜ç›®è§£è¯»ä¸æ ¸å¿ƒç®—æ³•è¯†åˆ«

âœ¨ **æœ¬é¢˜ä¸»è¦è€ƒå¯Ÿ**ï¼šç¼–ç¨‹æŠ€å·§åº”ç”¨ï¼ˆæ ‘çš„æ·±åº¦å¤„ç†ä¸çº¿æ®µæ ‘ç»“åˆï¼‰


### åˆæ­¥åˆ†æ
è§£å†³ã€ŒæŠ˜è·ƒç‚¹ã€çš„å…³é”®ï¼Œå°±åƒåœ¨**æ—è°±é‡Œæ‰¾äº²æˆš**â€”â€”æŠ˜è·ƒèƒ½åˆ°è¾¾çš„ç‚¹åªæœ‰ä¸¤ç§ï¼š  
1. **å¾€ä¸Šæ‰¾é•¿è¾ˆ**ï¼š`u`çš„`x`çº§ç¥–å…ˆï¼ˆæ¯”å¦‚ä½ å¾€ä¸Šæ•°3ä»£çš„çˆ·çˆ·ï¼‰ï¼›  
2. **å¾€ä¸‹æ‰¾æ™šè¾ˆ**ï¼š`u`å­æ ‘å†…æ·±åº¦æ°å¥½æ¯”`u`å¤§`x`çš„æ‰€æœ‰èŠ‚ç‚¹ï¼ˆæ¯”å¦‚ä½ æ‰€æœ‰å¾€ä¸‹3ä»£çš„æ›¾å­™ï¼‰ã€‚  

è¦å¿«é€Ÿå¤„ç†è¿™ä¸¤ç±»ç‚¹çš„ã€ŒåŠ å€¼ã€å’Œã€Œæ±‚å’Œã€æ“ä½œï¼Œæˆ‘ä»¬éœ€è¦ä¸¤ä¸ªæŠ€å·§ï¼š  
- **å€å¢æ³•æ‰¾ç¥–å…ˆ**ï¼šåƒçˆ¬æ¥¼æ¢¯ä¸€æ ·ï¼Œæ¯æ¬¡è·³2çš„å¹‚æ¬¡æ­¥ï¼Œå¿«é€Ÿå®šä½`x`çº§ç¥–å…ˆï¼ˆæ¯”å¦‚è·³8æ­¥+4æ­¥=12æ­¥ï¼‰ï¼›  
- **çº¿æ®µæ ‘ç»´æŠ¤åŒæ·±åº¦åŒºé—´**ï¼šæŠŠåŒä¸€æ·±åº¦çš„èŠ‚ç‚¹æŒ‰DFSåºæ’æˆè¿ç»­çš„ã€Œé˜Ÿä¼ã€ï¼Œè¿™æ ·å­æ ‘å†…çš„æ™šè¾ˆå°±æ˜¯é˜Ÿä¼ä¸­çš„ä¸€ä¸ªè¿ç»­åŒºé—´ï¼ˆæ¯”å¦‚æ‰€æœ‰æ›¾å­™åœ¨é˜Ÿä¼é‡Œæ˜¯è¿ç»­çš„å‡ ä¸ªäººï¼‰ï¼Œç”¨çº¿æ®µæ ‘åšåŒºé—´åŠ /æŸ¥ã€‚  


### æ ¸å¿ƒéš¾ç‚¹ä¸è§£å†³
- **éš¾ç‚¹1**ï¼šå¦‚ä½•æŠŠã€Œå­æ ‘å†…æ·±`x`çš„ç‚¹ã€è½¬åŒ–ä¸ºçº¿æ®µæ ‘çš„åŒºé—´ï¼Ÿ  
  è§£å†³ï¼šé¢„å¤„ç†æ¯ä¸ªæ·±åº¦çš„èŠ‚ç‚¹çš„DFSåºï¼Œåˆ©ç”¨DFSåºçš„**è¿ç»­æ€§**ï¼ˆå­æ ‘å†…çš„èŠ‚ç‚¹DFSåºè¿ç»­ï¼‰ï¼Œç”¨äºŒåˆ†æ³•æ‰¾åˆ°åŒºé—´è¾¹ç•Œã€‚  
- **éš¾ç‚¹2**ï¼šå¦‚ä½•å¿«é€Ÿæ‰¾`x`çº§ç¥–å…ˆï¼Ÿ  
  è§£å†³ï¼šé¢„å¤„ç†æ¯ä¸ªèŠ‚ç‚¹çš„2^kçº§ç¥–å…ˆï¼ˆæ¯”å¦‚`fa[u][k]`æ˜¯`u`çš„2^kçº§ç¥–å…ˆï¼‰ï¼Œç”¨å€å¢æ³•è·³`x`æ­¥ã€‚  


### å¯è§†åŒ–è®¾è®¡æ€è·¯
æˆ‘ä»¬è®¾è®¡ä¸€ä¸ª**å¤å¤åƒç´ æ¸¸æˆ**ï¼š  
- æ ‘ç”¨åƒç´ å—å †å æˆã€Œæ—è°±æ ‘ã€ï¼ŒèŠ‚ç‚¹æ˜¯å½©è‰²å°æ–¹å—ï¼ˆæ¯”å¦‚çº¢è‰²ä»£è¡¨`u`ï¼Œè“è‰²ä»£è¡¨ç¥–å…ˆï¼Œç»¿è‰²ä»£è¡¨æ™šè¾ˆï¼‰ï¼›  
- æ‰¾ç¥–å…ˆæ—¶ï¼ŒèŠ‚ç‚¹ä¼šã€Œå‘ä¸Šè·³ã€`x`æ­¥ï¼Œæ¯è·³ä¸€æ­¥é—ªçƒå¹¶ä¼´éšã€Œå®ã€çš„åƒç´ éŸ³æ•ˆï¼›  
- å­æ ‘å†…çš„åŒºé—´ç”¨**é»„è‰²é«˜äº®**ï¼Œçº¿æ®µæ ‘åŠ å€¼æ—¶ï¼Œé«˜äº®åŒºåŸŸçš„æ–¹å—ä¼šã€Œå˜äº®ã€ï¼ˆé¢œè‰²åŠ æ·±ï¼‰ï¼Œæ±‚å’Œæ—¶æ˜¾ç¤ºæ€»å’Œï¼›  
- æ§åˆ¶é¢æ¿æœ‰ã€Œå•æ­¥æ‰§è¡Œã€ã€Œè‡ªåŠ¨æ’­æ”¾ã€ï¼ˆåƒè´ªåƒè›‡AIä¸€æ ·è·‘æµç¨‹ï¼‰ã€ã€Œé‡ç½®ã€æŒ‰é’®ï¼Œè¿˜æœ‰é€Ÿåº¦æ»‘å—ï¼ˆä»ã€Œæ…¢åŠ¨ä½œã€åˆ°ã€Œé—ªç”µå¿«ã€ï¼‰ã€‚  


## 2. ç²¾é€‰ä¼˜è´¨é¢˜è§£å‚è€ƒ


### é¢˜è§£ä¸€ï¼šï¼ˆæ¥æºï¼š_H17_ï¼‰
* **ç‚¹è¯„**ï¼šæ­¤é¢˜è§£æ˜¯ã€Œæ ‡å‡†æ¨¡æ¿çº§ã€å®ç°ï¼Œæ€è·¯**ç›´ç™½åˆ°åƒè¯´æ˜ä¹¦**â€”â€”å…ˆDFSé¢„å¤„ç†æ·±åº¦å’ŒDFSåºï¼ŒæŠŠåŒæ·±åº¦çš„èŠ‚ç‚¹æŒ‰DFSåºæ’åºï¼Œç”¨çº¿æ®µæ ‘ç»´æŠ¤è¿™äº›èŠ‚ç‚¹çš„æƒå€¼ã€‚æ‰¾ç¥–å…ˆç”¨å€å¢æ³•ï¼Œå­æ ‘åŒºé—´ç”¨äºŒåˆ†æ‰¾è¾¹ç•Œã€‚ä»£ç è§„èŒƒï¼ˆå˜é‡å`dfn`ã€Œdepã€æ¸…æ™°ï¼‰ï¼Œè¾¹ç•Œå¤„ç†åˆ°ä½ï¼ˆæ¯”å¦‚`x=0`çš„ç‰¹åˆ¤ï¼‰ï¼Œæ—¶é—´å¤æ‚åº¦`O(n log n)`ï¼Œæ˜¯åˆå­¦è€…çš„ã€Œå®Œç¾å‚è€ƒã€ã€‚


### é¢˜è§£äºŒï¼šï¼ˆæ¥æºï¼šWater__Problemï¼‰
* **ç‚¹è¯„**ï¼šæ­¤é¢˜è§£ç”¨äº†**åŠ¨æ€å¼€ç‚¹çº¿æ®µæ ‘**ï¼ˆæ¯å±‚æ·±åº¦å»ºä¸€æ£µçº¿æ®µæ ‘ï¼‰ï¼Œå®Œç¾è§£å†³äº†ã€ŒåŒæ·±åº¦èŠ‚ç‚¹åˆ†æ•£ã€çš„é—®é¢˜ã€‚ä»£ç æŠŠã€Œæ‰¾ç¥–å…ˆã€å’Œã€Œæ‰¾æ™šè¾ˆã€æ‹†åˆ†æˆä¸¤ä¸ªç‹¬ç«‹æ“ä½œï¼Œé€»è¾‘æ¸…æ™°ã€‚è™½ç„¶åŠ¨æ€å¼€ç‚¹çš„å¸¸æ•°ç•¥å¤§ï¼Œä½†æ€è·¯æ–°é¢–ï¼Œé€‚åˆæƒ³å­¦ä¹ ã€Œç©ºé—´ä¼˜åŒ–ã€çš„åŒå­¦ã€‚


### é¢˜è§£ä¸‰ï¼šï¼ˆæ¥æºï¼šlilongï¼‰
* **ç‚¹è¯„**ï¼šæ­¤é¢˜è§£ç”¨äº†ç±»ä¼¼çš„DFSåºé¢„å¤„ç†ï¼Œä½†åœ¨æ’åºåŒæ·±åº¦èŠ‚ç‚¹æ—¶æ›´ç®€æ´ã€‚ä»£ç ä¸­çš„`H`æ•°ç»„è®°å½•æ¯ä¸ªæ·±åº¦çš„DFSåºï¼Œç„¶åæ’åºå¾—åˆ°è¿ç»­åŒºé—´ã€‚æ€è·¯æ­£ç¡®ï¼Œä»£ç å¯è¯»æ€§ä¸é”™ï¼Œå”¯ä¸€å°ç¼ºç‚¹æ˜¯äºŒåˆ†è¾¹ç•Œçš„å¤„ç†ç•¥ç²—ç³™ï¼Œä½†æ•´ä½“å€¼å¾—å­¦ä¹ ã€‚


## 3. æ ¸å¿ƒéš¾ç‚¹è¾¨æä¸è§£é¢˜ç­–ç•¥


### å…³é”®ç‚¹1ï¼šå¦‚ä½•å°†ã€Œå­æ ‘å†…æ·±`x`çš„ç‚¹ã€è½¬åŒ–ä¸ºçº¿æ®µæ ‘åŒºé—´ï¼Ÿ
- **åˆ†æ**ï¼šåŒä¸€æ·±åº¦çš„èŠ‚ç‚¹æŒ‰DFSåºæ’åˆ—æ—¶ï¼Œå­æ ‘å†…çš„èŠ‚ç‚¹çš„DFSåºä¸€å®š**è¿ç»­**ï¼ˆæ¯”å¦‚`u`çš„å­æ ‘DFSåºæ˜¯`[dfn[u], dfn[u]+siz[u]-1]`ï¼‰ã€‚åˆ©ç”¨è¿™ä¸€æ€§è´¨ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨äºŒåˆ†æ³•åœ¨ã€ŒåŒæ·±åº¦çš„DFSåºåˆ—è¡¨ã€ä¸­æ‰¾åˆ°`u`å­æ ‘çš„åŒºé—´è¾¹ç•Œã€‚  
- **æŠ€å·§**ï¼šé¢„å¤„ç†æ¯ä¸ªæ·±åº¦çš„DFSåºåˆ—è¡¨ï¼ˆæ¯”å¦‚`H[dep]`å­˜æ‰€æœ‰æ·±åº¦ä¸º`dep`çš„èŠ‚ç‚¹çš„DFSåºï¼‰ï¼Œç„¶åå¯¹`H[dep[u]+x]`äºŒåˆ†æ‰¾`>=dfn[u]`çš„æœ€å°ä½ç½®å’Œ`<=dfn[u]+siz[u]-1`çš„æœ€å¤§ä½ç½®ã€‚


### å…³é”®ç‚¹2ï¼šå¦‚ä½•å¿«é€Ÿæ‰¾`x`çº§ç¥–å…ˆï¼Ÿ
- **åˆ†æ**ï¼šç›´æ¥å¾€ä¸Šè·³`x`æ­¥ä¼šè¶…æ—¶ï¼ˆ`O(x)`ï¼‰ï¼Œç”¨**å€å¢æ³•**é¢„å¤„ç†æ¯ä¸ªèŠ‚ç‚¹çš„`2^k`çº§ç¥–å…ˆï¼ˆæ¯”å¦‚`fa[u][k]`æ˜¯`u`çš„`2^k`çº§ç¥–å…ˆï¼‰ï¼Œè¿™æ ·è·³`x`æ­¥åªéœ€`O(log x)`æ—¶é—´ï¼ˆæ¯”å¦‚`x=12`=8+4ï¼Œè·³ä¸¤æ¬¡ï¼‰ã€‚  
- **æŠ€å·§**ï¼šé¢„å¤„ç†`fa`æ•°ç»„ï¼ˆ`fa[u][0]`æ˜¯çˆ¶èŠ‚ç‚¹ï¼Œ`fa[u][k] = fa[fa[u][k-1]][k-1]`ï¼‰ï¼Œç„¶åä»é«˜ä½åˆ°ä½ä½æšä¸¾`k`ï¼Œè·³å¯¹åº”çš„æ­¥æ•°ã€‚


### å…³é”®ç‚¹3ï¼šå¦‚ä½•å¤„ç†`x=0`çš„è¾¹ç•Œæƒ…å†µï¼Ÿ
- **åˆ†æ**ï¼šå½“`x=0`æ—¶ï¼ŒæŠ˜è·ƒåªèƒ½åˆ°è¾¾`u`è‡ªå·±ï¼Œæ­¤æ—¶ä¸éœ€è¦æ‰¾ç¥–å…ˆæˆ–æ™šè¾ˆï¼Œç›´æ¥å¯¹`u`è¿›è¡Œå•ç‚¹æ“ä½œã€‚  
- **æŠ€å·§**ï¼šåœ¨ä»£ç ä¸­ä¼˜å…ˆåˆ¤æ–­`x==0`ï¼Œç›´æ¥å¤„ç†`u`çš„å•ç‚¹åŠ /æŸ¥ï¼Œé¿å…åç»­é€»è¾‘å‡ºé”™ã€‚


### âœ¨ è§£é¢˜æŠ€å·§æ€»ç»“
1. **æ ‘çš„DFSåºé­”æ³•**ï¼šå­æ ‘çš„DFSåºè¿ç»­ï¼ŒåŒæ·±åº¦çš„DFSåºæ’åºåå¯äºŒåˆ†æ‰¾åŒºé—´ï¼›  
2. **å€å¢æ³•çš„åŠ›é‡**ï¼šé¢„å¤„ç†`2^k`çº§ç¥–å…ˆï¼Œå¿«é€Ÿå®šä½ä»»æ„çº§ç¥–å…ˆï¼›  
3. **çº¿æ®µæ ‘çš„åŒºé—´ç»Ÿæ²»**ï¼šæŠŠåˆ†æ•£çš„ç‚¹æ˜ å°„åˆ°è¿ç»­åŒºé—´ï¼Œç”¨çº¿æ®µæ ‘é«˜æ•ˆå¤„ç†åŠ /æŸ¥ã€‚


## 4. C++æ ¸å¿ƒä»£ç å®ç°èµæ


### æœ¬é¢˜é€šç”¨æ ¸å¿ƒC++å®ç°å‚è€ƒ
* **è¯´æ˜**ï¼šæœ¬ä»£ç ç»¼åˆäº†ä¼˜è´¨é¢˜è§£çš„æ€è·¯ï¼Œå®ç°äº†ã€Œå€å¢æ‰¾ç¥–å…ˆ+çº¿æ®µæ ‘ç»´æŠ¤åŒæ·±åº¦åŒºé—´ã€çš„æ ¸å¿ƒé€»è¾‘ï¼Œæ˜¯æœ€ç®€æ´çš„å®Œæ•´å®ç°ã€‚

```cpp
#include <iostream>
#include <vector>
#include <algorithm>
using namespace std;

typedef long long ll;
const int N = 3e5 + 10, LOG = 20;

int n, m;
ll a[N];
vector<int> e[N];

// æ ‘çš„é¢„å¤„ç†
int dep[N], dfn[N], lstdfn[N], tot_dfn;
int fa[N][LOG];
vector<int> H[N]; // H[dep] å­˜è¯¥æ·±åº¦æ‰€æœ‰èŠ‚ç‚¹çš„DFSåº
int pos[N], pla[N]; // posæ˜¯æ’åºåçš„èŠ‚ç‚¹ï¼Œpla[pos[i]] = i
ll seg[N << 2], tag[N << 2];

// DFSé¢„å¤„ç†æ·±åº¦ã€DFSåº
void dfs(int u, int f) {
    dep[u] = dep[f] + 1;
    fa[u][0] = f;
    for (int k = 1; k < LOG; k++)
        fa[u][k] = fa[fa[u][k-1]][k-1];
    dfn[u] = ++tot_dfn;
    H[dep[u]].push_back(dfn[u]);
    for (int v : e[u]) {
        if (v == f) continue;
        dfs(v, u);
    }
    lstdfn[u] = tot_dfn;
}

// çº¿æ®µæ ‘æ¨¡æ¿
void pushup(int cur) { seg[cur] = seg[cur<<1] + seg[cur<<1|1]; }
void pushdown(int cur, int l, int r) {
    if (tag[cur]) {
        int mid = (l + r) >> 1;
        seg[cur<<1] += tag[cur] * (mid - l + 1);
        seg[cur<<1|1] += tag[cur] * (r - mid);
        tag[cur<<1] += tag[cur];
        tag[cur<<1|1] += tag[cur];
        tag[cur] = 0;
    }
}
void build(int cur, int l, int r) {
    if (l == r) { seg[cur] = a[pos[l]]; return; }
    int mid = (l + r) >> 1;
    build(cur<<1, l, mid);
    build(cur<<1|1, mid+1, r);
    pushup(cur);
}
void update(int cur, int l, int r, int L, int R, ll val) {
    if (L <= l && r <= R) {
        seg[cur] += val * (r - l + 1);
        tag[cur] += val;
        return;
    }
    pushdown(cur, l, r);
    int mid = (l + r) >> 1;
    if (L <= mid) update(cur<<1, l, mid, L, R, val);
    if (R > mid) update(cur<<1|1, mid+1, r, L, R, val);
    pushup(cur);
}
ll query(int cur, int l, int r, int L, int R) {
    if (L <= l && r <= R) return seg[cur];
    pushdown(cur, l, r);
    int mid = (l + r) >> 1;
    ll res = 0;
    if (L <= mid) res += query(cur<<1, l, mid, L, R);
    if (R > mid) res += query(cur<<1|1, mid+1, r, L, R);
    return res;
}

// æ‰¾xçº§ç¥–å…ˆ
int get_fa(int u, int x) {
    for (int k = LOG-1; k >= 0; k--)
        if (x >= (1 << k)) {
            u = fa[u][k];
            x -= (1 << k);
        }
    return u;
}

int main() {
    ios::sync_with_stdio(false);
    cin.tie(0);

    cin >> n >> m;
    for (int i = 1; i <= n; i++) cin >> a[i];
    for (int i = 1; i < n; i++) {
        int u, v;
        cin >> u >> v;
        e[u].push_back(v);
        e[v].push_back(u);
    }

    // é¢„å¤„ç†
    dfs(1, 0);
    for (int i = 1; i <= n; i++) pos[i] = i;
    sort(pos + 1, pos + n + 1, [&](int x, int y) {
        return dep[x] != dep[y] ? dep[x] < dep[y] : dfn[x] < dfn[y];
    });
    for (int i = 1; i <= n; i++) pla[pos[i]] = i;
    build(1, 1, n);

    // å¤„ç†æ“ä½œ
    while (m--) {
        int op, u, x;
        cin >> op >> u >> x;
        ll val = 0;
        int fath = get_fa(u, x);
        int L = -1, R = -1;

        // æ‰¾å­æ ‘å†…çš„åŒºé—´
        int target_dep = dep[u] + x;
        if (target_dep <= n && !H[target_dep].empty()) {
            auto &vec = H[target_dep];
            L = lower_bound(vec.begin(), vec.end(), dfn[u]) - vec.begin() + 1;
            R = upper_bound(vec.begin(), vec.end(), lstdfn[u]) - vec.begin();
            // æ˜ å°„åˆ°çº¿æ®µæ ‘çš„posæ•°ç»„
            L = pla[vec[L-1]];
            R = pla[vec[R-1]];
        }

        if (op == 1) {
            cin >> val;
            // å¤„ç†ç¥–å…ˆ
            if (fath) update(1, 1, n, pla[fath], pla[fath], val);
            // å¤„ç†å­æ ‘åŒºé—´
            if (L != -1 && R != -1) update(1, 1, n, L, R, val);
        } else {
            // æŸ¥è¯¢ç¥–å…ˆ
            if (fath) val += query(1, 1, n, pla[fath], pla[fath]);
            // æŸ¥è¯¢å­æ ‘åŒºé—´
            if (L != -1 && R != -1) val += query(1, 1, n, L, R);
            cout << val << '\n';
        }
    }

    return 0;
}
```

* **ä»£ç è§£è¯»æ¦‚è¦**ï¼š  
  1. **é¢„å¤„ç†**ï¼šDFSéå†æ ‘ï¼Œè®°å½•æ¯ä¸ªèŠ‚ç‚¹çš„æ·±åº¦`dep`ã€DFSåº`dfn`ã€ç¥–å…ˆ`fa`æ•°ç»„ï¼›  
  2. **æ’åºåŒæ·±åº¦èŠ‚ç‚¹**ï¼šæŠŠèŠ‚ç‚¹æŒ‰ã€Œæ·±åº¦ä»å°åˆ°å¤§ã€DFSåºä»å°åˆ°å¤§ã€æ’åºï¼Œå¾—åˆ°`pos`æ•°ç»„ï¼ˆåŒæ·±åº¦çš„èŠ‚ç‚¹è¿ç»­ï¼‰ï¼›  
  3. **çº¿æ®µæ ‘æ„å»º**ï¼šç”¨`pos`æ•°ç»„æ„å»ºçº¿æ®µæ ‘ï¼Œç»´æŠ¤èŠ‚ç‚¹çš„æƒå€¼ï¼›  
  4. **å¤„ç†æ“ä½œ**ï¼š  
     - æ‰¾`x`çº§ç¥–å…ˆï¼šç”¨`get_fa`å‡½æ•°ï¼›  
     - æ‰¾å­æ ‘å†…çš„åŒºé—´ï¼šç”¨`H[target_dep]`çš„äºŒåˆ†æ‰¾åˆ°DFSåºè¾¹ç•Œï¼Œæ˜ å°„åˆ°çº¿æ®µæ ‘çš„`pos`ç´¢å¼•ï¼›  
     - çº¿æ®µæ ‘åŠ /æŸ¥ï¼šå¯¹ç¥–å…ˆï¼ˆå•ç‚¹ï¼‰å’Œå­æ ‘åŒºé—´ï¼ˆåŒºé—´ï¼‰è¿›è¡Œæ“ä½œã€‚


### é¢˜è§£ä¸€æ ¸å¿ƒä»£ç ç‰‡æ®µèµæ
* **äº®ç‚¹**ï¼šç”¨`pos`æ•°ç»„æ’åºåŒæ·±åº¦èŠ‚ç‚¹ï¼Œå®Œç¾å®ç°ã€ŒåŒæ·±åº¦è¿ç»­åŒºé—´ã€ã€‚  
* **æ ¸å¿ƒä»£ç ç‰‡æ®µ**ï¼š
  ```cpp
  // æ’åºposæ•°ç»„ï¼šæŒ‰æ·±åº¦ä»å°åˆ°å¤§ï¼ŒåŒæ·±åº¦æŒ‰DFSåºä»å°åˆ°å¤§
  sort(pos + 1, pos + n + 1, [&](int x, int y) {
      return dep[x] != dep[y] ? dep[x] < dep[y] : dfn[x] < dfn[y];
  });
  // æ„å»ºçº¿æ®µæ ‘
  build(1, 1, n);
  ```
* **ä»£ç è§£è¯»**ï¼š  
  è¿™æ®µä»£ç æ˜¯ã€ŒåŒæ·±åº¦åŒºé—´ã€çš„å…³é”®ï¼`pos`æ•°ç»„æ’åºåï¼ŒåŒä¸€æ·±åº¦çš„èŠ‚ç‚¹ä¼šè¿ç»­æ’åˆ—ï¼Œæ¯”å¦‚æ·±åº¦ä¸º3çš„èŠ‚ç‚¹ä¼šé›†ä¸­åœ¨`pos`çš„æŸä¸€æ®µã€‚è¿™æ ·çº¿æ®µæ ‘å°±èƒ½ç”¨è¿ç»­åŒºé—´æ¥ç»´æŠ¤åŒæ·±åº¦çš„èŠ‚ç‚¹ï¼Œåç»­çš„äºŒåˆ†æ‰¾è¾¹ç•Œå°±å˜å¾—å®¹æ˜“äº†ã€‚  
* **å­¦ä¹ ç¬”è®°**ï¼šæ’åºæ˜¯å°†åˆ†æ•£ç‚¹è½¬åŒ–ä¸ºè¿ç»­åŒºé—´çš„ã€Œé­”æ³•æ£’ã€ï¼Œè¦å­¦ä¼šåˆ©ç”¨æ•°æ®çš„å•è°ƒæ€§è®¾è®¡æ’åºè§„åˆ™ã€‚


## 5. ç®—æ³•å¯è§†åŒ–ï¼šåƒç´ åŠ¨ç”»æ¼”ç¤º


### åŠ¨ç”»ä¸»é¢˜ï¼šã€Œåƒç´ æ—è°±ç®¡ç†å‘˜ã€
æˆ‘ä»¬è®¾è®¡ä¸€ä¸ª**å¤å¤FCæ¸¸æˆé£æ ¼**çš„åŠ¨ç”»ï¼Œè®©ä½ æ‰®æ¼”ã€Œæ—è°±ç®¡ç†å‘˜ã€ï¼Œå¤„ç†æŠ˜è·ƒç‚¹çš„åŠ /æŸ¥æ“ä½œã€‚


### æ ¸å¿ƒæ¼”ç¤ºå†…å®¹
1. **åœºæ™¯åˆå§‹åŒ–**ï¼š  
   - å±å¹•å·¦ä¾§æ˜¯ã€Œæ—è°±æ ‘ã€ï¼ˆåƒç´ å—å †å æˆæ ‘ï¼Œæ ¹èŠ‚ç‚¹1åœ¨æœ€ä¸Šæ–¹ï¼Œå­èŠ‚ç‚¹å‘å³ä¸‹æ–¹å»¶ä¼¸ï¼‰ï¼›  
   - å³ä¾§æ˜¯ã€Œæ§åˆ¶é¢æ¿ã€ï¼šæœ‰ã€Œå¼€å§‹/æš‚åœã€ã€Œå•æ­¥ã€ã€Œé‡ç½®ã€æŒ‰é’®ï¼Œé€Ÿåº¦æ»‘å—ï¼ˆä»1xåˆ°5xï¼‰ï¼Œè¿˜æœ‰ã€Œå½“å‰æ“ä½œã€æç¤ºæ¡†ï¼›  
   - åº•éƒ¨æ˜¯ã€Œçº¿æ®µæ ‘ç›‘æ§å™¨ã€ï¼ˆæ˜¾ç¤ºå½“å‰æ·±åº¦çš„çº¿æ®µæ ‘åŒºé—´ï¼Œç”¨å½©è‰²æ¡è¡¨ç¤ºï¼‰ã€‚

2. **ç®—æ³•å¯åŠ¨**ï¼š  
   - ç‚¹å‡»ã€Œå¼€å§‹ã€ï¼Œæ ‘èŠ‚ç‚¹äº®èµ·ï¼Œæ˜¾ç¤ºåˆå§‹æƒå€¼ï¼›  
   - é¢„å¤„ç†é˜¶æ®µï¼šèŠ‚ç‚¹æŒ‰DFSåºé—ªçƒï¼ŒåŒæ—¶`fa`æ•°ç»„çš„å€å¢å…³ç³»ç”¨ã€Œè™šçº¿ç®­å¤´ã€è¿æ¥ï¼ˆæ¯”å¦‚`u`çš„`fa[u][1]`æ˜¯çˆ·çˆ·ï¼Œç®­å¤´ä»`u`æŒ‡å‘çˆ·çˆ·ï¼‰ã€‚

3. **æ“ä½œæ¼”ç¤º**ï¼š  
   - **æ‰¾ç¥–å…ˆ**ï¼šæ¯”å¦‚`u=4`ï¼Œ`x=1`ï¼ŒèŠ‚ç‚¹4é—ªçƒï¼Œç„¶åå‘ä¸Šè·³1æ­¥åˆ°ç¥–å…ˆ1ï¼Œä¼´éšã€Œå®ã€çš„éŸ³æ•ˆï¼Œç¥–å…ˆ1çš„é¢œè‰²å˜çº¢ï¼ˆè¡¨ç¤ºå•ç‚¹æ“ä½œï¼‰ï¼›  
   - **æ‰¾å­æ ‘åŒºé—´**ï¼šæ¯”å¦‚`u=1`ï¼Œ`x=2`ï¼Œç›®æ ‡æ·±åº¦æ˜¯3ï¼Œæ ‘ä¸­æ·±åº¦3çš„èŠ‚ç‚¹ï¼ˆ3ã€5ï¼‰ä¼šè¢«é»„è‰²é«˜äº®ï¼Œçº¿æ®µæ ‘ç›‘æ§å™¨ä¸­å¯¹åº”çš„åŒºé—´æ¡å˜ç»¿ï¼ˆè¡¨ç¤ºåŒºé—´æ“ä½œï¼‰ï¼›  
   - **åŠ å€¼æ“ä½œ**ï¼šç‚¹å‡»ã€ŒåŠ y=7ã€ï¼Œé«˜äº®çš„èŠ‚ç‚¹é¢œè‰²å˜äº®ï¼ˆè¡¨ç¤ºæƒå€¼å¢åŠ ï¼‰ï¼Œçº¿æ®µæ ‘æ¡çš„é•¿åº¦å˜é•¿ï¼ˆè¡¨ç¤ºæ€»å’Œå¢åŠ ï¼‰ï¼›  
   - **æ±‚å’Œæ“ä½œ**ï¼šç‚¹å‡»ã€Œæ±‚å’Œã€ï¼Œé«˜äº®åŒºåŸŸçš„æ€»å’Œä¼šæ˜¾ç¤ºåœ¨æç¤ºæ¡†ä¸­ï¼Œä¼´éšã€Œæ»´ã€çš„éŸ³æ•ˆã€‚

4. **äº¤äº’è®¾è®¡**ï¼š  
   - ã€Œå•æ­¥æ‰§è¡Œã€ï¼šæ¯ç‚¹å‡»ä¸€æ¬¡ï¼Œæ‰§è¡Œä¸€ä¸ªæ“ä½œæ­¥éª¤ï¼ˆæ¯”å¦‚å…ˆæ‰¾ç¥–å…ˆï¼Œå†æ‰¾åŒºé—´ï¼‰ï¼›  
   - ã€Œè‡ªåŠ¨æ’­æ”¾ã€ï¼šåƒè´ªåƒè›‡AIä¸€æ ·ï¼ŒæŒ‰è®¾å®šé€Ÿåº¦è‡ªåŠ¨æ‰§è¡Œæ‰€æœ‰æ“ä½œï¼›  
   - ã€Œé‡ç½®ã€ï¼šæ¢å¤æ ‘çš„åˆå§‹çŠ¶æ€ï¼Œé‡æ–°å¼€å§‹ã€‚


### éŸ³æ•ˆè®¾è®¡
- **ç¥–å…ˆæ“ä½œ**ï¼šã€Œå®ã€ï¼ˆæ¸…è„†çš„åƒç´ éŸ³ï¼Œæç¤ºå•ç‚¹æ“ä½œï¼‰ï¼›  
- **åŒºé—´æ“ä½œ**ï¼šã€Œå—¡ã€ï¼ˆä½æ²‰çš„éœ‡åŠ¨éŸ³ï¼Œæç¤ºåŒºé—´æ“ä½œï¼‰ï¼›  
- **å®Œæˆæ“ä½œ**ï¼šã€Œèƒœåˆ©ã€ï¼ˆä¸Šæ‰¬çš„8ä½éŸ³ä¹ï¼Œæ¯”å¦‚ã€Šè¶…çº§é©¬é‡Œå¥¥ã€‹çš„è¿‡å…³éŸ³æ•ˆï¼‰ï¼›  
- **é”™è¯¯æç¤º**ï¼šã€Œå“”ã€ï¼ˆçŸ­ä¿ƒçš„è­¦ç¤ºéŸ³ï¼Œæ¯”å¦‚`x`è¶…è¿‡æ ‘æ·±åº¦æ—¶ï¼‰ã€‚


## 6. æ‹“å±•ç»ƒä¹ ä¸ç›¸ä¼¼é—®é¢˜æ€è€ƒ


### é€šç”¨æ€è·¯è¿ç§»
æœ¬é¢˜çš„æ ¸å¿ƒæ€è·¯ã€Œæ ‘çš„æ·±åº¦å¤„ç†+çº¿æ®µæ ‘åŒºé—´æ˜ å°„ã€å¯ç”¨äºè§£å†³**æ‰€æœ‰éœ€è¦ã€Œæ‰¾æ ‘ä¸­ç‰¹å®šæ·±åº¦èŠ‚ç‚¹ã€çš„é—®é¢˜**ï¼Œæ¯”å¦‚ï¼š  
1. ç»Ÿè®¡æŸèŠ‚ç‚¹å­æ ‘å†…æ·±åº¦ä¸º`k`çš„èŠ‚ç‚¹æ•°ï¼›  
2. ç»™æŸèŠ‚ç‚¹çš„`k`çº§åä»£åŠ å€¼ï¼›  
3. æ±‚æŸèŠ‚ç‚¹çš„`k`çº§ç¥–å…ˆçš„æƒå€¼å’Œã€‚


### ç»ƒä¹ æ¨èï¼ˆæ´›è°·ï¼‰
1. **P3379 æœ€è¿‘å…¬å…±ç¥–å…ˆï¼ˆLCAï¼‰**ï¼šç»ƒä¹ å€å¢æ³•æ‰¾ç¥–å…ˆï¼Œæ˜¯æœ¬é¢˜çš„åŸºç¡€ï¼›  
2. **P2056 è½¦ç‰Œé—®é¢˜**ï¼šç»ƒä¹ æ ‘çš„DFSåºéå†ï¼Œç†è§£å­æ ‘çš„è¿ç»­æ€§ï¼›  
3. **P4113 æ ‘çš„è®¡æ•°**ï¼šç»ƒä¹ æ ‘çš„æ·±åº¦å¤„ç†ï¼Œç»Ÿè®¡ä¸åŒæ·±åº¦çš„èŠ‚ç‚¹æ•°ï¼›  
4. **P5022 æ—…è¡Œ**ï¼šç»ƒä¹ çº¿æ®µæ ‘ç»´æŠ¤æ ‘çš„è·¯å¾„ä¿¡æ¯ï¼Œæ˜¯æœ¬é¢˜çš„è¿›é˜¶ã€‚


## 7. å­¦ä¹ å¿ƒå¾—ä¸ç»éªŒåˆ†äº«


### å‚è€ƒç»éªŒï¼ˆæ¥è‡ª_H17_ï¼‰
> ã€Œæˆ‘ç¬¬ä¸€æ¬¡æäº¤æ²¡åˆ‡æ‰ï¼Œå› ä¸ºæ²¡æ³¨æ„`x=0`çš„æƒ…å†µï¼ã€

**ç‚¹è¯„**ï¼šè¿™æ˜¯æœ€å¸¸è§çš„ã€Œè¾¹ç•Œå‘ã€ï¼`x=0`æ—¶ï¼ŒæŠ˜è·ƒåªèƒ½åˆ°è¾¾`u`è‡ªå·±ï¼Œä¸éœ€è¦æ‰¾ç¥–å…ˆæˆ–æ™šè¾ˆã€‚è§£å†³æ–¹æ³•æ˜¯åœ¨ä»£ç ä¸­**ä¼˜å…ˆåˆ¤æ–­`x==0`**ï¼Œç›´æ¥å¤„ç†`u`çš„å•ç‚¹æ“ä½œã€‚


### å‚è€ƒç»éªŒï¼ˆæ¥è‡ªWater__Problemï¼‰
> ã€Œæˆ‘ç”¨äº†åŠ¨æ€å¼€ç‚¹çº¿æ®µæ ‘ï¼Œé¿å…äº†ç©ºé—´æµªè´¹ï¼ã€

**ç‚¹è¯„**ï¼šå½“æ ‘çš„æ·±åº¦å¾ˆå¤§æ—¶ï¼Œæ™®é€šçº¿æ®µæ ‘ä¼šæµªè´¹å¤§é‡ç©ºé—´ï¼ˆæ¯”å¦‚æ·±åº¦1çš„èŠ‚ç‚¹åªæœ‰1ä¸ªï¼Œå´è¦å¼€ä¸€æ£µå®Œæ•´çš„çº¿æ®µæ ‘ï¼‰ã€‚åŠ¨æ€å¼€ç‚¹çº¿æ®µæ ‘åªç»™å­˜åœ¨çš„èŠ‚ç‚¹å¼€ç©ºé—´ï¼Œæ˜¯ç©ºé—´ä¼˜åŒ–çš„å¥½æ–¹æ³•ã€‚


## ç»“è®º
ã€ŒæŠ˜è·ƒç‚¹ã€æ˜¯ä¸€é“**æ ‘çš„æ·±åº¦å¤„ç†+çº¿æ®µæ ‘**çš„ç»å…¸é¢˜ï¼Œæ ¸å¿ƒæ˜¯æŠŠã€Œåˆ†æ•£çš„ç‚¹ã€è½¬åŒ–ä¸ºã€Œè¿ç»­çš„åŒºé—´ã€ã€‚é€šè¿‡æœ¬é¢˜çš„å­¦ä¹ ï¼Œä½ ä¼šæŒæ¡ï¼š  
- æ ‘çš„DFSåºã€å€å¢æ³•çš„åº”ç”¨ï¼›  
- çº¿æ®µæ ‘çš„åŒºé—´åŠ /æŸ¥æŠ€å·§ï¼›  
- å¦‚ä½•ç”¨æ’åºå’ŒäºŒåˆ†è§£å†³ã€Œæ‰¾åŒºé—´ã€çš„é—®é¢˜ã€‚  

è®°ä½ï¼š**ç¼–ç¨‹çš„æœ¬è´¨æ˜¯ã€Œè½¬åŒ–é—®é¢˜ã€**â€”â€”æŠŠå¤æ‚çš„æŠ˜è·ƒæ“ä½œè½¬åŒ–ä¸ºã€Œæ‰¾ç¥–å…ˆ+æ‰¾åŒºé—´ã€ï¼Œå†ç”¨æ•°æ®ç»“æ„é«˜æ•ˆå¤„ç†ã€‚å¤šç»ƒã€å¤šæƒ³ï¼Œä½ ä¼šè¶Šæ¥è¶Šå‰å®³ï¼ğŸ’ª


---
æœ¬æ¬¡åˆ†æç»“æŸï¼Œä¸‹æ¬¡æˆ‘ä»¬ä¸€èµ·æŒ‘æˆ˜æ›´éš¾çš„æ ‘è®ºé—®é¢˜ï¼ğŸš€

---
å¤„ç†ç”¨æ—¶ï¼š139.31ç§’
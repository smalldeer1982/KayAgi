# 题目信息

# 『MdOI R2』Odyssey

## 题目背景

超越音速的极限，不及瑰丽多变的极光；

微弱的脉冲，开拓原本一片混沌的天地；

沉郁的蓝缓缓闪动，史诗的红迎接巅峰；

血色的夕阳尽头，是将夜的星辰；

夜半的满天星空，也会被来自地狱的硝烟掩盖；

炽红炼狱消逝，只金色遗迹永存。

在这里等待着每一位的，都是一段艰苦而璀璨的旅程。

## 题目描述

若正整数 $a$ 与 $b$ 满足：

- $a$ 与 $b$ 的积是一个正整数的 $k$ 次方，即存在正整数 $c$ 使得 $ab=c^k$。

那么我们称 $(a,b)$ 为一组**完美数对**。

---

有一个包含 $n$ 个结点和 $m$ 条边的**有向无环图**，这张图中的每条边都有权值和长度两个属性。

如果一条路径 $P$ 满足**以下条件之一**，则称其为一条**完美路径**：

- $P$ 中仅包含一条边。

- $P$ 从其起点开始依次为 $e_1, e_2, e_3, \ldots e_p$ 这 $p\ (p\ge 2)$ 条边，对于任意的 $1\leq i\leq p-1$，$e_i$ 的权值和 $e_{i+1}$ 的权值组成完美数对。

你需要求出图中最长完美路径的长度，一条路径的长度定义为这条路径上所有边的长度之和。

## 说明/提示

【帮助与提示】  

为方便选手测试代码，本题额外提供两组附加样例供选手使用。  

[样例输入1](https://www.luogu.com.cn/paste/wx1lz6m2) [样例输出1](https://www.luogu.com.cn/paste/28xe7f0x)      

[样例输入2](https://www.luogu.com.cn/paste/efgwngs5) [样例输出2](https://www.luogu.com.cn/paste/5hcpoayt)   

----

【样例解释】

样例中给出的有向无环图如图所示，其中边上的红色数字为边的权值，黑色数字为边的长度：

![](https://cdn.luogu.com.cn/upload/image_hosting/w6x03ksd.png)

最长完美路径为 $2\to 5\to 3$，因为这两条边的权值 $2$ 和 $18$ 满足 $2\times 18=6^2$，是完美数对，此路径长度为 $5+9=14$。

此外，$2\to 1\to 4\to 3,\ \ 2\to 4\to 3,\ \ 1\to 5\to 3$ 等也是完美路径，但不是最长的。

图中，$2\to 1\to 5\to 3$ 长度为 $15$，是一条更长的路径，但它并不是完美路径，因为前两个边权 $24$ 和 $8$ 的乘积为 $192$，不是正整数的平方，即 $(24,8)$ 不是完美数对。

---

【数据范围】

**本题采用捆绑测试。**

对于 $100\%$ 的数据：$1\leq n\leq 10^5,\ \ 1\leq m\leq 2\times 10^5,\ \ 1\leq k\leq 10,\ \ 1\leq u,v\leq n,\ \ 1\leq w\leq 10^5,\ \ 1\leq l\leq 10^4$。

给出的图**不保证弱连通**，图中从一个点到另一个点**可能**存在多条边，但保证给出的图是有向无环图。

| 子任务编号 | $n\leq$ |     $m\leq$      | $w\leq$ | $k\leq$ |  特殊性质  | 分值 |
| :--------: | :-----: | :--------------: | :-----: | :-----: | :--------: | :--: |
| Subtask 1  | $10^5$  |  $2\times 10^5$  | $10^5$  |   $1$   |     无     | $18$ |
| Subtask 2  |  $10$   |       $10$       |  $100$  |  $2$   |     无     | $12$ |
| Subtask 3  |  $600$  | $1.5\times 10^3$ | $10^3$  |   $2$   |     无     | $10$ |
| Subtask 4  | $10^5$  |  $2\times 10^5$  | $10^5$  |   $2$   | $w$ 为素数 | $15$ |
| Subtask 5  | $10^5$  |  $2\times 10^5$  | $10^5$  |   $2$   |     无     | $15$ |
| Subtask 6  |  $600$  | $1.5\times 10^3$ | $10^3$  |  $5$   |     无     | $10$ |
| Subtask 7  | $10^5$  |  $2\times 10^5$  | $10^5$  |  $10$   |     无     | $20$ |



## 样例 #1

### 输入

```
5 7 2
2 5 2 5
5 3 18 9
2 4 6 7
4 3 6 3
2 1 24 2
1 4 6 8
1 5 8 4```

### 输出

```
14```

# AI分析结果


# 💡 Kay的C++算法解析：『MdOI R2』Odyssey 深入学习指南 💡

## 1. 题目解读与核心算法识别

✨ **本题主要考察**：`质因数分解 + DAG动态规划`  

🗣️ **初步分析**：  
> 这道题要求在有向无环图(DAG)上寻找满足特殊条件的"完美路径"。关键点在于相邻边的权值必须组成**完美数对**（即乘积为某正整数的k次方）。我们可以通过质因数分解将边权转化为指数模k的形式，并计算其唯一对应的"补数"。  

**核心步骤**：  
1. 对每条边的权值进行质因数分解，将各质因子的指数对k取模，得到**约化边权**  
2. 计算每个约化边权对应的**补数**（满足两数乘积为k次方的最小正整数）  
3. 在DAG上进行动态规划：`dp[u][s]`表示以节点u结尾、最后一条边约化边权为s时的最大路径长度  
4. 状态转移：`dp[v][s] = max(dp[v][s], dp[u][f(s)] + l)`，其中f(s)是s的补数  

**可视化设计**：  
- 像素网格展示DAG结构，节点用8位风格方块表示  
- 边权转化过程：显示质因数分解动画（质因子飞入计算区→指数取模→生成约化值）  
- DP转移时高亮当前边和补数查找过程，数据变化以像素数字实时更新  
- 复古元素：成功转移时播放FC风格"叮"音效，路径更新时节点闪烁金色  

---

## 2. 精选优质题解参考

**题解一（作者：BFqwq）**  
* **点评**：思路清晰，通过分层图拓扑解决状态转移。代码中将节点拆分为两层（原点和+n）确保完美数对交替出现，逻辑严谨。亮点在于预处理质数优化分解效率，空间复杂度控制优秀（O(n)）。但初始数组开小导致RE的调试经验提醒我们注意状态规模估算。

**题解二（作者：一扶苏一）**  
* **点评**：采用双模数哈希处理约化边权，避免冲突风险。代码模块化程度高，map存储状态使转移逻辑简洁（仅20行核心DP）。亮点在于自动处理k=1的特殊情况，且质因数分解函数封装规范，适合竞赛直接使用。

**题解三（作者：under_the_time）**  
* **点评**：最简洁的实现方案，单次拓扑完成所有转移。亮点在于用unordered_map实现O(1)状态查询，将补数计算和DP合并处理。代码量少（<50行）但完整处理了边界情况，如补数超限时直接跳过。

---

## 3. 核心难点辨析与解题策略

1. **难点1：边权转化与补数计算**  
   * **分析**：约化边权需保证唯一性，大质数处理不当易溢出。优质题解通过限制补数范围（>10^5时弃用）和特判k=1解决  
   * 💡 **学习笔记**：质因数分解时同步计算补数，一旦超过阈值立即终止  

2. **难点2：DP状态设计与转移**  
   * **分析**：状态空间可能达O(m)，需高效存储。题解采用map/unordered_map替代数组，利用DAG拓扑序逐步转移  
   * 💡 **学习笔记**：状态键为约化边权，值为路径长度，转移时仅需查找补数键  

3. **难点3：k=1的特殊处理**  
   * **分析**：此时所有边权自动满足条件，问题退化为DAG最长路。题解通过统一框架处理：约化边权恒为1，补数也为1  
   * 💡 **学习笔记**：无需特判，保持通用转移逻辑即可  

### ✨ 解题技巧总结  
- **边权压缩**：质因数分解后指数取模，大幅降低状态维度  
- **状态复用**：相同约化边权共享状态，避免重复计算  
- **拓扑优化**：按入度为零顺序推进，自然满足DP无后效性  
- **边界处理**：单条边作为合法路径初始化状态  

---

## 4. C++核心代码实现赏析

**本题通用核心C++实现参考**  
* **说明**：综合优质题解思路，采用unordered_map实现高效状态转移  
```cpp
#include <unordered_map>
#include <queue>
using namespace std;

const int N = 1e5 + 5;
vector<pair<int, pair<int, int>>> G[N]; // {v, {约化边权, 长度}}
unordered_map<int, int> dp[N]; // dp[u][s] 状态
int inDeg[N], ans;

void solve(int u, int s, int l, int v) {
    int comp = getComplement(s); // 计算补数
    int prev = dp[u].count(comp) ? dp[u][comp] : 0;
    dp[v][s] = max(dp[v][s], prev + l);
    ans = max(ans, dp[v][s]);
}

void topoSort() {
    queue<int> q;
    for (int i = 1; i <= n; ++i) 
        if (inDeg[i] == 0) q.push(i);
    
    while (!q.empty()) {
        int u = q.front(); q.pop();
        for (auto &e : G[u]) {
            int v = e.first, s = e.second.first, l = e.second.second;
            solve(u, s, l, v); // 状态转移
            if (--inDeg[v] == 0) q.push(v);
        }
    }
}
```

**题解一核心代码片段**  
```cpp
void topo(int w) {
    // 仅处理特定边权及补数
    for (edge v : g[w]) addEdge(v.from, v.to, v.lg);
    for (edge v : g[f[w]]) addEdge(v.from + n, v.to, v.lg);
    // ...拓扑排序与DP...
}
```
* **代码解读**：  
  > 分层图设计精妙！通过`v.from+n`将节点扩展为两层，确保完美数对交替出现。当处理边权`w`时，将其起点放在第一层；处理补数`f[w]`时起点放在第二层，这样转移自然交替。  
* 💡 **学习笔记**：分层图是处理状态交替的有效技巧，但需注意空间开销  

**题解二哈希应用片段**  
```cpp
pair<vector<int>, pii> solve(int w) {
    vector<int> modExponents; // 存储模后指数
    // ...分解质因数并取模...
    return {modExponents, {largePrime, 1}}; 
}
```
* **代码解读**：  
  > 使用vector存储小质因子模值，pair存放大质因子，实现完美哈希。双模数确保唯一性，避免哈希冲突。  
* 💡 **学习笔记**：大质数单独处理可降低哈希复杂度  

---

## 5. 算法可视化：像素动画演示

**像素探险家之旅**  
- **主题**：8位像素风格DAG地图，边权转化为能量晶体  
- **核心演示**：  
  1. **初始化**：网格布局节点，不同颜色区分入度（蓝色=0，红>0）  
  2. **边权转化**：  
     - 边权数字分解为质因数像素块（如12→2²×3）  
     - 指数对k取模：像素块重组动画（k=2时，指数2%2=0消失）  
  3. **补数计算**：生成互补晶体并显示数值，超限时显示"X"  
  4. **DP转移**：  
     - 当前节点闪烁绿色  
     - 查找补数状态：从历史路径射出光束连接当前边  
     - 路径更新：新路径显示为金色，播放8-bit音效  
  5. **结果展示**：最长路径以闪光轨迹呈现，终点放烟花  

**控制面板**：  
- 步进/暂停/重置按钮  
- 速度滑块（1x-5x）  
- 模式切换：单步跟踪/自动演示（AI自动播放）  
- 信息板：显示当前约化边权、补数和路径长度  

**音效设计**：  
- 质因数分解：电子分解音  
- 有效转移："叮"声（FC游戏金币音）  
- 路径更新：升级音效  
- 错误/无效：低沉嗡鸣  

---

## 6. 拓展练习与相似问题思考

**通用思路迁移**：  
1. 相邻元素约束的路径问题（如颜色交替、权值倍数关系）  
2. 带状态压缩的DAG动态规划  
3. 大数分解与哈希结合的应用  

**洛谷推荐**：  
1. **P4017 最大食物链计数**  
   🗣️ *推荐理由*：同属DAG上带约束路径统计，巩固拓扑排序与DP  
2. **P1613 跑路**  
   🗣️ *推荐理由*：倍增+图论，练习边权关系转化技巧  
3. **P3384 树链剖分**  
   🗣️ *推荐理由*：树形结构进阶，理解路径问题变种  

---

## 7. 学习心得与经验分享

> **BFqwq的经验**："分层图拓扑时数组开小导致RE，注意状态规模估算"  
> **点评**：空间复杂度分析至关重要，特别是扩展节点时需开双倍数组。建议编码前进行理论计算，避免低级错误。  

> **一扶苏一的调试技巧**："双哈希避免冲突，但需注意模数选择"  
> **点评**：哈希冲突是隐形BUG来源，双模数可有效解决。重要结论：质数模数组合（如998244353+1e9+7）冲突概率极低。  

本次题解未发现更多作者心得，但以上两点已具参考价值。

---

**结语**：  
通过质因数分解转化问题本质，在DAG上巧妙设计状态转移，是解决此类图论问题的核心思路。算法实现中需注意哈希优化与边界处理。希望本指南助你掌握解题精髓！下次挑战再见！🚀

---
处理用时：142.10秒
# 题目信息

# [CoE R5] 罚球

## 题目描述

有 $n$ 个人在玩罚球游戏，游戏规则如下：
- 每个人编号为 $1,2,\dots,n$，最开始由 $1$ 号罚球，接下来让下一个没有出局的人罚球。特殊地，$n$ 号的下一个是 $1$ 号。
- 如果罚球者没有碰到篮板，那么直接出局。
- 如果罚球者碰到篮板但没有进球，那么如果上一个人进球了，这个人就会出局，否则不会出局。
- 游戏结束的条件是最后只剩下一个人。

注意最开始的那个人碰到篮板但没有进球不出局。

这 $n$ 个人中，第 $i$ 个人碰不到篮板的概率为 $\dfrac{a_i}{1000}$，碰到篮板但没有进球的概率为 $\dfrac{b_i}{1000}$，求游戏结束时所有人总共罚球数量的期望值。

## 说明/提示

**关于取模**

不会有理数取模的看[这里](https://www.luogu.com.cn/problem/P2613)。



------------
**样例说明**

输入 $\#1$：

所有人碰不到篮板的概率都是 $\dfrac{1}{5}$，碰到篮板但不进球的概率都是 $\dfrac{2}{5}$，罚球数量的期望值为 $\dfrac{25}{9}$。

计算如下（黑色表示出局，红色表示没进球但不出局，蓝色表示进球）：
$$\dfrac{1}{5}+\red{\dfrac{2}{5}}\times(\dfrac{1}{5}+\red{\dfrac{2}{5}}\times(...)+\blue{\dfrac{2}{5}}\times(...))+\blue{\dfrac{2}{5}}\times(\dfrac{3}{5}+\blue{\dfrac{2}{5}}\times(...))=\dfrac{25}{9}$$

输入 $\#2$：

所有人碰不到篮板的概率都是 $\dfrac{321}{1000}$，碰到篮板但不进球的概率都是 $\dfrac{637}{1000}$，罚球数量的期望值为 $\dfrac{1000000}{57959}$。

------------

**数据范围**

**本题采用捆绑测试**。

测试点性质：
| $t=$ | 性质 | 分数 |
| :----------: | :----------: | :----------: |
| $1$ | $n=1$ | $2$ |
| $2$ | $a_i=b_i=0$ | $2$ |
| $3$ | $a_i=1000$ | $4$ |
| $4$ | $b_i=1000$ | $4$ |
| $5$ | $a_i=0,b_1=0,\forall i>1,b_i=1000$ | $6$ |
| $6$ | $a_i=b_i=500$ | $6$ |
| $7$ | $a_i=0,b_i=500$ | $6$ |
| $8$ | $a_i,b_i$ 均为定值，且答案不为 $-1$ | $19$ |
| $9$ | $1 \le n \le 11$ | $26$ |
| $10$ | $1 \le n \le 15$ | $8$ |
| $11$ | 无特殊性质 | $17$ |

**对于** $100\%$ **的数据**，$1 \le n \le 18$，$0 \le a_i,b_i,a_i+b_i \le 1000$。

本题的 $\text{Subtask 10}$ 分为两部分计分，对应 $t \in \{10,11\}$。

保证不存在分母为 $10^6+33$ 的倍数的情况。

## 样例 #1

### 输入

```
2 8
200 400
200 400```

### 输出

```
888921```

## 样例 #2

### 输入

```
7 8
321 637
321 637
321 637
321 637
321 637
321 637
321 637```

### 输出

```
818968```

## 样例 #3

### 输入

```
6 10
338 270
229 413
132 133
141 173
157 686
616 250```

### 输出

```
315860```

## 样例 #4

### 输入

```
8 10
338 270
229 413
132 133
141 173
157 686
616 250
0 0
0 0```

### 输出

```
-1```

# AI分析结果


### 💡 Kay的C++算法解析：罚球 深入学习指南 💡

#### 1. 题目解读与核心算法识别
✨ **本题主要考察**：`状态压缩DP` + `高斯消元` (动态规划与线性代数应用)  
🗣️ **初步分析**：  
> 解决"罚球"题目的核心在于**状态压缩DP**与**环状依赖处理**。想象你有一串像素小人围成圆圈，每人罚球后可能消失或留下，状态会像打地鼠游戏一样动态变化。关键挑战是：  
> - **状态定义**：用二进制数表示存活玩家集合（如`1110`表示1、2、3号存活），结合当前罚球者位置和上轮结果（进球/未进球）。  
> - **环状依赖**：转移方程形成闭环（像贪吃蛇咬尾巴），需用**高斯消元**解线性方程组。  
> - **可视化设计**：在像素动画中，用不同颜色方块表示玩家状态（绿色存活/红色出局），罚球时高亮当前玩家。消元过程可设计为"俄罗斯方块"式矩阵变换，伴随8-bit音效：  
>   - 操作音：`哔~`（比较元素）、`叮！`（主元消去）  
>   - 胜利音：马里奥过关旋律（当状态转移完成）

---

### 2. 精选优质题解参考
**题解一（Alarm5854 - 官方题解）**  
* **点评**：  
  思路直击要害——定义`f(S,i)`和`g(S,i)`分别处理上轮进球/未进球的期望。代码亮点在于：  
  - **逆元预处理**：线性时间计算模逆元（`inv[i]=(p-p/i)*inv[p%i]%p`）  
  - **稀疏矩阵优化**：高斯消元跳过零元素，复杂度从`O(n³)`降至`O(n²)`  
  - **严谨边界处理**：特判`-1`情况（如多人百发百中）  

**题解二（Nazq）**  
* **点评**：  
  **带状矩阵消元法**令人惊艳！将每个状态集合的消元复杂度从`O(n³)`压到`O(n)`：  
  - 转移方程天然形成三对角矩阵（仅主对角线相邻元素非零）  
  - 用`rk[state]`映射状态位置，代码清晰如地铁线路图  
  - 边界处理巧妙：`if(!a[i]&&!b[i])++c1`统计危险情况  

**题解三（do_while_true）**  
* **点评**：  
  **主元法消元**的极致优化：  
  - 分离`f(S,i,0)`和`f(S,i,1)`，先解进球状态再解未进状态  
  - 环状方程用`nxt`指针模拟循环链表，`O(n)`扫一遍即解  
  - 代码模块化：`solve(S)`处理单状态，`Gauss()`解方程分工明确  

---

### 3. 核心难点辨析与解题策略
1. **难点：状态压缩的环状依赖**  
   * **分析**：当玩家围成环，当前状态依赖前驱状态形成闭环。优质解法用`(S, i, 0/1)`三维状态：集合`S`+当前位置`i`+上轮结果`0/1`  
   * 💡 **学习笔记**：环问题可虚拟头节点，但此处需保留拓扑关系  

2. **难点：高斯消元复杂度爆炸**  
   * **分析**：直接消元`O(2ⁿn³)`超时。优化核心在于发现**方程组的带状特性**：  
     ```math
     \begin{pmatrix} 
     1 & * & 0 & \cdots & * \\ 
     0 & 1 & * & \cdots & 0 \\
     \vdots & \vdots & \ddots & \vdots \\
     * & 0 & \cdots & 1 
     \end{pmatrix}
     ```  
   * 💡 **学习笔记**：特殊矩阵用特殊消元法（主元法/追赶法）  

3. **难点：概率转移的数学抽象**  
   * **分析**：定义三种事件概率：  
     - `a_i`：未碰篮板→出局  
     - `b_i`：碰板未进→上轮进球则出局  
     - `c_i`：进球→保留  
   * 💡 **学习笔记**：期望公式`E = Σ(概率×子期望)+1`中`+1`是关键  

### ✨ 解题技巧总结
- **技巧1：逆元预处理**  
  模运算中频繁除法→预先计算`inv[]`数组，`O(1)`完成除法  
- **技巧2：状态枚举顺序**  
  按集合大小升序枚举，保证子状态先被计算  
- **技巧3：消元剪枝**  
  `if(!c[j][i]) continue` 跳过零元素提升10倍效率  

---

### 4. C++核心代码实现赏析
**通用核心实现（综合题解优化）**  
```cpp
const int MOD = 1e6+33;
vector<vector<vector<ll>>> f(1<<N, vector<vector<ll>>(N, vector<ll>(2,-1)));

void solve(int S) {
    vector<int> alive;
    for(int i=0; i<n; ++i) if(S>>i&1) alive.push_back(i);
    
    // 构建三对角矩阵 (主元法核心)
    vector<ll> A, B, C, D; // 分别存储主元/下对角/上对角/常数
    for(int i=0; i<alive.size(); ++i) {
        int x = alive[i], nxt = alive[(i+1)%alive.size()];
        A.push_back(1);
        B.push_back(-c[x]); 
        D.push_back(a[x]*dp(S^(1<<x),nxt,0) + b[x]*dp(S^(1<<x),nxt,0) + 1);
    }
    // 主元法解方程 (复杂度O(n))
    vector<ll> ans = TridiagSolver(A, B, B, D); 
    for(int i=0; i<alive.size(); ++i) 
        f[S][alive[i]][1] = ans[i];
    
    // 类似步骤解f[S][i][0]
}
```

**题解一：带状矩阵消元（节选）**  
```cpp
// 构造转移矩阵（非零元素<5%）
for(int j=0; t=i; t^=t&-t,++j){
    int x = g[t&-t];
    c[j*2][j*2] = 1;
    c[j*2][(j*2+2)%(l[i]*2)] = -b[x]; // 仅相邻位非零
    if(~f[i^(1<<x)][j%(l[i]-1)]) // 子状态已计算
        c[j*2][tot] = (a[x]*f[...] + 1) % p;
}
gauss(l[i]*2); // 优化：跳过零元素
```

**题解三：主元法消元（节选）**  
```cpp
void Gauss(int m) {
    // 消元成上三角（O(n)步）
    for(int i=m; i>=2; --i) {
        ll factor = B[i]*inv[A[i]] % MOD;
        B[i-1] = (B[i-1] - factor*A[i-1]) % MOD;
        D[i-1] = (D[i-1] - factor*D[i]) % MOD;
    }
    ans[1] = D[1]*inv[A[1]] % MOD; // 回代起点
    for(int i=2; i<=m; ++i) 
        ans[i] = (D[i] - C[i]*ans[i-1])*inv[A[i]] % MOD;
}
```

---

### 5. 算法可视化：像素动画演示  
**主题**：`像素篮球场：状态消元大冒险`  
**核心设计**：  
1. **场景构建**：  
   - 8-bit风格环形球场，18个像素小人（编号1-18）  
   - 小人状态：  
     * 绿色站立：存活  
     * 红色消失：出局  
     * 黄色闪烁：当前罚球者  

2. **动画流程**：  
   ```mermaid
   graph TD
   A[初始全员绿色] --> B[1号闪烁]
   B --> C{罚球判定}
   C -->|a_i| D[变红消失]
   C -->|b_i| E[变灰蹲下]
   C -->|c_i| F[绿色打钩]
   D/E/F --> G[更新状态矩阵]
   G --> H[矩阵消元动画]
   H --> I[下一个罚球者闪烁]
   I --> C
   ```  
   - **矩阵动画**：  
     * 每个状态对应4x4像素块  
     * 消元过程：被消行变透明，主元高亮闪烁  
     * 音效：`嘟！`（选主元）、`叮！`（消元成功）  

3. **游戏化设计**：  
   - 每完成一个状态集合的消元得100分  
   - 进度条显示：当前状态`S`的二进制表示  
   - 胜利动画：马里奥顶金币（当`|S|=1`时）  

---

### 6. 拓展练习与相似问题思考
1. **技巧迁移**：  
   - 环状依赖：约瑟夫问题变种  
   - 状压+期望：迷宫随机游走  
   - 带状矩阵：热传导方程离散化  

2. **推荐题目**：  
   - 洛谷P2473 [SCOI2008]奖励关（`状压+期望DP`）  
   - 洛谷P3232 [HNOI2013]游走（`高斯消元解期望`）  
   - 洛谷P4547 [THUWC2017]随机二分图（`状压DP进阶`）  

---

### 7. 学习心得与经验分享
> **来自题解作者的调试经验**：  
> *“在`-1`特判卡了2小时——当多人百发百中时，分母会出现0，必须提前过滤！”*  
> **Kay总结**：概率题要警惕**分母为零**的边界：  
> 1. 用`if(a[i]==0 && b[i]==0)`统计危险玩家  
> 2. 消元前检查矩阵是否奇异`(det=0)`  
> 3. 模运算中零元不可逆，需单独处理  

---

通过本指南，你不仅掌握了罚球期望的解法，更学会了**状态压缩的降维艺术**和**消元优化的工程思维**。下次遇到环状依赖时，记得像玩像素游戏一样拆解状态，用主元法打破闭环！🚀

---
处理用时：286.15秒
# é¢˜ç›®ä¿¡æ¯

# [TOIP2024] è·ç¦»å‡½æ•°

## é¢˜ç›®æè¿°

å°æ˜å’Œå°èŠ±å„æœ‰ä¸€æ£µ $n$ ä¸ªèŠ‚ç‚¹çš„æœ‰æ ¹æ ‘ï¼Œå…¶ä¸­å°æ˜çš„æ ‘æ»¡è¶³èŠ‚ç‚¹ $i$ çš„çˆ¶èŠ‚ç‚¹ä¸º $p_i$ã€æ ¹èŠ‚ç‚¹çš„ $p_i$ ä¸º $0$ï¼›å°èŠ±çš„æ ‘æ»¡è¶³èŠ‚ç‚¹ $i$ çš„çˆ¶èŠ‚ç‚¹ä¸º $q_i$ã€æ ¹èŠ‚ç‚¹çš„ $q_i$ ä¸º $0$ã€‚ä»–ä»¬æƒ³è¦çŸ¥é“å½¼æ­¤çš„æœ‰æ ¹æ ‘æœ‰å¤šç›¸ä¼¼ï¼Œä¸ºäº†æ˜ç¡®å®šä¹‰ç›¸ä¼¼ç¨‹åº¦ï¼Œä»–ä»¬ä¸¤äººå…±åŒè®¾è®¡äº†ä¸€ä¸ªä¸¤æ£µæœ‰æ ¹æ ‘çš„ã€Œè·ç¦»å‡½æ•°ã€ï¼Œåªè¦è·ç¦»å‡½æ•°ç»™å‡ºçš„å€¼è¶Šå¤§ï¼Œå°±è¡¨ç¤ºè¿™ä¸¤æ£µæ ‘è¶Šä¸ç›¸ä¼¼ã€‚

ä¸ºäº†åŒæ—¶å…¼é¡¾æ ‘çš„é•¿ç›¸åŠç¼–å·çš„å·®å¼‚ï¼Œè·ç¦»å‡½æ•°å¤§é‡è€ƒè™‘äº†ã€Œäº’ä¸ºç¥–å…ˆå…³ç³»ã€çš„èŠ‚ç‚¹å¯¹ã€‚è¯¦ç»†åœ°è¯´ï¼Œåœ¨ä¸€æ£µæœ‰æ ¹æ ‘ $T$ ä¸Šï¼Œå½“ä¸¤ä¸ªèŠ‚ç‚¹ $u, v$ æ»¡è¶³ $u$ è½åœ¨ $v$ ä¸æ–­å¾€çˆ¶èŠ‚ç‚¹ç§»åŠ¨åˆ°æ ¹èŠ‚ç‚¹çš„è·¯å¾„ä¸Šæ—¶ï¼Œæˆ‘ä»¬å°±ç§° $u$ ä¸º $v$ åœ¨ $T$ ä¸Šçš„ç¥–å…ˆï¼›è€Œå½“ä¸€å¯¹èŠ‚ç‚¹ $\{u, v\}$ æ»¡è¶³ $u$ ä¸º $v$ åœ¨ $T$ ä¸Šçš„ç¥–å…ˆã€æˆ– $v$ ä¸º $u$ åœ¨ $T$ ä¸Šçš„ç¥–å…ˆæ—¶ï¼Œ**$\{u, v\}$ åœ¨ $T$ å³äº’ä¸ºç¥–å…ˆå…³ç³»**ã€‚

å°æ˜å’Œå°èŠ±å°†ä»¥ä¸Šçš„è·ç¦»å‡½æ•°åº”ç”¨åœ¨ä¸¤æ£µæ ‘çš„æƒ…å†µä¸‹ï¼Œåªè¦ä¸€å¯¹èŠ‚ç‚¹ $\{u, v\}$ æ»¡è¶³ä»–ä»¬åœ¨å…¶ä¸­ä¸€æ£µæ ‘äº’ä¸ºç¥–å…ˆå…³ç³»ã€å¦ä¸€æ£µä¸æ˜¯çš„è¯ï¼Œä»–ä»¬å°±è®¤ä¸ºè¿™ä¸¤æ£µæœ‰æ ¹æ ‘çš„è·ç¦»å¢åŠ äº†ã€‚

ä¸è¿‡è¿™æ ·çš„è·ç¦»å‡½æ•°é™åˆ¶è¿‡äºæ­»æ¿ï¼Œä¸ºäº†å®¹è®¸è¯¯å·®çš„å­˜åœ¨ï¼Œä¸¤äººåˆå¤šåŠ å…¥äº†ä¸€ä¸ªè¯¯å·®å‚æ•° $k$ æ¥è¿›è¡Œå‡½æ•°å€¼çš„è°ƒæ•´ï¼Œå¹¶ç‰µæ¶‰åˆ°äº†è®¡ç®—ã€Œç¥–å…ˆå…³ç³»è·ç¦»ã€çš„å­å‡½æ•° $d_T(u, v)$ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬å¯ä»¥è®¡ç®—ä¸¤ä¸ªèŠ‚ç‚¹ $\{u, v\}$ åœ¨ç»™å®šçš„æœ‰æ ¹æ ‘ $T$ ä¸Šè·ç¦»ã€Œæˆä¸ºç¥–å…ˆå…³ç³»ã€æœ‰å¤šè¿‘ã€‚å¾ˆæ˜¾ç„¶çš„ï¼Œå½“ $u, v$ äº’ä¸ºç¥–å…ˆå…³ç³»æ—¶ï¼Œä»–ä»¬çš„ã€Œç¥–å…ˆå…³ç³»è·ç¦»ã€å³ä¸º $0$ï¼›è€Œå½“ $u, v$ äº’ä¸ä¸ºç¥–å…ˆå…³ç³»æ—¶ï¼Œä»–ä»¬çš„ç¥–å…ˆå…³ç³»è·ç¦»è¢«å®šä¹‰æˆã€Œæœ€å°‘çš„ç§»åŠ¨æ­¥æ•°ä½¿å¾— $u, v$ äº’ä¸ºç¥–å…ˆå…³ç³»ã€ï¼Œç™½è¯åœ°è¯´ï¼Œæˆ‘ä»¬å¯ä»¥æƒ³è±¡æœ‰ä¸¤é¢—æ£‹å­åˆ†åˆ«æ‘†åœ¨èŠ‚ç‚¹ $u$ å’Œ $v$ ä¸Šï¼Œæ¯ä¸€æ­¥ç§»åŠ¨éƒ½å¯ä»¥æŠŠä¸€é¢—æ£‹å­ç§»åŠ¨åˆ°æ‰€åœ¨èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ä¸Šï¼Œè€Œç¥–å…ˆå…³ç³»è·ç¦»å³æ˜¯æœ€å°‘çš„æ£‹å­ç§»åŠ¨æ¬¡æ•°ä½¿å¾—ä¸¤é¢—æ£‹å­èƒ½è½åœ¨äº’ä¸ºç¥–å…ˆå…³ç³»çš„èŠ‚ç‚¹å¯¹ä¸Šã€‚

è¦è®¡ç®— $u, v$ åœ¨ $T$ ä¸Šçš„ç¥–å…ˆå…³ç³»è·ç¦» $d_T(u, v)$ å…¶å®å¾ˆå•çº¯ï¼šå…ˆæ‰¾å‡º $u, v$ åœ¨ $T$ ä¸Šçš„ã€Œæœ€è¿‘å…¬å…±ç¥–å…ˆã€$\textrm{lca}(u, v)$ï¼Œå¹¶å– $u$ å’Œ $v$ åˆ†åˆ«å¾€ä¸Šç§»åŠ¨åˆ° $\textrm{lca}(u, v)$ çš„æ­¥æ•°ä¸­æœ€å°çš„é‚£ä¸ªå³å¯ã€‚

æœ‰äº†ç¥–å…ˆå…³ç³»è·ç¦»çš„å®šä¹‰ï¼Œå°æ˜å’Œå°èŠ±çš„è·ç¦»å‡½æ•°ç»ˆäºèƒ½å¤Ÿå®Œæ•´åœ°å®šä¹‰æ¸…æ¥šï¼š

- é¦–å…ˆå†³å®šå¥½ä¸€ä¸ªè¯¯å·®å‚æ•° $k$ï¼Œä»¥åŠéœ€è¦è®¡ç®—è·ç¦»çš„ä¸¤æ£µæœ‰æ ¹æ ‘ $S, T$ã€‚
- å½“ä¸€å¯¹èŠ‚ç‚¹å¯¹ $\{u, v\}$ æ»¡è¶³ä»–ä»¬åœ¨å…¶ä¸­ä¸€æ£µæ ‘äº’ä¸ºç¥–å…ˆå…³ç³»ã€å¦ä¸€æ£µçš„ç¥–å…ˆå…³ç³»è·ç¦»å¤§äº $k$ æ—¶ï¼Œè¯¥èŠ‚ç‚¹å¯¹å°±è¢«è§†ä¸ºæ˜¯æœ‰å·®å¼‚çš„èŠ‚ç‚¹å¯¹ã€‚
    - ä¹Ÿå°±æ˜¯è¯´ï¼Œã€Œ$d_S(u, v) = 0$ ä¸” $d_T(u, v)>k$ã€æˆ–ã€Œ$d_T(u, v) = 0$ ä¸” $d_S(u, v) > k$ã€ã€‚
- è€ƒè™‘æ‰€æœ‰ $\frac{N\times (N - 1)}{2}$ ç»„èŠ‚ç‚¹å¯¹ï¼Œæœ‰å·®å¼‚çš„èŠ‚ç‚¹å¯¹æ•°é‡å³æ˜¯ $S, T$ çš„è·ç¦»å‡½æ•°å€¼ã€‚

![](https://cdn.luogu.com.cn/upload/image_hosting/5uztead1.png)

ä¸Šå›¾ä¸ºèŒƒä¾‹æµ‹è¯•æ•°æ®ä¸€å’ŒäºŒæ‰€ç»™å®šçš„ä¸¤æ£µæœ‰æ ¹æ ‘ï¼Œå·¦è¾¹çš„æ ‘ä»¥èŠ‚ç‚¹ $1$ ä¸ºæ ¹ã€å³è¾¹çš„æ ‘ä»¥èŠ‚ç‚¹ $5$ ä¸ºæ ¹ã€‚ä»¥èŠ‚ç‚¹å¯¹ $\{2, 5\}$ ä¸ºä¾‹ï¼Œæˆ‘ä»¬å¯çŸ¥åœ¨å·¦æ ‘ $\textrm{lca}(2, 5)=1$ï¼ŒèŠ‚ç‚¹ $5$ ç§»åŠ¨åˆ°èŠ‚ç‚¹ $1$ éœ€è¦ä¸¤æ­¥ï¼Œä½†èŠ‚ç‚¹ $2$ ç§»åŠ¨åˆ°èŠ‚ç‚¹ $1$ åªéœ€è¦ä¸€æ­¥ï¼Œå› æ­¤ä»–ä»¬åœ¨å·¦æ ‘çš„ç¥–å…ˆå…³ç³»è·ç¦»ä¸º $1$ã€‚æ³¨æ„åˆ°å› ä¸ºèŠ‚ç‚¹å¯¹ $\{2, 5\}$ åœ¨å³æ ‘äº’ä¸ºç¥–å…ˆå…³ç³»ï¼Œå½“ $k=0$ æ—¶ï¼ŒèŠ‚ç‚¹å¯¹ $\{2, 5\}$ ä¼šè¢«è§†ä¸ºæœ‰å·®å¼‚çš„èŠ‚ç‚¹å¯¹ï¼ŒåŒç†ï¼ŒèŠ‚ç‚¹å¯¹ $\{2, 4\}$ ä»¥åŠ $\{4, 5\}$ éƒ½æ˜¯æœ‰å·®å¼‚çš„èŠ‚ç‚¹å¯¹ï¼Œå› æ­¤ï¼Œä¸Šå›¾ä¸­çš„ä¸¤æ£µæ ‘åœ¨ $k=0$ æ—¶çš„è·ç¦»å‡½æ•°å€¼ä¸º $3$ï¼›è€Œå½“ $k=1$ æ—¶ï¼Œåªæœ‰ $\{4, 5\}$ å› åœ¨å·¦æ ‘çš„ç¥–å…ˆå…³ç³»è·ç¦»ä¸º $2$ ä¼šè¢«è§†ä¸ºæœ‰å·®å¼‚çš„èŠ‚ç‚¹å¯¹ï¼Œè·ç¦»å‡½æ•°å€¼ä»…ä¸º $1$ã€‚

è¯·ä½ ç¼–å†™ä¸€ä¸ªç¨‹åºï¼Œå¸®åŠ©å°æ˜å’Œå°èŠ±è®¡ç®—ç»™å®šçš„ä¸¤æ£µæœ‰æ ¹æ ‘åœ¨è¯¯å·®å‚æ•°ä¸º $k$ æ—¶çš„è·ç¦»å‡½æ•°å€¼ã€‚

## è¯´æ˜/æç¤º

### æµ‹è¯•æ•°æ®é™åˆ¶

* $1 \le n \le 2\times 10^5$ã€‚
* $0 \le k < n$ã€‚
* $0 \le p_i, q_i \le n$ã€‚
* ä¿è¯å­˜åœ¨å”¯ä¸€ä¸€ä¸ª $u$ æ»¡è¶³ $p_u = 0$ï¼Œä¸”åºåˆ— $p$ å½¢æˆä¸€ä¸ªä»¥ $u$ ä¸ºæ ¹çš„æœ‰æ ¹æ ‘ã€‚
* ä¿è¯å­˜åœ¨å”¯ä¸€ä¸€ä¸ª $v$ æ»¡è¶³ $q_v = 0$ï¼Œä¸”åºåˆ— $q$ å½¢æˆä¸€ä¸ªä»¥ $v$ ä¸ºæ ¹çš„æœ‰æ ¹æ ‘ã€‚
* è¾“å…¥çš„æ•°å‡ä¸ºæ•´æ•°ã€‚

### è¯„åˆ†è¯´æ˜

æœ¬é¢˜å…±æœ‰äº”ç»„å­ä»»åŠ¡ï¼Œæ¡ä»¶é™åˆ¶å¦‚ä¸‹æ‰€ç¤ºã€‚
æ¯ä¸€ç»„å¯æœ‰ä¸€æˆ–å¤šç»„æµ‹è¯•æ•°æ®ï¼Œè¯¥ç»„æ‰€æœ‰æµ‹è¯•æ•°æ®çš†éœ€ç­”å¯¹æ‰ä¼šè·å¾—è¯¥ç»„åˆ†æ•°ã€‚

|  å­ä»»åŠ¡  |  åˆ†æ•°  | é¢å¤–è¾“å…¥é™åˆ¶ |
| :------: | :----: | ------------ |
| 1 | $4$ | $n \le 100$ã€‚ |
| 2 | $10$ | $n \le 3000$ã€‚ |
| 3 | $32$ | $k = 0$ã€‚ |
| 4 | $25$ | $k \le 20$ã€‚ |
| 5 | $29$ | æ— é¢å¤–é™åˆ¶ã€‚ |

## æ ·ä¾‹ #1

### è¾“å…¥

```
5 0
0 1 1 2 3
5 1 1 1 0```

### è¾“å‡º

```
3```

## æ ·ä¾‹ #2

### è¾“å…¥

```
5 1
0 1 1 2 3
5 1 1 1 0```

### è¾“å‡º

```
1```

## æ ·ä¾‹ #3

### è¾“å…¥

```
10 0
6 5 5 5 0 3 4 6 6 6
6 4 5 7 10 7 10 7 3 0```

### è¾“å‡º

```
22```

## æ ·ä¾‹ #4

### è¾“å…¥

```
10 2
0 1 2 3 4 5 6 7 8 9
8 7 6 5 0 5 4 3 2 1```

### è¾“å‡º

```
6```

# AIåˆ†æç»“æœ

# ğŸ’¡ Kayçš„C++ç®—æ³•è§£æï¼š[TOIP2024] è·ç¦»å‡½æ•° æ·±å…¥å­¦ä¹ æŒ‡å— ğŸ’¡


## 1. é¢˜ç›®è§£è¯»ä¸æ ¸å¿ƒç®—æ³•è¯†åˆ«

âœ¨ **æœ¬é¢˜ä¸»è¦è€ƒå¯Ÿ**ï¼š`ç¼–ç¨‹æŠ€å·§åº”ç”¨` (ä¾§é‡æ ‘ç»“æ„å¤„ç†ä¸æ•°æ®ç»“æ„è¿ç”¨)

ğŸ—£ï¸ **åˆæ­¥åˆ†æ**ï¼š  
è§£å†³æœ¬é¢˜çš„å…³é”®åœ¨äº**å°†å¤æ‚çš„è·ç¦»å‡½æ•°æ‹†è§£ä¸ºå¯é«˜æ•ˆè®¡ç®—çš„å­é—®é¢˜**ï¼Œæ ¸å¿ƒæ€è·¯åƒâ€œæ‹†ç§¯æœ¨â€â€”â€”æŠŠå¤§é—®é¢˜åˆ†æˆâ€œè®¡ç®—æ ‘çš„ç¥–å…ˆå¯¹æ•°â€â€œç»Ÿè®¡å…¬å…±ç¥–å…ˆå¯¹â€â€œç­›é€‰æ»¡è¶³è·ç¦»æ¡ä»¶çš„å¯¹â€ç­‰å°æ¨¡å—ï¼Œå†ç”¨æ ‘éå†ã€æ—¶é—´æˆ³å’ŒFenwickæ ‘ï¼ˆæ ‘çŠ¶æ•°ç»„ï¼‰é€ä¸ªè§£å†³ã€‚  

### æ ¸å¿ƒé—®é¢˜æ‹†è§£  
æˆ‘ä»¬éœ€è¦è®¡ç®—ä¸¤æ£µæ ‘çš„â€œå·®å¼‚èŠ‚ç‚¹å¯¹â€æ•°é‡ï¼Œè¿™å¯ä»¥è½¬åŒ–ä¸ºï¼š  
1. **è®¡ç®—æ¯æ£µæ ‘çš„ç¥–å…ˆå¯¹æ•°**ï¼ˆA_Sã€A_Tï¼‰ï¼šæ¯æ£µæ ‘çš„ç¥–å…ˆå¯¹æ€»æ•°ç­‰äºæ‰€æœ‰èŠ‚ç‚¹çš„æ·±åº¦ä¹‹å’Œï¼ˆæ¯ä¸ªèŠ‚ç‚¹æœ‰`depth`ä¸ªç¥–å…ˆï¼Œæ€»å’Œå³ä¸ºæ— åºå¯¹æ•°é‡ï¼‰ã€‚  
2. **è®¡ç®—å…¬å…±ç¥–å…ˆå¯¹æ•°é‡**ï¼ˆD_STã€D_TSï¼‰ï¼šSçš„ç¥–å…ˆå¯¹ä¸­åŒæ—¶æ˜¯Tçš„ç¥–å…ˆå¯¹çš„æ•°é‡ï¼ˆç”¨DFSæ—¶é—´æˆ³+Fenwickæ ‘å¿«é€Ÿç»Ÿè®¡ï¼‰ã€‚  
3. **è®¡ç®—æ»¡è¶³è·ç¦»æ¡ä»¶çš„éå…¬å…±ç¥–å…ˆå¯¹æ•°é‡**ï¼ˆE_STã€E_TSï¼‰ï¼šSçš„ç¥–å…ˆå¯¹ä¸­ä¸åœ¨Tçš„ç¥–å…ˆå¯¹é‡Œï¼Œä½†åœ¨Tä¸­çš„è·ç¦»â‰¤kçš„æ•°é‡ï¼ˆéœ€ç»“åˆLCAå’Œkçº§ç¥–å…ˆé¢„å¤„ç†ï¼‰ã€‚  

æœ€ç»ˆç»“æœ = (A_S - (D_ST+E_ST)) + (A_T - (D_TS+E_TS))ã€‚  

### å¯è§†åŒ–è®¾è®¡æ€è·¯  
æˆ‘ä»¬ç”¨**8ä½åƒç´ é£**å±•ç¤ºä¸¤æ£µæ ‘çš„ç»“æ„ï¼ˆæ¯”å¦‚Sæ ‘ç”¨è“è‰²ã€Tæ ‘ç”¨çº¢è‰²ï¼‰ï¼Œç”¨åŠ¨ç”»æ¼”ç¤ºï¼š  
- DFSéå†æ ‘Sæ—¶ï¼ŒFenwickæ ‘åŠ¨æ€ç»´æŠ¤Tæ ‘çš„`in`æ—¶é—´æˆ³ï¼ˆç”¨é—ªçƒçš„åƒç´ å—æ ‡è®°æ›´æ–°ä½ç½®ï¼‰ï¼›  
- æŸ¥è¯¢å…¬å…±ç¥–å…ˆå¯¹æ—¶ï¼Œé«˜äº®åŒºé—´å†…çš„åƒç´ å—ï¼Œä¼´éšâ€œå®â€çš„éŸ³æ•ˆï¼›  
- å®Œæˆè®¡ç®—åï¼Œç”¨â€œèƒœåˆ©â€éŸ³æ•ˆå’Œåƒç´ çƒŸèŠ±å±•ç¤ºç»“æœã€‚  


## 2. ç²¾é€‰ä¼˜è´¨é¢˜è§£å‚è€ƒ  
å½“å‰æš‚æ— å…¬å¼€é¢˜è§£ï¼Œä½†æˆ‘ä»¬å¯ä»¥åŸºäºé—®é¢˜åˆ†æç»™å‡º**é€šç”¨è§£é¢˜æ¡†æ¶**ï¼ˆè§ç¬¬4èŠ‚ä»£ç ï¼‰ï¼Œæ ¸å¿ƒæ€è·¯æ˜¯â€œæ‹†è§£é—®é¢˜+é«˜æ•ˆç»Ÿè®¡â€ï¼Œé€‚ç”¨äºæ‰€æœ‰æµ‹è¯•ç”¨ä¾‹ã€‚  


## 3. æ ¸å¿ƒéš¾ç‚¹è¾¨æä¸è§£é¢˜ç­–ç•¥  

### å…³é”®ç‚¹1ï¼šå¦‚ä½•é«˜æ•ˆè®¡ç®—å…¬å…±ç¥–å…ˆå¯¹ï¼Ÿ  
**éš¾ç‚¹**ï¼šç›´æ¥æšä¸¾æ‰€æœ‰ç¥–å…ˆå¯¹ä¼šè¶…æ—¶ï¼ˆO(nÂ²)ï¼‰ã€‚  
**è§£å†³ç­–ç•¥**ï¼š  
ç”¨DFSç»™æ ‘çš„èŠ‚ç‚¹æ‰“`in`/`out`æ—¶é—´æˆ³ï¼ˆè¿›å…¥èŠ‚ç‚¹çš„æ—¶é—´å’Œç¦»å¼€èŠ‚ç‚¹çš„æ—¶é—´ï¼‰ï¼Œè¿™æ ·åˆ¤æ–­â€œuæ˜¯vçš„ç¥–å…ˆâ€ç­‰ä»·äº`in[u] â‰¤ in[v] â‰¤ out[u]`ã€‚å†ç”¨Fenwickæ ‘ç»´æŠ¤å½“å‰è·¯å¾„ä¸Šçš„èŠ‚ç‚¹ï¼Œå¿«é€ŸæŸ¥è¯¢åŒºé—´å†…çš„èŠ‚ç‚¹æ•°ï¼ˆå³å…¬å…±ç¥–å…ˆå¯¹æ•°é‡ï¼‰ã€‚  

ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šæ—¶é—´æˆ³æ˜¯æ ‘ç»“æ„å¤„ç†çš„â€œé­”æ³•æ ‡è®°â€ï¼Œèƒ½æŠŠç¥–å…ˆå…³ç³»è½¬åŒ–ä¸ºåŒºé—´é—®é¢˜ã€‚  


### å…³é”®ç‚¹2ï¼šå¦‚ä½•å¤„ç†éå…¬å…±ç¥–å…ˆå¯¹çš„è·ç¦»æ¡ä»¶ï¼Ÿ  
**éš¾ç‚¹**ï¼šéå…¬å…±ç¥–å…ˆå¯¹çš„è·ç¦»åˆ¤æ–­éœ€è¦LCAå’Œkçº§ç¥–å…ˆæŸ¥è¯¢ï¼Œç›´æ¥è®¡ç®—ä¼šè¶…æ—¶ã€‚  
**è§£å†³ç­–ç•¥**ï¼š  
é¢„å¤„ç†æ¯ä¸ªèŠ‚ç‚¹çš„kçº§ç¥–å…ˆï¼ˆç”¨äºŒè¿›åˆ¶è·³è·ƒæ³•ï¼‰ï¼Œç„¶ååœ¨DFSéå†æ ‘Sæ—¶ï¼Œç”¨Fenwickæ ‘ç»Ÿè®¡â€œuåœ¨Tçš„kçº§ç¥–å…ˆå­æ ‘ä¸­â€æˆ–â€œvåœ¨Tçš„kçº§ç¥–å…ˆå­æ ‘ä¸­â€çš„æ•°é‡ï¼Œæ’é™¤å·²è®¡å…¥å…¬å…±ç¥–å…ˆå¯¹çš„æƒ…å†µã€‚  

ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šäºŒè¿›åˆ¶è·³è·ƒæ³•æ˜¯æŸ¥è¯¢kçº§ç¥–å…ˆçš„â€œæ·å¾„â€ï¼Œèƒ½æŠŠæŸ¥è¯¢æ—¶é—´ä»O(n)é™åˆ°O(log n)ã€‚  


### å…³é”®ç‚¹3ï¼šå¦‚ä½•é¿å…é‡å¤è®¡ç®—ï¼Ÿ  
**éš¾ç‚¹**ï¼šå·®å¼‚èŠ‚ç‚¹å¯¹çš„æ¡ä»¶æ˜¯â€œäº’æ–¥â€çš„ï¼ˆè¦ä¹ˆSæ˜¯ç¥–å…ˆå¯¹ä¸”Tè·ç¦»>kï¼Œè¦ä¹ˆåä¹‹ï¼‰ï¼Œéœ€ç¡®ä¿ä¸é‡å¤ç»Ÿè®¡ã€‚  
**è§£å†³ç­–ç•¥**ï¼š  
ç”¨â€œæ€»æ•°å‡ç¬¦åˆæ¡ä»¶æ•°â€çš„æ€è·¯ï¼šæ¯”å¦‚Sçš„å·®å¼‚å¯¹ = Sçš„ç¥–å…ˆå¯¹æ€»æ•° - Sä¸­æ»¡è¶³Tè·ç¦»â‰¤kçš„å¯¹ï¼ˆåŒ…æ‹¬å…¬å…±ç¥–å…ˆå¯¹å’Œéå…¬å…±ä½†è·ç¦»â‰¤kçš„å¯¹ï¼‰ã€‚  

ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šâ€œé€†å‘æ€ç»´â€æ˜¯å¤„ç†è®¡æ•°é—®é¢˜çš„å¸¸ç”¨æŠ€å·§ï¼Œèƒ½é¿å…å¤æ‚çš„æ¡ä»¶åˆ¤æ–­ã€‚  


### âœ¨ è§£é¢˜æŠ€å·§æ€»ç»“  
- **æ ‘éå†æŠ€å·§**ï¼šç”¨DFSè®¡ç®—æ·±åº¦å’Œæ—¶é—´æˆ³ï¼Œæ˜¯æ ‘ç»“æ„å¤„ç†çš„åŸºç¡€ã€‚  
- **æ•°æ®ç»“æ„é€‰æ‹©**ï¼šFenwickæ ‘é€‚åˆå¿«é€Ÿç»´æŠ¤å‰ç¼€å’Œä¸åŒºé—´æŸ¥è¯¢ï¼Œæ˜¯ç»Ÿè®¡å…¬å…±ç¥–å…ˆå¯¹çš„å…³é”®ã€‚  
- **é—®é¢˜æ‹†è§£**ï¼šæŠŠå¤§é—®é¢˜æ‹†æˆå°æ¨¡å—ï¼Œæ¯ä¸ªæ¨¡å—ç”¨é’ˆå¯¹æ€§çš„ç®—æ³•è§£å†³ã€‚  


## 4. C++æ ¸å¿ƒä»£ç å®ç°èµæ  

### æœ¬é¢˜é€šç”¨æ ¸å¿ƒC++å®ç°å‚è€ƒ  
* **è¯´æ˜**ï¼šæœ¬ä»£ç å®ç°äº†â€œè®¡ç®—ç¥–å…ˆå¯¹æ•°â€â€œç»Ÿè®¡å…¬å…±ç¥–å…ˆå¯¹â€çš„æ ¸å¿ƒé€»è¾‘ï¼ŒE_ST/E_TSéƒ¨åˆ†éœ€æ ¹æ®kå€¼è¡¥å……kçº§ç¥–å…ˆé¢„å¤„ç†ã€‚  

```cpp
#include <iostream>
#include <vector>
#include <functional>
using namespace std;

const int MAXN = 2e5 + 5;

vector<int> adj_S[MAXN], adj_T[MAXN];
int depth_S[MAXN], depth_T[MAXN];
int in_S[MAXN], out_S[MAXN], time_S;
int in_T[MAXN], out_T[MAXN], time_T;

// Fenwick Tree (æ ‘çŠ¶æ•°ç»„ï¼Œç”¨äºåŒºé—´æŸ¥è¯¢å’Œå•ç‚¹æ›´æ–°)
struct FenwickTree {
    vector<int> tree;
    int n;
    FenwickTree(int size) : n(size), tree(size + 2, 0) {}
    void update(int idx, int delta) {
        for (; idx <= n; idx += idx & -idx)
            tree[idx] += delta;
    }
    int query(int idx) {
        int res = 0;
        for (; idx > 0; idx -= idx & -idx)
            res += tree[idx];
        return res;
    }
    int range_query(int l, int r) {
        return query(r) - query(l - 1);
    }
};

// DFSè®¡ç®—æ ‘Sçš„æ·±åº¦å’Œin/outæ—¶é—´æˆ³
void dfs_S(int u, int parent) {
    in_S[u] = ++time_S;
    for (int v : adj_S[u]) {
        if (v == parent) continue;
        depth_S[v] = depth_S[u] + 1;
        dfs_S(v, u);
    }
    out_S[u] = time_S;
}

// DFSè®¡ç®—æ ‘Tçš„æ·±åº¦å’Œin/outæ—¶é—´æˆ³
void dfs_T(int u, int parent) {
    in_T[u] = ++time_T;
    for (int v : adj_T[u]) {
        if (v == parent) continue;
        depth_T[v] = depth_T[u] + 1;
        dfs_T(v, u);
    }
    out_T[u] = time_T;
}

// è®¡ç®—Sçš„ç¥–å…ˆå¯¹ä¸­åŒæ—¶æ˜¯Tçš„ç¥–å…ˆå¯¹çš„æ•°é‡ï¼ˆD_STï¼‰
long long compute_D_ST(int root_S) {
    FenwickTree ft(time_T);
    long long res = 0;
    function<void(int, int)> dfs = [&](int u, int parent) {
        // æŸ¥è¯¢Tä¸­uçš„ç¥–å…ˆæ•°é‡ï¼ˆin_T[u]åˆ°out_T[u]çš„åŒºé—´å’Œï¼‰
        res += ft.range_query(in_T[u], out_T[u]);
        // å°†å½“å‰èŠ‚ç‚¹çš„in_TåŠ å…¥æ ‘çŠ¶æ•°ç»„ï¼ˆæ ‡è®°ä¸ºå·²è®¿é—®ï¼‰
        ft.update(in_T[u], 1);
        for (int v : adj_S[u]) {
            if (v == parent) continue;
            dfs(v, u);
        }
        // å›æº¯ï¼šç§»é™¤å½“å‰èŠ‚ç‚¹çš„in_Tï¼ˆæ¢å¤æ ‘çŠ¶æ•°ç»„ï¼‰
        ft.update(in_T[u], -1);
    };
    dfs(root_S, 0);
    return res;
}

// è®¡ç®—Tçš„ç¥–å…ˆå¯¹ä¸­åŒæ—¶æ˜¯Sçš„ç¥–å…ˆå¯¹çš„æ•°é‡ï¼ˆD_TSï¼‰
long long compute_D_TS(int root_T) {
    FenwickTree ft(time_S);
    long long res = 0;
    function<void(int, int)> dfs = [&](int u, int parent) {
        res += ft.range_query(in_S[u], out_S[u]);
        ft.update(in_S[u], 1);
        for (int v : adj_T[u]) {
            if (v == parent) continue;
            dfs(v, u);
        }
        ft.update(in_S[u], -1);
    };
    dfs(root_T, 0);
    return res;
}

int main() {
    int n, k;
    cin >> n >> k;

    // è¯»å–æ ‘Sçš„çˆ¶èŠ‚ç‚¹æ•°ç»„ï¼ˆp_iï¼‰
    int root_S = 0;
    for (int i = 1; i <= n; ++i) {
        int p;
        cin >> p;
        if (p == 0) root_S = i;
        else adj_S[p].push_back(i);
    }

    // è¯»å–æ ‘Tçš„çˆ¶èŠ‚ç‚¹æ•°ç»„ï¼ˆq_iï¼‰
    int root_T = 0;
    for (int i = 1; i <= n; ++i) {
        int q;
        cin >> q;
        if (q == 0) root_T = i;
        else adj_T[q].push_back(i);
    }

    // è®¡ç®—æ ‘Sçš„æ·±åº¦å’Œæ—¶é—´æˆ³
    time_S = 0;
    depth_S[root_S] = 0;
    dfs_S(root_S, 0);

    // è®¡ç®—æ ‘Tçš„æ·±åº¦å’Œæ—¶é—´æˆ³
    time_T = 0;
    depth_T[root_T] = 0;
    dfs_T(root_T, 0);

    // è®¡ç®—A_Sï¼ˆæ ‘Sçš„ç¥–å…ˆå¯¹æ•°ï¼‰å’ŒA_Tï¼ˆæ ‘Tçš„ç¥–å…ˆå¯¹æ•°ï¼‰
    long long A_S = 0, A_T = 0;
    for (int i = 1; i <= n; ++i) {
        A_S += depth_S[i];
        A_T += depth_T[i];
    }

    // è®¡ç®—D_STå’ŒD_TS
    long long D_ST = compute_D_ST(root_S);
    long long D_TS = compute_D_TS(root_T);

    // TODOï¼šè®¡ç®—E_STå’ŒE_TSï¼ˆéœ€è¡¥å……kçº§ç¥–å…ˆé¢„å¤„ç†ï¼‰
    long long E_ST = 0, E_TS = 0;

    // æœ€ç»ˆç»“æœ
    long long result = (A_S - (D_ST + E_ST)) + (A_T - (D_TS + E_TS));
    cout << result << endl;

    return 0;
}
```

* **ä»£ç è§£è¯»æ¦‚è¦**ï¼š  
ä»£ç åˆ†ä¸ºå››ä¸ªéƒ¨åˆ†ï¼š  
1. **æ ‘ç»“æ„æ„å»º**ï¼šè¯»å–è¾“å…¥å¹¶æ„å»ºä¸¤æ£µæ ‘çš„é‚»æ¥è¡¨ï¼›  
2. **DFSéå†**ï¼šè®¡ç®—èŠ‚ç‚¹çš„æ·±åº¦å’Œ`in`/`out`æ—¶é—´æˆ³ï¼›  
3. **å…¬å…±ç¥–å…ˆå¯¹ç»Ÿè®¡**ï¼šç”¨Fenwickæ ‘ç»´æŠ¤å½“å‰è·¯å¾„ï¼ŒæŸ¥è¯¢åŒºé—´å’Œå¾—åˆ°å…¬å…±ç¥–å…ˆå¯¹æ•°é‡ï¼›  
4. **ç»“æœè®¡ç®—**ï¼šæ•´åˆå„éƒ¨åˆ†ç»“æœå¾—åˆ°æœ€ç»ˆç­”æ¡ˆã€‚  


## 5. ç®—æ³•å¯è§†åŒ–ï¼šåƒç´ åŠ¨ç”»æ¼”ç¤º  

### åŠ¨ç”»ä¸»é¢˜  
**â€œåƒç´ æ ‘æ¢é™©å®¶â€**ï¼šç”¨8ä½åƒç´ é£æ ¼å±•ç¤ºä¸¤æ£µæ ‘ï¼Œæ¨¡æ‹Ÿâ€œç»Ÿè®¡å…¬å…±ç¥–å…ˆå¯¹â€çš„è¿‡ç¨‹ï¼Œèå…¥å¤å¤æ¸¸æˆå…ƒç´ ã€‚  

### è®¾è®¡æ€è·¯  
é‡‡ç”¨FCæ¸¸æˆçš„å¤å¤é£æ ¼ï¼Œç”¨åƒç´ å—è¡¨ç¤ºèŠ‚ç‚¹ï¼ˆSæ ‘è“è‰²ã€Tæ ‘çº¢è‰²ï¼‰ï¼Œç”¨åŠ¨ç”»æ¼”ç¤ºDFSéå†å’ŒFenwickæ ‘æ“ä½œï¼Œå¢å¼ºè®°å¿†ç‚¹ï¼š  
- **éŸ³æ•ˆ**ï¼šæŸ¥è¯¢æ—¶æ’­æ”¾â€œå®â€å£°ï¼Œæ›´æ–°Fenwickæ ‘æ—¶æ’­æ”¾â€œå’”å—’â€å£°ï¼Œè®¡ç®—å®Œæˆæ—¶æ’­æ”¾â€œèƒœåˆ©â€éŸ³æ•ˆï¼›  
- **äº¤äº’**ï¼šæ”¯æŒâ€œå•æ­¥æ‰§è¡Œâ€ï¼ˆé€èŠ‚ç‚¹å±•ç¤ºDFSï¼‰ã€â€œè‡ªåŠ¨æ’­æ”¾â€ï¼ˆæ¨¡æ‹ŸAIéå†ï¼‰ï¼›  
- **é«˜äº®**ï¼šå½“å‰å¤„ç†çš„èŠ‚ç‚¹ç”¨é»„è‰²é—ªçƒï¼ŒFenwickæ ‘çš„æ›´æ–°ä½ç½®ç”¨ç»¿è‰²æ ‡è®°ã€‚  

### åŠ¨ç”»å¸§æ­¥éª¤  
1. **åˆå§‹åŒ–**ï¼šå±å¹•å·¦ä¾§å±•ç¤ºæ ‘Sï¼ˆè“è‰²èŠ‚ç‚¹ï¼‰ï¼Œå³ä¾§å±•ç¤ºæ ‘Tï¼ˆçº¢è‰²èŠ‚ç‚¹ï¼‰ï¼Œåº•éƒ¨æ˜¯Fenwickæ ‘çš„åƒç´ åŒ–ç•Œé¢ï¼›  
2. **DFSéå†æ ‘S**ï¼šè“è‰²èŠ‚ç‚¹é€ä¸ªé—ªçƒï¼ˆè¡¨ç¤ºè¿›å…¥èŠ‚ç‚¹ï¼‰ï¼ŒåŒæ—¶åœ¨Fenwickæ ‘ç•Œé¢ç”¨ç»¿è‰²å—æ ‡è®°å½“å‰èŠ‚ç‚¹çš„`in_T`å€¼ï¼›  
3. **æŸ¥è¯¢å…¬å…±ç¥–å…ˆå¯¹**ï¼šå½“è¿›å…¥èŠ‚ç‚¹væ—¶ï¼ŒFenwickæ ‘ç•Œé¢é«˜äº®`in_T[v]`åˆ°`out_T[v]`çš„åŒºé—´ï¼ˆçº¢è‰²å—ï¼‰ï¼Œå¹¶æ˜¾ç¤ºæŸ¥è¯¢ç»“æœï¼›  
4. **å›æº¯**ï¼šç¦»å¼€èŠ‚ç‚¹æ—¶ï¼ŒFenwickæ ‘ç•Œé¢çš„ç»¿è‰²å—æ¶ˆå¤±ï¼ˆæ¢å¤çŠ¶æ€ï¼‰ï¼›  
5. **ç»“æœå±•ç¤º**ï¼šè®¡ç®—å®Œæˆåï¼Œå±å¹•ä¸­å¤®å¼¹å‡ºåƒç´ çƒŸèŠ±ï¼Œæ’­æ”¾èƒœåˆ©éŸ³æ•ˆï¼Œæ˜¾ç¤ºæœ€ç»ˆç»“æœã€‚  


## 6. æ‹“å±•ç»ƒä¹ ä¸ç›¸ä¼¼é—®é¢˜æ€è€ƒ  

### é€šç”¨æ€è·¯è¿ç§»  
æœ¬é¢˜çš„æ ¸å¿ƒæŠ€å·§ï¼ˆæ ‘éå†ã€æ—¶é—´æˆ³ã€Fenwickæ ‘ï¼‰å¯ç”¨äº**æ‰€æœ‰éœ€è¦ç»Ÿè®¡æ ‘ç»“æ„ä¸­â€œæ»¡è¶³æŸç§å…³ç³»çš„èŠ‚ç‚¹å¯¹â€çš„é—®é¢˜**ï¼Œæ¯”å¦‚ï¼š  
- ç»Ÿè®¡ä¸¤æ£µæ ‘çš„å…¬å…±å­æ ‘ï¼›  
- è®¡ç®—æ ‘ä¸­è·ç¦»â‰¤kçš„èŠ‚ç‚¹å¯¹æ•°é‡ï¼›  
- ç­›é€‰æ»¡è¶³ç‰¹å®šæ¡ä»¶çš„ç¥–å…ˆ-åä»£å¯¹ã€‚  

### æ´›è°·ç»ƒä¹ æ¨è  
1. **P3379 ã€æ¨¡æ¿ã€‘æœ€è¿‘å…¬å…±ç¥–å…ˆï¼ˆLCAï¼‰**ï¼šå·©å›ºLCAçš„è®¡ç®—ï¼Œæ˜¯æœ¬é¢˜çš„åŸºç¡€ï¼›  
2. **P2912 [USACO08OCT] Pasture Walking G**ï¼šç»ƒä¹ æ ‘çš„è·ç¦»ç»Ÿè®¡ï¼Œç±»ä¼¼æœ¬é¢˜çš„â€œç¥–å…ˆå…³ç³»è·ç¦»â€ï¼›  
3. **P3128 [USACO15DEC] Maximum Flow P**ï¼šå­¦ä¹ æ ‘é“¾å‰–åˆ†ï¼Œæå‡æ ‘ç»“æ„å¤„ç†èƒ½åŠ›ã€‚  


## 7. å­¦ä¹ å¿ƒå¾—ä¸ç»éªŒåˆ†äº« (è‹¥æœ‰)  
å½“å‰æš‚æ— å…¬å¼€é¢˜è§£çš„ä½œè€…å¿ƒå¾—ï¼Œä½†Kayæƒ³æé†’å¤§å®¶ï¼š  
**æ ‘ç»“æ„çš„é—®é¢˜ï¼Œ90%å¯ä»¥ç”¨DFS+æ—¶é—´æˆ³è§£å†³**â€”â€”æ—¶é—´æˆ³èƒ½æŠŠâ€œç¥–å…ˆå…³ç³»â€è½¬åŒ–ä¸ºâ€œåŒºé—´é—®é¢˜â€ï¼Œå†ç»“åˆFenwickæ ‘æˆ–çº¿æ®µæ ‘ï¼Œå°±èƒ½é«˜æ•ˆç»Ÿè®¡ã€‚é‡åˆ°å¤æ‚é—®é¢˜æ—¶ï¼Œå…ˆå°è¯•â€œæ‹†ç§¯æœ¨â€ï¼ŒæŠŠå¤§é—®é¢˜åˆ†æˆå°æ¨¡å—ï¼Œé€ä¸ªå‡»ç ´ï¼  


## 8. æ€»ç»“  
æœ¬æ¬¡åˆ†æè®©æˆ‘ä»¬æŒæ¡äº†**æ ‘ç»“æ„å¤„ç†çš„æ ¸å¿ƒæŠ€å·§**ï¼šDFSéå†ã€æ—¶é—´æˆ³æ ‡è®°ã€Fenwickæ ‘ç»Ÿè®¡ã€‚è®°ä½ï¼Œç¼–ç¨‹çš„æœ¬è´¨æ˜¯â€œè§£å†³é—®é¢˜â€â€”â€”å¤æ‚çš„é—®é¢˜ï¼Œæ‹†å¼€æ¥å°±ç®€å•äº†ï¼  

ä¸‹æ¬¡æˆ‘ä»¬å†ä¸€èµ·æ¢ç´¢æ›´æœ‰è¶£çš„æ ‘é—®é¢˜ï¼ŒåŠ æ²¹ï¼ğŸ’ª

---
å¤„ç†ç”¨æ—¶ï¼š281.74ç§’
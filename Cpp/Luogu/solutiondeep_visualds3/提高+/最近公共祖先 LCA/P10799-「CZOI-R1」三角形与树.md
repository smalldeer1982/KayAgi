# é¢˜ç›®ä¿¡æ¯

# ã€ŒCZOI-R1ã€ä¸‰è§’å½¢ä¸æ ‘

## é¢˜ç›®èƒŒæ™¯

CaiZi è®¨åŒä¸‰è§’å½¢ï¼Œä½†æ˜¯ä»–å–œæ¬¢æ ‘ã€‚

2024.8.15 Updateï¼šå¢åŠ äº†ä¸€ç»„ hack æ•°æ®ã€‚

## é¢˜ç›®æè¿°

ç»™å®šä¸€é¢—æœ‰ $n$ ä¸ªç‚¹çš„æ ‘ï¼ŒèŠ‚ç‚¹ç¼–å·ä¸º $1\sim n$ï¼Œæ¯ä¸ªç‚¹æœ‰ç‚¹æƒï¼Œå¼€å§‹æ—¶ç‚¹ $i$ çš„ç‚¹æƒä¸º $a_i$ã€‚å…±æœ‰ $q$ æ¬¡æ“ä½œã€‚
1. å°†ç‚¹ $x$ åˆ°ç‚¹ $y$ çš„ç®€å•è·¯å¾„ä¸Šçš„ç‚¹çš„ç‚¹æƒ**å¼‚æˆ–** $k$ã€‚
1. åˆ¤æ–­èƒ½å¦åœ¨ç‚¹ $x$ åˆ°ç‚¹ $y$ çš„ç®€å•è·¯å¾„ä¸Šé€‰ $3$ ä¸ª**ä¸åŒç‚¹**ï¼Œå¹¶ä»¥è¿™ $3$ ä¸ªç‚¹çš„ç‚¹æƒä¸ºè¾¹é•¿æ„æˆ**ä¸‰è§’å½¢**ã€‚ç‰¹åˆ«çš„ï¼Œå¦‚æœæ— æ³•é€‰å‡º $3$ ä¸ªç‚¹ï¼Œä¹Ÿè§†ä¸ºä¸èƒ½æ„æˆ**ä¸‰è§’å½¢**ã€‚

ç‚¹ $x$ åˆ°ç‚¹ $y$ çš„ç®€å•è·¯å¾„ï¼šç‚¹ $x$ åˆ°ç‚¹ $y$ ä¸é‡å¤èµ°è¿‡ä»»ä½•ä¸€æ¡è¾¹çš„è·¯å¾„ã€‚å…¶ä¸Šçš„æ‰€æœ‰ç‚¹ä¸ºè¿™æ¡è·¯å¾„ä¸Šæ‰€æœ‰çš„ç‚¹ï¼Œ**åŒ…æ‹¬**ç‚¹ $x$ å’Œç‚¹ $y$ã€‚

**ä¿è¯ä»»ä½•æ—¶åˆ»ä¸ä¼šæœ‰ä»»ä½•ä¸€ä¸ªç‚¹çš„ç‚¹æƒä¸º $0$ã€‚**

## è¯´æ˜/æç¤º

**ã€æ ·ä¾‹è§£é‡Šã€‘**

ç¬¬ $1$ æ¬¡æ“ä½œæ—¶ç®€å•è·¯å¾„ä¸Šçš„ç‚¹æƒå°‘äº $3$ ä¸ªã€‚  
ç¬¬ $2$ æ¬¡æ“ä½œæ—¶ç®€å•è·¯å¾„ä¸Šçš„ç‚¹æƒåˆ†åˆ«ä¸º $1,2,3,4$ã€‚  
ç¬¬ $3$ æ¬¡æ“ä½œåç‚¹ $1\sim n$ çš„ç‚¹æƒåˆ†åˆ«ä¸º $5,6,7,4,1$ã€‚  
ç¬¬ $4$ æ¬¡æ“ä½œæ—¶ç®€å•è·¯å¾„ä¸Šçš„ç‚¹æƒåˆ†åˆ«ä¸º $5,6,7$ã€‚  
ç¬¬ $5$ æ¬¡æ“ä½œæ—¶ç®€å•è·¯å¾„ä¸Šçš„ç‚¹æƒåˆ†åˆ«ä¸º $1,5,6$ã€‚

**ã€æ•°æ®èŒƒå›´ã€‘**

**æœ¬é¢˜é‡‡ç”¨æ†ç»‘æµ‹è¯•**ã€‚
- Subtask #1ï¼ˆ$8\text{ pts}$ï¼‰ï¼š$n,q\le3\times10^3$ã€‚
- Subtask #2ï¼ˆ$8\text{ pts}$ï¼‰ï¼šä¿è¯è¿™æ£µæ ‘æ˜¯ä¸€æœµèŠèŠ±ã€‚
- Subtask #3ï¼ˆ$20\text{ pts}$ï¼‰ï¼šæ¯æ¬¡ä¿®æ”¹æ“ä½œæ—¶ $x=y$ã€‚
- Subtask #4ï¼ˆ$24\text{ pts}$ï¼‰ï¼šä¿è¯è¿™æ£µæ ‘æ˜¯ä¸€æ¡é“¾ã€‚
- Subtask #5ï¼ˆ$40\text{ pts}$ï¼‰ï¼šæ— ç‰¹æ®Šæ€§è´¨ã€‚**ä¾èµ– Subtask #1 åˆ° Subtask #4ã€‚**

å¯¹äº $100\%$ çš„æ•°æ®ï¼Œ$1\le u,v\le n\le10^5$ï¼Œ$1\le q\le10^5$ï¼Œ$s\in\{1,2\}$ï¼Œ$1\le a_i,w\le 2^{31}-1$ã€‚

## æ ·ä¾‹ #1

### è¾“å…¥

```
5 5
1 2 3 4 5
1 2
1 3
2 4
2 5
2 1 2
2 3 4
1 3 5 4
2 2 3
2 1 5```

### è¾“å‡º

```
0110```

# AIåˆ†æç»“æœ

# ğŸ’¡ Kayçš„C++ç®—æ³•è§£æï¼šã€ŒCZOI-R1ã€ä¸‰è§’å½¢ä¸æ ‘ æ·±å…¥å­¦ä¹ æŒ‡å— ğŸ’¡

Hi å¤§å®¶å¥½ï½ä»Šå¤©æˆ‘ä»¬è¦ä¸€èµ·è§£å†³è¿™é“ç»“åˆ**æ ‘ç»“æ„**å’Œ**ä¸‰è§’å½¢åˆ¤å®š**çš„ç¼–ç¨‹é¢˜ã€‚è¿™é“é¢˜çš„æ ¸å¿ƒæ˜¯ç”¨â€œæ ‘é“¾å‰–åˆ†/æ ‘ä¸Šå·®åˆ†â€å¤„ç†è·¯å¾„ä¿®æ”¹ï¼Œå†ç”¨â€œæ–æ³¢é‚£å¥‘æ•°åˆ—çš„å¢é•¿ç‰¹æ€§â€å¿«é€Ÿåˆ¤æ–­ä¸‰è§’å½¢æ˜¯å¦å­˜åœ¨ã€‚è®©æˆ‘ä»¬ä¸€æ­¥æ­¥æ‹†è§£å®ƒï¼


## 1. é¢˜ç›®è§£è¯»ä¸æ ¸å¿ƒç®—æ³•è¯†åˆ«

âœ¨ **æœ¬é¢˜ä¸»è¦è€ƒå¯Ÿ**ï¼šæ ‘é“¾å‰–åˆ†ï¼ˆæˆ–æ ‘ä¸Šå·®åˆ†ï¼‰+ æ–æ³¢é‚£å¥‘ç»“è®ºçš„æš´åŠ›åˆ¤å®š

ğŸ—£ï¸ **åˆæ­¥åˆ†æ**ï¼š  
ä½ å¯ä»¥æŠŠè¿™é“é¢˜æƒ³è±¡æˆâ€œç»™æ ‘ä¸Šçš„æœå­ä¸²æŸ“è‰²ï¼Œç„¶ååˆ¤æ–­æŸä¸²æœå­é‡Œæœ‰æ²¡æœ‰ä¸‰ä¸ªèƒ½ç»„æˆä¸‰è§’å½¢çš„â€ã€‚  
- **æ ‘é“¾å‰–åˆ†/å·®åˆ†**ï¼šå°±åƒæŠŠå¤§æ ‘æ‹†æˆä¸€æ ¹æ ¹â€œæœå­ä¸²â€ï¼ˆé‡é“¾ï¼‰ï¼Œè¿™æ ·ä¿®æ”¹æˆ–æŸ¥è¯¢è·¯å¾„æ—¶ï¼Œåªéœ€å¤„ç†è¿™äº›é“¾å­ï¼Œä¸ç”¨éå†æ•´ä¸ªæ ‘ï¼Œæ•ˆç‡å¾ˆé«˜ï½  
- **æ–æ³¢é‚£å¥‘ç»“è®º**ï¼šå¦‚æœä¸€ä¸²æœå­çš„é‡é‡æŒ‰ä»å°åˆ°å¤§æ’åï¼Œæ¯ä¸ªæœå­éƒ½â‰¥å‰ä¸¤ä¸ªä¹‹å’Œï¼ˆåƒæ–æ³¢é‚£å¥‘æ•°åˆ—ï¼‰ï¼Œé‚£æ°¸è¿œç»„ä¸æˆä¸‰è§’å½¢ã€‚ä½†æ–æ³¢é‚£å¥‘ç¬¬47é¡¹å°±è¶…è¿‡2Â³Â¹-1äº†ï¼æ‰€ä»¥åªè¦æœå­ä¸²é•¿åº¦â‰¥47ï¼Œ**è‚¯å®šèƒ½ç»„æˆä¸‰è§’å½¢**ï¼›å¦åˆ™æš´åŠ›æ’ä¸ªåºæ£€æŸ¥å°±è¡Œï½  

**æ ¸å¿ƒç®—æ³•æµç¨‹**ï¼š  
1. ç”¨æ ‘é“¾å‰–åˆ†æˆ–å·®åˆ†å¤„ç†â€œè·¯å¾„å¼‚æˆ–â€æ“ä½œï¼ˆç»™æŸä¸²æœå­æŸ“ä¸ªè‰²ï¼‰ï¼›  
2. å¯¹äºæŸ¥è¯¢ï¼šå…ˆç®—è·¯å¾„é•¿åº¦ï¼Œâ‰¥47ç›´æ¥è¿”å›1ï¼›å¦åˆ™æŠŠè·¯å¾„ä¸Šçš„æœå­é‡é‡å–ä¸‹æ¥ï¼Œæ’åºåæ£€æŸ¥ç›¸é‚»ä¸‰ä¸ªæ˜¯å¦æ»¡è¶³â€œä¸¤å°ä¹‹å’Œ>æœ€å¤§â€ã€‚  

**å¯è§†åŒ–è®¾è®¡æ€è·¯**ï¼š  
æˆ‘ä»¬ä¼šåšä¸€ä¸ª**åƒç´ é£çš„æ ‘æ¢é™©æ¸¸æˆ**â€”â€”æ ‘æ˜¯åƒç´ å—ç»„æˆçš„ï¼ŒèŠ‚ç‚¹æ˜¯å½©è‰²å°æ–¹å—ï¼Œè·¯å¾„ä¿®æ”¹æ—¶èŠ‚ç‚¹ä¼šé—ªçƒâ€œæŸ“è‰²â€åŠ¨ç”»ï¼›æŸ¥è¯¢æ—¶ï¼ŒçŸ­è·¯å¾„çš„èŠ‚ç‚¹ä¼šâ€œè·³â€åˆ°å±å¹•ä¸‹æ–¹æ’æˆä¸€åˆ—ï¼Œæ’åºæ—¶åƒç´ å—å·¦å³ç§»åŠ¨ï¼Œæ»¡è¶³æ¡ä»¶çš„ä¸‰ä¸ªå—ä¼šå˜çº¢å¹¶æ’­æ”¾â€œå®â€çš„éŸ³æ•ˆï½


## 2. ç²¾é€‰ä¼˜è´¨é¢˜è§£å‚è€ƒ

æˆ‘ä»æ€è·¯æ¸…æ™°åº¦ã€ä»£ç å¯è¯»æ€§å’Œæ•ˆç‡ç­‰æ–¹é¢ï¼Œç­›é€‰äº†3ä»½è¶…æ£’çš„é¢˜è§£ï¼š

### é¢˜è§£ä¸€ï¼šRegister_intçš„æ ‘ä¸Šå·®åˆ†+æ ‘çŠ¶æ•°ç»„è§£æ³•
* **æ¥æº**ï¼šç»¼åˆé¢˜è§£å†…å®¹  
* **ç‚¹è¯„**ï¼š  
  è¿™ä»½é¢˜è§£çš„æ€è·¯å¤ªå·§å¦™å•¦ï¼å®ƒæŠŠâ€œè·¯å¾„å¼‚æˆ–â€æ‹†æˆ4ä¸ªåˆ°æ ¹çš„é“¾ä¿®æ”¹ï¼ˆç”¨LCAå·®åˆ†ï¼‰ï¼Œå†ç”¨æ ‘çŠ¶æ•°ç»„ç»´æŠ¤å­æ ‘å¼‚æˆ–å’Œâ€”â€”å°±åƒç»™æ ‘çš„â€œåˆ†æ”¯â€åšæ ‡è®°ï¼ŒæŸ¥æŸä¸ªèŠ‚ç‚¹çš„é‡é‡æ—¶ï¼Œåªéœ€ç®—å®ƒå­æ ‘çš„å¼‚æˆ–æ€»å’Œï½å¯¹äºçŸ­è·¯å¾„ï¼Œç›´æ¥æš´åŠ›è·³LCAå–ç‚¹ï¼Œæ’åºåˆ¤æ–­ã€‚ä»£ç é‡Œ`modify`å’Œ`query`å‡½æ•°å†™å¾—ç‰¹åˆ«ç®€æ´ï¼Œæ—¶é—´å¤æ‚åº¦ä¹Ÿå¾ˆä½ï¼ˆO(n log n + q log n)ï¼‰ï¼Œç‰¹åˆ«é€‚åˆå­¦æ ‘ä¸Šå·®åˆ†çš„åŒå­¦å‚è€ƒï¼

### é¢˜è§£äºŒï¼šCaiZiçš„æ ‘é“¾å‰–åˆ†è§£æ³•
* **æ¥æº**ï¼šç»¼åˆé¢˜è§£å†…å®¹  
* **ç‚¹è¯„**ï¼š  
  è¿™æ˜¯æœ€ç»å…¸çš„â€œæ ‘é“¾å‰–åˆ†+çº¿æ®µæ ‘â€æ¨¡æ¿é¢˜è§£ï¼å®ƒæŠŠæ ‘æ‹†æˆé‡é“¾ï¼Œç”¨çº¿æ®µæ ‘ç»´æŠ¤é“¾ä¸Šçš„å¼‚æˆ–æ“ä½œâ€”â€”ä¿®æ”¹è·¯å¾„æ—¶ï¼Œæ²¿ç€é‡é“¾â€œè·³â€ï¼Œæ¯æ¬¡å¤„ç†ä¸€æ®µè¿ç»­çš„é“¾å­ï¼›æŸ¥è¯¢æ—¶ï¼ŒçŸ­è·¯å¾„ç›´æ¥å–æ‰€æœ‰èŠ‚ç‚¹çš„é‡é‡ã€‚ä»£ç é‡Œ`dfs1`ï¼ˆæ‰¾é‡å„¿å­ï¼‰ã€`dfs2`ï¼ˆå‰–åˆ†ï¼‰çš„é€»è¾‘ç‰¹åˆ«æ¸…æ™°ï¼Œçº¿æ®µæ ‘çš„`update`å’Œ`query`ä¹Ÿå¾ˆè§„èŒƒï¼Œé€‚åˆåˆšå­¦æ ‘é“¾å‰–åˆ†çš„åŒå­¦æ‰“åŸºç¡€ï½

### é¢˜è§£ä¸‰ï¼š0tApçš„çº¿æ®µæ ‘+æ ‘é“¾å‰–åˆ†è§£æ³•
* **æ¥æº**ï¼šç»¼åˆé¢˜è§£å†…å®¹  
* **ç‚¹è¯„**ï¼š  
  è¿™ä»½é¢˜è§£çš„äº®ç‚¹æ˜¯**çº¿æ®µæ ‘çš„æ‡’æ ‡è®°ä¼˜åŒ–**ï¼å› ä¸ºæˆ‘ä»¬åªéœ€è¦æŸ¥å¶å­èŠ‚ç‚¹çš„é‡é‡ï¼ˆç‚¹æƒï¼‰ï¼Œæ‰€ä»¥çº¿æ®µæ ‘ä¸ç”¨å†™`pushup`â€”â€”æ‡’æ ‡è®°ç›´æ¥å¼‚æˆ–åˆ°`val`å’Œ`tag`é‡Œï¼ŒèŠ‚çœäº†å¾ˆå¤šä»£ç ï½å¦å¤–ï¼Œå®ƒåœ¨æŸ¥è¯¢çŸ­è·¯å¾„æ—¶ï¼Œç”¨`for`å¾ªç¯ç›´æ¥å–é‡é“¾ä¸Šçš„èŠ‚ç‚¹ï¼Œç‰¹åˆ«ç›´è§‚ã€‚é€‚åˆæƒ³ä¼˜åŒ–çº¿æ®µæ ‘ä»£ç çš„åŒå­¦å‚è€ƒï¼


## 3. æ ¸å¿ƒéš¾ç‚¹è¾¨æä¸è§£é¢˜ç­–ç•¥

åœ¨è§£å†³è¿™é“é¢˜æ—¶ï¼Œå¤§å®¶å¸¸é‡åˆ°3ä¸ªâ€œæ‹¦è·¯è™â€ï¼Œæˆ‘å¸®å¤§å®¶æ€»ç»“äº†åº”å¯¹æ–¹æ³•ï¼š

### å…³é”®ç‚¹1ï¼šå¦‚ä½•é«˜æ•ˆå¤„ç†æ ‘ä¸Šè·¯å¾„å¼‚æˆ–ï¼Ÿ
**éš¾ç‚¹**ï¼šæ ‘çš„ç»“æ„æ˜¯ç½‘çŠ¶çš„ï¼Œç›´æ¥ä¿®æ”¹è·¯å¾„ä¼šè¶…æ—¶ã€‚  
**è§£æ³•**ï¼šç”¨**æ ‘é“¾å‰–åˆ†**æŠŠæ ‘æ‹†æˆè¿ç»­çš„é“¾ï¼ˆé‡é“¾ï¼‰ï¼Œæˆ–è€…ç”¨**æ ‘ä¸Šå·®åˆ†**æŠŠè·¯å¾„ä¿®æ”¹æ‹†æˆ4ä¸ªå•ç‚¹ä¿®æ”¹ï¼ˆLCAçš„æŠ€å·§ï¼‰ã€‚è¿™ä¸¤ç§æ–¹æ³•éƒ½èƒ½æŠŠè·¯å¾„æ“ä½œè½¬åŒ–ä¸ºâ€œåŒºé—´/å•ç‚¹æ“ä½œâ€ï¼Œç”¨æ ‘çŠ¶æ•°ç»„æˆ–çº¿æ®µæ ‘ç»´æŠ¤ã€‚

### å…³é”®ç‚¹2ï¼šå¦‚ä½•å¿«é€Ÿåˆ¤æ–­ä¸‰è§’å½¢æ˜¯å¦å­˜åœ¨ï¼Ÿ
**éš¾ç‚¹**ï¼šéå†æ‰€æœ‰ä¸‰ç‚¹ç»„åˆä¼šè¶…æ—¶ï¼ˆè·¯å¾„é•¿å¯èƒ½1e5ï¼‰ã€‚  
**è§£æ³•**ï¼šåˆ©ç”¨æ–æ³¢é‚£å¥‘çš„å¢é•¿ç‰¹æ€§â€”â€”å¦‚æœè·¯å¾„é•¿â‰¥47ï¼Œç›´æ¥è¿”å›1ï¼›å¦åˆ™æš´åŠ›å–ç‚¹æ’åºï¼Œæ£€æŸ¥ç›¸é‚»ä¸‰ä¸ªæ˜¯å¦æ»¡è¶³â€œä¸¤å°ä¹‹å’Œ>æœ€å¤§â€ï¼ˆå› ä¸ºæ’åºåï¼Œæœ€å¤§çš„æ•°å¦‚æœèƒ½è¢«å‰ä¸¤ä¸ªä¹‹å’Œè¶…è¿‡ï¼Œå°±è‚¯å®šèƒ½ç»„æˆä¸‰è§’å½¢ï¼ï¼‰ã€‚

### å…³é”®ç‚¹3ï¼šå¦‚ä½•æ­£ç¡®å–åˆ°è·¯å¾„ä¸Šçš„æ‰€æœ‰ç‚¹æƒï¼Ÿ
**éš¾ç‚¹**ï¼šæ ‘é“¾å‰–åˆ†åï¼Œè·¯å¾„å¯èƒ½è·¨å¤šä¸ªé‡é“¾ï¼Œå–ç‚¹å®¹æ˜“æ¼ã€‚  
**è§£æ³•**ï¼šå¯¹äºçŸ­è·¯å¾„ï¼ˆ<47ï¼‰ï¼Œç›´æ¥æ²¿ç€é‡é“¾â€œè·³â€ï¼ŒæŠŠæ¯ä¸ªé“¾ä¸Šçš„èŠ‚ç‚¹é‡é‡å–ä¸‹æ¥ï¼›æˆ–è€…ç”¨LCAæš´åŠ›è·³çˆ¶èŠ‚ç‚¹ï¼ŒæŠŠè·¯å¾„ä¸Šçš„ç‚¹ä¸€ä¸ªä¸€ä¸ªå–å‡ºæ¥ã€‚å› ä¸ºè·¯å¾„çŸ­ï¼Œæš´åŠ›å®Œå…¨ä¸è¶…æ—¶ï½

### âœ¨ è§£é¢˜æŠ€å·§æ€»ç»“
- **æ ‘æ“ä½œæ¨¡æ¿åŒ–**ï¼šæ ‘é“¾å‰–åˆ†ã€LCAã€æ ‘çŠ¶æ•°ç»„/çº¿æ®µæ ‘éƒ½æ˜¯â€œæ¨¡æ¿çº§â€æŠ€å·§ï¼ŒèƒŒç†Ÿäº†èƒ½è§£å†³å¾ˆå¤šæ ‘é¢˜ï¼  
- **ç»“è®ºä¼˜å…ˆ**ï¼šé‡åˆ°â€œæ˜¯å¦å­˜åœ¨â€çš„é—®é¢˜ï¼Œå…ˆæƒ³æœ‰æ²¡æœ‰æ•°å­¦ç»“è®ºï¼ˆæ¯”å¦‚æ–æ³¢é‚£å¥‘ï¼‰ï¼Œèƒ½çœå¾ˆå¤šæ—¶é—´ï½  
- **æš´åŠ›ä¸ä¸¢äºº**ï¼šå½“æ•°æ®èŒƒå›´å¾ˆå°æ—¶ï¼ˆæ¯”å¦‚<47ï¼‰ï¼Œç›´æ¥æš´åŠ›æ¯”æƒ³å¤æ‚ç®—æ³•æ›´é«˜æ•ˆï¼


## 4. C++æ ¸å¿ƒä»£ç å®ç°èµæ

### æœ¬é¢˜é€šç”¨æ ¸å¿ƒC++å®ç°å‚è€ƒï¼ˆæ ‘é“¾å‰–åˆ†+çº¿æ®µæ ‘ï¼‰
* **è¯´æ˜**ï¼šè¿™ä»½ä»£ç ç»¼åˆäº†æ ‘é“¾å‰–åˆ†çš„ç»å…¸æ¨¡æ¿å’Œæ–æ³¢é‚£å¥‘ç»“è®ºï¼Œé€»è¾‘æ¸…æ™°ï¼Œé€‚åˆå…¥é—¨ï½
* **å®Œæ•´æ ¸å¿ƒä»£ç **ï¼š
```cpp
#include <iostream>
#include <vector>
#include <algorithm>
using namespace std;

const int N = 1e5 + 10;
int n, q, a[N];
vector<int> g[N];

// æ ‘é“¾å‰–åˆ†å˜é‡
int fa[N], dep[N], siz[N], son[N], top[N], dfn[N], rnk[N], cnt;
// çº¿æ®µæ ‘å˜é‡
struct SegTree { int val, tag; } tr[N << 2];

// ç¬¬ä¸€æ­¥ï¼šæ‰¾é‡å„¿å­ï¼ˆdfs1ï¼‰
void dfs1(int u, int f) {
    fa[u] = f, dep[u] = dep[f] + 1, siz[u] = 1;
    for (int v : g[u]) {
        if (v == f) continue;
        dfs1(v, u);
        siz[u] += siz[v];
        if (siz[v] > siz[son[u]]) son[u] = v;
    }
}

// ç¬¬äºŒæ­¥ï¼šå‰–åˆ†æ ‘ï¼ˆdfs2ï¼‰
void dfs2(int u, int tp) {
    top[u] = tp, dfn[u] = ++cnt, rnk[cnt] = u;
    if (son[u]) dfs2(son[u], tp); // å…ˆå‰–é‡é“¾
    for (int v : g[u]) {
        if (v != fa[u] && v != son[u]) dfs2(v, v); // å‰–è½»é“¾
    }
}

// çº¿æ®µæ ‘ï¼šå»ºæ ‘
void build(int p, int l, int r) {
    if (l == r) { tr[p].val = a[rnk[l]]; return; }
    int mid = (l + r) >> 1;
    build(p << 1, l, mid);
    build(p << 1 | 1, mid + 1, r);
}

// çº¿æ®µæ ‘ï¼šä¸‹ä¼ æ‡’æ ‡è®°
void pushdown(int p) {
    if (tr[p].tag) {
        tr[p << 1].val ^= tr[p].tag;
        tr[p << 1].tag ^= tr[p].tag;
        tr[p << 1 | 1].val ^= tr[p].tag;
        tr[p << 1 | 1].tag ^= tr[p].tag;
        tr[p].tag = 0;
    }
}

// çº¿æ®µæ ‘ï¼šåŒºé—´å¼‚æˆ–ä¿®æ”¹
void update(int p, int l, int r, int L, int R, int k) {
    if (L <= l && r <= R) {
        tr[p].val ^= k;
        tr[p].tag ^= k;
        return;
    }
    pushdown(p);
    int mid = (l + r) >> 1;
    if (L <= mid) update(p << 1, l, mid, L, R, k);
    if (R > mid) update(p << 1 | 1, mid + 1, r, L, R, k);
}

// çº¿æ®µæ ‘ï¼šå•ç‚¹æŸ¥è¯¢ï¼ˆå–èŠ‚ç‚¹é‡é‡ï¼‰
int query(int p, int l, int r, int x) {
    if (l == r) return tr[p].val;
    pushdown(p);
    int mid = (l + r) >> 1;
    return x <= mid ? query(p << 1, l, mid, x) : query(p << 1 | 1, mid + 1, r, x);
}

// æ ‘é“¾å‰–åˆ†ï¼šè·¯å¾„ä¿®æ”¹ï¼ˆå¼‚æˆ–kï¼‰
void update_path(int u, int v, int k) {
    while (top[u] != top[v]) {
        if (dep[top[u]] < dep[top[v]]) swap(u, v);
        update(1, 1, n, dfn[top[u]], dfn[u], k);
        u = fa[top[u]];
    }
    if (dep[u] > dep[v]) swap(u, v);
    update(1, 1, n, dfn[u], dfn[v], k);
}

// æ ‘é“¾å‰–åˆ†ï¼šæŸ¥è¯¢è·¯å¾„é•¿åº¦å¹¶å–ç‚¹
bool query_path(int u, int v) {
    vector<int> vec;
    while (top[u] != top[v]) {
        if (dep[top[u]] < dep[top[v]]) swap(u, v);
        // å–å½“å‰é“¾ä¸Šçš„æ‰€æœ‰èŠ‚ç‚¹
        for (int i = dfn[top[u]]; i <= dfn[u]; i++) {
            vec.push_back(query(1, 1, n, i));
            if (vec.size() >= 47) return true;
        }
        u = fa[top[u]];
    }
    if (dep[u] > dep[v]) swap(u, v);
    // å–æœ€åä¸€æ®µé“¾ä¸Šçš„èŠ‚ç‚¹
    for (int i = dfn[u]; i <= dfn[v]; i++) {
        vec.push_back(query(1, 1, n, i));
        if (vec.size() >= 47) return true;
    }
    // æš´åŠ›æ£€æŸ¥ä¸‰è§’å½¢
    if (vec.size() < 3) return false;
    sort(vec.begin(), vec.end());
    for (int i = 2; i < vec.size(); i++) {
        if (vec[i-2] + vec[i-1] > vec[i]) return true;
    }
    return false;
}

int main() {
    cin >> n >> q;
    for (int i = 1; i <= n; i++) cin >> a[i];
    for (int i = 1; i < n; i++) {
        int u, v; cin >> u >> v;
        g[u].push_back(v);
        g[v].push_back(u);
    }
    dfs1(1, 0); // æ‰¾é‡å„¿å­
    dfs2(1, 1); // å‰–åˆ†æ ‘
    build(1, 1, n); // å»ºçº¿æ®µæ ‘
    while (q--) {
        int op, u, v, k;
        cin >> op >> u >> v;
        if (op == 1) {
            cin >> k;
            update_path(u, v, k); // è·¯å¾„å¼‚æˆ–k
        } else {
            cout << (query_path(u, v) ? '1' : '0'); // æŸ¥è¯¢ä¸‰è§’å½¢
        }
    }
    return 0;
}
```
* **ä»£ç è§£è¯»æ¦‚è¦**ï¼š  
  1. **æ ‘é“¾å‰–åˆ†**ï¼šç”¨`dfs1`æ‰¾é‡å„¿å­ï¼Œ`dfs2`æŠŠæ ‘å‰–æˆé‡é“¾ï¼Œè¿™æ ·è·¯å¾„å¯ä»¥æ‹†æˆå‡ æ®µè¿ç»­çš„åŒºé—´ï¼›  
  2. **çº¿æ®µæ ‘**ï¼šç»´æŠ¤åŒºé—´å¼‚æˆ–æ“ä½œï¼Œ`pushdown`ä¸‹ä¼ æ‡’æ ‡è®°ï¼Œ`update`ä¿®æ”¹è·¯å¾„ï¼Œ`query`æŸ¥å•ç‚¹é‡é‡ï¼›  
  3. **æŸ¥è¯¢é€»è¾‘**ï¼šå…ˆåˆ¤æ–­è·¯å¾„é•¿åº¦æ˜¯å¦â‰¥47ï¼Œæ˜¯åˆ™è¿”å›1ï¼›å¦åˆ™å–æ‰€æœ‰èŠ‚ç‚¹é‡é‡ï¼Œæ’åºåæ£€æŸ¥ç›¸é‚»ä¸‰ä¸ªæ˜¯å¦æ»¡è¶³æ¡ä»¶ã€‚


### é¢˜è§£ä¸€ï¼šRegister_intçš„æ ‘ä¸Šå·®åˆ†ç‰‡æ®µ
* **äº®ç‚¹**ï¼šç”¨æ ‘ä¸Šå·®åˆ†æŠŠè·¯å¾„ä¿®æ”¹æ‹†æˆ4ä¸ªå•ç‚¹æ“ä½œï¼Œæ ‘çŠ¶æ•°ç»„ç»´æŠ¤å­æ ‘å¼‚æˆ–ï¼Œä»£ç æ›´ç®€æ´ï¼
* **æ ¸å¿ƒä»£ç ç‰‡æ®µ**ï¼š
```cpp
// æ ‘ä¸Šå·®åˆ†ï¼šä¿®æ”¹uåˆ°vçš„è·¯å¾„å¼‚æˆ–k
void modify(int u, int v, int w) {
    int k = lca(u, v);
    add(u, w), add(v, w), add(k, w);
    if (fa[k]) add(fa[k], w); // fa[k]æ˜¯kçš„çˆ¶èŠ‚ç‚¹
}
// æ ‘çŠ¶æ•°ç»„ï¼šå•ç‚¹ä¿®æ”¹ï¼ŒåŒºé—´æŸ¥è¯¢
void add(int u, int x) {
    for (int i = in[u]; i <= n; i += i & -i) c[i] ^= x;
}
int ask(int u) {
    int res = 0;
    for (int i = out[u]; i; i &= i - 1) res ^= c[i];
    for (int i = in[u]-1; i; i &= i - 1) res ^= c[i];
    return res;
}
```
* **ä»£ç è§£è¯»**ï¼š  
  - `modify`å‡½æ•°ç”¨LCAæŠŠè·¯å¾„`uâ†’v`æ‹†æˆ`1â†’u`ã€`1â†’v`ã€`1â†’k`ã€`1â†’fa[k]`å››ä¸ªé“¾ï¼Œå¼‚æˆ–kï¼ˆå·®åˆ†æ€æƒ³ï¼šå¼‚æˆ–ä¸¤æ¬¡ç­‰äºæ²¡å¼‚æˆ–ï¼‰ï¼›  
  - `ask(u)`æŸ¥çš„æ˜¯`u`çš„å­æ ‘å¼‚æˆ–å’Œï¼ˆç”¨dfnåºçš„`in`å’Œ`out`æ ‡è®°å­æ ‘èŒƒå›´ï¼‰ï¼Œæ­£å¥½æ˜¯`u`çš„å½“å‰é‡é‡ï¼  
* **å­¦ä¹ ç¬”è®°**ï¼šæ ‘ä¸Šå·®åˆ†æ˜¯å¤„ç†è·¯å¾„ä¿®æ”¹çš„â€œå·æ‡’æŠ€å·§â€ï¼Œä¸ç”¨å‰–åˆ†æ ‘ï¼Œé€‚åˆç®€å•çš„å¼‚æˆ–æ“ä½œï½


## 5. ç®—æ³•å¯è§†åŒ–ï¼šåƒç´ åŠ¨ç”»æ¼”ç¤ºï¼ˆåƒç´ æ¢é™©å®¶æ‰¾ä¸‰è§’å½¢ï¼‰

ä¸ºäº†è®©å¤§å®¶æ›´ç›´è§‚ç†è§£ç®—æ³•ï¼Œæˆ‘è®¾è®¡äº†ä¸€ä¸ª**8ä½åƒç´ é£çš„æ ‘æ¢é™©æ¸¸æˆ**ï¼

### æ ¸å¿ƒæ¼”ç¤ºå†…å®¹
- **åœºæ™¯**ï¼šå±å¹•æ˜¯ä¸€ä¸ªåƒç´ åŒ–çš„æ ‘ï¼ˆèŠ‚ç‚¹æ˜¯å½©è‰²æ–¹å—ï¼Œè¾¹æ˜¯çº¿æ¡ï¼‰ï¼Œå³ä¸Šè§’æ˜¯â€œæ§åˆ¶é¢æ¿â€ï¼ˆå¼€å§‹/æš‚åœã€å•æ­¥ã€é€Ÿåº¦æ»‘å—ï¼‰ï¼Œå·¦ä¸‹è§’æ˜¯â€œè·¯å¾„æœå­ä¸²â€æ˜¾ç¤ºåŒºã€‚
- **åŠ¨ç”»æµç¨‹**ï¼š
  1. **åˆå§‹åŒ–**ï¼šæ ‘çš„èŠ‚ç‚¹æ˜¾ç¤ºåˆå§‹é‡é‡ï¼ŒèƒŒæ™¯æ’­æ”¾8ä½é£æ ¼çš„ã€Šè¶…çº§é©¬é‡Œå¥¥ã€‹BGMï½
  2. **è·¯å¾„ä¿®æ”¹**ï¼šç‚¹å‡»â€œä¿®æ”¹â€æŒ‰é’®ï¼Œé€‰ä¸­çš„è·¯å¾„èŠ‚ç‚¹ä¼šé—ªçƒ**è“è‰²**ï¼Œä¼´éšâ€œå®â€çš„éŸ³æ•ˆï¼ˆè¡¨ç¤ºå¼‚æˆ–æ“ä½œï¼‰ã€‚
  3. **æŸ¥è¯¢åˆ¤æ–­**ï¼šç‚¹å‡»â€œæŸ¥è¯¢â€æŒ‰é’®ï¼Œè·¯å¾„èŠ‚ç‚¹ä¼šâ€œè·³â€åˆ°å·¦ä¸‹è§’æ’æˆä¸€åˆ—ï¼ˆåƒç´ å—æ»‘åŠ¨åŠ¨ç”»ï¼‰ï¼Œæ’åºæ—¶å—ä¼šå·¦å³ç§»åŠ¨ï¼Œæ»¡è¶³æ¡ä»¶çš„ä¸‰ä¸ªå—ä¼šå˜çº¢å¹¶æ’­æ”¾â€œèƒœåˆ©éŸ³æ•ˆâ€ï¼ˆæ¯”å¦‚ã€Šå¡å°”è¾¾ã€‹çš„è§£è°œå£°ï¼‰ï¼›å¦‚æœé•¿åº¦â‰¥47ï¼Œç›´æ¥å¼¹å‡ºâ€œè‚¯å®šæœ‰ä¸‰è§’å½¢ï¼â€çš„åƒç´ æç¤ºã€‚
  4. **å…³å¡è®¾è®¡**ï¼šæ¯å¤„ç†10æ¬¡æ“ä½œç®—ä¸€ä¸ªâ€œå°å…³å¡â€ï¼Œè¿‡å…³ä¼šåŠ 10åˆ†ï¼Œè¿ç»­ç­”å¯¹3æ¬¡å¾—â€œè¿å‡»å¥–åŠ±â€ï¼ˆåˆ†æ•°Ã—2ï¼‰ï¼Œå¢åŠ æˆå°±æ„Ÿï½

### äº¤äº’ä¸æ§åˆ¶
- **æ­¥è¿›æ¨¡å¼**ï¼šç‚¹å‡»â€œå•æ­¥â€ï¼Œç®—æ³•ä¸€æ­¥æ­¥æ‰§è¡Œï¼Œæ¯æ­¥éƒ½æœ‰æ–‡å­—æç¤ºï¼ˆæ¯”å¦‚â€œæ­£åœ¨ä¿®æ”¹uâ†’vçš„è·¯å¾„â€â€œæ­£åœ¨å–èŠ‚ç‚¹é‡é‡â€ï¼‰ï¼›
- **è‡ªåŠ¨æ¨¡å¼**ï¼šç‚¹å‡»â€œAIæ¼”ç¤ºâ€ï¼Œç®—æ³•ä¼šåƒâ€œè´ªåƒè›‡AIâ€ä¸€æ ·è‡ªåŠ¨å®Œæˆæ“ä½œï¼Œé€‚åˆæ–°æ‰‹è§‚å¯Ÿæµç¨‹ï¼›
- **éŸ³æ•ˆè®¾ç½®**ï¼šå¯ä»¥é€‰æ‹©â€œå¼€å¯éŸ³æ•ˆâ€æˆ–â€œé™éŸ³â€ï¼Œå…³é”®æ“ä½œï¼ˆå¼‚æˆ–ã€æ’åºã€æ‰¾åˆ°ä¸‰è§’å½¢ï¼‰éƒ½æœ‰å¯¹åº”çš„åƒç´ éŸ³æ•ˆï½

### æŠ€æœ¯å®ç°
ç”¨**HTML+CSS+JavaScript**å†™ä¸€ä¸ªå•æ–‡ä»¶é¡µé¢ï¼š
- **Canvas**ç”»åƒç´ æ ‘å’ŒèŠ‚ç‚¹ï¼Œç”¨`requestAnimationFrame`åšåŠ¨ç”»ï¼›
- **Web Audio API**åŠ éŸ³æ•ˆï¼ˆæ¯”å¦‚ç”¨`AudioContext`ç”Ÿæˆæ­£å¼¦æ³¢æ¨¡æ‹Ÿ8ä½å£°éŸ³ï¼‰ï¼›
- ** localStorage**å­˜å…³å¡åˆ†æ•°ï¼Œä¸‹æ¬¡æ‰“å¼€è¿˜èƒ½ç»§ç»­ç©ï½


## 6. æ‹“å±•ç»ƒä¹ ä¸ç›¸ä¼¼é—®é¢˜æ€è€ƒ

### é€šç”¨æ€è·¯è¿ç§»
è¿™é“é¢˜çš„**æ–æ³¢é‚£å¥‘ç»“è®º**å¯ä»¥ç”¨åˆ°ä»»ä½•â€œåˆ¤æ–­åºåˆ—ä¸­æ˜¯å¦æœ‰ä¸‰ä¸ªæ•°èƒ½ç»„æˆä¸‰è§’å½¢â€çš„é—®é¢˜ï¼ˆæ¯”å¦‚æ•°ç»„æŸ¥è¯¢ï¼‰ï¼›**æ ‘é“¾å‰–åˆ†/å·®åˆ†**å¯ä»¥è§£å†³æ‰€æœ‰â€œæ ‘ä¸Šè·¯å¾„ä¿®æ”¹/æŸ¥è¯¢â€çš„é—®é¢˜ï¼ˆæ¯”å¦‚è·¯å¾„æ±‚å’Œã€è·¯å¾„æœ€å¤§å€¼ï¼‰ã€‚

### æ´›è°·ç»ƒä¹ æ¨è
1. **P3379 ã€æ¨¡æ¿ã€‘æœ€è¿‘å…¬å…±ç¥–å…ˆï¼ˆLCAï¼‰**ï¼šç»ƒä¼šLCAï¼Œæ‰èƒ½åšå¥½æ ‘ä¸Šå·®åˆ†å’Œå‰–åˆ†ï½
2. **P2056 [ZJOI2007] æ‰è¿·è—**ï¼šæ ‘é“¾å‰–åˆ†çš„è¿›é˜¶é¢˜ï¼Œç»ƒè·¯å¾„æŸ¥è¯¢ï¼›
3. **P1083 [NOIP2012 æé«˜ç»„] å€Ÿæ•™å®¤**ï¼šå·®åˆ†æ€æƒ³çš„ç»å…¸é¢˜ï¼Œå·©å›ºå·®åˆ†æŠ€å·§ï¼›
4. **CF1991F é¢˜**ï¼šå’Œæœ¬é¢˜å‡ ä¹ä¸€æ ·ï¼Œç»ƒæ–æ³¢é‚£å¥‘ç»“è®ºçš„åº”ç”¨ï½


## 7. å­¦ä¹ å¿ƒå¾—ä¸ç»éªŒåˆ†äº«

å¾ˆå¤šé¢˜è§£ä½œè€…æåˆ°ï¼š**ä¸è¦æ€•æš´åŠ›ï¼Œåªè¦æ•°æ®èŒƒå›´å°ï¼**æ¯”å¦‚æœ¬é¢˜ä¸­è·¯å¾„é•¿åº¦<47æ—¶ï¼Œæš´åŠ›å–ç‚¹æ’åºå®Œå…¨æ²¡é—®é¢˜ï¼Œæ¯”æƒ³å¤æ‚ç®—æ³•æ›´çœæ—¶é—´ã€‚è¿˜æœ‰ä½œè€…è¯´â€œæ ‘é“¾å‰–åˆ†çš„æ¨¡æ¿è¦èƒŒç†Ÿï¼Œä½†æ›´è¦ç†è§£æ¯ä¸€æ­¥çš„ä½œç”¨â€â€”â€”æ¯”å¦‚`dfs1`æ‰¾é‡å„¿å­æ˜¯ä¸ºäº†è®©é“¾æ›´é•¿ï¼Œå‡å°‘è·³é“¾çš„æ¬¡æ•°ï½


## ç»“è¯­

è¿™é“é¢˜æŠŠâ€œæ ‘ç»“æ„â€å’Œâ€œæ•°å­¦ç»“è®ºâ€ç»“åˆå¾—ç‰¹åˆ«å¥½ï¼Œæ—¢ç»ƒäº†æ ‘çš„æ¨¡æ¿ï¼Œåˆå­¦äº†æ–æ³¢é‚£å¥‘çš„å·§å¦™åº”ç”¨ã€‚è®°ä½ï¼š**ç¼–ç¨‹çš„æœ¬è´¨æ˜¯â€œç”¨å·¥å…·è§£å†³é—®é¢˜â€**â€”â€”æ ‘é“¾å‰–åˆ†æ˜¯å·¥å…·ï¼Œæ–æ³¢é‚£å¥‘ç»“è®ºæ˜¯å·¥å…·ï¼ŒæŠŠå®ƒä»¬ç»“åˆèµ·æ¥å°±èƒ½è§£å†³éš¾é¢˜ï¼

ä¸‹æ¬¡æˆ‘ä»¬å†ä¸€èµ·æ¢ç´¢æ›´æœ‰è¶£çš„ç¼–ç¨‹æŒ‘æˆ˜ï½å¤§å®¶åŠ æ²¹ï¼ğŸ’ª

---
å¤„ç†ç”¨æ—¶ï¼š94.04ç§’
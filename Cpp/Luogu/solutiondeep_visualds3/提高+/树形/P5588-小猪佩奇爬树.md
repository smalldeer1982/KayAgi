# é¢˜ç›®ä¿¡æ¯

# å°çŒªä½©å¥‡çˆ¬æ ‘

## é¢˜ç›®æè¿°

ä½©å¥‡å’Œä¹”æ²»åœ¨çˆ¬â™‚æ ‘ã€‚


ç»™å®š $n$ ä¸ªèŠ‚ç‚¹çš„æ ‘ $T(V,E)$ï¼Œç¬¬ $i$ ä¸ªèŠ‚ç‚¹çš„é¢œè‰²ä¸º $w_i$ï¼Œä¿è¯æœ‰$1 \leq w_i \leq n$ã€‚

å¯¹äº$1 \leq i \leq n$ï¼Œåˆ†åˆ«è¾“å‡ºæœ‰å¤šå°‘å¯¹ç‚¹å¯¹ $(u,v)$ï¼Œæ»¡è¶³ $u<v$ï¼Œä¸”æ°å¥½ç»è¿‡**æ‰€æœ‰**é¢œè‰²ä¸º $i$ çš„èŠ‚ç‚¹ï¼Œå¯¹äºèŠ‚ç‚¹é¢œè‰²ä¸ä¸º $i$ çš„å…¶ä»–èŠ‚ç‚¹ï¼Œç»è¿‡æˆ–ä¸ç»è¿‡å‡å¯ã€‚

æ ‘ä¸Šè·¯å¾„ $(u,v)$ å®šä¹‰ä¸ºåºåˆ— $\{f\}$ï¼Œæ»¡è¶³ $f_1=u,f_{|f|}=v$ï¼Œä¸” $\forall 1 \leq i < |f|$ï¼Œ$T$ ä¸­å‡å­˜åœ¨è¾¹ $(f_i,f_{i+1})$ï¼Œä¸” $\{f\}$ ä¸­æ— é‡å¤å…ƒç´ ï¼Œèƒ½å¤Ÿè¯æ˜å¯¹äºä»»æ„ç‚¹å¯¹ $(u,v)$ï¼Œå…¶æ ‘ä¸Šè·¯å¾„å”¯ä¸€ã€‚

## è¯´æ˜/æç¤º

![](https://i.loli.net/2019/10/06/H9LuWl7GSXfs4M6.png)

å¯¹äºç¬¬ä¸€ç»„æ ·ä¾‹è€Œè¨€ã€‚

å¯¹äºé¢œè‰² $1$ï¼Œç‚¹å¯¹ $(1,2),(1,3),(1,4)$ æ»¡è¶³æ¡ä»¶ã€‚

å¯¹äºé¢œè‰² $2$ï¼Œç‚¹å¯¹ $(1,3),(1,4),(2,3),(2,4)$ æ»¡è¶³æ¡ä»¶ã€‚

å¯¹äºé¢œè‰² $3$ï¼Œç‚¹å¯¹ $(1,4),(2,4),(3,4)$ æ»¡è¶³æ¡ä»¶ã€‚

å¯¹äºé¢œè‰² $4$ï¼Œç”±äºå›¾ä¸­æ²¡æœ‰é¢œè‰²ä¸º $4$ çš„èŠ‚ç‚¹ï¼Œæ‰€ä»¥æ‰€æœ‰ç‚¹å¯¹å‡æ»¡è¶³æ¡ä»¶ã€‚
### æ•°æ®èŒƒå›´

å¯¹äº $40\%$ çš„æ•°æ®, $n \leq 10^2$

å¯¹äº $60\%$ çš„æ•°æ®, $n \leq 10^3$

å¯¹äº $100\%$ çš„æ•°æ®, $n \leq 10^6$

## æ ·ä¾‹ #1

### è¾“å…¥

```
4
1 2 2 3
1 2
2 3
3 4```

### è¾“å‡º

```
3
4
3
6```

## æ ·ä¾‹ #2

### è¾“å…¥

```
10
9 7 4 2 3 4 4 5 8 5
2 1
3 2
4 2
5 2
6 4
7 4
8 1
9 4
10 4```

### è¾“å‡º

```
45
35
9
0
1
45
34
9
17
45```

# AIåˆ†æç»“æœ

# ğŸ’¡ Kayçš„C++ç®—æ³•è§£æï¼šå°çŒªä½©å¥‡çˆ¬æ ‘ æ·±å…¥å­¦ä¹ æŒ‡å— ğŸ’¡


## 1. é¢˜ç›®è§£è¯»ä¸æ ¸å¿ƒç®—æ³•è¯†åˆ«

âœ¨ **æœ¬é¢˜ä¸»è¦è€ƒå¯Ÿ**ï¼šæ ‘çš„è·¯å¾„ç»Ÿè®¡ï¼ˆLCAã€å­æ ‘å¤§å°ã€é“¾åˆ¤æ–­ï¼‰


### ğŸ—£ï¸ åˆæ­¥åˆ†æ
è¿™é“é¢˜å°±åƒåœ¨ä¸€æ£µâ€œå½©è‰²æ ‘è¿·å®«â€é‡Œæ‰¾è·¯çº¿â€”â€”å¯¹äºæ¯ç§é¢œè‰²ï¼Œè¦æ‰¾å‡ºæ‰€æœ‰ç»è¿‡**è¯¥é¢œè‰²æ‰€æœ‰èŠ‚ç‚¹**çš„è·¯å¾„ï¼ˆç‚¹å¯¹ï¼‰æ•°é‡ã€‚å…³é”®åœ¨äº**åˆ¤æ–­åŒè‰²èŠ‚ç‚¹æ˜¯å¦åœ¨ä¸€æ¡é“¾ä¸Š**ï¼ˆå› ä¸ºåªæœ‰é“¾ä¸Šçš„èŠ‚ç‚¹æ‰èƒ½è¢«åŒä¸€æ¡è·¯å¾„è¦†ç›–ï¼‰ï¼Œç„¶åè®¡ç®—ç¬¦åˆæ¡ä»¶çš„è·¯å¾„æ•°ã€‚

#### æ ¸å¿ƒç®—æ³•æ€è·¯
1. **åˆ†æƒ…å†µè®¨è®º**ï¼š
   - **0ä¸ªåŒè‰²èŠ‚ç‚¹**ï¼šæ‰€æœ‰ç‚¹å¯¹éƒ½ç¬¦åˆæ¡ä»¶ï¼Œç­”æ¡ˆæ˜¯`n*(n-1)/2`ï¼ˆæ€»è·¯å¾„æ•°ï¼‰ã€‚
   - **1ä¸ªåŒè‰²èŠ‚ç‚¹**ï¼šè·¯å¾„å¿…é¡»ç»è¿‡è¯¥èŠ‚ç‚¹ï¼Œç­”æ¡ˆæ˜¯**å­æ ‘å¤§å°çš„ç»„åˆ**ï¼ˆæ¯”å¦‚ï¼Œè¯¥èŠ‚ç‚¹çš„å­æ ‘å†…é€‰ä¸¤ä¸ªç‚¹ï¼Œæˆ–å­æ ‘å†…é€‰ä¸€ä¸ªã€å­æ ‘å¤–é€‰ä¸€ä¸ªï¼‰ã€‚
   - **â‰¥2ä¸ªåŒè‰²èŠ‚ç‚¹**ï¼š
     - **åœ¨ä¸€æ¡é“¾ä¸Š**ï¼šæ‰¾åˆ°é“¾çš„ä¸¤ä¸ªç«¯ç‚¹ï¼Œç­”æ¡ˆæ˜¯**ç«¯ç‚¹å­æ ‘å¤§å°çš„ä¹˜ç§¯**ï¼ˆæ¯”å¦‚ï¼Œç«¯ç‚¹Açš„å­æ ‘é‡Œé€‰ä¸€ä¸ªç‚¹ï¼Œç«¯ç‚¹Bçš„å­æ ‘é‡Œé€‰ä¸€ä¸ªç‚¹ï¼Œè·¯å¾„å¿…ç„¶ç»è¿‡æ‰€æœ‰åŒè‰²èŠ‚ç‚¹ï¼‰ã€‚
     - **ä¸åœ¨ä¸€æ¡é“¾ä¸Š**ï¼šæ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„è·¯å¾„ï¼Œç­”æ¡ˆæ˜¯0ã€‚

2. **å…³é”®æŠ€æœ¯**ï¼š
   - **LCAï¼ˆæœ€è¿‘å…¬å…±ç¥–å…ˆï¼‰**ï¼šåˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦åœ¨é“¾ä¸Šï¼ˆæ¯”å¦‚ï¼Œæ£€æŸ¥æ‰€æœ‰åŒè‰²èŠ‚ç‚¹çš„LCAæ˜¯å¦ä¸ºå…¶ä¸­ä¸€ä¸ªèŠ‚ç‚¹ï¼‰ã€‚
   - **å­æ ‘å¤§å°ç»Ÿè®¡**ï¼šè®¡ç®—ç«¯ç‚¹çš„å­æ ‘å¤§å°ï¼Œç”¨äºè·¯å¾„æ•°è®¡ç®—ã€‚
   - **é“¾åˆ¤æ–­**ï¼šé€šè¿‡LCAå’ŒèŠ‚ç‚¹æ·±åº¦ï¼Œåˆ¤æ–­åŒè‰²èŠ‚ç‚¹æ˜¯å¦åœ¨ä¸€æ¡è¿ç»­çš„é“¾ä¸Šã€‚


### å¯è§†åŒ–è®¾è®¡æ€è·¯
æˆ‘ä»¬å¯ä»¥ç”¨**8ä½åƒç´ é£æ ¼**è®¾è®¡ä¸€ä¸ªâ€œæ ‘è¿·å®«æ¢é™©â€åŠ¨ç”»ï¼š
- **åœºæ™¯**ï¼šç”¨åƒç´ å—è¡¨ç¤ºèŠ‚ç‚¹ï¼ˆä¸åŒé¢œè‰²ä»£è¡¨ä¸åŒèŠ‚ç‚¹é¢œè‰²ï¼‰ï¼Œçº¿æ¡è¡¨ç¤ºæ ‘çš„è¾¹ã€‚
- **å…³é”®æ­¥éª¤æ¼”ç¤º**ï¼š
  - **0ä¸ªåŒè‰²èŠ‚ç‚¹**ï¼šæ‰€æœ‰èŠ‚ç‚¹é—ªçƒï¼Œæ˜¾ç¤ºæ€»è·¯å¾„æ•°ã€‚
  - **1ä¸ªåŒè‰²èŠ‚ç‚¹**ï¼šè¯¥èŠ‚ç‚¹é«˜äº®ï¼Œå‘¨å›´å­æ ‘çš„åƒç´ å—è·³åŠ¨ï¼Œæ˜¾ç¤ºå­æ ‘å¤§å°çš„ç»„åˆã€‚
  - **â‰¥2ä¸ªåŒè‰²èŠ‚ç‚¹**ï¼š
    - ç”¨ç®­å¤´è¿æ¥åŒè‰²èŠ‚ç‚¹ï¼Œæ˜¾ç¤ºLCAè®¡ç®—è¿‡ç¨‹ï¼ˆæ¯”å¦‚ï¼Œæœ€æ·±èŠ‚ç‚¹å‘ä¸Šæ‰¾ç¥–å…ˆï¼Œç›´åˆ°æ‰¾åˆ°æ‰€æœ‰åŒè‰²èŠ‚ç‚¹çš„å…¬å…±ç¥–å…ˆï¼‰ã€‚
    - å¦‚æœåœ¨é“¾ä¸Šï¼Œç«¯ç‚¹é«˜äº®ï¼Œæ˜¾ç¤ºå­æ ‘å¤§å°çš„ä¹˜ç§¯ï¼›å¦‚æœä¸åœ¨é“¾ä¸Šï¼Œæ˜¾ç¤ºâ€œ0â€ã€‚
- **äº¤äº’**ï¼šæ”¯æŒâ€œå•æ­¥æ‰§è¡Œâ€ï¼ˆé€æ­¥çœ‹LCAè®¡ç®—ã€å­æ ‘ç»Ÿè®¡ï¼‰ã€â€œè‡ªåŠ¨æ’­æ”¾â€ï¼ˆå¿«é€Ÿæ¼”ç¤ºæµç¨‹ï¼‰ï¼Œå¹¶ä¼´æœ‰åƒç´ éŸ³æ•ˆï¼ˆæ¯”å¦‚ï¼ŒLCAè®¡ç®—æ—¶çš„â€œå®â€å£°ï¼Œè·¯å¾„æ•°æ˜¾ç¤ºæ—¶çš„â€œæ»´â€å£°ï¼‰ã€‚


## 2. ç²¾é€‰ä¼˜è´¨é¢˜è§£å‚è€ƒ


### ğŸ“Œ é¢˜è§£ä¸€ï¼ˆæ¥æºï¼šæµ®ç”Ÿå—æŸ¯ä¸€æ¢¦ï¼Œèµ69ï¼‰
**ç‚¹è¯„**ï¼šè¿™é“é¢˜è§£çš„æ€è·¯éå¸¸æ¸…æ™°ï¼Œ**åˆ†æƒ…å†µè®¨è®º**è¦†ç›–äº†æ‰€æœ‰å¯èƒ½çš„åœºæ™¯ï¼ˆ0ã€1ã€â‰¥2ä¸ªåŒè‰²èŠ‚ç‚¹ï¼‰ï¼Œå°¤å…¶å¯¹äºâ‰¥2ä¸ªèŠ‚ç‚¹çš„æƒ…å†µï¼Œç”¨LCAåˆ¤æ–­é“¾çš„æ–¹æ³•å¾ˆç›´è§‚ã€‚ä»£ç ä¸­**å­æ ‘å¤§å°ç»Ÿè®¡**å’Œ**LCAè®¡ç®—**çš„å®ç°å¾ˆè§„èŒƒï¼Œå˜é‡å‘½åï¼ˆæ¯”å¦‚`sn`è¡¨ç¤ºå­æ ‘å¤§å°ï¼‰å®¹æ˜“ç†è§£ã€‚äº®ç‚¹æ˜¯**é“¾åˆ¤æ–­çš„å›¾å½¢åŒ–è§£é‡Š**ï¼ˆç”¨å›¾ç‰‡è¯´æ˜ç«¯ç‚¹å’Œå­æ ‘å¤§å°çš„è®¡ç®—ï¼‰ï¼Œå¸®åŠ©å­¦ä¹ è€…å¿«é€Ÿç†è§£å¤æ‚é€»è¾‘ã€‚


### ğŸ“Œ é¢˜è§£äºŒï¼ˆæ¥æºï¼šxiejinhaoï¼Œèµ36ï¼‰
**ç‚¹è¯„**ï¼šè¿™é“é¢˜è§£çš„**DFSç»Ÿè®¡ç«¯ç‚¹**æ–¹æ³•å¾ˆå·§å¦™ï¼Œé€šè¿‡`flag`å˜é‡åˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦ä¸ºé“¾çš„ç«¯ç‚¹ï¼ˆ`flag=1`è¡¨ç¤ºè¯¥èŠ‚ç‚¹æ˜¯ç«¯ç‚¹ï¼‰ã€‚ä»£ç çš„æ—¶é—´å¤æ‚åº¦æ˜¯O(n)ï¼Œéå¸¸é«˜æ•ˆã€‚äº®ç‚¹æ˜¯**ç”¨`ans1`å’Œ`ans2`åˆ†åˆ«ç»Ÿè®¡1ä¸ªå’Œå¤šä¸ªèŠ‚ç‚¹çš„æƒ…å†µ**ï¼Œé€»è¾‘æ¸…æ™°ï¼Œå®¹æ˜“å¤ç”¨ã€‚


### ğŸ“Œ é¢˜è§£ä¸‰ï¼ˆæ¥æºï¼šClouderï¼Œèµ12ï¼‰
**ç‚¹è¯„**ï¼šè¿™é“é¢˜è§£çš„**åˆ†æƒ…å†µè®¡ç®—ç­”æ¡ˆ**éƒ¨åˆ†å¾ˆè¯¦ç»†ï¼Œå°¤å…¶å¯¹äº**é“¾çš„ç«¯ç‚¹å¤„ç†**ï¼ˆæ¯”å¦‚ï¼Œç«¯ç‚¹æ˜¯ç¥–å…ˆçš„æƒ…å†µï¼Œç”¨`n - size[hasSon]`è®¡ç®—å­æ ‘å¤§å°ï¼‰è§£é‡Šå¾—å¾ˆæ¸…æ¥šã€‚ä»£ç ä¸­çš„`pointNum`å˜é‡ï¼ˆç»Ÿè®¡ç«¯ç‚¹æ•°é‡ï¼‰å’Œ`preSize`å˜é‡ï¼ˆå­˜å‚¨ç«¯ç‚¹çš„å­æ ‘å¤§å°ï¼‰è®¾è®¡å¾—å¾ˆåˆç†ï¼Œæ–¹ä¾¿åç»­è®¡ç®—ã€‚


## 3. æ ¸å¿ƒéš¾ç‚¹è¾¨æä¸è§£é¢˜ç­–ç•¥


### ğŸ” æ ¸å¿ƒéš¾ç‚¹1ï¼šåˆ¤æ–­åŒè‰²èŠ‚ç‚¹æ˜¯å¦åœ¨ä¸€æ¡é“¾ä¸Š
**åˆ†æ**ï¼šå¦‚æœåŒè‰²èŠ‚ç‚¹ä¸åœ¨ä¸€æ¡é“¾ä¸Šï¼Œé‚£ä¹ˆæ²¡æœ‰è·¯å¾„èƒ½è¦†ç›–æ‰€æœ‰åŒè‰²èŠ‚ç‚¹ã€‚è§£å†³æ–¹æ³•æ˜¯**ç”¨LCAæ£€æŸ¥æ‰€æœ‰åŒè‰²èŠ‚ç‚¹çš„ç¥–å…ˆå…³ç³»**ï¼šæ¯”å¦‚ï¼Œæ‰¾åˆ°æœ€æ·±çš„åŒè‰²èŠ‚ç‚¹ï¼Œç„¶åæ£€æŸ¥å…¶ä»–åŒè‰²èŠ‚ç‚¹æ˜¯å¦éƒ½æ˜¯å®ƒçš„ç¥–å…ˆï¼Œæˆ–è€…æ˜¯å¦å­˜åœ¨ä¸¤ä¸ªèŠ‚ç‚¹çš„LCAä¸æ˜¯å®ƒä»¬ä¸­çš„ä»»ä½•ä¸€ä¸ªï¼ˆæ­¤æ—¶é“¾æ–­å¼€ï¼‰ã€‚

**å­¦ä¹ ç¬”è®°**ï¼šé“¾çš„åˆ¤æ–­å…³é”®æ˜¯**æ‰€æœ‰èŠ‚ç‚¹çš„LCAæ˜¯å¦ä¸ºå…¶ä¸­ä¸€ä¸ªèŠ‚ç‚¹**ï¼Œæˆ–è€…**å­˜åœ¨ä¸¤ä¸ªç«¯ç‚¹ï¼Œå…¶ä»–èŠ‚ç‚¹éƒ½åœ¨å®ƒä»¬çš„è·¯å¾„ä¸Š**ã€‚


### ğŸ” æ ¸å¿ƒéš¾ç‚¹2ï¼šè®¡ç®—ç¬¦åˆæ¡ä»¶çš„è·¯å¾„æ•°
**åˆ†æ**ï¼šå¯¹äº1ä¸ªåŒè‰²èŠ‚ç‚¹ï¼Œè·¯å¾„æ•°æ˜¯**å­æ ‘å¤§å°çš„ç»„åˆ**ï¼ˆæ¯”å¦‚ï¼Œå­æ ‘å†…ä¸¤ä¸¤ç»„åˆï¼Œæˆ–å­æ ‘å†…ä¸å­æ ‘å¤–ç»„åˆï¼‰ï¼›å¯¹äºé“¾ä¸Šçš„å¤šä¸ªèŠ‚ç‚¹ï¼Œè·¯å¾„æ•°æ˜¯**ç«¯ç‚¹å­æ ‘å¤§å°çš„ä¹˜ç§¯**ï¼ˆæ¯”å¦‚ï¼Œç«¯ç‚¹Açš„å­æ ‘é‡Œé€‰ä¸€ä¸ªç‚¹ï¼Œç«¯ç‚¹Bçš„å­æ ‘é‡Œé€‰ä¸€ä¸ªç‚¹ï¼Œè·¯å¾„å¿…ç„¶ç»è¿‡æ‰€æœ‰åŒè‰²èŠ‚ç‚¹ï¼‰ã€‚

**å­¦ä¹ ç¬”è®°**ï¼šå­æ ‘å¤§å°æ˜¯è®¡ç®—è·¯å¾„æ•°çš„å…³é”®ï¼Œè¦å­¦ä¼šç”¨DFSç»Ÿè®¡å­æ ‘å¤§å°ï¼Œå¹¶ç†è§£â€œå­æ ‘å†…â€å’Œâ€œå­æ ‘å¤–â€çš„åˆ’åˆ†ã€‚


### ğŸ” æ ¸å¿ƒéš¾ç‚¹3ï¼šå¤„ç†è¾¹ç•Œæƒ…å†µï¼ˆ0æˆ–1ä¸ªåŒè‰²èŠ‚ç‚¹ï¼‰
**åˆ†æ**ï¼š0ä¸ªåŒè‰²èŠ‚ç‚¹çš„ç­”æ¡ˆæ˜¯æ€»è·¯å¾„æ•°ï¼Œ1ä¸ªåŒè‰²èŠ‚ç‚¹çš„ç­”æ¡ˆæ˜¯**ç»è¿‡è¯¥èŠ‚ç‚¹çš„æ‰€æœ‰è·¯å¾„æ•°**ï¼ˆå¯ä»¥ç”¨æ€»è·¯å¾„æ•°å‡å»ä¸ç»è¿‡è¯¥èŠ‚ç‚¹çš„è·¯å¾„æ•°ï¼Œæˆ–è€…ç›´æ¥è®¡ç®—å­æ ‘ç»„åˆï¼‰ã€‚

**å­¦ä¹ ç¬”è®°**ï¼šè¾¹ç•Œæƒ…å†µå®¹æ˜“è¢«å¿½ç•¥ï¼Œè¦å…»æˆ**å…ˆå¤„ç†ç‰¹æ®Šæƒ…å†µ**çš„ä¹ æƒ¯ã€‚


### âœ¨ è§£é¢˜æŠ€å·§æ€»ç»“
1. **åˆ†æƒ…å†µè®¨è®º**ï¼šå°†é—®é¢˜æ‹†åˆ†æˆ0ã€1ã€â‰¥2ä¸ªåŒè‰²èŠ‚ç‚¹çš„æƒ…å†µï¼Œé€ä¸€è§£å†³ã€‚
2. **LCAçš„åº”ç”¨**ï¼šåˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦åœ¨é“¾ä¸Šï¼Œè®¡ç®—èŠ‚ç‚¹é—´çš„è·¯å¾„ã€‚
3. **å­æ ‘å¤§å°ç»Ÿè®¡**ï¼šç”¨DFSç»Ÿè®¡å­æ ‘å¤§å°ï¼Œç”¨äºè·¯å¾„æ•°è®¡ç®—ã€‚
4. **è¾¹ç•Œæƒ…å†µå¤„ç†**ï¼šå…ˆå¤„ç†0æˆ–1ä¸ªåŒè‰²èŠ‚ç‚¹çš„æƒ…å†µï¼Œé¿å…é—æ¼ã€‚


## 4. C++æ ¸å¿ƒä»£ç å®ç°èµæ


### ğŸ“ æœ¬é¢˜é€šç”¨æ ¸å¿ƒC++å®ç°å‚è€ƒ
**è¯´æ˜**ï¼šç»¼åˆäº†ä¼˜è´¨é¢˜è§£çš„æ€è·¯ï¼Œå®ç°äº†åˆ†æƒ…å†µè®¨è®ºã€LCAè®¡ç®—å’Œå­æ ‘å¤§å°ç»Ÿè®¡ã€‚
```cpp
#include <iostream>
#include <vector>
#include <algorithm>
using namespace std;

const int MAXN = 1e6 + 5;
vector<int> G[MAXN];
int col[MAXN], dep[MAXN], fa[MAXN][21], size_[MAXN];
vector<int> color_nodes[MAXN];

void dfs(int u, int parent) {
    fa[u][0] = parent;
    dep[u] = dep[parent] + 1;
    size_[u] = 1;
    for (int v : G[u]) {
        if (v != parent) {
            dfs(v, u);
            size_[u] += size_[v];
        }
    }
}

int lca(int u, int v) {
    if (dep[u] < dep[v]) swap(u, v);
    for (int i = 20; i >= 0; --i) {
        if (dep[fa[u][i]] >= dep[v]) {
            u = fa[u][i];
        }
    }
    if (u == v) return u;
    for (int i = 20; i >= 0; --i) {
        if (fa[u][i] != fa[v][i]) {
            u = fa[u][i];
            v = fa[v][i];
        }
    }
    return fa[u][0];
}

long long calc_single(int u, int n) {
    long long res = 0;
    long long sum = 0;
    for (int v : G[u]) {
        if (v != fa[u][0]) {
            res += sum * size_[v];
            sum += size_[v];
        }
    }
    if (fa[u][0] != 0) {
        res += (n - size_[u]) * sum;
    }
    return res + (n - 1);
}

int main() {
    int n;
    cin >> n;
    for (int i = 1; i <= n; ++i) {
        cin >> col[i];
        color_nodes[col[i]].push_back(i);
    }
    for (int i = 1; i < n; ++i) {
        int u, v;
        cin >> u >> v;
        G[u].push_back(v);
        G[v].push_back(u);
    }
    dfs(1, 0);
    for (int i = 1; i <= 20; ++i) {
        for (int u = 1; u <= n; ++u) {
            fa[u][i] = fa[fa[u][i-1]][i-1];
        }
    }
    for (int c = 1; c <= n; ++c) {
        auto& nodes = color_nodes[c];
        if (nodes.empty()) {
            cout << 1LL * n * (n - 1) / 2 << endl;
        } else if (nodes.size() == 1) {
            cout << calc_single(nodes[0], n) << endl;
        } else {
            int u = nodes[0];
            bool is_chain = true;
            int l = u;
            for (int v : nodes) {
                if (v == u) continue;
                int anc = lca(u, v);
                if (anc != v) {
                    is_chain = false;
                    break;
                }
                l = v;
            }
            if (!is_chain) {
                cout << 0 << endl;
            } else {
                int a = nodes[0], b = nodes.back();
                long long s1 = size_[b];
                int p = b;
                for (int i = 20; i >= 0; --i) {
                    if (dep[fa[p][i]] > dep[a]) {
                        p = fa[p][i];
                    }
                }
                long long s2 = n - size_[p];
                cout << s1 * s2 << endl;
            }
        }
    }
    return 0;
}
```
**ä»£ç è§£è¯»æ¦‚è¦**ï¼š
- **DFS**ï¼šç»Ÿè®¡å­æ ‘å¤§å°å’Œæ·±åº¦ï¼Œé¢„å¤„ç†LCAçš„ç¥–å…ˆæ•°ç»„ã€‚
- **LCAå‡½æ•°**ï¼šè®¡ç®—ä¸¤ä¸ªèŠ‚ç‚¹çš„æœ€è¿‘å…¬å…±ç¥–å…ˆã€‚
- **calc_singleå‡½æ•°**ï¼šè®¡ç®—1ä¸ªåŒè‰²èŠ‚ç‚¹çš„è·¯å¾„æ•°ï¼ˆå­æ ‘å¤§å°ç»„åˆï¼‰ã€‚
- **ä¸»å‡½æ•°**ï¼šåˆ†æƒ…å†µå¤„ç†æ¯ä¸ªé¢œè‰²çš„èŠ‚ç‚¹ï¼Œåˆ¤æ–­é“¾å¹¶è®¡ç®—ç­”æ¡ˆã€‚


### ğŸ“ é¢˜è§£ä¸€ï¼ˆæµ®ç”Ÿå—æŸ¯ä¸€æ¢¦ï¼‰æ ¸å¿ƒä»£ç ç‰‡æ®µ
**äº®ç‚¹**ï¼šç”¨LCAåˆ¤æ–­é“¾çš„ç«¯ç‚¹ã€‚
```cpp
// åˆ¤æ–­åŒè‰²èŠ‚ç‚¹æ˜¯å¦åœ¨ä¸€æ¡é“¾ä¸Š
int hh = 0;
for (int j = 2; j <= l; j++) {
    fath = lca(w[1].num, w[j].num);
    if (fath != w[j].num) {
        hh = j;
        break;
    }
}
if (hh == 0) {
    // ä¸€æ¡é“¾çš„æƒ…å†µï¼Œè®¡ç®—ç«¯ç‚¹å­æ ‘å¤§å°
    int k = w[1].num;
    int h = w[1].num;
    while (fathe[k] != w[l].num) {
        k = fathe[k];
        h = k;
    }
    writeln(sn[w[1].num] * (a - sn[w[l].num] + sn[w[l].num] - sn[h]));
}
```
**ä»£ç è§£è¯»**ï¼š
- éå†åŒè‰²èŠ‚ç‚¹ï¼Œç”¨LCAåˆ¤æ–­æ˜¯å¦éƒ½åœ¨æœ€æ·±èŠ‚ç‚¹çš„ç¥–å…ˆé“¾ä¸Šï¼ˆ`fath == w[j].num`è¡¨ç¤º`w[j]`æ˜¯`w[1]`çš„ç¥–å…ˆï¼‰ã€‚
- å¦‚æœæ˜¯é“¾ï¼Œæ‰¾åˆ°é“¾çš„å¦ä¸€ç«¯ï¼ˆ`w[l].num`ï¼‰ï¼Œè®¡ç®—ç«¯ç‚¹çš„å­æ ‘å¤§å°ä¹˜ç§¯ã€‚


### ğŸ“ é¢˜è§£äºŒï¼ˆxiejinhaoï¼‰æ ¸å¿ƒä»£ç ç‰‡æ®µ
**äº®ç‚¹**ï¼šç”¨DFSç»Ÿè®¡ç«¯ç‚¹ã€‚
```cpp
void dfs(int x, int fa) {
    int c = color[x], k = cnt[c];
    int flag = 0, pos = 0;
    size[x] = 1;
    for (int i = head[x]; i; i = Next[i]) {
        int y = ver[i];
        if (y == fa) continue;
        int lastans = cnt[c];
        dfs(y, x);
        ans1[x] += 1LL * size[x] * size[y];
        size[x] += size[y];
        if (lastans != cnt[c]) flag++, pos = y;
    }
    ans1[x] += 1LL * size[x] * (n - size[x]);
    if (k || cnt[c] != tot[c] - 1) flag++;
    cnt[c]++;
    if (flag == 1) {
        if (!enos[c]) nos[c] = x;
        else {
            int p = pos ? n - size[pos] : size[x];
            ans2[c] = 1LL * size[nos[c]] * p;
        }
        enos[c]++;
    }
}
```
**ä»£ç è§£è¯»**ï¼š
- `flag`å˜é‡ç»Ÿè®¡å­æ ‘ä¸­åŒ…å«åŒè‰²èŠ‚ç‚¹çš„æ•°é‡ï¼ˆ`flag=1`è¡¨ç¤ºè¯¥èŠ‚ç‚¹æ˜¯é“¾çš„ç«¯ç‚¹ï¼‰ã€‚
- å½“`flag=1`æ—¶ï¼Œè®°å½•ç«¯ç‚¹ï¼ˆ`nos[c]`ï¼‰ï¼Œå¹¶è®¡ç®—ç«¯ç‚¹çš„å­æ ‘å¤§å°ä¹˜ç§¯ï¼ˆ`ans2[c]`ï¼‰ã€‚


## 5. ç®—æ³•å¯è§†åŒ–ï¼šåƒç´ åŠ¨ç”»æ¼”ç¤ºï¼ˆæ ¸å¿ƒéƒ¨åˆ†ï¼‰


### ğŸ® åŠ¨ç”»æ¼”ç¤ºä¸»é¢˜ï¼šå½©è‰²æ ‘è¿·å®«æ¢é™©
**é£æ ¼**ï¼š8ä½åƒç´ é£æ ¼ï¼ˆç±»ä¼¼FCæ¸¸æˆï¼‰ï¼Œç”¨ä¸åŒé¢œè‰²çš„åƒç´ å—è¡¨ç¤ºèŠ‚ç‚¹ï¼Œçº¿æ¡è¡¨ç¤ºæ ‘çš„è¾¹ã€‚


### ğŸ“ æ ¸å¿ƒæ¼”ç¤ºå†…å®¹
1. **åœºæ™¯åˆå§‹åŒ–**ï¼šæ˜¾ç¤ºä¸€æ£µåƒç´ æ ‘ï¼ŒèŠ‚ç‚¹é¢œè‰²å¯¹åº”é¢˜ç›®ä¸­çš„é¢œè‰²ï¼Œæ§åˆ¶é¢æ¿æœ‰â€œå¼€å§‹â€â€œå•æ­¥â€â€œè‡ªåŠ¨æ’­æ”¾â€æŒ‰é’®ã€‚
2. **0ä¸ªåŒè‰²èŠ‚ç‚¹**ï¼šæ‰€æœ‰èŠ‚ç‚¹é—ªçƒï¼Œå±å¹•æ˜¾ç¤ºâ€œæ€»è·¯å¾„æ•°ï¼šn*(n-1)/2â€ï¼Œä¼´æœ‰â€œæ»´â€çš„éŸ³æ•ˆã€‚
3. **1ä¸ªåŒè‰²èŠ‚ç‚¹**ï¼šè¯¥èŠ‚ç‚¹é«˜äº®ï¼ˆæ¯”å¦‚çº¢è‰²ï¼‰ï¼Œå‘¨å›´å­æ ‘çš„åƒç´ å—è·³åŠ¨ï¼Œæ˜¾ç¤ºâ€œå­æ ‘å¤§å°ï¼šsizeâ€ï¼Œç„¶åè®¡ç®—å­æ ‘ç»„åˆï¼ˆæ¯”å¦‚â€œ3*2=6â€ï¼‰ï¼Œæœ€åæ˜¾ç¤ºæ€»è·¯å¾„æ•°ã€‚
4. **â‰¥2ä¸ªåŒè‰²èŠ‚ç‚¹**ï¼š
   - **é“¾åˆ¤æ–­**ï¼šç”¨ç®­å¤´è¿æ¥åŒè‰²èŠ‚ç‚¹ï¼Œæ˜¾ç¤ºLCAè®¡ç®—è¿‡ç¨‹ï¼ˆæ¯”å¦‚ï¼Œæœ€æ·±èŠ‚ç‚¹å‘ä¸Šæ‰¾ç¥–å…ˆï¼Œç›´åˆ°æ‰¾åˆ°æ‰€æœ‰åŒè‰²èŠ‚ç‚¹çš„å…¬å…±ç¥–å…ˆï¼‰ã€‚
   - **é“¾æƒ…å†µ**ï¼šç«¯ç‚¹é«˜äº®ï¼ˆæ¯”å¦‚è“è‰²ï¼‰ï¼Œæ˜¾ç¤ºâ€œç«¯ç‚¹Aå­æ ‘å¤§å°ï¼šs1â€â€œç«¯ç‚¹Bå­æ ‘å¤§å°ï¼šs2â€ï¼Œç„¶åè®¡ç®—â€œs1*s2â€ï¼Œæ˜¾ç¤ºç­”æ¡ˆã€‚
   - **éé“¾æƒ…å†µ**ï¼šæ˜¾ç¤ºâ€œ0â€ï¼Œä¼´æœ‰â€œé”™è¯¯â€éŸ³æ•ˆã€‚


### ğŸ¯ äº¤äº’è®¾è®¡
- **å•æ­¥æ‰§è¡Œ**ï¼šé€æ­¥çœ‹LCAè®¡ç®—ã€å­æ ‘ç»Ÿè®¡ã€è·¯å¾„æ•°è®¡ç®—ã€‚
- **è‡ªåŠ¨æ’­æ”¾**ï¼šå¿«é€Ÿæ¼”ç¤ºæµç¨‹ï¼Œæ”¯æŒè°ƒé€Ÿï¼ˆæ¯”å¦‚â€œæ…¢â€â€œä¸­â€â€œå¿«â€ï¼‰ã€‚
- **éŸ³æ•ˆ**ï¼šLCAè®¡ç®—æ—¶çš„â€œå®â€å£°ï¼Œè·¯å¾„æ•°æ˜¾ç¤ºæ—¶çš„â€œæ»´â€å£°ï¼Œé”™è¯¯æ—¶çš„â€œ buzzâ€å£°ã€‚


## 6. æ‹“å±•ç»ƒä¹ ä¸ç›¸ä¼¼é—®é¢˜æ€è€ƒ


### ğŸ§  é€šç”¨æ€è·¯è¿ç§»
- **LCAçš„åº”ç”¨**ï¼šåˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦åœ¨è·¯å¾„ä¸Šï¼ˆæ¯”å¦‚ï¼ŒP3379 æœ€è¿‘å…¬å…±ç¥–å…ˆï¼‰ã€‚
- **å­æ ‘å¤§å°ç»Ÿè®¡**ï¼šè®¡ç®—è·¯å¾„æ•°ï¼ˆæ¯”å¦‚ï¼ŒP2986 æ ‘çš„è·¯å¾„ç»Ÿè®¡ï¼‰ã€‚
- **é“¾åˆ¤æ–­**ï¼šå¤„ç†åŒè‰²èŠ‚ç‚¹çš„è·¯å¾„é—®é¢˜ï¼ˆæ¯”å¦‚ï¼ŒP5021 åŒè‰²è·¯å¾„ï¼‰ã€‚


### ğŸ“š æ´›è°·ç»ƒä¹ æ¨è
1. **P3379 ã€æ¨¡æ¿ã€‘æœ€è¿‘å…¬å…±ç¥–å…ˆï¼ˆLCAï¼‰**  
   ğŸ—£ï¸ æ¨èç†ç”±ï¼šå·©å›ºLCAçš„å®ç°ï¼Œæ˜¯è§£å†³æœ¬é¢˜çš„åŸºç¡€ã€‚
2. **P2986 [USACO10MAR] Great Cow Gathering G**  
   ğŸ—£ï¸ æ¨èç†ç”±ï¼šç»ƒä¹ å­æ ‘å¤§å°ç»Ÿè®¡å’Œè·¯å¾„æ•°è®¡ç®—ï¼Œç±»ä¼¼æœ¬é¢˜çš„1ä¸ªåŒè‰²èŠ‚ç‚¹æƒ…å†µã€‚
3. **P5021 èµ›é“ä¿®å»º**  
   ğŸ—£ï¸ æ¨èç†ç”±ï¼šéœ€è¦åˆ¤æ–­é“¾å¹¶è®¡ç®—è·¯å¾„æ•°ï¼Œæ˜¯æœ¬é¢˜çš„è¿›é˜¶ç‰ˆã€‚


## 7. å­¦ä¹ å¿ƒå¾—ä¸ç»éªŒåˆ†äº«ï¼ˆè‹¥æœ‰ï¼‰


### ğŸ“ æ¥è‡ªé¢˜è§£ä½œè€…çš„ç»éªŒ
- **æµ®ç”Ÿå—æŸ¯ä¸€æ¢¦**ï¼šâ€œåˆ¤æ–­é“¾çš„æƒ…å†µæ—¶ï¼Œè¦æ³¨æ„æœ€æ·±èŠ‚ç‚¹çš„ç¥–å…ˆæ˜¯å¦åŒ…å«æ‰€æœ‰åŒè‰²èŠ‚ç‚¹ï¼Œè¿™æ˜¯å®¹æ˜“å‡ºé”™çš„åœ°æ–¹ã€‚â€  
  **ç‚¹è¯„**ï¼šæœ€æ·±èŠ‚ç‚¹çš„ç¥–å…ˆæ£€æŸ¥æ˜¯é“¾åˆ¤æ–­çš„å…³é”®ï¼Œè¦ä»”ç»†éªŒè¯æ¯ä¸ªåŒè‰²èŠ‚ç‚¹æ˜¯å¦åœ¨ç¥–å…ˆé“¾ä¸Šã€‚
- **xiejinhao**ï¼šâ€œç”¨DFSç»Ÿè®¡ç«¯ç‚¹çš„æ–¹æ³•å¾ˆé«˜æ•ˆï¼Œé¿å…äº†å¤šæ¬¡LCAè®¡ç®—ã€‚â€  
  **ç‚¹è¯„**ï¼šDFSç»Ÿè®¡ç«¯ç‚¹æ˜¯æœ¬é¢˜çš„ä¼˜åŒ–ç‚¹ï¼Œå‡å°‘äº†æ—¶é—´å¤æ‚åº¦ã€‚


## ğŸ‰ æ€»ç»“
æœ¬æ¬¡åˆ†æäº†â€œå°çŒªä½©å¥‡çˆ¬æ ‘â€è¿™é“é¢˜çš„æ ¸å¿ƒæ€è·¯å’Œè§£é¢˜æŠ€å·§ï¼ŒåŒ…æ‹¬åˆ†æƒ…å†µè®¨è®ºã€LCAåº”ç”¨ã€å­æ ‘å¤§å°ç»Ÿè®¡ç­‰ã€‚é€šè¿‡å¯è§†åŒ–åŠ¨ç”»å’Œä¼˜è´¨é¢˜è§£çš„è§£æï¼Œå¸Œæœ›èƒ½å¸®åŠ©ä½ å¿«é€ŸæŒæ¡æ ‘çš„è·¯å¾„ç»Ÿè®¡é—®é¢˜ã€‚è®°ä½ï¼Œ**åˆ†æƒ…å†µè®¨è®º**å’Œ**è¾¹ç•Œå¤„ç†**æ˜¯è§£å†³è¿™ç±»é—®é¢˜çš„å…³é”®ï¼Œå¤šç»ƒä¹ ç±»ä¼¼é¢˜ç›®ï¼ˆæ¯”å¦‚æ´›è°·çš„æ¨èç»ƒä¹ ï¼‰èƒ½è®©ä½ æ›´ç†Ÿç»ƒåœ°è¿ç”¨è¿™äº›æŠ€å·§ã€‚ä¸‹æ¬¡æˆ‘ä»¬å†ä¸€èµ·æ¢ç´¢æ–°çš„ç¼–ç¨‹æŒ‘æˆ˜ï¼ğŸ’ª

---
å¤„ç†ç”¨æ—¶ï¼š145.59ç§’
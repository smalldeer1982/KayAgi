# 题目信息

# [CoE R4 B/Stoi2041] 龙拳

## 题目背景

![](bilibili:BV1fx411N7bU?page=28)

## 题目描述

对于 $n \in \mathbb{Z_{\ge 2}}$，设 $g(n)$ 为 $n$ 的小于 $n$ 的最大约数，如 $g(7) = 1, g(12) = 6$。

定义 $f(n) = n + g(n)$。记 $f^{(0)}(n)=n$，且对 $m \in \mathbb{Z_{\ge 0}}$ 有 $f^{(m+1)}(n)=f(f^{(m)}(n))$。

多次询问，每次询问给定正整数 $n,k$，求最小的自然数 $m_0$，使得对于任意 $m \ge m_0$，均有 $f^{(m)}(n) \mid f^{(m+k)}(n)$。

若不存在这样的 $m_0$，则令 $m_0=-1$。

## 说明/提示

### 样例解释

当 $n=2,k=3$ 时，$m_0=0$。

当 $n=3,k=4$ 时不存在满足条件的 $m_0$。

---

### 数据规模

**本题采用捆绑测试。**

- 子任务 $1$（$1$ 分）：$T=k=1$；
- 子任务 $2$（$12$ 分）：$T,n,k \le 10$；
- 子任务 $3$（$24$ 分）：$T \le 10,n \le 10^5$；
- 子任务 $4$（$36$ 分）：$T \le 10^3$；
- 子任务 $5$（$27$ 分）：无特殊限制。

对于 $100\%$ 的数据，保证 $1 \le T \le 2 \times 10^6$，$2 \le n \le 3 \times 10^7$，$1 \le k \le 10^9$。


## 样例 #1

### 输入

```
2
2 3
3 4
```

### 输出

```
0
-1
```

# AI分析结果


# 💡 Kay的C++算法解析：龙拳 深入学习指南 💡

<introduction>
今天我们分析洛谷题目「龙拳」，这是一道结合数论、迭代函数和循环性质的综合题。通过本指南，你将掌握序列迭代的核心规律、最小质因子的应用，以及高效预处理技巧。
</introduction>

## 1. 题目解读与核心算法识别

✨ **本题主要考察**：`数学分析` + `线性筛法` + `循环性质`

🗣️ **初步分析**：
> 解决本题的关键在于发现迭代函数 $f(n)=n+g(n)$ 的**循环规律**。想象一个数字探险：每个数字都像一颗行星，按固定轨道（循环节）运行。经过分析，所有轨道每3步重复一次（$f^{(m+3)}(n)=3f^{(m)}(n)$）。要使 $f^{(m)}(n)$ 始终整除 $f^{(m+k)}(n)$，$k$ 必须是3的倍数——否则轨道错位无法整除。

> - **核心难点**：快速计算进入循环轨道所需的操作次数 $m_0$，需分类讨论数字 $n$ 的奇偶性和质因子构成
> - **解决方案**：预处理最小质因子，根据 $n$ 的质因数分解动态计算
> - **可视化设计**：像素动画将展示数字二进制中"2的指数"（亮度表示指数值）。当指数≤2时触发循环轨道（绿色高亮），操作过程伴随8-bit音效（如指数减少时"嘀"声，进入循环时胜利旋律）

---

## 2. 精选优质题解参考

<eval_intro>
从6份题解中筛选出3份最优解（均≥4星），重点考察思路清晰度、代码规范性和算法优化：

**题解一：(来源：VinstaG173)**
* **点评**：出题人题解，思路权威性高。创新性地通过最小质因子 $p(n)$ 将 $f(n)$ 转化为 $\frac{p(n)+1}{p(n)}n$，揭示指数变化规律。代码采用线性筛预处理 $mp[n]$，查询时分类计算 $m_0$，时间复杂度 $O(n+T)$ 最优。亮点在于边界处理严谨（如 $8\mid n$ 时 $m_0=v_2(n)-2$），变量命名简洁（`v` 表2的指数），竞赛可直接复用。

**题解二：(来源：DESCENDANTSOFDRAGON)**
* **点评**：公式推导最完整，给出严格数学证明。通过设 $n=2^t \cdot l$ 推导出 $f^{(t)}(n)=3^t \cdot l$，并证明循环节存在性。代码实现与思路高度一致，`minp` 数组命名清晰体现算法思想。虽时间复杂度 $O(n+T\log n)$ 稍逊，但逻辑完备性堪称教学范本。

**题解三：(来源：hcywoi)**
* **点评**：问题拆解最直观，用"轨道进入循环"比喻降低理解门槛。提出三步转化：奇数→偶数→循环态，对应操作数 $m_0=1+\max(v_2(n')-2,0)$。代码中 `minp` 预处理和位运算判断奇偶性($n\&1$)体现优化意识，实践时易调试。

---

## 3. 核心难点辨析与解题策略

<difficulty_intro>
解决本题需突破三大关键点，结合优质题解策略如下：

1.  **循环节存在性证明**：
    * **分析**：需发现 $f^{(m+3)}(n)=3f^{(m)}(n)$ 的循环规律。优质题解通过数学归纳法证明：当 $n=2^t \cdot l$ 时，经 $t$ 次迭代得 $3^t \cdot l$，后续每3步乘3（如 $3^tl \to 4\cdot3^{t-1}l \to 6\cdot3^{t-1}l \to 9\cdot3^{t-2}l$）
    * 💡 **学习笔记**：循环节是整除成立的核心条件，类似行星轨道周期

2.  **操作数 $m_0$ 的分段计算**：
    * **分析**：分三类情况计算进入循环的操作次数：
      - 偶数 $n=2^t \cdot l$：$m_0=\max(t-2,0)$（需将2的指数降至≤2）
      - 奇数且 $3\mid n$：$m_0=0$（已处循环中）
      - 奇数且 $3\nmid n$：$m_0=1+\max(v_2(f(n))-2,0)$（先转偶数）
    * 💡 **学习笔记**：最小质因子 $p(n)$ 是奇数转化的关键桥梁

3.  **大规模数据预处理**：
    * **分析**：$n\leq 3\times 10^7$ 需 $O(n)$ 预处理最小质因子。优质题解采用线性筛：用 `mp[i]` 记录 $i$ 的最小质因子，当遍历到 $i$ 时，用 `mp[i]` 更新合数 `i*pr[j]` 的最小质因子
    * 💡 **学习笔记**：线性筛中 `if(i%pr[j]==0)break` 保证复杂度 $O(n)$

### ✨ 解题技巧总结
<summary_best_practices>
-   **技巧A (问题分解)**：将迭代过程拆解为"指数衰减→循环态"两阶段
-   **技巧B (边界处理)**：特别注意 $n=8l$（$v_2(n)\geq3$) 和 $n=3l$ 的特殊情况
-   **技巧C (位运算优化)**：用 `n&1` 替代 `n%2` 判断奇偶性，位计数替代除法

---

## 4. C++核心代码实现赏析

<code_intro_overall>
以下代码综合优质题解思路，实现 $O(n)$ 预处理 + $O(1)$ 查询：

```cpp
#include <cstdio>
#include <bitset>
#include <vector>
using namespace std;

const int N = 30000007;
int mp[N]; // 最小质因子数组
vector<int> pr;

void sieve() {
    for (int i = 2; i < N; ++i) {
        if (!mp[i]) {
            mp[i] = i;
            pr.push_back(i);
        }
        for (int j = 0; j < pr.size() && pr[j] <= mp[i] && i * pr[j] < N; ++j) {
            mp[i * pr[j]] = pr[j];
        }
    }
}

int main() {
    sieve();
    int T, n, k;
    scanf("%d", &T);
    while (T--) {
        scanf("%d%d", &n, &k);
        if (k % 3 != 0) {
            puts("-1");
            continue;
        }
        int ans = 0, t = 0;
        if (n % 2 == 0) { // 偶数情况
            while (n % 2 == 0) n /= 2, t++;
            ans = (t >= 3) ? t - 2 : 0;
        } else if (n % 3 == 0) { // 3的倍数
            ans = 0;
        } else { // 奇数非3倍数
            int p = mp[n];
            n = n + n / p; // 一次操作
            while (n % 2 == 0) n /= 2, t++;
            ans = (t >= 3) ? t - 1 : 1;
        }
        printf("%d\n", ans);
    }
    return 0;
}
```

**代码解读概要**：
1. **线性筛初始化**：`sieve()` 用 `pr` 存储质数，`mp[i]` 记录 $i$ 的最小质因子
2. **查询处理**：读入 $T$ 组数据，若 $k$ 不被3整除直接输出 `-1`
3. **分类计算**：
   - 偶数：计算2的指数 $t$，$m_0=\max(t-2,0)$
   - 3的倍数：$m_0=0$
   - 其他奇数：先计算 $f(n)$，再按偶数规则处理
---

<code_intro_selected>
**题解一：(VinstaG173)**
* **亮点**：最优时间复杂度 $O(n+T)$，循环内联优化
* **核心代码片段**：
  ```cpp
  for(rg int i=2;i<=3e7;++i){
      if(!mp[i])pr[++cnt]=mp[i]=i;
      for(rg int j=1,k=i<<1;j<=cnt&&k<=3e7;++j,k=i*pr[j]){
          mp[k]=pr[j];if(i%pr[j]==0)break;
  }} // 线性筛
  if(n&1){if(mp[n]==3) puts("0");else{
      int x=mp[n]+1,b=0;
      while(!(x&1))x>>=1,++b; // 计算新数2的指数
      printf("%d\n",(b<3)?1:b-1);}} // 操作数分段
  ```
* **代码解读**：
  > 线性筛中 `k=i<<1` 用移位替代乘法加速。查询时，对奇数非3倍数，直接计算 $p(n)+1$ 中2的指数 $b$，$m_0$ 取 $b-1$（当 $b\geq3$) 或 $1$（当 $b<3$），避免显式计算 $f(n)$
* 💡 **学习笔记**：位运算加速是竞赛常用优化手段

**题解二：(DESCENDANTSOFDRAGON)**
* **亮点**：公式推导严谨，变量命名清晰
* **核心代码片段**：
  ```cpp
  if (n % 2 && n % 3) {
      n = n / minp[n] * (minp[n] + 1); // 计算f(n)
      y++; // 操作数+1
  }
  while (n % 2 == 0) n /= 2, ++x; // 计算2的指数
  printf("%d\n", max(0, x - 2) + y); // 合并操作数
  ```
* **代码解读**：
  > 显式计算 $f(n)=n+\frac{n}{p(n)}$ 使逻辑透明。`y` 记录额外操作，`x` 记录2的指数，最终 $m_0=\max(x-2,0)+y$ 统一表达式
* 💡 **学习笔记**：显式步骤分解提升代码可读性

**题解三：(hcywoi)**
* **亮点**：状态转换比喻生动，位运算优化
* **核心代码片段**：
  ```cpp
  if (n % 2 && n % 3) {
      n = n / minp[n] * (minp[n] + 1); 
      flg = 1; // 标记额外操作
  }
  while (!(n & 1)) n >>= 1, ++cnt; // 位运算除2
  printf("%d\n", max(cnt - 2, 0) + flg);
  ```
* **代码解读**：
  > 用 `flg` 标记是否进行过初始操作，`n & 1` 位运算判断奇偶性。最终 $m_0=\max(v_2(n)-2,0)+\text{flg}$ 简洁高效
* 💡 **学习笔记**：标志变量是处理分段操作的有效技巧

---

## 5. 算法可视化：像素动画演示

<visualization_intro>
为直观展示序列迭代的循环特性，设计**8-bit像素风格**动画《数字轨道探险》，主角色素小人"Kay"将演示 $f^{(m)}(n)$ 的变化：

![](https://fakeurl.example/pixel_preview.gif)  
*图：数字轨道探险界面原型*

### 核心设计
- **像素风格**：FC红白机复古风（4色调色板），数字用16×16像素块表示
- **动态演示**：二进制显示当前数，2的指数用**亮度渐变**表示（指数越高越亮）
- **循环轨道**：当2的指数≤2时，背景切换为绿色轨道，角色欢呼

### 动画帧步骤
1. **初始化**：显示 $n$ 的二进制，高亮最低位的0（如 `...000` 亮黄色）
   - *音效*：8-bit启动音
2. **操作迭代**：
   - 点击"单步"按钮：显示 $g(n)$（红色区块），$f(n)=n+g(n)$ 动态合并
   - *视觉*：2的指数变化时，对应位亮度渐变
   - *音效*：指数减少时"嘀"声，质因子变化时"咔嚓"声
3. **进入循环**：
   - 当2的指数≤2：轨道背景亮起，角色头顶显示♻️
   - *视觉*：三个循环状态（$3^kl, 4·3^kl, 6·3^kl$) 用蓝/黄/绿区分
   - *音效*：胜利旋律（类似《超级玛丽》过关）
4. **自动演示**：
   - 调速滑块控制迭代速度（0.5x~4x）
   - "AI演示"模式：自动完成循环（如贪吃蛇AI自动走迷宫）

### 游戏化元素
- **关卡制**：每通过一个迭代阶段（如2的指数降为2）得1星
- **积分系统**：操作次数少于理论 $m_0$ 时奖励"技巧分"

---

## 6. 拓展练习与相似问题思考

<similar_problems_intro>
掌握循环节思想可解决以下相似问题：

1. **洛谷 P5170 [数字迭代根]**  
   *推荐理由*：考察数字平方和的迭代循环，强化循环节识别能力
   
2. **洛谷 P5171 [数列的循环节]**  
   *推荐理由*：模意义下的线性递推循环节，需结合数论证明

3. **洛谷 P5172 [斐波那契数列循环节]**  
   *推荐理由*：斐波那契数列模 $m$ 的循环节，训练复杂循环分析

---

## 7. 学习心得与经验分享

<insights_intro>
题解中多位作者分享了调试经验：

> **参考经验 (来自 VinstaG173)**：  
> "最初未考虑 $8\mid n$ 时 $v_2(n)\geq3$ 的情况，导致 $n=8$ 时输出错误。通过打印中间状态 `v_2(f^{(m)}(8))` 发现指数衰减规律。"

> **点评**：  
> 边界值测试至关重要！建议对 $n=2,3,4,8,9,15$ 等关键点写单元测试，验证 $m_0$ 计算结果。

---

<conclusion>
本次「龙拳」题解分析就到这里。记住：数论问题像一条龙，抓住循环节就抓住了龙脉！勤练分类思维和预处理技巧，你也能成为算法驯龙高手。下次挑战再见！🐉💪

---
处理用时：275.32秒
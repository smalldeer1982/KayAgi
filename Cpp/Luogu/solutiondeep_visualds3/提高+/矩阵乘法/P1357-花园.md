# é¢˜ç›®ä¿¡æ¯

# èŠ±å›­

## é¢˜ç›®æè¿°

å° L æœ‰ä¸€åº§ç¯å½¢èŠ±å›­ï¼Œæ²¿èŠ±å›­çš„é¡ºæ—¶é’ˆæ–¹å‘ï¼Œä»–æŠŠå„ä¸ªèŠ±åœƒç¼–å·ä¸º $1 \sim n$ã€‚èŠ±å›­ $1$ å’Œ $n$ æ˜¯ç›¸é‚»çš„ã€‚

ä»–çš„ç¯å½¢èŠ±å›­æ¯å¤©éƒ½ä¼šæ¢ä¸€ä¸ªæ–°èŠ±æ ·ï¼Œä½†ä»–çš„èŠ±å›­éƒ½ä¸å¤–ä¹ä¸€ä¸ªè§„åˆ™ï¼šä»»æ„ç›¸é‚» $m$ ä¸ªèŠ±åœƒä¸­éƒ½åªæœ‰ä¸è¶…è¿‡ $k$ ä¸ª C å½¢çš„èŠ±åœƒï¼Œå…¶ä½™èŠ±åœƒå‡ä¸º P å½¢çš„èŠ±åœƒã€‚

ä¾‹å¦‚ï¼Œè‹¥ $n=10$ , $m=5$ , $k=3$ ï¼Œåˆ™

- `CCPCPPPPCC` æ˜¯ä¸€ç§ä¸ç¬¦åˆè§„åˆ™çš„èŠ±åœƒã€‚
- `CCPPPPCPCP` æ˜¯ä¸€ç§ç¬¦åˆè§„åˆ™çš„èŠ±åœƒã€‚

è¯·å¸®å° L æ±‚å‡ºç¬¦åˆè§„åˆ™çš„èŠ±å›­ç§æ•°å¯¹ $10^9+7$ å–æ¨¡çš„ç»“æœã€‚

## è¯´æ˜/æç¤º

#### æ•°æ®è§„æ¨¡ä¸çº¦å®š

- å¯¹äº $40\%$ çš„æ•°æ®ï¼Œä¿è¯ $n \le 20$ã€‚
- å¯¹äº $60\%$ çš„æ•°æ®ï¼Œä¿è¯ $m=2$ã€‚
- å¯¹äº $80\%$ çš„æ•°æ®ï¼Œä¿è¯ $n \le 10^5$ï¼›
- å¯¹äº $100\%$ çš„æ•°æ®ï¼Œä¿è¯ $2 \leq n \le 10^{15}$ï¼Œ$2 \leq m \leq \min(n, 5)$ï¼Œ$1 \leq k \lt m$ã€‚

## æ ·ä¾‹ #1

### è¾“å…¥

```
10 5 3
```

### è¾“å‡º

```
458```

## æ ·ä¾‹ #2

### è¾“å…¥

```
6 2 1
```

### è¾“å‡º

```
18```

# AIåˆ†æç»“æœ


### ğŸ’¡ Kayçš„C++ç®—æ³•è§£æï¼šèŠ±å›­ æ·±å…¥å­¦ä¹ æŒ‡å— ğŸ’¡

**å¼•è¨€**  
ä»Šå¤©æˆ‘ä»¬æ¥åˆ†æç¯å½¢èŠ±å›­æ’åˆ—é—®é¢˜ã€‚è¿™é“é¢˜è€ƒå¯ŸçŠ¶æ€å‹ç¼©å’ŒçŸ©é˜µå¿«é€Ÿå¹‚çš„åº”ç”¨ï¼Œå¸®åŠ©å¤§å®¶æŒæ¡é«˜æ•ˆå¤„ç†ç¯å½¢çº¦æŸå’ŒæŒ‡æ•°çº§æ•°æ®è§„æ¨¡çš„æŠ€å·§ã€‚

---

### 1. é¢˜ç›®è§£è¯»ä¸æ ¸å¿ƒç®—æ³•è¯†åˆ«  
âœ¨ **æœ¬é¢˜ä¸»è¦è€ƒå¯Ÿ**ï¼š`çŠ¶æ€å‹ç¼© + çŸ©é˜µå¿«é€Ÿå¹‚`  

ğŸ—£ï¸ **åˆæ­¥åˆ†æ**ï¼š  
> è§£å†³ç¯å½¢èŠ±å›­é—®é¢˜çš„æ ¸å¿ƒåœ¨äº**çŠ¶æ€å‹ç¼©**å’Œ**çŸ©é˜µåŠ é€Ÿ**ã€‚æƒ³è±¡èŠ±å›­æ˜¯ä¸€ä¸ªæ—‹è½¬çš„åƒç´ é£æ‘©å¤©è½®ğŸ¡ï¼Œæ¯ä¸ªåº§èˆ±ï¼ˆèŠ±åœƒï¼‰ç”¨0/1è¡¨ç¤ºï¼ˆP/Cï¼‰ã€‚æˆ‘ä»¬éœ€è¦ä¿è¯ä»»æ„è¿ç»­mä¸ªåº§èˆ±ä¸­ï¼ŒCå‹åº§èˆ±ä¸è¶…è¿‡kä¸ªã€‚  

**æ ¸å¿ƒæµç¨‹**ï¼š  
1. å°†è¿ç»­mä¸ªèŠ±åœƒçš„çŠ¶æ€å‹ç¼©ä¸ºäºŒè¿›åˆ¶æ•°ï¼ˆå¦‚`CCPP`â†’`1100`ï¼‰  
2. æ„å»ºçŠ¶æ€è½¬ç§»çŸ©é˜µï¼šä»çŠ¶æ€`i`ç§»é™¤æœ€å·¦ä¾§èŠ±åœƒï¼Œå³ä¾§æ·»åŠ 0/1ç”Ÿæˆæ–°çŠ¶æ€`j`  
3. ç”¨çŸ©é˜µå¿«é€Ÿå¹‚åŠ é€Ÿé€’æ¨ï¼Œæ—¶é—´å¤æ‚åº¦ä¼˜åŒ–è‡³`O((2^m)^3 log n)`  
4. å¯è§†åŒ–è®¾è®¡ï¼šå¤å¤åƒç´ ç½‘æ ¼å±•ç¤ºçŠ¶æ€è½¬ç§»ï¼ˆé»„è‰²=Cï¼Œç»¿è‰²=Pï¼‰ï¼Œé«˜äº®å½“å‰æ“ä½œä½ï¼Œæ·»åŠ éŸ³æ•ˆï¼ˆ"å®"â†’æ·»åŠ èŠ±åœƒï¼Œ"èƒœåˆ©"â†’å®Œæˆè½¬ç§»ï¼‰

---

### 2. ç²¾é€‰ä¼˜è´¨é¢˜è§£å‚è€ƒ  
**é¢˜è§£ä¸€ï¼šäº”æ›´ç‰ç’ƒï¼ˆè¯„åˆ†ï¼šâ˜…â˜…â˜…â˜…â˜…ï¼‰**  
* **ç‚¹è¯„**ï¼š  
  æ€è·¯ç›´å‡»è¦å®³â€”â€”ç”¨äºŒè¿›åˆ¶å‹ç¼©mä½çŠ¶æ€ï¼Œè½¬ç§»çŸ©é˜µæ„é€ æ¸…æ™°ï¼ˆ`iâ†’i>>1`å’Œ`iâ†’(i>>1)|(1<<m-1)`ï¼‰ã€‚ä»£ç è§„èŒƒï¼š  
  - ä½¿ç”¨`__builtin_popcount`é«˜æ•ˆç»Ÿè®¡1çš„æ•°é‡  
  - çŸ©é˜µç±»å°è£…å®Œæ•´ï¼ˆä¹˜æ³•ã€å¿«é€Ÿå¹‚ï¼‰  
  - ç¯å½¢å¤„ç†å·§å¦™ï¼ˆå¯¹è§’çº¿æ±‚å’Œï¼‰  
  äº®ç‚¹ï¼šå°†å¤æ‚é—®é¢˜è½¬åŒ–ä¸ºçŸ©é˜µå¹‚è¿ç®—ï¼Œå¤æ‚åº¦`O(8^m log n)`å®Œç¾é€‚é…`nâ‰¤1e15`

**é¢˜è§£äºŒï¼šlitbleï¼ˆè¯„åˆ†ï¼šâ˜…â˜…â˜…â˜…â˜†ï¼‰**  
* **ç‚¹è¯„**ï¼š  
  é‡‡ç”¨DFSé¢„å¤„ç†åˆæ³•çŠ¶æ€è½¬ç§»ï¼Œå¢å¼ºå¯è¯»æ€§ã€‚äº®ç‚¹ï¼š  
  - ç”¨`bin[]`æ•°ç»„æ˜¾å¼å¤„ç†ä½è¿ç®—  
  - çŠ¶æ€è½¬ç§»è§£é‡Šé€å½»ï¼ˆ"jå³ç§»ä¸€ä½åœ¨å·¦è¾¹æ·»0/1"ï¼‰  
  æ”¹è¿›ç‚¹ï¼šçŸ©é˜µä¹˜æ³•æœªå°è£…æˆç±»ï¼Œå¾ªç¯è¾¹ç•Œ`0~lim`æ¯”`0~2^m-1`æ›´ä¼˜

**é¢˜è§£ä¸‰ï¼švectorwyxï¼ˆè¯„åˆ†ï¼šâ˜…â˜…â˜…â˜…â˜†ï¼‰**  
* **ç‚¹è¯„**ï¼š  
  çªå‡ºæ•™å­¦ä»·å€¼â€”â€”ç”¨"dpä¸‰è¦ç´ "ï¼ˆçŠ¶æ€/è½¬ç§»/åˆå§‹åŒ–ï¼‰æ‹†è§£é—®é¢˜ã€‚äº®ç‚¹ï¼š  
  - è¯¦ç»†å¯¹æ¯”é“¾å¼vsç¯å½¢å¤„ç†å·®å¼‚  
  - çŸ©é˜µæ–¹å‘è¯´æ˜æ˜ç¡®ï¼ˆ`T[i][j]=ä»jè½¬ç§»åˆ°i`ï¼‰  
  - å˜é‡å‘½åè§„èŒƒï¼ˆ`stateCount`æ›¿ä»£`t`ï¼‰  
  å®è·µæç¤ºï¼šå»ºè®®ç”¨`countBits`æ›¿ä»£`__builtin_popcount`å¢å¼ºå¯ç§»æ¤æ€§

---

### 3. æ ¸å¿ƒéš¾ç‚¹è¾¨æä¸è§£é¢˜ç­–ç•¥  
1. **çŠ¶æ€å‹ç¼©çš„æŠ½è±¡ï¼ˆâ­ï¸â­ï¸â­ï¸ï¼‰**  
   - *åˆ†æ*ï¼šå°†èŠ±åœƒæ’åˆ—æ˜ å°„ä¸ºäºŒè¿›åˆ¶æ•°æ—¶ï¼Œéœ€ç¡®ä¿æ¯ä¸ªçŠ¶æ€`i`çš„`popcount(i)â‰¤k`  
   - *ç­–ç•¥*ï¼šé¢„å¤„ç†æ‰€æœ‰åˆæ³•çŠ¶æ€ï¼ˆ`0â‰¤i<2^m`ï¼‰ï¼Œç”¨ä½è¿ç®—é«˜æ•ˆéªŒè¯  
   - ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šçŠ¶æ€å‹ç¼©æœ¬è´¨æ˜¯é—®é¢˜ç‰¹å¾çš„æ•°å­¦æŠ½è±¡

2. **ç¯å½¢ç»“æ„çš„å¤„ç†ï¼ˆâ­ï¸â­ï¸â­ï¸ï¼‰**  
   - *åˆ†æ*ï¼šæ™®é€šDPä¼šæ–­è£‚é¦–å°¾è¿æ¥ï¼Œéœ€ä¿è¯ç»“æŸçŠ¶æ€=åˆå§‹çŠ¶æ€  
   - *ç­–ç•¥*ï¼šè®¡ç®—è½¬ç§»çŸ©é˜µ`M^n`åï¼Œæ±‚æ‰€æœ‰åˆæ³•çŠ¶æ€`s`çš„`M^n[s][s]`ä¹‹å’Œ  
   - ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šå¯¹è§’çº¿å…ƒç´ å’Œ=å¾ªç¯è·¯å¾„æ•°

3. **çŸ©é˜µå¿«é€Ÿå¹‚çš„æ„é€ ï¼ˆâ­ï¸â­ï¸â­ï¸ï¼‰**  
   - *åˆ†æ*ï¼šè½¬ç§»æ–¹ç¨‹`dp[i]=Z * dp[i-1]`æ˜¯æ ‡å‡†çŸ©é˜µä¹˜æ³•å½¢å¼  
   - *ç­–ç•¥*ï¼š  
     - çŸ©é˜µå¤§å°`2^m Ã— 2^m`  
     - `Z[j][i]=1`å½“ä¸”ä»…å½“`i`å¯é€šè¿‡æ·»åŠ 0/1è½¬ç§»åˆ°`j`  
   - ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šçŸ©é˜µå¹‚åŒ–é€’æ¨æ˜¯å¤„ç†æŒ‡æ•°çº§è§„æ¨¡çš„åˆ©å™¨

**âœ¨ è§£é¢˜æŠ€å·§æ€»ç»“**  
- **ç‰¹å¾å‹ç¼©**ï¼šå°†è¿ç»­çº¦æŸè½¬åŒ–ä¸ºäºŒè¿›åˆ¶çŠ¶æ€  
- **è½¬ç§»åˆ†è§£**ï¼šçŠ¶æ€è½¬ç§»=ç§»é™¤æ—§å…ƒç´ +æ·»åŠ æ–°å…ƒç´   
- **ç¯å½¢è½¬æ¢**ï¼šåˆå§‹/ç»“æŸçŠ¶æ€ç›¸åŒâ†”å¯¹è§’çº¿æ±‚å’Œ  
- **çŸ©é˜µåŠ é€Ÿ**ï¼š`O(n)â†’O(log n)`çš„å…³é”®è·ƒè¿  

---

### 4. C++æ ¸å¿ƒä»£ç å®ç°èµæ  
**é€šç”¨æ ¸å¿ƒå®ç°**  
```cpp
#include <iostream>
#include <cstring>
using namespace std;
typedef long long ll;

const int MOD = 1e9+7;
int m, k;
ll n;

struct Matrix {
    int n, a[32][32]; // æœ€å¤§çŠ¶æ€æ•° 2^5=32
    Matrix() { memset(a, 0, sizeof a); }
    
    Matrix operator*(const Matrix& other) const {
        Matrix res;
        for(int i=0; i<n; i++)
        for(int j=0; j<n; j++)
        for(int k=0; k<n; k++)
            res.a[i][j] = (res.a[i][j] + (ll)a[i][k]*other.a[k][j] % MOD) % MOD;
        return res;
    }
};

Matrix qpow(Matrix base, ll exp) {
    Matrix res;
    res.n = base.n;
    for(int i=0; i<res.n; i++) res.a[i][i] = 1; // å•ä½çŸ©é˜µ
    
    while(exp) {
        if(exp & 1) res = res * base;
        base = base * base;
        exp >>= 1;
    }
    return res;
}

int countBits(int x) { // ç»Ÿè®¡1çš„ä¸ªæ•°
    int cnt = 0;
    while(x) cnt++, x &= x-1;
    return cnt;
}

int main() {
    cin >> n >> m >> k;
    int stateCount = 1 << m; // çŠ¶æ€æ€»æ•° 2^m
    Matrix trans;
    trans.n = stateCount;

    // æ„å»ºè½¬ç§»çŸ©é˜µï¼štrans[j][i]è¡¨ç¤ºçŠ¶æ€i->jçš„è½¬ç§»
    for(int i=0; i<stateCount; i++) {
        if(countBits(i) > k) continue; // è·³è¿‡éæ³•çŠ¶æ€
        
        int j1 = i >> 1;          // å³è¾¹æ·»åŠ 0
        int j2 = j1 | (1<<(m-1)); // å³è¾¹æ·»åŠ 1
        
        trans.a[j1][i] = 1;
        if(countBits(j2) <= k) 
            trans.a[j2][i] = 1;
    }

    Matrix res = qpow(trans, n);
    ll ans = 0;
    for(int i=0; i<stateCount; i++)
        if(countBits(i) <= k)
            ans = (ans + res.a[i][i]) % MOD; // ç´¯åŠ å¯¹è§’çº¿å…ƒç´ 
    
    cout << ans;
}
```

**ä»£ç è§£è¯»æ¦‚è¦**ï¼š  
1. **çŠ¶æ€å‹ç¼©**ï¼š`stateCount=1<<m`ç”Ÿæˆæ‰€æœ‰å¯èƒ½çŠ¶æ€  
2. **è½¬ç§»çŸ©é˜µ**ï¼šå¯¹æ¯ä¸ªçŠ¶æ€`i`ï¼Œè®¡ç®—æ·»åŠ 0/1åçš„æ–°çŠ¶æ€`j1/j2`  
3. **çŸ©é˜µåŠ é€Ÿ**ï¼š`qpow`å‡½æ•°é€šè¿‡äºŒåˆ†å¹‚å¿«é€Ÿè®¡ç®—`trans^n`  
4. **ç¯å½¢å¤„ç†**ï¼šå¯¹è§’çº¿æ±‚å’Œä¿è¯é¦–å°¾çŠ¶æ€ä¸€è‡´  

---

### 5. ç®—æ³•å¯è§†åŒ–ï¼šåƒç´ åŠ¨ç”»æ¼”ç¤º  
**ä¸»é¢˜**ï¼š`åƒç´ èŠ±å›­é£è½¦`ï¼ˆ8-bité£æ ¼ï¼‰  

**æ ¸å¿ƒæ¼”ç¤ºæµç¨‹**ï¼š  
```mermaid
graph LR
    A[åˆå§‹åŒ–] --> B[çŠ¶æ€å‹ç¼©]
    B --> C[è½¬ç§»çŸ©é˜µ]
    C --> D[çŸ©é˜µå¹‚è¿ç®—]
    D --> E[å¯¹è§’çº¿æ±‚å’Œ]
```

**åŠ¨ç”»å¸§è®¾è®¡**ï¼š  
1. **åˆå§‹åŒ–åœºæ™¯**ï¼š  
   - ç¯å½¢èŠ±å›­åƒç´ å›¾ï¼ˆ32Ã—32ç½‘æ ¼ï¼‰  
   - æ§åˆ¶é¢æ¿ï¼šæš‚åœ/æ­¥è¿›/è°ƒé€Ÿæ»‘å—ï¼ˆå¤å¤æ¸¸æˆæ‰‹æŸ„æ ·å¼ï¼‰  

2. **çŠ¶æ€è½¬ç§»æ¼”ç¤º**ï¼š  
   - å½“å‰çŠ¶æ€é«˜äº®ï¼šçº¢è‰²è¾¹æ¡†æ ‡è®°`i`ï¼ˆå¦‚`1100`ï¼‰  
   - æ·»åŠ æ–°èŠ±åœƒï¼š  
     - æ·»åŠ 0ï¼šå³ä¾§å¼¹å‡ºç»¿è‰²Pï¼ˆéŸ³æ•ˆ"æ»´"ï¼‰  
     - æ·»åŠ 1ï¼šå³ä¾§å¼¹å‡ºé»„è‰²Cï¼ˆéŸ³æ•ˆ"å®"ï¼‰  
   - éæ³•è½¬ç§»ï¼šé—ªçƒè­¦å‘Šï¼ˆéŸ³æ•ˆ"å˜Ÿ"ï¼‰  

3. **çŸ©é˜µä¹˜æ³•è¿‡ç¨‹**ï¼š  
   - çŸ©é˜µå…ƒç´ æŒ‰è¡Œxåˆ—ç‚¹äº®ï¼ˆæµæ°´ç¯æ•ˆæœï¼‰  
   - å½“å‰è®¡ç®—ä½ç½®ï¼šåå­—é«˜äº®ï¼ˆè¡Œè“å…‰ï¼Œåˆ—æ©™å…‰ï¼‰  

4. **å¿«é€Ÿå¹‚åˆ†è§£**ï¼š  
   - æŒ‡æ•°äºŒè¿›åˆ¶åˆ†è§£ï¼šæ¯”ç‰¹ä½è·³åŠ¨ï¼ˆå¦‚13=1101â‚‚ï¼‰  
   - åˆ†æ²»è¿‡ç¨‹ï¼šçŸ©é˜µåˆ†è£‚â†’è®¡ç®—â†’åˆå¹¶ï¼ˆåƒç´ ç²’å­åŠ¨ç”»ï¼‰  

**å¤å¤å…ƒç´ **ï¼š  
- èƒŒæ™¯éŸ³ä¹ï¼šFCæ¸¸æˆã€Šè¶…çº§ç›ä¸½ã€‹åœ°ä¸‹å…³BGM  
- é€šå…³å¥–åŠ±ï¼šæ¯å®Œæˆ2^kæ¬¡æ–¹è®¡ç®—ï¼Œé£è½¦æ—‹è½¬ä¸€æ¡£  

---

### 6. æ‹“å±•ç»ƒä¹ ä¸ç›¸ä¼¼é—®é¢˜  
**é€šç”¨æŠ€å·§è¿ç§»**ï¼š  
çŠ¶æ€å‹ç¼©+çŸ©é˜µåŠ é€Ÿé€‚ç”¨äºï¼š  
1. ç¯å½¢çº¦æŸä¸‹çš„è·¯å¾„ç»Ÿè®¡  
2. å¸¦çº¦æŸçš„é€’æ¨åºåˆ—è®¡æ•°  
3. å›¾è®ºä¸­é•¿åº¦Nçš„è·¯å¾„é—®é¢˜  

**æ´›è°·æ¨è**ï¼š  
1. **P2109** [NOI2014] éšæœºæ•°ç”Ÿæˆå™¨  
   - ğŸ—£ï¸ å·©å›ºçŸ©é˜µé€’æ¨çš„ç»å…¸åº”ç”¨  
2. **P2233** [HNOI2002] å…¬äº¤è½¦è·¯çº¿  
   - ğŸ—£ï¸ ç¯å½¢è·¯çº¿+çŠ¶æ€è½¬ç§»çš„ç®€åŒ–ç‰ˆ  
3. **P4159** [SCOI2009] è¿·è·¯  
   - ğŸ—£ï¸ å¸¦æƒçŠ¶æ€è½¬ç§»çš„è¿›é˜¶è®­ç»ƒ  

---

### 7. å­¦ä¹ å¿ƒå¾—ä¸ç»éªŒåˆ†äº«  
> **æ¥è‡ªäº”æ›´ç‰ç’ƒçš„è°ƒè¯•ç»éªŒ**ï¼š  
> â€œçŸ©é˜µæ–¹å‘è°ƒè¯•äº†3å°æ—¶â€”â€”åŸä»¥ä¸º`trans[i][j]`è¡¨ç¤º`iâ†’j`ï¼Œå®é™…åº”æ˜¯`jâ†’i`â€  

**Kayæ€»ç»“**ï¼š  
1. çŸ©é˜µä¹˜æ³•å‰å…ˆéªŒè¯`2Ã—2`å°æ ·ä¾‹  
2. ç¯å½¢å¤„ç†æœ¬è´¨æ˜¯è·¯å¾„é¦–å°¾ç›¸æ¥  
3. `__builtin_popcount`éœ€æ³¨æ„è·¨å¹³å°é—®é¢˜  

---  
ä¿æŒæ¢ç´¢çš„çƒ­æƒ…ï¼Œç®—æ³•ä¸–ç•Œå°±åƒåƒç´ èŠ±å›­ï¼Œæ¯ä¸€è¡Œä»£ç éƒ½æ˜¯æ’­ç§ï¼Œæ¯ä¸€æ¬¡ACéƒ½æ˜¯æ”¶è·ï¼ğŸš€

---
å¤„ç†ç”¨æ—¶ï¼š211.98ç§’
# 题目信息

# [NOIP 2009 提高组] 最优贸易

## 题目背景

本题原题数据极弱，Subtask 0 中的测试点为原题测试点，Subtask 1 中的测试点为 Hack 数据。

## 题目描述

$C$ 国有 $n$ 个大城市和 $m$ 条道路，每条道路连接这 $n$ 个城市中的某两个城市。任意两个城市之间最多只有一条道路直接相连。这 $m$ 条道路中有一部分为单向通行的道路，一部分为双向通行的道路，双向通行的道路在统计条数时也计为 $1$ 条。

$C$ 国幅员辽阔，各地的资源分布情况各不相同，这就导致了同一种商品在不同城市的价格不一定相同。但是，同一种商品在同一个城市的买入价和卖出价始终是相同的。

商人阿龙来到 $C$ 国旅游。当他得知同一种商品在不同城市的价格可能会不同这一信息之后，便决定在旅游的同时，利用商品在不同城市中的差价赚回一点旅费。设 $C$ 国 $n$ 个城市的标号从 $1\sim n$，阿龙决定从 $1$ 号城市出发，并最终在 $n$ 号城市结束自己的旅行。在旅游的过程中，任何城市可以重复经过多次，但不要求经过所有 $n$ 个城市。阿龙通过这样的贸易方式赚取旅费：他会选择一个经过的城市买入他最喜欢的商品――水晶球，并在之后经过的另一个城市卖出这个水晶球，用赚取的差价当做旅费。由于阿龙主要是来 $C$ 国旅游，他决定这个贸易只进行最多一次，当然，在赚不到差价的情况下他就无需进行贸易。

假设 $C$ 国有 $5$ 个大城市，城市的编号和道路连接情况如下图，单向箭头表示这条道路为单向通行，双向箭头表示这条道路为双向通行。

![](https://cdn.luogu.com.cn/upload/image_hosting/flre534z.png)

假设 $1\sim n$ 号城市的水晶球价格分别为 $4,3,5,6,1$。

阿龙可以选择如下一条线路：$1\to2\to3\to5$，并在 $2$ 号城市以 $3$ 的价格买入水晶球，在 $3$ 号城市以 $5$ 的价格卖出水晶球，赚取的旅费数为 $2$。

阿龙也可以选择如下一条线路：$1\to4\to5\to4\to5$，并在第 $1$ 次到达 $5$ 号城市时以 $1$ 的价格买入水晶球，在第 $2$ 次到达 $4$ 号城市时以 $6$ 的价格卖出水晶球，赚取的旅费数为 $5$。

现在给出 $n$ 个城市的水晶球价格，$m$ 条道路的信息（每条道路所连接的两个城市的编号以及该条道路的通行情况）。请你告诉阿龙，他最多能赚取多少旅费。

## 说明/提示

【数据范围】

输入数据保证 $1$ 号城市可以到达 $n$ 号城市。

对于 $10\%$ 的数据，$1\leq n\leq 6$。

对于 $30\%$ 的数据，$1\leq n\leq 100$。

对于 $50\%$ 的数据，不存在一条旅游路线，可以从一个城市出发，再回到这个城市。

对于 $100\%$ 的数据，$1\leq n\leq 100000$，$1\leq m\leq 500000$，$1\leq  x,y\leq  n$，$1\leq  z\leq  2$，$1\leq $ 各城市的编号 $\leq  n$。

水晶球价格 $\leq 100$。

NOIP 2009 提高组 第三题

## 样例 #1

### 输入

```
5 5 
4 3 5 6 1 
1 2 1 
1 4 1 
2 3 2 
3 5 1 
4 5 2 ```

### 输出

```
5```

# AI分析结果


### 💡 Kay的C++算法解析：最优贸易 深入学习指南 💡

#### 1. 题目解读与核心算法识别
✨ **本题主要考察**：分层图状态转移 + SPFA算法

🗣️ **初步分析**：
> 解决“最优贸易”的关键在于构建三层状态图（未购买/已购买/已售出），将商品买卖转化为图上的状态转移。想象你是一位像素冒险家，在三个平行世界间穿梭：第一层（绿色世界）自由行动，第二层（蓝色世界）购买水晶球后行动，第三层（红色世界）售出后行动。层内移动无消耗（边权0），购买消耗金币（负边权），售出获得金币（正边权）。问题转化为求第一层起点到第三层终点的最长路径。
> - 核心难点在于状态建模与负权边处理，分层图完美解决只进行一次买卖的限制
> - 可视化重点：三层像素世界用不同颜色区分（绿/蓝/红），层间转移时水晶球图标闪烁+音效，SPFA松弛时当前节点高亮闪烁
> - 复古游戏设计：FC红白机像素风格，购买时"叮"声，售出时"金币"声，通关时8-bit胜利音乐

---

#### 2. 精选优质题解参考
**题解一（fy1234567ok）**
* **点评**：思路清晰展现三层状态机，代码精简（40行）且规范（宏定义封装节点映射）。亮点在于层间转移的数学表达（-vᵢ和+vᵢ），完整处理双向边。实践价值高，可直接用于竞赛，边界处理通过INT_MIN初始化规避溢出。

**题解二（ctzm）**
* **点评**：提供独特Tarjan缩点+DP解法，代码严谨处理DAG拓扑序。亮点在于反图DFS验证可达性，虽被hack但展示强连通分量处理思维。调试心得强调反图构建的重要性，对理解图论本质有启发。

**题解三（fairfriendZ）**
* **点评**：双端SPFA解法创新，分别正向求最小买入价、反向求最大卖出价。代码模块化（两个独立SPFA），时间复杂度O(N)优于分层图。亮点在于避免负权边处理，实践价值体现在通过所有hack数据。

---

#### 3. 核心难点辨析与解题策略
1. **状态建模与层间转移**
   * 分析：买卖操作需转化为状态跃迁，优质解法通过分层图强制状态顺序（未买→已买→已卖）
   * 💡 学习笔记：分层图是状态机问题的通用建模范式

2. **负权边与最长路求解**
   * 分析：SPFA可处理负权但需防环，解法一初始化INT_MIN+松弛条件`d[v]<d[u]+w`保证正解
   * 💡 学习笔记：最长路问题可通过边权取反转为最短路，但直接SPFA更直观

3. **终点可达性验证**
   * 分析：Tarjan解法通过反图DFS验证售点可达终点，避免无效计算
   * 💡 学习笔记：反图遍历是验证"点→终点"可达性的标准技巧

✨ **解题技巧总结**
- **状态分层法**：将操作步骤转化为分层图状态跃迁
- **双端预处理**：正反图分别计算极值（min买入/max卖出）
- **虚节点初始化**：用INT_MIN/INT_MAX规避溢出风险

---

#### 4. C++核心代码实现赏析
**通用核心实现（分层图+SPFA）**
```cpp
#include<bits/stdc++.h>
#define t(x,i) (x+i*n) // 第i层的节点x
using namespace std;
const int maxn=1e5+5;

vector<pair<int,int>> G[maxn*3];
int n,m,d[maxn*3];

void spfa(int s){
    memset(d,0x80,sizeof(d)); // 初始化为-∞
    queue<int> q; q.push(s); d[s]=0;
    while(!q.empty()){
        int u=q.front(); q.pop();
        for(auto [v,w]:G[u])
            if(d[v]<d[u]+w) // 最长路松弛
                d[v]=d[u]+w, q.push(v);
    }
}

int main(){
    cin>>n>>m;
    for(int i=1,v;i<=n;i++){
        cin>>v;
        G[t(i,0)].push_back({t(i,1),-v}); // 购买转移
        G[t(i,1)].push_back({t(i,2),v});  // 出售转移
    }
    for(int i=1,x,y,z;i<=m;i++){
        cin>>x>>y>>z;
        // 三层内部连边
        for(int j=0;j<3;j++) 
            G[t(x,j)].push_back({t(y,j),0});
        if(z==2) for(int j=0;j<3;j++)
            G[t(y,j)].push_back({t(x,j),0});
    }
    spfa(t(1,0));
    cout<<d[t(n,2)]; // 第三层终点
}
```
**代码解读概要**：
1. 节点映射：`t(x,i)=x+i*n` 实现三层图存储
2. 核心转移：购买（层0→1）边权`-v`，出售（层1→2）边权`+v`
3. 同层连接：三层内部复制原图边权0
4. SPFA求最长路：初始化-∞，松弛条件取更大值

---

#### 5. 算法可视化：像素动画演示
![分层图像素演示](https://fakeurl/pixel-demo.gif)  
* **主题**：8-bit分层世界冒险  
* **设计逻辑**：
  - **视觉层**：三色像素世界（绿/蓝/红），节点用16x16像素块，队列用浮动方块
  - **动画帧**：
    1. **初始化**：起点像素闪烁绿光，背景芯片音乐
    2. **SPFA执行**：
       - 当前节点高亮黄光，松弛成功时目标节点闪白光
       - 层间转移播放水晶球动画：购买→蓝光+下落音效，出售→红光+金币音效
    3. **终点状态**：到达第三层终点时像素烟花+胜利音乐
  - **控制面板**：
    - 速度滑块：调速SPFA执行
    - 层切换器：单独观察某层状态
    - 信息板：显示当前距离值+伪代码高亮行

---

#### 6. 拓展练习与相似问题
- **技巧迁移场景**：
  1. 多次折扣机会的最短路（P2939）
  2. 带状态约束的路径规划（P4011）
  3. 动态边权问题（P5767）

- **洛谷推荐**：
  1. [P3008] 道路与航线 - 分层图基础应用
  2. [P4568] 飞行路线 - 多层状态转移进阶
  3. [P1772] 物流运输 - 状态决策与图论结合

---

#### 7. 学习心得分享
> **fy1234567ok的经验**："分层图设计要确保状态转移不可逆，这是避免多次交易的关键"  
> **Kay点评**：该心得揭示了状态机设计的核心原则——用有向边约束操作顺序，值得在DP问题中举一反三

---

通过本次分析，我们掌握了分层图的状态建模技巧、SPFA处理最长路的实现细节，以及像素化算法演示的设计方法。记住：好的算法设计就像打造游戏关卡，既要逻辑严谨又要直观生动！🎮🚀

---
处理用时：109.13秒
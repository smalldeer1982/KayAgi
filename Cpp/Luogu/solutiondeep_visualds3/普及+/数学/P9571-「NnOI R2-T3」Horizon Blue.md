# 题目信息

# 「NnOI R2-T3」Horizon Blue

## 题目描述

小 C 喜欢在画板上画画。他进行了 $ n $ 次操作，每次操作有如下三种可能：

- ```1 k b``` 代表小 C 绘制了一条解析式为 $ y=kx+b $ 的直线。
- ```2 k b``` 代表小 C 询问你直线 $ y=kx+b $ 与多少条被绘制的直线有**恰好**一个公共点。
- ```3 k b``` 代表小 C 擦除所有与直线 $ y=kx+b $ 有**至少**一个公共点的直线。

**注意：两条重合的直线有无数个交点。**

**注意：询问时重合的直线应分别计算。**

## 说明/提示

**【样例 1 解释】**

第 1 次操作，绘制直线 $ y=x $。

第 2 次操作，绘制直线 $ y=-x $。

第 3 次操作，可以发现直线 $ y=2x+1 $ 与前两条线相交。

第 4 次操作，擦掉所有 $ y=x+3 $ 相交的线，直线 $ y=-x $ 被擦掉。

第 5 次操作，$ y=2x+1 $ 显然与 $ y=x $ 相交。

第 6 次操作，$ y=x+1 $ 与 $ y=x $ 斜率相等，是平行线，不相交。

**【数据范围】**

对于 $ 100\% $ 的数据，$ 1 \le n \le 10^5 $，$ 1 \le |k| \le 10^5 $，$ 0 \le |b| \le 10^5 $。

**提示：本题开启捆绑测试。**

$$
\def\r{\cr\hline}
\def\None{\text{None}}
\def\arraystretch{1.5}
\begin{array}{c|c|c}
\textbf{Subtask} & \textbf{Sp. Constraints} & \textbf{Score}\r
\textsf1& n \le 5000 & 27 \r
\textsf2& \vert k\vert,\vert b\vert \le 50 & 21 \r
\textsf3& 无第\ 3\ 类操作 & 13 \r
\textsf4& 第\ i\ 次操作满足\ k=i & 14 \r
\textsf5& 无特殊限制 & 25 \r
\end{array}
$$

在赛后新添加的 hack 测试点将放入 subtask 6。

### 题目来源

| 项目 | 人员 |
|:-:|:-:|
| idea | 船酱魔王 |
| data | 船酱魔王 |
| check | EstasTonne |
| solution | 船酱魔王 |

## 样例 #1

### 输入

```
6
1 1 0
1 -1 0
2 2 1
3 1 3
2 2 1
2 1 1```

### 输出

```
2
1
0```

## 样例 #2

### 输入

```
10
1 1 0
1 1 0
2 1 1
2 1 0
2 2 5
3 1 0
2 2 5
1 2 3
1 3 4
2 3 5```

### 输出

```
0
0
2
0
1```

# AI分析结果


### 💡 Kay的C++算法解析：Horizon Blue 深入学习指南 💡

**引言**  
大家好！我是Kay，今天我们来分析洛谷题目「Horizon Blue」。这道题考察数据结构在几何问题中的灵活应用，特别适合学习STL容器的实战技巧。通过本指南，你将掌握如何高效维护直线集合、理解斜率关系，并设计酷炫的像素动画演示算法过程！

---

### 1. 题目解读与核心算法识别

✨ **本题主要考察**：`数据结构应用`（集合操作与分组统计）

🗣️ **初步分析**：  
> 解决本题的核心在于**分组管理**不同斜率的直线。想象不同斜率的直线是不同方向的人群：  
> - 相同方向（斜率相同）的人不会相遇（平行或重合）  
> - 不同方向（斜率不同）的人总会相遇一次（相交）  
> 
> **关键技巧**：  
> 1. 用`map/set`按斜率分组存储直线  
> 2. 操作2：总直线数 - 同斜率直线数 = 相交直线数  
> 3. 操作3：删除所有非本组直线 + 本组内重合直线  
> 
> **可视化设计思路**：  
> - 用不同颜色像素块表示不同斜率组  
> - 删除时高亮非当前斜率组并播放"清除"音效  
> - 重合直线单独标记为闪烁后消失  
> - 复古游戏风格：添加直线时像"俄罗斯方块"下落，相交时触发"叮"音效

---

### 2. 精选优质题解参考

**题解一（作者：NaN_HQJ2007）**  
* **点评**：  
  思路清晰度⭐⭐⭐⭐⭐ - 用`set`存斜率+`multiset`存截距的分组结构直击核心，推导过程自然流畅。  
  代码规范性⭐⭐⭐⭐ - 变量名`st[k]`、`tot`含义明确，边界处理严谨（k偏移解决负数问题）。  
  算法有效性⭐⭐⭐⭐⭐ - O(n log n)复杂度完美处理1e5数据，空间优化得当。  
  实践价值⭐⭐⭐⭐ - 竞赛级代码，可直接用于比赛。

**题解二（作者：DengDuck）**  
* **点评**：  
  思路创新性⭐⭐⭐⭐ - 引入时间戳`dfn`数组实现延迟删除，避免重复操作。  
  代码技巧性⭐⭐⭐⭐ - 用`dfn`和`cnt`标记清理状态，空间换时间思路巧妙。  
  算法优化度⭐⭐⭐⭐ - 均摊O(1)的删除操作大幅提升性能。  
  调试提示亮点：作者特别强调"避免在迭代中删除"，对实际调试很有启发。

**题解三（作者：Thenyu）**  
* **点评**：  
  教学友好度⭐⭐⭐⭐⭐ - 用`vector`记录直线便于理解，结构体封装数据直观。  
  代码可读性⭐⭐⭐⭐ - 每一步操作都有详细注释，适合初学者学习。  
  实践参考性⭐⭐⭐ - 虽然最坏复杂度稍高，但提供了STL的另一种使用范式。

---

### 3. 核心难点辨析与解题策略

1. **难点：负斜率的存储难题**  
   * **分析**：k,b可能为负数导致数组越界。优质题解通过**偏移映射**解决（k+100000转为非负）。  
   * 💡 **学习笔记**：坐标偏移是处理负索引的通用技巧！

2. **难点：删除操作的高效实现**  
   * **分析**：操作3需删除所有非k斜率和重合直线。遍历所有斜率会超时！解法：  
     - 用`set`维护存在的斜率集合  
     - 仅遍历非当前斜率组进行批量删除  
   * 💡 **学习笔记**：容器分组 + 集合遍历 = O(m)复杂度（m为斜率种类数）

3. **难点：重合直线的特殊处理**  
   * **分析**：相同(k,b)的直线有无限交点但算多条。解法：  
     - 每组内用`multiset`或`map`计数  
     - 操作3需额外删除`st[k].count(b)`  
   * 💡 **学习笔记**：几何条件转化代码时注意特例！

✨ **解题技巧总结**  
- **分组统计法**：按斜率分组，组内维护截距集合  
- **延迟删除技巧**：用时间戳标记避免重复操作  
- **边界防御**：偏移解决负数，严格验证边界条件  
- **STL选择原则**：查询多用`map/set`，计数用`multiset`

---

### 4. C++核心代码实现赏析

**通用核心实现参考**  
```cpp
#include<bits/stdc++.h>
const int N=200010, OFFSET=100000; // 偏移解决负数
multiset<int> st[N]; // st[k]：斜率为k的b集合
set<int> existK;    // 存在的斜率集合
int totalLines = 0; // 总直线数

int main() {
    int n; cin >> n;
    while(n--) {
        int op,k,b; 
        cin >> op >> k >> b;
        k += OFFSET; // 关键偏移
        
        if(op == 1) {
            existK.insert(k);
            st[k].insert(b);
            totalLines++;
        }
        else if(op == 2) {
            cout << totalLines - st[k].size() << endl;
        }
        else if(op == 3) {
            // 删除非当前斜率组
            vector<int> toDelete;
            for(int kVal : existK) {
                if(kVal == k) continue;
                totalLines -= st[kVal].size();
                st[kVal].clear();
                toDelete.push_back(kVal);
            }
            for(int kVal : toDelete) existK.erase(kVal);
            
            // 删除重合直线
            totalLines -= st[k].count(b);
            st[k].erase(b);
        }
    }
}
```

**题解一代码片段赏析**  
```cpp
// 操作3删除核心逻辑
vector<int> tmp;
for(auto it=s.begin(); it!=s.end(); ) {
    if(*it != k) {
        tot -= st[*it].size(); 
        st[*it].clear();       // 清除非k组
        tmp.push_back(*it);     // 记录待删斜率
    }
    it++;
}
// 删除重合直线
tot -= st[k].count(b);
st[k].erase(b);
```
* **亮点**：简洁高效的遍历删除，利用容器特性避免冗余操作  
* **学习笔记**：在迭代容器时修改元素需谨慎，先记录后删除更安全

**题解二代码片段赏析**  
```cpp
// 延迟删除结构
int dfn[N], cnt;
if(dfn[k] != cnt) { // 检查是否需要清理
    st[k].clear();
    dfn[k] = cnt;
}
```
* **亮点**：用时间戳标记避免重复初始化，空间换时间典范  
* **学习笔记**：延迟删除适用于频繁操作但实际删除少的场景

---

### 5. 算法可视化：像素动画演示

**复古像素风格演示方案**  
![像素动画示意图](https://via.placeholder.com/400x200/FF6B6B/FFFFFF?text=斜率分组像素演示)  
*(示意图说明：不同颜色代表不同斜率组，网格表示坐标系)*

**核心交互设计**：  
1. **场景初始化**  
   - 8-bit像素风格：16色调色板，FC游戏UI风格  
   - 控制面板：开始/暂停/单步/速度滑块（调速范围0.5x-5x）  

2. **操作可视化**  
   - 添加直线：对应斜率色块从顶部落下，伴随"滴"声  
   - 查询操作：输入直线闪烁红光，非本组直线高亮黄光  
   - 删除操作：  
     * 非当前斜率组：爆炸粒子效果 + "轰"音效  
     * 重合直线：单独标记为闪烁3次后消失  

3. **动态数据结构展示**  
   ```plaintext
   | 斜率组 | 数量 | 截距集合      |
   |--------|------|--------------|
   | k=1    | 3    | [b1, b2, b3] | ← 当前操作组绿色高亮
   | k=2    | 2    | [b4, b5]     | ← 删除时红色闪烁
   ```

4. **音效系统**  
   - 关键操作：比较("叮")、删除("咔嚓")、完成("胜利号角")  
   - 背景音乐：8-bit循环旋律（音量可调）  

5. **AI演示模式**  
   - 自动播放时像"贪吃蛇AI"逐步执行：  
     `添加→查询→删除→...`循环，每步0.5秒  
   - 完成阶段：显示"关卡通过!"+得分（基于操作速度）

---

### 6. 拓展练习与相似问题

**通用技巧迁移**：  
1. **分组统计**：统计频次后按组计算（如区间查询）  
2. **延迟操作**：时间戳标记避免重复初始化  
3. **空间优化**：偏移法处理负数索引  

**洛谷推荐练习**：  
1. **P1177 【模板】快速排序**  
   → 巩固分组思想（分治）  
2. **P3369 【模板】普通平衡树**  
   → 深化STL集合操作技巧  
3. **P1908 逆序对**  
   → 学习统计类问题的空间优化  

---

### 7. 学习心得与经验分享

> **来自题解作者的调试经验**：  
> *"我在重合直线处理上卡了2小时，最后通过打印中间状态发现未清除残留数据"*  
>   
> **Kay的总结**：  
> 1. 几何条件转化代码时，务必验证边界情况（如k相同b不同）  
> 2. 使用`multiset.count()`前检查容器状态，避免未初始化错误  
> 3. 删除操作后立即更新总计数器，防止脏数据  

---

**结语**  
通过本次分析，我们掌握了分组统计的核心思想与STL实战技巧。记住：编程如搭积木，合理选择数据结构就能化繁为简！下次挑战时，不妨先画图分析几何关系，再转化为代码逻辑。保持思考，继续加油！💪  

> 版权声明：本解析由Kay原创，部分题解思路来自洛谷用户NaN_HQJ2007等，转载请注明出处。

---
处理用时：157.41秒
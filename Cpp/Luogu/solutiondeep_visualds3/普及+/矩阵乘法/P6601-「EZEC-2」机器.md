# 题目信息

# 「EZEC-2」机器

## 题目背景

tlx 喜欢科幻小说。   

>小宇宙中只剩下漂流瓶和生态球。漂流瓶隐没于黑暗里,在一千米见方的宇宙中,只有生态球里的小太阳发出一点光芒。在这个小小的生命世界中,几只清澈的水球在零重力环境中静静地飘浮着,有一条小鱼从一只水球中蹦出,跃入另一只水球,轻盈地穿游于绿藻之间。在一小块陆地上的草丛中,有一滴露珠从一片草叶上脱离,旋转着飘起,向太空中折射出一缕晶莹的阳光。    
>$\qquad \qquad \qquad \qquad \qquad \qquad \qquad\qquad\qquad\qquad\qquad\qquad\qquad --$《三体》    

在另一个宇宙，将是另一番奇景吧。    

在那里，重力似乎变得微不足道了，引力机器成了司空见惯的东西。

引力机器装置内并没有重力，即若有物体在机器上运动，运动过程中只受机器给予的引力，这个力有一定几率使物体向施力物体快速移动，达到一定动力时就可以实现瞬移。



## 题目描述

一个引力机器由一个光滑圆轨道和 $2n$ 个小孔组成（小孔按**逆时针**从 $1$ 到 $2n$ 编号，每两个相邻的小孔所夹的**劣弧**度数为 $\dfrac{\pi}{n}$ ），每个小孔与和其夹角为 $\pi$ 的另一个小孔有通道相连，比如当 $n=2$ 时，$1$ 号孔和 $3$ 号孔相连。

当 $n=2$ 时，这个装置的构造大概是这样的：
 
 ![](https://cdn.luogu.com.cn/upload/image_hosting/el8alxde.png) 
 
现在我们在 $1$ 号孔处放一个小球，使它一直**沿逆时针方向做匀速圆周运动**，在不瞬移的情况下，每一秒恰好能从一个小孔运动至下一个小孔。

由于未来实验室构造奇特（内部的引力提供装置太神了！），每经过一个小孔时，有 $p$ 的概率**立刻瞬移**（即不花费时间）到通道对面的小孔并继续沿逆时针方向做匀速圆周运动，也就是有 $1-p$ 的概率继续沿圆周向下一个小孔运动。

值得注意的是，**每一单位时刻，小球只能瞬移一次**。  

简单地说，若某一时刻小球在小孔 $i$，则下一时刻它可能运动到小孔 $i \bmod 2n + 1$ 或 $(i + n) \bmod 2n + 1$，概率分别为 $1-p$ 和 $p$。

现在 tlx 有两个一模一样的引力机器，两个小球同时从 $1$ 号孔开始运动。他会**随机**（所有可能选择的概率相同）选择一个二元组 $(i,j)( 1\leqslant i\leqslant 2n,0\leqslant j\leqslant t,i,j\in \mathbb Z$ ) 分别代表小孔编号和时间，你需要求出时间为 $j$ 时两个引力机器的小孔 $i$ **同时**有小球**停留（运动经过小孔但瞬移到对面了不算停留）** 的概率。

注意：**小球刚开始运动时也可能瞬移到对面的小孔。**   

为方便计算，我们规定：所有概率都是在模 $10^9+7$ 意义下的。      

## 说明/提示

**【数据范围与约定】** 

**本题采用捆绑测试。**    

具体计分方式如下：   

- Subtask $1$ ($7$ points)：满足 $p\in \{0,1\}$；  
- Subtask $2$ ($13$ points)：满足 $t\leqslant 20,n\leqslant50$；  
- Subtask $3$ ($20$ points)：满足 $t\leqslant 10^3,n\leqslant50$；  
- Subtask $4$ ($10$ points)：满足 $t\leqslant 10^3$；  
- Subtask $5$ ($10$ points)：满足 $t\leqslant 10^6$；
- Subtask $6$ ($15$ points)：满足 $n\leqslant50$；
- Subtask $7$ ($25$ points)：无特殊限制。


对于 $100\%$ 的数据，满足 $2\leqslant n\leqslant 500$，$0\leqslant p\leqslant 10^9+6$，$0\leqslant t \leqslant 10^9$。  

**注意：不做说明的数据范围即为极限数据范围。**

**【样例解释 #1】**  

$500000004$ 是模 $10^9+7$ 意义下的 $\dfrac{1}{2}$。 

下面为了方便，记 $P(i,j)$ 为选择的二元组为 $(i,j)$ 时的概率。    

所有概率不为 $0$ 的二元组有：   
$P(1,0)=\dfrac{1}{4},P(3,0)=\dfrac{1}{4},P(2,1)=\dfrac{1}{4},P(4,1)=\dfrac{1}{4}$。    

所有可以选择的二元组有：   
$(1,0),(1,1),(2,0),(2,1),(3,0),(3,1),(4,0),(4,1)$，共 $8$ 种。    

所以总的概率：  
$$P=\dfrac{1}{8}×\dfrac{1}{4}×4+\dfrac{1}{8}×0×4=\dfrac{1}{8}$$

在模 $10^9+7$ 意义下为 $125000001$，即为输出的答案。

------------

**【其他提示】**

1. 如果你不了解分数取模，可以查看[这里](https://www.luogu.com.cn/problem/P2613)。  

2. 如果你不明白题目中角度的表示方法，可以查看[弧度制](https://baike.baidu.com/item/弧度制/3315973?fr=aladdin)。



## 样例 #1

### 输入

```
2 500000004 1```

### 输出

```
125000001```

## 样例 #2

### 输入

```
6 114514 11```

### 输出

```
756497239```

# AI分析结果


### 💡 Kay的C++算法解析：「EZEC-2」机器 深入学习指南 💡

#### 1. 题目解读与核心算法识别
✨ **本题主要考察**：`概率动态规划 + 矩阵快速幂优化`  
🗣️ **初步分析**：  
> 这道题就像两个小球在环形轨道上玩"瞬移捉迷藏"。核心思想是将小球位置概率建模为状态转移（类似棋盘上棋子移动的概率计算），再通过矩阵快速幂高效处理大范围时间步长（t ≤ 10⁹）。  
> - **核心难点**：小球位置由瞬移次数奇偶性决定，且每秒状态仅依赖前一秒状态  
> - **关键突破**：题解发现小球时刻只可能出现在相对的两个孔（fᵢ + gᵢ = 1），将2n维问题压缩为2维  
> - **可视化设计**：采用像素风环形轨道（FC游戏风格），用不同颜色方块表示：  
>   - 蓝色：普通移动路径  
> - 红色：瞬移通道  
> - 闪烁黄星：当前小球位置  
> - 每次瞬移时触发"嗖"音效，奇偶位置切换时轨道会8-bit像素抖动  

---

#### 2. 精选优质题解参考
**题解一（NaCly_Fish）**  
* **点评**：思路如手术刀般精准，发现瞬移奇偶性决定位置的核心性质（⭐️⭐️⭐️⭐️⭐️）。通过生成函数将概率求和转化为封闭形式（(1+(1-2p)ᵏ)/2），最终用等比数列求和实现O(log t)复杂度。代码仅需10行，但数学推导需要较强功底。

**题解二（hanzhongtlx）**  
* **点评**：提供扎实的概率DP框架（⭐️⭐️⭐️⭐️）。亮点在于用矩阵表述状态转移（fᵢ², gᵢ², fᵢgᵢ的递推），并发现fᵢ + gᵢ = 1的优化点。虽然矩阵构造稍复杂，但提供了从朴素DP到优化的完整思考路径。

**题解三（君のNOIP）**  
* **点评**：最佳教学向题解（⭐️⭐️⭐️⭐️）。分Subtask渐进讲解，从O(t) DP到矩阵快速幂，给出完整矩阵实现代码。特别欣赏其状态设计：Fᵢ,₀表示"预期位置"概率，Fᵢ,₁表示"瞬移位置"概率，直观易理解。

---

#### 3. 核心难点辨析与解题策略
1. **难点：状态空间的维度爆炸**  
   * **分析**：直接记录2n个孔概率需O(n²t)空间。优质题解发现：小球第i秒必定在编号(i mod 2n)或(i+n mod 2n)的孔，将状态压缩为二元组(fᵢ, gᵢ)  
   * 💡 **学习笔记**：找状态周期性是降维关键

2. **难点：大时间范围的计算**  
   * **分析**：t≤10⁹时无法线性递推。通过矩阵表示转移关系：  
     ```math
     \begin{bmatrix} f_{i} \\ g_{i} \end{bmatrix} = \begin{bmatrix} 1-p & p \\ p & 1-p \end{bmatrix} \begin{bmatrix} f_{i-1} \\ g_{i-1} \end{bmatrix}
     ```
     再通过矩阵快速幂在O(log t)时间内完成计算  
   * 💡 **学习笔记**：线性递推遇大范围，矩阵快速幂是救星

3. **难点：概率平方和的累积**  
   * **分析**：答案需∑(fᵢ² + gᵢ²)。利用(fᵢ + gᵢ)² = 1 ⇒ fᵢ² + gᵢ² = 1 - 2fᵢgᵢ，将问题转化为计算∑fᵢgᵢ  
   * 💡 **学习笔记**：遇平方和先想恒等变换

### ✨ 解题技巧总结
- **维数打击**：利用对称性将2n维压缩为2维
- **转移矩阵**：将递推式写成矩阵形式
- **分治幂**：用快速幂思想处理指数级迭代
- **模运算**：概率在模空间下仍保持运算律

---

#### 4. C++核心代码实现赏析
**通用核心实现（综合题解精华）**  
```cpp
const int MOD = 1e9+7;

qpow(ll x, ll n) { // 快速幂模板
    ll res = 1;
    while(n) {
        if(n & 1) res = res*x % MOD;
        x = x*x % MOD;
        n >>= 1;
    }
    return res;
}

int main() {
    ll n, p, t; 
    cin >> n >> p >> t;
    ll inv2n = qpow(2*n % MOD, MOD-2);
    ll invT = qpow(t+1, MOD-2);
    
    // 核心计算（基于NaCly_Fish公式）
    ll A = (1 - 2*p % MOD + MOD) % MOD;
    ll A2 = A*A % MOD;
    ll sum = (t+1) % MOD; 
    if(A2 != 1) { // 等比数列求和
        ll An = qpow(A2, t+1);
        sum = (qpow(A2, t+1) - 1) * qpow(A2-1, MOD-2) % MOD;
    }
    ll ans = inv2n * invT % MOD * sum % MOD;
    cout << ans;
}
```

**题解一代码片段赏析**  
```cpp
// 公式推导核心
ll even_k = (1 + qpow(1-2*p, k)) * inv2 % MOD;
ll odd_k = (1 - qpow(1-2*p, k)) * inv2 % MOD;
ans += (even_k*even_k + odd_k*odd_k) % MOD;
```
> **解读**：`qpow(1-2*p, k)`计算(1-2p)ᵏ，通过±1操作得到奇偶概率。**学习笔记**：概率问题常可转化为几何级数

**题解三矩阵实现**  
```cpp
struct Matrix {
    ll m[4][4];
    Matrix operator*(const Matrix &b) {
        // 矩阵乘法实现
    }
};

Matrix qpow(Matrix a, ll n) {
    // 矩阵快速幂
}

int main() {
    Matrix base = { /* 4x4转移矩阵 */ };
    Matrix res = qpow(base, t);
    ll S = res.m[0][0]; // 获取平方和累积值
}
```
> **解读**：将`[∑f²+g², fᵢ², gᵢ², fᵢgᵢ]`视为状态向量。**学习笔记**：高维DP常用矩阵封装

---

#### 5. 算法可视化：像素动画演示
**主题**：8-bit风格《环形瞬移大冒险》  
**核心设计**：  
![](https://cdn.luogu.com.cn/upload/image_hosting/el8alxde.png)  
1. **像素场景**：  
   - 环形轨道分割为16色像素块（n=2时8块）  
   - 小球用闪烁的4x4像素星星表示  
   - 瞬移通道用红色箭头连接相对孔洞  

2. **动态演示**：  
   ```python
   # 伪代码逻辑
   for t in range(max_time):
       绘制当前轨道和小球位置(蓝色星星在孔i，黄色在孔i+n)
       if 随机数 < p:  # 触发瞬移
           play_sound("嗖.wav")  # 8-bit音效
           当前小球位置 = (当前位置 + n) % 2n
           轨道高亮红色通道
       else:
           小球像素移动到下一孔
       if t % 2 == 0:  # 奇偶位置切换
           shake_canvas(3) # 像素抖动特效
   ```

3. **控制面板**：  
   - 速度滑块：调节帧间隔(100ms~2s)  
   - 奇偶追踪：用半透明色块显示历史奇(粉)/偶(绿)位置  
   - 数据面板：实时显示fₜ, gₜ概率值  

---

#### 6. 拓展练习与相似问题
1. **洛谷 P1357**：环形概率DP基础  
2. **洛谷 P2109**：矩阵加速递推应用  
3. **洛谷 P4921**：奇偶性在组合问题中的应用  

---

#### 7. 学习心得
> **hanzhongtlx的调试经验**："在验证fᵢ+gᵢ=1时，发现初始状态不满足，才注意到t=0时小球未移动的特殊情况"  
> **Kay点评**：边界条件往往是BUG温床，建议：  
> 1. 单独验证t=0,1等特殊输入  
> 2. 用assert(f+g == 1)辅助调试

---  
通过像素化的算法之旅，我们不仅理解了环形概率DP的精髓，更学会用矩阵手术刀解剖大数问题。记住，好的算法是数学与代码的协奏曲！🎮🔢

---
处理用时：97.00秒
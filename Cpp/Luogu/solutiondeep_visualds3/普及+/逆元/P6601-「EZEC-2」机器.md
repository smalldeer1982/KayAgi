# 题目信息

# 「EZEC-2」机器

## 题目背景

tlx 喜欢科幻小说。   

>小宇宙中只剩下漂流瓶和生态球。漂流瓶隐没于黑暗里,在一千米见方的宇宙中,只有生态球里的小太阳发出一点光芒。在这个小小的生命世界中,几只清澈的水球在零重力环境中静静地飘浮着,有一条小鱼从一只水球中蹦出,跃入另一只水球,轻盈地穿游于绿藻之间。在一小块陆地上的草丛中,有一滴露珠从一片草叶上脱离,旋转着飘起,向太空中折射出一缕晶莹的阳光。    
>$\qquad \qquad \qquad \qquad \qquad \qquad \qquad\qquad\qquad\qquad\qquad\qquad\qquad --$《三体》    

在另一个宇宙，将是另一番奇景吧。    

在那里，重力似乎变得微不足道了，引力机器成了司空见惯的东西。

引力机器装置内并没有重力，即若有物体在机器上运动，运动过程中只受机器给予的引力，这个力有一定几率使物体向施力物体快速移动，达到一定动力时就可以实现瞬移。



## 题目描述

一个引力机器由一个光滑圆轨道和 $2n$ 个小孔组成（小孔按**逆时针**从 $1$ 到 $2n$ 编号，每两个相邻的小孔所夹的**劣弧**度数为 $\dfrac{\pi}{n}$ ），每个小孔与和其夹角为 $\pi$ 的另一个小孔有通道相连，比如当 $n=2$ 时，$1$ 号孔和 $3$ 号孔相连。

当 $n=2$ 时，这个装置的构造大概是这样的：
 
 ![](https://cdn.luogu.com.cn/upload/image_hosting/el8alxde.png) 
 
现在我们在 $1$ 号孔处放一个小球，使它一直**沿逆时针方向做匀速圆周运动**，在不瞬移的情况下，每一秒恰好能从一个小孔运动至下一个小孔。

由于未来实验室构造奇特（内部的引力提供装置太神了！），每经过一个小孔时，有 $p$ 的概率**立刻瞬移**（即不花费时间）到通道对面的小孔并继续沿逆时针方向做匀速圆周运动，也就是有 $1-p$ 的概率继续沿圆周向下一个小孔运动。

值得注意的是，**每一单位时刻，小球只能瞬移一次**。  

简单地说，若某一时刻小球在小孔 $i$，则下一时刻它可能运动到小孔 $i \bmod 2n + 1$ 或 $(i + n) \bmod 2n + 1$，概率分别为 $1-p$ 和 $p$。

现在 tlx 有两个一模一样的引力机器，两个小球同时从 $1$ 号孔开始运动。他会**随机**（所有可能选择的概率相同）选择一个二元组 $(i,j)( 1\leqslant i\leqslant 2n,0\leqslant j\leqslant t,i,j\in \mathbb Z$ ) 分别代表小孔编号和时间，你需要求出时间为 $j$ 时两个引力机器的小孔 $i$ **同时**有小球**停留（运动经过小孔但瞬移到对面了不算停留）** 的概率。

注意：**小球刚开始运动时也可能瞬移到对面的小孔。**   

为方便计算，我们规定：所有概率都是在模 $10^9+7$ 意义下的。      

## 说明/提示

**【数据范围与约定】** 

**本题采用捆绑测试。**    

具体计分方式如下：   

- Subtask $1$ ($7$ points)：满足 $p\in \{0,1\}$；  
- Subtask $2$ ($13$ points)：满足 $t\leqslant 20,n\leqslant50$；  
- Subtask $3$ ($20$ points)：满足 $t\leqslant 10^3,n\leqslant50$；  
- Subtask $4$ ($10$ points)：满足 $t\leqslant 10^3$；  
- Subtask $5$ ($10$ points)：满足 $t\leqslant 10^6$；
- Subtask $6$ ($15$ points)：满足 $n\leqslant50$；
- Subtask $7$ ($25$ points)：无特殊限制。


对于 $100\%$ 的数据，满足 $2\leqslant n\leqslant 500$，$0\leqslant p\leqslant 10^9+6$，$0\leqslant t \leqslant 10^9$。  

**注意：不做说明的数据范围即为极限数据范围。**

**【样例解释 #1】**  

$500000004$ 是模 $10^9+7$ 意义下的 $\dfrac{1}{2}$。 

下面为了方便，记 $P(i,j)$ 为选择的二元组为 $(i,j)$ 时的概率。    

所有概率不为 $0$ 的二元组有：   
$P(1,0)=\dfrac{1}{4},P(3,0)=\dfrac{1}{4},P(2,1)=\dfrac{1}{4},P(4,1)=\dfrac{1}{4}$。    

所有可以选择的二元组有：   
$(1,0),(1,1),(2,0),(2,1),(3,0),(3,1),(4,0),(4,1)$，共 $8$ 种。    

所以总的概率：  
$$P=\dfrac{1}{8}×\dfrac{1}{4}×4+\dfrac{1}{8}×0×4=\dfrac{1}{8}$$

在模 $10^9+7$ 意义下为 $125000001$，即为输出的答案。

------------

**【其他提示】**

1. 如果你不了解分数取模，可以查看[这里](https://www.luogu.com.cn/problem/P2613)。  

2. 如果你不明白题目中角度的表示方法，可以查看[弧度制](https://baike.baidu.com/item/弧度制/3315973?fr=aladdin)。



## 样例 #1

### 输入

```
2 500000004 1```

### 输出

```
125000001```

## 样例 #2

### 输入

```
6 114514 11```

### 输出

```
756497239```

# AI分析结果


### 💡 Kay的C++算法解析：「EZEC-2」机器 深入学习指南 💡

#### 1. 题目解读与核心算法识别
✨ **本题主要考察**：`概率DP与生成函数优化`  
🗣️ **初步分析**：  
> 解决本题的关键是理解小球位置由瞬移次数的**奇偶性**决定（类似抛硬币的奇偶概率问题）。想象两个机器是独立的硬币抛掷器，瞬移次数奇偶性相同时小球才会停在同一点。  
> - **核心思路**：通过二项式定理将奇偶概率转化为闭式解（题解1/4），或用矩阵快速幂递推位置概率平方和（题解2/3）  
> - **难点对比**：闭式解更简洁（O(log t)），矩阵法更通用（适用于更复杂的状态转移）  
> - **可视化设计**：采用像素圆环展示小球运动。高亮当前孔位（黄色像素块），瞬移时播放“叮”音效，奇偶相同触发绿色闪光特效。自动演示模式可调速展示概率变化过程  

---

#### 2. 精选优质题解参考
**题解一（NaCly_Fish）**  
* **点评**：  
  思路直击本质——利用**瞬移奇偶性等价位置相同**的洞察（✨亮点）。通过二项式定理将概率求和转化为闭式解，数学推导严谨优美。代码实现仅需快速幂和逆元（<20行），复杂度O(log t)碾压其他解法。边界处理完整，直接输出最终答案公式，竞赛实战价值极高。

**题解二（君のNOIP）**  
* **点评**：  
  提供完整解题路径：从暴力DP（O(t)）→状态压缩（O(1)转移）→矩阵快速幂（O(log t)）。代码规范（✨亮点）：矩阵乘法封装清晰，变量名`Base`/`Ans`含义明确。特别学习点：平方和递推中巧妙构造4×4矩阵维护交叉项，避免冗余计算。

**题解三（hanzhongtlx）**  
* **点评**：  
  建立概率DP模型时精准定位**位置概率的对称性**（✨亮点）：发现$f_i+g_i=1$后，将平方和转化为$1-2f_ig_i$简化计算。矩阵构造虽稍复杂，但完整呈现状态转移的数学本质，适合理解概率DP的底层机制。

---

#### 3. 核心难点辨析与解题策略
1. **瞬移的位置等价性**  
   *分析*：小球位置仅取决于瞬移次数的奇偶性（模2同余）。题解1/4用二项式定理证明：$\text{even}_k=\frac{1}{2}(1+(1-2p)^k)$  
   💡 **学习笔记**：识别问题中的**不变量**（奇偶性）是优化关键

2. **联合概率的平方和处理**  
   *分析*：两个机器独立需计算$P^2$。闭式解直接平方（题解1），矩阵法递推$f_i^2+g_i^2$（题解2/3）。交叉项处理见题解2的矩阵构造  
   💡 **学习笔记**：独立事件的联合概率=概率乘积 → 平方和=各概率平方和

3. **大范围时间求和**  
   *分析*：t≤1e9需O(log t)算法。闭式解用等比数列求和（题解1），矩阵法用快速幂（题解2/3）  
   💡 **学习笔记**：遇到∑[0,t]形式时，优先检查能否转化为等比/矩阵幂

### ✨ 解题技巧总结
- **模型抽象**：将物理运动转化为奇偶计数（题解1/4）  
- **维度压缩**：发现仅2种有效状态（题解2/3）  
- **数学工具**：二项式定理、矩阵特征值加速递推  

---

#### 4. C++核心代码实现赏析
**通用核心实现**（闭式解）
```cpp
#include <cstdio>
#define mod 1000000007
typedef long long ll;

ll qpow(ll x, ll n) { // 快速幂
    ll res = 1;
    while (n) {
        if (n & 1) res = res * x % mod;
        x = x * x % mod; n >>= 1;
    }
    return res;
}

int main() {
    ll n, p, t; scanf("%lld%lld%lld", &n, &p, &t);
    ll inv = qpow(2 * n % mod * (t + 1) % mod, mod - 2); // 分母逆元
    ll q = (1 - 2 * p % mod + mod) % mod; // 公比(1-2p)
    ll q2 = qpow(q, 2), qt = qpow(q2, t + 1); // (1-2p)^(2t+2)
    // 闭式解：ans = (t+1 + (q^2-qt)/(1-q^2)) / (4n(t+1))
    ll fenzi = (t + 1) % mod * (1 - qt + mod) % mod;
    fenzi = fenzi * qpow((1 - q2 + mod) % mod, mod - 2) % mod;
    printf("%lld", (fenzi + t + 1) % mod * inv % mod);
}
```
* **代码解读概要**：  
  1. 计算公比 `q=1-2p` 和其平方 `q2`  
  2. 等比求和公式求 $\sum_{k=0}^{t}(1-2p)^{2k}$  
  3. 合并答案项并乘分母逆元  

**题解一（奇偶概率法）核心片段**
```cpp
ll even_k = (1 + qpow(1-2*p, k)) * inv2 % mod; // 偶数次瞬移概率
ll odd_k = (1 - qpow(1-2*p, k) + mod) * inv2 % mod; // 奇数次
ans = (ans + (even_k*even_k + odd_k*odd_k) % mod) % mod;
```
* **亮点**：数学优化极致  
* **学习笔记**：利用$[i\bmod 2=0]=\frac{1+(-1)^i}{2}$的二项式展开是核心技巧  

**题解二（矩阵法）核心片段**
```cpp
// 构造转移矩阵（4维维护平方和）
Base[1][1]=1; Base[2][1]=Base[3][1]=1;
Base[2][2]=Base[3][3]=(1-p)*(1-p)%mod;
Base[2][3]=Base[3][2]=p*p%mod;
Base[4][2]=Base[4][3]=2*p*(1-p)%mod;
```
* **亮点**：通用递推结构  
* **学习笔记**：高维状态优先用矩阵，注意利用对称性降维  

---

### 5. 算法可视化：像素动画演示
**主题**：像素宇宙中的双球舞蹈  
**核心演示**：奇偶性如何决定小球相遇  

**设计思路**：  
> 8-bit像素风圆环分为2n孔位（仿《三体》引力机）。双球用红/蓝像素块表示，瞬移时划出像素轨迹，奇偶相同触发星云特效。  

**动画流程**：  
1. **初始化**：  
   - 复古CRT风格界面，圆环中央显示`p=0.3`等参数  
   - 控制面板：▶️暂停/⏩单步/🎚️速度条/🔁自动演示  

2. **运动帧**：  
   - **正常移动**：蓝球逆时针跳动，伴随电子音效  
   - **瞬移**：按概率p触发，红球闪现到对面孔位，触发“叮”声  
   - **奇偶标识**：球体上方显示二进制计数器（奇=1/偶=0）  

3. **相遇判定**：  
   - 当两球奇偶计数器末位相同：双球融合为紫色，播放8-bit胜利音效  
   - 统计区同步更新相遇概率曲线（像素折线图）  

4. **自动演示**：  
   - 调速滑块控制模拟速度（0.5x-10x）  
   - 实时显示公式计算值 vs 动画统计值  

**技术实现**：  
- Canvas绘制动态圆环，requestAnimationFrame驱动  
- 音效：Web Audio生成方波音效（瞬移=440Hz短脉冲）  

---

### 6. 拓展练习
1. **洛谷P2634**：利用奇偶性的树上路径统计  
2. **洛谷P1357**：概率DP+矩阵优化的经典题  
3. **洛谷P1939**：高维矩阵快速幂应用  

---

### 7. 学习心得
> **题解1作者洞察**：  
> *“容易发现性质：位置等价于瞬移奇偶性”*  
> **Kay点评**：启示我们挖掘问题中的**隐藏等价关系**，这是优化复杂度的钥匙。在类似问题中（如状态压缩DP），寻找此类不变量应是首要思考方向。  

--- 
通过本次分析，我们深入理解了概率模型中的奇偶性优化与高效求和技巧。动手实现像素动画能直观感受概率收敛过程，矩阵法则展示了状态递推的通用框架。现在就去洛谷挑战推荐题目吧！💪

---
处理用时：103.72秒
# 题目信息

# [NOI2018] 屠龙勇士

## 题目描述

小 D 最近在网上发现了一款小游戏。游戏的规则如下：

- 游戏的目标是按照编号 $1 \rightarrow n$ 顺序杀掉 $n$ 条巨龙，每条巨龙拥有一个初始的生命值 $a_i$ 。同时每条巨龙拥有恢复能力，当其使用恢复能力时，它的生命值就会每次增加 $p_i$ ，直至生命值非负。只有在攻击结束后且当生命值 **恰好** 为 $0$ 时它才会死去。
- 游戏开始时玩家拥有 $m$ 把攻击力已知的剑，每次面对巨龙时，玩家只能选择一把剑，当杀死巨龙后这把剑就会消失，但作为奖励，玩家会获得全新的一把剑。

小 D 觉得这款游戏十分无聊，但最快通关的玩家可以获得 ION2018 的参赛资格，于是小 D 决定写一个笨笨的机器人帮她通关这款游戏，她写的机器人遵循以下规则：

- 每次面对巨龙时，机器人会选择当前拥有的，攻击力不高于巨龙初始生命值中攻击力最大的一把剑作为武器。如果没有这样的剑，则选择 **攻击力最低** 的一把剑作为武器。
- 机器人面对每条巨龙，它都会使用上一步中选择的剑攻击巨龙固定的 $x$ 次，使巨龙的生命值减少 $x \times ATK$ 。
- 之后，巨龙会不断使用恢复能力，每次恢复 $p_i$ 生命值。若在使用恢复能力前或某一次恢复后其生命值为 $0$ ，则巨龙死亡，玩家通过本关。

那么显然机器人的攻击次数是决定能否最快通关这款游戏的关键。小 D 现在得知了每条巨龙的所有属性，她想考考你，你知道应该将机器人的攻击次数 $x$ 设置为多少，才能用最少的攻击次数通关游戏吗？

当然如果无论设置成多少都无法通关游戏，输出 $-1$ 即可。

## 说明/提示

### 更多样例

更多样例请在附加文件中下载。

### 样例 2

见附加文件中的 `dragon2.in` 与 `dragon2.ans`。

### 样例 1 解释

第一组数据：
- 开始时拥有的剑的攻击力为 $\{1,9,1000\}$，第 $1$ 条龙生命值为 $3$，故选择攻击力为 $1$ 的剑，攻击 $59$ 次，造成 $59$ 点伤害，此时龙的生命值为 $-56$，恢复 14 次后生命值恰好为 $0$，死亡。

- 攻击力为 $1$ 的剑消失，拾取一把攻击力为 $7$ 的剑，此时拥有的剑的攻击力为
$\{7,9,1000\}$，第 2 条龙生命值为 $5$，故选择攻击力为 $7$ 的剑，攻击 $59$ 次，造成 $413$ 点伤害，此时龙的生命值为 $-408$，恢复 $68$ 次后生命值恰好为 $0$，死亡。

- 此时拥有的剑的攻击力为 $\{3,9,1000\}$，第 $3$ 条龙生命值为 $7$，故选择攻击力为 $3$ 的剑，攻击 $59$ 次，造成 $177$ 点伤害，此时龙的生命值为 $-170$，恢复 $17$ 次后生命值恰好为 0，死亡。

- 没有比 $59$ 次更少的通关方法，故答案为 $59$。

第二组数据：
不存在既能杀死第一条龙又能杀死第二条龙的方法，故无法通关，输出 $-1$。

### 子任务

测试点编号 |　　　$n$　　　|　　　$m$　　　|　　　$p_i$　　　|　　　$a_i$　　　| 　　攻击力　　 | 其他限制
-|-|-|-|-|-|-
1|$\le 10^5$|$=1$|$=1$|$\le 10^5$|$=1$| 无
2|$\le 10^5$|$=1$|$=1$|$\le 10^5$|$=1$| 无
3|$\le 10^5$|$=1$|$=1$|$\le 10^5$|$\le 10^5$| 无
4|$\le 10^5$|$=1$|$=1$|$\le 10^5$|$\le 10^5$| 无
5|$\le 10^3$|$\le 10^3$|$\le 10^5$|$\le 10^5$|$\le 10^5$| 特性 1、特性 2
6|$\le 10^3$|$\le 10^3$|$\le 10^5$|$\le 10^5$|$\le 10^5$| 特性 1、特性 2
7|$\le 10^3$|$\le 10^3$|$\le 10^5$|$\le 10^5$|$\le 10^5$| 特性 1、特性 2
8|$=1$|$=1$|$\le 10^8$|$\le 10^8$|$\le 10^6$| 特性 1
9|$=1$|$=1$|$\le 10^8$|$\le 10^8$|$\le 10^6$| 特性 1
10|$=1$|$=1$|$\le 10^8$|$\le 10^8$|$\le 10^6$| 特性 1
11|$=1$|$=1$|$\le 10^8$|$\le 10^8$|$\le 10^6$| 特性 1
12|$=1$|$=1$|$\le 10^8$|$\le 10^8$|$\le 10^6$| 特性 1
13|$=1$|$=1$|$\le 10^8$|$\le 10^8$|$\le 10^6$| 特性 1
14|$=10^5$|$=10^5$|$=1$|$\le 10^8$|$\le 10^6$| 无特殊限制
15|$=10^5$|$=10^5$|$=1$|$\le 10^8$|$\le 10^6$| 无特殊限制
16|$\le 10^5$|$\le 10^5$| 所有 $p_i$ 是质数 |$\le 10^{12}$|$\le 10^6$| 特性 1
17|$\le 10^5$|$\le 10^5$| 所有 $p_i$ 是质数 |$\le 10^{12}$|$\le 10^6$| 特性 1
18|$\le 10^5$|$\le 10^5$| 无特殊限制 |$\le 10^{12}$|$\le 10^6$| 特性 1
19|$\le 10^5$|$\le 10^5$| 无特殊限制 |$\le 10^{12}$|$\le 10^6$| 特性 1
20|$\le 10^5$|$\le 10^5$| 无特殊限制 |$\le 10^{12}$|$\le 10^6$| 特性 1

特性 1 是指：对于任意的 $i$，$a_i \le p_i$。

特性 2 是指：$\operatorname{lcm}(p_i) \le 10^6$，即所有 $p_i$ 的 **最小公倍数** 不大于 $10^6$。

对于所有的测试点，$T \le 5$，所有武器的攻击力 $\le 10^6$，所有 $p_i$ 的最小公倍数 $\le 10^{12}$。

保证 $ T, n, m $ 均为正整数。

### 提示

你所用到的中间结果可能很大，注意保存中间结果的变量类型。

## 样例 #1

### 输入

```
2
3 3
3 5 7
4 6 10
7 3 9
1 9 1000
3 2
3 5 6
4 8 7
1 1 1
1 1```

### 输出

```
59
-1```

# AI分析结果


# 💡 Kay的C++算法解析：[NOI2018]屠龙勇士 深入学习指南 💡

> 今天我们来分析NOI2018的经典题目「屠龙勇士」。这道题将带你深入理解扩展中国剩余定理（ExCRT）的应用技巧，并学会处理复杂同余方程组的转化与求解。本指南将结合清晰的算法分析和生动的像素动画演示，助你彻底掌握解题精髓！

## 1. 题目解读与核心算法识别

✨ **本题主要考察**：`扩展中国剩余定理（ExCRT）`与`带系数同余方程转化`

🗣️ **初步分析**：
> 解决「屠龙勇士」的关键在于将游戏规则转化为**带系数的同余方程组**。每条龙对应一个方程 $ATK_i \times x \equiv a_i \pmod{p_i}$，其中 $ATK_i$ 是剑的攻击力，$a_i$ 是巨龙生命值，$p_i$ 是恢复能力。解题核心分为两步：
> 1. **预处理**：用平衡树（如`multiset`）动态选择每场战斗的剑
> 2. **方程转化**：通过扩展欧几里得（exgcd）将带系数方程化为标准 ExCRT 形式 $x \equiv c_i \pmod{m_i}$
>
> **可视化设计**：我们将用像素动画展示剑选择过程（巨龙像素形象，剑光闪烁特效）和方程合并过程（网格表示模数空间，颜色标记当前合并状态）。复古游戏风格将加入8-bit音效：剑击声（金属碰撞音）、方程合并成功（上升音阶）、错误（警示音）。

---

## 2. 精选优质题解参考

**题解一：(来源：emptysetvvvv)**
* **点评**：此解法思路清晰，直接点明问题本质是同余方程组求解。亮点在于：
  - 用`multiset`高效处理剑的选择（$O(n \log m)$）
  - 将 $ATK_i x \equiv a_i \pmod{p_i}$ 转化为 $x \equiv c_i \pmod{m_i}$ 的标准形式
  - 代码中巧妙使用`__int128`防止溢出
  - 边界处理严谨（检查解是否满足最小攻击次数）
  > *学习点：复杂问题的清晰分解能力*

**题解二：(来源：shadowice1984)**
* **点评**：此解突出特殊情况的处理技巧：
  - $p_i=1$ 时直接取 $\max \lceil a_i / ATK_i \rceil$
  - $a_i = p_i$ 时转化为求最小公倍数
  - 详细推导了 exgcd 解不定方程的过程
  > *学习点：特判逻辑的完整性*

**题解三：(来源：FlashHu)**
* **点评**：此解提供直接合并带系数方程的创新思路：
  - 不转化为标准形式，直接推导 ExCRT 合并公式
  - 优化 exgcd 的调用次数
  - 强调快速乘（龟速乘）的必要性
  > *学习点：数学公式的直接推导能力*

---

## 3. 核心难点辨析与解题策略

1.  **难点：动态剑选择**
    * **分析**：剑的选择需满足"不高于生命值的最大剑"的规则，且集合动态变化。**平衡树**是高效解决方案（`multiset`或手写Treap）。
    * 💡 **学习笔记**：动态查询问题优先考虑平衡数据结构

2.  **难点：带系数方程转化**
    * **分析**：关键在解 $ATK_i x + p_i y = a_i$：
      ```python
      g = exgcd(ATK_i, p_i, x, y)  # 求gcd和特解
      m_i = p_i // g               # 新模数
      c_i = (a_i // g) * x % m_i   # 新余数
      ```
    * 💡 **学习笔记**：系数转化本质是exgcd求逆元

3.  **难点：大数溢出处理**
    * **分析**：$a_i, p_i$ 高达 $10^{12}$，乘法需用**龟速乘**（二进制分解乘法）：
      ```cpp
      ll mul(ll a, ll b, ll mod) {
        ll res = 0;
        while (b) {
          if (b & 1) res = (res + a) % mod;
          a = (a << 1) % mod;
          b >>= 1;
        }
        return res;
      }
      ```
    * 💡 **学习笔记**：任何模数超过$10^9$的乘法都需防溢出

### ✨ 解题技巧总结
- **数据结构优化**：用`multiset`处理动态集合查询
- **数学转化**：exgcd化系数为1（核心技巧）
- **边界处理**：特判 $p_i=1$ 和 $a_i=p_i$ 的情况
- **溢出防御**：龟速乘代替直接乘法

---

## 4. C++核心代码实现赏析

**通用核心实现参考**
* **说明**：综合优质题解，处理剑选择+方程转化+ExCRT合并
* **完整核心代码**：
  ```cpp
  #include <set>
  #include <vector>
  using namespace std;
  typedef long long ll;
  
  ll exgcd(ll a, ll b, ll &x, ll &y) {
    if (!b) { x = 1; y = 0; return a; }
    ll g = exgcd(b, a % b, y, x);
    y -= a / b * x;
    return g;
  }
  
  ll mul(ll a, ll b, ll p) { /* 龟速乘 */ }
  
  ll solve() {
    multiset<ll> swords;
    // 读入数据+初始化
    for (int i = 0; i < n; i++) {
      auto it = swords.upper_bound(a[i]);
      if (it != swords.begin()) it--;
      ll atk = *it;
      swords.erase(it);
      swords.insert(new_sword[i]);
      
      // 解 ATK * x ≡ a_i (mod p_i)
      ll x, y, g = exgcd(atk, p[i], x, y);
      if (a[i] % g) return -1; // 无解
      ll m_i = p[i] / g;
      c[i] = mul((a[i] / g), (x % m_i + m_i) % m_i, m_i);
    }
    // ExCRT合并方程
    ll M = 1, ans = 0;
    for (int i = 0; i < n; i++) {
      // 合并 ans + M * t ≡ c_i (mod m_i)
      // ...
    }
    return ans;
  }
  ```

**题解片段赏析**  
*题解一：方程转化*
```cpp
g = exgcd(ATK[i], p[i], x, y);
p[i] /= g;
x = (x % p[i] + p[i]) % p[i];
c[i] = mul(x, a[i]/g, p[i]);
```
> **解读**：此片段展示系数转化核心步骤。先计算gcd保证可解性，再调整解在模数范围内，最后用龟速乘计算新余数。

*题解二：龟速乘*
```cpp
ll mul(ll a, ll b, ll p) {
  ll res = 0;
  for (; b; b >>= 1, a = (a<<1)%p) 
    if (b&1) res = (res + a) % p;
  return res;
}
```
> **解读**：通过二进制分解将乘法转化为加法，避免溢出。时间复杂度$O(\log b)$，是数论题的安全保障。

---

## 5. 算法可视化：像素动画演示

**主题**："龙与剑的数学冒险"（8-bit RPG风格）

**核心演示内容**：
1. **剑选择阶段**：
   - 像素龙显示生命值$a_i$，剑库显示可用剑
   - 高亮符合规则的剑（攻击力≤生命值的最大剑）
   - 选择时播放"金属碰撞"音效

2. **方程转化阶段**：
   ```mermaid
   graph LR
   A[ATK*x ≡ a mod p] --> B[ATK*x + p*y = a]
   B --> C[exgcd求解]
   C --> D[x ≡ c mod m]
   ```
   - 可视化exgcd计算过程（逐步显示辗转相除）

3. **ExCRT合并**：
   - 两个方程表示为像素网格（模数空间）
   - 合并时网格叠加，显示新解空间形成
   - 成功时播放"升级"音效

**交互控制**：
- 单步执行：空格键逐步推进
- 自动播放：A键启动/暂停
- 速度调节：←→键调整动画速度

**游戏化元素**：
- 每成功合并一个方程获得"数学宝石"
- 最终解出x时巨龙像素爆炸，显示"Victory!"
- 背景音乐：芯片音乐版《Dragon Quest》主题曲

---

## 6. 拓展练习与相似问题

1. **洛谷P3868**：简单同余方程练习  
   > *"巩固基础同余方程解法"*

2. **洛谷P4777**：扩展中国剩余定理模板  
   > *"掌握ExCRT的标准应用场景"*

3. **CodeForces 338D**：带系数的同余方程组  
   > *"挑战更复杂的系数处理技巧"*

---

## 7. 学习心得与经验分享

> **参考经验**：  
> "调试时发现龟速乘忘记处理负数，导致WA。切记：龟速乘需先取模绝对值！"  
> —— emptysetvvvv

> **Kay点评**：  
> 数论题需特别注意**边界情况**和**溢出防御**。建议：
> 1. 所有乘法前先取模
> 2. 负数转正处理
> 3. 用统一封装函数代替直接运算

---

> 本次分析就到这里。记住，屠龙勇士的终极武器不是剑，而是严谨的数学思维！下次挑战再见！💪

---
处理用时：184.61秒
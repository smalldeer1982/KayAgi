# 题目信息

# [USACO10HOL] Driving Out the Piggies G

## 题目描述

奶牛们制造了一种随机臭弹，目的是驱赶小猪。小猪文明由 $ N (2 \leq N \leq 300) $ 个小猪城市组成，这些城市编号为 1 到 N，通过 $ M (1 \leq M \leq 44,850) $ 条双向道路连接，具体由它们的不同端点 $A_j$ 和 $B_j$ 指定 $ (1 \leq A_j \leq N; 1 \leq B_j \leq N) $。小猪城市 $1$ 总是与至少一个其他城市相连。

臭弹在小猪城市 $1$ 部署。每小时（包括第一小时），它有 $P/Q (1 \leq P \leq 1,000,000, 1 \leq Q \leq 1,000,000; P \leq Q) $ 的概率爆炸并污染它所在的城市。如果它没有爆炸，它会随机选择一条通往其他城市的道路并沿着它走，直到到达一个新城市。所有从一个城市出发的道路被选择的概率相同。

由于臭弹的随机性质，奶牛们想知道哪些城市最有可能被污染。给定小猪文明的地图以及臭弹在每个小时内爆炸的概率，计算每个城市被污染的概率。

例如，假设小猪文明由两个城市组成并且相连，臭弹从城市 $1$ 开始，每次进入一个城市时有 $\frac12$ 的概率爆炸：

1--2

我们有以下可能的臭弹路径（最后一个城市是终点城市）：

1: 1

2: 1-2

3: 1-2-1

4: 1-2-1-2

5: 1-2-1-2-1

等等。
要找到臭弹最终停留在城市 $1$ 的概率，我们可以将上述每条路径的概率相加（具体来说，就是上述列表中每一个奇数编号的路径）。选择第 $k$ 条路径的概率正好是 $(1/2)^k$ ——臭弹必须在前 $k-1$ 次不留在它的城市（每次概率为 $1-\frac12=\frac12$），然后在最后一个城市停留（概率为 $\frac12$）。

因此，我们在城市 $1$ 停留的概率由无穷级数 $\displaystyle\sum_{2\nmid k}\left(\frac12\right)^k$ 表示。当我们无限地求和这些项时，最终得到的概率恰好是 $\frac23$，大约为 $0.666666667$。这意味着在城市 $2$ 停留的概率是 $\frac13$，大约为 $0.333333333$。

## 说明/提示

感谢 @[Alpha](https://www.luogu.com.cn/user/87058) 贡献 Special Judge。

## 样例 #1

### 输入

```
2 1 1 2 
1 2 
```

### 输出

```
0.666666667 
0.333333333 
```

# AI分析结果


### 💡 Kay的C++算法解析：P2973 [USACO10HOL] Driving Out the Piggies G 深入学习指南 💡

#### 1. 题目解读与核心算法识别
✨ **本题主要考察**：`数学（高斯消元）`

🗣️ **初步分析**：
> 解决这道题的核心在于理解炸弹随机移动与爆炸的转移过程，并用**高斯消元法**求解线性方程组。想象每个城市是蓄水池，炸弹移动是水流扩散（期望转移），爆炸是水池漏水（概率消耗）。关键步骤：
> - **建立方程**：每个城市爆炸概率 = 相邻城市转移概率之和 × (1-爆炸概率)
> - **特殊处理**：起点城市需额外增加初始概率
> - **可视化设计**：用像素水流动画展示期望转移（蓝色水流扩散），爆炸时城市闪烁红光，高斯消元过程用像素天秤平衡动画呈现

---

#### 2. 精选优质题解参考
**题解一（jun头吉吉）**  
* **点评**：  
  用游戏例子生动引入方程思想（★5），代码规范命名清晰（`f[u]`表期望），核心逻辑直白：  
  ```数学
  x₁ = P/Q + Σ[xⱼ×(1-P/Q)/dⱼ] 
  xᵢ = Σ[xⱼ×(1-P/Q)/dⱼ] (i≠1)
  ```
  亮点：通过「游戏回合」类比化解题思路，边界处理严谨（起点单独处理）。

**题解二（Siyuan）**  
* **点评**：  
  理论推导严谨（★5），代码模块化强（分离高斯消元函数），空间优化到位：  
  ```cpp
  for (int k=i+1; k<=n; ++k) {
    double d = a[k][i]/a[i][i];  // 消元系数计算
    b[k] -= d*b[i];              // 常数项同步消元
  }
  ```
  亮点：明确概率与期望的转化关系（爆炸概率=期望次数×P/Q）。

**题解三（whhsteven）**  
* **点评**：  
  理论洞察深刻（★4），提出「期望次数×爆炸概率=总概率」的本质关系：  
  > "炸弹在某个节点爆炸的概率等于该节点期望经过次数乘以爆炸概率"  
  亮点：从随机变量独立性角度严格论证解法正确性。

---

#### 3. 核心难点辨析与解题策略
1. **难点1：方程构建（概率流向分析）**  
   * **分析**：每个节点的概率来源=相邻节点流入×转移概率，起点需额外加初始概率。优质题解均用`deg[v]`精确计算转移权重。
   * 💡 学习笔记：概率问题可转化为期望问题简化建模

2. **难点2：环状转移处理（后效性）**  
   * **分析**：图中存在环路导致无法直接递推，高斯消元通过矩阵运算一次性解决所有依赖。
   * 💡 学习笔记：当问题呈现多状态循环依赖时，优先考虑高斯消元

3. **难点3：数值稳定性（精度控制）**  
   * **分析**：消元时需选取绝对值最大的主元（如Kelin题解`fabs(a[j][i])>fabs(a[p][i])`），避免除零错误。
   * 💡 学习笔记：浮点运算需设置误差阈值（如`eps=1e-13`）

✨ **解题技巧总结**：
- **转移方程抽象**：将概率流动具象化为水流模型
- **模块化消元**：分离高斯消元函数提升复用性
- **边界防御**：单独处理起点和孤立节点
- **精度保障**：主元选取+误差阈值双保险

---

#### 4. C++核心代码实现赏析
**本题通用核心实现**  
```cpp
#include <iostream>
#include <vector>
#include <cmath>
#include <iomanip>
using namespace std;
const double eps = 1e-12;

void Gauss(vector<vector<double>>& a, int n) {
    for (int i = 0; i < n; i++) {
        int maxr = i;
        for (int k = i + 1; k < n; k++)
            if (fabs(a[k][i]) > fabs(a[maxr][i])) maxr = k;
        for (int k = i; k <= n; k++) swap(a[i][k], a[maxr][k]);
        for (int k = 0; k < n; k++) {
            if (k == i) continue;
            double factor = a[k][i] / a[i][i];
            for (int j = i; j <= n; j++) 
                a[k][j] -= factor * a[i][j];
        }
    }
}

int main() {
    int n, m, p, q;
    cin >> n >> m >> p >> q;
    double P = p * 1.0 / q;
    vector<vector<double>> mat(n, vector<double>(n + 1, 0));
    vector<int> deg(n, 0);
    vector<vector<int>> G(n);

    while (m--) {
        int u, v; cin >> u >> v; u--; v--;
        G[u].push_back(v); G[v].push_back(u);
        deg[u]++; deg[v]++;
    }

    // 构建方程：mat[i][j] = 转移系数, mat[i][n] = 常数项
    for (int i = 0; i < n; i++) {
        mat[i][i] = 1.0;  // 主对角线系数
        for (int v : G[i]) {
            mat[i][v] -= (1 - P) / deg[v]; // 移项后负号
        }
    }
    mat[0][n] = 1.0;  // 起点初始期望=1

    Gauss(mat, n);

    for (int i = 0; i < n; i++) 
        cout << fixed << setprecision(9) << mat[i][n] * P << endl;
}
```
**代码解读概要**：  
1. 邻接表存图（`G`）并记录度数（`deg`）
2. 初始化增广矩阵：主对角线=1，邻接点系数=`-(1-P)/deg[v]`
3. 起点常数项=1（初始期望）
4. 高斯消元后解向量×P得最终概率

---

#### 5. 算法可视化：像素动画演示
**主题**：《炸弹人像素冒险》  
**核心演示**：  
![](https://assets.algorithmhub.cn/visual/dotp-preview.gif)  
*(图：像素水流模拟期望转移过程)*

**交互设计**：
1. **初始化界面**：8位像素风城市网格（节点=彩色方块，边=发光管道）
2. **动态过程**：
   - 炸弹移动：像素炸弹沿管道跳动，伴随"滴答"音效
   - 期望转移：蓝色水流从高期望节点流向低期望节点
   - 爆炸特效：城市闪红光+爆炸音效，显示当前概率
3. **高斯消元演示**：
   - 左侧矩阵：像素数字实时变化
   - 右侧天平：方程平衡过程可视化（砝码=系数）
4. **控制面板**：
   - 速度滑块：调节动画速度
   - 单步模式：空格键逐步执行
   - 视角切换：城市视图/矩阵视图

**音效设计**：
- 移动：`8-bit脚步声`
- 爆炸：`低音爆破音`
- 消元成功：`清脆金属声`

---

#### 6. 拓展练习与相似问题
1. **技巧迁移**：  
   高斯消元解决后效性问题适用于：
   - 随机游走期望计算（环状依赖）
   - 电子电路节点分析（基尔霍夫定律）
   - 经济系统平衡模型

2. **推荐题目**：
   | 题号      | 题目名称                 | 推荐理由                     |
   |----------|------------------------|----------------------------|
   | P3232    | [HNOI2013]游走         | 边期望排序+高斯消元          |
   | P3211    | [HNOI2011]XOR和路径     | 位分解+期望消元              |
   | P1589    | 泥泞路                  | 线性方程组实际应用            |

---

#### 7. 学习心得与经验分享
> **作者调试经验**（jun头吉吉）：  
> *"方程构建时忘记起点特殊处理导致WA，建议用小样例（如2节点）验证边界"*  
> **Kay点评**：  
> 边界条件需优先验证！推荐调试方法：
> 1. 打印增广矩阵观察结构
> 2. 用样例`n=2,m=1`手工计算验证
> 3. 测试孤立节点（deg=0）防护

---

通过本指南，你掌握了概率建模的核心思想与高斯消元的实战应用。记住：**复杂问题本质往往是简单的流动平衡**。下次遇到随机过程问题，不妨先问自己：*"水流会如何流动？"*

---
处理用时：176.95秒
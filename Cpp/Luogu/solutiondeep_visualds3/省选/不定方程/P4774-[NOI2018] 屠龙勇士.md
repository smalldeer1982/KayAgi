# 题目信息

# [NOI2018] 屠龙勇士

## 题目描述

小 D 最近在网上发现了一款小游戏。游戏的规则如下：

- 游戏的目标是按照编号 $1 \rightarrow n$ 顺序杀掉 $n$ 条巨龙，每条巨龙拥有一个初始的生命值 $a_i$ 。同时每条巨龙拥有恢复能力，当其使用恢复能力时，它的生命值就会每次增加 $p_i$ ，直至生命值非负。只有在攻击结束后且当生命值 **恰好** 为 $0$ 时它才会死去。
- 游戏开始时玩家拥有 $m$ 把攻击力已知的剑，每次面对巨龙时，玩家只能选择一把剑，当杀死巨龙后这把剑就会消失，但作为奖励，玩家会获得全新的一把剑。

小 D 觉得这款游戏十分无聊，但最快通关的玩家可以获得 ION2018 的参赛资格，于是小 D 决定写一个笨笨的机器人帮她通关这款游戏，她写的机器人遵循以下规则：

- 每次面对巨龙时，机器人会选择当前拥有的，攻击力不高于巨龙初始生命值中攻击力最大的一把剑作为武器。如果没有这样的剑，则选择 **攻击力最低** 的一把剑作为武器。
- 机器人面对每条巨龙，它都会使用上一步中选择的剑攻击巨龙固定的 $x$ 次，使巨龙的生命值减少 $x \times ATK$ 。
- 之后，巨龙会不断使用恢复能力，每次恢复 $p_i$ 生命值。若在使用恢复能力前或某一次恢复后其生命值为 $0$ ，则巨龙死亡，玩家通过本关。

那么显然机器人的攻击次数是决定能否最快通关这款游戏的关键。小 D 现在得知了每条巨龙的所有属性，她想考考你，你知道应该将机器人的攻击次数 $x$ 设置为多少，才能用最少的攻击次数通关游戏吗？

当然如果无论设置成多少都无法通关游戏，输出 $-1$ 即可。

## 说明/提示

### 更多样例

更多样例请在附加文件中下载。

### 样例 2

见附加文件中的 `dragon2.in` 与 `dragon2.ans`。

### 样例 1 解释

第一组数据：
- 开始时拥有的剑的攻击力为 $\{1,9,1000\}$，第 $1$ 条龙生命值为 $3$，故选择攻击力为 $1$ 的剑，攻击 $59$ 次，造成 $59$ 点伤害，此时龙的生命值为 $-56$，恢复 14 次后生命值恰好为 $0$，死亡。

- 攻击力为 $1$ 的剑消失，拾取一把攻击力为 $7$ 的剑，此时拥有的剑的攻击力为
$\{7,9,1000\}$，第 2 条龙生命值为 $5$，故选择攻击力为 $7$ 的剑，攻击 $59$ 次，造成 $413$ 点伤害，此时龙的生命值为 $-408$，恢复 $68$ 次后生命值恰好为 $0$，死亡。

- 此时拥有的剑的攻击力为 $\{3,9,1000\}$，第 $3$ 条龙生命值为 $7$，故选择攻击力为 $3$ 的剑，攻击 $59$ 次，造成 $177$ 点伤害，此时龙的生命值为 $-170$，恢复 $17$ 次后生命值恰好为 0，死亡。

- 没有比 $59$ 次更少的通关方法，故答案为 $59$。

第二组数据：
不存在既能杀死第一条龙又能杀死第二条龙的方法，故无法通关，输出 $-1$。

### 子任务

::cute-table{tuack}

测试点编号 | $n$ | $m$ | $p_i$ | $a_i$ | 攻击力 | 其他限制
:-:|:-:|:-:|:-:|:-:|:-:|:-:
1|$\le 10^5$|$=1$|$=1$|$\le 10^5$|$=1$| 无
2|^|^|^|^|^| ^
3|^|^|^|^|$\le 10^5$| ^
4|^|^|^|^|^| ^
5|$\le 10^3$|$\le 10^3$|$\le 10^5$|^|^| 特性 1、特性 2
6|^|^|^|^|^| ^
7|^|^|^|^|^| ^
8|$=1$|$=1$|$\le 10^8$|$\le 10^8$|$\le 10^6$| 特性 1
9|^|^|^|^|^| ^
10|^|^|^|^|^| ^
11|^|^|^|^|^| ^
12|^|^|^|^|^| ^
13|^|^|^|^|^| ^
14|$=10^5$|$=10^5$|$=1$|^|^| 无特殊限制
15|^|^|^|^|^| ^
16|$\le 10^5$|^| 所有 $p_i$ 是质数 |$\le 10^{12}$|^| 特性 1
17|^|^| ^ |^|^| ^
18|^|^| 无特殊限制 | ^| ^ | ^
19|^|^| ^ | ^| ^ | ^
20|^|^| ^ | ^| ^ | ^

特性 1 是指：对于任意的 $i$，$a_i \le p_i$。

特性 2 是指：$\operatorname{lcm}(p_i) \le 10^6$，即所有 $p_i$ 的 **最小公倍数** 不大于 $10^6$。

对于所有的测试点，$T \le 5$，所有武器的攻击力 $\le 10^6$，所有 $p_i$ 的最小公倍数 $\le 10^{12}$。

保证 $ T, n, m $ 均为正整数。

### 提示

你所用到的中间结果可能很大，注意保存中间结果的变量类型。

## 样例 #1

### 输入

```
2
3 3
3 5 7
4 6 10
7 3 9
1 9 1000
3 2
3 5 6
4 8 7
1 1 1
1 1```

### 输出

```
59
-1```

# AI分析结果


# 💡 Kay的C++算法解析：屠龙勇士 深入学习指南 💡

> 今天我们来分析NOI2018的"屠龙勇士"这道编程题。本指南将帮助你理解题目核心、掌握解题技巧，并通过生动的像素动画直观感受算法执行流程。

## 1. 题目解读与核心算法识别

✨ **本题主要考察**：扩展中国剩余定理（ExCRT）与扩展欧几里得算法（exgcd）

🗣️ **初步分析**：
> 解决"屠龙勇士"的关键在于处理带系数的同余方程组。想象你在玩一款策略RPG游戏，每条龙对应一个加密的密码锁（同余方程），而剑的攻击力就是开锁的钥匙。我们需要用ExCRT这把"万能钥匙"来解开所有锁。

- **核心思路**：预处理每条龙对应的剑，转化为同余方程组，用ExCRT合并解
- **难点对比**：与标准ExCRT不同，本题方程带系数（剑的攻击力），需用exgcd消去系数
- **可视化设计**：将每条龙视为一个像素关卡，剑为钥匙，解方程过程展示为钥匙开锁动画
- **复古游戏化**：采用8位像素风格，剑攻击时触发"斩击"音效，解方程成功时播放"解锁"音效，自动演示模式展示解方程过程

---

## 2. 精选优质题解参考

<eval_intro>
从思路清晰度、代码规范性和算法效率等角度，我精选了以下优质题解（评分≥4★）：

**题解一（来源：emptysetvvvv）**
* **点评**：思路清晰直击核心，将问题转化为ExCRT的标准形式。代码简洁规范，变量命名合理（如`exgcd`函数），巧妙使用`__int128`处理大数乘模。亮点在于完整推导了带系数方程的转化过程，并给出严谨的数学证明，具有很高的学习价值。

**题解二（来源：shadowice1984）**
* **点评**：解法高效实用，深入分析了数据特性（如特性1：a_i≤p_i）。代码实现严谨，边界处理完善（如`p_i=1`特判）。亮点在于提出"龟速乘"避免溢出，并通过特判优化特殊情况，对竞赛实践有重要参考价值。

**题解三（来源：FlashHu）**
* **点评**：教学价值突出，用游戏化比喻解释算法（如"密码锁"类比）。代码模块化好，封装了快速乘和exgcd函数。亮点在于详细推导了ExCRT的合并步骤，并给出完整数学证明，特别适合初学者理解。

---

## 3. 核心难点辨析与解题策略

<difficulty_intro>
解决本题需突破三大核心难点，以下是应对策略：

1. **剑的选择与预处理**
   * **分析**：用平衡树（如`multiset`）动态维护剑集合，根据规则选择最优剑。关键技巧：`upper_bound`找不大于龙血量的最大剑
   * 💡 **学习笔记**：平衡树操作是高效预处理的基础

2. **同余方程的转化**
   * **分析**：将方程 $ATK_i \cdot x \equiv a_i \pmod{p_i}$ 转化为标准形式。设 $g = \gcd(ATK_i, p_i)$，若 $g \nmid a_i$ 则无解。通过exgcd求逆元消除系数
   * 💡 **学习笔记**：系数消除是同余方程求解的关键转换技巧

3. **ExCRT的合并优化**
   * **分析**：合并方程时用快速乘避免溢出，通过 $g = \gcd(g_1, g_2)$ 分解优化大数运算。调整解满足 $x \geq \max\lceil a_i/ATK_i \rceil$
   * 💡 **学习笔记**：快速乘和gcd分解是处理大数的核心手段

### ✨ 解题技巧总结
1. **数据结构优化**：用`multiset`高效维护动态剑集合
2. **数学变换技巧**：exgcd消去系数，将方程转化为标准形式
3. **边界处理艺术**：特判 $p_i=1$ 和 $a_i=p_i$ 的边界情况
4. **溢出防御**：快速乘处理大数运算，避免中间结果溢出

---

## 4. C++核心代码实现赏析

<code_intro_overall>
**通用核心实现**（综合优质题解）：
```cpp
#include <set>
using namespace std;
typedef long long ll;

ll mul(ll a, ll b, ll mod) { // 快速乘
    ll res = 0;
    while (b) {
        if (b & 1) res = (res + a) % mod;
        a = (a + a) % mod;
        b >>= 1;
    }
    return res;
}

ll exgcd(ll a, ll b, ll &x, ll &y) { // 扩展欧几里得
    if (!b) return x = 1, y = 0, a;
    ll g = exgcd(b, a % b, y, x);
    return y -= a / b * x, g;
}

void solve() {
    multiset<ll> sword;
    // 读入数据 & 插入初始剑
    ll mx = 0, x0 = 0, M = 1; // 初始化解和模数
    for (int i = 1; i <= n; ++i) {
        // 1. 选择剑 (略)
        // 2. 更新mx = max(mx, (a_i + ATK - 1) / ATK)
        ll A = ATK[i], B = a[i], m = p[i];
        ll g1 = gcd(A, m), g2 = gcd(M, m / g1);
        ll g = g1 * g2;
        // 3. 检查无解条件 (略)
        // 4. 计算新方程参数
        ll a1 = (A/g1) * (M/g2), m1 = m / g;
        ll inv, y; exgcd(a1, m1, inv, y); // 求逆元
        // 5. 更新x0和M (略)
    }
    // 调整解x0 >= mx
}
```

<code_intro_selected>
**优质题解片段赏析**：

**题解一（emptysetvvvv）**
```cpp
void exgcd(ll A, ll B, ll &x, ll &y, ll &gcd) {
    if (!B) x = 1, y = 0, gcd = A;
    else exgcd(B, A % B, y, x, gcd), y -= (A / B) * x;
}
```
* **亮点**：递归实现exgcd，通过引用返回结果，代码紧凑高效
* **学习笔记**：注意参数交换技巧 `y -= (A/B)*x` 避免额外变量

**题解二（shadowice1984）**
```cpp
if (p[i] == 1) { // 特判p_i=1
    ll res = 0;
    for (int i = 1; i <= n; ++i)
        res = max(res, (a[i] + ATK[i] - 1) / ATK[i]);
    printf("%lld\n", res);
}
```
* **亮点**：边界处理完善，直接计算最小攻击次数
* **学习笔记**：特判简单情况可提升程序效率和可读性

**题解三（FlashHu）**
```cpp
ll LCM = 1; // 计算最小公倍数
for (int i = 1; i <= n; i++) {
    ll ds = p[i] / gcd(ATK[i], p[i]);
    LCM = LCM / gcd(LCM, ds) * ds;
}
```
* **亮点**：通过gcd优化LCM计算，避免中间结果溢出
* **学习笔记**：`a / gcd(a,b) * b` 是计算LCM的标准安全写法

---

## 5. 算法可视化：像素动画演示

<visualization_intro>
**设计方案**：8位像素风RPG游戏，玩家扮演骑士解方程屠龙

* **场景设计**：
  - 龙作为关卡BOSS，血条显示$a_i$和$p_i$
  - 剑槽展示当前武器$ATK_i$
  - 控制面板显示方程$ATK_i \cdot x \equiv a_i \pmod{p_i}$

* **动画流程**：
  1. **选择剑**：像素剑在背包中高亮，伴随"选择"音效
  2. **方程转化**：显示gcd计算，系数消去过程用粒子效果展示
  3. **ExCRT合并**：两个龙形图标碰撞融合，生成新方程图标
  4. **解调整**：血条与解x0比较，不足时触发"强化"动画

* **交互控制**：
  - 步进/暂停：观察每步状态变化
  - 调速滑块：调整动画速度
  - 自动演示：AI自动解方程，类似自动战斗

* **音效设计**：
  - 关键操作：剑击声（选择剑），解锁声（方程合并）
  - 状态提示：错误音效（无解），胜利音乐（通关）

---

## 6. 拓展练习与相似问题

* **技能迁移**：
  1. **带系数的同余方程**：POJ 2891, 洛谷P4777
  2. **动态集合维护**：HDU 3487 (平衡树应用)
  3. **大数处理技巧**：Project Euler 97 (快速幂应用)

* **洛谷推荐**：
  1. **P4777 【模板】扩展中国剩余定理（EXCRT）**
     - 理由：巩固ExCRT的模板实现
  2. **P1082 同余方程**
     - 理由：掌握exgcd求逆元的核心技巧
  3. **P2042 维护序列**
     - 理由：学习平衡树维护动态数据集

---

## 7. 学习心得与经验分享

> **shadowice1984的经验**：
> "中间结果可能很大，注意保存中间结果的变量类型。"
>
> **Kay点评**：这提醒我们选择正确的数据类型（如`long long` vs `int`），并使用快速乘防止溢出。调试时可打印中间变量验证。

> **FlashHu的调试经验**：
> "遇到WA不要慌，重点检查快速乘和边界条件"
>
> **Kay点评**：快速乘的实现细节和$p_i=1$的特判是常见错误点，建议单独测试这些边界情况。

---

通过本指南，相信你已经掌握"屠龙勇士"的核心解法。记住：数据结构是基础，数学转化是关键，边界处理是保障。继续挑战更高难度的算法问题吧！💪

---
处理用时：598.12秒
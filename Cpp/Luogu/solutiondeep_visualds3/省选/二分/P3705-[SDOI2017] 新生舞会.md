# 题目信息

# [SDOI2017] 新生舞会

## 题目描述

学校组织了一次新生舞会，Cathy 作为经验丰富的老学姐，负责为同学们安排舞伴。


有 $n$ 个男生和 $n$ 个女生参加舞会，一个男生和一个女生一起跳舞，互为舞伴。


Cathy 收集了这些同学之间的关系，比如两个人之前认识没，计算得出 $a_{i,j}$。

Cathy 还需要考虑两个人一起跳舞是否方便，比如身高体重差别会不会太大，计算得出 $b_{i,j}$，表示第 $i$ 个男生和第 $j$ 个女生一起跳舞时的不协调程度。


当然，还需要考虑很多其他问题。


Cathy 想先用一个程序通过 $a_{i,j}$ 和 $b_{i,j}$ 求出一种方案，再手动对方案进行微调。

Cathy 找到你，希望你帮她写那个程序。


一个方案中有 n 对舞伴，假设每对舞伴的喜悦程度分别是 $a'_1,a'_2,...,a'_n$，假设每对舞伴的不协调程度分别是 $b'_1,b'_2,...,b'_n$。令

$C=\frac {a'_1+a'_2+...+a'_n}{b'_1+b'_2+...+b'_n}$

Cathy 希望 $C$ 值最大。


## 说明/提示

对于 10% 的数据，$1\le n\le 5$

对于 40% 的数据，$1\le n\le 18$

另有 20% 的数据，$b_{i,j}\le 1$

对于 100% 的数据，$1\le n\le 100,1\le a_{i,j},b_{i,j}\le10^4$


## 样例 #1

### 输入

```
3
19 17 16
25 24 23
35 36 31
9 5 6
3 4 2
7 8 9```

### 输出

```
5.357143```

# AI分析结果


### 💡 Kay的C++算法解析：新生舞会 深入学习指南 💡

#### **1. 题目解读与核心算法识别**
✨ **本题主要考察**：分数规划 + 网络流/二分图匹配

🗣️ **初步分析**：
> 本题要求最大化男女配对的总喜悦度与总不协调度的比值（$C=\frac{\sum a}{\sum b}$），属于**分数规划问题**。核心思想是将分式转化为线性表达式：通过二分答案$mid$，将原问题转化为判断是否存在配对满足$\sum(a_i - mid \times b_i) \geq 0$。这就像在超市挑选商品时，我们需要找到性价比最高的组合（总和价值/总花费）。

在本题中：
1. **建图技巧**：将男生视为左部点，女生视为右部点，源点连接所有男生，汇点连接所有女生，男女间连边权为$a_{ij} - mid \times b_{ij}$的边。
2. **算法流程**：通过费用流求解最大权匹配（若总费用≥0则$mid$可行）。可视化时需高亮：① 二分$mid$值更新 ② 增广路径寻找过程 ③ 费用累计变化。
3. **像素动画设计**：采用**8位像素风格**，男生用蓝色方块、女生用红色方块表示。增广路径用黄色闪烁线条展示，费用更新时显示数值变化。加入复古音效：路径找到时播放"叮"声，配对成功时播放胜利音效，精度达标时触发8-bit胜利BGM。

---

#### **2. 精选优质题解参考**
**题解一（Soulist）**
* **亮点**：思路清晰直击分数规划核心，代码规范（变量名`a[i][j]`、`b[i][j]`含义明确），巧妙结合费用流求解。空间优化到位（无冗余数组），边界处理严谨（$eps=10^{-8}$）。作者强调"类似方格取数问题套分数规划"，启发迁移思维。

**题解二（Log_x）**
* **亮点**：推导过程详尽（逐步展示公式变形），代码模块化（独立`Check()`函数）。创新性地将边权设为$a_{ij}-mid×b_{ij}$，通过最大费用流直接验证，实践价值高（可直接用于竞赛）。

**题解三（xyz32768）**
* **亮点**：SPFA实现高效（手写队列优化），复杂度分析清晰（$O(n^3 \log n)$）。强调精度控制（$eps=10^{-8}$），提供完整调试建议（如边界值测试），适合初学者理解细节。

---

#### **3. 核心难点辨析与解题策略**
1. **难点1：分数规划模型建立**
   * **分析**：如何将分式$\frac{\sum a}{\sum b}$转化为可二分的线性表达式？优质题解通过变形$\sum a_i - mid \times b_i = 0$，将比值问题转化为判定问题。
   * 💡 **学习笔记**：核心是分离分子分母，消除分式结构。

2. **难点2：图构建与权值设计**
   * **分析**：需构建源点→男生（容量1，费用0）、男生→女生（容量1，费用$a_{ij}-mid×b_{ij}$）、女生→汇点（容量1，费用0）的三层网络。权值设计直接影响算法正确性。
   * 💡 **学习笔记**：费用边权需包含二分变量$mid$以动态验证。

3. **难点3：负权边与精度控制**
   * **分析**：当$a_{ij}-mid×b_{ij}<0$时出现负权边，SPFA需特殊处理。二分精度需达$10^{-8}$才能通过所有测试点。
   * 💡 **学习笔记**：SPFA可处理负权，但需初始化$dis$为极大值；浮点数二分用相对精度控制。

### ✨ 解题技巧总结
- **技巧1：分式线性化**：遇到$\frac{\sum A}{\sum B}$优先考虑分数规划，变形为$\sum (A - k \times B) \geq 0$。
- **技巧2：二分图建图**：行列匹配问题（如本题行列各$n$个点）可转化为二分图，用网络流求解。
- **技巧3：费用流调试**：打印每次增广路径和费用变化，验证权值计算正确性。

---

#### **4. C++核心代码实现赏析**
**本题通用核心C++实现参考**
```cpp
#include <iostream>
#include <vector>
#include <queue>
#include <cstring>
#include <cmath>
#include <iomanip>
using namespace std;

const int MAXN = 210;
const double INF = 1e18;
const double eps = 1e-8;

struct Edge { int to, cap, rev; double cost; };
vector<Edge> graph[MAXN];
double dis[MAXN];
int prev_node[MAXN], prev_edge[MAXN];
bool inq[MAXN];
int n, a[MAXN][MAXN], b[MAXN][MAXN];
int S, T; // 源点S=0, 汇点T=2*n+1

void add_edge(int from, int to, int cap, double cost) {
    graph[from].push_back({to, cap, (int)graph[to].size(), cost});
    graph[to].push_back({from, 0, (int)graph[from].size()-1, -cost});
}

bool spfa() {
    fill(dis, dis+MAXN, INF);
    memset(inq, 0, sizeof(inq));
    queue<int> q;
    q.push(S); dis[S] = 0; inq[S] = true;
    while (!q.empty()) {
        int u = q.front(); q.pop(); inq[u] = false;
        for (int i = 0; i < graph[u].size(); i++) {
            Edge &e = graph[u][i];
            if (e.cap > 0 && dis[e.to] > dis[u] + e.cost) {
                dis[e.to] = dis[u] + e.cost;
                prev_node[e.to] = u;
                prev_edge[e.to] = i;
                if (!inq[e.to]) { q.push(e.to); inq[e.to] = true; }
            }
        }
    }
    return dis[T] < INF - eps; // 避免浮点误差
}

double min_cost_flow() {
    double cost = 0;
    while (spfa()) {
        int flow = 1e9;
        for (int v = T; v != S; v = prev_node[v])
            flow = min(flow, graph[prev_node[v]][prev_edge[v]].cap);
        for (int v = T; v != S; v = prev_node[v]) {
            Edge &e = graph[prev_node[v]][prev_edge[v]];
            e.cap -= flow;
            graph[v][e.rev].cap += flow;
        }
        cost += dis[T] * flow;
    }
    return cost;
}

bool check(double mid) {
    for (int i = 0; i < MAXN; i++) graph[i].clear();
    S = 0; T = 2*n+1;
    // 建图：源点→男生→女生→汇点
    for (int i = 1; i <= n; i++) {
        add_edge(S, i, 1, 0);          // 源点到男生
        add_edge(i+n, T, 1, 0);         // 女生到汇点
    }
    for (int i = 1; i <= n; i++)
        for (int j = 1; j <= n; j++)
            add_edge(i, j+n, 1, -(a[i][j] - mid*b[i][j])); // 男生到女生
    return min_cost_flow() < 0; // 总费用<0说明mid可行
}

int main() {
    cin >> n;
    for (int i = 1; i <= n; i++) for (int j = 1; j <= n; j++) cin >> a[i][j];
    for (int i = 1; i <= n; i++) for (int j = 1; j <= n; j++) cin >> b[i][j];
    double l = 0, r = 1e4;
    while (r - l > eps) {
        double mid = (l + r) / 2;
        if (check(mid)) l = mid;
        else r = mid;
    }
    cout << fixed << setprecision(6) << l << endl;
}
```
**代码解读概要**：
1. **建图三层结构**：源点→男生（容量1）、男生→女生（容量1，动态费用）、女生→汇点（容量1）
2. **SPFA找增广路**：每次寻找最小费用路径，更新残余网络
3. **二分框架**：在$[0, 10^4]$范围内二分$mid$，通过费用流验证

---

#### **5. 算法可视化：像素动画演示**
* **主题**：像素舞会配对（8-bit风格）
* **核心演示流程**：
  1. **初始化场景**：
     - 左侧蓝色像素块（男生）编号1~n
     - 右侧红色像素块（女生）编号n+1~2n
     - 顶部显示当前二分值$mid$（黄色像素数字）
  2. **建图动画**：
     - 绿色线条：源点（S）→男生（流量1，费用0）
     - 黄色线条：男生→女生（流量1，费用$a_{ij}-mid×b_{ij}$实时显示）
     - 红色线条：女生→汇点（T）（流量1，费用0）
  3. **SPFA执行过程**：
     - 当前队列节点高亮闪烁（蓝色边框）
     - 松弛成功时边变绿色，播放"叮"声；失败则变灰色
  4. **增广路径标记**：
     - 找到路径时，整条路径（S→男→女→T）闪烁3次
     - 路径上费用累加显示在右上角，伴随上升音效
  5. **游戏化反馈**：
     - 每轮二分成功：显示"Stage Pass!" + 得分
     - 最终答案：所有配对连线闪烁，播放8-bit胜利BGM

---

#### **6. 拓展练习与相似问题思考**
* **通用思路迁移**：
  分数规划可应用于：
  1. 最优比率生成树（POJ 2728）
  2. 最优比率环（POJ 3621）
  3. 最大密度子图（POJ 3155）

* **洛谷练习推荐**：
  1. **P3199 最小圈**（分数规划+SPFA判负环）
  2. **P4322 最佳团体**（分数规划+树形DP）
  3. **P2868 观光奶牛**（分数规划+SPFA应用）

---

#### **7. 学习心得与经验分享**
> **Soulist的调试经验**："二分精度必须达$10^{-8}$，否则无法通过极限数据。费用流中负权边需谨慎初始化$dis$数组"。这提醒我们：浮点运算是分数规划的核心难点，测试需覆盖边界值（如$mid=0$和$mid=10^4$）。

---

**最终结论**：本题是分数规划与网络流的经典结合，通过二分答案将分式问题转化为线性判定，再通过费用流验证。关键点在于建图策略、负权处理和精度控制。掌握此模型可解决一大类最优比率问题！

---
处理用时：167.20秒
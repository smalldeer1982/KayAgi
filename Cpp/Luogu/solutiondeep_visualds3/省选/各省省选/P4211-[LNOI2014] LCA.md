# é¢˜ç›®ä¿¡æ¯

# [LNOI2014] LCA

## é¢˜ç›®æè¿°

ç»™å‡ºä¸€ä¸ª $n$ ä¸ªèŠ‚ç‚¹çš„æœ‰æ ¹æ ‘ï¼ˆç¼–å·ä¸º $0$ åˆ° $n-1$ï¼Œæ ¹èŠ‚ç‚¹ä¸º $0$ï¼‰ã€‚

ä¸€ä¸ªç‚¹çš„æ·±åº¦å®šä¹‰ä¸ºè¿™ä¸ªèŠ‚ç‚¹åˆ°æ ¹çš„è·ç¦» $+1$ã€‚ 

è®¾ $dep[i]$ è¡¨ç¤ºç‚¹ $i$ çš„æ·±åº¦ï¼Œ$\operatorname{LCA}(i, j)$ è¡¨ç¤º $i$ ä¸ $j$ çš„æœ€è¿‘å…¬å…±ç¥–å…ˆã€‚ 

æœ‰ $m$ æ¬¡è¯¢é—®ï¼Œæ¯æ¬¡è¯¢é—®ç»™å‡º $l, r, z$ï¼Œæ±‚ $\sum_{i=l}^r dep[\operatorname{LCA}(i,z)]$ ã€‚

## è¯´æ˜/æç¤º

### æ•°æ®èŒƒå›´åŠçº¦å®š

- å¯¹äº $20\%$ çš„æ•°æ®ï¼Œ$n\le 10000,m\le 10000$ï¼›
- å¯¹äº $40\%$ çš„æ•°æ®ï¼Œ$n\le 20000,m\le 20000$ï¼›
- å¯¹äº $60\%$ çš„æ•°æ®ï¼Œ$n\le 30000,m\le 30000$ï¼›
- å¯¹äº $80\%$ çš„æ•°æ®ï¼Œ$n\le 40000,m\le 40000$ï¼›
- å¯¹äº $100\%$ çš„æ•°æ®ï¼Œ$1\le n\le 50000,1\le m\le 50000$ã€‚

## æ ·ä¾‹ #1

### è¾“å…¥

```
5 2
0
0
1
1
1 4 3
1 4 2```

### è¾“å‡º

```
8
5```

# AIåˆ†æç»“æœ


### é¢˜ç›®è§£è¯»ä¸æ ¸å¿ƒç®—æ³•è¯†åˆ«
âœ¨ **æœ¬é¢˜ä¸»è¦è€ƒå¯Ÿ**ï¼šæ ‘é“¾å‰–åˆ† + ç¦»çº¿å·®åˆ† + çº¿æ®µæ ‘

ğŸ—£ï¸ **åˆæ­¥åˆ†æ**ï¼š
> è§£å†³æœ¬é¢˜çš„å…³é”®åœ¨äºå°† LCA æ·±åº¦æ±‚å’Œé—®é¢˜è½¬åŒ–ä¸ºè·¯å¾„ä¿®æ”¹ä¸æŸ¥è¯¢é—®é¢˜ã€‚æ ¸å¿ƒæ€æƒ³æ˜¯ï¼š**å°†æ¯ä¸ªç‚¹ \(i\) åˆ°æ ¹çš„è·¯å¾„æƒå€¼+1 åï¼Œ\(z\) åˆ°æ ¹çš„è·¯å¾„æƒå€¼å’Œå³ä¸º \(\sum dep[LCA(i,z)]\)**ã€‚  
> - **æ ¸å¿ƒæµç¨‹**ï¼š  
>   1. ç¦»çº¿å¤„ç†ï¼šå°†æ¯ä¸ªè¯¢é—® \([l, r, z]\) æ‹†æˆ \([1, r] - [1, l-1]\) ä¸¤éƒ¨åˆ†  
>   2. æŒ‰å³ç«¯ç‚¹æ’åºåï¼Œä¾æ¬¡å°†ç‚¹ \(i\) åˆ°æ ¹çš„è·¯å¾„æƒå€¼+1ï¼ˆæ ‘é“¾å‰–åˆ†å®ç°ï¼‰  
>   3. é‡åˆ°è¯¢é—®ä½ç½®æ—¶ï¼ŒæŸ¥è¯¢ \(z\) åˆ°æ ¹çš„è·¯å¾„å’Œï¼ˆçº¿æ®µæ ‘ç»´æŠ¤ï¼‰  
> - **å¯è§†åŒ–è®¾è®¡**ï¼š  
>   ç”¨ 8 ä½åƒç´ é£æ ¼åŠ¨ç”»å±•ç¤ºæ ‘é“¾å‰–åˆ†è¿‡ç¨‹ï¼ˆé‡é“¾ç”¨ç²—è¾¹æ ‡è®°ï¼‰ï¼Œçº¿æ®µæ ‘åŒºé—´ä¿®æ”¹æ—¶é«˜äº®è·¯å¾„èŠ‚ç‚¹ï¼ŒæŸ¥è¯¢æ—¶æ˜¾ç¤º \(z\) åˆ°æ ¹çš„è·¯å¾„å’Œè®¡ç®—è¿‡ç¨‹ã€‚å…³é”®æ­¥éª¤è§¦å‘éŸ³æ•ˆï¼ˆå¦‚"æ»´"å£°è¡¨ç¤ºä¿®æ”¹ï¼Œ"å®"å£°è¡¨ç¤ºæŸ¥è¯¢ï¼‰ã€‚

---

### ç²¾é€‰ä¼˜è´¨é¢˜è§£å‚è€ƒ
**é¢˜è§£ä¸€ï¼ˆä½œè€…ï¼šç´«é’¦ï¼Œèµ 208ï¼‰**  
* **ç‚¹è¯„**ï¼š  
  æ€è·¯æ¸…æ™°ï¼Œå®Œæ•´æ¨å¯¼äº†é—®é¢˜è½¬åŒ–ï¼ˆLCA æ·±åº¦ â†’ è·¯å¾„æƒå€¼å’Œï¼‰å’Œç¦»çº¿å·®åˆ†ç­–ç•¥ã€‚ä»£ç è§„èŒƒæ€§ä¼˜ç§€ï¼ˆå˜é‡å `f[i]`ã€`pre[i]` å«ä¹‰æ˜ç¡®ï¼‰ï¼Œæ ‘å‰–+çº¿æ®µæ ‘å®ç°ä¸¥è°¨ï¼Œè¾¹ç•Œå¤„ç†å®Œæ•´ï¼ˆæ¨¡è¿ç®—ä¸¥è°¨ï¼‰ã€‚äº®ç‚¹åœ¨äºå·§å¦™åˆ©ç”¨å·®åˆ†é¿å…é‡å¤è®¡ç®—ï¼Œå¤æ‚åº¦ \(O(n \log^2 n)\) é«˜æ•ˆå¯é ã€‚è°ƒè¯•å¿ƒå¾—æé†’æ³¨æ„æ•´ä½“ç¼–å·+1çš„ç»†èŠ‚ï¼Œæå…·å‚è€ƒä»·å€¼ã€‚

**é¢˜è§£äºŒï¼ˆä½œè€…ï¼šé¡éŸ³ãƒªãƒ³ï¼Œèµ 184ï¼‰**  
* **ç‚¹è¯„**ï¼š  
  åˆ›æ–°æ€§å¼•å…¥**å…¨å±€å¹³è¡¡äºŒå‰æ ‘**æ›¿ä»£æ ‘å‰–ï¼Œå°†é“¾æ“ä½œå¤æ‚åº¦ä¼˜åŒ–è‡³ \(O(n \log n)\)ã€‚ä»£ç å®ç°ç®€æ´ï¼ˆä»…ç»´æŠ¤è½»å„¿å­ size å’Œï¼‰ï¼Œé€šè¿‡äºŒåˆ†å»ºæ ‘ä¿è¯æ ‘é«˜å¹³è¡¡ã€‚äº®ç‚¹åœ¨äºç±»æ¯” LCT çš„é™æ€åŒ–æ€æƒ³ï¼Œ132ms çš„å®æµ‹æ•ˆç‡ç¢¾å‹å…¶ä»–è§£æ³•ï¼Œå±•ç°é«˜é˜¶æ•°æ®ç»“æ„çš„å¨åŠ›ã€‚

**é¢˜è§£ä¸‰ï¼ˆä½œè€…ï¼šxä¹‰xï¼Œèµ 38ï¼‰**  
* **ç‚¹è¯„**ï¼š  
  æä¾›**åœ¨çº¿ä¸»å¸­æ ‘**è§£æ³•ï¼Œé€šè¿‡å¯æŒä¹…åŒ–çº¿æ®µæ ‘ç»´æŠ¤å†å²ç‰ˆæœ¬ã€‚äº®ç‚¹åœ¨äºæ ‡è®°æ°¸ä¹…åŒ–å¤„ç†åŒºé—´ä¿®æ”¹ï¼Œæ»¡è¶³å¼ºåˆ¶åœ¨çº¿éœ€æ±‚ã€‚ç©ºé—´å¤æ‚åº¦ \(O(n \log^2 n)\) è¾ƒé«˜ä½†æ€è·¯å®Œæ•´ï¼Œæ‹“å±•æ€§æå¼ºï¼ˆå¯å¤„ç† \(dep^k[LCA]\) ç­‰å˜å¼ï¼‰ã€‚

---

### æ ¸å¿ƒéš¾ç‚¹è¾¨æä¸è§£é¢˜ç­–ç•¥
1. **é—®é¢˜è½¬åŒ–æ€ç»´**  
   *éš¾ç‚¹*ï¼šç†è§£ \(dep[LCA(i,z)]\) ä¸è·¯å¾„æƒå€¼çš„ç­‰ä»·å…³ç³»ã€‚  
   *è§£å†³*ï¼šç±»æ¯”æŸ“è‰²æ¨¡å‹â€”â€”å°† \(i\) åˆ°æ ¹è·¯å¾„æŸ“è‰²åï¼Œ\(z\) åˆ°æ ¹çš„æŸ“è‰²ç‚¹æ•°å³ä¸ºæ‰€æ±‚ï¼ˆç´«é’¦é¢˜è§£å›¾ç¤ºæ¸…æ™°ï¼‰ã€‚

2. **ç¦»çº¿å·®åˆ†å¤„ç†**  
   *éš¾ç‚¹*ï¼šé¿å…å¯¹æ¯ä¸ªè¯¢é—®ç‹¬ç«‹å¤„ç†å¯¼è‡´çš„ \(O(n^2)\) å¼€é”€ã€‚  
   *è§£å†³*ï¼šæ‹†è§£è¯¢é—®ä¸º \([1,r]-[1,l-1]\)ï¼ŒæŒ‰å³ç«¯ç‚¹æ’åºåé€æ­¥æ·»åŠ ç‚¹ï¼ˆGreat_Influence é¢˜è§£å®ç°ç®€æ´ï¼‰ã€‚

3. **é“¾ä¿®æ”¹/æŸ¥è¯¢å®ç°**  
   *éš¾ç‚¹*ï¼šé«˜æ•ˆå®ç°è·¯å¾„æ“ä½œã€‚  
   *è§£å†³*ï¼š  
   - æ ‘å‰–+çº¿æ®µæ ‘ï¼ˆé€šç”¨ï¼‰  
   - å…¨å±€å¹³è¡¡äºŒå‰æ ‘ï¼ˆé«˜æ•ˆï¼‰  
   - ä¸»å¸­æ ‘ï¼ˆåœ¨çº¿éœ€æ±‚ï¼‰  

ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼š  
> - æ ‘å‰–æ˜¯åŸºç¡€è§£æ³•ï¼ŒæŒæ¡ DFS åºæ˜ å°„ä¸è½»é‡é“¾åˆ’åˆ†  
> - å·®åˆ†æ˜¯åŒºé—´é—®é¢˜çš„é€šç”¨ä¼˜åŒ–æ‰‹æ®µ  
> - é«˜é˜¶æ•°æ®ç»“æ„åœ¨å¡å¸¸æ—¶èƒ½å‡ºå¥‡åˆ¶èƒœ

### âœ¨ è§£é¢˜æŠ€å·§æ€»ç»“
- **é—®é¢˜åˆ†è§£**ï¼šå°†å¤æ‚æŸ¥è¯¢ï¼ˆåŒºé—´ LCAï¼‰è½¬åŒ–ä¸ºè·¯å¾„æ“ä½œ+å·®åˆ†  
- **ç¦»çº¿å¤„ç†**ï¼šæŒ‰å³ç«¯ç‚¹æ’åºé¿å…é‡å¤è®¡ç®—  
- **ä»£ç å°è£…**ï¼šæ ‘é“¾å‰–åˆ†å°è£…ä¸º `ModifyChain`ã€`QueryChain` æå‡å¯è¯»æ€§  
- **è¾¹ç•Œç‰¹åˆ¤**ï¼šæ ¹èŠ‚ç‚¹å¤„ç†ã€æ¨¡è¿ç®—é˜²æ­¢è´Ÿæ•°æ˜¯å¸¸è§é™·é˜±  

---

### C++æ ¸å¿ƒä»£ç å®ç°èµæ
**æœ¬é¢˜é€šç”¨æ ¸å¿ƒå®ç°ï¼ˆæ ‘å‰–+çº¿æ®µæ ‘ï¼‰**  
```cpp
#include <vector>
#include <algorithm>
using namespace std;
const int N = 5e4 + 5, mod = 201314;

int n, q, fa[N], ans[N];
vector<int> g[N], Q[N]; // Q[i] å­˜å‚¨å³ç«¯ç‚¹ä¸º i çš„è¯¢é—®

// æ ‘é“¾å‰–åˆ†éƒ¨åˆ†
int sz[N], son[N], top[N], dfn[N], idx;
void dfs1(int u) {
    sz[u] = 1;
    for (int v : g[u]) {
        dfs1(v); sz[u] += sz[v];
        if (sz[v] > sz[son[u]]) son[u] = v;
    }
}
void dfs2(int u, int tp) {
    dfn[u] = ++idx; top[u] = tp;
    if (son[u]) dfs2(son[u], tp);
    for (int v : g[u]) 
        if (v != son[u]) dfs2(v, v);
}

// çº¿æ®µæ ‘éƒ¨åˆ†
struct {
    int sum[N<<2], tag[N<<2];
    void pushdown(int rt, int len) {
        if (!tag[rt]) return;
        tag[rt<<1] += tag[rt];
        tag[rt<<1|1] += tag[rt];
        sum[rt<<1] += tag[rt] * (len - (len>>1));
        sum[rt<<1|1] += tag[rt] * (len>>1);
        tag[rt] = 0;
    }
    void update(int l, int r, int rt, int L, int R) {
        if (L <= l && r <= R) {
            sum[rt] += r - l + 1;
            tag[rt]++; 
            return;
        }
        pushdown(rt, r - l + 1);
        int mid = (l + r) >> 1;
        if (L <= mid) update(l, mid, rt<<1, L, R);
        if (R > mid) update(mid+1, r, rt<<1|1, L, R);
        sum[rt] = sum[rt<<1] + sum[rt<<1|1];
    }
    int query(int l, int r, int rt, int L, int R) {
        if (L <= l && r <= R) return sum[rt];
        pushdown(rt, r - l + 1);
        int mid = (l + r) >> 1, res = 0;
        if (L <= mid) res = query(l, mid, rt<<1, L, R);
        if (R > mid) res += query(mid+1, r, rt<<1|1, L, R);
        return res;
    }
} seg;

// æ ‘å‰–è·¯å¾„ä¿®æ”¹/æŸ¥è¯¢
void modify(int u) {
    while (u) {
        seg.update(1, n, 1, dfn[top[u]], dfn[u]);
        u = fa[top[u]];
    }
}
int query(int u) {
    int res = 0;
    while (u) {
        res += seg.query(1, n, 1, dfn[top[u]], dfn[u]);
        u = fa[top[u]];
    }
    return res % mod;
}

int main() {
    scanf("%d%d", &n, &q);
    for (int i = 2; i <= n; i++) {
        scanf("%d", &fa[i]); fa[i]++;
        g[fa[i]].push_back(i);
    }
    // å­˜å‚¨ç¦»çº¿è¯¢é—® (pos, z, coef)
    for (int i = 1; i <= q; i++) {
        int l, r, z; scanf("%d%d%d", &l, &r, &z);
        Q[l].push_back(-z-1); // è´Ÿæ•°è¡¨ç¤º l-1
        Q[r+1].push_back(z+1); // æ­£æ•°è¡¨ç¤º r
    }
    
    dfs1(1); dfs2(1, 1);
    for (int i = 1; i <= n; i++) {
        modify(i); // æ·»åŠ å½“å‰ç‚¹
        for (int qid : Q[i]) {
            int coef = qid > 0 ? 1 : -1;
            int z = abs(qid) - 1;
            ans[abs(qid)] += coef * query(z);
        }
    }
    for (int i = 1; i <= q; i++) 
        printf("%d\n", (ans[i] % mod + mod) % mod);
}
```

---

### ç®—æ³•å¯è§†åŒ–ï¼šåƒç´ åŠ¨ç”»æ¼”ç¤º
**ä¸»é¢˜**ï¼šæ ‘é“¾æ¢é™©è€…ï¼ˆ8-bit é£æ ¼ï¼‰  
**æ ¸å¿ƒæ¼”ç¤º**ï¼š  
1. **æ ‘æ„å»ºé˜¶æ®µ**  
   - åƒç´ èŠ‚ç‚¹ç”Ÿæˆï¼ˆç»¿è‰²æ ¹èŠ‚ç‚¹ï¼Œè“è‰²æ™®é€šèŠ‚ç‚¹ï¼‰  
   - DFS1 è¿‡ç¨‹ï¼šè®¡ç®—å­æ ‘å¤§å°ï¼ˆèŠ‚ç‚¹æ˜¾ç¤º size å€¼ï¼‰  
   - DFS2 è¿‡ç¨‹ï¼šé‡é“¾æ ‡è®°ï¼ˆç²—é»„è‰²è¾¹ï¼‰ï¼Œåˆ†é… DFS åº  

2. **ä¿®æ”¹é˜¶æ®µï¼ˆç‚¹ \(i\) åŠ å…¥ï¼‰**  
   - \(i\) åˆ°æ ¹è·¯å¾„é—ªçƒçº¢è‰²  
   - çº¿æ®µæ ‘åŒºé—´æ›´æ–°ï¼šå¯¹åº”é“¾çš„çº¿æ®µæ ‘èŠ‚ç‚¹å˜æ©™è‰²  
   - éŸ³æ•ˆï¼šè·¯å¾„æ¯èŠ‚ç‚¹è§¦å‘ "æ»´" å£°  

3. **æŸ¥è¯¢é˜¶æ®µï¼ˆè¯¢é—® \(z\)ï¼‰**  
   - \(z\) åˆ°æ ¹è·¯å¾„é—ªçƒç´«è‰²  
   - çº¿æ®µæ ‘æŸ¥è¯¢ï¼šé«˜äº®å¯¹åº”åŒºé—´å¹¶æ˜¾ç¤ºæ±‚å’Œç»“æœ  
   - éŸ³æ•ˆï¼šè·¯å¾„ç»ˆç‚¹è§¦å‘ "å®" å£°ï¼Œç»“æœæ˜¾ç¤ºæ—¶æ’­æ”¾èƒœåˆ©éŸ³æ•ˆ  

**äº¤äº’æ§åˆ¶**ï¼š  
- æ­¥è¿›æ§åˆ¶ï¼šç©ºæ ¼å•æ­¥æ‰§è¡Œ  
- é€Ÿåº¦æ»‘å—ï¼šè°ƒæ•´è‡ªåŠ¨æ’­æ”¾é€Ÿåº¦ï¼ˆ0.5x~2xï¼‰  
- é‡ç½®æŒ‰é’®ï¼šé‡æ–°å¼€å§‹åŠ¨ç”»  

---

### æ‹“å±•ç»ƒä¹ ä¸ç›¸ä¼¼é—®é¢˜
1. **é€šç”¨æŠ€å·§è¿ç§»**  
   - æ ‘é“¾å‰–åˆ†ç»´æŠ¤è·¯å¾„ä¿¡æ¯çš„æŠ€å·§å¯åº”ç”¨äºï¼š  
     [BZOJ 4034] æ ‘ä¸Šæ“ä½œï¼ˆè·¯å¾„åŠ /å­æ ‘æ±‚å’Œï¼‰  
     [LOJ 139] æ ‘é“¾å‰–åˆ†ï¼ˆåŠ¨æ€è·¯å¾„æŸ¥è¯¢ï¼‰  
     [Luogu P3384] æ ‘é“¾å‰–åˆ†æ¨¡æ¿ï¼ˆå­æ ‘ä¿®æ”¹+è·¯å¾„æŸ¥è¯¢ï¼‰

2. **æ¨èé¢˜ç›®**  
   | é¢˜å·       | æ ‡é¢˜                     | æ¨èç†ç”±                     |
   |------------|--------------------------|------------------------------|
   | Luogu P4211 | [LNOI2014] LCAï¼ˆæœ¬é¢˜ï¼‰    | æŒæ¡æ ‘å‰–+ç¦»çº¿å·®åˆ†æ ¸å¿ƒæ€è·¯    |
   | Luogu P4213 | SUMï¼ˆæœæ•™ç­›ï¼‰            | è®­ç»ƒç¦»çº¿å·®åˆ†ä¸é¢„å¤„ç†æŠ€å·§     |
   | Luogu P3398 | ä»“é¼ æ‰¾ sugar             | æ‹“å±• LCA æ€§è´¨åº”ç”¨            |
   | Luogu P3676 | å°æ¸…æ–°æ•°æ®ç»“æ„é¢˜         | æ ‘å‰–ç»´æŠ¤å¸¦æƒè·¯å¾„å’Œçš„è¿›é˜¶åº”ç”¨ |

---

### å­¦ä¹ å¿ƒå¾—ä¸ç»éªŒåˆ†äº«
> **æ¥è‡ªç´«é’¦çš„è°ƒè¯•ç»éªŒ**ï¼š  
> "æ•´ä½“ç¼–å·+1æ—¶å¿˜è®°å¤„ç†è¯¢é—®ä¸­çš„ \(z\)ï¼Œå¯¼è‡´ REã€‚å»ºè®®å°è£…ç¼–å·è½¬æ¢å‡½æ•°é¿å…é—æ¼ã€‚"  
>   
> **Kay æ€»ç»“**ï¼š  
> è¾¹ç•Œå¤„ç†æ˜¯æ ‘å‰–æ˜“é”™ç‚¹ï¼Œå¯é€šè¿‡ï¼š  
> 1. ç¼–å†™ `modify` å’Œ `query` é“¾æ“ä½œå‡½æ•°ç»Ÿä¸€é€»è¾‘  
> 2. ç”¨ `assert` æ£€æŸ¥æ ¹èŠ‚ç‚¹ç»ˆæ­¢æ¡ä»¶  
> 3. æ¨¡è¿ç®—ååŠ æ¨¡å†å–æ¨¡é˜²è´Ÿæ•°  

---

### ç»“è¯­
æœ¬é¢˜é€šè¿‡æ ‘é“¾å‰–åˆ†å°† LCA æ·±åº¦æ±‚å’Œè½¬åŒ–ä¸ºè·¯å¾„æ“ä½œï¼Œç»“åˆç¦»çº¿å·®åˆ†å¤§å¹…ä¼˜åŒ–æ•ˆç‡ã€‚æŒæ¡æ ‘å‰–çš„ DFS åºæ˜ å°„ã€çº¿æ®µæ ‘åŒºé—´ç»´æŠ¤ã€å·®åˆ†æ€æƒ³æ˜¯è§£é¢˜å…³é”®ã€‚é«˜é˜¶è§£æ³•å¦‚å…¨å±€å¹³è¡¡äºŒå‰æ ‘å’Œä¸»å¸­æ ‘è¿›ä¸€æ­¥æ‹“å±•äº†æ•ˆç‡ä¸åœ¨çº¿å¤„ç†èƒ½åŠ›ã€‚

---
å¤„ç†ç”¨æ—¶ï¼š145.36ç§’
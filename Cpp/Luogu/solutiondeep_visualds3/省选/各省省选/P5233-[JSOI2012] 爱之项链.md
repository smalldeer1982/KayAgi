# 题目信息

# [JSOI2012] 爱之项链

## 题目描述

在进香河，流传着这样一段美丽的故事。zyg 与 kzn 是两个生活在进香河的孩子，一天，他们两人闹矛盾了，于是 zyg 送给了 kzn 一条精美的爱之项链。从此他们幸福生活在一起。

这则故事的真实性到今天已经没有意义了，然而我们关注的是那一条精美的爱之项链。这是一条由 $N$ 个精致的戒指与一块特殊纪念品相连而成的环形，如下图中的爱心符号正是一种特殊纪念品（据说是 2012 年情人节时 zyg 特意托人订制的）。上面的每一枚戒指又是由 $M$ 个带磁性的特殊彩色球状物组成的环形。也许你会认为，这所谓的戒指，更像是一条条小项链。

下图给出了一种可行的方案，其中左边描述的是单一的一枚戒指，右图描述的是项链。

![](https://cdn.luogu.com.cn/upload/pic/52648.png) 

这里，所有带磁性的特殊彩色球状物的颜色只有 $R$ 种，这里我们用 $1$ 到 $R$ 来表示。如果一枚戒指可以通过顺时针或逆时针的旋转后与另外一枚戒指相同，则认为这是两枚相同的戒指。 

对于一条爱之项链，要求满足任何相邻两枚戒指必须是不相同的。同时，特殊纪念品左右两枚戒指也必须是不同的。 

现在给定 $N$，$M$ 和 $R$，问究竟有多少种不同的爱之项链。 

注意： 

1. 特殊纪念品的插入位置不同，也许会得到不同的爱之项链。
 2. 这里我们只考虑旋转后是否相同，不考虑翻转操作，这一点不论是对于每一枚戒指，还是对于整条项链，都是这样的。

## 说明/提示

对于 $30\%$ 的数据，$N \leq 10^3$，$M \leq 3 \times 10^2$，$R \leq 10^2$。

对于 $60\%$ 的数据，$N \leq 3 \times 10^4$，$M \leq 2 \times 10^3$，$R \leq 10^5$。

对于 $80\%$ 的数据，$N \leq 10^7$，$M \leq 10^6$，$R \leq 10^6$。

对于 $100\%$ 的数据，$N \leq 10^{15}$，$M \leq 10^9$，$R \leq 10^6$。

## 样例 #1

### 输入

```
10 5 4```

### 输出

```
1398595```

# AI分析结果


### 💡 Kay的C++算法解析：[JSOI2012]爱之项链 深入学习指南 💡

#### 题目解读与核心算法识别
✨ **本题主要考察**：Pólya定理（戒指计数）与组合计数/递推（项链计数）

🗣️ **初步分析**：
> 戒指计数本质是计算旋转同构的染色方案数，想象一个旋转的彩色摩天轮——若旋转后颜色布局相同则视为同一戒指。项链计数则需处理相邻约束（含特殊纪念品两侧），如同在固定位置的圆环上放置互斥的磁铁。
> - **戒指计数**：使用Pólya定理，公式为 \( k = \frac{1}{M} \sum_{d|M} r^d \varphi(\frac{M}{d}) \)，核心是枚举因数计算循环节
> - **项链计数**：通过递推 \( f(n) = k(k-1)^{n-1} - f(n-1) \) 导出通项 \( f(n) = (k-1)^n + (-1)^n(k-1) \)
> - **可视化设计**：戒指部分用像素环展示旋转同构（高亮循环节），项链部分以心形像素为固定点，动态演示相邻戒指约束。复古音效标记关键操作（如"叮"声表示循环节计算），自动模式逐步生成合法项链

---

#### 精选优质题解参考
**题解一（rui_er）**
* **点评**：思路清晰直击要害，Pólya定理推导完整，项链容斥转化精妙。代码规范（欧拉函数独立封装），复杂度优化（\( O(\sqrt{M}) \)枚举因数）。亮点在于模块化设计——戒指与项链计数分离，边界处理严谨（模逆元计算），是竞赛标准实现

**题解二（tzc_wk）**
* **点评**：创新性使用特征根求解递推，数学深度更优。代码亮点在模数特判（处理 \( M \mid 3214567 \) 的情况），实践价值高。但推导过程稍显跳跃，需一定数学基础才能完全消化

**题解三（littlez_meow）**
* **点评**：以数学归纳法证明项链公式，比容斥更易理解。代码简洁高效（快速幂内联），但缺少模数特判。亮点是用"摩天轮"比喻旋转同构，生动体现算法本质

---

#### 核心难点辨析与解题策略
1. **难点：戒指旋转同构的循环节计算**
   * **分析**：Pólya定理中置换分解是关键。旋转 \( d \) 位时循环节数为 \( \gcd(M,d) \)，需转化为 \( \sum_{d|M} r^d \varphi(\frac{M}{d}) \) 以高效计算
   * 💡 学习笔记：循环节本质是最小重复单元——如同齿轮咬合点

2. **难点：项链相邻约束的递推关系**
   * **分析**：首尾约束打破对称性需特殊处理。从链式方案 \( k(k-1)^{n-1} \) 出发，减去首尾相同的方案（等价于 \( n-1 \) 规模子问题）
   * 💡 学习笔记：递推是处理环形约束的利器——化环为链再修正

3. **难点：大数运算的模处理**
   * **分析**：当 \( M \) 是模数倍数时，需在模 \( 3214567^2 \) 下计算后调整。关键变量 \( k \) 的计算涉及大指数和欧拉函数
   * 💡 学习笔记：数论问题中，模运算如同密码锁——必须对准齿槽才能开解

✨ **解题技巧总结**
- **问题分解**：拆解为戒指（Pólya定理）→项链（递推）两阶段
- **数学工具**：欧拉定理降幂/特征根求通项/模逆元处理除法
- **边界艺术**：\( n=1 \) 时项链无解，\( \varphi(1)=1 \) 等细节决定成败
- **代码鲁棒性**：枚举因数 \( i \) 与 \( M/i \) 对称处理避免重复

---

#### C++核心代码实现赏析
**通用核心实现**（综合题解优化）
```cpp
#include <iostream>
using namespace std;
typedef long long ll;
const int MOD = 3214567;

ll qpow(ll base, ll expo, int mod = MOD) {
    ll res = 1;
    while (expo) {
        if (expo & 1) res = res * base % mod;
        base = base * base % mod;
        expo >>= 1;
    }
    return res;
}

int phi(int x) { // 欧拉函数
    int res = x;
    for (int i = 2; i * i <= x; ++i) {
        if (x % i) continue;
        res = res / i * (i - 1);
        while (x % i == 0) x /= i;
    }
    if (x > 1) res = res / x * (x - 1);
    return res;
}

int main() {
    ll n, m, r; 
    cin >> n >> m >> r;
    ll k = 0;
    // 枚举m的因数
    for (int d = 1; d * d <= m; ++d) {
        if (m % d) continue;
        k = (k + qpow(r, d) * phi(m / d)) % MOD;
        if (d != m / d) // 对称因数
            k = (k + qpow(r, m / d) * phi(d)) % MOD;
    }
    k = k * qpow(m, MOD - 2) % MOD; // 乘以逆元
    ll ans = (qpow(k - 1, n) + (n % 2 ? MOD - k + 1 : k - 1)) % MOD;
    cout << ans << endl;
}
```

**题解一（rui_er）片段赏析**
```cpp
rep(d, 1, lim) { // 因数枚举
    if (!(m % d)) {
        k = (k + qpow(r, d) * phi(m/d)) % mod;
        if (d != m / d) // 避免平方根重复
            k = (k + qpow(r, m/d) * phi(d)) % mod;
    }
}
```
* **亮点**：优雅处理因数对称性
* **解读**：`lim=sqrt(m)`优化枚举范围，`d`与`m/d`成对计算确保不遗漏。`qpow`封装快速幂保证指数运算高效性
* 💡 学习笔记：因数分解时 \( d \times \frac{M}{d}=M \) 的对称美

---

#### 算法可视化：像素动画演示
**主题**：8-bit风格"旋转戒指与心形项链"

**核心设计**：
1. **戒指生成阶段**：
   - 像素环由 \( M \) 个色块组成，点击"旋转"触发齿轮转动动画
   - 高亮当前因数 \( d \) 对应的循环节（同色块脉冲闪烁）
   - 音效：循环节计算成功时播放"叮！"，欧拉函数计算时触发复古电子音

2. **项链编织阶段**：
   - 心形像素固定中央，\( N \) 个戒指环围绕成圈
   - 动态演示递推：相邻戒指碰撞时检测颜色，冲突则闪烁红光并播放故障音
   - 自动模式：AI小人像玩跳格子游戏，逐步放置合法戒指，完成时心形绽放像素烟花

**交互控制**：
- 步进模式：空格键单步观察Pólya计算过程
- 速度滑块：调整AI演示速度（蜗牛→闪电）
- 比较模式：并排展示递推与通项公式生成过程

**技术实现**：
```javascript
// 伪代码：循环节可视化
function visualizeCycles(d) {
  for (let i = 0; i < m; i++) {
    const cycleColor = (i % d) ? prevColor : randomColor(); 
    drawPixel(i, cycleColor); // 绘制像素环
    if (i % d == 0) playSound("chime"); // 循环节开始音效
  }
}
```

---

#### 拓展练习与相似问题
1. **洛谷 P4980** - Pólya定理模板  
   → 强化戒指计数思维
2. **洛谷 P1357** - 花园（环形递推）  
   → 掌握项链式约束处理
3. **洛谷 P3307** - [SDOI2013]项链  
   → 双倍经验：珠宝计数+质因数分解

---

#### 学习心得分享
> **题解作者经验**：  
> "调试时被 \( M \mid 3214567 \) 坑惨——必须扩展模数空间！"  
> **Kay点评**：数论题需警惕模数边界，如同过河检查踏脚石。测试时用 \( M=3214567 \) 验证是黄金准则！

---

> 编程如 crafting 像素艺术——每一行代码都是色彩的堆叠。本次指南帮你点亮算法调色盘，下次挑战再见！ 🎮🚀

---
处理用时：165.80秒
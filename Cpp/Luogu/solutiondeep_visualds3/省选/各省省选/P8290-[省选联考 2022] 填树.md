# 题目信息

# [省选联考 2022] 填树

## 题目背景

原题时限为 2s。

## 题目描述

有一棵 $n$ 个节点的无根树，刚开始树上每个节点的权值均为 $0$。KK 想对这棵树进行一些修改，他会任选一个节点作为初始的当前节点，然后重复以下动作：

1. 将当前节点 $i$ 的权值修改为一个**正整数** $x$，需满足 $l_i \leq x \leq r_i$。其中 $l_i, r_i$ 是输入中给出的两个正整数。
2. 结束修改过程，或移动到一个与当前节点相邻的权值为 $0$ 的节点（如果不存在这样的节点，则必须结束修改过程）。

现在 KK 有两个问题：

1. 在修改结束后，可以得到多少棵不同的树，满足树上**非零权值**的最大值和最小值的差小于等于 $K$？其中 $K$ 是输入中给出的一个正整数。

2. 这些满足条件的树的权值之和为多少？（树的权值定义为这棵树上所有节点的权值之和）

你需要输出这两个问题的答案模 $10^9 + 7$。我们认为两棵树不同当且仅当至少存在一个节点的权值不同。

温馨提示：

1. KK 至少会修改一个节点（初始节点）。
2. 实质上 KK 会修改树上的任意一条路径，最后需要满足这条路径上的点的权值最大值和最小值之差小于等于 $K$。

## 说明/提示

**【样例解释 #1】**

| | $1$ | $2$ | $3$ | $4$ | $5$ | $6$ | $7$ | $8$ | $9$ | $10$ | $11$ | $12$ | $13$ | $14$ |
|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|
| 节点 $1$ | $2$ | $3$ | $2$ | $3$ | $3$ | $3$ | $3$ | $3$ | $0$ | $0$ | $0$ | $0$ | $0$ | $0$ |
| 节点 $2$ | $0$ | $0$ | $3$ | $3$ | $4$ | $0$ | $4$ | $3$ | $3$ | $4$ | $5$ | $0$ | $0$ | $0$ |
| 节点 $3$ | $0$ | $0$ | $0$ | $0$ | $0$ | $4$ | $4$ | $4$ | $0$ | $0$ | $0$ | $4$ | $5$ | $6$ |

表格中列出了全部 $14$ 棵满足条件的树，将这些树的权值加起来为 $78$。

**【数据范围】**

对于 $100\%$ 的数据，$1 \leq n \leq 200$，$1 \leq l_i \leq r_i \leq {10}^9$，$1 \leq K \leq {10}^9$。

| 测试点 | $n \leq $ | $r_i, K \leq$ | 其他限制 |
|:-:|:-:|:-:|:-:|
| $1$ | $5$ | $10$ | 无 |
| $2$ | $30$ | $10^9$ | 无 |
| $3$ | $30$ | $10^9$ | 无 |
| $4$ | $30$ | $500$ | 无 |
| $5$ | $200$ | $200000$ | 无 |
| $6$ | $200$ | $200000$ | 无 |
| $7$ | $200$ | $10^9$ | A |
| $8$ | $200$ | $10^9$ | A |
| $9$ | $200$ | $10^9$ | 无 |
| $10$ | $200$ | $10^9$ | 无 |

特殊限制 A：所有点构成一条链, 编号为 $i$ 的点和编号为 $i + 1$ 的点之间有连边

**【评分方式】**

本题共 $10$ 个测试点，每个测试点 $10$ 分。其中回答正确第一问可得 $7$ 分，回答正确第二问可得 $3$ 分。

## 样例 #1

### 输入

```
3 1
2 3
3 5
4 6
1 2
1 3
```

### 输出

```
14
78
```

## 样例 #2

### 输入

```
见附件中的 tree/tree2.in```

### 输出

```
见附件中的 tree/tree2.ans```

## 样例 #3

### 输入

```
见附件中的 tree/tree3.in```

### 输出

```
见附件中的 tree/tree3.ans```

# AI分析结果


### 题目分析：填树问题

#### 题目核心
给定一棵树，每个节点有权值范围 $[l_i, r_i]$。选择一条路径，为路径上每个节点赋一个**正整数**权值，要求非零权值的最大值与最小值之差 $\leq K$。需要计算：
1. **方案数**：满足条件的赋权方案总数（第一问）。
2. **权值和**：所有满足条件的树的节点权值之和（第二问）。

#### 算法核心：动态规划 + 拉格朗日插值 + 值域分段

##### 关键步骤
1. **枚举最小值 $L$**：
   - 权值限制在 $[L, L+K]$ 内。
   - 通过容斥处理：用 $[L, L+K]$ 的方案数减去 $[L+1, L+K]$ 的方案数，确保最小值 $L$ 被取到。

2. **值域分段**：
   - 分段点包括 $l_i, r_i, \max(0, l_i - K), \max(0, r_i - K)$，共 $O(n)$ 段。
   - 每段内，每个节点的可选权值数量（$len$）是 $L$ 的**一次多项式**，权值和（$sum$）是 $L$ 的**二次多项式**。

3. **动态规划（树形DP）**：
   - **状态定义**：
     - `dp1[u]`：以 $u$ 为端点的路径方案数。
     - `dp2[u]`：以 $u$ 为端点的路径权值和。
   - **转移方程**：
     - 合并子树时，考虑路径组合：
       ```math
       \begin{aligned}
       \text{dp1}[u] &= \text{len}_u \times \prod_{v} (1 + \text{dp1}[v]) \\
       \text{dp2}[u] &= \text{sum}_u \times \prod_{v} (1 + \text{dp1}[v]) + \text{len}_u \times \sum_{v} \text{dp2}[v]
       \end{aligned}
       ```
   - **复杂度**：单次 $O(n)$。

4. **拉格朗日插值**：
   - 在值域每一段内，方案数和权值和是关于 $L$ 的 $n$ 次和 $n+1$ 次多项式。
   - 计算前 $n+2$ 个点值，用插值公式求区间和：
     ```math
     f(x) = \sum_{i=1}^{n+2} y_i \prod_{j \neq i} \frac{x - x_j}{x_i - x_j}
     ```
   - **总复杂度**：$O(n^3)$（$n$ 段 × $O(n)$ 点值 × $O(n)$ 插值）。

##### 难点突破
- **多项式次数分析**：
  - 方案数：$n$ 次多项式（$n$ 个节点乘积）。
  - 权值和：$n+1$ 次多项式（加入二次函数求和）。
- **值域分段优化**：避免枚举整个值域，仅处理 $O(n)$ 个关键点。
- **动态规划细节**：路径合并时需避免重复计数，容斥确保最小值 $L$ 被取到。

#### 算法对比
| 题解作者 | 核心思路 | 优化点 | 代码亮点 |
|----------|----------|--------|----------|
| **WeLikeStudying** | 拉格朗日插值 + 树形DP | 分段处理多项式 | 详细推导插值过程 |
| **Renshey** | 值域分段 + 插值 | 直接拆 $\min/\max$ | 代码简洁，强调分段多项式性质 |
| **小木虫** | 暴力DP优化到插值 | 强调多项式次数证明 | 提供完整DP转移方程 |
| **HikariS** | 树上背包 + 多项式卷积 | 避免插值，用自然数幂和 | 适合数学基础强的学习者 |
| **Autre** | 拉格朗日插值 + 树形DP | 轻量化实现 | 代码简短，强调分段思想 |

#### 精炼结论
1. **核心算法**：动态规划处理树上路径，拉格朗日插值加速值域求和。
2. **关键技巧**：
   - 容斥确保最小值 $L$ 被取到。
   - 值域分段将问题转化为多项式求和。
   - 插值法避免暴力枚举值域。
3. **复杂度**：$O(n^3)$，可通过 $n \leq 200$ 的数据。
4. **适用场景**：值域大但函数分段平滑的问题（如树上路径统计）。

#### 算法可视化：像素动画方案
为帮助理解动态规划过程，设计一个**8位像素风格**的动画演示：
```markdown
### 5. 算法可视化：像素动画演示
* **主题**：`像素探险家在网格迷宫中搜索路径`
* **核心演示**：
  1. **树结构展示**：节点用像素方块表示，边用连线连接（复古FC风格）。
  2. **DP状态更新**：
     - 当前节点高亮（闪烁），显示 `dp1[u]` 和 `dp2[u]` 的值。
     - 子树合并时，用箭头表示路径延伸，伴随“叮”音效。
  3. **值域分段**：网格下方进度条显示当前 $L$ 值，颜色标记分段区间。
* **交互控制**：
  - **单步执行**：按空格键逐步更新DP状态。
  - **自动播放**：滑块调节速度（1x~5x），背景音乐为8位芯片音乐。
  - **重置/暂停**：按钮控制动画流程。
* **动画示例**：
  - 当 $L$ 变化时，节点颜色变化（红：不可选，绿：可选）。
  - 路径找到时播放“胜利”音效，显示方案数和权值和。
```

#### 拓展练习
1. **相似问题**：
   - **洛谷 P4211 [HEOI2014] 路径**：类似树上路径统计。
   - **CF622F The Sum of the k-th Powers**：拉格朗日插值模板题。
   - **洛谷 P4389 付公主的背包**：生成函数与插值结合。
2. **推荐题目**：
   | 题号 | 名称 | 训练目标 |
   |------|------|----------|
   | P4211 | 路径 | 树上路径DP |
   | CF622F | 自然数幂和 | 拉格朗日插值 |
   | P4389 | 付公主的背包 | 生成函数与多项式 |

#### 学习心得
- **经验分享**：调试时重点检查分段点和插值点，确保多项式次数正确。
- **核心收获**：将大值域问题转化为分段多项式，利用插值避免枚举是高效解题的关键。

---
处理用时：88.24秒
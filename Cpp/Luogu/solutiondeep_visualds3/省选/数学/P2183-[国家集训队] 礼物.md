# 题目信息

# [国家集训队] 礼物

## 题目背景

一年一度的圣诞节快要来到了。每年的圣诞节小 E 都会收到许多礼物，当然他也会送出许多礼物。不同的人物在小 E 心目中的重要性不同，在小 E 心中分量越重的人，收到的礼物会越多。

## 题目描述

小 E 从商店中购买了 $n$ 件礼物，打算送给 $m$ 个人，其中送给第 $i$ 个人礼物数量为 $w_i$。请你帮忙计算出送礼物的方案数（两个方案被认为是不同的，当且仅当存在某个人在这两种方案中收到的礼物不同）。由于方案数可能会很大，你只需要输出模 $P$ 后的结果。


## 说明/提示

### 样例 1 解释
以 `/` 分割，`/` 前后分别表示送给第一个人和第二个人的礼物编号。$12$ 种方案详情如下：
```plain
1/23 1/24 1/34
2/13 2/14 2/34
3/12 3/14 3/24
4/12 4/13 4/23
```
### 数据规模与约定
设 $P= \prod_{i=1}^t p_i^{c_i}$，$p_i$ 为质数。

对于 $15\%$ 的数据，$n\leq 15$，$m\leq 5$，$p_i^{c_i}\leq 10^5$。

在剩下的 $85\%$ 数据中，约有 $60\%$ 的数据满足 $t\leq 2$，$c_i=1$，$p_i\leq 10^5$，约有 $30\%$ 的数据满足 $p_i\leq 200$。

对于 $100\%$ 的数据，$1\leq n\leq 10^9$，$1\leq m\leq 5$，$1\leq p_i^{c_i}\leq 10^5$，$1\leq w_i \leq P\leq 10^9$。


## 样例 #1

### 输入

```
100
4 2
1
2
```

### 输出

```
12```

## 样例 #2

### 输入

```
100
2 2
1
2```

### 输出

```
Impossible
```

# AI分析结果


### 💡 Kay的C++算法解析：礼物 深入学习指南 💡

#### **题目解读与核心算法识别**
✨ **本题主要考察**：组合计数与模非质数处理（扩展卢卡斯定理）  
🗣️ **初步分析**：
> 本题要求将 $n$ 件不同礼物分给 $m$ 人，每人得 $w_i$ 件，求方案数模 $P$。其本质是计算组合数连乘：
> $$
> \prod_{i=1}^m C_{n - \sum_{j=1}^{i-1} w_j}^{w_i} \mod P
> $$
> 当 $P$ 非质数时，需用 **扩展卢卡斯定理 (ExLucas)**。该算法将 $P$ 质因数分解为 $p^k$，分别计算组合数模 $p^k$ 后，用中国剩余定理 (CRT) 合并结果。  
> **核心难点**：  
> 1. $P$ 非质数时无法直接求逆元。  
> 2. $n$ 极大（$10^9$），需高效计算阶乘模 $p^k$。  
> **可视化设计**：  
> 采用复古像素风格，模拟“礼物分发明”游戏。动画演示：  
> - **质因数分解阶段**：像素方块表示 $P$，爆破成 $p_1^{k_1}, p_2^{k_2},\dots$（音效：爆破声）。  
> - **阶乘计算阶段**：网格代表 $n!$，高亮移除质因子 $p_i$ 的过程（闪烁效果）。  
> - **CRT 合并**：像素管道将部分结果合并为最终答案（胜利音效）。

---

### **精选优质题解参考**
**题解一（作者：___new2zy___）**  
* **点评**：  
  思路清晰，推导完整：从组合数公式引出 ExLucas，逐步解释质因数分解、阶乘处理、CRT 合并。代码规范：函数模块化（`mul` 计算阶乘、`exLucas` 整合流程），变量名明确（`pk` 表 $p^k$）。亮点：详细解释递归移除质因子的阶乘计算，复杂度分析到位（单次 $O(\log n)$）。实践价值高，代码可直接用于竞赛。

**题解二（作者：da_AA）**  
* **点评**：  
  提供新颖思路：将方案数公式改写为 $\frac{n!}{(n-\sum w_i)! \prod w_i!}$，再应用 ExLucas。代码简洁高效：递归阶乘时直接处理质因子计数。亮点：优化了公式推导，避免重复计算剩余礼物。边界处理严谨（`if (n<0) return 0`），适合学习代码精简技巧。

**题解三（作者：没名字可被用）**  
* **点评**：  
  聚焦阶乘处理细节：强调拆分阶乘为“完整循环段+剩余部分”。代码实现完整：`fac` 函数递归移除质因子并分段计算乘积。亮点：深入解释 $n!$ 的数学结构，帮助理解 ExLucas 本质。调试建议（如边界测试）具实践参考价值。

---

### **核心难点辨析与解题策略**
1. **难点：模数 $P$ 非质数导致逆元不可求**  
   * **分析**：组合数含除法，需逆元但 $P$ 非质数。解法：分解 $P=\prod p_i^{k_i}$，分别计算 $C_n^m \mod p_i^{k_i}$ 后 CRT 合并。  
   * 💡 **学习笔记**：质因数分解是处理非质数模数的基石。

2. **难点：大阶乘计算效率低下**  
   * **分析**：直接计算 $n!$ 不可行。解法：递归移除质因子 $p$，将阶乘拆为 $p^{\lfloor n/p \rfloor} \cdot (\lfloor n/p \rfloor!) \cdot (\text{循环段}) \cdot (\text{剩余})$。  
   * 💡 **学习笔记**：递归分治是高效计算大阶乘的关键。

3. **难点：组合数分母的质因子处理**  
   * **分析**：分母 $m!(n-m)!$ 可能含质因子 $p$。解法：统计分子分母中 $p$ 的指数差，分开计算非 $p$ 部分。  
   * 💡 **学习笔记**：分离质因子避免除法失效。

#### ✨ **解题技巧总结**
- **质因数分解先行**：立即分解 $P$，化归为质数幂模问题。  
- **阶乘分段递归**：将 $n!$ 拆为循环段、剩余和递归子问题。  
- **CRT 合并结果**：中国剩余定理整合部分解。  
- **边界严谨处理**：特判 $n < \sum w_i$ 为 `Impossible`。

---

### **C++核心代码实现赏析**
#### 本题通用核心C++实现参考
```cpp
#include <iostream>
using namespace std;
typedef long long ll;

ll exgcd(ll a, ll b, ll &x, ll &y) {
    if (!b) { x = 1; y = 0; return a; }
    ll d = exgcd(b, a % b, y, x);
    y -= a / b * x;
    return d;
}

ll inv(ll a, ll p) {
    ll x, y;
    exgcd(a, p, x, y);
    return (x % p + p) % p;
}

ll qpow(ll a, ll b, ll p) {
    ll res = 1;
    while (b) {
        if (b & 1) res = res * a % p;
        a = a * a % p;
        b >>= 1;
    }
    return res;
}

ll fac(ll n, ll pi, ll pk) {
    if (!n) return 1;
    ll res = 1;
    for (ll i = 2; i <= pk; i++) 
        if (i % pi) res = res * i % pk;
    res = qpow(res, n / pk, pk);
    for (ll i = 2; i <= n % pk; i++) 
        if (i % pi) res = res * i % pk;
    return res * fac(n / pi, pi, pk) % pk;
}

ll exLucas(ll n, ll m, ll pi, ll pk) {
    if (m > n) return 0;
    ll a = fac(n, pi, pk), b = fac(m, pi, pk), c = fac(n - m, pi, pk);
    ll k = 0;
    for (ll i = n; i; i /= pi) k += i / pi;
    for (ll i = m; i; i /= pi) k -= i / pi;
    for (ll i = n - m; i; i /= pi) k -= i / pi;
    return a * inv(b, pk) % pk * inv(c, pk) % pk * qpow(pi, k, pk) % pk;
}

ll crt(ll a, ll p, ll pk) {
    return a * (p / pk) % p * inv(p / pk, pk) % p;
}

ll solve(ll n, ll m, ll p) {
    ll res = 0, tmp = p;
    for (ll i = 2; i * i <= tmp; i++) {
        if (tmp % i) continue;
        ll pk = 1;
        while (tmp % i == 0) pk *= i, tmp /= i;
        res = (res + crt(exLucas(n, m, i, pk), p, pk)) % p;
    }
    if (tmp > 1) res = (res + crt(exLucas(n, m, tmp, tmp), p, tmp)) % p;
    return res;
}

int main() {
    ll P, n, m, w, sum = 0, ans = 1;
    cin >> P >> n >> m;
    for (int i = 0; i < m; i++) {
        cin >> w;
        sum += w;
        if (n < sum) { cout << "Impossible"; return 0; }
        ans = ans * solve(n, w, P) % P;
        n -= w;
    }
    cout << ans;
}
```
* **代码解读概要**：  
  1. `exLucas`：计算 $C_n^m \mod p^k$，调用 `fac` 处理阶乘。  
  2. `fac`：递归计算 $n! / p^{\text{count}}$ 模 $p^k$。  
  3. `crt`：中国剩余定理合并部分解。  
  4. 主逻辑：读入 $w_i$，累乘组合数并更新剩余礼物数。

#### 题解片段赏析
**题解一（ExLucas 核心逻辑）**  
```cpp
ll exLucas(ll n, ll m, ll pi, ll pk) {
    ll a = fac(n, pi, pk), b = fac(m, pi, pk), c = fac(n - m, pi, pk);
    // ... 质因子计数与合并
}
```
* **亮点**：模块化清晰，分离阶乘与质因子计数。  
* **学习笔记**：质因子指数差通过循环除法高效统计。

**题解二（公式优化）**  
```cpp
ans = n! / ((n - sum)! * ∏ w_i!); // 直接计算总公式
```
* **亮点**：避免累乘组合数，减少递归调用次数。  
* **学习笔记**：数学优化可提升代码效率。

**题解三（阶乘分段计算）**  
```cpp
for (int i = 2; i <= pk; i++) 
    if (i % pi) res = res * i % pk; // 非 p 倍数段
```
* **亮点**：显式处理循环段，增强可读性。  
* **学习笔记**：循环段乘积可预计算加速。

---

### **算法可视化：像素动画演示**
**主题**：复古像素游戏“礼物分发明”  
**核心演示**：ExLucas 分阶段执行流程  
**设计思路**：  
- **8-bit 风格**：FC 红白机色调，礼物/质因数用不同像素块表示。  
- **交互控制**：步进按钮、调速滑块、重置键。  
- **音效**：质因数分解（爆破声）、阶乘计算（按键声）、CRT 合并（胜利音效）。  

**动画帧步骤**：  
1. **初始化**：像素网格展示 $n$ 个礼物盒，$P$ 显示为待分解大方块。  
2. **质因数分解**：$P$ 爆破为 $p_1^{k_1}, p_2^{k_2},\dots$（爆破动画+音效）。  
3. **阶乘计算**：  
   - 高亮当前质因子 $p_i$（闪烁）。  
   - $n!$ 网格分段：循环段（绿色）、剩余（黄色）、递归子问题（箭头指向缩小网格）。  
4. **组合数计算**：  
   - 分子/分母阶乘对比，移除质因子计数（数字浮动显示）。  
   - 逆元计算：像素锁被钥匙（逆元）解开（音效：解锁声）。  
5. **CRT 合并**：部分结果通过管道流入 CRT 机器，输出最终答案（像素烟花+胜利音乐）。  

**技术实现**：Canvas 绘制网格，Web Audio API 添加音效，单文件 HTML/CSS/JS 实现。

---

### **拓展练习与相似问题**
1. **通用技巧迁移**：  
   ExLucas 适用于：  
   - 大组合数模非质数（如密码学）。  
   - 高精度阶乘计算（分治优化）。  
   - 数论问题中的分治求值。  

2. **洛谷推荐**：  
   - **P3807 【模板】卢卡斯定理**：基础 Lucas 定理，适合练习质数模数。  
     > 🗣️ *推荐理由*：巩固质数模下的组合数计算，对比 ExLucas 差异。  
   - **P2480 [SDOI2010] 古代猪文**：ExLucas 经典应用。  
     > 🗣️ *推荐理由*：复杂模数处理，提升 CRT 合并技巧。  
   - **P3301 [SDOI2013] 方程**：组合数模非质数变式。  
     > 🗣️ *推荐理由*：拓展 ExLucas 在约束条件下的应用。

---

### **学习心得与经验分享**
> **参考经验（作者：___new2zy___）**：  
> “调试时特别注意 `n < sum` 和递归边界，我曾在阶乘的质因子计数卡了很久。”  
> **点评**：典型调试教训，验证输入边界和递归终止条件是避免 WA 的关键。动手模拟小数据（如 $n=5, p=2$）可快速定位逻辑错误。”

---

### **结语**
掌握 ExLucas 需理解其三大支柱：质因数分解、阶乘递归分治、CRT 合并。通过本题，我们不仅学会处理非质数模组合数，更领悟了数论分治的思想。下次挑战见！💪
```

---
处理用时：153.72秒
# 题目信息

# [BJOI2019] 光线

## 题目描述

当一束光打到一层玻璃上时，有一定比例的光会穿过这层玻璃，一定比例的光会被反射回去，剩下的光被玻璃吸收。  

设对于任意 $x$，有 $x \times a_i\%$ 单位的光会穿过它，有 $x \times b_i\%$ 的会被反射回去。  
现在 $n$ 层玻璃叠在一起，有 $1$ 单位的光打到第 $1$ 层玻璃上，那么有多少单位的光能穿过**所有** $n$ 层玻璃呢？


## 说明/提示

**样例1解释：**  
![](https://cdn.luogu.com.cn/upload/pic/57125.png)   
如图，光线从左上角打进来，有 $0.5$ 单位的光穿过第 $1$ 层玻璃，有 $0.2$ 单位的光被反射回去。这 $0.5$ 单位的光有 $0.4$ 单位穿过第 $2$ 层玻璃，有 $0.025$ 单位的光被反射回去。这 $0.025$ 单位的光有 $0.0125$ 单位穿过第 $1$ 层玻璃，有 $0.005$ 单位的光被反射回去。这 $0.005$ 单位的光有 $0.004$ 单位穿过第 $2$ 层玻璃……于是，穿过两层玻璃的光一共有$0.40404... = 40/99$ 单位。在模 $10^9+7$ 意义下等于 $858585865$。 

**数据范围：**  
对于 $5\%$ 的数据，$n=1$；    
对于 $20\%$ 的数据，$n\le 2$；    
对于 $30\%$ 的数据，$n\le 3$；    
对于 $50\%$ 的数据，$n\le 100$；    
对于 $70\%$ 的数据，$n\le 3000$；    
对于 $100\%$ 的数据，$n\le 5\times 10^5$，$1\le a_i \le 100$，$0\le b_i \le 99$，$1\le a_i+b_i \le 100$。  

每组 $a_i$ 和 $b_i$ 在满足上述限制的整数中随机生成。

## 样例 #1

### 输入

```
2
50 20
80 5```

### 输出

```
858585865```

## 样例 #2

### 输入

```
3
1 2
3 4
5 6```

### 输出

```
843334849```

# AI分析结果


### 💡 Kay的C++算法解析：光线 深入学习指南 💡

**引言**  
今天我们一起分析“光线”这道C++编程题。本指南将帮助你理解多层玻璃透射问题，掌握动态规划与无穷级数求和技巧，并通过像素动画直观理解算法。

---

## 1. 题目解读与核心算法识别

✨ **本题主要考察**：`动态规划与无穷级数求和`  
🗣️ **初步分析**：  
> 解决“光线”问题的核心在于**动态规划**结合**无穷级数求和**。想象光线在玻璃层间像弹球一样反复弹跳，每次反射强度减弱。我们需要计算所有透射光线的总和——这本质上是一个无穷等比数列求和问题。  

- **核心思路**：维护两个状态量  
  - `P_i`：前`i`层玻璃的整体透射率（光从顶部射入的穿透比例）  
  - `Q_i`：前`i`层玻璃的反射率（光从第`i`层底部射入的反射比例）  
- **关键公式**（推导自等比数列求和）：  
  ```math
  P_i = \frac{P_{i-1} \cdot a_i}{1 - Q_{i-1} \cdot b_i}, \quad 
  Q_i = b_i + \frac{Q_{i-1} \cdot a_i^2}{1 - Q_{i-1} \cdot b_i}
  ```
- **可视化设计**：  
  在像素动画中，我们将用**绿色箭头**表示透射光路，**红色箭头**表示反射光路。关键步骤包括：  
  1. 高亮当前处理的玻璃层  
  2. 动态展示光线在层间的多次反射（箭头颜色逐渐变淡表示衰减）  
  3. 实时显示`P_i`和`Q_i`的数值更新  
- **复古游戏化**：  
  采用8位像素风格（类似FC游戏），每层玻璃作为一关：  
  - 透射成功时播放“叮”音效，通关时播放胜利音效  
  - 支持步进控制（暂停/继续/调速）观察光路细节  

---

## 2. 精选优质题解参考

**题解一：小粉兔（45赞）**  
* **点评**：  
  思路清晰度⭐⭐⭐⭐⭐——直接推导物理意义明确的`P_i`（透射率）和`Q_i`（反射率），点明“不同方向反射率不同”的关键洞察。代码规范性⭐⭐⭐⭐——变量名`P, Q`含义明确，边界处理严谨（+Mod防负数）。算法有效性⭐⭐⭐⭐⭐——O(n)时间复杂度，空间复杂度O(1)。实践价值⭐⭐⭐⭐⭐——代码可直接用于竞赛，快速幂求逆元提升效率。

**题解三：花里心爱（12赞）**  
* **点评**：  
  思路清晰度⭐⭐⭐⭐——创新性引入比例变量`F_i = f[i]/f[i-1]`，通过数学变换避免大数计算。代码规范性⭐⭐⭐⭐——模块化分离逆元计算和递推逻辑。算法有效性⭐⭐⭐⭐——O(n)时间但需两次遍历。实践价值⭐⭐⭐——提供另一种视角，适合进阶学习者理解状态设计的灵活性。

---

## 3. 核心难点辨析与解题策略

1. **状态定义的双维度性**  
   * **分析**：必须同时维护透射率（自上而下）和反射率（自下而上）。优质题解用`P_i`和`Q_i`分别表示这两个物理量，确保状态无后效性。  
   * 💡 **学习笔记**：好的状态设计需完整描述光的双向传播特性。

2. **无穷反射的数学处理**  
   * **分析**：光线在玻璃层间反复反射形成无穷级数。通过等比数列求和公式（`S = a/(1-r)`）将无限问题转化为有限表达式，其中`r = Q_{i-1}·b_i < 1`保证收敛。  
   * 💡 **学习笔记**：识别等比结构是化无限为有限的关键。

3. **模运算下的除法处理**  
   * **分析**：公式中的除法需转换为乘逆元。小粉兔题解用快速幂求逆元：`inv(x) = x^{MOD-2} % MOD`。  
   * 💡 **学习笔记**：在模数领域，除法必须通过逆元实现。

### ✨ 解题技巧总结
- **技巧1：物理模型数学化**  
  将光学过程转化为递推关系，结合等比数列求和压缩状态转移。  
- **技巧2：逆元预处理**  
  用`const int Inv100 = 570000004`避免重复计算100的逆元。  
- **技巧3：负数防溢出**  
  关键运算后加`(x%MOD + MOD)%MOD`确保非负。  

---

## 4. C++核心代码实现赏析

**本题通用核心C++实现**  
```cpp
#include <cstdio>
typedef long long LL;
const int Mod = 1000000007;
const int Inv100 = 570000004; // 100的逆元

// 快速幂求逆元（模素数）
inline LL Inv(LL b) {
    LL a = 1;
    for (int e = Mod - 2; e; e >>= 1, b = b * b % Mod)
        if (e & 1) a = a * b % Mod;
    return a;
}

int main() {
    int N; scanf("%d", &N);
    LL P = 1, Q = 0; // 初始化：无玻璃时透射率100%，反射率0%
    while (N--) {
        LL a, b;
        scanf("%lld%lld", &a, &b);
        a = a * Inv100 % Mod; // 转换为比例
        b = b * Inv100 % Mod;
        LL W = Inv((1 - Q * b % Mod + Mod) % Mod); // 1/(1-Q·b_i)
        Q = (b + a * a % Mod * Q % Mod * W) % Mod; // 更新反射率
        P = P * a % Mod * W % Mod; // 更新透射率
    }
    printf("%lld\n", P);
    return 0;
}
```
**代码解读概要**：  
- **初始化**：`P=1`（无玻璃时透射率），`Q=0`（无玻璃时反射率）  
- **核心循环**：  
  1. 计算当前层`a_i, b_i`（除以100）  
  2. 求无穷级数因子`W = 1/(1-Q·b_i)`  
  3. 更新`Q`（反射率）和`P`（透射率）  
- **防溢出**：`(x%Mod + Mod)%Mod`确保结果非负  

---

## 5. 算法可视化：像素动画演示

**主题**：8位像素风格“光线穿透大冒险”  
**核心演示流程**：  
1. **场景初始化**：  
   - 玻璃层用彩色像素方块表示（蓝色=普通层，黄色=当前处理层）  
   - 控制面板：开始/暂停按钮，速度滑块（调速范围1x-5x）  
   ```plaintext
   [控制台] 
   | 开始 | 暂停 | 速度: [===|===] 3x |
   ```

2. **单层透射/反射演示**（以第i层为例）：  
   - **步骤1**：绿色箭头从顶部射入当前玻璃（显示光强值）  
   - **步骤2**：分裂为透射光（向下绿色箭头）和反射光（向上红色箭头）  
   - **步骤3**：反射光在层间反弹（箭头颜色渐淡，强度=原始值×0.3^k）  
   - **步骤4**：实时显示公式计算：  
     ```math
     W = \frac{1}{1 - Q_{i-1}·b_i} = 1.25 \quad (\text{播放音效})
     ```

3. **自动演示模式**：  
   - 类似“贪吃蛇AI”自动遍历所有层  
   - 通关时：玻璃层变为绿色，播放胜利音效+显示总透射率  

4. **交互设计细节**：  
   - **音效**：透射（8-bit“叮”声），反射（低沉“砰”声），通关（胜利旋律）  
   - **数据展示**：右侧信息栏实时显示`P_i`和`Q_i`的数值变化  

---

## 6. 拓展练习与相似问题思考

**通用技巧迁移**：  
- 等比数列求和压缩状态转移可应用于：  
  1. 电阻网络等效电阻计算  
  2. 马尔科夫链中的概率收敛  
  3. 金融复利模型中的无限期现金流  

**洛谷推荐题目**：  
1. **P1053 电阻网络**  
   🗣️ *推荐理由*：同样需要合并串联/并联结构，巩固递推与数学化简技巧。  
2. **P1654 概率计算器**  
   🗣️ *推荐理由*：练习用无穷级数处理概率问题，强化状态设计能力。  
3. **P1850 换教室**  
   🗣️ *推荐理由*：结合期望值与动态规划，提升实际问题建模能力。  

---

## 7. 学习心得与经验分享

> **参考经验（小粉兔）**：  
> “解题时要注意光从玻璃不同侧射入时反射率不同，这是许多错误假设的根源。”  
>  
> **点评**：  
> 这个经验强调了**物理模型的精确性**对算法设计的影响。在类似问题中，必须明确每个状态量的物理意义和方向性，避免因简化过度导致错误。  

---

**结语**  
通过本次分析，我们掌握了用动态规划+无穷级数处理多层透射问题的方法。记住：清晰的状态定义和数学工具的应用是解题关键。下次挑战见！💪

---
处理用时：179.98秒
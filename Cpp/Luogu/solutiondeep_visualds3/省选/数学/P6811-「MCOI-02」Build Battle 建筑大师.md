# 题目信息

# 「MCOI-02」Build Battle 建筑大师

## 题目背景

WAPER 爱玩 hypixel（世界上最大的 Minecraft 小游戏服务器） 建筑大师！

提示：在本题中，羊毛属于一种方块。

## 题目描述

现在 WAPER 准备玩 $q$ 局建筑大师。在第 $i$ 局游戏的开始，WAPER 会选定一个参数 $m_i$，并 **按顺序** 放置 $n$ 个有颜色的羊毛，羊毛颜色的排列如下：

$$1,\ 2,\ ...\ ,\ m_i-1,\ m_i,\ 1,\ 2,\ ...\ ,m_i-1\ ,m_i\ ,\ ...\ (n-1) \ \bmod \  m_i+1$$

例如 $n=7,m=3$ 时，颜色排列如下：

$$1\ ,2,\ 3,\ 1,\ 2,\ 3,\ 1$$

现在 WAPER 准备打破一些方块（可以一个也不打破，也可以全部打破），WAPER 想知道这样可以产生多少种不同的颜色序列。（两个颜色序列不同当且仅当其长度不同或某一位置的羊毛颜色不同）

因为答案太大，所以输出答案对 $10^9+7$ 取模的结果。

（其实就是询问这个序列本质不同的子序列对 $10^9+7$ 取模的结果）

## 说明/提示

#### 数据规模与约定

**本题采用捆绑测试。**

- Subtask 1（5 pts）$\ \ $：$n \le 20$，$q=1$。
- Subtask 2（15 pts）：$n \le 10^3$，$q=1$。
- Subtask 3（15 pts）：$\max\{m_i\} \le 20$，$q=1$。
- Subtask 4（25 pts）：$q=1$。
- Subtask 5（40 pts）：无特殊限制。

对于 $100\%$ 的数据，$1 \le n,q \le 10^6$，$1 \le m_i \le n$。

#### 说明

Minecraft OI Round 2 B

- Maker：WAPER420
- Tester：灵空

$样例不是出题人写的！！！！！！！！$

## 样例 #1

### 输入

```
10 6
1 1 4 5 1 4```

### 输出

```
11
11
833
944
11
833```

## 样例 #2

### 输入

```
1000000 1
114514```

### 输出

```
945636198```

# AI分析结果


### 💡 Kay的C++算法解析：Build Battle 建筑大师 深入学习指南 💡

#### 1. 题目解读与核心算法识别
✨ **本题主要考察**：`组合数学与动态规划优化`  
🗣️ **初步分析**：  
> 本质是求循环序列的本质不同子序列数。序列按 `1,2,...,m` 循环构成，需避免重复计数。核心技巧是将DP方程转化为组合问题：  
> - **组合计数比喻**：想象角色在循环轨道行走，每次可选择：  
>   - 走1步：方案数×2（记录当前颜色）  
>   - 跳跃m+1步：方案数×(-1)（跳过整个循环节避免重复）  
> - **可视化设计**：用像素轨道展示颜色循环（FC游戏风格），高亮当前操作格子。跳跃时播放下滑音效，走步时显示×2动画。自动演示模式将展示不同跳跃次数的路径组合。

---

#### 2. 精选优质题解参考
**题解一（w4p3r）**  
* **点评**：完整推导DP优化到组合计数的过程，解释状态转移 $f_i=2f_{i-1}-f_{i-m-1}$ 的物理意义（权值翻倍与取反），给出清晰组合公式。代码预处理阶乘+幂次，记忆化查询，实践性强。亮点：将抽象DP转化为直观路径计数模型。

**题解二（gghack_Nythix）**  
* **点评**：独立推导相同结论，强调问题分解思想。代码用前缀和优化组合计算，变量名 `fac/inv` 规范，边界处理严谨。亮点：详细分析转移方程组合意义，提供可复用的组合数模板。

**题解三（wwwwwza）**  
* **点评**：简洁高效实现，直接应用公式 $ans=\sum (-1)^i 2^{n-i(m+1)} \binom{n-i(m+1)+i}{i}$。亮点：强调本质不同子序列的通用解法框架，代码用 `vector` 预计算避免重复。

---

#### 3. 核心难点辨析与解题策略
1. **难点：避免子序列重复计数**  
   *分析*：当相同颜色重复出现时，需跳过前一次出现的冗余状态。优质题解用 $f_{i-m-1}$ 消除重复（最近同色位置为 $i-m$）。  
   💡 学习笔记：循环序列中，同色间隔固定为 $m$，利用该性质优化状态转移。

2. **难点：转化DP为组合问题**  
   *分析*：递推式 $f_i=2f_{i-1}-f_{i-m-1}$ 对应两种操作：走步（×2）和跳跃（×(-1)）。通过枚举跳跃次数，用组合数统计操作序列方案数。  
   💡 学习笔记：线性递推可转化为路径计数模型，组合数描述操作排列。

3. **难点：高效计算组合公式**  
   *分析*：需快速计算 $2^k \binom{k+i}{i}$。预处理阶乘 $O(n)$ + 查询 $O(1)$，总复杂度 $O(n \log n)$（调和级数枚举 $m$）。  
   💡 学习笔记：预处理是优化组合问题的关键技巧。

### ✨ 解题技巧总结
- **模型转化**：将DP状态转移视为操作序列（走步/跳跃）  
- **组合优化**：预处理阶乘+逆元加速组合数计算  
- **边界处理**：注意 $n-i(m+1)<0$ 时组合数为0  
- **记忆化**：对重复查询的 $m$ 存储结果  

---

#### 4. C++核心代码实现赏析
**通用核心实现**  
```cpp
#include <bits/stdc++.h>
using namespace std;
const int N = 2e6, mod = 1e9+7;
int fac[N], inv[N], pow2[N], ans[N];

void init() { // 预处理阶乘/幂/逆元
    fac[0]=pow2[0]=1;
    for(int i=1; i<N; i++) {
        fac[i] = 1LL*fac[i-1]*i % mod;
        pow2[i] = 2LL*pow2[i-1] % mod;
    }
    inv[N-1] = pow(fac[N-1], mod-2); // 费马小定理求逆元
    for(int i=N-2; i>=0; i--) 
        inv[i] = 1LL*inv[i+1]*(i+1) % mod;
}

int C(int n, int k) { // 组合数计算
    return 1LL*fac[n]*inv[k]%mod*inv[n-k]%mod;
}

int main() {
    init();
    int n, q, m; cin >> n >> q;
    for(m=1; m<=n; m++) // 预计算所有m的答案
        for(int i=0; i*(m+1)<=n; i++) {
            int k = n - i*(m+1);
            int term = 1LL*pow2[k] * C(k+i, i) % mod;
            ans[m] = (ans[m] + (i%2 ? mod-term : term)) % mod;
        }
    while(q--) cin >> m, cout << ans[m] << "\n";
}
```
**代码解读概要**：  
1. 预处理阶乘、逆元、2的幂次  
2. 枚举跳跃次数 $i$，计算剩余步数 $k=n-i(m+1)$  
3. 组合数 $\binom{k+i}{i}$ 统计操作序列方案  
4. $(-1)^i 2^k$ 计算权值贡献  

---

#### 5. 算法可视化：像素动画演示
![](https://via.placeholder.com/400x200/FFFF00/000000?text=Pixel+Animation)  
**设计思路**：8位像素风格模拟FC游戏，角色在循环颜色轨道移动，直观展示组合计数过程。  

**动画流程**：  
1. **轨道初始化**：  
   - 像素网格按 `1,2,...,m` 循环填色（每色独特像素块）  
   - 控制面板：速度滑块/暂停/单步按钮  
   - 背景播放8-bit循环BGM  

2. **操作演示**：  
   - **走步**：角色移动1格，当前格子闪烁+绿色高亮，播放“叮”音效，显示“×2”动画  
   - **跳跃**：角色跳过m+1格，轨迹显示红色虚线，播放“嗖”音效，显示“×(-1)”动画  

3. **AI自动演示**：  
   - 按不同跳跃次数 $i$ 自动演示路径  
   - 到达终点时：成功路径显示金光，播放胜利音效；失败路径灰暗闪烁  

4. **信息面板**：  
   - 实时显示公式：$(-1)^i 2^{k} \binom{k+i}{i}$  
   - 当前操作计数：`Steps: k | Jumps: i`  

---

#### 6. 拓展练习
1. **洛谷 P1641**：生成字符串的组合计数（类似操作模型）  
2. **洛谷 P2767**：树计数中的组合优化（预处技巧迁移）  
3. **洛谷 P2513**：逆序对计数（递推转组合思想）  

---

#### 7. 学习心得
> **w4p3r 经验**："组合计数trick要熟练"  
> **Kay点评**：将经典DP转化为组合问题是高频考点，需掌握操作序列的建模方法。  
> **gghack_Nythix 经验**："独立推导比直接看解更有收获"  
> **Kay点评**：亲自转化递推式能加深对组合意义的理解。  

> **本次指南核心收获**：  
> 1. 循环序列利用固定间隔优化DP  
> 2. 递推关系可视为带权操作路径  
> 3. 预处理是组合问题的加速关键

---
处理用时：193.48秒
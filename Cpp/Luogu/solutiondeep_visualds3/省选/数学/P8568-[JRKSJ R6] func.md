# 题目信息

# [JRKSJ R6] func

## 题目描述

**这是一道 IO 交互题．**

你有一个一次函数 $f(x)=kx+b$（$1\le x \le n-1$）．这个一次函数满足 $k,b$ 均为整数且 $k>0$．

vectorwyx 修改了这个函数，具体而言，他会选择一个整数 $t$（$1\le t \le n-1$），将这个函数在直线 $x=t$ 及右侧的部分向右平移一个单位长度，并把两部分的端点用直线段连接，得到一个分段函数 $g(x)$：

$$
g(x)=\begin{cases}
kx+b&1\le x<t\\
kt+b& t\le x <t+1\\
k(x-1)+b& t+1\le x \le n
\end{cases}
$$

请通过交互的方式得到 $t$ 的值．

### 交互方式

**本题单个测试点中含有多组数据．**

1. 首先从标准输入流读入一个整数 $T$，表示数据组数．
1. 接下来你将进行 $T$ 组数据的交互．对于每组数据，首先从标准输入流读入三个整数 $n,Q,P$．
1. 你可以通过向标准输出流输出 `? l r p`（$1\le l \le r \le n$，$2\le p \le P$）的方式来询问．在单组数据中，你最多只能进行 $Q$ 次 `?` 操作．交互库会根据你的询问依次做出以下判断并向标准输入流发送返回结果：
    - 若你的询问数据范围错误，回答为 $-2$．此时交互库会直接返回 WA．你需要立刻退出你的程序来避免与已经结束程序的交互库交互引起超时．
    - 若 $g(l)=g(r)$，回答为 $-1$．
    - 否则回答为 $(g(l) + g(r))\bmod p$．
1. 你可以通过向标准输出流输出 `! t` 的方式来给出答案．你只能进行一次回答操作，且回答操作必须是你在每组数据中进行的最后一个操作．交互完成后，从标准输入流读入一个零或一的整数 $x$．若 $x=1$ 则代表当前数据回答正确，你需要回到步骤 $2$ 以进行下一组数据的交互．否则 $x=0$，你需要立刻退出自己的程序．

**不要忘记在每次输出后刷新缓冲区，否则你将会 TLE．**

下面是一些语言的刷新缓冲区操作：

- C++：`fflush(stdout)` 或 `cout.flush()`．
- C: `fflush(stdout)`．
- Java: `System.out.flush()`．
- Python: `stdout.flush()`．
- Pascal: `flush(output)`．
- 其他语言：请参考对应语言的帮助文档．


## 说明/提示

### 样例解释

请注意，样例仅用来表示交互的规则，不保证有逻辑性．

#### 样例 #1

$f(x)=3x-2$（$1\le x \le 4$），$t=3$．

$$
g(x)=\begin{cases}
3x-2&1\le x<3\\
7& 3\le x <4\\
3x-5& 4\le x \le 5.
\end{cases}
$$

所以第一次询问的结果 $(g(1) + g(3))\bmod 2 = (1+7)\bmod 2=0$，第二次询问的结果 $(g(4)+g(5))\bmod 2 = (7+ 10)\bmod 2=1$．

### 数据范围与约束

**本题采用捆绑测试．且不存在一个 Subtask 包含其它所有 Subtask 的限制．**

| Subtask | 分值 |    $n$     | $Q=$ |       $P=$        | $g(x)\le$ |    特殊性质     |
| ------- | ---- | ---------- | ---- | ----------------- | --------- | --------------- |
| $1$     | $10$ | $\le 10^9$ | $42$ | $2\times 10^{18}$ | $10^{18}$ | 无              |
| $2$     | $20$ | $\le 10^9$ | $30$ | $2$               | $10^{18}$ | 斜率 $k$ 为奇数 |
| $3$     | $30$ | $\le 10^9$ | $42$ | $50$              | $10^{18}$ | 无              |
| $4$     | $39$ | $\le 10^9$ | $32$ | $50$              | $10^{18}$ | 无              |
|$5$|$1$|$ = 1162261531$| $32$| $50$| $7857125847061472735$|无|

对于 $100\%$ 的数据，保证 $1 \le T \le 10$，$2\le n\le 1162261531$．且满足 $\forall x \in [1,n], 0 \le g(x)\le 7857125847061472735$．

### 提示

由于本题不存在一个 Subtask 包含其它所有 Subtask 的限制．所以数据范围中「对于 $100\%$ 的数据」部分的 $n$ 和 $g(x)$ 的上界没有任何意义．但由于直接写「对于 $100\%$ 的数据，满足 $n \ge 2$，$g(x)\ge 0$」会被某些管理以「你管这叫数据范围」打回，故此题中保留该没有意义的上界．

## 样例 #1

### 输入

```
1
5 999 999

0

1

1```

### 输出

```


? 1 3 2

? 4 5 2

! 3```

# AI分析结果


### 💡 Kay的C++算法解析：func 深入学习指南 💡

#### 题目解读与核心算法识别
✨ **本题主要考察**：二分/三分查找与模运算应用  

🗣️ **初步分析**：  
> 本题的核心在于通过有限次交互询问定位分段函数的拐点位置。我们可以将其想象成在一条像素化的迷宫中寻找隐藏的“传送门”（拐点）。核心策略是：  
> 1. **模数筛选**：先通过2-12次询问找到合适的模数p（确保斜率k在模p下非零），这就像在迷宫中收集不同颜色的钥匙来测试哪把能打开门锁。  
> 2. **区间搜索**：  
>    - **二分法**（Subtask2）：利用模2时函数值的奇偶性变化直接二分，如同在黑白像素的迷宫中寻找明暗分界线。  
>    - **三分法**（通用）：每次将区间分成三等份，根据询问结果判断拐点所在区间（左/中/右），类似在RGB三色通道中定位颜色突变点。  
>  
> **可视化设计思路**：  
> - 用8-bit像素网格表示函数定义域（x轴），不同颜色表示函数值（如蓝色=左段，黄色=平台，红色=右段）。  
> - 高亮关键操作：模数测试时钥匙旋转动画，三分时区间分裂的“像素爆破”特效，拐点定位时的“宝箱开启”动画。  
> - 音效：钥匙测试（清脆叮咚声），区间分裂（像素爆破音），找到拐点（胜利小调）。  
> - 交互：控制面板支持单步/自动播放（AI贪吃蛇式自动解题），速度调节滑块。

---

#### 精选优质题解参考
**题解一（vectorwyx）**  
* **点评**：思路直击要害，清晰区分Subtask2与其他情况。模数集合（49,47,...）的选择经过严谨计算（LCM>k_max），确保覆盖所有数据。三分法推导完整（g(l)+g(r)在拐点两侧的三种表达式），代码规范：  
  - 变量名`lmid/rmid`直观，边界处理严谨（区间长度≤3时特判）。  
  - 亮点：巧妙利用模运算性质将问题转化为可三分形式，复杂度O(log₃n)，完美匹配32次询问限制。

**题解二（Eafoo）**  
* **点评**：讲解生动，比喻精准（“像素迷宫寻门”）。核心贡献在于：  
  - 明确推导`Ask(l,r,p)*2 ≡ g(l)+g(r) mod p`的三种情况，奠定三分理论基础。  
  - 代码实践性强：用DFS筛选最优模数集合，三重条件处理边界（长度≤3时逐点询问）。  
  - 亮点：提出“游戏化积分”概念（每通过一小关得星），增强学习趣味性。

**题解三（星星与辰）**  
* **点评**：函数性质分析透彻，图示辅助理解。创新点：  
  - 用`f(x)≡f(x-1) mod p`性质直接建立二分/三分依据，简化思维路径。  
  - 代码优化：随机化模数测试顺序，减少平均询问次数。  
  - 亮点：调试技巧（打印中间模数值）实用性强，适合初学者排错。

---

#### 核心难点辨析与解题策略
1. **难点1：如何选择有效模数p？**  
   * **分析**：若k≡0 mod p则询问无效。优质题解通过固定点组合（如询问(1,2)和(2,3)）求k，并选LCM足够大的奇数模数集合（如{49,47,...}）确保覆盖k_max。  
   * 💡 **学习笔记**：模数应互质且覆盖值域，类似多把钥匙开同一把锁。

2. **难点2：二分与三分的转换时机**  
   * **分析**：Subtask2（k为奇数）直接二分（O(log₂n)），其他情况三分（O(log₃n)）。关键是根据P值动态切换策略，避免询问超限。  
   * 💡 **学习笔记**：二分像走单色迷宫，三分像RGB通道分离——根据“迷宫颜色复杂度”选工具。

3. **难点3：边界条件与平台处理**  
   * **分析**：当询问返回-1（g(l)=g(r)）时立即锁定拐点。代码中需特判区间长度≤3的情况，逐点询问避免遗漏。  
   * 💡 **学习笔记**：平台区如像素图中的纯色方块，需用“像素放大镜”（单点询问）精确定位。

### ✨ 解题技巧总结
- **技巧1：问题分解与抽象**  
  将交互题分解为“模数测试+区间搜索”两阶段，抽象出函数值变化模型（左/平台/右）。
- **技巧2：数据结构轻量化**  
  仅用整型变量存储模数、斜率、截距，避免复杂数据结构。
- **技巧3：边界鲁棒性测试**  
  对n=2, t=1/t=n-1等边界设计特判，如题解四对t=n-1的独立处理。

---

#### C++核心代码实现赏析
**通用核心实现参考**  
```cpp
#include <bits/stdc++.h>
using namespace std;
typedef long long ll;
const int P[] = {49,47,45,43,41,37,31,29,25,23};

void solve() {
    int n, Q, Pmax; 
    cin >> n >> Q >> Pmax;
    // 模数筛选与三分逻辑（略）
}

int main() {
    int T; cin >> T;
    while (T--) solve();
}
```
**代码解读概要**：  
> 1. **模数筛选**：遍历预设模数集P，通过两次询问计算k mod p。  
> 2. **三分框架**：初始化区间[l,r]，计算三等分点lmid/rmid，根据询问结果收缩区间。  
> 3. **边界处理**：当区间长度≤3时逐点询问锁定拐点。

**题解一片段赏析**  
```cpp
int l=1, r=n;
while (r-l>1) {
    int x=(2ll*l+r)/3, y=(l+2ll*r)/3;
    int w=ask(x,y,p); // 核心询问
    if (w==-1) return answer(x);
    int a0=(k*(x-2ll+y)+b)%p; // 左区间预期值
    int a1=(k*(x-1ll+y)+b)%p; // 中区间预期值
    int a2=(k*(x+0ll+y)+b)%p; // 右区间预期值
    if (w==a0) r=x;    // 拐点在左
    else if (w==a1) l=x, r=y; // 拐点在中
    else if (w==a2) l=y; // 拐点在右
}
```
**代码解读**：  
> - `ask(x,y,p)`获取关键点函数值和模p结果，如同在像素迷宫中放置两个探针。  
> - 预期值`a0/a1/a2`对应拐点在左/中/右时的理论结果，类似预测像素颜色混合效果。  
> - 通过比较实际值与预期值，将300x300像素的搜索区域压缩到100x100，迭代至锁定目标。  
> 💡 **学习笔记**：三分法像“像素缩放镜”，每次排除1/3无效区域。

---

#### 算法可视化：像素动画演示
**主题**：8-bit迷宫探险（拐点=隐藏宝箱）  
**核心流程**：  
1. **场景初始化**：  
   - x轴网格（1到n）渲染为草地像素块，拐点t位置藏宝箱。  
   - 控制面板：开始/单步/速度滑块（复古游戏机按钮样式）。  

2. **模数测试阶段**：  
   - 探针（1,2）和（2,3）处升起像素塔，塔顶显示`Ask`返回值。  
   - 无效模数（k≡0）时塔身变灰并播放“错误音效”，有效模数则亮绿灯+“钥匙解锁”声。  

3. **三分搜索阶段**：  
   - 当前区间[l,r]高亮为黄色边框，三等分点x,y处放置旋转探针。  
   - 每次询问：探针发射光束连接，返回结果以像素数字浮现，同时播放对应音效（高音=左区间，中音=中区间，低音=右区间）。  
   - 区间收缩时，两侧像素块“坍塌”特效，保留区间放大显示（如FC游戏《塞尔达》地图缩放）。  

4. **拐点定位**：  
   - 宝箱开启动画（金币喷涌），显示“Victory!”像素字体，背景播放8-bit胜利音乐。  

**技术实现**：  
- Canvas绘制网格与动态元素，音效用Web Audio API生成8-bit音色。  
- 伪代码同步：右侧面板高亮当前执行的C++代码行（如`ask(x,y,p)`）。  
- **教育价值**：游戏化设计将抽象的区间分裂具象为“地图探索”，强化算法直觉。  

---

#### 拓展练习与相似问题思考
1. **洛谷 P1883** - 函数  
   * 🗣️ **推荐理由**：同样考察分段函数极值，可练习二分/三分思想迁移。  
2. **洛谷 P3382** - 【模板】三分法  
   * 🗣️ **推荐理由**：标准三分算法实现，帮助巩固区间划分技巧。  
3. **洛谷 P4366** - 交互题  
   * 🗣️ **推荐理由**：训练交互逻辑与询问优化策略。  

---

#### 学习心得与经验分享
> **经验摘录（vectorwyx）**：  
> “调试时发现三分点计算需严格对称，否则区间收缩不均衡导致超询问次数。”  
> **Kay点评**：该经验揭示了算法实现中的关键细节——数学精度直接影响效率，建议用`(2*l+r)/3`而非`l+(r-l)/3`避免取整误差。  

> **经验摘录（Eafoo）**：  
> “模数集合的LCM必须大于理论斜率最大值，否则无法保证找到有效模数。”  
> **Kay点评**：此教训强调了算法设计中的边界意识，提醒我们在分析阶段需严格验证数学约束。  

---

通过本次分析，我们深入理解了交互题中的二分/三分技巧与模运算应用。记住：算法学习如同探索像素迷宫——耐心收集钥匙（模数），精准缩放视野（三分），终将开启宝箱（拐点）！🚀

---
处理用时：136.58秒
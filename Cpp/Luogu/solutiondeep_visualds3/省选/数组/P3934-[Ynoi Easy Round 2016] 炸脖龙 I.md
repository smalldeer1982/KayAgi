# 题目信息

# [Ynoi Easy Round 2016] 炸脖龙 I

## 题目背景

备餐时光，软泞蜥獾

草地中钻孔，日晷下打转

波若歌鹦苟延残喘，迷途绿龟嚎哮迷茫

“当心炸脖龙，我的孩子！

那锋爪利颚，能挠钩撕咬！

注意秋布秋布鸟，你需回避，

那暴躁冒烟恶怪大毛怪！”

手持宝剑鸣真理之语：寻觅强敌豪壮永不息——于噹噹树下稍事休憩，伫立良久，深陷思绪。

当思绪纷乱杂绪之际，炸脖龙双目如烔炬，从阴暗密林奔跃闯出，一路悲鸣低吟时啭啼！

一，二！一，二！一刺再刺，真理之语将敌斩成糜！

取其首级，置之死地，

伴随胜利，驰马归疾。

“真当是你把怪龙斩于马下？

奋勇吾儿！

来我怀里！奔走相告！衣锦还乡！

父喜不自禁窃鸣得意

波若歌鹦苟延残喘，

迷途绿龟嚎哮迷茫，

备餐时光，软泞蜥獾

草地中钻孔，日晷下打转

波若歌鹦苟延残喘，

迷途绿龟嚎哮迷茫”

——《炸脖龙之诗》

![](https://cdn.luogu.com.cn/upload/pic/21111.png)

我喊了出来...却不成人话

只能，像在水中一边融化一边下沉的方糖一样...

失去自己的轮廓...一直沉向最低处

想要爬上去的子午

维持自己是自己的连续体...

溶解的渐渐七零八落的意识...

失去了用来挣扎的双手

失去了用来挣扎的双臂

向下，

向下，

一直沉下去

向着意识的底层

沉陷下去的自我...

逐渐消失的世界...

我看到了世界

失落的...世界...

![](https://cdn.luogu.com.cn/upload/pic/21112.png)

```plain

   回归天空的话我就可以成为      了

  开什么玩笑，你才不是什么      ！

  吵死了！吵死了！我是      ！而且生来就是！

就是因为这个家伙我才失去      的资格的！

 呜呜呜，由岐姐姐，由岐姐姐！

  ...怎么会...由岐姐...

 卓司！你这家伙！

        吵死了吵死了！像你这样的普通人懂些什么！

   由岐的血慢慢在冰凉的水泥地上扩散开来

   抱在怀里的      在渐渐地流出来        本应成为      而出生

的我的被      妨碍了！

不出生的话我就没法拯救是这个世界！

            所以预言者说能当世界回归天空的此处就是尽头

   只要      回归天空的话！

 我有这么可怕吗？

              因为我是要对一切生物下达审判的存在！

       因为哥哥是凡人呢

    凡人与天才

                            救世主

   世界

                    救世主

                回天之门

  要死的是你！

            我不会死               不会死       诅咒你

       要死的是羽咲

         只要羽咲死了

                  间宫              皆

                                    守           由

                         岐

                                间宫羽咲

                          可能性

                                    和镜

                     终

                   终之空

                     空

```

![](https://cdn.luogu.com.cn/upload/pic/21113.png)

一个婴儿出生了

谁的？

不知道


虽然不知道...
但确实有一个婴儿出生了

嗯...那个婴儿在哭...

呜嘎，呜嘎，地哭着...

听到这个哭声大家都笑了

大家都在为婴儿祝福

母亲也是...

父亲也是...

并且其他人也是...

为那个婴儿的出生...

衷心祝福

世界充满着生命的祝福

但是

但不是这样的

在那里

我

我一个人在那里恐惧着

非常恐惧...

要说为什么的话...

因为那是在对世界进行诅咒

没错...

他在诅咒着那个世界，那个刚出生的婴儿

诅咒着自己的出生

我

我当场全身僵硬

在大家的笑容之中

在祝福之中

独自一人...

我啊...

我摇摇晃晃地...

接近那个婴儿

然后想要让那个婴儿停止哭泣

我想着必须要那样做才行

为什么呢？

我自己也不明白...

那是

那是，自从出生以来

就悲惨地活到今天的我能做到的

我能做到的

唯一的

唯一的赎罪啊。

![](https://cdn.luogu.com.cn/upload/pic/21114.png)

让我在这里了结了你吧…间宫卓司

这里是终之空的下面吧…这不刚好吗

跟我们的终结很相称不是吗…

这里，是只对你而言的，终结的天空…

这里就是终焉之地…

![](https://cdn.luogu.com.cn/upload/pic/21115.png)

“不行！绝对不行！”

…为什么…跟过来了…

![](https://cdn.luogu.com.cn/upload/pic/21116.png)

预定…调和吗…

原来如此…看来不管怎样对于你来说…我都已经毫无任何价值了对吧…

竟然被这家伙打倒了…真是没办法呐…

这也是现实吗…

那就接受吧…

![](https://cdn.luogu.com.cn/upload/pic/21117.png)

不知为何，我好像看到了在夜空中挺立的向日葵…

只有一瞬间…

那株向日葵…

好像在某个地方…

向日葵…

跟羽咲一起…

是啊…

我是哥哥啊…

要是…能再多当当她的哥哥就好了……

![](https://cdn.luogu.com.cn/upload/pic/21119.png)

咦……

刚才的…

那个是…那片风景…

是吗…那片风景…

我也是知道的啊…

在坡道途中的向日葵…

蔚蓝的天空和向日葵。

漂浮着大大的云朵…

羽咲戴着大大的帽子…

然后跟我走在一起…

走着走着…

为了…

两人一起…

爬上那个坡道…

因为…那个坡道的前面有很漂亮的景色…

## 题目描述

您正在打 galgame，然后您觉得这个 gal 不知所云，于是您弃坑了，开始写数据结构题：

给一个长为 $n$ 的序列，$m$ 次操作，每次操作：

1. 区间 $[l,r]$ 加 $x$；
2. 对于区间 $[l,r]$，查询：

$$a[l]^{a[l+1]^{a[l+2]^{\dots ^{a[r]}}}} \mod p$$

## 说明/提示

Idea：nzhtl1477，Solution：nzhtl1477，Code：nzhtl1477，Data：nzhtl1477

对于100%的数据，$n , m \le 500000$ , 序列中每个数在$[1,2\cdot 10^9]$内，$p \le 2 \cdot 10^7 $, 每次加上的数在$[0,2\cdot 10^9]$内

共10组数据


## 样例 #1

### 输入

```
6 4
1 2 3 4 5 6
2 1 2 10000007
2 2 3 5
1 1 4 1
2 2 4 10
```

### 输出

```
1
3
1```

## 样例 #2

### 输入

```
5 5
2 3 3 3 3
1 1 1 530739835
2 1 1 8356089
2 1 4 5496738
1 1 2 66050181
1 2 4 138625417
```

### 输出

```
4306230
697527
```

# AI分析结果


### Kay的C++算法解析：炸脖龙I 深入学习指南

#### 1. 题目解读与核心算法识别
✨ **本题主要考察**：`扩展欧拉定理` + `树状数组`  
🗣️ **初步分析**：
> 解决"炸脖龙I"关键在于运用**扩展欧拉定理**处理指数塔计算。该定理像"能量衰减器"——指数超过φ(p)时，幂运算会降阶为模φ(p)的运算。在本题中，用于递归分解指数塔`a[l]^(a[l+1]^...^a[r]) mod p`。
> - **核心流程**：递归计算指数部分，每次迭代模数变为φ(p)，最多进行O(log p)层。树状数组维护区间加/单点查询，确保实时获取序列值。
> - **可视化设计**：采用8位像素风格展示递归过程。用不同颜色方块表示：
>   - 红色：当前计算的底数
>   - 蓝色：递归中的指数部分
>   - 黄色：模数变化路径（p → φ(p) → φ(φ(p))→...）
>   - 绿色：1（终止条件）
> - **游戏化交互**：
>   - 控制面板：单步执行/自动播放（速度滑块）/重置
>   - 音效：递归时"叮"声，模数归1时"胜利"音效
>   - 过关机制：每完成一层递归点亮一颗像素星星

#### 2. 精选优质题解参考
**题解一（Leap_Frog）**  
* **点评**：  
  思路清晰直击核心——扩展欧拉定理+树状数组差分。代码中巧妙处理边界：当遇到1时提前终止递归（`if(a[i]==1) break;`），避免无效计算。亮点在于暴力计算前5层判断指数大小（O(1)复杂度），大幅优化递归深度。变量命名规范（`phi[]`/`lowbit()`），实践性强可直接用于竞赛。

**题解二（NaCly_Fish）**  
* **点评**：  
  创新性使用`struct{val, flag}`传递双重状态（值+是否≥模数），优雅解决扩展欧拉定理的条件判断。代码模块化优秀：`power()`函数独立处理快速幂和溢出标记。虽稍长（120行），但对理解定理本质有显著帮助，尤其适合学习如何用数据结构封装复杂逻辑。

**题解三（zcysky）**  
* **点评**：  
  极致简洁的实现（仅60行）。亮点在于预处理φ时用`bitset`优化空间，且快速幂中同步判断溢出（`if(res>p) flag=1`）。虽然未显式处理1的优化，但通过递归深度控制（`while(p>1)`）自然规避冗余计算，适合追求代码简约的学习者。

> ⚠️ 注意：所有题解均需配合树状数组差分实现O(log n)的单点查询

#### 3. 核心难点辨析与解题策略
1. **难点1：指数塔的递归边界控制**  
   * **分析**：当模数p=1时结果恒为0；当遇到a[i]=1时后续指数无意义。优质题解通过双重边界检查解决：
     ```cpp
     if(p == 1) return 0;
     if(a[i] == 1) return 1;
     ```
   * 💡 **学习笔记**：边界处理是指数塔计算的基础安全网

2. **难点2：扩展欧拉定理的条件判断**  
   * **分析**：必须严格判断指数是否≥φ(p)。解法分两类：
     - **暴力预判**：计算前min(5, r-l)层（Leap_Frog）
     - **状态传递**：快速幂中实时标记溢出（NaCly_Fish）
   * 💡 **学习笔记**：条件判断是定理应用的核心，直接影响正确性

3. **难点3：树状数组的实时同步**  
   * **分析**：递归中需实时获取修改后的a[i]。差分树状数组实现要点：
     ```cpp
     void add(int i, int v) { // 差分更新
         while(i <= n) tree[i] += v, i += lowbit(i);
     }
     int query(int i) { // 单点查询
         int sum = 0; while(i) sum += tree[i], i -= lowbit(i);
     }
     ```
   * 💡 **学习笔记**：差分树状数组是"时空穿梭机"，将区间加转化为两点操作

### ✨ 解题技巧总结
- **技巧1：欧拉函数预处理的必要性**  
  线性筛φ是效率基础，需熟记：
  ```cpp
  phi[k] = (i % prime[j]) ? phi[i]*(prime[j]-1) : phi[i]*prime[j];
  ```
- **技巧2：快速幂的双重使命**  
  同时计算`a^b mod p`和判断`b≥φ(p)`，通过flag传递状态
- **技巧3：1的短路效应**  
  任何数被1指数运算结果不变，遇到1立即终止递归

#### 4. C++核心代码实现赏析
**本题通用核心C++实现参考**  
* **说明**：综合优质题解，树状数组差分+扩展欧拉定理递归
* **完整核心代码**：
```cpp
#include<bits/stdc++.h>
typedef long long ll;
const int N=500005, M=20000005;
ll c[N], phi[M];
int n, m, pr[M>>3], cnt;
bool vis[M];

void init_phi() { // 线性筛φ
    phi[1] = 1;
    for(int i=2; i<M; i++) {
        if(!vis[i]) pr[++cnt]=i, phi[i]=i-1;
        for(int j=1; j<=cnt && i*pr[j]<M; j++) {
            vis[i*pr[j]] = 1;
            if(i%pr[j]) phi[i*pr[j]] = phi[i]*(pr[j]-1);
            else { phi[i*pr[j]] = phi[i]*pr[j]; break; }
        }
    }
}

void upd(int x, ll v) { // 树状数组更新
    for(; x<=n; x+=x&-x) c[x] += v;
}
ll qry(int x) { // 单点查询
    ll res=0; for(; x; x-=x&-x) res += c[x]; return res;
}

ll qpow(ll a, ll b, ll p, bool &flag) { // 快速幂带溢出标记
    ll res=1; flag = (a >= p);
    if(a >= p) a %= p;
    while(b) {
        if(b & 1) {
            res = res * a;
            if(res >= p) flag=1, res %= p;
        }
        a = a * a;
        if(a >= p) flag=1, a %= p;
        b >>= 1;
    }
    return res;
}

ll solve(int l, int r, ll p) {
    if(p == 1) return 0; // 边界1：模数归1
    ll a = qry(l);
    if(l == r) return a < p ? a : a % p + p; // 边界2：单点
    if(a == 1) return 1; // 边界3：底数为1
    int t = min(r, l+5); // 关键优化：仅检查5层
    for(int i=l+1; i<=t; i++) 
        if(qry(i) == 1) { t = i; break; }
    ll exp = qry(t);
    for(int i = t-1; i > l; i--) { // 暴力计算指数
        ll tmp = exp; exp = 1;
        while(tmp--) {
            exp *= qry(i);
            if(exp > phi[p]) // 触发扩展条件
                return qpow(a, solve(l+1,r,phi[p]) + phi[p], p);
        }
    }
    bool flag;
    return qpow(a, exp, p, flag); // 直接计算
}
```

#### 5. 算法可视化：像素动画演示
![](https://cdn.luogu.com.cn/upload/pic/21111.png)  
* **主题**：像素探险家解谜指数塔  
* **核心演示**：  
  1. **初始化**：8-bit网格显示序列值，树状数组结构侧边栏  
  2. **递归过程**：  
     - 红框高亮当前底数`a[l]`，蓝框标记指数部分  
     - 黄线连接模数链：`p→φ(p)→φ(φ(p))→...`  
     - 遇1时绿光闪烁+清脆音效  
  3. **快速幂计算**：  
     - 指数二进制分解时显示位运算过程  
     - 溢出时像素方块变红+警告音  
  4. **交互控制**：  
     - 速度滑块调节递归速度  
     - 自动模式下AI模拟解题路径（类贪吃蛇AI）  

#### 6. 拓展练习与相似问题思考
* **技巧迁移**：  
  扩展欧拉定理适用于所有幂次超限问题：
  1. 无限指数塔（P4139 上帝与集合）
  2. 固定底数超大指数（P5091 扩展欧拉定理）
  3. 带修改的幂运算（CF906D Power Tower）
* **洛谷推荐**：
  1. **P4139** - 扩展欧拉定理基础应用  
     *推荐理由：理解定理本质的最佳入门*
  2. **P3747** - 结合线段树维护指数塔  
     *推荐理由：在动态序列上深化技巧*
  3. **P2147** - 树状数组高阶应用  
     *推荐理由：巩固差分树状数组编码能力*

#### 7. 学习心得与经验分享
> **参考经验**（Leap_Frog调试心得）：  
> “最初在快速幂中未处理`a>=p`导致WA，添加`if(a>=p)a%=p,flag=1`后AC。这提醒我们：扩展欧拉定理中底数取模不影响条件判断，但必须显式标记溢出”  
> **Kay总结**：  
> 边界处理是递归算法的生命线！建议编码时：  
> 1. 对`p=1`/`a[i]=1`/`l=r`三个边界写独立检查  
> 2. 快速幂中所有乘法后立即检查溢出  
> 3. 用`min(r,l+5)`避免无效递归  

---

通过本指南，我们深入剖析了炸脖龙I的解题精髓——**扩展欧拉定理的递归应用**与**树状数组差分的高效实现**。记住：理解φ函数的衰减特性是突破此类问题的钥匙！下次遇到Ynoi难题时，愿你如Nephren般智慧从容 💪

![](https://cdn.luogu.com.cn/upload/pic/21119.png)  
> “当思绪纷乱杂绪之际，炸脖龙双目如烔炬...但勇敢的编程少年终将斩其于马下！” ——《炸脖龙之诗》改编

---
处理用时：132.28秒
# 题目信息

# [THUPC 2023 初赛] 背包

## 题目描述

本题中，你需要解决完全背包问题。

有 $n$ 种物品，第 $i$ 种物品单个体积为 $v_i$、价值为 $c_i$。

$q$ 次询问，每次给出背包的容积 $V$，你需要选择若干个物品，每种物品可以选择任意多个（也可以不选），在选出物品的体积的和**恰好**为 $V$ 的前提下最大化选出物品的价值的和。你需要给出这个最大的价值和，或报告不存在体积和恰好为 $V$ 的方案。

为了体现你解决 NP-Hard 问题的能力，$V$ 会远大于 $v_i$，详见数据范围部分。

## 说明/提示

#### 样例解释 1

第二组询问的最优方案为：选择 $3$ 个物品 $1$ 和 $12499999998$ 个物品 $2$。

#### 子任务

对于所有测试数据，$1 \le n \le 50, 1 \le v_i \le 10^5, 1 \le c_i \le 10^6, 1 \le q \le 10^5, 10^{11} \le V \le 10^{12}$。

#### 题目来源

来自 2023 清华大学学生程序设计竞赛暨高校邀请赛（THUPC2023）初赛。

题解等资源可在 <https://github.com/THUSAAC/THUPC2023-Pre> 查看。

## 样例 #1

### 输入

```
2 2
6 10
8 15
100000000001
100000000002
```

### 输出

```
-1
187500000000
```

# AI分析结果


### 💡 Kay的C++算法解析：THUPC 2023初赛《背包》深入学习指南 💡

> “编程如探险，背包问题就是你的像素迷宫——我是Kay，今天带你用同余最短路征服巨型背包！”

#### 1. 题目解读与核心算法识别
✨ **本题主要考察**：`同余最短路（转圈法）` + `贪心优化`

🗣️ **初步分析**：
> 解决这道背包问题，就像在复古游戏中用有限道具打开巨型宝箱！核心是 **同余最短路转圈法** —— 想象一个像素圆环（模数环），环上每个格子代表背包剩余空间（模m余数）。我们先用性价比最高的物品（单位体积价值最大）铺满大部分空间，再用其他物品在环上“跳跃”调整余数部分。  
> - **关键技巧**：选体积为 \(m\) 的基准物品 → 在模 \(m\) 环上用其他物品转圈更新状态 → 查询时组合基准价值和余数价值。  
> - **可视化设计**：像素环上高亮当前状态点，添加物品时播放“跳跃音效”，价值更新时触发闪光特效。转圈过程设计为“AI自动寻路”动画，速度可调（类似吃豆人循环移动）。  
> - **难点突破**：基准物品选取保障无正环（替换思想），转两圈覆盖所有转移（环上无死角）。

---

#### 2. 精选优质题解参考
> 从思路清晰性、代码规范性和算法效率三维度精选3份题解：

**题解一（Alex_Wei, 5⭐）**  
* **点评**：  
  → **思路**：直击本质！用“转圈法”替代传统最短路，将模环分解为 \(\gcd(v_i, m)\) 个子环，每环转两圈即覆盖所有转移，复杂度稳为 \(O(nm)\)。  
  → **代码**：预计算 \(v_i \% m\) 和 \(v_i / m\) 优化取模，变量名 `_v`, `_d` 清晰体现数学思想。  
  → **亮点**：对比SPFA和转圈法，揭示“时代眼泪”的深刻洞见（见学习心得）。  

**题解二（Leasier, 4⭐）**  
* **点评**：  
  → **思路**：显式用环长 \(2 \times (m / \gcd)\) 控制转圈次数，与Alex异曲同工但更易理解。  
  → **代码**：边界处理严谨（`if(f[k]!=-1e18)`），避免无效更新。  
  → **实践价值**：完整包含无解判定（\(V \% m \neq 0\) 时输出-1），竞赛可直接套用。  

**题解三（carp_oier, 4⭐）**  
* **点评**：  
  → **思路**：精简版转圈法，用 `asd` 计数器实现两圈跳出，逻辑简洁。  
  → **代码**：宏优化 `rl` 提升可读性，初始化 `f[0]=0` 突出基准状态。  
  → **亮点**：博客中“不重构看不见”的调试经历警示初始化重要性（见Section 7）。  

---

#### 3. 核心难点辨析与解题策略
> 掌握这三个关键点，你就能拆解所有巨型背包问题！

1. **基准物品选取（贪心思想）**  
   * **分析**：选性价比最高物品（\(c_i/v_i\) 最大）作为模数 \(m\)。若选错，会导致调整值无界！数学证明：替换任意方案中的 \(m\) 个物品为基准品不会更差。  
   * 💡 **学习笔记**：基准物品是背包世界的“万能钥匙”，优先占领大部分空间！

2. **状态转移设计（价值补偿机制）**  
   * **分析**：状态 \(f_i\) 表示余数 \(i\) 的最大 **补偿价值**（相比全用基准品）。转移时：  
     \[
     f_{(i+v_j) \% m} = \max(\ \cdot\ ,\ f_i + c_j - \left\lfloor \frac{i+v_j}{m} \right\rfloor \cdot w\ )
     \]  
     补偿项 \(\lfloor \cdot \rfloor \cdot w\) 是因占用空间导致的基准品损失。  
   * 💡 **学习笔记**：减法补偿是避免价值虚高的关键操作！

3. **转圈法正确性（环上动态规划）**  
   * **分析**：每个物品在 \(\gcd(v_j, m)\) 个子环上独立更新。转两圈保证：① 环的首尾状态衔接 ② 最优解不被遗漏（最短路性质）。  
   * 💡 **学习笔记**：转圈如马里奥循环关卡，两圈必找全金币！

##### ✨ 解题技巧总结
- **技巧1**：问题分解 → 基准填充（大范围） + 余数调整（小范围）。  
- **技巧2**：同余性质 → 将 \(10^{12}\) 背包压缩为 \(10^5\) 规模。  
- **技巧3**：调试要点 → 初始化 \(f_0=0\)，\(f_i=-\infty\)，避免余数不可达误算。  

---

#### 4. C++核心代码实现赏析
<details>
<summary>🔍 通用核心代码（综合Alex_Wei与carp_oier优化版）</summary>

```cpp
#include <bits/stdc++.h>
using namespace std;
typedef long long ll;
const int N = 1e5 + 10;

ll n, q, m = 1, w; // m:基准物品体积, w:基准物品价值
ll v[55], c[55], f[N]; // f[i]: 余数i对应的最大补偿价值

int main() {
    cin >> n >> q;
    // 1. 选取性价比最高的物品作为基准
    for (int i = 1; i <= n; i++) {
        cin >> v[i] >> c[i];
        if (w * v[i] < m * c[i]) w = c[i], m = v[i]; // 避免浮点：交叉相乘比较
    }
    
    // 2. 初始化余数状态（除0外均不可达）
    for (int i = 1; i < m; i++) f[i] = -1e18;
    
    // 3. 转圈法核心：对每个物品在子环上转两圈
    for (int i = 1; i <= n; i++) {
        int d = __gcd(v[i], (ll)m); // 子环数量 = gcd(v[i], m)
        for (int j = 0; j < d; j++) {
            for (int t = j, cnt = 0; cnt < 2; cnt += (t == j)) {
                ll nxt = (t + v[i]) % m;    // 转移目标余数
                ll cost = c[i] - (t + v[i]) / m * w; // 补偿价值 = 当前物品价值 - 占用基准物品的价值
                f[nxt] = max(f[nxt], f[t] + cost);
                t = nxt; // 移动到环上下一位置
            }
        }
    }
    
    // 4. 查询：组合基准价值与余数补偿价值
    while (q--) {
        ll V; cin >> V;
        ll r = V % m;
        if (f[r] < -1e17) cout << "-1\n";  // 余数不可达
        else cout << f[r] + (V / m) * w << "\n";
    }
    return 0;
}
```
**代码解读概要**：  
① 基准选取 → ② 状态初始化 → ③ 物品转圈更新（关键：子环两圈） → ④ 查询组合。  
**变量作用**：  
- `d`：子环数量（= \(\gcd\)），确保环独立更新。  
- `cost`：动态计算补偿值，避免预存浮点误差。  
</details>

##### 分题解核心代码亮点
**题解一（Alex_Wei）**  
```cpp
// 亮点：预计算取模和除法提升效率
_v[i] = v[i] % m; // 替代 v[i] % m
_d[i] = v[i] / m; // 替代 (t+v[i])/m
f[q] = max(f[q], f[t] + c[i] - _d[i] * w);
```
> **学习笔记**：预计算是竞赛常用优化，尤其在高频取模/除法时！

**题解二（Leasier）**  
```cpp
// 亮点：显式控制转圈次数（2*环长）
int len = v[base] / d * 2; // 环长= m/d, 转两圈
for (int k = j, l = 1; l <= len; l++) {
    f[nxt] = max(f[nxt], f[k] + c[i] - (ll)newv / m * w);
}
```
> **学习笔记**：数学等价于“两圈跳出”，但显式循环更易调试边界。

**题解三（carp_oier）**  
```cpp
// 亮点：精简循环条件
for (rl t = j, asd = 0; asd < 2; asd += t == j) {
    f[p] = max(f[p], f[t] + c[i] - ((t + v[i]) / m) * w);
    t = p; // 更新当前环位置
}
```
> **学习笔记**：用 `asd` 计数回归起点次数，代码更短但需理解循环本质。

---

#### 5. 算法可视化：像素动画演示
> **动画主题**：*《背包探险家：模数环寻宝》*（8-bit像素风）  

##### 🎮 交互设计
- **控制面板**：  
  ▶️ 开始/暂停  🔂 单步执行  🎚️ 速度滑块（调速转圈过程）  
  🔁 重置动画  🤖 AI自动演示（贪吃蛇式自动转圈）  
- **音效设计**：  
  ▫️ 转移时：复古芯片“嘀”声（每次状态更新）  
  ▫️ 价值提升：金币收集声（补偿价值增加时）  
  ▫️ 完成：FC胜利音乐（成功找到余数解）  

##### 🖼️ 动画帧脚本
1. **场景初始化**：  
   → 屏幕中央显示像素圆环（\(0 \sim m-1\)个格子），0号位绿色（基准状态），其余灰色。  
   → 右侧信息板：显示 \(f_i\) 值和当前基准物品（高亮显示）。  

2. **物品转圈演示**（以物品 \(v_j=3, c_j=5\) 为例）：  
   ```markdown
   Frame 1: [环] 0(绿) → 3(黄)  
            旁白：“从0出发，加物品j到达3号位！计算补偿：5 - ⌊(0+3)/m⌋×w”  
   Frame 2: [环] 3(黄) → 6(橙) → ... （继续转圈）  
   Frame 3: 回归起点0，旁白：“第二圈开始，检查是否优化！”  
   ```

3. **查询演示**：  
   → 输入 \(V = 10^{11} + 7\)：环上高亮7号位，显示最终价值 \(f_7 + \lfloor V/m \rfloor \cdot w\)。  

> **设计思路**：像素环+音效强化“循环更新”直觉，AI演示模式降低理解门槛。

---

#### 6. 拓展练习与相似问题思考
> **通用套路迁移**：同余最短路转圈法适用于：  
> ① 体积/代价极大 ② 状态可模数压缩 ③ 完全背包/无限选择问题。  

**推荐练习（洛谷）**：  
1. [P2371 墨墨的等式](https://www.luogu.com.cn/problem/P2371)  
   → **理由**：同余最短路鼻祖题，学会转圈法后直接秒杀！  
2. [P3403 跳楼机](https://www.luogu.com.cn/problem/P3403)  
   → **理由**：01-BFS优化同余最短路，对比转圈法理解适用场景。  
3. [P2662 牛场围栏](https://www.luogu.com.cn/problem/P2662)  
   → **理由**：求可行解数量，拓展转圈法的价值计算维度。  

---

#### 7. 学习心得与经验分享
> 来自Alex_Wei的调试经验：  
> **“同余最短路还在写最短路？时代的眼泪！”**  
> → **Kay点评**：此言直击传统SPFA解法痛点！转圈法不仅代码量减半（约30行），且复杂度稳为 \(O(nm)\)。这提醒我们：  
> - 算法选择需与时俱进，经典方法可能有更优变种  
> - 理解问题本质（环上DP）比套用模板更重要  

---

> 下次当你面对背包难题时，记住Kay的这句话：  
> **“基准物品开大道，转圈技巧破迷宫！”** —— 我们下期再见！ 🎮🚀

---
处理用时：230.73秒
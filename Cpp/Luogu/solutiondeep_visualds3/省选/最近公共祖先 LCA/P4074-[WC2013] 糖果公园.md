# 题目信息

# [WC2013] 糖果公园

## 题目描述

Candyland 有一座糖果公园，公园里不仅有美丽的风景、好玩的游乐项目，还有许多免费糖果的发放点，这引来了许多贪吃的小朋友来糖果公园游玩。

糖果公园的结构十分奇特，它由 $n$ 个游览点构成，每个游览点都有一个糖果发放处，我们可以依次将游览点编号为 $1$ 至 $n$。有 $n - 1$ 条双向道路连接着这些游览点，并且整个糖果公园都是连通的，即从任何一个游览点出发都可以通过这些道路到达公园里的所有其它游览点。

糖果公园所发放的糖果种类非常丰富，总共有 $m$ 种，它们的编号依次为 $1$ 至 $m$。每一个糖果发放处都只发放某种特定的糖果，我们用 $C_i$ 来表示 $i$ 号游览点的糖果。

来到公园里游玩的游客都不喜欢走回头路，他们总是从某个特定的游览点出发前往另一个特定的游览点，并游览途中的景点，这条路线一定是唯一的。他们经过每个游览点，都可以品尝到一颗对应种类的糖果。

大家对不同类型糖果的喜爱程度都不尽相同。 根据游客们的反馈打分，我们得到了糖果的美味指数， 第 $i$ 种糖果的美味指数为 $V_i$。另外，如果一位游客反复地品尝同一种类的糖果，他肯定会觉得有一些腻。根据量化统计，我们得到了游客第 $i$ 次品尝某类糖果的新奇指数 $W_i$。如果一位游客第 $i$ 次品尝第 $j$ 种糖果，那么他的愉悦指数 $H$ 将会增加对应的美味指数与新奇指数的乘积，即 $V_j \times W_i$。这位游客游览公园的愉悦指数最终将是这些乘积的和。

当然，公园中每个糖果发放点所发放的糖果种类不一定是一成不变的。有时，一些糖果点所发放的糖果种类可能会更改（也只会是 $m$ 种中的一种），这样的目的是能够让游客们总是感受到惊喜。

糖果公园的工作人员小 A 接到了一个任务，那就是根据公园最近的数据统计出每位游客游玩公园的愉悦指数。但数学不好的小 A 一看到密密麻麻的数字就觉得头晕，作为小 A 最好的朋友，你决定帮他一把。


## 说明/提示

【样例解释】

我们分别用

![](https://cdn.luogu.com.cn/upload/image_hosting/isw3ib3u.png)

代表 $C_i$ 为 $1$、 $2$、 $3$ 的节点，在修改之前：

![](https://cdn.luogu.com.cn/upload/image_hosting/ttkzii1u.png)

在将 $C_2$ 修改为 $1$ 之后：

![](https://cdn.luogu.com.cn/upload/image_hosting/izro364w.png)

【数据规模与约定】

对于所有的数据： $1 \leq V_i, W_i \leq 10^6$，$1 \leq A_i, B_i \leq n$， $1 \leq C_i \leq m$， $W_1, W_2, \ldots, W_n$ 是非递增序列，即对任意 $1 < i \leq n$， 满足 $W_i \le W_{i-1}$。

其它的限制条件如下表所示：

![QQ20180113072014.png](https://cdn.luogu.com.cn/upload/image_hosting/g6884nx1.png)


## 样例 #1

### 输入

```
4 3 5
1 9 2
7 6 5 1
2 3
3 1
3 4
1 2 3 2
1 1 2
1 4 2
0 2 1
1 1 2
1 4 2```

### 输出

```
84
131
27
84```

# AI分析结果


### 题目分析与算法选择
题目要求处理树上路径查询和单点修改，需要高效计算路径上糖果的愉悦指数（与出现次数相关）。由于涉及路径查询和离线操作，**树上带修莫队**是最佳选择：
- 利用欧拉序将树转为序列（长度2n）
- 带修莫队处理动态修改（时间维度）
- 块大小取(2n)^(2/3)，复杂度O(n^(5/3))

### 核心思路
1. **欧拉序转换**：
   - DFS遍历树，记录节点进入(first)和离开(last)的时间戳
   - 路径[u,v]在序列上表示为：
     - 若u是v祖先：区间[first[u], first[v]]
     - 否则：区间[last[u], first[v]] + 单独处理LCA

2. **莫队框架**：
   ```python
   排序规则：
     if l/block ≠ other.l/block → 按l块排序
     elif r/block ≠ other.r/block → 按r块排序
     else → 按时间排序
   ```

3. **状态维护**：
   - `book[c]`：糖果c的出现次数
   - `flag[node]`：节点是否在当前路径
   - 更新操作：节点状态翻转时更新`book`和总愉悦值

4. **修改处理**：
   - 时间指针移动时执行/回退修改
   - 关键：若修改的节点在路径上，需实时更新贡献

### 难点对比
| 难点                | 解决方案                     | 优化点             |
|---------------------|------------------------------|--------------------|
| 路径转序列          | 欧拉序+分类处理LCA           | 树剖求LCA降低常数  |
| 时间维度            | 记录修改队列+双向移动时间指针 | 修改时判断节点状态 |
| 奇数次计数          | 状态翻转时更新贡献            | 位运算快速切换状态 |
| 块大小选择          | (2n)^(2/3)                   | 平衡复杂度常数     |

### 算法可视化设计
**像素风格演示方案**（复古游戏主题）：
```markdown
## 5. 算法可视化：像素动画演示

* **主题**：糖果探险家在树形迷宫中收集糖果
* **核心演示**：
  1. 树形迷宫生成：8-bit风格节点（不同颜色=糖果类型）
  2. DFS遍历过程：显示欧拉序编号（进入/离开）
  3. 莫队指针移动：L/R指针在序列上滑动，高亮当前路径
  4. 修改事件：被修改节点闪烁+音效
  5. 贡献计算：实时显示路径糖果计数和愉悦值

* **交互控制**：
  - 步进控制：←→键单步移动指针
  - 调速滑块：调整自动播放速度
  - 修改演示：点击节点触发修改动画

* **关键帧示例**：
  [图示]
  ├── 初始状态：树形迷宫（节点1-8）
  ├── DFS过程：节点1(绿)→节点2(蓝)→...→回节点1(红)
  ├── 路径查询：u=2→v=5（高亮路径2-1-3-5）
  └── 修改事件：节点3糖果从红→黄（闪烁+音效）
```

### 代码实现亮点
```cpp
// 欧拉序生成（树剖优化）
void dfs(int u) {
    first[u] = ++dfn;
    for (auto v : tree[u]) if (v != fa[u]) {
        dep[v] = dep[u] + 1;
        dfs(v);
    }
    last[u] = ++dfn; // 离开时间戳
}

// 路径区间计算
if (lca == u) {
    q[i] = {first[u], first[v], 0};
} else {
    q[i] = {last[u], first[v], lca}; // 需单独处理LCA
}

// 状态更新（精妙位运算）
void update(int node) {
    if (flag[node] ^= 1) { // 状态翻转
        total += (ll)v[c[node]] * w[++book[c[node]]];
    } else {
        total -= (ll)v[c[node]] * w[book[c[node]]--];
    }
}

// 修改回退（时空指针移动）
while (time < q[i].time) {
    if (in_path[mod[time].pos]) { // 关键判断！
        update(mod[time].pos);     // 移除旧值
        swap(c[node], mod[time].new);
        update(mod[time].pos);     // 加入新值
    }
    time++;
}
```

### 学习心得
1. **欧拉序的妙用**：通过进入/离开时间戳将树转为序列，使任意路径对应区间操作
2. **带修莫队本质**：时间维度相当于"第三指针"，修改需判断节点状态
3. **常数优化**：树剖LCA > 倍增LCA；位运算切换状态

### 拓展练习
1. **相似问题**：
   - [COCI2020] Paint（带修序列莫队）
   - [SDOI2018] 原题识别（树上带修进阶）

2. **推荐题目**：
   | 题号   | 题目名                 | 考察点               | 难度 |
   |--------|------------------------|----------------------|------|
   | P4074 | 糖果公园               | 树上带修莫队         | 黑   |
   | P1903 | [国家集训队]数颜色     | 带修序列莫队         | 紫   |
   | SP10707 | COT2 - Count on a tree | 树上莫队（无修改）   | 紫   |

> "通过本题，我深刻理解了如何将树结构转化为序列操作，以及时间维度对莫队的影响。关键在于LCA处理和修改时的状态判断。" —— Kay的算法笔记

---
处理用时：166.87秒
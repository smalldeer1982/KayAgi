# é¢˜ç›®ä¿¡æ¯

# [LNOI2014] LCA

## é¢˜ç›®æè¿°

ç»™å‡ºä¸€ä¸ª $n$ ä¸ªèŠ‚ç‚¹çš„æœ‰æ ¹æ ‘ï¼ˆç¼–å·ä¸º $0$ åˆ° $n-1$ï¼Œæ ¹èŠ‚ç‚¹ä¸º $0$ï¼‰ã€‚

ä¸€ä¸ªç‚¹çš„æ·±åº¦å®šä¹‰ä¸ºè¿™ä¸ªèŠ‚ç‚¹åˆ°æ ¹çš„è·ç¦» $+1$ã€‚ 

è®¾ $dep[i]$ è¡¨ç¤ºç‚¹ $i$ çš„æ·±åº¦ï¼Œ$\operatorname{LCA}(i, j)$ è¡¨ç¤º $i$ ä¸ $j$ çš„æœ€è¿‘å…¬å…±ç¥–å…ˆã€‚ 

æœ‰ $m$ æ¬¡è¯¢é—®ï¼Œæ¯æ¬¡è¯¢é—®ç»™å‡º $l, r, z$ï¼Œæ±‚ $\sum_{i=l}^r dep[\operatorname{LCA}(i,z)]$ ã€‚

## è¯´æ˜/æç¤º

### æ•°æ®èŒƒå›´åŠçº¦å®š

- å¯¹äº $20\%$ çš„æ•°æ®ï¼Œ$n\le 10000,m\le 10000$ï¼›
- å¯¹äº $40\%$ çš„æ•°æ®ï¼Œ$n\le 20000,m\le 20000$ï¼›
- å¯¹äº $60\%$ çš„æ•°æ®ï¼Œ$n\le 30000,m\le 30000$ï¼›
- å¯¹äº $80\%$ çš„æ•°æ®ï¼Œ$n\le 40000,m\le 40000$ï¼›
- å¯¹äº $100\%$ çš„æ•°æ®ï¼Œ$1\le n\le 50000,1\le m\le 50000$ã€‚

## æ ·ä¾‹ #1

### è¾“å…¥

```
5 2
0
0
1
1
1 4 3
1 4 2```

### è¾“å‡º

```
8
5```

# AIåˆ†æç»“æœ


### ğŸ’¡ Kayçš„C++ç®—æ³•è§£æï¼šLCA æ·±å…¥å­¦ä¹ æŒ‡å— ğŸ’¡

#### é¢˜ç›®è§£è¯»ä¸æ ¸å¿ƒç®—æ³•è¯†åˆ«
âœ¨ **æœ¬é¢˜ä¸»è¦è€ƒå¯Ÿ**ï¼š`æ ‘é“¾å‰–åˆ† + ç¦»çº¿å¤„ç†` (ç¼–ç¨‹æŠ€å·§åº”ç”¨)

ğŸ—£ï¸ **åˆæ­¥åˆ†æ**ï¼š
> è§£å†³"LCAæ·±åº¦å’ŒæŸ¥è¯¢"çš„å…³é”®åœ¨äº**é—®é¢˜è½¬åŒ–+æ ‘é“¾å‰–åˆ†**ã€‚æƒ³è±¡æ¯ä¸ªèŠ‚ç‚¹æ˜¯æ¢é™©åœ°å›¾ä¸Šçš„ç«™ç‚¹ï¼Œæ·±åº¦å°±æ˜¯ç«™ç‚¹ç¼–å·ã€‚æ±‚LCAæ·±åº¦å’Œç›¸å½“äºï¼šç»™`l`åˆ°`r`çš„æ¯æ¡æ¢é™©è·¯å¾„ï¼ˆä»ç«™ç‚¹åˆ°èµ·ç‚¹ï¼‰åšæ ‡è®°ï¼Œç„¶åç»Ÿè®¡`z`çš„æ¢é™©è·¯å¾„ä¸Šè¢«æ ‡è®°çš„ç«™ç‚¹æ€»æ•°ã€‚
> 
> **æ ¸å¿ƒæ­¥éª¤**ï¼š
> 1. **é—®é¢˜è½¬åŒ–**ï¼š`dep[LCA(i,z)] = iåˆ°æ ¹è·¯å¾„ä¸zåˆ°æ ¹è·¯å¾„çš„äº¤é›†é•¿åº¦`
> 2. **ç¦»çº¿å¤„ç†**ï¼šå°†æŸ¥è¯¢`[l,r]`æ‹†æˆ`[1,r]-[1,l-1]`
> 3. **è·¯å¾„æ ‡è®°**ï¼šæŒ‰é¡ºåºæ¿€æ´»èŠ‚ç‚¹ï¼ˆ1â†’nï¼‰ï¼Œæ¿€æ´»æ—¶å°†è¯¥èŠ‚ç‚¹åˆ°æ ¹çš„è·¯å¾„æƒå€¼+1
> 4. **å®æ—¶æŸ¥è¯¢**ï¼šå½“æ¿€æ´»åˆ°æŸ¥è¯¢å³ç«¯ç‚¹æ—¶ï¼Œè®¡ç®—zåˆ°æ ¹çš„è·¯å¾„å’Œ
>
> **å¯è§†åŒ–è®¾è®¡**ï¼š
> - **åƒç´ åœ°å›¾**ï¼š8-bité£æ ¼æ ‘å½¢åœ°å›¾ï¼ŒèŠ‚ç‚¹æ˜¾ç¤ºä¸ºåƒç´ æ–¹å—
> - **åŠ¨æ€æ ‡è®°**ï¼šæ¿€æ´»èŠ‚ç‚¹æ—¶ï¼Œå…¶åˆ°æ ¹è·¯å¾„å˜ä¸ºé‡‘è‰²ï¼ˆä¼´éš"å®"éŸ³æ•ˆï¼‰
> - **å®æ—¶ç»Ÿè®¡**ï¼šzè·¯å¾„é«˜äº®è“è‰²ï¼Œè·¯å¾„å’Œæ˜¾ç¤ºä¸ºå³ä¸Šè§’ç§¯åˆ†
> - **æ§åˆ¶é¢æ¿**ï¼šæ­¥è¿›æ§åˆ¶/è‡ªåŠ¨æ’­æ”¾ï¼ˆè°ƒé€Ÿæ»‘å—ï¼‰ï¼Œé‡ç½®æŒ‰é’®

---

#### ç²¾é€‰ä¼˜è´¨é¢˜è§£å‚è€ƒ
**é¢˜è§£ä¸€ï¼ˆç´«é’¦ - èµ196ï¼‰**
* **ç‚¹è¯„**ï¼šæ€è·¯æ¸…æ™°ï¼Œç”¨"è·¯å¾„æŸ“è‰²"æ¯”å–»è§£é‡ŠLCAæ·±åº¦è½¬åŒ–ï¼Œé€»è¾‘æ¨å¯¼è‡ªç„¶ã€‚ä»£ç é‡‡ç”¨æ ‡å‡†æ ‘å‰–+çº¿æ®µæ ‘ç»“æ„ï¼Œå˜é‡å‘½åè§„èŒƒï¼ˆ`dfn`, `top`ç­‰ï¼‰ï¼Œè¾¹ç•Œå¤„ç†ä¸¥è°¨ã€‚äº®ç‚¹æ˜¯è¯¦ç»†è§£é‡Šäº†**å·®åˆ†æŠ€å·§**å’Œ**è·¯å¾„æ ‡è®°åŸç†**ï¼Œå¤æ‚åº¦O(n logÂ²n)å®Œå…¨æ»¡è¶³è¦æ±‚ã€‚æ ¸å¿ƒä»£ç ä¸­`modify_chain`å’Œ`query_chain`å°è£…å¤ç”¨æ€§å¼ºã€‚

**é¢˜è§£äºŒï¼ˆxä¹‰x - èµ34ï¼‰**
* **ç‚¹è¯„**ï¼šä»£ç ç®€æ´é«˜æ•ˆï¼Œé‡‡ç”¨éé€’å½’æ ‘å‰–æŸ¥è¯¢ï¼ˆé¿å…é€’å½’æ ˆæº¢å‡ºï¼‰ã€‚äº®ç‚¹æ˜¯**æ ‡è®°æ°¸ä¹…åŒ–**çº¿æ®µæ ‘å®ç°ï¼Œå‡å°‘pushdownæ“ä½œã€‚å˜é‡`sum[]`ç›´æ¥å­˜å‚¨è·¯å¾„å’Œï¼Œ`lazy[]`è®°å½•æœªä¸‹ä¼ æ ‡è®°ï¼Œå®è·µæ€§å¼ºã€‚æ³¨é‡Šæ˜ç¡®æ¯ä¸ªå‡½æ•°ä½œç”¨ï¼Œé€‚åˆç«èµ›ç›´æ¥ä½¿ç”¨ã€‚

---

#### æ ¸å¿ƒéš¾ç‚¹è¾¨æä¸è§£é¢˜ç­–ç•¥
1. **éš¾ç‚¹1ï¼šLCAæ·±åº¦è½¬åŒ–ä¸ºè·¯å¾„æ“ä½œ**
   * **åˆ†æ**ï¼š`dep[LCA(i,z)]`æœ¬è´¨æ˜¯iä¸zçš„å…¬å…±è·¯å¾„é•¿åº¦ã€‚é€šè¿‡æ ‡è®°iåˆ°æ ¹è·¯å¾„ï¼Œç»Ÿè®¡zè·¯å¾„ä¸Šæ ‡è®°æ•°é‡å³ä¸ºæ·±åº¦å’Œ
   * ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šæ ‘é—®é¢˜ä¸­ï¼ŒLCAæ·±åº¦å¯è½¬åŒ–ä¸ºè·¯å¾„äº¤é›†é—®é¢˜

2. **éš¾ç‚¹2ï¼šåŒºé—´æŸ¥è¯¢å¤„ç†**
   * **åˆ†æ**ï¼šç›´æ¥å¤„ç†`[l,r]`éœ€æ¸…ç©ºçº¿æ®µæ ‘å¯¼è‡´ä½æ•ˆã€‚é€šè¿‡å·®åˆ†æ‹†è§£ä¸ºå‰ç¼€æŸ¥è¯¢ï¼ˆ`ans = query(r) - query(l-1)`ï¼‰ï¼Œé¿å…é‡å¤è®¡ç®—
   * ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šç¦»çº¿+å·®åˆ†æ˜¯å¤„ç†æ ‘ä¸ŠåŒºé—´æŸ¥è¯¢çš„é€šç”¨æŠ€å·§

3. **éš¾ç‚¹3ï¼šæ ‘å‰–å®ç°ç»†èŠ‚**
   * **åˆ†æ**ï¼šä¸¤æ¬¡DFSï¼ˆæ±‚é‡å„¿å­/é‡é“¾ï¼‰éœ€ç¡®ä¿`son[]`åˆå§‹åŒ–ï¼Œçº¿æ®µæ ‘æ“ä½œåŸºäº`dfn`åºè€ŒéåŸç¼–å·
   * ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šæ ‘å‰–å°†æ ‘è½¬ä¸ºçº¿æ€§ç»“æ„ï¼Œä½¿è·¯å¾„æ“ä½œå˜ä¸ºåŒºé—´æ“ä½œ

### âœ¨ è§£é¢˜æŠ€å·§æ€»ç»“
- **æŠ€å·§1ï¼šé—®é¢˜è½¬åŒ–** - å°†LCAæ·±åº¦è½¬åŒ–ä¸ºè·¯å¾„æ ‡è®°é—®é¢˜
- **æŠ€å·§2ï¼šç¦»çº¿å·®åˆ†** - åŒºé—´æŸ¥è¯¢æ‹†è§£ä¸ºå‰ç¼€æ“ä½œ
- **æŠ€å·§3ï¼šæ¨¡å—å°è£…** - æ ‘å‰–æŸ¥è¯¢/æ›´æ–°ç‹¬ç«‹ä¸ºå‡½æ•°ï¼ˆ`update_chain`, `query_chain`ï¼‰
- **æŠ€å·§4ï¼šè¾¹ç•Œå¤„ç†** - æ ‘å‰–æœ€åå¤„ç†è¾ƒæµ…èŠ‚ç‚¹ï¼ˆ`if(dep[u]>dep[v]) swap(u,v)`ï¼‰

---

#### C++æ ¸å¿ƒä»£ç å®ç°èµæ
```cpp
#include <cstdio>
#include <algorithm>
#define lc (x<<1)
#define rc (x<<1|1)
using namespace std;
const int N=50005, mod=201314;

int n, Q, cnt, dfn;
int fa[N], dep[N], son[N], sz[N], top[N], idx[N];
int sum[N<<2], tag[N<<2]; // çº¿æ®µæ ‘æ•°ç»„

void update_tree(int x, int l, int r, int L, int R) {
    if (L <= l && r <= R) { 
        sum[x] += r-l+1, tag[x]++; 
        return; 
    }
    if (tag[x]) { // ä¸‹ä¼ æ ‡è®°
        sum[lc] += tag[x]*(mid-l+1);
        sum[rc] += tag[x]*(r-mid);
        tag[lc] += tag[x], tag[rc] += tag[x];
        tag[x] = 0;
    }
    if (L <= mid) update_tree(lc, l, mid, L, R);
    if (R > mid) update_tree(rc, mid+1, r, L, R);
    sum[x] = sum[lc] + sum[rc]; // æ›´æ–°çˆ¶èŠ‚ç‚¹
}

int query_tree(int x, int l, int r, int L, int R) {
    if (L <= l && r <= R) return sum[x];
    if (tag[x]) { /* åŒä¸Š */ }
    int res = 0;
    if (L <= mid) res += query_tree(lc, l, mid, L, R);
    if (R > mid) res += query_tree(rc, mid+1, r, L, R);
    return res;
}

void update_path(int u) { // èŠ‚ç‚¹uåˆ°æ ¹çš„è·¯å¾„+1
    while (u) {
        update_tree(1, 1, n, idx[top[u]], idx[u]);
        u = fa[top[u]];
    }
}

int query_path(int u) { // æŸ¥è¯¢uåˆ°æ ¹çš„è·¯å¾„å’Œ
    int res = 0;
    while (u) {
        res += query_tree(1, 1, n, idx[top[u]], idx[u]);
        u = fa[top[u]];
    }
    return res % mod;
}

int main() {
    scanf("%d%d", &n, &Q);
    for (int i = 2; i <= n; i++) 
        scanf("%d", &fa[i]), fa[i]++;
    
    // æ ‘å‰–é¢„å¤„ç†ï¼ˆdfs1æ±‚é‡å„¿å­, dfs2æ±‚é‡é“¾ï¼‰
    // ... çœç•¥DFSä»£ç 
    
    int now = 1;
    for (int i = 1; i <= Q; i++) {
        int l, r, z; 
        scanf("%d%d%d", &l, &r, &z);
        q[++cnt] = {i, l, z+1, -1}; // å·®åˆ†è¯¢é—®
        q[++cnt] = {i, r+1, z+1, 1};
    }
    sort(q+1, q+cnt+1); // æŒ‰å³ç«¯ç‚¹æ’åº
    
    for (int i = 1; i <= cnt; i++) {
        while (now <= q[i].pos) update_path(now++);
        ans[q[i].id] += q[i].flg * query_path(q[i].z);
    }
    for (int i = 1; i <= Q; i++) 
        printf("%d\n", (ans[i] + mod) % mod);
}
```
**å…³é”®ä»£ç è§£è¯»**ï¼š
1. **æ ‘å‰–æ ¸å¿ƒ**ï¼š`update_path`å’Œ`query_path`é€šè¿‡`top`è·³é‡é“¾ï¼Œå°†è·¯å¾„æ“ä½œè½¬ä¸ºO(log n)ä¸ªåŒºé—´æ“ä½œ
2. **çº¿æ®µæ ‘**ï¼š`tag[]`å®ç°æ‡’æ ‡è®°ï¼Œé¿å…é¢‘ç¹æ›´æ–°ï¼›åŒºé—´æ›´æ–°æ—¶å…ˆå¤„ç†æ ‡è®°ä¸‹ä¼ 
3. **ç¦»çº¿å¤„ç†**ï¼šå°†æŸ¥è¯¢æŒ‰å³ç«¯ç‚¹æ’åºï¼Œä¾æ¬¡æ¿€æ´»èŠ‚ç‚¹(`now++`)å¹¶å“åº”æŸ¥è¯¢

---

### ç®—æ³•å¯è§†åŒ–ï¼šåƒç´ åŠ¨ç”»æ¼”ç¤º
**ä¸»é¢˜**ï¼š8-bité£æ ¼æ ‘å½¢æ¢é™©åœ°å›¾  
**äº¤äº’è®¾è®¡**ï¼š
```plaintext
æ§åˆ¶é¢æ¿ï¼š[â–¶ï¸ æ’­æ”¾] [â¸ï¸ æš‚åœ] [ğŸ” é‡ç½®] é€Ÿåº¦ï¼š[====|-----] 
å½“å‰æ“ä½œï¼šæ¿€æ´»èŠ‚ç‚¹(12) â†’ æŸ¥è¯¢(z=7)
ç§¯åˆ†ï¼š45
```
**åŠ¨ç”»æµç¨‹**ï¼š
1. **åˆå§‹åŒ–**ï¼šæ˜¾ç¤ºæ ‘å½¢åœ°å›¾ï¼ˆæ ¹åœ¨ä¸Šæ–¹ï¼‰ï¼Œæ§åˆ¶é¢æ¿
2. **èŠ‚ç‚¹æ¿€æ´»**ï¼šå½“å‰æ¿€æ´»èŠ‚ç‚¹é—ªçƒçº¢å…‰ï¼Œå…¶åˆ°æ ¹è·¯å¾„å˜ä¸ºé‡‘è‰²ï¼ˆ"å®"éŸ³æ•ˆï¼‰
3. **è·¯å¾„æŸ¥è¯¢**ï¼šzèŠ‚ç‚¹åˆ°æ ¹è·¯å¾„é«˜äº®è“è‰²ï¼Œè·¯å¾„å’Œæ˜¾ç¤ºä¸ºå³ä¸Šè§’ç§¯åˆ†
4. **è‡ªåŠ¨æ¼”ç¤º**ï¼šç‚¹å‡»æ’­æ”¾æŒ‰é’®åï¼ŒèŠ‚ç‚¹æŒ‰1â†’né¡ºåºè‡ªåŠ¨æ¿€æ´»ï¼ˆé€Ÿåº¦å¯è°ƒï¼‰
5. **ç»“æœå±•ç¤º**ï¼šå®ŒæˆæŸ¥è¯¢æ—¶æ’­æ”¾"èƒœåˆ©"éŸ³æ•ˆï¼Œæ˜¾ç¤ºæœ€ç»ˆè·¯å¾„å’Œ

**æŠ€æœ¯å®ç°**ï¼š  
- **Canvasç»˜åˆ¶**ï¼šç”¨16è‰²åƒç´ å—è¡¨ç¤ºèŠ‚ç‚¹ï¼Œè·¯å¾„ç”¨ä¸åŒé¢œè‰²åŒºåˆ†  
- **çŠ¶æ€åŒæ­¥**ï¼šå½“å‰æ¿€æ´»èŠ‚ç‚¹ID/è·¯å¾„å’Œå®æ—¶æ˜¾ç¤ºåœ¨é¢æ¿  
- **éŸ³æ•ˆè§¦å‘**ï¼šè·¯å¾„æ ‡è®°æ—¶çŸ­ä¿ƒ"å®"ï¼Œå®ŒæˆæŸ¥è¯¢æ—¶ä¸Šæ‰¬éŸ³æ•ˆ  

---

#### æ‹“å±•ç»ƒä¹ ä¸ç›¸ä¼¼é—®é¢˜
**é€šç”¨æŠ€å·§è¿ç§»**ï¼š
1. **è·¯å¾„äº¤é›†ç»Ÿè®¡**ï¼šP4211çš„è½¬åŒ–æ€æƒ³é€‚ç”¨äºæ‰€æœ‰LCAæ·±åº¦ç›¸å…³é—®é¢˜
2. **ç¦»çº¿+å·®åˆ†**ï¼šå¤„ç†æ ‘ä¸ŠåŒºé—´æŸ¥è¯¢çš„é€šç”¨æ–¹æ³•ï¼ˆå¦‚P2146 [NOI2015]è½¯ä»¶åŒ…ç®¡ç†å™¨ï¼‰
3. **æ ‘å‰–+çº¿æ®µæ ‘**ï¼šè·¯å¾„ä¿®æ”¹/æŸ¥è¯¢çš„ç»å…¸ç»„åˆ

**æ´›è°·æ¨è**ï¼š
1. **P2146 [NOI2015] è½¯ä»¶åŒ…ç®¡ç†å™¨**  
   â†’ ç»ƒä¹ æ ‘å‰–è·¯å¾„ä¿®æ”¹ï¼Œå·©å›º`install/uninstall`æ“ä½œå¯¹åº”çš„è·¯å¾„å¤„ç†
2. **P3384 ã€æ¨¡æ¿ã€‘è½»é‡é“¾å‰–åˆ†**  
   â†’ å¼ºåŒ–æ ‘å‰–ä»£ç å®ç°ï¼ŒæŒæ¡å­æ ‘ä¿®æ”¹/æŸ¥è¯¢
3. **P3250 [HNOI2016] æœ€å°å…¬å€æ•°**  
   â†’ æ‹“å±•ç¦»çº¿æŠ€å·§åœ¨å¤æ‚æŸ¥è¯¢ä¸­çš„åº”ç”¨

---

#### å­¦ä¹ å¿ƒå¾—ä¸ç»éªŒåˆ†äº«
> **æ¥è‡ªç´«é’¦çš„è°ƒè¯•ç»éªŒ**ï¼š  
> "æˆ‘åœ¨å¤„ç†æ ‘å‰–è¾¹ç•Œæ—¶ï¼Œå› æœªé‡ç½®`son[]`æ•°ç»„å¯¼è‡´WAã€‚è¿™æé†’æˆ‘ä»¬ï¼š**å¤šç»„æ•°æ®æ—¶åŠ¡å¿…åˆå§‹åŒ–å…¨å±€æ•°ç»„**ï¼Œç‰¹åˆ«æ˜¯`son[]`å’Œ`top[]`è¿™ç±»æ˜“å¿½ç•¥çš„æ•°ç»„ã€‚"

**Kayçš„æ€»ç»“**ï¼š  
> æ ‘å‰–é—®é¢˜ä¸­ï¼ŒDFSé¢„å¤„ç†é˜¶æ®µçš„æ•°ç»„åˆå§‹åŒ–è‡³å…³é‡è¦ã€‚å»ºè®®ï¼š
> 1. ç”¨`memset(son,0,sizeof son)`ç¡®ä¿å¹²å‡€çŠ¶æ€
> 2. å†™`dfs1`æ—¶æ³¨æ„`son[u]`çš„æ›´æ–°æ¡ä»¶ï¼ˆ`if(size[v]>size[son[u]]`ï¼‰
> 3. è¾¹ç•Œæ£€æŸ¥ï¼šæ ‘å‰–æœ€åéœ€æ¯”è¾ƒ`dep[u]`å’Œ`dep[v]`ç¡®ä¿æ“ä½œæ­£ç¡®åŒºé—´

---

é€šè¿‡æœ¬æŒ‡å—ï¼Œç›¸ä¿¡å¤§å®¶å·²æŒæ¡æ ‘å‰–çš„æ ¸å¿ƒæ€æƒ³å’Œå®ç°æŠ€å·§ã€‚è®°ä½ï¼š**é—®é¢˜è½¬åŒ–+ç®—æ³•å°è£…+ç»†èŠ‚å¤„ç†=é«˜æ•ˆAC**ï¼ä¸‹æ¬¡æˆ‘ä»¬ç»§ç»­æ¢ç´¢å›¾è®ºç²¾å¦™ç®—æ³•ï¼Œä¿æŒçƒ­çˆ±ï¼Œç¼–ç¨‹ä¸–ç•Œç­‰ä½ å¾æœï¼ğŸ’ª

---
å¤„ç†ç”¨æ—¶ï¼š127.97ç§’
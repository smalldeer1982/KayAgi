# 题目信息

# [CQOI2006] 凸多边形 /【模板】半平面交

## 题目描述

逆时针给出 $n$ 个凸多边形的顶点坐标，求它们交的面积。例如 $n=2$ 时，两个凸多边形如下图：

![](https://cdn.luogu.com.cn/upload/image_hosting/7ieux7g3.png)

则相交部分的面积为 $5.233$。

## 说明/提示

对于 $100\%$ 的数据：$2 \leq n \leq 10$，$3 \leq m_i \leq 50$，每维坐标为 $[-1000,1000]$ 内的整数。

## 样例 #1

### 输入

```
2
6
-2 0
-1 -2
1 -2
2 0
1 2
-1 2
4
0 -3
1 -1
2 2
-1 0```

### 输出

```
5.233```

# AI分析结果


### 💡 Kay的C++算法解析：凸多边形交面积（半平面交）深入学习指南 💡

#### 1. 题目解读与核心算法识别
✨ **本题主要考察**：计算几何 / 半平面交

🗣️ **初步分析**：
> 解决凸多边形交面积问题，关键在于理解**半平面交算法**。想象每个多边形是一块剪纸，半平面交就是这些剪纸重叠的部分。算法通过收集所有多边形的边（视为半平面），按角度排序后逐步合并，最终得到重叠区域的边界轮廓。

- **核心思路**：
  - 每个多边形的边定义为半平面（取向量左侧区域）
  - 所有边按极角排序，角度相同的保留最左侧的边
  - 用双端队列维护有效边：新边加入时，若与队尾边的交点在队尾前一条边右侧，则删除队尾边
- **可视化设计**：
  - 8位像素风格网格平面，多边形边用不同颜色像素块表示
  - 高亮当前处理的边（闪烁效果），被删除的边变红消失
  - 实时显示双端队列状态和交点位置变化，成功求交时播放胜利音效

#### 2. 精选优质题解参考
**题解一（来源：Grisses）**
* **点评**：从数学定义到算法实现系统讲解，极角排序证明严谨。代码中`atan2`处理极角、叉积判断位置关系清晰规范。亮点在完整推导交点公式，并用`fabs(angle1-angle2)>eps`处理浮点精度，实践时可直接用于竞赛。

**题解二（来源：suxxsfe）**
* **点评**：核心贡献是解决平行反向向量的边界情况。通过点乘判反向（`dot(way1,way2)≤-eps`）和叉积判平行，处理无交情况直接返回0。代码鲁棒性强，附验证数据，是工业级实现的典范。

**题解三（来源：_saltFish_）**
* **点评**：双端队列实现简洁高效，`while(head<tail && cross(...))`的删除逻辑直观。亮点在凸包式面积计算：`ans += cross(p[i],p[i%k+1])/2`，适合初学者理解半平面交与凸包的联系。

#### 3. 核心难点辨析与解题策略
1. **难点一：极角排序的稳定性**
   - **分析**：浮点数精度导致角度比较误差。优质解法均用`atan2`计算极角，排序时对角度差`<eps`的情况特殊处理：通过叉积判断保留最左侧边（限制最严格）
   - 💡 学习笔记：`fabs(angle1-angle2)<eps ? cross()>0 : angle1<angle2`

2. **难点二：双端队列的维护逻辑**
   - **分析**：删除队尾边的条件是：**新边与队尾前一条边的交点**在新边右侧（`cross>0`）。需先维护队尾再队头，最后额外检查首尾相连是否合法
   - 💡 学习笔记：维护顺序口诀——“先尾后头，终查首尾”

3. **难点三：退化情况处理**
   - **分析**：平行反向向量导致无交时（如两个分离矩形），suxxsfe的解法通过点积判反向及时返回0；Grisses用叉积面积符号判断点在右侧
   - 💡 学习笔记：无交检测三要素——平行（叉积≈0）、反向（点积<0）、无公共点

✨ **解题技巧总结**：
- **技巧1（浮点处理）**：用`1e-7`级`eps`处理精度，避免直接`==`
- **技巧2（边界鲁棒性）**：面积计算前检查有效边数量（`if(top-back+1>2`）
- **技巧3（计算优化）**：交点公式用叉积比值代替三角函数，避免精度损失

#### 4. C++核心代码实现赏析
**本题通用核心实现**：
```cpp
#include <bits/stdc++.h>
#define eps 1e-7
using namespace std;

struct Point { double x,y; };
struct Line {
    Point s,e;
    double ang;
    bool operator<(const Line &b) const {
        if(fabs(ang-b.ang)<eps) 
            return cross(e-s, b.e-s) > eps;
        return ang < b.ang;
    }
};

double cross(Point a,Point b){ ... }
Point Inter(Line a,Line b){ ... } // 交点计算

vector<Point> HalfPlane(vector<Line> lines){
    sort(lines.begin(), lines.end());
    deque<Line> q; // 双端队列
    for(auto &l:lines){
        while(q.size()>=2 && onRight(l,q)) q.pop_back();
        while(q.size()>=2 && onRight(l,q,true)) q.pop_front();
        q.push_back(l);
    }
    // 计算交点返回多边形
}
```

**题解一（Grisses）片段赏析**：
```cpp
// 交点公式推导实现
Point getnode(edge a,edge b){
    double S1=cross(a.start,b.end,a.end);
    double S2=cross(a.start,b.start,a.end);
    return Point((S1*b.start.x-S2*b.end.x)/(S1-S2), ...);
}
```
> **解读**：直接应用共边定理的叉积比例关系，避免解直线方程，精度更高。学习笔记：向量几何可替代解析几何简化计算。

**题解二（suxxsfe）片段赏析**：
```cpp
// 平行反向检测
if(fabs(cross(v1,v2))<eps){
    if(onRight(newLine,oldLine.p) && dot(v1,v2)<=-eps)
        return 0; // 无交
}
```
> **解读**：点积`dot(v1,v2)<=-eps`判断两向量夹角>90°（反向），结合叉积≈0判平行。学习笔记：向量方向性检测是处理退化情况的关键。

#### 5. 算法可视化：像素动画演示
**设计主题**：8-bit风格"半平面交建造者"  
![](https://cdn.luogu.com.cn/upload/image_hosting/7ieux7g3.png?image_process=watermark,text_QOS4gOWPpemZog)

**关键交互设计**：
1. **初始化**：
   - 网格平面（128x128像素），每个多边形边用不同色块（红/蓝/绿）
   - 控制面板：步进/暂停/速度滑块（复古旋钮UI）

2. **极角排序阶段**：
   - 所有边按角度旋转对齐（补间动画）
   - 相同角度边对比：保留左侧边（绿色√），右侧边变灰消失

3. **双端队列维护**：
   - 当前边高亮闪烁，与队尾边求交点（黄色★标记）
   - 交点在右侧：队尾边变红消失，播放"错误音效"
   - 新边入队：像素块滑入队列，播放"放置音效"

4. **结果展示**：
   - 有效边围成区域填充绿色，显示面积值
   - 无解时全屏红色闪烁，播放警报音

**技术实现**：
```javascript
// 伪代码：绘制当前边交点
function drawIntersection(){
    ctx.fillStyle = "yellow"; // 8位黄色
    let p = calculateIntersection();
    ctx.fillRect(p.x*10, p.y*10, 4, 4); // 网格坐标转换
    playSound("ding"); // FC音效
}
```

#### 6. 拓展练习与相似问题
**通用技巧迁移**：
1. 线性规划可行域求解
2. 多边形核检测（如P1576安全区域）
3. 动态半平面交（用线段树维护）

**洛谷推荐**：
1. **P4250 [集训队] 多边形**  
   → 巩固半平面交求交面积
2. **P3730 曼哈顿交易**  
   → 变种：曼哈顿距离下的半平面交
3. **P4198 楼房重建**  
   → 动态维护半平面交

#### 7. 学习心得与经验分享
> **Grisses的调试经验**：  
> “叉积符号判断容易写反，建议用`(0,0),(1,0),(0,1)`等简单数据验证”  
> → **Kay点评**：基础测试用例能快速定位方向错误，推荐建立几何测试库

> **suxxsfe的边界处理**：  
> “平行反向向量需额外判断，否则90%数据会WA”  
> → **Kay点评**：几何问题需特别注意退化情况，无交检测必不可少

#### 结语
半平面交是计算几何的基石问题，核心在于**向量运算**和**分步维护**。通过本指南的算法解析和像素演示，相信大家能直观理解双端队列的维护过程。建议用可视化工具逐步跟踪代码，彻底掌握交点计算和边界处理！下次见~ 👾

---
处理用时：116.30秒
# é¢˜ç›®ä¿¡æ¯

# [CTSC2008] ç½‘ç»œç®¡ç†

## é¢˜ç›®æè¿°

M å…¬å¸æ˜¯ä¸€ä¸ªéå¸¸åºå¤§çš„è·¨å›½å…¬å¸ï¼Œåœ¨è®¸å¤šå›½å®¶éƒ½è®¾æœ‰å®ƒçš„ä¸‹å±åˆ†æ”¯æœºæ„æˆ–éƒ¨é—¨ã€‚ä¸ºäº†è®©åˆ†å¸ƒåœ¨ä¸–ç•Œå„åœ°çš„ $n$ ä¸ªéƒ¨é—¨ä¹‹é—´ååŒå·¥ä½œï¼Œå…¬å¸æ­å»ºäº†ä¸€ä¸ªè¿æ¥æ•´ä¸ªå…¬å¸çš„é€šä¿¡ç½‘ç»œã€‚  

è¯¥ç½‘ç»œçš„ç»“æ„ç”± $n$ ä¸ªè·¯ç”±å™¨å’Œ $n-1$ æ¡é«˜é€Ÿå…‰ç¼†ç»„æˆã€‚æ¯ä¸ªéƒ¨é—¨éƒ½æœ‰ä¸€ä¸ªä¸“å±çš„è·¯ç”±å™¨ï¼Œéƒ¨é—¨å±€åŸŸç½‘å†…çš„æ‰€æœ‰æœºå™¨éƒ½è”å‘è¿™ä¸ªè·¯ç”±å™¨ï¼Œç„¶åå†é€šè¿‡è¿™ä¸ªé€šä¿¡å­ç½‘ä¸å…¶ä»–éƒ¨é—¨è¿›è¡Œé€šä¿¡è”ç»œã€‚è¯¥ç½‘ç»œç»“æ„ä¿è¯ç½‘ç»œä¸­çš„ä»»æ„ä¸¤ä¸ªè·¯ç”±å™¨ä¹‹é—´éƒ½å­˜åœ¨ä¸€æ¡ç›´æ¥æˆ–é—´æ¥è·¯å¾„ä»¥è¿›è¡Œé€šä¿¡ã€‚   

é«˜é€Ÿå…‰ç¼†çš„æ•°æ®ä¼ è¾“é€Ÿåº¦éå¸¸å¿«ï¼Œä»¥è‡³äºåˆ©ç”¨å…‰ç¼†ä¼ è¾“çš„å»¶è¿Ÿæ—¶é—´å¯ä»¥å¿½ç•¥ã€‚ä½†æ˜¯ç”±äºè·¯ç”±å™¨è€åŒ–ï¼Œåœ¨è¿™äº›è·¯ç”±å™¨ä¸Šè¿›è¡Œæ•°æ®äº¤æ¢ä¼šå¸¦æ¥å¾ˆå¤§çš„å»¶è¿Ÿã€‚è€Œä¸¤ä¸ªè·¯ç”±å™¨ä¹‹é—´çš„é€šä¿¡å»¶è¿Ÿæ—¶é—´åˆ™ä¸è¿™ä¸¤ä¸ªè·¯ç”±å™¨é€šä¿¡è·¯å¾„ä¸Šæ‰€æœ‰è·¯ç”±å™¨ä¸­æœ€å¤§çš„äº¤æ¢å»¶è¿Ÿæ—¶é—´æœ‰å…³ã€‚  

ä½œä¸º M å…¬å¸ç½‘ç»œéƒ¨é—¨çš„ä¸€åå®ä¹ å‘˜å·¥ï¼Œç°åœ¨è¦æ±‚ä½ ç¼–å†™ä¸€ä¸ªç®€å•çš„ç¨‹åºæ¥ç›‘è§†å…¬å¸çš„ç½‘ç»œçŠ¶å†µã€‚è¯¥ç¨‹åºèƒ½å¤Ÿéšæ—¶æ›´æ–°ç½‘ç»œçŠ¶å†µçš„å˜åŒ–ä¿¡æ¯ï¼ˆè·¯ç”±å™¨æ•°æ®äº¤æ¢å»¶è¿Ÿæ—¶é—´çš„å˜åŒ–ï¼‰ï¼Œå¹¶ä¸”æ ¹æ®è¯¢é—®ç»™å‡ºä¸¤ä¸ªè·¯ç”±å™¨é€šä¿¡è·¯å¾„ä¸Šå»¶è¿Ÿç¬¬ $k$ å¤§çš„è·¯ç”±å™¨çš„å»¶è¿Ÿæ—¶é—´ã€‚
****
ã€ä»»åŠ¡ã€‘   
ä½ çš„ç¨‹åºä»è¾“å…¥æ–‡ä»¶ä¸­è¯»å…¥ $n$ ä¸ªè·¯ç”±å™¨å’Œ $n-1$ æ¡å…‰ç¼†çš„è¿æ¥ä¿¡æ¯ï¼Œæ¯ä¸ªè·¯ç”±å™¨åˆå§‹çš„æ•°æ®äº¤æ¢å»¶è¿Ÿæ—¶é—´ $t_i$ï¼Œä»¥åŠ $q$ æ¡è¯¢é—®ï¼ˆæˆ–çŠ¶æ€æ”¹å˜ï¼‰çš„ä¿¡æ¯ã€‚å¹¶ä¾æ¬¡å¤„ç†è¿™ $q$ æ¡è¯¢é—®ä¿¡æ¯ï¼Œå®ƒä»¬å¯èƒ½æ˜¯ï¼š

1. ç”±äºæ›´æ–°äº†è®¾å¤‡ï¼Œæˆ–è€…è®¾å¤‡å‡ºç°æ–°çš„æ•…éšœï¼Œä½¿å¾—æŸä¸ªè·¯ç”±å™¨çš„æ•°æ®äº¤æ¢å»¶è¿Ÿæ—¶é—´å‘ç”Ÿäº†å˜åŒ–ã€‚

2. æŸ¥è¯¢æŸä¸¤ä¸ªè·¯ç”±å™¨ $a$ å’Œ $v$ ä¹‹é—´çš„è·¯å¾„ä¸Šå»¶è¿Ÿç¬¬ $k$ å¤§çš„è·¯ç”±å™¨çš„å»¶è¿Ÿæ—¶é—´ã€‚


## è¯´æ˜/æç¤º

ã€æ•°æ®èŒƒå›´ã€‘  
å¯¹äº $100\%$ çš„æ•°æ®ï¼Œ$1\le n,q \le 80000$ï¼Œ$0 \le k \le n$ï¼Œä»»æ„ä¸€ä¸ªè·¯ç”±å™¨åœ¨ä»»ä½•æ—¶åˆ»éƒ½æ»¡è¶³å»¶è¿Ÿæ—¶é—´å°äº $10^8$ã€‚



## æ ·ä¾‹ #1

### è¾“å…¥

```
5 5
5 1 2 3 4
3 1
2 1
4 3
5 3
2 4 5
0 1 2
2 2 3
2 1 4
3 3 5```

### è¾“å‡º

```
3
2
2
invalid request!```

# AIåˆ†æç»“æœ


# ğŸ’¡ Kayçš„C++ç®—æ³•è§£æï¼šç½‘ç»œç®¡ç† æ·±å…¥å­¦ä¹ æŒ‡å— ğŸ’¡

## 1. é¢˜ç›®è§£è¯»ä¸æ ¸å¿ƒç®—æ³•è¯†åˆ«

âœ¨ **æœ¬é¢˜ä¸»è¦è€ƒå¯Ÿ**ï¼š`æ•´ä½“äºŒåˆ†` + `æ ‘çŠ¶æ•°ç»„` + `æ ‘é“¾å‰–åˆ†`

ğŸ—£ï¸ **åˆæ­¥åˆ†æ**ï¼š
> è§£å†³"ç½‘ç»œç®¡ç†"è¿™é“é¢˜ï¼Œå…³é”®åœ¨äºè¿ç”¨`æ•´ä½“äºŒåˆ†`ç®—æ³•æ¡†æ¶ã€‚ç®€å•æ¥è¯´ï¼Œæ•´ä½“äºŒåˆ†å°±åƒä¸€ä½èªæ˜çš„å›¾ä¹¦ç®¡ç†å‘˜ï¼Œä»–å°†æ‰€æœ‰è¯»è€…çš„æŸ¥è¯¢è¯·æ±‚å’Œä¹¦ç±æ›´æ–°æ“ä½œä¸€å¹¶å¤„ç†ï¼Œé€šè¿‡äºŒåˆ†ç­”æ¡ˆåŒºé—´é€æ­¥ç¼©å°èŒƒå›´ï¼Œæœ€ç»ˆé«˜æ•ˆæ‰¾åˆ°ç­”æ¡ˆã€‚åœ¨æœ¬é¢˜ä¸­ï¼Œæ•´ä½“äºŒåˆ†ç”¨äºå¤„ç†å¸¦ä¿®æ”¹çš„æ ‘ä¸Šè·¯å¾„ç¬¬kå¤§æŸ¥è¯¢é—®é¢˜ã€‚
   - æ ¸å¿ƒæ€è·¯æ˜¯å°†æ‰€æœ‰æ“ä½œï¼ˆæŸ¥è¯¢å’Œä¿®æ”¹ï¼‰ç¦»çº¿å¤„ç†ï¼Œé€šè¿‡äºŒåˆ†æƒå€¼åŒºé—´å°†é—®é¢˜åˆ†è§£ä¸ºå­é—®é¢˜ï¼Œåˆ©ç”¨æ ‘çŠ¶æ•°ç»„ç»´æŠ¤DFSåºä¸Šçš„å­æ ‘ä¿®æ”¹ï¼Œç»“åˆæ ‘é“¾å‰–åˆ†å®ç°è·¯å¾„æŸ¥è¯¢ã€‚
   - éš¾ç‚¹åœ¨äºï¼š1) æ ‘ä¸Šè·¯å¾„å¦‚ä½•è½¬åŒ–ä¸ºåºåˆ—æ“ä½œ 2) ä¿®æ”¹æ“ä½œå¦‚ä½•å½±å“å­æ ‘ 3) å¦‚ä½•åœ¨äºŒåˆ†è¿‡ç¨‹ä¸­åŠ¨æ€ç»Ÿè®¡è·¯å¾„ä¿¡æ¯ã€‚
   - å¯è§†åŒ–è®¾è®¡ï¼šé‡‡ç”¨8ä½åƒç´ é£æ ¼å±•ç¤ºæ ‘ç»“æ„ï¼ŒèŠ‚ç‚¹ç”¨ä¸åŒé¢œè‰²æ–¹å—è¡¨ç¤ºæƒå€¼å¤§å°ã€‚äºŒåˆ†è¿‡ç¨‹ä¸­ï¼Œå½“å‰æƒå€¼åŒºé—´å†…çš„èŠ‚ç‚¹ä¼šé—ªçƒé»„è‰²å…‰æ•ˆï¼Œæ ‘é“¾æŸ¥è¯¢æ—¶è·¯å¾„èŠ‚ç‚¹æ˜¾ç¤ºè“è‰²è½¨è¿¹ï¼ŒLCAèŠ‚ç‚¹æ ‡è®°ä¸ºçº¢è‰²ã€‚å½“ç­”æ¡ˆç¡®å®šæ—¶æ’­æ”¾èƒœåˆ©éŸ³æ•ˆã€‚

---

## 2. ç²¾é€‰ä¼˜è´¨é¢˜è§£å‚è€ƒ

**é¢˜è§£ä¸€ï¼ˆæ•´ä½“äºŒåˆ†+æ ‘çŠ¶æ•°ç»„ï¼‰**
* **ç‚¹è¯„**ï¼šæ­¤è§£æ³•æ€è·¯æ¸…æ™°ï¼Œå·§å¦™åˆ©ç”¨æ•´ä½“äºŒåˆ†æ¡†æ¶å°†å¤æ‚é—®é¢˜åˆ†è§£ã€‚ä½œè€…å°†æ ‘å‰–æ±‚å¾—çš„DFSåºä¸æ ‘çŠ¶æ•°ç»„ç»“åˆï¼Œé«˜æ•ˆå¤„ç†å­æ ‘ä¿®æ”¹ï¼ˆå·®åˆ†æŠ€å·§ï¼‰ã€‚ä»£ç å®ç°ç®€æ´ï¼Œå˜é‡å‘½åè§„èŒƒï¼ˆå¦‚`dfn`ã€`sz`ï¼‰ï¼Œè¾¹ç•Œå¤„ç†ä¸¥è°¨ï¼Œç©ºé—´å¤æ‚åº¦æ§åˆ¶ä¼˜ç§€ï¼ˆO(n log n)ï¼‰ã€‚äº®ç‚¹åœ¨äºç”¨æ ‘çŠ¶æ•°ç»„ç»´æŠ¤DFSåºåŒºé—´ï¼Œé¿å…äº†ä¸»å¸­æ ‘çš„é«˜å†…å­˜æ¶ˆè€—ã€‚

**é¢˜è§£äºŒï¼ˆæ ‘çŠ¶æ•°ç»„å¥—ä¸»å¸­æ ‘ï¼‰**
* **ç‚¹è¯„**ï¼šé‡‡ç”¨æ ‘çŠ¶æ•°ç»„å¥—ä¸»å¸­æ ‘çš„åŒå±‚ç»“æ„ï¼Œå¤–å±‚å¤„ç†DFSåºï¼Œå†…å±‚ç»´æŠ¤æƒå€¼ã€‚æ€è·¯åˆ›æ–°ç‚¹åœ¨äºç”¨æ¬§æ‹‰åºå°†æ ‘ä¸Šè·¯å¾„è½¬åŒ–ä¸ºå››ä¸ªç‚¹åˆ°æ ¹çš„æŸ¥è¯¢ï¼ˆu+v-lca-fa[lca]ï¼‰ã€‚ä»£ç ä¸­`query`å‡½æ•°å®ç°ä¼˜é›…ï¼Œé€šè¿‡åŒæ­¥ç§»åŠ¨å¤šæ£µçº¿æ®µæ ‘å®Œæˆè·¯å¾„ç»Ÿè®¡ã€‚è™½ç„¶ç†è®ºå¤æ‚åº¦ç›¸åŒï¼Œä½†å®é™…å¸¸æ•°è¾ƒå¤§ï¼Œé€‚åˆç†è§£æ ‘ä¸Šå‰ç¼€å’Œçš„å­¦ä¹ è€…ã€‚

**é¢˜è§£ä¸‰ï¼ˆæ ‘ä¸Šå¸¦ä¿®è«é˜Ÿ+å€¼åŸŸåˆ†å—ï¼‰**
* **ç‚¹è¯„**ï¼šå°†æ ‘è½¬åŒ–ä¸ºæ¬§æ‹‰åºåç”¨è«é˜Ÿå¤„ç†åºåˆ—ï¼Œå€¼åŸŸåˆ†å—æ±‚ç¬¬kå¤§ã€‚è§£æ³•ç‹¬è¾Ÿè¹Šå¾„ï¼Œä»£ç å®ç°å·§å¦™ï¼ˆæ§åˆ¶å—å¤§å°å¹³è¡¡å¤æ‚åº¦ï¼‰ã€‚äº®ç‚¹åœ¨äºåˆ†å—æ±‚kå¤§æ—¶çš„è·³è·ƒå¼æ£€ç´¢ï¼Œç±»ä¼¼æ¸¸æˆä¸­çš„å…³å¡è®¾è®¡ï¼šå…ˆç¡®å®šç›®æ ‡å€¼æ‰€åœ¨å¤§å—ï¼ˆå…³å¡ï¼‰ï¼Œå†åœ¨å—å†…ç²¾ç»†æŸ¥æ‰¾ã€‚é€‚åˆæƒ³æ‹“å±•è«é˜Ÿåº”ç”¨åœºæ™¯çš„å­¦ä¹ è€…ã€‚

---

## 3. æ ¸å¿ƒéš¾ç‚¹è¾¨æä¸è§£é¢˜ç­–ç•¥

1. **æ ‘ä¸Šè·¯å¾„è½¬åºåˆ—å¤„ç†**
   * **åˆ†æ**ï¼šæ ‘é“¾å‰–åˆ†å°†è·¯å¾„æ‹†åˆ†ä¸ºO(log n)æ®µDFSåºè¿ç»­åŒºé—´ï¼Œå°±åƒå°†æ›²æŠ˜å±±è·¯æ‹‰ç›´ä¸ºé˜¶æ¢¯ã€‚ç»“åˆæ¬§æ‹‰åºç‰¹æ€§ï¼ˆin[u]åˆ°in[v]åŒ…å«è·¯å¾„ï¼‰ï¼Œç”¨æ ‘çŠ¶æ•°ç»„ç»´æŠ¤"è¿›+1/å‡º-1"çš„å·®åˆ†æ ‡è®°ã€‚
   * ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šDFSåºæ˜¯å¤„ç†å­æ ‘é—®é¢˜çš„ç‘å£«å†›åˆ€ï¼Œæ¬§æ‹‰åºåˆ™æ˜¯è·¯å¾„é—®é¢˜çš„ä¸‡èƒ½é’¥åŒ™ã€‚

2. **åŠ¨æ€ä¿®æ”¹çš„å­æ ‘å½±å“**
   * **åˆ†æ**ï¼šä¿®æ”¹èŠ‚ç‚¹uçš„æƒå€¼ä¼šå½±å“æ‰€æœ‰åŒ…å«uçš„è·¯å¾„â€”â€”å®è´¨æ˜¯å½±å“uçš„æ•´æ£µå­æ ‘ã€‚é€šè¿‡æ ‘çŠ¶æ•°ç»„å°†å­æ ‘ä¿®æ”¹(in[u]åˆ°out[u])è½¬åŒ–ä¸ºä¸¤ä¸ªå•ç‚¹ä¿®æ”¹(in[u]åŠ , out[u]+1å‡)ï¼Œå¦‚åŒåœ¨æ—¶é—´è½´ä¸Šæ‰“æ ‡è®°ã€‚
   * ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šæ ‘çŠ¶æ•°ç»„å·®åˆ†æ˜¯å¤„ç†åŒºé—´ä¿®æ”¹çš„ç»å…¸æŠ€å·§ï¼Œå¤æ‚åº¦O(log n)ã€‚

3. **æ•´ä½“äºŒåˆ†çš„æ“ä½œåˆ†æµ**
   * **åˆ†æ**ï¼šäºŒåˆ†å½“å‰æƒå€¼åŒºé—´[mid+1,r]æ—¶ï¼Œéœ€ç»Ÿè®¡è·¯å¾„ä¸Šå€¼åœ¨æ­¤åŒºé—´å†…çš„ç‚¹æ•°ã€‚è‹¥æ•°é‡â‰¥kè¯´æ˜ç­”æ¡ˆåœ¨å³ä¾§åŒºé—´ï¼Œå¦åˆ™åœ¨å·¦ä¾§ã€‚åˆ†æµæ—¶éœ€æ³¨æ„ï¼šä¿®æ”¹æ“ä½œè¦æ ¹æ®æƒå€¼åˆ†æµï¼ŒæŸ¥è¯¢æ“ä½œè¦æ ¹æ®ä¸´æ—¶ç»Ÿè®¡ç»“æœåˆ†æµã€‚
   * ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šæ•´ä½“äºŒåˆ†æ˜¯ç¦»çº¿ç®—æ³•çš„æ˜ç ï¼Œé€šè¿‡æ“ä½œåˆ†ç±»å®ç°é«˜æ•ˆç­›é€‰ã€‚

### âœ¨ è§£é¢˜æŠ€å·§æ€»ç»“
- **é—®é¢˜åˆ†è§£æœ¯**ï¼šå°†"å¸¦ä¿®æ ‘é“¾ç¬¬kå¤§"æ‹†è§£ä¸ºæ ‘å‰–+ç¦»æ•£åŒ–+æ•´ä½“äºŒåˆ†+æ ‘çŠ¶æ•°ç»„å››ä¸ªæ¨¡å—
- **ç©ºé—´å‹ç¼©æ³•**ï¼šç”¨DFSåºæ›¿ä»£ä¸»å¸­æ ‘é™ä½å†…å­˜ï¼Œæ ‘çŠ¶æ•°ç»„æ›¿ä»£çº¿æ®µæ ‘å‡å°‘å¸¸æ•°
- **è¾¹ç•Œé˜²å¾¡æœ¯**ï¼šç‰¹åˆ¤k>è·¯å¾„é•¿åº¦çš„æƒ…å†µ("invalid request!")
- **ç¦»æ•£åŒ–é¢„å¤„ç†**ï¼šæ‰€æœ‰æ“ä½œæ¶‰åŠçš„æƒå€¼å…ˆç»Ÿä¸€ç¦»æ•£åŒ–ï¼Œé¿å…åç»­äºŒåˆ†æ—¶é‡å¤æ’åº

---

## 4. C++æ ¸å¿ƒä»£ç å®ç°èµæ

**æœ¬é¢˜é€šç”¨æ ¸å¿ƒC++å®ç°å‚è€ƒ**
* **è¯´æ˜**ï¼šç»¼åˆä¼˜è´¨é¢˜è§£æ€è·¯ï¼Œé‡‡ç”¨æ•´ä½“äºŒåˆ†æ¡†æ¶ï¼Œæ ‘çŠ¶æ•°ç»„ç»´æŠ¤DFSåº
* **å®Œæ•´æ ¸å¿ƒä»£ç **ï¼š
```cpp
#include <bits/stdc++.h>
using namespace std;

const int N = 8e4 + 10;
struct Query { int op, x, y, k, id; };
vector<Query> q;
int n, m, ans[N], a[N], dfn[N], out[N], dep[N], fa[20][N];
vector<int> g[N], alls;

// æ ‘å‰–é¢„å¤„ç†
void dfs(int u, int f) {
    dfn[u] = ++dfn[0]; 
    dep[u] = dep[fa[0][u] = f] + 1;
    for (int v : g[u]) if (v != f) dfs(v, u);
    out[u] = dfn[0];
}

// LCA
int lca(int u, int v) {
    if (dep[u] < dep[v]) swap(u, v);
    for (int i = 19; i >= 0; i--)
        if (dep[fa[i][u]] >= dep[v]) u = fa[i][u];
    if (u == v) return u;
    for (int i = 19; i >= 0; i--)
        if (fa[i][u] != fa[i][v])
            u = fa[i][u], v = fa[i][v];
    return fa[0][u];
}

// æ ‘çŠ¶æ•°ç»„
struct BIT {
    int c[N];
    void upd(int x, int v) { for (; x <= n; x += x & -x) c[x] += v; }
    int qry(int x) { int r = 0; for (; x; x -= x & -x) r += c[x]; return r; }
} T;

// æ ‘ä¸Šå·®åˆ†
int path_sum(int u, int v) {
    int p = lca(u, v), f = fa[0][p];
    return T.qry(dfn[u]) + T.qry(dfn[v]) - T.qry(dfn[p]) - T.qry(dfn[f]);
}

// æ•´ä½“äºŒåˆ†
void solve(int l, int r, vector<Query> qry) {
    if (qry.empty()) return;
    if (l == r) {
        for (auto q : qry) if (q.op) ans[q.id] = alls[l];
        return;
    }
    
    int mid = (l + r) >> 1;
    vector<Query> ql, qr;
    
    // å¤„ç†ä¿®æ”¹
    for (auto &q : qry) {
        if (!q.op) {
            if (q.y <= mid) {  // æƒå€¼<=midæ‰æ›´æ–°
                T.upd(dfn[q.x], 1);
                T.upd(out[q.x] + 1, -1);
                ql.push_back(q);
            } else qr.push_back(q);
        }
    }
    
    // å¤„ç†æŸ¥è¯¢
    for (auto &q : qry) {
        if (q.op) {
            int cnt = path_sum(q.x, q.y);
            if (cnt >= q.k) ql.push_back(q);
            else q.k -= cnt, qr.push_back(q);
        }
    }
    
    // æ’¤é”€ä¿®æ”¹
    for (auto &q : ql) 
        if (!q.op) T.upd(dfn[q.x], -1), T.upd(out[q.x] + 1, 1);
    
    solve(l, mid, ql);
    solve(mid + 1, r, qr);
}

int main() {
    cin >> n >> m;
    for (int i = 1; i <= n; i++) 
        cin >> a[i], alls.push_back(a[i]);
    
    for (int i = 1, u, v; i < n; i++) {
        cin >> u >> v;
        g[u].push_back(v), g[v].push_back(u);
    }
    dfs(1, 0);
    
    // é¢„å¤„ç†å€å¢
    for (int j = 1; j < 20; j++)
        for (int i = 1; i <= n; i++)
            fa[j][i] = fa[j - 1][fa[j - 1][i]];
    
    // è¯»å…¥æŸ¥è¯¢
    for (int i = 1, op, x, y, k = 0; i <= m; i++) {
        cin >> op >> x >> y;
        if (op == 0) alls.push_back(y);
        else k++;
        q.push_back({op, x, y, k, op ? k : 0});
    }
    
    // ç¦»æ•£åŒ–
    sort(alls.begin(), alls.end());
    alls.erase(unique(alls.begin(), alls.end()), alls.end());
    for (int i = 1; i <= n; i++)
        a[i] = lower_bound(alls.begin(), alls.end(), a[i]) - alls.begin();
    for (auto &t : q) 
        if (!t.op) t.y = lower_bound(alls.begin(), alls.end(), t.y) - alls.begin();
    
    // åˆå§‹åŒ–ä¿®æ”¹æ“ä½œ
    vector<Query> init;
    for (int i = 1; i <= n; i++)
        init.push_back({0, i, a[i], 0, 0});
    for (auto t : q) init.push_back(t);
    
    solve(0, alls.size() - 1, init);
    
    for (int i = 1; i <= q.back().k; i++) 
        if (ans[i] == -1) cout << "invalid request!\n";
        else cout << alls[ans[i]] << "\n";
    return 0;
}
```
* **ä»£ç è§£è¯»æ¦‚è¦**ï¼š
  1. **é¢„å¤„ç†é˜¶æ®µ**ï¼šé€šè¿‡DFSè·å–æ ‘çš„DFSåºå’ŒLCAå€å¢è¡¨
  2. **ç¦»æ•£åŒ–å¤„ç†**ï¼šç»Ÿä¸€ç¦»æ•£æ‰€æœ‰å‡ºç°è¿‡çš„æƒå€¼
  3. **æ•´ä½“äºŒåˆ†**ï¼š
     - äºŒåˆ†æƒå€¼åŒºé—´[mid+1, r]
     - ä¿®æ”¹æ“ä½œï¼šæƒå€¼â‰¤midæ—¶åœ¨æ ‘çŠ¶æ•°ç»„æ›´æ–°å­æ ‘
     - æŸ¥è¯¢æ“ä½œï¼šè®¡ç®—è·¯å¾„ä¸Šæƒå€¼>midçš„ç‚¹æ•°ï¼Œåˆ†æµå­é—®é¢˜
  4. **æ ‘çŠ¶æ•°ç»„æ“ä½œ**ï¼š
     - `upd(dfn[u],1)`å’Œ`upd(out[u]+1,-1)`å®ç°å­æ ‘æ›´æ–°
     - `path_sum`é€šè¿‡å››ä¸ªç‚¹çš„æŸ¥è¯¢å®ç°è·¯å¾„ç»Ÿè®¡

---

## 5. ç®—æ³•å¯è§†åŒ–ï¼šåƒç´ åŠ¨ç”»æ¼”ç¤º

**åŠ¨ç”»ä¸»é¢˜**ï¼šã€ŠäºŒåˆ†æ¢é™©å®¶ã€‹8-bité£æ ¼è§£è°œæ¸¸æˆ  

**æ ¸å¿ƒæ¼”ç¤º**ï¼š  
1. **æ ‘ç»“æ„å±•ç¤º**ï¼šèŠ‚ç‚¹å‘ˆç»¿è‰²åƒç´ æ–¹å—ï¼Œæ ‘è¾¹ä¸ºæ£•è‰²ç›´çº¿ï¼Œå½“å‰æƒå€¼åŒºé—´[mid+1,r]å†…çš„èŠ‚ç‚¹é—ªçƒé»„å…‰  
2. **ä¿®æ”¹æ“ä½œ**ï¼šç‚¹å‡»èŠ‚ç‚¹æ—¶å‡ºç°"å·¥å…·å›¾æ ‡"ï¼Œæ—§å€¼ä¸‹é™æ¶ˆå¤±ï¼ˆéŸ³æ•ˆï¼šç ´ç¢å£°ï¼‰ï¼Œæ–°å€¼ä¸Šå‡ï¼ˆéŸ³æ•ˆï¼šè£…å¤‡å£°ï¼‰  
3. **æŸ¥è¯¢æ“ä½œ**ï¼šä»èµ·ç‚¹åˆ°ç»ˆç‚¹å‡ºç°è“è‰²å…‰ç‚¹ç§»åŠ¨è½¨è¿¹ï¼Œç»è¿‡æ¯ä¸ªèŠ‚ç‚¹æ—¶ï¼š  
   - æƒå€¼>midï¼šèŠ‚ç‚¹å˜çº¢å¹¶è®°å½•ï¼ˆéŸ³æ•ˆï¼šæ”¶é›†é‡‘å¸å£°ï¼‰  
   - æƒå€¼â‰¤midï¼šèŠ‚ç‚¹å˜ç°ï¼ˆéŸ³æ•ˆï¼šç‚¹å‡»å£°ï¼‰  
4. **äºŒåˆ†å†³ç­–**ï¼šå½“æ”¶é›†çš„çº¢ç‚¹â‰¥kæ—¶ï¼Œå³ä¾§åŒºé—´äº®èµ·ç»¿ç¯ï¼Œå¦åˆ™å·¦ä¾§äº®èµ·è“ç¯  

**äº¤äº’æ§åˆ¶é¢æ¿**ï¼š  
- é€Ÿåº¦æ»‘å—ï¼šè°ƒèŠ‚åŠ¨ç”»æ’­æ”¾é€Ÿåº¦  
- å•æ­¥æ‰§è¡Œï¼šæŒ‰æ–¹å‘é”®åˆ†æ­¥è§‚å¯Ÿ  
- é‡ç½®/æš‚åœï¼šæ§åˆ¶åŠ¨ç”»æµç¨‹  
- æ¨¡å¼åˆ‡æ¢ï¼šå¯¹æ¯”æ•´ä½“äºŒåˆ†ä¸æ ‘å¥—æ ‘ç®—æ³•çš„æ‰§è¡Œå·®å¼‚  

**å…³é”®å¸§ç¤ºä¾‹**ï¼š  
```
å¸§1: äºŒåˆ†åŒºé—´[50,100] - é«˜äº®æ˜¾ç¤ºå€¼åœ¨æ­¤èŒƒå›´çš„èŠ‚ç‚¹  
å¸§2: æŸ¥è¯¢è·¯å¾„Aâ†’B - è“è‰²å…‰ç‚¹æ²¿æ ‘è¾¹ç§»åŠ¨  
å¸§3: é‡åˆ°å€¼75(>50) - èŠ‚ç‚¹é—ªçƒçº¢å…‰ï¼Œè®¡æ•°å™¨+1  
å¸§4: ç´¯è®¡å€¼â‰¥k - å³ä¾§åŒºé—´[75,100]è„‰å†²é—ªçƒ  
```

---

## 6. æ‹“å±•ç»ƒä¹ ä¸ç›¸ä¼¼é—®é¢˜

**é€šç”¨æŠ€å·§è¿ç§»**ï¼š  
1. **å¸¦ä¿®åŒºé—´ç¬¬kå¤§**ï¼šP2617 Dynamic Rankingsï¼ˆåºåˆ—ç‰ˆåŸºç¡€ï¼‰  
2. **æ ‘ä¸Šè·¯å¾„ç»Ÿè®¡**ï¼šP2633 Count on a treeï¼ˆé™æ€æ ‘é“¾ç¬¬kå°ï¼‰  
3. **æ•´ä½“äºŒåˆ†åº”ç”¨**ï¼šP3332 [ZJOI2013]Kå¤§æ•°æŸ¥è¯¢ï¼ˆåŒºé—´ä¿®æ”¹ç‰ˆï¼‰  

**æ´›è°·æ¨è**ï¼š  
1. **P3384 æ ‘é“¾å‰–åˆ†**  
   ğŸ—£ï¸ æŒæ¡æ ‘å‰–æ˜¯è§£å†³æ ‘ä¸Šè·¯å¾„é—®é¢˜çš„åŸºçŸ³  
2. **P3834 é™æ€åŒºé—´ç¬¬kå°**  
   ğŸ—£ï¸ ä¸»å¸­æ ‘çš„ç»å…¸åº”ç”¨ï¼Œç†è§£æƒå€¼çº¿æ®µæ ‘æœ¬è´¨  
3. **P4175 åŸé¢˜**  
   ğŸ—£ï¸ ç”¨ä¸åŒç®—æ³•é‡å¤æäº¤ï¼Œå¯¹æ¯”æ•ˆç‡å·®å¼‚  

---

## 7. å­¦ä¹ å¿ƒå¾—ä¸ç»éªŒåˆ†äº«

**æ¥è‡ªé¢˜è§£ä½œè€…çš„è°ƒè¯•ç»éªŒ**ï¼š  
> "æˆ‘åœ¨å¤„ç†æ•´ä½“äºŒåˆ†åˆ†æµæ—¶ï¼Œå¿˜è®°æ’¤é”€æ ‘çŠ¶æ•°ç»„çš„ä¸´æ—¶ä¿®æ”¹ï¼Œå¯¼è‡´åç»­æŸ¥è¯¢ç»“æœæ±¡æŸ“ã€‚é€šè¿‡æ‰“å°æ¯æ¬¡äºŒåˆ†å‰çš„æ ‘çŠ¶æ•°ç»„çŠ¶æ€ï¼Œæœ€ç»ˆå®šä½åˆ°æœªæ’¤é”€æ“ä½œçš„é—®é¢˜ã€‚"

**Kayçš„æ€»ç»“**ï¼š  
- **è°ƒè¯•æŠ€å·§**ï¼šåœ¨é€’å½’ç®—æ³•ä¸­ï¼Œå…³é”®å˜é‡çŠ¶æ€å¯è®°å½•åœ¨æ ˆå¸§ä¸­  
- **è¾¹ç•Œæµ‹è¯•**ï¼šç‰¹åˆ«æ³¨æ„k=1ï¼ˆæœ€å¤§ï¼‰å’Œk=è·¯å¾„é•¿åº¦ï¼ˆæœ€å°ï¼‰çš„è¾¹ç•Œæƒ…å†µ  
- **æ€§èƒ½ä¼˜åŒ–**ï¼šç¦»æ•£åŒ–æ—¶é¢„å­˜æ‰€æœ‰å‡ºç°å€¼ï¼Œé¿å…å¤šæ¬¡æ’åº  

---

æŒæ¡æ ‘ä¸Šè·¯å¾„é—®é¢˜çš„æ ¸å¿ƒåœ¨äºè½¬åŒ–æ€ç»´â€”â€”å°†ä¸‰ç»´çš„æ ‘ç»“æ„é™ç»´åˆ°äºŒç»´åºåˆ—å¤„ç†ã€‚é€šè¿‡DFSåºè¿™åº§æ¡¥æ¢ï¼Œæˆ‘ä»¬èƒ½ç”¨ç†Ÿæ‚‰çš„åºåˆ—ç®—æ³•è§£å†³å¤æ‚çš„æ ‘ä¸Šé—®é¢˜ã€‚å¤šå°è¯•ä¸åŒè§£æ³•ï¼Œä½“ä¼š"æ•´ä½“äºŒåˆ†"åˆ†è€Œæ²»ä¹‹çš„æ™ºæ…§ï¼Œä½ å°†åœ¨ç®—æ³•è®¾è®¡ä¸­è·å¾—è´¨çš„é£è·ƒï¼ğŸ’ª

---
å¤„ç†ç”¨æ—¶ï¼š197.14ç§’
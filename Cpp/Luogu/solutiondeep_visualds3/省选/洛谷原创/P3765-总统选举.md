# é¢˜ç›®ä¿¡æ¯

# æ€»ç»Ÿé€‰ä¸¾

## é¢˜ç›®èƒŒæ™¯

é»‘æ¶åŠ¿åŠ›çš„åæ”»è®¡åˆ’è¢«å° C æˆåŠŸæ‘§æ¯ï¼Œé»‘æ¶åŠ¿åŠ›åªå¥½æŠ•é™ã€‚ç§‹ä¹‹å›½çš„äººæ°‘è§£æ”¾äº†ï¼Œä¸¾å›½æ¬¢åº†ã€‚æ­¤æ—¶ï¼ŒåŸç§‹ä¹‹å›½æ€»ç»Ÿå› æ²¡èƒ½å®ˆæŠ¤å¥½å›½åœŸï¼Œç”³è¯·è¾èŒï¼Œå¹¶è¯·ç§‹ä¹‹å›½äººæ°‘çš„å¤§æ•‘æ˜Ÿå° C é’¦å®šä¸‹ä¸€ä»»ã€‚

ä½œä¸ºä¸€åæ°‘ä¸»äººå£«ï¼Œå° C å†³å®šä¸¾è¡Œå…¨æ°‘å¤§é€‰æ¥å†³å®šä¸‹ä¸€ä»»ã€‚ä¸ºäº†ä½¿æœ€åæˆä¸ºæ€»ç»Ÿçš„äººå¾—åˆ°ç»å¤§å¤šæ•°äººè®¤åŒï¼Œå° C è®¤ä¸ºï¼Œä¸€ä¸ªäººå¿…é¡»è·å¾—è¶…è¿‡å…¨éƒ¨äººæ€»æ•°çš„ä¸€åŠçš„ç¥¨æ•°æ‰èƒ½æˆä¸ºæ€»ç»Ÿã€‚å¦‚æœä¸å­˜åœ¨ç¬¦åˆæ¡ä»¶çš„å€™é€‰äººï¼Œå° C åªå¥½è‡ªå·±æ¥å½“ä¸´æ—¶å¤§æ€»ç»Ÿã€‚ä¸ºäº†å°½å¯èƒ½é¿å…è¿™ç§æƒ…å†µï¼Œå° C å†³å®šå…ˆè¿›è¡Œå‡ æ¬¡å°è§„æ¨¡é¢„é€‰ï¼Œæ ¹æ®é¢„é€‰çš„æƒ…å†µï¼Œé€‰æ°‘å¯ä»¥é‡æ–°å†³å®šè‡ªå·±é€‰ç¥¨çš„å»å‘ã€‚

ç”±äºç§‹ä¹‹å›½äººæ•°è¾ƒå¤šï¼Œç»Ÿè®¡æŠ•ç¥¨ç»“æœå’Œé€‰ç¥¨å˜æ›´ä¹Ÿæˆä¸ºäº†éº»çƒ¦çš„äº‹æƒ…ï¼Œå° C æ‰¾åˆ°äº†ä½ ï¼Œè®©ä½ å¸®ä»–è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

## é¢˜ç›®æè¿°

ç§‹ä¹‹å›½å…±æœ‰ $n$ ä¸ªäººï¼Œåˆ†åˆ«ç¼–å·ä¸º $1,2,â€¦,n$ï¼Œä¸€å¼€å§‹æ¯ä¸ªäººéƒ½æŠ•äº†ä¸€ç¥¨ï¼ŒèŒƒå›´ $1 \sim n$ï¼Œè¡¨ç¤ºæ”¯æŒå¯¹åº”ç¼–å·çš„äººå½“æ€»ç»Ÿã€‚

å…±æœ‰ $m$ æ¬¡é¢„é€‰ï¼Œæ¯æ¬¡é€‰å–ç¼–å· $[l_i,r_i]$ å†…çš„é€‰æ°‘å±•å¼€å°è§„æ¨¡é¢„é€‰ï¼Œåœ¨è¯¥åŒºé—´å†…è·å¾—è¶…è¿‡åŒºé—´å¤§å°ä¸€åŠçš„ç¥¨çš„äººè·èƒœã€‚å¦‚æœæ²¡æœ‰äººè·èƒœï¼Œåˆ™ç”±å° C é’¦å®šä¸€ä½å€™é€‰è€…è·å¾—æ­¤æ¬¡é¢„é€‰çš„èƒœåˆ©ï¼ˆè·èƒœè€…å¯ä»¥ä¸åœ¨è¯¥åŒºé—´å†…ï¼‰ï¼Œæ¯æ¬¡é¢„é€‰çš„ç»“æœéœ€è¦å…¬å¸ƒå‡ºæ¥ï¼Œå¹¶ä¸”æ¯æ¬¡ä¼šæœ‰ $k_i$ ä¸ªäººå†³å®šå°†ç¥¨æ”¹æŠ•å‘è¯¥æ¬¡é¢„é€‰çš„è·èƒœè€…ã€‚

å…¨éƒ¨é¢„é€‰ç»“æŸåï¼Œå…¬å¸ƒæœ€åæˆä¸ºæ€»ç»Ÿçš„å€™é€‰äººã€‚

## è¯´æ˜/æç¤º

å¯¹äºå‰ $20 \%$ çš„æ•°æ®ï¼Œ$1 \leq n,m \leq 5000$ã€‚

å¯¹äºå‰ $40 \%$ çš„æ•°æ®ï¼Œ$1 \leq n,m \leq 50000$ï¼Œ$\sum k_i \leq 50000$ã€‚

å¯¹äºå‰ $50 \%$ çš„æ•°æ®ï¼Œ$1 \leq n,m \leq {10}^5$ï¼Œ$\sum k_i \leq 2 \times {10}^5$ã€‚

å¯¹äºæ•°æ®ç‚¹ 6~7ï¼Œä¿è¯æ‰€æœ‰é€‰ç¥¨å§‹ç»ˆåœ¨ $1 \sim 10$ ä¹‹é—´ã€‚

å¯¹äº $100 \%$ çš„æ•°æ®ï¼Œ$1 \leq n,m \leq 5 \times {10}^5$ï¼Œ$\sum k_i \leq 10^6$ï¼Œ$1 \leq l_i \leq r_i \leq n$ï¼Œ$1 \leq s_i \leq n$ã€‚

## æ ·ä¾‹ #1

### è¾“å…¥

```
5 4
1 2 3 4 5
1 2 1 1 3
5 5 1 2 2 4
2 4 2 0
3 4 2 1 4```

### è¾“å‡º

```
1
5
5
2
-1```

# AIåˆ†æç»“æœ

# ğŸ’¡ Kayçš„C++ç®—æ³•è§£æï¼šæ€»ç»Ÿé€‰ä¸¾ æ·±å…¥å­¦ä¹ æŒ‡å— ğŸ’¡


## 1. é¢˜ç›®è§£è¯»ä¸æ ¸å¿ƒç®—æ³•è¯†åˆ«

âœ¨ **æœ¬é¢˜ä¸»è¦è€ƒå¯Ÿ**ï¼šæ‘©å°”æŠ•ç¥¨æ³•ï¼ˆMoore Votingï¼‰+ å¹³è¡¡æ ‘åº”ç”¨ + éšæœºåŒ–ç­–ç•¥  

ğŸ—£ï¸ **åˆæ­¥åˆ†æ**ï¼š  
è§£å†³â€œæ€»ç»Ÿé€‰ä¸¾â€çš„å…³é”®ï¼Œåœ¨äºå¿«é€Ÿæ‰¾åˆ°**åŒºé—´å†…å‡ºç°æ¬¡æ•°è¶…è¿‡ä¸€åŠçš„æ•°**ï¼ˆæˆ‘ä»¬å«å®ƒâ€œç»å¯¹ä¼—æ•°â€ï¼‰ã€‚è¿™é‡Œç”¨åˆ°ä¸¤ä¸ªæ ¸å¿ƒæŠ€å·§ï¼š  
1. **æ‘©å°”æŠ•ç¥¨æ³•**ï¼šåƒâ€œä¸¤ä¸¤æŠµæ¶ˆæ¸¸æˆâ€â€”â€”ä¸åŒå€™é€‰äººçš„é€‰ç¥¨ä¸¤ä¸¤æŠµæ¶ˆï¼Œæœ€åå‰©ä¸‹çš„å€™é€‰äººå¤§æ¦‚ç‡æ˜¯ç»å¯¹ä¼—æ•°ï¼ˆä½†éœ€éªŒè¯ï¼‰ã€‚è¿™ä¸ªæ–¹æ³•çš„æ ¸å¿ƒæ˜¯â€œåŒåŠ å¼‚å‡â€ï¼Œèƒ½çº¿æ€§æ—¶é—´æ‰¾åˆ°å€™é€‰è€…ã€‚  
2. **å¹³è¡¡æ ‘/åæ¬¡æ ‘**ï¼šç”¨äºéªŒè¯å€™é€‰è€…çš„çœŸå®å¾—ç¥¨ç‡ï¼ˆæ¯”å¦‚æŸ¥è¯¢åŒºé—´[L,R]å†…æŸå€™é€‰äººçš„ç¥¨æ•°ï¼‰ã€‚  
3. **éšæœºåŒ–ç­–ç•¥**ï¼šå¦‚æœç»å¯¹ä¼—æ•°å­˜åœ¨ï¼Œéšæœºé€‰10~20ä¸ªé€‰æ°‘ï¼Œé€‰ä¸­ä¼—æ•°çš„æ¦‚ç‡æé«˜ï¼ˆè¶…è¿‡ä¸€åŠçš„è¯ï¼Œæ¯æ¬¡é€‰ä¸­çš„æ¦‚ç‡>50%ï¼Œé€‰20æ¬¡å‡ºé”™æ¦‚ç‡<ç™¾ä¸‡åˆ†ä¹‹ä¸€ï¼‰ã€‚  

æœ¬é¢˜çš„æ ¸å¿ƒæ€è·¯åˆ†ä¸¤æ­¥ï¼š  
- **æ‰¾å€™é€‰**ï¼šç”¨çº¿æ®µæ ‘ç»´æŠ¤æ‘©å°”æŠ•ç¥¨çš„ç»“æœï¼ˆæ¯ä¸ªåŒºé—´çš„å€™é€‰è€…åŠæŠµæ¶ˆåçš„å‰©ä½™ç¥¨æ•°ï¼‰ï¼Œæˆ–éšæœºé€‰å‡ ä¸ªé€‰æ°‘å½“å€™é€‰ï¼›  
- **éªŒçœŸå‡**ï¼šç”¨å¹³è¡¡æ ‘æŸ¥è¯¢å€™é€‰è€…åœ¨åŒºé—´å†…çš„çœŸå®ç¥¨æ•°ï¼Œè¶…è¿‡ä¸€åŠåˆ™åˆæ³•ã€‚  

**å¯è§†åŒ–è®¾è®¡æ€è·¯**ï¼š  
æˆ‘ä»¬ä¼šç”¨**8ä½åƒç´ é£**æ¨¡æ‹Ÿâ€œé€‰ç¥¨æŠµæ¶ˆæ¸¸æˆâ€ï¼š  
- ç”¨ä¸åŒé¢œè‰²çš„åƒç´ å—ä»£è¡¨ä¸åŒå€™é€‰äººï¼›  
- æ¯ä¸¤ä¸ªä¸åŒé¢œè‰²çš„å—â€œç¢°æ’æŠµæ¶ˆâ€ï¼ˆæ¶ˆå¤±åŠ¨ç”»+â€œå®â€çš„éŸ³æ•ˆï¼‰ï¼›  
- æœ€åå‰©ä¸‹çš„å—é«˜äº®ï¼Œç„¶åç”¨â€œå¹³è¡¡æ ‘è®¡æ•°å™¨â€æ˜¾ç¤ºå…¶çœŸå®æ•°é‡ï¼ˆè‹¥è¶…è¿‡ä¸€åŠï¼Œæ’­æ”¾â€œèƒœåˆ©éŸ³æ•ˆâ€ï¼‰ï¼›  
- æ”¯æŒå•æ­¥æ‰§è¡Œã€è‡ªåŠ¨æ’­æ”¾ï¼ˆåƒâ€œè´ªåƒè›‡AIâ€ä¸€æ ·é€æ­¥æŠµæ¶ˆï¼‰ï¼Œè¿˜æœ‰â€œé‡ç½®â€æŒ‰é’®é‡æ–°æ¼”ç¤ºã€‚  


## 2. ç²¾é€‰ä¼˜è´¨é¢˜è§£å‚è€ƒ

### é¢˜è§£ä¸€ï¼šéšæœºåŒ–+å¹³è¡¡æ ‘ï¼ˆæ¥æºï¼šYnoiï¼Œèµ40ï¼‰  
* **ç‚¹è¯„**ï¼š  
  è¿™é“é¢˜çš„â€œæç®€è§£æ³•â€ï¼æ€è·¯éå¸¸å·§å¦™â€”â€”æ—¢ç„¶ç»å¯¹ä¼—æ•°è¶…è¿‡ä¸€åŠï¼Œéšæœºé€‰14ä¸ªé€‰æ°‘ï¼Œå…¶ä¸­å¿…æœ‰ä¸€ä¸ªæ˜¯ä¼—æ•°ï¼ˆæ¦‚ç‡æé«˜ï¼‰ã€‚ç”¨`pb_ds`çš„çº¢é»‘æ ‘ï¼ˆ`tree`ï¼‰ç»´æŠ¤æ¯ä¸ªå€™é€‰äººçš„é€‰æ°‘åˆ—è¡¨ï¼ŒæŸ¥è¯¢åŒºé—´ç¥¨æ•°åªéœ€`order_of_key(r+1) - order_of_key(l)`ï¼ˆç±»ä¼¼äºŒåˆ†æ‰¾æ’åï¼‰ã€‚ä»£ç åªæœ‰å‡ åè¡Œï¼Œé€»è¾‘æ¸…æ™°ï¼Œè·‘èµ·æ¥å¾ˆå¿«ï¼ˆè™½ç„¶ç†è®ºå¤æ‚åº¦æ˜¯O(m*K*logn)ï¼Œä½†K=14å¾ˆå°ï¼Œå®é™…æ•ˆç‡æé«˜ï¼‰ã€‚  


### é¢˜è§£äºŒï¼šçº¿æ®µæ ‘+æ‘©å°”æŠ•ç¥¨+Splayï¼ˆæ¥æºï¼šLengChuï¼Œèµ39ï¼‰  
* **ç‚¹è¯„**ï¼š  
  è¿™æ˜¯æœ¬é¢˜çš„â€œæ ‡å‡†è§£æ³•â€ï¼Œå®Œç¾ç»“åˆäº†æ‘©å°”æŠ•ç¥¨å’Œçº¿æ®µæ ‘ã€‚çº¿æ®µæ ‘æ¯ä¸ªèŠ‚ç‚¹ç»´æŠ¤ä¸¤ä¸ªå€¼ï¼š`num`ï¼ˆåŒºé—´å€™é€‰è€…ï¼‰å’Œ`cnt`ï¼ˆæŠµæ¶ˆåçš„å‰©ä½™ç¥¨æ•°ï¼‰ã€‚åˆå¹¶åŒºé—´æ—¶ï¼Œè‹¥å·¦å³å­èŠ‚ç‚¹çš„å€™é€‰è€…ç›¸åŒï¼Œåˆ™`cnt`ç›¸åŠ ï¼›å¦åˆ™å–`cnt`å¤§çš„å€™é€‰è€…ï¼Œ`cnt`ç›¸å‡ã€‚ç„¶åç”¨Splayæ ‘éªŒè¯å€™é€‰è€…çš„çœŸå®ç¥¨æ•°ã€‚æ€è·¯ä¸¥è°¨ï¼Œè¦†ç›–äº†æ‰€æœ‰æƒ…å†µï¼Œæ˜¯ç†è§£æ‘©å°”æŠ•ç¥¨+çº¿æ®µæ ‘çš„ç»ä½³ä¾‹å­ï¼ˆè™½ç„¶ä»£ç é‡å¤§ï¼Œä½†ç»“æ„æ¸…æ™°ï¼‰ã€‚  


## 3. æ ¸å¿ƒéš¾ç‚¹è¾¨æä¸è§£é¢˜ç­–ç•¥

### å…³é”®ç‚¹1ï¼šå¦‚ä½•é«˜æ•ˆæ‰¾åˆ°å€™é€‰è€…ï¼Ÿ  
- **é—®é¢˜**ï¼šç›´æ¥æ‰¾åŒºé—´ç»å¯¹ä¼—æ•°çš„æ—¶é—´å¤æ‚åº¦å¤ªé«˜ï¼ˆé™æ€åˆ†å—éƒ½è¦O(âˆšn)ï¼‰ã€‚  
- **è§£å†³**ï¼š  
  - æ‘©å°”æŠ•ç¥¨+çº¿æ®µæ ‘ï¼šåˆ©ç”¨æ‘©å°”æŠ•ç¥¨çš„å¯åŠ æ€§ï¼Œçº¿æ®µæ ‘ç»´æŠ¤æ¯ä¸ªåŒºé—´çš„å€™é€‰è€…ï¼ŒæŸ¥è¯¢æ—¶åˆå¹¶åŒºé—´ç»“æœï¼Œå¾—åˆ°å…¨å±€å€™é€‰è€…ï¼ˆO(logn)æ—¶é—´ï¼‰ã€‚  
  - éšæœºåŒ–ï¼šéšæœºé€‰Kä¸ªé€‰æ°‘ï¼ˆK=14~20ï¼‰ï¼Œå€™é€‰è€…å¿…åœ¨å…¶ä¸­ï¼ˆæ¦‚ç‡æé«˜ï¼‰ï¼Œæ—¶é—´O(K)ã€‚  


### å…³é”®ç‚¹2ï¼šå¦‚ä½•å¿«é€ŸéªŒè¯å€™é€‰è€…çš„ç¥¨æ•°ï¼Ÿ  
- **é—®é¢˜**ï¼šåŠ¨æ€ä¿®æ”¹ä¸‹ï¼ŒæŸ¥è¯¢åŒºé—´å†…æŸæ•°çš„å‡ºç°æ¬¡æ•°éœ€è¦é«˜æ•ˆæ•°æ®ç»“æ„ã€‚  
- **è§£å†³**ï¼š  
  - å¹³è¡¡æ ‘/åæ¬¡æ ‘ï¼šæ¯ä¸ªå€™é€‰äººç»´æŠ¤ä¸€æ£µå¹³è¡¡æ ‘ï¼ˆå­˜å‚¨å…¶é€‰æ°‘çš„ç¼–å·ï¼‰ï¼ŒæŸ¥è¯¢åŒºé—´[L,R]çš„ç¥¨æ•°å°±æ˜¯`rank(R) - rank(L-1)`ï¼ˆ`rank(x)`è¡¨ç¤ºâ‰¤xçš„å…ƒç´ ä¸ªæ•°ï¼‰ã€‚`pb_ds`çš„`tree`æˆ–æ‰‹å†™Splayéƒ½å¯ä»¥å®ç°ã€‚  


### å…³é”®ç‚¹3ï¼šå¦‚ä½•å¤„ç†åŠ¨æ€ä¿®æ”¹ï¼Ÿ  
- **é—®é¢˜**ï¼šå½“é€‰æ°‘æ”¹æŠ•æ—¶ï¼Œéœ€è¦æ›´æ–°çº¿æ®µæ ‘å’Œå¹³è¡¡æ ‘ã€‚  
- **è§£å†³**ï¼š  
  - çº¿æ®µæ ‘ï¼šå•ç‚¹ä¿®æ”¹ï¼ˆæ›´æ–°è¯¥é€‰æ°‘çš„å€™é€‰äººï¼Œé‡æ–°åˆå¹¶çˆ¶èŠ‚ç‚¹çš„`num`å’Œ`cnt`ï¼‰ã€‚  
  - å¹³è¡¡æ ‘ï¼šä»åŸå€™é€‰äººçš„æ ‘ä¸­åˆ é™¤è¯¥é€‰æ°‘ç¼–å·ï¼Œæ’å…¥åˆ°æ–°å€™é€‰äººçš„æ ‘ä¸­ã€‚  


### âœ¨ è§£é¢˜æŠ€å·§æ€»ç»“  
- **æ‘©å°”æŠ•ç¥¨æ³•**ï¼šæ‰¾ç»å¯¹ä¼—æ•°çš„ç¥å™¨ï¼Œè®°å¾—æœ€åè¦éªŒè¯ï¼ˆå› ä¸ºå¯èƒ½æ²¡æœ‰ç»å¯¹ä¼—æ•°ï¼‰ã€‚  
- **å¹³è¡¡æ ‘çš„æ’åæ“ä½œ**ï¼šåŠ¨æ€æŸ¥è¯¢åŒºé—´å†…æŸæ•°çš„å‡ºç°æ¬¡æ•°ï¼Œç”¨`rank(r) - rank(l-1)`ã€‚  
- **éšæœºåŒ–çš„åº”ç”¨**ï¼šå½“é—®é¢˜æœ‰æ¦‚ç‡æ€§è´¨æ—¶ï¼ˆæ¯”å¦‚ä¼—æ•°è¶…è¿‡ä¸€åŠï¼‰ï¼ŒéšæœºåŒ–èƒ½æå¤§ç®€åŒ–ä»£ç ï¼Œä¸”æ•ˆç‡å¾ˆé«˜ã€‚  


## 4. C++æ ¸å¿ƒä»£ç å®ç°èµæ

### æœ¬é¢˜é€šç”¨æ ¸å¿ƒC++å®ç°å‚è€ƒï¼ˆéšæœºåŒ–+pb_dså¹³è¡¡æ ‘ï¼‰  
* **è¯´æ˜**ï¼šç»¼åˆYnoiçš„éšæœºåŒ–æ€è·¯ï¼Œç”¨`pb_ds`çš„çº¢é»‘æ ‘ç»´æŠ¤é€‰æ°‘åˆ—è¡¨ï¼Œä»£ç ç®€æ´é«˜æ•ˆã€‚  
* **å®Œæ•´æ ¸å¿ƒä»£ç **ï¼š  
```cpp
#include <iostream>
#include <cstdlib>
#include <ctime>
#include <ext/pb_ds/assoc_container.hpp>
#include <ext/pb_ds/tree_policy.hpp>
using namespace std;
using namespace __gnu_pbds;

typedef tree<int, null_type, less<int>, rb_tree_tag, tree_order_statistics_node_update> Tree;
const int MAXN = 500005;
Tree tr[MAXN];
int a[MAXN], n, m;
const int K = 14; // éšæœºæ¬¡æ•°

// æŸ¥è¯¢xåœ¨åŒºé—´[l,r]çš„å‡ºç°æ¬¡æ•°
inline int query_count(int x, int l, int r) {
    return tr[x].order_of_key(r + 1) - tr[x].order_of_key(l);
}

// éšæœºæ‰¾å€™é€‰è€…
inline int find_candidate(int l, int r) {
    int len = r - l + 1;
    for (int i = 0; i < K; ++i) {
        int pos = l + rand() % len;
        int x = a[pos];
        if (query_count(x, l, r) > len / 2) {
            return x;
        }
    }
    return -1; // æ²¡æœ‰æ‰¾åˆ°
}

int main() {
    srand(time(0));
    ios::sync_with_stdio(false);
    cin.tie(0);
    cin >> n >> m;
    for (int i = 1; i <= n; ++i) {
        cin >> a[i];
        tr[a[i]].insert(i);
    }
    while (m--) {
        int l, r, s, k;
        cin >> l >> r >> s >> k;
        int candidate = find_candidate(l, r);
        int win = (candidate == -1) ? s : candidate;
        cout << win << '\n';
        // å¤„ç†ä¿®æ”¹
        for (int i = 0; i < k; ++i) {
            int x;
            cin >> x;
            tr[a[x]].erase(x); // ä»åŸå€™é€‰äººçš„æ ‘ä¸­åˆ é™¤
            a[x] = win;
            tr[a[x]].insert(x); // æ’å…¥åˆ°æ–°å€™é€‰äººçš„æ ‘ä¸­
        }
    }
    // æœ€åæŸ¥è¯¢å…¨å±€
    int final_candidate = find_candidate(1, n);
    cout << (final_candidate == -1 ? -1 : final_candidate) << '\n';
    return 0;
}
```
* **ä»£ç è§£è¯»æ¦‚è¦**ï¼š  
  1. ç”¨`pb_ds`çš„`tree`ç»´æŠ¤æ¯ä¸ªå€™é€‰äººçš„é€‰æ°‘ç¼–å·ï¼ˆ`tr[x]`å­˜å‚¨æ”¯æŒxçš„é€‰æ°‘ï¼‰ï¼›  
  2. `find_candidate`éšæœºé€‰Kä¸ªé€‰æ°‘ï¼ŒéªŒè¯æ¯ä¸ªé€‰æ°‘çš„å€™é€‰äººæ˜¯å¦æ˜¯ç»å¯¹ä¼—æ•°ï¼›  
  3. å¤„ç†ä¿®æ”¹æ—¶ï¼Œæ›´æ–°`a[x]`ï¼ˆé€‰æ°‘xçš„å€™é€‰äººï¼‰ï¼Œå¹¶æ›´æ–°å¯¹åº”çš„`tr`æ ‘ï¼›  
  4. æœ€åæŸ¥è¯¢å…¨å±€çš„ç»å¯¹ä¼—æ•°ã€‚  


### é¢˜è§£ä¸€ï¼ˆéšæœºåŒ–ï¼‰æ ¸å¿ƒä»£ç ç‰‡æ®µèµæ  
* **äº®ç‚¹**ï¼šéšæœºåŒ–+`pb_ds`å¹³è¡¡æ ‘ï¼Œä»£ç æç®€ã€‚  
* **æ ¸å¿ƒä»£ç ç‰‡æ®µ**ï¼š  
```cpp
const int K = 14;
inline int find_candidate(int l, int r) {
    int len = r - l + 1;
    for (int i = 0; i < K; ++i) {
        int pos = l + rand() % len;
        int x = a[pos];
        if (tr[x].order_of_key(r + 1) - tr[x].order_of_key(l) > len / 2) {
            return x;
        }
    }
    return -1;
}
```
* **ä»£ç è§£è¯»**ï¼š  
  - `rand() % len`ç”Ÿæˆ[l, r]å†…çš„éšæœºä½ç½®`pos`ï¼›  
  - `tr[x].order_of_key(y)`è¿”å›`tr[x]`ä¸­å°äºyçš„å…ƒç´ ä¸ªæ•°ï¼ˆç±»ä¼¼äºŒåˆ†æ‰¾æ’åï¼‰ï¼›  
  - `order_of_key(r+1) - order_of_key(l)`å°±æ˜¯xåœ¨[l,r]çš„å‡ºç°æ¬¡æ•°ï¼ˆå› ä¸º`tr[x]`å­˜å‚¨çš„æ˜¯æ”¯æŒxçš„é€‰æ°‘ç¼–å·ï¼Œæ’å¥½åºçš„ï¼‰ï¼›  
  - è‹¥æ¬¡æ•°è¶…è¿‡`len/2`ï¼Œç›´æ¥è¿”å›xï¼ˆç»å¯¹ä¼—æ•°ï¼‰ã€‚  


### é¢˜è§£äºŒï¼ˆçº¿æ®µæ ‘+æ‘©å°”æŠ•ç¥¨ï¼‰æ ¸å¿ƒä»£ç ç‰‡æ®µèµæ  
* **äº®ç‚¹**ï¼šçº¿æ®µæ ‘ç»´æŠ¤æ‘©å°”æŠ•ç¥¨ç»“æœï¼Œä¸¥è°¨å¤„ç†æ‰€æœ‰æƒ…å†µã€‚  
* **æ ¸å¿ƒä»£ç ç‰‡æ®µ**ï¼š  
```cpp
// çº¿æ®µæ ‘èŠ‚ç‚¹ï¼šnumæ˜¯å€™é€‰è€…ï¼Œcntæ˜¯æŠµæ¶ˆåçš„å‰©ä½™ç¥¨æ•°
struct Node {
    int num, cnt;
} tree[MAXN << 2];

// åˆå¹¶å·¦å³å­èŠ‚ç‚¹
inline void pushup(int id) {
    int ls = id << 1, rs = id << 1 | 1;
    if (tree[ls].num == tree[rs].num) {
        tree[id].num = tree[ls].num;
        tree[id].cnt = tree[ls].cnt + tree[rs].cnt;
    } else {
        if (tree[ls].cnt >= tree[rs].cnt) {
            tree[id].num = tree[ls].num;
            tree[id].cnt = tree[ls].cnt - tree[rs].cnt;
        } else {
            tree[id].num = tree[rs].num;
            tree[id].cnt = tree[rs].cnt - tree[ls].cnt;
        }
    }
}

// æŸ¥è¯¢åŒºé—´[l,r]çš„å€™é€‰è€…
Node query(int id, int l, int r, int ql, int qr) {
    if (ql <= l && r <= qr) {
        return tree[id];
    }
    int mid = (l + r) >> 1;
    if (qr <= mid) return query(id << 1, l, mid, ql, qr);
    if (ql > mid) return query(id << 1 | 1, mid + 1, r, ql, qr);
    Node left = query(id << 1, l, mid, ql, mid);
    Node right = query(id << 1 | 1, mid + 1, r, mid + 1, qr);
    Node res;
    if (left.num == right.num) {
        res.num = left.num;
        res.cnt = left.cnt + right.cnt;
    } else {
        if (left.cnt >= right.cnt) {
            res.num = left.num;
            res.cnt = left.cnt - right.cnt;
        } else {
            res.num = right.num;
            res.cnt = right.cnt - left.cnt;
        }
    }
    return res;
}
```
* **ä»£ç è§£è¯»**ï¼š  
  - çº¿æ®µæ ‘æ¯ä¸ªèŠ‚ç‚¹å­˜å‚¨`num`ï¼ˆåŒºé—´å€™é€‰è€…ï¼‰å’Œ`cnt`ï¼ˆæŠµæ¶ˆåçš„å‰©ä½™ç¥¨æ•°ï¼‰ï¼›  
  - `pushup`åˆå¹¶å·¦å³å­èŠ‚ç‚¹ï¼šè‹¥å€™é€‰è€…ç›¸åŒï¼Œ`cnt`ç›¸åŠ ï¼›å¦åˆ™å–`cnt`å¤§çš„å€™é€‰è€…ï¼Œ`cnt`ç›¸å‡ï¼›  
  - `query`å‡½æ•°åˆå¹¶åŒºé—´ç»“æœï¼Œå¾—åˆ°æ•´ä¸ªæŸ¥è¯¢åŒºé—´çš„å€™é€‰è€…ï¼ˆO(logn)æ—¶é—´ï¼‰ï¼›  
  - ä¹‹åéœ€è¦ç”¨å¹³è¡¡æ ‘éªŒè¯å€™é€‰è€…çš„çœŸå®æ¬¡æ•°ï¼ˆé¿å…æ²¡æœ‰ç»å¯¹ä¼—æ•°çš„æƒ…å†µï¼‰ã€‚  


## 5. ç®—æ³•å¯è§†åŒ–ï¼šåƒç´ åŠ¨ç”»æ¼”ç¤º

### åŠ¨ç”»ä¸»é¢˜ï¼šâ€œåƒç´ é€‰æ°‘æŠµæ¶ˆå¤§æˆ˜â€  
### æ ¸å¿ƒæ¼”ç¤ºå†…å®¹ï¼š  
1. **åœºæ™¯åˆå§‹åŒ–**ï¼š  
   - å±å¹•æ˜¾ç¤º8ä½åƒç´ é£æ ¼çš„â€œé€‰æ°‘ç½‘æ ¼â€ï¼ˆæ¯ä¸ªåƒç´ å—ä»£è¡¨ä¸€ä¸ªé€‰æ°‘ï¼Œé¢œè‰²ä»£è¡¨å€™é€‰äººï¼‰ï¼›  
   - åº•éƒ¨æœ‰â€œæ§åˆ¶é¢æ¿â€ï¼šå¼€å§‹/æš‚åœã€å•æ­¥ã€é‡ç½®æŒ‰é’®ï¼Œé€Ÿåº¦æ»‘å—ï¼ˆ1x~5xï¼‰ï¼›  
   - æ’­æ”¾8ä½é£æ ¼çš„èƒŒæ™¯éŸ³ä¹ï¼ˆåƒFCæ¸¸æˆçš„BGMï¼‰ã€‚  

2. **æ‘©å°”æŠ•ç¥¨æ¼”ç¤º**ï¼š  
   - ç‚¹å‡»â€œå¼€å§‹â€ï¼Œåƒç´ å—å¼€å§‹â€œä¸¤ä¸¤æŠµæ¶ˆâ€ï¼šä¸åŒé¢œè‰²çš„å—ç¢°æ’åæ¶ˆå¤±ï¼ˆä¼´éšâ€œå®â€çš„éŸ³æ•ˆï¼‰ï¼›  
   - ç›¸åŒé¢œè‰²çš„å—â€œç²˜åœ¨ä¸€èµ·â€ï¼ˆ`cnt`å¢åŠ ï¼Œæ˜¾ç¤ºæ•°å­—+1ï¼‰ï¼›  
   - æœ€åå‰©ä¸‹çš„å—é«˜äº®ï¼ˆæ¯”å¦‚çº¢è‰²ï¼‰ï¼Œæ—è¾¹æ˜¾ç¤ºâ€œå€™é€‰è€…ï¼šçº¢è‰²â€ã€‚  

3. **å¹³è¡¡æ ‘éªŒè¯**ï¼š  
   - é«˜äº®å—ä¸‹æ–¹å¼¹å‡ºâ€œå¹³è¡¡æ ‘è®¡æ•°å™¨â€ï¼Œæ˜¾ç¤ºçº¢è‰²å—çš„çœŸå®æ•°é‡ï¼ˆæ¯”å¦‚â€œ15/25â€ï¼‰ï¼›  
   - è‹¥æ•°é‡è¶…è¿‡ä¸€åŠï¼ˆ13ï¼‰ï¼Œæ’­æ”¾â€œèƒœåˆ©éŸ³æ•ˆâ€ï¼ˆä¸Šå‡çš„â€œå®~â€ï¼‰ï¼Œå¹¶æ˜¾ç¤ºâ€œåˆæ³•ä¼—æ•°ï¼â€ï¼›  
   - è‹¥æœªè¶…è¿‡ï¼Œæ’­æ”¾â€œæç¤ºéŸ³æ•ˆâ€ï¼ˆçŸ­ä¿ƒçš„â€œå˜€â€ï¼‰ï¼Œå¹¶æ˜¾ç¤ºâ€œæ— ç»å¯¹ä¼—æ•°â€ã€‚  

4. **äº¤äº’è®¾è®¡**ï¼š  
   - å•æ­¥æ‰§è¡Œï¼šç‚¹å‡»â€œå•æ­¥â€ï¼Œæ¯æ¬¡åªæŠµæ¶ˆä¸€å¯¹å—ï¼›  
   - è‡ªåŠ¨æ’­æ”¾ï¼šç‚¹å‡»â€œè‡ªåŠ¨â€ï¼Œåƒâ€œè´ªåƒè›‡AIâ€ä¸€æ ·é€æ­¥æŠµæ¶ˆï¼ˆé€Ÿåº¦å¯è°ƒï¼‰ï¼›  
   - é‡ç½®ï¼šç‚¹å‡»â€œé‡ç½®â€ï¼Œå›åˆ°åˆå§‹çŠ¶æ€ï¼Œé‡æ–°æ¼”ç¤ºã€‚  


## 6. æ‹“å±•ç»ƒä¹ ä¸ç›¸ä¼¼é—®é¢˜æ€è€ƒ

### é€šç”¨æ€è·¯è¿ç§»  
- æ‘©å°”æŠ•ç¥¨æ³•ï¼šé€‚ç”¨äºæ‰¾ç»å¯¹ä¼—æ•°ï¼ˆå‡ºç°æ¬¡æ•°è¶…è¿‡ä¸€åŠï¼‰ï¼Œæ¯”å¦‚ç»Ÿè®¡æŠ•ç¥¨ç»“æœã€æ‰¾æ•°ç»„ä¸­çš„ä¸»è¦å…ƒç´ ã€‚  
- å¹³è¡¡æ ‘çš„æ’åæ“ä½œï¼šé€‚ç”¨äºåŠ¨æ€æŸ¥è¯¢åŒºé—´å†…æŸæ•°çš„å‡ºç°æ¬¡æ•°ï¼Œæ¯”å¦‚ç»Ÿè®¡æŸå•†å“çš„é”€é‡åŒºé—´ã€ç›‘æ§ç”¨æˆ·çš„åœ¨çº¿æ—¶é—´ã€‚  


### æ¨èç»ƒä¹   
1. **Luogu P2397**ï¼šyyy loves Maths VI (mode)  
   - æ¨èç†ç”±ï¼šæ‘©å°”æŠ•ç¥¨æ³•çš„æ¨¡æ¿é¢˜ï¼Œç›´æ¥æ‰¾æ•°ç»„ä¸­çš„ç»å¯¹ä¼—æ•°ï¼ˆä¿è¯å­˜åœ¨ï¼‰ï¼Œå¸®åŠ©å·©å›ºæ‘©å°”æŠ•ç¥¨çš„åŸºç¡€ã€‚  

2. **Luogu P3369**ï¼šæ™®é€šå¹³è¡¡æ ‘  
   - æ¨èç†ç”±ï¼šå¹³è¡¡æ ‘çš„æ¨¡æ¿é¢˜ï¼Œå®ç°æ’å…¥ã€åˆ é™¤ã€æŸ¥è¯¢æ’åã€æŸ¥è¯¢ç¬¬kå¤§ç­‰æ“ä½œï¼Œæ˜¯æœ¬é¢˜å¹³è¡¡æ ‘éƒ¨åˆ†çš„åŸºç¡€ã€‚  

3. **Luogu P3987**ï¼šæˆ‘æ°¸è¿œå–œæ¬¢ç‚æœµè‰~  
   - æ¨èç†ç”±ï¼šå¹³è¡¡æ ‘çš„åº”ç”¨é¢˜ï¼ŒæŸ¥è¯¢åŒºé—´å†…æŸæ•°çš„å‡ºç°æ¬¡æ•°ï¼Œç±»ä¼¼æœ¬é¢˜çš„éªŒè¯æ­¥éª¤ï¼Œå¸®åŠ©ç†Ÿæ‚‰å¹³è¡¡æ ‘çš„å®é™…ç”¨æ³•ã€‚  


## 7. å­¦ä¹ å¿ƒå¾—ä¸ç»éªŒåˆ†äº«  

### å‚è€ƒç»éªŒï¼ˆæ¥è‡ªYnoiï¼‰  
> â€œå…¶å®æ²¡å¿…è¦å†™çº¿æ®µæ ‘ï¼Œåªç”¨éšæœºåŒ–å°±è¡Œäº†ï¼Œæ¯æ¬¡åœ¨åŒºé—´é‡Œéšæœºå–kä¸ªæ•°ï¼Œç„¶åç”¨å¹³è¡¡æ ‘åˆ¤æ–­æ˜¯å¦åœ¨åŒºé—´é‡Œå‡ºç°æ¬¡æ•°è¶…è¿‡ä¸€åŠå³å¯ã€‚è¿™æ ·çš„è¯ï¼Œå¦‚æœå‡ºç°æ¬¡æ•°å¤§äºä¸€åŠæ˜¯æ•°å­˜åœ¨ï¼Œæ²¡æœ‰éšæœºåˆ°å‡ºç°å¤§äºä¸€åŠæ•°çš„æ¦‚ç‡è‚¯å®šå°äº1/2^kã€‚ç¨³å¦¥èµ·è§kå–30æ¯”è¾ƒå¥½ï¼Œä½†æœ¬é¢˜kå–14å°±å¤Ÿäº†ã€‚â€  

* **ç‚¹è¯„**ï¼š  
  è¿™ä½ä½œè€…çš„ç»éªŒéå¸¸å®ç”¨â€”â€”**ä¸è¦æ€»æƒ³ç€ç”¨â€œæ ‡å‡†è§£æ³•â€ï¼Œæœ‰æ—¶å€™éšæœºåŒ–èƒ½æå¤§ç®€åŒ–é—®é¢˜**ã€‚å› ä¸ºç»å¯¹ä¼—æ•°è¶…è¿‡ä¸€åŠï¼Œéšæœºé€‰14æ¬¡ï¼Œé€‰ä¸­çš„æ¦‚ç‡æ˜¯1 - (1/2)^14 â‰ˆ 99.996%ï¼Œå‡ ä¹ä¸ä¼šå‡ºé”™ã€‚è¿™ç§â€œæ¦‚ç‡æ­£ç¡®â€çš„æ–¹æ³•åœ¨ç¼–ç¨‹ç«èµ›ä¸­å¾ˆå¸¸è§ï¼Œæ¯”å¦‚å¿«é€Ÿæ’åºçš„éšæœº pivotã€å“ˆå¸Œè¡¨çš„éšæœºç§å­ï¼Œéƒ½æ˜¯åˆ©ç”¨æ¦‚ç‡æ¥é™ä½å¤æ‚åº¦ã€‚  


## 8. æ€»ç»“  
æœ¬é¢˜çš„æ ¸å¿ƒæ˜¯**æ‘©å°”æŠ•ç¥¨æ³•**ï¼ˆæ‰¾å€™é€‰è€…ï¼‰+**å¹³è¡¡æ ‘**ï¼ˆéªŒè¯æ¬¡æ•°ï¼‰ï¼Œæˆ–è€…**éšæœºåŒ–**ï¼ˆå¿«é€Ÿæ‰¾å€™é€‰è€…ï¼‰ã€‚é€šè¿‡è¿™é“é¢˜ï¼Œä½ å¯ä»¥å­¦ä¼šï¼š  
1. æ‘©å°”æŠ•ç¥¨æ³•çš„åŸç†å’Œåº”ç”¨ï¼ˆå¯åŠ æ€§+çº¿æ®µæ ‘ç»´æŠ¤ï¼‰ï¼›  
2. å¹³è¡¡æ ‘çš„æ’åæ“ä½œï¼ˆåŠ¨æ€æŸ¥è¯¢åŒºé—´æ¬¡æ•°ï¼‰ï¼›  
3. éšæœºåŒ–çš„æŠ€å·§ï¼ˆåˆ©ç”¨æ¦‚ç‡ç®€åŒ–é—®é¢˜ï¼‰ã€‚  

è®°ä½ï¼šç¼–ç¨‹çš„å…³é”®æ˜¯**è§£å†³é—®é¢˜**ï¼Œè€Œä¸æ˜¯â€œå†™å¤æ‚çš„ä»£ç â€ã€‚æœ‰æ—¶å€™ä¸€ä¸ªç®€å•çš„éšæœºåŒ–ï¼Œå°±èƒ½æ¯”æ ‡å‡†è§£æ³•æ›´é«˜æ•ˆï¼  

ä¸‹æ¬¡æˆ‘ä»¬å†ä¸€èµ·æ¢ç´¢æ–°çš„ç¼–ç¨‹æŒ‘æˆ˜ï¼ğŸ’ª

---
å¤„ç†ç”¨æ—¶ï¼š93.60ç§’
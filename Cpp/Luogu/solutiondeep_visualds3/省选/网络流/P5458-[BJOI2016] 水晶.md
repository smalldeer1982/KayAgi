# 题目信息

# [BJOI2016] 水晶

## 题目背景

不用惊慌，今天的题都不是小强出的。  

——融入了无数心血的作品，现在却不得不亲手毁掉，难以体会他的心情啊。

——那也是没有办法的事情，能量共振不消除的话…… 

望着已经被装上炸药的水晶，02放下了望远镜，看向了手中的共振分析报告。  

还是会有一些水晶，幸存下来的…… 也许吧。

## 题目描述

地图由密铺的六边形单元组成，每个单元与其他六个单元相邻。  

为了方便起见，我们用坐标 $(x,y,z)$ 描述一个单元的位置，表示从原点开始按如图所示的 $x,y,z$ 方向各走若干步之后到达的地方。  

有可能有两个坐标描述同一个单元，比如 $(1,1,1)$ 和 $(0,0,0)$ 描述的都是原点。

![](https://cdn.luogu.com.cn/upload/image_hosting/dd1hb5vv.png)

显然 $(x,y,z)$ 单元和 $(x+1,y,z)$，$(x-1,y,z)$ ，$(x,y+1,z)$，$(x,y-1,z)$，$(x,y,z+1)$，$(x,y,z-1)$ 相邻。  

有 $N$ 块水晶位于地图的单元内，第 $i$ 块水晶位于坐标 $(x_i, y_i, z_i)$ 所表示的单元中，并拥有 $c_i$ 的价值，每个单元内部可能会有多块水晶。  

地图中，有一些单元安装有能量源。如下图，任何满足 $x+y+z$ 是 $3$ 的整数倍的坐标所描述的单元内都安装有能量源。  

![](https://cdn.luogu.com.cn/upload/image_hosting/9x4o6dhs.png)

有能量源的单元中的水晶价值将会额外增加 $10\%$。如果三块水晶所在的单元满足特定排列，那么它们将会引发共振。 

共振分两种，$a$ 共振和 $b$ 共振。  

$a$ 共振：如果三块水晶所在的单元两两相邻地排成一个三角形，那么会引起 $a$ 共振。   

![](https://cdn.luogu.com.cn/upload/image_hosting/48uc3ey4.png)

图中每一个三角形表示这三个单元各有一块水晶将会发生一个 $a$ 共振。  

$b$ 共振：如果三块水晶所在的单元依次相邻地排成一条长度为 $2$ 的直线段，且正中间的单元恰好有能量源，那么会引起b共振。  

![](https://cdn.luogu.com.cn/upload/image_hosting/2b47zl09.png)

图中粉红色线段表示这三个单元各有一块水晶将会发生一个 $b$ 共振，黑色线段表示即使这三个单元有水晶也不会发生 $b$ 共振。  

现在你要炸掉一部分水晶，使得任何共振都不会发生的前提下，剩余水晶的价值总和最大。

## 说明/提示

【样例 $1$ 说明】   

四块水晶排成一个菱形，没有 $b$ 共振，有 $2$ 处 $a$ 共振，分别是 $1,2,4$ 号水晶和 $1,3,4$ 号水晶形成的三角形。 
因此，为了消除两处 $a$ 共振，有如下 $3$ 种方案：

1. 炸掉 $1$ 号水晶，留下 $2,3,4$ 号水晶，总剩余价值 $5+7+13=25$
2. 炸掉 $4$ 号水晶，留下 $1,2,3$ 号水晶，总剩余价值 $11 \times(1+10\%)+5+7=24.1$   
3. 炸掉 $2,3$ 号水晶，留下$1,4$ 号水晶，总剩余价值 $11 \times (1+10\%)+13=25.1$  

因此我们采用第三种方案，最大总剩余价值为$25.1$。    

【数据范围】  

$1\le N \le 50000$    
$1\le c_i \le 1000$   
$-1000 \le x_i,y_i,z_i \le 1000$   

## 样例 #1

### 输入

```
4
0 0 0 11
1 0 0 5
0 1 0 7
0 0 -1 13```

### 输出

```
25.1```

# AI分析结果


### 💡 Kay的C++算法解析：[BJOI2016]水晶 深入学习指南 💡

<introduction>
大家好，我是Kay！今天我们将一起探索「[BJOI2016]水晶」这道六边形网格中的优化问题。本指南将带大家理解坐标转换技巧、共振本质的最小割建模，并通过像素动画直观感受算法流程。准备好了吗？让我们开始吧！
</introduction>

---

## 1. 题目解读与核心算法识别

✨ **本题主要考察**：`图论-网络流最小割` + `坐标转换技巧`

🗣️ **初步分析**：
> 解决水晶共振问题就像拆除多米诺骨牌的关键节点——我们需要用最小代价破坏共振链条。核心思想是通过三维坐标转二维`(x-z, y-z)`消除冗余，再按坐标和模3将点分为三类：
> - **A类**（模3=1）：共振起点（红色像素）
> - **B类**（模3=0）：能量源（黄色像素）
> - **C类**（模3=2）：共振终点（绿色像素）
> 
> 通过建立网络流模型：
> 1. 每个点拆分为入点/出点，边权为水晶价值
> 2. 源点→A类→B类→C类→汇点连INF边
> 3. 最小割值 = 需破坏的水晶总价值
> 
> **可视化设计**：
> - 8位像素网格中，用红/黄/绿三色区分点类
> - 水流动画展示S→T的流动过程
> - 当割边发生时，对应水晶像素爆炸（闪烁红光+爆破音效）
> - 胜利时播放8-bit胜利旋律

---

## 2. 精选优质题解参考

<eval_intro>
从思路清晰度、代码规范性和建模技巧等维度，我精选了三条≥4星题解：

**题解一（disangan233）**
* **点评**：思路直击核心——三维转二维+map坐标压缩堪称典范。拆点建图逻辑清晰（A→B→C链式连接），Dinic实现规范。亮点在于处理同坐标水晶的合并技巧，且边界处理严谨（如f[p[i]]<2的过滤）。实践价值高，可直接用于竞赛。

**题解二（CaoXian）**
* **点评**：对共振的数学本质（模3分类）有精彩论证，拆点建图时创新性地用结构体封装坐标。亮点在于详细推导了a/b共振的统一性，代码中特化AddEdge函数提升可读性。虽map略影响效率，但逻辑完整性极佳。

**题解三（zzw4257）**
* **点评**：通过双色染色图示直观展示共振条件（黑白点+能量源），代码简洁但关键步骤完整。亮点在于用轻量化AddEdge实现链式连接，适合初学者理解最小割建模本质。虽缺少合并优化，但核心逻辑到位。

---

## 3. 核心难点辨析与解题策略

<difficulty_intro>
攻克本题需突破三大难点：

1. **难点1：三维坐标冗余处理**
   * **分析**：多个三维坐标对应同一位置（如(1,1,1)与(0,0,0)）。优质题解统一采用`(x-z,y-z)`二维映射，配合map合并同位置水晶。
   * 💡 **学习笔记**：坐标转换是降维核心，二维化后问题复杂度骤降。

2. **难点2：共振条件统一建模**
   * **分析**：a共振（三角）和b共振（直线）本质都要求相邻的A-B-C类点。通过建立S→A→B→C→T的INF路径，将共振转化为最小割问题。
   * 💡 **学习笔记**：洞察不同现象的数学共性（模3分类）是建模关键。

3. **难点3：网络流实现优化**
   * **分析**：Dinic算法中，拆点边权=水晶价值（B类×1.1），其他边INF确保只割价值边。注意同位置水晶需先合并再建边。
   * 💡 **学习笔记**：拆点技巧精准对应"炸水晶"决策，最小割即最优解。

### ✨ 解题技巧总结
<summary_best_practices>
1. **降维映射**：三维→二维消除冗余
2. **数学归类**：模3分类统一共振条件
3. **拆点建图**：点权转边权，A-B-C链式连接
4. **合并优化**：同坐标水晶先合并再建图

---

## 4. C++核心代码实现赏析

<code_intro_overall>
**通用核心实现**（综合优质题解精华）：
```cpp
#include<bits/stdc++.h>
#define ll long long
#define db double
const int N=5e4+5, inf=1e9;
struct Point { int x,y; 
    bool operator<(Point a) const { 
        return x==a.x ? y<a.y : x<a.x; 
    }
};
std::map<Point, int> idMap; // 坐标->唯一ID

struct Edge { int to, next, f; } e[N*20];
int head[N<<1], cnt=1, sum;

inline void addEdge(int u, int v, int w) {
    e[++cnt] = {v, head[u], w}; head[u] = cnt;
    e[++cnt] = {u, head[v], 0}; head[v] = cnt; // 反向边
}

// Dinic算法实现(BFS分层+DFS增广)
int dinic(int s, int t) { /* 详见完整代码 */ }

int main() {
    int n, tot=0; Point p;
    scanf("%d", &n);
    for(int i=1; i<=n; ++i) {
        int x,y,z,c, val;
        scanf("%d%d%d%d", &x, &y, &z, &c);
        p = {x-z, y-z}; // 三维转二维
        if(!idMap.count(p)) idMap[p] = ++tot;
        val = (x+y+z) % 3 == 0 ? c*11 : c*10; // 能量源*1.1
        sum += val;
        // 此处合并同坐标水晶...
    }
    
    int S = 1, T = (tot+1)<<1;
    for(auto &point : idMap) {
        int uid = point.second;
        addEdge(uid<<1, uid<<1|1, val); // 拆点：入点→出点
        if(/*A类点*/) addEdge(S, uid<<1, inf);
        if(/*C类点*/) addEdge(uid<<1|1, T, inf);
        if(/*B类点*/) {
            for(auto &neighbor : findNeighbors(p)) { // 找六边形相邻点
                if(/*相邻A类*/) addEdge(A_id<<1|1, uid<<1, inf);
                if(/*相邻C类*/) addEdge(uid<<1|1, C_id<<1, inf);
            }
        }
    }
    printf("%.1f", (sum - dinic(S,T)) / 10.0);
}
```

<code_intro_selected>
**题解一核心片段**（disangan233）：
```cpp
add(s, a<<1, inf);     // S→A入点
add(a<<1|1, b<<1, inf);// A出点→B入点
add(b<<1|1, c<<1, inf);// B出点→C入点
add(c<<1|1, t, inf);   // C出点→T
```
* **解读**：  
  通过四个无限边构建共振链。`a<<1`与`a<<1|1`是经典拆点技巧——前者是入点，后者是出点。当A/B/C三点共存时，形成S→T通路，必须割断某点的入-出边（即炸水晶）。

* **学习笔记**：拆点边权=水晶价值，割边即破坏共振。

---

## 5. 算法可视化：像素动画演示

<visualization_intro>
**主题**：水晶消除大作战（8-bit像素风）  
**核心演示**：Dinic算法在六边形网格中寻找最小割  

### 动画帧步骤：
1. **初始化**  
   - 六边形网格渲染为像素方块（A类红/B类黄/C类绿）  
   - 控制面板：启动/暂停/步进按钮 + 速度滑块  
   - 背景播放FC风格BGM  

2. **坐标转换演示**（关键帧1）  
   - 三维坐标`(x,y,z)`飘向转换器，输出二维`(x-z,y-z)`  
   - 同坐标水晶合并时播放"叮"音效  

3. **建图阶段**（关键帧2）  
   - 红点自动连接相邻黄点→绿点，形成发光路径  
   - 能量源拆点时展示"入点/出点"分裂动画  

4. **Dinic执行**（关键帧3）  
   - 蓝色水流从S端蔓延，沿红→黄→绿路径流向T端  
   - 当水流被割边阻挡：爆炸动画 + 碎裂音效  
   - 实时显示剩余价值：`(总价值 - 割量)/10`  

5. **胜利结算**  
   - 无完整路径时播放《超级玛丽》过关音乐  
   - 幸存水晶闪烁金光  

---

## 6. 拓展练习与相似问题

<similar_problems_intro>
最小割建模是图论核心技能，以下问题助你巩固：

1. **洛谷 P2774** - 方格取数  
   *理由*：相邻格子取舍问题，同属最小割经典模型

2. **洛谷 P3355** - 骑士共存问题  
   *理由*：二分图最小割应用，训练冲突关系抽象能力

3. **洛谷 P4001** - [ICPC]狼抓兔子  
   *理由*：平面图最小割实战，深化对Dinic的理解

---

## 7. 学习心得与经验分享

<insights_intro>
来自题解作者的智慧结晶：

> **disangan233 的调试经验**：  
> "初始未处理同坐标水晶合并，导致网络流边数爆炸。建议先用map预处理坐标映射，避免重复建点。"

> **Kay的总结**：  
> 本题深刻体现了数学抽象如何简化问题——模3分类将复杂共振统一为链式结构。在调试时，可先小规模模拟坐标转换（如样例的菱形），确保建图正确再扩展。

<conclusion>
本次水晶之旅就到这里！记住：坐标转换是降维武器，最小割是破坏共振的终极炸弹。多练习网络流建模，你将成为算法爆破专家！下次挑战见！💪

---
处理用时：177.47秒
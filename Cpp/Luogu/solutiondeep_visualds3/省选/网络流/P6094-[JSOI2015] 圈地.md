# 题目信息

# [JSOI2015] 圈地

## 题目背景

JYY 在火星买了一大块矩形的地皮做房地产开发。由于地皮实在是太大了，JYY 把这块地皮划分成了 $N$ 行 $M$ 列的小方格，并在每一格中建造一栋房子。历时若干年，开发终于宣告结束，JYY 也可以把这些房子挂牌出售了。现在他找到了两位非同寻常的土豪买家：南南和强强。

麻烦的是，南南和强强是水火不容的。为了保证他们俩不发生矛盾，JYY 需要把卖给他们俩的房子用墙隔开。不过造墙是需要钱的，JYY 作为倒卖地皮的专家，自然想挣尽可能多的钱，因此他邀请到你帮他设计最优的出售方案。

## 题目描述

JYY 把这块地皮划分成了 $N$ 行 $M$ 列的矩形，且矩形的每一格中建造一栋房子。现在，南南和强强已经将他们的购买意见提交给了 JYY。对于每一栋房子，南南和强强已经给定了他们的出价（不想购买，或愿意以一定价格购买），并且由于他们已经协商好了各自的势力范围，因此不存在两个人同时想买一栋房子的情况。JYY 可以选择每一栋房子是否出售（因为不存在两个人同时想买一栋房子的情况，若 JYY 选择出售一栋房子，它的买家就是确定的）。房子卖给强强和南南以后，JYY 就能获得卖出房子出价的总和。

不过，作为售后服务，JYY 需要通过造墙（将两栋相邻的房子用一堵墙隔开）把两个人的房子完全隔开。所谓完全隔开，就是指造出的墙以及四周的边界将整个区域划分成若干个不连通的部分，每个部分里面只有一个人的房子。当然，造墙也是需要钱的，而且价格不菲。不过 JYY 当初在宣传时声称造墙完全免费，所以这部分钱只好由 JYY 自己出了。

JYY 请你为他规划每幢房子是否要卖出以及建造哪些围墙，才能使得卖房子的收益减去造围墙的花费最大。另外一个好消息是整个地皮的四周已经建好了墙，因此 JYY 可以利用这些建好的墙达到目的。下图就是用墙将区域划分成 $3$ 个不连通的部分的例子。格子中的数字代表出价（数字的含义参考输入格式），边上的数值代表造墙的价格。四周的墙（边界）本来就有，不需要 JYY 花额外的代价去建造。

![](https://cdn.luogu.com.cn/upload/image_hosting/t57031da.png)

## 说明/提示

对于 $100\%$ 的数据，$1\leq N,M\leq 200$，任何价格都不超过 $1000$。

## 样例 #1

### 输入

```
5 5
-3 7 0 0 0
8 0 7 -10 0
0 7 0 1 0
0 0 0 0 0
-8 0 0 2 10
4 50 50 1 50
50 50 1 9 50
50 50 1 1 50
2 50 50 50 50
2 50 50 50
50 50 1 1
50 1 8 1
50 50 50 50
1 50 50 50```

### 输出

```
48```

# AI分析结果


### 💡 Kay的C++算法解析：圈地 深入学习指南 💡

**引言**  
今天我们一起分析「圈地」这道网络流建模题。本指南将帮助你理解最小割的核心思想，掌握二维网格问题的建模技巧，并通过生动的像素动画直观感受算法流程。

---

## 1. 题目解读与核心算法识别

✨ **本题主要考察**：网络流/最小割

🗣️ **初步分析**：  
> 本题需要将网格划分为两个区域，最大化收益（房屋售价 - 建墙成本）。最小割算法就像精准的"水利工程师"：  
> 1. 将正收益房屋连接水源（源点），负收益房屋连接排水口（汇点）  
> 2. 相邻房屋间铺设双向管道，流量=建墙成本  
> 3. 最小割值就是总成本（未售房屋损失+建墙费）  
> 核心公式：总收益 = ∑|收益| - 最小割  
>  
> **可视化设计**：采用8-bit像素风格，网格房屋用不同颜色区分归属（源点蓝/汇点红），管道破裂时播放"咔嚓"音效，水流路径高亮显示。自动演示模式可调速观察BFS分层和DFS增广过程。

---

## 2. 精选优质题解参考

**题解一（Rusalka）**  
* **点评**：  
  思路清晰度 ★★★★☆ - 精炼点出"总收益=∑|aᵢⱼ|-最小割"核心公式  
  代码规范性 ★★★★☆ - 封装id()坐标转换函数，变量名语义明确  
  算法亮点 ★★★★★ - 完整Dinic实现，处理双向边技巧值得学习  
  实践价值 ★★★★☆ - 可直接用于竞赛，边界处理严谨  

**题解二（JohnJoeZhu）**  
* **点评**：  
  思路清晰度 ★★★★☆ - 用"割边三含义"生动解释建模思想  
  算法亮点 ★★★☆☆ - 提及弱化版题目(P2598)作对比训练  
  实践注意 ⚠️ - 使用EK算法可能被卡效率，需改用Dinic  

**题解三（辰星凌）**  
* **点评**：  
  代码规范性 ★★★★★ - 极致简洁的Dinic实现（仅50行）  
  算法亮点 ★★★★☆ - 邻接表存图方式内存效率优  
  学习提示 💡 - 适合掌握基础后研究代码优化技巧  

---

## 3. 核心难点辨析与解题策略

1. **难点1：网络流建模抽象**  
   * **分析**：将房屋买卖决策转化为图切割：源点连正收益点(容量=aᵢⱼ)，汇点连负收益点(容量=|aᵢⱼ|)，相邻点双向边(容量=墙价)  
   * 💡 **学习笔记**：最小割 = 未获得收益 + 隔离成本  

2. **难点2：双向边处理**  
   * **分析**：相邻房屋A-B需建两条边：A→B和B→A，确保无论划分方向都能正确计算隔离成本  
   * 💡 **学习笔记**：双向边保证切割方向无关性  

3. **难点3：二维坐标转换**  
   * **分析**：使用`id(i,j)=(i-1)*m+j`将网格映射为一维节点，避免复杂的二维存储  
   * 💡 **学习笔记**：网格问题优先考虑坐标线性化  

### ✨ 解题技巧总结
- **技巧1：最小割建模** - 将最大化问题转化为最小损失（∑|aᵢⱼ| - 最小割）
- **技巧2：Dinic优化** - BFS分层+DFS多路增广，复杂度O(n²m)
- **技巧3：内存预分配** - 预估边数（约4nm）避免动态扩容开销

---

## 4. C++核心代码实现赏析

**通用核心实现**  
```cpp
#include <cstdio>
#include <queue>
#include <cstring>
#define id(i,j) ((i-1)*m+j) // 坐标转换
const int N=4e4+5, M=3e5+5, INF=0x3f3f3f3f;

struct Dinic {
    // ...[Dinic算法模板，见完整代码]
} solver;

int main() {
    scanf("%d%d",&n,&m);
    int s=0, t=n*m+1, sum=0;
    
    // 1. 建源点/汇点边
    for(int i=1; i<=n; ++i)
    for(int j=1; j<=m; ++j) {
        int a; scanf("%d",&a);
        if(a>0) solver.add(s, id(i,j), a);
        if(a<0) solver.add(id(i,j), t, -a);
        sum += abs(a);
    }
    
    // 2. 建水平双向边
    for(int i=1; i<n; ++i)
    for(int j=1; j<=m; ++j) {
        int w; scanf("%d",&w);
        solver.add(id(i,j), id(i+1,j), w);
        solver.add(id(i+1,j), id(i,j), w);
    }
    
    // 3. 建垂直双向边
    for(int i=1; i<=n; ++i)
    for(int j=1; j<m; ++j) {
        int w; scanf("%d",&w);
        solver.add(id(i,j), id(i,j+1), w);
        solver.add(id(i,j+1), id(i,j), w);
    }
    
    printf("%d\n", sum - solver.dinic(s,t));
}
```

**代码解读概要**：  
1. 坐标转换：`id(i,j)`将二维网格压缩为一维索引  
2. 三层建图：源/汇边（决策损失）、水平墙、垂直墙（隔离成本）  
3. Dinic算法高效求解最小割  

---

## 5. 算法可视化：像素动画演示

**主题**：8-bit水管工大战  
**核心演示**：Dinic算法执行过程（BFS分层+DFS增广）

```plaintext
┌───────┬───────┬───────┐
│  S(5) │       │       │
│   ●═══╪═══●═══╪═══●  │
│  │    │ W=3│   │   │
│  ●━━━━┿━━━●━━━┿━━━●  │ 控制面板：
│  T(4) │       │       │ [▶] 暂停/继续
└───────┴───────┴───────┘ [▮▮] 单步 [🔊] 音效
```

**动画流程**：  
1. **初始化**：网格房屋着色（蓝=源点/红=汇点/灰=中立），墙显示为虚线  
2. **BFS分层**：  
   - 源点发出蓝色波纹扩散（像素波浪动画）  
   - 播放"滴答"音效标记访问节点  
3. **DFS增广**：  
   - 增广路径高亮显示（黄色光流效果）  
   - 墙破裂时：播放"咔嚓"音效+像素碎片动画  
   - 房屋变色：归属确定时播放"叮"声  
4. **结算阶段**：  
   - 成功分割：显示总收益公式 ∑|aᵢⱼ|-mincut  
   - 失败提示：播放低沉音效+闪烁红色边框  

**技术实现**：  
- 使用Canvas绘制网格/水流/墙体  
- 音效触发：Web Audio API播放8-bit音效  
- 交互控制：调速滑块(50ms~2s/步)，支持单步调试  

---

## 6. 拓展练习与相似问题

**通用技巧迁移**：  
最小割模型适用于：区域划分、冲突消除、资源分配问题

**推荐练习**：  
1. **P2598 [ZJOI2009]狼和羊的故事**  
   🗣️ 最小割裸题，巩固基础建模能力  
2. **P2774 方格取数问题**  
   🗣️ 二分图最小割，理解"互斥选择"建模  
3. **P4001 [ICPC-Beijing 2006]狼抓兔子**  
   🗣️ 平面图最小割转最短路，拓展思维  

---

## 7. 学习心得与经验分享

**作者经验摘录**：  
> "调试时先检查双向边——建墙必须两条反向边，漏掉会导致WA"  
> —— Rusalka 题解  

**Kay点评**：  
网络流调试核心步骤：  
1. 打印建边列表，验证容量值  
2. 小规模数据手工验证（如2x2网格）  
3. 用`cout`追踪增广路径  

---

**结语**  
通过最小割的精妙建模，我们成功解决了圈地问题。记住：算法思维就像乐高积木——掌握最小割这个基础模块，能组合解决无数划分难题。下次遇到网格划分时，不妨再回味这道题的"像素水管工"动画哦！🚀

---
处理用时：154.61秒
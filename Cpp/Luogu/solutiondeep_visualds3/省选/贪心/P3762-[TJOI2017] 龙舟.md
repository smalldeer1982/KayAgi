# 题目信息

# [TJOI2017] 龙舟

## 题目描述

加里敦大学有一个龙舟队，龙舟队有 $n$ 支队伍，每只队伍有 $m$ 个划手。龙舟比赛是一个集体项目，和每个人的能力息息相关，但由于龙舟讲究配合，所以评价队伍的能力的是一个值 $C=\frac{b_1 \times b_2 \times \cdots \times b_m}{a_1 \times a_2 \times \cdots \times a_m}$，其中 $b_i$ 表示第 $i$ 个位置的标准能力值，$a_i$ 表示在队伍中第 $i$ 个位置的划手的能力值。最后通过约分，我们会得到 $C=\frac{B}{A}$，其中 $\gcd(B,A)=1$，即 $A,B$ 互质。

但是由于比赛现场的情况不一样，我们认为在现场压力为 $M$ 的情况下，队伍最后的表现情况是 $C^{-1}\mod M$。我们规定在模 $M$ 的条件下 $\frac{1}{x}=y$，其中 $y$ 满足 $xy \equiv 1\pmod M$，并且 $y$ 大于等于 $0$ 小于 $M$。如果不存在这样的 $y$ 我们就认为在压力为 $M$ 的条件下这支队伍会发挥失常（即 $y$ 是 $x$ 在模 $M$ 意义下的逆元，如果不存在逆元我们认为队伍发挥失常）。给出这个赛季的比赛安排情况，现在教练组想知道各队在比赛中的表现情况。

## 说明/提示

对于 $20\%$ 的数据，$1<M,a_i,b_i<10^8$，$m \le 100$。

对于 $100\%$ 的数据，$1<M,a_i,b_i<2 \times 10^{18}$，$m \le 10000$，$n \le 20$，$k \le 50$。

## 样例 #1

### 输入

```
2 3 3
5 2 3
3 2 3
2 3 2
1 4
2 4
1 7```

### 输出

```
3
-1
4```

# AI分析结果


### 💡 Kay的C++算法解析：龙舟问题 深入学习指南 💡

---

## 1. 题目解读与核心算法识别
✨ **本题主要考察**：`数学（质因数分解与模逆元）` + `编程技巧应用（大数处理）`

🗣️ **初步分析**：
> 龙舟问题就像在烹饪比赛前准备食材：分子分母是原始食材（能力值），模数M是特殊调料。我们需要先剔除调料中"过敏成分"（M的质因子），才能安全混合食材（约分），最后调制出合格酱汁（模逆元）。
> - **核心思路**：分解模数M的质因子，将分子分母中这些因子约去，剩余部分与M互质时才能求逆元
> - **难点突破**：直接分解大数（最大2e18）需用Pollard Rho算法，避免对每个数单独分解
> - **可视化设计**：将质因子具象化为彩色像素球，约分过程设计为"球体碰撞消除"动画（见第5节）
> - **复古元素**：8-bit音效（分解成功→胜利音效/约分失败→错误音效），关卡式进度（每完成10%点亮一颗星）

---

## 2. 精选优质题解参考
**agicy的题解（评分：★★★★☆）**
* **点评**：  
  思路直击要害——通过分解模数M而非每个大数来优化约分。代码采用模块化设计：
  - `Miller_Rabin`和`Pollard_Rho`实现高效大数分解（算法亮点）
  - `T[]`数组精妙统计质因子次数（变量设计合理）
  - 欧拉定理求逆元代替费马小定理（严谨处理非质数模数）
  实践价值高，但缺少边界注释（如n=1时），建议补充调试心得。

---

## 3. 核心难点辨析与解题策略
1. **难点1：大数质因数分解**
   * **分析**：传统试除法在2e18数量级失效。agicy采用**Pollard Rho概率算法**（时间复杂度O(M¹ᐟ⁴)），配合Miller-Rabin素性测试加速
   * 💡 **学习笔记**：大数分解="大海捞针"，随机算法是唯一渔网

2. **难点2：安全约分保证互质**
   * **分析**：对M的每个质因子p：
     - 扫描分子bᵢ：记录p出现次数T[p] += k  
     - 扫描分母aᵢ：T[p] -= k  
     若任何T[p]<0 → 分母含多余p因子 → 无解
   * 💡 **学习笔记**：约分是求逆元的"安全证书"

3. **难点3：非质数模下的逆元**
   * **分析**：当M非质数时，需用**欧拉定理**：
     ```math
     inv ≡ ans₂^{φ(M)-1} \pmod M
     ```
     其中φ(M)由质因子直接计算：φ(M)=M×∏(1-1/pᵢ)
   * 💡 **学习笔记**：欧拉函数是打开非质数模逆元大门的万能钥匙

### ✨ 解题技巧总结
- **分解转移术**：将全局问题（分解所有a/b）简化为局部问题（只分解M）
- **批处理统计**：用数组T[]集中管理质因子计数，避免重复计算
- **快速乘防溢出**：`mul(a,b,M)`用加法模拟乘法（位运算加速），处理2e18×2e18

---

## 4. C++核心代码实现赏析
**本题通用核心实现参考**
```cpp
#include<bits/stdc++.h>
using namespace std;
typedef long long ll;

// 快速乘 (防溢出)
ll mul(ll a, ll b, ll mod) {
  ll res = 0;
  while (b) {
    if (b & 1) res = (res + a) % mod;
    a = (a + a) % mod;
    b >>= 1;
  }
  return res;
}

// 欧拉函数计算 (需质因数分解)
ll get_phi(ll n) {
  ll res = n;
  for (ll i = 2; i * i <= n; ++i) {
    if (n % i == 0) {
      res = res / i * (i - 1);
      while (n % i == 0) n /= i;
    }
  }
  if (n > 1) res = res / n * (n - 1);
  return res;
}

int main() {
  // 读入数据 + 调用Pollard_Rho分解
  // 约分检查 + 欧拉定理求逆元
}
```

**agicy解法核心片段**  
```cpp
// 质因子统计与约分
for (int j = 1; j <= tot; ++j) {
  while (tb[i] % fac[j] == 0) {  // 扫描分子
    ++T[j];  // 质因子计数器+1
    tb[i] /= fac[j];
  }
  while (ta[i] % fac[j] == 0) {  // 扫描分母
    --T[j];  // 质因子计数器-1
    ta[i] /= fac[j];
  }
}
if (T[j] < 0) {  // 检查分母是否有多余因子
  puts("-1");
  return;
}
```

**代码解读**  
> 这段代码像精密的流水线：
> 1. `fac[j]`是质因子"滤网"（M分解出的质因子）
> 2. `while`循环是"过滤装置"：不断剔除分子分母中的fac[j]
> 3. `T[j]`是"质检计数器"：分子过滤→计数器+1，分母过滤→-1
> 4. 最终检查T[j]≥0 → 确保分母无多余因子  
> 💡 **学习笔记**：质因子计数器是约分过程的"黑匣子记录仪"

---

## 5. 算法可视化：像素动画演示
![](https://via.placeholder.com/800x400?text=Pollard+Rho+%E5%8C%85%E8%A3%B9%E5%88%86%E8%A7%A3%E5%8A%A8%E7%94%BB)  
* **主题**：质因子大冒险（8-bit像素风）
* **核心流程**：
  1. **初始化**：屏幕左侧显示分子/分母队列（像素小人），右侧显示巨型M（发光方块）
  2. **分解阶段**：
     - M方块裂变成彩色小球（质因子）→ 播放"碎裂音效"
     - Pollard Rho算法用两个像素球（x,y）随机碰撞 → 碰撞成功时触发因子分裂动画
  3. **约分阶段**：
     - 分子小人持bᵢ方块走过质因子滤网 → 匹配时方块缩小并播放"叮"声
     - 分母小人持aᵢ方块过滤 → 失败时闪红光+错误音效
  4. **逆元阶段**：
     - 剩余分母方块进入欧拉机器（显示φ(M)计算过程）
     - 快速幂齿轮转动（二进制光效）→ 输出逆元方块

* **交互设计**：
  - 控制台：暂停/单步/速度滑块（兔子/乌龟图标）
  - 自动演示模式：AI小人自动完成全流程（每10%点亮星标）
  - 音效系统：分解→金属声，约分→水滴声，成功→超级玛丽过关音效

---

## 6. 拓展练习与相似问题
**通用技巧迁移**：
1. 大数分解 → 质因数统计问题
2. 模逆元应用 → 组合数学问题
3. 批处理约分 → 分数运算优化

**推荐练习**：
1. **洛谷 P4718**（Pollard Rho模板题）  
   → 掌握大数分解的核心实现
2. **洛谷 P3811**（线性逆元计算）  
   → 理解逆元在不同场景的应用
3. **洛谷 P1069**（约分与质因子统计）  
   → 强化约分技巧的迁移能力

---

> 本次题解分析完结。记住：数论是算法世界的基石，掌握它就像获得像素游戏中的万能钥匙！🚀

---
处理用时：124.51秒
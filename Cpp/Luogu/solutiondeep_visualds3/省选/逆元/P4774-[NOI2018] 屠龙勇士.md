# 题目信息

# [NOI2018] 屠龙勇士

## 题目描述

小 D 最近在网上发现了一款小游戏。游戏的规则如下：

- 游戏的目标是按照编号 $1 \rightarrow n$ 顺序杀掉 $n$ 条巨龙，每条巨龙拥有一个初始的生命值 $a_i$ 。同时每条巨龙拥有恢复能力，当其使用恢复能力时，它的生命值就会每次增加 $p_i$ ，直至生命值非负。只有在攻击结束后且当生命值 **恰好** 为 $0$ 时它才会死去。
- 游戏开始时玩家拥有 $m$ 把攻击力已知的剑，每次面对巨龙时，玩家只能选择一把剑，当杀死巨龙后这把剑就会消失，但作为奖励，玩家会获得全新的一把剑。

小 D 觉得这款游戏十分无聊，但最快通关的玩家可以获得 ION2018 的参赛资格，于是小 D 决定写一个笨笨的机器人帮她通关这款游戏，她写的机器人遵循以下规则：

- 每次面对巨龙时，机器人会选择当前拥有的，攻击力不高于巨龙初始生命值中攻击力最大的一把剑作为武器。如果没有这样的剑，则选择 **攻击力最低** 的一把剑作为武器。
- 机器人面对每条巨龙，它都会使用上一步中选择的剑攻击巨龙固定的 $x$ 次，使巨龙的生命值减少 $x \times ATK$ 。
- 之后，巨龙会不断使用恢复能力，每次恢复 $p_i$ 生命值。若在使用恢复能力前或某一次恢复后其生命值为 $0$ ，则巨龙死亡，玩家通过本关。

那么显然机器人的攻击次数是决定能否最快通关这款游戏的关键。小 D 现在得知了每条巨龙的所有属性，她想考考你，你知道应该将机器人的攻击次数 $x$ 设置为多少，才能用最少的攻击次数通关游戏吗？

当然如果无论设置成多少都无法通关游戏，输出 $-1$ 即可。

## 说明/提示

### 更多样例

更多样例请在附加文件中下载。

### 样例 2

见附加文件中的 `dragon2.in` 与 `dragon2.ans`。

### 样例 1 解释

第一组数据：
- 开始时拥有的剑的攻击力为 $\{1,9,1000\}$，第 $1$ 条龙生命值为 $3$，故选择攻击力为 $1$ 的剑，攻击 $59$ 次，造成 $59$ 点伤害，此时龙的生命值为 $-56$，恢复 14 次后生命值恰好为 $0$，死亡。

- 攻击力为 $1$ 的剑消失，拾取一把攻击力为 $7$ 的剑，此时拥有的剑的攻击力为
$\{7,9,1000\}$，第 2 条龙生命值为 $5$，故选择攻击力为 $7$ 的剑，攻击 $59$ 次，造成 $413$ 点伤害，此时龙的生命值为 $-408$，恢复 $68$ 次后生命值恰好为 $0$，死亡。

- 此时拥有的剑的攻击力为 $\{3,9,1000\}$，第 $3$ 条龙生命值为 $7$，故选择攻击力为 $3$ 的剑，攻击 $59$ 次，造成 $177$ 点伤害，此时龙的生命值为 $-170$，恢复 $17$ 次后生命值恰好为 0，死亡。

- 没有比 $59$ 次更少的通关方法，故答案为 $59$。

第二组数据：
不存在既能杀死第一条龙又能杀死第二条龙的方法，故无法通关，输出 $-1$。

### 子任务

测试点编号 |　　　$n$　　　|　　　$m$　　　|　　　$p_i$　　　|　　　$a_i$　　　| 　　攻击力　　 | 其他限制
-|-|-|-|-|-|-
1|$\le 10^5$|$=1$|$=1$|$\le 10^5$|$=1$| 无
2|$\le 10^5$|$=1$|$=1$|$\le 10^5$|$=1$| 无
3|$\le 10^5$|$=1$|$=1$|$\le 10^5$|$\le 10^5$| 无
4|$\le 10^5$|$=1$|$=1$|$\le 10^5$|$\le 10^5$| 无
5|$\le 10^3$|$\le 10^3$|$\le 10^5$|$\le 10^5$|$\le 10^5$| 特性 1、特性 2
6|$\le 10^3$|$\le 10^3$|$\le 10^5$|$\le 10^5$|$\le 10^5$| 特性 1、特性 2
7|$\le 10^3$|$\le 10^3$|$\le 10^5$|$\le 10^5$|$\le 10^5$| 特性 1、特性 2
8|$=1$|$=1$|$\le 10^8$|$\le 10^8$|$\le 10^6$| 特性 1
9|$=1$|$=1$|$\le 10^8$|$\le 10^8$|$\le 10^6$| 特性 1
10|$=1$|$=1$|$\le 10^8$|$\le 10^8$|$\le 10^6$| 特性 1
11|$=1$|$=1$|$\le 10^8$|$\le 10^8$|$\le 10^6$| 特性 1
12|$=1$|$=1$|$\le 10^8$|$\le 10^8$|$\le 10^6$| 特性 1
13|$=1$|$=1$|$\le 10^8$|$\le 10^8$|$\le 10^6$| 特性 1
14|$=10^5$|$=10^5$|$=1$|$\le 10^8$|$\le 10^6$| 无特殊限制
15|$=10^5$|$=10^5$|$=1$|$\le 10^8$|$\le 10^6$| 无特殊限制
16|$\le 10^5$|$\le 10^5$| 所有 $p_i$ 是质数 |$\le 10^{12}$|$\le 10^6$| 特性 1
17|$\le 10^5$|$\le 10^5$| 所有 $p_i$ 是质数 |$\le 10^{12}$|$\le 10^6$| 特性 1
18|$\le 10^5$|$\le 10^5$| 无特殊限制 |$\le 10^{12}$|$\le 10^6$| 特性 1
19|$\le 10^5$|$\le 10^5$| 无特殊限制 |$\le 10^{12}$|$\le 10^6$| 特性 1
20|$\le 10^5$|$\le 10^5$| 无特殊限制 |$\le 10^{12}$|$\le 10^6$| 特性 1

特性 1 是指：对于任意的 $i$，$a_i \le p_i$。

特性 2 是指：$\operatorname{lcm}(p_i) \le 10^6$，即所有 $p_i$ 的 **最小公倍数** 不大于 $10^6$。

对于所有的测试点，$T \le 5$，所有武器的攻击力 $\le 10^6$，所有 $p_i$ 的最小公倍数 $\le 10^{12}$。

保证 $ T, n, m $ 均为正整数。

### 提示

你所用到的中间结果可能很大，注意保存中间结果的变量类型。

## 样例 #1

### 输入

```
2
3 3
3 5 7
4 6 10
7 3 9
1 9 1000
3 2
3 5 6
4 8 7
1 1 1
1 1```

### 输出

```
59
-1```

# AI分析结果


### 💡 Kay的C++算法解析：[NOI2018] 屠龙勇士 深入学习指南 💡

#### 题目解读与核心算法识别
✨ **本题主要考察**：`扩展中国剩余定理（ExCRT）`与`扩展欧几里得（ExGCD）`

🗣️ **初步分析**：
> 解决"屠龙勇士"的关键在于**动态维护武器系统**和**求解带系数的同余方程组**。想象你是一位装备管理员（平衡树/multiset）兼数学家（ExCRT），需要：
> 1. **动态选剑**：用平衡树快速选择每条龙的武器（不大于龙血量的最大攻击力剑）
> 2. **建立方程**：每条龙转化为 $ATK_i \cdot x \equiv a_i \pmod{p_i}$（$x$为攻击次数）
> 3. **方程转化**：用ExGCD消去系数 $ATK_i$，转化为标准同余方程
> 4. **合并求解**：用ExCRT合并所有方程，求最小正整数解 $x$
> 
> **可视化设计思路**：在8位像素风格动画中：
> - 左侧显示当前合并的方程（像素化公式）
> - 右侧Canvas动态展示ExCRT合并过程（模数环状扩展）
> - 高亮当前操作的系数 $ATK_i$ 和模数 $p_i$ 更新
> - 音效：剑击声（选剑）、数字跳动声（ExGCD计算）、合成音效（方程合并）

---

### 精选优质题解参考
**题解一（emptysetvvvv）**
* **点评**：思路最清晰直白，用`multiset`高效处理剑的选择，ExCRT实现简洁完整。亮点在于：
  - 直接使用`__int128`避免手写快速乘（需注意编译器支持）
  - 边界处理严谨（无解判断、负数处理）
  - 代码模块化：ExCRT独立函数，实践性强
  > *学习点：竞赛中可用`__int128`简化大数处理*

**题解二（shadowice1984）**
* **点评**：理论推导最严谨，逐步解剖ExCRT合并原理。亮点：
  - 详细推导系数处理（$ATK_i$ 转化为逆元）
  - 特殊点分析透彻（$p_i=1$ 和 $a_i=p_i$ 的情况）
  > *学习点：理解ExCRT的数学本质*

**题解三（FlashHu）**
* **点评**：代码健壮性最佳，鲁棒性强。亮点：
  - 独立处理所有特判（$p_i=1$、$a_i>p_i$）
  - 龟速乘实现完全避免溢出
  - 模块化函数设计（exgcd/Excrt分离）
  > *学习点：工业级代码的边界处理技巧*

---

### 核心难点辨析与解题策略
1. **动态武器选择**
   * **难点**：快速选择"不大于龙血量的最大攻击力剑"
   * **策略**：用`multiset.upper_bound()`定位前驱，$O(\log n)$完成
   * 💡 **学习笔记**：STL容器选择直接影响效率

2. **系数处理（关键难点）**
   * **难点**：$ATK_i \cdot x \equiv a_i \pmod{p_i}$ 含系数
   * **策略**：
     ```python
     g = gcd(ATK_i, p_i)           # 求公共因子
     inv = ATK_i/g 在模 (p_i/g) 下的逆元  # ExGCD求逆元
     x ≡ (a_i/g)·inv (mod p_i/g)    # 转化为标准方程
     ```
   * 💡 **学习笔记**：系数本质是求模意义下的"倒数"

3. **大数运算优化**
   * **难点**：$10^{12}×10^{12}$ 导致溢出
   * **策略**：龟速乘（反复加法替代乘法）
   ```cpp
   ll mul(ll a, ll b, ll mod) {
     ll res = 0;
     while (b) {
       if (b & 1) res = (res + a) % mod;
       a = (a + a) % mod;
       b >>= 1;
     }
     return res;
   }
   ```

### ✨ 解题技巧总结
- **特判先行**：先处理 $p_i=1$ 的情况（$x = \max\lceil a_i/ATK_i \rceil$）
- **无解条件**：$gcd(ATK_i, p_i) \nmid a_i$ 时直接返回-1
- **调试技巧**：打印中间变量（如ExGCD的解）
- **代码优化**：ExCRT和ExGCD拆分为独立函数

---

### C++核心代码实现赏析
**通用核心实现参考**（综合优质题解优化）
```cpp
#include <set>
using namespace std;
typedef long long ll;

ll solve() {
  multiset<ll> swords; // 武器库
  // 读入数据（略）
  for (int i = 1; i <= n; ++i) {
    auto it = swords.upper_bound(a[i]);
    if (it != swords.begin()) --it; // 选不大于a[i]的最大剑
    ATK[i] = *it;
    swords.erase(it);
    swords.insert(new_sword[i]); // 获得新剑
  }

  ll X = 0, M = 1; // ExCRT初始解
  for (int i = 1; i <= n; ++i) {
    ll g = gcd(ATK[i], p[i]);
    if (a[i] % g) return -1; // 无解判断
    
    // ExGCD求逆元（略）
    // 龟速乘更新解
    ll new_M = M / gcd(M, p[i]/g) * (p[i]/g);
    X = /* 更新解（略） */;
    M = new_M;
  }
  return X;
}
```

**题解一核心片段赏析**
```cpp
void exgcd(ll A, ll B, ll &x, ll &y, ll &gcd) {
  if (!B) x = 1, y = 0, gcd = A;
  else exgcd(B, A%B, y, x, gcd), y -= (A/B)*x;
}
```
> **亮点**：递归实现ExGCD，结构优美  
> **学习笔记**：递归时交换x,y巧妙避免中间变量

---

### 算法可视化：像素动画演示
**设计概念**：8位RPG战斗界面 + 数学演算过程

```plaintext
| 战场画面                | 方程合并过程          |
|-------------------------|---------------------|
| 勇士(8bit像素)对战巨龙   | 当前方程: ATK₁x ≡ a₁ |
| 剑光闪烁(攻击动画)       | 模数环: [===] → [======] |
| 血量条: ████▁▁▁▁▁       | 合并动画: 两环相交扩展   |
```

1. **控制面板**：
   - 步进控制：← → 键单步执行
   - 速度滑块：调速0.5x~2x
   - 模式切换：战斗视图/数学视图

2. **关键动画帧**：
   - 选剑：武器库高亮选中剑，音效"锵！"
   - ExGCD计算：显示辗转相除过程（像素数字跳动）
   - 方程合并：两个模数环融合为更大环

3. **游戏化元素**：
   - 每解一个方程获得"数学宝石"（+100分）
   - BOSS战：最终合并时播放BOSS战音乐
   - 失败音效：无解时播放"Game Over"芯片音乐

---

### 拓展练习与相似问题思考
1. **ExCRT基础应用**  
   - 洛谷P4777【模板】扩展中国剩余定理（ExCRT）
   - 核心技巧迁移：方程合并、大数处理

2. **动态武器系统变种**  
   - CodeForces 1538D：动态装备系统+贪心选择
   - 联系：均需高效数据结构维护武器库

3. **模运算进阶**  
   - 洛谷P3846【模板】BSGS算法
   - 思考：$a^x \equiv b \pmod{p}$ 与 $ax \equiv b \pmod{p}$ 的异同

---

### 学习心得与经验分享
> **参考经验**（from FlashHu）：  
> "调试时重点监控ExGCD的解和模数变化，快速乘的负数处理是常见陷阱"

> **Kay总结**：  
> 1. 先写框架再补特判（$p_i=1$单独处理）  
> 2. 模块化编程：ExGCD/ExCRT/快速乘独立验证  
> 3. 对拍工具：用小数据验证龟速乘正确性  
> 4. **核心教训**：大数运算是魔鬼，越界检查要前置！

---

### 结语
通过本次分析，我们深入掌握了动态武器管理+ExCRT的核心思想。记住：算法竞赛中，"选择合适工具"（multiset）和"严谨数学推导"（ExGCD）同等重要。现在就去洛谷P4777检验你的学习成果吧！💪

---
处理用时：114.33秒
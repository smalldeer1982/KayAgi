# 题目信息

# [CTSC2012] 电阻网络

## 题目描述

给定一个树型电网，树中的每条边上有一个电阻$R_i$，电阻值均为10000Ω。下图为一个包含4个节点的树型电路情况：

![图1](https://i.loli.net/2018/10/03/5bb46c0c587be.png)

树中的所有叶子节点（度为1的节点称为叶子）都接地，每条线上都接地，每条线上都附有10000Ω的电阻，最终形成的电网如下图所示：

![图2](https://i.loli.net/2018/10/03/5bb46c0c72576.png)

现有如下两种操作：

`C u v w`：表示在边`<u,v>`上串联一个电源，电源的大小为$w$伏，电源位于靠近节点$u$一侧（如下图所示），电源负极指向$u$。注意同一条边上可以串联多个电源。

![图3](https://i.loli.net/2018/10/03/5bb46c0c6a122.png)

`Q u` ：表示询问点$u$当前的电压，此是指对地。

如对上图进行`C 2 4 5`操作后，网络变为：

![图4](https://i.loli.net/2018/10/03/5bb46c0c86064.png)

此时每个节点上的电压见上图的标注。


## 说明/提示

【样例说明】

对于第一个询问，由于原图中没有电源，所以没有电流，所有点的电压都相

等（否则如果有 U i >U j ，则就有 i 流向 j 的电流，与没有电源矛盾）,都等于地电

压 0V。

之后在<2,4>中加一个 5V 的电源，得到的新图见题目描述。

整理后可以发现，新图的形式是串联(电源,R 2 +10000,并联(R 1 +10000,

R 3 +10000))，由此可以得到新图的总电阻为:

R 2 +10000+1/(1/(R 3 +10000)+1/(R 1 +10000))=30000 Ω.

所以流过节点 4 的电流就是 5/30000A，所以 U 4 =5/3V。U 2 =U 4 +R 2 \*I-5=-5/3V，由

于 U 1 和 U 3 形式对称，由分压关系可知 U 1 =U 3 =U 2 \*10000/(10000+10000)=-5/6V。

【数据规模】

30%的数据保证 N,M ≤ 30

60%的数据保证 N,M ≤ 3000

100%的数据保证 3 ≤ N,M ≤ 50000，1 ≤ u,v ≤ n，1 ≤ w ≤ 10，树中最长链的长

度不超过 50。


## 样例 #1

### 输入

```
4 3
1 2
2 3
2 4
Q 2
C 2 4 5
Q 2```

### 输出

```
0.0000000000
-1.6666666666```

# AI分析结果


### 💡 Kay的C++算法解析：电阻网络 深入学习指南 💡

#### 1. 题目解读与核心算法识别
✨ **本题主要考察**：树形动态规划（树形DP）

🗣️ **初步分析**：
> 解决这道题的关键在于将物理问题转化为数学模型。想象电网是一棵倒挂的圣诞树🎄，电流如同水流从树根流向树叶（接地）。我们通过树形DP建立每个节点的电势与父节点电势的线性关系：φ_i = K_i * φ_fa + B_i  
> - **核心思路**：利用树的结构特性，通过基尔霍夫定律推导出电势传递公式，预处理系数K_i，动态维护偏移量B_i  
> - **难点突破**：边界处理（叶子节点接地）、电源修改时的路径更新  
> - **可视化设计**：用像素树模拟电流（蓝色光点流动），修改电源时高亮操作边（红色闪烁），查询时显示电势值（绿色数字浮动）

---

#### 2. 精选优质题解参考
**题解（作者：SuperJvRuo）**  
* **点评**：  
  思路清晰推导严谨（⭐️⭐️⭐️⭐️⭐️）—— 从欧姆定律出发逐步构建递推关系，物理模型到代码实现逻辑闭环  
  代码规范（⭐️⭐️⭐️⭐️）—— `k[]`/`b[]`变量名直指核心，边界处理（`degree[0]=1`）巧妙  
  算法高效（⭐️⭐️⭐️⭐️⭐️）—— 预处理K_i使修改复杂度O(链长≤50)，完美契合"最长链≤50"的数据特征  
  实践价值（⭐️⭐️⭐️⭐️）—— 完整可运行的竞赛级代码，包含输入输出和边界处理

---

#### 3. 核心难点辨析与解题策略
1. **电势递推关系建立**  
   * **分析**：需结合基尔霍夫定律（电流守恒）和欧姆定律（U=IR）推导φ_i = (φ_fa - E_i + Σ(φ_x + E_x)) / deg_i  
   * 💡 学习笔记：树形DP本质是父-子状态传递，物理量需满足叠加原理

2. **边界条件处理**  
   * **分析**：叶子节点度=2（原边+接地边），得φ_leaf = (φ_fa - E_i)/2 → K_leaf=1/2  
   * 💡 学习笔记：边界决定递推起点，接地相当于电势零点

3. **动态维护B_i**  
   * **分析**：修改电源需更新路径上所有B_i，利用树链短特性暴力更新  
   * 💡 学习笔记：树链较短时，暴力更新优于复杂数据结构

✨ **解题技巧总结**  
- **物理模型数学化**：将电路定律转化为递推公式  
- **树形DP预处理**：静态系数(K_i)预计算，动态量(B_i)按需更新  
- **边界驱动设计**：从叶子节点反向推导递推系数  

---

#### 4. C++核心代码实现赏析
**通用核心实现参考**  
```cpp
#include<cstdio>
#include<cctype>
// 核心变量：k[]递推系数，b[]电势偏移，sum_b[]子节点b值和
void init_k(int u,int f) { // 预处理K_i
    double sum_k=0;
    for(int v : sons) sum_k += k[v]; 
    k[u] = 1.0/(deg[u]-sum_k); // 关键递推公式
}
void Modify(int u,int v,int e) {
    if(fa[v]==u) swap(u,v), e=-e; // 电源方向处理
    U[u]+=e; // 更新电源值
    Add_b(u,e); // 暴力更新路径b值
}
double Query(int u) { // 递推求解
    return u ? k[u]*Query(fa[u])+b[u] : 0; 
}
```

**关键片段赏析**  
1. **递推系数预处理**  
   ```cpp
   k[u]=1.0/(degree[u]-sum_k); // deg[u]为节点度数
   ```  
   > **解读**：如同计算圣诞树灯串的亮度衰减比，分母`deg[u]-Σk[v]`是"父节点电流分流比例"  
   > 💡 学习笔记：K_i由子节点状态决定，需后序遍历计算

2. **电源修改处理**  
   ```cpp
   if(fa[v]==u) swap(u,v), e=-e; // 电源方向校准
   ```  
   > **解读**：电源在边<u,v>且靠近u端时，实际作用在u→v方向，需统一为子节点方向  
   > 💡 学习笔记：树形结构中统一方向可简化操作

---

#### 5. 算法可视化：像素动画演示
![像素电路树](https://asset.cakeresume.com/assets/animations/circuit_tree.gif)  
* **主题**：8-bit风格电路探险  
* **核心交互**：  
  - **电源修改**：点击边→弹出电源设置框→确认后红色电流脉冲沿路径传播  
  - **电势查询**：点击节点→显示绿色电势值（如"-1.67V"）并播放"滴"声  
  - **自动演示**：AI小人沿树链移动，实时显示K/b值变化（按空格暂停）  
* **设计细节**：  
  - 电阻=棕色像素条，电源=闪烁⭐️，地=⚡️符号  
  - 路径更新时播放"滋滋"电流声，计算完成奏胜利音效🎵

---

#### 6. 拓展练习与相似问题思考
1. **洛谷P2015 二叉苹果树**  
   🗣️ 同类树形DP，用`f[u][j]`记录保留树枝的最大苹果数  
2. **洛谷P3177 [HAOI2015]树上染色**  
   🗣️ 进阶树形DP，结合组合数学计算黑点分布方案  
3. **洛谷P1352 没有上司的舞会**  
   🗣️ 经典树形DP入门，状态转移设计思路相通

---

#### 7. 学习心得与经验分享
> **作者经验**："推导φ_i表达式时，先画等效电路图再列方程更直观"  
> **Kay总结**：物理类树形DP需把握两点：  
> 1. 从边界条件（如接地）逆推递推式  
> 2. 修改操作尽量影响局部（本题仅更新路径B_i）  

通过这道题，我们看到树形DP不仅能解决计数问题，还能建模物理系统。记住：好算法=清晰数学模型+契合数据结构，继续加油！🚀

---
处理用时：85.31秒
# é¢˜ç›®ä¿¡æ¯

# [ROI 2017] å­¦ä¹ è½¨è¿¹ (Day 2)

## é¢˜ç›®æè¿°

THU å’Œ PKU åŒæ—¶å¼€è®¾äº†ä¸€æ‰¹è¯¾ç¨‹ï¼ŒTHU æœ‰ $n$ èŠ‚è¯¾ï¼ŒPKU æœ‰ $m$ èŠ‚è¯¾ã€‚

å…¶ä¸­ THU ç¬¬ $i$ èŠ‚è¯¾ç±»åˆ«æ˜¯ $a_i$ï¼Œä¹è¶£åº¦æ˜¯ $x_i$ï¼›PKU ç¬¬ $i$ èŠ‚è¯¾ç±»åˆ«æ˜¯ $b_i$ï¼Œä¹è¶£åº¦æ˜¯ $y_i$ã€‚ä¿è¯ $a$ ä¸­å…ƒç´ äº’ä¸ç›¸åŒï¼Œ$b$ ä¸­å…ƒç´ äº’ä¸ç›¸åŒï¼Œä½†æ˜¯ $a$ å’Œ $b$ ä¹‹é—´å¯èƒ½æœ‰ç›¸åŒå…ƒç´ ã€‚

ä½ å¯ä»¥é€‰æ‹©å¬ THU çš„ $l_1 \sim r_1$ èŠ‚è¯¾ï¼Œæ”¶è·åˆ°çš„ä¹è¶£åº¦ä¸ºæ‰€æœ‰ä½ å¬çš„è¯¾çš„ä¹è¶£åº¦çš„å’Œï¼›åŒæ—¶å¯ä»¥åœ¨ PKU å¬ $l_2 \sim r_2$ èŠ‚è¯¾ï¼Œæ”¶è·åˆ°çš„ä¹è¶£åº¦ä¹Ÿæ˜¯æ‰€æœ‰ä½ å¬çš„è¯¾çš„ä¹è¶£åº¦çš„å’Œã€‚ï¼ˆå½“ç„¶ä½ ä¹Ÿå¯ä»¥é€‰æ‹©åªå¬ä¸€æ‰€å¤§å­¦çš„è¯¾ç”šè‡³ä¸å¬ï¼‰

åŒä¸€ç±»åˆ«çš„è¯¾ä½ ä¸èƒ½å¬ä¸¤æ¬¡ï¼Œä¹Ÿå°±æ˜¯å¦‚æœ $a_{l_1 \sim r_1}$ ä¸­æœ‰å…ƒç´ ä¸ $b_{l_2 \sim r_2}$ ç›¸åŒï¼Œé‚£ä¹ˆè¿™ä¸ªå¬è¯¾æ–¹æ¡ˆå°±ä¸èƒ½æ»¡è¶³ä½ çš„èƒƒå£ã€‚

ä½ éœ€è¦æ±‚å‡ºå¯èƒ½çš„å¬è¯¾æ–¹æ¡ˆä¸­ä¹è¶£åº¦æœ€å¤§çš„æ˜¯å¤šå°‘ä»¥åŠå…·ä½“çš„å®‰æ’ã€‚

## è¯´æ˜/æç¤º

#### ã€æ ·ä¾‹è§£é‡Šã€‘

å¯¹äºæ ·ä¾‹ç»„ #1ï¼š

æœ€ä¼˜è§£å¦‚æ ·ä¾‹æ‰€ç¤ºï¼Œè¯¾ç¨‹è´¨é‡ä¹‹å’Œä¸º $(7 + 4 + 10 + 1 + 5) + (5 + 3 + 4) = 27 + 12 = 39$ã€‚

å¯¹äºæ ·ä¾‹ç»„ #2ï¼š

ç”±äº PKU çš„ $1$ å·ã€$2$ å·è¯¾ç¨‹ç›¸æ¯” THU çš„ç›¸åŒè¯¾ç¨‹çš„è´¨é‡è¦é«˜å¾—å¤šï¼Œå› æ­¤æœ€ä¼˜è§£æ˜¯ä¸å» THU å¬è¯¾ï¼Œè½¬è€Œåœ¨ PKU è¯» $1\sim 3$ å·è¯¾ç¨‹ã€‚

#### ã€æ•°æ®èŒƒå›´ã€‘

æ³¨ï¼šæœ¬é¢˜åªæ”¾éƒ¨åˆ†æ•°æ®ï¼Œå®Œæ•´æ•°æ®è¯·å·¦è½¬ [LOJ P2773](https://loj.ac/p/2773) è¯„æµ‹ã€‚

å¯¹äºæ‰€æœ‰æ•°æ®æ»¡è¶³ï¼š$1 \le a_i,b_i \le n+m$ï¼Œ$1 \le x_i,y_i \le 10^9$ï¼Œ$a_i \ne a_j(i \ne j)$ï¼Œ$b_i \ne b_j(i \ne j)$ã€‚

| å­ä»»åŠ¡ç¼–å· | åˆ†å€¼ | $1 \le n,m \le $ |
| :----------: | :----------: | :----------: |
| $1$ | $10$ | $50$ |
| $2$ | $10$ | $100$ |
| $3$ | $10$ | $300$ |
| $4$ | $10$ | $500$ |
| $5$ | $10$ | $2000$ |
| $6$ | $5$ | $5000$ |
| $7$ | $5$ | $10^4$ |
| $8$ | $10$ | $3 \times 10^4$ |
| $9$ | $10$ | $10^5$ |
| $10$ | $10$ | $2.5 \times 10^5$ |
| $11$ | $10$ | $5 \times 10^5$ |


## æ ·ä¾‹ #1

### è¾“å…¥

```
7 5
3 1 4 8 6 9 2
2 7 4 10 1 5 3
9 2 11 3 8
3 5 3 4 12```

### è¾“å‡º

```
39
2 6
2 4```

## æ ·ä¾‹ #2

### è¾“å…¥

```
2 3
1 2
1 4
2 3 1
17 2 15```

### è¾“å‡º

```
34
0 0
1 3```

## æ ·ä¾‹ #3

### è¾“å…¥

```
3 3
4 2 1
10 1 2
5 4 2
1 2 9```

### è¾“å‡º

```
19
1 1
3 3```

# AIåˆ†æç»“æœ


# ğŸ’¡ æ´›è¯­äº‘ç¬ºçš„C++ç®—æ³•è§£æï¼š[ROI 2017] å­¦ä¹ è½¨è¿¹ (Day 2) æ·±å…¥å­¦ä¹ æŒ‡å— ğŸ’¡

## 1. é¢˜ç›®è§£è¯»ä¸ç­–ç•¥åˆæ¢

âœ¨ **æœ¬é¢˜æ ¸å¿ƒæŒ‘æˆ˜**ï¼šå¤„ç†ä¸¤ä¸ªåºåˆ—ï¼ˆTHUå’ŒPKUè¯¾ç¨‹ï¼‰ä¸­è¯¾ç¨‹ç±»åˆ«çš„ä¾èµ–å…³ç³»ï¼ˆåŒä¸€ç±»åˆ«ä¸èƒ½é‡å¤é€‰æ‹©ï¼‰ï¼ŒåŒæ—¶åœ¨æœ€å¤§åŒ–æ€»ä¹è¶£åº¦çš„çº¦æŸä¸‹ï¼ŒåŠ¨æ€è§„åˆ’é€‰æ‹©æœ€ä¼˜åŒºé—´ç»„åˆã€‚

âœ¨ **æ ¸å¿ƒç®—æ³•æ ‡ç­¾**ï¼šåŠ¨æ€è§„åˆ’(DP)ã€æ‰«æçº¿ã€å•è°ƒæ ˆã€çº¿æ®µæ ‘

ğŸ—£ï¸ **åˆæ­¥åˆ†æ**ï¼š
> æœ¬é¢˜è¦æ±‚åœ¨ä¸¤ä¸ªåºåˆ—ä¸­é€‰æ‹©å­åŒºé—´ï¼Œä½¿å¾—æ€»ä¹è¶£åº¦æœ€å¤§ä¸”æ— é‡å¤ç±»åˆ«ã€‚æš´åŠ›æšä¸¾ï¼ˆO(nÂ²)ï¼‰ä»…èƒ½è§£å†³å°è§„æ¨¡æ•°æ®ï¼Œè€Œæœ€ä¼˜è§£åˆ©ç”¨**æƒå€¼ä¸­ç‚¹æ€§è´¨**ï¼ˆè‡³å°‘ä¸€ä¸ªåºåˆ—çš„é€‰ä¸­åŒºé—´å’Œè¶…è¿‡è¯¥åºåˆ—æ€»å’Œçš„ä¸€åŠï¼‰ï¼Œå°†é—®é¢˜è½¬åŒ–ä¸ºO(n log n)çš„æ‰«æçº¿+çº¿æ®µæ ‘ä¼˜åŒ–ã€‚æ ¸å¿ƒæ€è·¯æ˜¯ï¼š
> 1. **æš´åŠ›èµ·ç‚¹**ï¼šæšä¸¾ä¸€ä¸ªåºåˆ—çš„åŒºé—´ï¼Œè®¡ç®—å¦ä¸€åºåˆ—çš„æœ€å¤§å­æ®µå’Œï¼ˆO(nÂ²)ï¼‰
> 2. **å…³é”®çªç ´**ï¼šå‘ç°æƒå€¼ä¸­ç‚¹æ€§è´¨ï¼Œå›ºå®šå…³é”®ä½ç½®
> 3. **æœ€ä¼˜ç­–ç•¥**ï¼šæ‰«æçº¿é…åˆå•è°ƒæ ˆç»´æŠ¤åŒºé—´é™åˆ¶ï¼Œçº¿æ®µæ ‘åŠ¨æ€æ›´æ–°æœ€ä¼˜è§£
>
> å¯è§†åŒ–è®¾è®¡é‡‡ç”¨**8ä½åƒç´ é£æ ¼**ï¼šç”¨ç½‘æ ¼è¡¨ç¤ºåºåˆ—ï¼Œé¢œè‰²åŒºåˆ†è¯¾ç¨‹ç±»åˆ«ï¼Œæ‰«æçº¿ç§»åŠ¨æ—¶é«˜äº®å½“å‰æ“ä½œï¼ŒéŸ³æ•ˆæ ‡è®°å…³é”®äº‹ä»¶ï¼ˆå¦‚æ ˆå¼¹å‡ºã€ç­”æ¡ˆæ›´æ–°ï¼‰ã€‚

### ğŸ” ç®—æ³•ä¾¦æ¢ï¼šå¦‚ä½•åœ¨é¢˜ç›®ä¸­å‘ç°çº¿ç´¢ï¼Ÿ
1.  **çº¿ç´¢1 (é—®é¢˜ç›®æ ‡)**ï¼š"åœ¨ä¸è¶…è¿‡é¢„ç®—ï¼ˆåºåˆ—é•¿åº¦æ— æ˜¾å¼é™åˆ¶ä½†éšå«ç±»åˆ«çº¦æŸï¼‰ä¸‹æ±‚ä»·å€¼æ€»å’Œæœ€å¤§"ï¼Œè¿™æ˜¯å…¸å‹çš„**å¸¦çº¦æŸçš„æœ€ä¼˜åŒ–é—®é¢˜**ï¼ŒæŒ‡å‘åŠ¨æ€è§„åˆ’æˆ–è´ªå¿ƒç­–ç•¥ã€‚
2.  **çº¿ç´¢2 (é—®é¢˜çº¦æŸ/ç‰¹æ€§)**ï¼š"åŒä¸€ç±»åˆ«çš„è¯¾ä¸èƒ½å¬ä¸¤æ¬¡"è¡¨æ˜å­˜åœ¨**è·¨åºåˆ—ä¾èµ–å…³ç³»**ï¼Œéœ€è®¾è®¡ç‰¹æ®Šæ•°æ®ç»“æ„ï¼ˆå¦‚å•è°ƒæ ˆ+çº¿æ®µæ ‘ï¼‰å¤„ç†åŠ¨æ€åŒºé—´é™åˆ¶ã€‚
3.  **çº¿ç´¢3 (æ•°æ®è§„æ¨¡)**ï¼šn, m â‰¤ 5Ã—10âµï¼Œæš´åŠ›O(nÂ²)ä¸å¯è¡Œï¼ˆ>10Â¹â°æ“ä½œï¼‰ï¼Œéœ€O(n log n)ç®—æ³•ï¼ˆçº¦10â·æ“ä½œï¼‰ï¼ŒæŒ‡å‘é«˜æ•ˆæ‰«æçº¿+çº¿æ®µæ ‘ã€‚

### ğŸ§  æ€ç»´é“¾æ„å»ºï¼šä»çº¿ç´¢åˆ°ç­–ç•¥
> "ä»çº¿ç´¢1å¯çŸ¥è¿™æ˜¯æœ€ä¼˜åŒ–é—®é¢˜ï¼Œæˆ‘æƒ³åˆ°åŠ¨æ€è§„åˆ’æˆ–è´ªå¿ƒã€‚ä½†çº¿ç´¢2çš„ä¾èµ–å…³ç³»æ’é™¤äº†ç®€å•è´ªå¿ƒï¼ˆæ— æ³•ä¿è¯å…¨å±€æœ€ä¼˜ï¼‰ï¼Œè€Œæš´åŠ›æœç´¢çš„æŒ‡æ•°çº§å¤æ‚åº¦ï¼ˆçº¿ç´¢3ï¼‰å®Œå…¨ä¸å¯è¡Œã€‚æƒå€¼ä¸­ç‚¹æ€§è´¨ï¼ˆéšå«åœ¨é—®é¢˜ç»“æ„ä¸­ï¼‰è®©æˆ‘ä»¬å›ºå®šä¸€ä¸ªå…³é”®ä½ç½®ï¼Œå°†äºŒç»´åŒºé—´é€‰æ‹©é™ä¸ºä¸€ç»´æ‰«æé—®é¢˜ï¼Œé…åˆå•è°ƒæ ˆç»´æŠ¤è¾¹ç•Œé™åˆ¶å’Œçº¿æ®µæ ‘é«˜æ•ˆæŸ¥è¯¢ï¼Œå®Œç¾æ»¡è¶³å¤æ‚åº¦è¦æ±‚ã€‚è¿™å°±æ˜¯æˆ‘ä»¬çš„æ ¸å¿ƒç­–ç•¥ï¼"

---

## 2. ç²¾é€‰ä¼˜è´¨é¢˜è§£å‚è€ƒ

**é¢˜è§£ä¸€ï¼ˆè‹è”å°æ¸£ï¼‰**
* **ç‚¹è¯„**ï¼šæ€è·¯æ¸…æ™°æŠ“ä½æƒå€¼ä¸­ç‚¹æ€§è´¨ï¼Œä»£ç ç”¨å•è°ƒæ ˆå¤„ç†è¾¹ç•Œé™åˆ¶ï¼Œçº¿æ®µæ ‘æ›´æ–°ç­”æ¡ˆã€‚äº®ç‚¹æ˜¯ç®€æ´çš„çŠ¶æ€è½¬ç§»è®¾è®¡ï¼Œä½†å˜é‡å‘½åå¯è¯»æ€§å¯æå‡ï¼ˆå¦‚`fl`, `fr`ï¼‰ã€‚å®è·µä»·å€¼é«˜ï¼Œå¯ç›´æ¥ç”¨äºç«èµ›ã€‚

**é¢˜è§£äºŒï¼ˆ_Ch1F4N_ï¼‰**
* **ç‚¹è¯„**ï¼šè¯¦ç»†æ¨å¯¼æƒå€¼ä¸­ç‚¹æ€§è´¨ï¼Œä»£ç è§„èŒƒï¼ˆ`prex`, `prey`ç­‰æè¿°æ€§å˜é‡åï¼‰ã€‚äº®ç‚¹æ˜¯å®Œæ•´å¤„ç†äº†ä¸­ç‚¹ä½ç½®è®¡ç®—å’ŒåŒå‘æ‰«æï¼Œä½†æ¢å¤é€‰ä¸­åŒºé—´æ—¶ç”¨äº†é¢å¤–å¾ªç¯ï¼Œç¨å½±å“æ•ˆç‡ã€‚è§£é‡Šæ˜“æ‡‚ï¼Œé€‚åˆå­¦ä¹ ã€‚

**é¢˜è§£ä¸‰ï¼ˆfight_for_humanityï¼‰**
* **ç‚¹è¯„**ï¼šç»“æ„ä¸¥è°¨ï¼Œå¼ºè°ƒé—®é¢˜è½¬åŒ–æ€ç»´ï¼ˆä¾èµ–â†’è¾¹ç•Œé™åˆ¶ï¼‰ã€‚äº®ç‚¹æ˜¯çº¿æ®µæ ‘å°è£…å’Œè¾¹ç•Œåˆå§‹åŒ–å¤„ç†ï¼Œä»£ç å¯è¯»æ€§å¼ºï¼ˆ`L[i]`, `R[i]`ç›´è§‚æµ‹åº¦ï¼‰ã€‚å­¦ä¹ ä»·å€¼é«˜ï¼Œä½“ç°å·¥ç¨‹åŒ–æ€ç»´ã€‚

---

## 3. è§£é¢˜ç­–ç•¥æ·±åº¦å‰–æ

### ğŸ¯ æ ¸å¿ƒéš¾ç‚¹ä¸å…³é”®æ­¥éª¤
1.  **å…³é”®ç‚¹1ï¼šæƒå€¼ä¸­ç‚¹æ€§è´¨çš„è¯æ˜ä¸åº”ç”¨**
    * **åˆ†æ**ï¼šè¯æ˜è‡³å°‘ä¸€ä¸ªåºåˆ—çš„é€‰ä¸­åŒºé—´å’Œè¶…è¿‡å…¶æ€»å’Œä¸€åŠï¼ˆå¦åˆ™å…¨é€‰æ›´ä¼˜ï¼‰ï¼Œä»è€Œå›ºå®šå…³é”®ä½ç½®ï¼Œå°†äºŒç»´é€‰æ‹©é™ä¸ºä¸€ç»´æ‰«æã€‚
    * ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šæœ€ä¼˜åŒ–é—®é¢˜ä¸­å¯»æ‰¾"å¿…ç»çŠ¶æ€"æ˜¯é™ä½å¤æ‚åº¦çš„å…³é”®æŠ€å·§ã€‚
2.  **å…³é”®ç‚¹2ï¼šæ‰«æçº¿åŠ¨æ€ç»´æŠ¤è¾¹ç•Œ**
    * **åˆ†æ**ï¼šæ‰«æå³ç«¯ç‚¹æ—¶ï¼Œç”¨å•è°ƒæ ˆç»´æŠ¤å·¦ç«¯ç‚¹å¯¹å¦ä¸€åºåˆ—çš„è¾¹ç•Œé™åˆ¶ï¼ˆå·¦è¾¹ç•Œå•è°ƒä¸å‡ï¼Œå³è¾¹ç•Œå•è°ƒä¸å¢ï¼‰ï¼Œç¡®ä¿O(n)æ›´æ–°ã€‚
    * ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šå•è°ƒæ ˆå¤„ç†è¿ç»­åŒºé—´æœ€å€¼é™åˆ¶æ˜¯æ‰«æçº¿çš„é»„é‡‘æ­æ¡£ã€‚
3.  **å…³é”®ç‚¹3ï¼šçº¿æ®µæ ‘é«˜æ•ˆæŸ¥è¯¢**
    * **åˆ†æ**ï¼šçº¿æ®µæ ‘ç»´æŠ¤æ¯ä¸ªå·¦ç«¯ç‚¹çš„ä»·å€¼ï¼ˆå«æ‡’æ ‡è®°ï¼‰ï¼Œæ”¯æŒåŒºé—´åŠ å‡å’Œè¾¹ç•Œèµ‹å€¼ã€‚æŸ¥è¯¢æ—¶è·å–å…¨å±€æœ€ä¼˜è§£ã€‚
    * ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šçº¿æ®µæ ‘è®¾è®¡éœ€æ˜ç¡®èŠ‚ç‚¹ä¿¡æ¯ï¼ˆå€¼/è¾¹ç•Œï¼‰å’Œæ‡’æ ‡è®°ç±»å‹ï¼ˆåŠ /èµ‹å€¼ï¼‰ã€‚

### âœ¨ è§£é¢˜æŠ€å·§æ€»ç»“
- **é—®é¢˜è½¬åŒ–æŠ€å·§**ï¼šå°†è·¨åºåˆ—ä¾èµ–è½¬åŒ–ä¸ºæƒå€¼ä¸­ç‚¹+è¾¹ç•Œé™åˆ¶
- **æ•°æ®ç»“æ„é€‰æ‹©**ï¼šå•è°ƒæ ˆå¤„ç†è¿ç»­æ€§ï¼Œçº¿æ®µæ ‘å¤„ç†åŠ¨æ€åŒºé—´
- **è¾¹ç•Œå¤„ç†**ï¼šåˆå§‹åŒ–`L[i]=0, R[i]=n+1`é¿å…å¤æ‚åˆ¤ç©º

### âš”ï¸ ç­–ç•¥ç«æŠ€åœºï¼šä¸åŒè§£æ³•çš„å¯¹æ¯”åˆ†æ
| ç­–ç•¥               | æ ¸å¿ƒæ€æƒ³                     | ä¼˜ç‚¹                     | ç¼ºç‚¹ä¸åˆ†æ                     | é€‚ç”¨åœºæ™¯/å¾—åˆ†        |
|--------------------|------------------------------|--------------------------|--------------------------------|---------------------|
| **æš´åŠ›æšä¸¾**       | æšä¸¾åŒºé—´ç»„åˆ+æ ‡è®°å†²çª        | ç›´è§‚æ˜“æ‡‚                 | O(nÂ²)è¶…æ—¶                      | n,mâ‰¤20ï¼Œ10~30%åˆ†æ•° |
| **æƒå€¼ä¸­ç‚¹+æ‰«æçº¿** | å›ºå®šä¸­ç‚¹ï¼Œæ‰«æå¦ä¸€åºåˆ—       | O(n log n)é«˜æ•ˆ           | éœ€ç†è§£æ€§è´¨ï¼Œå®ç°ç•¥å¤æ‚         | 100%åˆ†æ•°           |

### âœ¨ ä¼˜åŒ–ä¹‹æ—…ï¼šä»"èƒ½åš"åˆ°"åšå¥½"
1. **æš´åŠ›èµ·ç‚¹**ï¼šæšä¸¾æ‰€æœ‰åŒºé—´ç»„åˆï¼ˆO(nÂ²)ï¼‰ï¼Œä½†50ä¸‡æ•°æ®è¶…æ—¶
2. **å‘ç°ç“¶é¢ˆ**ï¼šå†²çªæ ‡è®°å’Œæœ€å¤§å­æ®µå’Œè®¡ç®—ç‹¬ç«‹ï¼Œæ— é‡ç”¨
3. **å…³é”®çªç ´**ï¼šæƒå€¼ä¸­ç‚¹æ€§è´¨å›ºå®šå¿…ç»ä½ç½®ï¼Œé™ç»´æ‰“å‡»
4. **æ¨¡å‹å‡å**ï¼šæ‰«æçº¿+å•è°ƒæ ˆé‡ç”¨ä¸­é—´ç»“æœï¼Œçº¿æ®µæ ‘åŠ é€ŸæŸ¥è¯¢

> ğŸ’¡ **ç­–ç•¥æ€»ç»“**ï¼š"ä»æš´åŠ›åˆ°æœ€ä¼˜è§£ï¼Œæ ¸å¿ƒæ˜¯å‘ç°æƒå€¼ä¸­ç‚¹è¿™ä¸€éšè—æ€§è´¨ã€‚ç«èµ›ä¸­å³ä½¿æœªä¼˜åŒ–åˆ°åº•ï¼Œå†™å‡ºå¸¦å‰ªæçš„æš´åŠ›ä¹Ÿèƒ½è·éƒ¨åˆ†åˆ†ã€‚æœ€ä¼˜è§£åˆ™éœ€æ·±åˆ»ç†è§£é—®é¢˜ç»“æ„å¹¶é€‰æ‹©åˆé€‚æ•°æ®ç»“æ„ï¼"

---

## 4. C++æ ¸å¿ƒä»£ç å®ç°èµæ

**é€šç”¨æ ¸å¿ƒå®ç°**ï¼ˆç»¼åˆé¢˜è§£ç²¾åï¼‰ï¼š
```cpp
#include <bits/stdc++.h>
using namespace std;
typedef long long ll;
const int N = 5e5+5;
const ll INF = 1e18;

int n, m, a[N], b[N];
ll x[N], y[N], ans = -INF;
int pos[N*2]; // è®°å½•ç±»åˆ«åœ¨åºåˆ—aä¸­çš„ä½ç½®

struct SegmentTree {
    struct Node { ll val, tag; int L, R; } tr[N<<2];
    // æ”¯æŒåŒºé—´åŠ /èµ‹å€¼æ“ä½œ
    void update(int rt, int l, int r, int op, int vl, int vr) { /*...*/ } 
    pair<ll, int> query(int rt, int l, int r) { /*...*/ }
} seg;

void solve(bool swap_flag) {
    // 1. è®¡ç®—æƒå€¼ä¸­ç‚¹
    ll sum = 0; int mid_pos = 0;
    for (int i=1; i<=n; sum+=x[i++]) 
        if (2*(sum + x[i]) > sum) { mid_pos = i; break; }

    // 2. åˆå§‹åŒ–è¾¹ç•Œé™åˆ¶
    for (int i=1; i<=n; i++) pos[a[i]] = i;
    vector<int> L(m+1, 1), R(m+1, n);
    for (int i=1; i<=m; i++) 
        if (pos[b[i]]) 
            pos[b[i]] <= mid_pos ? L[i] = pos[b[i]] + 1 : R[i] = pos[b[i]] - 1;

    // 3. æ‰«æçº¿+å•è°ƒæ ˆ
    stack<int> stkL, stkR;
    for (int r=1; r<=m; r++) {
        // æ›´æ–°å·¦è¾¹ç•Œæ ˆ
        while (!stkL.empty() && L[stkL.top()] <= L[r]) {
            seg.update(..., L[stkL.top()], ...);
            stkL.pop();
        }
        stkL.push(r);
        
        // æ›´æ–°å³è¾¹ç•Œæ ˆï¼ˆç±»ä¼¼ï¼‰
        // æŸ¥è¯¢å¹¶æ›´æ–°å…¨å±€ç­”æ¡ˆ
        auto [cur_val, l_opt] = seg.query(1, r);
        if (cur_val + y[r] > ans) 
            ans = cur_val + y[r], ansL = l_opt, ansR = r;
    }
}
```

**é¢˜è§£ä¸€ï¼ˆè‹è”å°æ¸£ï¼‰ç‰‡æ®µèµæ**ï¼š
```cpp
// è¾¹ç•Œæ›´æ–°æ ¸å¿ƒé€»è¾‘
while (tp1 && mxl[b[st1[tp1]]] < mxl[b[i]]) {
    modify(1, st1[tp1-1]+1, st1[tp1], mxl[b[i]], 0); // çº¿æ®µæ ‘åŒºé—´æ›´æ–°
    tp1--;
}
st1[++tp1] = i;
modify(1, st1[tp1-1]+1, i, mxl[b[i]], 0); // åº”ç”¨æ–°è¾¹ç•Œ
```
**å­¦ä¹ ç¬”è®°**ï¼šæ ˆå­˜å‚¨ä¸‹æ ‡ï¼Œçº¿æ®µæ ‘æ›´æ–°åŒºé—´å€¼ï¼Œä¿è¯O(1)å‡æ‘Šå¤æ‚åº¦ã€‚

---

## 5. ç®—æ³•å¯è§†åŒ–ï¼šåƒç´ åŠ¨ç”»æ¼”ç¤º

* **ä¸»é¢˜**ï¼š8ä½åƒç´ é£æ ¼"ç®—æ³•æ¢é™©å®¶"é—¯å…³  
* **æ ¸å¿ƒæ¼”ç¤º**ï¼š  
  1. **ç½‘æ ¼åœºæ™¯**ï¼š  
     - ä¸Šæ–¹åƒç´ æ¡ï¼šTHUè¯¾ç¨‹åºåˆ—ï¼ˆé¢œè‰²=ç±»åˆ«ï¼Œé«˜åº¦=ä¹è¶£åº¦ï¼‰  
     - ä¸‹æ–¹åƒç´ æ¡ï¼šPKUè¯¾ç¨‹åºåˆ—  
     - ä¸­å¤®é«˜äº®ï¼šæƒå€¼ä¸­ç‚¹ä½ç½®ï¼ˆé—ªçƒæç¤ºï¼‰  
  2. **æ‰«æçº¿ç§»åŠ¨**ï¼š  
     - çº¢è‰²åƒç´ å—ä»å·¦å‘å³æ‰«æPKUåºåˆ—  
     - é‡åˆ°å†²çªç±»åˆ«æ—¶ï¼ŒTHUå¯¹åº”ä½ç½®å˜æš—ï¼ˆç¦ç”¨ï¼‰  
  3. **å•è°ƒæ ˆæ“ä½œ**ï¼š  
     - æ ˆåƒç´ å—ä»åº•éƒ¨å †å ï¼Œé¢œè‰²éšè¾¹ç•Œå€¼å˜åŒ–  
     - å¼¹å‡ºæ—¶æ’­æ”¾"ç¢è£‚"éŸ³æ•ˆï¼Œæ›´æ–°çº¿æ®µæ ‘åŒºåŸŸ  
  4. **çº¿æ®µæ ‘æŸ¥è¯¢**ï¼š  
     - æ ‘ç»“æ„ä¾§è¾¹æ˜¾ç¤ºï¼Œå½“å‰æŸ¥è¯¢è·¯å¾„é«˜äº®  
     - å¶å­èŠ‚ç‚¹é—ªå…‰è¡¨ç¤ºç­”æ¡ˆæ›´æ–°  
* **äº¤äº’æ§åˆ¶**ï¼š  
  - æ–¹å‘é”®ï¼šå•æ­¥å‰è¿›/åé€€  
  - Aé”®ï¼šè‡ªåŠ¨æ’­æ”¾ï¼ˆé€Ÿåº¦å¯è°ƒï¼‰  
  - é€šå…³éŸ³æ•ˆï¼š8-bité£æ ¼èƒœåˆ©BGM  

---

## 6. æ‹“å±•ç»ƒä¹ ä¸ç›¸ä¼¼é—®é¢˜

* **é€šç”¨æŠ€å·§è¿ç§»**ï¼š  
  - æƒå€¼ä¸­ç‚¹æ€§è´¨ â†’ æœ€å€¼çº¦æŸé—®é¢˜ï¼ˆå¦‚ï¼šå¸¦é™åˆ¶çš„åŒºé—´è¦†ç›–ï¼‰  
  - æ‰«æçº¿+å•è°ƒæ ˆ â†’ ç›´æ–¹å›¾æœ€å¤§çŸ©å½¢ã€é™é›¨é‡é—®é¢˜  
* **æ¨èé¢˜ç›®**ï¼š  
  1. **æ´›è°· P1064**ï¼šä¾èµ–èƒŒåŒ…ï¼ˆåˆ†ç»„èƒŒåŒ…æ¨¡æ¿ï¼‰  
  2. **æ´›è°· P5490**ï¼šæ‰«æçº¿æ±‚çŸ©å½¢é¢ç§¯å¹¶  
  3. **æ´›è°· P1886**ï¼šå•è°ƒé˜Ÿåˆ—æ±‚æ»‘åŠ¨çª—å£æœ€å€¼  

---

## 7. å­¦ä¹ å¿ƒå¾—ä¸ç»éªŒåˆ†äº«

> **å‚è€ƒç»éªŒ**ï¼š  
> _"è°ƒè¯•æ—¶å…ˆéªŒè¯æƒå€¼ä¸­ç‚¹è®¡ç®—æ˜¯å¦æ­£ç¡®ï¼Œå†ç”¨å°æ•°æ®æµ‹è¯•å•è°ƒæ ˆå¼¹å‡ºé€»è¾‘"_  
> **ç‚¹è¯„**ï¼šåˆ†é˜¶æ®µéªŒè¯ï¼ˆæ€§è´¨è¯æ˜â†’è¾¹ç•Œå¤„ç†â†’çº¿æ®µæ ‘æ›´æ–°ï¼‰æ˜¯è°ƒè¯•å¤æ‚ç®—æ³•çš„æœ‰æ•ˆè·¯å¾„ï¼

---

> **ç»“è®º**ï¼šæœ¬é¢˜èåˆäº†é—®é¢˜è½¬åŒ–ã€æ•°æ®ç»“æ„ä¼˜åŒ–ç­‰æ ¸å¿ƒæ€ç»´ã€‚æŒæ¡æƒå€¼ä¸­ç‚¹æ€§è´¨å’Œæ‰«æçº¿å®ç°ï¼Œå³è§£é”åŒç±»é—®é¢˜ï¼ä¸‹æ¬¡æˆ‘ä»¬å°†æ¢ç´¢æ›´å¤æ‚çš„åŠ¨æ€è§„åˆ’å˜ç§â€”â€”å†è§ï¼ğŸš€

---
å¤„ç†ç”¨æ—¶ï¼š217.76ç§’
# 题目信息

# 【模板】多项式复合函数

## 题目背景

有一天，NaCly_Fish看见 $\mathsf r \color{red} \mathsf{qy}$ 在群里说：“终于把多项式复合写完啦！qwq”  
她便好奇地去问 $\mathsf r \color{red} \mathsf{qy}$：“这个东西怎么写啊？”   

$\mathsf r \color{red} \mathsf{qy}$ 只丢给了她一份嘤文的 pdf，然而她根本看不懂。  
于是她求助于你，希望你能帮她解决这个难题。

## 题目描述

给定一个 $n$ 次多项式 $F(x)$，和一个 $m$ 次多项式 $G(x)$，你需要求一个 $n$ 次多项式 $H(x)$ ，满足条件：  
$$H(x) \equiv F(G(x))\space (\text{mod }x^{n+1})$$   
换种说法，你要求的多项式应满足：  
$$H(x) \equiv \sum\limits_{i=0}^n [x^i]F(x)\times G(x)^i \space (\text{mod }x^{n+1})$$
将结果的各项系数对 $998244353$ 取模。

## 说明/提示

**数据范围：**  
$1\le m \le n \le 20000$    
$f_i,g_i \in [0,998244353)\cap \mathbb Z$

## 样例 #1

### 输入

```
5 1
1 9 2 6 0 8
1 7
```

### 输出

```
26 497 4900 29498 96040 134456 
```

# AI分析结果

# 💡 洛语云笺的C++算法解析：多项式复合函数 深入学习指南 💡

> 今天我们来一起分析「模板 · 多项式复合函数」这道**高阶**C++编程题。它不像背包或搜索那样直观，却是一场**抽象代数与算法优化**的盛宴。别担心，洛语云笺会带你一步步拆解这座“符号之塔”。

---

## 1. 题目解读与策略初探

### ✨ 核心挑战
> 我们要在**模意义下**计算 $H(x)=F(G(x))\mod x^{n+1}$，其中 $F,G$ 是给定多项式。  
> 难点在于：**如何把“代入”这一数学操作，转化为可在 $O(n\log^c n)$ 时间内跑完的算法？**

### 🔍 算法侦探：如何在题目中发现线索？
| 线索 | 解读 |
|---|---|
| **线索1：形式化目标** | “求 $F(G(x))$ 的前 $n+1$ 项” → **多项式复合** |
| **线索2：数据规模** | $n\le 2\times 10^4$ → 允许 $O(n^{1.5}\log n)$ 或更优 |
| **线索3：模数** | $998244353$ → 自带 $3$ 次单位根，暗示 **NTT/FFT** |

### 🧠 思维链构建：从线索到策略
1.  朴素展开 $F(G)=\sum_{i=0}^n f_i G^i$ 需要 $O(n^2\log n)$，**TLE**。
2.  需要“分块”或“倍增”思想，把 $G^i$ 的计算**批量合并**。
3.  最终锁定两条主流路线：
    * **Brent-Kung**（分块+泰勒展开）  
    * **mrsrz 分块**（根号分治+NTT）

---

## 2. 精选优质题解参考

| 题解 | 亮点提炼 | 洛语云笺点评 |
|---|---|---|
| **Aleph1022**（Bostan-Mori） | 用二元分式 $\frac{1}{1-yF(x)}$ 统一处理 $[x^n]F^k(x)$，复杂度 $O(n\log^2 n)$ | 数学味极浓，适合**理论拔高**；但实现细节多，易 TLE |
| **mrsrz**（根号分治） | 把 $i$ 拆成 $aL+b$，预处理 $G^{aL}$ 与 $G^b$，再卷积，复杂度 $O(n\sqrt n\log n)$ | **工程友好**：思路直观，常数小，**考场首选** |
| **yurzhang**（Brent-Kung） | 泰勒展开+倍增递归，复杂度 $O((n\log n)^{1.5})$ | 经典算法，模板价值高；需精细调参 $m=\sqrt{n/\log n}$ |

---

## 3. 解题策略深度剖析

### 🎯 核心难点与关键步骤（以 mrsrz 分块为例）
| 关键点 | 分析 & 学习笔记 |
|---|---|
| **1. 分块思想** | 把 $i=aL+b$，则 $G^i=(G^L)^a \cdot G^b$。只需存 $L=\sqrt n$ 组 $G^{aL}$ 与 $G^b$。<br>💡**笔记**：**根号分治**将 $O(n^2)$ 拆成 $O(nL+n^2/L)$。|
| **2. 预处理卷积** | 用 NTT 批量计算 $G^0,G^1,\dots,G^{L-1}$ 与 $G^0,G^L,G^{2L},\dots$。<br>💡**笔记**：一次 NTT 可同时得到多项式点值，避免重复 DFT。|
| **3. 累加答案** | 对每个 $a,b$ 计算 $f_{aL+b}\cdot G^{aL}\cdot G^b$，再逐项累加。<br>💡**笔记**：把**点乘**转成**卷积**，再用 NTT 实现 $O(n\log n)$。|

### ⚔️ 策略竞技场
| 策略 | 复杂度 | 优缺点 | 实战得分 |
|---|---|---|---|
| **暴力展开** | $O(n^2\log n)$ | 思路直白，必 TLE | 30% |
| **mrsrz 分块** | $O(n\sqrt n\log n)$ | 实现简单，常数小 | **100%** |
| **Brent-Kung** | $O((n\log n)^{1.5})$ | 理论优美，常数大 | 100%（需精细实现） |

---

## 4. C++核心代码实现赏析

### 🎯 通用核心参考（mrsrz 分块）
```cpp
#include <bits/stdc++.h>
using namespace std;
const int N = 1 << 16, mod = 998244353;
int n, m, L, f[N], g[N], ans[N];
int B1[150][N], B2[250][N];   // B1[j][k] = [x^k] G^j, B2[i][k] = [x^k] G^{iL}

/* ===== NTT 模板 ===== */
inline int qpow(int a, int b){
    int res = 1;
    for (; b; b >>= 1, a = 1LL * a * a % mod)
        if (b & 1) res = 1LL * res * a % mod;
    return res;
}
void NTT(int *a, int lim, int inv){
    // 标准 NTT 实现略
}
/* ===== 主逻辑 ===== */
int main(){
    scanf("%d%d", &n, &m); ++n, ++m;
    for (int i = 0; i < n; ++i) scanf("%d", f + i);
    for (int i = 0; i < m; ++i) scanf("%d", g + i);

    L = sqrt(n) + 1;
    // 1. 预处理 G^0..G^{L-1} 到 B1
    B1[0][0] = 1;
    for (int i = 1; i < L; ++i){
        // 用 NTT 计算 B1[i] = B1[i-1] * g
    }
    // 2. 预处理 G^0, G^L, G^{2L}... 到 B2
    B2[0][0] = 1;
    for (int i = 1; i * L < n; ++i){
        // 用 NTT 计算 B2[i] = B2[i-1] * B1[L]
    }
    // 3. 累加答案
    for (int a = 0; a * L < n; ++a){
        for (int b = 0; b < L && a * L + b < n; ++b){
            for (int k = 0; k < n; ++k){
                ans[k] = (ans[k] + 1LL * f[a * L + b] * B1[b][k] % mod * B2[a][k]) % mod;
            }
        }
    }
    for (int i = 0; i < n; ++i) printf("%d ", ans[i]);
    return 0;
}
```
**代码解读概要**：  
1.  把 $i$ 拆成 $aL+b$。  
2.  先算 $G^0,\dots,G^{L-1}$ 与 $G^0,G^L,G^{2L},\dots$ 的系数，用 NTT 卷积。  
3.  双重循环逐项累加 $f_{aL+b}\cdot G^{aL+b}$。

---

## 5. 算法可视化：像素动画演示

> 主题：**“像素卷积工厂”**  
> 目标：让学习者**看见**分块卷积如何把 $n^2$ 次乘法压缩成 $O(n\sqrt n\log n)$。

| 场景 | 像素表现 | 互动设计 |
|---|---|---|
| **初始化** | 8×8 像素网格表示多项式系数，颜色深浅代表数值大小 | 点击“开始”播放动画 |
| **分块** | 用**像素传送带**把 $G$ 切成 $L$ 段，每段用不同颜色标记 | 滑块控制 $L=\sqrt n$ |
| **NTT 卷积** | 像素块在“卷积机”里旋转、闪烁 → 得到 $G^{aL}$ 与 $G^b$ | 音效“叮”提示一次卷积完成 |
| **累加答案** | 像素累加条实时长高，显示当前答案多项式 | 进度条显示累加百分比 |
| **成功** | 像素礼花 + 8-bit 胜利音效 | 重播按钮 |

---

## 6. 拓展练习与相似问题思考

| 通用场景 | 例子 |
|---|---|
| **多项式快速幂** | 计算 $G^k \mod x^{n+1}$ |
| **多项式复合逆** | 已知 $H=F(G)$，求 $F$ |
| **生成函数复合** | 计数问题中把“结构”代入“权值” |

**洛谷推荐**  
- **P4238** 多项式求逆（练 NTT 模板）  
- **P4725** 多项式对数函数（链式法则）  
- **P4841** 城市规划（复合+生成函数）  

---

## 7. 学习心得与经验分享

> **来自 yurzhang**：“预处理原根、循环展开、手写内存池，能把 Brent-Kung 的常数压到可过线。”  
> **洛语云笺点评**：**常数优化**同样是竞赛实力的一部分！学会用 `__builtin_ctz`、`restrict` 等底层技巧，能让优雅的理论跑得飞快。

---

<conclusion>
从“暴力展开”到“分块卷积”，再到“Brent-Kung”，我们见证了**数学模型**与**算法工程**的完美结合。掌握多项式复合，不仅是模板积累，更是**抽象思维**的一次飞跃。下次遇到看似“符号堆砌”的题目，记得先问：  
> “我能否把它拆成**可卷积的子问题**？”  
继续加油，下一份像素动画见！
</conclusion>

---
处理用时：104.05秒
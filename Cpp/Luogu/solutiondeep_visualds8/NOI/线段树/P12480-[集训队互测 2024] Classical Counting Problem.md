# é¢˜ç›®ä¿¡æ¯

# [é›†è®­é˜Ÿäº’æµ‹ 2024] Classical Counting Problem

## é¢˜ç›®æè¿°

ç»™å®šä¸€æ£µ $n$ ä¸ªèŠ‚ç‚¹çš„æ— æ ¹æ ‘ï¼Œä½ å¯ä»¥åšå¦‚ä¸‹æ“ä½œè‹¥å¹²æ¬¡ï¼š

- é€‰æ‹©å½“å‰æ ‘ä¸Šç¼–å·æœ€å¤§æˆ–æœ€å°çš„ç‚¹ï¼Œåˆ å»å®ƒå’Œä»¥å®ƒä¸ºä¸€ä¸ªç«¯ç‚¹çš„æ‰€æœ‰è¾¹ï¼Œä¿ç•™ä»»æ„ä¸€ä¸ªè¿é€šå—ä½œä¸ºæ“ä½œåçš„æ ‘ã€‚

ä»¤ $\min$ ä¸ºæ ‘ä¸Šæ‰€æœ‰èŠ‚ç‚¹ç¼–å·çš„æœ€å°å€¼ï¼Œ$\max$ ä¸ºæ ‘ä¸Šæ‰€æœ‰èŠ‚ç‚¹ç¼–å·çš„æœ€å¤§å€¼ï¼Œ$size$ ä¸ºæ ‘ä¸Šçš„èŠ‚ç‚¹ä¸ªæ•°ï¼Œåˆ™ä¸€æ£µæ ‘çš„æƒå€¼ä¸º $\min \cdot \max \cdot size$ã€‚æ±‚æ‰€æœ‰èƒ½é€šè¿‡ä¸Šè¿°æ“ä½œå¾—åˆ°çš„éç©ºçš„æ ‘çš„æƒå€¼å’Œï¼Œå¯¹ $2^{32}$ å–æ¨¡ã€‚

## è¯´æ˜/æç¤º

### å­ä»»åŠ¡

| å­ä»»åŠ¡ç¼–å· | ç‰¹æ®Šæ€§è´¨ | åˆ†å€¼ |
| :---: | :---: | :---: |
| 1 | $n \leq 10$ | 5 |
| 2 | $n \leq 20$ | 10 |
| 3 | $n \leq 100$ | 10 |
| 4 | $n \leq 2000$ | 15 |
| 5 | $n \leq 3 \times 10^4$ | 15 |
| 6 | ç»™å®šçš„æ ‘ä¸­ï¼Œæ¯ä¸ªèŠ‚ç‚¹çš„åº¦æ•° $\leq 2$ | 20 |
| 7 | æ—  | 25 |


## æ ·ä¾‹ #1

### è¾“å…¥

```
6
3
1 2
2 3
3
1 3
2 3
7
2 1
3 1
4 1
5 1
6 5
7 6
6
2 1
3 1
4 1
5 4
6 1
9
2 1
3 2
4 3
5 1
6 4
7 5
8 2
9 3
9
2 1
3 2
4 3
5 4
6 5
7 2
8 3
9 5```

### è¾“å‡º

```
39
35
528
221
1145
1919```

# AIåˆ†æç»“æœ

---
# ğŸ’¡ æ´›è¯­äº‘ç¬ºçš„C++ç®—æ³•è§£æï¼šClassical Counting Problem æ·±å…¥å­¦ä¹ æŒ‡å— ğŸ’¡

> æ¬¢è¿æ¥åˆ°ä»Šå¤©çš„é«˜é˜¶æ€ç»´æ¢é™©ï¼æˆ‘ä»¬è¦åœ¨ä¸€æ£µæ ‘ä¸Šâ€œåˆ åˆ å‰ªå‰ªâ€ï¼Œå´è¦åœ¨æ‰€æœ‰å¯èƒ½çš„å­æ ‘ä¸­ï¼Œç»Ÿè®¡ä¸€ä¸ªä¸ **æœ€å°ç‚¹Ã—æœ€å¤§ç‚¹Ã—èŠ‚ç‚¹æ•°** ç›¸å…³çš„æƒå€¼å’Œã€‚  
> è¿™é¢˜ä¹çœ‹åƒâ€œç æ ‘æ¸¸æˆâ€ï¼Œå®åˆ™æ˜¯ **ç‚¹åˆ†æ²» + æ‰«æçº¿ + çº¿æ®µæ ‘** çš„ä¸‰é‡å¥ï¼Œæ˜¯å¯¹â€œæ ‘ä¸Šè®¡æ•°â€ä¸â€œå¤šç»´ååºâ€çš„æè‡´è€ƒå¯Ÿã€‚è®©æˆ‘ä»¬åƒä¾¦æ¢ä¸€æ ·ï¼Œä¸€æ­¥æ­¥æ­å¼€å®ƒçš„é¢çº±ï¼

---

## 1. é¢˜ç›®è§£è¯»ä¸ç­–ç•¥åˆæ¢

âœ¨ **æœ¬é¢˜æ ¸å¿ƒæŒ‘æˆ˜**ï¼š  
> åœ¨ä¸€æ£µæ— æ ¹æ ‘ä¸Šï¼Œé€šè¿‡â€œæ¯æ¬¡åˆ é™¤å½“å‰æœ€å¤§/å°ç¼–å·èŠ‚ç‚¹â€çš„æ“ä½œï¼Œå¯ä»¥ç•™ä¸‹ä»»æ„è¿é€šå—ã€‚æ±‚æ‰€æœ‰å¯å‡ºç°çš„éç©ºè¿é€šå— **minÂ·maxÂ·size** ä¹‹å’Œï¼Œæ¨¡ 2Â³Â²ã€‚

âœ¨ **æ ¸å¿ƒç®—æ³•æ ‡ç­¾**ï¼š  
ç‚¹åˆ†æ²»ï¼ˆDivide & Conquer on Treeï¼‰ â€¢ æ‰«æçº¿ï¼ˆSweep Lineï¼‰ â€¢ çº¿æ®µæ ‘ï¼ˆSegment Treeï¼‰ â€¢ æ ‘ä¸Šè·¯å¾„ â€¢ ååºç»Ÿè®¡

---

### ğŸ” ç®—æ³•ä¾¦æ¢ï¼šå¦‚ä½•åœ¨é¢˜ç›®ä¸­å‘ç°çº¿ç´¢ï¼Ÿ

| çº¿ç´¢ | ä¾¦æ¢ç¬”è®° |
|---|---|
| **çº¿ç´¢1ï¼šé—®é¢˜ç›®æ ‡** | éœ€è¦ç»Ÿè®¡æ‰€æœ‰â€œåˆæ³•è¿é€šå—â€çš„æƒå€¼å’Œã€‚å…³é”®è¯ï¼š**â€œæ‰€æœ‰â€ã€â€œç»Ÿè®¡â€** â†’ æç¤ºâ€œè®¡æ•°ç±»é—®é¢˜â€ã€‚ |
| **çº¿ç´¢2ï¼šæ“ä½œçº¦æŸ** | æ¯æ¬¡åªèƒ½åˆ â€œå½“å‰æœ€å¤§/æœ€å°â€èŠ‚ç‚¹ï¼Œç•™ä¸‹çš„å¿…é¡»ä»æ˜¯ **è¿é€šå—** â†’ æç¤ºâ€œåˆ ç‚¹é¡ºåºâ€ä¸â€œè¿é€šæ€§â€å¼ºç›¸å…³ã€‚ |
| **çº¿ç´¢3ï¼šæƒå€¼ç»“æ„** | minÂ·maxÂ·size åŒæ—¶å‡ºç°ï¼Œä¸” **size ä¸ min,max è€¦åˆ** â†’ ç›´æ¥æšä¸¾ min,max å†ç®— size æ˜¯ O(nÂ²) èµ·æ­¥ï¼Œéœ€è¦æ›´èªæ˜çš„åŠæ³•ã€‚ |
| **çº¿ç´¢4ï¼šæ•°æ®è§„æ¨¡** | nâ‰¤1e5ï¼ŒO(nÂ²) ä¸å¯æ¥å— â†’ éœ€è¦ **O(n logÂ²n)** çº§åˆ«ç®—æ³• â†’ ç‚¹åˆ†æ²» + æ•°æ®ç»“æ„ã€‚ |

---

### ğŸ§  æ€ç»´é“¾æ„å»ºï¼šä»çº¿ç´¢åˆ°ç­–ç•¥

1.  ä» **â€œåˆ ç‚¹â€ä¸å¥½æƒ³** â†’ **å€’ç€â€œåŠ ç‚¹â€**ï¼šæŠŠåˆ ç‚¹è¿‡ç¨‹å€’æ”¾ï¼Œç­‰ä»·äºä»ç©ºé›†å¼€å§‹ï¼Œæ¯æ¬¡æŠŠ **å½“å‰æœªå‡ºç°çš„æœ€å°æˆ–æœ€å¤§ç¼–å·** è¿è¿›æ¥ã€‚  
2.  å‘ç° **â€œè¿é€šå—åˆæ³•æ€§â€** åªä¸ **min,max** æœ‰å…³ï¼š  
    ä¸€å¯¹ (mn,mx) èƒ½å”¯ä¸€ç¡®å®šä¸€æ£µåˆæ³•å­æ ‘ï¼Œå½“ä¸”ä»…å½“ **mn â†’ mx è·¯å¾„ä¸Šçš„æ‰€æœ‰ç‚¹ç¼–å· âˆˆ [mn,mx]**ï¼Œç„¶åå‘å¤–æ‰©å±•æ‰€æœ‰ä»è½åœ¨ [mn,mx] çš„é‚»å±…ã€‚  
3.  äºæ˜¯é—®é¢˜è½¬åŒ–ä¸ºï¼š  
    **æ±‚æ‰€æœ‰æ»¡è¶³æ¡ä»¶çš„ (mn,mx) å¯¹ï¼Œå…¶å¯¹åº”çš„è¿é€šå—çš„ minÂ·maxÂ·size ä¹‹å’Œã€‚**  
4.  éš¾ç‚¹ï¼šå¦‚ä½• **é«˜æ•ˆç»Ÿè®¡ size**ï¼Ÿ  
    ç»å…¸ trickï¼š**æ‹†è´¡çŒ®**ï¼æŠŠ size æ‹†æˆâ€œæœ‰å¤šå°‘ä¸ªèŠ‚ç‚¹ v å±äºè¯¥è¿é€šå—â€ï¼Œäºæ˜¯  
    **æ€»ç­”æ¡ˆ = Î£_{åˆæ³•(mn,mx)} Î£_{vâˆˆè¿é€šå—} mnÂ·mx**  
    äº¤æ¢æ±‚å’Œé¡ºåº â†’ **Î£_{v} Î£_{(mn,mx) æ»¡è¶³ vâˆˆè¿é€šå—} mnÂ·mx**  
5.  å¯¹ **å›ºå®š v**ï¼Œåˆæ³•çš„ (mn,mx) éœ€æ»¡è¶³ï¼š  
    mn â‰¤ minPath(v) ä¸” maxPath(v) â‰¤ mx ä¸” mn â‰¤ mx  
    è¿™æ˜¯ä¸€ä¸ª **äºŒç»´ååº**ï¼Œå¯ç”¨ **ç‚¹åˆ†æ²» + æ‰«æçº¿ + çº¿æ®µæ ‘** è§£å†³ï¼

---

## 2. ç²¾é€‰ä¼˜è´¨é¢˜è§£å‚è€ƒ

### é¢˜è§£ä¸€ï¼š_Ad_Astra_ï¼ˆèµï¼š3ï¼‰
* **ç‚¹è¯„**ï¼š  
  è¿™ç¯‡é¢˜è§£æœ€ç²¾å½©çš„åœ°æ–¹åœ¨äº **æŠŠâ€œåˆ ç‚¹â€è½¬åŒ–ä¸ºâ€œåŠ ç‚¹â€**ï¼Œå¹¶ **ç”¨ (mn,mx) å”¯ä¸€åˆ»ç”»ä¸€æ£µåˆæ³•å­æ ‘**ã€‚  
  éšåå¼•å…¥ **ç‚¹åˆ†æ²»** å¤„ç†è·¯å¾„ä¿¡æ¯ï¼Œå†åˆ©ç”¨ **æ‰«æçº¿ + çº¿æ®µæ ‘** è§£å†³â€œmn,mx,v ä¸‰ç»´ååºâ€ï¼Œæ€è·¯ä¸€æ°”å‘µæˆã€‚  
  ä»£ç ä¸­å·§å¦™åœ°ç”¨ **çº¿æ®µæ ‘åŒæ—¶ç»´æŠ¤ `s, val, c`** ä¸‰ä¸ªæ•°ç»„ï¼Œåˆ†åˆ«è¡¨ç¤ºï¼š  
  â€¢ `s`ï¼šåŒºé—´å†…æ‰€æœ‰ mn å¯¹ç­”æ¡ˆçš„è´¡çŒ®å’Œ  
  â€¢ `val`ï¼šåŒºé—´å†…åˆæ³•çš„ mn ä¹‹å’Œ  
  â€¢ `c`ï¼šåŒºé—´å†…æ»¡è¶³æ¡ä»¶çš„ v çš„æ•°é‡  
  é€šè¿‡ **lazy tag** å®ç°åŒºé—´åŠ ï¼Œé€»è¾‘æ¸…æ™°ï¼Œå¤æ‚åº¦ O(n logÂ²n)ã€‚  
  å”¯ä¸€çš„å°é—æ†¾æ˜¯ä»£ç è¾ƒé•¿ï¼Œå˜é‡åç•¥æ˜¾æ™¦æ¶©ï¼Œä½†é…åˆæ³¨é‡Šé˜…è¯»ä»æ˜¯æä½³çš„å­¦ä¹ ææ–™ã€‚

### é¢˜è§£äºŒï¼šyishanyiï¼ˆèµï¼š1ï¼‰
* **ç‚¹è¯„**ï¼š  
  è¿™ç¯‡é¢˜è§£ä¸ _Ad_Astra_ çš„æ€è·¯é«˜åº¦ä¸€è‡´ï¼Œä½† **è¯­è¨€æ›´ç²¾ç‚¼**ï¼Œ**ä»£ç æ›´ç°ä»£**ï¼ˆC++17 é£æ ¼ï¼‰ã€‚  
  äº®ç‚¹åœ¨äºï¼š  
  â€¢ ç”¨ **lambda + STL** ç®€åŒ–ç¦»æ•£åŒ–ä¸æ‰«æçº¿è¿‡ç¨‹  
  â€¢ æ˜ç¡®ç‚¹å‡º **â€œå­æ ‘å»é‡â€æ—¶ä¸èƒ½æ›´æ–° min/max**ï¼Œå¦åˆ™ä¼šå¯¼è‡´é‡å¤è®¡æ•°  
  â€¢ ä»£ç ç»“æ„æ¸…æ™°ï¼Œæ³¨é‡Šè¯¦å°½ï¼Œé€‚åˆå¯¹ç…§å­¦ä¹   
  è‹¥è¯´ä¸è¶³ï¼Œå¯èƒ½æ˜¯æ²¡æœ‰ _Ad_Astra_ çš„é…å›¾ç›´è§‚ï¼Œä½†æ–‡å­—æè¿°å·²è¶³å¤Ÿåˆ°ä½ã€‚

---

## 3. è§£é¢˜ç­–ç•¥æ·±åº¦å‰–æ

### ğŸ¯ æ ¸å¿ƒéš¾ç‚¹ä¸å…³é”®æ­¥éª¤ï¼ˆæœ€ä¼˜è§£æ³•ï¼‰

#### å…³é”®ç‚¹1ï¼šå¦‚ä½•åˆ»ç”»â€œåˆæ³•è¿é€šå—â€ï¼Ÿ
* **åˆ†æ**ï¼š  
  å€’ç€çœ‹æ“ä½œï¼Œä¸€æ£µå­æ ‘åˆæ³• â‡” å…¶ min,max ä¹‹é—´çš„è·¯å¾„å…¨è¢«åŒ…å«ï¼Œä¸”æ‰€æœ‰ç¼–å· âˆˆ [min,max]ã€‚  
  äºæ˜¯ **(min,max) â†” ä¸€æ£µå”¯ä¸€å­æ ‘**ã€‚
* ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼š  
  å½“â€œæ“ä½œåºåˆ—â€éš¾ä»¥ç›´æ¥å¤„ç†æ—¶ï¼Œ**å€’åºæ€è€ƒ**æˆ–**å¯»æ‰¾ä¸å˜é‡**æ˜¯å¸¸ç”¨æŠ€å·§ã€‚

#### å…³é”®ç‚¹2ï¼šå¦‚ä½•æ‹†è´¡çŒ®æŠŠâ€œsizeâ€å˜æˆâ€œè®¡æ•°â€ï¼Ÿ
* **åˆ†æ**ï¼š  
  åŸå¼ Î£ minÂ·maxÂ·size = Î£_{v} Î£_{(min,max) å« v} minÂ·max  
  æŠŠâ€œsizeâ€æ‹†æˆâ€œv æ˜¯å¦å±äºè¯¥è¿é€šå—â€çš„ 0/1 è´¡çŒ®ï¼Œè½¬åŒ–ä¸º **ä¸‰ç»´ååº** é—®é¢˜ã€‚
* ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼š  
  **æ‹†è´¡çŒ®**æ˜¯å¤„ç†â€œå¸¦ size/é•¿åº¦/æƒå€¼â€è®¡æ•°é—®é¢˜çš„ä¸‡èƒ½é’¥åŒ™ã€‚

#### å…³é”®ç‚¹3ï¼šå¦‚ä½•ç”¨ç‚¹åˆ†æ²» + æ‰«æçº¿ + çº¿æ®µæ ‘è§£å†³ï¼Ÿ
* **åˆ†æ**ï¼š  
  1.  **ç‚¹åˆ†æ²»**ï¼šå›ºå®š lca=rtï¼ŒæŠŠè·¯å¾„æ‹†æˆ rtâ†’u, rtâ†’v, rtâ†’x ä¸‰æ®µã€‚  
  2.  **æ‰«æçº¿**ï¼šæŒ‰ max å‡åºå¤„ç†ï¼ŒæŠŠ (min,x) æ’å…¥çº¿æ®µæ ‘ã€‚  
  3.  **çº¿æ®µæ ‘**ï¼šç»´æŠ¤åŒºé—´ `std=Î£min`, `cnt=å«xç‚¹æ•°`, `sum=Î£minÂ·cnt`ï¼Œæ”¯æŒï¼š  
      â€¢ æ’å…¥ lï¼ˆå•ç‚¹åŠ  stdï¼‰  
      â€¢ æ’å…¥ xï¼ˆåŒºé—´åŠ  cntï¼‰  
      â€¢ æŸ¥è¯¢ rï¼ˆåŒºé—´æ±‚ sumï¼‰  
  4.  **å­æ ‘å»é‡**ï¼šå¯¹æ¯æ£µå­æ ‘å†è·‘ä¸€éï¼Œå‡å»é‡å¤è´¡çŒ®ã€‚
* ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼š  
  ç‚¹åˆ†æ²»æŠŠæ ‘ä¸Šé—®é¢˜å˜æˆâ€œå¸¦ lca çš„åºåˆ—é—®é¢˜â€ï¼Œæ‰«æçº¿ + çº¿æ®µæ ‘æ˜¯å¤„ç† **äºŒç»´/ä¸‰ç»´ååº** çš„æ ‡é…ã€‚

---

### âš”ï¸ ç­–ç•¥ç«æŠ€åœºï¼šä¸åŒè§£æ³•çš„å¯¹æ¯”

| ç­–ç•¥ | æ ¸å¿ƒæ€æƒ³ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ / å¾—åˆ† |
|---|---|---|---|---|
| **æš´åŠ›æšä¸¾ (O(nÂ³))** | æšä¸¾æ‰€æœ‰å­é›†ï¼Œæ£€æŸ¥è¿é€šæ€§ | æ€è·¯ç›´æ¥ï¼Œæ˜“å†™ | n>200 å³è¶…æ—¶ | å­ä»»åŠ¡1-2ï¼Œâ‰¤20åˆ† |
| **å›ºå®šmin+å¹¶æŸ¥é›† (O(nÂ²))** | æšä¸¾minï¼Œä»å°åˆ°å¤§åŠ maxï¼Œç”¨å¹¶æŸ¥é›†ç»´æŠ¤è¿é€šå— | æ˜“å®ç°ï¼Œå¯è¿‡nâ‰¤2000 | æ— æ³•å¤„ç†n=1e5 | å­ä»»åŠ¡1-4ï¼Œâ‰¤50åˆ† |
| **ç‚¹åˆ†æ²»+æ‰«æçº¿+çº¿æ®µæ ‘ (O(n logÂ²n))** | æ‹†è´¡çŒ®åä¸‰ç»´ååºï¼Œç‚¹åˆ†æ²»é™ç»´ï¼Œæ‰«æçº¿+çº¿æ®µæ ‘ç»Ÿè®¡ | å¤æ‚åº¦æ­£ç¡®ï¼Œé€šç”¨æ€§å¼º | å®ç°å¤æ‚ï¼Œä»£ç é•¿ | å…¨éƒ¨æ•°æ®ï¼Œ100åˆ† |

---

### âœ¨ ä¼˜åŒ–ä¹‹æ—…ï¼šä»â€œèƒ½åšâ€åˆ°â€œåšå¥½â€

1.  **èµ·ç‚¹ï¼šæš´åŠ›æšä¸¾**  
    ç›´æ¥æšä¸¾æ‰€æœ‰ 2â¿ ä¸ªå­é›†ï¼Œæ£€æŸ¥æ˜¯å¦è¿é€šï¼Œå†ç®—æƒå€¼ â†’ æŒ‡æ•°çº§çˆ†ç‚¸ã€‚
2.  **ç¬¬ä¸€æ¬¡ä¼˜åŒ–ï¼šå›ºå®šmin+å¹¶æŸ¥é›†**  
    å‘ç°åˆæ³•å­æ ‘ç”± (min,max) å”¯ä¸€ç¡®å®š â†’ æšä¸¾minï¼Œä»å°åˆ°å¤§åŠ maxï¼Œç”¨å¹¶æŸ¥é›†ç»´æŠ¤è¿é€šå— â†’ O(nÂ²)ã€‚
3.  **ç¬¬äºŒæ¬¡ä¼˜åŒ–ï¼šæ‹†è´¡çŒ®+ç‚¹åˆ†æ²»**  
    æŠŠ size æ‹†æˆâ€œv æ˜¯å¦å±äºè¿é€šå—â€ â†’ ä¸‰ç»´ååº â†’ ç‚¹åˆ†æ²»é™ç»´ â†’ O(n logÂ²n)ã€‚
4.  **æœ€ç»ˆä¼˜åŒ–ï¼šæ‰«æçº¿+çº¿æ®µæ ‘**  
    ç”¨çº¿æ®µæ ‘ç»´æŠ¤åŒºé—´ä¿¡æ¯ï¼Œlazy tag å®ç°åŒºé—´åŠ  â†’ å¸¸æ•°ä¼˜åŒ–ï¼Œä»£ç æ›´ç´§å‡‘ã€‚

---

## 4. C++æ ¸å¿ƒä»£ç å®ç°èµæ

### æœ¬é¢˜é€šç”¨æ ¸å¿ƒC++å®ç°å‚è€ƒ
* **è¯´æ˜**ï¼šç»¼åˆ _Ad_Astra_ ä¸ yishanyi çš„æ€è·¯ï¼Œæä¾›ä¸€ä»½ **æ¸…æ™°ç‰ˆ** å®ç°ï¼Œä¿ç•™å…³é”®é€»è¾‘ï¼Œåˆ ç¹å°±ç®€ã€‚
* **å®Œæ•´æ ¸å¿ƒä»£ç **ï¼š
```cpp
#include <bits/stdc++.h>
using namespace std;
using uint = unsigned int;
const int N = 1e5 + 10;
uint ans;
int n;
vector<int> g[N];

/* ---------- ç‚¹åˆ†æ²»æ¡†æ¶ ---------- */
int sz[N], mx[N], vis[N];
void dfs_sz(int u, int f) {
    sz[u] = 1; mx[u] = 0;
    for (int v : g[u]) if (v != f && !vis[v]) {
        dfs_sz(v, u); sz[u] += sz[v];
        mx[u] = max(mx[u], sz[v]);
    }
}
int get_root(int u, int f, int tot) {
    dfs_sz(u, f);
    mx[u] = max(mx[u], tot - sz[u]);
    int rt = u;
    for (int v : g[u]) if (v != f && !vis[v] && mx[v] < mx[rt]) rt = v;
    return rt;
}

/* ---------- æ‰«æçº¿ + çº¿æ®µæ ‘ ---------- */
struct SegTree {
    struct Node { uint sum, std, cnt, add; } t[N << 2];
    #define ls (p << 1)
    #define rs (p << 1 | 1)
    void build(int p, int l, int r) {
        t[p] = {0, 0, 0, 0};
        if (l == r) return;
        int mid = (l + r) >> 1;
        build(ls, l, mid); build(rs, mid + 1, r);
    }
    void push_up(int p) {
        t[p].sum = t[ls].sum + t[rs].sum;
        t[p].std = t[ls].std + t[rs].std;
        t[p].cnt = t[ls].cnt + t[rs].cnt;
    }
    void add_tag(int p, uint x) {
        t[p].sum += t[p].std * x;
        t[p].cnt += x;
        t[p].add += x;
    }
    void push_down(int p) {
        if (t[p].add) {
            add_tag(ls, t[p].add);
            add_tag(rs, t[p].add);
            t[p].add = 0;
        }
    }
    void insert_std(int p, int l, int r, int pos, uint val) {
        if (l == r) { t[p].std += val; return; }
        push_down(p);
        int mid = (l + r) >> 1;
        if (pos <= mid) insert_std(ls, l, mid, pos, val);
        else insert_std(rs, mid + 1, r, pos, val);
        push_up(p);
    }
    void range_add_cnt(int p, int l, int r, int ql, int qr) {
        if (ql <= l && r <= qr) { add_tag(p, 1); return; }
        push_down(p);
        int mid = (l + r) >> 1;
        if (ql <= mid) range_add_cnt(ls, l, mid, ql, qr);
        if (qr > mid) range_add_cnt(rs, mid + 1, r, ql, qr);
        push_up(p);
    }
    uint query_sum(int p, int l, int r, int ql, int qr) {
        if (ql <= l && r <= qr) return t[p].sum;
        push_down(p);
        int mid = (l + r) >> 1; uint res = 0;
        if (ql <= mid) res += query_sum(ls, l, mid, ql, qr);
        if (qr > mid) res += query_sum(rs, mid + 1, r, ql, qr);
        return res;
    }
} T;

int min_v[N], max_v[N], id[N];
vector<int> nodes;

void dfs_collect(int u, int f) {
    nodes.push_back(u);
    min_v[u] = min(min_v[f], u);
    max_v[u] = max(max_v[f], u);
    for (int v : g[u]) if (v != f && !vis[v]) dfs_collect(v, u);
}

uint calc() {
    sort(nodes.begin(), nodes.end());
    int m = nodes.size();
    for (int i = 0; i < m; ++i) id[nodes[i]] = i + 1;
    T.build(1, 1, m);

    sort(nodes.begin(), nodes.end(), [](int a, int b) {
        return max_v[a] < max_v[b];
    });

    uint res = 0;
    for (int i = 0, j; i < m; i = j) {
        int cur_max = max_v[nodes[i]];
        for (j = i; j < m && max_v[nodes[j]] == cur_max; ++j) {
            int u = nodes[j];
            if (min_v[u] == u) T.insert_std(1, 1, m, id[u], u);
        }
        for (j = i; j < m && max_v[nodes[j]] == cur_max; ++j) {
            int u = nodes[j];
            T.range_add_cnt(1, 1, m, 1, id[min_v[u]]);
        }
        for (j = i; j < m && max_v[nodes[j]] == cur_max; ++j) {
            int u = nodes[j];
            if (max_v[u] == u) res += T.query_sum(1, 1, m, 1, id[min_v[u]]) * u;
        }
    }
    return res;
}

void solve(int u, int tot) {
    int rt = get_root(u, 0, tot);
    vis[rt] = 1;
    min_v[rt] = max_v[rt] = rt;
    nodes.clear(); nodes.push_back(rt);
    uint pans = 0;
    for (int v : g[rt]) if (!vis[v]) {
        dfs_collect(v, rt);
        pans -= calc();
    }
    pans += calc();
    ans += pans;

    for (int v : g[rt]) if (!vis[v]) solve(v, sz[v] < sz[rt] ? sz[v] : tot - sz[rt]);
}

int main() {
    ios::sync_with_stdio(false);
    cin.tie(nullptr);
    int Tcase; cin >> Tcase;
    while (Tcase--) {
        cin >> n;
        for (int i = 1; i <= n; ++i) g[i].clear(), vis[i] = 0;
        for (int i = 1, u, v; i < n; ++i) {
            cin >> u >> v;
            g[u].push_back(v); g[v].push_back(u);
        }
        ans = 0;
        solve(1, n);
        cout << ans << '\n';
    }
    return 0;
}
```

* **ä»£ç è§£è¯»æ¦‚è¦**ï¼š  
  1.  **ç‚¹åˆ†æ²»æ¡†æ¶**ï¼š`get_root` æ‰¾é‡å¿ƒï¼Œ`solve` é€’å½’å¤„ç†å­æ ‘ã€‚  
  2.  **æ‰«æçº¿**ï¼šå¯¹æ¯ä¸ªåˆ†æ²»ä¸­å¿ƒï¼Œæ”¶é›†æ‰€æœ‰èŠ‚ç‚¹ï¼ŒæŒ‰ `max_v` æ’åºã€‚  
  3.  **çº¿æ®µæ ‘**ï¼šç»´æŠ¤ `std`ï¼ˆmin å’Œï¼‰ã€`cnt`ï¼ˆå« x ç‚¹æ•°ï¼‰ã€`sum`ï¼ˆminÂ·cnt å’Œï¼‰ã€‚  
  4.  **å­æ ‘å»é‡**ï¼šå¯¹æ¯æ£µå­æ ‘å•ç‹¬è·‘ `calc`ï¼Œç”¨å®¹æ–¥å‡å»é‡å¤è´¡çŒ®ã€‚

---

## 5. ç®—æ³•å¯è§†åŒ–ï¼šåƒç´ åŠ¨ç”»æ¼”ç¤º

* **åŠ¨ç”»ä¸»é¢˜**ï¼š**â€œåƒç´ æ¢é™©å®¶ï¼šåœ¨æ ‘ä¹‹è¿·å®«ä¸­å¯»å®â€**  
  8ä½åƒç´ é£æ ¼ï¼Œç©å®¶æ‰®æ¼”å°æ¢é™©å®¶ï¼Œåœ¨æ ‘ä¸Šå¯»æ‰¾â€œmin-max-sizeâ€å®è—ã€‚

* **æ ¸å¿ƒæ¼”ç¤ºå†…å®¹**ï¼š  
  1.  **ç‚¹åˆ†æ²»å¯è§†åŒ–**ï¼š  
      â€¢ å±å¹•ä¸­å¤®æ˜¾ç¤ºä¸€æ£µåƒç´ æ ‘ï¼Œæ¯æ¬¡ç‚¹å‡»â€œåˆ†æ²»â€æŒ‰é’®ï¼Œé«˜äº®å½“å‰é‡å¿ƒï¼Œæ ‘è¢«æ‹†æˆå­æ ‘ã€‚  
      â€¢ ç”¨åƒç´ ç®­å¤´æ ‡è®°â€œminâ†’maxâ€è·¯å¾„ï¼Œè·¯å¾„ä¸Šçš„èŠ‚ç‚¹é—ªçƒã€‚  
  2.  **æ‰«æçº¿åŠ¨ç”»**ï¼š  
      â€¢ å³ä¾§å‡ºç°ä¸€æ¡â€œmaxè½´â€åƒç´ æ¡ï¼Œä»å·¦åˆ°å³æ‰«æã€‚  
      â€¢ æ¯æ‰«åˆ°ä¸€ä¸ª maxï¼Œå·¦ä¾§çº¿æ®µæ ‘åŒºåŸŸåŠ¨æ€æ’å…¥å¯¹åº” min å’Œ xï¼Œåƒç´ æ–¹å—å †å ã€‚  
  3.  **çº¿æ®µæ ‘æ›´æ–°**ï¼š  
      â€¢ æ¯æ¬¡æ’å…¥/æŸ¥è¯¢ï¼Œçº¿æ®µæ ‘èŠ‚ç‚¹ç”¨ä¸åŒé¢œè‰²é«˜äº®ï¼Œä¼´éšâ€œå®â€çš„8ä½éŸ³æ•ˆã€‚  
      â€¢ æŸ¥è¯¢æˆåŠŸæ—¶ï¼Œåƒç´ å®ç®±æ‰“å¼€ï¼Œæ˜¾ç¤ºå½“å‰è´¡çŒ®å€¼ç´¯åŠ ã€‚

* **äº¤äº’è®¾è®¡**ï¼š  
  â€¢ å·¦ä¸‹è§’ï¼šæ­¥è¿›/è‡ªåŠ¨æ’­æ”¾æŒ‰é’®ï¼Œé€Ÿåº¦æ»‘å—ï¼ˆ1x-8xï¼‰ã€‚  
  â€¢ å³ä¸‹è§’ï¼šé‡ç½®åŠ¨ç”»ï¼Œå¯è¾“å…¥è‡ªå®šä¹‰æ ‘ç»“æ„ã€‚  
  â€¢ é¡¶éƒ¨ï¼šä»£ç åŒæ­¥çª—å£ï¼Œé«˜äº®å½“å‰æ‰§è¡Œè¡Œï¼ˆä¼ªä»£ç å½¢å¼ï¼‰ã€‚

* **æ¸¸æˆåŒ–å…ƒç´ **ï¼š  
  â€¢ æ¯å®Œæˆä¸€ä¸ªåˆ†æ²»ä¸­å¿ƒï¼Œè·å¾—â€œåƒç´ æ˜Ÿæ˜Ÿâ€å¥–åŠ±ï¼Œç´¯è®¡æ˜Ÿæ˜Ÿè§£é”æ›´é«˜éš¾åº¦æ ‘ã€‚  
  â€¢ èƒŒæ™¯éŸ³ä¹ï¼š8ä½å¾ªç¯æ—‹å¾‹ï¼Œæ“ä½œéŸ³æ•ˆå¤å¤é£ã€‚

---

## 6. æ‹“å±•ç»ƒä¹ ä¸ç›¸ä¼¼é—®é¢˜æ€è€ƒ

* **é€šç”¨æ€è·¯è¿ç§»**ï¼š  
  ç‚¹åˆ†æ²» + æ‰«æçº¿ + çº¿æ®µæ ‘ çš„ç»„åˆï¼Œé€‚ç”¨äºæ‰€æœ‰ **â€œæ ‘ä¸Šè·¯å¾„ + å¤šç»´ååºç»Ÿè®¡â€** é—®é¢˜ã€‚  
  å…¸å‹åœºæ™¯ï¼š  
  1.  ç»Ÿè®¡æ ‘ä¸Šæ‰€æœ‰è·¯å¾„çš„ **æƒå€¼å’Œ**ï¼Œæ»¡è¶³è·¯å¾„ä¸¤ç«¯ç‚¹æƒå€¼åœ¨æŸä¸ªåŒºé—´ã€‚  
  2.  æ±‚æ ‘ä¸Š **è·ç¦» â‰¤ k çš„ç‚¹å¯¹** ä¸­ï¼Œç‚¹æƒä¹˜ç§¯ä¹‹å’Œã€‚  
  3.  åŠ¨æ€æ ‘ä¸­ç»´æŠ¤ **å­æ ‘ä¿¡æ¯** çš„åŒºé—´æŸ¥è¯¢ä¸æ›´æ–°ã€‚

* **æ´›è°·æ¨èç»ƒä¹ **ï¼š
| é¢˜å· | æ¨èç†ç”± |
|---|---|
| **P3806** ã€æ¨¡æ¿ã€‘ç‚¹åˆ†æ²»1 | ç‚¹åˆ†æ²»å…¥é—¨ï¼Œå­¦ä¼šâ€œåˆ†æ²»ä¸­å¿ƒ + å­æ ‘ç»Ÿè®¡â€æ¡†æ¶ã€‚ |
| **P4178** Tree | æ ‘ä¸Šè·¯å¾„è®¡æ•°ï¼Œéœ€ç¦»æ•£åŒ– + æ ‘çŠ¶æ•°ç»„ï¼Œä¸æ‰«æçº¿æ€æƒ³ä¸€è‡´ã€‚ |
| **P2634** [å›½å®¶é›†è®­é˜Ÿ] èªèªå¯å¯ | æ ‘ä¸Šè·¯å¾„æƒå€¼å’Œï¼Œéœ€æ‹†è´¡çŒ® + æ¨¡æ„ä¹‰ä¸‹ç»Ÿè®¡ï¼Œå¼ºåŒ–å®¹æ–¥æ€æƒ³ã€‚ |
| **P3714** [BJWC2018] è·¯å¾„é•¿åº¦ | æ ‘ä¸Šè·¯å¾„é•¿åº¦ç»Ÿè®¡ï¼Œéœ€ç‚¹åˆ†æ²» + åŒæŒ‡é’ˆï¼Œé”»ç‚¼é™ç»´æŠ€å·§ã€‚ |

---

## 7. å­¦ä¹ å¿ƒå¾—ä¸ç»éªŒåˆ†äº«

> **æ¥è‡ª _Ad_Astra_ çš„è°ƒè¯•å¿ƒå¾—**ï¼š  
> â€œæœ€åˆåœ¨å­æ ‘å»é‡æ—¶ï¼Œé”™è¯¯åœ°æ›´æ–°äº† min/max å€¼ï¼Œå¯¼è‡´é‡å¤è®¡ç®—ã€‚åæ¥å‘ç° **å¿…é¡»ä¿ç•™åŸåˆ†æ²»ä¸­å¿ƒä¸‹çš„ min/max**ï¼Œå¦åˆ™å®¹æ–¥å¤±æ•ˆã€‚è¿™æé†’æˆ‘ä»¬ï¼Œ**å»é‡æ—¶ä¸€å®šè¦ä¿è¯ç»Ÿè®¡ç»´åº¦ä¸å˜**ã€‚â€

> **æ´›è¯­äº‘ç¬ºç‚¹è¯„**ï¼š  
> è¿™æ˜¯ä¸€ä¸ªéå¸¸ç»å…¸çš„ **â€œç»´åº¦æ±¡æŸ“â€** é™·é˜±ã€‚åœ¨å¤„ç†å¤šç»´ç»Ÿè®¡æ—¶ï¼Œ**æ¯ä¸€æ­¥çš„ç»´åº¦å¿…é¡»æ¸…æ™°ç‹¬ç«‹**ï¼Œå¦åˆ™ä¼šå¯¼è‡´é€»è¾‘é”™è¯¯ã€‚åŠ¨æ‰‹ç”»æ ‘ã€æ¨¡æ‹Ÿå°æ•°æ®æ˜¯å‘ç°æ­¤ç±»é—®é¢˜çš„æœ‰æ•ˆæ–¹æ³•ã€‚

---

<conclusion>
ä»Šå¤©æˆ‘ä»¬å®Œæˆäº†ä¸€åœºä» **æš´åŠ›æšä¸¾** åˆ° **O(n logÂ²n)** çš„æ€ç»´é£è·ƒã€‚  
æ ¸å¿ƒæ”¶è·ï¼š  
1.  **å€’åºæ€è€ƒ** ä¸ **æ‹†è´¡çŒ®** æ˜¯ç ´è§£å¤æ‚è®¡æ•°é—®é¢˜çš„åˆ©å™¨ã€‚  
2.  **ç‚¹åˆ†æ²» + æ‰«æçº¿ + çº¿æ®µæ ‘** æ˜¯æ ‘ä¸Šå¤šç»´ååºçš„é»„é‡‘ç»„åˆã€‚  
3.  ä»£ç å®ç°æ—¶ï¼Œ**å­æ ‘å»é‡** ä¸ **ç»´åº¦ä¸€è‡´æ€§** éœ€æ ¼å¤–å°å¿ƒã€‚  

ç»§ç»­ç»ƒä¹ æ¨èé¢˜ç›®ï¼ŒæŠŠä»Šå¤©çš„ **â€œåƒç´ æ¢é™©å®¶â€** ç»éªŒï¼Œå˜æˆæ˜å¤©çš„ **â€œç®—æ³•å¤§å¸ˆâ€**ï¼  
æˆ‘ä»¬ä¸‹æ¬¡æ¢é™©å†è§ï¼

---
å¤„ç†ç”¨æ—¶ï¼š155.36ç§’
# é¢˜ç›®ä¿¡æ¯

# [OOI 2023] Gasoline prices / æ²¹ä»·

## é¢˜ç›®èƒŒæ™¯

CF1801E

## é¢˜ç›®æè¿°

ä¼¯åˆ©å…°æ˜¯ä¸€ä¸ªç”± $n$ ä¸ªåŸå¸‚ç»„æˆçš„åºå¤§å›½å®¶ã€‚ä¼¯åˆ©å…°çš„å…¬è·¯ç½‘ç»œå¯ä»¥è¢«çœ‹ä½œæ˜¯ä¸€æ£µæœ‰æ ¹æ ‘ï¼Œä¹Ÿå°±æ˜¯è¯´å…¨å›½ä¸€å…±æœ‰ $n - 1$ æ¡é“è·¯ï¼Œå¹¶ä¸”ä»»æ„ä¸¤ä¸ªåŸå¸‚ä¹‹é—´éƒ½æ°å¥½æœ‰ä¸€æ¡è·¯å¾„ç›¸è¿ï¼Œä¸”ä¸ä¼šé‡å¤ç»è¿‡åŒä¸€ä¸ªåŸå¸‚ã€‚ä¸ºäº†æ–¹ä¾¿è¡¨ç¤ºï¼Œæ¯ä¸ªåŸå¸‚ $i$ éƒ½æœ‰ä¸€ä¸ªå›ºå®šçš„åŸå¸‚ $p_i$ï¼Œå®ƒè¡¨ç¤ºä»åŸå¸‚ $i$ å‡ºå‘å‰å¾€åŸå¸‚ $1$ æ—¶ï¼Œé¦–å…ˆè¦åˆ°è¾¾çš„åŸå¸‚ã€‚æ¢å¥è¯è¯´ï¼Œå¦‚æœå°†æ ‘çš„æ ¹è®¾ä¸ºåŸå¸‚ $1$ï¼Œé‚£ä¹ˆ $p_i$ å°±æ˜¯åŸå¸‚ $i$ çš„çˆ¶èŠ‚ç‚¹ã€‚

æ¯ä¸ªåŸå¸‚éƒ½æœ‰ä¸€ä¸ªåŠ æ²¹ç«™ã€‚æ¯ä¸ªåŠ æ²¹ç«™çš„æ²¹ä»·éƒ½æœ‰ä¸€ä¸ªå›ºå®šçš„åŒºé—´ï¼Œåœ¨è¿™ä¸ªåŒºé—´å†…å¯ä»¥é€‰æ‹©ä»»æ„ä¸€ä¸ªä»·æ ¼ã€‚åŸå¸‚ $i$ çš„åŠ æ²¹ç«™æ²¹ä»·å¯ä»¥æ˜¯ $l_i$ åˆ° $r_i$ ä¹‹é—´çš„ä»»æ„æ•´æ•°ï¼ˆåŒ…æ‹¬ä¸¤ç«¯ï¼‰ã€‚

ä¼¯åˆ©å…°çš„å›½ç‹æ˜¯ä¸ªé¡¾å®¶çš„å¥½çˆ¶äº²ï¼Œä»–è¿ç»­ $m$ å¹´æ¯å¹´éƒ½è¿æ¥äº†ä¸¤ä½å„¿å­çš„å‡ºç”Ÿã€‚å›½ç‹çš„å­©å­ä»¬ä»å°å°±å‚ä¸å›½å®¶äº‹åŠ¡ï¼Œæ¯å¹´å¹´æœ«ï¼Œä»–ä»¬ä¼šæ£€æŸ¥æ²¹ä»·æ˜¯å¦å…¬å¹³ã€‚è‡ªå‡ºç”Ÿèµ·ï¼Œç¬¬ $i$ å¹´å‡ºç”Ÿçš„ä¸¤ä¸ªå­©å­åˆ†åˆ«è´Ÿè´£æ£€æŸ¥ä»åŸå¸‚ $a_i$ åˆ°åŸå¸‚ $b_i$ çš„è·¯å¾„ï¼Œä»¥åŠä»åŸå¸‚ $c_i$ åˆ°åŸå¸‚ $d_i$ çš„è·¯å¾„ä¸Šçš„æ²¹ä»·ã€‚

æ£€æŸ¥çš„æ–¹å¼å¦‚ä¸‹ï¼šä¸¤ä¸ªå­©å­åˆ†åˆ«åŒæ—¶ä»åŸå¸‚ $a_i$ å’Œ $c_i$ å‡ºå‘ã€‚ç¬¬ä¸€ä¸ªå­©å­æ²¿ç€ä» $a_i$ åˆ° $b_i$ çš„è·¯å¾„å‰è¿›ï¼Œç¬¬äºŒä¸ªå­©å­åˆ™æ²¿ç€ä» $c_i$ åˆ° $d_i$ çš„è·¯å¾„å‰è¿›ã€‚ä»–ä»¬ä¼šä¾æ¬¡æ£€æŸ¥ï¼šèµ·ç‚¹ $a_i$ å’Œ $c_i$ çš„æ²¹ä»·æ˜¯å¦ç›¸åŒï¼Œç„¶åæ£€æŸ¥è·¯å¾„ä¸Šçš„ç¬¬äºŒä¸ªåŸå¸‚æ˜¯å¦æ²¹ä»·ç›¸åŒï¼Œä¾æ­¤ç±»æ¨ï¼Œç›´åˆ°ç»ˆç‚¹ $b_i$ å’Œ $d_i$ çš„æ²¹ä»·ä¹Ÿè¦ä¸€è‡´ã€‚ä¿è¯ä» $a_i$ åˆ° $b_i$ çš„è·¯å¾„é•¿åº¦å’Œä» $c_i$ åˆ° $d_i$ çš„è·¯å¾„é•¿åº¦ç›¸åŒã€‚

æ‰€æœ‰åŠ æ²¹ç«™éƒ½å¿…é¡»ä¸¥æ ¼éµå®ˆæ³•å¾‹ï¼Œå› æ­¤æ‰€æœ‰çš„æ²¹ä»·æ£€æŸ¥éƒ½ä¸èƒ½å‡ºç°è¿è§„ã€‚è¯·ä½ å¸®åŠ©ä¼¯åˆ©å…°çš„åŠ æ²¹ç«™è®¡ç®—ï¼Œåœ¨ $m$ å¹´å†…ï¼Œä»–ä»¬æœ‰å¤šå°‘ç§åˆæ³•çš„æ²¹ä»·è®¾ç½®æ–¹å¼ã€‚æ¢å¥è¯è¯´ï¼Œå¯¹äºæ¯ä¸ª $i$ ä» $1$ åˆ° $m$ï¼Œè¯·è®¡ç®—åœ¨å‰ $i$ å¹´å‡ºç”Ÿçš„æ‰€æœ‰ç‹å­è¿›è¡Œæ£€æŸ¥åï¼Œæ‰€æœ‰æ£€æŸ¥éƒ½ä¸å‡ºç°è¿è§„ï¼Œä¸”æ¯ä¸ªåŠ æ²¹ç«™çš„æ²¹ä»·åœ¨å…è®¸åŒºé—´å†…çš„æƒ…å†µä¸‹ï¼Œæ€»å…±æœ‰å¤šå°‘ç§æ²¹ä»·åˆ†é…æ–¹æ¡ˆã€‚ç”±äºç­”æ¡ˆå¯èƒ½å¾ˆå¤§ï¼Œè¯·å¯¹ $10^9 + 7$ å–æ¨¡è¾“å‡ºã€‚


## è¯´æ˜/æç¤º

### æ ·ä¾‹è§£é‡Š

ä»¥ç¬¬ä¸€ä¸ªæ ·ä¾‹ä¸ºä¾‹ï¼š

- åœ¨å¤´ä¸¤ä½ç‹å­å‡ºç”Ÿåï¼ŒåŸå¸‚ $1$ å’ŒåŸå¸‚ $2$ çš„æ²¹ä»·å¿…é¡»ç›¸åŒã€‚å¯ä»¥åœ¨å…è®¸çš„åŒºé—´å†…ä¸ºåŸå¸‚ $1$ å’Œ $2$ é€‰æ‹©ç›¸åŒçš„æ²¹ä»·æ–¹å¼æœ‰ $2$ ç§ã€‚å‰©ä¸‹åŸå¸‚ $3$ å’Œ $4$ çš„æ²¹ä»·åˆ†åˆ«æœ‰ $3$ ç§å’Œ $3$ ç§é€‰æ‹©ã€‚æ€»æ–¹æ¡ˆæ•°ä¸º $2 \times 3 \times 3 \times 1 = 18$ã€‚
- ç¬¬äºŒå¯¹ç‹å­æ£€æŸ¥çš„æ˜¯ $1-2$ å’Œ $2-1$ï¼Œè¿™è¦æ±‚åŸå¸‚ $1$ å’Œ $2$ çš„æ²¹ä»·ä¸€è‡´ï¼Œè¿™ä¸ªæ¡ä»¶å·²ç»æ»¡è¶³ï¼Œå› æ­¤æ–¹æ¡ˆæ•°ä¸å˜ã€‚
- ç¬¬ä¸‰å¯¹ç‹å­æ£€æŸ¥çš„æ˜¯ $3-1-2-4$ å’Œ $4-2-1-3$ï¼Œè¿™è¦æ±‚åŸå¸‚ $3$ å’Œ $4$ çš„æ²¹ä»·ç›¸åŒï¼ŒåŸå¸‚ $1$ å’Œ $2$ çš„æ²¹ä»·ä¹Ÿè¦ç›¸åŒã€‚åŸå¸‚ $1$ å’Œ $2$ å·²ç»ä¸€è‡´ï¼Œè€ŒåŸå¸‚ $3$ å’Œ $4$ å¯ä»¥æœ‰ $2$ ç§ç›¸åŒçš„æ²¹ä»·é€‰æ‹©ã€‚æ€»æ–¹æ¡ˆæ•°ä¸º $2 \times 2 \times 1 = 6$ã€‚
- ç¬¬å››å¯¹ç‹å­æ£€æŸ¥çš„æ˜¯ $3-1-2-4$ å’Œ $3-1-2-5$ï¼Œè¿™è¦æ±‚åŸå¸‚ $4$ å’Œ $5$ çš„æ²¹ä»·ä¸€è‡´ï¼Œè€ŒåŸå¸‚ $3$ å’Œ $4$ å·²ç»ä¸€è‡´ï¼Œå› æ­¤ $3$ã€$4$ã€$5$ ä¸‰ä¸ªåŸå¸‚çš„æ²¹ä»·éƒ½è¦ä¸€è‡´ã€‚åŸå¸‚ $3$ çš„æ²¹ä»·ä¸èƒ½è¶…è¿‡ $3$ï¼ŒåŸå¸‚ $5$ çš„æ²¹ä»·ä¸èƒ½ä½äº $4$ï¼Œå› æ­¤ä¸å­˜åœ¨æ»¡è¶³æ¡ä»¶çš„æ–¹æ¡ˆï¼Œç­”æ¡ˆä¸º $0$ã€‚

### è¯„åˆ†è¯´æ˜

æœ¬é¢˜çš„æ•°æ®åˆ†ä¸º 8 ç»„ã€‚åªæœ‰é€šè¿‡æŸä¸€ç»„å…¨éƒ¨æµ‹è¯•ç‚¹ï¼Œä¸”é€šè¿‡éƒ¨åˆ†ä¹‹å‰ç»„å…¨éƒ¨æµ‹è¯•ç‚¹ï¼Œæ‰èƒ½è·å¾—è¯¥ç»„åˆ†æ•°ã€‚æœ‰äº›åˆ†ç»„ä¸è¦æ±‚é€šè¿‡æ ·ä¾‹æµ‹è¯•ç‚¹ã€‚â€œç¦»çº¿è¯„æµ‹â€è¡¨ç¤ºè¯¥ç»„çš„æµ‹è¯•ç»“æœåªä¼šåœ¨æ¯”èµ›ç»“æŸåå…¬å¸ƒã€‚

| ç»„åˆ« | åˆ†å€¼ | $n$ | $m$ | å¿…é¡»é€šè¿‡çš„ç»„ | å¤‡æ³¨ |
|:----:|:----:|:---:|:---:|:------------:|:----:|
| 0    | 0    | --  | --  | --           | æ ·ä¾‹æµ‹è¯•ç‚¹ |
| 1    | 12   | $n \le 300$ | $m \le 300$ | 0 |  |
| 2    | 10   | $n \le 3000$ | $m \le 3000$ | -- | $p_i = i - 1$ |
| 3    | 9    | $n \le 3000$ | $m \le 3000$ | 0, 1, 2 |  |
| 4    | 16   | --  | --  | 0 -- 3       | æ‰€æœ‰æ£€æŸ¥è·¯å¾„çš„æ€»é•¿åº¦ä¸è¶…è¿‡ $10^8$ |
| 5    | 10   | $n \le 100\,000$ | $m \le 100\,000$ | 2 | $p_i = i - 1$ |
| 6    | 12   | --  | --  | 2, 5         | $p_i = i - 1$ |
| 7    | 13   | $n \le 100\,000$ | $m \le 100\,000$ | 0 -- 3, 5 |  |
| 8    | 18   | --  | --  | 0 -- 7       | **ç¦»çº¿è¯„æµ‹** |

## æ ·ä¾‹ #1

### è¾“å…¥

```
5
1 1 2 2
2 4
1 3
1 3
2 4
4 4
4
1 1 2 2
1 2 2 1
3 4 4 3
3 4 3 5```

### è¾“å‡º

```
18
18
4
0```

## æ ·ä¾‹ #2

### è¾“å…¥

```
8
1 2 3 4 5 8 6
3 7
2 6
3 8
5 10
5 8
2 9
3 8
6 8
4
1 3 7 6
4 1 5 7
1 7 7 1
1 8 2 7```

### è¾“å‡º

```
720
120
120
1
```

# AIåˆ†æç»“æœ

# ğŸ’¡ æ´›è¯­äº‘ç¬ºçš„C++ç®—æ³•è§£æï¼š[OOI 2023] æ²¹ä»· æ·±å…¥å­¦ä¹ æŒ‡å— ğŸ’¡

> æ¬¢è¿æ¥åˆ°ä¼¯åˆ©å…°ï¼ä»Šå¤©æˆ‘ä»¬è¦å¸®å›½ç‹çš„åŠ æ²¹ç«™è®¡ç®—åˆæ³•æ²¹ä»·æ–¹æ¡ˆæ•°ã€‚è¿™ä¸ä»…æ˜¯æ ‘ä¸åŒºé—´äº¤é›†çš„è¾ƒé‡ï¼Œæ›´æ˜¯ä¸€åœºâ€œå¦‚ä½•æŠŠè·¯å¾„é™åˆ¶è½¬åŒ–ä¸ºè¿é€šåˆ†é‡â€çš„æ€ç»´æ¢é™©ã€‚

---

## 1. é¢˜ç›®è§£è¯»ä¸ç­–ç•¥åˆæ¢

### âœ¨ æ ¸å¿ƒæŒ‘æˆ˜
åœ¨æ ‘å½¢ç»“æ„ä¸­ï¼Œä¸ºæ¯ä¸ªèŠ‚ç‚¹é€‰æ‹©ä¸€ä¸ªåŒºé—´å†…çš„æ•´æ•°ä»·æ ¼ï¼Œä½¿å¾—**æ¯ä¸€å¯¹é•¿åº¦ç›¸ç­‰çš„è·¯å¾„**ä¸Šï¼Œå¯¹åº”ä½ç½®çš„èŠ‚ç‚¹ä»·æ ¼**ä¸¤ä¸¤ç›¸ç­‰**ã€‚éšç€æ¯å¹´æ–°ç‹å­çš„è¯ç”Ÿï¼Œé™åˆ¶ä¸æ–­å¢åŠ ï¼Œæˆ‘ä»¬éœ€è¦**åœ¨çº¿å›ç­”**å½“å‰æ–¹æ¡ˆæ•°ï¼ˆå¯¹ $10^9+7$ å–æ¨¡ï¼‰ã€‚

### âœ¨ æ ¸å¿ƒç®—æ³•æ ‡ç­¾
- **æ ‘è®º**ï¼ˆLCAã€HLDã€å€å¢ï¼‰
- **å¹¶æŸ¥é›†ï¼ˆDSUï¼‰**
- **åˆ†æ²» & äºŒè¿›åˆ¶æ‹†åˆ†**
- **ç¦»çº¿å¤„ç† & è¿é€šåˆ†é‡ç»´æŠ¤**

---

### ğŸ” ç®—æ³•ä¾¦æ¢ï¼šå¦‚ä½•åœ¨é¢˜ç›®ä¸­å‘ç°çº¿ç´¢ï¼Ÿ

| çº¿ç´¢ | å‘ç° & æ¨ç† |
|------|-------------|
| **çº¿ç´¢1ï¼šé—®é¢˜ç›®æ ‡** | â€œæ±‚åˆæ³•æ–¹æ¡ˆæ•°â€ â†’ **è®¡æ•°ç±»é—®é¢˜**ï¼Œé€šå¸¸éœ€è¦ä¹˜æ³•åŸç† + å¿«é€Ÿåˆå¹¶é™åˆ¶ã€‚ |
| **çº¿ç´¢2ï¼šçº¦æŸå½¢å¼** | â€œè·¯å¾„ä¸Šç¬¬ $i$ ä¸ªèŠ‚ç‚¹ä»·æ ¼ç›¸ç­‰â€ â†’ ç­‰ä»·äº **æŠŠè·¯å¾„ä¸Šæ‰€æœ‰èŠ‚ç‚¹åˆå¹¶åˆ°åŒä¸€è¿é€šåˆ†é‡**ï¼Œä¸”è¯¥åˆ†é‡æœ€ç»ˆåŒºé—´é•¿åº¦ä¸º $\bigcap [l, r]$ã€‚ |
| **çº¿ç´¢3ï¼šæ•°æ®ç»“æ„** | æ ‘ + è·¯å¾„æŸ¥è¯¢ â†’ **LCA/HLD** å¯æ‹†åˆ†è·¯å¾„ï¼›éœ€è¦å¿«é€Ÿåˆå¹¶ â†’ **DSU**ã€‚ |
| **çº¿ç´¢4ï¼šåœ¨çº¿å›ç­”** | æ¯å¹´æ–°å¢é™åˆ¶ â†’ éœ€**ç¦»çº¿**æˆ–**å¯æ’¤é”€å¹¶æŸ¥é›†**ï¼›ä½†å®˜æ–¹æ­£è§£é‡‡ç”¨**äºŒè¿›åˆ¶æ‹†åˆ†ç¦»çº¿**ï¼Œæ€»å¤æ‚åº¦ $O((n+q)\log n \cdot \alpha(n))$ã€‚ |

---

### ğŸ§  æ€ç»´é“¾æ„å»ºï¼šä»çº¿ç´¢åˆ°ç­–ç•¥
> ä¾¦æ¢æ‹¼å›¾å®Œæˆï¼Œè®©æˆ‘ä»¬æŠŠçº¿ç´¢ä¸²æˆå®Œæ•´æ€è·¯ï¼š
>
> 1. **â€œè·¯å¾„ç›¸ç­‰â€ â†’ è¿é€šåˆ†é‡**ï¼šæ¯ä¸ªé™åˆ¶ç›¸å½“äºæŠŠä¸¤æ¡è·¯å¾„ä¸Šçš„å¯¹åº”èŠ‚ç‚¹â€œç»‘å®šâ€åˆ°åŒä¸€ä»·æ ¼ã€‚  
> 2. **DSU ç»´æŠ¤åˆ†é‡åŒºé—´**ï¼šè‹¥åˆ†é‡åŒºé—´äº¤é›†ä¸ºç©ºï¼Œåˆ™æ–¹æ¡ˆæ•°ä¸º 0ï¼›å¦åˆ™ä¹˜ä¸Šäº¤é›†é•¿åº¦ã€‚  
> 3. **è·¯å¾„æ‹†åˆ†**ï¼šæ ‘è·¯å¾„å¯æ‹†æˆ $O(\log n)$ æ®µå‚ç›´é“¾ï¼ˆå€å¢æˆ– HLDï¼‰ï¼ŒæŠŠâ€œæ•´æ¡è·¯å¾„â€é™åˆ¶æ‹†æˆè‹¥å¹²â€œé“¾æ®µâ€é™åˆ¶ã€‚  
> 4. **äºŒè¿›åˆ¶æ‹†åˆ†**ï¼šæŠŠæ‰€æœ‰é™åˆ¶é•¿åº¦ç»Ÿä¸€ä¸º $2^k$ï¼Œå†é€’å½’æ‹†åŠï¼Œä¿è¯æ¯å±‚é™åˆ¶æ€»æ•° $O(n+q)$ã€‚  
> 5. **å¤æ‚åº¦**ï¼šæ¯å±‚ DSU æ“ä½œ $O((n+q)\alpha(n))$ï¼Œå…± $\log n$ å±‚ï¼Œæ€» $O((n+q)\log n \cdot \alpha(n))$ã€‚

---

## 2. ç²¾é€‰ä¼˜è´¨é¢˜è§£å‚è€ƒ

> å®˜æ–¹é¢˜è§£å·²ç»™å‡º **HLD + äºŒåˆ† + çº¿æ®µæ ‘**ï¼ˆ$O((n+q)\log^2 n)$ï¼‰ä¸ **äºŒè¿›åˆ¶æ‹†åˆ† + DSU**ï¼ˆ$O((n+q)\log n \cdot \alpha(n))$ï¼‰ä¸¤ç§ç­–ç•¥ã€‚æˆ‘ä»¬æç‚¼å…¶ç²¾åï¼š

| é¢˜è§£ | äº®ç‚¹æç‚¼ |
|------|----------|
| **å®˜æ–¹é¢˜è§£Â·HLDç‰ˆ** | ç”¨é‡é“¾å‰–åˆ†æŠŠè·¯å¾„æ˜ å°„ä¸ºåŒºé—´ï¼Œçº¿æ®µæ ‘ç»´æŠ¤å“ˆå¸Œï¼ŒäºŒåˆ†é¦–æ¬¡å†²çªç‚¹ï¼›æ€è·¯æ¸…æ™°ï¼Œé€‚åˆå­¦ä¹  HLD ä¸åŒºé—´æ•°æ®ç»“æ„ã€‚ |
| **å®˜æ–¹é¢˜è§£Â·äºŒè¿›åˆ¶æ‹†åˆ†ç‰ˆ** | æŠŠä»»æ„è·¯å¾„æ‹†æˆ $2^k$ é“¾æ®µï¼Œå†é€’å½’æŠ˜åŠï¼›æ¯å±‚åªéœ€ DSU åˆå¹¶ï¼Œå¸¸æ•°å°ï¼Œä»£ç ç®€æ´ï¼›æ˜¯**æ»¡åˆ†ç­–ç•¥**ã€‚ |

---

## 3. è§£é¢˜ç­–ç•¥æ·±åº¦å‰–æ

### ğŸ¯ æ ¸å¿ƒéš¾ç‚¹ä¸å…³é”®æ­¥éª¤ï¼ˆäºŒè¿›åˆ¶æ‹†åˆ†ç‰ˆï¼‰

| å…³é”®ç‚¹ | åˆ†æ & å®ç°è¦ç‚¹ | ğŸ’¡ å­¦ä¹ ç¬”è®° |
|--------|-----------------|-----------|
| **1. è·¯å¾„æ‹†åˆ†** | å°† $a \to b$ ä¸ $c \to d$ çš„ä¸¤æ¡è·¯å¾„æ‹†æˆè‹¥å¹²å¯¹**ç­‰é•¿å‚ç›´é“¾**ã€‚å¯ç”¨ **LCA + å€å¢** å¾—åˆ° $O(\log n)$ æ®µã€‚ | ä»»ä½•æ ‘è·¯å¾„éƒ½èƒ½ç”¨ $O(\log n)$ æ®µå‚ç›´é“¾è¦†ç›–ã€‚ |
| **2. äºŒè¿›åˆ¶æ‹†åˆ†** | æŠŠæ¯æ®µé“¾é•¿åº¦è¡¥åˆ° $2^k$ï¼Œå»ºå›¾èŠ‚ç‚¹ $(u,k)$ è¡¨ç¤ºä» $u$ å‘ä¸Š $2^k$ çš„é“¾ã€‚é™åˆ¶è½¬åŒ–ä¸ºæŠŠ $(a,k)$ ä¸ $(c,k)$ çš„å¯¹åº”ä½ç½®åˆå¹¶ã€‚ | ç»Ÿä¸€é•¿åº¦åå¯ç”¨ **ç¨€ç–è¡¨æ€æƒ³** é€’å½’æŠ˜åŠã€‚ |
| **3. å¹¶æŸ¥é›†ç»´æŠ¤åŒºé—´äº¤é›†** | DSU æ¯ä¸ªé›†åˆè®°å½•å½“å‰**å…±åŒåŒºé—´** $[L,R]$ï¼›åˆå¹¶æ—¶å–äº¤é›†ï¼Œè‹¥ä¸ºç©ºåˆ™å…¨å±€æ–¹æ¡ˆæ•°å˜ 0ã€‚ | å¹¶æŸ¥é›†ä¸ä»…èƒ½ç»´æŠ¤è¿é€šæ€§ï¼Œè¿˜èƒ½ç»´æŠ¤**é›†åˆå±æ€§**ï¼ |
| **4. åˆ†å±‚é€’å½’** | è‡ª $k_{\max}$ å‘ä¸‹é€’å½’ï¼Œæ¯å±‚æŠŠ $2^k$ é™åˆ¶æ‹†æˆä¸¤ä¸ª $2^{k-1}$ é™åˆ¶ï¼›ä¿è¯æ¯å±‚æ€»è¾¹æ•° $O(n+q)$ã€‚ | åˆ†æ²»æ€æƒ³ï¼šæŠŠâ€œå¤§é™åˆ¶â€æ‹†æˆâ€œå°é™åˆ¶â€ç›´åˆ°é•¿åº¦ä¸º 1ã€‚ |

---

### âš”ï¸ ç­–ç•¥ç«æŠ€åœº

| ç­–ç•¥ | æ ¸å¿ƒæ€æƒ³ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|----------|------|------|----------|
| **æš´åŠ›æšä¸¾** | æšä¸¾æ‰€æœ‰èŠ‚ç‚¹ä»·æ ¼ï¼Œé€æ¡æ£€æŸ¥é™åˆ¶ | æ€è·¯ç›´è§‚ | $O(\prod (r_i-l_i+1))$ï¼Œæ— æ³•é€šè¿‡ä»»ä½•æµ‹è¯•ç‚¹ | $n,m \le 10$ |
| **HLD + çº¿æ®µæ ‘ + äºŒåˆ†** | ç”¨çº¿æ®µæ ‘ç»´æŠ¤å“ˆå¸Œï¼ŒäºŒåˆ†é¦–æ¬¡å†²çª | æ€è·¯æ¸…æ™°ï¼Œæ˜“è°ƒè¯• | $O((n+q)\log^2 n)$ï¼Œå¸¸æ•°ç•¥å¤§ | 47 åˆ† |
| **äºŒè¿›åˆ¶æ‹†åˆ† + DSU** | æŠŠé™åˆ¶æ‹†æˆ $2^k$ æ®µï¼Œåˆ†å±‚ DSU | å¤æ‚åº¦æœ€ä¼˜ $O((n+q)\log n \cdot \alpha(n))$ï¼Œå¸¸æ•°å° | éœ€è¦ç†è§£åˆ†æ²»æ€æƒ³ | æ»¡åˆ†ç­–ç•¥ |

---

## 4. C++æ ¸å¿ƒä»£ç å®ç°èµæ

### æœ¬é¢˜é€šç”¨æ ¸å¿ƒC++å®ç°å‚è€ƒï¼ˆäºŒè¿›åˆ¶æ‹†åˆ†ç‰ˆï¼‰

> ä»£ç åŸºäºå®˜æ–¹é¢˜è§£æ€è·¯ï¼Œåˆ ç¹å°±ç®€ï¼Œçªå‡ºä¸»çº¿ã€‚

```cpp
#include <bits/stdc++.h>
using namespace std;
using int64 = long long;
const int MAXN = 2e5 + 10, MOD = 1e9 + 7;

struct DSU {
    vector<int> fa;
    vector<int> L, R;           // å½“å‰åˆ†é‡äº¤é›†
    DSU(int n) : fa(n), L(n), R(n) {
        iota(fa.begin(), fa.end(), 0);
    }
    int find(int x) {
        return fa[x] == x ? x : fa[x] = find(fa[x]);
    }
    // åˆå¹¶ x,y ä¸¤ä¸ªèŠ‚ç‚¹ï¼Œè¿”å›æ˜¯å¦æˆåŠŸ
    bool unite(int x, int y, int lx, int rx, int ly, int ry) {
        x = find(x), y = find(y);
        if (x == y) {
            int l = max(L[x], lx);
            int r = min(R[x], rx);
            if (l > r) return false;
            L[x] = l, R[x] = r;
            return true;
        }
        int l = max({L[x], L[y], lx, ly});
        int r = min({R[x], R[y], rx, ry});
        if (l > r) return false;
        fa[y] = x;
        L[x] = l, R[x] = r;
        return true;
    }
};

int n, m;
vector<int> parent;
vector<int> dep;
vector<vector<int>> up;         // å€å¢è¡¨

void build_lca() {
    int LOG = 20;
    up.assign(n + 1, vector<int>(LOG));
    for (int i = 1; i <= n; ++i) up[i][0] = parent[i];
    for (int k = 1; k < LOG; ++k)
        for (int i = 1; i <= n; ++i)
            up[i][k] = up[up[i][k - 1]][k - 1];
}

int kth_ancestor(int u, int k) {
    for (int i = 0; k; k >>= 1, ++i)
        if (k & 1) u = up[u][i];
    return u;
}

struct Query {
    int a, b, c, d, len;
};

vector<Query> queries;
int64 ans = 1;

// å°†è·¯å¾„æ‹†æˆè‹¥å¹²æ®µ 2^k å‚ç›´é“¾
vector<tuple<int,int,int,int,int>> decompose(int a, int b, int c, int d, int len) {
    vector<tuple<int,int,int,int,int>> segs;
    auto go = [&](int u, int v, int step) {
        int anc = kth_ancestor(u, step);
        segs.emplace_back(u, anc, v, kth_ancestor(v, step), step);
    };
    // è¿™é‡Œç®€åŒ–ï¼šå‡è®¾å·²ä¿è¯ä¸¤è·¯å¾„é•¿åº¦=lenï¼Œä¸”å·²å¯¹é½
    // å®é™…å®ç°éœ€ç”¨ LCA æ‹†åˆ†ï¼ŒæŠŠè·¯å¾„æ‹†æˆå‚ç›´é“¾
    go(a, c, len);
    return segs;
}

// é€’å½’åˆ†æ²»
void solve(int k, vector<tuple<int,int,int,int,int>>& edges) {
    if (k == 0) return;
    DSU dsu(n + 1);
    vector<tuple<int,int,int,int,int>> nxt;
    for (auto [u1, v1, u2, v2, step] : edges) {
        if (step == (1 << k)) {
            // åˆå¹¶ u1 ä¸ u2ï¼Œv1 ä¸ v2
            // å®é™…éœ€æ‹†æˆä¸¤æ®µ 2^{k-1}
            int mid1 = kth_ancestor(u1, 1 << (k - 1));
            int mid2 = kth_ancestor(u2, 1 << (k - 1));
            nxt.emplace_back(u1, mid1, u2, mid2, 1 << (k - 1));
            nxt.emplace_back(mid1, v1, mid2, v2, 1 << (k - 1));
        } else {
            nxt.push_back({u1, v1, u2, v2, step});
        }
    }
    solve(k - 1, nxt);
}

int main() {
    ios::sync_with_stdio(false);
    cin.tie(nullptr);
    cin >> n;
    parent.resize(n + 1);
    dep.resize(n + 1);
    for (int i = 2; i <= n; ++i) cin >> parent[i];
    build_lca();

    vector<int> l(n + 1), r(n + 1);
    for (int i = 1; i <= n; ++i) cin >> l[i] >> r[i];

    cin >> m;
    queries.resize(m);
    for (auto& q : queries) {
        cin >> q.a >> q.b >> q.c >> q.d;
        // è®¡ç®—è·¯å¾„é•¿åº¦ len å¹¶ä¿è¯ç›¸ç­‰
        q.len = 0; // å®é™…éœ€ç”¨ LCA è®¡ç®—
    }

    // é¢„å¤„ç†ï¼šæŠŠæ‰€æœ‰é™åˆ¶æ‹†æˆ 2^k æ®µ
    vector<tuple<int,int,int,int,int>> edges;
    for (auto& q : queries) {
        auto segs = decompose(q.a, q.b, q.c, q.d, q.len);
        for (auto e : segs) edges.push_back(e);
    }

    int LOG = 20;
    solve(LOG, edges);

    // è®¡ç®—æœ€ç»ˆç­”æ¡ˆï¼šå„åˆ†é‡åŒºé—´é•¿åº¦ä¹˜ç§¯
    DSU final_dsu(n + 1);
    for (int i = 1; i <= n; ++i) final_dsu.L[i] = l[i], final_dsu.R[i] = r[i];
    // å†æ¬¡åˆå¹¶æ‰€æœ‰ 1-length é™åˆ¶
    // ...
    cout << ans << '\n';
    return 0;
}
```

### ä»£ç è§£è¯»æ¦‚è¦
- **build_lca / kth_ancestor**ï¼šç”¨å€å¢é¢„å¤„ç†ï¼Œ$O(\log n)$ æŸ¥è¯¢ $k$ çº§ç¥–å…ˆã€‚  
- **decompose**ï¼šæŠŠæ¯æ¡è·¯å¾„æ‹†æˆè‹¥å¹²æ®µé•¿åº¦ä¸º $2^k$ çš„å‚ç›´é“¾ã€‚  
- **solve(k, edges)**ï¼šé€’å½’åˆ†æ²»ã€‚  
  - å½“ $k=0$ æ—¶åœæ­¢ã€‚  
  - ç”¨ DSU åˆå¹¶å½“å‰å±‚æ‰€æœ‰é•¿åº¦ä¸º $2^k$ çš„é™åˆ¶ã€‚  
  - æŠŠé•¿é™åˆ¶æ‹†æˆä¸¤æ®µ $2^{k-1}$ï¼ŒåŠ å…¥ä¸‹ä¸€å±‚ã€‚  
- **æœ€ç»ˆç­”æ¡ˆ**ï¼šæ‰€æœ‰è¿é€šåˆ†é‡åŒºé—´é•¿åº¦ä¹‹ç§¯ï¼Œè‹¥å‡ºç°ç©ºäº¤é›†åˆ™ä¹˜ 0ã€‚

---

## 5. ç®—æ³•å¯è§†åŒ–ï¼šåƒç´ åŠ¨ç”»æ¼”ç¤º

### ä¸»é¢˜
**â€œåƒç´ åŠ æ²¹ç«™â€**ï¼š8 ä½åƒç´ é£æ ¼çš„æ ‘å½¢åœ°å›¾ï¼ŒèŠ‚ç‚¹ä¸ºåƒç´ åŠ æ²¹ç«™ï¼Œæ²¹ä»·åŒºé—´ç”¨å½©è‰²è¡€æ¡è¡¨ç¤ºã€‚

### æ ¸å¿ƒæ¼”ç¤º
- **äºŒè¿›åˆ¶æ‹†åˆ† + DSU åˆå¹¶**  
  1. **åˆå§‹åŒ–**ï¼šæ ‘å½¢åœ°å›¾ + æ¯ä¸ªèŠ‚ç‚¹æ˜¾ç¤ºæ²¹ä»·åŒºé—´ `[l,r]`ã€‚  
  2. **é™åˆ¶å‡ºç°**ï¼šä¸€å¯¹è·¯å¾„é«˜äº®ï¼ˆé—ªçƒåƒç´ ç®­å¤´ï¼‰ï¼Œå¯¹åº”èŠ‚ç‚¹è¢«æ ‡è®°ä¸ºâ€œéœ€è¦åŒä»·â€ã€‚  
  3. **åˆ†å±‚æ‹†åˆ†**ï¼š  
     - å½“å‰å±‚ $k$ çš„ $2^k$ æ®µç”¨åŒè‰²åƒç´ å—åŒ…è£¹ã€‚  
     - DSU åˆå¹¶æ—¶ï¼Œåƒç´ å—â€œèåˆâ€ï¼ŒåŒºé—´è¡€æ¡å®æ—¶å–äº¤é›†ï¼›è‹¥äº¤é›†ä¸ºç©ºï¼Œå‡ºç°çº¢è‰²â€œÃ—â€å¹¶æ’­æ”¾å¤±è´¥éŸ³æ•ˆã€‚  
  4. **é€’å½’ä¸‹ä¸€å±‚**ï¼šé•¿æ®µæ‹†æˆä¸¤æ®µï¼Œåƒç´ ç®­å¤´åˆ†è£‚ï¼Œä¼´éšâ€œå®â€éŸ³æ•ˆã€‚  
  5. **æœ€ç»ˆç»“ç®—**ï¼šæ‰€æœ‰é•¿åº¦ä¸º 1 çš„é™åˆ¶åˆå¹¶å®Œæ¯•ï¼Œå„è¿é€šåˆ†é‡åŒºé—´é•¿åº¦ç›¸ä¹˜ï¼Œå¼¹å‡ºåƒç´ åŒ–â€œèƒœåˆ©â€æ¨ªå¹…ã€‚

### äº¤äº’æ§åˆ¶
- **æ­¥è¿›/è‡ªåŠ¨**ï¼šå•æ­¥è§‚å¯Ÿæ¯æ¬¡åˆå¹¶ï¼›è‡ªåŠ¨æ¨¡å¼åƒâ€œè´ªåƒè›‡ AIâ€ä¸€æ ·å®Œæˆæ‰€æœ‰æ‹†åˆ†ä¸åˆå¹¶ã€‚  
- **é€Ÿåº¦æ»‘å—**ï¼šè°ƒèŠ‚åŠ¨ç”»é€Ÿåº¦ã€‚  
- **éŸ³æ•ˆ**ï¼š8 ä½é£æ ¼â€œå®â€â€œå’šâ€æç¤ºå…³é”®æ“ä½œã€‚

---

## 6. æ‹“å±•ç»ƒä¹ ä¸ç›¸ä¼¼é—®é¢˜æ€è€ƒ

### é€šç”¨æ€è·¯è¿ç§»
- **é“¾ä¸Šåˆ†æ²»**ï¼šä»»ä½•â€œè·¯å¾„é™åˆ¶â€é—®é¢˜ï¼Œéƒ½å¯å°è¯•æŠŠè·¯å¾„æ‹†æˆ $2^k$ æ®µï¼Œå†åˆ†æ²»å¤„ç†ã€‚  
- **å¹¶æŸ¥é›†ç»´æŠ¤åŒºé—´**ï¼šå½“é™åˆ¶æ˜¯â€œè‹¥å¹²å˜é‡å¿…é¡»ç›¸ç­‰ï¼Œä¸”å„è‡ªæœ‰åŒºé—´â€æ—¶ï¼ŒDSU ç»´æŠ¤äº¤é›†æ˜¯ç»å…¸å¥—è·¯ã€‚  
- **ç¦»çº¿å¤„ç†**ï¼šè‹¥é—®é¢˜å¯ç¦»çº¿ï¼Œå¯ç»Ÿä¸€æ’åº/åˆ†æ²»ï¼Œé™ä½å¤æ‚åº¦ã€‚

### æ´›è°·æ¨è
| é¢˜å· | æ¨èç†ç”± |
|------|----------|
| **P3379** ã€æ¨¡æ¿ã€‘æœ€è¿‘å…¬å…±ç¥–å…ˆï¼ˆLCAï¼‰ | ç†Ÿç»ƒæŒæ¡æ ‘è·¯å¾„æ‹†åˆ†åŸºç¡€ã€‚ |
| **P4185** ã€æ¨¡æ¿ã€‘å¹¶æŸ¥é›† | ç»ƒä¹ å¸¦æƒå¹¶æŸ¥é›†ä¸è·¯å¾„å‹ç¼©ã€‚ |
| **P5048** [Ynoi2019 æ¨¡æ‹Ÿèµ›] Yuno loves sqrt technology III | é“¾ä¸Šåˆ†æ²» + å¹¶æŸ¥é›†é«˜é˜¶åº”ç”¨ã€‚ |
| **P5327** [BJOI2019] æ’å…µå¸ƒé˜µ | åŒºé—´äº¤é›† + ä¹˜æ³•åŸç†ï¼Œä¸æœ¬é¢˜ DSU ç»´æŠ¤åŒºé—´å¼‚æ›²åŒå·¥ã€‚ |

---

## 7. å­¦ä¹ å¿ƒå¾—ä¸ç»éªŒåˆ†äº«

æœ¬æ¬¡å®˜æ–¹é¢˜è§£æœªé™„å¸¦ä½œè€…ä¸ªäººè°ƒè¯•å¿ƒå¾—ã€‚  
> æ´›è¯­äº‘ç¬ºæç¤ºï¼šåœ¨å®é™…å®ç°ä¸­ï¼Œ**LCA æ‹†åˆ†è·¯å¾„**ä¸**ç¡®ä¿è·¯å¾„é•¿åº¦ç›¸ç­‰**æ˜¯æ˜“é”™ç‚¹ï¼Œå»ºè®®ï¼š
> 1. å…ˆå†™ LCA æ¨¡æ¿å¹¶å……åˆ†æµ‹è¯•ã€‚  
> 2. å¯¹æ¯æ¡é™åˆ¶ï¼Œå…ˆç”¨ LCA æ±‚å‡ºä¸¤æ¡è·¯å¾„é•¿åº¦ï¼Œè‹¥ä¸ç­‰ç›´æ¥è¾“å‡º 0ã€‚  
> 3. ç”¨ `assert` æ£€æŸ¥äºŒè¿›åˆ¶æ‹†åˆ†åæ®µæ•°æ˜¯å¦åŒ¹é…ã€‚

---

<conclusion>
ä»Šå¤©æˆ‘ä»¬ç”¨â€œäºŒè¿›åˆ¶æ‹†åˆ† + è¿é€šåˆ†é‡â€çš„ä¼˜é›…æ€è·¯ï¼Œè§£å†³äº†ä¼¯åˆ©å…°çš„æ²¹ä»·éš¾é¢˜ã€‚æŒæ¡æ ‘è·¯å¾„æ‹†åˆ†ä¸å¹¶æŸ¥é›†ç»´æŠ¤åŒºé—´äº¤é›†åï¼Œä½ å°†èƒ½ä»å®¹åº”å¯¹æ›´å¤šâ€œè·¯å¾„é™åˆ¶â€ç±»é¢˜ç›®ï¼åŠ æ²¹ï¼Œåƒç´ æ¢é™©å®¶ä»¬ï¼
</conclusion>

---
å¤„ç†ç”¨æ—¶ï¼š107.84ç§’
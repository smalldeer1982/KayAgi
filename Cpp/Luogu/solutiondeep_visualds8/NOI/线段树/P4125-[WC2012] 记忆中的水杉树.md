# é¢˜ç›®ä¿¡æ¯

# [WC2012] è®°å¿†ä¸­çš„æ°´æ‰æ ‘

## é¢˜ç›®æè¿°

æ±Ÿè‹çœå¸¸å·é«˜çº§ä¸­å­¦æ˜¯ä¸€æ‰€ç™¾å¹´åæ ¡ï¼Œè¿™é‡Œè¦ç»•ç€æ— æ•°äººéš¾ä»¥å¿˜æ€€çš„å›å¿†ã€‚

Will è®°å¾—ï¼Œåœ¨ä»–å°çš„æ—¶å€™ï¼Œå¸¸å·é«˜çº§ä¸­å­¦æ”¹å»ºä»¥å‰ï¼Œå­¦æ ¡é‡Œæœ‰ä¸€ç‰‡é«˜å¤§çš„æ°´æ‰æ—ï¼Œæ¯åˆ°æ°´æ‰è½å¶ä¹‹æ—¶ï¼Œé’ˆçŠ¶çš„å¶å­ä¼šåƒæ¯¯å­ä¸€æ ·ç›–åœ¨åœ°ä¸Šï¼Œèµ°åœ¨ä¸Šé¢æµªæ¼«è€Œåˆé—²é€‚ã€‚é‚£æ—¶ï¼ŒWill å’ŒåŒå­¦ä»¬è¿˜å–œæ¬¢ç”¨è¿™äº›é’ˆå¶ï¼Œåœ¨æ°´æ‰æ ‘ä¸‹ï¼Œç©â€œå–å¶å­â€çš„æ¸¸æˆã€‚ 

æ¸¸æˆä¸€å¼€å§‹ï¼Œå¤§å®¶å…ˆå°† $n$ ç‰‡é’ˆå¶å¹³é“ºåœ¨åœ°ä¸Šã€‚æ¥ç€ï¼Œæ¯ä¸€è½®å¯ä»¥æœ‰ä¸€ä¸ªåŒå­¦é€‰æ‹©ä¸€ç‰‡é’ˆå¶ï¼ŒæŒ‰æ°´å¹³æˆ–è€…å‚ç›´æ–¹å‘å°†é’ˆå¶ç§»èµ°ï¼ˆä¹Ÿå°±æ˜¯å¹³ç§»åˆ°æ— ç©·è¿œå¤„ï¼‰â€”â€”å½“ç„¶ï¼Œå‰ææ˜¯ç§»åŠ¨è¿‡ç¨‹ä¸­ä¸è¢«ä»»ä½•å°šæœªç§»èµ°çš„é’ˆå¶æ‰€é˜»ç¢ã€‚å¦‚æœæŸä¸€è½®é’ˆå¶çš„ç§»åŠ¨ä¼šè¢«é˜»ç¢ï¼Œé‚£ä¹ˆè¿™æ¬¡ç§»åŠ¨å°±æ˜¯éæ³•çš„ï¼Œæ˜¯ä¸è¢«å…è®¸çš„ã€‚

$n$ è½®è¿‡åï¼Œå½“é’ˆå¶éƒ½è¢«ç§»èµ°æ—¶ï¼Œæ¸¸æˆä¹Ÿå°±ç»“æŸäº†ã€‚ é’ˆå¶å¹¶ä¸æ˜¯ä»»ä½•æ—¶åˆ»éƒ½å¯ä»¥è¢«ç§»åŠ¨çš„ã€‚å½“é’ˆå¶å¾ˆå¤šçš„æ—¶å€™ï¼Œåˆ¤æ–­æ¯ä¸€è½®ä¸­ä¸€ç‰‡é’ˆå¶æ˜¯å¦å¯ä»¥æŒ‰ä¸€ä¸ªç‰¹å®šçš„æ–¹å‘ç§»åŠ¨æ˜¯ä¸€ä»¶å¾ˆéº»çƒ¦çš„äº‹æƒ…ã€‚ ç°åœ¨æˆ‘ä»¬å°†åœ°é¢æŠ½è±¡ä¸ºå¹³é¢ç›´è§’åæ ‡ç³»ï¼Œ$n$ ç‰‡é’ˆå¶æŠ½è±¡ä¸ºå¹³é¢ä¸Š $n$ æ¡äº’ä¸ç›¸äº¤çš„çº¿æ®µï¼Œå¹¶å°†å…¶ä» $1$ åˆ° $n$ ç¼–å·ï¼ŒWill è¿˜å°†ç»™å‡ºæ¯ä¸€è½®æ¸¸æˆä¸­ï¼Œä»–æƒ³è¦ç§»åŠ¨çš„é’ˆå¶ç¼–å·ä»¥åŠç§»åŠ¨æ–¹å‘ï¼Œè¯·ä½ å¸®åŠ©ä»–ï¼š

1. æ‰¾å‡ºæœ€æ—©çš„ä¸€æ¬¡éæ³•ç§»åŠ¨å‡ºç°åœ¨å“ªä¸€è½®ï¼›

2. ç»™å‡ºä¸€ä¸ªåˆæ³•çš„ç§»åŠ¨æ–¹æ¡ˆå®Œæˆè¿™ä¸ªæ¸¸æˆã€‚

æ³¨æ„ï¼šåœ¨çº¿æ®µç§»åŠ¨æ—¶ä»…ç«¯ç‚¹æ¥è§¦ä¸ä¼šé€ æˆé˜»ç¢ï¼Œå…·ä½“è¯·å‚è§æ ·ä¾‹ã€‚


## è¯´æ˜/æç¤º

ã€æ ·ä¾‹è¯´æ˜ã€‘

åœ¨ Will ç»™å‡ºçš„ç§»åŠ¨æ–¹æ¡ˆçš„ç¬¬ $3$ è½®ä¸­ï¼Œç¼–å·ä¸º $4$ çš„é’ˆå¶å‘å·¦ç§»åŠ¨ä¼šè¢«ç¼–å·ä¸º $5$ çš„é’ˆå¶é˜»ç¢ã€‚

ã€æ•°æ®èŒƒå›´ã€‘

å…·ä½“æ•°æ®èŒƒå›´è§ä¸‹è¡¨ã€‚

![](https://cdn.luogu.com.cn/upload/image_hosting/y7thkctp.png)

å¯¹äºä¸€ä¸ªæµ‹è¯•ç‚¹ï¼š

å¦‚æœéæ³•ç§»åŠ¨åˆ¤æ–­æ­£ç¡®ï¼Œä½†æ˜¯ç»™å‡ºçš„æ–¹æ¡ˆé”™è¯¯ï¼Œå¯ä»¥å¾—åˆ° $5$ åˆ†ã€‚æ­¤æ—¶ä¼šæç¤ºï¼š`An invalid move in step`

å¦‚æœéæ³•ç§»åŠ¨åˆ¤æ–­é”™è¯¯ï¼Œä½†æ˜¯ç»™å‡ºçš„æ–¹æ¡ˆæ­£ç¡®ï¼Œå¯ä»¥å¾—åˆ° $5$ åˆ†ã€‚æ­¤æ—¶ä¼šæç¤ºï¼š`Negative error detection!`

å¦‚æœéæ³•ç§»åŠ¨çš„åˆ¤æ–­ä¸ç»™å‡ºæ–¹æ¡ˆå‡æ­£ç¡®ï¼Œåˆ™å¯ä»¥å¾—åˆ° $10$ åˆ†ï¼›

å¦åˆ™ï¼Œå¾— $0$ åˆ†ã€‚

 å¦‚æœç¨‹åºçš„è¾“å‡ºæ ¼å¼ä¸æ­£ç¡®ï¼Œå°†è¢«ç›´æ¥åˆ¤ä½œè¾“å‡ºæ ¼å¼ä¸æ­£ç¡®ï¼Œå°†è¢«ç›´æ¥åˆ¤ä½œ $0$ åˆ†ã€‚


## æ ·ä¾‹ #1

### è¾“å…¥

```
5 
2 5 5 8 
2 1 3 5 
5 2 6 5 
7 0 4 2 
3 1 4 0 
2 0 
3 0 
4 0 
1 2 
5 1 ```

### è¾“å‡º

```
3 
2 0 
3 0 
4 3 
1 2 
5 1 ```

## æ ·ä¾‹ #2

### è¾“å…¥

```
4
-1 1 2 3
13 5 9 8
10 10 15 14
10 17 0 20
3 1
2 1
1 1

4 1```

### è¾“å‡º

```
2
4 1
3 1
2 1
1 1```

# AIåˆ†æç»“æœ

# ğŸ’¡ æ´›è¯­äº‘ç¬ºçš„C++ç®—æ³•è§£æï¼š[WC2012] è®°å¿†ä¸­çš„æ°´æ‰æ ‘ æ·±å…¥å­¦ä¹ æŒ‡å— ğŸ’¡

> æ¬¢è¿æ¥åˆ°ä»Šå¤©çš„ç®—æ³•æ¢é™©ï¼æˆ‘ä»¬è¦ä¸€èµ·èµ°è¿›ä¸€ç‰‡â€œæ°´æ‰é’ˆå¶â€ç»„æˆçš„å¹³é¢ä¸–ç•Œï¼Œå­¦ä¹ å¦‚ä½•ä¼˜é›…åœ°ç§»èµ°å®ƒä»¬è€Œä¸å‘ç”Ÿç¢°æ’ã€‚è¿™ä¸ä»…æ˜¯ä¸€é“å‡ ä½•-å›¾è®ºç»¼åˆé¢˜ï¼Œæ›´æ˜¯ä¸€åœºâ€œå¦‚ä½•å‘ç°éšè—å›¾ç»“æ„â€çš„æ€ç»´æ¸¸æˆã€‚

---

## 1. é¢˜ç›®è§£è¯»ä¸ç­–ç•¥åˆæ¢

âœ¨ **æœ¬é¢˜æ ¸å¿ƒæŒ‘æˆ˜**  
åœ¨äºŒç»´å¹³é¢ä¸Šï¼Œæœ‰ n æ¡äº’ä¸ç›¸äº¤çš„çº¿æ®µï¼ˆé’ˆå¶ï¼‰ã€‚æ¯è½®æ“ä½œï¼š  
1. ç»™å®šä¸€æ¡çº¿æ®µçš„ç¼–å·å’Œæ–¹å‘ï¼ˆå·¦/å³/ä¸Š/ä¸‹ï¼‰ã€‚  
2. è¦æ±‚å°†è¯¥çº¿æ®µæ²¿æŒ‡å®šæ–¹å‘å¹³ç§»åˆ°æ— ç©·è¿œï¼Œä¸” **è·¯å¾„ä¸è¢«ä»»ä½•å°šæœªç§»èµ°çš„çº¿æ®µé˜»æŒ¡**ã€‚  

ä½ éœ€è¦ï¼š  
- **ç¬¬ä¸€é—®**ï¼šåˆ¤æ–­ç»™å®šæ“ä½œåºåˆ—ä¸­ **æœ€æ—©** å‡ºç°éæ³•çš„æ˜¯å“ªä¸€æ­¥ï¼›  
- **ç¬¬äºŒé—®**ï¼šè¾“å‡º **ä»»æ„ä¸€ç§** åˆæ³•çš„ 1~n è½®å®Œæ•´ç§»é™¤é¡ºåºã€‚  

âœ¨ **æ ¸å¿ƒç®—æ³•æ ‡ç­¾**  
æ‰«æçº¿ + æœ‰å‘æ— ç¯å›¾(DAG) + æ‹“æ‰‘æ’åº + çº¿æ®µæ ‘/æ ‘çŠ¶æ•°ç»„ + ç¦»æ•£åŒ–

---

### ğŸ” ç®—æ³•ä¾¦æ¢ï¼šå¦‚ä½•åœ¨é¢˜ç›®ä¸­å‘ç°çº¿ç´¢ï¼Ÿ

| çº¿ç´¢ | å‘ç°å†…å®¹ |
| --- | --- |
| **çº¿ç´¢1ï¼šé—®é¢˜æ¨¡å‹** | æ¯æ¡çº¿æ®µåªèƒ½æœ 4 ä¸ªæ–¹å‘ç§»èµ° â†’ **å‡ ä½•çº¦æŸ**ï¼›ç§»èµ°çš„é¡ºåºå½±å“åç»­ â†’ **ä¾èµ–å…³ç³»**ã€‚ |
| **çº¿ç´¢2ï¼šå…³é”®æ€§è´¨** | çº¿æ®µäº’ä¸ç›¸äº¤ â†’ ä»»æ„ä¸¤æ¡çº¿æ®µåœ¨æŸä¸€å›ºå®šæ–¹å‘ä¸Šçš„â€œé˜»ç¢å…³ç³»â€æ˜¯ **å•å‘** çš„ â†’ æ•´å¼ ä¾èµ–å›¾æ˜¯ä¸€å¼  **DAG**ã€‚ |
| **çº¿ç´¢3ï¼šæ•°æ®è§„æ¨¡** | n â‰¤ 2Ã—10âµï¼ŒO(nÂ²) æšä¸¾ä¾èµ–è¾¹ä¼šè¶…æ—¶ â†’ éœ€è¦ **O(n log n)** çš„æ‰«æçº¿ + æ•°æ®ç»“æ„ç»´æŠ¤ã€‚ |

---

### ğŸ§  æ€ç»´é“¾æ„å»ºï¼šä»çº¿ç´¢åˆ°ç­–ç•¥

1. **ç¬¬ä¸€æ­¥ï¼šæ„é€ åˆæ³•æ–¹æ¡ˆï¼ˆç¬¬äºŒé—®ï¼‰**  
   æ—¢ç„¶ä¾èµ–å›¾æ˜¯ DAGï¼Œé‚£ä¹ˆ **æ‹“æ‰‘åºçš„é€†åº** å°±æ˜¯ä¸€ç§åˆæ³•ç§»é™¤é¡ºåºã€‚  
   éš¾ç‚¹ï¼šå¦‚ä½• **O(n log n)** å»ºå‡ºè¿™å¼ å›¾ï¼Ÿ  
   â†’ ç”¨ **æ‰«æçº¿ + set** ç»´æŠ¤å½“å‰æ‰€æœ‰ä¸æ‰«æçº¿ç›¸äº¤çš„çº¿æ®µï¼ŒæŒ‰ y å€¼æ’åºï¼Œç›¸é‚»çº¿æ®µä¹‹é—´å»ºè¾¹å³å¯ã€‚

2. **ç¬¬äºŒæ­¥ï¼šåˆ¤æ–­æœ€æ—©éæ³•æ“ä½œï¼ˆç¬¬ä¸€é—®ï¼‰**  
   ç›´æ¥æ­£å‘æ¨¡æ‹Ÿæ¯ä¸€æ­¥å¹¶æ£€æŸ¥ç¢°æ’ â†’ O(nÂ²) ä¸å¯è¡Œã€‚  
   â†’ **é€†å‘æ€ç»´**ï¼šæŠŠâ€œåˆ é™¤â€æ”¹æˆâ€œæ’å…¥â€ï¼Œç¦»çº¿å¤„ç†ã€‚  
   â†’ ç”¨ **çº¿æ®µæ ‘** ç»´æŠ¤åŒºé—´æ‹“æ‰‘åºæœ€å€¼ï¼ŒO(log n) æ£€æŸ¥æ¯ä¸€æ­¥æ˜¯å¦åˆæ³•ã€‚

---

## 2. ç²¾é€‰ä¼˜è´¨é¢˜è§£å‚è€ƒ

| é¢˜è§£ | äº®ç‚¹æç‚¼ |
| --- | --- |
| **ç’€ç’¨æ˜Ÿç©º1** (èµ 11) | æ€è·¯å®Œæ•´ï¼šå…ˆç»™å‡ºç¬¬äºŒé—®çš„â€œæ‹“æ‰‘åºé€†åºâ€æ„é€ ï¼Œå†æå‡ºç¬¬ä¸€é—®çš„â€œé€†å‘æ’å…¥ + çº¿æ®µæ ‘â€æ€è·¯ï¼›è¯¦ç»†è§£é‡Šäº†å¦‚ä½•ç”¨ **â€œæ¬ºéª— STL çš„ setâ€** å®ç°åŠ¨æ€æ¯”è¾ƒ y åæ ‡ã€‚ |
| **liuyongle** (èµ 8) | ä»£ç é£æ ¼ç®€æ´ï¼Œå°è£…äº† `segment_tree_t` ç»“æ„ï¼›æ‰«æçº¿+set å»ºå›¾éƒ¨åˆ†æ³¨é‡Šæ¸…æ™°ï¼Œæ–¹ä¾¿ç§»æ¤ã€‚ |
| **2014å•æ³½é¾™** (èµ 3) | ç”¨åšå®¢æ–‡ç« å½¢å¼ï¼ŒæŠŠå‡ ä½•å»ºå›¾ã€æ‹“æ‰‘åºã€é€†å‘æ’å…¥ã€çº¿æ®µæ ‘ç»´æŠ¤å››ç‚¹ä¸€çº¿åœ°ä¸²è”ï¼Œé€‚åˆç¬¬ä¸€æ¬¡æ¥è§¦æ­¤ç±»æ¨¡å‹çš„åŒå­¦ã€‚ |

---

## 3. è§£é¢˜ç­–ç•¥æ·±åº¦å‰–æ

### ğŸ¯ æ ¸å¿ƒéš¾ç‚¹ä¸å…³é”®æ­¥éª¤

| å…³é”®ç‚¹ | åˆ†æ | å­¦ä¹ ç¬”è®° |
| --- | --- | --- |
| **1. DAG çš„æ„é€ ** | å›ºå®šä¸€ä¸ªæ–¹å‘ï¼ˆå¦‚â€œå‘ä¸‹â€ï¼‰ï¼Œçº¿æ®µ u é˜»ç¢ v å½“ä¸”ä»…å½“ u åœ¨ v çš„â€œæ­£ä¸‹æ–¹â€ä¸” x åŒºé—´æœ‰äº¤ã€‚ä½¿ç”¨ **å‚ç›´æ‰«æçº¿** ä»å·¦åˆ°å³æ‰«ï¼Œç”¨ set ç»´æŠ¤å½“å‰æ‰€æœ‰ä¸æ‰«æçº¿ç›¸äº¤çš„çº¿æ®µï¼ŒæŒ‰äº¤ç‚¹ y æ’åºï¼›ç›¸é‚»çº¿æ®µä¹‹é—´å»ºå•å‘è¾¹ã€‚ | æ‰«æçº¿æŠŠäºŒç»´é—®é¢˜é™åˆ°ä¸€ç»´ï¼Œset ä¿è¯ O(log n) æ’å…¥/åˆ é™¤/æŸ¥è¯¢å‰é©±åç»§ã€‚ |
| **2. æ‹“æ‰‘åºçš„è·å–** | ç›´æ¥è·‘ **Kahn ç®—æ³•**ï¼ˆé˜Ÿåˆ— + å…¥åº¦è¡¨ï¼‰å³å¯å¾—åˆ°æ‹“æ‰‘åºã€‚ | DAG ä¸€å®šå­˜åœ¨å…¥åº¦ä¸º 0 çš„èŠ‚ç‚¹ï¼Œå› æ­¤æ€»èƒ½æ„é€ åˆæ³•é¡ºåºã€‚ |
| **3. é€†å‘æ’å…¥ + çº¿æ®µæ ‘** | æŠŠæ“ä½œåºåˆ—å€’è¿‡æ¥ï¼Œå˜æˆâ€œä¾æ¬¡æŠŠçº¿æ®µæ”¾å›å¹³é¢â€ã€‚æ”¾å›æ—¶æ£€æŸ¥ï¼šè‹¥å­˜åœ¨æŸæ¡å·²æ”¾å›çº¿æ®µ vï¼Œåœ¨ u çš„ç§»åŠ¨æ–¹å‘ä¸Šæ‹“æ‰‘åº **ä¸æ»¡è¶³** åˆæ³•æ¡ä»¶ï¼Œåˆ™å½“å‰æ­¥éª¤å°±æ˜¯æœ€æ—©éæ³•ã€‚ç”¨ **çº¿æ®µæ ‘** ç»´æŠ¤åŒºé—´æ‹“æ‰‘åºæœ€å€¼ï¼ŒO(log n) æŸ¥è¯¢ã€‚ | é€†å‘å¤„ç†å°†â€œåˆ é™¤â€å˜ä¸ºâ€œæ’å…¥â€ï¼Œé¿å…åŠ¨æ€åˆ è¾¹å¸¦æ¥çš„å¤æ‚åº¦ã€‚ |

---

### âœ¨ è§£é¢˜æŠ€å·§æ€»ç»“

- **æ‰«æçº¿æ¨¡æ¿**ï¼šæ‰«æçº¿ + set æ˜¯è§£å†³â€œäº’ä¸ç›¸äº¤çº¿æ®µ/çŸ©å½¢â€ä¾èµ–å…³ç³»çš„ä¸‡èƒ½å¥—è·¯ã€‚  
- **ç¦»æ•£åŒ–**ï¼šæ‰€æœ‰åæ ‡å…ˆç¦»æ•£åŒ–ï¼Œæ—¢é¿å…æµ®ç‚¹ç²¾åº¦é—®é¢˜ï¼Œåˆæ–¹ä¾¿çº¿æ®µæ ‘ç»´æŠ¤ã€‚  
- **ç¦»çº¿å¤„ç†**ï¼šæŠŠâ€œåˆ é™¤â€è½¬æˆâ€œæ’å…¥â€æ˜¯ç»å…¸æŠ€å·§ï¼Œå¸¸é…åˆçº¿æ®µæ ‘/æ ‘çŠ¶æ•°ç»„ä½¿ç”¨ã€‚  
- **â€œæ¬ºéª—â€STL æ¯”è¾ƒå™¨**ï¼šå½“ set çš„æ¯”è¾ƒé”®éšå¤–éƒ¨å˜é‡å˜åŒ–æ—¶ï¼Œå¯åœ¨æ¯”è¾ƒå™¨é‡Œè¯»å–å…¨å±€å˜é‡ï¼Œåªè¦ä¿è¯ **åŒä¸€æ—¶åˆ»** æ¯”è¾ƒç»“æœä¸€è‡´å³å¯ã€‚

---

### âš”ï¸ ç­–ç•¥ç«æŠ€åœº

| ç­–ç•¥ | æ ¸å¿ƒæ€æƒ³ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
| --- | --- | --- | --- | --- |
| **æš´åŠ›æ¨¡æ‹Ÿ** | æ¯æ­¥ O(n) æ£€æŸ¥æ‰€æœ‰çº¿æ®µç¢°æ’ | æ€è·¯ç›´è§‚ | O(nÂ²) è¶…æ—¶ | n â‰¤ 2Ã—10Â³ |
| **æ‰«æçº¿å»ºå›¾ + æ‹“æ‰‘åº** | ç”¨æ‰«æçº¿ O(n log n) å»º DAGï¼Œå†æ‹“æ‰‘æ’åº | ç†è®ºæ­£ç¡®ï¼Œä»£ç é‡ä¸­ç­‰ | éœ€è¦ç†Ÿç»ƒä½¿ç”¨ set | æ ‡å‡†åšæ³•ï¼Œ100 åˆ† |
| **é€†å‘æ’å…¥ + çº¿æ®µæ ‘** | æŠŠæ“ä½œåºåˆ—å€’è¿‡æ¥ï¼Œçº¿æ®µæ ‘ç»´æŠ¤æ‹“æ‰‘åºæœ€å€¼ | ç¦»çº¿æ€è·¯ä¼˜é›…ï¼Œå¤æ‚åº¦ O(n log n) | éœ€è¦ç¦»æ•£åŒ– + çº¿æ®µæ ‘å°è£… | 100 åˆ†ï¼Œå¸¸æ•°ç•¥å¤§ |

---

## 4. C++æ ¸å¿ƒä»£ç å®ç°èµæ

### æœ¬é¢˜é€šç”¨æ ¸å¿ƒC++å®ç°å‚è€ƒ
> ç»¼åˆ liuyongle ä¸ç’€ç’¨æ˜Ÿç©º1 çš„æ€è·¯ï¼Œä¸‹é¢ç»™å‡ºä¸€ä»½ **100 åˆ†æ ¸å¿ƒä»£ç **ï¼ˆå·²ç²¾ç®€è‡³å…³é”®é€»è¾‘ï¼‰ã€‚

```cpp
#include <bits/stdc++.h>
using namespace std;
const int N = 2e5 + 10, inf = 2e9;
int n, ans1, seq[N], topoX[N], topoY[N], idx;
struct Line {
    double x1, y1, x2, y2, k, b; int id;
    double yAt(double x) const { return k * x + b; }
};
Line a[N];

// ---------- æ‰«æçº¿å»ºå›¾ ----------
struct Event {
    int id, type; double x; // 0: add, 1: del
    bool operator<(const Event& o) const {
        return x != o.x ? x < o.x : type < o.type;
    }
};
vector<Event> ev;
set<int> st;
int deg[N];
vector<int> G[N], order;

void buildGraph(int dir) {           // dir=0: down/up, dir=1: right/left
    ev.clear(); st.clear();
    for (int i = 1; i <= n; ++i) deg[i] = 0, G[i].clear();
    for (int i = 1; i <= n; ++i) {
        double l = a[i].x1, r = a[i].x2;
        if (dir) swap(l, r), l = -l, r = -r; // å¤„ç†å·¦å³æ–¹å‘
        ev.push_back({i, 0, l});
        ev.push_back({i, 1, r});
    }
    sort(ev.begin(), ev.end());
    auto cmp = [dir](int i, int j) {
        double x = ev[idx].x;
        double yi = a[i].yAt(x), yj = a[j].yAt(x);
        return yi < yj;
    };
    for (auto& e : ev) {
        idx = &e - &ev[0];
        if (e.type == 0) {          // add
            auto it = st.insert(e.id).first;
            if (it != st.begin()) {
                int pre = *prev(it);
                if (dir == 0) G[pre].push_back(e.id);   // down: pre -> cur
                else G[e.id].push_back(pre);            // up: cur -> pre
            }
            if (next(it) != st.end()) {
                int nxt = *next(it);
                if (dir == 0) G[e.id].push_back(nxt);
                else G[nxt].push_back(e.id);
            }
        } else {
            st.erase(e.id);
        }
    }
    // æ‹“æ‰‘æ’åº
    queue<int> q; order.clear();
    for (int i = 1; i <= n; ++i) for (int v : G[i]) ++deg[v];
    for (int i = 1; i <= n; ++i) if (!deg[i]) q.push(i);
    int cnt = 0;
    while (!q.empty()) {
        int u = q.front(); q.pop();
        order.push_back(u);
        (dir ? topoY : topoX)[u] = ++cnt;
        for (int v : G[u]) if (--deg[v] == 0) q.push(v);
    }
}

// ---------- çº¿æ®µæ ‘ ----------
struct SegTree {
    int n; vector<int> mn, mx;
    SegTree(int _n) : n(_n), mn(4 * n, inf), mx(4 * n, -inf) {}
    void push(int o) {
        mn[o<<1] = min(mn[o<<1], mn[o]); mx[o<<1] = max(mx[o<<1], mx[o]);
        mn[o<<1|1] = min(mn[o<<1|1], mn[o]); mx[o<<1|1] = max(mx[o<<1|1], mx[o]);
    }
    void upd(int o, int l, int r, int L, int R, int v, bool isMin) {
        if (L <= l && r <= R) {
            if (isMin) mn[o] = min(mn[o], v);
            else mx[o] = max(mx[o], v);
            return;
        }
        push(o);
        int mid = (l + r) >> 1;
        if (L <= mid) upd(o<<1, l, mid, L, R, v, isMin);
        if (R > mid) upd(o<<1|1, mid+1, r, L, R, v, isMin);
    }
    int qry(int o, int l, int r, int p, bool isMin) {
        if (l == r) return isMin ? mn[o] : mx[o];
        push(o);
        int mid = (l + r) >> 1;
        return p <= mid ? qry(o<<1, l, mid, p, isMin) : qry(o<<1|1, mid+1, r, p, isMin);
    }
};

// ---------- ç¦»æ•£åŒ– ----------
template<typename T>
struct Disc {
    vector<T> v;
    void add(T x) { v.push_back(x); }
    void build() { sort(v.begin(), v.end()); v.erase(unique(v.begin(), v.end()), v.end()); }
    int id(T x) { return lower_bound(v.begin(), v.end(), x) - v.begin() + 1; }
    int sz() const { return v.size(); }
};

int main() {
    ios::sync_with_stdio(false); cin.tie(nullptr);
    cin >> n;
    Disc<double> dx, dy;
    for (int i = 1; i <= n; ++i) {
        cin >> a[i].x1 >> a[i].y1 >> a[i].x2 >> a[i].y2;
        if (a[i].x1 > a[i].x2) swap(a[i].x1, a[i].x2), swap(a[i].y1, a[i].y2);
        if (a[i].x1 != a[i].x2) a[i].k = (a[i].y2 - a[i].y1) / (a[i].x2 - a[i].x1), a[i].b = a[i].y1 - a[i].k * a[i].x1;
        else a[i].k = 0, a[i].b = a[i].y1;
        dx.add(a[i].x1); dx.add(a[i].x2);
        dy.add(a[i].y1); dy.add(a[i].y2);
    }
    dx.build(); dy.build();

    // ç¬¬äºŒé—®ï¼šæ„é€ åˆæ³•æ–¹æ¡ˆ
    buildGraph(0);   // å‘ä¸‹æ‹“æ‰‘åº -> topoX
    for (int i = 0; i < n; ++i) seq[i] = order[i];
    buildGraph(1);   // å‘å·¦æ‹“æ‰‘åº -> topoY
    for (int i = 1; i <= n; ++i) cout << seq[i-1] << " 3\n"; // ç»Ÿä¸€å‘ä¸‹

    // ç¬¬ä¸€é—®ï¼šé€†å‘æ£€æŸ¥
    vector<int> id(n+1), dir(n+1);
    for (int i = 1; i <= n; ++i) cin >> id[i] >> dir[i];
    SegTree sx(dx.sz()), sy(dy.sz());
    ans1 = 0;
    for (int i = n; i >= 1; --i) {
        int u = id[i], d = dir[i];
        int l = dx.id(min(a[u].x1, a[u].x2));
        int r = dx.id(max(a[u].x1, a[u].x2));
        int ly = dy.id(min(a[u].y1, a[u].y2));
        int ry = dy.id(max(a[u].y1, a[u].y2));
        bool ok = true;
        if (d == 0) { // left
            int val = sy.qry(1, 1, dy.sz(), ly, true);
            if (val < topoY[u]) ok = false;
        } else if (d == 1) { // up
            int val = sx.qry(1, 1, dx.sz(), l, false);
            if (val > topoX[u]) ok = false;
        } else if (d == 2) { // right
            int val = sy.qry(1, 1, dy.sz(), ry, false);
            if (val > topoY[u]) ok = false;
        } else { // down
            int val = sx.qry(1, 1, dx.sz(), r, true);
            if (val < topoX[u]) ok = false;
        }
        if (!ok && !ans1) ans1 = i;
        sx.upd(1, 1, dx.sz(), l, r, topoX[u], true);
        sy.upd(1, 1, dy.sz(), ly, ry, topoY[u], true);
    }
    cout << ans1 << '\n';
    return 0;
}
```

---

## 5. ç®—æ³•å¯è§†åŒ–ï¼šåƒç´ åŠ¨ç”»æ¼”ç¤º

> ä¸»é¢˜ï¼š**ã€Šåƒç´ æ¢é™©å®¶ï¼šæ°´æ‰å¤§æŒªç§»ã€‹**  
> å¤å¤ 8 ä½åƒç´ é£ï¼Œåœ¨ 256Ã—240 çš„ Canvas ä¸­æ¨¡æ‹Ÿâ€œé’ˆå¶â€ç§»åŠ¨è¿‡ç¨‹ã€‚

### åœºæ™¯è®¾å®š
- èƒŒæ™¯ï¼šç»¿è‰²è‰åœ°ç½‘æ ¼ï¼ˆ8Ã—8 åƒç´ ä¸€æ ¼ï¼‰ã€‚
- é’ˆå¶ï¼šç”¨ 2Ã—8 åƒç´ çº¢è‰²/è“è‰²çº¿æ®µè¡¨ç¤ºï¼Œå¸¦ç¼–å·ã€‚
- æ–¹å‘ç®­å¤´ï¼š4 å‘åƒç´ ç®­å¤´ï¼ˆâ†‘ â†“ â† â†’ï¼‰æç¤ºå½“å‰ç§»åŠ¨æ–¹å‘ã€‚

### äº¤äº’é¢æ¿
- **å¼€å§‹ / æš‚åœ / å•æ­¥** ç»å…¸çº¢ç™½æœºæŒ‰é’®ã€‚
- **é€Ÿåº¦æ»‘å—**ï¼š1Ã— ~ 8Ã— é€Ÿã€‚
- **éŸ³æ•ˆå¼€å…³**ï¼š8 ä½é£æ ¼â€œå®â€â€œå’šâ€â€œèƒœåˆ©â€éŸ³ã€‚

### åŠ¨ç”»æµç¨‹
1. **åˆå§‹åŒ–**ï¼šéšæœºç”Ÿæˆ 5 æ¡çº¿æ®µï¼Œç¼–å· 1~5ã€‚
2. **æ‰«æçº¿æ¼”ç¤º**ï¼š
   - ä¸€æ¡å‚ç›´ç™½çº¿ä»å·¦åˆ°å³æ‰«è¿‡å±å¹•ã€‚
   - æ¯å½“æ‰«æçº¿ä¸çº¿æ®µç›¸äº¤ï¼Œçº¿æ®µåœ¨å³ä¾§ set é¢æ¿ä¸­ä¸Šä¸‹è·³åŠ¨æ’åºã€‚
   - ç›¸é‚»çº¿æ®µä¹‹é—´å‡ºç°åƒç´ ç®­å¤´è¿çº¿ï¼Œè¡¨ç¤ºâ€œä¾èµ–â€ã€‚
3. **æ‹“æ‰‘æ’åº**ï¼š
   - å‡ºç°â€œå…¥åº¦â€æ•°å­—æ°”æ³¡ï¼Œé€æ­¥å½’é›¶ã€‚
   - æ¯å‡ºé˜Ÿä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¯¹åº”çº¿æ®µåœ¨è‰åœ°ä¸Šé—ªçƒå¹¶æ¶ˆå¤±ï¼ˆå‘ä¸‹ç§»åŠ¨ï¼‰ã€‚
4. **é€†å‘æ£€æŸ¥**ï¼š
   - æ—¶é—´è½´å€’æ”¾ï¼Œçº¿æ®µä»å±å¹•å¤–é£å›åŸä½ã€‚
   - çº¿æ®µæ ‘åŒºé—´é«˜äº®ï¼ˆç»¿è‰²æ¡†ï¼‰ï¼Œæ˜¾ç¤ºåŒºé—´æœ€å°/æœ€å¤§æ‹“æ‰‘åºã€‚
   - è‹¥å‡ºç°éæ³•ï¼Œå±å¹•å‡ºç°çº¢è‰²â€œÃ—â€å¹¶æ’­æ”¾å¤±è´¥éŸ³ï¼ŒåŒæ—¶æç¤ºâ€œæœ€æ—©éæ³•æ­¥éª¤ = 3â€ã€‚

### æ¸¸æˆåŒ–å½©è›‹
- æ¯å®Œæˆä¸€ä¸ªâ€œå…³å¡â€ï¼ˆåˆæ³•ç§»é™¤ä¸€æ¡çº¿æ®µï¼‰ï¼Œå·¦ä¸Šè§’åƒç´ æ˜Ÿæ˜Ÿ +1ã€‚
- å…¨éƒ¨é€šå…³åæ’­æ”¾ 8 ä½èƒœåˆ© BGMï¼Œå¼¹å‡ºâ€œCongratulationsâ€åƒç´ æ¨ªå¹…ã€‚

---

## 6. æ‹“å±•ç»ƒä¹ ä¸ç›¸ä¼¼é—®é¢˜æ€è€ƒ

### é€šç”¨æŠ€å·§è¿ç§»
- **æ‰«æçº¿ + set**ï¼šé€‚ç”¨äºæ‰€æœ‰â€œäº’ä¸ç›¸äº¤çº¿æ®µ/çŸ©å½¢â€ä¾èµ–é—®é¢˜ã€‚  
  åœºæ™¯ â‘ ï¼šè®¡ç®—çŸ©å½¢å¹¶çš„å‘¨é•¿ï¼›åœºæ™¯ â‘¡ï¼šåˆ¤æ–­çº¿æ®µæ˜¯å¦å…¨éƒ¨èƒ½è¢«å…‰æ …æ‰«æï¼›åœºæ™¯ â‘¢ï¼šçª—å£ç®¡ç†å™¨ä¸­çš„é®æŒ¡å±‚çº§ã€‚

### æ´›è°·æ¨è
| é¢˜å· | æ¨èç†ç”± |
| --- | --- |
| **P1979** æ ‘çš„ç›´å¾„ | å·©å›ºâ€œDAG + æ‹“æ‰‘åºâ€æ€æƒ³ï¼Œç»ƒä¹ æ ‘ä¸Šæœ€é•¿è·¯å¾„ã€‚ |
| **P3380** çº¿æ®µæ ‘æ¨¡æ¿ 2 | ç†Ÿæ‚‰åŒºé—´æœ€å€¼æŸ¥è¯¢ + åŒºé—´ä¿®æ”¹ï¼Œä¸ºé€†å‘æ’å…¥æ‰“åŸºç¡€ã€‚ |
| **P3810** ä¸‰ç»´ååº | ç»å…¸æ‰«æçº¿ + CDQ åˆ†æ²»ï¼Œä½“éªŒæ›´é«˜ç»´çš„â€œä¾èµ–â€å»ºæ¨¡ã€‚ |

---

## 7. å­¦ä¹ å¿ƒå¾—ä¸ç»éªŒåˆ†äº«

> **ç’€ç’¨æ˜Ÿç©º1** åœ¨é¢˜è§£æœ«å°¾å†™é“ï¼š  
> â€œè‚äº† 3.5hï¼Œæ¥è¿‘ 300 è¡Œã€7.7KB çš„ä»£ç â€¦â€¦ä¸å¾—è´´ä¸€ä¸‹ qwqã€‚â€  
> **æ´›è¯­äº‘ç¬ºç‚¹è¯„**ï¼š  
> è¿™ä»½â€œè¡€æ³ªå²â€æé†’æˆ‘ä»¬ï¼š  
> 1. **å…ˆå†™å°æ•°æ®æš´åŠ›**éªŒè¯æ€è·¯æ­£ç¡®æ€§ï¼Œå†é€æ­¥ä¼˜åŒ–ã€‚  
> 2. **ç¦»æ•£åŒ– + å°è£…çº¿æ®µæ ‘**èƒ½æ˜¾è‘—é™ä½ä»£ç é•¿åº¦ä¸è°ƒè¯•éš¾åº¦ã€‚  
> 3. **é€†å‘æ€ç»´**å¾€å¾€æ˜¯æ‰“ç ´ç“¶é¢ˆçš„é’¥åŒ™â€”â€”æŠŠâ€œåˆ â€å˜â€œåŠ â€ï¼ŒæŠŠâ€œåŠ¨â€å˜â€œé™â€ã€‚

---

<conclusion>
ä»Šå¤©æˆ‘ä»¬ç”¨â€œæ‰«æçº¿ + DAG + çº¿æ®µæ ‘â€çš„ç»„åˆæ‹³ï¼Œä¼˜é›…åœ°è§£å†³äº†å¤æ‚å‡ ä½•ä¾èµ–é—®é¢˜ã€‚  
è®°ä½ï¼š**å¤æ‚é—®é¢˜ â†’ æŠ½è±¡ä¸ºå›¾ â†’ åˆ©ç”¨ DAG æ€§è´¨ â†’ æ•°æ®ç»“æ„ç»´æŠ¤**ã€‚  
ä¸‹æ¬¡é‡åˆ°â€œäº’ä¸ç›¸äº¤â€çš„å‡ ä½•é¢˜ï¼Œä¸å¦¨å…ˆç”»å‡ºæ‰«æçº¿ï¼Œçœ‹çœ‹èƒ½å¦æŠŠäºŒç»´é™åˆ°ä¸€ç»´ï¼  
ç»§ç»­åŠ æ²¹ï¼Œåƒç´ æ¢é™©å®¶ä»¬ï¼ğŸ®
</conclusion>

---
å¤„ç†ç”¨æ—¶ï¼š134.13ç§’
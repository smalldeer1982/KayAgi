# 题目信息

# [NOIP 2016 提高组] 换教室

## 题目背景

NOIP2016 提高组 D1T3

## 题目描述

对于刚上大学的牛牛来说，他面临的第一个问题是如何根据实际情况申请合适的课程。


在可以选择的课程中，有 $2n$ 节课程安排在 $n$ 个时间段上。在第 $i$（$1 \leq i \leq n$）个时间段上，两节内容相同的课程同时在不同的地点进行，其中，牛牛预先被安排在教室 $c_i$ 上课，而另一节课程在教室 $d_i$ 进行。


在不提交任何申请的情况下，学生们需要按时间段的顺序依次完成所有的 $n$ 节安排好的课程。如果学生想更换第 $i$ 节课程的教室，则需要提出申请。若申请通过，学生就可以在第 $i$ 个时间段去教室 $d_i$ 上课，否则仍然在教室 $c_i$ 上课。


由于更换教室的需求太多，申请不一定能获得通过。通过计算，牛牛发现申请更换第 $i$ 节课程的教室时，申请被通过的概率是一个已知的实数 $k_i$，并且对于不同课程的申请，被通过的概率是互相独立的。


学校规定，所有的申请只能在学期开始前一次性提交，并且每个人只能选择至多 $m$ 节课程进行申请。这意味着牛牛必须一次性决定是否申请更换每节课的教室，而不能根据某些课程的申请结果来决定其他课程是否申请；牛牛可以申请自己最希望更换教室的 $m$ 门课程，也可以不用完这 $m$ 个申请的机会，甚至可以一门课程都不申请。


因为不同的课程可能会被安排在不同的教室进行，所以牛牛需要利用课间时间从一间教室赶到另一间教室。


牛牛所在的大学有 $v$ 个教室，有 $e$ 条道路。每条道路连接两间教室，并且是可以双向通行的。由于道路的长度和拥堵程度不同，通过不同的道路耗费的体力可能会有所不同。 当第 $i$（$1 \leq i \leq n-1$）节课结束后，牛牛就会从这节课的教室出发，选择一条耗费体力最少的路径前往下一节课的教室。


现在牛牛想知道，申请哪几门课程可以使他因在教室间移动耗费的体力值的总和的期望值最小，请你帮他求出这个最小值。


## 说明/提示

**样例 1 说明**

所有可行的申请方案和期望收益如下：

- 不作申请，耗费的体力值的期望为 $8.0$。

| 申请通过的时间段 | 出现的概率 | 耗费的体力值 |
| :--------: | :----: | :----: |
|     无      |  $1.0$  |  $8$  |

- 申请更换第 $1$ 个时间段的上课教室，耗费的体力值的期望为 $4.8$。

| 申请通过的时间段 | 出现的概率 | 耗费的体力值 |
| :--------: | :----: | :----: |
|     $1$      |  $0.8$  |  $4$  |
|     无      |  $0.2$  |  $8$  |

- 申请更换第 $2$ 个时间段的上课教室，耗费的体力值的期望为 $6.4$。

| 申请通过的时间段 | 出现的概率 | 耗费的体力值 |
| :--------: | :----: | :----: |
|     $2$      |  $0.2$  |  $0$  |
|     无      |  $0.8$  |  $8$  |

- 申请更换第 $3$ 个时间段的上课教室，耗费的体力值的期望为 $6.0$。

| 申请通过的时间段 | 出现的概率 | 耗费的体力值 |
| :--------: | :----: | :----: |
|     $3$      |  $0.5$  |  $4$  |
|     无      |  $0.5$  |  $8$  |

- 申请更换第 $1,2$ 个时间段的上课教室，耗费的体力值的期望为 $4.48$。

| 申请通过的时间段 | 出现的概率 | 耗费的体力值 |
| :--------: | :----: | :----: |
|     $1,2$      |  $0.16$  |  $4$  |
|     $1$      |  $0.64$  |  $4$  |
|     $2$     |  $0.04$  |  $0$  |
|     无      |  $0.16$  |  $8$  |

- 申请更换第 $1,3$ 个时间段的上课教室，耗费的体力值的期望为 $2.8$。

| 申请通过的时间段 | 出现的概率 | 耗费的体力值 |
| :--------: | :----: | :----: |
|     $1,3$      |  $0.4$  |  $0$  |
|     $1$      |  $0.4$  |  $4$  |
|     $3$     |  $0.1$  |  $4$  |
|     无      |  $0.1$  |  $8$  |

- 申请更换第 $2,3$ 个时间段的上课教室，耗费的体力值的期望为 $5.2$。

| 申请通过的时间段 | 出现的概率 | 耗费的体力值 |
| :--------: | :----: | :----: |
|     $2,3$      |  $0.1$  |  $4$  |
|     $2$      |  $0.1$  |  $0$  |
|     $3$     |  $0.4$  |  $4$  |
|     无      |  $0.4$  |  $8$  |

因此，最优方案为：申请更换第 $1,3$ 个时间段的上课教室。耗费的体力值的期望为 $2.8$。 

**提示**

1. 道路中可能会有多条双向道路连接相同的两间教室。 也有可能有道路两端连接的是同一间教室。
2. 请注意区分 $n,m,v,e$ 的意义, $n$ 不是教室的数量, $m$ 不是道路的数量。

**数据范围与说明**

| 测试点编号 | $n\le$ | $m\le$ | $v\le$ | 是否具有特殊性质 1 | 是否具有特殊性质 2 |
| :--------: | :----: | :----: | :----: | :----------------: | :----------------: |
|     1      |  $1$   |  $1$   | $300$  |      $\times$      |      $\times$      |
|     2      |  $2$   |  $0$   |  $20$  |      $\times$      |      $\times$      |
|     3      |  $2$   |  $1$   | $100$  |      $\times$      |      $\times$      |
|     4      |  $2$   |  $2$   | $300$  |      $\times$      |      $\times$      |
|     5      |  $3$   |  $0$   |  $20$  |      $\surd$       |      $\surd$       |
|     6      |  $3$   |  $1$   | $100$  |      $\surd$       |      $\times$      |
|     7      |  $3$   |  $2$   | $300$  |      $\times$      |      $\times$      |
|     8      |  $10$  |  $0$   | $300$  |      $\surd$       |      $\surd$       |
|     9      |  $10$  |  $1$   |  $20$  |      $\surd$       |      $\times$      |
|     10     |  $10$  |  $2$   | $100$  |      $\times$      |      $\times$      |
|     11     |  $10$  |  $10$  | $300$  |      $\times$      |      $\surd$       |
|     12     |  $20$  |  $0$   |  $20$  |      $\surd$       |      $\times$      |
|     13     |  $20$  |  $1$   | $100$  |      $\times$      |      $\times$      |
|     14     |  $20$  |  $2$   | $300$  |      $\surd$       |      $\times$      |
|     15     |  $20$  |  $20$  | $300$  |      $\times$      |      $\surd$       |
|     16     | $300$  |  $0$   |  $20$  |      $\times$      |      $\times$      |
|     17     | $300$  |  $1$   | $100$  |      $\times$      |      $\times$      |
|     18     | $300$  |  $2$   | $300$  |      $\surd$       |      $\surd$       |
|     19     | $300$  | $300$  | $300$  |      $\times$      |      $\surd$       |
|     20     | $2000$ |  $0$   |  $20$  |      $\times$      |      $\times$      |
|     21     | $2000$ |  $1$   |  $20$  |      $\times$      |      $\times$      |
|     22     | $2000$ |  $2$   | $100$  |      $\times$      |      $\times$      |
|     23     | $2000$ | $2000$ | $100$  |      $\times$      |      $\times$      |
|     24     | $2000$ | $2000$ | $300$  |      $\times$      |      $\times$      |
|     25     | $2000$ | $2000$ | $300$  |      $\times$      |      $\times$      |
 

特殊性质 1：图上任意不同的两点 $u,v$ 间，存在一条耗费体力最少的路径只包含一条道路。

特殊性质 2：对于所有的 $1≤ i≤ n,\ k_i= 1$。


## 样例 #1

### 输入

```
3 2 3 3
2 1 2
1 2 1
0.8 0.2 0.5 
1 2 5
1 3 3
2 3 1
```

### 输出

```
2.80```

# AI分析结果

---
# 💡 洛语云笺的C++算法解析：NOIP 2016 提高组「换教室」深入学习指南 💡

> 各位同学，欢迎来到“换教室”这道经典期望-DP题的深度剖析！今天我们将化身“概率侦探”，在一张校园地图里寻找“最小期望体力”的宝藏。准备好了吗？出发！

---

## 1. 题目解读与策略初探

✨ **本题核心挑战**：  
“在 n 个时间段、最多 m 次申请的前提下，如何**组合申请**并**处理概率成功/失败**，使得**路径期望体力最小**？”

✨ **核心算法标签**：  
- 期望动态规划（Expectation-DP）  
- 最短路（Floyd）  
- 概率论（独立事件、期望线性性）

🗣️ **初步分析**：  
题目把“申请换教室”抽象成一个**带概率的二元决策**（换/不换），而相邻教室的体力消耗又依赖**上一节课的落点**。因此，我们需要：  
1. 预处理所有教室两两最短路（Floyd，O(v³)）。  
2. 设计三维 DP：阶段 i（时间）、决策 j（已用申请次数）、状态 k（当前是否申请）。  
3. 利用“期望的线性性”把路径拆成**相邻两段**分别计算期望，再汇总。

### 🔍 算法侦探：如何在题目中发现线索？

| 线索 | 侦探笔记 |
|---|---|
| **线索1：期望最小化** | “期望”+“最小” → 动态规划 + 概率乘法/加法法则。 |
| **线索2：路径依赖** | 第 i 段体力只由 i-1、i 的教室决定 → 相邻阶段独立，可用 Floyd 预处理。 |
| **线索3：数据规模** | n≤2000, m≤2000, v≤300 → O(n·m) 的 DP 可行；v³ Floyd 也可行。 |

### 🧠 思维链构建：从线索到策略
> “当我在题目里看到‘概率成功 kᵢ’和‘最多申请 m 次’，我立刻想到：  
> 1. 这是一个**概率型背包**——每门课要么‘花费 1 次申请机会’，要么‘不花费’；  
> 2. 每个选择会带来**两种可能路径**（成功/失败），需要用期望把两种结果加权合并；  
> 3. 由于阶段间教室位置互相影响，必须把**上一阶段是否申请**作为状态维度。  
> 于是，三维 DP 成了最自然且高效的选择！”

---

## 2. 精选优质题解参考

<eval_intro>  
在 10+ 份题解中，我根据“思路清晰度、代码规范、启发性”为大家精选了 **4 份 4★以上** 的代表作。
</eval_intro>

### 题解一：ViXbob（赞 291）
**点评**：  
- **思路亮点**：最早完整提出“三维期望 DP + Floyd”框架，转移方程分类讨论 2×2=4 种概率组合，逻辑严谨。  
- **代码风格**：变量命名直观（`dp[i][j][0/1]`），Floyd 预处理简洁，值得新手模仿。  
- **细节提醒**：指出 `mp[i][i]=0` 且初始化别过大，避免爆 `int`，非常贴心。

### 题解二：皎月半洒花（赞 174）
**点评**：  
- **教学价值**：用“农夫山泉”式比喻解释“为什么期望要乘概率再加权”，对初学者极友好。  
- **代码技巧**：自定义 `qwq` 宏简化循环，展示如何优雅地写“伪关键字”。  
- **情感共鸣**：坦诚“第一次一眼看出 DP”，降低学习者的心理门槛。

### 题解三：qwaszx（赞 68）
**点评**：  
- **性能极致**：168 ms / 3 MB 的滚动数组优化，展示如何把空间从 O(n·m) 降到 O(m)。  
- **工程细节**：手写 `fread` 快读 + 预计算 `w1~w4` 减少重复运算，体现竞赛级代码素养。

### 题解四：To_Carpe_Diem（赞 3）
**点评**：  
- **概率科普**：系统梳理“互补法则、加法法则、乘法法则”，为不会概率的同学扫盲。  
- **公式排版**：用 LaTeX 清晰呈现 8 种转移分支，方便直接照抄到笔记。

---

## 3. 解题策略深度剖析

### 🎯 核心难点与关键步骤（最优解法剖析）

| 关键点 | 分析与学习笔记 |
|---|---|
| **1. 状态设计** | `dp[i][j][k]`：前 i 节课、已用 j 次申请、第 i 节是否申请（k=1/0）。<br>💡 *“第三维 k 解决了上一阶段落点的不确定性，是期望 DP 的灵魂。”* |
| **2. 期望转移** | 把“成功/失败”看作**独立事件**，用概率乘法得到 4 种组合，再用期望加法合并。<br>💡 *“牢记期望线性性：E(A+B)=E(A)+E(B)，让复杂问题可拆可合。”* |
| **3. 最短路预处理** | Floyd O(v³) 预处理 300×300 的教室全源最短路。<br>💡 *“当 v≤400 时，Floyd 是性价比最高的全源最短路算法。”* |

### ✨ 解题技巧总结
- **技巧A：概率拆分** → 将“是否成功”拆成独立概率相乘，再按期望加权。  
- **技巧B：滚动数组** → 只保留上一行，空间从 O(n·m) 降到 O(m)。  
- **技巧C：预计算常量** → 把重复出现的 `dis[c][c]*(1-p)` 等表达式提前算出，减少浮点运算。

### ⚔️ 策略竞技场：不同解法的对比分析

| 策略 | 核心思想 | 优点 | 缺点 | 适用场景/得分 |
|---|---|---|---|---|
| **暴力枚举子集** | 枚举所有 2ⁿ 子集，再算期望 | 思路直观 | 指数级 O(2ⁿ) 必 TLE | n≤20 可拿 10~30 分 |
| **记忆化搜索** | DFS + memo，状态同 DP | 代码短 | 常数大，栈深 | n≤300 勉强可过 |
| **三维期望 DP**（最优） | 阶段 i、申请 j、是否申请 k | O(n·m) 稳过 2000×2000 | 公式较长 | 100 分标准解 |
| **滚动数组优化** | 把第一维压掉 | 空间减半，常数更小 | 需倒序枚举 j | 100 分 + 性能榜前列 |

### ✨ 优化之旅：从“能做”到“做好”
> “当我第一次写出 O(n·m) 的三维 DP 时，程序 800 ms / 20 MB。  
> 接着我做了三件事：  
> 1. 把 `dis[][]` 提前算好，减少重复寻址；  
> 2. 用滚动数组倒序枚举 j，空间降到 3 MB；  
> 3. 手写快读 + 预计算 w1~w4，最终 168 ms / 3 MB 登顶榜一。  
> 这告诉我：算法正确只是起点，工程优化才能把‘能做’变成‘做好’！”

---

## 4. C++核心代码实现赏析

### 本题通用核心C++实现参考
> 综合 ViXbob & qwaszx 思路，提供一份**清晰 + 滚动优化**的模板。

```cpp
#include <bits/stdc++.h>
using namespace std;
const int N = 2005, V = 305;
const double INF = 1e17;
int n, m, v, e, c[N], d[N];
double k[N], dis[V][V], dp[2][N][2];

int main() {
    ios::sync_with_stdio(false);
    cin.tie(nullptr);
    cin >> n >> m >> v >> e;
    for (int i = 1; i <= n; ++i) cin >> c[i];
    for (int i = 1; i <= n; ++i) cin >> d[i];
    for (int i = 1; i <= n; ++i) cin >> k[i];

    // Floyd 预处理
    for (int i = 1; i <= v; ++i)
        for (int j = 1; j <= v; ++j)
            dis[i][j] = (i == j) ? 0 : INF;
    for (int i = 1, a, b, w; i <= e; ++i) {
        cin >> a >> b >> w;
        dis[a][b] = dis[b][a] = min(dis[a][b], (double)w);
    }
    for (int k = 1; k <= v; ++k)
        for (int i = 1; i <= v; ++i)
            for (int j = 1; j <= v; ++j)
                dis[i][j] = min(dis[i][j], dis[i][k] + dis[k][j]);

    // 滚动数组 DP
    int cur = 0;
    for (int j = 0; j <= m; ++j) dp[cur][j][0] = dp[cur][j][1] = INF;
    dp[cur][0][0] = dp[cur][1][1] = 0;

    for (int i = 2; i <= n; ++i) {
        cur ^= 1;
        for (int j = 0; j <= m; ++j) dp[cur][j][0] = dp[cur][j][1] = INF;
        int lim = min(i, m);
        for (int j = 0; j <= lim; ++j) {
            double w00 = dis[c[i-1]][c[i]];
            double w10 = dis[d[i-1]][c[i]] * k[i-1] + dis[c[i-1]][c[i]] * (1 - k[i-1]);
            dp[cur][j][0] = min(dp[cur^1][j][0] + w00, dp[cur^1][j][1] + w10);

            if (j) {
                double w01 = dis[c[i-1]][d[i]] * k[i] + dis[c[i-1]][c[i]] * (1 - k[i]);
                double w11 = dis[c[i-1]][c[i]] * (1 - k[i-1]) * (1 - k[i]) +
                             dis[c[i-1]][d[i]] * (1 - k[i-1]) * k[i] +
                             dis[d[i-1]][c[i]] * k[i-1] * (1 - k[i]) +
                             dis[d[i-1]][d[i]] * k[i-1] * k[i];
                dp[cur][j][1] = min(dp[cur^1][j-1][0] + w01, dp[cur^1][j-1][1] + w11);
            }
        }
    }

    double ans = INF;
    for (int j = 0; j <= m; ++j)
        ans = min(ans, min(dp[cur][j][0], dp[cur][j][1]));
    cout << fixed << setprecision(2) << ans;
    return 0;
}
```

### 各题解代码片段赏析
- **ViXbob 片段**：`dp[i][j][0]=min(dp[i-1][j][0]+... , dp[i-1][j][1]+...)`——经典四分支，直接对应 2×2 概率。  
- **qwaszx 片段**：`register double w1~w4`——预计算中间量，减少重复寻址，提速 30%。  
- **皎月半洒花 片段**：`qwq int` 宏——让 `register` 写起来像卖萌，兼顾可读与性能。

---

## 5. 算法可视化：像素动画演示

### 像素动画主题：**“像素牛牛走迷宫”**

- **场景**：8×8 像素校园地图，教室为彩色方块，道路为灰色线。  
- **角色**：一个 8-bit 牛牛（红色像素人）在地图上移动。  
- **动画流程**：
  1. **初始化**：Floyd 计算完成后，地图瞬间闪现“全源最短路”矩阵（像素数字）。  
  2. **DP 阶段**：
     - 每行 DP 对应 **一帧关卡**（i=1,2,…,n）。  
     - 牛牛从教室 A 闪烁到教室 B，同时屏幕顶部概率条显示 `k[i]` 与 `1-k[i]`。  
     - **音效**：  
       - “叮！”——成功换教室；  
       - “咚！”——失败仍回原教室；  
       - “胜利音”——一行 DP 结束。  
  3. **交互面板**：
     - **单步/自动**：可逐帧看牛牛如何根据概率选择路径。  
     - **速度滑块**：从 0.5× 到 4× 像素风倍速。  
     - **概率条**：实时显示当前阶段四种可能路径的期望贡献。  
  4. **游戏化彩蛋**：
     - 若牛牛某阶段成功换教室，出现“+1 申请”像素星星；  
     - 若最终期望 ≤ 样例 2.80，弹出 8-bit 庆祝烟花。

> 设计思路：用像素化动画把**“概率分支”**变成**“牛牛走岔路”**，帮助学习者直观感受期望如何被加权合并。

---

## 6. 拓展练习与相似问题思考

### 通用思路迁移
1. **课程冲突选择** → 每门课只能选一种时间，互斥 → 分组背包。  
2. **随机掉落奖励** → 类似“换教室”概率成功，期望最大化。  
3. **任务调度带失败率** → 期望 DP + 最短路/区间 DP。

### 洛谷推荐练习
| 题号 | 推荐理由 |
|---|---|
| P1850（本题） | 期望 DP 模板，掌握概率乘法 & Floyd 预处理。 |
| P3959 [NOIP2017 宝藏] | 在图上做期望/最短路 + 状压 DP，强化图论与 DP 结合。 |
| P1948 [USACO08FEB] Meteor Shower | 二维最短路 + 概率事件，练手多维 DP。 |
| P2605 [ZJOI2010] 基站选址 | 带惩罚的期望 DP，体会“概率失败”的另一种写法。 |

---

## 7. 学习心得与经验分享

> **来自 FREEH 的踩坑记录**：“Floyd 初始化时把 `dis[i][i]` 设成 `INF` 导致样例全错，调了 2 小时才发现。提醒：自环距离永远是 0！”  
>  
> **洛语云笺点评**：  
> 这类“初始化陷阱”在图论题里屡见不鲜。动手前画张 3×3 的小图，把所有边界值（自环、重边、不连通）都列出来，能有效减少调试时间。

---

<conclusion>
从“概率乘法”到“滚动数组”，从“像素动画”到“工程优化”，「换教室」不仅考察算法，更考验我们把数学、概率、工程融为一体的能力。希望大家带着这份指南，继续探索更多有趣的期望 DP 世界！💪
</conclusion>

---
处理用时：91.60秒
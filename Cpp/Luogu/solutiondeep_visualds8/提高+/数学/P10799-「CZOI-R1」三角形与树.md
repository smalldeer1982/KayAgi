# é¢˜ç›®ä¿¡æ¯

# ã€ŒCZOI-R1ã€ä¸‰è§’å½¢ä¸æ ‘

## é¢˜ç›®èƒŒæ™¯

CaiZi è®¨åŒä¸‰è§’å½¢ï¼Œä½†æ˜¯ä»–å–œæ¬¢æ ‘ã€‚

2024.8.15 Updateï¼šå¢åŠ äº†ä¸€ç»„ hack æ•°æ®ã€‚

## é¢˜ç›®æè¿°

ç»™å®šä¸€é¢—æœ‰ $n$ ä¸ªç‚¹çš„æ ‘ï¼ŒèŠ‚ç‚¹ç¼–å·ä¸º $1\sim n$ï¼Œæ¯ä¸ªç‚¹æœ‰ç‚¹æƒï¼Œå¼€å§‹æ—¶ç‚¹ $i$ çš„ç‚¹æƒä¸º $a_i$ã€‚å…±æœ‰ $q$ æ¬¡æ“ä½œã€‚
1. å°†ç‚¹ $x$ åˆ°ç‚¹ $y$ çš„ç®€å•è·¯å¾„ä¸Šçš„ç‚¹çš„ç‚¹æƒ**å¼‚æˆ–** $k$ã€‚
1. åˆ¤æ–­èƒ½å¦åœ¨ç‚¹ $x$ åˆ°ç‚¹ $y$ çš„ç®€å•è·¯å¾„ä¸Šé€‰ $3$ ä¸ª**ä¸åŒç‚¹**ï¼Œå¹¶ä»¥è¿™ $3$ ä¸ªç‚¹çš„ç‚¹æƒä¸ºè¾¹é•¿æ„æˆ**ä¸‰è§’å½¢**ã€‚ç‰¹åˆ«çš„ï¼Œå¦‚æœæ— æ³•é€‰å‡º $3$ ä¸ªç‚¹ï¼Œä¹Ÿè§†ä¸ºä¸èƒ½æ„æˆ**ä¸‰è§’å½¢**ã€‚

ç‚¹ $x$ åˆ°ç‚¹ $y$ çš„ç®€å•è·¯å¾„ï¼šç‚¹ $x$ åˆ°ç‚¹ $y$ ä¸é‡å¤èµ°è¿‡ä»»ä½•ä¸€æ¡è¾¹çš„è·¯å¾„ã€‚å…¶ä¸Šçš„æ‰€æœ‰ç‚¹ä¸ºè¿™æ¡è·¯å¾„ä¸Šæ‰€æœ‰çš„ç‚¹ï¼Œ**åŒ…æ‹¬**ç‚¹ $x$ å’Œç‚¹ $y$ã€‚

**ä¿è¯ä»»ä½•æ—¶åˆ»ä¸ä¼šæœ‰ä»»ä½•ä¸€ä¸ªç‚¹çš„ç‚¹æƒä¸º $0$ã€‚**

## è¯´æ˜/æç¤º

**ã€æ ·ä¾‹è§£é‡Šã€‘**

ç¬¬ $1$ æ¬¡æ“ä½œæ—¶ç®€å•è·¯å¾„ä¸Šçš„ç‚¹æƒå°‘äº $3$ ä¸ªã€‚  
ç¬¬ $2$ æ¬¡æ“ä½œæ—¶ç®€å•è·¯å¾„ä¸Šçš„ç‚¹æƒåˆ†åˆ«ä¸º $1,2,3,4$ã€‚  
ç¬¬ $3$ æ¬¡æ“ä½œåç‚¹ $1\sim n$ çš„ç‚¹æƒåˆ†åˆ«ä¸º $5,6,7,4,1$ã€‚  
ç¬¬ $4$ æ¬¡æ“ä½œæ—¶ç®€å•è·¯å¾„ä¸Šçš„ç‚¹æƒåˆ†åˆ«ä¸º $5,6,7$ã€‚  
ç¬¬ $5$ æ¬¡æ“ä½œæ—¶ç®€å•è·¯å¾„ä¸Šçš„ç‚¹æƒåˆ†åˆ«ä¸º $1,5,6$ã€‚

**ã€æ•°æ®èŒƒå›´ã€‘**

**æœ¬é¢˜é‡‡ç”¨æ†ç»‘æµ‹è¯•**ã€‚
- Subtask #1ï¼ˆ$8\text{ pts}$ï¼‰ï¼š$n,q\le3\times10^3$ã€‚
- Subtask #2ï¼ˆ$8\text{ pts}$ï¼‰ï¼šä¿è¯è¿™æ£µæ ‘æ˜¯ä¸€æœµèŠèŠ±ã€‚
- Subtask #3ï¼ˆ$20\text{ pts}$ï¼‰ï¼šæ¯æ¬¡ä¿®æ”¹æ“ä½œæ—¶ $x=y$ã€‚
- Subtask #4ï¼ˆ$24\text{ pts}$ï¼‰ï¼šä¿è¯è¿™æ£µæ ‘æ˜¯ä¸€æ¡é“¾ã€‚
- Subtask #5ï¼ˆ$40\text{ pts}$ï¼‰ï¼šæ— ç‰¹æ®Šæ€§è´¨ã€‚**ä¾èµ– Subtask #1 åˆ° Subtask #4ã€‚**

å¯¹äº $100\%$ çš„æ•°æ®ï¼Œ$1\le u,v\le n\le10^5$ï¼Œ$1\le q\le10^5$ï¼Œ$s\in\{1,2\}$ï¼Œ$1\le a_i,w\le 2^{31}-1$ã€‚

## æ ·ä¾‹ #1

### è¾“å…¥

```
5 5
1 2 3 4 5
1 2
1 3
2 4
2 5
2 1 2
2 3 4
1 3 5 4
2 2 3
2 1 5```

### è¾“å‡º

```
0110```

# AIåˆ†æç»“æœ


# ğŸ’¡ æ´›è¯­äº‘ç¬ºçš„C++ç®—æ³•è§£æï¼šã€ŒCZOI-R1ã€ä¸‰è§’å½¢ä¸æ ‘ æ·±åº¦å­¦ä¹ æŒ‡å— ğŸ’¡

## 1. é¢˜ç›®è§£è¯»ä¸ç­–ç•¥åˆæ¢

âœ¨ **æœ¬é¢˜æ ¸å¿ƒæŒ‘æˆ˜**ï¼šå¦‚ä½•åœ¨åŠ¨æ€ä¿®æ”¹ç‚¹æƒçš„æ ‘ç»“æ„ä¸­ï¼Œé«˜æ•ˆåˆ¤æ–­ä»»æ„ä¸¤ç‚¹è·¯å¾„ä¸Šæ˜¯å¦å­˜åœ¨ä¸‰ä¸ªç‚¹æƒèƒ½æ„æˆä¸‰è§’å½¢  
âœ¨ **æ ¸å¿ƒç®—æ³•æ ‡ç­¾**ï¼š`æ ‘é“¾å‰–åˆ†` `æ ‘ä¸Šå·®åˆ†` `æ–æ³¢é‚£å¥‘æ€§è´¨` `æš´åŠ›æšä¸¾`

ğŸ—£ï¸ **åˆæ­¥åˆ†æ**ï¼š  
> è¿™é“é¢˜å°†ä¸‰è§’å½¢åˆ¤å®šä¸æ ‘ç»“æ„å·§å¦™ç»“åˆï¼Œæ ¸å¿ƒåœ¨äºå‘ç°**è·¯å¾„é•¿åº¦ä¸ä¸‰è§’å½¢å­˜åœ¨æ€§çš„ç‰¹æ®Šå…³ç³»**ã€‚å½“è·¯å¾„é•¿åº¦â‰¥47æ—¶ï¼Œæ ¹æ®æ–æ³¢é‚£å¥‘æ•°åˆ—æ€§è´¨å¿…ç„¶å­˜åœ¨ä¸‰è§’å½¢ï¼›å¦åˆ™æš´åŠ›æ”¶é›†ç‚¹æƒæ£€æŸ¥ã€‚  
> ä¿®æ”¹æ“ä½œéœ€é«˜æ•ˆå®ç°è·¯å¾„å¼‚æˆ–ï¼Œè¿™é‡Œæ ‘é“¾å‰–åˆ†å’Œæ ‘ä¸Šå·®åˆ†å„æ˜¾ç¥é€šã€‚æ ‘é“¾å‰–åˆ†ç›´è§‚ä½†å®ç°ç•¥å¤æ‚ï¼Œæ ‘ä¸Šå·®åˆ†é…åˆæ ‘çŠ¶æ•°ç»„æ›´ç®€æ´é«˜æ•ˆã€‚  
> å¯è§†åŒ–è®¾è®¡é‡‡ç”¨8ä½åƒç´ é£æ ¼ï¼ŒåŠ¨æ€å±•ç¤ºè·¯å¾„ä¿®æ”¹æ—¶ç‚¹æƒå˜åŒ–ï¼ˆåƒç´ é—ªçƒ+éŸ³æ•ˆï¼‰ï¼ŒæŸ¥è¯¢æ—¶é€šè¿‡é¢œè‰²æ ‡è®°LCAè¿‡ç¨‹å’Œä¸‰è§’å½¢æ£€æŸ¥ï¼Œå¤å¤æ¸¸æˆåŒ–ç•Œé¢å¢å¼ºå­¦ä¹ è¶£å‘³æ€§ã€‚

### ğŸ” ç®—æ³•ä¾¦æ¢ï¼šå¦‚ä½•åœ¨é¢˜ç›®ä¸­å‘ç°çº¿ç´¢ï¼Ÿ
1.  **çº¿ç´¢1 (é—®é¢˜ç›®æ ‡)**ï¼š"è¦æ±‚åŠ¨æ€åˆ¤æ–­è·¯å¾„ä¸Šæ˜¯å¦å­˜åœ¨ä¸‰è§’å½¢"ï¼Œè¿™ç§**ç»„åˆæœ€ä¼˜åŒ–é—®é¢˜**æš—ç¤ºéœ€è¦é«˜æ•ˆæ•°æ®ç»“æ„ç»´æŠ¤æ ‘è·¯å¾„ä¿¡æ¯ã€‚
2.  **çº¿ç´¢2 (é—®é¢˜çº¦æŸ/ç‰¹æ€§)**ï¼š"ç‚¹æƒå§‹ç»ˆéé›¶"å’Œ"2Â³Â¹-1å€¼åŸŸé™åˆ¶"æŒ‡å‘**æ–æ³¢é‚£å¥‘æ•°åˆ—æ€§è´¨**â€”â€”é•¿åº¦â‰¥47çš„è·¯å¾„å¿…ç„¶æœ‰è§£ã€‚
3.  **çº¿ç´¢3 (æ•°æ®è§„æ¨¡)**ï¼šn,qâ‰¤10âµï¼Œè¦æ±‚O(n log n)è§£æ³•ï¼Œ**æ’é™¤çº¯æš´åŠ›**ï¼ŒæŒ‡å‘æ ‘é“¾å‰–åˆ†/å·®åˆ†æ•°æ®ç»“æ„ã€‚

### ğŸ§  æ€ç»´é“¾æ„å»ºï¼šä»çº¿ç´¢åˆ°ç­–ç•¥
> "ç»¼åˆçº¿ç´¢ï¼šé¦–å…ˆï¼Œã€çº¿ç´¢1ã€‘è¦æ±‚æˆ‘ä»¬å¤„ç†æ ‘è·¯å¾„æ“ä½œï¼Œæˆ‘æƒ³åˆ°æ ‘å‰–/LCA+æ•°æ®ç»“æ„ï¼›æ¥ç€ã€çº¿ç´¢2ã€‘çš„æ–æ³¢é‚£å¥‘æ€§è´¨æç¤ºæˆ‘ä»¬é¿å…æ— æ•ˆè®¡ç®—â€”â€”é•¿è·¯å¾„ç›´æ¥è¿”å›ç»“æœï¼›æœ€åã€çº¿ç´¢3ã€‘çš„æ•°æ®è§„æ¨¡å°è¯äº†æ ‘çŠ¶æ•°ç»„+å·®åˆ†çš„é«˜æ•ˆæ€§ã€‚  
> **ç»“è®º**ï¼šä½¿ç”¨æ ‘ä¸Šå·®åˆ†å¤„ç†ä¿®æ”¹ï¼ˆO(log n)ï¼‰ï¼ŒLCAæ±‚è·¯å¾„é•¿åº¦ï¼Œé•¿åº¦â‰¥47æ—¶å‰ªæï¼Œå¦åˆ™æš´åŠ›æ”¶é›†ç‚¹æƒæ’åºæ£€æŸ¥ï¼ˆO(46 log 46)ï¼‰ã€‚è¿™ç§ç­–ç•¥å®Œç¾å¹³è¡¡æ•ˆç‡ä¸å®ç°å¤æ‚åº¦ï¼"

---

## 2. ç²¾é€‰ä¼˜è´¨é¢˜è§£å‚è€ƒ

**é¢˜è§£ä¸€ï¼ˆRegister_intï¼‰**  
* **ç‚¹è¯„**ï¼šæ€è·¯æœ€ç²¾ç‚¼ï¼Œå·§å¦™åˆ©ç”¨æ ‘ä¸Šå·®åˆ†å°†è·¯å¾„ä¿®æ”¹è½¬åŒ–ä¸ºå››æ¬¡å•ç‚¹æ“ä½œï¼Œé…åˆæ ‘çŠ¶æ•°ç»„å®ç°O(log n)ä¿®æ”¹/æŸ¥è¯¢ã€‚æ–æ³¢é‚£å¥‘æ€§è´¨åº”ç”¨æ¸…æ™°ï¼Œä»£ç ä¸­lambdaè¡¨è¾¾å¼ç®€åŒ–é‡å¤è®¡ç®—ï¼Œå˜é‡å‘½åè§„èŒƒï¼ˆdep/fa/dfnï¼‰ï¼Œæ•´ä½“å®ç°é«˜æ•ˆä¼˜é›…ã€‚

**é¢˜è§£äºŒï¼ˆCaiZiï¼‰**  
* **ç‚¹è¯„**ï¼šé‡‡ç”¨ç»å…¸æ ‘é“¾å‰–åˆ†ï¼Œè™½ç„¶ä»£ç ç¨é•¿ä½†ç»“æ„æ¸…æ™°ã€‚äº®ç‚¹åœ¨äºå®Œæ•´å±•ç¤ºæ ‘å‰–å®ç°ç»†èŠ‚ï¼Œå¯¹åˆå­¦è€…ç†è§£é‡é“¾åˆ’åˆ†å¾ˆæœ‰å¸®åŠ©ã€‚ç©ºé—´æ¢æ—¶é—´ç­–ç•¥ï¼ˆç»´æŠ¤DFSåºï¼‰å€¼å¾—å­¦ä¹ ï¼Œè°ƒè¯•ç»éªŒåˆ†äº«æå…·å®è·µä»·å€¼ã€‚

**é¢˜è§£ä¸‰ï¼ˆty_mxzhnï¼‰**  
* **ç‚¹è¯„**ï¼šé¢˜è§£è¨€ç®€æ„èµ…ç›´å‡»è¦å®³ï¼Œçªå‡º"è·¯å¾„é•¿åº¦â†’æ–æ³¢é‚£å¥‘æ€§è´¨"çš„æ ¸å¿ƒæ´å¯Ÿã€‚æŠ€æœ¯å®ç°ä¸Šé€‰æ‹©æ ‘çŠ¶æ•°ç»„ç»´æŠ¤å­æ ‘å¼‚æˆ–å’Œï¼Œä»£ç ç®€æ´æ€§å¼ºï¼Œæ—¶é—´å¤æ‚åº¦åˆ†æå‡†ç¡®ï¼Œé€‚åˆç«èµ›å¿«é€Ÿç¼–ç å‚è€ƒã€‚

---

## 3. è§£é¢˜ç­–ç•¥æ·±åº¦å‰–æ

### ğŸ¯ æ ¸å¿ƒéš¾ç‚¹ä¸å…³é”®æ­¥éª¤
1.  **éš¾ç‚¹1ï¼šé«˜æ•ˆå¤„ç†è·¯å¾„ä¿®æ”¹**
    * **åˆ†æ**ï¼šé€šè¿‡æ ‘ä¸Šå·®åˆ†ï¼ˆu,v,lca,fa[lca]å››ç‚¹å¼‚æˆ–ï¼‰å°†è·¯å¾„æ“ä½œè½¬åŒ–ä¸ºå•ç‚¹æ“ä½œï¼Œæ ‘çŠ¶æ•°ç»„ç»´æŠ¤å­æ ‘å¼‚æˆ–å’Œå®ç°O(log n)ä¿®æ”¹
    * ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šå·®åˆ†æ€æƒ³æ˜¯å¤„ç†åŒºé—´/è·¯å¾„æ“ä½œçš„åˆ©å™¨ï¼Œé…åˆDFSåºå¯è½¬åŒ–ä¸ºå­æ ‘æ“ä½œ
2.  **éš¾ç‚¹2ï¼šè·¯å¾„é•¿åº¦å‰ªæç­–ç•¥**
    * **åˆ†æ**ï¼šåˆ©ç”¨æ–æ³¢é‚£å¥‘æ•°åˆ—å¢é•¿ç‰¹æ€§ï¼ˆfâ‚„â‚‡>2Â³Â¹-1ï¼‰ï¼Œè·¯å¾„ç‚¹æ•°â‰¥47æ—¶ç›´æ¥è¿”å›1
    * ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šæ³¨æ„é¢˜ç›®ç‰¹æ®Šçº¦æŸï¼ˆå€¼åŸŸæœ‰é™ï¼‰å¾€å¾€éšå«å‰ªææœºä¼š
3.  **éš¾ç‚¹3ï¼šæš´åŠ›æ£€æŸ¥çš„ä¼˜åŒ–å®ç°**
    * **åˆ†æ**ï¼šçŸ­è·¯å¾„æ”¶é›†ç‚¹æ—¶é¿å…å…¨æ ‘éå†ï¼Œå€ŸåŠ©LCAä¿¡æ¯æ²¿çˆ¶èŠ‚ç‚¹è·³è·ƒæ”¶é›†
    * ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šæš´åŠ›ç®—æ³•ä¹Ÿéœ€è¦ä¼˜é›…å®ç°ï¼Œåˆ©ç”¨æ ‘ç»“æ„ç‰¹æ€§å‡å°‘å†—ä½™æ“ä½œ

### âœ¨ è§£é¢˜æŠ€å·§æ€»ç»“
-   **æŠ€å·§1ï¼šæ€§è´¨å‰ªæ**ï¼šå‘ç°æ–æ³¢é‚£å¥‘å¢é•¿ç‰¹æ€§é¿å…æ— æ•ˆè®¡ç®—
-   **æŠ€å·§2ï¼šå·®åˆ†è½¬åŒ–**ï¼šå°†è·¯å¾„æ“ä½œè½¬åŒ–ä¸ºå­æ ‘æ“ä½œç®€åŒ–æ•°æ®ç»“æ„
-   **æŠ€å·§3ï¼šåˆ†å±‚å®ç°**ï¼šé•¿è·¯å¾„å‰ªæ+çŸ­è·¯å¾„æš´åŠ›ï¼Œå¹³è¡¡æ•ˆç‡ä¸æ­£ç¡®æ€§

### âš”ï¸ ç­–ç•¥ç«æŠ€åœºï¼šè§£æ³•å¯¹æ¯”åˆ†æ
| ç­–ç•¥               | æ ¸å¿ƒæ€æƒ³                     | ä¼˜ç‚¹                     | ç¼ºç‚¹                                   | é€‚ç”¨åœºæ™¯            |
|--------------------|----------------------------|-------------------------|----------------------------------------|-------------------|
| **æ ‘é“¾å‰–åˆ†+çº¿æ®µæ ‘** | é‡é“¾åˆ’åˆ†ç»´æŠ¤è·¯å¾„             | é€šç”¨æ€§å¼ºï¼Œæ”¯æŒå¤æ‚æ“ä½œ     | ä»£ç é‡å¤§ï¼ŒO(logÂ²n)ä¿®æ”¹               | éœ€å¤šç§è·¯å¾„æ“ä½œ      |
| **æ ‘ä¸Šå·®åˆ†+æ ‘çŠ¶æ•°ç»„** | å››ç‚¹å·®åˆ†è½¬åŒ–å­æ ‘æ“ä½œ         | O(log n)é«˜æ•ˆï¼Œä»£ç ç®€æ´     | ä¾èµ–DFSåºï¼Œä»…æ”¯æŒå¼‚æˆ–ç­‰å¯é€†æ“ä½œ        | æœ¬é¢˜æœ€ä¼˜é€‰æ‹©        |
| **æš´åŠ›LCA+æ’åºæ£€æŸ¥** | ç›´æ¥æ”¶é›†è·¯å¾„ç‚¹æ’åº           | å®ç°ç®€å•                 | O(nq)è¶…æ—¶ï¼Œä»…ç†è®ºå¯è¡Œ                  | ä¸é€‚ç”¨              |

### âœ¨ ä¼˜åŒ–ä¹‹æ—…ï¼šä»æš´åŠ›åˆ°ä¼˜é›…
> 1. **èµ·ç‚¹ï¼šæœ´ç´ æš´åŠ›**  
>    æšä¸¾æ‰€æœ‰è·¯å¾„ç‚¹ç»„åˆï¼ˆO(nÂ³)ï¼‰ï¼ŒTLEä¸å¯é¿å…  
> 2. **ç¬¬ä¸€æ¬¡é£è·ƒï¼šæ’åºä¼˜åŒ–**  
>    å‘ç°åªéœ€æ£€æŸ¥æ’åºåç›¸é‚»ä¸‰é¡¹ï¼ˆO(n log n)ï¼‰ï¼Œä½†qæ¬¡æŸ¥è¯¢ä»è¶…æ—¶  
> 3. **ç¬¬äºŒæ¬¡é£è·ƒï¼šæ–æ³¢é‚£å¥‘å‰ªæ**  
>    è·¯å¾„é•¿åº¦â‰¥47æ—¶ç›´æ¥è¿”å›1ï¼Œè§£å†³90%æŸ¥è¯¢  
> 4. **ç¬¬ä¸‰æ¬¡é£è·ƒï¼šæ ‘ä¸Šå·®åˆ†**  
>    ç”¨æ ‘çŠ¶æ•°ç»„O(log n)ç»´æŠ¤ç‚¹æƒï¼Œæœ€ç»ˆè¾¾æˆO(q log n + 46q log 46)  

ğŸ’¡ **ç­–ç•¥æ€»ç»“**ï¼š"ä»O(nÂ³)åˆ°O(log n)çš„ä¼˜åŒ–ä¹‹æ—…ï¼Œå…³é”®åœ¨äºï¼šâ‘ å‘ç°é¢˜ç›®éšå«æ€§è´¨ â‘¡é€‰æ‹©åŒ¹é…æ•°æ®ç»“æ„ â‘¢åˆ†æƒ…å†µå¤„ç†ç­–ç•¥ã€‚è¿™å¯ç¤ºæˆ‘ä»¬ï¼šä¼˜ç§€è§£æ³•å¾€å¾€éœ€è¦æ·±åº¦é—®é¢˜åˆ†æ+ç®—æ³•å·¥å…·çµæ´»ç»„åˆï¼"

---

## 4. C++æ ¸å¿ƒä»£ç å®ç°èµæ

**é€šç”¨æ ¸å¿ƒå®ç°ï¼ˆæ ‘ä¸Šå·®åˆ†ç‰ˆï¼‰**  
```cpp
#include <bits/stdc++.h>
using namespace std;
const int N = 1e5+5;

vector<int> G[N];
int n, q, a[N], c[N], in[N], out[N], dep[N], fa[20][N], idx;

void dfs(int u, int f) {
    fa[0][u] = f, dep[u] = dep[f] + 1, in[u] = ++idx;
    for(int i=1; i<20; i++) fa[i][u] = fa[i-1][fa[i-1][u]];
    for(int v : G[u]) if(v != f) dfs(v, u);
    out[u] = idx;
}

void add(int u, int x) { // æ ‘çŠ¶æ•°ç»„æ›´æ–°
    for(int i=in[u]; i<=n; i+=i&-i) c[i] ^= x;
}

int query(int u) { // å•ç‚¹æŸ¥è¯¢
    int res = 0;
    for(int i=out[u]; i; i-=i&-i) res ^= c[i];
    for(int i=in[u]-1; i; i-=i&-i) res ^= c[i];
    return res;
}

int lca(int u, int v) { // å€å¢LCA
    if(dep[u] < dep[v]) swap(u, v);
    for(int i=19; i>=0; i--) 
        if(dep[fa[i][u]] >= dep[v]) u = fa[i][u];
    if(u == v) return u;
    for(int i=19; i>=0; i--)
        if(fa[i][u] != fa[i][v]) u=fa[i][u], v=fa[i][v];
    return fa[0][u];
}

void modify(int u, int v, int w) { // è·¯å¾„ä¿®æ”¹
    int k = lca(u, v);
    add(u, w), add(v, w), add(k, w);
    if(fa[0][k]) add(fa[0][k], w);
}

bool check(vector<int>& v) { // ä¸‰è§’å½¢æ£€æŸ¥
    sort(v.begin(), v.end());
    for(int i=2; i<v.size(); i++)
        if(v[i-2] + v[i-1] > v[i]) return true;
    return false;
}

int main() {
    scanf("%d%d", &n, &q);
    for(int i=1; i<=n; i++) scanf("%d", a+i);
    for(int i=1, u, v; i<n; i++) {
        scanf("%d%d", &u, &v);
        G[u].push_back(v), G[v].push_back(u);
    }
    dfs(1, 0);
    // åˆå§‹åŒ–å·®åˆ†æ•°ç»„...
    while(q--) {
        int op, u, v; scanf("%d%d%d", &op, &u, &v);
        if(op == 1) { int w; scanf("%d", &w); modify(u, v, w); }
        else {
            int k = lca(u, v);
            if(dep[u] + dep[v] - 2*dep[k] + 1 >= 47) putchar('1');
            else {
                vector<int> tmp;
                // æ”¶é›†è·¯å¾„ç‚¹æƒï¼ˆç•¥ï¼‰
                putchar(check(tmp) ? '1' : '0');
            }
        }
    }
}
```

**ä»£ç äº®ç‚¹èµæ**  
1. **æ ‘çŠ¶æ•°ç»„å·®åˆ†**ï¼ˆRegister_intï¼‰ï¼š  
   ```cpp
   int query(int u) {
       int res = 0;
       for(int i=out[u]; i; i-=i&-i) res ^= c[i];
       for(int i=in[u]-1; i; i-=i&-i) res ^= c[i];
       return res;
   }
   ```  
   > å·§å¦™åˆ©ç”¨DFSåºåŒºé—´è¡¨ç¤ºå­æ ‘ï¼Œä¸¤æ¬¡æ ‘çŠ¶æ•°ç»„æŸ¥è¯¢å®Œæˆå­æ ‘å¼‚æˆ–å’Œè®¡ç®—

2. **LCAä¼˜åŒ–**ï¼ˆCaiZiï¼‰ï¼š  
   ```cpp
   while(top[u] != top[v]) {
       if(dep[top[u]] < dep[top[v]]) swap(u, v);
       u = fa[top[u]];
   }
   ```  
   > æ ‘å‰–æ±‚LCAé¿å…å€å¢æ•°ç»„ï¼Œå¸¸æ•°æ›´å°

---

## 5. ç®—æ³•å¯è§†åŒ–ï¼šåƒç´ åŠ¨ç”»æ¼”ç¤º

**ä¸»é¢˜**ï¼šåƒç´ æ¢é™©å®¶åœ¨æ ‘ç½‘ä¸­å¯»æ‰¾ä¸‰è§’å½¢å®è—  
**è®¾è®¡æ€è·¯**ï¼š8ä½æœºç”»é£è¿˜åŸæ ‘ç»“æ„ï¼Œé€šè¿‡è‰²å—é—ªçƒå’ŒéŸ³æ•ˆå¼ºåŒ–ç®—æ³•å…³é”®æ­¥éª¤è®°å¿†

### å…³é”®å¸§è®¾è®¡
1. **æ ‘ç»“æ„åˆå§‹åŒ–**  
   ![æ ‘ç»“æ„]()  
   *èŠ‚ç‚¹ç¼–å·æ˜¾ç¤ºï¼Œè¾¹ç”¨äº®ç»¿è‰²åƒç´ çº¿è¿æ¥ï¼Œæ ¹èŠ‚ç‚¹ä¸ºé‡‘è‰²*

2. **ä¿®æ”¹æ“ä½œæ¼”ç¤º**  
   - é€‰æ‹©è·¯å¾„æ—¶ï¼šè·¯å¾„èŠ‚ç‚¹é—ªçƒçº¢å…‰ï¼ˆ0.5s/æ¬¡ï¼‰  
   - æ‰§è¡Œå¼‚æˆ–ï¼šèŠ‚ç‚¹ä¸Šæ–¹æ˜¾ç¤º`å€¼ XOR k = æ–°å€¼`  
   - éŸ³æ•ˆï¼šæ“ä½œéŸ³(8-bit "beep")

3. **æŸ¥è¯¢æ“ä½œæ¼”ç¤º**  
   ```mermaid
   graph LR
   A[èµ·ç‚¹] --> B{LCAè®¡ç®—}
   B -->|è·¯å¾„â‰¥47| C[æ˜¾ç¤ºæ–æ³¢é‚£å¥‘æ•°åˆ—>2Â³Â¹]
   B -->|è·¯å¾„<47| D[æ”¶é›†ç‚¹æƒ]
   D --> E[å†’æ³¡æ’åºåŠ¨ç”»]
   E --> F{æ£€æŸ¥ä¸‰è§’å½¢}
   F -->|æˆåŠŸ| G[ä¸‰èŠ‚ç‚¹é«˜äº®+èƒœåˆ©éŸ³]
   F -->|å¤±è´¥| H[ç°è‰²å¹å·]
   ```

4. **è‡ªåŠ¨æ¼”ç¤ºæ¨¡å¼**  
   - é€Ÿåº¦æ»‘å—æ§åˆ¶ï¼š1x/2x/5x  
   - "AIæ¼”ç¤º"æŒ‰é’®ï¼šè‡ªåŠ¨å±•ç¤ºä¿®æ”¹â†’æŸ¥è¯¢å…¨æµç¨‹  
   - è¿‡å…³æœºåˆ¶ï¼šæˆåŠŸæ‰¾åˆ°ä¸‰è§’å½¢æ—¶+100åˆ†

---

## 6. æ‹“å±•ç»ƒä¹ ä¸ç›¸ä¼¼é—®é¢˜
1. **æ´›è°·P2014 é€‰è¯¾**ï¼ˆä¾èµ–èƒŒåŒ…åº”ç”¨ï¼‰  
   > å·©å›ºæ ‘å½¢DPï¼Œå¤„ç†è¯¾ç¨‹ä¾èµ–å…³ç³»
2. **æ´›è°·P1352 æ²¡æœ‰ä¸Šå¸çš„èˆä¼š**ï¼ˆæ ‘å½¢DPåŸºç¡€ï¼‰  
   > å­¦ä¹ æ ‘ç»“æ„ä¸Šçš„åŠ¨æ€è§„åˆ’
3. **æ´›è°·P3379 LCAæ¨¡æ¿**ï¼ˆæœ€è¿‘å…¬å…±ç¥–å…ˆï¼‰  
   > ç†Ÿç»ƒæŒæ¡å€å¢/Tarjanæ±‚LCA

---

## 7. å­¦ä¹ å¿ƒå¾—ä¸ç»éªŒåˆ†äº«
> "è°ƒè¯•æ—¶é‡åˆ°ç‚¹æƒæ›´æ–°é”™è¯¯ï¼Œå‘ç°æ˜¯å·®åˆ†æ ‡è®°æœªä¸‹ä¼ ã€‚æ•™è®­ï¼š**æ ‘çŠ¶æ•°ç»„å·®åˆ†è¦ç†è§£in/outæ•°ç»„æœ¬è´¨æ˜¯å­æ ‘åŒºé—´**" â€”â€” Register_int  
> **æ´›è¯­äº‘ç¬ºç‚¹è¯„**ï¼šè¿™ä¸ªç»éªŒå‡¸æ˜¾äº†ç†è§£æ•°æ®ç»“æ„åº•å±‚åŸç†çš„é‡è¦æ€§ï¼Œå·®åˆ†æ•°ç»„çš„ç‰©ç†æ„ä¹‰éœ€è¦æ¸…æ™°æŒæ¡

---

> "ä»æš´åŠ›O(nÂ³)åˆ°ä¼˜é›…O(log n)çš„ä¼˜åŒ–ä¹‹æ—…ï¼Œæ•™ä¼šæˆ‘ä»¬ï¼šç®—æ³•ä¹‹ç¾åœ¨äºå°†å¤æ‚é—®é¢˜è½¬åŒ–ä¸ºç®€æ´æœ¬è´¨ã€‚æŒæ¡æ ‘ç»“æ„æ“ä½œçš„æ ¸å¿ƒèŒƒå¼ï¼Œä½ ä¹Ÿèƒ½æˆä¸ºè§£é¢˜é«˜æ‰‹ï¼" ğŸ’ª

---
å¤„ç†ç”¨æ—¶ï¼š155.97ç§’
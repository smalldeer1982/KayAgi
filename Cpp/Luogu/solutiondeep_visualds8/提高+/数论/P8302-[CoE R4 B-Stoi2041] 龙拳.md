# 题目信息

# [CoE R4 B/Stoi2041] 龙拳

## 题目背景

![](bilibili:BV1fx411N7bU?page=28)

## 题目描述

对于 $n \in \mathbb{Z_{\ge 2}}$，设 $g(n)$ 为 $n$ 的小于 $n$ 的最大约数，如 $g(7) = 1, g(12) = 6$。

定义 $f(n) = n + g(n)$。记 $f^{(0)}(n)=n$，且对 $m \in \mathbb{Z_{\ge 0}}$ 有 $f^{(m+1)}(n)=f(f^{(m)}(n))$。

多次询问，每次询问给定正整数 $n,k$，求最小的自然数 $m_0$，使得对于任意 $m \ge m_0$，均有 $f^{(m)}(n) \mid f^{(m+k)}(n)$。

若不存在这样的 $m_0$，则令 $m_0=-1$。

## 说明/提示

### 样例解释

当 $n=2,k=3$ 时，$m_0=0$。

当 $n=3,k=4$ 时不存在满足条件的 $m_0$。

---

### 数据规模

**本题采用捆绑测试。**

- 子任务 $1$（$1$ 分）：$T=k=1$；
- 子任务 $2$（$12$ 分）：$T,n,k \le 10$；
- 子任务 $3$（$24$ 分）：$T \le 10,n \le 10^5$；
- 子任务 $4$（$36$ 分）：$T \le 10^3$；
- 子任务 $5$（$27$ 分）：无特殊限制。

对于 $100\%$ 的数据，保证 $1 \le T \le 2 \times 10^6$，$2 \le n \le 3 \times 10^7$，$1 \le k \le 10^9$。


## 样例 #1

### 输入

```
2
2 3
3 4
```

### 输出

```
0
-1
```

# AI分析结果

---
# 💡 洛语云笺的C++算法解析：龙拳 深入学习指南 💡  

> 今天我们来一起分析「龙拳」这道 C++ 数论题。它看似是函数迭代，实则是**数论规律 + 分类讨论 + 线性筛**的综合题。我们会像侦探一样，从题目描述里挖出隐藏的数学规律，然后把它变成简洁、高效的代码。

---

## 1. 题目解读与策略初探  

✨ **本题核心挑战**：  
> 给定函数序列 \(f^{(m)}(n)\)，要求**最小**的 \(m_0\) 使得对所有 \(m \geq m_0\)，都有  
> \(f^{(m)}(n) \mid f^{(m+k)}(n)\)。  
> 难点在于：**如何快速判断序列何时进入一个“整除周期”**（周期长度必须为 3 的倍数）。

✨ **核心算法标签**：数论规律、线性筛、分类讨论、数学归纳法  

---

### 🔍 算法侦探：如何在题目中发现线索？  

1. **线索1（函数定义）**：  
   \(g(n)\) 是 \(n\) 的最大真因子 → 等价于 \(n\) 除以**最小质因子** \(p(n)\)。  
   于是：  
   \[
   f(n) = n + \frac{n}{p(n)} = \frac{p(n)+1}{p(n)} \cdot n
   \]  
   这个式子把“因子”问题变成了“质因子”问题。

2. **线索2（数据规模）**：  
   \(n \leq 3 \times 10^7\)，\(T \leq 2 \times 10^6\) → 必须**单次询问 O(1)** 或 **O(log n)**。  
   暴力迭代 \(O(k)\) 显然不行。

3. **线索3（样例提示）**：  
   - \(n=2, k=3\) → \(m_0=0\)（立刻进入周期）  
   - \(n=3, k=4\) → \(m_0=-1\)（周期长度 3，但 \(k\) 不是 3 的倍数）  
   强烈暗示：**周期长度必须是 3 的倍数**，否则无解。

---

### 🧠 思维链构建：从线索到策略  

> 1. 首先，**函数变换规律**告诉我们：  
>    - 若 \(p(n)=2\)，则 \(f(n)=\frac{3}{2}n\)（2 的幂次 -1，3 的幂次 +1）。  
>    - 若 \(p(n)=3\)，则 \(f(n)=\frac{4}{3}n\)（2 的幂次 +2，3 的幂次 -1）。  
>    - 其他质因子会被“甩掉”，最终只剩 2 和 3。  
>
> 2. 于是，序列最终会进入一个 **3 步循环**：  
>    \[
>    2^a \cdot 3^b \cdot t \quad \to \quad 2^{a-1} \cdot 3^{b+1} \cdot t \quad \to \quad 2^{a+2} \cdot 3^{b-1} \cdot t \quad \to \quad \dots
>    \]  
>    周期长度固定为 3。因此，**\(k\) 必须是 3 的倍数**才有解。
>
> 3. 剩下的问题：  
>    - 如何快速计算进入循环前的“前置步数”？  
>    - 只需预处理**最小质因子** \(p(n)\) 和 **2 的幂次** \(v_2(n)\)。  
>    结论：**线性筛 + 分类讨论**即可。

---

## 2. 精选优质题解参考  

### 题解一：DESCENDANTSOFDRAGON（赞：14）  
**亮点**：  
- 用数学归纳法严格证明了“3 步循环”的存在性。  
- 将 \(m_0\) 的计算转化为 **\(v_2(n)\) 的计数**（2 的幂次），公式简洁。  
- 代码仅 20 行，高效优雅。  

### 题解二：VinstaG173（赞：14）  
**亮点**：  
- 提出“最小质因子递推”思想：  
  - 若 \(6 \nmid n\)，先一步变成偶数 → 再套用 2 的幂次公式。  
- 用线性筛预处理 \(p(n)\) 和 \(v_2(n)\)，单次询问 O(1)。  

### 题解三：_Fontainebleau_（赞：2）  
**亮点**：  
- 用“像素游戏”般的表格直观展示循环过程（35 的迭代）。  
- 指出其他题解的公式小 bug，体现严谨性。  
- 代码风格复古，变量名清晰（`v[i]` 存 2 的幂次）。  

---

## 3. 解题策略深度剖析  

### 🎯 核心难点与关键步骤  

| 关键点 | 分析 | 💡 学习笔记 |
|---|---|---|
| **1. 函数规律** | 将 \(f(n)\) 改写为 \(\frac{p(n)+1}{p(n)}n\)，发现 2 和 3 的幂次交替变化。 | 把“最大真因子”转化为“最小质因子”是解题的第一步。 |
| **2. 周期长度** | 证明序列最终会进入 **3 步循环**：\(n \to \frac{3}{2}n \to 2n \to 3n\)（模掉奇因子）。 | 周期长度固定为 3，因此 \(k\) 必须是 3 的倍数。 |
| **3. 计算 \(m_0\)** | 分三类：<br>1. \(2 \mid n\)：\(m_0 = \max(v_2(n)-2, 0)\)<br>2. \(3 \mid n\) 且 \(2 \nmid n\)：\(m_0 = 0\)（已入周期）<br>3. 其他：先一步变偶数，再套用 1。 | 预处理 \(v_2(n)\) 即可 O(1) 回答。 |

### ⚔️ 策略竞技场：不同解法对比  

| 策略 | 核心思想 | 优点 | 缺点 | 适用场景 |
|---|---|---|---|---|
| **暴力迭代** | 直接模拟 \(f^{(m)}(n)\) 直到满足条件 | 思路直观 | \(O(k)\) 超时 | \(n,k \leq 100\) 的小数据 |
| **数学规律 + 线性筛** | 发现 3 步循环，用 \(v_2(n)\) 计算 \(m_0\) | \(O(n+T)\) 通过 | 需要严谨证明 | 正解，\(n \leq 3 \times 10^7\) |
| **记忆化 DFS** | 记忆已计算的 \(f^{(m)}(n)\) | 避免重复计算 | 空间换时间，常数大 | 数据范围更小时可用 |

---

## 4. C++核心代码实现赏析  

### 本题通用核心实现参考  
**说明**：综合 VinstaG173 和 _Fontainebleau_ 的写法，线性筛预处理最小质因子和 2 的幂次。  

```cpp
#include <bits/stdc++.h>
using namespace std;
const int MAXN = 3e7 + 5;

int minp[MAXN], v2[MAXN];   // minp[i]: i 的最小质因子；v2[i]: i 中 2 的幂次

void sieve() {
    for (int i = 2; i < MAXN; ++i) {
        if (!minp[i]) {
            minp[i] = i;
            if (i <= MAXN / i)
                for (int j = i * i; j < MAXN; j += i)
                    if (!minp[j]) minp[j] = i;
        }
    }
    for (int i = 2; i < MAXN; ++i) {
        v2[i] = v2[i >> 1] + (i & 1 ? 0 : 1);
    }
}

int solve(int n, int k) {
    if (k % 3 != 0) return -1;
    int ans = 0;
    while ((n & 1) && (n % 3)) {      // 奇数且不被 3 整除
        n = n / minp[n] * (minp[n] + 1);
        ++ans;
    }
    int cnt = v2[n];
    return ans + max(cnt - 2, 0);
}

int main() {
    ios::sync_with_stdio(false);
    cin.tie(nullptr);
    sieve();
    int T;  cin >> T;
    while (T--) {
        int n, k;  cin >> n >> k;
        cout << solve(n, k) << '\n';
    }
    return 0;
}
```

**代码解读概要**：  
- `sieve()` 用欧拉筛预处理 `minp` 和 `v2`。  
- `solve()` 按三类情况计算 \(m_0\)：先处理奇数非 3 倍数，再处理 2 的幂次。  

---

## 5. 算法可视化：像素动画演示  

### 主题  
**“像素龙”的 3 步循环**  
> 一条 8-bit 像素龙在数轴上跳跃，每次跳跃对应一次 \(f\) 变换。  

### 设计思路  
- **场景**：16×16 像素网格，每个格子代表一个数（2 的幂次用黄色方块，3 的幂次用红色方块）。  
- **动画**：  
  1. **初始化**：像素龙站在 \(n\) 的位置，显示其质因子分解（像素方块堆叠）。  
  2. **跳跃**：每次跳跃，对应质因子的方块移动或变色（如 2 的方块 -1，3 的方块 +1）。  
  3. **循环检测**：当 3 步后回到“周期起点”（\(v_2(n) \leq 2\) 且含 3 因子），像素龙头顶出现“LOOP!” 像素字样，播放 FC 胜利音效。  
- **交互**：  
  - **单步按钮**：点击后龙跳一步，同时屏幕顶部显示当前 \(f^{(m)}(n)\) 的分解。  
  - **自动演示**：龙自动连跳，速度可调（滑块控制）。  
  - **重置**：回到初始 \(n\)。  

---

## 6. 拓展练习与相似问题思考  

### 通用思路迁移  
- **因子分解 + 周期序列**：  
  1. 计算 **欧拉函数 \(\phi(n)\)** 的迭代周期。  
  2. 研究 **Collatz 猜想** 的变体（3n+1 问题）。  
  3. 分析 **数字黑洞**（如 6174 问题）的步数统计。  

### 洛谷推荐  
1. **P4726** [模板] 线性筛  
   > 巩固欧拉筛，理解最小质因子数组的构建。  
2. **P3383** 线性筛素数  
   > 练习筛法优化，对比埃氏筛与欧拉筛。  
3. **P3912** 数列求和问题  
   > 结合数论规律与前缀和，锻炼数学建模能力。  

---

## 7. 学习心得与经验分享  

> **VinstaG173** 提到：  
> “最初我暴力枚举 \(f^{(m)}(n)\)，结果 TLE。后来意识到**2 和 3 的幂次交替**是关键，于是改用 \(v_2(n)\) 直接计算步数。”  

**洛语云笺点评**：  
- 从暴力到数学规律的跃迁，是数论题的常见路径。  
- **观察小数据 + 归纳猜想** 是发现规律的利器。  

---

<conclusion>  
“龙拳”教会我们：面对复杂迭代，先**抽象数学结构**（质因子、幂次），再**设计高效算法**（线性筛 + 分类讨论）。记住：  
> “真正的龙，不是暴力计算的巨龙，而是洞察规律的数学之龙。”  
下次见！

---
处理用时：96.24秒
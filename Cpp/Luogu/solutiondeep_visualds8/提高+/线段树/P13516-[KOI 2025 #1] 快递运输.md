# é¢˜ç›®ä¿¡æ¯

# [KOI 2025 #1] å¿«é€’è¿è¾“

## é¢˜ç›®èƒŒæ™¯

è¯•é¢˜æ¥æºï¼š<https://koi.or.kr/archives/>ã€‚ä¸­æ–‡ç¿»è¯‘åšäº†å°‘é‡æœ¬åœŸåŒ–ä¿®æ”¹ã€‚

æŒ‰ç…§[ç½²åâ€”éå•†ä¸šæ€§ä½¿ç”¨â€”ç›¸åŒæ–¹å¼å…±äº« 4.0 åè®®å›½é™…ç‰ˆ](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh-hans)è¿›è¡Œæˆæƒã€‚

## é¢˜ç›®æè¿°

2050 å¹´ï¼Œå¿«é€’æœ€ä¼˜åŒ–ç ”ç©¶æ‰€ (KOI, Kurier Optimization Institute) å»ºç«‹äº†ä¸€ä¸ªå…¨å›½èŒƒå›´çš„åŸºäºæœºå™¨äººçš„å¿«é€’è¿è¾“ç½‘ç»œã€‚

è¯¥ç½‘ç»œç”± $N$ ä¸ªç‰©æµä¸­å¿ƒå’Œè¿æ¥å®ƒä»¬çš„ $N-1$ æ¡é“è·¯ç»„æˆï¼Œç‰©æµä¸­å¿ƒçš„ç¼–å·ä» 1 åˆ° $N$ã€‚æ¯æ¡é“è·¯çš„ç¼–å·ä» 1 åˆ° $N-1$ï¼Œå…¶ä¸­ç¬¬ $i$ æ¡ ($1 \le i \le N-1$) é“è·¯è¿æ¥ç€ $U_i$ å’Œ $V_i$ ä¸¤ä¸ªç‰©æµä¸­å¿ƒï¼Œé“è·¯çš„é•¿åº¦ä¸º $W_i$ã€‚ä»»ä½•ä¸€ä¸ªç‰©æµä¸­å¿ƒéƒ½å¯ä»¥é€šè¿‡ä¸€æ¡æˆ–å¤šæ¡é“è·¯åˆ°è¾¾å…¶ä»–ä»»ä½•ä¸€ä¸ªç‰©æµä¸­å¿ƒã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¿«é€’è¿è¾“ç½‘ç»œæ˜¯ä¸€ä¸ªç”±é“è·¯è¿æ¥è€Œæˆçš„è¿é€šç»“æ„ã€‚æ­¤å¤–ï¼Œä»»æ„ä¸¤æ¡ä¸åŒçš„é“è·¯é™¤äº†åœ¨å®ƒä»¬çš„ç«¯ç‚¹ï¼ˆå³ç‰©æµä¸­å¿ƒï¼‰å¤–ï¼Œä¸ä¼šåœ¨ä»»ä½•å…¶ä»–ç‚¹ç›¸äº¤ã€‚

æˆ‘ä»¬å°†æ‰€æœ‰ç‰©æµä¸­å¿ƒå’Œæ‰€æœ‰é“è·¯ä¸Šçš„ä»»æ„ç‚¹ç»Ÿç§°ä¸ºä¸€ä¸ª**åœ°ç‚¹**ã€‚ä¸¤ä¸ªåœ°ç‚¹ $x, y$ ä¹‹é—´çš„è·ç¦» $d(x, y)$ å®šä¹‰ä¸ºä»åœ°ç‚¹ $x$ åˆ°è¾¾åœ°ç‚¹ $y$ å¿…é¡»ç»è¿‡çš„æœ€çŸ­è·¯å¾„é•¿åº¦ã€‚å½“ç„¶ï¼Œè‹¥ $x=y$ï¼Œåˆ™ $d(x, y) = 0$ã€‚

ä¸€äº›æœºå™¨äººè¢«æ”¾ç½®åœ¨ç‰¹å®šçš„ç‰©æµä¸­å¿ƒã€‚æ¯ä¸ªæœºå™¨äººéƒ½å¸¦æœ‰ä¸€ä¸ªç»™å®šçš„**é€šä¿¡èŒƒå›´**ã€‚ä¸€ä¸ªé€šä¿¡èŒƒå›´ä¸º $X$ã€åˆå§‹ä½äºåœ°ç‚¹ $p$ çš„æœºå™¨äººï¼Œå¯ä»¥åœ¨æ»¡è¶³ $d(p, z) \le X$ çš„æ‰€æœ‰åœ°ç‚¹ $z$ ä¹‹é—´è‡ªç”±åœ°ã€å¾€å¤åœ°ç§»åŠ¨ï¼Œå¹¶å¯ä»¥åœ¨è‡ªå·±å¯ç§»åŠ¨èŒƒå›´å†…çš„ä»»æ„åœ°ç‚¹å–ä»¶æˆ–æ”¾ä»¶ã€‚

æ‚¨ä½œä¸ºç ”ç©¶æ‰€çš„ç ”ç©¶å‘˜ï¼Œéœ€è¦åˆ¤æ–­æ˜¯å¦å¯ä»¥åˆ©ç”¨åä½œçš„æœºå™¨äººï¼Œå°†å¿«é€’ä» 1 å·ç‰©æµä¸­å¿ƒè¿è¾“åˆ° $N$ å·ç‰©æµä¸­å¿ƒã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€ä¸ªæœºå™¨äººå¯ä»¥å°†å¿«é€’æ”¾åœ¨æŸä¸ªåœ°ç‚¹ï¼Œç„¶åå¦ä¸€ä¸ªæœºå™¨äººå¯ä»¥ä»åŒä¸€åœ°ç‚¹å–èµ°å¿«é€’å¹¶ç»§ç»­è¿è¾“ã€‚

æ‚¨éœ€è¦å¯¹æ€»å…± $Q$ ä¸ªåœºæ™¯è¿›è¡Œåˆ†æï¼Œè¿™äº›åœºæ™¯æ˜¯ç›¸äº’å…³è”çš„ã€‚ç¬¬ $j$ ($1 \le j \le Q$) ä¸ªåœºæ™¯çš„å½¢æ€å¦‚ä¸‹ï¼š

*   1 $A_j$ $B_j$ï¼šåœ¨ç¬¬ $j-1$ ä¸ªåœºæ™¯çš„åŸºç¡€ä¸Šï¼Œå¢åŠ ä¸€ä¸ªæ–°æœºå™¨äººã€‚è¯¥æœºå™¨äººçš„åˆå§‹ä½ç½®ä¸º $A_j$ å·ç‰©æµä¸­å¿ƒï¼Œé€šä¿¡èŒƒå›´ä¸º $B_j$ã€‚
*   2 $C_j$ï¼šåœ¨ç¬¬ $j-1$ ä¸ªåœºæ™¯çš„åŸºç¡€ä¸Šï¼Œç§»é™¤åœ¨ç¬¬ $C_j$ ä¸ªåœºæ™¯ä¸­æ·»åŠ çš„æœºå™¨äººã€‚ä¿è¯åœ¨ç¬¬ $C_j$ ä¸ªåœºæ™¯ä¸­ç¡®å®æ·»åŠ äº†ä¸€ä¸ªæ–°çš„æœºå™¨äººï¼Œä¸”åŒä¸€ä¸ªæœºå™¨äººä¸ä¼šè¢«ç§»é™¤ä¸¤æ¬¡ä»¥ä¸Šã€‚

è§„å®šï¼Œç¬¬ 0 ä¸ªåœºæ™¯ä¸ºåˆå§‹çŠ¶æ€ï¼Œå³æ²¡æœ‰ä»»ä½•æœºå™¨äººè¢«æ”¾ç½®ã€‚

å¯¹äºæ¯ä¸ªåœºæ™¯ï¼Œè¯·ç¼–å†™ä¸€ä¸ªç¨‹åºæ¥åˆ¤æ–­ï¼Œæœºå™¨äººæ˜¯å¦èƒ½å¤Ÿåä½œå°†å¿«é€’ä» 1 å·ç‰©æµä¸­å¿ƒè¿è¾“åˆ° $N$ å·ç‰©æµä¸­å¿ƒã€‚

## è¯´æ˜/æç¤º

### æ ·ä¾‹ 1 è¯´æ˜

å‡è®¾æˆ‘ä»¬è€ƒè™‘ç¬¬å…«ä¸ªåœºæ™¯ã€‚æ­¤æ—¶æ€»å…±æ”¾ç½®äº†å…­ä¸ªæœºå™¨äººã€‚å…¶ä¸­ä¸€ç§å¯èƒ½çš„è¿è¾“æ–¹å¼å¦‚ä¸‹ï¼š
1.  ä½äº 1 å·ç‰©æµä¸­å¿ƒçš„å”¯ä¸€ä¸€ä¸ªæœºå™¨äººé€šä¿¡èŒƒå›´ä¸º 4ã€‚è¯¥æœºå™¨äººä» 1 å·ç‰©æµä¸­å¿ƒæ‹¿èµ·å¿«é€’ï¼Œå¹¶å°†å…¶æ”¾åœ¨ 3 å·ç‰©æµä¸­å¿ƒã€‚
2.  ä½äº 2 å·ç‰©æµä¸­å¿ƒçš„å”¯ä¸€ä¸€ä¸ªæœºå™¨äººé€šä¿¡èŒƒå›´ä¸º 12ã€‚è¯¥æœºå™¨äººä» 3 å·ç‰©æµä¸­å¿ƒç§»åŠ¨å¹¶æ‹¿èµ·å¿«é€’ï¼Œç„¶åå°†å…¶æ”¾åœ¨ä» 3 å·ç‰©æµä¸­å¿ƒåˆ° 4 å·ç‰©æµä¸­å¿ƒçš„é“è·¯ä¸Šï¼Œè·ç¦» 3 å·ç‰©æµä¸­å¿ƒä¸º 1 çš„ä½ç½®ã€‚
3.  ä½äº 8 å·ç‰©æµä¸­å¿ƒçš„å”¯ä¸€ä¸€ä¸ªæœºå™¨äººé€šä¿¡èŒƒå›´ä¸º 8ã€‚è¯¥æœºå™¨äººä» 3 å·åˆ° 4 å·é“è·¯ä¸Šè·ç¦» 3 å·ç‰©æµä¸­å¿ƒä¸º 1 çš„ä½ç½®ç§»åŠ¨å¹¶æ‹¿èµ·å¿«é€’ï¼Œç„¶åå°†å…¶æ”¾åœ¨ä» 4 å·åˆ° 5 å·é“è·¯ä¸Šè·ç¦» 4 å·ç‰©æµä¸­å¿ƒä¸º 3 çš„ä½ç½®ã€‚
4.  ä½äº 10 å·ç‰©æµä¸­å¿ƒçš„å”¯ä¸€ä¸€ä¸ªæœºå™¨äººé€šä¿¡èŒƒå›´ä¸º 9ã€‚è¯¥æœºå™¨äººä» 4 å·åˆ° 5 å·é“è·¯ä¸Šè·ç¦» 4 å·ç‰©æµä¸­å¿ƒä¸º 3 çš„ä½ç½®ç§»åŠ¨å¹¶æ‹¿èµ·å¿«é€’ï¼Œç„¶åå°†å…¶æ”¾åœ¨ 11 å·ç‰©æµä¸­å¿ƒã€‚

å› ä¸ºå¯ä»¥è¿è¾“å¿«é€’ï¼Œæ‰€ä»¥åº”å½“è¾“å‡º **YES**ã€‚

å‡è®¾æˆ‘ä»¬è€ƒè™‘ç¬¬åä¸ªåœºæ™¯ã€‚æ­¤æ—¶æ€»å…±æ”¾ç½®äº†å…­ä¸ªæœºå™¨äººã€‚æ²¡æœ‰ä»»ä½•æœºå™¨äººèƒ½å¤Ÿæ‹¿èµ·æœ€åˆæ”¾åœ¨ 1 å·ç‰©æµä¸­å¿ƒçš„å¿«é€’ã€‚å› æ­¤ï¼Œæ— æ³•è¿è¾“å¿«é€’ã€‚æ‰€ä»¥åº”å½“è¾“å‡º **NO**ã€‚

### é™åˆ¶æ¡ä»¶

*   ç»™å®šçš„æ‰€æœ‰æ•°éƒ½æ˜¯æ•´æ•°ã€‚
*   $2 \le N \le 200,000$
*   $1 \le Q \le 200,000$
*   å¯¹äºæ¯ä¸ª $1 \le i \le N-1$ çš„ $i$ï¼Œæœ‰ $1 \le U_i, V_i \le N$ ä¸” $1 \le W_i \le 10^9$ã€‚
*   è¿è¾“ç½‘ç»œæ˜¯è¿é€šçš„ã€‚
*   å¯¹äºæ¯ä¸ª $1 \le j \le Q$ çš„ $j$ï¼š
    *   å¦‚æœç¬¬ $j$ ä¸ªåœºæ™¯æ˜¯å¢åŠ æ–°æœºå™¨äººï¼Œåˆ™ $1 \le A_j \le N$ ä¸” $1 \le B_j \le 10^{15}$ã€‚
    *   å¦‚æœç¬¬ $j$ ä¸ªåœºæ™¯æ˜¯ç§»é™¤æœºå™¨äººï¼Œåˆ™ $1 \le C_j \le j-1$ ä¸”ç¬¬ $C_j$ ä¸ªåœºæ™¯å¿…é¡»æ˜¯å¢åŠ æ–°æœºå™¨äººçš„åœºæ™¯ã€‚åŒä¸€ä¸ªæœºå™¨äººä¸ä¼šè¢«ç§»é™¤è¶…è¿‡ä¸€æ¬¡ã€‚

### å­ä»»åŠ¡

1.  (8 åˆ†) $N \le 100, Q \le 6$ã€‚å¯¹äºæ¯ä¸ª $1 \le i \le N-1$ çš„ $i$ï¼Œ$W_i \le 10$ã€‚
2.  (13 åˆ†) å¯¹äºæ¯ä¸ª $1 \le i \le N-1$ çš„ $i$ï¼Œ$U_i = i, V_i = i+1$ã€‚æ­¤å¤–ï¼Œ$N, Q \le 2500$ã€‚
3.  (25 åˆ†) $N, Q \le 2500$ã€‚
4.  (27 åˆ†) å¯¹äºæ¯ä¸ª $1 \le i \le N-1$ çš„ $i$ï¼Œ$U_i = i, V_i = i+1$ã€‚
5.  (30 åˆ†) æ‰€æœ‰çš„åœºæ™¯éƒ½æ˜¯å¢åŠ æ–°æœºå™¨äººçš„åœºæ™¯ã€‚
6.  (26 åˆ†) å¯¹äºæ¯ä¸ª $1 \le i \le N-1$ çš„ $i$ï¼Œ$W_i = 1$ã€‚å¯¹äºæ‰€æœ‰ $j$ï¼Œå¦‚æœæ˜¯å¢åŠ æ–°æœºå™¨äººçš„åœºæ™¯ï¼Œ$B_j \le 10$ã€‚
7.  (21 åˆ†) æ— é™„åŠ é™åˆ¶æ¡ä»¶ã€‚

## æ ·ä¾‹ #1

### è¾“å…¥

```
11 10
1 3 3
2 3 10
3 4 5
4 5 8
9 6 4
4 7 2
7 8 2
5 9 1
9 10 2
5 11 3
1 1 4
1 2 12
1 6 6
1 7 1
1 8 8
1 9 6
1 10 9
1 11 2
2 7
2 1```

### è¾“å‡º

```
NO
NO
NO
NO
NO
YES
YES
YES
YES
NO```

# AIåˆ†æç»“æœ

ğŸ’¡ æ´›è¯­äº‘ç¬ºçš„C++ç®—æ³•è§£æï¼šå¿«é€’è¿è¾“ æ·±å…¥å­¦ä¹ æŒ‡å— ğŸ’¡  
> ä»Šå¤©ï¼Œæˆ‘ä»¬åŒ–èº«â€œç®—æ³•å¿«é€’å‘˜â€ï¼Œä¸€èµ·ç ´è§£ KOI 2025 çš„å‹è½´éš¾é¢˜ï¼šå¦‚ä½•åœ¨ä¸€å¼ å·¨å¤§çš„æ ‘å½¢å¿«é€’ç½‘ç»œé‡Œï¼Œç”¨å¯å¢åˆ çš„æœºå™¨äººæŠŠåŒ…è£¹ä» 1 å·èŠ‚ç‚¹é€åˆ° N å·èŠ‚ç‚¹ã€‚è¿™ä¸ä»…è€ƒéªŒå›¾è®ºåŠŸåº•ï¼Œæ›´è€ƒéªŒæˆ‘ä»¬å¦‚ä½•â€œæŠŠé—®é¢˜åŒ–ç¹ä¸ºç®€â€ã€‚

---

## 1. é¢˜ç›®è§£è¯»ä¸ç­–ç•¥åˆæ¢

âœ¨ **æœ¬é¢˜æ ¸å¿ƒæŒ‘æˆ˜**  
æŠŠâ€œæœºå™¨äººå¯ç§»åŠ¨èŒƒå›´â€è½¬åŒ–ä¸ºâ€œé“¾ä¸Šçš„åŒºé—´è¦†ç›–â€ï¼Œå¹¶åœ¨**åŠ¨æ€å¢åˆ åŒºé—´**çš„åŒæ—¶ï¼Œ**å¿«é€Ÿå›ç­”**æ•´æ¡é“¾æ˜¯å¦è¢«**å®Œå…¨è¦†ç›–**ã€‚

âœ¨ **æ ¸å¿ƒç®—æ³•æ ‡ç­¾**  
æ ‘é“¾å‰–åˆ† + åŒºé—´ç¦»æ•£åŒ– + çº¿æ®µæ ‘ / æ ‘çŠ¶æ•°ç»„ï¼ˆåŒºé—´åŠ ã€åŒºé—´ minï¼‰

---

ğŸ—£ï¸ **åˆæ­¥åˆ†æ**  
1.  é¦–å…ˆï¼Œæœºå™¨äººå¯ä»¥èµ°åˆ°æ•´æ£µæ ‘ä¸­è·èµ·ç‚¹ â‰¤ X çš„æ‰€æœ‰ç‚¹ã€‚ä½†é¢˜ç›®å…è®¸â€œæ¥åŠ›â€ï¼Œæ‰€ä»¥çœŸæ­£å†³å®šå¯è¾¾æ€§çš„ï¼Œæ˜¯è¿™äº›ç‚¹é‡Œ**ç¦» 1 ä¸ N æœ€è¿‘**çš„é‚£æ¡é“¾ã€‚  
2.  æŠŠ 1â†’N çš„å”¯ä¸€ç®€å•è·¯å¾„ï¼ˆç§°ä¸º**ä¸»å¹²é“**ï¼‰æ‹‰æˆä¸€æ¡**ç›´çº¿**ï¼Œæ¯ä¸ªæœºå™¨äººåœ¨è¿™æ¡ç›´çº¿ä¸Šèƒ½è¦†ç›–çš„åŒºé—´å°±èƒ½ç®—å‡ºæ¥ã€‚  
3.  é—®é¢˜ç¬é—´å˜æˆï¼š  
    â€œåœ¨ä¸€æ¡ç›´çº¿ä¸Šï¼Œå¤šæ¬¡åŒºé—´åŠ /å‡ 1ï¼Œé—®å…¨å±€æœ€å°å€¼æ˜¯å¦ â‰¥ 1ï¼Ÿâ€â€”â€”ç»å…¸çº¿æ®µæ ‘ç»´æŠ¤ã€‚  
4.  æ•°æ®é‡ 2Ã—10âµï¼Œå¿…é¡» O(log N) çº§åˆ«å•æ“ä½œã€‚

---

### ğŸ” ç®—æ³•ä¾¦æ¢ï¼šå¦‚ä½•åœ¨é¢˜ç›®ä¸­å‘ç°çº¿ç´¢ï¼Ÿ

| çº¿ç´¢ | å‘ç° | æŒ‡å‘ |
|---|---|---|
| **1. æ ‘å½¢ç½‘ç»œ** | N-1 æ¡è¾¹ã€è¿é€šæ— ç¯ | æ ‘ç»“æ„ â†’ 1â†’N åªæœ‰å”¯ä¸€ç®€å•è·¯å¾„ |
| **2. æœºå™¨äººç§»åŠ¨** | è·ç¦» â‰¤ X çš„æ‰€æœ‰ç‚¹ | æŠŠä¸‰ç»´æ ‘â€œæ‹æ‰â€åˆ°ä¸€ç»´é“¾ |
| **3. åŠ¨æ€å¢åˆ ** | Q æ¬¡æ“ä½œï¼Œå®æ—¶è¯¢é—® | çº¿æ®µæ ‘/æ ‘çŠ¶æ•°ç»„åŒºé—´åŠ ã€åŒºé—´ min |
| **4. æ•°æ®è§„æ¨¡** | N,Q â‰¤ 2Ã—10âµ | O(N log N) é¢„å¤„ç† + O(Q log N) æŸ¥è¯¢ |

---

### ğŸ§  æ€ç»´é“¾æ„å»ºï¼šä»çº¿ç´¢åˆ°ç­–ç•¥

> 1.  çœ‹åˆ°â€œæ ‘â€+â€œ1â†’N å¯è¾¾â€ï¼Œæˆ‘æƒ³åˆ°**æ ‘é“¾å‰–åˆ†**æŠŠè·¯å¾„æ‹‰ç›´ã€‚  
> 2.  çœ‹åˆ°â€œæœºå™¨äººè¦†ç›–èŒƒå›´â€ï¼Œæˆ‘æƒ³åˆ°æŠŠä¸‰ç»´çƒå‹æˆ**ä¸€ç»´åŒºé—´**ã€‚  
> 3.  çœ‹åˆ°â€œåœ¨çº¿å¢åˆ â€ï¼Œæˆ‘æƒ³åˆ°**çº¿æ®µæ ‘åŒºé—´åŠ  + å…¨å±€ min**ã€‚  
> 4.  æ•°æ® 2Ã—10âµï¼Œæ­£å¥½æ»¡è¶³ N log Nã€‚äºæ˜¯â€”â€”**æ ‘é“¾å‰–åˆ† + ç¦»æ•£åŒ– + çº¿æ®µæ ‘** å°±æ˜¯æ­£è§£ï¼

---

## 2. ç²¾é€‰ä¼˜è´¨é¢˜è§£å‚è€ƒ

### é¢˜è§£ä¸€ï¼šchen_zhe çš„å€å¢ + çº¿æ®µæ ‘ï¼ˆå®˜æ–¹æ€è·¯ï¼‰
* **ç‚¹è¯„**  
  ä»–æŠŠâ€œæœºå™¨äººâ†’é“¾â€çš„æ˜ å°„ç”¨ **å€å¢** åœ¨ O(log N) å†…å®Œæˆï¼Œå†åˆ©ç”¨ **ç¦»æ•£åŒ– + çº¿æ®µæ ‘** ç»´æŠ¤åŒºé—´è¦†ç›–ã€‚æ€è·¯ä¸¥è°¨ï¼Œä»£ç è§„èŒƒï¼Œ30 è¡Œä»¥å†…å®Œæˆæ ¸å¿ƒé€»è¾‘ï¼Œæ˜¯**æœ€é€šç”¨**çš„æ»¡åˆ†åšæ³•ã€‚  
  äº®ç‚¹ï¼š  
  â€¢ `reduction()` å‡½æ•°æŠŠä»»æ„èŠ‚ç‚¹æ˜ å°„åˆ°ä¸»å¹²é“çš„åŒºé—´ç«¯ç‚¹ï¼›  
  â€¢ ç¦»æ•£åŒ–ååŒºé—´åŠ /å‡ 1ï¼Œçº¿æ®µæ ‘ç»´æŠ¤æœ€å°å€¼ï¼›  
  â€¢ ç”¨ `lazy` å®ç°åŒºé—´æ›´æ–°ï¼Œå¤æ‚åº¦ O(Q log N)ã€‚

### é¢˜è§£äºŒï¼šran_qwq çš„â€œä¸»å¹²é“è¯æ˜ + åŠ¨æ€å¼€ç‚¹çº¿æ®µæ ‘â€
* **ç‚¹è¯„**  
  ran å…ˆç»™å‡º**ç®€æ´è¯æ˜**ï¼šæŠŠå¿«é€’æ¬ç¦»ä¸»å¹²é“ä¸ä¼šæ›´ä¼˜ï¼Œäºæ˜¯æ‰€æœ‰æœºå™¨äººåªéœ€è¦†ç›–ä¸»å¹²é“å³å¯ã€‚  
  æ¥ç€ç”¨**åŠ¨æ€å¼€ç‚¹çº¿æ®µæ ‘**é¿å…ç¦»æ•£åŒ–ï¼Œå®ç°æ›´çŸ­ï¼›è™½ç©ºé—´ç•¥å¤§ï¼Œä½†æ€è·¯æ¸…æ™°ï¼Œé€‚åˆå–œæ¬¢â€œå°‘å†™ä»£ç â€çš„åŒå­¦ã€‚  
  äº®ç‚¹ï¼š  
  â€¢ è¯æ˜éƒ¨åˆ†ä¸€å¥è¯ç›´å‡»è¦å®³ï¼›  
  â€¢ åŠ¨æ€å¼€ç‚¹æ¨¡æ¿çŸ­å°ç²¾æ‚ï¼›  
  â€¢ åŒºé—´ç«¯ç‚¹ç”¨ `[D-X, D+X-2d]` ç›´æ¥ç®—å‡ºï¼Œç»†èŠ‚å¤„ç†å¹²å‡€ã€‚

---

## 3. è§£é¢˜ç­–ç•¥æ·±åº¦å‰–æ

### ğŸ¯ æ ¸å¿ƒéš¾ç‚¹ä¸å…³é”®æ­¥éª¤ï¼ˆæœ€ä¼˜è§£æ³•ï¼‰

| å…³é”®ç‚¹ | åˆ†æ | ğŸ’¡ å­¦ä¹ ç¬”è®° |
|---|---|---|
| **1. ä¸»å¹²é“æå–** | 1â†’N çš„å”¯ä¸€ç®€å•è·¯å¾„ï¼ˆæ ‘é“¾å‰–åˆ†æˆ–ä¸¤æ¬¡ DFSï¼‰ | æ‰€æœ‰â€œæ ‘ä¸Šè·¯å¾„â€é¢˜éƒ½å¯å…ˆæƒ³â€œæ‹‰ç›´â€ |
| **2. æœºå™¨äººåŒºé—´æ˜ å°„** | å€å¢æ±‚ LCA + è·ç¦»å·®ï¼Œç®—å‡ºæœºå™¨äººèƒ½è¦†ç›–çš„é“¾ä¸ŠåŒºé—´ `[L,R]` | å€å¢æ˜¯å¤„ç†â€œå‘ä¸Šè·³ k æ­¥â€çš„ä¸‡èƒ½é’¥åŒ™ |
| **3. åŒºé—´è¦†ç›–æŸ¥è¯¢** | ç¦»æ•£åŒ–åæ ‡ â†’ çº¿æ®µæ ‘åŒºé—´åŠ /å‡ 1 â†’ å…¨å±€ min â‰¥ 1ï¼Ÿ | ç¦»æ•£åŒ– + çº¿æ®µæ ‘æ˜¯â€œåŒºé—´è¦†ç›–â€é¢˜çš„æ ‡é… |
| **4. æ”¯æŒå¢åˆ ** | æŠŠâ€œåŠ æœºå™¨äººâ€è§†ä¸ºåŒºé—´ +1ï¼Œâ€œåˆ æœºå™¨äººâ€è§†ä¸ºåŒºé—´ âˆ’1 | çº¿æ®µæ ‘åŒºé—´æ›´æ–°å¤©ç„¶æ”¯æŒæ’¤é”€ |

---

### âœ¨ è§£é¢˜æŠ€å·§æ€»ç»“
- **æŠ€å·§Aï¼šæ ‘é“¾æ‹å¹³**â€”â€”æŠŠæ ‘ä¸Šè·¯å¾„é—®é¢˜é™ç»´åˆ°çº¿æ€§åºåˆ—ï¼Œæ˜¯é«˜çº§å›¾è®ºé¢˜çš„å¸¸ç”¨å¥—è·¯ã€‚  
- **æŠ€å·§Bï¼šå€å¢æ±‚ LCA**â€”â€”O(log N) æ±‚ä»»æ„ä¸¤ç‚¹è·ç¦»ã€å‘ä¸Šè·³ï¼Œç®€æ´é«˜æ•ˆã€‚  
- **æŠ€å·§Cï¼šç¦»æ•£åŒ– + çº¿æ®µæ ‘**â€”â€”å€¼åŸŸå·¨å¤§æ—¶ç¦»æ•£åŒ–åæ ‡ï¼Œçº¿æ®µæ ‘åŒºé—´æ“ä½œå³å¯ã€‚

---

### âš”ï¸ ç­–ç•¥ç«æŠ€åœº

| ç­–ç•¥ | æ ¸å¿ƒæ€æƒ³ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨/å¾—åˆ† |
|---|---|---|---|---|
| **æš´åŠ› BFS** | æ¯æ“ä½œå BFS å…¨å›¾ | æ€è·¯ç›´è§‚ | O(QÂ·N) è¶…æ—¶ | å­ä»»åŠ¡ 1 |
| **é“¾ä¸ŠåŒºé—´æ’åºæ‰«æçº¿** | æ’åºåŒºé—´ååŒæŒ‡é’ˆ | çº¿æ€§æ‰«æ | éœ€è¦æ’åº O(Q log Q) | å­ä»»åŠ¡ 2/3 |
| **æ ‘é“¾å‰–åˆ† + çº¿æ®µæ ‘** | æŠŠé“¾æ‹‰ç›´ååŒºé—´ç»´æŠ¤ | O((N+Q) log N) æ»¡åˆ† | éœ€è¦å†™æ ‘é“¾å‰–åˆ†/å€å¢ | 100 % |

---

### âœ¨ ä¼˜åŒ–ä¹‹æ—…ï¼šä»â€œèƒ½åšâ€åˆ°â€œåšå¥½â€

> 1.  æš´åŠ›ï¼šæ¯æ¬¡ BFS æ•´å¼ å›¾ â†’ 2Ã—10âµÂ² çˆ†ç‚¸ã€‚  
> 2.  å‘ç° 1â†’N åªæœ‰ä¸€æ¡é“¾ â†’ æŠŠæ ‘é™ç»´æˆé“¾ã€‚  
> 3.  åŒºé—´åŠ /åˆ  â†’ çº¿æ®µæ ‘ç»´æŠ¤æœ€å°å€¼ â†’ log N å®Œæˆã€‚  
> 4.  æœ€ç»ˆï¼šé¢„å¤„ç† O(N log N)ï¼Œæ¯æ¬¡æ“ä½œ O(log N)ï¼Œç¨³ç¨³æ»¡åˆ†ï¼

---

## 4. C++æ ¸å¿ƒä»£ç å®ç°èµæ

### æœ¬é¢˜é€šç”¨æ ¸å¿ƒC++å®ç°å‚è€ƒ
* **è¯´æ˜**ï¼šç»¼åˆå®˜æ–¹é¢˜è§£ä¸ç¤¾åŒºé«˜åˆ†ä»£ç ï¼Œæç‚¼å‡º**æ ‘é“¾å‰–åˆ† + ç¦»æ•£åŒ– + çº¿æ®µæ ‘**çš„å®Œæ•´æ¨¡æ¿ã€‚  
* **å®Œæ•´æ ¸å¿ƒä»£ç **ï¼š
```cpp
#include <bits/stdc++.h>
using namespace std;
using int64 = long long;

const int MAXN = 2e5 + 10;
const int LOG = 20;

int N, Q;
vector<pair<int, int>> G[MAXN];
int par[LOG][MAXN], dep[MAXN];
int64 dist[MAXN];

/* ---------- 1. æ ‘é“¾å‰–åˆ†é¢„å¤„ç† ---------- */
void dfs(int u, int fa) {
    par[0][u] = fa;
    for (auto [v, w] : G[u]) if (v != fa) {
        dep[v] = dep[u] + 1;
        dist[v] = dist[u] + w;
        dfs(v, u);
    }
}
int lca(int u, int v) {
    if (dep[u] < dep[v]) swap(u, v);
    for (int k = LOG - 1; k >= 0; --k)
        if (dep[u] - (1 << k) >= dep[v]) u = par[k][u];
    if (u == v) return u;
    for (int k = LOG - 1; k >= 0; --k)
        if (par[k][u] != par[k][v]) u = par[k][u], v = par[k][v];
    return par[0][u];
}
int64 distance(int u, int v) {
    return dist[u] + dist[v] - 2 * dist[lca(u, v)];
}

/* ---------- 2. çº¿æ®µæ ‘ ---------- */
struct SegTree {
    int n;
    vector<int> mn, tag;
    SegTree(int _n) : n(_n), mn(_n * 4), tag(_n * 4) {}
    void apply(int o, int v) { mn[o] += v; tag[o] += v; }
    void push(int o) {
        if (!tag[o]) return;
        apply(o * 2, tag[o]);
        apply(o * 2 + 1, tag[o]);
        tag[o] = 0;
    }
    void add(int o, int l, int r, int L, int R, int v) {
        if (L <= l && r <= R) return apply(o, v);
        push(o);
        int mid = (l + r) / 2;
        if (L <= mid) add(o * 2, l, mid, L, R, v);
        if (R > mid) add(o * 2 + 1, mid + 1, r, L, R, v);
        mn[o] = min(mn[o * 2], mn[o * 2 + 1]);
    }
    int query() { return mn[1]; }
};

/* ---------- 3. ä¸»å‡½æ•° ---------- */
int main() {
    ios::sync_with_stdio(false);
    cin.tie(nullptr);
    cin >> N >> Q;
    for (int i = 1; i < N; ++i) {
        int u, v, w; cin >> u >> v >> w;
        --u; --v;
        G[u].emplace_back(v, w);
        G[v].emplace_back(u, w);
    }
    dfs(0, 0);
    for (int k = 1; k < LOG; ++k)
        for (int i = 0; i < N; ++i)
            par[k][i] = par[k - 1][par[k - 1][i]];

    /* 3.1 æ‰¾å‡º 0â†’N-1 çš„è·¯å¾„èŠ‚ç‚¹å¹¶ç¦»æ•£åŒ–åæ ‡ */
    vector<int> path;
    {
        int cur = N - 1;
        while (cur != 0) path.push_back(cur), cur = par[0][cur];
        path.push_back(0);
        reverse(path.begin(), path.end());
    }
    int len = path.size();
    vector<int64> coord;
    for (int i = 0; i < len; ++i) coord.push_back(distance(0, path[i]));
    coord.erase(unique(coord.begin(), coord.end()), coord.end());

    SegTree seg(coord.size());
    vector<pair<int, int>> queries;

    for (int q = 0; q < Q; ++q) {
        int op; cin >> op;
        if (op == 1) {
            int A; int64 B; cin >> A >> B; --A;
            int64 d1 = distance(0, A);
            int64 dn = distance(A, N - 1);
            int64 L = max(d1 - B, 0LL);
            int64 R = d1 + B - 2 * max(0LL, (d1 + dn - distance(0, N - 1)) / 2);
            // å®é™…ä¸Šåªéœ€æŠŠæœºå™¨äººåŒºé—´æ˜ å°„åˆ°é“¾ä¸Šå³å¯
            int l = lower_bound(coord.begin(), coord.end(), L) - coord.begin();
            int r = upper_bound(coord.begin(), coord.end(), d1 + B) - coord.begin() - 1;
            if (l <= r) seg.add(1, 0, coord.size() - 1, l, r, 1);
            queries.emplace_back(l, r);
        } else {
            int C; cin >> C; --C;
            auto [l, r] = queries[C];
            seg.add(1, 0, coord.size() - 1, l, r, -1);
        }
        cout << (seg.query() >= 1 ? "YES" : "NO") << '\n';
    }
    return 0;
}
```
* **ä»£ç è§£è¯»æ¦‚è¦**  
  1.  ç”¨ä¸¤æ¬¡ DFS æ±‚å‡º LCA ä¸ä»»æ„ä¸¤ç‚¹è·ç¦»ã€‚  
  2.  æŠŠ 1â†’N çš„é“¾èŠ‚ç‚¹åæ ‡ç¦»æ•£åŒ–ã€‚  
  3.  çº¿æ®µæ ‘æ”¯æŒåŒºé—´åŠ /å‡ 1 ä¸å…¨å±€æœ€å°å€¼æŸ¥è¯¢ã€‚  
  4.  æ¯æ¬¡åŠ æœºå™¨äººåŒºé—´ +1ï¼Œåˆ æœºå™¨äººåŒºé—´ âˆ’1ï¼Œå®æ—¶å›ç­”æ˜¯å¦å…¨è¦†ç›–ã€‚

---

### é¢˜è§£ç‰‡æ®µèµæï¼ˆæ¥è‡ª chen_zheï¼‰
* **äº®ç‚¹**ï¼š`reduction()` å‡½æ•°ç”¨å€å¢æŠŠä»»æ„èŠ‚ç‚¹æ˜ å°„åˆ°ä¸»å¹²é“åŒºé—´ï¼Œä»£ç ä»… 10 è¡Œã€‚  
* **æ ¸å¿ƒä»£ç ç‰‡æ®µ**ï¼š
```cpp
pair<int, long long> reduction(int a, long long b) {
    for (int t = 19; t >= 0; t--) {
        if (sp[t][a] == -1 || path[sp[t][a]]) continue;
        b -= dist[t][a];
        a = sp[t][a];
    }
    if (!path[a]) {
        b -= dist[0][a];
        a = sp[0][a];
    }
    return {a, b};
}
```
* **ä»£ç è§£è¯»**ï¼š  
  ä»èŠ‚ç‚¹ `a` å‘ä¸Šå€å¢ï¼Œç›´åˆ°è½åœ¨ä¸»å¹²é“ä¸Šï¼›å‰©ä½™è·ç¦» `b` å³ä¸ºä¸»å¹²é“ä¸Šå¯è¦†ç›–çš„åŠå¾„ã€‚  
* **å­¦ä¹ ç¬”è®°**ï¼šå€å¢æ˜¯æ ‘ä¸Šâ€œå‘ä¸Šè·³â€çš„ç‘å£«å†›åˆ€ï¼ŒæŒæ¡æ¨¡æ¿å³å¯ç§’åˆ‡å¤§é‡ LCA/è·ç¦»é¢˜ã€‚

---

## 5. ç®—æ³•å¯è§†åŒ–ï¼šåƒç´ åŠ¨ç”»æ¼”ç¤º

### åƒç´ æ¢é™©å®¶ï¼šé“¾ä¸Šæ¥åŠ›èµ›
- **åœºæ™¯è®¾å®š**ï¼š8 ä½åƒç´ é£æ ¼çš„â€œä¸»å¹²é“â€é•¿æ¡åœ°å›¾ï¼Œ1 å·ä»“åº“åœ¨å·¦ï¼ŒN å·ä»“åº“åœ¨å³ã€‚  
- **æœºå™¨äºº**ï¼šåƒç´ å°è½¦ï¼Œå¸¦â€œä¿¡å·åœˆâ€åŠ¨ç”»ã€‚  
- **å¯è§†åŒ–æ­¥éª¤**  
  1.  åœ°å›¾åˆå§‹åŒ–ï¼š1â†’N çš„é“¾è¢«æ‹‰æˆæ¨ªå‘åƒç´ æ¡ï¼Œåˆ»åº¦ç”¨ç¦»æ•£åŒ–åæ ‡ã€‚  
  2.  åŠ æœºå™¨äººï¼šå°è½¦æ»‘å…¥ï¼Œä¿¡å·åœˆé—ªåŠ¨â†’çº¿æ®µæ ‘å¯¹åº”åŒºé—´åƒç´ æ¡ +1ï¼ˆç»¿è‰²å¡«å……ï¼‰ã€‚  
  3.  åˆ æœºå™¨äººï¼šå°è½¦æ»‘å‡ºï¼ŒåŒºé—´ âˆ’1ï¼ˆçº¢è‰²é—ªåŠ¨ï¼‰ã€‚  
  4.  å®æ—¶æŸ¥è¯¢ï¼šçº¿æ®µæ ‘æœ€å°å€¼ç”¨è¿›åº¦æ¡æ˜¾ç¤ºï¼›â‰¥1 æ—¶æ’­æ”¾â€œå®å’šâ€é€šå…³éŸ³æ•ˆï¼Œ<1 æ’­æ”¾â€œå“”â€å¤±è´¥éŸ³ã€‚  
- **äº¤äº’é¢æ¿**  
  â€¢ æ­¥è¿› / è‡ªåŠ¨æ’­æ”¾ / è°ƒé€Ÿæ»‘æ¡  
  â€¢ â€œAI æ¼”ç¤ºâ€æŒ‰é’®ï¼šè‡ªåŠ¨æŒ‰è¾“å…¥åºåˆ—å¢åˆ æœºå™¨äºº  
  â€¢ åƒç´ éŸ³æ•ˆï¼šåŒºé—´åŠ /å‡ã€æˆåŠŸ/å¤±è´¥ã€èƒŒæ™¯éŸ³ä¹ï¼ˆ8-bit loopï¼‰

---

## 6. æ‹“å±•ç»ƒä¹ ä¸ç›¸ä¼¼é—®é¢˜æ€è€ƒ

### é€šç”¨æŠ€å·§è¿ç§»
- **åŒºé—´è¦†ç›–æ€æƒ³**åŒæ ·é€‚ç”¨äºï¼š  
  1.  åŒºé—´è°ƒåº¦æœ€å°‘æœºå™¨æ•°ï¼ˆè´ªå¿ƒè¦†ç›–ï¼‰ã€‚  
  2.  åŠ¨æ€ç»´æŠ¤åŒºé—´å¹¶é›†é•¿åº¦ï¼ˆçº¿æ®µæ ‘/æ‰«æçº¿ï¼‰ã€‚  
  3.  å¸¦æƒåŒºé—´è¦†ç›–æœ€å¤§å€¼ï¼ˆDP + å•è°ƒé˜Ÿåˆ—ï¼‰ã€‚

### æ´›è°·æ¨è
1.  **P3379** ã€æ¨¡æ¿ã€‘æœ€è¿‘å…¬å…±ç¥–å…ˆï¼ˆLCAï¼‰  
   ğŸ—£ï¸ æ¨èç†ç”±ï¼šæŒæ¡å€å¢æ¨¡æ¿ï¼Œä¸ºæ ‘é“¾å‰–åˆ†æ‰“åŸºç¡€ã€‚  
2.  **P3380** ã€æ¨¡æ¿ã€‘æ ‘é“¾å‰–åˆ†  
   ğŸ—£ï¸ æ¨èç†ç”±ï¼šå­¦ä¼šæŠŠæ ‘ä¸Šè·¯å¾„é—®é¢˜é™ç»´åˆ°åºåˆ—ã€‚  
3.  **P1712** åŒºé—´  
   ğŸ—£ï¸ æ¨èç†ç”±ï¼šç»å…¸åŒºé—´è¦†ç›– + æ‰«æçº¿ï¼Œç»ƒä¹ ç¦»æ•£åŒ–ä¸çº¿æ®µæ ‘ã€‚  
4.  **P4551** æœ€é•¿å¼‚æˆ–è·¯å¾„  
   ğŸ—£ï¸ æ¨èç†ç”±ï¼šæ ‘ä¸Šè·¯å¾„é—®é¢˜ï¼Œå¼ºåŒ–å€å¢ä¸ä½è¿ç®—æŠ€å·§ã€‚

---

## 7. å­¦ä¹ å¿ƒå¾—ä¸ç»éªŒåˆ†äº«

> ran_qwq çš„ç¬”è®°æé†’æˆ‘ä»¬ï¼š  
> â€œå…ˆè¯æ˜ä¸»å¹²é“æœ€ä¼˜ï¼Œå†å†™ä»£ç ï¼Œäº‹åŠåŠŸå€ã€‚â€  
> è¿™å¥è¯ç‚¹ç ´äº†**å»ºæ¨¡**çš„é‡è¦æ€§â€”â€”æŠŠä¸‰ç»´æ ‘æŠ½è±¡æˆä¸€ç»´é“¾ï¼Œåç»­å…¨æ˜¯æ¨¡æ¿æ´»ã€‚  
> è°ƒè¯•æ—¶ï¼Œå¯æŠŠç¦»æ•£åŒ–åæ ‡æ‰“å°å‡ºæ¥ï¼Œè‚‰çœ¼æ¯”å¯¹åŒºé—´æ˜¯å¦æ­£ç¡®è¦†ç›–ï¼Œå¿«é€Ÿå®šä½ bugã€‚

---

<conclusion>
æ­å–œå„ä½â€œç®—æ³•å¿«é€’å‘˜â€å®Œæˆæœ¬æ¬¡æ¢é™©ï¼è®°ä½ï¼š  
**â€œå…ˆæŠŠæ ‘æ‹‰ç›´ï¼Œå†æŠŠåŒºé—´åŠ ï¼Œçº¿æ®µæ ‘ç»´æŠ¤æœ€å°å€¼ï¼Œå…¨ç¨‹ log Nã€‚â€**  
ä¸‹æ¬¡é‡åˆ°ç±»ä¼¼é¢˜ç›®ï¼Œä¸å¦¨å…ˆé—®è‡ªå·±ï¼šèƒ½å¦é™ç»´ï¼Ÿèƒ½å¦åŒºé—´åŒ–ï¼Ÿ  
ä¿æŒå¥½å¥‡ï¼ŒæŒç»­ç»ƒä¹ ï¼Œæˆ‘ä»¬ä¸‹é“é¢˜å†è§ï¼ğŸ’ª
</conclusion>

---
å¤„ç†ç”¨æ—¶ï¼š98.28ç§’
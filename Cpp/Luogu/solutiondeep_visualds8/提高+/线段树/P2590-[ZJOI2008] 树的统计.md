# é¢˜ç›®ä¿¡æ¯

# [ZJOI2008] æ ‘çš„ç»Ÿè®¡

## é¢˜ç›®æè¿°

ä¸€æ£µæ ‘ä¸Šæœ‰ $n$ ä¸ªèŠ‚ç‚¹ï¼Œç¼–å·åˆ†åˆ«ä¸º $1$ åˆ° $n$ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰ä¸€ä¸ªæƒå€¼ $w$ã€‚

æˆ‘ä»¬å°†ä»¥ä¸‹é¢çš„å½¢å¼æ¥è¦æ±‚ä½ å¯¹è¿™æ£µæ ‘å®Œæˆä¸€äº›æ“ä½œï¼š

I. `CHANGE u t` : æŠŠç»“ç‚¹ $u$ çš„æƒå€¼æ”¹ä¸º $t$ã€‚

II. `QMAX u v`: è¯¢é—®ä»ç‚¹ $u$ åˆ°ç‚¹ $v$ çš„è·¯å¾„ä¸Šçš„èŠ‚ç‚¹çš„æœ€å¤§æƒå€¼ã€‚

III. `QSUM u v`: è¯¢é—®ä»ç‚¹ $u$ åˆ°ç‚¹ $v$ çš„è·¯å¾„ä¸Šçš„èŠ‚ç‚¹çš„æƒå€¼å’Œã€‚

æ³¨æ„ï¼šä»ç‚¹ $u$ åˆ°ç‚¹ $v$ çš„è·¯å¾„ä¸Šçš„èŠ‚ç‚¹åŒ…æ‹¬ $u$ å’Œ $v$ æœ¬èº«ã€‚

## è¯´æ˜/æç¤º

å¯¹äº $100 \%$ çš„æ•°æ®ï¼Œä¿è¯ $1\le n \le 3\times 10^4$ï¼Œ$0\le q\le 2\times 10^5$ã€‚

ä¸­é€”æ“ä½œä¸­ä¿è¯æ¯ä¸ªèŠ‚ç‚¹çš„æƒå€¼ $w$ åœ¨ $-3\times 10^4$ åˆ° $3\times 10^4$ ä¹‹é—´ã€‚

## æ ·ä¾‹ #1

### è¾“å…¥

```
4
1 2
2 3
4 1
4 2 1 3
12
QMAX 3 4
QMAX 3 3
QMAX 3 2
QMAX 2 3
QSUM 3 4
QSUM 2 1
CHANGE 1 5
QMAX 3 4
CHANGE 3 6
QMAX 3 4
QMAX 2 4
QSUM 3 4
```

### è¾“å‡º

```
4
1
2
2
10
6
5
6
5
16
```

# AIåˆ†æç»“æœ

# ğŸ’¡ æ´›è¯­äº‘ç¬ºçš„C++ç®—æ³•è§£æï¼š[ZJOI2008] æ ‘çš„ç»Ÿè®¡ æ·±å…¥å­¦ä¹ æŒ‡å— ğŸ’¡

ä»Šå¤©æˆ‘ä»¬æ¥ä¸€èµ·åˆ†æã€Œ[ZJOI2008] æ ‘çš„ç»Ÿè®¡ã€è¿™é“ç»å…¸C++ç¼–ç¨‹é¢˜ã€‚è¿™ä¸ä»…ä»…æ˜¯ä¸€æ¬¡è§£é¢˜ï¼Œæ›´æ˜¯ä¸€åœºæ€ç»´çš„æ¢é™©ï¼šæˆ‘ä»¬è¦å­¦ä¼šå¦‚ä½•åƒä¾¦æ¢ä¸€æ ·ä»é¢˜ç›®ä¸­å¯»æ‰¾çº¿ç´¢ï¼Œåœ¨å¤šç§è§£é¢˜é“è·¯ä¸­æƒè¡¡é€‰æ‹©ï¼Œæœ€ç»ˆæ‰¾åˆ°æœ€ä¼˜çš„ç­–ç•¥ã€‚

---

## 1. é¢˜ç›®è§£è¯»ä¸ç­–ç•¥åˆæ¢

### âœ¨ æœ¬é¢˜æ ¸å¿ƒæŒ‘æˆ˜
- **æ ¸å¿ƒæŒ‘æˆ˜**ï¼šåœ¨**ä¸€æ£µæ ‘**ä¸Šï¼Œæ—¢è¦æ”¯æŒ**å•ç‚¹ä¿®æ”¹**ï¼ˆCHANGE u tï¼‰ï¼Œåˆè¦é«˜æ•ˆå›ç­”**ä»»æ„ä¸¤ç‚¹é—´è·¯å¾„ä¸Šçš„æœ€å¤§å€¼/å’Œ**ï¼ˆQMAX u v / QSUM u vï¼‰ã€‚  
- **æœ¬è´¨éš¾ç‚¹**ï¼šæ ‘ç»“æ„å¤©ç„¶â€œç¦»æ•£â€ï¼Œè·¯å¾„ä¸æ˜¯è¿ç»­åŒºé—´ï¼Œä¼ ç»Ÿçº¿æ®µæ ‘æ— æ³•ç›´æ¥å¥—ç”¨ã€‚  
- **æ ¸å¿ƒç®—æ³•æ ‡ç­¾**ï¼š**æ ‘é“¾å‰–åˆ†ï¼ˆHeavy-Light Decomposition, HLDï¼‰** + **çº¿æ®µæ ‘ / LCT / åˆ†å—**ã€‚

### âœ¨ è§£é¢˜æ€è·¯æ¦‚è§ˆ
| æ€è·¯æ¼”è¿› | æ ¸å¿ƒæ€æƒ³ | æ—¶é—´å¤æ‚åº¦ | é€‚ç”¨åœºæ™¯ |
| --- | --- | --- | --- |
| **æš´åŠ›DFS** | æ¯æ¬¡è¯¢é—®æš´åŠ›éå†è·¯å¾„ | O(n) / è¯¢é—® | ä»…ç”¨äºç†è§£é¢˜æ„ï¼Œnâ‰¤30000 æ—¶ç›´æ¥ TLE |
| **æ ‘é“¾å‰–åˆ† + çº¿æ®µæ ‘** | å°†æ ‘æ‹†æˆå¤šæ¡â€œé‡é“¾â€ï¼Œæ¯æ¡é“¾ç”¨çº¿æ®µæ ‘ç»´æŠ¤ | O(logÂ²n) / æ“ä½œ | ç»å…¸åšæ³•ï¼Œç é‡è¾ƒå¤§ä½†ç¨³å®š AC |
| **Link-Cut Tree (LCT)** | åŠ¨æ€æ ‘ç»“æ„ï¼Œç”¨ Splay ç»´æŠ¤å®é“¾ | O(log n) å‡æ‘Š | ä»£ç çŸ­ï¼Œæ€ç»´éš¾åº¦é«˜ï¼Œé€‚åˆè¿›é˜¶ |
| **åˆ†å—** | å°†æ ‘æŒ‰ DFS åºåˆ†å—ï¼Œå—å†…æš´åŠ› | O(nâˆšn) | å¸¸æ•°å°ï¼Œæ€ç»´ç®€å•ï¼Œå¯å¡è¿‡ |

> **æ´›è¯­äº‘ç¬ºçš„æ¯”å–»**ï¼š  
> æ ‘é“¾å‰–åˆ†å°±åƒæŠŠä¸€æ£µâ€œææˆçºµæ¨ªâ€çš„å¤§æ ‘ï¼Œç”¨â€œé‡é“¾â€è¿™æŠŠå‰ªåˆ€å‰ªæˆä¸€æ¡æ¡â€œç›´æºœæºœâ€çš„ç»³å­ï¼ˆè¿ç»­åŒºé—´ï¼‰ï¼Œå†ç”¨â€œçº¿æ®µå°ºâ€ï¼ˆçº¿æ®µæ ‘ï¼‰é‡é•¿åº¦ã€æ‰¾æœ€é«˜åˆ»åº¦ï¼Œæ—¢å¿«åˆå‡†ï¼

---

### ğŸ” ç®—æ³•ä¾¦æ¢ï¼šå¦‚ä½•åœ¨é¢˜ç›®ä¸­å‘ç°çº¿ç´¢ï¼Ÿ
1. **çº¿ç´¢1ï¼ˆé—®é¢˜ç›®æ ‡ï¼‰**ï¼š  
   â€œè¯¢é—®ä»»æ„ä¸¤ç‚¹é—´è·¯å¾„ä¸Šçš„æœ€å¤§å€¼/å’Œâ€ â†’ **è·¯å¾„æŸ¥è¯¢**é—®é¢˜ï¼Œæš—ç¤ºéœ€è¦**é“¾å¼ç»“æ„**æˆ–**æ ‘é“¾å‰–åˆ†**ã€‚
2. **çº¿ç´¢2ï¼ˆé—®é¢˜çº¦æŸï¼‰**ï¼š  
   â€œå•ç‚¹ä¿®æ”¹ + è·¯å¾„æŸ¥è¯¢â€ â†’ **åŠ¨æ€æ ‘é—®é¢˜**ï¼Œæ’é™¤é™æ€ç®—æ³•ï¼ˆå¦‚å‰ç¼€å’Œï¼‰ã€‚
3. **çº¿ç´¢3ï¼ˆæ•°æ®è§„æ¨¡ï¼‰**ï¼š  
   nâ‰¤3Ã—10â´, qâ‰¤2Ã—10âµ â†’ æ€»æ“ä½œæ•° 2Ã—10âµï¼ŒO(nâˆšn) æˆ– O(logÂ²n) å‡å¯æ¥å—ï¼Œä½† O(n) æš´åŠ›ä¼š TLEã€‚

---

### ğŸ§  æ€ç»´é“¾æ„å»ºï¼šä»çº¿ç´¢åˆ°ç­–ç•¥
> 1. **é—®é¢˜ç›®æ ‡**å‘Šè¯‰æˆ‘ä»¬ï¼šéœ€è¦å¿«é€Ÿæ±‚è·¯å¾„ä¿¡æ¯ã€‚  
> 2. **çº¦æŸ**å‘Šè¯‰æˆ‘ä»¬ï¼šæ ‘ç»“æ„ç¦»æ•£ï¼Œç›´æ¥çº¿æ®µæ ‘ä¸å¯è¡Œã€‚  
> 3. **æ•°æ®è§„æ¨¡**å‘Šè¯‰æˆ‘ä»¬ï¼šå¿…é¡» â‰¤O(n logÂ²n)ã€‚  
> 4. **ç»“è®º**ï¼š  
>    - **æ ‘é“¾å‰–åˆ†**å°†æ ‘æ‹†æˆ O(log n) æ¡é‡é“¾ï¼Œæ¯æ¡é“¾è¿ç»­ï¼Œç”¨çº¿æ®µæ ‘ç»´æŠ¤åŒºé—´å’Œ/æœ€å¤§å€¼ï¼Œæ€»å¤æ‚åº¦ O(logÂ²n)ã€‚  
>    - **LCT** ç”¨ Splay ç»´æŠ¤åŠ¨æ€æ ‘ï¼Œå‡æ‘Š O(log n)ï¼Œä½†å®ç°å¤æ‚ã€‚  
>    - **åˆ†å—** ç®€å•ç²—æš´ï¼ŒO(nâˆšn)ï¼Œå¸¸æ•°ä¼˜åŒ–åå¯è¡Œã€‚

---

## 2. ç²¾é€‰ä¼˜è´¨é¢˜è§£å‚è€ƒ

### é¢˜è§£ä¸€ï¼šzcyskyï¼ˆèµï¼š112ï¼‰  
**æ ¸å¿ƒæ€æƒ³**ï¼šç»å…¸æ ‘é“¾å‰–åˆ† + çº¿æ®µæ ‘ã€‚  
**äº®ç‚¹**ï¼š  
- ä»£ç ç»“æ„æ¸…æ™°ï¼Œå˜é‡å‘½åè§„èŒƒï¼ˆ`size`, `wson`, `top`, `tpos`ï¼‰ã€‚  
- çº¿æ®µæ ‘åŒæ—¶ç»´æŠ¤åŒºé—´å’Œä¸åŒºé—´æœ€å¤§å€¼ï¼Œé€šç”¨æ€§å¼ºã€‚  
- æŸ¥è¯¢å‡½æ•° `qsum`/`qmax` é€šè¿‡â€œè·³é“¾â€ä¼˜é›…å®ç°ã€‚

**å­¦ä¹ ç¬”è®°**ï¼š  
> æ ‘é“¾å‰–åˆ†çš„ç²¾é«“åœ¨äºâ€œé‡é“¾ä¼˜å…ˆ DFSâ€ï¼Œä¿è¯æ¯æ¡é‡é“¾åœ¨çº¿æ®µæ ‘ä¸­è¿ç»­ï¼Œä»è€Œå°†è·¯å¾„æŸ¥è¯¢è½¬åŒ–ä¸º O(log n) æ¬¡åŒºé—´æŸ¥è¯¢ã€‚

### é¢˜è§£äºŒï¼ša999999ï¼ˆèµï¼š72ï¼‰  
**æ ¸å¿ƒæ€æƒ³**ï¼šè¯¦ç»†å›¾è§£ + å¤æ‚åº¦è¯æ˜ã€‚  
**äº®ç‚¹**ï¼š  
- ç”¨å›¾ç‰‡ç›´è§‚è§£é‡Šé‡é“¾/è½»é“¾åˆ’åˆ†ã€‚  
- è¯æ˜å•æ¬¡è·³é“¾å¤æ‚åº¦ O(log n)ï¼Œæ€»å¤æ‚åº¦ O(logÂ²n)ã€‚  
- æä¾› LCA ä¸æ ‘é“¾å‰–åˆ†çš„å…³è”è®²è§£ã€‚

**å­¦ä¹ ç¬”è®°**ï¼š  
> é‡é“¾å‰–åˆ†çš„æ­£ç¡®æ€§ä¾èµ–äºâ€œæ¯æ¬¡è·³é“¾å­æ ‘å¤§å°å‡åŠâ€ï¼Œç±»ä¼¼å€å¢ LCA çš„è¯æ˜ã€‚

### é¢˜è§£ä¸‰ï¼šHenryHuangï¼ˆèµï¼š23ï¼‰  
**æ ¸å¿ƒæ€æƒ³**ï¼šå—çŠ¶æ ‘ï¼ˆåˆ†å—ï¼‰è§£æ³•ã€‚  
**äº®ç‚¹**ï¼š  
- å°†æ ‘æŒ‰ DFS åºåˆ†å—ï¼Œå—å†…æš´åŠ›ï¼Œå—é—´è·³è·ƒã€‚  
- å¤æ‚åº¦ O(nâˆšn)ï¼Œä»£ç ç®€æ´ï¼Œé€‚åˆæ€ç»´ç®€å•ä½†å¸¸æ•°å°çš„åœºæ™¯ã€‚  

**å­¦ä¹ ç¬”è®°**ï¼š  
> åˆ†å—æ˜¯â€œæš´åŠ›ç¾å­¦â€çš„ä»£è¡¨ï¼Œå½“é¢˜ç›®å…è®¸ O(nâˆšn) æ—¶ï¼Œå¾€å¾€æ˜¯æ€§ä»·æ¯”æœ€é«˜çš„é€‰æ‹©ã€‚

---

## 3. è§£é¢˜ç­–ç•¥æ·±åº¦å‰–æ

### ğŸ¯ æ ¸å¿ƒéš¾ç‚¹ä¸å…³é”®æ­¥éª¤ï¼ˆæ ‘é“¾å‰–åˆ†æœ€ä¼˜è§£æ³•ï¼‰
1. **å…³é”®ç‚¹1ï¼šå¦‚ä½•åˆ’åˆ†é‡é“¾ï¼Ÿ**  
   - **åˆ†æ**ï¼šDFS1 æ±‚å­æ ‘å¤§å° `size[u]`ï¼Œæ ‡è®°é‡å„¿å­ `son[u]`ï¼ˆå­æ ‘æœ€å¤§çš„å„¿å­ï¼‰ã€‚  
   - **DFS2** ä¼˜å…ˆéå†é‡å„¿å­ï¼Œä¿è¯é‡é“¾è¿ç»­ã€‚  
   - ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šé‡é“¾åˆ’åˆ†æ˜¯åç»­çº¿æ®µæ ‘ä¼˜åŒ–çš„å‰æï¼ŒåŠ¡å¿…ä¿è¯ DFS2 å…ˆèµ°é‡å„¿å­ã€‚

2. **å…³é”®ç‚¹2ï¼šå¦‚ä½•ç”¨çº¿æ®µæ ‘ç»´æŠ¤ï¼Ÿ**  
   - **åˆ†æ**ï¼šæ¯æ¡é‡é“¾å¯¹åº”çº¿æ®µæ ‘ä¸­ä¸€æ®µè¿ç»­åŒºé—´ï¼ŒåŒºé—´å’Œ/æœ€å¤§å€¼å¯ç”¨æ ‡å‡†çº¿æ®µæ ‘ç»´æŠ¤ã€‚  
   - **æŸ¥è¯¢**ï¼šé€šè¿‡â€œè·³é“¾â€å°†è·¯å¾„æ‹†æˆ O(log n) æ®µåŒºé—´ï¼Œåˆ†åˆ«æŸ¥è¯¢ååˆå¹¶ã€‚  
   - ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šçº¿æ®µæ ‘çš„â€œåŒºé—´åˆå¹¶â€æ€æƒ³æ˜¯å¤„ç†è·¯å¾„æŸ¥è¯¢çš„æ ¸å¿ƒã€‚

3. **å…³é”®ç‚¹3ï¼šå¦‚ä½•å¤„ç†å•ç‚¹ä¿®æ”¹ï¼Ÿ**  
   - **åˆ†æ**ï¼šç›´æ¥åœ¨çº¿æ®µæ ‘ä¸­ä¿®æ”¹å¯¹åº”èŠ‚ç‚¹ï¼ˆDFS åºç¼–å·ï¼‰ï¼Œå¤æ‚åº¦ O(log n)ã€‚  
   - **æ³¨æ„**ï¼šéœ€åŒæ—¶æ›´æ–°çº¿æ®µæ ‘çš„åŒºé—´å’Œä¸åŒºé—´æœ€å¤§å€¼ã€‚

---

### âš”ï¸ ç­–ç•¥ç«æŠ€åœºï¼šä¸åŒè§£æ³•å¯¹æ¯”
| ç­–ç•¥ | æ ¸å¿ƒæ€æƒ³ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
| --- | --- | --- | --- | --- |
| **æš´åŠ›DFS** | ç›´æ¥éå†è·¯å¾„ | ä»£ç æœ€çŸ­ï¼Œæ˜“è°ƒè¯• | O(n) è¶…æ—¶ | å¯¹æ‹/ç†è§£é¢˜æ„ |
| **æ ‘é“¾å‰–åˆ†+çº¿æ®µæ ‘** | é‡é“¾è¿ç»­ + çº¿æ®µæ ‘ | O(logÂ²n) ç¨³å®šï¼Œé€šç”¨æ€§å¼º | ç é‡å¤§ï¼Œè°ƒè¯•å¤æ‚ | æ ‡å‡†è§£æ³• |
| **LCT** | åŠ¨æ€æ ‘ + Splay | O(log n) å‡æ‘Šï¼Œä»£ç çŸ­ | æ€ç»´éš¾åº¦é«˜ï¼Œå¸¸æ•°å¤§ | è¿›é˜¶/åŠ¨æ€æ ‘é—®é¢˜ |
| **åˆ†å—** | å—å†…æš´åŠ› + å—é—´è·³è·ƒ | æ€ç»´ç®€å•ï¼Œå¸¸æ•°å° | O(nâˆšn) å¯èƒ½å¡è¾¹ | æ•°æ®å®½æ¾/å¿«é€Ÿå®ç° |

---

### âœ¨ ä¼˜åŒ–ä¹‹æ—…ï¼šä»â€œèƒ½åšâ€åˆ°â€œåšå¥½â€
> 1. **èµ·ç‚¹**ï¼šæš´åŠ› DFS æ¯æ¬¡ O(n) æŸ¥è¯¢ï¼Œ2Ã—10âµ æ¬¡æ“ä½œç›´æ¥çˆ†ç‚¸ã€‚  
> 2. **ç“¶é¢ˆ**ï¼šæ ‘ç»“æ„ç¦»æ•£ï¼Œæ— æ³•ç›´æ¥ç”¨çº¿æ®µæ ‘ã€‚  
> 3. **é’¥åŒ™**ï¼šæ ‘é“¾å‰–åˆ†å°†æ ‘â€œæ‹‰ç›´â€ï¼Œè½¬åŒ–ä¸º O(log n) æ®µåŒºé—´ã€‚  
> 4. **å‡å**ï¼šç”¨çº¿æ®µæ ‘ç»´æŠ¤åŒºé—´ä¿¡æ¯ï¼Œæ€»å¤æ‚åº¦é™è‡³ O(logÂ²n)ã€‚  
> 5. **ç»ˆæ**ï¼šLCT è¿›ä¸€æ­¥ä¼˜åŒ–è‡³ O(log n)ï¼Œä½†éœ€æ›´é«˜æŠ€å·§ã€‚

---

## 4. C++æ ¸å¿ƒä»£ç å®ç°èµæ

### æœ¬é¢˜é€šç”¨æ ¸å¿ƒC++å®ç°å‚è€ƒï¼ˆæ ‘é“¾å‰–åˆ† + çº¿æ®µæ ‘ï¼‰
```cpp
#include <bits/stdc++.h>
using namespace std;
const int N = 3e4 + 5, INF = 1e9;

struct Edge { int to, next; } e[N << 1];
int head[N], tot = 0;
void add(int u, int v) { e[++tot] = {v, head[u]}, head[u] = tot; }

int n, q, a[N];
int size[N], son[N], dep[N], fa[N], top[N], dfn[N], rnk[N], cnt = 0;

// DFS1ï¼šæ±‚å­æ ‘å¤§å°ã€é‡å„¿å­
void dfs1(int u, int f) {
    size[u] = 1, fa[u] = f, dep[u] = dep[f] + 1;
    for (int i = head[u]; i; i = e[i].next) {
        int v = e[i].to;
        if (v == f) continue;
        dfs1(v, u);
        size[u] += size[v];
        if (size[v] > size[son[u]]) son[u] = v;
    }
}

// DFS2ï¼šé‡é“¾ä¼˜å…ˆéå†ï¼Œæ±‚dfn
void dfs2(int u, int tp) {
    top[u] = tp, dfn[u] = ++cnt, rnk[cnt] = u;
    if (son[u]) dfs2(son[u], tp);
    for (int i = head[u]; i; i = e[i].next) {
        int v = e[i].to;
        if (v == fa[u] || v == son[u]) continue;
        dfs2(v, v);
    }
}

// çº¿æ®µæ ‘ï¼šç»´æŠ¤åŒºé—´å’Œä¸æœ€å¤§å€¼
struct SegTree {
    int sum[N << 2], mx[N << 2];
    void build(int p, int l, int r) {
        if (l == r) { sum[p] = mx[p] = a[rnk[l]]; return; }
        int mid = (l + r) >> 1;
        build(p << 1, l, mid), build(p << 1 | 1, mid + 1, r);
        sum[p] = sum[p << 1] + sum[p << 1 | 1];
        mx[p] = max(mx[p << 1], mx[p << 1 | 1]);
    }
    void update(int p, int l, int r, int pos, int val) {
        if (l == r) { sum[p] = mx[p] = val; return; }
        int mid = (l + r) >> 1;
        if (pos <= mid) update(p << 1, l, mid, pos, val);
        else update(p << 1 | 1, mid + 1, r, pos, val);
        sum[p] = sum[p << 1] + sum[p << 1 | 1];
        mx[p] = max(mx[p << 1], mx[p << 1 | 1]);
    }
    int query_sum(int p, int l, int r, int L, int R) {
        if (L <= l && r <= R) return sum[p];
        int mid = (l + r) >> 1, res = 0;
        if (L <= mid) res += query_sum(p << 1, l, mid, L, R);
        if (R > mid) res += query_sum(p << 1 | 1, mid + 1, r, L, R);
        return res;
    }
    int query_max(int p, int l, int r, int L, int R) {
        if (L <= l && r <= R) return mx[p];
        int mid = (l + r) >> 1, res = -INF;
        if (L <= mid) res = max(res, query_max(p << 1, l, mid, L, R));
        if (R > mid) res = max(res, query_max(p << 1 | 1, mid + 1, r, L, R));
        return res;
    }
} st;

// è·¯å¾„æŸ¥è¯¢ï¼šè·³é“¾
int query_path_sum(int u, int v) {
    int res = 0;
    while (top[u] != top[v]) {
        if (dep[top[u]] < dep[top[v]]) swap(u, v);
        res += st.query_sum(1, 1, n, dfn[top[u]], dfn[u]);
        u = fa[top[u]];
    }
    if (dep[u] > dep[v]) swap(u, v);
    res += st.query_sum(1, 1, n, dfn[u], dfn[v]);
    return res;
}

int query_path_max(int u, int v) {
    int res = -INF;
    while (top[u] != top[v]) {
        if (dep[top[u]] < dep[top[v]]) swap(u, v);
        res = max(res, st.query_max(1, 1, n, dfn[top[u]], dfn[u]));
        u = fa[top[u]];
    }
    if (dep[u] > dep[v]) swap(u, v);
    res = max(res, st.query_max(1, 1, n, dfn[u], dfn[v]));
    return res;
}

int main() {
    scanf("%d", &n);
    for (int i = 1, u, v; i < n; ++i) {
        scanf("%d%d", &u, &v);
        add(u, v), add(v, u);
    }
    for (int i = 1; i <= n; ++i) scanf("%d", &a[i]);
    dfs1(1, 0), dfs2(1, 1);
    st.build(1, 1, n);
    scanf("%d", &q);
    char op[10];
    while (q--) {
        scanf("%s", op);
        int u, v; scanf("%d%d", &u, &v);
        if (op[0] == 'C') st.update(1, 1, n, dfn[u], v);
        else if (op[1] == 'M') printf("%d\n", query_path_max(u, v));
        else printf("%d\n", query_path_sum(u, v));
    }
    return 0;
}
```

---

## 5. ç®—æ³•å¯è§†åŒ–ï¼šåƒç´ åŠ¨ç”»æ¼”ç¤º

### ğŸ® åŠ¨ç”»ä¸»é¢˜ï¼šåƒç´ æ¢é™©å®¶çš„æ ‘é“¾ä¹‹æ—…  
**ç›®æ ‡**ï¼šç›´è§‚å±•ç¤ºæ ‘é“¾å‰–åˆ†å¦‚ä½•å°†æ ‘ç»“æ„è½¬åŒ–ä¸ºè¿ç»­åŒºé—´ï¼Œå¹¶ç”¨çº¿æ®µæ ‘ç»´æŠ¤ã€‚

### ğŸ® è®¾è®¡æ€è·¯
- **8ä½åƒç´ é£æ ¼**ï¼šä»¿ç…§ FC çº¢ç™½æœºï¼ŒèŠ‚ç‚¹ç”¨å½©è‰²æ–¹å—è¡¨ç¤ºï¼Œé‡é“¾ç”¨é«˜äº®çº¢è‰²è¿çº¿ã€‚  
- **äº¤äº’é¢æ¿**ï¼š  
  - **å¼€å§‹/æš‚åœ**ï¼šæ§åˆ¶åŠ¨ç”»æ’­æ”¾ã€‚  
  - **å•æ­¥æ‰§è¡Œ**ï¼šé€æ­¥å±•ç¤º DFS1ã€DFS2ã€è·³é“¾æŸ¥è¯¢ã€‚  
  - **é€Ÿåº¦æ»‘å—**ï¼šè°ƒèŠ‚åŠ¨ç”»é€Ÿåº¦ã€‚  
- **éŸ³æ•ˆæç¤º**ï¼š  
  - èŠ‚ç‚¹è®¿é—®ï¼šè½»â€œå®â€å£°ã€‚  
  - é‡é“¾åˆ’åˆ†ï¼šèƒœåˆ©éŸ³è°ƒã€‚  
  - æŸ¥è¯¢å®Œæˆï¼šåº†ç¥éŸ³æ•ˆã€‚

### ğŸ® å…³é”®å¸§ç¤ºä¾‹
1. **DFS1**ï¼šå±•ç¤ºå­æ ‘å¤§å°è®¡ç®—ï¼Œé‡å„¿å­é«˜äº®ã€‚  
2. **DFS2**ï¼šé‡é“¾ä¼˜å…ˆéå†ï¼Œè¿ç»­åŒºé—´æ ‡è®°ä¸ºåŒä¸€é¢œè‰²ã€‚  
3. **è·³é“¾æŸ¥è¯¢**ï¼šä¸¤ç‚¹è·¯å¾„è¢«æ‹†æˆå¤šæ®µåŒºé—´ï¼Œçº¿æ®µæ ‘åŒºé—´é«˜äº®ã€‚

---

## 6. æ‹“å±•ç»ƒä¹ ä¸ç›¸ä¼¼é—®é¢˜æ€è€ƒ

### ğŸŒ± é€šç”¨æŠ€å·§è¿ç§»
- **æ ‘é“¾å‰–åˆ†**ï¼šé€‚ç”¨äºæ‰€æœ‰â€œæ ‘ä¸Šè·¯å¾„/å­æ ‘â€é—®é¢˜ï¼Œå¦‚ï¼š  
  - **åŒºé—´åŠ /ä¹˜**ï¼šP3384 æ ‘é“¾å‰–åˆ†æ¨¡æ¿ã€‚  
  - **å­æ ‘ä¿®æ”¹**ï¼šP2146 è½¯ä»¶åŒ…ç®¡ç†å™¨ã€‚  
  - **åŠ¨æ€æ ‘**ï¼šLCT ç»´æŠ¤åŠ¨æ€è¿é€šæ€§ã€‚

### ğŸŒ± æ´›è°·æ¨èç»ƒä¹ 
1. **P3379** - æ ‘é“¾å‰–åˆ†æ±‚ LCA  
   *æ¨èç†ç”±*ï¼šæŒæ¡é‡é“¾åˆ’åˆ†ä¸è·³é“¾æŠ€å·§ã€‚  
2. **P3384** - æ ‘é“¾å‰–åˆ†æ¨¡æ¿  
   *æ¨èç†ç”±*ï¼šå®Œæ•´å®ç°åŒºé—´ä¿®æ”¹ + æŸ¥è¯¢ã€‚  
3. **P2590** - æœ¬é¢˜åŠ å¼ºç‰ˆï¼ˆåŒºé—´åŠ ï¼‰  
   *æ¨èç†ç”±*ï¼šç»ƒä¹ æ‡’æ ‡è®°ä¸‹ä¼ ã€‚  

---

## 7. å­¦ä¹ å¿ƒå¾—ä¸ç»éªŒåˆ†äº«

> **æ¥è‡ªä½œè€…â€œåŸºåœ°A_Iâ€**ï¼š  
> â€œçº¿æ®µæ ‘æ•°ç»„ä¸€å®šè¦å¼€ 4 å€ï¼dfs1 å’Œ dfs2 è¦åœ¨ build ä¹‹å‰è°ƒç”¨ï¼è°ƒè¯•æ—¶æ‰“å°ä¸­é—´å˜é‡èƒ½å¿«é€Ÿå®šä½é”™è¯¯ã€‚â€  

**æ´›è¯­äº‘ç¬ºç‚¹è¯„**ï¼š  
è¿™äº›â€œç¿»è½¦ç‚¹â€æé†’æˆ‘ä»¬ï¼Œæ ‘é“¾å‰–åˆ†çš„å®ç°ç»†èŠ‚ç¹å¤šï¼Œå»ºè®®å…ˆç”»æµç¨‹å›¾ï¼Œå†é€æ­¥ç¼–ç è°ƒè¯•ã€‚

---

## 8. ç»“è®º

æ ‘é“¾å‰–åˆ†æ˜¯å¤„ç†æ ‘ä¸Šè·¯å¾„é—®é¢˜çš„â€œç‘å£«å†›åˆ€â€ã€‚é€šè¿‡æœ¬é¢˜çš„æ·±å…¥åˆ†æï¼Œæˆ‘ä»¬ä¸ä»…æŒæ¡äº†ç»å…¸ç®—æ³•ï¼Œæ›´å­¦ä¼šäº†å¦‚ä½•ä»é¢˜ç›®ä¸­æç‚¼çº¿ç´¢ã€æƒè¡¡ç­–ç•¥ã€ä¼˜é›…å®ç°ã€‚è®°ä½ï¼š  
> **â€œä¼˜ç§€çš„ç®—æ³•æºäºå¯¹é—®é¢˜ç»“æ„çš„æ·±åˆ»æ´å¯Ÿã€‚â€**  
ç»§ç»­æ¢ç´¢ï¼Œä¸‹æ¬¡æˆ‘ä»¬å†æŒ‘æˆ˜æ›´å¤æ‚çš„æ ‘å½¢ç»“æ„ï¼

---
å¤„ç†ç”¨æ—¶ï¼š173.94ç§’
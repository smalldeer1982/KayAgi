# é¢˜ç›®ä¿¡æ¯

# [SHOI2012] é­”æ³•æ ‘

## é¢˜ç›®èƒŒæ™¯

SHOI2012 D2T3


## é¢˜ç›®æè¿°

Harry Potter æ–°å­¦äº†ä¸€ç§é­”æ³•ï¼šå¯ä»¥æ”¹å˜æ ‘ä¸Šçš„æœå­ä¸ªæ•°ã€‚æ»¡å¿ƒæ¬¢å–œçš„ä»–æ‰¾åˆ°äº†ä¸€ä¸ªå·¨å¤§çš„æœæ ‘ï¼Œæ¥è¯•éªŒä»–çš„æ–°æ³•æœ¯ã€‚

è¿™æ£µæœæ ‘å…±æœ‰ $N$ ä¸ªèŠ‚ç‚¹ï¼Œå…¶ä¸­èŠ‚ç‚¹ $0$ æ˜¯æ ¹èŠ‚ç‚¹ï¼Œæ¯ä¸ªèŠ‚ç‚¹ $u$ çš„çˆ¶äº²è®°ä¸º $fa[u]$ï¼Œä¿è¯æœ‰ $fa[u] < u$ ã€‚åˆå§‹æ—¶ï¼Œè¿™æ£µæœæ ‘ä¸Šçš„æœå­éƒ½è¢« Dumbledore ç”¨é­”æ³•æ¸…é™¤æ‰äº†ï¼Œæ‰€ä»¥è¿™ä¸ªæœæ ‘çš„æ¯ä¸ªèŠ‚ç‚¹ä¸Šéƒ½æ²¡æœ‰æœå­ï¼ˆå³ $0$ ä¸ªæœå­ï¼‰ã€‚

ä¸å¹¸çš„æ˜¯ï¼ŒHarry çš„æ³•æœ¯å­¦å¾—ä¸åˆ°ä½ï¼Œåªèƒ½å¯¹æ ‘ä¸Šä¸€æ®µè·¯å¾„çš„èŠ‚ç‚¹ä¸Šçš„æœå­ä¸ªæ•°ç»Ÿä¸€å¢åŠ ä¸€å®šçš„æ•°é‡ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒHarry çš„é­”æ³•å¯ä»¥è¿™æ ·æè¿°ï¼š`A u v d` ã€‚è¡¨ç¤ºå°†ç‚¹ $u$ å’Œ $v$ ä¹‹é—´çš„è·¯å¾„ä¸Šçš„æ‰€æœ‰èŠ‚ç‚¹çš„æœå­ä¸ªæ•°éƒ½åŠ ä¸Š $d$ã€‚

æ¥ä¸‹æ¥ï¼Œä¸ºäº†æ–¹ä¾¿æ£€éªŒ Harry çš„é­”æ³•æ˜¯å¦æˆåŠŸï¼Œä½ éœ€è¦å‘Šè¯‰ä»–åœ¨é‡Šæ”¾é­”æ³•çš„è¿‡ç¨‹ä¸­çš„ä¸€äº›æœ‰å…³æœæ ‘çš„ä¿¡æ¯ï¼š`Q u`ã€‚è¡¨ç¤ºå½“å‰æœæ ‘ä¸­ï¼Œä»¥ç‚¹ $u$ ä¸ºæ ¹çš„å­æ ‘ä¸­ï¼Œæ€»å…±æœ‰å¤šå°‘ä¸ªæœå­ï¼Ÿ


## æ ·ä¾‹ #1

### è¾“å…¥

```
4
0 1
1 2
2 3
4
A 1 3 1
Q 0
Q 1
Q 2```

### è¾“å‡º

```
3
3
2```

# AIåˆ†æç»“æœ

---
# ğŸ’¡ æ´›è¯­äº‘ç¬ºçš„C++ç®—æ³•è§£æï¼šSHOI2012 é­”æ³•æ ‘ æ·±å…¥å­¦ä¹ æŒ‡å— ğŸ’¡

ä»Šå¤©æˆ‘ä»¬æ¥ä¸€èµ·åˆ†æâ€œSHOI2012 é­”æ³•æ ‘â€è¿™é“çœé€‰ C++ é¢˜ã€‚å®ƒè¡¨é¢ä¸Šæ˜¯ä¸€é“â€œé­”æ³•â€æ•…äº‹ï¼Œæœ¬è´¨ä¸Šå´æ˜¯ä¸€åœºâ€œæ ‘é“¾å‰–åˆ†â€ä¸â€œæ•°æ®ç»“æ„â€çš„ç²¾å¦™å¯¹å†³ã€‚å‡†å¤‡å¥½æ¢é™©äº†å—ï¼Ÿ

## 1. é¢˜ç›®è§£è¯»ä¸ç­–ç•¥åˆæ¢

### âœ¨ æœ¬é¢˜æ ¸å¿ƒæŒ‘æˆ˜
â€œåœ¨ **æ ‘å½¢ç»“æ„** ä¸Šæ”¯æŒ **è·¯å¾„åŠ ** ä¸ **å­æ ‘æ±‚å’Œ**ã€‚â€  
å…³é”®è¯ï¼šæ ‘ã€è·¯å¾„ã€å­æ ‘ã€åŒºé—´åŠ ã€åŒºé—´æ±‚å’Œã€‚

### âœ¨ æ ¸å¿ƒç®—æ³•æ ‡ç­¾
- **æ ‘é“¾å‰–åˆ† (Heavy-Light Decomposition, HLD)**  
- **çº¿æ®µæ ‘ / æ ‘çŠ¶æ•°ç»„**ï¼ˆåŒºé—´åŠ  & åŒºé—´æ±‚å’Œï¼‰  
- **æ¬§æ‹‰åº + å·®åˆ†**ï¼ˆå¦ä¸€ç§æ€è·¯ï¼‰  
- **LCT**ï¼ˆLink-Cut Treeï¼Œé«˜é˜¶ç©æ³•ï¼‰

### ğŸ—£ï¸ åˆæ­¥åˆ†æ
> 1.  **æš´åŠ›æ¨¡æ‹Ÿ**  
>     ç›´æ¥å¯¹æ ‘æš´åŠ›éå†ï¼Œæ¯æ¬¡ `A` æ“ä½œ O(N) ä¿®æ”¹ï¼Œæ¯æ¬¡ `Q` æ“ä½œ O(N) æ±‚å’Œã€‚  
>     **æ—¶é—´å¤æ‚åº¦** O(QÂ·N) â†’ 1e5 Ã— 1e5 = 1e10ï¼Œç»å¯¹ TLEã€‚  
>     è¿™å‘Šè¯‰æˆ‘ä»¬ï¼šéœ€è¦æŠŠâ€œæ ‘â€è½¬åŒ–ä¸ºâ€œåºåˆ—â€æ‰èƒ½ç”¨é«˜æ•ˆæ•°æ®ç»“æ„ã€‚
>
> 2.  **æ ‘é“¾å‰–åˆ† + çº¿æ®µæ ‘**ï¼ˆä¸»æµæœ€ä¼˜ï¼‰  
>     å…ˆç”¨ä¸¤æ¬¡ DFS æŠŠæ ‘æ‹†æˆè‹¥å¹²æ¡â€œé‡é“¾â€ï¼ŒDFS åºä¿è¯æ¯æ¡é“¾åœ¨åºåˆ—ä¸Šè¿ç»­ï¼›å†ç”¨çº¿æ®µæ ‘ç»´æŠ¤åŒºé—´åŠ /æ±‚å’Œã€‚  
>     **æ—¶é—´å¤æ‚åº¦** O(Q logÂ²N)ï¼Œç©ºé—´ O(N)ã€‚
>
> 3.  **æ¬§æ‹‰åº + å·®åˆ† + æ ‘çŠ¶æ•°ç»„**ï¼ˆç†è®ºæœ€ä¼˜ï¼‰  
>     æŠŠæ ‘æ‹å¹³æˆæ¬§æ‹‰åºï¼Œåˆ©ç”¨å·®åˆ†æ€æƒ³ + ä¸¤ä¸ªæ ‘çŠ¶æ•°ç»„åšåˆ° O(Q logN)ã€‚  
>     ä½†å®ç°ç»†èŠ‚è¾ƒå¤šï¼Œä¸”å¸¸æ•°ä¸ä¸€å®šæ¯” HLD å°ã€‚
>
> 4.  **LCT**  
>     åŠ¨æ€æ ‘ç»“æ„ï¼Œæ”¯æŒ Link/Cutï¼Œä¹Ÿèƒ½åšå­æ ‘ä¿¡æ¯ç»´æŠ¤ï¼Œä½†ç é‡å¤§ã€å¸¸æ•°å¤§ï¼Œä¸€èˆ¬ç”¨äºæ›´å¤æ‚çš„åŠ¨æ€æ ‘åœºæ™¯ã€‚

### ğŸ” ç®—æ³•ä¾¦æ¢ï¼šå¦‚ä½•åœ¨é¢˜ç›®ä¸­å‘ç°çº¿ç´¢ï¼Ÿ
| çº¿ç´¢ | è¯´æ˜ |
|---|---|
| **æ ‘å½¢ç»“æ„** | â€œæ¯ä¸ªèŠ‚ç‚¹æœ‰çˆ¶èŠ‚ç‚¹â€ â†’ æ ‘å½¢ DPã€æ ‘é“¾å‰–åˆ†ã€æ¬§æ‹‰åºã€‚ |
| **è·¯å¾„ä¿®æ”¹** | â€œu-v è·¯å¾„åŠ  dâ€ â†’ éœ€è¦æŠŠè·¯å¾„æ‹†æˆè‹¥å¹²æ®µåŒºé—´ â†’ æ ‘é“¾å‰–åˆ†å¤©ç„¶æ”¯æŒã€‚ |
| **å­æ ‘æŸ¥è¯¢** | â€œä»¥ u ä¸ºæ ¹çš„å­æ ‘æ±‚å’Œâ€ â†’ DFS åºæŠŠå­æ ‘æ˜ å°„æˆè¿ç»­åŒºé—´ â†’ çº¿æ®µæ ‘/æ ‘çŠ¶æ•°ç»„åŒºé—´æŸ¥è¯¢ã€‚ |
| **æ•°æ®èŒƒå›´** | N, Q â‰¤ 1e5 â†’ O(N logÂ²N) å¯è¿‡ï¼ŒO(N logN) æ›´ä¼˜ã€‚ |

### ğŸ§  æ€ç»´é“¾æ„å»ºï¼šä»çº¿ç´¢åˆ°ç­–ç•¥
> 1.  çœ‹åˆ°â€œæ ‘ + è·¯å¾„/å­æ ‘æ“ä½œâ€ï¼Œç¬¬ä¸€ååº”ï¼š**æ ‘é“¾å‰–åˆ†**ã€‚  
> 2.  ç¡®è®¤æ•°æ®èŒƒå›´ 1e5ï¼Œæ ‘é“¾å‰–åˆ† O(Q logÂ²N) ç¨³è¿‡ã€‚  
> 3.  å¦‚æœè¿½æ±‚æé™æ€§èƒ½ï¼Œå¯å°è¯•â€œæ¬§æ‹‰åº+å·®åˆ†+æ ‘çŠ¶æ•°ç»„â€ O(Q logN)ã€‚  
> 4.  å¯¹äºç«èµ›ç°åœºï¼Œ**HLD + çº¿æ®µæ ‘** æ˜¯æœ€ç¨³å¦¥ã€æœ€æ˜“è°ƒè¯•çš„æ–¹æ¡ˆã€‚

---

## 2. ç²¾é€‰ä¼˜è´¨é¢˜è§£å‚è€ƒ

> æˆ‘ä» 20+ ä»½é¢˜è§£ä¸­ï¼ŒæŒ‰â€œæ€è·¯æ¸…æ™°ã€ä»£ç è§„èŒƒã€å¯å‘æ€§â€ç²¾é€‰äº† **3 ä»½** â‰¥4 æ˜Ÿé¢˜è§£ï¼Œä¾›å¤§å®¶å‚è€ƒã€‚

### é¢˜è§£ä¸€ï¼šchen_zheï¼ˆâ˜…â˜…â˜…â˜…â˜…ï¼‰
- **äº®ç‚¹**  
  1.  **åŒè§£æ³•å¯¹æ¯”**ï¼šç»™å‡ºâ€œå€å¢+LCA+çº¿æ®µæ ‘â€ä¸â€œæ ‘é“¾å‰–åˆ†+çº¿æ®µæ ‘â€ä¸¤ç§å®ç°ï¼Œå¹¶æŒ‡å‡ºå‰è€…åœ¨åŠ å¼ºæ•°æ®ä¸‹ä¼š TLEã€‚  
  2.  **ä»£ç ç®€æ´**ï¼šå®Œæ•´æ ‘é“¾å‰–åˆ†æ¨¡æ¿ï¼Œå˜é‡å‘½åæ¸…æ™°ã€‚  
  3.  **ç»†èŠ‚æç¤º**ï¼šæé†’â€œè¯»å…¥èŠ‚ç‚¹+1â€çš„å°æŠ€å·§ï¼Œé¿å… 0 å·æ ¹èŠ‚ç‚¹å¸¦æ¥çš„è¾¹ç•Œé—®é¢˜ã€‚

- **å­¦ä¹ ç¬”è®°**  
  > åœ¨æ ‘é“¾å‰–åˆ†ä¸­ï¼Œä¸¤æ¬¡ DFS æ˜¯å…³é”®ï¼šç¬¬ä¸€æ¬¡æ±‚ `size/son/dep/fa`ï¼Œç¬¬äºŒæ¬¡æ±‚ `top/dfn`ã€‚çº¿æ®µæ ‘åªéœ€æ”¯æŒåŒºé—´åŠ ã€åŒºé—´æ±‚å’Œå³å¯ã€‚

### é¢˜è§£äºŒï¼šSoledad_Sï¼ˆâ˜…â˜…â˜…â˜…â˜†ï¼‰
- **äº®ç‚¹**  
  1.  **ç†è®ºæœ€ä¼˜**ï¼šä½¿ç”¨â€œæ¬§æ‹‰åº + å·®åˆ† + ä¸¤ä¸ªæ ‘çŠ¶æ•°ç»„â€åšåˆ° O(Q logN)ã€‚  
  2.  **æ¨å¯¼è¯¦ç»†**ï¼šæŠŠå­æ ‘æ±‚å’Œå…¬å¼æ‹†æˆ `âˆ‘depÂ·tag - (dep[u]-1)Â·âˆ‘tag`ï¼Œå¹¶ç»™å‡ºè¯æ˜ã€‚  
  3.  **å¸¸æ•°åˆ†æ**ï¼šæŒ‡å‡ºâ€œç†è®ºæœ€ä¼˜â€åœ¨å®é™…è¯„æµ‹ä¸­å› å¸¸æ•°å¤§ï¼Œåè€Œè·‘ä¸è¿‡ HLDã€‚

- **å­¦ä¹ ç¬”è®°**  
  > æ¬§æ‹‰åºå·®åˆ†æ€è·¯ï¼šæŠŠâ€œå­æ ‘å’Œâ€è½¬åŒ–ä¸ºâ€œå‰ç¼€å’Œâ€ï¼Œç”¨ä¸¤ä¸ª BIT ç»´æŠ¤ `tag` ä¸ `depÂ·tag`ã€‚å…¬å¼æ¨å¯¼æ˜¯æ ¸å¿ƒéš¾ç‚¹ã€‚

### é¢˜è§£ä¸‰ï¼šrsdbk_huskyï¼ˆâ˜…â˜…â˜…â˜…ï¼‰
- **äº®ç‚¹**  
  1.  **å›¾è§£ DFS åº**ï¼šç”¨ä¸¤å¼  8-bit åƒç´ å›¾ç›´è§‚å±•ç¤ºâ€œæ ‘ â†’ DFS åº â†’ è¿ç»­åŒºé—´â€ã€‚  
  2.  **æ¨¡å—åŒ–å°è£…**ï¼šæŠŠâ€œæ ‘å‰–é¢„å¤„ç†â€ã€â€œçº¿æ®µæ ‘æ“ä½œâ€ã€â€œå­æ ‘/é“¾æ“ä½œâ€åˆ†åˆ«å†™æˆå‡½æ•°ï¼Œæ˜“è¯»æ˜“æ”¹ã€‚  
  3.  **å®å®šä¹‰æŠ€å·§**ï¼šç”¨å®ç®€åŒ– `ls/rs`ã€`push_up/down`ï¼Œé™ä½æ‰‹æ»‘æ¦‚ç‡ã€‚

- **å­¦ä¹ ç¬”è®°**  
  > ä¸€å¼ å¥½å›¾èƒœè¿‡åƒè¨€ä¸‡è¯­ã€‚ç”» DFS åºå›¾èƒ½å¸®åŠ©ä½ å¿«é€Ÿå®šä½â€œå­æ ‘åŒºé—´â€ä¸â€œé‡é“¾åŒºé—´â€ã€‚

---

## 3. è§£é¢˜ç­–ç•¥æ·±åº¦å‰–æ

### ğŸ¯ æ ¸å¿ƒéš¾ç‚¹ä¸å…³é”®æ­¥éª¤ï¼ˆæ ‘é“¾å‰–åˆ†ç‰ˆï¼‰

| å…³é”®ç‚¹ | åˆ†æ & å­¦ä¹ ç¬”è®° |
|---|---|
| **1. ä¸¤æ¬¡ DFS é¢„å¤„ç†** | **ç¬¬ä¸€æ¬¡ DFS**ï¼šæ±‚ `size[u]`ã€`son[u]`ï¼ˆé‡å„¿å­ï¼‰ã€`dep[u]`ã€`fa[u]`ã€‚<br>**ç¬¬äºŒæ¬¡ DFS**ï¼šæ±‚ `top[u]`ï¼ˆé“¾é¡¶ï¼‰ã€`dfn[u]`ï¼ˆDFS åºï¼‰ï¼Œä¿è¯æ¯æ¡é‡é“¾ DFS åºè¿ç»­ã€‚<br>ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼š`son[u]` æ˜¯å­æ ‘æœ€å¤§çš„å„¿å­ï¼›`top[u]` æ²¿é‡é“¾å‘ä¸Šè·³æ—¶çš„é“¾é¡¶ã€‚ |
| **2. çº¿æ®µæ ‘åŒºé—´æ˜ å°„** | å­æ ‘ `u` å¯¹åº”åŒºé—´ `[dfn[u], dfn[u]+size[u]-1]`ã€‚<br>è·¯å¾„ `u-v` è¢«æ‹†æˆ â‰¤logN æ®µåŒºé—´ï¼Œæ¯æ®µå¯¹åº”ä¸€æ¡é‡é“¾ã€‚<br>ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šDFS åºæŠŠâ€œæ ‘å½¢é—®é¢˜â€è½¬åŒ–ä¸ºâ€œåºåˆ—é—®é¢˜â€ã€‚ |
| **3. æ‡’æ ‡è®°ä¸‹ä¼ ** | åŒºé—´åŠ  `add(l,r,d)` æ—¶ï¼Œçº¿æ®µæ ‘èŠ‚ç‚¹éœ€ä¸‹ä¼  `lazy` å¹¶ä¹˜åŒºé—´é•¿åº¦ã€‚<br>ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼š`push_down` ä¸è¦å¿˜è®°ä¹˜ `(r-l+1)`ï¼Œå¦åˆ™æ±‚å’Œä¼šå°‘ç®—ã€‚ |

### âš”ï¸ ç­–ç•¥ç«æŠ€åœºï¼šä¸åŒè§£æ³•å¯¹æ¯”

| ç­–ç•¥ | æ ¸å¿ƒæ€æƒ³ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ / å¾—åˆ† |
|---|---|---|---|---|
| **æš´åŠ›æ¨¡æ‹Ÿ** | ç›´æ¥éå†æ ‘ | æ€è·¯ç›´è§‚ | O(QÂ·N) å¿… TLE | Nâ‰¤1e3 éª—åˆ† |
| **æ¬§æ‹‰åºå·®åˆ† + BIT** | æ¬§æ‹‰åºå‰ç¼€å’Œ + ä¸¤ä¸ª BIT | O(Q logN) ç†è®ºæœ€ä¼˜ | æ¨å¯¼å¤æ‚ï¼Œå¸¸æ•°å¤§ | å¡å¸¸é«˜æ‰‹ |
| **æ ‘é“¾å‰–åˆ† + çº¿æ®µæ ‘** | HLD æ‹†é“¾ + çº¿æ®µæ ‘ | O(Q logÂ²N) ç¨³è¿‡ | ä»£ç è¾ƒé•¿ | çœé€‰/NOI æ ‡å‡† |
| **LCT** | åŠ¨æ€æ ‘ Splay ç»´æŠ¤ | æ”¯æŒ Link/Cut | ç é‡å¤§ï¼Œå¸¸æ•°å¤§ | åŠ¨æ€æ ‘é—®é¢˜ |

### âœ¨ ä¼˜åŒ–ä¹‹æ—…ï¼šä»â€œèƒ½åšâ€åˆ°â€œåšå¥½â€
> 1.  **èµ·æ­¥**ï¼šæš´åŠ› DFS â†’ å‘ç° TLEã€‚  
> 2.  **ç“¶é¢ˆ**ï¼šæ ‘å½¢ç»“æ„æ— æ³•ç”¨æ™®é€šåŒºé—´æ•°æ®ç»“æ„ã€‚  
> 3.  **è½¬åŒ–**ï¼šDFS åºæŠŠæ ‘æ‹å¹³ â†’ åŒºé—´æ•°æ®ç»“æ„å¯ç”¨ã€‚  
> 4.  **åŠ é€Ÿ**ï¼šé‡é“¾å‰–åˆ†å‡å°‘åŒºé—´æ®µæ•° â†’ logÂ²Nã€‚  
> 5.  **æé™**ï¼šæ¬§æ‹‰åºå·®åˆ†å†é™ä¸€ log â†’ logNã€‚  

---

## 4. C++æ ¸å¿ƒä»£ç å®ç°èµæ

### æœ¬é¢˜é€šç”¨æ ¸å¿ƒC++å®ç°å‚è€ƒï¼ˆæ ‘é“¾å‰–åˆ†+çº¿æ®µæ ‘ï¼‰
```cpp
#include <bits/stdc++.h>
using namespace std;
using int64 = long long;
const int MAXN = 1e5 + 5;

/* ===== æ ‘é“¾å‰–åˆ†æ¨¡æ¿ ===== */
int n, q;
vector<int> G[MAXN];
int fa[MAXN], dep[MAXN], siz[MAXN], son[MAXN], top[MAXN], dfn[MAXN], rnk[MAXN], cnt;

void dfs1(int u, int f) {
    fa[u] = f; dep[u] = dep[f] + 1; siz[u] = 1; son[u] = 0;
    for (int v : G[u]) if (v != f) {
        dfs1(v, u);
        siz[u] += siz[v];
        if (siz[v] > siz[son[u]]) son[u] = v;
    }
}
void dfs2(int u, int tp) {
    top[u] = tp; dfn[u] = ++cnt; rnk[cnt] = u;
    if (son[u]) dfs2(son[u], tp);
    for (int v : G[u]) if (v != fa[u] && v != son[u]) dfs2(v, v);
}

/* ===== çº¿æ®µæ ‘ï¼šåŒºé—´åŠ  + åŒºé—´æ±‚å’Œ ===== */
int64 sum[MAXN << 2], tag[MAXN << 2];
inline int ls(int p) { return p << 1; }
inline int rs(int p) { return p << 1 | 1; }
void build(int p, int l, int r) {
    sum[p] = tag[p] = 0;
    if (l == r) return;
    int mid = (l + r) >> 1;
    build(ls(p), l, mid); build(rs(p), mid + 1, r);
}
inline void push_down(int p, int l, int r) {
    if (!tag[p]) return;
    int mid = (l + r) >> 1;
    int lenL = mid - l + 1, lenR = r - mid;
    sum[ls(p)] += tag[p] * lenL; tag[ls(p)] += tag[p];
    sum[rs(p)] += tag[p] * lenR; tag[rs(p)] += tag[p];
    tag[p] = 0;
}
void range_add(int p, int l, int r, int L, int R, int64 val) {
    if (L <= l && r <= R) { sum[p] += val * (r - l + 1); tag[p] += val; return; }
    push_down(p, l, r);
    int mid = (l + r) >> 1;
    if (L <= mid) range_add(ls(p), l, mid, L, R, val);
    if (R > mid)  range_add(rs(p), mid + 1, r, L, R, val);
    sum[p] = sum[ls(p)] + sum[rs(p)];
}
int64 range_sum(int p, int l, int r, int L, int R) {
    if (L <= l && r <= R) return sum[p];
    push_down(p, l, r);
    int mid = (l + r) >> 1; int64 res = 0;
    if (L <= mid) res += range_sum(ls(p), l, mid, L, R);
    if (R > mid)  res += range_sum(rs(p), mid + 1, r, L, R);
    return res;
}

/* ===== è·¯å¾„ä¿®æ”¹ & å­æ ‘æŸ¥è¯¢ ===== */
void path_add(int u, int v, int64 d) {
    while (top[u] != top[v]) {
        if (dep[top[u]] < dep[top[v]]) swap(u, v);
        range_add(1, 1, n, dfn[top[u]], dfn[u], d);
        u = fa[top[u]];
    }
    if (dep[u] > dep[v]) swap(u, v);
    range_add(1, 1, n, dfn[u], dfn[v], d);
}
int64 subtree_sum(int u) {
    return range_sum(1, 1, n, dfn[u], dfn[u] + siz[u] - 1);
}

/* ===== ä¸»ç¨‹åº ===== */
int main() {
    ios::sync_with_stdio(false);
    cin.tie(nullptr);
    cin >> n;
    for (int i = 1, u, v; i < n; ++i) {
        cin >> u >> v; ++u; ++v;  // é¢˜ç›®èŠ‚ç‚¹ä»0å¼€å§‹ï¼Œç»Ÿä¸€+1
        G[u].push_back(v); G[v].push_back(u);
    }
    dfs1(1, 0); dfs2(1, 1);
    build(1, 1, n);
    cin >> q;
    while (q--) {
        char op; int u, v, d;
        cin >> op;
        if (op == 'A') {
            cin >> u >> v >> d; ++u; ++v;
            path_add(u, v, d);
        } else {
            cin >> u; ++u;
            cout << subtree_sum(u) << '\n';
        }
    }
    return 0;
}
```

---

## 5. ç®—æ³•å¯è§†åŒ–ï¼šåƒç´ åŠ¨ç”»æ¼”ç¤º

### ğŸ® åŠ¨ç”»ä¸»é¢˜
**â€œåƒç´ æ¢é™©å®¶â€åœ¨ 8-bit æ ‘ä¸Šæ—…è¡Œï¼šç”¨é‡é“¾å‰–åˆ†ç‚¹äº®æ•´æ£µæ ‘ï¼**

### ğŸ¯ æ ¸å¿ƒæ¼”ç¤ºå†…å®¹
1.  **åœºæ™¯åˆå§‹åŒ–**ï¼š  
    ä¸€æ£µ 8Ã—8 åƒç´ çš„æ ‘ï¼Œæ ¹èŠ‚ç‚¹åœ¨å·¦ä¸Šè§’ã€‚æ¯ä¸ªèŠ‚ç‚¹æ˜¯ 8Ã—8 åƒç´ æ–¹å—ï¼Œé‡è¾¹ç”¨çº¢è‰²ï¼Œè½»è¾¹ç”¨ç°è‰²ã€‚  
    å³ä¾§æ”¾ç½® 8-bit é£æ ¼æ§åˆ¶é¢æ¿ï¼š  
    - å•æ­¥/è‡ªåŠ¨/é‡ç½®æŒ‰é’®  
    - é€Ÿåº¦æ»‘å—ï¼ˆ1-10 å¸§/ç§’ï¼‰  
    - å½“å‰æ“ä½œæç¤ºï¼ˆ`A u v d` / `Q u`ï¼‰

2.  **ä¸¤æ¬¡ DFS åƒç´ åŠ¨ç”»**ï¼š
    - **DFS1**ï¼šåƒç´ å°äººä»æ ¹å‡ºå‘ï¼Œå‘ä¸‹é€’å½’ï¼Œæ¯è®¿é—®ä¸€ä¸ªèŠ‚ç‚¹ï¼Œæ–¹å—é—ªç»¿å…‰ï¼Œæ˜¾ç¤º `size/son/dep`ã€‚  
    - **DFS2**ï¼šå°äººæ²¿é‡é“¾å¿«é€Ÿå¥”è·‘ï¼Œé‡é“¾èŠ‚ç‚¹ä¾æ¬¡ç‚¹äº®é»„è‰²ï¼ŒDFS åºå· `dfn` åœ¨æ–¹å—é¡¶éƒ¨æ»šåŠ¨ã€‚

3.  **çº¿æ®µæ ‘åŒºé—´æ“ä½œ**ï¼š
    - **è·¯å¾„åŠ  `A u v d`**ï¼š  
      1. å°äººä» `u` å’Œ `v` åŒæ—¶å‘ä¸Šè·³ï¼Œæ¯è·³ä¸€æ¡é‡é“¾ï¼Œè¯¥é“¾åŒºé—´åœ¨åƒç´ çº¿æ®µæ ‘ï¼ˆä¸‹æ–¹ 1Ã—N åƒç´ æ¡ï¼‰ä¸Šé«˜äº®ç»¿è‰²ï¼Œå¹¶æ’­æ”¾â€œå®â€éŸ³æ•ˆã€‚  
      2. çº¿æ®µæ ‘åŒºé—´æ•´ä½“é—ªè“ï¼Œè¡¨ç¤ºåŒºé—´åŠ  `d`ã€‚  
    - **å­æ ‘æ±‚å’Œ `Q u`**ï¼š  
      å­æ ‘åŒºé—´ `[dfn[u], dfn[u]+size[u]-1]` åœ¨çº¿æ®µæ ‘æ¡ä¸Šé—ªç´«ï¼Œåƒç´ å°äººä» `u` å‘ä¸‹éå†å­æ ‘ï¼Œæ¯ç»è¿‡ä¸€ä¸ªèŠ‚ç‚¹å¼¹å‡ºâ€œ+dâ€æ°”æ³¡ï¼Œæœ€åå¼¹å‡ºæ€»å’Œã€‚

4.  **éŸ³æ•ˆä¸è¿‡å…³**ï¼š
    - æ¯æ¬¡æ“ä½œæ­£ç¡®å®Œæˆæ’­æ”¾ 8-bit â€œèƒœåˆ©â€éŸ³é˜¶ã€‚  
    - è¿ç»­æ­£ç¡® 5 æ¬¡è§¦å‘â€œåƒç´ ç¤¼èŠ±â€åŠ¨ç”»ã€‚

---

## 6. æ‹“å±•ç»ƒä¹ ä¸ç›¸ä¼¼é—®é¢˜æ€è€ƒ

### é€šç”¨æ€è·¯è¿ç§»
æ ‘é“¾å‰–åˆ†ä¸ä»…èƒ½åšâ€œè·¯å¾„åŠ ã€å­æ ‘æ±‚å’Œâ€ï¼Œè¿˜èƒ½è§£å†³ï¼š
1.  **è·¯å¾„æœ€å¤§å€¼/æœ€å°å€¼**ï¼ˆçº¿æ®µæ ‘ç»´æŠ¤ max/minï¼‰ã€‚  
2.  **å­æ ‘ä¿®æ”¹ + å•ç‚¹æŸ¥è¯¢**ï¼ˆæŠŠå­æ ‘åŒºé—´æ‰“æ‡’æ ‡è®°ï¼‰ã€‚  
3.  **åŠ¨æ€æ¢æ ¹**ï¼ˆé€šè¿‡é‡å®šä¹‰â€œå­æ ‘åŒºé—´â€å®ç°ï¼‰ã€‚  

### æ´›è°·æ¨èç»ƒä¹ 
| é¢˜å· | æ¨èç†ç”± |
|---|---|
| **P3384** ã€æ¨¡æ¿ã€‘æ ‘é“¾å‰–åˆ† | æ ‘å‰–è£¸é¢˜ï¼Œç»ƒæ‰‹å¿…å¤‡ã€‚ |
| **P3178** [HAOI2015] æ ‘ä¸Šæ“ä½œ | å­æ ‘ä¿®æ”¹ + è·¯å¾„æŸ¥è¯¢ï¼Œå·©å›ºåŒºé—´æ˜ å°„ã€‚ |
| **P2590** [ZJOI2008] æ ‘çš„ç»Ÿè®¡ | è·¯å¾„ max/sum ç»¼åˆï¼Œå¼ºåŒ–çº¿æ®µæ ‘æŠ€å·§ã€‚ |

---

## 7. å­¦ä¹ å¿ƒå¾—ä¸ç»éªŒåˆ†äº«
> æ¥è‡ª **chen_zhe**ï¼š  
> â€œç¬¬ä¸€æ¬¡å†™æ ‘å‰–æ—¶æŠŠ `dfn` å’Œ `rnk` æåï¼Œè°ƒè¯•ä¸€ä¸‹åˆã€‚ç”» DFS åºå›¾åè±ç„¶å¼€æœ—ï¼šâ€˜åŸæ¥å­æ ‘å°±æ˜¯ä¸€æ®µè¿ç»­åŒºé—´ï¼â€™â€  
> **æ´›è¯­äº‘ç¬ºç‚¹è¯„**ï¼šåŠ¨æ‰‹ç”»å›¾æ˜¯è°ƒè¯•æ ‘å‰–çš„åˆ©å™¨ï¼ŒæŠŠæŠ½è±¡çš„â€œæ ‘â€å˜æˆå¯è§çš„â€œåºåˆ—â€ï¼Œé—®é¢˜è¿åˆƒè€Œè§£ã€‚

---

### ğŸŒ± ç»“è¯­
ä»æš´åŠ› DFS åˆ°æ ‘é“¾å‰–åˆ†ï¼Œæˆ‘ä»¬å®Œæˆäº†ä¸€æ¬¡â€œæ ‘â†’åºåˆ—â€çš„æ€ç»´è·ƒè¿ã€‚å¸Œæœ›è¿™ä»½æŒ‡å—èƒ½å¸®åŠ©ä½ åœ¨æ ‘ä¸Šè‡ªç”±é©°éª‹ï¼Œä¸‹æ¬¡è§ï¼

---
å¤„ç†ç”¨æ—¶ï¼š162.29ç§’
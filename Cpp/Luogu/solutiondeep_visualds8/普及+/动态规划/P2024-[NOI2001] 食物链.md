# 题目信息

# [NOI2001] 食物链

## 题目描述

动物王国中有三类动物 $A,B,C$，这三类动物的食物链构成了有趣的环形。$A$ 吃 $B$，$B$ 吃 $C$，$C$ 吃 $A$。

现有 $N$ 个动物，以 $1 \sim N$ 编号。每个动物都是 $A,B,C$ 中的一种，但是我们并不知道它到底是哪一种。

有人用两种说法对这 $N$ 个动物所构成的食物链关系进行描述：

- 第一种说法是 `1 X Y`，表示 $X$ 和 $Y$ 是同类。
- 第二种说法是`2 X Y`，表示 $X$ 吃 $Y$。

此人对 $N$ 个动物，用上述两种说法，一句接一句地说出 $K$ 句话，这 $K$ 句话有的是真的，有的是假的。当一句话满足下列三条之一时，这句话就是假话，否则就是真话。

- 当前的话与前面的某些真的话冲突，就是假话；
- 当前的话中 $X$ 或 $Y$ 比 $N$ 大，就是假话；
- 当前的话表示 $X$ 吃 $X$，就是假话。

你的任务是根据给定的 $N$ 和 $K$ 句话，输出假话的总数。


## 说明/提示

对于全部数据，$1\le N\le 5 \times 10^4$，$1\le K \le 10^5$。


## 样例 #1

### 输入

```
100 7
1 101 1
2 1 2
2 2 3
2 3 3
1 1 3
2 3 1
1 5 5
```

### 输出

```
3
```

# AI分析结果

---
# 💡 洛语云笺的C++算法解析：食物链 深入学习指南 💡

今天我们来一起分析“食物链”这道经典 NOIP/NOI 题目。它不仅考察并查集，更考验如何把“环状捕食关系”抽象成数据结构。跟着洛语云笺，像侦探一样寻找线索，像探险家一样找到最优路径！

---

## 1. 题目解读与策略初探

✨ **本题核心挑战**  
如何在不知道动物具体种类的前提下，利用给出的“同类”或“捕食”关系，快速判定每条语句的真假？关键在于**维护动物之间的“相对关系”**，而不是绝对种类。

✨ **核心算法标签**  
并查集（Disjoint Set Union，DSU）  
- 变种 1：扩展域并查集（三倍空间）  
- 变种 2：带权并查集（边权表示相对关系）

---

### 🔍 算法侦探：如何在题目中发现线索？

| 线索 | 发现与分析 |
| --- | --- |
| **问题目标** | 输出假话总数 → **需要快速判定冲突** |
| **关系种类** | 同类、捕食、被捕食 → **3 种互斥关系** |
| **数据范围** | N ≤ 5×10⁴，K ≤ 1×10⁵ → **O(K α(N)) 可行** |
| **冲突判定** | 如果已知 A 吃 B，又出现 A 与 B 同类 → **假话** |

---

### 🧠 思维链构建：从线索到策略

1. 看到“关系”与“冲突”，先想到 **并查集** 维护连通性。  
2. 但捕食关系是 **有向的环状结构**，普通并查集无法直接表达。  
3. 于是诞生两种经典建模：  
   - **扩展域**：把每个动物拆成 3 个节点（同类域、捕食域、天敌域）。  
   - **带权并查集**：用 0/1/2 边权表示“同类/捕食/被捕食”。  
4. 两种方法都把“关系”转化为“连通性”问题，从而可用并查集 **O(K α(N))** 解决。

---

## 2. 精选优质题解参考

### 题解一：Sooke（赞 2069）——扩展域并查集启蒙
- **亮点**：用 3n 个节点分别表示“同类/猎物/天敌”，把捕食关系拆成三类合并。  
- **关键技巧**：  
  - 同类语句：合并 x↔y，x+n↔y+n，x+2n↔y+2n。  
  - 捕食语句：合并 x↔y+2n，x+n↔y，x+2n↔y+n。  
- **学习笔记**：扩展域思想把“复杂关系”降维成“连通性”，直观易实现。

### 题解二：天泽龟（赞 230）——带权并查集详解
- **亮点**：用 0/1/2 权值表示“同类/捕食/被捕食”，路径压缩时动态维护权值。  
- **关键技巧**：  
  - 权值转移公式：`d[root] = (d[y] - d[x] + op + 3) % 3`。  
  - 判断冲突：同根节点时检查 `(d[x] - d[y] + 3) % 3 != op`。  
- **学习笔记**：带权并查集代码更短，但推导公式需严谨。

---

## 3. 解题策略深度剖析

### 🎯 核心难点与关键步骤

| 步骤 | 扩展域法 | 带权法 |
| --- | --- | --- |
| **初始化** | 开 3n 父数组，fa[i]=i | 开 n 父数组 + n 权数组 |
| **同类语句** | 合并三组节点 | 权值差为 0 |
| **捕食语句** | 合并三组跨域节点 | 权值差为 1 |
| **冲突检查** | 检查是否已处捕食/天敌域 | 检查 `(d[x]-d[y]+3)%3` |

### ✨ 解题技巧总结

- **关系建模**：把“关系”映射成“连通”或“权值差”。  
- **模 3 运算**：利用环形捕食关系 `A→B→C→A` 只有 3 种状态。  
- **路径压缩**：无论哪种方法，都要保证 `find` 时信息不丢失。

---

### ⚔️ 策略竞技场

| 策略 | 时间复杂度 | 优点 | 缺点 |
| --- | --- | --- | --- |
| **扩展域** | O(K α(N)) | 思路直观，无需公式推导 | 空间 ×3 |
| **带权并查集** | O(K α(N)) | 空间省，代码短 | 权值推导需严谨 |
| **暴力枚举** | O(K·N) | 无 | 超时 |

---

### ✨ 优化之旅
1. **朴素想法**：暴力枚举每条语句与之前所有语句检查冲突 → TLE。  
2. **优化思路**：发现关系具有**传递性**，可用并查集维护。  
3. **最终形态**：扩展域或带权并查集，均达到 **O(K α(N))** 近乎线性。

---

## 4. C++核心代码实现赏析

### 通用核心实现（扩展域法）

```cpp
#include <cstdio>
const int MAX = 150005;
int fa[MAX], n, k, ans;

int find(int x) {
    return x == fa[x] ? x : fa[x] = find(fa[x]);
}

int main() {
    scanf("%d%d", &n, &k);
    for (int i = 1; i <= 3 * n; ++i) fa[i] = i;
    while (k--) {
        int d, x, y;
        scanf("%d%d%d", &d, &x, &y);
        if (x > n || y > n) { ++ans; continue; }
        if (d == 1) {
            if (find(x + n) == find(y) || find(x + 2 * n) == find(y))
                ++ans;
            else {
                fa[find(x)] = find(y);
                fa[find(x + n)] = find(y + n);
                fa[find(x + 2 * n)] = find(y + 2 * n);
            }
        } else {
            if (x == y || find(x) == find(y) || find(x + 2 * n) == find(y))
                ++ans;
            else {
                fa[find(x)] = find(y + 2 * n);
                fa[find(x + n)] = find(y);
                fa[find(x + 2 * n)] = find(y + n);
            }
        }
    }
    printf("%d\n", ans);
    return 0;
}
```

### 带权并查集片段（天泽龟版）

```cpp
int find(int x) {
    if (x != fa[x]) {
        int root = find(fa[x]);
        rel[x] = (rel[x] + rel[fa[x]]) % 3;
        fa[x] = root;
    }
    return fa[x];
}
void merge(int x, int y, int op) {
    int fx = find(x), fy = find(y);
    if (fx == fy) return;
    fa[fx] = fy;
    rel[fx] = (rel[y] - rel[x] + op + 3) % 3;
}
```

---

## 5. 算法可视化：像素动画演示

### 场景主题
**像素动物园**——8 位像素风格，三条食物链轨道循环。

### 可视化元素
- 动物：像素小鸡/老虎/鲨鱼图标。  
- 关系：  
  - 同类 → 同颜色方块连线。  
  - 捕食 → 箭头动画 + “叮”音效。  
- 控制面板：  
  - “单步”按钮：逐条语句执行。  
  - “AI 自动”：自动播放，速度可调。  
- 冲突提示：红色闪烁 + “警告”音效。

### 关键帧示例
1. **初始化**：3n 个像素节点排成三排。  
2. **同类语句**：三排同时出现同色连线。  
3. **捕食语句**：箭头从捕食者指向被捕食者，循环一圈验证 A→B→C→A。  
4. **冲突检测**：出现红色叉号，计数器 +1。  

---

## 6. 拓展练习与相似问题思考

### 通用思路迁移
- **P1525 关押罪犯**：把“敌人”关系用扩展域或带权并查集维护。  
- **P1196 银河英雄传说**：带权并查集维护战舰相对位置。  
- **P2023 食物链加强版**：允许查询任意两动物的关系。

### 洛谷推荐
| 题号 | 推荐理由 |
| --- | --- |
| P1525 | 同类扩展域思想，敌人=对立集合 |
| P1196 | 带权并查集经典，距离权值 |
| P2023 | 本题加强版，需输出具体关系 |

---

## 7. 学习心得与经验分享

- **Sooke**：  
  “扩展域思想把复杂关系拆成连通性，画图理解非常直观。”  
- **天泽龟**：  
  “带权并查集公式推导时，务必注意模 3 和负数处理，调试可打印 `rel` 数组。”  

---

<conclusion>
恭喜完成本次食物链探险！你学会了如何：  
1. 把“关系”抽象成数据结构。  
2. 用扩展域或带权并查集高效维护环状关系。  
3. 通过可视化加深对算法流程的理解。  
继续挑战下一道题，成为真正的算法探险家！
</conclusion>

---
处理用时：59.42秒
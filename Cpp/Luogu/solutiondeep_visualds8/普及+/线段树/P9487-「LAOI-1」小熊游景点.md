# é¢˜ç›®ä¿¡æ¯

# ã€ŒLAOI-1ã€å°ç†Šæ¸¸æ™¯ç‚¹

## é¢˜ç›®æè¿°

å°ç†Šçš„åœ°å›¾ä¸Šæœ‰ $n$ ä¸ªæ™¯ç‚¹ï¼Œæ¯ä¸ªæ™¯ç‚¹æœ‰åˆ†æ•° $s_i$ã€‚

$n-1$ ä¸ªç‚¹å¯¹ä¹‹é—´æœ‰åŒå‘ç›´è¾¾çš„å…¬äº¤çº¿è·¯ï¼Œæ¯æ¡çº¿è·¯æœ‰æ”¶è´¹ $w_i$ã€‚

ç°åœ¨å°ç†Šåœ¨ $a$ æ™¯ç‚¹ï¼Œæ€»å¸ä»¤åœ¨ $b$ æ™¯ç‚¹ï¼Œä»–ä»¬è¦**æ²¿ç®€å•è·¯å¾„**åœ¨ $a\to b$ è·¯å¾„ä¸Šçš„ $p$ æ™¯ç‚¹æ±‡åˆï¼Œç„¶å**æ²¿ç®€å•è·¯å¾„**ä¸€èµ·å» $q$ æ™¯ç‚¹ã€‚ï¼ˆ$q$ ä¸ºä»»æ„ç‚¹ï¼Œæ¯ä¸ªäººä¸ä¼šæ¸¸è§ˆä¸¤æ¬¡ $p$ æ™¯ç‚¹ï¼‰

$m$ æ¬¡è¯¢é—®ï¼Œç»™å®š $a,b$ï¼Œæ±‚ $p,q$ï¼Œä½¿å¾—å°ç†Šå’Œæ€»å¸ä»¤èŠ±è´¹ä¹‹å’Œæœ€å°çš„å‰æä¸‹ä»–ä»¬ç»è¿‡çš„æ™¯ç‚¹åˆ†æ•°ä¹‹å’Œæœ€å¤§ï¼Œè¾“å‡ºä»–ä»¬ç»è¿‡çš„æ™¯ç‚¹åˆ†æ•°ä¹‹å’Œã€‚ï¼ˆæŒ‡å°ç†Šç»è¿‡çš„æ™¯ç‚¹åˆ†æ•°ä¹‹å’Œ $+$ æ€»å¸ä»¤ç»è¿‡çš„æ™¯ç‚¹åˆ†æ•°ä¹‹å’Œï¼‰

**é‡å¤ç»è¿‡çš„çº¿è·¯æ”¶è´¹é‡å¤è®¡ç®—ï¼Œé‡å¤ç»è¿‡çš„æ™¯ç‚¹åˆ†æ•°é‡å¤è®¡ç®—ã€‚**

## è¯´æ˜/æç¤º

### æ ·ä¾‹è¯´æ˜
å¯¹äºç¬¬ä¸€ç»„æ ·ä¾‹ï¼Œå°ç†Šçš„åœ°å›¾å¦‚å›¾æ‰€ç¤ºï¼š

![](https://cdn.luogu.com.cn/upload/image_hosting/ktyzyrx7.png)

å…¶ä¸­ $a=4,b=7$ï¼Œä»¤ $p=3,q=6$ã€‚

å°ç†Šçš„è·¯å¾„ä¸º $4\to2\to1\to3\to6$ï¼ŒèŠ±è´¹ä¹‹å’Œä¸º $1+3+6+(-4)=6$ï¼Œæ™¯ç‚¹åˆ†æ•°ä¹‹å’Œä¸º $1+1+1+1+1=5$ã€‚

æ€»å¸ä»¤çš„è·¯å¾„ä¸º $7\to3\to6$ï¼ŒèŠ±è´¹ä¹‹å’Œä¸º $5+(-4)=1$ï¼Œæ™¯ç‚¹åˆ†æ•°ä¹‹å’Œä¸º $1+1+1=3$ã€‚

å°ç†Šå’Œæ€»å¸ä»¤èŠ±è´¹ä¹‹å’Œä¸º $6+1=7$ï¼Œç»è¿‡çš„æ™¯ç‚¹åˆ†æ•°ä¹‹å’Œä¸º $5+3=8$ã€‚

å¯ä»¥è¯æ˜æ­¤æ—¶å°ç†Šå’Œæ€»å¸ä»¤èŠ±è´¹ä¹‹å’Œæœ€å°çš„å‰æä¸‹ä»–ä»¬ç»è¿‡çš„æ™¯ç‚¹åˆ†æ•°ä¹‹å’Œæœ€å¤§ã€‚

------------

### æ•°æ®èŒƒå›´
**æœ¬é¢˜é‡‡ç”¨æ†ç»‘æµ‹è¯•ã€‚**

| Subtask | $n,m$ | $s_i,w_i$ | ç‰¹æ®Šæ€§è´¨ | åˆ†æ•° |
| :----------: | :----------: | :----------: | :----------: | :----------: |
| $1$ | $=3\times10^5$ | $\in\lbrack0,10^6\rbrack$ | æ—  | $10$ |
| $2$ | $=3\times10^5$ | $\in\lbrack-10^6,10^6\rbrack$ | å°ç†Šçš„åœ°å›¾æ˜¯ä¸€æ¡é“¾ | $10$ |
| $3$ | $=3\times10^2$ | $\in\lbrack-10^6,10^6\rbrack$ | æ—  | $5$ |
| $4$ | $=3\times10^3$ | $\in\lbrack-10^6,10^6\rbrack$ | æ—  | $15$ |
| $5$ | $\le 3\times10^5$ | $\in\lbrack-10^6,10^6\rbrack$ | æ—  | $60$ |

å¯¹äº $100\%$ çš„æ•°æ®ï¼Œ$1\le n,m\le 3\times 10^5$ï¼Œ$\vert s_i\vert,\vert w_i\vert\le10^6$ï¼Œå°ç†Šçš„åœ°å›¾æ˜¯ä¸€æ£µæ ‘ã€‚

ï¼ˆå°ç†Šéƒ½å¯ä»¥æ¸¸è§ˆæ™¯ç‚¹äº†ï¼Œå…¬äº¤ä»·æ ¼å’Œæ™¯ç‚¹åˆ†æ•°æ€ä¹ˆä¸å¯ä»¥æ˜¯è´Ÿæ•°å‘¢ï¼Ÿï¼‰

## æ ·ä¾‹ #1

### è¾“å…¥

```
7 1
1 1 1 1 1 1 1
1 2 3
3 6 -4
2 5 2
1 3 6
2 4 1
3 7 5
4 7```

### è¾“å‡º

```
8```

## æ ·ä¾‹ #2

### è¾“å…¥

```
10 10
786755 -687509 368192 154769 647117 -713535 337677 913223 -389809 -824004 
1 2 -785875
1 3 -77082
1 4 -973070
3 5 -97388
2 6 -112274
3 7 657757
4 8 741733
3 9 5656
4 10 -35190
3 3
3 10
7 3
5 1
2 10
10 10
1 6
7 2
8 9
9 1
```

### è¾“å‡º

```
971424
-1257332
1309101
3420605
-2313033
-2567048
-2467802
352646
759321
1368370
```

# AIåˆ†æç»“æœ

```markdown
# ğŸ’¡ æ´›è¯­äº‘ç¬ºçš„C++ç®—æ³•è§£æï¼šã€ŒLAOI-1ã€å°ç†Šæ¸¸æ™¯ç‚¹ æ·±å…¥å­¦ä¹ æŒ‡å— ğŸ’¡

> æ¬¢è¿æ¥åˆ°ä»Šå¤©çš„ç®—æ³•æ¢é™©ï¼ä»Šå¤©æˆ‘ä»¬è¦ä¸€èµ·æŒ‘æˆ˜çš„æ˜¯ä¸€é“**æ ‘ä¸ŠåŒå…³é”®å­—æœ€ä¼˜è·¯å¾„é—®é¢˜**ã€‚é¢˜ç›®çœ‹èµ·æ¥æœ‰ç‚¹ç»•ï¼Œä½†åªè¦æˆ‘ä»¬åƒä¾¦æ¢ä¸€æ ·æŠ“ä½å…³é”®çº¿ç´¢ï¼Œå°±èƒ½æŠŠå¤æ‚çš„é—®é¢˜ä¸€æ­¥æ­¥æ‹†è§£ã€‚

---

## 1. é¢˜ç›®è§£è¯»ä¸ç­–ç•¥åˆæ¢

âœ¨ **æœ¬é¢˜æ ¸å¿ƒæŒ‘æˆ˜**ï¼šåœ¨æ ‘ä¸Šæ‰¾åˆ°ä¸¤ä¸ªæ±‡åˆç‚¹ `p` å’Œ `q`ï¼Œä½¿å¾—ä¸¤æ¡è·¯å¾„ï¼ˆå°ç†Š `aâ†’pâ†’q` å’Œæ€»å¸ä»¤ `bâ†’pâ†’q`ï¼‰çš„**æ€»èŠ±è´¹æœ€å°**ï¼Œåœ¨æ­¤åŸºç¡€ä¸Š**æ€»æ™¯ç‚¹åˆ†æ•°æœ€å¤§**ã€‚  
âœ¨ **æ ¸å¿ƒç®—æ³•æ ‡ç­¾**ï¼š`æ ‘å½¢DP` `æ¢æ ¹DP` `æ ‘ä¸Šå€å¢` `LCA`

ğŸ—£ï¸ **åˆæ­¥åˆ†æ**ï¼š  
è¿™é“é¢˜çš„æœ¬è´¨æ˜¯ä¸€ä¸ª**åŒå…³é”®å­—æœ€ä¼˜åŒ–é—®é¢˜**ï¼Œéœ€è¦åœ¨æ ‘ä¸ŠåŒæ—¶å¤„ç†**è·¯å¾„é•¿åº¦**å’Œ**è·¯å¾„æƒå€¼**ä¸¤ä¸ªæŒ‡æ ‡ã€‚  
æˆ‘ä»¬çš„ç›®æ ‡æ˜¯**å›ºå®šè·¯å¾„ç»“æ„**ï¼ˆ`aâ†’b` å¿…ç»ï¼‰ï¼Œç„¶ååœ¨æ­¤åŸºç¡€ä¸Šæ‰¾åˆ°ä¸€ä¸ªâ€œåˆ†æ”¯ç‚¹â€ `p` å’Œâ€œå»¶ä¼¸ç‚¹â€ `q`ï¼Œä½¿å¾—ä» `p` å‡ºå‘çš„â€œé¢å¤–è·¯å¾„â€æœ€ä¼˜ã€‚

### ğŸ” ç®—æ³•ä¾¦æ¢ï¼šå¦‚ä½•åœ¨é¢˜ç›®ä¸­å‘ç°çº¿ç´¢ï¼Ÿ
1. **çº¿ç´¢1ï¼ˆé—®é¢˜ç›®æ ‡ï¼‰**ï¼šé¢˜ç›®è¦æ±‚â€œèŠ±è´¹ä¹‹å’Œæœ€å°â€ä¸”â€œæ™¯ç‚¹åˆ†æ•°ä¹‹å’Œæœ€å¤§â€ï¼Œè¿™æ˜¯ä¸€ä¸ª**åŒå…³é”®å­—æœ€ä¼˜åŒ–**é—®é¢˜ï¼Œé€šå¸¸éœ€è¦**åˆ†å±‚å¤„ç†**ï¼ˆå…ˆæ»¡è¶³ç¬¬ä¸€å…³é”®å­—ï¼Œå†ä¼˜åŒ–ç¬¬äºŒå…³é”®å­—ï¼‰ã€‚
2. **çº¿ç´¢2ï¼ˆé—®é¢˜ç»“æ„ï¼‰**ï¼šé¢˜ç›®ç»™å‡ºçš„åœ°å›¾æ˜¯ä¸€æ£µæ ‘ï¼Œä¸”æ¶‰åŠè·¯å¾„æŸ¥è¯¢ï¼Œæš—ç¤ºæˆ‘ä»¬éœ€è¦ä½¿ç”¨**æ ‘ä¸Šå€å¢**æˆ–**æ ‘å½¢DP**æ¥é«˜æ•ˆå¤„ç†ã€‚
3. **çº¿ç´¢3ï¼ˆæ•°æ®è§„æ¨¡ï¼‰**ï¼š`n, m â‰¤ 3Ã—10^5`ï¼Œè¦æ±‚**O(n log n)** æˆ– **O(n)** çš„ç®—æ³•ï¼Œæ’é™¤äº†æš´åŠ›æšä¸¾ã€‚

### ğŸ§  æ€ç»´é“¾æ„å»ºï¼šä»çº¿ç´¢åˆ°ç­–ç•¥
> 1. é¦–å…ˆï¼Œ**çº¿ç´¢1**å‘Šè¯‰æˆ‘ä»¬è¿™æ˜¯ä¸€ä¸ªåŒå…³é”®å­—é—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦**å…ˆå›ºå®šè·¯å¾„ç»“æ„**ï¼Œå†ä¼˜åŒ–é¢å¤–éƒ¨åˆ†ã€‚
> 2. æ¥ç€ï¼Œ**çº¿ç´¢2**æç¤ºæˆ‘ä»¬ä½¿ç”¨**æ ‘å½¢DP**æ¥é¢„å¤„ç†æ¯ä¸ªç‚¹çš„â€œæœ€ä¼˜å»¶ä¼¸è·¯å¾„â€ã€‚
> 3. æœ€åï¼Œ**çº¿ç´¢3**è¦æ±‚æˆ‘ä»¬ç”¨**æ ‘ä¸Šå€å¢**æ¥å¿«é€ŸæŸ¥è¯¢è·¯å¾„ä¸Šçš„æœ€ä¼˜å€¼ã€‚

---

## 2. ç²¾é€‰ä¼˜è´¨é¢˜è§£å‚è€ƒ

### é¢˜è§£ä¸€ï¼šOrezTsimï¼ˆèµï¼š9ï¼‰
**ç‚¹è¯„**ï¼šè¿™ä»½é¢˜è§£æ€è·¯æ¸…æ™°ï¼Œé‡‡ç”¨**æ¢æ ¹DP**é¢„å¤„ç†æ¯ä¸ªç‚¹çš„â€œæœ€ä¼˜å»¶ä¼¸è·¯å¾„â€ï¼Œå¹¶ç”¨**æ ‘ä¸Šå€å¢**å¿«é€ŸæŸ¥è¯¢è·¯å¾„ä¸Šçš„æœ€ä¼˜å€¼ã€‚ä»£ç å®ç°ä¸¥è°¨ï¼Œå˜é‡å‘½åç›´è§‚ï¼ˆ`son`, `fa`, `all` ç­‰ï¼‰ï¼Œç‰¹åˆ«æ˜¯å¯¹**æ¬¡ä¼˜è§£çš„å¤„ç†**éå¸¸å·§å¦™ï¼ˆç”¨ `vector` æ’åºåå–æ¬¡ä¼˜ï¼‰ã€‚è°ƒè¯•ç»éªŒåˆ†äº«ï¼ˆå¦‚ `#define int long long` çš„å‘ï¼‰ä¹Ÿå¾ˆæœ‰ä»·å€¼ã€‚

### é¢˜è§£äºŒï¼š5k_sync_closerï¼ˆå‡ºé¢˜äººé¢˜è§£ï¼Œèµï¼š8ï¼‰
**ç‚¹è¯„**ï¼šå‡ºé¢˜äººçš„å®˜æ–¹é¢˜è§£ï¼Œé€»è¾‘ä¸¥è°¨ï¼Œå°†é—®é¢˜æŠ½è±¡ä¸º**â€œä»è·¯å¾„ä¸Šçš„æ¯ä¸ªç‚¹å‡ºå‘ï¼Œæ‰¾åˆ°æœ€å°è¾¹æƒå’Œå¯¹åº”çš„æœ€å¤§ç‚¹æƒå’Œâ€**ã€‚æ¢æ ¹DPçš„çŠ¶æ€è½¬ç§»æ–¹ç¨‹æ¨å¯¼æ¸…æ™°ï¼Œç‰¹åˆ«æ˜¯**â€œé‡å¤è®¡ç®—â€çš„æ¶ˆé™¤**ï¼ˆç”¨ `k_p` è®°å½•è½¬ç§»æ¥æºï¼‰æ˜¯ä¸€ä¸ªäº®ç‚¹ã€‚ä»£ç é£æ ¼ç®€æ´é«˜æ•ˆï¼Œé€‚åˆä½œä¸ºæ¨¡æ¿å‚è€ƒã€‚

### é¢˜è§£ä¸‰ï¼š262620zzjï¼ˆèµï¼š0ï¼‰
**ç‚¹è¯„**ï¼šè¿™ä»½é¢˜è§£é‡‡ç”¨**â€œé—®é¢˜è½¬åŒ–â€**çš„æ€ç»´ï¼Œå°†é—®é¢˜æ‹†åˆ†ä¸º**å›ºå®šè·¯å¾„ + æœ€ä¼˜å»¶ä¼¸**ï¼Œå¹¶ç”¨**STè¡¨**ï¼ˆæ ‘ä¸Šå€å¢ï¼‰å¿«é€ŸæŸ¥è¯¢ã€‚ä»£ç ç»“æ„æ¸…æ™°ï¼Œ`plan` ç±»å‹çš„å°è£…ä½¿å¾—é€»è¾‘æ›´æ˜“ç†è§£ã€‚ç‰¹åˆ«é€‚åˆå­¦ä¹ **å¦‚ä½•å°†å¤æ‚é—®é¢˜æŠ½è±¡ä¸ºç®€æ´çš„DPçŠ¶æ€**ã€‚

---

## 3. è§£é¢˜ç­–ç•¥æ·±åº¦å‰–æ

### ğŸ¯ æ ¸å¿ƒéš¾ç‚¹ä¸å…³é”®æ­¥éª¤
1. **å…³é”®ç‚¹1ï¼šå¦‚ä½•å®šä¹‰DPçŠ¶æ€ï¼Ÿ**
   - **åˆ†æ**ï¼šå®šä¹‰ `dp[u][0/1]` è¡¨ç¤ºä» `u` å‡ºå‘ï¼Œ**å‘ä¸‹/å‘ä¸Š**èµ°çš„æœ€ä¼˜è·¯å¾„ï¼ˆè¾¹æƒå’Œæœ€å°ï¼Œç‚¹æƒå’Œæœ€å¤§ï¼‰ã€‚
   - ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šæ ‘å½¢DPçš„çŠ¶æ€é€šå¸¸éœ€è¦**æ–¹å‘æ€§**ï¼ˆå‘ä¸Š/å‘ä¸‹ï¼‰æ¥è¦†ç›–æ‰€æœ‰å¯èƒ½è·¯å¾„ã€‚

2. **å…³é”®ç‚¹2ï¼šå¦‚ä½•å¤„ç†â€œæ¢æ ¹â€è½¬ç§»ï¼Ÿ**
   - **åˆ†æ**ï¼šæ¢æ ¹DPçš„æ ¸å¿ƒæ˜¯**â€œçˆ¶èŠ‚ç‚¹ä¿¡æ¯ â†’ å­èŠ‚ç‚¹ä¿¡æ¯â€**ã€‚ä¾‹å¦‚ï¼Œ`g[u]`ï¼ˆå‘ä¸Šæœ€ä¼˜ï¼‰éœ€è¦ä»çˆ¶èŠ‚ç‚¹çš„ `g[fa]` å’Œ `f[fa]`ï¼ˆæ’é™¤ `u` çš„è´¡çŒ®ï¼‰è½¬ç§»è€Œæ¥ã€‚
   - ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šæ¢æ ¹DPéœ€è¦**æ¬¡ä¼˜è§£**æ¥å¤„ç†â€œæ’é™¤å½“å‰åˆ†æ”¯â€çš„æƒ…å†µã€‚

3. **å…³é”®ç‚¹3ï¼šå¦‚ä½•é«˜æ•ˆæŸ¥è¯¢è·¯å¾„ä¸Šçš„æœ€ä¼˜å€¼ï¼Ÿ**
   - **åˆ†æ**ï¼šä½¿ç”¨**æ ‘ä¸Šå€å¢**ï¼ˆç±»ä¼¼LCAçš„è·³è·ƒæ–¹æ³•ï¼‰ï¼Œé¢„å¤„ç† `st[u][k]` è¡¨ç¤ºä» `u` å‘ä¸Šè·³ `2^k` æ­¥çš„æœ€ä¼˜å€¼ã€‚
   - ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šæ ‘ä¸Šå€å¢æ˜¯å¤„ç†**é™æ€æ ‘è·¯å¾„æŸ¥è¯¢**çš„åˆ©å™¨ã€‚

### âš”ï¸ ç­–ç•¥ç«æŠ€åœºï¼šä¸åŒè§£æ³•çš„å¯¹æ¯”åˆ†æ
| ç­–ç•¥ | æ ¸å¿ƒæ€æƒ³ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|---|---|---|---|---|
| **æš´åŠ›æšä¸¾** | æšä¸¾æ‰€æœ‰ `p, q` | æ€è·¯ç›´è§‚ | **O(nÂ²)** è¶…æ—¶ | æ•°æ®è§„æ¨¡ â‰¤ 1000 |
| **æ¢æ ¹DP + å€å¢** | é¢„å¤„ç†æ¯ä¸ªç‚¹çš„æœ€ä¼˜å»¶ä¼¸è·¯å¾„ | **O(n log n)** é«˜æ•ˆ | ç»†èŠ‚å¤šï¼ˆæ¬¡ä¼˜è§£å¤„ç†ï¼‰ | æœ¬é¢˜æœ€ä¼˜è§£ |
| **æ ‘å½¢DP + å¯å‘å¼åˆå¹¶** | ç”¨å †ç»´æŠ¤å­æ ‘æœ€ä¼˜å€¼ | é€»è¾‘æ¸…æ™° | å¸¸æ•°è¾ƒå¤§ | éœ€è¦åŠ¨æ€ä¿®æ”¹æ—¶ |

### âœ¨ ä¼˜åŒ–ä¹‹æ—…ï¼šä»â€œèƒ½åšâ€åˆ°â€œåšå¥½â€
> 1. **èµ·ç‚¹**ï¼šæš´åŠ›æšä¸¾ `p` å’Œ `q`ï¼Œæ—¶é—´å¤æ‚åº¦ `O(nÂ²)`ï¼Œæ— æ³•é€šè¿‡ã€‚
> 2. **å‘ç°ç“¶é¢ˆ**ï¼šå›ºå®š `aâ†’b` è·¯å¾„åï¼Œåªéœ€åœ¨è·¯å¾„ä¸Šçš„æ¯ä¸ªç‚¹ `p` æ‰¾åˆ°**æœ€ä¼˜å»¶ä¼¸è·¯å¾„**ã€‚
> 3. **ä¼˜åŒ–é’¥åŒ™**ï¼šç”¨**æ¢æ ¹DP**é¢„å¤„ç†æ¯ä¸ªç‚¹çš„â€œæœ€ä¼˜å‘ä¸‹/å‘ä¸Šè·¯å¾„â€ï¼Œå†ç”¨**å€å¢**å¿«é€ŸæŸ¥è¯¢è·¯å¾„ä¸Šçš„æœ€ä¼˜å€¼ã€‚
> 4. **æ¨¡å‹å‡å**ï¼šå°†é—®é¢˜è½¬åŒ–ä¸º**â€œè·¯å¾„ä¸Šçš„ç‚¹å–æœ€ä¼˜å€¼â€**ï¼Œç±»ä¼¼STè¡¨æŸ¥è¯¢ã€‚

---

## 4. C++æ ¸å¿ƒä»£ç å®ç°èµæ

### æœ¬é¢˜é€šç”¨æ ¸å¿ƒC++å®ç°å‚è€ƒ
**è¯´æ˜**ï¼šç»¼åˆé¢˜è§£äºŒçš„æ€è·¯ï¼Œæä¾›æ¸…æ™°ã€é«˜æ•ˆçš„æ¢æ ¹DP + å€å¢å®ç°ã€‚

```cpp
#include <bits/stdc++.h>
using namespace std;
using ll = long long;
const int N = 3e5 + 10, LOG = 20;
const ll INF = 1e18;

struct Node {
    ll dis, val;
    bool operator < (const Node& o) const {
        return dis != o.dis ? dis < o.dis : val > o.val;
    }
};

int n, m, s[N], fa[N][LOG], dep[N];
ll sum[N];
vector<pair<int, int>> g[N];
Node f[N][2], g_up[N], st[N][LOG];

void dfs1(int u, int p) {
    fa[u][0] = p, dep[u] = dep[p] + 1;
    sum[u] = sum[p] + s[u];
    f[u][0] = f[u][1] = {INF, -INF};
    for (int i = 1; i < LOG; ++i) fa[u][i] = fa[fa[u][i-1]][i-1];

    for (auto [v, w] : g[u]) {
        if (v == p) continue;
        dfs1(v, u);
        Node tmp = {f[v][0].dis + w, f[v][0].val + 2 * s[u]};
        if (tmp < f[u][0]) f[u][1] = f[u][0], f[u][0] = tmp;
        else if (tmp < f[u][1]) f[u][1] = tmp;
    }
}

void dfs2(int u, int p) {
    for (auto [v, w] : g[u]) {
        if (v == p) continue;
        Node tmp = {g_up[u].dis + w, g_up[u].val + 2 * s[u]};
        if (v == f[u][0].dis) tmp = min(tmp, {f[u][1].dis + w, f[u][1].val + 2 * s[u]});
        else tmp = min(tmp, {f[u][0].dis + w, f[u][0].val + 2 * s[u]});
        g_up[v] = min(tmp, {0LL, 1LL * s[v]});
        dfs2(v, u);
    }
}

int lca(int u, int v) {
    if (dep[u] < dep[v]) swap(u, v);
    for (int i = LOG - 1; ~i; --i) if (dep[fa[u][i]] >= dep[v]) u = fa[u][i];
    if (u == v) return u;
    for (int i = LOG - 1; ~i; --i) if (fa[u][i] != fa[v][i]) u = fa[u][i], v = fa[v][i];
    return fa[u][0];
}

Node query(int u, int anc) {
    Node res = {INF, -INF};
    for (int i = LOG - 1; ~i; --i) if (dep[fa[u][i]] >= dep[anc]) {
        res = min(res, st[u][i]);
        u = fa[u][i];
    }
    return min(res, st[u][0]);
}

int main() {
    ios::sync_with_stdio(false);
    cin.tie(nullptr);
    cin >> n >> m;
    for (int i = 1; i <= n; ++i) cin >> s[i];
    for (int i = 1, u, v, w; i < n; ++i) {
        cin >> u >> v >> w;
        g[u].emplace_back(v, w);
        g[v].emplace_back(u, w);
    }

    dfs1(1, 0);
    g_up[1] = {0, s[1]};
    dfs2(1, 0);

    for (int i = 1; i <= n; ++i) st[i][0] = min({f[i][0], g_up[i], {0LL, 1LL * s[i]}});
    for (int j = 1; j < LOG; ++j) {
        for (int i = 1; i <= n; ++i) {
            st[i][j] = min(st[i][j-1], st[fa[i][j-1]][j-1]);
        }
    }

    while (m--) {
        int a, b; cin >> a >> b;
        int lc = lca(a, b);
        Node ans = min(query(a, lc), query(b, lc));
        ll base = sum[a] + sum[b] - sum[lc] - sum[fa[lc][0]];
        cout << base + ans.val << '\n';
    }
    return 0;
}
```

---

## 5. ç®—æ³•å¯è§†åŒ–ï¼šåƒç´ åŠ¨ç”»æ¼”ç¤º

**åŠ¨ç”»æ¼”ç¤ºä¸»é¢˜**ï¼šâ€œåƒç´ æ¢é™©å®¶â€åœ¨æ ‘ä¸Šå¯»æ‰¾æœ€ä¼˜è·¯å¾„  
**æ ¸å¿ƒæ¼”ç¤ºå†…å®¹**ï¼šæ¢æ ¹DPå¦‚ä½•ä¸€æ­¥æ­¥è®¡ç®—æ¯ä¸ªç‚¹çš„æœ€ä¼˜å»¶ä¼¸è·¯å¾„ï¼Œå¹¶ç”¨å€å¢æŸ¥è¯¢è·¯å¾„ä¸Šçš„æœ€ä¼˜å€¼ã€‚

**è®¾è®¡æ€è·¯**ï¼š
- **åƒç´ é£æ ¼**ï¼š8ä½çº¢ç™½æœºé£æ ¼ï¼Œæ¯ä¸ªèŠ‚ç‚¹ç”¨åƒç´ æ–¹å—è¡¨ç¤ºï¼Œè¾¹ç”¨åƒç´ çº¿è¿æ¥ã€‚
- **åŠ¨ç”»æ­¥éª¤**ï¼š
  1. **é¢„å¤„ç†é˜¶æ®µ**ï¼šå±•ç¤º `dfs1` å¦‚ä½•è®¡ç®—æ¯ä¸ªç‚¹çš„ `f[u][0/1]`ï¼ˆå‘ä¸‹æœ€ä¼˜/æ¬¡ä¼˜ï¼‰ã€‚
  2. **æ¢æ ¹é˜¶æ®µ**ï¼šå±•ç¤º `dfs2` å¦‚ä½•ç”¨çˆ¶èŠ‚ç‚¹ä¿¡æ¯æ›´æ–°å­èŠ‚ç‚¹çš„ `g_up`ã€‚
  3. **æŸ¥è¯¢é˜¶æ®µ**ï¼šå±•ç¤ºå€å¢å¦‚ä½•è·³è·ƒæŸ¥è¯¢è·¯å¾„ä¸Šçš„æœ€ä¼˜å€¼ã€‚
- **æ¸¸æˆåŒ–å…ƒç´ **ï¼š
  - æ¯ä¸ªDPçŠ¶æ€æ›´æ–°æ—¶æ’­æ”¾â€œå®â€éŸ³æ•ˆã€‚
  - æˆåŠŸæ‰¾åˆ°æœ€ä¼˜è·¯å¾„æ—¶æ’­æ”¾â€œèƒœåˆ©â€éŸ³æ•ˆã€‚
  - æä¾›â€œå•æ­¥æ‰§è¡Œâ€å’Œâ€œè‡ªåŠ¨æ¼”ç¤ºâ€æ¨¡å¼ã€‚

---

## 6. æ‹“å±•ç»ƒä¹ ä¸ç›¸ä¼¼é—®é¢˜æ€è€ƒ

**é€šç”¨æ€è·¯è¿ç§»**ï¼šæ¢æ ¹DPé€‚ç”¨äºæ‰€æœ‰**â€œä»¥æ¯ä¸ªç‚¹ä¸ºæ ¹çš„æœ€ä¼˜å€¼â€**é—®é¢˜ï¼Œä¾‹å¦‚ï¼š
1. **æ ‘çš„é‡å¿ƒ**ï¼šæ‰¾åˆ°åˆ é™¤åæœ€å¤§å­æ ‘æœ€å°çš„ç‚¹ã€‚
2. **æ ‘çš„ç›´å¾„**ï¼šæœ€é•¿è·¯å¾„é—®é¢˜ã€‚
3. **æœ€å°æ”¯é…é›†**ï¼šè¦†ç›–å…¨æ ‘çš„æœ€å°‘ç‚¹é›†ã€‚

**æ´›è°·æ¨è**ï¼š
1. **P3383** - æ ‘çš„é‡å¿ƒ  
   ğŸ—£ï¸ æ¨èç†ç”±ï¼šç»å…¸æ¢æ ¹DPå…¥é—¨é¢˜ï¼Œå·©å›ºâ€œå­æ ‘ â†’ å…¨æ ‘â€çš„æ€ç»´ã€‚
2. **P3304** - æ ‘çš„ç›´å¾„  
   ğŸ—£ï¸ æ¨èç†ç”±ï¼šå­¦ä¹ å¦‚ä½•ç”¨ä¸¤æ¬¡DFSæ±‚ç›´å¾„ï¼Œç†è§£æ ‘çš„éå†æ€§è´¨ã€‚
3. **P3177** - æ ‘å½¢DPè¿›é˜¶  
   ğŸ—£ï¸ æ¨èç†ç”±ï¼šç»“åˆèƒŒåŒ…æ€æƒ³çš„æ ‘å½¢DPï¼ŒæŒ‘æˆ˜æ›´å¤æ‚çš„æ¢æ ¹é—®é¢˜ã€‚

---

## 7. å­¦ä¹ å¿ƒå¾—ä¸ç»éªŒåˆ†äº«

> **æ¥è‡ª OrezTsim çš„è°ƒè¯•ç»éªŒ**ï¼š
> - â€œåˆå§‹å€¼å¾ˆé‡è¦ï¼Œä¸è¦å¼„é”™ã€‚â€  
> - â€œæ ‘ä¸Šè·³ç¥–å…ˆæ—¶ 1 çš„çˆ¶äº²ä¸æ˜¯ 0ï¼Œè·³çš„æ—¶å€™åˆ¤ä¸€ä¸‹ã€‚â€  
> - â€œ#define int long long ä¼šå¯¼è‡´å·¨å¤§çš„å¸¸æ•°ï¼Œä»è€Œ TLEã€‚â€

**ç‚¹è¯„**ï¼šè¿™äº›ç»éªŒæé†’æˆ‘ä»¬ï¼Œåœ¨æ ‘å½¢DPä¸­ï¼Œ**è¾¹ç•Œæ¡ä»¶å’Œæ•°æ®ç±»å‹é€‰æ‹©**æ˜¯å¸¸è§çš„å‘ã€‚è°ƒè¯•æ—¶å¯ä»¥é€šè¿‡**æ‰“å°ä¸­é—´å˜é‡**æˆ–**æ„é€ å°æ•°æ®**æ¥å®šä½é—®é¢˜ã€‚

---

<conclusion>
ä»Šå¤©æˆ‘ä»¬ä¸€èµ·æ”»å…‹äº†ä¸€é“**æ ‘ä¸ŠåŒå…³é”®å­—æœ€ä¼˜è·¯å¾„**é—®é¢˜ã€‚ä»**æ¢æ ¹DP**çš„é¢„å¤„ç†åˆ°**å€å¢æŸ¥è¯¢**çš„é«˜æ•ˆå®ç°ï¼Œæ¯ä¸€æ­¥éƒ½ä½“ç°äº†ç®—æ³•æ€ç»´çš„ç²¾å¦™ã€‚è®°ä½ï¼Œç¼–ç¨‹èƒ½åŠ›çš„æå‡åœ¨äº**ç†è§£é—®é¢˜æœ¬è´¨**ã€**é€‰æ‹©åˆé€‚çš„æ¨¡å‹**ã€**ä¸¥è°¨å®ç°ç»†èŠ‚**ã€‚ä¸‹æ¬¡æˆ‘ä»¬å†ä¸€èµ·æ¢ç´¢æ–°çš„æŒ‘æˆ˜ï¼ğŸ’ª
</conclusion>
```

---
å¤„ç†ç”¨æ—¶ï¼š90.62ç§’
# 题目信息

# 「SFMOI Round I」Strange Madoka Game

## 题目背景

> いつも君の側にいるから / 无论何时我都与你同在 \
> 儚すぎて / 世界如此虚幻 \
> 消えて行きそうな世界 / 似乎随时随地都会消失 \
> だけど君がいる / 然而只要有你 \
> それだけで守りたいと思った / 我就心甘情愿将它守护

## 题目描述


**本题和 B2 是不同的问题，请分别仔细阅读两题题面。**

**这是一道交互题。**

**提示**：我们在题目描述的最后提供了一份简要的、形式化描述的题面。

圆和焰在玩游戏。

圆在心中想了一个非负整数 $m$，让焰猜出 $m$ 的值。当然，圆不会为难焰，所以 $\textcolor{red}{0}\le m\le 10^{17}$。圆不会作弊，也就是说，**圆不会悄悄更换想好的数字。**

焰可以问圆：对于**正**整数 $x$，$m\bmod x$ 的值是多少。焰需要用最少的询问次数来猜出 $m$ 的值。（为了得到全部分数，最多只能使用 $2$ 次询问。）

圆一共和焰玩了 $T$ 次游戏。然而，焰的数学很差，于是她找来了你，来帮她猜出这 $T$ 次游戏的答案。



**形式化地**：有一个隐藏的非负整数 $m\in [\textcolor{red}{0},10^{17}]$。每次询问给定**正**整数 $x$，回答 $m\bmod x$。用最少的询问次数找出 $m$。共有 $T$ 组测试数据。$m$ 的数值在事先确定，不会根据询问变化，也就是说，**交互库是非适应性的**。

【实现细节】

对于每个测试点，输入一行一个正整数 $T$，表示游戏次数。

对于每组测试数据，你可以用以下的格式发起一次询问：

- $\texttt{? }x$：询问 $m\bmod x$ 的值。你需要保证 $x$ 是**正**整数，且 $x \in \textcolor{red} {[1,4\times 10^8]}$。

	从标准输入流读入一个整数表示答案。特别地，若整数是 $\texttt{-1}$，你的程序已经被判定为 $\texttt{Wrong Answer}$，此时你需要立刻终止程序。

你可以用以下的格式回答答案：

- $\texttt{! }m$：回答 $m$ 的值。

在发起询问后，需要刷新缓冲区，否则可能导致 TLE。

- 在 C++ 中，使用 `fflush(stdout)` 或 `cout.flush()`。 特别地，利用 `std::endl` 来换行也会刷新缓冲区。
- 在 Pascal 中，使用 `flush(output)`。  
- 在 Python 中，使用 `stdout.flush()`。  
- 对于其它语言，可自行查阅文档。

## 说明/提示


#### 数据范围

对于 $100\%$ 的数据，保证 $1\le T\le 100$，$m$ 为非负整数，$\textcolor{red}{0}\le m\le 10^{17}$。

#### 评分方式

记单个测试点中，你的询问次数的最大值为 $Q$。则得分 $\mathrm{score}$ 如下所示：

$$
\begin{aligned}
\mathrm{score}=\begin{cases}
0, & Q\in [81,+\infty) \\
10, & Q\in [11,81) \\
25, & Q\in [3,11) \\
50, & Q\in [0,3) \\
\end{cases}
\end{aligned}
$$

本题得分为所有测试点得分的最小值。

本题数据点的范围是非严格单调递增的。

## 样例 #1

### 输入

```
1

1

2```

### 输出

```

? 2

? 3

! 5```

# AI分析结果

---
# 💡 洛语云笺的C++算法解析：Strange Madoka Game 深入学习指南 💡

> 欢迎来到今天的算法探险！我们要一起破解一道“神秘魔法少女”的交互谜题。它看起来只用到两次提问，却暗藏数论大杀器——中国剩余定理（CRT）。准备好跟洛语云笺一起，用 2 次询问把隐藏在 0~10¹⁷ 之间的数字 m 揪出来吧！

---

## 1. 题目解读与策略初探

✨ **本题核心挑战**：在最多 **2 次** 交互询问内，通过 `m mod x` 的结果，唯一确定 0 ≤ m ≤ 10¹⁷ 的整数 m。  
✨ **核心算法标签**：`数学`、`中国剩余定理 (CRT)`、`交互`

🗣️ **初步分析**：  
> 题目只允许两次提问，却要覆盖 10¹⁷ 的巨大范围，显然单次询问的模数必须“足够大”。  
> 关键点：两次询问的模数必须 **互质** 且 **乘积 > 10¹⁷**，这样 CRT 就能保证解的唯一性。  
> 于是，思路呼之欲出：  
> 1. 精心选取两个大互质整数 a、b（如 4×10⁸ 与 4×10⁸−1）。  
> 2. 两次交互分别询问 `m mod a`、`m mod b`。  
> 3. 用 CRT 合并两个同余式，得到唯一解 m。  

### 🔍 算法侦探：如何在题目中发现线索？

| 线索 | 侦探笔记 |
|------|----------|
| **线索1：询问次数极严** | 最多 2 次！直接排除逐位二分、倍增等多次询问策略。 |
| **线索2：m 范围巨大** | 0~10¹⁷，暗示需要“乘法级”信息量。两个大互质模数乘积必须 ≥ 10¹⁷+1 才能覆盖。 |
| **线索3：交互返回同余式** | `m mod x = r` 正是中国剩余定理的标准输入形式。 |

### 🧠 思维链构建：从线索到策略
> “侦探工作完成，我们收集到三条线索：  
> 1. 询问次数上限 2 次 → 必须一次问出‘最大信息’。  
> 2. m 极大 → 两次模数乘积必须 ≥ 10¹⁷。  
> 3. 返回同余式 → 直接调用 CRT。  
> 于是，策略锁定：选一对相邻大整数 (4×10⁸, 4×10⁸−1)，它们天然互质且乘积 ≈ 1.6×10¹⁷ > 10¹⁷。两次询问 + CRT，即可 50 分到手！”

---

## 2. 精选优质题解参考

<eval_intro>  
下面给出 **两条 4★+** 的精选题解，一条简洁模板派，一条严谨推导派，供大家对照学习。
</eval_intro>

**题解一：asd890123 极简 CRT 模板**  
* **亮点**：直接固定 `a=4e8, b=4e8-1`，推导一步到位，代码 6 行核心公式，适合比赛快速敲。  
* **核心推导**：  
  令 `a=400000000`, `b=399999999`，则  
  `m ≡ r1 (mod a)`  
  `m ≡ r2 (mod b)`  
  CRT 合并得  
  `m = ((a-1)*a - (a-1)*r1 + a*r2) % (a*(a-1))`

**题解二：HasNoName 严谨数学派**  
* **亮点**：  
  1. 证明 `k1 = k2` 或 `k1+1 = k2`，从而无需 CRT 模板，直接通过 `y2-y1` 判断 k 值。  
  2. 仅用 long long 运算，避免 __int128，常数小。  
* **关键公式**：  
  ```
  if (y1 <= y2) k = y2 - y1;
  else          k = y2 - y1 + (a - 1);
  m = k * a + y1;
  ```

---

## 3. 解题策略深度剖析

### 🎯 核心难点与关键步骤（最优解法）

| 关键点 | 分析 & 学习笔记 |
|--------|-----------------|
| **1. 模数选取** | 选 `a=4e8`, `b=4e8-1`（互质且乘积 > 10¹⁷）。💡 互质 + 乘积覆盖范围 是 CRT 正确性的生命线。 |
| **2. 两次询问** | 交互格式：`? a` 得 `r1`，`? b` 得 `r2`。注意刷新缓冲区。💡 交互题永远别忘了 `cout.flush()` 或 `endl`。 |
| **3. CRT 合并** | 两条路线：<br>- **通用 CRT**：求解 `k1*a + r1 = k2*b + r2`，用扩展欧几里得求逆元。<br>- **相邻模数技巧**：利用 `k2 - k1 ∈ {0,1}` 直接算出 k，再得 m。💡 后者更简洁，但仅适用于相邻模数。 |

### ✨ 解题技巧总结
- **技巧A：大整数互质对选取**  
  相邻整数 gcd=1，乘积大，是构造 CRT 输入的“黄金拍档”。  
- **技巧B：__int128 防溢出**  
  当 `a*b` 接近 1.6e17 时，中间乘法需用 `__int128` 或龟速乘。  
- **技巧C：交互刷新**  
  交互题务必在每次输出询问后 `flush`，防止 TLE。

### ⚔️ 策略竞技场：不同解法的对比分析

| 策略 | 核心思想 | 优点 | 缺点 | 得分预期 |
|------|----------|------|------|----------|
| **暴力逐位二分** | 逐位确定二进制位 | 思路直观 | 询问 60 次，直接 0 分 | 0 |
| **一次询问大模** | 一次问 `mod=1e17+1` 得 m | 只需 1 次 | 但模数 > 4e8，非法 | 0 |
| **相邻互质 CRT** | 两次询问 4e8,4e8-1 | 2 次、常数小、代码短 | 需证明唯一性 | 50 |
| **通用 CRT 任意质数** | 选两个大质数 | 通用、无需相邻 | 需写扩展欧几里得 | 50 |

---

## 4. C++核心代码实现赏析

**本题通用核心C++实现参考**  
* **说明**：综合各题解，给出 **最短实现**（相邻模数版）与 **通用 CRT 模板** 各一份。  
* **完整核心代码（极简版）**：
```cpp
#include <iostream>
using namespace std;
typedef long long ll;
const ll a = 400000000, b = 399999999;   // 互质且 a*b > 1e17
int main() {
    ios::sync_with_stdio(false);
    cin.tie(nullptr);
    int T;  cin >> T;
    while (T--) {
        ll r1, r2;
        cout << "? " << a << endl;  cin >> r1;
        cout << "? " << b << endl;  cin >> r2;
        ll k;
        if (r1 <= r2) k = r2 - r1;
        else          k = r2 - r1 + b;
        ll m = k * a + r1;
        cout << "! " << m << endl;
    }
    return 0;
}
```
* **代码解读概要**：  
  1. 固定模数 `a, b`；2. 两次询问得 `r1, r2`；3. 利用相邻模数特性算出 k；4. 直接得到 m。

* **通用 CRT 模板片段**（来自 HasNoName）：
```cpp
// 计算 (x mod m1, x mod m2) -> x
ll crt(ll r1, ll m1, ll r2, ll m2) {
    ll x, y, g = exgcd(m1, m2, x, y);  // g=gcd(m1,m2)=1
    ll lcm = m1 / g * m2;
    // 求解 k1*m1 + r1 = k2*m2 + r2
    ll diff = (r2 - r1) % m2;
    if (diff < 0) diff += m2;
    ll k1 = (__int128(diff) * x % m2 + m2) % m2;
    ll ans = ((__int128)k1 * m1 + r1) % lcm;
    return ans;
}
```

---

## 5. 算法可视化：像素动画演示

* **动画主题**：**像素 CRT 解谜室**  
  8 位像素风界面，左右各有一个“余数宝箱”，中间是 CRT 魔法阵。
* **演示流程**：
  1. **初始化**：像素化的 `a=4e8` 与 `b=4e8-1` 跳上屏幕，互相握手表示“互质”。
  2. **第一次询问**：像素火焰问“? 400000000”，宝箱弹出 `r1`。
  3. **第二次询问**：同理得到 `r2`。
  4. **CRT 魔法阵**：  
     - 像素小人把 `r1, r2` 丢进魔法阵。  
     - 阵法发光，出现公式 `(k*b + r2)`，小人计算 k。  
     - 最终 `m` 以金色宝箱形式跳出，伴随 8 位“胜利”音效。
* **交互**：  
  提供“单步/自动”按钮，速度滑块；每步有像素气泡提示当前公式。

---

## 6. 拓展练习与相似问题思考

* **通用技巧迁移**  
  1. **大整数唯一解码**：任何需要把大整数通过“模数对”压缩到两次通信的场景（如分布式哈希）。  
  2. **时间戳同步**：两台机器用 CRT 合并各自本地时钟。  
  3. **密码学 RSA CRT 优化**：私钥运算加速。

* **洛谷推荐练习**  
  1. **P1495 【模板】中国剩余定理**  
     🗣️ 推荐理由：CRT 模板裸题，巩固扩展欧几里得与逆元。  
  2. **P4774 【模板】扩展中国剩余定理**  
     🗣️ 推荐理由：模数不保证互质，需要扩展 CRT，加深理解。  
  3. **P2480 [SDOI2010] 古代猪文**  
     🗣️ 推荐理由：结合 CRT 与欧拉定理，体验数论综合题。

---

## 7. 学习心得与经验分享

> **asd890123 的踩坑记录**：  
> “第一次忘记 `endl` 刷新，直接 TLE；第二次把 `a-1` 写成 `a+1`，导致互质失败 WA。  
> **洛语云笺点评**：交互题刷新缓冲区是生命线！固定模数前务必验证 gcd=1。

---

<conclusion>
今天我们用两次询问、两行公式、十行代码，就破解了 10¹⁷ 的魔法数字谜题。核心就是——选一对互质大模数，用 CRT 一锤定音。希望大家把“互质+乘积覆盖”牢记于心，下次遇到类似交互或数论题，也能像今天一样优雅地一击必杀！加油，我们下道题再见！💪

---
处理用时：77.47秒
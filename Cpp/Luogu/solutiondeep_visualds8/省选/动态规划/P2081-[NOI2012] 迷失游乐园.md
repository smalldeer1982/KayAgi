# é¢˜ç›®ä¿¡æ¯

# [NOI2012] è¿·å¤±æ¸¸ä¹å›­

## é¢˜ç›®æè¿°

æ”¾å‡äº†ï¼Œå° Z è§‰å¾—å‘†åœ¨å®¶é‡Œç‰¹åˆ«æ— èŠï¼Œäºæ˜¯å†³å®šä¸€ä¸ªäººå»æ¸¸ä¹å›­ç©ã€‚

è¿›å…¥æ¸¸ä¹å›­åï¼Œå° Z çœ‹äº†çœ‹æ¸¸ä¹å›­çš„åœ°å›¾ï¼Œå‘ç°å¯ä»¥å°†æ¸¸ä¹å›­æŠ½è±¡æˆæœ‰ $n$ ä¸ªæ™¯ç‚¹ã€$m$ æ¡é“è·¯çš„æ— å‘è¿é€šå›¾ï¼Œä¸”è¯¥å›¾ä¸­è‡³å¤šæœ‰ä¸€ä¸ªç¯ï¼ˆå³ $m$ åªå¯èƒ½ç­‰äº $n$ æˆ–è€… $n-1$ï¼‰ã€‚

å° Z ç°åœ¨æ‰€åœ¨çš„å¤§é—¨ä¹Ÿæ­£å¥½æ˜¯ä¸€ä¸ªæ™¯ç‚¹ã€‚å° Z ä¸çŸ¥é“ä»€ä¹ˆå¥½ç©ï¼Œäºæ˜¯ä»–å†³å®šï¼Œä»å½“å‰ä½ç½®å‡ºå‘ï¼Œæ¯æ¬¡éšæœºå»ä¸€ä¸ªå’Œå½“å‰æ™¯ç‚¹æœ‰é“è·¯ç›¸è¿çš„æ™¯ç‚¹ï¼Œå¹¶ä¸”åŒä¸€ä¸ªæ™¯ç‚¹ä¸å»ä¸¤æ¬¡ï¼ˆåŒ…æ‹¬èµ·å§‹æ™¯ç‚¹ï¼‰ã€‚è´ªç©çš„å° Z ä¼šä¸€ç›´æ¸¸ç©ï¼Œç›´åˆ°å½“å‰æ™¯ç‚¹çš„ç›¸é‚»æ™¯ç‚¹éƒ½å·²ç»è®¿é—®è¿‡ä¸ºæ­¢ã€‚

å° Z æ‰€æœ‰ç»è¿‡çš„æ™¯ç‚¹æŒ‰é¡ºåºæ„æˆä¸€æ¡éé‡å¤è·¯å¾„ï¼Œä»–æƒ³çŸ¥é“è¿™æ¡è·¯å¾„çš„æœŸæœ›é•¿åº¦æ˜¯å¤šå°‘ï¼Ÿ

å° Z æŠŠæ¸¸ä¹å›­çš„æŠ½è±¡åœ°å›¾ç”»ä¸‹æ¥å¸¦å›äº†å®¶ï¼Œå¯æ˜¯å¿˜äº†æ ‡å“ªä¸ªç‚¹æ˜¯å¤§é—¨ï¼Œä»–åªå¥½å‡è®¾æ¯ä¸ªæ™¯ç‚¹éƒ½å¯èƒ½æ˜¯å¤§é—¨ï¼ˆå³æ¯ä¸ªæ™¯ç‚¹ä½œä¸ºèµ·å§‹ç‚¹çš„æ¦‚ç‡æ˜¯ä¸€æ ·çš„ï¼‰ã€‚åŒæ—¶ï¼Œä»–æ¯æ¬¡åœ¨é€‰æ‹©ä¸‹ä¸€ä¸ªæ™¯ç‚¹æ—¶ä¼šç­‰æ¦‚ç‡åœ°éšæœºé€‰æ‹©ä¸€ä¸ªè¿˜æ²¡å»è¿‡çš„ç›¸é‚»æ™¯ç‚¹ã€‚


## è¯´æ˜/æç¤º

### æ ·ä¾‹è§£é‡Š

æ ·ä¾‹æ•°æ®ä¸­å…±æœ‰ $6$ æ¡ä¸åŒçš„è·¯å¾„ï¼š

|è·¯å¾„|é•¿åº¦|æ¦‚ç‡|
|:-:|:-:|:-:| 
|$1\rightarrow 4$|$8$|$\frac{1}{4}$| 
|$2\rightarrow 1$|$3$|$\frac{1}{8}$| 
|$2\rightarrow 4$|$5$|$\frac{1}{8}$|
|$3\rightarrow 1$|$4$|$\frac{1}{8}$|
|$3\rightarrow 4$|$4$|$\frac{1}{8}$|
|$4\rightarrow 1$|$8$|$\frac{1}{4}$|

å› æ­¤æœŸæœ›é•¿åº¦ $= \frac{8}{4} + \frac{3}{8} + \frac{5}{8} +\frac{4}{8} + \frac{4}{8} +\frac{8}{4} = 6.00$

### è¯„åˆ†æ–¹æ³•

æœ¬é¢˜æ²¡æœ‰éƒ¨åˆ†åˆ†ï¼Œä½ ç¨‹åºçš„è¾“å‡ºåªæœ‰å’Œæ ‡å‡†ç­”æ¡ˆçš„å·®è·ä¸è¶…è¿‡ $0.01$ æ—¶ï¼Œæ‰èƒ½è·å¾—è¯¥æµ‹è¯•ç‚¹çš„æ»¡åˆ†ï¼Œå¦åˆ™ä¸å¾—åˆ†ã€‚


### æ•°æ®è§„æ¨¡å’Œçº¦å®š

å¯¹äº $100\%$ çš„æ•°æ®ï¼Œ$1\leq W_i\leq 100$ã€‚

|æµ‹è¯•ç‚¹ç¼–å·|$n$|$m$|å¤‡æ³¨| 
|:-:|:-:|:-:|:-:|
|$1$| $n=10$| $m = n-1$| ä¿è¯å›¾æ˜¯é“¾çŠ¶ |
|$2$| $n=100$|  $m = n-1$|åªæœ‰èŠ‚ç‚¹ $1$ çš„åº¦æ•°å¤§äº $2$| 
|$3$| $n=1000$| $m = n-1$| / | 
|$4$| $n=10^5$| $m = n-1$| / | 
|$5$| $n=10^5$|  $m = n-1$| / | 
|$6$| $n=10$| $m = n$ | / | 
|$7$| $n=100$| $m = n$| ç¯ä¸­èŠ‚ç‚¹ä¸ªæ•° $\leq 5$| 
|$8$| $n=1000$|$m = n$| ç¯ä¸­èŠ‚ç‚¹ä¸ªæ•° $\leq 10$| 
|$9$| $n=10^5$ | $m = n$| ç¯ä¸­èŠ‚ç‚¹ä¸ªæ•° $\leq 15$| 
|$10$| $n=10^5$|$m = n$| ç¯ä¸­èŠ‚ç‚¹ä¸ªæ•° $\leq 20$| 


## æ ·ä¾‹ #1

### è¾“å…¥

```
4 3
1 2 3
2 3 1
3 4 4```

### è¾“å‡º

```
6.00000000```

# AIåˆ†æç»“æœ


# ğŸ’¡ æ´›è¯­äº‘ç¬ºçš„C++ç®—æ³•è§£æï¼š[NOI2012] è¿·å¤±æ¸¸ä¹å›­ æ·±å…¥å­¦ä¹ æŒ‡å— ğŸ’¡

## 1. é¢˜ç›®è§£è¯»ä¸ç­–ç•¥åˆæ¢

âœ¨ **æœ¬é¢˜æ ¸å¿ƒæŒ‘æˆ˜**ï¼šå¤„ç†åŸºç¯æ ‘ç»“æ„ä¸­çš„éšæœºæ¸¸èµ°æœŸæœ›è·¯å¾„è®¡ç®—ï¼Œç‰¹åˆ«æ˜¯ç¯ä¸ŠèŠ‚ç‚¹çš„åŒå‘ä¾èµ–å…³ç³»å’Œè·¯å¾„ä¸é‡å¤çº¦æŸã€‚

âœ¨ **æ ¸å¿ƒç®—æ³•æ ‡ç­¾**ï¼šåŠ¨æ€è§„åˆ’(DP)ã€åŸºç¯æ ‘å¤„ç†ã€æœŸæœ›è®¡ç®—

ğŸ—£ï¸ **åˆæ­¥åˆ†æ**ï¼š
> æœ¬é¢˜è¦æ±‚è®¡ç®—åœ¨åŸºç¯æ ‘ï¼ˆæ ‘æˆ–å¸¦ä¸€ä¸ªç¯çš„æ— å‘å›¾ï¼‰ä¸Šéšæœºæ¸¸èµ°çš„æœŸæœ›è·¯å¾„é•¿åº¦ã€‚æ ¸å¿ƒéš¾ç‚¹åœ¨äºç¯çš„å­˜åœ¨æ‰“ç ´äº†æ ‘çš„å±‚æ¬¡ç»“æ„ï¼Œä½¿èŠ‚ç‚¹é—´äº§ç”ŸåŒå‘ä¾èµ–ã€‚è§£é¢˜æ€è·¯æ¼”è¿›å¦‚ä¸‹ï¼š
> 1. **æš´åŠ›æœç´¢**ï¼šæšä¸¾æ‰€æœ‰è·¯å¾„ï¼Œä½†O(2^n)å¤æ‚åº¦ä¸å¯è¡Œã€‚
> 2. **æ ‘å½¢DP**ï¼šå¯¹äºçº¯æ ‘ç»“æ„ï¼Œé€šè¿‡ä¸¤æ¬¡DFSï¼ˆdownè®¡ç®—å­æ ‘æœŸæœ›ï¼Œupè®¡ç®—çˆ¶æ–¹å‘æœŸæœ›ï¼‰é«˜æ•ˆè§£å†³ã€‚
> 3. **åŸºç¯æ ‘åˆ†è§£**ï¼šå°†å›¾åˆ†è§£ä¸ºç¯å’Œè¿åœ¨ç¯ä¸Šçš„æ ‘ï¼Œåˆ†åˆ«å¤„ç†å­æ ‘æœŸæœ›å’Œç¯ä¸ŠæœŸæœ›ã€‚
> 
> æœ€ä¼˜è§£é‡‡ç”¨åŠ¨æ€è§„åˆ’ï¼Œæ ¸å¿ƒæ€æƒ³æ˜¯å°†é—®é¢˜åˆ†è§£ï¼š
> - å­æ ‘æœŸæœ›è®¡ç®—ï¼ˆä¸æ ‘å½¢DPç›¸åŒï¼‰
> - ç¯ä¸ŠæœŸæœ›è®¡ç®—ï¼ˆåˆ©ç”¨ç¯å°ç‰¹ç‚¹æšä¸¾ï¼‰
> - é€šè¿‡æ¢æ ¹DPæ•´åˆç»“æœ
> 
> å¯è§†åŒ–è®¾è®¡é‡‡ç”¨åƒç´ é£æ ¼å±•ç¤ºåŸºç¯æ ‘ç»“æ„ï¼Œé«˜äº®å½“å‰è®¡ç®—èŠ‚ç‚¹ï¼ŒåŠ¨æ€æ˜¾ç¤ºæœŸæœ›å€¼ä¼ æ’­è¿‡ç¨‹ã€‚

### ğŸ” ç®—æ³•ä¾¦æ¢ï¼šå¦‚ä½•åœ¨é¢˜ç›®ä¸­å‘ç°çº¿ç´¢ï¼Ÿ
1.  **çº¿ç´¢1 (é—®é¢˜ç›®æ ‡)**ï¼š"ä»ä»»æ„ç‚¹å‡ºå‘ï¼Œéšæœºé€‰æ‹©æœªè®¿é—®é‚»å±…ï¼Œæ±‚æœŸæœ›è·¯å¾„é•¿åº¦"â€”â€”è¿™æ˜¯å…¸å‹çš„**æœŸæœ›è®¡ç®—é—®é¢˜**ï¼Œéœ€ç”¨æ¦‚ç‡DPå»ºæ¨¡ã€‚
2.  **çº¿ç´¢2 (é—®é¢˜çº¦æŸ)**ï¼š"å›¾ä¸­è‡³å¤šä¸€ä¸ªç¯"â€”â€”æŒ‡å‘**åŸºç¯æ ‘ç‰¹æ®Šå¤„ç†**ï¼Œéœ€å°†ç¯ä¸æ ‘åˆ†ç¦»å¤„ç†ã€‚
3.  **çº¿ç´¢3 (æ•°æ®è§„æ¨¡)**ï¼šnâ‰¤10^5ä½†ç¯â‰¤20â€”â€”æš—ç¤º**æš´åŠ›å¤„ç†ç¯**å¯è¡Œï¼ˆO(kÂ²)ï¼‰ï¼Œè€Œæ ‘éƒ¨åˆ†éœ€O(n)ç®—æ³•ã€‚

### ğŸ§  æ€ç»´é“¾æ„å»ºï¼šä»çº¿ç´¢åˆ°ç­–ç•¥
> ç»¼åˆçº¿ç´¢ï¼š
> 1. æœŸæœ›é—®é¢˜éœ€DPï¼Œä½†ç¯æ‰“ç ´å•å‘ä¾èµ–
> 2. åŸºç¯æ ‘å¯åˆ†è§£ä¸ºç¯+å­æ ‘
> 3. ç¯å°å¯æšä¸¾ï¼Œæ ‘å¤§éƒ¨åˆ†ç”¨é«˜æ•ˆæ ‘å½¢DP
> 
> **ç»“è®º**ï¼šé‡‡ç”¨**åˆ†æ²»ç­–ç•¥**ï¼š
> 1. æ ‘å½¢DPè®¡ç®—å­æ ‘æœŸæœ›ï¼ˆdownæ•°ç»„ï¼‰
> 2. æšä¸¾ç¯ä¸Šèµ·ç‚¹è®¡ç®—ç¯ä¸ŠæœŸæœ›ï¼ˆupæ•°ç»„ï¼‰
> 3. æ¢æ ¹DPæ•´åˆç»“æœ
> 
> è¿™æ­£æ˜¯åŠ¨æ€è§„åˆ’åœ¨åŸºç¯æ ‘ä¸Šçš„åˆ›æ–°åº”ç”¨ï¼

---

## 2. ç²¾é€‰ä¼˜è´¨é¢˜è§£å‚è€ƒ

### é¢˜è§£ä¸€ï¼ˆemptysetvvvvï¼‰
* **äº®ç‚¹**ï¼š
  - æ¸…æ™°å®šä¹‰down[u]/up[u]åŒºåˆ†æ–¹å‘
  - ç¯å¤„ç†ï¼šé¡º/é€†æ—¶é’ˆåŒæ–¹å‘æ¦‚ç‡å„0.5
  - ä»£ç è§„èŒƒï¼Œé¢„å¤„ç†ç¯ä¿¡æ¯
* **æ ¸å¿ƒæ€æƒ³**ï¼š
  ```cpp
  // å­æ ‘æœŸæœ›è®¡ç®—
  void dfsDown(int u, int fa) {
      for (auto [v, w] : G[u]) {
          if (v == fa || inCycle[v]) continue;
          dfsDown(v, u);
          down[u] += (down[v] + w) / sonCount;
      }
  }
  
  // ç¯ä¸ŠæœŸæœ›è®¡ç®—
  void calcCycleUp() {
      for (int u : cycle) {
          double path = 0.0, prob = 0.5;
          // é¡ºæ—¶é’ˆèµ°
          for (int cur = nextInCycle(u); cur != u; cur = nextInCycle(cur)) {
              path += prob * (edgeWeight + down[cur] * (deg[cur]-1)/deg[cur]);
              prob /= deg[cur];
          }
          up[u] = path; // åŒç†é€†æ—¶é’ˆ
      }
  }
  ```

### é¢˜è§£äºŒï¼ˆGKxxï¼‰
* **äº®ç‚¹**ï¼š
  - ä¸¥æ ¼åˆ†ç¦»æ ‘/åŸºç¯æ ‘å¤„ç†æ¨¡å—
  - ç¯ä¸ŠDFSé‡‡ç”¨è®°å¿†åŒ–å‡å°‘é‡å¤è®¡ç®—
* **æ ¸å¿ƒæŠ€å·§**ï¼š
  ```cpp
  // ç¯ä¸ŠDP
  double dfsCycle(int u, int start, int dir) {
      if (next[u] == start) return down[u]; // è¿”å›å­æ ‘
      return (down[u] * (deg[u]-1) + dfsCycle(next[u], start, dir)) / deg[u];
  }
  ```

---

## 3. è§£é¢˜ç­–ç•¥æ·±åº¦å‰–æ

### ğŸ¯ æ ¸å¿ƒéš¾ç‚¹ä¸å…³é”®æ­¥éª¤
1.  **éš¾ç‚¹1ï¼šåŸºç¯æ ‘åˆ†è§£**
    * **åˆ†æ**ï¼šé€šè¿‡DFSæ‰¾ç¯å¹¶æ ‡è®°ç¯ä¸ŠèŠ‚ç‚¹ï¼ˆ`in_cycle[]`ï¼‰ï¼Œå°†å›¾åˆ†è§£ä¸ºç¯+å¤šæ£µå­æ ‘
    * ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šç¯æ˜¯åŸºç¯æ ‘çš„æ ¸å¿ƒï¼Œåˆ†ç¦»ç¯ä¸æ ‘æ˜¯è§£é¢˜å…³é”®

2.  **éš¾ç‚¹2ï¼šç¯ä¸ŠæœŸæœ›è®¡ç®—**
    * **åˆ†æ**ï¼š
      ```python
      up[u] = 0.5 * (é¡ºæ—¶é’ˆæœŸæœ›) + 0.5 * (é€†æ—¶é’ˆæœŸæœ›)
      é¡ºæ—¶é’ˆæœŸæœ› = Î£ [æ¦‚ç‡ * (è¾¹æƒ + down[v] * (deg[v]-1)/deg[v])]
      ```
    * ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šç¯ä¸Šè®¡ç®—éœ€è€ƒè™‘æ–¹å‘æ¦‚ç‡å’Œå­æ ‘è¿›å…¥æ¦‚ç‡

3.  **éš¾ç‚¹3ï¼šæ¢æ ¹DPæ•´åˆ**
    * **åˆ†æ**ï¼šç”¨ç¯ä¸ŠèŠ‚ç‚¹çš„upæ›´æ–°å­æ ‘èŠ‚ç‚¹çš„up
      ```cpp
      up[v] = w + (up[u]*facnt + down[u]*soncnt - down[v] - w) / (facnt+soncnt-1)
      ```
    * ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šæ¢æ ¹DPå®ç°ä¿¡æ¯é«˜æ•ˆä¼ é€’

### âœ¨ è§£é¢˜æŠ€å·§æ€»ç»“
- **é—®é¢˜åˆ†è§£**ï¼šåŸºç¯æ ‘ â†’ ç¯ + å­æ ‘
- **æ–¹å‘å¤„ç†**ï¼šç¯ä¸Šé¡º/é€†æ—¶é’ˆç‹¬ç«‹è®¡ç®—
- **æ¦‚ç‡æ•´åˆ**ï¼šä¹˜æ³•åŸç†è®¡ç®—å¤åˆæ¦‚ç‡
- **æ•°æ®ç»“æ„**ï¼šæ•°ç»„å­˜å‚¨ç¯èŠ‚ç‚¹é¡ºåº

### âš”ï¸ ç­–ç•¥ç«æŠ€åœºï¼šä¸åŒè§£æ³•å¯¹æ¯”
| ç­–ç•¥          | æ ¸å¿ƒæ€æƒ³               | ä¼˜ç‚¹              | ç¼ºç‚¹                     | å¾—åˆ†é¢„æœŸ |
|---------------|------------------------|-------------------|--------------------------|----------|
| **æš´åŠ›æœç´¢**  | æšä¸¾æ‰€æœ‰è·¯å¾„           | ç›´è§‚              | O(2â¿)è¶…æ—¶               | 0-30%   |
| **æ ‘å½¢DP**    | ä¸¤æ¬¡DFSè®¡ç®—æœŸæœ›        | O(n)é«˜æ•ˆ          | ä¸å¤„ç†ç¯                 | 50%     |
| **åŸºç¯æ ‘DP**  | åˆ†è§£ç¯+å­æ ‘åˆ†åˆ«å¤„ç†    | O(n+kÂ²) é«˜æ•ˆé€šè¿‡  | å®ç°å¤æ‚                 | 100%    |

### âœ¨ ä¼˜åŒ–ä¹‹æ—…ï¼šä»â€œèƒ½åšâ€åˆ°â€œåšå¥½â€
> 1. **èµ·ç‚¹**ï¼šæš´åŠ›æœç´¢ï¼ˆæŒ‡æ•°çº§ï¼‰â†’ å‘ç°é‡å¤å­é—®é¢˜
> 2. **çªç ´**ï¼šæ ‘å½¢DPï¼ˆçº¿æ€§ï¼‰â†’ ä½†æ— æ³•å¤„ç†ç¯
> 3. **å…³é”®è½¬åŒ–**ï¼šå°†ç¯è§†ä¸ºç‰¹æ®Šæ ¹ï¼Œå­æ ‘æœŸæœ›å¤ç”¨æ ‘å½¢DP
> 4. **æœ€ç»ˆä¼˜åŒ–**ï¼šç¯ä¸ŠO(kÂ²)å¤„ç† + æ¢æ ¹DP â†’ O(n+kÂ²)
> 
> ğŸ’¡ **ç­–ç•¥æ€»ç»“**ï¼š"é€šè¿‡åˆ†è§£é—®é¢˜ç»“æ„å’Œå¤ç”¨å­é—®é¢˜è§£å†³æ–¹æ¡ˆï¼Œå°†æŒ‡æ•°çº§ä¼˜åŒ–åˆ°çº¿æ€§+å¸¸æ•°çº§ï¼Œä½“ç°äº†åˆ†æ²»æ€æƒ³å’ŒDPçš„å¨åŠ›"

---

## 4. C++æ ¸å¿ƒä»£ç å®ç°èµæ

### é€šç”¨æ ¸å¿ƒå®ç°ï¼ˆåŸºç¯æ ‘DPï¼‰
```cpp
#include <cstdio>
#include <vector>
#include <cstring>
using namespace std;
const int MAXN = 1e5+5;
vector<pair<int, int>> G[MAXN]; // {é‚»å±…, è¾¹æƒ}
bool inCycle[MAXN];             // æ˜¯å¦åœ¨ç¯ä¸Š
vector<int> cycle;               // ç¯ä¸ŠèŠ‚ç‚¹
double down[MAXN], up[MAXN];     // å­æ ‘æœŸæœ›ï¼Œå‘ä¸ŠæœŸæœ›
int deg[MAXN];                  // åº¦æ•°

// æ‰¾ç¯ï¼ˆDFSï¼‰
bool findCycle(int u, int fa) {
    static bool vis[MAXN] = {};
    static int parent[MAXN] = {};
    vis[u] = true;
    for (auto [v, w] : G[u]) {
        if (v == fa) continue;
        if (!vis[v]) {
            parent[v] = u;
            if (findCycle(v, u)) return true;
        } else if (!cycle.size()) { // æ‰¾åˆ°æ–°ç¯
            for (int cur = u; cur != v; cur = parent[cur])
                cycle.push_back(cur), inCycle[cur] = true;
            cycle.push_back(v), inCycle[v] = true;
            return true;
        }
    }
    return false;
}

// è®¡ç®—å­æ ‘æœŸæœ›
void dfsDown(int u, int fa) {
    down[u] = 0;
    int cnt = 0;
    for (auto [v, w] : G[u]) {
        if (v == fa || inCycle[v]) continue;
        dfsDown(v, u);
        cnt++;
        down[u] += down[v] + w;
    }
    if (cnt) down[u] /= cnt;
}

// è®¡ç®—ç¯ä¸ŠæœŸæœ›
void calcCycleUp() {
    int k = cycle.size();
    for (int i = 0; i < k; i++) {
        int u = cycle[i];
        double prob = 0.5, sum = 0;
        
        // é¡ºæ—¶é’ˆ
        for (int j = (i+1)%k, step=1; j != i; j=(j+1)%k, step++) {
            int v = cycle[j];
            if (step == k-1) // æœ€åèŠ‚ç‚¹åªèƒ½èµ°å­æ ‘
                sum += prob * (down[v] + G[u][v]); 
            else
                sum += prob * (down[v]*(deg[v]-1)/deg[v] + G[u][v]);
            prob /= deg[v]; // æ›´æ–°æ¦‚ç‡
        }
        up[u] = sum;
        // åŒç†é€†æ—¶é’ˆ...
    }
}

// æ¢æ ¹DPæ›´æ–°å­æ ‘
void dfsUp(int u, int fa) {
    for (auto [v, w] : G[u]) {
        if (v == fa || inCycle[v]) continue;
        double other = (up[u]*(inCycle[u]?2:1) + down[u]*deg[u] - down[v] - w) / (deg[u]-1);
        up[v] = w + other;
        dfsUp(v, u);
    }
}

int main() {
    // è¯»å…¥å›¾
    findCycle(1, 0); // æ‰¾ç¯
    for (int u : cycle) dfsDown(u, 0); // è®¡ç®—å­æ ‘
    calcCycleUp(); // ç¯ä¸ŠæœŸæœ›
    for (int u : cycle) dfsUp(u, 0); // æ¢æ ¹æ›´æ–°
    
    double ans = 0;
    for (int i = 1; i <= n; i++) {
        double res = inCycle[i] ? 
            (down[i]*(deg[i]-2)+up[i])/deg[i] : 
            (down[i]*(deg[i]-1)+up[i])/deg[i];
        ans += res;
    }
    printf("%.5f\n", ans / n);
}
```

### ä»£ç äº®ç‚¹è§£æ
1. **ç¯å¤„ç†**ï¼š`findCycle` ç”¨DFSæ‰¾ç¯å¹¶æ ‡è®°
2. **æœŸæœ›è®¡ç®—**ï¼š
   - `dfsDown`ï¼šæ ‡å‡†æ ‘å½¢DPè®¡ç®—å­æ ‘æœŸæœ›
   - `calcCycleUp`ï¼šç¯ä¸ŠèŠ‚ç‚¹é¡º/é€†åŒæ–¹å‘æ¦‚ç‡è®¡ç®—
3. **æ¢æ ¹æ•´åˆ**ï¼š`dfsUp`ç”¨çˆ¶èŠ‚ç‚¹æ›´æ–°å­èŠ‚ç‚¹æœŸæœ›

---

## 5. ç®—æ³•å¯è§†åŒ–ï¼šåƒç´ åŠ¨ç”»æ¼”ç¤º

**è®¾è®¡è¯´æ˜**ï¼šé‡‡ç”¨8-bitåƒç´ é£æ ¼ï¼Œå¯è§†åŒ–åŸºç¯æ ‘ç»“æ„å’ŒæœŸæœ›ä¼ æ’­è¿‡ç¨‹

**åŠ¨ç”»æµç¨‹**ï¼š
1. **åœºæ™¯åˆå§‹åŒ–**ï¼šåƒç´ ç½‘æ ¼æ˜¾ç¤ºåŸºç¯æ ‘ï¼ˆç¯ä¸ºçº¢è‰²ï¼Œå­æ ‘ä¸ºç»¿è‰²ï¼‰
   ```plaintext
   [1]-[2]â€”[5]   ç¯ï¼š1-2-3-4
    |   |    |   å­æ ‘ï¼š5,6,7
   [3]-[4] [6]
          |
         [7]
   ```

2. **å­æ ‘è®¡ç®—é˜¶æ®µ**ï¼š
   - å¶å­èŠ‚ç‚¹[5][6][7]æ˜¾ç¤ºdown=0
   - å‘ä¸Šä¼ æ’­ï¼šèŠ‚ç‚¹[2]æ˜¾ç¤ºdown=(w+0)/1

3. **ç¯ä¸Šè®¡ç®—é˜¶æ®µ**ï¼š
   - é€‰æ‹©èŠ‚ç‚¹[1]ï¼Œæ˜¾ç¤ºé¡ºæ—¶é’ˆ(0.5æ¦‚ç‡)
   - è·¯å¾„é«˜äº®ï¼š1â†’2â†’3â†’4
   - å®æ—¶æ˜¾ç¤ºæ¦‚ç‡è¡°å‡ï¼š0.5 â†’ 0.25 â†’...

4. **æ¢æ ¹æ›´æ–°**ï¼š
   - ä»ç¯ä¸ŠèŠ‚ç‚¹[2]å‡ºå‘ï¼Œæ›´æ–°å­æ ‘[5]çš„upå€¼
   - ç®­å¤´åŠ¨ç”»æ˜¾ç¤ºæœŸæœ›å€¼ä¼ æ’­

**äº¤äº’æ§åˆ¶**ï¼š
- æ­¥è¿›æŒ‰é’®ï¼šå•æ­¥æ‰§è¡Œç®—æ³•
- é€Ÿåº¦æ»‘å—ï¼šè°ƒæ•´åŠ¨ç”»é€Ÿåº¦
- æ¨¡å¼åˆ‡æ¢ï¼šæ ‘/åŸºç¯æ ‘æ¼”ç¤º

**éŸ³æ•ˆè®¾è®¡**ï¼š
- èŠ‚ç‚¹æ›´æ–°ï¼š8-bit "å˜€"å£°
- æ–¹å‘åˆ‡æ¢ï¼šä¸åŒéŸ³è°ƒæç¤º
- è®¡ç®—å®Œæˆï¼šèƒœåˆ©æ—‹å¾‹

---

## 6. æ‹“å±•ç»ƒä¹ ä¸ç›¸ä¼¼é—®é¢˜

### ç›¸ä¼¼é—®é¢˜æ€ç»´è¿ç§»
1. **åˆ†ç»„èƒŒåŒ…**ï¼šç¯ä¸Šé€‰æ‹©â‡’èƒŒåŒ…åˆ†ç»„ï¼ˆå¦‚[P1064 é‡‘æ˜çš„é¢„ç®—æ–¹æ¡ˆ](https://www.luogu.com.cn/problem/P1064)ï¼‰
2. **æ ‘å½¢DPæ‰©å±•**ï¼šæ¢æ ¹DPåº”ç”¨ï¼ˆå¦‚[P3478 STA-Station](https://www.luogu.com.cn/problem/P3478)ï¼‰
3. **åŸºç¯æ ‘è¿›é˜¶**ï¼šç¯ä¸ŠDPå˜å½¢ï¼ˆå¦‚[P2607 éª‘å£«](https://www.luogu.com.cn/problem/P2607)ï¼‰

### æ¨èç»ƒä¹ 
1. **æ´›è°·P2014** - é€‰è¯¾
   - ç†ç”±ï¼šæ ‘å½¢ä¾èµ–èƒŒåŒ…ï¼Œå·©å›ºåˆ†ç»„DPæ€æƒ³
   
2. **æ´›è°·P5022** - æ—…è¡Œ
   - ç†ç”±ï¼šåŸºç¯æ ‘åº”ç”¨ï¼Œå¼ºåŒ–ç¯å¤„ç†èƒ½åŠ›

3. **æ´›è°·P2607** - éª‘å£«
   - ç†ç”±ï¼šåŸºç¯æ ‘DPè¿›é˜¶ï¼Œç¯ä¸Šå†³ç­–ä¼˜åŒ–

---

## 7. å­¦ä¹ å¿ƒå¾—ä¸ç»éªŒåˆ†äº«
> ä½œè€…emptysetvvvvå¿ƒå¾—ï¼š
> "è°ƒè¯•æ—¶å‘ç°ç¯ä¸Šæ¦‚ç‡è®¡ç®—é”™è¯¯ï¼Œé€šè¿‡æ‰“å°æ¯ä¸€æ­¥çš„æ¦‚ç‡å€¼å®šä½åˆ°åˆ†æ¯æœªæ›´æ–°é—®é¢˜ã€‚å¯ç¤ºï¼š**æ¦‚ç‡DPéœ€é€æ­¥éªŒè¯è½¬ç§»å…¬å¼**"
>
> **æ´›è¯­äº‘ç¬ºæ€»ç»“**ï¼š
> 1. åŸºç¯æ ‘æ ¸å¿ƒï¼šåˆ†ç¦»ç¯ä¸æ ‘
> 2. ç¯å¤„ç†è¦ç‚¹ï¼šåŒæ–¹å‘ç‹¬ç«‹è®¡ç®—+æ¦‚ç‡è¡°å‡
> 3. è°ƒè¯•æŠ€å·§ï¼šä¸­é—´å˜é‡è¾“å‡ºéªŒè¯
> 
> ç‰¢è®°ï¼š**å¤æ‚é—®é¢˜åˆ†è§£æ˜¯ç‹é“ï¼ŒDPçŠ¶æ€å®šä¹‰æ˜¯å…³é”®**

---

> æœ¬æ¬¡è§£ææ·±å…¥å‰–æäº†åŸºç¯æ ‘æœŸæœ›é—®é¢˜çš„è§£æ³•ç²¾é«“ï¼Œé€šè¿‡åˆ†æ²»æ€æƒ³å’ŒåŠ¨æ€è§„åˆ’å®ç°é«˜æ•ˆç®—æ³•ã€‚è®°ä½ï¼šæ ‘æ˜¯ç¯çš„åŸºç¡€ï¼Œç¯æ˜¯æ ‘çš„æ‰©å±•ï¼ŒæŒæ¡æ­¤æ€ç»´å¯è§£æ›´å¤šå›¾è®ºéš¾é¢˜ï¼ğŸ’ª

---
å¤„ç†ç”¨æ—¶ï¼š244.67ç§’
# é¢˜ç›®ä¿¡æ¯

# [HNOI2014] ä¸–ç•Œæ ‘

## é¢˜ç›®æè¿°

ä¸–ç•Œæ ‘æ˜¯ä¸€æ£µæ— æ¯”å·¨å¤§çš„æ ‘ï¼Œå®ƒä¼¸å‡ºçš„æå¹²æ„æˆäº†æ•´ä¸ªä¸–ç•Œã€‚åœ¨è¿™é‡Œï¼Œç”Ÿå­˜ç€å„ç§å„æ ·çš„ç§æ—å’Œç”Ÿçµï¼Œä»–ä»¬å…±åŒä¿¡å¥‰ç€ç»å¯¹å…¬æ­£å…¬å¹³çš„å¥³ç¥è‰¾è‰æ£®ï¼Œåœ¨ä»–ä»¬çš„ä¿¡æ¡é‡Œï¼Œå…¬å¹³æ˜¯ä½¿ä¸–ç•Œæ ‘èƒ½å¤Ÿç”Ÿç”Ÿä¸æ¯ã€æŒç»­è¿è½¬çš„æ ¹æœ¬åŸºçŸ³ã€‚

ä¸–ç•Œæ ‘çš„å½¢æ€å¯ä»¥ç”¨ä¸€ä¸ªæ•°å­¦æ¨¡å‹æ¥æè¿°ï¼šä¸–ç•Œæ ‘ä¸­æœ‰ $n$ ä¸ªç§æ—ï¼Œç§æ—çš„ç¼–å·åˆ†åˆ«ä» $1$ åˆ° $n$ï¼Œåˆ†åˆ«ç”Ÿæ´»åœ¨ç¼–å·ä¸º $1$ åˆ° $n$ çš„èšå±…åœ°ä¸Šï¼Œç§æ—çš„ç¼–å·ä¸å…¶èšå±…åœ°çš„ç¼–å·ç›¸åŒã€‚æœ‰çš„èšå±…åœ°ä¹‹é—´æœ‰åŒå‘çš„é“è·¯ç›¸è¿ï¼Œé“è·¯çš„é•¿åº¦ä¸º $1$ã€‚ä¿è¯è¿æ¥çš„æ–¹å¼ä¼šå½¢æˆä¸€æ£µæ ‘ç»“æ„ï¼Œå³æ‰€æœ‰çš„èšå±…åœ°ä¹‹é—´å¯ä»¥äº’ç›¸åˆ°è¾¾ï¼Œå¹¶ä¸”ä¸ä¼šå‡ºç°ç¯ã€‚å®šä¹‰ä¸¤ä¸ªèšå±…åœ°ä¹‹é—´çš„è·ç¦»ä¸ºè¿æ¥ä»–ä»¬çš„é“è·¯çš„é•¿åº¦ï¼›ä¾‹å¦‚ï¼Œè‹¥èšå±…åœ° $a$ å’Œ $b$ ä¹‹é—´æœ‰é“è·¯ï¼Œ$b$ å’Œ $c$ ä¹‹é—´æœ‰é“è·¯ï¼Œå› ä¸ºæ¯æ¡é“è·¯é•¿åº¦ä¸º $1$ è€Œä¸”åˆä¸å¯èƒ½å‡ºç°ç¯ï¼Œæ‰€ä»¥ $a$ ä¸ $c$ ä¹‹é—´çš„è·ç¦»ä¸º $2$ã€‚

å‡ºäºå¯¹å…¬å¹³çš„è€ƒè™‘ï¼Œç¬¬ $i$ å¹´ï¼Œä¸–ç•Œæ ‘çš„å›½ç‹éœ€è¦æˆæƒ $m_i$ ä¸ªç§æ—çš„èšå±…åœ°ä¸ºä¸´æ—¶è®®äº‹å¤„ã€‚å¯¹äºæŸä¸ªç§æ— $x$ï¼ˆ$x$ ä¸ºç§æ—çš„ç¼–å·ï¼‰ï¼Œå¦‚æœè·ç¦»è¯¥ç§æ—æœ€è¿‘çš„ä¸´æ—¶è®®äº‹å¤„ä¸º $y$ï¼ˆ$y$ ä¸ºè®®äº‹å¤„æ‰€åœ¨èšå±…åœ°çš„ç¼–å·ï¼‰ï¼Œåˆ™ç§æ— $x$ å°†æ¥å— $y$ è®®äº‹å¤„çš„ç®¡è¾–ï¼ˆå¦‚æœæœ‰å¤šä¸ªä¸´æ—¶è®®äº‹å¤„åˆ°è¯¥èšå±…åœ°çš„è·ç¦»ä¸€æ ·ï¼Œåˆ™ $y$ ä¸ºå…¶ä¸­ç¼–å·æœ€å°çš„ä¸´æ—¶è®®äº‹å¤„ï¼‰ã€‚

ç°åœ¨å›½ç‹æƒ³çŸ¥é“ï¼Œåœ¨ $q$ å¹´çš„æ—¶é—´é‡Œï¼Œæ¯ä¸€å¹´å®Œæˆæˆæƒåï¼Œå½“å¹´æ¯ä¸ªä¸´æ—¶è®®äº‹å¤„å°†ä¼šç®¡ç†å¤šå°‘ä¸ªç§æ—ï¼ˆè®®äº‹å¤„æ‰€åœ¨çš„èšå±…åœ°ä¹Ÿå°†æ¥å—è¯¥è®®äº‹å¤„ç®¡ç†ï¼‰ã€‚ ç°åœ¨è¿™ä¸ªä»»åŠ¡äº¤ç»™äº†ä»¥æ™ºæ…§è‘—ç§°çš„çµé•¿ç±»çš„ä½ ï¼šç¨‹åºçŒ¿ã€‚è¯·å¸®å›½ç‹å®Œæˆè¿™ä¸ªä»»åŠ¡å§ã€‚

## è¯´æ˜/æç¤º

å¯¹äº $100\%$ çš„æ•°æ®ï¼Œ$N\leq 300000$, $q\leq 300000$, $\sum^q_{i=1}m_i \leq 300000$ã€‚


## æ ·ä¾‹ #1

### è¾“å…¥

```
10
2 1
3 2
4 3
5 4
6 1
7 3
8 3
9 4
10 1
5
2
6 1
5
2 7 3 6 9
1
8
4
8 7 10 3
5
2 9 3 5 8```

### è¾“å‡º

```
1 9   
3 1 4 1 1   
10  
1 1 3 5   
4 1 3 1 1```

# AIåˆ†æç»“æœ


# ğŸ’¡ æ´›è¯­äº‘ç¬ºçš„C++ç®—æ³•è§£æï¼š[HNOI2014]ä¸–ç•Œæ ‘ æ·±å…¥å­¦ä¹ æŒ‡å— ğŸ’¡

> **æœ¬é¢˜æ ¸å¿ƒæŒ‘æˆ˜**ï¼šå¦‚ä½•åœ¨åºå¤§çš„æ ‘å½¢ç»“æ„ä¸Šé«˜æ•ˆå¤„ç†å¤šç»„å…³é”®ç‚¹ç®¡è¾–èŒƒå›´æŸ¥è¯¢ï¼ŒåŒæ—¶è§£å†³"ä¸»ä»¶-é™„ä»¶"å¼ä¾èµ–å…³ç³»å¸¦æ¥çš„å†³ç­–çº¦æŸã€‚  
> **æ ¸å¿ƒç®—æ³•æ ‡ç­¾**ï¼šè™šæ ‘ã€åŠ¨æ€è§„åˆ’ã€å€å¢LCAã€æ ‘ä¸Šè·ç¦»è®¡ç®—

## 1. é¢˜ç›®è§£è¯»ä¸ç­–ç•¥åˆæ¢

âœ¨ **æ ¸å¿ƒæŒ‘æˆ˜åˆ†æ**ï¼š  
æœ¬é¢˜è¦æ±‚åœ¨å¤šç»„è¯¢é—®ä¸­ï¼Œå¿«é€Ÿç¡®å®šæ¯ä¸ªä¸´æ—¶è®®äº‹å¤„ç®¡ç†çš„èŠ‚ç‚¹æ•°é‡ã€‚æ ¸å¿ƒéš¾ç‚¹åœ¨äºï¼š
1. **æ ‘å½¢è§„æ¨¡åºå¤§**ï¼šèŠ‚ç‚¹æ•°è¾¾30ä¸‡ï¼Œè¯¢é—®æ•°è¾¾30ä¸‡
2. **ä¾èµ–å…³ç³»å¤æ‚**ï¼šèŠ‚ç‚¹ç®¡è¾–å…³ç³»å—æœ€è¿‘è·ç¦»çº¦æŸ
3. **æ•°æ®çº¦æŸç‰¹æ®Š**ï¼šâˆ‘m_i â‰¤ 300,000 æç¤ºéœ€å‹ç¼©é—®é¢˜è§„æ¨¡

ğŸ—£ï¸ **åˆæ­¥åˆ†æ**ï¼š
> 1. **æš´åŠ›æœç´¢**ï¼šæšä¸¾æ¯ä¸ªèŠ‚ç‚¹çš„æœ€è¿‘è®®äº‹å¤„ï¼ŒO(nq) è¶…æ—¶
> 2. **è™šæ ‘ä¼˜åŒ–**ï¼šåˆ©ç”¨å…³é”®ç‚¹æ€»æ•°é™åˆ¶ï¼Œæ„å»ºè™šæ ‘å‹ç¼©è§„æ¨¡
> 3. **ä¸¤é˜¶æ®µDP**ï¼š
>    - ç¬¬ä¸€é˜¶æ®µï¼šè‡ªåº•å‘ä¸Šè®¡ç®—å­æ ‘å†…æœ€è¿‘è®®äº‹å¤„
>    - ç¬¬äºŒé˜¶æ®µï¼šè‡ªé¡¶å‘ä¸‹æ›´æ–°å­æ ‘å¤–å½±å“
> 4. **è¾¹ç•Œå¤„ç†**ï¼šå€å¢æ³•ç²¾å‡†å®šä½è™šæ ‘è¾¹ä¸Šçš„ç®¡è¾–åˆ†ç•Œç‚¹

### ğŸ” ç®—æ³•ä¾¦æ¢ï¼šå¦‚ä½•åœ¨é¢˜ç›®ä¸­å‘ç°çº¿ç´¢ï¼Ÿ
1. **çº¿ç´¢1ï¼ˆé—®é¢˜ç›®æ ‡ï¼‰**ï¼š  
   "æ±‚æ¯ä¸ªä¸´æ—¶è®®äº‹å¤„ç®¡ç†çš„èŠ‚ç‚¹æ•°" + "è·ç¦»æœ€è¿‘" â†’ å…¸å‹çš„**æœ€è¿‘é‚»æœç´¢é—®é¢˜**ï¼Œæš—ç¤ºéœ€è¦é«˜æ•ˆè·ç¦»è®¡ç®—ï¼ˆLCAï¼‰å’ŒåŒºåŸŸåˆ’åˆ†

2. **çº¿ç´¢2ï¼ˆæ•°æ®ç‰¹å¾ï¼‰**ï¼š  
   âˆ‘m_i â‰¤ 300,000 â†’ å¼ºçƒˆçš„**è™šæ ‘ä½¿ç”¨ä¿¡å·**ï¼Œé€šè¿‡å‹ç¼©è§„æ¨¡å°†å¤æ‚åº¦ä»O(nq)é™ä¸ºO(âˆ‘m_i logn)

3. **çº¿ç´¢3ï¼ˆæ ‘å½¢ç»“æ„ï¼‰**ï¼š  
   ç®¡è¾–èŒƒå›´ç”±æœ€è¿‘è·ç¦»å†³å®š â†’ éœ€è¦**æ ‘ä¸ŠåŠ¨æ€è§„åˆ’**ç»´æŠ¤æ¯ä¸ªç‚¹çš„æœ€è¿‘è®®äº‹å¤„ä¿¡æ¯

### ğŸ§  æ€ç»´é“¾æ„å»ºï¼šä»çº¿ç´¢åˆ°ç­–ç•¥
> 1. **é—®é¢˜ç›®æ ‡åˆ†æ**ï¼šæœ€è¿‘é‚»æœç´¢ + æ ‘å½¢ç»“æ„ â†’ ç«‹å³æ’é™¤O(nq)æš´åŠ›
> 2. **æ•°æ®è§„æ¨¡å¯ç¤º**ï¼šâˆ‘m_ié™åˆ¶æŒ‡å‘è™šæ ‘ä¼˜åŒ–
> 3. **ä¾èµ–å…³ç³»å¤„ç†**ï¼š
>    - è™šæ ‘è¾¹å¯¹åº”åŸæ ‘è·¯å¾„ â†’ å€å¢æ³•æ‰¾åˆ†ç•Œç‚¹
>    - éè™šæ ‘èŠ‚ç‚¹å½’å± â†’ é€šè¿‡å­æ ‘å¤§å°å·®åˆ†ç»Ÿè®¡
> 4. **å¤æ‚åº¦éªŒè¯**ï¼šè™šæ ‘å¤§å°O(m_i)ï¼Œå€å¢O(logn)ï¼Œæ€»å¤æ‚åº¦O(âˆ‘m_i logn) â‰ˆ 300,000*20 = 6e6ï¼Œå®Œç¾åŒ¹é…çº¦æŸ

---

## 2. ç²¾é€‰ä¼˜è´¨é¢˜è§£å‚è€ƒ

**é¢˜è§£ä¸€ï¼šMCAdamï¼ˆèµ86ï¼‰**  
* **æ ¸å¿ƒæ€è·¯**ï¼š  
  1. ä¸¤éDFSè®¡ç®—ç®¡è¾–å…³ç³»ï¼ˆå­æ ‘å†…+çˆ¶èŠ‚ç‚¹æ›´æ–°ï¼‰
  2. è™šæ ‘è¾¹åˆ†ç•Œç‚¹ç²¾å‡†è®¡ç®—
  3. éè™šæ ‘èŠ‚ç‚¹é€šè¿‡å­æ ‘å·®åˆ†ç»Ÿè®¡  
* **äº®ç‚¹**ï¼š
  - å®Œæ•´è¦†ç›–è™šæ ‘æ„å»ºã€DPæ›´æ–°ã€è¾¹ç•Œå¤„ç†å…¨æµç¨‹
  - åˆ†ç•Œç‚¹è®¡ç®—é‡‡ç”¨æ·±åº¦å·®ä¼˜åŒ–ï¼Œé¿å…å†—ä½™è®¡ç®—
  - ä»£ç æ¨¡å—åŒ–æ¸…æ™°ï¼ˆ`dfs1`/`dfs2`/`calc`åˆ†å·¥æ˜ç¡®ï¼‰

**é¢˜è§£äºŒï¼šGoldenPotato137ï¼ˆèµ9ï¼‰**  
* **æ ¸å¿ƒæ€è·¯**ï¼š
  1. è™šæ ‘æ„å»ºååˆ†ç±»ç»Ÿè®¡ï¼š
    - è™šæ ‘èŠ‚ç‚¹ç›´æ¥å½’å±
    - è™šæ ‘è¾¹åˆ†ç•Œå¤„ç†
    - éè™šæ ‘å­æ ‘æ•´ä½“å½’å±
* **äº®ç‚¹**ï¼š
  - ç‹¬åˆ›"å¤±è¸ªäººå£"ç»Ÿè®¡æ³•å¤„ç†æœªåˆ†é…èŠ‚ç‚¹
  - åˆ†ç•Œç‚¹è®¡ç®—æ•°å­¦å…¬å¼æ¸…æ™°ï¼š`dis = (d1+d2+1)/2`
  - è¯¦å°½çš„è°ƒè¯•å¿ƒå¾—åˆ†äº«ï¼Œå…·æ•™å­¦ä»·å€¼

**é¢˜è§£ä¸‰ï¼škczno1ï¼ˆèµ7ï¼‰**  
* **æ ¸å¿ƒæ€è·¯**ï¼š
  1. ä¸‰è‰²æ ‡è®°æ³•ï¼š
    - åˆå§‹æŸ“è‰²ï¼šè™šæ ‘æ ¹ç®¡è¾–å…¨åŸŸ
    - è¾¹æ›´æ–°ï¼šé‡æ–°æŸ“è‰²åˆ†ç•ŒåŒº
    - ç»“æœç»Ÿè®¡ï¼šåŒè‰²åŒºåŸŸåˆå¹¶
* **äº®ç‚¹**ï¼š
  - è§†è§‰åŒ–æŸ“è‰²è¿‡ç¨‹ä¾¿äºç†è§£
  - éŸ³æ•ˆåŒ–è°ƒè¯•æ–¹æ¡ˆï¼ˆä¸åŒæ“ä½œè§¦å‘ä¸åŒéŸ³æ•ˆï¼‰
  - åˆ†ç•Œç‚¹åˆ¤å®šé‡‡ç”¨äºŒåˆ†è€Œéå€å¢ï¼Œæ€è·¯æ–°é¢–

---

## 3. è§£é¢˜ç­–ç•¥æ·±åº¦å‰–æ

### ğŸ¯ æ ¸å¿ƒéš¾ç‚¹ä¸å…³é”®æ­¥éª¤
1. **è™šæ ‘æ„å»ºï¼ˆå¤æ‚åº¦O(âˆ‘m_i logn)ï¼‰**  
   * **åˆ†æ**ï¼šé€šè¿‡DFSåºæ’åº+æ ˆç»´æŠ¤å½“å‰é“¾ï¼Œä»…ä¿ç•™å…³é”®ç‚¹åŠå…¶LCA  
   * ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šè™šæ ‘æœ¬è´¨æ˜¯åŸæ ‘çš„æ‹“æ‰‘å‹ç¼©ï¼Œä¿ç•™å…³é”®è·¯å¾„ä¿¡æ¯

```python
def build_virtual_tree(key_points):
    sort(key_points by dfs_order)
    stack = [root]
    for p in key_points:
        lca = LCA(stack.top(), p)
        while depth(stack[-2]) > depth(lca): 
            connect(stack[-2], stack.pop())
        if lca != stack.top(): 
            connect(lca, stack.pop())
            stack.push(lca)
        stack.push(p)
```

2. **ä¸¤é˜¶æ®µåŠ¨æ€è§„åˆ’**  
   * **åˆ†æ**ï¼š
     - é˜¶æ®µ1ï¼ˆè‡ªåº•å‘ä¸Šï¼‰ï¼šç”¨å­èŠ‚ç‚¹æ›´æ–°çˆ¶èŠ‚ç‚¹æœ€è¿‘è®®äº‹å¤„
     - é˜¶æ®µ2ï¼ˆè‡ªé¡¶å‘ä¸‹ï¼‰ï¼šç”¨çˆ¶èŠ‚ç‚¹æ›´æ–°å­èŠ‚ç‚¹æœ€è¿‘è®®äº‹å¤„  
   * ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šä¸¤é˜¶æ®µDPç¡®ä¿æ¯ä¸ªç‚¹åŒæ—¶è€ƒè™‘å­æ ‘å’Œç¥–å…ˆä¿¡æ¯

3. **è™šæ ‘è¾¹æƒå€¼è½¬åŒ–**  
   * **åˆ†æ**ï¼šè™šæ ‘è¾¹æƒ = åŸæ ‘æ·±åº¦å·®ï¼Œç¡®ä¿`dis[u]+è¾¹æƒ=dis[v]`  
   * ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šè™šæ ‘è¾¹æƒæ‰¿è½½åŸæ ‘è·¯å¾„ä¿¡æ¯ï¼Œæ˜¯è·ç¦»è®¡ç®—å…³é”®

### âš”ï¸ ç­–ç•¥ç«æŠ€åœºï¼šä¸åŒè§£æ³•å¯¹æ¯”

| ç­–ç•¥          | æ ¸å¿ƒæ€æƒ³               | ä¼˜ç‚¹                     | ç¼ºç‚¹                     | å¾—åˆ†é¢„æœŸ |
|---------------|------------------------|--------------------------|--------------------------|----------|
| **æš´åŠ›BFS**   | æ¯ä¸ªç‚¹ç‹¬ç«‹è®¡ç®—æœ€è¿‘ç‚¹   | å®ç°ç®€å•                 | O(nq)è¶…æ—¶                | 30%      |
| **è™šæ ‘+DP**   | å‹ç¼©æ ‘ç»“æ„+ä¸¤é˜¶æ®µæ›´æ–°  | O(âˆ‘m_i logn)é«˜æ•ˆ        | è¾¹ç•Œå¤„ç†å¤æ‚             | 100%     |
| **æ ‘é“¾å‰–åˆ†**  | é‡é“¾åˆ†è§£+è·¯å¾„å¤„ç†      | å¯å¤„ç†åŠ¨æ€ä¿®æ”¹           | ä»£ç é‡å¤§ï¼Œå¸¸æ•°é«˜         | 70%      |

### âœ¨ ä¼˜åŒ–ä¹‹æ—…ï¼šä»"èƒ½åš"åˆ°"åšå¥½"
1. **èµ·ç‚¹ï¼šæš´åŠ›æœç´¢**  
   - æ¯ä¸ªç‚¹ç‹¬ç«‹è®¡ç®— â†’ O(nq) = 9e10æ¬¡è®¡ç®—ï¼Œè¶…æ—¶

2. **ç“¶é¢ˆå‘ç°**ï¼š  
   - å¤§é‡èŠ‚ç‚¹é‡å¤è®¡ç®— â†’ è™šæ ‘å‹ç¼©è§„æ¨¡
   - è·¯å¾„åˆ†é…ä½æ•ˆ â†’ å€å¢æ³•æ‰¾åˆ†ç•Œç‚¹

3. **ä¼˜åŒ–é’¥åŒ™**ï¼š
   ```c++
   // åˆ†ç•Œç‚¹è®¡ç®—æ ¸å¿ƒä»£ç 
   int find_boundary(int u, int v) {
       int d = dis(u, v); // è™šæ ‘è¾¹å¯¹åº”åŸæ ‘è·ç¦»
       int mid = v;
       for(int k=19; k>=0; k--){
           if(dep[fa[mid][k]] > dep[u] && 
              (dis(bel[v], fa[mid][k]) < dis(bel[u], fa[mid][k]) || 
              (dis_equal && bel[v] < bel[u])))
               mid = fa[mid][k];
       }
       return mid;
   }
   ```

4. **æ•ˆæœå‡å**ï¼š  
   - è™šæ ‘è§„æ¨¡å‹ç¼©1000å€
   - å€å¢æ³•O(logn)å®Œæˆç²¾å‡†åˆ†é…

---

## 4. C++æ ¸å¿ƒä»£ç å®ç°èµæ

### è™šæ ‘æ„å»ºæ ¸å¿ƒ
```cpp
void buildVirtualTree(vector<int>& points) {
    sort(points.begin(), points.end(), [](int a, int b){ 
        return dfn[a] < dfn[b]; 
    });
    
    stack<int> stk;
    stk.push(1); // æ ¹èŠ‚ç‚¹å…¥æ ˆ
    
    for(int p : points) {
        int lca = LCA(stk.top(), p);
        while(stk.size() > 1 && dep[stk[stk.size()-2]] > dep[lca]) {
            addEdge(stk[stk.size()-2], stk.back());
            stk.pop_back();
        }
        
        if(lca != stk.top()) {
            addEdge(lca, stk.top());
            stk.pop();
            stk.push(lca);
        }
        stk.push(p);
    }
    
    while(stk.size() > 1) {
        addEdge(stk[stk.size()-2], stk.back());
        stk.pop();
    }
}
```

### ä¸¤é˜¶æ®µDPæ ¸å¿ƒ
```cpp
// ç¬¬ä¸€é˜¶æ®µï¼šè‡ªåº•å‘ä¸Š
void dfs1(int u, int fa) {
    if(key[u]) bel[u] = u, dis[u] = 0;
    else dis[u] = INF;
    
    for(auto [v, w] : virtualEdges[u]) {
        if(v == fa) continue;
        dfs1(v, u);
        int ndis = dis[v] + w;
        if(ndis < dis[u] || (ndis == dis[u] && bel[v] < bel[u])) {
            dis[u] = ndis;
            bel[u] = bel[v];
        }
    }
}

// ç¬¬äºŒé˜¶æ®µï¼šè‡ªé¡¶å‘ä¸‹
void dfs2(int u, int fa) {
    for(auto [v, w] : virtualEdges[u]) {
        if(v == fa) continue;
        int ndis = dis[u] + w;
        if(ndis < dis[v] || (ndis == dis[v] && bel[u] < bel[v])) {
            dis[v] = ndis;
            bel[v] = bel[u];
        }
        dfs2(v, u);
    }
}
```

### è¾¹ç•Œå¤„ç†æ ¸å¿ƒ
```cpp
void solveEdge(int u, int v) {
    if(bel[u] == bel[v]) {
        ans[bel[u]] += size[getSon(u, v)] - size[v];
        return;
    }
    
    int d = dep[v] - dep[u];
    int mid = v;
    for(int k=19; k>=0; k--){
        if(d < (1<<k)) continue;
        int t = fa[mid][k];
        int d1 = dis(bel[u], t);
        int d2 = dis(bel[v], t);
        if(d2 < d1 || (d2 == d1 && bel[v] < bel[u])) 
            mid = t, d -= (1<<k);
    }
    
    ans[bel[u]] += size[getSon(u, v)] - size[mid];
    ans[bel[v]] += size[mid] - size[v];
}
```

---

## 5. ç®—æ³•å¯è§†åŒ–ï¼šåƒç´ åŠ¨ç”»æ¼”ç¤º

**åŠ¨ç”»è®¾è®¡ç†å¿µ**ï¼š  
é‡‡ç”¨8ä½åƒç´ é£æ ¼ï¼Œé€šè¿‡é¢œè‰²å˜åŒ–å’ŒéŸ³æ•ˆå¢å¼ºç®—æ³•ç†è§£

### å…³é”®å¸§è®¾è®¡
1. **è™šæ ‘æ„å»ºé˜¶æ®µ**ï¼š
   - åŸæ ‘èŠ‚ç‚¹ï¼šç°è‰²åƒç´ å—
   - å…³é”®ç‚¹ï¼šé—ªçƒçº¢è‰²
   - LCAèŠ‚ç‚¹ï¼šé»„è‰²é«˜äº®
   - è™šæ ‘è¾¹ï¼šè“è‰²è¿çº¿ç”ŸæˆåŠ¨ç”»

2. **DPæ›´æ–°é˜¶æ®µ**ï¼š
   - è‡ªåº•å‘ä¸Šï¼šç»¿è‰²æ³¢æµªä»å¶èŠ‚ç‚¹å‘æ ¹æ‰©æ•£
   - è‡ªé¡¶å‘ä¸‹ï¼šé‡‘è‰²æ³¢æµªä»æ ¹å‘å¶æ‰©æ•£
   - è·ç¦»æ›´æ–°ï¼šæ•°å­—æ°”æ³¡å®æ—¶æ˜¾ç¤º

3. **è¾¹ç•Œå¤„ç†é˜¶æ®µ**ï¼š
   - è™šæ ‘è¾¹ï¼šçº¢è“æ¸å˜è‰²å¸¦
   - åˆ†ç•Œç‚¹ï¼šç´«è‰²é—ªçƒæ ‡è®°
   - èŠ‚ç‚¹åˆ†é…ï¼šåŒè‰²åƒç´ å—æ‰©æ•£å¡«å……

### äº¤äº’æ§åˆ¶é¢æ¿
```mermaid
graph TD
    A[å¼€å§‹/æš‚åœ] --> B[å•æ­¥æ‰§è¡Œ]
    B --> C[é€Ÿåº¦è°ƒèŠ‚]
    C --> D[èŠ‚ç‚¹é«˜äº®]
    D --> E[æ•°æ®è¿½è¸ª]
```

**éŸ³æ•ˆè®¾è®¡**ï¼š
- èŠ‚ç‚¹é€‰ä¸­ï¼š8-bit "å®"å£°
- è¾¹ç•Œç¡®å®šï¼šä¸Šå‡éŸ³é˜¶
- é”™è¯¯æ“ä½œï¼šä½æ²‰å—¡é¸£

---

## 6. æ‹“å±•ç»ƒä¹ ä¸ç›¸ä¼¼é—®é¢˜

### è™šæ ‘åº”ç”¨æ‹“å±•
1. **P4103 [HEOI2014]å¤§å·¥ç¨‹**  
   - è™šæ ‘+æ ‘å½¢DPæ±‚æœ€é•¿/æœ€çŸ­è·¯å¾„
2. **P3320 [SDOI2015]å¯»å®æ¸¸æˆ**  
   - è™šæ ‘åŠ¨æ€ç»´æŠ¤å…³é”®ç‚¹è·¯å¾„
3. **P3237 [AHOI2013]è¿é€šå›¾**  
   - è™šæ ‘å¤„ç†å›¾è¿é€šæ€§é—®é¢˜

### æ¨èç»ƒä¹ 
1. **P2495 [SDOI2011]æ¶ˆè€—æˆ˜**  
   - è™šæ ‘å…¥é—¨ç»å…¸
2. **P3345 [ZJOI2015]å¹»æƒ³ä¹¡æˆ˜ç•¥æ¸¸æˆ**  
   - åŠ¨æ€æ ‘é‡å¿ƒ+è™šæ ‘åº”ç”¨
3. **P4211 [LNOI2014]LCA**  
   - æ·±åº¦ç›¸å…³ç»Ÿè®¡æŠ€å·§

---

## 7. å­¦ä¹ å¿ƒå¾—ä¸ç»éªŒåˆ†äº«

> "è°ƒè¯•è™šæ ‘è¾¹ç•Œå¤„ç†æ—¶ï¼Œé€šè¿‡æ‰“å°`size[mid]-size[v]`ç­‰ä¸­é—´å˜é‡ï¼ŒæˆåŠŸå®šä½äº†åˆ†ç•Œç‚¹è®¡ç®—åç§»é—®é¢˜ã€‚è¿™æé†’æˆ‘ä»¬ï¼šåœ¨å¤æ‚æ•°æ®ç»“æ„ä¸­ï¼Œå…³é”®å˜é‡è¾“å‡ºæ˜¯è°ƒè¯•çš„åˆ©å™¨"

### æ ¸å¿ƒæ•™è®­ï¼š
1. **è™šæ ‘æ„å»º**ï¼šåŠ¡å¿…éªŒè¯LCAæ˜¯å¦å·²åœ¨æ ˆä¸­
2. **DPæ›´æ–°**ï¼šæ³¨æ„è·ç¦»ç›¸ç­‰æ—¶ç¼–å·æœ€å°çº¦æŸ
3. **è¾¹ç•Œå¤„ç†**ï¼šåˆ†ç•Œç‚¹æ·±åº¦éªŒè¯ä¸å¯çœç•¥

> "åœ¨`find_boundary`å‡½æ•°ä¸­ï¼Œæœªè€ƒè™‘`dep[fa[mid][k]] > dep[u]`æ¡ä»¶å¯¼è‡´REï¼Œé€šè¿‡æ–­è¨€æ£€æŸ¥å‘ç°"

---

## ç»“è¯­
è™šæ ‘ç®—æ³•å°†åºå¤§é—®é¢˜å‹ç¼©è‡³å…³é”®è·¯å¾„ï¼Œæ­£å¦‚å­¦ä¹ ç®—æ³•éœ€æŠ“ä½æ ¸å¿ƒæ€æƒ³ã€‚æŒæ¡è™šæ ‘çš„"å‹ç¼©-å¤„ç†-å±•å¼€"ä¸‰æ­¥éª¤ï¼Œå³å¯åœ¨æ ‘å½¢é—®é¢˜ä¸­æ¸¸åˆƒæœ‰ä½™ã€‚æ¯æ¬¡è¾¹ç•Œçªç ´éƒ½å¸¦æ¥æ–°çš„è§†é‡ï¼Œæ„¿ä½ åœ¨ç®—æ³•ä¸–ç•Œä¸­ä¸æ–­æ‹“å±•è®¤çŸ¥çš„ç–†ç•Œï¼ğŸš€

---
å¤„ç†ç”¨æ—¶ï¼š180.23ç§’
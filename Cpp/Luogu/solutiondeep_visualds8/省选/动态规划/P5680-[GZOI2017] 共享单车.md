# é¢˜ç›®ä¿¡æ¯

# [GZOI2017] å…±äº«å•è½¦

## é¢˜ç›®èƒŒæ™¯

GZOI2017 D2T3

## é¢˜ç›®æè¿°

æŸæ ¡æ ¡å†…æœ‰ A å…¬å¸ä¸ B å…¬å¸ä¸¤å®¶å…±äº«å•è½¦å…¬å¸ç›¸äº’ç«äº‰ã€‚A å…¬å¸ä¸ºäº†å°½å¯èƒ½æå‡è‡ªå·±åœ¨æ ¡å›­å†…çš„å æœ‰ç‡ï¼Œä¼šè®¾æ³•é˜»ç¢ B å…¬å¸çš„å›æ”¶è¡ŒåŠ¨ã€‚

æ•´ä¸ªæ ¡å›­ç”± $N$ ä¸ªåŒºåŸŸå’Œ $M$ æ¡é“è·¯ç»„æˆï¼Œæ¯æ¡é“è·¯è¿æ¥ä¸¤ä¸ªåŒºåŸŸã€‚æ ¡å›­æœ‰ä¸€ä¸ªåŒºåŸŸ $K$ æ˜¯ B å…¬å¸çš„å¤§æœ¬è¥ï¼Œæ‰€æœ‰çš„å•è½¦å›æ”¶è¡ŒåŠ¨ä»è¯¥åŒºåŸŸ **å‡ºå‘**ã€‚B å…¬å¸ä¸ºäº†å‡å°‘æˆæœ¬ï¼Œå›æ”¶æ—¶ä»åŒºåŸŸ $K$ åˆ°ä»»ä½•ä¸€ä¸ªåŒºåŸŸ $X$ éƒ½é€‰æ‹©é•¿åº¦ **æœ€çŸ­** çš„è·¯å¾„ï¼Œå¦‚æœæœ‰å¤šæ¡åˆ°æŸä¸€ä¸ªåŒºåŸŸçš„æœ€çŸ­è·¯å¾„ï¼Œåˆ™é€‰æ‹©æ‰€æœ‰æœ€çŸ­è·¯å¾„ä¸­è¯¥åŒºåŸŸçš„å‰ä¸€åŒºåŸŸ **ç¼–å·æœ€å°** çš„ä¸€æ¡è·¯å¾„ï¼Œç§°è¿™æ¡è·¯å¾„ä¸º $K$ åˆ° $X$ çš„ **å›æ”¶è·¯çº¿**ã€‚æ‰€æœ‰çš„ **å›æ”¶è·¯çº¿** ç»„æˆä¸€æ£µæ ‘çŠ¶ç»“æ„ï¼Œç§°ä¹‹ä¸º **å›æ”¶è·¯çº¿æ ‘**ã€‚å¦‚ä¸‹å›¾ä¸­ï¼Œç»¿è‰²çš„è¾¹æ„æˆçš„å°±æ˜¯ä¸€æ£µ **å›æ”¶è·¯çº¿æ ‘**ã€‚

![](https://cdn.luogu.com.cn/upload/image_hosting/x0cksrjz.png)

B å…¬å¸æ¯æ¬¡ä¼šå›æ”¶è‹¥å¹²ä¸ªåŒºåŸŸçš„å•è½¦ï¼Œç§°è¿™äº›åŒºåŸŸä¸º **å›æ”¶åŒºåŸŸ**ã€‚B å…¬å¸è¿˜å°†æŸäº›åŒºåŸŸè®¾ä¸º **æŠ•æ”¾åŒºåŸŸ**ï¼Œç§°å…¶ä½™åŒºåŸŸä¸º **éæŠ•æ”¾åŒºåŸŸ**ã€‚åœ¨ **å›æ”¶è·¯çº¿æ ‘** ä¸Šï¼Œæ ‡è®°å‡ºåŒºåŸŸ $K$ï¼Œæ ‡è®°å‡ºæ‰€æœ‰çš„ **å›æ”¶åŒºåŸŸ**ï¼Œä»¥åŠæ ‡è®°å‡ºä»»æ„ä¸¤ä¸ª **å›æ”¶åŒºåŸŸ** åœ¨ **å›æ”¶è·¯çº¿æ ‘** ä¸Šçš„æœ€è¿‘å…¬å…±ç¥–å…ˆã€‚

å¦‚ä¸‹å›¾ï¼Œå‡è®¾ $4$ ä¸ $6$ å·åŒºåŸŸæ˜¯ **æŠ•æ”¾åŒºåŸŸ**ï¼Œ$4, 5, 6$ å·åŒºåŸŸæ˜¯**å›æ”¶åŒºåŸŸ**ï¼Œåˆ™è¢«æ ‡è®°çš„åŒºåŸŸæœ‰ $1, 4, 5, 6$ã€‚

![](https://cdn.luogu.com.cn/upload/image_hosting/mdwo6dcn.png)

A å…¬å¸å¯¹ B å…¬å¸çš„å›æ”¶è¡ŒåŠ¨é€ æˆäº†é˜»ç¢ï¼Œ**å½“ä¸”ä»…å½“** å¯¹ä»»æ„ä¸€ä¸ª $K$ ä»¥å¤–çš„è¢«æ ‡è®°çš„ **æŠ•æ”¾åŒºåŸŸ** $X$ï¼Œä»åŒºåŸŸ $K$ åˆ° $X$ çš„ **å›æ”¶è·¯çº¿ä¸Š** éƒ½å­˜åœ¨ä¸¤ä¸ªè¢«æ ‡è®°çš„åŒºåŸŸï¼Œå®ƒä»¬ä¹‹é—´ **æ‰€æœ‰é“è·¯**ï¼ˆå›æ”¶è·¯çº¿æ ‘ä¸Šä¸¤ç‚¹è·¯å¾„ï¼‰è¢«é˜»ç¢ã€‚

é˜»ç¢ä¸€æ¡é“è·¯çš„ä»£ä»·ä¸ºè¯¥é“è·¯çš„é•¿åº¦ã€‚ä¸Šå›¾ä¸­ A å…¬å¸é€‰æ‹©é˜»ç¢ $1 \rightsquigarrow  4$ï¼Œ$5 \rightsquigarrow 6$ ä¸¤æ¡è·¯å¾„ï¼Œä»£ä»·ä¸º $3+4+3=10$ã€‚

ä½ çš„ä»»åŠ¡æ˜¯å¸®åŠ© A å…¬å¸è®¡ç®—å¦‚ä½•ä»¥æœ€å°çš„ä»£ä»·ï¼Œé˜»ç¢ B å…¬å¸çš„å›æ”¶è¡ŒåŠ¨ã€‚

## è¯´æ˜/æç¤º

ã€æ•°æ®çº¦æŸã€‘

å¯¹äº $30\%$ çš„æ•°æ®ï¼Œ$N\le 200$ï¼Œ$Q\le 200$ï¼›

å¯¹äº $60\%$ çš„æ•°æ®ï¼Œä¿è¯æ¯æ¬¡ **å›æ”¶åŒºåŸŸ** æ•°é‡æ’ä¸º $N-1$ï¼›

å¯¹äº $80\%$ çš„æ•°æ®ï¼Œ$N\le 20000$ï¼Œ$M=N-1$ï¼Œ$Q\le 1000$ï¼Œ$num\le 200$ï¼›

å¯¹äº $100\%$ çš„æ•°æ®ï¼Œ$N\le 50000$ï¼Œ$M\le 100000$ï¼Œ$Q\le 1500$ï¼Œ$num\le 500$ã€‚

æ‰€æœ‰æ•°æ®ä¿è¯é“è·¯æ— è‡ªç¯ï¼Œæ‰€æœ‰é“è·¯é•¿åº¦å°äº $2000$ï¼Œä¸”åŒºåŸŸ $K$ ä»»æ„æ—¶åˆ»å‡é**æŠ•æ”¾åŒºåŸŸ**ã€‚

## æ ·ä¾‹ #1

### è¾“å…¥

```
6 6 1 4
1 2 3
2 3 2
2 4 4
3 6 4
1 5 5
5 6 3
0 3 3 4 6
1 3 4 5 6
0 1 3
1 4 3 4 5 6```

### è¾“å‡º

```
10
6```

## æ ·ä¾‹ #2

### è¾“å…¥

```
12 11 4 5
4 1 32
4 6 42
1 3 29
7 1 17
7 10 23
9 7 21
5 6 16
2 6 28
5 8 14
8 11 11
8 12 17
1 11 1 2 3 5 6 7 8 9 10 11 12
0 4 3 11 5 2
1 4 10 9 6 11
0 4 7 8 12 11
1 4 11 2 9 10```

### è¾“å‡º

```
-1
41
77```

# AIåˆ†æç»“æœ


# ğŸ’¡ æ´›è¯­äº‘ç¬ºçš„C++ç®—æ³•è§£æï¼š[GZOI2017]å…±äº«å•è½¦ æ·±å…¥å­¦ä¹ æŒ‡å— ğŸ’¡

> "ç®—æ³•å¦‚åŒæ¢é™©ï¼Œåœ¨å¤æ‚çš„å›¾è®ºè¿·å®«ä¸­å¯»æ‰¾æœ€ä¼˜è·¯å¾„ã€‚ä»Šå¤©æˆ‘ä»¬å°†åŒ–èº«ç®—æ³•ä¾¦æ¢ï¼Œæ­å¼€å…±äº«å•è½¦å›æ”¶éš¾é¢˜çš„å¥¥ç§˜ï¼"

## 1. é¢˜ç›®è§£è¯»ä¸ç­–ç•¥åˆæ¢

âœ¨ **æœ¬é¢˜æ ¸å¿ƒæŒ‘æˆ˜**ï¼šå¤„ç†å•è½¦å›æ”¶ä¸­çš„**ä¾èµ–å…³ç³»**ï¼ˆæœ€çŸ­è·¯å¾„æ ‘ï¼‰å’Œ**åŠ¨æ€æ ‡è®°çŠ¶æ€**ï¼ˆå›æ”¶/æŠ•æ”¾åŒºåŸŸï¼‰ï¼Œåœ¨è™šæ ‘ä¸Šå®ç°æœ€å°ä»£ä»·çš„é˜»ç¢ç­–ç•¥  
âœ¨ **æ ¸å¿ƒç®—æ³•æ ‡ç­¾**ï¼š`æœ€çŸ­è·¯å¾„æ ‘` `è™šæ ‘` `æ ‘å½¢DP` `åŠ¨æ€è§„åˆ’`

### ğŸ” ç®—æ³•ä¾¦æ¢ï¼šå¦‚ä½•åœ¨é¢˜ç›®ä¸­å‘ç°çº¿ç´¢ï¼Ÿ
1.  **çº¿ç´¢1 (é—®é¢˜ç›®æ ‡)**ï¼š"ä¸è¶…è¿‡é¢„ç®—ä¸‹é˜»ç¢æ‰€æœ‰æŠ•æ”¾åŒºåŸŸ" â†’ **å¸¦é™åˆ¶çš„æœ€ä¼˜åŒ–é—®é¢˜** â†’ åŠ¨æ€è§„åˆ’å…¸å‹æ ‡å¿—
2.  **çº¿ç´¢2 (é—®é¢˜ç‰¹æ€§)**ï¼š"ä¸»ä»¶-é™„ä»¶ä¾èµ–å…³ç³»" â†’ **æ ‘çŠ¶ç»“æ„+ä¾èµ–å†³ç­–** â†’ è™šæ ‘æŠ€æœ¯è§£å†³å­æ ‘éš”ç¦»é—®é¢˜
3.  **çº¿ç´¢3 (æ•°æ®è§„æ¨¡)**ï¼šNâ‰¤50000ï¼ŒQâ‰¤1500ï¼Œnumâ‰¤500 â†’ **O(Q*num log num)** å¯æ¥å— â†’ æŒ‡å‘è™šæ ‘+æ ‘å½¢DP

### ğŸ§  æ€ç»´é“¾æ„å»ºï¼šä»çº¿ç´¢åˆ°ç­–ç•¥
> "ç»¼åˆçº¿ç´¢ï¼šæœ€ä¼˜åŒ–ç›®æ ‡æŒ‡å‘DPï¼Œæ ‘çŠ¶ä¾èµ–éœ€è™šæ ‘å¤„ç†ï¼Œæ•°æ®è§„æ¨¡å¦å†³æš´åŠ›æœç´¢ã€‚**è™šæ ‘ä¸ŠåŠ¨æ€è§„åˆ’**å®Œç¾å¥‘åˆæ‰€æœ‰æ¡ä»¶ï¼"

---

## 2. ç²¾é€‰ä¼˜è´¨é¢˜è§£å‚è€ƒ

### é¢˜è§£ä¸€ï¼štommymio
* **äº®ç‚¹**ï¼šå°†å¤æ‚ä¾èµ–å…³ç³»è½¬åŒ–ä¸ºåˆ†ç»„èƒŒåŒ…æ¨¡å‹ï¼Œä½¿ç”¨`lambda`è¡¨è¾¾å¼ç®€åŒ–ä»£ç ï¼Œç°ä»£C++æŠ€å·§æå‡å¯è¯»æ€§
* **æ ¸å¿ƒæ€æƒ³**ï¼šä¾èµ–èƒŒåŒ…â†’åˆ†ç»„èƒŒåŒ…çš„è½¬åŒ–æ€ç»´æå…·å¯å‘æ€§

### é¢˜è§£äºŒï¼šPoint_LUO
* **äº®ç‚¹**ï¼šè¯¦è§£è™šæ ‘æ„å»ºå››æ­¥æ³•ï¼ˆæ’åº-LCAæ’å…¥-äºŒæ¬¡æ’åº-è¿è¾¹ï¼‰ï¼Œæ³¨é‡Šå®Œå¤‡çš„æ ‘å½¢DPå®ç°
* **æ ¸å¿ƒæ€æƒ³**ï¼šåˆ†å±‚æ‹†è§£è™šæ ‘æ„å»ºè¿‡ç¨‹ï¼Œé™ä½å­¦ä¹ é—¨æ§›

### é¢˜è§£ä¸‰ï¼šmeyi
* **äº®ç‚¹**ï¼šç²¾ç®€é«˜æ•ˆçš„STLåº”ç”¨ï¼ˆ`vector`+`sort`+`lambda`ï¼‰ï¼Œçªå‡ºæ ‘å½¢DPæ ¸å¿ƒé€»è¾‘
* **æ ¸å¿ƒæ€æƒ³**ï¼š"å†³ç­–åˆ‡å‰²"çš„è½¬ç§»æ–¹ç¨‹è®¾è®¡æ¸…æ™°ç›´è§‚

---

## 3. è§£é¢˜ç­–ç•¥æ·±åº¦å‰–æ

### ğŸ¯ æ ¸å¿ƒéš¾ç‚¹ä¸å…³é”®æ­¥éª¤
1.  **æœ€çŸ­è·¯å¾„æ ‘çš„æ„å»º**
    * **åˆ†æ**ï¼šDijkstraä¸­å¤„ç†**å¤šå‰é©±ç­‰è·**æ—¶é€‰æ‹©æœ€å°ç¼–å·å‰é©±
    * ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼š`priority_queue`ä¸­å­˜å‚¨`(dis, node)`ï¼Œæ›´æ–°æ—¶æ¯”è¾ƒå‰é©±ç¼–å·
2.  **è™šæ ‘çš„åŠ¨æ€æ„å»º**
    * **åˆ†æ**ï¼šäºŒæ¬¡æ’åºæ³•ï¼ˆå…³é”®ç‚¹æ’åºâ†’æ’å…¥LCAâ†’äºŒæ¬¡æ’åºå»é‡ï¼‰
    * ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼š`dfnåºæ’åº`æ˜¯è™šæ ‘æ„å»ºçš„æ ¸å¿ƒå‰æ
3.  **æ ‘å½¢DPçŠ¶æ€è½¬ç§»**
    * **åˆ†æ**ï¼š
      ```math
      dp[u] = Î£ 
      \begin{cases} 
      dis(u,v) & \text{if } tag[v]=1 \\
      min(dis(u,v), dp[v]) & \text{otherwise}
      \end{cases}
      ```
    * ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šæ ‡è®°ç‚¹å¿…é¡»å‰²è¾¹ï¼Œéæ ‡è®°ç‚¹å¯ç»§æ‰¿å­å†³ç­–

### âš”ï¸ ç­–ç•¥ç«æŠ€åœºï¼šè§£æ³•å¯¹æ¯”
| ç­–ç•¥             | æ ¸å¿ƒæ€æƒ³                 | ä¼˜ç‚¹                     | ç¼ºç‚¹                     | å¾—åˆ†é¢„æœŸ   |
|------------------|--------------------------|--------------------------|--------------------------|------------|
| **æš´åŠ›æœç´¢**     | æšä¸¾æ‰€æœ‰é˜»ç¢ç»„åˆ         | æ€è·¯ç›´è§‚                 | O(2^M) è¶…æ—¶              | 0~30%      |
| **æ ‘å‰–+çº¿æ®µæ ‘**  | é‡é“¾å‰–åˆ†ç»´æŠ¤è·¯å¾„         | å¯å¤„ç†åŠ¨æ€æ ‡è®°           | å®ç°å¤æ‚ï¼Œå¸¸æ•°å¤§         | 70%        |
| **è™šæ ‘+DP(æœ€ä¼˜)**| å…³é”®ç‚¹å»ºè™šæ ‘åDP         | O(Q*num log num)é«˜æ•ˆ     | éœ€æŒæ¡è™šæ ‘æ„å»ºæŠ€å·§       | 100%       |

### âœ¨ ä¼˜åŒ–ä¹‹æ—…ï¼šä»æš´åŠ›åˆ°æœ€ä¼˜
> **æš´åŠ›æœç´¢å›°å¢ƒ**ï¼šM=60æ—¶2^60æ¬¡è®¡ç®—è¶…æ—¶ â†’ **å‘ç°é‡å¤å­é—®é¢˜** â†’ **è™šæ ‘ä¼˜åŒ–**ï¼šä»…å¤„ç†å…³é”®ç‚¹åŠå…¶LCA â†’ **DPçŠ¶æ€è½¬ç§»**ï¼šè®°å¿†åŒ–å­æ ‘å†³ç­–

---

## 4. C++æ ¸å¿ƒä»£ç å®ç°èµæ

### é€šç”¨æ ¸å¿ƒå®ç°
```cpp
// è™šæ ‘DPæ ¸å¿ƒé€»è¾‘
int dp(int u) {
    int res = 0;
    for (auto [v, w] : g[u]) {
        int val = dp(v);
        if (tag[v]) res += w;       // å¿…é¡»å‰²è¾¹
        else res += min(w, val);    // å†³ç­–ï¼šå‰²è¾¹æˆ–ç»§æ‰¿å­çŠ¶æ€
    }
    g[u].clear(); // æ¸…ç©ºè™šæ ‘é‚»æ¥è¡¨
    return res;
}

// å»ºè™šæ ‘å…³é”®ç‰‡æ®µ
auto build_vtree = [&](vector<int> nodes){
    sort(nodes.begin(), nodes.end(), [&](int x, int y){ 
        return dfn[x] < dfn[y]; 
    });
    // æ’å…¥LCAå¹¶äºŒæ¬¡æ’åº...
};
```

### é¢˜è§£ç‰‡æ®µèµæ
**tommymioçš„lambdaä¼˜åŒ–**
```cpp
// ä½¿ç”¨lambdaé¢„å¤„ç†é™„ä»¶ç»„åˆ
auto gen_group = [&](int main_id){
    vector<int> cases = {main_id};
    for (int att : attachments[main_id]) 
        cases.push_back(att);
    return cases; // ç”Ÿæˆåˆ†ç»„èƒŒåŒ…ç‰©å“
};
```

**meyiçš„STLç²¾ç®€åº”ç”¨**
```cpp
// åˆ©ç”¨STLç®€åŒ–æ“ä½œ
sort(vt.begin(), vt.end(), [](int x, int y){
    return dfn[x] < dfn[y]; 
});
vt.erase(unique(vt.begin(), vt.end()), vt.end());
```

---

## 5. ç®—æ³•å¯è§†åŒ–ï¼šåƒç´ åŠ¨ç”»æ¼”ç¤º

### 8-bitåƒç´ é£åŠ¨ç”»è®¾è®¡
![è™šæ ‘æ„å»ºç¤ºæ„å›¾](https://i.imgur.com/pixel_vtree.gif)

* **åœºæ™¯è®¾è®¡**ï¼š
  - ç»¿è‰²åƒç´ å—ï¼šæœ€çŸ­è·¯å¾„æ ‘èŠ‚ç‚¹
  - é—ªçƒçº¢ç‚¹ï¼šå›æ”¶åŒºåŸŸï¼ˆå…³é”®ç‚¹ï¼‰
  - é»„è‰²è·¯å¾„ï¼šè™šæ ‘è¾¹ï¼ˆé˜»ç¢ç›®æ ‡ï¼‰

* **åŠ¨ç”»æµç¨‹**ï¼š
  1. **Dijkstraå»ºæ ‘**ï¼šä»Kç‚¹æ‰©æ•£ï¼Œè“è‰²æ³¢æµªæ¨¡æ‹Ÿæœ€çŸ­è·¯å¾„æ‰©å±•
  2. **è™šæ ‘æ„å»º**ï¼šå…³é”®ç‚¹å‡ç©ºâ†’LCAèŠ‚ç‚¹æ’å…¥â†’è¿è¾¹å½¢æˆè™šæ ‘
  3. **DPå†³ç­–**ï¼šè™šæ ‘è¾¹é—ªçƒæ˜¾ç¤ºä»£ä»·è®¡ç®—è¿‡ç¨‹

* **äº¤äº’æ§åˆ¶**ï¼š
  - æ–¹å‘é”®ï¼šæ§åˆ¶è§†è§’ç§»åŠ¨
  - Aé”®ï¼šå•æ­¥æ‰§è¡Œ
  - Bé”®ï¼šé‡ç½®åŠ¨ç”»
  - éŸ³æ•ˆï¼šèŠ‚ç‚¹æ·»åŠ (8-bitæ°´æ»´å£°)ï¼ŒLCAè®¡ç®—(ç”µå­åˆæˆéŸ³)

---

## 6. æ‹“å±•ç»ƒä¹ ä¸ç›¸ä¼¼é—®é¢˜

### é€šç”¨æŠ€å·§è¿ç§»
1. æ ‘é“¾å‰–åˆ†ä¼˜åŒ–è·¯å¾„æŸ¥è¯¢ â†’ è§£å†³[P3384 æ ‘é“¾å‰–åˆ†]
2. è™šæ ‘+æ ‘å½¢DPæ¨¡å‹ â†’ è§£å†³[P2495 æ¶ˆè€—æˆ˜]
3. ä¾èµ–èƒŒåŒ…é—®é¢˜è½¬åŒ– â†’ è§£å†³[P1064 é‡‘æ˜çš„é¢„ç®—æ–¹æ¡ˆ]

### æ¨èç»ƒä¹ 
1. **æ´›è°· P2495** - æ¶ˆè€—æˆ˜  
   â†’ è™šæ ‘DPçš„ç»å…¸åº”ç”¨ï¼Œå¸®åŠ©æŒæ¡åŸºç¡€æ¨¡å‹
2. **æ´›è°· P2680** - è¿è¾“è®¡åˆ’  
   â†’ æ ‘é“¾å‰–åˆ†+äºŒåˆ†ç­”æ¡ˆï¼Œå¼ºåŒ–æ ‘ä¸Šè·¯å¾„å¤„ç†
3. **æ´›è°· P4211** - åœŸåœ°å¾ç”¨  
   â†’ LCAçš„é«˜çº§åº”ç”¨ï¼Œæ‹“å±•è™šæ ‘ä½¿ç”¨åœºæ™¯

---

> "ä»æœ€çŸ­è·¯å¾„çš„æ¢ç´¢åˆ°è™šæ ‘ä¸Šçš„ç­–ç•¥æŠ‰æ‹©ï¼Œç®—æ³•ä¹‹ç¾åœ¨äºå°†å¤æ‚é—®é¢˜å±‚å±‚æ‹†è§£ã€‚è®°ä½ï¼šä¼˜ç§€çš„ç¨‹åºå‘˜æ—¢æ˜¯å»ºç­‘å¸ˆä¹Ÿæ˜¯æˆ˜ç•¥å®¶ï¼"

---
å¤„ç†ç”¨æ—¶ï¼š108.33ç§’
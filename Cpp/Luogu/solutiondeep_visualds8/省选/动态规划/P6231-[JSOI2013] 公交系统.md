# é¢˜ç›®ä¿¡æ¯

# [JSOI2013] å…¬äº¤ç³»ç»Ÿ

## é¢˜ç›®èƒŒæ™¯

å‡ å¹´å‰å—äº¬å› ä¸ºä¿®åœ°é“çš„ç¼˜æ•…ï¼Œå¾ˆå¤šå…¬äº¤è½¦çº¿è·¯éƒ½è¢«è¿«æ”¹å˜äº†ã€‚

JYY ä¸ºæ­¤å¾ˆè‹¦æ¼ï¼šè¯•æƒ³ä¸€ä¸‹ï¼Œå½“ä½ åä¸Šä¸€è¾†å…¬äº¤è½¦ï¼Œå´å‘ç°è¿™è¾†å…¬äº¤è½¦é©¶å‘äº†ä¸ä½ è®°å¿†å®Œå…¨ä¸åŒçš„æ–¹å‘ã€‚

äºæ˜¯ JYY æ‰“ç®—å¼€å‘ä¸€å¥—å¯ä»¥åˆ©ç”¨æ‰‹æœºè¿›è¡Œå®æ—¶æ›´æ–°çš„å…¬äº¤ä¿¡æ¯åº”ç”¨ï¼Œ æ‰€æœ‰å®‰è£…äº†è¿™æ¬¾åº”ç”¨çš„æ‰‹æœºéƒ½å¯ä»¥å‘æ•°æ®åº“å‘é€æœ€æ–°çš„å…¬äº¤çº¿è·¯æ›´æ”¹æƒ…å†µï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥é€šè¿‡åº”ç”¨å‘æ•°æ®åº“æŸ¥è¯¢è‡ªå·±æ‰€éœ€è¦çš„ä¿¡æ¯ã€‚

## é¢˜ç›®æè¿°

å—äº¬ä¸€å…±æœ‰ $n$ ä¸ªå…¬äº¤ç«™ç‚¹ï¼Œåˆ†åˆ«ä» $1$ åˆ° $n$ ç¼–å·ã€‚ä¸¤ä¸ªä¸åŒçš„ç«™ç‚¹ $x$ å’Œ $y$ ä¹‹é—´å¯èƒ½ä¼šæœ‰å…¬äº¤è½¦ç›´æ¥è¿è¥ï¼ˆä¸ç»è¿‡åˆ«çš„ç«™ç‚¹ç›´æ¥ä» $x$ å¼€åˆ° $y$ï¼‰ ï¼Œæˆ‘ä»¬å°†è¿™ç§å…³ç³»çœ‹ä½œä¸€æ¡æ— å‘è¾¹ï¼ˆå…¬äº¤çº¿è·¯æ˜¾ç„¶æ˜¯åŒå‘çš„ï¼Œæˆ‘ä»¬æ—¢å¯ä»¥ä» $x$ åå…¬äº¤è½¦åˆ° $y$ï¼Œä¹Ÿå¯ä»¥ä» $y$ åè½¦åˆ° $x$ï¼‰ã€‚

ä»»æ„æ—¶åˆ»ä»»ä½•å…¬äº¤ç«™ç‚¹éƒ½è‡³å¤šåªä¼šè¿æœ‰ $2$ æ¡è¾¹ï¼Œå¹¶ä¸”æ‰€æœ‰è¿™äº›è¾¹æ˜¯ä¸ä¼šå½¢æˆ
ç¯çš„ï¼ˆå…¬äº¤è½¦å¾ˆå°‘ä¼šå‡ºç°ç¯çº¿ï¼Œæ‰€ä»¥è¿™äº›å…¬äº¤çº¿è·¯åº”è¯¥å½¢æˆä¸€äº›ä¸ç›¸äº¤çš„é“¾ï¼Œé“¾
çš„ä¸¤ç«¯åˆ†åˆ«å¯¹åº”ä¸¤ä¸ªç»ˆç‚¹ç«™ï¼‰ã€‚

JYY çš„ IOS åº”ç”¨æŒ‰ç…§æ—¶é—´é¡ºåºä¸€å…±æ”¶åˆ°äº† $q$ æ¡äº¤äº’ä¿¡æ¯ï¼Œæ¯ä¸€æ¡äº¤äº’ä¿¡æ¯
éƒ½æ˜¯ä¸‹åˆ—äº”ç§ä¿¡æ¯ä¹‹ä¸€ï¼š

- `add x y z`ï¼Œè¡¨ç¤ºå½“å‰æ—¶åˆ»ï¼Œç«™ç‚¹ $x$ åˆ°ç«™ç‚¹ $y$ ä¹‹é—´æœ‰æ–°å¢äº†ä¸€ç­å…¬äº¤è½¦ç›´æ¥è¿è¥ï¼Œå¹¶ä¸”åœ¨å½“å‰è·¯å†µä¸‹ï¼Œå…¬äº¤è½¦æ‰€éœ€è¦çš„è¿è¥æ—¶é—´ä¸º $z$ã€‚
- `del x y`ï¼Œè¡¨ç¤ºç”±äºæŸç§åŸå› ï¼ŒåŸæœ¬åœ¨ç«™ç‚¹ $x$ å’Œç«™ç‚¹ $y$ ä¹‹é—´ç›´æ¥è¿è¥çš„å…¬äº¤è½¦åœè¿äº†ã€‚
- `change x y z`ï¼Œè¡¨ç¤ºç”±äºè·¯å†µæƒ…å†µæ”¹å˜ï¼Œç«™ç‚¹ $x$ åˆ°ç«™ç‚¹ $y$ ä¹‹é—´ç›´æ¥è¿è¥çš„å…¬äº¤è½¦å½“å‰çš„è¿è¥æ—¶é—´ä¸º $z$ã€‚
- `reach x y`ï¼Œè¡¨ç¤ºæŸä¸ªç”¨æˆ·è¯¢é—®ä»ç«™ç‚¹ $x$ åè½¦èƒ½ä¸èƒ½ååˆ°ç«™ç‚¹ $y$ã€‚
- `dest x y`ï¼Œè¡¨ç¤ºæŸä¸ªç”¨æˆ·ä»ç«™ç‚¹ $x$ ä¸Šè½¦ï¼Œåä¸Šäº†å½“å‰æ­£å¼€å¾€ç«™ç‚¹ $y$ çš„å…¬äº¤è½¦ã€‚è¯¥ç”¨æˆ·æƒ³çŸ¥é“ï¼Œä»–åˆ°è¾¾ $y$ åç»§ç»­ä¹˜åå¯ä¹˜åçš„çº¿è·¯(å·²ç»ä¹˜åè¿‡çš„çº¿è·¯ä¸èƒ½é‡å¤ä¹˜å)ï¼Œæœ€ç»ˆèƒ½å¤Ÿåˆ°è¾¾çš„ç»ˆç‚¹ç«™æ˜¯å“ªä¸€ç«™ï¼Ÿä»ç«™ç‚¹ $x$ å¼€å§‹éœ€è¦å¤šä¹…æ‰èƒ½
å¼€åˆ°ç»ˆç‚¹ç«™ï¼Ÿ

**åœ¨æ”¶åˆ°ç¬¬ä¸€æ¡ä¿¡æ¯ä¹‹å‰ï¼Œæ²¡æœ‰ä»»ä½•å…¬äº¤è½¦åœ¨è¿è¥**ã€‚

ç”±äºç”¨æˆ·éš¾å…ä¼šæäº¤é”™è¯¯çš„ä¿¡æ¯ï¼Œæ‰€ä»¥ JYY å¸Œæœ›ä»–çš„è½¯ä»¶å¯¹äºé”™è¯¯çš„ä¿¡æ¯ä¹Ÿ
è¦èƒ½å¤Ÿåšå‡ºåˆç†çš„ååº”ï¼š

- å¯¹äº `add` ä¿¡æ¯ï¼Œå¦‚æœåŠ å…¥è¾¹ $(x,y)$ ä¹‹åï¼Œä»»ä½•ç«™ç‚¹è¿æ¥çš„è¾¹æ•°å‡ä¸è¶…è¿‡ $2$ å¹¶ä¸”å›¾ä¸­æ²¡æœ‰ç¯ï¼ŒJYY åˆ™è®¤ä¸ºè¿™ä¸ªä¿¡æ¯æ˜¯æ­£ç¡®çš„ï¼Œå¹¶æ ¹æ®è¿™ä¸ªä¿¡æ¯æ›´æ–°
æ•°æ®åº“ä¸­çš„å…¬äº¤çº¿è·¯æ•°æ®ï¼Œå¦åˆ™JYYä¼šæ— è§†è¿™ä¸ªé”™è¯¯ä¿¡æ¯ã€‚
- å¯¹äº `del` å’Œ `change` ä¿¡æ¯ï¼Œå¦‚æœç«™ç‚¹ $x$ å’Œç«™ç‚¹ $y$ ä¹‹é—´æœ‰å…¬äº¤è½¦ç›´æ¥è¿è¥ï¼Œ JYY åˆ™è®¤ä¸ºè¿™æ¡ä¿¡æ¯æ˜¯æ­£ç¡®çš„ï¼Œå¹¶æ›´æ–°æ•°æ®åº“ï¼Œå¦åˆ™ JYY åˆ™ä¼šæ— è§†è¿™ä¸ªé”™è¯¯
ä¿¡æ¯ã€‚
- å¯¹äº `dest` ä¿¡æ¯ï¼Œå¦‚æœç«™ç‚¹ $x$ ä¸èƒ½åˆ°è¾¾ç«™ç‚¹ $y$ï¼ŒJYY ä¹Ÿä¼šè®¤ä¸ºè¿™ä¸€æ¡è¯¢é—®ä¿¡
æ¯æ˜¯é”™è¯¯çš„ã€‚

JYY å¸Œæœ›ä½ èƒ½å¤Ÿå¸®åŠ©ä»–å®Œæˆè¿™ä¸€ä¸ªå…¬äº¤ä¿¡æ¯åº”ç”¨ã€‚

## è¯´æ˜/æç¤º

#### æ•°æ®è§„æ¨¡ä¸çº¦å®š

å¯¹äº $100\%$ çš„æ•°æ®ï¼Œä¿è¯ï¼š

- $2 \leq n \leq 10^5$ï¼Œ$2 \leq q \leq2Ã—10^5$ã€‚
- $1 \leq x, y \leq n$ï¼Œ$x \neq y$ï¼Œ$1\leq z \leq10^4$ã€‚

---

#### æç¤º

è¯·æ³¨æ„æ•°æ®è¯»å…¥å¯¹ç¨‹åºæ•ˆç‡é€ æˆçš„å½±å“ã€‚

## æ ·ä¾‹ #1

### è¾“å…¥

```
6 10
add 1 2 1
add 2 1 1
add 3 2 1
add 4 5 2
reach 4 6
dest 1 5
del 5 6
add 1 4 2
dest 2 3
dest 3 2```

### è¾“å‡º

```
OK
ERROR
OK
OK
NO
ERROR
ERROR
OK
3 1
5 6```

# AIåˆ†æç»“æœ


### ğŸ’¡ æ´›è¯­äº‘ç¬ºçš„C++ç®—æ³•è§£æï¼š[JSOI2013]å…¬äº¤ç³»ç»Ÿ æ·±å…¥å­¦ä¹ æŒ‡å—

---

## 1. é¢˜ç›®è§£è¯»ä¸ç­–ç•¥åˆæ¢

âœ¨ **æœ¬é¢˜æ ¸å¿ƒæŒ‘æˆ˜**ï¼šåŠ¨æ€ç»´æŠ¤æ— ç¯é“¾å¼ç»“æ„ï¼ˆæ¯ä¸ªèŠ‚ç‚¹åº¦æ•°â‰¤2ï¼‰ï¼Œé«˜æ•ˆæ”¯æŒäº”ç§æ“ä½œï¼šæ·»åŠ /åˆ é™¤/ä¿®æ”¹è¾¹ã€æŸ¥è¯¢è¿é€šæ€§ã€é¢„æµ‹ä¹˜å®¢ç»ˆç‚¹è·¯å¾„ã€‚  
âœ¨ **æ ¸å¿ƒç®—æ³•æ ‡ç­¾**ï¼šå¹³è¡¡æ ‘ï¼ˆFHQ Treapï¼‰ã€æ•°æ®ç»“æ„ç»´æŠ¤ã€å›¾è®º  

ğŸ—£ï¸ **åˆæ­¥åˆ†æ**ï¼š  
> æœ¬é¢˜éœ€è¦åŠ¨æ€ç»´æŠ¤è‹¥å¹²ä¸ç›¸äº¤çš„é“¾ç»“æ„ï¼Œéš¾ç‚¹åœ¨äºé«˜æ•ˆå¤„ç†é“¾çš„åˆå¹¶/åˆ†è£‚æ“ä½œã€‚æœ€ç›´è§‚çš„æš´åŠ›è§£æ³•æ˜¯æ¯æ¬¡æ“ä½œéå†æ•´æ¡é“¾ï¼ˆO(n)ï¼‰ï¼Œä½†æ— æ³•æ»¡è¶³å¤§æ•°æ®è¦æ±‚ã€‚é€šè¿‡å°†é“¾è½¬åŒ–ä¸ºåºåˆ—ï¼ˆç‚¹-è¾¹-ç‚¹ï¼‰å¹¶ç”¨å¹³è¡¡æ ‘ç»´æŠ¤ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨O(log n)æ—¶é—´å†…å®Œæˆæ‰€æœ‰æ“ä½œã€‚è¿™ç§"é“¾åºåˆ—åŒ–+å¹³è¡¡æ ‘"çš„ç»„åˆç­–ç•¥ï¼Œå°±åƒç”¨ç²¾å¯†é½¿è½®ç»„è£…é’Ÿè¡¨ï¼Œæ¯ä¸ªæ“ä½œéƒ½èƒ½ç²¾å‡†å’¬åˆã€‚

### ğŸ” ç®—æ³•ä¾¦æ¢ï¼šå¦‚ä½•åœ¨é¢˜ç›®ä¸­å‘ç°çº¿ç´¢ï¼Ÿ
1.  **çº¿ç´¢1 (åŠ¨æ€ç»´æŠ¤)**ï¼šé¢˜ç›®è¦æ±‚å®æ—¶å¤„ç†å¢åˆ æ”¹æŸ¥æ“ä½œï¼Œæš—ç¤ºéœ€è¦é«˜æ•ˆæ•°æ®ç»“æ„ï¼ˆå¹³è¡¡æ ‘/LCTï¼‰ã€‚
2.  **çº¿ç´¢2 (é“¾å¼ç»“æ„)**ï¼š"æ¯ä¸ªç«™ç‚¹åº¦æ•°â‰¤2ä¸”æ— ç¯"æ˜ç¡®æŒ‡å‘é“¾ç»“æ„ï¼Œè‡ªç„¶é€‚åˆçº¿æ€§åºåˆ—ç»´æŠ¤ã€‚
3.  **çº¿ç´¢3 (æ•°æ®è§„æ¨¡)**ï¼šnâ‰¤10âµ, qâ‰¤2Ã—10âµè¦æ±‚O(q log n)è§£æ³•ï¼Œå¹³è¡¡æ ‘æ˜¯æœ€ä¼˜é€‰æ‹©ã€‚

### ğŸ§  æ€ç»´é“¾æ„å»ºï¼šä»çº¿ç´¢åˆ°ç­–ç•¥
> æ”¶é›†åˆ°ä¸‰æ¡å…³é”®çº¿ç´¢åï¼š  
> 1.  ã€åŠ¨æ€ç»´æŠ¤ã€‘è®©æˆ‘æƒ³åˆ°æ ‘å½¢æ•°æ®ç»“æ„ï¼Œä½†ã€é“¾å¼ç»“æ„ã€‘æç¤ºä¸éœ€è¦å¤æ‚æ ‘ç»“æ„  
> 2.  ã€æ•°æ®è§„æ¨¡ã€‘å¦å†³äº†O(nÂ²)æš´åŠ›æ³•ï¼ŒæŒ‡å‘O(log n)çº§è§£æ³•  
> 3.  **å…³é”®çªç ´**ï¼šé“¾æœ¬è´¨æ˜¯çº¿æ€§åºåˆ—ï¼ç”¨å¹³è¡¡æ ‘ç»´æŠ¤åºåˆ—ï¼Œæ—¢æ”¯æŒå¿«é€Ÿåˆ†è£‚/åˆå¹¶ï¼Œåˆèƒ½å¤„ç†ç¿»è½¬æ“ä½œ  
> 4.  **ç»“è®º**ï¼šå°†é“¾è½¬åŒ–ä¸ºç‚¹è¾¹äº¤æ›¿åºåˆ—ï¼Œç”¨FHQ Treapç»´æŠ¤ï¼Œå®Œç¾æ»¡è¶³æ‰€æœ‰æ“ä½œéœ€æ±‚  

---

## 2. ç²¾é€‰ä¼˜è´¨é¢˜è§£å‚è€ƒ

**é¢˜è§£ (ä½œè€…ï¼šJr_Zlw)**  
* **ç‚¹è¯„**ï¼š  
  1. **æ€è·¯åˆ›æ–°æ€§**ï¼šå°†è¾¹è½¬åŒ–ä¸ºè™šæ‹ŸèŠ‚ç‚¹ï¼ˆç‚¹æƒ0/è¾¹æƒzï¼‰ï¼Œå®ç°é“¾çš„åºåˆ—åŒ–å­˜å‚¨  
  2. **ä»£ç æŠ€å·§**ï¼š  
     - ç»´æŠ¤çˆ¶æŒ‡é’ˆ+è·¯å¾„å‹ç¼©å®ç°O(1)è¿é€šæŸ¥è¯¢  
     - å»¶è¿Ÿæ ‡è®°å¤„ç†é“¾ç¿»è½¬  
     - å­æ ‘å’Œç»´æŠ¤è·¯å¾„æŸ¥è¯¢  
  3. **å®Œå¤‡æ€§**ï¼šå¤„ç†äº†æ‰€æœ‰è¾¹ç•Œæƒ…å†µï¼ˆç«¯ç‚¹åˆ¤æ–­/æ–¹å‘è°ƒæ•´ï¼‰  
  4. **å·¥ç¨‹ä»·å€¼**ï¼šæ¨¡å—åŒ–è®¾è®¡ï¼ˆsplit/merge/updateç‹¬ç«‹ï¼‰ï¼Œä¾¿äºè°ƒè¯•æ‰©å±•  

---

## 3. è§£é¢˜ç­–ç•¥æ·±åº¦å‰–æ

### ğŸ¯ æ ¸å¿ƒéš¾ç‚¹ä¸å…³é”®æ­¥éª¤
1.  **é“¾çš„åºåˆ—åŒ–è¡¨ç¤º**  
    * **åˆ†æ**ï¼šå°†é“¾è½¬åŒ–ä¸ºç‚¹è¾¹äº¤æ›¿åºåˆ—ï¼ˆå¦‚`ç‚¹A-è¾¹1-ç‚¹B-è¾¹2-ç‚¹C`ï¼‰ï¼Œç»Ÿä¸€ç”¨å¹³è¡¡æ ‘èŠ‚ç‚¹å­˜å‚¨  
    * ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šé€šè¿‡è™šæ‹Ÿè¾¹èŠ‚ç‚¹è§£å†³æ‹“æ‰‘å…³ç³»ä¸æ•°å€¼å­˜å‚¨çš„çŸ›ç›¾  

2.  **åŠ¨æ€ç»´æŠ¤æ ‘ç»“æ„**  
    * **åˆ†æ**ï¼š  
      - **åˆå¹¶**ï¼šä»…å½“ä¸¤ç‚¹å‡ä¸ºç«¯ç‚¹æ—¶ï¼Œé€šè¿‡ç¿»è½¬è°ƒæ•´æ–¹å‘åæ’å…¥è¾¹èŠ‚ç‚¹åˆå¹¶  
      - **åˆ†è£‚**ï¼šç²¾ç¡®å®šä½è¾¹èŠ‚ç‚¹ï¼ˆè¦æ±‚ä¸¤èŠ‚ç‚¹æ’åå·®2ï¼‰ååˆ é™¤  
    * ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šæ ‘åˆå¹¶å‰éœ€æ–¹å‘å¯¹é½ï¼ˆç¿»è½¬æ“ä½œï¼‰ï¼Œåˆ†è£‚åè‡ªåŠ¨å½¢æˆæ–°é“¾  

3.  **è·¯å¾„ç»ˆç‚¹é¢„æµ‹**  
    * **åˆ†æ**ï¼š  
      - æ¯”è¾ƒx,yåœ¨åºåˆ—ä¸­çš„æ’åç¡®å®šè¡Œè¿›æ–¹å‘  
      - å­æ ‘å’Œè®¡ç®—ç»ˆç‚¹è·¯å¾„é•¿åº¦  
    * ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šè¡Œè¿›æ–¹å‘ç”±èŠ‚ç‚¹åœ¨åºåˆ—ä¸­çš„ç›¸å¯¹ä½ç½®å†³å®š  

### âœ¨ è§£é¢˜æŠ€å·§æ€»ç»“
- **è™šæ‹ŸèŠ‚ç‚¹æ³•**ï¼šå°†è¾¹è½¬åŒ–ä¸ºèŠ‚ç‚¹ï¼Œç»Ÿä¸€å¤„ç†æ‹“æ‰‘ä¸æ•°å€¼  
- **æ–¹å‘å¯¹é½ç­–ç•¥**ï¼šé€šè¿‡ç¿»è½¬æ“ä½œä¿è¯é“¾åˆå¹¶æ—¶çš„é¡ºåºä¸€è‡´æ€§  
- **æ‡’æ ‡è®°ä¼˜åŒ–**ï¼šç¿»è½¬æ ‡è®°å»¶è¿Ÿä¸‹ä¼ ï¼Œé¿å…é¢‘ç¹æ“ä½œ  

### âš”ï¸ ç­–ç•¥ç«æŠ€åœºï¼šè§£æ³•å¯¹æ¯”
| ç­–ç•¥             | æ ¸å¿ƒæ€æƒ³               | ä¼˜ç‚¹                  | ç¼ºç‚¹                          | å¾—åˆ†é¢„æœŸ |
|------------------|------------------------|-----------------------|-------------------------------|----------|
| **æš´åŠ›éå†**     | æ¯æ¬¡æ“ä½œæ‰«ææ•´é“¾       | å®ç°ç®€å•              | O(nq)è¶…æ—¶ï¼Œä»…é€šè¿‡10%æ•°æ®      | 10%      |
| **å¹¶æŸ¥é›†+LCT**   | ç»´æŠ¤è¿é€šæ€§+é“¾æ“ä½œ      | ç†è®ºæœ€ä¼˜              | å®ç°å¤æ‚ï¼Œå¸¸æ•°å¤§              | 100%     |
| **å¹³è¡¡æ ‘åºåˆ—åŒ–** | é“¾è½¬åºåˆ—+FHQ Treapç»´æŠ¤ | O(log n)æ“ä½œï¼Œä»£ç æ¸…æ™° | éœ€å¤„ç†ç¿»è½¬æ ‡è®°å’Œçˆ¶æŒ‡é’ˆ        | 100%     |

### âœ¨ ä¼˜åŒ–ä¹‹æ—…ï¼šä»æš´åŠ›åˆ°å¹³è¡¡æ ‘
> 1. **èµ·ç‚¹**ï¼šæš´åŠ›éå†é“¾ç»“æ„ï¼ˆO(n)æ¯æ¬¡æ“ä½œï¼‰  
> 2. **ç“¶é¢ˆ**ï¼šqè¾¾20ä¸‡æ—¶ï¼ŒO(nq)å¿…ç„¶è¶…æ—¶  
> 3. **å…³é”®è·ƒè¿**ï¼šæ„è¯†åˆ°é“¾æœ¬è´¨æ˜¯çº¿æ€§åºåˆ—  
> 4. **ç»ˆè§£**ï¼šç”¨å¹³è¡¡æ ‘ç»´æŠ¤åºåˆ—ï¼Œå®ç°ï¼š  
>    - é“¾åˆå¹¶ â†’ æ ‘åˆå¹¶ + æ–¹å‘è°ƒæ•´  
>    - é“¾åˆ†è£‚ â†’ æŒ‰æ’åæ‹†åˆ†å­æ ‘  
>    - è·¯å¾„æŸ¥è¯¢ â†’ å­æ ‘å’Œè®¡ç®—  

---

## 4. C++æ ¸å¿ƒä»£ç å®ç°èµæ

### é€šç”¨æ ¸å¿ƒå®ç°
```cpp
// é“¾åºåˆ—åŒ–å­˜å‚¨ï¼ˆç‚¹/è¾¹ç»Ÿä¸€ä¸ºèŠ‚ç‚¹ï¼‰
struct Node { 
    int l, r, siz, val, sum, fa; 
    bool rev; 
};

// åˆå¹¶ä¸¤æ¡é“¾ï¼ˆéœ€æ–¹å‘å¯¹é½ï¼‰
void mergeChains(int x, int y, int edge) {
    if(isEndPoint(x) && isEndPoint(y)) {
        if(needFlip(x)) flipTree(x);
        int newEdge = createEdgeNode(edge);
        root = merge(merge(x, newEdge), y);
    }
}

// æŸ¥è¯¢è·¯å¾„ç»ˆç‚¹ä¸æ—¶é—´
void queryDest(int x, int y) {
    if(!isConnected(x, y)) return ERROR;
    int posX = getRank(x), posY = getRank(y);
    int endPoint = (posX < posY) ? rightmost() : leftmost();
    int time = (posX < posY) ? calcRightSum(x) : calcLeftSum(x);
    print(endPoint, time);
}
```

### é¢˜è§£äº®ç‚¹è§£æ
1. **é“¾åˆå¹¶æ–¹å‘å¤„ç†**  
```cpp
if((rx==1||rx==t[fx].siz)&&(ry==1||ry==t[fy].siz)) {
    if(rx==1) swapChain(x,y); 
    if(needFlip(fy)) flipTree(fy);
    mergeTrees(fx, newEdge, fy);
}
```
**è§£è¯»**ï¼šå…ˆåˆ¤æ–­ç«¯ç‚¹æœ‰æ•ˆæ€§ï¼Œå†é€šè¿‡äº¤æ¢å’Œç¿»è½¬å¯¹é½é“¾æ–¹å‘ï¼Œæœ€åæ’å…¥è¾¹èŠ‚ç‚¹åˆå¹¶ã€‚

2. **åŠ¨æ€ç»´æŠ¤çˆ¶æŒ‡é’ˆ**  
```cpp
void update(int x) {
    t[t[x].l].fa = t[t[x].r].fa = x; 
    // æ›´æ–°å­æ ‘ä¿¡æ¯
}
```
**è§£è¯»**ï¼šæ¯æ¬¡æ ‘ç»“æ„è°ƒæ•´åæ›´æ–°çˆ¶æŒ‡é’ˆï¼Œä¸ºå¿«é€ŸæŸ¥è¯¢èŠ‚ç‚¹æ’åå¥ åŸºã€‚

---

## 5. ç®—æ³•å¯è§†åŒ–ï¼šåƒç´ åŠ¨ç”»æ¼”ç¤º

### ğŸ® è®¾è®¡æ¦‚å¿µï¼š**ã€Šé“¾ä¹‹æ¢é™©è€…ã€‹**ï¼ˆ8-bitåƒç´ é£ï¼‰
![](https://fakeurl.com/chain-pixel-preview.gif)  
*åœºæ™¯ï¼šåƒç´ åŒ–åŸå¸‚åœ°å›¾ï¼Œå…¬äº¤ç«™ä¸ºåœ†ç‚¹ï¼Œé“è·¯ä¸ºå½©è‰²çº¿æ¡*

### å…³é”®åŠ¨ç”»è®¾è®¡
1. **é“¾åˆå¹¶è¿‡ç¨‹**  
   - ç«¯ç‚¹é—ªçƒçº¢å…‰ â†’ è™šæ‹Ÿè¾¹èŠ‚ç‚¹åƒç´ æ’å…¥ â†’ é“¾æ¡æ‹¼æ¥åŠ¨ç”»  
   - **éŸ³æ•ˆ**ï¼šé½¿è½®å’¬åˆå£°(åˆå¹¶æˆåŠŸ) / é”™è¯¯éŸ³(æ— æ•ˆæ“ä½œ)

2. **è·¯å¾„æŸ¥è¯¢æ¼”ç¤º**  
   ```mermaid
   graph LR
   A[ä¹˜å®¢] -->|é€‰æ‹©æ–¹å‘| B{æ’åæ¯”è¾ƒ}
   B -->|X<Y| C[å³ç§»åŠ¨ç”»]
   B -->|X>Y| D[å·¦ç§»åŠ¨ç”»]
   C --> E[æ˜¾ç¤ºç»ˆç‚¹+è®¡æ—¶]
   D --> E
   ```
   - **äº¤äº’**ï¼šæ–¹å‘é”®æ§åˆ¶ä¹˜å®¢ç§»åŠ¨ï¼Œå®æ—¶æ˜¾ç¤ºè·¯å¾„å’Œ

3. **æ•°æ®ç»“æ„é€è§†**  
   - å¹³è¡¡æ ‘ç»“æ„ä¾§è¾¹æ å±•ç¤ºï¼Œé«˜äº®å½“å‰æ“ä½œèŠ‚ç‚¹
   - ç¿»è½¬æ“ä½œæ—¶æ’­æ”¾çŸ©é˜µæ—‹è½¬åŠ¨ç”»

---

## 6. æ‹“å±•ç»ƒä¹ ä¸ç›¸ä¼¼é—®é¢˜æ€è€ƒ
### é€šç”¨æŠ€å·§è¿ç§»
1. æ ‘é“¾å‰–åˆ†ä¸­çš„é‡é“¾ç»´æŠ¤  
2. æ–‡æœ¬ç¼–è¾‘å™¨ä¸­çš„åºåˆ—æ“ä½œï¼ˆå¦‚ï¼šå—çŠ¶é“¾è¡¨ï¼‰  
3. åŸºå› ç»„æ‹¼æ¥ä¸­çš„åºåˆ—åˆå¹¶  

### æ´›è°·æ¨è
1. **P2147 [SDOI2008]æ´ç©´å‹˜æµ‹**  
   â†’ ç»ƒä¹ åŠ¨æ€è¿é€šæ€§ç»´æŠ¤  
2. **P3203 [HNOI2010]å¼¹é£ç»µç¾Š**  
   â†’ é“¾å¼ç»“æ„åˆ†å—æŠ€å·§  
3. **P1501 [å›½å®¶é›†è®­é˜Ÿ]Tree II**  
   â†’ LCTç»¼åˆåº”ç”¨  

---

## 7. å­¦ä¹ å¿ƒå¾—ä¸ç»éªŒ
> **ä½œè€…ç»éªŒ**ï¼š  
> *"ç»´æŠ¤çˆ¶æŒ‡é’ˆæ—¶å¿˜è®°è·¯å¾„å‹ç¼©ï¼Œå¯¼è‡´TLE... åŠ¡å¿…åœ¨æŸ¥è¯¢å‰ä¸‹ä¼ æ‰€æœ‰æ ‡è®°ï¼"*  
>   
> **æ´›è¯­äº‘ç¬ºæ€»ç»“**ï¼š  
> 1. æ ‘å½¢æ•°æ®ç»“æ„ä¸­ï¼Œ**æ‡’æ ‡è®°å¿…é¡»å®Œå…¨ä¸‹ä¼ **æ‰èƒ½ä¿è¯æŸ¥è¯¢æ­£ç¡®æ€§  
> 2. **çˆ¶æŒ‡é’ˆç»´æŠ¤**æ˜¯åŒåˆƒå‰‘ï¼šåŠ é€ŸæŸ¥è¯¢ä½†å¢åŠ æ›´æ–°æˆæœ¬  
> 3. é“¾ç«¯ç‚¹åˆ¤æ–­æ—¶æ³¨æ„**è¾¹ç•Œæƒ…å†µ**ï¼ˆå•èŠ‚ç‚¹é“¾ï¼‰  

---

<conclusion>  
**é“¾å¼ç»“æ„çš„è‰ºæœ¯åœ¨äºåºåˆ—åŒ–è¡¨è¾¾**â€”â€”é€šè¿‡æœ¬è§£ï¼Œæˆ‘ä»¬ä¸ä»…å­¦ä¼šç”¨å¹³è¡¡æ ‘ç»´æŠ¤åŠ¨æ€é“¾ï¼Œæ›´æŒæ¡å°†æ‹“æ‰‘å…³ç³»è½¬åŒ–ä¸ºçº¿æ€§åºåˆ—çš„æ€ç»´èŒƒå¼ã€‚è®°ä½ï¼šä¼˜ç§€è§£æ³•å¸¸è¯ç”Ÿäºä¸åŒé¢†åŸŸçš„å·§å¦™èåˆï¼Œå¦‚é½¿è½®å’¬åˆèˆ¬ç²¾å¦™ï¼ï¼ˆæºç å®ç°è§é™„ä»¶ï¼‰  
</conclusion>

---
å¤„ç†ç”¨æ—¶ï¼š211.79ç§’
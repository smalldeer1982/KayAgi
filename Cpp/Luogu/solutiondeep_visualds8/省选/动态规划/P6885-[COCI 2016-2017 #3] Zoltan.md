# é¢˜ç›®ä¿¡æ¯

# [COCI 2016/2017 #3] Zoltan

## é¢˜ç›®æè¿°

Marton çš„æœ‹å‹ Cero æœ‰ä¸€ä¸ªç”± $N$ ä¸ªæ­£æ•´æ•°ç»„æˆçš„æ•°ç»„ã€‚

é¦–å…ˆ Cero ä¼šåœ¨é»‘æ¿ä¸Šå†™ä¸‹è¿™ä¸ªæ•°ç»„ä¸­çš„ç¬¬ä¸€ä¸ªæ•°å­—ã€‚æ¥ä¸‹æ¥ä»–ä¼šåœ¨ä¹‹å‰å†™ä¸‹çš„æ‰€æœ‰æ•°çš„å·¦è¾¹æˆ–è€…å³è¾¹å†™ä¸‹ä¸€ä¸ªæ•°å­—ã€‚é‡å¤ä»¥ä¸Šæ“ä½œå¾—åˆ°ä¸€ä¸ªåºåˆ—ã€‚

è¯·æ³¨æ„ï¼Œæ ¹æ®ä¸Šè¿°æ–¹æ³•æ„é€ å‡ºçš„ä¸¤ä¸ªåºåˆ—ç›¸åŒ**å½“ä¸”ä»…å½“æ¯ä¸€ä¸ªæ•°å­—å†™ä¸‹çš„é¡ºåºå®Œå…¨ç›¸åŒ**ã€‚ä¾‹å¦‚ï¼Œ$1,1$ å¯èƒ½å’Œ $1,1$ ä¸åŒï¼Œå‰è€…çš„ç¬¬äºŒä¸ªæ•°åœ¨ç¬¬ä¸€ä¸ªæ•°çš„å·¦è¾¹ï¼Œåè€…çš„ç¬¬äºŒä¸ªæ•°åœ¨ç¬¬ä¸€ä¸ªæ•°çš„å³è¾¹ã€‚

æ±‚è¿™äº›æ•°ç»„æˆçš„æ‰€æœ‰åºåˆ—ä¸­ï¼Œæœ€é•¿ä¸¥æ ¼é€’å¢å­åºåˆ—é•¿åº¦çš„æœ€å¤§å€¼ $M$ï¼Œä»¥åŠæ‰€æœ‰æœ€é•¿ä¸¥æ ¼é€’å¢å­åºåˆ—é•¿åº¦ç­‰äº $M$ çš„åºåˆ—ä¸­ï¼Œæœ€é•¿ä¸¥æ ¼é€’å¢å­åºåˆ—ä¸ªæ•°çš„æ€»å’Œã€‚è€ƒè™‘åˆ°ç­”æ¡ˆå¯èƒ½å¾ˆå¤§ï¼ŒMarton åªæƒ³çŸ¥é“è¿™ä¸ªæ•°å¯¹ $10^9+7$ å–æ¨¡çš„å€¼ã€‚

## è¯´æ˜/æç¤º

### æ ·ä¾‹è§£é‡Š

#### æ ·ä¾‹ 1 è§£é‡Š

Cero å¯ä»¥æ„é€  $2$ ä¸ªä¸åŒçš„åºåˆ—ï¼Œ$1,1$ å’Œ $1,1$ã€‚

æ˜¾ç„¶æœ€é•¿çš„ä¸¥æ ¼ä¸Šå‡å­åºåˆ—é•¿åº¦ä¸º $1$ï¼Œæœ‰ $4$ ä¸ªå­åºåˆ—æ»¡è¶³ã€‚

#### æ ·ä¾‹ 2 è§£é‡Š

æœ€é•¿çš„ä¸¥æ ¼ä¸Šå‡å­åºåˆ—é•¿åº¦ä¸º $4$ï¼Œåªæœ‰ $1,2,3,4$ æ»¡è¶³ã€‚
 
### æ•°æ®è§„æ¨¡ä¸çº¦å®š

å¯¹äº $30\%$ çš„æ•°æ®ï¼Œæ»¡è¶³ $N\le 20$ã€‚

å¯¹äº $50\%$ çš„æ•°æ®ï¼Œæ»¡è¶³ $N\le 10^3$ã€‚

å¯¹äº $100\%$ çš„æ•°æ®ï¼Œæ»¡è¶³ $N\le 2\times10^5$ï¼Œæ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´  $\le10^9$ã€‚

### è¯´æ˜

**é¢˜ç›®è¯‘è‡ª [COCI2016-2017](https://hsin.hr/coci/archive/2016_2017/) [CONTEST #3](https://hsin.hr/coci/archive/2016_2017/contest3_tasks.pdf) _T5 Zoltan_**ã€‚

æ ·ä¾‹ 1,2 çš„è§£é‡Šéå®˜æ–¹ã€‚

## æ ·ä¾‹ #1

### è¾“å…¥

```
2
1 1 ```

### è¾“å‡º

```
1 4 ```

## æ ·ä¾‹ #2

### è¾“å…¥

```
4
2 1 3 4 ```

### è¾“å‡º

```
4 1```

# AIåˆ†æç»“æœ


# ğŸ’¡ æ´›è¯­äº‘ç¬ºçš„C++ç®—æ³•è§£æï¼šZoltan æ·±å…¥å­¦ä¹ æŒ‡å— ğŸ’¡

> â€œç®—æ³•ä¹‹ç¾åœ¨äºå°†å¤æ‚é—®é¢˜æ‹†è§£ä¸ºä¼˜é›…çš„æ´å¯ŸåŠ›æ‹¼å›¾ã€‚â€â€”â€”æ´›è¯­äº‘ç¬º

## 1. é¢˜ç›®è§£è¯»ä¸ç­–ç•¥åˆæ¢

âœ¨ **æœ¬é¢˜æ ¸å¿ƒæŒ‘æˆ˜**ï¼š  
åœ¨åŠ¨æ€æ„é€ åºåˆ—çš„è¿‡ç¨‹ä¸­ï¼Œ**æœ€å¤§åŒ–æœ€é•¿ä¸¥æ ¼é€’å¢å­åºåˆ—ï¼ˆLISï¼‰é•¿åº¦**å¹¶**ç»Ÿè®¡æ‰€æœ‰æ»¡è¶³æ¡ä»¶çš„åºåˆ—ä¸­LISçš„ä¸ªæ•°æ€»å’Œ**ã€‚æ ¸å¿ƒéš¾ç‚¹åœ¨äºåºåˆ—æ„é€ æ–¹å¼çš„ç‰¹æ®Šæ€§â€”â€”æ¯ä¸ªåç»­æ•°å­—å¯æ’å…¥åºåˆ—å·¦ä¾§æˆ–å³ä¾§ï¼Œå¯¼è‡´åºåˆ—ç©ºé—´å‘ˆæŒ‡æ•°çº§å¢é•¿ã€‚

âœ¨ **æ ¸å¿ƒç®—æ³•æ ‡ç­¾**ï¼š  
`ç¦»æ•£åŒ–` `åŠ¨æ€è§„åˆ’` `æ ‘çŠ¶æ•°ç»„ä¼˜åŒ–` `æœ€é•¿å­åºåˆ—`

ğŸ—£ï¸ **åˆæ­¥åˆ†æ**ï¼š  
> å½“æˆ‘ä»¬é¢å¯¹åºåˆ—åŠ¨æ€æ„é€ é—®é¢˜æ—¶ï¼Œæœ€ç›´è§‚çš„æ€è·¯æ˜¯æš´åŠ›æšä¸¾æ‰€æœ‰$2^n$ç§åºåˆ—ï¼ˆ30åˆ†åšæ³•ï¼‰ã€‚ä½†é€šè¿‡è§‚å¯Ÿé¢˜ç›®ç‰¹å¾ï¼Œå¯ä»¥å‘ç°ä¸€ä¸ªå…³é”®æ€§è´¨ï¼š**ä»»æ„ç”Ÿæˆåºåˆ—çš„LISéƒ½ç”±åŸåºåˆ—çš„ä¸€ä¸ªä¸‹é™å­åºåˆ—ï¼ˆå·¦ä¾§éƒ¨åˆ†ï¼‰å’Œä¸€ä¸ªä¸Šå‡å­åºåˆ—ï¼ˆå³ä¾§éƒ¨åˆ†ï¼‰åœ¨æŸä¸ªä¸­å¿ƒç‚¹æ‹¼æ¥è€Œæˆ**ã€‚è¿™ä¸€æ´å¯Ÿå°†é—®é¢˜è½¬åŒ–ä¸ºé«˜æ•ˆæ±‚è§£åŸåºåˆ—æ¯ä¸ªä½ç½®ä½œä¸ºä¸­å¿ƒæ—¶çš„æœ€ä¼˜æ‹¼æ¥æ–¹æ¡ˆã€‚  

> æœ€ä¼˜ç­–ç•¥é‡‡ç”¨**æ ‘çŠ¶æ•°ç»„ä¼˜åŒ–DP**ï¼ˆ100åˆ†è§£æ³•ï¼‰ï¼š  
> 1. **ç¦»æ•£åŒ–**å‹ç¼©å€¼åŸŸ  
> 2. **å€’åºDP**è®¡ç®—æ¯ä¸ªä½ç½®çš„æœ€é•¿ä¸Šå‡/ä¸‹é™å­åºåˆ—ä¿¡æ¯  
> 3. **æ ‘çŠ¶æ•°ç»„**é«˜æ•ˆç»´æŠ¤åŒºé—´æœ€å€¼åŠæ–¹æ¡ˆæ•°  
> 4. **å¹‚è¿ç®—**å¤„ç†è‡ªç”±é€‰æ‹©ä½çš„è´¡çŒ®  

### ğŸ” ç®—æ³•ä¾¦æ¢ï¼šå¦‚ä½•åœ¨é¢˜ç›®ä¸­å‘ç°çº¿ç´¢ï¼Ÿ

1.  **çº¿ç´¢1 (é—®é¢˜ç›®æ ‡)**ï¼š  
    â€œæ±‚æœ€é•¿ä¸¥æ ¼é€’å¢å­åºåˆ—é•¿åº¦çš„æœ€å¤§å€¼â€æ˜ç¡®æŒ‡å‘**æœ€ä¼˜åŒ–é—®é¢˜**ï¼Œä¸”æ¶‰åŠåºåˆ—æ„é€ è¿‡ç¨‹ä¸­çš„æå€¼ç»Ÿè®¡ï¼Œæš—ç¤ºéœ€è¦é«˜æ•ˆç®—æ³•è€Œéæš´åŠ›æšä¸¾ã€‚

2.  **çº¿ç´¢2 (é—®é¢˜ç‰¹æ€§)**ï¼š  
    â€œæ¯ä¸ªæ•°å­—å¯æ’å…¥å·¦ä¾§æˆ–å³ä¾§â€çš„ç‰¹æ®Šæ“ä½œè§„åˆ™æš—ç¤ºç”Ÿæˆåºåˆ—å…·æœ‰**ç»“æ„æ€§ç‰¹å¾**â€”â€”å·¦ä¾§éƒ¨åˆ†é€†åºã€å³ä¾§éƒ¨åˆ†æ­£åºã€‚è¿™æç¤ºæˆ‘ä»¬å¯ä»¥é€šè¿‡åˆ†æåŸåºåˆ—çš„**ä¸Šå‡/ä¸‹é™å­åºåˆ—**æ¥æ„é€ æœ€ä¼˜è§£ã€‚

3.  **çº¿ç´¢3 (æ•°æ®è§„æ¨¡)**ï¼š  
    $N \leq 2 \times 10^5$ ç›´æ¥å¦å†³ $O(2^N)$ æš´åŠ›è§£æ³•ã€‚è€Œ $O(N \log N)$ çš„æ ‘çŠ¶æ•°ç»„DPåˆšå¥½æ»¡è¶³è¦æ±‚â€”â€”$2 \times 10^5 \times \log_2(2 \times 10^5) \approx 3.5 \times 10^6$ æ¬¡æ“ä½œï¼Œåœ¨ç°ä»£è®¡ç®—æœºå¯æ¥å—èŒƒå›´å†…ã€‚

### ğŸ§  æ€ç»´é“¾æ„å»ºï¼šä»çº¿ç´¢åˆ°ç­–ç•¥

> å°†æ”¶é›†çš„çº¿ç´¢åƒæ‹¼å›¾ä¸€æ ·ç»„åˆï¼š  
> 1. **çº¿ç´¢1ï¼ˆæœ€ä¼˜åŒ–ï¼‰** è¦æ±‚æˆ‘ä»¬æ”¾å¼ƒæš´åŠ›ï¼Œè€ƒè™‘åŠ¨æ€è§„åˆ’ç­‰é«˜æ•ˆç®—æ³•  
> 2. **çº¿ç´¢2ï¼ˆç»“æ„æ€§ï¼‰** æ­ç¤ºç”Ÿæˆåºåˆ—çš„LISå¿…ç„¶ç”±åŸåºåˆ—çš„ä¸‹é™å­åºåˆ—ï¼ˆå·¦ï¼‰+ä¸Šå‡å­åºåˆ—ï¼ˆå³ï¼‰åœ¨ä¸­å¿ƒç‚¹æ‹¼æ¥è€Œæˆ  
> 3. **çº¿ç´¢3ï¼ˆæ•°æ®è§„æ¨¡ï¼‰** è¦æ±‚ä½¿ç”¨ $O(N \log N)$ ç®—æ³•ï¼Œæ ‘çŠ¶æ•°ç»„æˆä¸ºDPä¼˜åŒ–çš„ç†æƒ³é€‰æ‹©  
>  
> **ç»“è®º**ï¼šé€šè¿‡ç¦»æ•£åŒ–å¤„ç†å€¼åŸŸï¼Œå€’åºDPé…åˆæ ‘çŠ¶æ•°ç»„ç»´æŠ¤åŒºé—´æœ€å€¼ï¼Œå®ç° $O(N \log N)$ çš„æœ€ä¼˜è§£ã€‚ä¸­å¿ƒç‚¹æ‹¼æ¥çš„æ´å¯Ÿæ˜¯ç ´è§£æœ¬é¢˜çš„é‡‘é’¥åŒ™ï¼

---

## 2. ç²¾é€‰ä¼˜è´¨é¢˜è§£å‚è€ƒ

**é¢˜è§£ä¸€ï¼šDemeanor_Roy**  
* **äº®ç‚¹**ï¼š  
  1. æ¸…æ™°é˜è¿°â€œä¸­å¿ƒç‚¹æ‹¼æ¥â€çš„æ ¸å¿ƒæ€æƒ³ï¼Œå°†é—®é¢˜åˆ†è§£ä¸º$f_i$ï¼ˆæœ€é•¿ä¸Šå‡ï¼‰ã€$g_i$ï¼ˆæœ€é•¿ä¸‹é™ï¼‰çš„è®¡ç®—  
  2. å®Œæ•´å®ç°æ ‘çŠ¶æ•°ç»„åŒé‡ç»´æŠ¤æœºåˆ¶ï¼Œä»£ç ä¸­`C1`ã€`C2`åˆ†åˆ«å¤„ç†ä¸Šå‡/ä¸‹é™åºåˆ—  
  3. å·§å¦™åˆ©ç”¨`lambda`ç®€åŒ–æ ‘çŠ¶æ•°ç»„æ“ä½œï¼Œæå‡å¯è¯»æ€§  
  4. å¹‚è¿ç®—é¢„å¤„ç†$2^k$ä¼˜åŒ–è®¡ç®—æ•ˆç‡  

**é¢˜è§£äºŒï¼šReunite**  
* **äº®ç‚¹**ï¼š  
  1. ç”¨â€œç¿»æŠ˜â€æ¯”å–»å½¢è±¡è§£é‡Šåºåˆ—æ„é€ è¿‡ç¨‹  
  2. ä¸¥æ ¼åŒºåˆ†ä¸Šå‡/ä¸‹é™åºåˆ—çš„æ ‘çŠ¶æ•°ç»„æŸ¥è¯¢èŒƒå›´ï¼ˆ`a[i]-1`å’Œ`n-a[i]`ï¼‰  
  3. è¾¹ç•Œå¤„ç†ä¸¥è°¨ï¼ˆ`f[i]=1`/`g[i]=1`çš„åˆå§‹åŒ–ï¼‰  
  4. å®Œæ•´å±•ç¤ºç¦»æ•£åŒ–å®ç°ç»†èŠ‚  

**é¢˜è§£ä¸‰ï¼šlyas145**  
* **äº®ç‚¹**ï¼š  
  1. ç‹¬åˆ›æ€§ä½¿ç”¨â€œåƒç´ æ¢é™©â€å¯è§†åŒ–æ¯”å–»è§£é‡Šç®—æ³•æµç¨‹  
  2. è¯¦ç»†æ³¨é‡Šå…³é”®ä»£ç æ®µï¼Œå¦‚æ ‘çŠ¶æ•°ç»„çš„`add`/`query`æ“ä½œ  
  3. å¼ºè°ƒä¸­å¿ƒç‚¹$i$è¢«é‡å¤è®¡ç®—çš„$-1$ä¿®æ­£é€»è¾‘  
  4. å®Œæ•´åŒ…å«ç¦»æ•£åŒ–åˆ°ç»“æœè¾“å‡ºçš„ç«¯åˆ°ç«¯å®ç°  

---

## 3. è§£é¢˜ç­–ç•¥æ·±åº¦å‰–æ

### ğŸ¯ æ ¸å¿ƒéš¾ç‚¹ä¸å…³é”®æ­¥éª¤

1.  **éš¾ç‚¹1ï¼šå¦‚ä½•é«˜æ•ˆè®¡ç®—ä¸­å¿ƒç‚¹ä¸¤ä¾§çš„æœ€å€¼ï¼Ÿ**  
    * **åˆ†æ**ï¼š  
      å€’åºDPï¼ˆä»$n$åˆ°$1$ï¼‰é…åˆæ ‘çŠ¶æ•°ç»„ã€‚å¯¹æ¯ä¸ªä½ç½®$i$ï¼š  
      - **ä¸Šå‡åºåˆ—**ï¼šæŸ¥è¯¢å€¼åŸŸ$[a_i+1, max]$çš„æœ€é•¿åºåˆ—é•¿åº¦$f_i$åŠæ–¹æ¡ˆæ•°$cntf_i$  
      - **ä¸‹é™åºåˆ—**ï¼šæŸ¥è¯¢å€¼åŸŸ$[1, a_i-1]$çš„æœ€é•¿åºåˆ—é•¿åº¦$g_i$åŠæ–¹æ¡ˆæ•°$cntg_i$  
    * ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šå€’åºDPä¿è¯åç»­çŠ¶æ€å…ˆè®¡ç®—ï¼Œæ ‘çŠ¶æ•°ç»„å®ç°$O(\log N)$åŒºé—´æŸ¥è¯¢

2.  **éš¾ç‚¹2ï¼šå¦‚ä½•é¿å…å€¼åŸŸè¿‡å¤§å¯¼è‡´çš„æ€§èƒ½é—®é¢˜ï¼Ÿ**  
    * **åˆ†æ**ï¼š  
      ç¦»æ•£åŒ–å¤„ç†ï¼šå°†åŸæ•°ç»„æ’åºå»é‡åï¼Œæ˜ å°„åˆ°$[1, m]$çš„ç´§å‡‘å€¼åŸŸï¼Œä½¿æ ‘çŠ¶æ•°ç»„ç©ºé—´å¤æ‚åº¦é™è‡³$O(N)$  
    * ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šç¦»æ•£åŒ–æ˜¯å¤„ç†å¤§å€¼åŸŸé—®é¢˜çš„æ ‡å‡†æŠ€å·§ï¼Œéœ€æŒæ¡`sort+unique+lower_bound`ä¸‰æ¿æ–§

3.  **éš¾ç‚¹3ï¼šå¦‚ä½•ç»Ÿè®¡ä¸åœ¨LISä¸­çš„å…ƒç´ è´¡çŒ®ï¼Ÿ**  
    * **åˆ†æ**ï¼š  
      å¯¹äºé•¿åº¦$len = f_i + g_i - 1$çš„LISï¼Œå‰©ä½™$n-len$ä¸ªå…ƒç´ å„æœ‰2ç§é€‰æ‹©ï¼ˆå·¦/å³ï¼‰ï¼Œè´¡çŒ®$2^{n-len}$å€æ–¹æ¡ˆæ•°  
    * ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šä½¿ç”¨é¢„å¤„ç†çš„$2^k$æ•°ç»„é¿å…é‡å¤å¹‚è¿ç®—

### âœ¨ è§£é¢˜æŠ€å·§æ€»ç»“
- **æŠ€å·§1ï¼šé€†å‘æ€ç»´**â€”â€”å€’åºDPåˆ©ç”¨å·²è®¡ç®—çŠ¶æ€  
- **æŠ€å·§2ï¼šç©ºé—´æ¢æ—¶é—´**â€”â€”æ ‘çŠ¶æ•°ç»„$O(\log N)$æ›¿ä»£$O(N)$æ‰«æ  
- **æŠ€å·§3ï¼šé—®é¢˜åˆ†è§£**â€”â€”å°†LISæ‹†åˆ†ä¸ºå·¦ä¾§ä¸‹é™+å³ä¾§ä¸Šå‡å­é—®é¢˜  
- **æŠ€å·§4ï¼šç¦»æ•£åŒ–å‹ç¼©**â€”â€”å°†ç¨€ç–å¤§å€¼åŸŸæ˜ å°„ä¸ºç´§å‡‘å°å€¼åŸŸ  

### âš”ï¸ ç­–ç•¥ç«æŠ€åœºï¼šä¸åŒè§£æ³•çš„å¯¹æ¯”åˆ†æ
| ç­–ç•¥                | æ ¸å¿ƒæ€æƒ³                     | ä¼˜ç‚¹                     | ç¼ºç‚¹                     | å¾—åˆ†é¢„æœŸ       |
|---------------------|-----------------------------|--------------------------|--------------------------|----------------|
| **æš´åŠ›æšä¸¾ (30åˆ†)** | æšä¸¾$2^N$ç§åºåˆ—ï¼Œ$O(N^2)$æ±‚LIS | æ€è·¯ç›´è§‚ï¼Œæ˜“å®ç°         | $O(2^N N^2)$ä¸å¯æ¥å—     | $N \leq 20$    |
| **æ ‘çŠ¶æ•°ç»„DP (100åˆ†)** | ç¦»æ•£åŒ–+å€’åºDP+æ ‘çŠ¶æ•°ç»„ç»´æŠ¤  | $O(N \log N)$é«˜æ•ˆ       | æ€ç»´éš¾åº¦é«˜ï¼Œå®ç°ç»†èŠ‚å¤æ‚ | $N \leq 2 \times 10^5$ |

### âœ¨ ä¼˜åŒ–ä¹‹æ—…ï¼šä»â€œèƒ½åšâ€åˆ°â€œåšå¥½â€
```mermaid
graph LR
    A[æš´åŠ›æšä¸¾] -->|æŒ‡æ•°çˆ†ç‚¸| B[æ•°æ®è§„æ¨¡å¦å†³]
    B --> C[æ´å¯Ÿç»“æ„ç‰¹å¾]
    C --> D[ä¸­å¿ƒç‚¹æ‹¼æ¥ç†è®º]
    D --> E[ç¦»æ•£åŒ–å€¼åŸŸ]
    E --> F[å€’åºDPè®¾è®¡]
    F --> G[æ ‘çŠ¶æ•°ç»„ä¼˜åŒ–]
    G --> H[O(N logN)æœ€ä¼˜è§£]
```

> **ç­–ç•¥æ€»ç»“**ï¼šä»æš´åŠ›åˆ°æœ€ä¼˜è§£çš„è·¨è¶Šï¼Œå…³é”®åœ¨äºå‘ç°â€œåºåˆ—ç¿»æŠ˜â€çš„éšè—ç»“æ„ã€‚æ ‘çŠ¶æ•°ç»„å°†DPçš„åŒºé—´æŸ¥è¯¢å¤æ‚åº¦ä»$O(N)$é™è‡³$O(\log N)$ï¼Œä½¿$10^5$çº§æ•°æ®æˆä¸ºå¯èƒ½ã€‚è¿™å¯ç¤ºæˆ‘ä»¬ï¼š**ä¼˜åŒ–å¸¸æºäºå¯¹é—®é¢˜æœ¬è´¨çš„æ·±åˆ»æ´å¯Ÿä¸æ•°æ®ç»“æ„çš„å·§å¦™ç»“åˆ**ã€‚

---

## 4. C++æ ¸å¿ƒä»£ç å®ç°èµæ

### æœ¬é¢˜é€šç”¨æ ¸å¿ƒå®ç°
```cpp
#include <bits/stdc++.h>
using namespace std;
const int N = 2e5 + 10, mod = 1e9 + 7;

struct BIT {
    int len[N], cnt[N];
    void update(int x, int l, int c) {
        for (; x < N; x += x & -x) {
            if (l > len[x]) len[x] = l, cnt[x] = c;
            else if (l == len[x]) (cnt[x] += c) %= mod;
        }
    }
    pair<int, int> query(int x) {
        int res_len = 0, res_cnt = 1;
        for (; x; x -= x & -x) {
            if (len[x] > res_len) res_len = len[x], res_cnt = cnt[x];
            else if (len[x] == res_len) (res_cnt += cnt[x]) %= mod;
        }
        return {res_len, res_cnt};
    }
} bit_up, bit_down;

int main() {
    int n, a[N], f_up[N], f_down[N], cnt_up[N], cnt_down[N];
    vector<int> vals; // ç¦»æ•£åŒ–å€¼åŸŸ

    // ç¦»æ•£åŒ–
    for (int i = 1; i <= n; i++) {
        cin >> a[i];
        vals.push_back(a[i]);
    }
    sort(vals.begin(), vals.end());
    vals.erase(unique(vals.begin(), vals.end()), vals.end());
    
    // å€’åºDP
    for (int i = n; i >= 1; i--) {
        int pos = lower_bound(vals.begin(), vals.end(), a[i]) - vals.begin() + 1;
        
        // ä¸Šå‡åºåˆ—ï¼ˆæŸ¥è¯¢å¤§äºa[i]ï¼‰
        auto [len_up, cnt_up_val] = bit_up.query(N - 1 - pos);
        f_up[i] = len_up + 1, cnt_up[i] = cnt_up_val;
        bit_up.update(N - pos, f_up[i], cnt_up[i]);
        
        // ä¸‹é™åºåˆ—ï¼ˆæŸ¥è¯¢å°äºa[i]ï¼‰
        auto [len_down, cnt_down_val] = bit_down.query(pos - 1);
        f_down[i] = len_down + 1, cnt_down[i] = cnt_down_val;
        bit_down.update(pos, f_down[i], cnt_down[i]);
    }
    
    // è®¡ç®—ç­”æ¡ˆ
    int max_len = 0, total_cnt = 0;
    for (int i = 1; i <= n; i++) {
        int len = f_up[i] + f_down[i] - 1;
        if (len > max_len) max_len = len, total_cnt = 0;
        if (len == max_len) 
            (total_cnt += 1LL * cnt_up[i] * cnt_down[i] % mod) %= mod;
    }
    // å¤„ç†2^(n-len)
    long long power = 1;
    for (int i = 0; i < n - max_len; i++) power = (power * 2) % mod;
    total_cnt = 1LL * total_cnt * power % mod;

    cout << max_len << " " << total_cnt;
}
```

**ä»£ç è§£è¯»æ¦‚è¦**ï¼š  
1. **ç¦»æ•£åŒ–**ï¼šå°†åŸå§‹å€¼åŸŸå‹ç¼©è‡³$[1, m]$  
2. **åŒæ ‘çŠ¶æ•°ç»„**ï¼š`bit_up`ç»´æŠ¤ä¸Šå‡åºåˆ—ï¼Œ`bit_down`ç»´æŠ¤ä¸‹é™åºåˆ—  
3. **å€’åºDP**ï¼šä»$n$åˆ°$1$éå†ï¼Œä¿è¯çŠ¶æ€ä¾èµ–å…ˆè®¡ç®—  
4. **æ ‘çŠ¶æ•°ç»„æŠ€å·§**ï¼š  
   - ä¸Šå‡åºåˆ—æŸ¥è¯¢è½¬æ¢ä¸º$N-pos$å®ç°åŒºé—´åè½¬  
   - ä¸‹é™åºåˆ—ç›´æ¥æŸ¥è¯¢$[1, pos-1]$  
5. **ç­”æ¡ˆåˆå¹¶**ï¼šéå†æ‰€æœ‰ä¸­å¿ƒç‚¹ï¼Œç´¯åŠ æœ€ä¼˜è§£æ–¹æ¡ˆæ•°  

### é¢˜è§£ç‰‡æ®µèµæ

**Demeanor_Roy çš„æ ‘çŠ¶æ•°ç»„å®ç°**  
```cpp
auto up = query(n + 1 - a[i], C1); // ä¸Šå‡åºåˆ—æŸ¥è¯¢
dp1[i] = up.val + 1, cnt1[i] = up.num;
insert(n + 2 - a[i], dp1[i], cnt1[i], C1); // ä¸Šå‡åºåˆ—æ›´æ–°
```
* **äº®ç‚¹**ï¼š  
  é€šè¿‡`n+1-a[i]`å°†ä¸Šå‡æŸ¥è¯¢è½¬æ¢ä¸ºä¸‹é™æŸ¥è¯¢ï¼Œå¤ç”¨æ ‘çŠ¶æ•°ç»„ç»“æ„

**lyas145 çš„ç¦»æ•£åŒ–å®ç°**  
```cpp
sort(b + 1, b + 1 + n);
m = unique(b + 1, b + 1 + n) - b - 1;
for (int i = 1; i <= n; i++)
    a[i] = lower_bound(b + 1, b + 1 + m, a[i]) - b;
```
* **å­¦ä¹ ç¬”è®°**ï¼š  
  æ ‡å‡†ç¦»æ•£åŒ–ä¸‰è¿ï¼šæ’åº â†’ å»é‡ â†’ äºŒåˆ†æ˜ å°„

---

## 5. ç®—æ³•å¯è§†åŒ–ï¼šåƒç´ åŠ¨ç”»æ¼”ç¤º

### åƒç´ åŒ–æ¼”ç¤ºè®¾è®¡
```mermaid
graph TD
    A[å¯åŠ¨] --> B[åˆå§‹åŒ–ç½‘æ ¼]
    B --> C[ç¦»æ•£åŒ–æ•°å€¼]
    C --> D[å€’åºæ‰«æ]
    D --> E{ä½ç½®i}
    E --> F[æŸ¥è¯¢æ ‘çŠ¶æ•°ç»„]
    F --> G[æ›´æ–°çŠ¶æ€]
    G --> H[æ¸²æŸ“åƒç´ å—]
    H --> I{å®Œæˆï¼Ÿ}
    I --å¦--> D
    I --æ˜¯--> J[æ˜¾ç¤ºæœ€ä¼˜è·¯å¾„]
```

**åƒç´ åŠ¨ç”»æ–¹æ¡ˆ**ï¼š  
1. **8ä½åƒç´ é£æ ¼**ï¼š  
   - ç½‘æ ¼èƒŒæ™¯ï¼š16x16åƒç´ å—ï¼ŒFCçº¢ç™½æœºé…è‰²ï¼ˆæ·±è“èƒŒæ™¯+äº®è‰²å…ƒç´ ï¼‰  
   - å…ƒç´ è¡¨ç¤ºï¼š  
     * å½“å‰ä¸­å¿ƒç‚¹ï¼šé—ªçƒé‡‘è‰²æ–¹å—  
     * ä¸Šå‡åºåˆ—ï¼šç»¿è‰²ç®­å¤´ï¼ˆâ†’ï¼‰  
     * ä¸‹é™åºåˆ—ï¼šçº¢è‰²ç®­å¤´ï¼ˆâ†ï¼‰  
     * æ ‘çŠ¶æ•°ç»„ï¼šåº•éƒ¨äºŒè¿›åˆ¶æ ‘çŠ¶ç»“æ„ï¼Œæ›´æ–°æ—¶äº®é»„é—ªçƒ  

2. **åŠ¨æ€æ¼”ç¤ºæµç¨‹**ï¼š  
   - **å¸§1**ï¼šåˆå§‹åŒ–æ˜¾ç¤ºåŸæ•°ç»„ï¼ˆåƒç´ æ¡å½¢å›¾é«˜åº¦=æ•°å€¼ï¼‰  
   - **å¸§2**ï¼šç¦»æ•£åŒ–æ˜ å°„ï¼Œæ˜¾ç¤ºå‹ç¼©åå€¼åŸŸ  
   - **å¸§3**ï¼šä»å³å‘å·¦æ‰«æï¼Œå½“å‰ä¸­å¿ƒç‚¹é«˜äº®  
   - **å¸§4**ï¼šæ ‘çŠ¶æ•°ç»„æŸ¥è¯¢åŒºåŸŸé«˜äº®ï¼ˆä¸Šå‡ï¼šå¤§äºå½“å‰å€¼ï¼›ä¸‹é™ï¼šå°äºå½“å‰å€¼ï¼‰  
   - **å¸§5**ï¼šçŠ¶æ€æ›´æ–°ï¼Œæ˜¾ç¤º$f_i$/$g_i$æ•°å€¼åŠæ–¹æ¡ˆæ•°  
   - **å¸§6**ï¼šæœ€ä¼˜è·¯å¾„æ¸²æŸ“ï¼ˆä¸‹é™åºåˆ—å·¦æŠ˜+ä¸Šå‡åºåˆ—å³æŠ˜ï¼‰  

3. **äº¤äº’æ§åˆ¶**ï¼š  
   - æ­¥è¿›æ§åˆ¶ï¼šâ† â†’ é”®å•æ­¥å‰è¿›/åé€€  
   - é€Ÿåº¦è°ƒèŠ‚ï¼šâ†‘ â†“ é”®è°ƒæ•´å¸§ç‡ï¼ˆ0.5x~4xï¼‰  
   - æ¨¡å¼åˆ‡æ¢ï¼š  
     * Aé”®ï¼šè‡ªåŠ¨æ¼”ç¤ºï¼ˆAIè´ªåƒè›‡å¼éå†ï¼‰  
     * Mé”®ï¼šåˆ‡æ¢ä¸­å¿ƒç‚¹è§†è§’  

4. **éŸ³æ•ˆè®¾è®¡**ï¼š  
   - æ ‘çŠ¶æ•°ç»„æ›´æ–°ï¼š8-bit "å®"å£°ï¼ˆNESéŸ³æ•ˆï¼‰  
   - æœ€ä¼˜è·¯å¾„å‘ç°ï¼šèƒœåˆ©å·è§’ï¼ˆFCã€Šè¶…çº§ç›ä¸½ã€‹è¿‡å…³éŸ³æ•ˆï¼‰  
   - é”™è¯¯æ“ä½œï¼šçŸ­ä¿ƒè­¦ç¤ºéŸ³  

> **è®¾è®¡ç›®çš„**ï¼šé€šè¿‡åƒç´ åŠ¨ç”»ç›´è§‚å‘ˆç°å€’åºDPå’Œæ ‘çŠ¶æ•°ç»„æ›´æ–°çš„åŠ¨æ€è¿‡ç¨‹ï¼Œå¸®åŠ©ç†è§£â€œä¸­å¿ƒç‚¹æ‹¼æ¥â€ç†è®ºçš„ç©ºé—´ç»“æ„ã€‚

---

## 6. æ‹“å±•ç»ƒä¹ ä¸ç›¸ä¼¼é—®é¢˜æ€è€ƒ

### ç›¸ä¼¼é—®é¢˜è¿ç§»
1. **åˆ†ç»„èƒŒåŒ…é—®é¢˜**ï¼š  
   - å°†ç‰©å“åˆ†ç»„ï¼Œæ¯ç»„é€‰ä¸€ç§æ–¹æ¡ˆï¼ˆç±»æ¯”ä¸­å¿ƒç‚¹é€‰æ‹©ï¼‰  
   - ä¾‹é¢˜ï¼š[P1757 é€šå¤©ä¹‹åˆ†ç»„èƒŒåŒ…](https://www.luogu.com.cn/problem/P1757)

2. **å¸¦ä¾èµ–çš„å­åºåˆ—é—®é¢˜**ï¼š  
   - éœ€æ»¡è¶³ç‰¹å®šæ¡ä»¶ï¼ˆå¦‚ä¸Šå‡+ä¸‹é™ï¼‰çš„å­åºåˆ—æ‹¼æ¥  
   - ä¾‹é¢˜ï¼š[P2782 åºåˆ—æ‹¼æ¥](https://www.luogu.com.cn/problem/P2782)

3. **æ ‘å½¢DPä¸­çš„è·¯å¾„ç»Ÿè®¡**ï¼š  
   - æ ‘ä¸­ä¸Šå‡è·¯å¾„/ä¸‹é™è·¯å¾„çš„ç»„åˆä¼˜åŒ–  
   - ä¾‹é¢˜ï¼š[P3177 [HAOI2015] æ ‘ä¸ŠæŸ“è‰²](https://www.luogu.com.cn/problem/P3177)

### æ¨èç»ƒä¹ 
1. **P1439 ã€æ¨¡æ¿ã€‘æœ€é•¿å…¬å…±å­åºåˆ—**  
   * ç»ƒä¹ ç¦»æ•£åŒ–+æ ‘çŠ¶æ•°ç»„ä¼˜åŒ–DPçš„åŸºç¡€åº”ç”¨  
   * ç†è§£å€¼åŸŸå‹ç¼©å¯¹æ€§èƒ½çš„å½±å“  

2. **P1776 å®ç‰©ç­›é€‰**  
   * å¼ºåŒ–å¤šé‡èƒŒåŒ…çš„äºŒè¿›åˆ¶ä¼˜åŒ–æ€ç»´  
   * è¿ç§»â€œé—®é¢˜åˆ†è§£â€æŠ€å·§  

3. **P2602 [ZJOI2010] æ•°å­—è®¡æ•°**  
   * è®­ç»ƒæ•°ä½DPä¸æ ‘çŠ¶æ•°ç»„çš„ç»“åˆ  
   * æå‡å¤§å€¼åŸŸé—®é¢˜å¤„ç†èƒ½åŠ›  

---

## 7. å­¦ä¹ å¿ƒå¾—ä¸ç»éªŒåˆ†äº«
> **æ¥è‡ª Demeananor_Roy çš„è°ƒè¯•ç»éªŒ**ï¼š  
> â€œåœ¨å®ç°æ ‘çŠ¶æ•°ç»„æ—¶ï¼Œç‰¹åˆ«æ³¨æ„`query`å’Œ`update`çš„è¾¹ç•Œæƒ…å†µâ€”â€”æˆ‘æ›¾å› æœªå¤„ç†ç©ºæŸ¥è¯¢ï¼ˆè¿”å›æ–¹æ¡ˆæ•°=1ï¼‰WAå¤šæ¬¡ã€‚å»ºè®®åœ¨å…³é”®å‡½æ•°å†…åŠ å…¥æ–­è¨€ï¼š`assert(pos >= 1 && pos <= n)`â€

> **æ´›è¯­äº‘ç¬ºæ€»ç»“**ï¼š  
> 1. **ç¦»æ•£åŒ–é™·é˜±**ï¼šé‡å¤å…ƒç´ éœ€ä¿è¯ç¨³å®šæ€§ï¼ˆ`lower_bound`ä¸¥æ ¼å‡åºï¼‰  
> 2. **æ ‘çŠ¶æ•°ç»„è®¾è®¡**ï¼šä¸Šå‡åºåˆ—æŸ¥è¯¢ç”¨å€¼åŸŸåè½¬æŠ€å·§é¿å…é¢å¤–æ•°æ®ç»“æ„  
> 3. **æ¨¡è¿ç®—å®‰å…¨**ï¼š`1LL * a * b % mod`é˜²intæº¢å‡º  
> 4. **å€’åºDPä¼˜åŠ¿**ï¼šè‡ªç„¶æ»¡è¶³çŠ¶æ€ä¾èµ–ï¼Œé€»è¾‘æ›´æ¸…æ™°  

---
> â€œç¼–ç¨‹ä¹‹è·¯ä¸Šï¼Œæœ€ä¼˜é›…çš„è§£æ³•å¾€å¾€è¯ç”Ÿäºå¯¹é—®é¢˜æœ¬è´¨çš„æ·±åˆ»æ´å¯Ÿã€‚æ„¿ä½ åœ¨ç®—æ³•çš„æ˜Ÿè¾°å¤§æµ·ä¸­ï¼Œæ°¸è¿œä¿æŒæ¢ç´¢çš„çƒ­æƒ…ï¼â€â€”â€”æ´›è¯­äº‘ç¬º

---
å¤„ç†ç”¨æ—¶ï¼š194.23ç§’
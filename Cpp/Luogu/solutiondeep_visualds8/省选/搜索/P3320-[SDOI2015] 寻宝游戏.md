# é¢˜ç›®ä¿¡æ¯

# [SDOI2015] å¯»å®æ¸¸æˆ

## é¢˜ç›®æè¿°

å° B æœ€è¿‘æ­£åœ¨ç©ä¸€ä¸ªå¯»å®æ¸¸æˆï¼Œè¿™ä¸ªæ¸¸æˆçš„åœ°å›¾ä¸­æœ‰ $N$ ä¸ªæ‘åº„å’Œ $N-1$ æ¡é“è·¯ï¼Œå¹¶ä¸”ä»»ä½•ä¸¤ä¸ªæ‘åº„ä¹‹é—´æœ‰ä¸”ä»…æœ‰ä¸€æ¡è·¯å¾„å¯è¾¾ã€‚æ¸¸æˆå¼€å§‹æ—¶ï¼Œç©å®¶å¯ä»¥ä»»æ„é€‰æ‹©ä¸€ä¸ªæ‘åº„ï¼Œç¬é—´è½¬ç§»åˆ°è¿™ä¸ªæ‘åº„ï¼Œç„¶åå¯ä»¥ä»»æ„åœ¨åœ°å›¾çš„é“è·¯ä¸Šè¡Œèµ°ï¼Œè‹¥èµ°åˆ°æŸä¸ªæ‘åº„ä¸­æœ‰å®ç‰©ï¼Œåˆ™è§†ä¸ºæ‰¾åˆ°è¯¥æ‘åº„å†…çš„å®ç‰©ï¼Œç›´åˆ°æ‰¾åˆ°æ‰€æœ‰å®ç‰©å¹¶è¿”å›åˆ°æœ€åˆè½¬ç§»åˆ°çš„æ‘åº„ä¸ºæ­¢ã€‚

å° B å¸Œæœ›è¯„æµ‹ä¸€ä¸‹è¿™ä¸ªæ¸¸æˆçš„éš¾åº¦ï¼Œå› æ­¤ä»–éœ€è¦çŸ¥é“ç©å®¶æ‰¾åˆ°æ‰€æœ‰å®ç‰©éœ€è¦è¡Œèµ°çš„æœ€çŸ­è·¯ç¨‹ã€‚ä½†æ˜¯è¿™ä¸ªæ¸¸æˆä¸­å®ç‰©ç»å¸¸å˜åŒ–ï¼Œæœ‰æ—¶æŸä¸ªæ‘åº„ä¸­ä¼šçªç„¶å‡ºç°å®ç‰©ï¼Œæœ‰æ—¶æŸä¸ªæ‘åº„å†…çš„å®ç‰©ä¼šçªç„¶æ¶ˆå¤±ï¼Œå› æ­¤å° B éœ€è¦ä¸æ–­åœ°æ›´æ–°æ•°æ®ï¼Œä½†æ˜¯å° B å¤ªæ‡’äº†ï¼Œä¸æ„¿æ„è‡ªå·±è®¡ç®—ï¼Œå› æ­¤ä»–å‘ä½ æ±‚åŠ©ã€‚ä¸ºäº†ç®€åŒ–é—®é¢˜ï¼Œæˆ‘ä»¬è®¤ä¸ºæœ€å¼€å§‹æ—¶æ‰€æœ‰æ‘åº„å†…å‡æ²¡æœ‰å®ç‰©ã€‚

## è¯´æ˜/æç¤º

- å¯¹äº $10\%$ çš„æ•°æ®ï¼Œ$1 \leq N \leq 100, 1 \leq M \leq 100$ï¼›
- å¯¹äº $20\%$ çš„æ•°æ®ï¼Œ$1 \leq N \leq 1000, 1 \leq M \leq 1000$ï¼›
- å¯¹äºå¦å¤– $15\%$ çš„æ•°æ®ï¼Œæ¯ä¸ªæ‘åº„æœ€å¤šæˆä¸ºä¸¤æ¡é“è·¯çš„ç«¯ç‚¹ï¼›
- å¯¹äº $100\%$ çš„æ•°æ®ï¼Œ$1 \leq N \leq 100000,\ 1 \leq M \leq 100000,\ 1 \leq z \leq 10^9$ã€‚

## æ ·ä¾‹ #1

### è¾“å…¥

```
4 5
1 2 30
2 3 50
2 4 60
2
3
4
2
1```

### è¾“å‡º

```
0
100
220
220
280```

# AIåˆ†æç»“æœ

# ğŸ’¡ æ´›è¯­äº‘ç¬ºçš„C++ç®—æ³•è§£æï¼š[SDOI2015] å¯»å®æ¸¸æˆ æ·±å…¥å­¦ä¹ æŒ‡å— ğŸ’¡

> æ¬¢è¿æ¥åˆ°ã€Œå¯»å®æ¸¸æˆã€çš„æ€ç»´æ¢é™©ï¼ä»Šå¤©æˆ‘ä»¬è¦åœ¨ä¸€æ£µå·¨å¤§çš„æ ‘ä¸Šï¼ŒåŠ¨æ€è¿½è¸ªå®è—çš„ä½ç½®ï¼Œå¹¶å®æ—¶è®¡ç®—â€œæ”¶é›†æ‰€æœ‰å®è—å†å›å®¶â€çš„æœ€çŸ­è·¯ç¨‹ã€‚è¿™ä¸ä»…è€ƒéªŒæˆ‘ä»¬å¯¹æ ‘ç»“æ„çš„ç†è§£ï¼Œæ›´æ˜¯ä¸€åœºå…³äºå¦‚ä½•ä¼˜é›…å¤„ç†â€œåŠ¨æ€ç‚¹é›†â€é—®é¢˜çš„å¤´è„‘é£æš´ã€‚

---

## 1. é¢˜ç›®è§£è¯»ä¸ç­–ç•¥åˆæ¢

âœ¨ **æœ¬é¢˜æ ¸å¿ƒæŒ‘æˆ˜**ï¼šåœ¨ä¸€æ£µå¸¦æƒæ ‘ä¸Šï¼ŒåŠ¨æ€ç»´æŠ¤ä¸€ä¸ªâ€œå…³é”®ç‚¹â€é›†åˆï¼Œæ¯æ¬¡æ“ä½œåå¿«é€Ÿæ±‚å‡ºè¿™äº›ç‚¹çš„â€œæœ€å°è¿é€šå­æ ‘â€è¾¹æƒå’Œçš„ä¸¤å€ã€‚

âœ¨ **æ ¸å¿ƒç®—æ³•æ ‡ç­¾**ï¼š`LCA`ã€`DFSåº`ã€`å¹³è¡¡æ ‘/Set`ã€`ç»“è®ºæ¨å¯¼`

ğŸ—£ï¸ **åˆæ­¥åˆ†æ**ï¼š
- é¢˜ç›®æœ¬è´¨æ˜¯æ±‚â€œæœ€å°æ–¯å¦çº³æ ‘â€çš„è¾¹æƒå’Œï¼Œä½†æ•°æ®èŒƒå›´è¦æ±‚æ›´å·§å¦™çš„æ€è·¯ã€‚
- å…³é”®çªç ´ç‚¹ï¼šå°†ç‚¹é›†æŒ‰DFSåºæ’åºåï¼Œç­”æ¡ˆç­‰äºç›¸é‚»ç‚¹è·ç¦»å’Œçš„ä¸¤å€ï¼ˆä¸€ä¸ªç¯ï¼‰ã€‚è¿™ä¸€ç»“è®ºå°†å¤æ‚é—®é¢˜è½¬åŒ–ä¸ºâ€œåŠ¨æ€ç»´æŠ¤æœ‰åºç‚¹é›†â€ã€‚
- æœ€ç»ˆç­–ç•¥ï¼šç”¨`std::set`ç»´æŠ¤DFSåºï¼Œæ¯æ¬¡æ’å…¥/åˆ é™¤æ—¶ï¼Œåªéœ€è°ƒæ•´å‰åç›¸é‚»ç‚¹çš„è´¡çŒ®å³å¯ã€‚

---

### ğŸ” ç®—æ³•ä¾¦æ¢ï¼šå¦‚ä½•åœ¨é¢˜ç›®ä¸­å‘ç°çº¿ç´¢ï¼Ÿ
1.  **çº¿ç´¢1 (é—®é¢˜ç›®æ ‡)**: "æ±‚æœ€çŸ­è·¯ç¨‹"æç¤ºæœ€ä¼˜åŒ–é—®é¢˜ï¼Œä½†æ ‘ç»“æ„æš—ç¤ºå¯èƒ½éœ€è¦è·¯å¾„æ€§è´¨ã€‚
2.  **çº¿ç´¢2 (é—®é¢˜çº¦æŸ)**: "åŠ¨æ€ä¿®æ”¹ç‚¹é›†" â†’ éœ€è¦é«˜æ•ˆç»´æŠ¤æœ‰åºç»“æ„ï¼ˆå¦‚å¹³è¡¡æ ‘ï¼‰ã€‚
3.  **çº¿ç´¢3 (æ•°æ®è§„æ¨¡)**: `N,M â‰¤ 1e5` â†’ è¦æ±‚å•æ¬¡æ“ä½œ`O(log N)`ï¼Œæ’é™¤æš´åŠ›ã€‚

---

### ğŸ§  æ€ç»´é“¾æ„å»ºï¼šä»çº¿ç´¢åˆ°ç­–ç•¥
> "ä¾¦æ¢å·¥ä½œå®Œæˆï¼æˆ‘ä»¬å‘ç°ï¼š
> 1.  è¿™æ˜¯ä¸€ä¸ªåŠ¨æ€ç‚¹é›†é—®é¢˜ï¼Œæš´åŠ›è®¡ç®—æ¯æ¬¡`O(N)`ä¼šè¶…æ—¶ã€‚
> 2.  é€šè¿‡DFSåºå°†æ ‘ç»“æ„è½¬åŒ–ä¸ºçº¿æ€§åºåˆ—ï¼Œå·§å¦™åˆ©ç”¨`set`ç»´æŠ¤æœ‰åºæ€§ã€‚
> 3.  æœ€ç»ˆå¤æ‚åº¦`O(M log N)`ï¼Œå®Œç¾åŒ¹é…æ•°æ®èŒƒå›´ï¼"

---

## 2. ç²¾é€‰ä¼˜è´¨é¢˜è§£å‚è€ƒ

### é¢˜è§£ä¸€ï¼šå°ç²‰å…”çš„Set+LCAï¼ˆç»¼åˆè¯„åˆ†ï¼š5æ˜Ÿï¼‰
- **æ ¸å¿ƒæ€æƒ³**ï¼šDFSåº + ç›¸é‚»ç‚¹è·ç¦»å’Œçš„ç»“è®ºï¼Œç”¨`set`ç»´æŠ¤åŠ¨æ€ç‚¹é›†ã€‚
- **ä»£ç äº®ç‚¹**ï¼š
  - ç®€æ´çš„LCAå€å¢å®ç°
  - ä¼˜é›…çš„`set`æ’å…¥/åˆ é™¤é€»è¾‘ï¼ˆè§`Insert`/`Erase`å‡½æ•°ï¼‰
- **å­¦ä¹ ç¬”è®°**ï¼šå°†æ ‘é—®é¢˜è½¬åŒ–ä¸ºåºåˆ—é—®é¢˜ï¼Œæ˜¯å¤„ç†åŠ¨æ€ç‚¹é›†çš„ç»å…¸æŠ€å·§ã€‚

### é¢˜è§£äºŒï¼šHzaoçš„æ ‘çŠ¶æ•°ç»„+å€å¢ï¼ˆ4æ˜Ÿï¼‰
- **åˆ›æ–°ç‚¹**ï¼šç”¨æ ‘çŠ¶æ•°ç»„ç»´æŠ¤å­æ ‘ä¿¡æ¯ï¼Œç»“åˆå€å¢æ‰¾æœ€è¿‘å…³é”®ç‚¹ã€‚
- **é€‚ç”¨åœºæ™¯**ï¼šéœ€è¦æ›´å¤æ‚çš„å­æ ‘æŸ¥è¯¢æ—¶ï¼ˆå¦‚ç»Ÿè®¡å­æ ‘å†…å…³é”®ç‚¹æ•°é‡ï¼‰ã€‚
- **å­¦ä¹ ç¬”è®°**ï¼šæ ‘çŠ¶æ•°ç»„åœ¨æ ‘ä¸Šçš„åº”ç”¨éœ€ç»“åˆDFSåºã€‚

---

## 3. è§£é¢˜ç­–ç•¥æ·±åº¦å‰–æ

### ğŸ¯ æ ¸å¿ƒéš¾ç‚¹ä¸å…³é”®æ­¥éª¤
1.  **å…³é”®ç‚¹1ï¼šDFSåºçš„é­”æ³•**
    - **åˆ†æ**ï¼šDFSåºå°†æ ‘ç»“æ„çº¿æ€§åŒ–ï¼Œ`dfn[u]`è¡¨ç¤ºèŠ‚ç‚¹`u`çš„è®¿é—®é¡ºåºã€‚
    - ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼š`dfn[u] < dfn[v]` â‡¨ `u`åœ¨`v`çš„å·¦ä¾§å­æ ‘ä¸­ã€‚

2.  **å…³é”®ç‚¹2ï¼šç›¸é‚»ç‚¹è·ç¦»å’Œå…¬å¼**
    - **åˆ†æ**ï¼šå¯¹äºDFSåºæ’åºåçš„ç‚¹é›†`{a1,a2,...,ak}`ï¼Œç­”æ¡ˆä¸ºï¼š
      ```
      2 * (dist(a1,a2) + dist(a2,a3) + ... + dist(ak,a1))
      ```
    - ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šè¯¥ç»“è®ºæºäºæ¬§æ‹‰å›è·¯æ€§è´¨ï¼Œæ¯æ¡è¾¹è¢«éå†ä¸¤æ¬¡ã€‚

3.  **å…³é”®ç‚¹3ï¼šSetçš„ç²¾å¦™æ“ä½œ**
    - **åˆ†æ**ï¼šæ’å…¥ç‚¹`x`æ—¶ï¼Œæ‰¾åˆ°å…¶DFSåºçš„å‰é©±`l`å’Œåç»§`r`ï¼Œæ›´æ–°ï¼š
      ```
      ans += dist(l,x) + dist(x,r) - dist(l,r)
      ```
    - ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šè¾¹ç•Œå¤„ç†ï¼ˆå¦‚`x`æ˜¯æœ€å°/æœ€å¤§DFSåºæ—¶ï¼Œéœ€å¾ªç¯å¤„ç†ï¼‰ã€‚

---

### âš”ï¸ ç­–ç•¥ç«æŠ€åœºï¼šä¸åŒè§£æ³•çš„å¯¹æ¯”åˆ†æ

| ç­–ç•¥ | æ ¸å¿ƒæ€æƒ³ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
| :--- | :--- | :--- | :--- | :--- |
| **Set+LCA** | DFSåº+ç›¸é‚»ç‚¹è·ç¦»å’Œ | ä»£ç ç®€æ´ï¼Œå¸¸æ•°å° | éœ€ç†è§£ç»“è®º | æ ‡å‡†è§£æ³•ï¼ˆ100%åˆ†æ•°ï¼‰ |
| **æ ‘çŠ¶æ•°ç»„+å€å¢** | å­æ ‘ä¿¡æ¯+å€å¢æ‰¾ç‚¹ | æ”¯æŒæ›´å¤æ‚æŸ¥è¯¢ | å®ç°å¤æ‚ | éœ€è¦æ‰©å±•åŠŸèƒ½æ—¶ |
| **è™šæ ‘** | æ˜¾å¼æ„å»ºè™šæ ‘ | æ¨¡å‹ç²¾ç¡® | å®ç°ç¹ç | æ•™å­¦æ¼”ç¤º |

---

### âœ¨ ä¼˜åŒ–ä¹‹æ—…ï¼šä»â€œèƒ½åšâ€åˆ°â€œåšå¥½â€
> "ä»æš´åŠ›`O(N)`åˆ°`O(log N)`çš„é£è·ƒï¼Œå…³é”®åœ¨äºå°†æ ‘ç»“æ„è½¬åŒ–ä¸ºåºåˆ—ï¼Œå¹¶ç”¨å¹³è¡¡æ ‘ç»´æŠ¤åŠ¨æ€æ€§ã€‚è¿™å‘Šè¯‰æˆ‘ä»¬ï¼šå¥½çš„ç®—æ³•å¾€å¾€æºäºå¯¹é—®é¢˜ç»“æ„çš„æ·±åˆ»æ´å¯Ÿï¼"

---

## 4. C++æ ¸å¿ƒä»£ç å®ç°èµæ

### æœ¬é¢˜é€šç”¨æ ¸å¿ƒC++å®ç°å‚è€ƒ
```cpp
#include <bits/stdc++.h>
using namespace std;
typedef long long LL;

const int MAXN = 1e5 + 5;
int N, M, dfn[MAXN], pos[MAXN], dep[MAXN], fa[MAXN][20];
LL dis[MAXN];
vector<pair<int, int>> G[MAXN];
set<int> st;
LL ans = 0;

void dfs(int u, int f) {
    static int cnt = 0;
    dfn[u] = ++cnt;
    pos[cnt] = u;
    dep[u] = dep[f] + 1;
    fa[u][0] = f;
    for (int i = 1; i < 20; ++i)
        fa[u][i] = fa[fa[u][i-1]][i-1];
    for (auto [v, w] : G[u]) if (v != f) {
        dis[v] = dis[u] + w;
        dfs(v, u);
    }
}

int lca(int x, int y) {
    if (dep[x] < dep[y]) swap(x, y);
    for (int i = 19; ~i; --i)
        if (dep[fa[x][i]] >= dep[y]) x = fa[x][i];
    if (x == y) return x;
    for (int i = 19; ~i; --i)
        if (fa[x][i] != fa[y][i]) x = fa[x][i], y = fa[y][i];
    return fa[x][0];
}

LL dist(int x, int y) {
    return dis[x] + dis[y] - 2 * dis[lca(x, y)];
}

int main() {
    ios::sync_with_stdio(false);
    cin.tie(nullptr);
    cin >> N >> M;
    for (int i = 1, u, v, w; i < N; ++i) {
        cin >> u >> v >> w;
        G[u].emplace_back(v, w);
        G[v].emplace_back(u, w);
    }
    dfs(1, 0);
    vector<bool> vis(N + 1);
    while (M--) {
        int x; cin >> x;
        if (!vis[x]) {
            st.insert(dfn[x]);
            auto it = st.find(dfn[x]);
            int l = (it == st.begin()) ? *prev(st.end()) : *prev(it);
            int r = (next(it) == st.end()) ? *st.begin() : *next(it);
            ans += dist(pos[l], x) + dist(x, pos[r]) - dist(pos[l], pos[r]);
        } else {
            auto it = st.find(dfn[x]);
            int l = (it == st.begin()) ? *prev(st.end()) : *prev(it);
            int r = (next(it) == st.end()) ? *st.begin() : *next(it);
            ans -= dist(pos[l], x) + dist(x, pos[r]) - dist(pos[l], pos[r]);
            st.erase(dfn[x]);
        }
        cout << ans << '\n';
        vis[x] ^= 1;
    }
    return 0;
}
```

---

## 5. ç®—æ³•å¯è§†åŒ–ï¼šåƒç´ åŠ¨ç”»æ¼”ç¤º

### è®¾è®¡æ€è·¯
- **ä¸»é¢˜**ï¼šåƒç´ é£â€œå¯»å®ç¯æ¸¸è®°â€ï¼Œç”¨8ä½åƒç´ å—å±•ç¤ºæ ‘çš„DFSåºå’ŒSetæ“ä½œã€‚
- **æ ¸å¿ƒåŠ¨ç”»**ï¼š
  1.  **DFSåºç”Ÿæˆ**ï¼šåƒç´ åŒ–DFSéå†ï¼ŒèŠ‚ç‚¹æŒ‰è®¿é—®é¡ºåºç‚¹äº®ã€‚
  2.  **Setç»´æŠ¤**ï¼šæ’å…¥/åˆ é™¤èŠ‚ç‚¹æ—¶ï¼Œé«˜äº®å‰é©±å’Œåç»§ï¼ŒåŠ¨æ€æ›´æ–°è·ç¦»å’Œã€‚
- **äº¤äº’å…ƒç´ **ï¼š
  - æ­¥è¿›æŒ‰é’®ï¼šå•æ­¥æŸ¥çœ‹Setæ“ä½œã€‚
  - éŸ³æ•ˆï¼šæ’å…¥èŠ‚ç‚¹æ—¶æ’­æ”¾â€œå®â€ï¼Œåˆ é™¤æ—¶æ’­æ”¾â€œå’šâ€ã€‚

---

## 6. æ‹“å±•ç»ƒä¹ ä¸ç›¸ä¼¼é—®é¢˜æ€è€ƒ

### é€šç”¨æŠ€å·§è¿ç§»
- **DFSåº+Set**é€‚ç”¨äºæ‰€æœ‰â€œåŠ¨æ€ç‚¹é›†è¿é€šæ€§â€é—®é¢˜ï¼Œå¦‚ï¼š
  1.  **åŠ¨æ€ç›´å¾„**ï¼šç»´æŠ¤æ ‘çš„ç›´å¾„ï¼ˆæœ€è¿œä¸¤ç‚¹è·ç¦»ï¼‰ã€‚
  2.  **åŠ¨æ€é‡å¿ƒ**ï¼šæ”¯æŒæ’å…¥/åˆ é™¤ç‚¹åå¿«é€ŸæŸ¥è¯¢é‡å¿ƒã€‚
  3.  **åŠ¨æ€LCA**ï¼šå¿«é€ŸæŸ¥è¯¢ä»»æ„ä¸¤ç‚¹çš„LCAã€‚

### æ´›è°·æ¨èé¢˜ç›®
1.  **P3384** - æ ‘é“¾å‰–åˆ†æ¨¡æ¿
   - ğŸ—£ï¸ æ¨èç†ç”±ï¼šå·©å›ºLCAå’Œå­æ ‘æŸ¥è¯¢åŸºç¡€ã€‚
2.  **P3690** - åŠ¨æ€æ ‘ï¼ˆLCTï¼‰
   - ğŸ—£ï¸ æ¨èç†ç”±ï¼šè¿›é˜¶åŠ¨æ€æ ‘ç»“æ„ï¼Œæ”¯æŒæ›´å¤æ‚çš„è¿é€šæ€§æ“ä½œã€‚
3.  **P4719** - åŠ¨æ€DP
   - ğŸ—£ï¸ æ¨èç†ç”±ï¼šç»“åˆåŠ¨æ€è§„åˆ’ä¸æ ‘ç»“æ„ï¼Œæå‡å»ºæ¨¡èƒ½åŠ›ã€‚

---

## 7. å­¦ä¹ å¿ƒå¾—ä¸ç»éªŒåˆ†äº«

> **è°ƒè¯•æŠ€å·§**ï¼šå¤šä½ä½œè€…æåˆ°è¾¹ç•Œå¤„ç†ï¼ˆå¦‚ç©ºSetã€å•ç‚¹Setï¼‰æ˜¯å¸¸è§å‘ç‚¹ï¼Œå»ºè®®ï¼š
> 1.  ç”¨å“¨å…µèŠ‚ç‚¹ï¼ˆå¦‚`dfn=0`å’Œ`dfn=N+1`ï¼‰ç®€åŒ–è¾¹ç•Œåˆ¤æ–­ã€‚
> 2.  æ‰“å°`set`å†…å®¹éªŒè¯å‰é©±/åç»§æ˜¯å¦æ­£ç¡®ã€‚

---

### ç»“è®º
é€šè¿‡â€œDFSåº+Setâ€çš„ä¼˜é›…è½¬åŒ–ï¼Œæˆ‘ä»¬å°†çœ‹ä¼¼å¤æ‚çš„æ ‘é—®é¢˜ç®€åŒ–ä¸ºåºåˆ—æ“ä½œã€‚è®°ä½ï¼šå½“æ ‘ç»“æ„éš¾ä»¥ç›´æ¥å¤„ç†æ—¶ï¼Œå°è¯•ç”¨DFSåºå°†å…¶â€œæ‹‰å¹³â€â€”â€”è¿™æ˜¯è§£å†³åŠ¨æ€æ ‘é—®é¢˜çš„é‡‘é’¥åŒ™ï¼

---
å¤„ç†ç”¨æ—¶ï¼š62.49ç§’
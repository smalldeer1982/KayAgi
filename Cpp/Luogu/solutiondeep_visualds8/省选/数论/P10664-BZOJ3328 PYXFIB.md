# é¢˜ç›®ä¿¡æ¯

# BZOJ3328 PYXFIB

## é¢˜ç›®æè¿°

ç»™å®šæ•´æ•° $n,k,p$ï¼Œè¦æ±‚è®¡ç®—ä¸‹åˆ—å¼å­å¯¹ $p$ å–æ¨¡çš„å€¼ï¼š

$$\sum_{i=0}^{\lfloor \frac{n}{k} \rfloor} C_n^{i\times k}\times F_{i\times k}$$

å…¶ä¸­ï¼š
- $p$ ä¸ºè´¨æ•°ï¼Œä¸” $p$ é™¤ä»¥ $k$ çš„ä½™æ•°ä¸º $1$ã€‚
- $C$ ä¸ºç»„åˆæ•°ï¼Œå³ $C_m^n=\frac{n!}{m!(n-m)!}$ã€‚
- $F_n$ ä¸ºæ–æ³¢é‚£å¥‘æ•°åˆ—ï¼Œå³ $F_0=1$ï¼Œ$F_1=1$ï¼Œ$F_n=F_{n-1}+F_{n-2}(n\geq 2)$ã€‚

## è¯´æ˜/æç¤º

å¯¹äº $100\%$ çš„æ•°æ®ï¼Œä¿è¯ $1\leq n\leq 10^{18}$ï¼Œ$1\leq k \leq 20000$ï¼Œ$1\leq T\leq 20$ï¼Œ$1\leq p\leq 10^9$ï¼Œ$p$ ä¸ºè´¨æ•°ï¼Œä¸” $p$ é™¤ä»¥ $k$ çš„ä½™æ•°ä¸º $1$ã€‚

## æ ·ä¾‹ #1

### è¾“å…¥

```
1
1 2 3```

### è¾“å‡º

```
1```

# AIåˆ†æç»“æœ

# ğŸ’¡ æ´›è¯­äº‘ç¬ºçš„C++ç®—æ³•è§£æï¼šBZOJ3328 PYXFIB æ·±å…¥å­¦ä¹ æŒ‡å— ğŸ’¡

> å„ä½å°‘å¹´ç®—æ³•æ¢é™©å®¶ï¼Œæ¬¢è¿æ¥åˆ°ä»Šå¤©çš„**æ•°å­¦é­”æ³•è¯¾**ï¼  
> è¿™æ¬¡æˆ‘ä»¬è¦ä¸€èµ·ç ´è§£çš„ï¼Œæ˜¯ä¸€é“**â€œçœ‹ä¼¼å“äººï¼Œå®åˆ™ä¼˜é›…â€**çš„æ•°è®º+ä»£æ•°ç»¼åˆé¢˜ã€‚  
> æ ¸å¿ƒæŒ‘æˆ˜ï¼š**å¦‚ä½•åœ¨æ¨¡æ„ä¹‰ä¸‹ï¼Œé«˜æ•ˆæ±‚å‡ºâ€œæ¯éš” k é¡¹çš„æ–æ³¢é‚£å¥‘æ•°åˆ—ä¹‹å’Œâ€ï¼Ÿ**  
> åˆ«æ‹…å¿ƒï¼Œæˆ‘ä»¬å°†ä»æš´åŠ›æšä¸¾ä¸€æ­¥æ­¥èµ°å‘**å•ä½æ ¹åæ¼” + çŸ©é˜µå¿«é€Ÿå¹‚**çš„åä¸½è§£æ³•ï¼

---

## 1. é¢˜ç›®è§£è¯»ä¸ç­–ç•¥åˆæ¢

### âœ¨ æ ¸å¿ƒæŒ‘æˆ˜
> ç»™å®š **nã€kã€p**ï¼Œæ±‚  
> **Î£ C(n, iÂ·k) Â· F(iÂ·k) mod p**  
> å…¶ä¸­ **F** æ˜¯æ–æ³¢é‚£å¥‘æ•°åˆ—ï¼Œ**p** æ˜¯è´¨æ•°ä¸” **k | p-1**ã€‚

### âœ¨ æ ¸å¿ƒç®—æ³•æ ‡ç­¾
- **å•ä½æ ¹åæ¼”**ï¼ˆæ•°å­¦é­”æ³•ï¼‰
- **çŸ©é˜µå¿«é€Ÿå¹‚**ï¼ˆé«˜æ•ˆè®¡ç®—ï¼‰
- **åŸæ ¹ä¸æ¨¡é€†å…ƒ**ï¼ˆæ¨¡è®ºåŸºç¡€ï¼‰

---

### ğŸ” ç®—æ³•ä¾¦æ¢ï¼šå¦‚ä½•åœ¨é¢˜ç›®ä¸­å‘ç°çº¿ç´¢ï¼Ÿ

| çº¿ç´¢ | å‘ç° |
|---|---|
| **çº¿ç´¢1ï¼šæ±‚å’Œå½¢å¼** | **Î£ C(n, iÂ·k) Â· F(iÂ·k)** â†’ éœ€è¦**â€œæ¯éš”ké¡¹â€**æ±‚å’Œï¼Œæš—ç¤º**å•ä½æ ¹åæ¼”** |
| **çº¿ç´¢2ï¼šæ¨¡æ•°ç‰¹æ€§** | **pæ˜¯è´¨æ•°ï¼Œk | p-1** â†’ æ¨¡æ„ä¹‰ä¸‹**å­˜åœ¨kæ¬¡å•ä½æ ¹** |
| **çº¿ç´¢3ï¼šæ•°æ®èŒƒå›´** | **n â‰¤ 1e18** â†’ æš´åŠ›æšä¸¾ä¸å¯è¡Œï¼Œéœ€è¦**O(log n)**çº§åˆ«ç®—æ³• |
| **çº¿ç´¢4ï¼šæ–æ³¢é‚£å¥‘** | **F(iÂ·k)** â†’ å¯ç”¨**çŸ©é˜µå¿«é€Ÿå¹‚**è¡¨ç¤ºï¼Œä¾¿äºä»£æ•°è¿ç®— |

---

### ğŸ§  æ€ç»´é“¾æ„å»ºï¼šä»çº¿ç´¢åˆ°ç­–ç•¥

> 1. **æš´åŠ›æ€è·¯**ï¼šæšä¸¾æ‰€æœ‰ **iÂ·k â‰¤ n**ï¼Œè®¡ç®— **C(n, iÂ·k)** å’Œ **F(iÂ·k)**ï¼Œä½† **n â‰¤ 1e18** â†’ æ˜¾ç„¶è¶…æ—¶ï¼  
> 2. **æ•°å­¦è½¬åŒ–**ï¼šå‘ç° **â€œæ¯éš”ké¡¹â€** å¯ä»¥ç”¨ **å•ä½æ ¹åæ¼”** è½¬åŒ–ä¸º **â€œå¯¹æ‰€æœ‰å•ä½æ ¹æ±‚å’Œâ€** â†’ å°† **ç»„åˆæ•°Ã—æ–æ³¢é‚£å¥‘** è½¬åŒ–ä¸º **çŸ©é˜µå¹‚**ï¼  
> 3. **é«˜æ•ˆè®¡ç®—**ï¼šåˆ©ç”¨ **çŸ©é˜µå¿«é€Ÿå¹‚**ï¼Œå°†å¤æ‚åº¦ä» **O(n)** é™åˆ° **O(k log n)**ï¼

---

## 2. ç²¾é€‰ä¼˜è´¨é¢˜è§£å‚è€ƒ

### âœ… **é¢˜è§£ä¸€ï¼šPurslaneï¼ˆ7èµï¼‰**
- **äº®ç‚¹**ï¼š**å•ä½æ ¹åæ¼”** + **çŸ©é˜µå¿«é€Ÿå¹‚** çš„å®Œç¾ç»“åˆï¼Œä»£ç æ¸…æ™°
- **å…³é”®æŠ€å·§**ï¼š
  - ä½¿ç”¨ **çŸ©é˜µå¿«é€Ÿå¹‚** è®¡ç®— **(I + Ï‰^j M)^n**
  - é€šè¿‡ **åŸæ ¹** æ‰¾åˆ°æ¨¡æ„ä¹‰ä¸‹çš„ **kæ¬¡å•ä½æ ¹**
- **å­¦ä¹ ç¬”è®°**ï¼š
  > å•ä½æ ¹åæ¼”æ˜¯å¤„ç†â€œå‘¨æœŸæ€§æ±‚å’Œâ€çš„åˆ©å™¨ï¼ŒçŸ©é˜µå¿«é€Ÿå¹‚è®©æŒ‡æ•°çº§å¤æ‚åº¦é™åˆ°å¯¹æ•°çº§ï¼

### âœ… **é¢˜è§£äºŒï¼šmEdenï¼ˆ4èµï¼‰**
- **äº®ç‚¹**ï¼š**é€šé¡¹å…¬å¼** + **æ‰©åŸŸ** çš„ä¸¥è°¨æ¨å¯¼ï¼Œè¦†ç›– **p=2/5** çš„ç‰¹åˆ¤
- **å…³é”®æŠ€å·§**ï¼š
  - ä½¿ç”¨ **æ–æ³¢é‚£å¥‘é€šé¡¹å…¬å¼** å°†é—®é¢˜è½¬åŒ–ä¸º **äºŒé¡¹å¼å±•å¼€**
  - å¤„ç† **âˆš5** åœ¨æ¨¡æ„ä¹‰ä¸‹çš„å­˜åœ¨æ€§ï¼ˆäºŒæ¬¡å‰©ä½™/æ‰©åŸŸï¼‰
- **å­¦ä¹ ç¬”è®°**ï¼š
  > æ•°å­¦æ¨å¯¼çš„ä¸¥è°¨æ€§è‡³å…³é‡è¦ï¼Œå°¤å…¶æ˜¯è¾¹ç•Œæƒ…å†µï¼ˆå¦‚p=2æˆ–5ï¼‰ï¼

### âœ… **é¢˜è§£ä¸‰ï¼šxiezheyuanï¼ˆ1èµï¼‰**
- **äº®ç‚¹**ï¼š**çŸ©é˜µå°è£…** + **STLä¼˜åŒ–**ï¼Œä»£ç é£æ ¼ç°ä»£
- **å…³é”®æŠ€å·§**ï¼š
  - ä½¿ç”¨ **C++æ¨¡æ¿çŸ©é˜µç±»**ï¼Œç®€åŒ–çŸ©é˜µè¿ç®—
  - åˆ©ç”¨ **std::all_of** ä¼˜é›…å¯»æ‰¾åŸæ ¹
- **å­¦ä¹ ç¬”è®°**ï¼š
  > è‰¯å¥½çš„ä»£ç å°è£…èƒ½å¤§å¹…æå‡å¯è¯»æ€§å’Œå¤ç”¨æ€§ï¼

---

## 3. è§£é¢˜ç­–ç•¥æ·±åº¦å‰–æ

### ğŸ¯ æ ¸å¿ƒéš¾ç‚¹ä¸å…³é”®æ­¥éª¤

| å…³é”®ç‚¹ | åˆ†æ | ğŸ’¡ å­¦ä¹ ç¬”è®° |
|---|---|---|
| **å•ä½æ ¹åæ¼”** | å°† **Î£ [k|i] C(n,i) F(i)** è½¬åŒ–ä¸º **(1/k) Î£_j (I + Ï‰^j M)^n** | **å‘¨æœŸæ€§æ±‚å’Œ**çš„é€šç”¨æŠ€å·§ |
| **çŸ©é˜µå¿«é€Ÿå¹‚** | ç”¨ **çŸ©é˜µä¹˜æ³•** è¡¨ç¤ºæ–æ³¢é‚£å¥‘é€’æ¨ï¼Œå¤æ‚åº¦ **O(log n)** | é€’æ¨é—®é¢˜çš„**ä»£æ•°åŒ–**æ–¹æ³• |
| **åŸæ ¹å¯»æ‰¾** | é€šè¿‡ **g^((p-1)/k)** æ„é€ æ¨¡æ„ä¹‰ä¸‹çš„ **kæ¬¡å•ä½æ ¹** | æ¨¡è®ºä¸­**åŸæ ¹**çš„æ ¸å¿ƒä½œç”¨ |

---

### âš”ï¸ ç­–ç•¥ç«æŠ€åœºï¼šä¸åŒè§£æ³•å¯¹æ¯”

| ç­–ç•¥ | æ ¸å¿ƒæ€æƒ³ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|---|---|---|---|---|
| **æš´åŠ›æšä¸¾** | ç›´æ¥è®¡ç®—æ¯é¡¹ | æ€è·¯ç›´è§‚ | **O(n)**ï¼Œè¶…æ—¶ | **n â‰¤ 1e6** |
| **å•ä½æ ¹åæ¼” + çŸ©é˜µå¿«é€Ÿå¹‚** | æ•°å­¦è½¬åŒ– + é«˜æ•ˆè®¡ç®— | **O(k log n)** | éœ€æ•°å­¦æ¨å¯¼ | **æœ¬é¢˜æœ€ä¼˜è§£** |
| **é€šé¡¹å…¬å¼ + æ‰©åŸŸ** | ä»£æ•°åŒ– + æ‰©åŸŸè¿ç®— | ç†è®ºä¸¥è°¨ | å®ç°å¤æ‚ | **ç†è®ºéªŒè¯** |

---

### âœ¨ ä¼˜åŒ–ä¹‹æ—…ï¼šä»æš´åŠ›åˆ°ä¼˜é›…

> 1. **æš´åŠ›å›°å¢ƒ**ï¼šæšä¸¾æ‰€æœ‰ **iÂ·k** é¡¹ï¼Œ**O(n)** æ— æ³•æ¥å—ï¼  
> 2. **æ•°å­¦çªç ´**ï¼šå‘ç° **â€œæ¯éš”ké¡¹â€** å¯ä»¥ç”¨ **å•ä½æ ¹åæ¼”** è½¬åŒ–ä¸º **â€œå¯¹æ‰€æœ‰å•ä½æ ¹æ±‚å’Œâ€**ï¼  
> 3. **ä»£æ•°åŒ–**ï¼šå°† **æ–æ³¢é‚£å¥‘é€’æ¨** è½¬åŒ–ä¸º **çŸ©é˜µå¹‚**ï¼Œåˆ©ç”¨ **çŸ©é˜µå¿«é€Ÿå¹‚** é«˜æ•ˆè®¡ç®—ï¼  
> 4. **æœ€ç»ˆä¼˜åŒ–**ï¼šé€šè¿‡ **åŸæ ¹** æ„é€  **å•ä½æ ¹**ï¼Œå¤æ‚åº¦é™è‡³ **O(k log n)**ï¼

---

## 4. C++æ ¸å¿ƒä»£ç å®ç°èµæ

### ğŸ” é€šç”¨æ ¸å¿ƒå®ç°å‚è€ƒ

```cpp
#include <bits/stdc++.h>
using namespace std;

const int MOD = 1e9 + 7;

struct Matrix {
    int a[2][2];
    Matrix() { memset(a, 0, sizeof(a)); }
    Matrix operator*(const Matrix& b) const {
        Matrix res;
        for (int i = 0; i < 2; ++i)
            for (int k = 0; k < 2; ++k)
                for (int j = 0; j < 2; ++j)
                    res.a[i][j] = (res.a[i][j] + 1LL * a[i][k] * b.a[k][j]) % MOD;
        return res;
    }
};

Matrix matrix_pow(Matrix base, long long n) {
    Matrix res;
    res.a[0][0] = res.a[1][1] = 1;
    while (n) {
        if (n & 1) res = res * base;
        base = base * base;
        n >>= 1;
    }
    return res;
}

int qpow(int a, int b, int p) {
    int res = 1;
    while (b) {
        if (b & 1) res = 1LL * res * a % p;
        a = 1LL * a * a % p;
        b >>= 1;
    }
    return res;
}

int find_primitive_root(int p) {
    if (p == 2) return 1;
    int phi = p - 1;
    vector<int> factors;
    int tmp = phi;
    for (int i = 2; i * i <= tmp; ++i) {
        if (tmp % i == 0) {
            factors.push_back(i);
            while (tmp % i == 0) tmp /= i;
        }
    }
    if (tmp > 1) factors.push_back(tmp);
    for (int g = 2; g <= p; ++g) {
        bool ok = true;
        for (int f : factors) {
            if (qpow(g, phi / f, p) == 1) {
                ok = false;
                break;
            }
        }
        if (ok) return g;
    }
    return -1;
}

int solve(long long n, int k, int p) {
    int g = find_primitive_root(p);
    int omega = qpow(g, (p - 1) / k, p);
    Matrix mat;
    mat.a[0][0] = mat.a[0][1] = mat.a[1][0] = 1;
    Matrix res;
    for (int j = 0; j < k; ++j) {
        Matrix tmp = mat;
        tmp.a[0][0] = (tmp.a[0][0] + qpow(omega, j, p)) % p;
        tmp.a[0][1] = qpow(omega, j, p) % p;
        tmp.a[1][0] = 1;
        tmp.a[1][1] = 0;
        tmp = matrix_pow(tmp, n);
        res.a[0][0] = (res.a[0][0] + tmp.a[0][0]) % p;
        res.a[0][1] = (res.a[0][1] + tmp.a[0][1]) % p;
    }
    return 1LL * res.a[0][0] * qpow(k, p - 2, p) % p;
}
```

---

### ğŸŒŸ å…³é”®ä»£ç ç‰‡æ®µèµæ

#### **1. å•ä½æ ¹åæ¼”æ ¸å¿ƒ**
```cpp
int ans = 0;
for (int j = 0; j < k; ++j) {
    int wj = qpow(omega, j, p);
    Matrix tmp = identity + mat * wj;
    tmp = matrix_pow(tmp, n);
    ans = (ans + tmp.a[0][0]) % p;
}
ans = 1LL * ans * qpow(k, p - 2, p) % p;
```
- **è§£è¯»**ï¼šé€šè¿‡ **å•ä½æ ¹åæ¼”** å°†é—®é¢˜è½¬åŒ–ä¸º **kæ¬¡çŸ©é˜µå¹‚æ±‚å’Œ**ï¼Œæœ€åç”¨ **è´¹é©¬å°å®šç†** å¤„ç†é™¤æ³•ï¼

#### **2. åŸæ ¹å¯»æ‰¾**
```cpp
for (int g = 2; g <= p; ++g) {
    bool ok = true;
    for (int f : factors) {
        if (qpow(g, (p - 1) / f, p) == 1) ok = false;
    }
    if (ok) return g;
}
```
- **è§£è¯»**ï¼šé€šè¿‡ **è¯•é™¤æ³•** éªŒè¯åŸæ ¹ï¼Œç¡®ä¿ **Ï‰** çš„æ­£ç¡®æ€§ï¼

---

## 5. ç®—æ³•å¯è§†åŒ–ï¼šåƒç´ åŠ¨ç”»æ¼”ç¤º

### ğŸ® åŠ¨ç”»ä¸»é¢˜ï¼š**â€œåƒç´ æ•°å­¦æ¢é™©â€**
- **åœºæ™¯**ï¼š8ä½åƒç´ é£æ ¼çš„æ•°å­¦å®éªŒå®¤ï¼Œå±•ç¤º **å•ä½æ ¹** å’Œ **çŸ©é˜µè¿ç®—** çš„é­”æ³•ï¼
- **æ ¸å¿ƒæ¼”ç¤º**ï¼š
  1. **å•ä½æ ¹ç”Ÿæˆ**ï¼šåƒç´ åŒ–çš„ **åŸæ ¹ g** ç”Ÿæˆ **kæ¬¡å•ä½æ ¹ Ï‰**ã€‚
  2. **çŸ©é˜µè¿ç®—**ï¼šåƒç´ çŸ©é˜µ **M** çš„å¹‚æ¬¡è®¡ç®—ï¼Œä¼´éš **â€œå®â€** éŸ³æ•ˆã€‚
  3. **æ±‚å’ŒåŠ¨ç”»**ï¼š**kä¸ªçŸ©é˜µ** çš„ç»“æœåƒç´ åŒ–æ±‚å’Œï¼Œæœ€ç»ˆå¾—åˆ°ç­”æ¡ˆï¼
- **äº¤äº’æ§åˆ¶**ï¼š
  - **æ­¥è¿›æŒ‰é’®**ï¼šé€æ­¥å±•ç¤ºæ¯ä¸ª **Ï‰^j** çš„è®¡ç®—è¿‡ç¨‹ã€‚
  - **é€Ÿåº¦æ»‘å—**ï¼šè°ƒæ•´åŠ¨ç”»é€Ÿåº¦ï¼Œé€‚åº”ä¸åŒå­¦ä¹ èŠ‚å¥ã€‚
  - **éŸ³æ•ˆæç¤º**ï¼šå…³é”®æ“ä½œæ—¶æ’­æ”¾ **8ä½éŸ³æ•ˆ**ï¼

---

## 6. æ‹“å±•ç»ƒä¹ ä¸ç›¸ä¼¼é—®é¢˜æ€è€ƒ

### ğŸ¯ é€šç”¨æŠ€å·§è¿ç§»
- **å•ä½æ ¹åæ¼”**ï¼šé€‚ç”¨äº **â€œå‘¨æœŸæ€§æ±‚å’Œâ€** é—®é¢˜ï¼Œå¦‚ï¼š
  - **Î£ C(n, iÂ·k)**ï¼ˆç»„åˆæ•°æ¯éš”ké¡¹æ±‚å’Œï¼‰
  - **Î£ (-1)^i C(n, i)**ï¼ˆäº¤é”™æ±‚å’Œï¼‰
  - **Î£ C(n, i) Â· i^k**ï¼ˆå¸¦å¹‚æ¬¡æ±‚å’Œï¼‰

### ğŸ“š æ´›è°·æ¨è
| é¢˜å· | æ¨èç†ç”± |
|---|---|
| **P4722** | å•ä½æ ¹åæ¼”çš„ç»å…¸æ¨¡æ¿é¢˜ï¼Œå·©å›ºæ•°å­¦æ¨å¯¼ï¼ |
| **P4245** | ç»“åˆ **å¤šé¡¹å¼** å’Œ **å•ä½æ ¹** çš„é«˜çº§åº”ç”¨ï¼ |
| **P5591** | è€ƒå¯Ÿ **çŸ©é˜µå¿«é€Ÿå¹‚** å’Œ **æ¨¡è¿ç®—** çš„ç»¼åˆèƒ½åŠ›ï¼ |

---

## 7. å­¦ä¹ å¿ƒå¾—ä¸ç»éªŒåˆ†äº«

> **ä½œè€…Purslaneçš„è°ƒè¯•å¿ƒå¾—**ï¼š
> â€œæˆ‘ä¸ä¼šæšä¸¾ä¸€ä¸ªæ•°çš„æ‰€æœ‰è´¨å› æ•°ï¼Œçœ‹æ¥å®é™…CCFè¯„çº§åªæœ‰3çº§ã€‚â€  
> **æ´›è¯­äº‘ç¬ºç‚¹è¯„**ï¼š  
> æ•°å­¦é¢˜çš„å®ç°å¾€å¾€å¡åœ¨æœ€åä¸€æ­¥çš„**ç»†èŠ‚å¤„ç†**ï¼å¯»æ‰¾åŸæ ¹æ—¶ï¼Œ**è´¨å› æ•°åˆ†è§£**çš„ä¼˜åŒ–æ˜¯å…³é”®ï¼Œå»ºè®®å¤§å®¶å¤šç»ƒä¹  **Pollard-Rho** ç­‰ç®—æ³•ï¼

---

### ğŸŒŸ ç»“è¯­
ä»Šå¤©çš„æ•°å­¦é­”æ³•è¯¾å°±åˆ°è¿™é‡Œï¼  
è®°ä½ï¼š**ä¼˜é›…çš„æ•°å­¦æ¨å¯¼ + é«˜æ•ˆçš„ä»£ç å®ç° = è§£å†³å¤æ‚é—®é¢˜çš„é’¥åŒ™**ï¼  
ä¸‹æ¬¡æˆ‘ä»¬å†ä¸€èµ·æ¢ç´¢æ–°çš„ç®—æ³•ä¸–ç•Œï¼ğŸ’ª

---
å¤„ç†ç”¨æ—¶ï¼š104.59ç§’
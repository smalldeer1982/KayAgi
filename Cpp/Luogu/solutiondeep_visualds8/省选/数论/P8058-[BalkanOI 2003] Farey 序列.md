# é¢˜ç›®ä¿¡æ¯

# [BalkanOI 2003] Farey åºåˆ—

## é¢˜ç›®æè¿°

æŠŠæ‰€æœ‰åˆ†å­å’Œåˆ†æ¯éƒ½ $\leq n$ çš„**æœ€ç®€çœŸåˆ†æ•°**ä»å°åˆ°å¤§æ’æˆä¸€è¡Œï¼Œå½¢æˆçš„åºåˆ—ç§°ä¸º Farey åºåˆ—ã€‚

æ±‚å‡º $n$ æ‰€å¯¹åº”çš„ Farey åºåˆ—ä¸­ç¬¬ $k$ å°çš„æ•°ã€‚

## è¯´æ˜/æç¤º

å¯¹äº $100\%$ çš„æ•°æ®ï¼Œ$2 \leq n \leq 4 \times 10^4$ï¼Œ$1 \leq k \leq$ ç¬¦åˆæ¡ä»¶çš„åˆ†æ•°çš„ä¸ªæ•°ã€‚

## æ ·ä¾‹ #1

### è¾“å…¥

```
5 6```

### è¾“å‡º

```
3 5```

# AIåˆ†æç»“æœ

# ğŸ’¡ æ´›è¯­äº‘ç¬ºçš„C++ç®—æ³•è§£æï¼šFarey åºåˆ— æ·±å…¥å­¦ä¹ æŒ‡å— ğŸ’¡

> ä»Šå¤©æˆ‘ä»¬æ¥ä¸€èµ·åˆ†æ **BalkanOI 2003 Farey åºåˆ—** è¿™é“æ•°è®º+ç®—æ³•ç»¼åˆé¢˜ã€‚å®ƒæ—¢è€ƒéªŒæˆ‘ä»¬å¯¹åˆ†æ•°ã€äº’è´¨çš„ç†è§£ï¼Œåˆæ¶‰åŠ**äºŒåˆ†ç­”æ¡ˆã€è«æ¯”ä¹Œæ–¯åæ¼”ã€ç±»æ¬§å‡ é‡Œå¾—ã€Sternâ€“Brocot æ ‘**å››å¤§ç¥å…µã€‚  
> æˆ‘ä»¬å°†åƒæ¢é™©å®¶ä¸€æ ·ï¼Œä»æœ´ç´ æšä¸¾ä¸€è·¯å‡çº§åˆ°â€œä½äºçº¿æ€§â€çš„é¡¶çº§ä¼˜åŒ–ï¼Œæ„Ÿå—ç®—æ³•ä¹‹ç¾ï¼

---

## 1. é¢˜ç›®è§£è¯»ä¸ç­–ç•¥åˆæ¢

âœ¨ **æ ¸å¿ƒæŒ‘æˆ˜**  
â€œåœ¨ n ä»¥å†…æ‰€æœ‰æœ€ç®€çœŸåˆ†æ•°æ’å¥½é˜Ÿåï¼Œå¿«é€Ÿé”å®šç¬¬ k ä¸ªæ˜¯è°ã€‚â€  
éš¾ç‚¹åœ¨äºï¼š  
1. åˆ†æ•°æ•°é‡â‰ˆ0.304 nÂ²ï¼ˆn=4Ã—10â´ æ—¶çº¦ 5Ã—10â¸ ä¸ªï¼‰ï¼Œ**æ— æ³•å…¨éƒ¨ç”Ÿæˆ**ã€‚  
2. éœ€è¦**å¯è®¡ç®—æ’å**çš„æ•°å­¦å·¥å…·ï¼Œè€Œéæš´åŠ›æšä¸¾ã€‚

âœ¨ **æ ¸å¿ƒç®—æ³•æ ‡ç­¾**  
äºŒåˆ†ç­”æ¡ˆã€è«æ¯”ä¹Œæ–¯åæ¼”ã€ç±»æ¬§å‡ é‡Œå¾—ã€Sternâ€“Brocot æ ‘ã€Farey é€’æ¨

ğŸ—£ï¸ **æ€è·¯æ¼”è¿›è·¯çº¿**  
1. **O(nÂ²) æš´åŠ›** â†’ 2. **O(n logÂ² n) æµ®ç‚¹äºŒåˆ†+å®¹æ–¥** â†’ 3. **O(n log n) Farey é€’æ¨** â†’ 4. **O(n^{2/3}+âˆšn logÂ² n) Sternâ€“Brocot + ç±»æ¬§** â†’ 5. **O(n^{2/3}+âˆšn log^{1.5} n) ç‹„åˆ©å…‹é›·æ±‚å’Œä¼˜åŒ–**

---

### ğŸ” ç®—æ³•ä¾¦æ¢ï¼šå¦‚ä½•åœ¨é¢˜ç›®ä¸­å‘ç°çº¿ç´¢ï¼Ÿ

| çº¿ç´¢ | å‘ç°è¿‡ç¨‹ | æŒ‡å‘ç®—æ³• |
|---|---|---|
| **çº¿ç´¢1ï¼šæ’åæŸ¥è¯¢** | â€œæ±‚ç¬¬ k å°â€å¤©ç„¶æ”¯æŒäºŒåˆ†ç­”æ¡ˆ | äºŒåˆ† |
| **çº¿ç´¢2ï¼šæœ€ç®€åˆ†æ•°** | åˆ†å­åˆ†æ¯äº’è´¨ â‡’ Î¼(d) å‡ºåœº | è«æ¯”ä¹Œæ–¯åæ¼” |
| **çº¿ç´¢3ï¼šè®¡æ•°å¼** | Î£âŒŠix/yâŒ‹ å½¢å¼å‡ºç° | ç±»æ¬§å‡ é‡Œå¾— |
| **çº¿ç´¢4ï¼šæœ‰åºåºåˆ—** | Farey åºåˆ—ä¸¥æ ¼é€’å¢ä¸”å¯é€’æ¨ | Farey é€’æ¨ |
| **çº¿ç´¢5ï¼šå¤§ n** | nâ‰¤4Ã—10â´ éœ€ä½äº O(n logÂ² n) | æ•°å­¦çº§ä¼˜åŒ– |

---

### ğŸ§  æ€ç»´é“¾æ„å»ºï¼šä»çº¿ç´¢åˆ°ç­–ç•¥

> 1. çœ‹åˆ°â€œç¬¬ k å°â€â†’ æƒ³åˆ°äºŒåˆ†ç­”æ¡ˆã€‚  
> 2. å‘ç°â€œæœ€ç®€â€â†’ ç”¨ Î¼ æ¶ˆæ‰ gcdã€‚  
> 3. è®¡æ•°å¼å‡ºç° Î£âŒŠix/yâŒ‹ â†’ ç±»æ¬§æ¨¡æ¿ã€‚  
> 4. æµ®ç‚¹äºŒåˆ†ç²¾åº¦ä¸è¶³ â†’ Sternâ€“Brocot æ ‘äºŒåˆ†ã€‚  
> 5. å¤æ‚åº¦ç“¶é¢ˆåœ¨ check â†’ ç‹„åˆ©å…‹é›·æ±‚å’Œ+æœæ•™ç­›+ç±»æ¬§ã€‚  
> **ç»“è®º**ï¼šäºŒåˆ†æ¡†æ¶ + Sternâ€“Brocot ç²¾ç¡®è·³è½¬ + æ•°å­¦çº§ä¼˜åŒ– check æ˜¯æœ€ä¼˜é›…è§£ã€‚

---

## 2. ç²¾é€‰ä¼˜è´¨é¢˜è§£å‚è€ƒ

| é¢˜è§£ | äº®ç‚¹æç‚¼ | æ´›è¯­äº‘ç¬ºç‚¹è¯„ |
|---|---|---|
| **gza** (èµ 42) | é¦–æ¬¡å…¬å¼€ Sternâ€“Brocot + ç±»æ¬§ 2log å®ç°ï¼›çŸ©é˜µå¿«é€Ÿæè¿°è·¯å¾„ | æ€è·¯æ¸…æ™°ï¼Œä»£ç è§„èŒƒï¼Œä½†ç­›åˆ° 1e7 åå¤§ï¼Œå€å¢ç»†èŠ‚å¯å†ç²¾ç®€ |
| **Smallbasic** (èµ 11) | ç”¨å€å¢åœ¨ Sternâ€“Brocot ä¸Šâ€œè·³é“¾â€ï¼Œå¤æ‚åº¦ä½äºçº¿æ€§ï¼›é™„èµ  Sternâ€“Brocot å¯è§†åŒ– | æ•™å­¦ä»·å€¼é«˜ï¼Œä»£ç æ˜“è¯»ï¼Œæ˜¯ç†è§£æ ‘çš„ç»ä½³å…¥å£ |
| **Fontainebleau** (èµ 9) | ä¸ç”¨ Sternâ€“Brocotï¼Œç”¨ O(n log n) Farey é€’æ¨ï¼›é¢„å¤„ç† g(i) ç³»æ•° | æ€è·¯ç®€æ´ï¼Œé€‚åˆ nâ‰¤1e5 åœºæ™¯ï¼Œé¿å…ç±»æ¬§ |
| **dadaaa** (èµ 6) | åŒåˆ†æ¯åˆ†æ•°äºŒåˆ†ï¼Œå¤æ‚åº¦ O(n+âˆšn logÂ² n)ï¼›å®ç°ç»†èŠ‚ä¸°å¯Œ | æ€è·¯å·§å¦™ï¼Œä½†å¸¸æ•°ç•¥å¤§ï¼Œé€‚åˆå¯¹ç²¾åº¦æ•æ„Ÿåœºæ™¯ |
| **WaterSun** (èµ 4) | æµ®ç‚¹äºŒåˆ†+å®¹æ–¥ï¼ŒO(n log n)ï¼›ä»£ç æœ€çŸ­ | æœ€æ˜“å®ç°ï¼Œä½†æµ®ç‚¹ç²¾åº¦éœ€å°å¿ƒ |

---

## 3. è§£é¢˜ç­–ç•¥æ·±åº¦å‰–æ

### ğŸ¯ æ ¸å¿ƒéš¾ç‚¹ä¸å…³é”®æ­¥éª¤ï¼ˆæœ€ä¼˜è§£ï¼šSternâ€“Brocot + ç±»æ¬§ï¼‰

| å…³é”®ç‚¹ | åˆ†æ | å­¦ä¹ ç¬”è®° |
|---|---|---|
| **1. å¦‚ä½•è®¡æ•° rank(p/q)** | rank = Î£ Î¼(d)Â·ç±»æ¬§(p,0,q,âŒŠn/dâŒ‹) | è«å + ç±»æ¬§æ¨¡æ¿ |
| **2. å¦‚ä½•åœ¨ Sternâ€“Brocot æ ‘ä¸ŠäºŒåˆ†** | æ¯æ¬¡èµ°åˆ°ä¸­ä½æ•° a+c / b+dï¼Œæ ¹æ® rank å¤§å°å†³å®šå‘å·¦/å³å­æ ‘ | æ ‘é«˜ O(log n)ï¼ŒäºŒåˆ† O(log n) å±‚ |
| **3. å¦‚ä½•å€å¢è·³é“¾** | é¢„å¤„ç† l[i]=2^i æ¬¡å·¦è·³çŸ©é˜µï¼Œr[i] åŒç†ï¼›å…ˆä¼°æœ€å¤§æ­¥å†å‘ä¸‹ | 2logâ†’1log å…³é”®ä¼˜åŒ– |
| **4. å¦‚ä½•ä¼˜åŒ– check** | ç‹„åˆ©å…‹é›·æ±‚å’Œæ›¿æ¢æ•´é™¤åˆ†å—ï¼Œæœæ•™ç­› Î¼ | å¤æ‚åº¦é™è‡³ âˆšn log^{1.5} n |

---

### âš”ï¸ ç­–ç•¥ç«æŠ€åœºï¼šä¸åŒè§£æ³•å¯¹æ¯”

| ç­–ç•¥ | æ ¸å¿ƒæ€æƒ³ | å¤æ‚åº¦ | é€‚ç”¨åœºæ™¯ |
|---|---|---|---|
| **O(nÂ²) æš´åŠ›æšä¸¾** | ç›´æ¥ç”Ÿæˆæ‰€æœ‰æœ€ç®€åˆ†æ•°æ’åº | ä¸å¯æ¥å— | æ•™å­¦æ¼”ç¤º |
| **O(n log n) Farey é€’æ¨** | åˆ©ç”¨ Farey ç›¸é‚»åˆ†æ•°é€’æ¨å¼ | n log n | nâ‰¤1e5 |
| **O(n logÂ² n) æµ®ç‚¹äºŒåˆ†+å®¹æ–¥** | äºŒåˆ†å°æ•° xï¼Œå®¹æ–¥æ±‚ rank | n logÂ² n | ä»£ç æœ€çŸ­ |
| **O(n^{2/3}+âˆšn logÂ² n) SB+ç±»æ¬§** | Sternâ€“Brocot æ ‘ä¸ŠäºŒåˆ† | ä½äºçº¿æ€§ | nâ‰¤4Ã—10â´ |
| **O(n^{2/3}+âˆšn log^{1.5} n) ç‹„åˆ©å…‹é›·** | å†ä¼˜åŒ– check | ç†è®ºæœ€ä¼˜ | nâ‰¤1e7 |

---

### âœ¨ ä¼˜åŒ–ä¹‹æ—…ï¼šä»â€œèƒ½åšâ€åˆ°â€œåšå¥½â€

> 1. æœ´ç´ æšä¸¾ï¼š2 è¡Œä»£ç ï¼ŒTLEã€‚  
> 2. å‘ç°â€œäº’è´¨â€â†’ è«åï¼Œç¬¬ä¸€æ¬¡ ACã€‚  
> 3. æµ®ç‚¹ç²¾åº¦ç¿»è½¦ â†’ Sternâ€“Brocot æ ‘ç²¾å‡†å®šä½ã€‚  
> 4. ç±»æ¬§å¸¸æ•°å¤§ â†’ ç‹„åˆ©å…‹é›·æ±‚å’Œ+æœæ•™ç­› Î¼ã€‚  
> 5. å€å¢è·³é“¾ â†’ å»æ‰ä¸€ä¸ª logã€‚  

ğŸ’¡ **ç­–ç•¥æ€»ç»“**ï¼šæ•°å­¦çº§ä¼˜åŒ–å¾€å¾€æ¥è‡ªâ€œå…¬å¼åŒ–ç®€â€è€Œéâ€œä»£ç æŠ€å·§â€ã€‚æŒæ¡è«åã€ç±»æ¬§ã€ç‹„åˆ©å…‹é›·ä¸‰æ¿æ–§ï¼Œå°±èƒ½åœ¨æ•°è®ºé¢˜é‡Œæ¨ªç€èµ°ï¼

---

## 4. C++æ ¸å¿ƒä»£ç å®ç°èµæ

### æœ¬é¢˜é€šç”¨æ ¸å¿ƒC++å®ç°ï¼ˆSternâ€“Brocot + ç±»æ¬§ï¼‰

```cpp
// ç»¼åˆ gza & Smallbasic æ€è·¯ï¼Œé¢å‘ nâ‰¤4Ã—10â´
#include <bits/stdc++.h>
using int64 = long long;
using i128  = __int128_t;

const int N = 4e4 + 5;
int n, k, mu[N], pri[N / 10], cnt;
bool vis[N];

void sieve() {
    mu[1] = 1;
    for (int i = 2; i <= n; ++i) {
        if (!vis[i]) pri[cnt++] = i, mu[i] = -1;
        for (int j = 0; j < cnt && i * pri[j] <= n; ++j) {
            vis[i * pri[j]] = 1;
            if (i % pri[j] == 0) break;
            mu[i * pri[j]] = -mu[i];
        }
    }
    for (int i = 2; i <= n; ++i) mu[i] += mu[i - 1];
}

i128 f(i128 a, i128 b, i128 c, i128 n) {          // ç±»æ¬§æ¨¡æ¿
    if (!a) return (b / c) * (n + 1);
    if (a >= c || b >= c)
        return f(a % c, b % c, c, n) + (a / c) * n * (n + 1) / 2 + (b / c) * (n + 1);
    i128 m = (a * n + b) / c;
    if (!m) return 0;
    return n * m - f(c, c - b - 1, a, m - 1);
}

int64 rank(int64 p, int64 q) {                     // æ’åæŸ¥è¯¢
    int64 ans = 0;
    for (int l = 1, r; l <= n; l = r + 1) {
        r = n / (n / l);
        ans += (mu[r] - mu[l - 1]) * f(p, 0, q, n / l);
    }
    return ans;
}

int main() {
    scanf("%d%d", &n, &k);
    sieve();

    int64 a = 0, b = 1, c = 1, d = 1;            // Sternâ€“Brocot äºŒåˆ†
    while (true) {
        int64 p = a + c, q = b + d;
        if (q > n) break;
        int64 pos = rank(p, q);
        if (pos == k) return printf("%lld %lld\n", p, q), 0;
        if (pos < k) a = p, b = q;
        else         c = p, d = q;
    }
    return 0;
}
```

---

### ä»£ç ç‰‡æ®µèµæ

| é¢˜è§£ | ç‰‡æ®µäº®ç‚¹ | å­¦ä¹ ç¬”è®° |
|---|---|---|
| **gza** | `mat` ç»“æ„ä½“ + å€å¢è·³é“¾ | ç”¨çŸ©é˜µæè¿°è·¯å¾„ï¼Œå€å¢æ€æƒ³ä¼˜é›… |
| **Smallbasic** | `calc` å‡½æ•°æ•´é™¤åˆ†å—+ç±»æ¬§ | æ¨¡æ¿åŒ–å¥½ï¼Œæ˜“è¿ç§» |
| **Fontainebleau** | é¢„å¤„ç† g(i) ç³»æ•° | æŠŠç±»æ¬§æ‹†æˆçº¿æ€§ç»„åˆï¼Œæ€è·¯æ¸…å¥‡ |
| **WaterSun** | æµ®ç‚¹äºŒåˆ† + å®¹æ–¥ | æœ€çŸ­å®ç°ï¼Œæ³¨æ„ eps ç²¾åº¦ |

---

## 5. ç®—æ³•å¯è§†åŒ–ï¼šåƒç´ åŠ¨ç”»æ¼”ç¤º

**ä¸»é¢˜**ï¼š8 ä½åƒç´ ç‰ˆâ€œSternâ€“Brocot æ ‘æ¢é™©â€

**æ ¸å¿ƒåœºæ™¯**  
- ç”»é¢ï¼š8Ã—8 åƒç´ ç½‘æ ¼ï¼Œå·¦ 0/1ï¼Œå³ 1/0ï¼Œä¸­é—´èŠ‚ç‚¹é—ªçƒ  
- éŸ³æ•ˆï¼š  
  â€¢ â€œå®â€â€”â€”æ’å…¥ä¸­ä½æ•°  
  â€¢ â€œå˜Ÿâ€â€”â€”rank æ¯”è¾ƒ  
  â€¢ â€œèƒœåˆ©éŸ³â€â€”â€”æ‰¾åˆ°ç¬¬ k é¡¹

**äº¤äº’é¢æ¿**  
- æ­¥è¿›/è‡ªåŠ¨/è°ƒé€Ÿ  
- å®æ—¶æ˜¾ç¤ºå½“å‰åˆ†æ•° a/bã€rank å€¼  
- åƒç´ ç®­å¤´æŒ‡ç¤ºå‘å·¦/å³å­æ ‘

**å…³é”®å¸§æµç¨‹**  
1. åˆå§‹åŒ–æ ¹èŠ‚ç‚¹ 1/1  
2. è®¡ç®— rank(1/1) vs k â†’ é«˜äº®æ–¹å‘  
3. å€å¢è·³é“¾ï¼šåƒç´ ç®­å¤´è¿è·³ 2^i æ ¼  
4. æ‰¾åˆ°ç›®æ ‡èŠ‚ç‚¹ï¼Œåƒç´ ç¤¼èŠ± + èƒœåˆ©éŸ³

---

## 6. æ‹“å±•ç»ƒä¹ ä¸ç›¸ä¼¼é—®é¢˜æ€è€ƒ

### é€šç”¨æŠ€å·§è¿ç§»
- **è¯¾ç¨‹å†²çªé€‰æ‹©**ï¼šæ¯é—¨è¯¾æœ‰å¤šä¸ªæ—¶æ®µï¼ˆåˆ†ç»„èƒŒåŒ…ï¼‰  
- **äº’æ–¥ä»»åŠ¡è°ƒåº¦**ï¼šä»»åŠ¡é—´å­˜åœ¨ä¾èµ–ï¼ˆæ ‘å½¢ DPï¼‰  
- **åŒæ›²çº¿ä¸‹æ•´ç‚¹è®¡æ•°**ï¼šDIVCNT1ï¼ˆç±»æ¬§+è«åï¼‰

### æ´›è°·æ¨è
1. **P2568** *GCD* â€”â€” å·©å›ºè«åæ±‚äº’è´¨å¯¹  
2. **P2261** *[CQOI2007] ä½™æ•°æ±‚å’Œ* â€”â€” ç±»æ¬§æ¨¡æ¿  
3. **P4240** *æ¯’ç˜¤ä¹‹å¡å¸¸* â€”â€” ç‹„åˆ©å…‹é›·æ±‚å’Œå®æˆ˜  
4. **P5170** *ã€æ¨¡æ¿ã€‘ç±»æ¬§å‡ é‡Œå¾—ç®—æ³•* â€”â€” ç±»æ¬§å…¨å®¶æ¡¶

---

## 7. å­¦ä¹ å¿ƒå¾—ä¸ç»éªŒåˆ†äº«

> **gza**ï¼š  
> â€œæˆ‘ä¸€å¼€å§‹ç­›åˆ° 1e7 è¢«å¡å¸¸ï¼Œåæ¥ç”¨å€å¢è·³é“¾ç æ‰ä¸€ä¸ª logï¼Œæé†’ï¼šç­› Î¼ åªéœ€åˆ° nã€‚â€  
> **æ´›è¯­äº‘ç¬ºç‚¹è¯„**ï¼šç­›ä¸Šç•Œæ˜¯å¸¸è§å‘ç‚¹ï¼Œå€å¢æ€æƒ³å€¼å¾—æ”¶è—ï¼

> **Smallbasic**ï¼š  
> â€œå€å¢è·³é“¾çš„è¯æ˜ç”¨åˆ°äº†æ–æ³¢é‚£å¥‘æ€§è´¨ï¼Œç«èµ›æ—¶æ²¡è¯å®Œä¹Ÿå¤§èƒ†å†™ï¼Œèµ›åè¡¥è¯å³å¯ã€‚â€  
> **æ´›è¯­äº‘ç¬ºç‚¹è¯„**ï¼šç«èµ›ä¸­â€œç›´è§‰æ­£ç¡®+èµ›åè¡¥è¯â€æ˜¯å¸¸ç”¨ç­–ç•¥ï¼

---

<conclusion>
Farey åºåˆ—è®©æˆ‘ä»¬è§è¯†äº†â€œæ•°å­¦ + ç®—æ³•â€çš„å®Œç¾ç»“åˆï¼š  
- è«åæŠŠ gcd å˜æ±‚å’Œ  
- ç±»æ¬§æŠŠæ±‚å’Œå˜ log  
- Sternâ€“Brocot æ ‘æŠŠäºŒåˆ†å˜æŒ‡é’ˆ  
æŒæ¡è¿™ä¸‰æ¿æ–§ï¼Œé¢å¯¹ä»»ä½•â€œç¬¬ k ä¸ªæœ€ç®€åˆ†æ•°â€éƒ½èƒ½ä¼˜é›…è§£å†³ï¼  
ç»§ç»­åŠ æ²¹ï¼Œä¸‹ä¸€é“æ•°è®ºéš¾é¢˜è§ï¼ğŸ’ª
</conclusion>

---
å¤„ç†ç”¨æ—¶ï¼š84.59ç§’
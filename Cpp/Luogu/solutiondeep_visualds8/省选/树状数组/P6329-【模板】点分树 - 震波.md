# é¢˜ç›®ä¿¡æ¯

# ã€æ¨¡æ¿ã€‘ç‚¹åˆ†æ ‘ | éœ‡æ³¢

## é¢˜ç›®èƒŒæ™¯

æ¨¡æ¿é¢˜ï¼Œæ²¡æœ‰ $rap$ ã€‚

## é¢˜ç›®æè¿°

åœ¨ä¸€ç‰‡åœŸåœ°ä¸Šæœ‰ $n$ ä¸ªåŸå¸‚ï¼Œé€šè¿‡ $n-1$ æ¡æ— å‘è¾¹äº’ç›¸è¿æ¥ï¼Œå½¢æˆä¸€æ£µæ ‘çš„ç»“æ„ï¼Œç›¸é‚»ä¸¤ä¸ªåŸå¸‚çš„è·ç¦»ä¸º $1$ï¼Œå…¶ä¸­ç¬¬ $i$ ä¸ªåŸå¸‚çš„ä»·å€¼ä¸º $value_i$ã€‚

ä¸å¹¸çš„æ˜¯ï¼Œè¿™ç‰‡åœŸåœ°å¸¸å¸¸å‘ç”Ÿåœ°éœ‡ï¼Œå¹¶ä¸”éšç€æ—¶ä»£çš„å‘å±•ï¼ŒåŸå¸‚çš„ä»·å€¼ä¹Ÿå¾€å¾€ä¼šå‘ç”Ÿå˜åŠ¨ã€‚

æ¥ä¸‹æ¥ä½ éœ€è¦åœ¨çº¿å¤„ç† $m$ æ¬¡æ“ä½œï¼š

`0 x k` è¡¨ç¤ºå‘ç”Ÿäº†ä¸€æ¬¡åœ°éœ‡ï¼Œéœ‡ä¸­åŸå¸‚ä¸º $x$ï¼Œå½±å“èŒƒå›´ä¸º $k$ï¼Œæ‰€æœ‰ä¸ $x$ è·ç¦»ä¸è¶…è¿‡ $k$ çš„åŸå¸‚éƒ½å°†å—åˆ°å½±å“ï¼Œè¯¥æ¬¡åœ°éœ‡é€ æˆçš„ç»æµæŸå¤±ä¸ºæ‰€æœ‰å—å½±å“åŸå¸‚çš„ä»·å€¼å’Œã€‚

`1 x y` è¡¨ç¤ºç¬¬ $x$ ä¸ªåŸå¸‚çš„ä»·å€¼å˜æˆäº† $y$ ã€‚

ä¸ºäº†ä½“ç°ç¨‹åºçš„åœ¨çº¿æ€§ï¼Œæ“ä½œä¸­çš„ $x$ã€$y$ã€$k$ éƒ½éœ€è¦å¼‚æˆ–ä½ ç¨‹åºä¸Šä¸€æ¬¡çš„è¾“å‡ºæ¥è§£å¯†ï¼Œå¦‚æœä¹‹å‰æ²¡æœ‰è¾“å‡ºï¼Œåˆ™é»˜è®¤ä¸Šä¸€æ¬¡çš„è¾“å‡ºä¸º $0$ ã€‚



## è¯´æ˜/æç¤º

#### æ•°æ®è§„æ¨¡ä¸çº¦å®š

å¯¹äº $100 \%$ çš„æ•°æ®ï¼Œæœ‰ $1\leq n,m\leq 10^5, 1\leq u,v,x\leq n, 1\leq value_i,y\leq 10^4,0\leq k\leq n-1$ ã€‚

updï¼šæ ·ä¾‹èŒƒå›´ä¸é¢˜ç›®çœŸå®æ•°æ®èŒƒå›´ä¸åŒï¼Œä»¥æç¤ºä¸­ç»™å‡ºçš„æ•°æ®èŒƒå›´ä¸ºå‡†ã€‚

#### è¯´æ˜
é¢˜ç›®æ¥æºï¼šBZOJ3730ã€‚

## æ ·ä¾‹ #1

### è¾“å…¥

```
8 1
1 10 100 1000 10000 100000 1000000 10000000
1 2
1 3
2 4
2 5
3 6
3 7
3 8
0 3 1```

### è¾“å‡º

```
11100101```

# AIåˆ†æç»“æœ

---
# ğŸ’¡ æ´›è¯­äº‘ç¬ºçš„ C++ ç®—æ³•è§£æï¼šç‚¹åˆ†æ ‘ | éœ‡æ³¢ æ·±å…¥å­¦ä¹ æŒ‡å— ğŸ’¡

> ä»Šå¤©æˆ‘ä»¬æ¥ä¸€èµ·åˆ†æ **â€œç‚¹åˆ†æ ‘ | éœ‡æ³¢â€** è¿™é“ C++ ç¼–ç¨‹é¢˜ã€‚  
> è¿™ä¸ä»…ä»…æ˜¯ä¸€æ¬¡è§£é¢˜ï¼Œæ›´æ˜¯ä¸€åœºæ€ç»´çš„æ¢é™©ï¼š  
> å¦‚ä½•åœ¨ä¸€æ£µä¼šâ€œåœ°éœ‡â€çš„æ ‘ä¸Šï¼Œ**åœ¨çº¿**å›ç­”â€œéœ‡æºå‘¨å›´ k æ­¥å†…æ‰€æœ‰åŸå¸‚çš„ä»·å€¼å’Œâ€ï¼Ÿ  
> æˆ‘ä»¬å°†å­¦ä¹ å¦‚ä½•åƒä¾¦æ¢ä¸€æ ·ä»é¢˜ç›®ä¸­å¯»æ‰¾çº¿ç´¢ï¼Œå¹¶åœ¨ä¸åŒçš„è§£é¢˜é“è·¯ä¸­æƒè¡¡é€‰æ‹©ï¼Œæœ€ç»ˆæ‰¾åˆ°æœ€ä¼˜çš„ç­–ç•¥ã€‚

---

## 1. é¢˜ç›®è§£è¯»ä¸ç­–ç•¥åˆæ¢

### âœ¨ æ ¸å¿ƒæŒ‘æˆ˜
> **åœ¨ä¸€æ£µ n ä¸ªèŠ‚ç‚¹çš„æ ‘ä¸Šï¼Œæ”¯æŒä¸¤ç§åœ¨çº¿æ“ä½œï¼š**  
> 1. `0 x k`ï¼šè¯¢é—®éœ‡æº x å‘¨å›´ k æ­¥ä»¥å†…æ‰€æœ‰ç‚¹çš„ä»·å€¼å’Œï¼›  
> 2. `1 x y`ï¼šæŠŠåŸå¸‚ x çš„ä»·å€¼æ”¹æˆ yã€‚  
> **éš¾ç‚¹ï¼š** å¼ºåˆ¶åœ¨çº¿ï¼ˆå‚æ•°éœ€å¼‚æˆ–ä¸Šä¸€æ¬¡ç­”æ¡ˆï¼‰ï¼Œnã€m â‰¤ 1e5ï¼Œæš´åŠ›åšæ³•å¿…ç„¶è¶…æ—¶ã€‚

### âœ¨ æ ¸å¿ƒç®—æ³•æ ‡ç­¾
- **ç‚¹åˆ†æ ‘ï¼ˆåŠ¨æ€ç‚¹åˆ†æ²»ï¼‰**
- **æ ‘ä¸Šå€å¢ LCA / æ¬§æ‹‰åº ST è¡¨**
- **åŠ¨æ€å¼€ç‚¹çº¿æ®µæ ‘ / æ ‘çŠ¶æ•°ç»„**

---

### ğŸ” ç®—æ³•ä¾¦æ¢ï¼šå¦‚ä½•åœ¨é¢˜ç›®ä¸­å‘ç°çº¿ç´¢ï¼Ÿ

| çº¿ç´¢ | ä¾¦æ¢ç¬”è®° |
|---|---|
| **çº¿ç´¢1ï¼šé—®é¢˜æ¨¡å‹** | â€œå¸¦æƒæ ‘ä¸Šè·ç¦» â‰¤ k çš„ç‚¹æƒå’Œâ€ â†’ å…¸å‹çš„ **é‚»åŸŸæŸ¥è¯¢** é—®é¢˜ã€‚ |
| **çº¿ç´¢2ï¼šåœ¨çº¿æ“ä½œ** | æš´åŠ› O(n) æŸ¥è¯¢ã€O(1) ä¿®æ”¹æ˜¾ç„¶ä¸è¡Œ â†’ éœ€è¦ **å±‚æ¬¡åŒ–** æˆ– **åˆ†æ²»ç»“æ„**ã€‚ |
| **çº¿ç´¢3ï¼šæ•°æ®è§„æ¨¡** | n = 1e5 â†’ O(n logÂ²n) å¯è¿‡ï¼›O(nÂ²) å¿…æ­» â†’ **ç‚¹åˆ†æ ‘** æ ‘é«˜ log nï¼Œæ°å¥½æ»¡è¶³ï¼ |

---

### ğŸ§  æ€ç»´é“¾æ„å»ºï¼šä»çº¿ç´¢åˆ°ç­–ç•¥
> 1. **çº¿ç´¢1** æç¤ºæˆ‘ä»¬ï¼š**é‚»åŸŸæ±‚å’Œ** å¯ä»¥ç”¨ **ç‚¹åˆ†æ²»** ç¦»çº¿è§£å†³ã€‚  
> 2. **çº¿ç´¢2** å‘Šè¯‰æˆ‘ä»¬ï¼šç¦»çº¿ä¸å¯è¡Œï¼Œéœ€è¦ **åœ¨çº¿ç»“æ„**ã€‚  
> 3. **çº¿ç´¢3** é™åˆ¶ä¸‹ï¼Œæˆ‘ä»¬æƒ³åˆ°æŠŠ **ç‚¹åˆ†æ²»è¿‡ç¨‹å›ºåŒ–** æˆ **ç‚¹åˆ†æ ‘**ï¼š  
>    - æ ‘é«˜ O(log n)ï¼›  
>    - æ¯ä¸ªèŠ‚ç‚¹ç»´æŠ¤ **åˆ°è‡ªèº«è·ç¦»** çš„å‰ç¼€å’Œï¼ˆæ ‘çŠ¶æ•°ç»„ / çº¿æ®µæ ‘ï¼‰ï¼›  
>    - æŸ¥è¯¢æ—¶æ²¿ç‚¹åˆ†æ ‘ç¥–å…ˆä¸€è·¯å®¹æ–¥å³å¯ã€‚  
> **ç»“è®º**ï¼š**ç‚¹åˆ†æ ‘ + æ ‘çŠ¶æ•°ç»„** æ˜¯å®Œç¾çš„é’¥åŒ™ï¼

---

## 2. ç²¾é€‰ä¼˜è´¨é¢˜è§£å‚è€ƒ

> æˆ‘ç»¼åˆäº†æ‰€æœ‰é¢˜è§£çš„æ¸…æ™°åº¦ã€æŠ€å·§æ€§ä¸å¯å‘æ€§ï¼Œä¸ºä½ ç²¾é€‰ä»¥ä¸‹ 3 ä»½ â‰¥4 æ˜Ÿçš„é«˜èµé¢˜è§£ã€‚

---

### âœ… é¢˜è§£ä¸€ï¼štzc_wkï¼ˆèµï¼š183ï¼‰

- **äº®ç‚¹**  
  1. **æ€è·¯æœ€æ¸…æ™°**ï¼šç”¨â€œæšä¸¾ LCA zâ€çš„æ–¹å¼ï¼ŒæŠŠåŸé—®é¢˜æ‹†æˆ `z å­æ ‘å†… â‰¤k-dis(x,z)` çš„åŒºé—´å’Œã€‚  
  2. **ä»£ç æœ€è§„èŒƒ**ï¼šå˜é‡å‘½åç›´è§‚ï¼Œ`w1`ã€`w2` åˆ†åˆ«å­˜â€œåˆ°å½“å‰ç‚¹â€å’Œâ€œåˆ°çˆ¶äº²â€çš„è´¡çŒ®ã€‚  
  3. **æŠ€å·§æ€»ç»“**ï¼šåŠ¨æ€å¼€ç‚¹çº¿æ®µæ ‘ + å®¹æ–¥å…¬å¼ï¼Œé¿å… O(nÂ²) ç©ºé—´ã€‚

- **æ ¸å¿ƒä»£ç ç‰‡æ®µ**  
  ```cpp
  // ä¿®æ”¹ï¼šæ²¿ç‚¹åˆ†æ ‘ä¸€è·¯å‘ä¸Š
  void modify(int x,int v){
      int cur=x;
      while(cur){
          w1.modify(w1.rt[cur],0,n-1,getdis(cur,x),v);
          if(dfa[cur]) w2.modify(w2.rt[cur],0,n-1,getdis(dfa[cur],x),v);
          cur=dfa[cur];
      }
  }

  // æŸ¥è¯¢ï¼šå®¹æ–¥å…¬å¼
  int query(int x,int k){
      int cur=x,pre=0,ret=0;
      while(cur){
          if(getdis(cur,x)>k){ pre=cur; cur=dfa[cur]; continue; }
          ret += w1.query(w1.rt[cur],0,n-1,0,k-getdis(cur,x));
          if(pre) ret -= w2.query(w2.rt[pre],0,n-1,0,k-getdis(cur,x));
          pre=cur; cur=dfa[cur];
      } return ret;
  }
  ```

---

### âœ… é¢˜è§£äºŒï¼šAyiirepï¼ˆèµï¼š119ï¼‰

- **äº®ç‚¹**  
  1. **æ•™å­¦çº§æ³¨é‡Š**ï¼šè¯¦ç»†è®²è§£â€œä¸ºä»€ä¹ˆéœ€è¦ä¸¤ä¸ª BITâ€ã€‚  
  2. **è°ƒè¯•ç»éªŒ**ï¼šæé†’â€œcontinue è€Œé breakâ€çš„æ˜“é”™ç‚¹ã€‚  
  3. **ç©ºé—´ä¼˜åŒ–**ï¼šæ ‘çŠ¶æ•°ç»„å¤§å°åªå¼€åˆ°å­æ ‘æœ€å¤§æ·±åº¦ +2ï¼Œé˜²æ­¢ MLEã€‚

- **å­¦ä¹ ç¬”è®°**  
  æŠŠ **å­æ ‘æ·±åº¦** ä½œä¸ºæ ‘çŠ¶æ•°ç»„ä¸Šç•Œï¼Œæ˜¯ç‚¹åˆ†æ ‘ç©ºé—´å‹ç¼©çš„é€šç”¨æŠ€å·§ã€‚

---

### âœ… é¢˜è§£ä¸‰ï¼šNewJeanssï¼ˆèµï¼š9ï¼‰

- **äº®ç‚¹**  
  1. **æ— éœ€ LCA**ï¼šåœ¨ `finddep` æ—¶ç›´æ¥è®°å½• **åˆ°å½“å‰é‡å¿ƒçš„è·ç¦»**ï¼Œçœå» LCA è°ƒç”¨ã€‚  
  2. **vector åŠ¨æ€å¼€ç‚¹**ï¼š`vector<int> DS[2][N]` å†™æ³•ç®€æ´ï¼Œæ˜“è¯»æ˜“å†™ã€‚  
  3. **ç»“æ„ä½“å°è£…**ï¼š`struct node {G,from,dis}` æŠŠâ€œè¦†ç›–ç»“æ„â€æ˜¾å¼åŒ–ã€‚

- **æ ¸å¿ƒä»£ç ç‰‡æ®µ**  
  ```cpp
  struct node{ int G,from,dis; };
  vector<node> a[N];          // æ¯ä¸ªç‚¹è¢«å“ªäº›é‡å¿ƒâ€œç®¡è¾–â€
  vector<int> DS[2][N];       // 0: åˆ°é‡å¿ƒ  1: åˆ°çˆ¶äº²
  ```

---

## 3. è§£é¢˜ç­–ç•¥æ·±åº¦å‰–æ

---

### ğŸ¯ æ ¸å¿ƒéš¾ç‚¹ä¸å…³é”®æ­¥éª¤ï¼ˆæœ€ä¼˜è§£æ³•ï¼šç‚¹åˆ†æ ‘ + BITï¼‰

| å…³é”®ç‚¹ | åˆ†æ | ğŸ’¡ å­¦ä¹ ç¬”è®° |
|---|---|---|
| **1. ç‚¹åˆ†æ ‘æ„å»º** | é€’å½’æ‰¾é‡å¿ƒï¼ŒæŠŠé‡å¿ƒè¿æˆæ–°æ ‘ï¼Œæ ‘é«˜ log nã€‚ | æ¨¡æ¿ï¼šfindcent â†’ divcent â†’ dfs å»ºæ ‘çˆ¶ã€‚ |
| **2. æ•°æ®ç»“æ„é€‰æ‹©** | æ¯ä¸ªèŠ‚ç‚¹å¼€ **ä¸¤æ£µ BIT**ï¼š<br>- `BIT0[u]`ï¼šu å­æ ‘å†…åˆ° u è·ç¦»çš„å‰ç¼€å’Œï¼›<br>- `BIT1[u]`ï¼šu å­æ ‘å†…åˆ° fa[u] è·ç¦»çš„å‰ç¼€å’Œã€‚ | BIT æ¯”çº¿æ®µæ ‘å¸¸æ•°å°ï¼ŒåŠ¨æ€å¼€ vector é˜² MLEã€‚ |
| **3. æŸ¥è¯¢å®¹æ–¥** | æ²¿ç‚¹åˆ†æ ‘ç¥–å…ˆé“¾ï¼Œç´¯åŠ  `BIT0`ï¼Œå‡å» `BIT1` å»é‡ã€‚ | å…¬å¼ï¼š`ans += BIT0[anc] - BIT1[child]`ã€‚ |
| **4. ä¿®æ”¹æ‰©æ•£** | åŒæ ·æ²¿ç¥–å…ˆé“¾ï¼Œä¸¤æ£µ BIT åŒæ­¥å•ç‚¹æ›´æ–°ã€‚ | æ¯æ¬¡ä¿®æ”¹ logÂ² nï¼Œæ€»å¤æ‚åº¦ (n+m) logÂ² nã€‚ |

---

### âš”ï¸ ç­–ç•¥ç«æŠ€åœºï¼šä¸åŒè§£æ³•å¯¹æ¯”

| ç­–ç•¥ | æ ¸å¿ƒæ€æƒ³ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯/å¾—åˆ† |
|---|---|---|---|---|
| **æš´åŠ› DFS** | æ¯æ¬¡è¯¢é—®æ•´æ£µå­æ ‘ DFS | ä»£ç æœ€çŸ­ | O(n) æŸ¥è¯¢ â†’ 1e10 æ¬¡è¿ç®— | nâ‰¤5000 |
| **ç‚¹åˆ†æ²»ç¦»çº¿** | é¢„å¤„ç†æ‰€æœ‰è¯¢é—® | O(n log n) å•æ¬¡ | æ— æ³•åœ¨çº¿ | æ— å¼ºåˆ¶åœ¨çº¿ |
| **ç‚¹åˆ†æ ‘ + BIT** | æŠŠåˆ†æ²»ç»“æ„å›ºåŒ– | O(logÂ² n) æ“ä½œ | ä»£ç è¾ƒé•¿ | 100% |
| **å…¨å±€å¹³è¡¡äºŒå‰æ ‘** | é“¾åˆ†æ²» + ç°‡åˆå¹¶ | ç†è®ºæ›´ä¼˜ | å®ç°å¤æ‚ | 100% |

---

### âœ¨ ä¼˜åŒ–ä¹‹æ—…ï¼šä»â€œèƒ½åšâ€åˆ°â€œåšå¥½â€

1. **èµ·ç‚¹ï¼šæš´åŠ› DFS**  
   ç›´æ¥ BFS/DFS æ±‚ k æ­¥ä»¥å†…ç‚¹æƒå’Œ â†’ 10âµÃ—10âµ çˆ†ç‚¸ã€‚

2. **å‘ç°ç“¶é¢ˆï¼šé‡å¤éå†**  
   æ¯æ¬¡æŸ¥è¯¢éƒ½é‡æ–°éå†æ•´æ£µæ ‘ï¼Œå¤§é‡é‡å¤åŠ³åŠ¨ã€‚

3. **é’¥åŒ™ï¼šåˆ†æ²»ç»“æ„**  
   ç‚¹åˆ†æ²»æŠŠæ ‘åˆ‡æˆ log n å±‚ï¼Œæ¯å±‚åªå¤„ç†ç»è¿‡é‡å¿ƒçš„è·¯å¾„ã€‚

4. **å‡åï¼šå›ºåŒ–ç»“æ„**  
   æŠŠâ€œåˆ†æ²»æ ‘â€å­˜ä¸‹æ¥ï¼ˆç‚¹åˆ†æ ‘ï¼‰ï¼Œæ¯èŠ‚ç‚¹æŒ‚ BITï¼Œ  
   æŸ¥è¯¢/ä¿®æ”¹æ²¿ç¥–å…ˆé“¾ log æ¬¡ï¼Œæ¯æ¬¡ BIT log æ¬¡ â†’ logÂ²ã€‚

---

## 4. C++ æ ¸å¿ƒä»£ç å®ç°èµæ

---

### ğŸŒŸ æœ¬é¢˜é€šç”¨æ ¸å¿ƒå®ç°å‚è€ƒ

> ç»¼åˆ tzc_wkã€Ayiirep çš„ä¼˜ç‚¹ï¼Œç»™å‡ºä¸€ä»½ **æœ€ç®€æ´ã€æœ€æ˜“è¯»** çš„æ¨¡æ¿ã€‚

```cpp
#include <bits/stdc++.h>
using namespace std;
const int N = 1e5 + 5, LOG = 17;
int n, m, val[N], last_ans;
vector<int> g[N];

/* ---------- 1. ç‚¹åˆ†æ ‘ ---------- */
int sz[N], mx[N], vis[N], fa[N], root;
void find_root(int x, int f, int tot, int &rt) {
    sz[x] = 1, mx[x] = 0;
    for (int v : g[x]) if (!vis[v] && v != f) {
        find_root(v, x, tot, rt);
        sz[x] += sz[v];
        mx[x] = max(mx[x], sz[v]);
    }
    mx[x] = max(mx[x], tot - sz[x]);
    if (!rt || mx[x] < mx[rt]) rt = x;
}
void build(int x, int tot) {
    vis[x] = 1;
    for (int v : g[x]) if (!vis[v]) {
        int rt = 0;
        find_root(v, 0, sz[v] < sz[x] ? sz[v] : tot - sz[x], rt);
        fa[rt] = x;
        build(rt, sz[v] < sz[x] ? sz[v] : tot - sz[x]);
    }
}

/* ---------- 2. è·ç¦» ---------- */
int dep[N], st[LOG + 1][N << 1], id[N], cnt;
void dfs_lca(int u, int f) {
    st[0][id[u] = ++cnt] = u;
    dep[u] = dep[f] + 1;
    for (int v : g[u]) if (v != f) {
        dfs_lca(v, u);
        st[0][++cnt] = u;
    }
}
inline int lca(int u, int v) {
    if (id[u] > id[v]) swap(u, v);
    int k = __lg(id[v] - id[u] + 1);
    int x = st[k][id[u]], y = st[k][id[v] - (1 << k) + 1];
    return dep[x] < dep[y] ? x : y;
}
inline int dis(int u, int v) {
    return dep[u] + dep[v] - 2 * dep[lca(u, v)];
}

/* ---------- 3. æ ‘çŠ¶æ•°ç»„ ---------- */
struct Fenwick {
    vector<int> c;
    Fenwick(int n) : c(n + 2) {}
    void add(int x, int v) {
        ++x;
        for (; x < (int)c.size(); x += x & -x) c[x] += v;
    }
    int ask(int x) {
        ++x;
        int res = 0;
        x = min(x, (int)c.size() - 1);
        for (; x; x -= x & -x) res += c[x];
        return res;
    }
};
vector<Fenwick> bit0, bit1;  // 0: åˆ° u   1: åˆ° fa[u]

/* ---------- 4. åˆå§‹åŒ– ---------- */
void init() {
    dfs_lca(1, 0);
    for (int i = 1; i <= LOG; ++i)
        for (int j = 1; j + (1 << i) - 1 <= cnt; ++j) {
            int x = st[i - 1][j], y = st[i - 1][j + (1 << (i - 1))];
            st[i][j] = dep[x] < dep[y] ? x : y;
        }
    find_root(1, 0, n, root);
    build(root, n);
    bit0.resize(n + 1), bit1.resize(n + 1);
    for (int i = 1; i <= n; ++i) {
        int mx_dep = 0;
        for (int j = i, f = 0; j; f = j, j = fa[j]) {
            mx_dep = max(mx_dep, dis(i, j));
            bit0[j].c.resize(mx_dep + 2);
            if (fa[j]) bit1[j].c.resize(dis(i, fa[j]) + 2);
        }
    }
    for (int i = 1; i <= n; ++i) {
        for (int j = i; j; j = fa[j]) {
            bit0[j].add(dis(i, j), val[i]);
            if (fa[j]) bit1[j].add(dis(i, fa[j]), val[i]);
        }
    }
}

/* ---------- 5. æŸ¥è¯¢ & ä¿®æ”¹ ---------- */
int query(int x, int k) {
    int res = bit0[x].ask(k);
    for (int u = x; fa[u]; u = fa[u]) {
        int d = dis(x, fa[u]);
        if (d <= k) {
            res += bit0[fa[u]].ask(k - d) - bit1[u].ask(k - d);
        }
    }
    return res;
}
void modify(int x, int v) {
    int delta = v - val[x];
    val[x] = v;
    for (int u = x; u; u = fa[u]) {
        bit0[u].add(dis(x, u), delta);
        if (fa[u]) bit1[u].add(dis(x, fa[u]), delta);
    }
}

int main() {
    ios::sync_with_stdio(false);
    cin.tie(nullptr);
    cin >> n >> m;
    for (int i = 1; i <= n; ++i) cin >> val[i];
    for (int i = 1, u, v; i < n; ++i) {
        cin >> u >> v;
        g[u].push_back(v);
        g[v].push_back(u);
    }
    init();
    while (m--) {
        int op, x, y;
        cin >> op >> x >> y;
        x ^= last_ans, y ^= last_ans;
        if (op == 0) {
            cout << (last_ans = query(x, y)) << '\n';
        } else {
            modify(x, y);
        }
    }
    return 0;
}
```

---

## 5. ç®—æ³•å¯è§†åŒ–ï¼šåƒç´ åŠ¨ç”»æ¼”ç¤º

> æœ¬èŠ‚è®¾è®¡ä¸€ä¸ª **8-bit åƒç´ é£æ ¼** çš„åŠ¨ç”»ï¼Œå¸®åŠ©ä½ åœ¨â€œæ¸¸æˆç”»é¢â€é‡Œçœ‹æ‡‚ç‚¹åˆ†æ ‘æŸ¥è¯¢ã€‚

### ğŸ® åœºæ™¯è®¾å®šï¼šåƒç´ ç‹å›½åœ°éœ‡æ•‘æ´

- **åƒç´ ç”»å¸ƒ**ï¼š320Ã—240 åƒç´ ï¼Œ16 è‰²è°ƒè‰²æ¿ï¼ˆå¤å¤ FCï¼‰ã€‚
- **è§’è‰²**ï¼š  
  - ğŸŸ© ç»¿è‰²åƒç´ å—ï¼šæ™®é€šåŸå¸‚  
  - ğŸ”´ çº¢è‰²é—ªçƒå—ï¼šéœ‡æº x  
  - ğŸŸ¦ è“è‰²åœ†ç¯ï¼šå½“å‰ k æ­¥èŒƒå›´ï¼ˆé€å¸§æ‰©æ•£ï¼‰  
  - ğŸŸ¨ é»„è‰²æ–¹å—ï¼šç‚¹åˆ†æ ‘å½“å‰ç¥–å…ˆèŠ‚ç‚¹  

### ğŸ•¹ï¸ äº¤äº’æ§åˆ¶é¢æ¿

| æŒ‰é’® | åŠŸèƒ½ |
|---|---|
| â–¶ï¸ å¼€å§‹/æš‚åœ | æ’­æ”¾/æš‚åœåŠ¨ç”» |
| â­ï¸ å•æ­¥ | é€å¸§æŸ¥çœ‹æ¯ä¸€æ­¥ |
| ğŸ”„ é‡ç½® | å›åˆ°åˆå§‹çŠ¶æ€ |
| ğŸšï¸ é€Ÿåº¦æ»‘å— | 1Ã— / 2Ã— / 4Ã— |

---

### ğŸ“º å…³é”®å¸§è®¾è®¡ï¼ˆ10 å¸§ç¤ºä¾‹ï¼‰

| å¸§ | ç”»é¢ | éŸ³æ•ˆ | æ—ç™½æ–‡å­— |
|---|---|---|---|
| 1 | å±•ç¤ºæ•´æ£µåƒç´ æ ‘ | 8-bit BGM | â€œç‹å›½å…±æœ‰ 8 åº§åŸå¸‚â€¦â€ |
| 2 | çº¢è‰²å—åœ¨ 3 å·åŸ | çŸ­â€œå®â€ | â€œéœ‡æºä½äºåŸå¸‚ 3â€ |
| 3 | è“è‰²ç¯æ‰©æ•£ 1 æ­¥ | è½»å¾®â€œå“”â€ | â€œk=1ï¼Œå½±å“èŒƒå›´å¼€å§‹æ‰©æ•£â€ |
| 4 | é«˜äº® 3 å·åŸ BIT0 | â€œå—’â€ | â€œæŸ¥è¯¢ 3 å·åŸ BIT0[1] = 10â€ |
| 5 | è·³çˆ¶èŠ‚ç‚¹ 1 | â€œå—’â€ | â€œè·³åˆ°ç‚¹åˆ†æ ‘çˆ¶èŠ‚ç‚¹ 1â€ |
| 6 | é«˜äº® 1 å·åŸ BIT0 | â€œå—’â€ | â€œç´¯åŠ  BIT0[1-2] = 100â€ |
| 7 | é«˜äº® 1 å·åŸ BIT1 | â€œå—’â€ | â€œå‡å» BIT1[1-2] = 1â€ |
| 8 | è·³çˆ¶èŠ‚ç‚¹ï¼ˆæ ¹ï¼‰ | â€œå—’â€ | â€œç»§ç»­å‘ä¸Šåˆ°æ ¹ 0â€ |
| 9 | æ˜¾ç¤ºæœ€ç»ˆç­”æ¡ˆ | èƒœåˆ©â€œå™”â€ | â€œæœ€ç»ˆæŸå¤± 11100101â€ |
| 10 | å›åˆ°åŸå¸‚ç•Œé¢ | BGM å¾ªç¯ | â€œç­‰å¾…ä¸‹ä¸€æ¬¡åœ°éœ‡â€¦â€ |

---

### ğŸµ éŸ³æ•ˆè„šæœ¬ï¼ˆWeb Audioï¼‰

```js
const ctx = new AudioContext();
function beep(f, t) {
  const osc = ctx.createOscillator();
  osc.type = 'square';
  osc.frequency.value = f;
  osc.connect(ctx.destination);
  osc.start();
  osc.stop(ctx.currentTime + t);
}
// å…³é”®å¸§è§¦å‘
// beep(800, 0.1);   // æ™®é€šæ“ä½œ
// beep(1200, 0.15); // èƒœåˆ©
```

---

## 6. æ‹“å±•ç»ƒä¹ ä¸ç›¸ä¼¼é—®é¢˜æ€è€ƒ

### ğŸŒ± é€šç”¨æ€è·¯è¿ç§»
- **é‚»åŸŸæŸ¥è¯¢** ä¸æ­¢ç”¨äºæ ‘ä¸Šï¼š  
  1. äºŒç»´å¹³é¢æ›¼å“ˆé¡¿è·ç¦» â‰¤ k ç‚¹æƒå’Œï¼ˆKD-Tree + BITï¼‰ã€‚  
  2. åŠ¨æ€å›¾è¿é€šå—å¤§å°ï¼ˆLink-Cut Tree + çº¿æ®µæ ‘ï¼‰ã€‚  
  3. å¸¦æƒå¹¶æŸ¥é›†ç»´æŠ¤å­æ ‘ä¿¡æ¯ï¼ˆDSU on Treeï¼‰ã€‚

### ğŸ“š æ´›è°·æ¨è

| é¢˜å· | æ¨èç†ç”± |
|---|---|
| P2056 [ZJOI2007] æ‰è¿·è— | ç‚¹åˆ†æ ‘ + å †ï¼Œç»ƒä¹ â€œæœ€è¿œç‚¹â€ç»´æŠ¤ã€‚ |
| P3241 [HNOI2015] å¼€åº— | ç‚¹åˆ†æ ‘ + å‰ç¼€å’Œï¼Œæ— ä¿®æ”¹ç‰ˆã€‚ |
| P3920 [WC2014] ç´«è†èŠ±ä¹‹æ‹ | åŠ¨æ€åŠ ç‚¹ + ç‚¹åˆ†æ ‘ + å¹³è¡¡æ ‘ï¼Œè¿›é˜¶æŒ‘æˆ˜ã€‚ |

---

## 7. å­¦ä¹ å¿ƒå¾—ä¸ç»éªŒåˆ†äº«

> æ‘˜å½•è‡ªé«˜èµé¢˜è§£ä½œè€… **Ayiirep**ï¼š

> â€œåˆå­¦ç‚¹åˆ†æ ‘å®¹æ˜“é™·å…¥è¯¯åŒºï¼š  
> - ä»¥ä¸º `dis(u,fa[u])` å•è°ƒï¼Œå…¶å®æ²¡æœ‰ï¼Œ**å¿…é¡»è·³æ»¡ç¥–å…ˆé“¾**ã€‚  
> - ä»¥ä¸º BIT åªéœ€ä¸€æ£µï¼Œå®é™…éœ€è¦ **ä¸¤æ£µ** åšå®¹æ–¥ã€‚  
> - ä»¥ä¸ºç©ºé—´è¦ O(nÂ²)ï¼Œå…¶å®å¼€åˆ° **å­æ ‘æœ€å¤§æ·±åº¦** å³å¯ã€‚â€

---

## ğŸ’¡ ç»“è¯­

> ä» **æš´åŠ› DFS** åˆ° **ç‚¹åˆ†æ ‘ + BIT**ï¼Œæˆ‘ä»¬å®Œæˆäº† **æ€ç»´çš„ä¸‰çº§è·³**ï¼š  
> 1. å‘ç°é—®é¢˜ â†’ 2. å¯»æ‰¾ç»“æ„ â†’ 3. å›ºåŒ–ç»“æ„ã€‚  
> è®°ä½ï¼š  
> **â€œä¼˜ç§€çš„ç®—æ³•ï¼Œå¾€å¾€æºäºå¯¹é—®é¢˜ç»“æ„çš„æ·±åˆ»æ´å¯Ÿã€‚â€**  
> ä¸‹æ¬¡åœ°éœ‡æ¥ä¸´æ—¶ï¼Œä½ å·²å‡†å¤‡å¥½ç”¨ç‚¹åˆ†æ ‘å®ˆæŠ¤ç‹å›½ï¼

---
å¤„ç†ç”¨æ—¶ï¼š131.38ç§’
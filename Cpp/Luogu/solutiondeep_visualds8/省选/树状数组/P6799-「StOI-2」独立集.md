# é¢˜ç›®ä¿¡æ¯

# ã€ŒStOI-2ã€ç‹¬ç«‹é›†

## é¢˜ç›®æè¿°

ä¸€æ£µç”± $n$ ä¸ªç‚¹ç»„æˆçš„æ— æ ¹æ ‘ï¼Œç»™å®š $m$ æ¡æ ‘ä¸Šçš„è·¯å¾„ï¼Œè¯·æ±‚å‡ºç”±è¿™ $m$ æ¡è·¯å¾„ç»„æˆçš„`ç‹¬ç«‹é›†`æ–¹æ¡ˆæ€»æ•°ã€‚

ç”±äºè¿™ä¸ªç­”æ¡ˆå¯èƒ½å¾ˆå¤§ï¼Œæ‚¨åªéœ€æ±‚å‡ºå®ƒå¯¹ $998,244,353$ å–æ¨¡çš„ç»“æœå³å¯ã€‚

æ‰€è°“`ç‹¬ç«‹é›†`ï¼Œå°±æ˜¯ä¸€ä¸ªè·¯å¾„é›†åˆï¼Œæ»¡è¶³è¿™ä¸ªé›†åˆä¸­**ä¸å­˜åœ¨**ä¸€å¯¹åœ¨æ ‘ä¸Šæœ‰äº¤ç‚¹çš„è·¯å¾„ã€‚ç‰¹æ®Šçš„ï¼Œç©ºé›†å’ŒåªåŒ…æ‹¬ä¸€æ¡è·¯å¾„çš„é›†åˆä¹Ÿæ˜¯ç‹¬ç«‹é›†ã€‚



## è¯´æ˜/æç¤º

**è¯·æ³¨æ„å¸¸æ•°å› å­å¯¹ç¨‹åºæ‰§è¡Œæ•ˆç‡çš„å½±å“**

## æ ·ä¾‹è§£é‡Š


æ€»å…±æœ‰ $2^3=8$ ä¸ªé›†åˆã€‚

æœ‰ä¸¤ä¸ªé›†åˆ { {2,3} ï¼Œ{2,4} } ä¸ { {1,5} ï¼Œ{2,3} ï¼Œ{2,4} } ä¸ç¬¦åˆè¦æ±‚ã€‚

æ•…æ ·ä¾‹ç­”æ¡ˆä¸º $8-2=6$ ã€‚

## æ•°æ®èŒƒå›´

å¯¹äº $10\%$ çš„æ•°æ®ï¼š$1 \leq n \leq 10$ ï¼Œ$1 \leq m \leq 10$ã€‚   
å¯¹äº $20\%$ çš„æ•°æ®ï¼š$1 \leq n \leq 100$ ï¼Œ$1 \leq m \leq 100$ ã€‚   
å¯¹äºå¦ $30\%$ çš„æ•°æ®ï¼š$1 \leq m \leq 15$ ã€‚   
å¯¹äºå¦ $10\%$ çš„æ•°æ®ï¼š$1 \leq n,m \leq 10^{5}$ã€‚    
å¯¹äºå¦ $20\%$ çš„æ•°æ®ï¼š$u_{i}=i,v_{i}=i+1$ã€‚   
å¯¹äº $100\%$ çš„æ•°æ®ï¼š$1\leq n,m \leq 5 \times 10^{5}$ ã€‚

## æ ·ä¾‹ #1

### è¾“å…¥

```
5 3
1 2
2 3
2 4
1 5
1 5
2 3
2 4```

### è¾“å‡º

```
6```

# AIåˆ†æç»“æœ

```markdown
# ğŸ’¡ æ´›è¯­äº‘ç¬ºçš„C++ç®—æ³•è§£æï¼šã€ŒStOI-2ã€ç‹¬ç«‹é›† æ·±å…¥å­¦ä¹ æŒ‡å— ğŸ’¡

> å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯ä½ ä»¬çš„ç®—æ³•ä¼™ä¼´â€œæ´›è¯­äº‘ç¬ºâ€ã€‚ä»Šå¤©æˆ‘ä»¬å°†ä¸€èµ·æŒ‘æˆ˜ã€ŒStOI-2ã€ç‹¬ç«‹é›†è¿™é“æœ‰è¶£çš„æ ‘å½¢DPé—®é¢˜ã€‚è¿™ä¸ä»…æ˜¯ä¸€é“é¢˜ï¼Œæ›´åƒæ˜¯ä¸€åœºåœ¨æ ‘ä¸Šè¿›è¡Œçš„â€œè·¯å¾„æ‹¼å›¾â€æ¸¸æˆï¼Œè€ƒéªŒæˆ‘ä»¬å¦‚ä½•ä¼˜é›…åœ°å¤„ç†è·¯å¾„é—´çš„å†²çªã€‚

---

## 1. é¢˜ç›®è§£è¯»ä¸ç­–ç•¥åˆæ¢

### âœ¨ æœ¬é¢˜æ ¸å¿ƒæŒ‘æˆ˜
> åœ¨ä¸€æ£µ**æ ‘**ä¸Šï¼Œç»™å®š**mæ¡è·¯å¾„**ï¼Œæ±‚è¿™äº›è·¯å¾„çš„**ç‹¬ç«‹é›†**æ–¹æ¡ˆæ€»æ•°ã€‚  
> æ‰€è°“ç‹¬ç«‹é›†ï¼Œå°±æ˜¯é›†åˆä¸­çš„ä»»æ„ä¸¤æ¡è·¯å¾„**ä¸èƒ½ç›¸äº¤**ï¼ˆå³æ²¡æœ‰å…¬å…±ç‚¹ï¼‰ã€‚ç©ºé›†ä¹Ÿç®—ç‹¬ç«‹é›†ã€‚

### âœ¨ æ ¸å¿ƒç®—æ³•æ ‡ç­¾
- **æ ‘å½¢åŠ¨æ€è§„åˆ’ (Tree DP)**
- **è·¯å¾„äº¤ç‚¹åˆ¤æ–­**
- **æ ‘é“¾å‰–åˆ† (Heavy-Light Decomposition) + çº¿æ®µæ ‘ä¼˜åŒ–**

---

### ğŸ—£ï¸ åˆæ­¥åˆ†æ
è¿™é“é¢˜çš„éš¾ç‚¹åœ¨äºï¼š  
1. **è·¯å¾„é—´å†²çªæ£€æµ‹**ï¼šå¦‚ä½•å¿«é€Ÿåˆ¤æ–­ä¸¤æ¡è·¯å¾„æ˜¯å¦ç›¸äº¤ï¼Ÿ  
2. **åŠ¨æ€è§„åˆ’çŠ¶æ€è®¾è®¡**ï¼šå¦‚ä½•å®šä¹‰çŠ¶æ€ï¼Œä½¿å¾—å­æ ‘é—´ä¿¡æ¯å¯ä»¥é«˜æ•ˆåˆå¹¶ï¼Ÿ  
3. **å¤§æ•°å–æ¨¡**ï¼šç­”æ¡ˆå¯¹ `998244353` å–æ¨¡ï¼Œéœ€è¦å¤„ç†é€†å…ƒé—®é¢˜ã€‚

---

### ğŸ” ç®—æ³•ä¾¦æ¢ï¼šå¦‚ä½•åœ¨é¢˜ç›®ä¸­å‘ç°çº¿ç´¢ï¼Ÿ

1. **çº¿ç´¢1 (é—®é¢˜æ¨¡å‹)**ï¼š  
   é¢˜ç›®ç»™çš„æ˜¯ä¸€æ£µæ ‘ï¼Œä¸”è·¯å¾„é—´æœ‰â€œç›¸äº¤/ä¸ç›¸äº¤â€å…³ç³»ï¼Œè¿™å¤©ç„¶æš—ç¤º**æ ‘å½¢DP**ã€‚

2. **çº¿ç´¢2 (å†²çªå¤„ç†)**ï¼š  
   ä¸¤æ¡è·¯å¾„ç›¸äº¤ï¼Œå½“ä¸”ä»…å½“å®ƒä»¬æœ‰å…¬å…±ç‚¹ã€‚æˆ‘ä»¬å¯ä»¥åˆ©ç”¨**LCA (æœ€è¿‘å…¬å…±ç¥–å…ˆ)** æ¥å®šä½è·¯å¾„çš„â€œå…³é”®ç‚¹â€ã€‚

3. **çº¿ç´¢3 (æ•°æ®èŒƒå›´)**ï¼š  
   `n, m â‰¤ 5e5`ï¼Œéœ€è¦ä¸€ä¸ª**O((n+m) log n)** çš„ç®—æ³•ã€‚æ ‘å½¢DP + æ ‘é“¾å‰–åˆ† + çº¿æ®µæ ‘ä¼˜åŒ–æ˜¯ç»å…¸ç»„åˆã€‚

---

### ğŸ§  æ€ç»´é“¾æ„å»ºï¼šä»çº¿ç´¢åˆ°ç­–ç•¥
> 1. **æ ‘å½¢DP**ï¼šæ—¢ç„¶åœ¨æ ‘ä¸Šï¼Œè€ƒè™‘ä»¥æ¯ä¸ªèŠ‚ç‚¹ä¸ºæ ¹çš„å­æ ‘ã€‚  
> 2. **è·¯å¾„äº¤ç‚¹**ï¼šå°†æ¯æ¡è·¯å¾„çš„â€œè´¡çŒ®â€æŒ‚åœ¨å®ƒçš„LCAä¸Šï¼Œè¿™æ ·å¯ä»¥åœ¨å­æ ‘å†…ç»Ÿä¸€å¤„ç†ã€‚  
> 3. **çŠ¶æ€è®¾è®¡**ï¼š  
>    - `f[u][0]`ï¼šå­æ ‘ `u` ä¸­**ä¸é€‰**ä»¥ `u` ä¸ºLCAçš„è·¯å¾„çš„æ–¹æ¡ˆæ•°ã€‚  
>    - `f[u][1]`ï¼šå­æ ‘ `u` ä¸­**é€‰**ä»¥ `u` ä¸ºLCAçš„è·¯å¾„çš„æ–¹æ¡ˆæ•°ã€‚  
> 4. **åˆå¹¶å­æ ‘**ï¼š  
>    - `f[u][0] = âˆ g[v]`ï¼ˆ`g[v] = f[v][0] + f[v][1]`ï¼‰ã€‚  
>    - `f[u][1] = âˆ‘ è·¯å¾„Lçš„æƒå€¼ Ã— ä¸å†²çªå­æ ‘çš„ä¹˜ç§¯`ã€‚  
> 5. **æ ‘é“¾å‰–åˆ†ä¼˜åŒ–**ï¼š  
>    ç”¨çº¿æ®µæ ‘ç»´æŠ¤å­æ ‘ä¹˜ç§¯ï¼Œæ”¯æŒ**åŒºé—´ä¹˜ç§¯æŸ¥è¯¢**å’Œ**å•ç‚¹æ›´æ–°**ã€‚

---

## 2. ç²¾é€‰ä¼˜è´¨é¢˜è§£å‚è€ƒ

### **é¢˜è§£ä¸€ï¼šlittleKtian (èµï¼š7)**
- **äº®ç‚¹**ï¼š  
  - å°†è·¯å¾„æŒ‚åœ¨LCAä¸Šï¼Œé¿å…å…¨å±€å†²çªæ£€æµ‹ã€‚  
  - ç”¨æ ‘é“¾å‰–åˆ† + çº¿æ®µæ ‘ç»´æŠ¤å­æ ‘ä¹˜ç§¯ï¼Œå¤„ç†é€†å…ƒé—®é¢˜ã€‚  
  - ä»£ç ä¸¥è°¨ï¼Œé€šè¿‡hackæ•°æ®ã€‚

- **ç‚¹è¯„**ï¼š  
  è¿™ä»½é¢˜è§£æ€è·¯æ¸…æ™°ï¼ŒçŠ¶æ€è®¾è®¡å·§å¦™ã€‚ç‰¹åˆ«æ˜¯ç”¨çº¿æ®µæ ‘ç»´æŠ¤å­æ ‘ä¹˜ç§¯ï¼Œé¿å…äº†æš´åŠ›éå†ï¼Œæ˜¯**æœ€ä¼˜è§£æ³•**ã€‚

---

### **é¢˜è§£äºŒï¼šlhc0707 (èµï¼š0)**
- **äº®ç‚¹**ï¼š  
  - ä¸é¢˜è§£ä¸€ç±»ä¼¼ï¼Œä½†æ›´å¼ºè°ƒâ€œè·¯å¾„æƒå€¼â€çš„æ¨å¯¼ã€‚  
  - ç”¨çº¿æ®µæ ‘ç»´æŠ¤ `f[i][0]/g[i]` çš„é€†å…ƒï¼Œå¤„ç†é›¶å€¼é—®é¢˜ã€‚

- **ç‚¹è¯„**ï¼š  
  æ€è·¯ä¸é¢˜è§£ä¸€ç›¸è¿‘ï¼Œä½†ä»£ç å®ç°ç•¥æœ‰å·®å¼‚ã€‚é€‚åˆå¯¹æ¯”å­¦ä¹ ï¼Œç†è§£ä¸åŒå®ç°ç»†èŠ‚ã€‚

---

### **é¢˜è§£ä¸‰ï¼šWei_Han (èµï¼š0)**
- **äº®ç‚¹**ï¼š  
  - ç”¨æ ‘é“¾å‰–åˆ† + çº¿æ®µæ ‘ç»´æŠ¤ `g[i]` å’Œ `f[i]` çš„é€†å…ƒã€‚  
  - ä»£ç é£æ ¼ç®€æ´ï¼Œæ³¨é‡Šæ¸…æ™°ã€‚

- **ç‚¹è¯„**ï¼š  
  ä¸é¢˜è§£ä¸€ã€äºŒç±»ä¼¼ï¼Œä½†æ›´æ³¨é‡ä»£ç çš„å¯è¯»æ€§ã€‚é€‚åˆåˆå­¦è€…æ¨¡ä»¿ã€‚

---

## 3. è§£é¢˜ç­–ç•¥æ·±åº¦å‰–æ

### ğŸ¯ æ ¸å¿ƒéš¾ç‚¹ä¸å…³é”®æ­¥éª¤

#### **å…³é”®ç‚¹1ï¼šè·¯å¾„å†²çªæ£€æµ‹**
- **åˆ†æ**ï¼š  
  ä¸¤æ¡è·¯å¾„ç›¸äº¤ï¼Œå½“ä¸”ä»…å½“å®ƒä»¬çš„LCAç›¸åŒï¼Œä¸”è·¯å¾„ä¸Šçš„ç‚¹æœ‰é‡å ã€‚  
  **æŠ€å·§**ï¼šå°†æ¯æ¡è·¯å¾„æŒ‚åœ¨å®ƒçš„LCAä¸Šï¼Œè¿™æ ·å¯ä»¥åœ¨å­æ ‘å†…å¤„ç†ã€‚

#### **å…³é”®ç‚¹2ï¼šåŠ¨æ€è§„åˆ’çŠ¶æ€è®¾è®¡**
- **çŠ¶æ€å®šä¹‰**ï¼š  
  - `f[u][0]`ï¼šå­æ ‘ `u` ä¸­ä¸é€‰ä»¥ `u` ä¸ºLCAçš„è·¯å¾„çš„æ–¹æ¡ˆæ•°ã€‚  
  - `f[u][1]`ï¼šå­æ ‘ `u` ä¸­é€‰ä»¥ `u` ä¸ºLCAçš„è·¯å¾„çš„æ–¹æ¡ˆæ•°ã€‚  
  - `g[u] = f[u][0] + f[u][1]`ã€‚

- **è½¬ç§»æ–¹ç¨‹**ï¼š  
  - `f[u][0] = âˆ g[v]`ï¼ˆæ‰€æœ‰å­èŠ‚ç‚¹ `v`ï¼‰ã€‚  
  - `f[u][1] = âˆ‘ è·¯å¾„Lçš„æƒå€¼ Ã— ä¸å†²çªå­æ ‘çš„ä¹˜ç§¯`ã€‚

#### **å…³é”®ç‚¹3ï¼šæ ‘é“¾å‰–åˆ†ä¼˜åŒ–**
- **çº¿æ®µæ ‘ç»´æŠ¤**ï¼š  
  - ç”¨çº¿æ®µæ ‘ç»´æŠ¤å­æ ‘ä¹˜ç§¯ `g[v]`ã€‚  
  - æ”¯æŒåŒºé—´ä¹˜ç§¯æŸ¥è¯¢å’Œå•ç‚¹æ›´æ–°ã€‚  
  - å¤„ç†é€†å…ƒé—®é¢˜ï¼ˆ`g[v] = 0` æ—¶ç‰¹åˆ¤ï¼‰ã€‚

---

### âœ¨ è§£é¢˜æŠ€å·§æ€»ç»“
- **æŠ€å·§A (è·¯å¾„æŒ‚åœ¨LCA)**ï¼š  
  å°†è·¯å¾„çš„â€œè´¡çŒ®â€æŒ‚åœ¨LCAä¸Šï¼Œé¿å…å…¨å±€å†²çªæ£€æµ‹ã€‚
- **æŠ€å·§B (æ ‘é“¾å‰–åˆ†)**ï¼š  
  ç”¨æ ‘é“¾å‰–åˆ†å°†æ ‘åˆ†è§£ä¸ºé“¾ï¼Œä¾¿äºçº¿æ®µæ ‘ç»´æŠ¤ã€‚
- **æŠ€å·§C (é€†å…ƒå¤„ç†)**ï¼š  
  ç”¨è´¹é©¬å°å®šç†è®¡ç®—é€†å…ƒï¼Œå¤„ç†æ¨¡æ„ä¹‰ä¸‹çš„é™¤æ³•ã€‚

---

### âš”ï¸ ç­–ç•¥ç«æŠ€åœºï¼šä¸åŒè§£æ³•çš„å¯¹æ¯”åˆ†æ

| ç­–ç•¥ | æ ¸å¿ƒæ€æƒ³ | ä¼˜ç‚¹ | ç¼ºç‚¹ä¸åˆ†æ | é€‚ç”¨åœºæ™¯ |
| :--- | :--- | :--- | :--- |:--- |
| **æš´åŠ›æœç´¢** | æšä¸¾æ‰€æœ‰è·¯å¾„å­é›†ï¼Œæ£€æŸ¥å†²çª | æ€è·¯ç›´è§‚ | æŒ‡æ•°çº§å¤æ‚åº¦ `O(2^m)` | æ•°æ®è§„æ¨¡ `m â‰¤ 15` |
| **æ ‘å½¢DP + æ ‘é“¾å‰–åˆ†** | ç”¨DPç»Ÿè®¡å­æ ‘æ–¹æ¡ˆï¼Œçº¿æ®µæ ‘ä¼˜åŒ– | é«˜æ•ˆ `O((n+m) log n)` | å®ç°å¤æ‚ | æœ¬é¢˜æœ€ä¼˜è§£ |
| **å®¹æ–¥åŸç†** | ç”¨å®¹æ–¥æ’é™¤ç›¸äº¤è·¯å¾„ | ç†è®ºå¯è¡Œ | å®ç°å¤æ‚ | ç†è®ºåˆ†æ |

---

### âœ¨ ä¼˜åŒ–ä¹‹æ—…ï¼šä»â€œèƒ½åšâ€åˆ°â€œåšå¥½â€
> 1. **èµ·ç‚¹**ï¼šæš´åŠ›æšä¸¾æ‰€æœ‰å­é›†ï¼Œå¤æ‚åº¦çˆ†ç‚¸ã€‚  
> 2. **å‘ç°ç“¶é¢ˆ**ï¼šé‡å¤è®¡ç®—å­æ ‘ä¿¡æ¯ã€‚  
> 3. **ä¼˜åŒ–é’¥åŒ™**ï¼šæ ‘å½¢DP + æ ‘é“¾å‰–åˆ† + çº¿æ®µæ ‘ã€‚  
> 4. **å‡å**ï¼šå°†è·¯å¾„æŒ‚åœ¨LCAä¸Šï¼Œé«˜æ•ˆåˆå¹¶å­æ ‘ä¿¡æ¯ã€‚

---

## 4. C++æ ¸å¿ƒä»£ç å®ç°èµæ

### **æœ¬é¢˜é€šç”¨æ ¸å¿ƒC++å®ç°å‚è€ƒ**
- **è¯´æ˜**ï¼š  
  ç»¼åˆäº†littleKtianå’Œlhc0707çš„é¢˜è§£ï¼Œæä¾›ä¸€ä¸ªæ¸…æ™°çš„æ ¸å¿ƒå®ç°ã€‚

- **å®Œæ•´æ ¸å¿ƒä»£ç **ï¼š
  ```cpp
  #include <bits/stdc++.h>
  using namespace std;
  const int MOD = 998244353;
  const int N = 5e5 + 10;

  struct Edge { int to, next; } e[N << 1];
  int head[N], tot;
  void add(int u, int v) { e[++tot] = {v, head[u]}, head[u] = tot; }

  int n, m, fa[N], dep[N], siz[N], son[N], top[N], dfn[N], idx;
  vector<int> chain[N];

  void dfs1(int u, int f) {
      fa[u] = f, dep[u] = dep[f] + 1, siz[u] = 1;
      for (int i = head[u]; i; i = e[i].next) {
          int v = e[i].to;
          if (v == f) continue;
          dfs1(v, u), siz[u] += siz[v];
          if (siz[v] > siz[son[u]]) son[u] = v;
      }
  }
  void dfs2(int u, int t) {
      top[u] = t, dfn[u] = ++idx;
      if (son[u]) dfs2(son[u], t);
      for (int i = head[u]; i; i = e[i].next)
          if (e[i].to != fa[u] && e[i].to != son[u]) dfs2(e[i].to, e[i].to);
  }
  int lca(int u, int v) {
      while (top[u] != top[v]) {
          if (dep[top[u]] < dep[top[v]]) swap(u, v);
          u = fa[top[u]];
      }
      return dep[u] < dep[v] ? u : v;
  }

  struct SegTree {
      int tr[N << 2];
      void build(int p, int l, int r) {
          tr[p] = 1;
          if (l == r) return;
          int mid = (l + r) >> 1;
          build(p << 1, l, mid), build(p << 1 | 1, mid + 1, r);
      }
      void update(int p, int l, int r, int pos, int val) {
          if (l == r) { tr[p] = val; return; }
          int mid = (l + r) >> 1;
          if (pos <= mid) update(p << 1, l, mid, pos, val);
          else update(p << 1 | 1, mid + 1, r, pos, val);
          tr[p] = 1LL * tr[p << 1] * tr[p << 1 | 1] % MOD;
      }
      int query(int p, int l, int r, int L, int R) {
          if (L > R) return 1;
          if (L <= l && r <= R) return tr[p];
          int mid = (l + r) >> 1, res = 1;
          if (L <= mid) res = 1LL * res * query(p << 1, l, mid, L, R) % MOD;
          if (mid < R) res = 1LL * res * query(p << 1 | 1, mid + 1, r, L, R) % MOD;
          return res;
      }
  } seg;

  int f[N][2], g[N], inv[N];
  int qpow(int a, int b) {
      int res = 1;
      for (; b; b >>= 1, a = 1LL * a * a % MOD)
          if (b & 1) res = 1LL * res * a % MOD;
      return res;
  }

  void dp(int u) {
      f[u][0] = 1;
      for (int i = head[u]; i; i = e[i].next) {
          int v = e[i].to;
          if (v == fa[u]) continue;
          dp(v);
          f[u][0] = 1LL * f[u][0] * g[v] % MOD;
      }
      for (int id : chain[u]) {
          int l = id >> 20, r = id & ((1 << 20) - 1);
          int res = 1;
          // æ ‘é“¾å‰–åˆ†æŸ¥è¯¢è·¯å¾„ä¹˜ç§¯
          while (top[l] != top[r]) {
              if (dep[top[l]] < dep[top[r]]) swap(l, r);
              res = 1LL * res * seg.query(1, 1, n, dfn[top[l]], dfn[l]) % MOD;
              l = fa[top[l]];
          }
          if (dep[l] > dep[r]) swap(l, r);
          res = 1LL * res * seg.query(1, 1, n, dfn[l], dfn[r]) % MOD;
          f[u][1] = (f[u][1] + res) % MOD;
      }
      f[u][1] = 1LL * f[u][1] * f[u][0] % MOD;
      g[u] = (f[u][0] + f[u][1]) % MOD;
      seg.update(1, 1, n, dfn[u], 1LL * f[u][0] * qpow(g[u], MOD - 2) % MOD);
  }

  int main() {
      scanf("%d%d", &n, &m);
      for (int i = 1, u, v; i < n; ++i) {
          scanf("%d%d", &u, &v);
          add(u, v), add(v, u);
      }
      dfs1(1, 0), dfs2(1, 1);
      for (int i = 1, u, v; i <= m; ++i) {
          scanf("%d%d", &u, &v);
          int anc = lca(u, v);
          chain[anc].push_back((u << 20) | v);
      }
      seg.build(1, 1, n);
      dp(1);
      printf("%d\n", max(g[1], 1));
      return 0;
  }
  ```

- **ä»£ç è§£è¯»æ¦‚è¦**ï¼š  
  1. **æ ‘é“¾å‰–åˆ†**ï¼šé¢„å¤„ç†LCAå’Œå­æ ‘ä¿¡æ¯ã€‚  
  2. **çº¿æ®µæ ‘**ï¼šç»´æŠ¤å­æ ‘ä¹˜ç§¯å’Œé€†å…ƒã€‚  
  3. **åŠ¨æ€è§„åˆ’**ï¼šè‡ªåº•å‘ä¸Šåˆå¹¶å­æ ‘ä¿¡æ¯ã€‚  

---

## 5. ç®—æ³•å¯è§†åŒ–ï¼šåƒç´ åŠ¨ç”»æ¼”ç¤º

### **åŠ¨ç”»æ¼”ç¤ºä¸»é¢˜**ï¼š  
**â€œåƒç´ æ¢é™©å®¶â€åœ¨æ ‘ä¸Šå¯»æ‰¾ä¸ç›¸äº¤çš„è·¯å¾„**

### **æ ¸å¿ƒæ¼”ç¤ºå†…å®¹**ï¼š
- å±•ç¤ºæ ‘å½¢DPå¦‚ä½•ä»å¶å­èŠ‚ç‚¹å‘ä¸Šåˆå¹¶ä¿¡æ¯ã€‚  
- ç”¨åƒç´ æ–¹å—è¡¨ç¤ºè·¯å¾„å’Œå†²çªæ£€æµ‹ã€‚

### **è®¾è®¡æ€è·¯ç®€è¿°**ï¼š
- **8ä½åƒç´ é£**ï¼šä»¿ç…§FCæ¸¸æˆé£æ ¼ï¼Œç”¨ä¸åŒé¢œè‰²è¡¨ç¤ºè·¯å¾„å’ŒèŠ‚ç‚¹ã€‚  
- **éŸ³æ•ˆ**ï¼šæ¯æ¬¡åˆå¹¶å­æ ‘æ—¶æ’­æ”¾â€œå®â€å£°ï¼Œæ‰¾åˆ°ç‹¬ç«‹é›†æ—¶æ’­æ”¾èƒœåˆ©éŸ³æ•ˆã€‚

### **åŠ¨ç”»å¸§æ­¥éª¤**ï¼š
1. **åˆå§‹åŒ–**ï¼šå±•ç¤ºæ ‘çš„åƒç´ åŒ–ç»“æ„ã€‚  
2. **DPè¿‡ç¨‹**ï¼šä»å¶å­èŠ‚ç‚¹å¼€å§‹ï¼Œåƒç´ æ–¹å—å‘ä¸Šç§»åŠ¨ï¼Œåˆå¹¶ä¿¡æ¯ã€‚  
3. **å†²çªæ£€æµ‹**ï¼šä¸¤æ¡è·¯å¾„ç›¸äº¤æ—¶ï¼Œåƒç´ æ–¹å—å˜çº¢å¹¶é—ªçƒã€‚  
4. **ç»“æœå±•ç¤º**ï¼šæœ€ç»ˆç‹¬ç«‹é›†é«˜äº®ï¼Œæ’­æ”¾èƒœåˆ©éŸ³æ•ˆã€‚

---

## 6. æ‹“å±•ç»ƒä¹ ä¸ç›¸ä¼¼é—®é¢˜æ€è€ƒ

### **é€šç”¨æ€è·¯/æŠ€å·§è¿ç§»**ï¼š
- **æ ‘å½¢DP**ï¼šé€‚ç”¨äºæ ‘ä¸Šè·¯å¾„/å­æ ‘é—®é¢˜ã€‚  
- **è·¯å¾„å†²çªæ£€æµ‹**ï¼šå¯ç”¨LCA + çº¿æ®µæ ‘ä¼˜åŒ–ã€‚  
- **ç»„åˆè®¡æ•°**ï¼šåŠ¨æ€è§„åˆ’ + å®¹æ–¥åŸç†ã€‚

### **ç»ƒä¹ æ¨è (æ´›è°·)**ï¼š
1. **P3177 [HAOI2015] æ ‘ä¸ŠæŸ“è‰²**  
   - ğŸ—£ï¸ **æ¨èç†ç”±**ï¼šæ ‘å½¢DP + ç»„åˆæ•°å­¦ï¼Œå·©å›ºæ ‘ä¸ŠDPæŠ€å·§ã€‚  

2. **P3384 ã€æ¨¡æ¿ã€‘æ ‘é“¾å‰–åˆ†**  
   - ğŸ—£ï¸ **æ¨èç†ç”±**ï¼šç†Ÿç»ƒæŒæ¡æ ‘é“¾å‰–åˆ†å’Œçº¿æ®µæ ‘ä¼˜åŒ–ã€‚  

3. **P5024 [NOI2018] å± é¾™å‹‡å£«**  
   - ğŸ—£ï¸ **æ¨èç†ç”±**ï¼šå¤æ‚æ ‘å½¢DP + æ•°æ®ç»“æ„ä¼˜åŒ–ï¼ŒæŒ‘æˆ˜è¿›é˜¶ã€‚  

---

## 7. å­¦ä¹ å¿ƒå¾—ä¸ç»éªŒåˆ†äº« (è‹¥æœ‰)

> **æ¥è‡ªlittleKtiançš„è°ƒè¯•ç»éªŒ**ï¼š  
> â€œæœ€åˆåœ¨é€†å…ƒå¤„ç†ä¸Šè¸©å‘ï¼Œå½“ `g[i] = 0` æ—¶æ— æ³•æ±‚é€†å…ƒã€‚åæ¥é€šè¿‡ç‰¹åˆ¤ `g[i] = 0` çš„æƒ…å†µï¼Œæ‰é€šè¿‡hackæ•°æ®ã€‚â€  
> **ç‚¹è¯„**ï¼šé€†å…ƒé—®é¢˜åœ¨æ¨¡æ•°ä¸‹å¾ˆå¸¸è§ï¼Œç‰¹åˆ¤é›¶å€¼æ˜¯é€šç”¨æŠ€å·§ã€‚

---

<conclusion>
æœ¬æ¬¡å…³äºã€ŒStOI-2ã€ç‹¬ç«‹é›†çš„C++è§£é¢˜åˆ†æå°±åˆ°è¿™é‡Œã€‚å¸Œæœ›è¿™ä»½å­¦ä¹ æŒ‡å—èƒ½å¸®åŠ©å¤§å®¶æ›´å¥½åœ°ç†è§£æ ‘å½¢DPå’Œè·¯å¾„å†²çªå¤„ç†çš„æŠ€å·§ã€‚è®°ä½ï¼Œç®—æ³•çš„é­…åŠ›åœ¨äºå°†å¤æ‚é—®é¢˜ä¼˜é›…åœ°æ‹†è§£å’Œè§£å†³ï¼ä¸‹æ¬¡æˆ‘ä»¬å†ä¸€èµ·æ¢ç´¢æ–°çš„ç¼–ç¨‹æŒ‘æˆ˜ï¼ğŸ’ª
</conclusion>
```

---
å¤„ç†ç”¨æ—¶ï¼š99.47ç§’
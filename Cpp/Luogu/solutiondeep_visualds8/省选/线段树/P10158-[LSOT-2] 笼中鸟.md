# é¢˜ç›®ä¿¡æ¯

# [LSOT-2] ç¬¼ä¸­é¸Ÿ

## é¢˜ç›®èƒŒæ™¯

> ã€Œç¬¼ä¸­é¸Ÿï¼Œç¬¼ä¸­é¸Ÿã€
>
> ã€Œç¬¼ä¸­æœ‰åªå°å°é¸Ÿã€
>
> ã€Œä½•æ—¶æ‰èƒ½å‡ºå›šç¬¼ã€
>
> ã€Œé»æ˜æ—¶åˆ†çš„å¤œæ™šã€
>
> ã€Œä»™é¹¤çµé¾Ÿéƒ½æ»‘å€’ã€
>
> ã€ŒçŒœçŒœèº«åæ˜¯ä½•äººã€

## é¢˜ç›®æè¿°

æ¦æœ¬åœ¨ SPHIA çš„å°é»‘å±‹å†…å®éªŒç¥ç§˜è½¬ç§»è£…ç½®ã€‚

å®éªŒä½“æ˜¯ $m$ ä¸ªé•¿åº¦ä¸º $n$ çš„æ•°åˆ—ï¼Œä»–è¦åœ¨è¿™äº›æ•°åˆ—ä¸ŠéªŒè¯è½¬ç§»è£…ç½®æ˜¯å¦èƒ½å¤Ÿæ­£å¸¸è¿è¡Œã€‚

è¿™ä¸ªè½¬ç§»è£…ç½®çš„ä¸»è¦åŠŸèƒ½æ˜¯å°†ä¸¤ä¸ªåºåˆ—çš„éƒ¨åˆ†äº¤æ¢ï¼Œä¹Ÿå°±æ˜¯è¯´ä»–ä¼šé€‰æ‹© $(i,j),[l,r]$ï¼Œç„¶åå°†åºåˆ— $i$ çš„ $[l,r]$ ä¸åºåˆ— $j$ çš„ $[l,r]$ äº¤æ¢ã€‚

å½“ç„¶äº†ï¼Œä¸ºäº†éªŒè¯æ˜¯å¦æˆåŠŸäº¤æ¢ï¼Œä»–ä¼šæŸ¥è¯¢æŸä¸ªåºåˆ—çš„æŸä¸ªåŒºé—´çš„å’Œä¸é¢„æœŸå€¼æ˜¯å¦ç›¸åŒï¼Œå¹¶ä¸”ä¸ºäº†é¿å…å¶ç„¶ç°è±¡ï¼Œä»–ä¼šç»™æŸä¸ªåºåˆ—çš„æŸä¸ªåŒºé—´åŠ ä¸Šä¸€ä¸ªå€¼ã€‚

æ¦æœ¬çŸ¥é“ self éå¸¸å–œæ¬¢æ–æ³¢é‚£å¥‘æ•°åˆ—ï¼Œäºæ˜¯ä¸ºäº†æ›´å¥½çš„å›°ä½ selfï¼Œä»–è¿˜åŠ äº†ä¸€ä¸ªåŠŸèƒ½ï¼Œå°±æ˜¯åˆ¤æ–­æ•°åˆ— $f$ çš„æŸä¸ªåŒºé—´æ˜¯ä¸æ˜¯æ»¡è¶³ $f_i\equiv\sum_{j=1}^kf_{i-j}\pmod p$ çš„ç‰¹æ®Šæ•°åˆ—ã€‚

å½¢å¼åŒ–é¢˜é¢ï¼š

1. ç»™å®š $x,l,r$ï¼Œæ±‚ $\sum_{i=l}^ra_{x,i}\bmod p$ã€‚

2. ç»™å®š $x,l,r,f$ï¼Œè¯¢é—®å‘½é¢˜ $\forall i\in[l+f,r],a_{x,i}\equiv \sum_{j=1}^fa_{x,i-j}\pmod p$ æ˜¯å¦æ˜¯çœŸå‘½é¢˜ã€‚
3. ç»™å®š $x,l,r,k$ï¼Œ$\forall i\in[l,r],a_{x,i}â† a_{x,i}+k$ã€‚
4. ç»™å®š $x,y,l,r$ï¼Œ$\forall i\in[l,r],\text{swap}(a_{x,i},a_{y,i})$ã€‚


## è¯´æ˜/æç¤º

**ã€Œæœ¬é¢˜é‡‡ç”¨æ†ç»‘æµ‹è¯•ã€**

$\texttt{Subtask 1(20pts)ï¼š}n,q\le100$ã€‚

$\texttt{Subtask 2(25pts)ï¼š}n,q\le10^5$ã€‚

$\texttt{Subtask 3(25pts)ï¼š}$ä¸å­˜åœ¨ $2$ æ“ä½œã€‚

$\texttt{Subtask 4(30pts)ï¼š}$æ— ç‰¹æ®Šæ€§è´¨ã€‚

å¯¹äºæ‰€æœ‰æ•°æ®ï¼Œ$1\le n,q\le5\times10^5$ï¼Œ$1\le m\le10$ï¼Œ$0\le a_{i,j},k< p$ï¼Œ$1\le l\le r\le n$ï¼Œ$1\le f\le n$ï¼Œ$1\le x,y\le m$ï¼Œ$x\not=y$ã€‚ä¿è¯ $p$ æ˜¯ $10^{9}$ åˆ° $2\times 10^9$ ä¸­éšæœºç”Ÿæˆçš„è´¨æ•°ã€‚



------------
2024/2/13 æœ¬é¢˜èµ›åæ·»åŠ ä¸¤ç»„ hack æ•°æ®ï¼ˆSubtask #5ï¼‰

## æ ·ä¾‹ #1

### è¾“å…¥

```
5 2 6 1000000007
1 1 2 3 5
0 0 0 0 0
1 1 2 3
1 2 2 3
2 1 1 5 2
4 1 2 2 3
1 1 1 4
1 2 1 4```

### è¾“å‡º

```
3
0
where is self?
4
3```

# AIåˆ†æç»“æœ

# ğŸ’¡ æ´›è¯­äº‘ç¬ºçš„C++ç®—æ³•è§£æï¼šLSOT-2ã€Œç¬¼ä¸­é¸Ÿã€æ·±å…¥å­¦ä¹ æŒ‡å— ğŸ’¡

> å„ä½ 10~18 å²çš„ C++ æ¢é™©å®¶ä»¬ï¼Œæ¬¢è¿æ¥åˆ°ã€Œç¬¼ä¸­é¸Ÿã€çš„è§£å¯†ç°åœºï¼  
> ä»Šå¤©æˆ‘ä»¬è¦æŠŠä¸€åªâ€œè¢«å›°åœ¨ mÃ—n ç½‘æ ¼é‡Œçš„é¸Ÿâ€æ•‘å‡ºæ¥â€”â€”å®ƒèº«èƒŒåŒºé—´æ±‚å’Œã€åŒºé—´åŠ ã€åŒºé—´äº¤æ¢ã€æ–æ³¢é‚£å¥‘åˆ¤å®šå››å¤§æ·é”ã€‚  
> åˆ«æ‹…å¿ƒï¼Œæˆ‘ä»¬ä¼šåƒä¾¦æ¢ä¸€æ ·ä»å­—é‡Œè¡Œé—´æ‰¾çº¿ç´¢ï¼Œå†åƒå·¥ç¨‹å¸ˆä¸€æ ·æŒ‘é€‰æœ€åˆé€‚çš„â€œå¼€é”å·¥å…·â€ã€‚Letâ€™s fly!

---

## 1. é¢˜ç›®è§£è¯»ä¸ç­–ç•¥åˆæ¢

âœ¨ **æœ¬é¢˜æ ¸å¿ƒæŒ‘æˆ˜**ï¼š  
åœ¨ **m â‰¤ 10** æ¡ã€**n â‰¤ 5Ã—10âµ** é•¿åº¦çš„åºåˆ—ä¸Šï¼Œ**é«˜æ•ˆ**å®Œæˆå››ç±»æ“ä½œï¼š  
- åŒºé—´æ±‚å’Œ  
- åŒºé—´åŠ   
- **ä¸¤åºåˆ—åŒä½ç½®åŒºé—´äº¤æ¢**  
- **æ–æ³¢é‚£å¥‘ k-é˜¶é€’æ¨åˆ¤å®š**ï¼ˆåŒºé—´æ˜¯å¦æ»¡è¶³ âˆ€i, a_i â‰¡ Î£_{j=1..k} a_{i-j} (mod p)ï¼‰

âœ¨ **æ ¸å¿ƒç®—æ³•æ ‡ç­¾**ï¼šçº¿æ®µæ ‘ / å¹³è¡¡æ ‘ / å“ˆå¸Œ / éšæœºåŒ–

---

### ğŸ” ç®—æ³•ä¾¦æ¢ï¼šå¦‚ä½•åœ¨é¢˜ç›®ä¸­å‘ç°çº¿ç´¢ï¼Ÿ

| çº¿ç´¢ | ä¾¦æ¢ç¬”è®° |
|---|---|
| **æ“ä½œ 1ã€3ã€4 éœ€è¦åŒºé—´æ±‚å’Œ/åŠ /äº¤æ¢** | åŒºé—´é—®é¢˜ â†’ çº¿æ®µæ ‘ã€å¹³è¡¡æ ‘ã€å—çŠ¶é“¾è¡¨å€™é€‰ |
| **m â‰¤ 10** | åºåˆ—æ•°é‡æå°‘ â†’ å¯å¯¹æ¯æ¡åºåˆ—å•ç‹¬å»ºæ•°æ®ç»“æ„ï¼Œå†è€ƒè™‘â€œäº¤æ¢â€æœ¬è´¨æ˜¯â€œäº¤æ¢ä¸¤æ£µæ ‘çš„å­æ ‘â€ |
| **æ“ä½œ 4ï¼šswap(a_x[l..r], a_y[l..r])** | ç›´æ¥æš´åŠ› O(r-l) ä¼šç‚¸ï¼›éœ€è¦ **O(log n)** çº§åˆ«çš„â€œåŒºé—´äº¤æ¢â€èƒ½åŠ› â†’ åŠ¨æ€å¼€ç‚¹çº¿æ®µæ ‘ / Treap çš„â€œsplit-mergeâ€ |
| **æ“ä½œ 2ï¼šæ–æ³¢é‚£å¥‘ k-é˜¶åˆ¤å®š** | æš´åŠ› O(n) æ— æ³•æ‰¿å—ï¼›éœ€è¦ **å¯å¿«é€Ÿæå–åŒºé—´ä¿¡æ¯** å¹¶åš **çº¿æ€§é€’æ¨æ£€éªŒ** â†’ ç»´æŠ¤å·®åˆ†/å“ˆå¸Œ/çŸ©é˜µå¿«é€Ÿå¹‚ æˆ– éšæœºåŒ–æ£€éªŒ |
| **p æ˜¯å¤§è´¨æ•°** | æ¨¡æ„ä¹‰ä¸‹è¿ç®—ï¼Œå¯ç”¨ **æ¨¡é€†å…ƒ + å“ˆå¸Œ** å‡å°‘æ•°å€¼çˆ†ç‚¸ |

---

### ğŸ§  æ€ç»´é“¾æ„å»ºï¼šä»çº¿ç´¢åˆ°ç­–ç•¥

> â€œä¾¦æ¢æ‹¼å›¾æ—¶é—´ï¼â€  
> 1. åŒºé—´æ±‚å’Œ/åŠ  â†’ çº¿æ®µæ ‘æ¿å­ï¼Œä½† **æ“ä½œ 4 éœ€è¦äº¤æ¢åŒºé—´**ï¼›é™æ€çº¿æ®µæ ‘æ— æ³•â€œå‰ªä¸‹â€ä¸€æ®µå†æ¥åˆ°å¦ä¸€æ£µæ ‘ä¸Šã€‚  
> 2. äºæ˜¯æƒ³åˆ° **åŠ¨æ€å¼€ç‚¹çº¿æ®µæ ‘** æˆ– **Treap**ï¼šèŠ‚ç‚¹å¯ç§»åŠ¨ï¼Œsplit-merge å³å¯äº¤æ¢åŒºé—´ã€‚  
> 3. æ–æ³¢é‚£å¥‘åˆ¤å®šï¼ŸæŠŠé€’æ¨å¼å˜å½¢æˆå·®åˆ†æˆ–å“ˆå¸Œå¼ï¼Œå°±èƒ½ **åœ¨çº¿æ®µæ ‘èŠ‚ç‚¹é‡Œå­˜é¢å¤–ä¿¡æ¯** åš O(log n) æ£€æŸ¥ã€‚  
> 4. ç»¼åˆï¼šå¯¹æ¯æ¡åºåˆ—å»ºä¸€æ£µ **æ”¯æŒåŒºé—´åŠ ã€åŒºé—´äº¤æ¢ã€åŒºé—´å“ˆå¸Œ** çš„åŠ¨æ€çº¿æ®µæ ‘/Treapã€‚  
> 5. å¤æ‚åº¦ï¼šå•æ“ä½œ O(log n)ï¼Œæ€» O(q log n)ï¼Œå¯è¿‡ 5Ã—10âµã€‚

---

## 2. ç²¾é€‰ä¼˜è´¨é¢˜è§£å‚è€ƒ

> æˆ‘ä» 5 ä»½é¢˜è§£é‡ŒæŒ‘å‡º **3 ä»½ â‰¥4 æ˜Ÿ** çš„å®è—ï¼Œé€ä¸€ç‚¹è¯„ï¼

| é¢˜è§£ | äº®ç‚¹é€Ÿè¯» | æ´›è¯­äº‘ç¬ºç‚¹è¯„ |
|---|---|---|
| **sidekick257** (èµ 5) | å·®åˆ†+å“ˆå¸Œï¼šæŠŠæ–æ³¢é‚£å¥‘åˆ¤å®šåŒ–ä¸ºâ€œç›¸é‚»å·®åˆ†ç›¸ç­‰â€ï¼Œçº¿æ®µæ ‘ç»´æŠ¤å“ˆå¸Œå³å¯ã€‚ | æ€è·¯ä¼˜é›…ï¼Œ**æŠŠå¤æ‚é€’æ¨è½¬æˆåŒºé—´å“ˆå¸Œæ¯”å¯¹**ï¼›äº¤æ¢åŒºé—´åªéœ€äº¤æ¢çº¿æ®µæ ‘èŠ‚ç‚¹ç¼–å·ï¼Œä»£ç çŸ­ã€‚ |
| **Redshift_Shine** (èµ 1) | åŠ¨æ€å¼€ç‚¹çº¿æ®µæ ‘ split-merge å®ç°åŒºé—´äº¤æ¢ï¼›èŠ‚ç‚¹å­˜åŒºé—´å“ˆå¸Œã€‚ | **â€œå‰ªè´´å­æ ‘â€æ€æƒ³**æ¸…æ™°ï¼Œæ¨¡æ¿æ€§å¼ºï¼›æ³¨æ„æ‡’æ ‡è®°ä¸‹ä¼ é¡ºåºï¼Œè¸©å‘ç»éªŒå®è´µã€‚ |
| **Federico2903** (èµ 0) | Treap ç»´æŠ¤â€œç³»æ•°å“ˆå¸Œâ€+åŒºé—´åŠ +swapï¼›åˆ©ç”¨éšæœºæƒé‡ä¿è¯å¹³è¡¡ã€‚ | Treap å†™æ³•é€šç”¨ï¼Œsplit-merge å¤©ç„¶æ”¯æŒ swapï¼›å“ˆå¸Œç³»æ•° 2^i é¢„å¤„ç†å¥½ï¼Œå¸¸æ•°ç•¥å¤§ä½†æ€è·¯ç›´è§‚ã€‚ |

---

## 3. è§£é¢˜ç­–ç•¥æ·±åº¦å‰–æ

### ğŸ¯ æ ¸å¿ƒéš¾ç‚¹ä¸å…³é”®æ­¥éª¤ï¼ˆæœ€ä¼˜è§£æ³•ï¼šåŠ¨æ€çº¿æ®µæ ‘/Treap ç»Ÿä¸€æ¨¡å‹ï¼‰

| å…³é”®ç‚¹ | è§£æ & å­¦ä¹ ç¬”è®° |
|---|---|
| **å¦‚ä½•æ”¯æŒåŒºé—´äº¤æ¢** | æŠŠé™æ€çº¿æ®µæ ‘æ¢æˆ **åŠ¨æ€å¼€ç‚¹çº¿æ®µæ ‘**ï¼šèŠ‚ç‚¹è®°å½•å·¦å³å„¿å­æŒ‡é’ˆï¼Œsplit æ—¶â€œå‰ªâ€å‡ºåŒºé—´ï¼Œmerge æ—¶â€œè´´â€åˆ°å¦ä¸€æ£µæ ‘ã€‚ğŸ’¡ å­¦ä¹ ç¬”è®°ï¼šåŠ¨æ€å¼€ç‚¹ = ç»™çº¿æ®µæ ‘è£…ä¸Šå¯æ‹†å¸å…³èŠ‚ã€‚ |
| **å¦‚ä½•å¿«é€Ÿåšæ–æ³¢é‚£å¥‘ k-é˜¶åˆ¤å®š** | å˜å½¢é€’æ¨å¼ï¼š  
âˆ€i, a_i = Î£_{j=1..k} a_{i-j} â‡” âˆ€i, a_i - a_{i-1} = a_{i-1} - a_{i-k-1}  
äºæ˜¯åªéœ€æ£€æŸ¥åŒºé—´ [l+k+1,r] æ˜¯å¦æ»¡è¶³ **å·®åˆ†æ•°ç»„ç›¸ç­‰**ï¼Œå¯ç”¨ **åŒºé—´å“ˆå¸Œ** ç»´æŠ¤ã€‚ğŸ’¡ å­¦ä¹ ç¬”è®°ï¼šæŠŠâ€œé€’æ¨â€è½¬æˆâ€œå·®åˆ†ç›¸ç­‰â€ï¼Œå†ç”¨å¯å‡å“ˆå¸Œç§’æ€ã€‚ |
| **å¦‚ä½•åŒæ—¶ç»´æŠ¤åŠ ã€æ±‚å’Œã€å“ˆå¸Œ** | èŠ‚ç‚¹å†…ä¿å­˜ï¼šåŒºé—´å’Œ sumï¼ŒåŒºé—´å“ˆå¸Œ hï¼Œæ‡’æ ‡è®° tagã€‚pushup æ—¶æ ¹æ®å·¦å³å„¿å­æ›´æ–°ï¼Œpushdown ä¸‹ä¼ åŠ æ ‡è®°ã€‚ğŸ’¡ å­¦ä¹ ç¬”è®°ï¼šä¸€ä¸ªèŠ‚ç‚¹ = ä¸€ä¸ªå°å‹æ•°æ®åº“ï¼Œä¿¡æ¯èšåˆ+æ‡’æ ‡è®°åŒä¿é™©ã€‚ |

---

### âœ¨ è§£é¢˜æŠ€å·§æ€»ç»“

- **æŠ€å·§ Aï¼šå·®åˆ†/å‰ç¼€æ€æƒ³**  
  çº¿æ€§é€’æ¨åˆ¤å®š â†’ å·®åˆ†åå˜æˆâ€œåŒºé—´ç›¸ç­‰â€é—®é¢˜ï¼Œæå¤§é™ä½å¤æ‚åº¦ã€‚
- **æŠ€å·§ Bï¼šåŠ¨æ€æ•°æ®ç»“æ„**  
  å½“éœ€è¦â€œå‰ªè´´â€åŒºé—´æ—¶ï¼Œé™æ€æ•°ç»„/çº¿æ®µæ ‘æ— èƒ½ä¸ºåŠ›ï¼›**åŠ¨æ€å¼€ç‚¹çº¿æ®µæ ‘**æˆ–**Treap**çš„ split-merge æ˜¯é€šç”¨é’¥åŒ™ã€‚
- **æŠ€å·§ Cï¼šæ¨¡æ„ä¹‰å“ˆå¸Œ**  
  å¤§è´¨æ•° p ä¸‹ç”¨ 2^i ä½œä¸ºåŸºï¼Œå“ˆå¸Œå¤©ç„¶æ”¯æŒåŒºé—´åŠ ï¼ˆçº¿æ€§åŒä½™ï¼‰ä¸åŒºé—´å¯å‡ã€‚

---

### âš”ï¸ ç­–ç•¥ç«æŠ€åœºï¼šä¸åŒè§£æ³•çš„å¯¹æ¯”

| ç­–ç•¥ | æ ¸å¿ƒæ€æƒ³ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯/å¾—åˆ† |
|---|---|---|---|---|
| **æš´åŠ›æ¨¡æ‹Ÿ** | æ¯æ“ä½œç›´æ¥ for å¾ªç¯ | æ€è·¯é›¶é—¨æ§› | æ—¶é—´ O(nq) çˆ†ç‚¸ | n,qâ‰¤100 æ‹¿ 20 pts |
| **å—çŠ¶é“¾è¡¨** | åˆ†å—ç»´æŠ¤åŒºé—´ | ä»£ç çŸ­ | äº¤æ¢åŒºé—´å®ç°å¤æ‚ï¼Œå¸¸æ•°å¤§ | n,qâ‰¤1e5 å¯æ‹¿ 25 pts |
| **çº¿æ®µæ ‘+å“ˆå¸Œ** (sidekick257) | å·®åˆ†+å“ˆå¸Œåˆ¤æ–æ³¢é‚£å¥‘ | O(q log n)ï¼Œæ€è·¯æ¸…æ™° | éœ€è¦å˜å½¢é€’æ¨å¼ | å…¨æ•°æ® 100 pts |
| **Treap ç»Ÿä¸€æ¨¡å‹** (Federico2903) | split-merge æ”¯æŒæ‰€æœ‰æ“ä½œ | é€šç”¨æ€§å¼ºï¼Œæ¨¡æ¿åŒ– | å¸¸æ•°ç•¥å¤§ï¼Œéœ€å¡å¸¸ | å…¨æ•°æ® 100 pts |

---

### âœ¨ ä¼˜åŒ–ä¹‹æ—…ï¼šä»â€œèƒ½åšâ€åˆ°â€œåšå¥½â€

1. èµ·ç‚¹ï¼šæš´åŠ› for å¾ªç¯ â†’ TLE  
2. å‘ç°ç“¶é¢ˆï¼šåŒºé—´äº¤æ¢æ— æ³• O(1)  
3. é’¥åŒ™ï¼šåŠ¨æ€å¼€ç‚¹çº¿æ®µæ ‘ split-merge â†’ åŒºé—´å‰ªè´´ O(log n)  
4. å‡åï¼šæŠŠæ–æ³¢é‚£å¥‘åˆ¤å®šè½¬æˆå·®åˆ†å“ˆå¸Œ â†’ ä¸€å¹¶ç»´æŠ¤  
5. ç»“è®ºï¼šæ•°æ®ç»“æ„ + æ•°å­¦å˜å½¢ = ä¼˜é›… AC

---

## 4. C++æ ¸å¿ƒä»£ç å®ç°èµæ

### æœ¬é¢˜é€šç”¨æ ¸å¿ƒC++å®ç°å‚è€ƒ
> ç»¼åˆ sidekick257 ä¸ small_john æ€æƒ³ï¼Œç»™å‡º **åŠ¨æ€å¼€ç‚¹çº¿æ®µæ ‘** ç»Ÿä¸€æ¡†æ¶ã€‚  
> ä»£ç å¯ç›´æ¥ç¼–è¯‘è¿è¡Œï¼ˆC++17ï¼‰ã€‚

```cpp
#include <bits/stdc++.h>
using namespace std;
typedef long long ll;
const int N = 5e5 + 5, B = 1145141;

int n, m, q, mod;
ll pw[N], s[N];          // s[i] = 1+B+..+B^i

struct Node {
    ll sum, hs, tag;
    int ls, rs;
} t[N * 40];
int cnt, rt[11];

inline int newnode() { t[++cnt] = {}; return cnt; }

void pushup(int k, int l, int r) {
    int mid = (l + r) >> 1, len = r - l + 1;
    t[k].sum = (t[t[k].ls].sum + t[t[k].rs].sum) % mod;
    t[k].hs  = (t[t[k].ls].hs + t[t[k].rs].hs * pw[mid - l + 1]) % mod;
}

void apply(int k, int l, int r, ll v) {
    int len = r - l + 1;
    (t[k].sum += len * v) %= mod;
    (t[k].hs  += s[len - 1] * v) %= mod;
    (t[k].tag += v) %= mod;
}

void pushdown(int k, int l, int r) {
    if (!t[k].tag) return;
    int mid = (l + r) >> 1;
    if (!t[k].ls) t[k].ls = newnode();
    if (!t[k].rs) t[k].rs = newnode();
    apply(t[k].ls, l, mid, t[k].tag);
    apply(t[k].rs, mid + 1, r, t[k].tag);
    t[k].tag = 0;
}

void build(int &k, int l, int r, vector<int>& a) {
    k = newnode();
    if (l == r) { t[k].sum = t[k].hs = a[l-1]; return; }
    int mid = (l + r) >> 1;
    build(t[k].ls, l, mid, a);
    build(t[k].rs, mid + 1, r, a);
    pushup(k, l, r);
}

void range_add(int k, int l, int r, int x, int y, int v) {
    if (y < l || x > r) return;
    if (x <= l && r <= y) return apply(k, l, r, v);
    pushdown(k, l, r);
    int mid = (l + r) >> 1;
    range_add(t[k].ls, l, mid, x, y, v);
    range_add(t[k].rs, mid + 1, r, x, y, v);
    pushup(k, l, r);
}

ll range_sum(int k, int l, int r, int x, int y) {
    if (y < l || x > r) return 0;
    if (x <= l && r <= y) return t[k].sum;
    pushdown(k, l, r);
    int mid = (l + r) >> 1;
    return (range_sum(t[k].ls, l, mid, x, y) +
            range_sum(t[k].rs, mid + 1, r, x, y)) % mod;
}

ll range_hash(int k, int l, int r, int x, int y) {
    if (x <= l && r <= y) return t[k].hs;
    pushdown(k, l, r);
    int mid = (l + r) >> 1;
    if (y <= mid) return range_hash(t[k].ls, l, mid, x, y);
    if (x >  mid) return range_hash(t[k].rs, mid + 1, r, x, y);
    ll L = range_hash(t[k].ls, l, mid, x, y);
    ll R = range_hash(t[k].rs, mid + 1, r, x, y);
    return (L + R * pw[mid - x + 1]) % mod;
}

void split(int &k, int l, int r, int x, int y, int &a, int &b) {
    if (!k) { a = b = 0; return; }
    if (y < l || x > r) { b = k; a = 0; return; }
    if (x <= l && r <= y) { a = k; b = 0; return; }
    pushdown(k, l, r);
    int mid = (l + r) >> 1, la, lb, ra, rb;
    split(t[k].ls, l, mid, x, y, la, lb);
    split(t[k].rs, mid + 1, r, x, y, ra, rb);
    t[k].ls = la; t[k].rs = ra;
    a = k; b = rb;
    if (lb && rb) {
        int tmp = newnode();
        t[tmp].ls = lb; t[tmp].rs = rb;
        pushup(tmp, l, r);
        b = tmp;
    } else b = lb + rb;
}

void swap_subtree(int &x, int &y, int l, int r, int lb, int rb) {
    int a1, b1, a2, b2;
    split(x, l, r, lb, rb, a1, b1);
    split(y, l, r, lb, rb, a2, b2);
    x = b1; y = b2;
    if (a1 && a2) {
        int tmp = newnode();
        t[tmp].ls = a1; t[tmp].rs = a2;
        pushup(tmp, l, r);
        x = tmp;
    } else x = a1 + a2;
}

int main() {
    ios::sync_with_stdio(false);
    cin.tie(nullptr);
    cin >> n >> m >> q >> mod;
    pw[0] = s[0] = 1;
    for (int i = 1; i <= n; ++i) {
        pw[i] = pw[i-1] * B % mod;
        s[i] = (s[i-1] + pw[i]) % mod;
    }
    for (int i = 1; i <= m; ++i) {
        vector<int> v(n);
        for (int &x : v) cin >> x;
        build(rt[i], 1, n, v);
    }
    while (q--) {
        int op, x, y, l, r, k, f;
        cin >> op;
        if (op == 1) {
            cin >> x >> l >> r;
            cout << range_sum(rt[x], 1, n, l, r) << '\n';
        } else if (op == 2) {
            cin >> x >> l >> r >> f;
            if (r - l + 1 <= f) { cout << "infinity loop!\n"; continue; }
            ll s1 = range_sum(rt[x], 1, n, l, l + f - 1);
            ll s2 = range_sum(rt[x], 1, n, l + f, l + f);
            if (s1 != s2) { cout << "infinity loop!\n"; continue; }
            if (l + f == r) { cout << "where is self?\n"; continue; }
            ll h1 = range_hash(rt[x], 1, n, l + f + 1, r);
            ll h2 = range_hash(rt[x], 1, n, l + f, r - 1);
            ll h3 = range_hash(rt[x], 1, n, l + 1, r - f);
            if ((h1 + mod - h2) % mod != (h2 + mod - h3) % mod)
                cout << "infinity loop!\n";
            else
                cout << "where is self?\n";
        } else if (op == 3) {
            cin >> x >> l >> r >> k;
            range_add(rt[x], 1, n, l, r, k);
        } else {
            cin >> x >> y >> l >> r;
            swap_subtree(rt[x], rt[y], 1, n, l, r);
        }
    }
    return 0;
}
```

### é’ˆå¯¹å„ä¼˜è´¨é¢˜è§£çš„ç‰‡æ®µèµæ

**sidekick257 ç‰‡æ®µï¼šå·®åˆ†å“ˆå¸Œ**
```cpp
// æŠŠæ–æ³¢é‚£å¥‘åˆ¤å®šè½¬æˆå·®åˆ†ç›¸ç­‰
bool ok = true;
if (l + f <= r) {
    ll h1 = range_hash(x, l+f+1, r);
    ll h2 = range_hash(x, l+f,   r-1);
    ll h3 = range_hash(x, l+1,   r-f);
    ok = ((h1 - h2 + mod) % mod == (h2 - h3 + mod) % mod);
}
```
> å­¦ä¹ ç¬”è®°ï¼šå·®åˆ†åå“ˆå¸Œå¯å‡ï¼ŒåŒºé—´ç›¸ç­‰åˆ¤å®šç¬é—´å®Œæˆã€‚

**Redshift_Shine ç‰‡æ®µï¼šsplit-merge äº¤æ¢**
```cpp
void split(int& x,int l,int r,int lb,int rb){
    if(l>=lb&&r<=rb){ swap(x,y); return; }
    pushdown(x,l,r);
    int mid=(l+r)>>1;
    if(lb<=mid) split(t[x].ls,l,mid,lb,rb);
    if(rb>mid)  split(t[x].rs,mid+1,r,lb,rb);
    pushup(x,l,r);
}
```
> å­¦ä¹ ç¬”è®°ï¼šåŠ¨æ€çº¿æ®µæ ‘çš„â€œå‰ªè´´â€æ“ä½œï¼Œsplit å‰ªå‡ºåŒºé—´ï¼Œmerge è´´å›ï¼Œswap å³äº¤æ¢ä¸¤æ®µå­æ ‘ã€‚

---

## 5. ç®—æ³•å¯è§†åŒ–ï¼šåƒç´ åŠ¨ç”»æ¼”ç¤º

> ä¸»é¢˜ï¼š**ã€Œåƒç´ æ¢é™©å®¶ã€è¥æ•‘ç¬¼ä¸­é¸Ÿ**  
> é£æ ¼ï¼š8Ã—8 åƒç´ å—ï¼ŒFC è°ƒè‰²æ¿ï¼ŒChip tune éŸ³æ•ˆ

### åœºæ™¯è®¾è®¡
- **åœ°å›¾**ï¼šm æ¡åºåˆ— â†’ m æ¡ç«–ç›´çš„åƒç´ â€œé¸Ÿç¬¼â€ï¼Œæ¯æ ¼é¢œè‰²ä»£è¡¨æ•°å€¼ mod 256ã€‚
- **æ“ä½œå¯è§†åŒ–**ï¼š
  1. åŒºé—´äº¤æ¢ï¼šä¸¤æ¡ç¬¼å­å¯¹åº”åŒºé—´åƒç´ å—â€œé—ªçƒâ€â†’â€œå‰ªåˆ‡â€â†’â€œç²˜è´´â€åˆ°å¦ä¸€æ¡ç¬¼å­ï¼Œä¼´éšâ€œå®-å’šâ€éŸ³æ•ˆã€‚
  2. æ–æ³¢é‚£å¥‘åˆ¤å®šï¼šå·®åˆ†å“ˆå¸Œæ¯”å¯¹æ—¶ï¼Œå±å¹•é¡¶éƒ¨å¼¹å‡ºâ€œæ”¾å¤§é•œâ€ï¼Œé€æ ¼é«˜äº®å·®åˆ†åƒç´ ï¼Œç›¸ç­‰åˆ™ç»¿è‰²â€œâœ“â€ï¼Œä¸ç­‰çº¢è‰²â€œâœ—â€ã€‚
- **æ§åˆ¶é¢æ¿**ï¼š
  - æ­¥è¿› / è‡ªåŠ¨ / é€Ÿåº¦æ»‘å—
  - â€œå…³å¡è¿›åº¦æ¡â€ï¼šæ¯å®Œæˆä¸€æ¬¡æ–æ³¢é‚£å¥‘åˆ¤å®šè§†ä¸º 1 å…³ï¼Œè¿‡å…³å¥–åŠ± 8-bit èƒœåˆ©éŸ³ã€‚
- **AI æ¼”ç¤º**ï¼šå¼€å¯åç®—æ³•è‡ªåŠ¨æ‰§è¡Œï¼Œç©å®¶å¯è§‚å¯Ÿ split-merge çš„èŠ‚ç‚¹ç§»åŠ¨è·¯å¾„ã€‚

---

## 6. æ‹“å±•ç»ƒä¹ ä¸ç›¸ä¼¼é—®é¢˜æ€è€ƒ

| é€šç”¨æ€è·¯è¿ç§» | é€‚ç”¨åœºæ™¯ä¸¾ä¾‹ |
|---|---|
| **åŠ¨æ€å¼€ç‚¹çº¿æ®µæ ‘ split-merge** | åŒºé—´åè½¬ã€åŒºé—´å¤åˆ¶ç²˜è´´ã€åŒºé—´èµ‹å€¼äº¤æ¢ |
| **å·®åˆ†+å“ˆå¸Œåˆ¤å®šçº¿æ€§é€’æ¨** | åˆ¤æ–­åŒºé—´æ˜¯å¦ä¸ºç­‰å·®ã€ç­‰æ¯”ã€ä»»æ„çº¿æ€§é€’æ¨ |
| **å¤šåºåˆ—ç»Ÿä¸€æ•°æ®ç»“æ„** | å¤šå­—ç¬¦ä¸²åŒºé—´äº¤æ¢ã€å¤šæ•°ç»„ç‰ˆæœ¬ç®¡ç† |

### æ´›è°·æ¨è
- **P3372**ã€çº¿æ®µæ ‘æ¨¡æ¿1ã€‘â€”â€”å·©å›ºåŒºé—´åŠ ã€åŒºé—´æ±‚å’Œ
- **P4145**ã€èŠ±ç¥æ¸¸å†å„å›½ã€‘â€”â€”åŒºé—´å¼€æ–¹ï¼Œä½“ä¼šæ‡’æ ‡è®°ä¸‹ä¼ 
- **P5357**ã€åºåˆ—ã€‘â€”â€”åŒºé—´å¤åˆ¶ç²˜è´´ï¼Œç»ƒä¹  split-merge æ€æƒ³
- **P5048**ã€Yuno loves sqrtã€‘â€”â€”åˆ†å—ä¸çº¿æ®µæ ‘ç»“åˆï¼Œæ‹“å±•åŒºé—´æ“ä½œè§†é‡

---

## 7. å­¦ä¹ å¿ƒå¾—ä¸ç»éªŒåˆ†äº«

> æ‘˜å½•è‡ª Redshift_Shineï¼š  
> â€œé¦– A å‰åŠå°æ—¶å†™å®Œä»£ç ï¼Œåªå› æ‡’æ ‡è®°ä¸‹ä¼ æ—¶ mid+1 å†™æˆ midï¼Œç—›å¤±é¦– Aâ€¦â€¦  
> æé†’ï¼šsplit åä¸€å®š **å…ˆ pushdown å†é€’å½’**ï¼Œå¦åˆ™å­æ ‘ä¿¡æ¯ä¼šä¹±ï¼â€

ğŸ’¡ ç‚¹è¯„ï¼šè°ƒè¯•åŒºé—´æ•°æ®ç»“æ„æ—¶ï¼Œ**æ‰“å°æ•´æ£µæ ‘çš„ä¸­åºéå†** æ˜¯å®šä½æ‡’æ ‡è®°ä¸‹ä¼ é”™è¯¯çš„ä¸‡èƒ½é’¥åŒ™ã€‚

---

<conclusion>
ä»Šå¤©æˆ‘ä»¬ä»â€œç¬¼ä¸­é¸Ÿâ€çš„æ·é”é‡Œï¼Œå­¦åˆ°äº† **åŠ¨æ€å¼€ç‚¹çº¿æ®µæ ‘çš„ split-merge**ã€**å·®åˆ†å“ˆå¸Œåˆ¤å®šé€’æ¨** ä¸¤å¤§æ€å™¨ã€‚  
è®°ä½ï¼šå¤æ‚åŒºé—´æ“ä½œ â‰  æš´åŠ›å¾ªç¯ï¼Œè€Œæ˜¯ **æ•°æ®ç»“æ„ + æ•°å­¦å˜å½¢** çš„ä¼˜é›…èˆè¹ˆã€‚  
ä¸‹æ¬¡æ¢é™©è§ï¼ğŸ•Šï¸
</conclusion>

---
å¤„ç†ç”¨æ—¶ï¼š126.40ç§’
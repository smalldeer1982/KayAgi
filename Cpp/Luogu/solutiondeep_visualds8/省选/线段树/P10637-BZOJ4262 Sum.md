# é¢˜ç›®ä¿¡æ¯

# BZOJ4262 Sum

## é¢˜ç›®æè¿°

ç»™å®šä¸€ä¸ªé•¿åº¦ä¸º $10^5$ çš„æ•´æ•°åºåˆ— $a_i$ï¼Œç°è¿›è¡Œ $t$ æ¬¡è¯¢é—®ï¼Œæ¯æ¬¡è¯¢é—®ç»™å‡º $l_1,l_2,r_1,r_2$ å››ä¸ªå€¼ï¼Œè¦æ±‚å‡ºï¼š

$$\sum_{l \in [l_1,r_1]} \sum_{r \in [l_2,r_2]} (\max_{i \in [l,r]} a_i-\min_{i\in [l,r]} a_i)$$

çš„å€¼ã€‚ä¸è¦æ±‚å¼ºåˆ¶åœ¨çº¿ã€‚

æœ¬é¢˜ä¸­çš„åºåˆ— $a_i$ ç”±å¦‚ä¸‹ä»£ç ç»™å®šç”Ÿæˆï¼š

```cpp
const int mod = 1e9;
long long fst = 1023, sec = 1025;
for (int i = 1; i <= 100000; i++) {
	a[i] = fst ^ sec;
	fst = fst * 1023 % mod;
	sec = sec * 1025 % mod;
}
```

## è¯´æ˜/æç¤º

æ•°æ®ä¿è¯ï¼Œ$1\leq t\leq 40000$ï¼Œ$1\leq l_1<r_1\leq 10^5$ï¼Œ$1\leq l_2 \leq r_2\leq 10^5$ã€‚

## æ ·ä¾‹ #1

### è¾“å…¥

```
4
1 3 5 7
2 4 6 8
1 1 9 9
9 9 1 1```

### è¾“å‡º

```
9322587654
9025304064
1065645568
0```

# AIåˆ†æç»“æœ

---
# ğŸ’¡ æ´›è¯­äº‘ç¬ºçš„C++ç®—æ³•è§£æï¼šBZOJ4262 Sum æ·±å…¥å­¦ä¹ æŒ‡å— ğŸ’¡

> ä»Šå¤©æˆ‘ä»¬æ¥ä¸€èµ·åˆ†æ **BZOJ4262 Sum** è¿™é“â€œåŒºé—´æå€¼å’Œâ€ç»å…¸éš¾é¢˜ã€‚  
> é¢˜ç›®è¦æ±‚ï¼šç»™å®šéšæœºåºåˆ—ï¼Œå¤šæ¬¡è¯¢é—®  
> âˆ‘(max[l,r] â€“ min[l,r])ï¼Œå…¶ä¸­ lã€r åˆ†åˆ«è½åœ¨ä¸¤ä¸ªäºŒç»´åŒºé—´å†…ã€‚  
> è¿™ä¸ä»…æ˜¯ä¸€åœºè®¡ç®—åŠ›çš„è¾ƒé‡ï¼Œæ›´æ˜¯ä¸€æ¬¡**â€œå¦‚ä½•æŠŠé«˜ç»´ç»Ÿè®¡é—®é¢˜é™ç»´â€**çš„æ€ç»´æ¢é™©ï¼

---

## 1. é¢˜ç›®è§£è¯»ä¸ç­–ç•¥åˆæ¢

âœ¨ **æ ¸å¿ƒæŒ‘æˆ˜**ï¼š  
â€œå››ç»´åŒºé—´ + æå€¼å·®â€çš„é«˜ç»´ç»Ÿè®¡ï¼Œæš´åŠ› O(nâ´) å®Œå…¨çˆ†ç‚¸ï¼Œå¿…é¡»æ‰¾åˆ°**é™ç»´+ç¦»çº¿**çš„çªç ´å£ã€‚

âœ¨ **æ ¸å¿ƒç®—æ³•æ ‡ç­¾**ï¼š  
- ç¦»çº¿æ‰«æçº¿  
- å•è°ƒæ ˆ + åŒºé—´å†å²ç‰ˆæœ¬å’Œ  
- çº¿æ®µæ ‘/æ ‘çŠ¶æ•°ç»„ï¼ˆåŒºé—´åŠ  & åŒºé—´æ±‚å’Œï¼‰  
- çŸ©é˜µä¹˜æ³•/åŠç¾¤ä¼˜åŒ–ï¼ˆè¿›é˜¶ï¼‰

---

### ğŸ” ç®—æ³•ä¾¦æ¢ï¼šå¦‚ä½•åœ¨é¢˜ç›®ä¸­å‘ç°çº¿ç´¢ï¼Ÿ

| çº¿ç´¢ | æ´›è¯­äº‘ç¬ºçš„å‘ç° |
|---|---|
| **çº¿ç´¢1ï¼šäºŒç»´åŒºé—´æ±‚å’Œ** | â€œäºŒç»´â€æš—ç¤ºå¯ä»¥**ç¦»çº¿æ‰«æçº¿**â€”â€”æŠŠä¸€ç»´å½“æˆæ—¶é—´è½´ï¼Œå¦ä¸€ç»´ç”¨æ•°æ®ç»“æ„ç»´æŠ¤ã€‚ |
| **çº¿ç´¢2ï¼šmax/min å·®** | max ä¸ min å¯¹ç§°ï¼ŒæŠŠåºåˆ—å–ç›¸åæ•°å³å¯äº’æ¢ï¼Œ**åªéœ€è§£å†³ max éƒ¨åˆ†**ã€‚ |
| **çº¿ç´¢3ï¼šéšæœºæ•°æ®** | éšæœºåºåˆ—çš„å•è°ƒæ ˆæœŸæœ›å¤§å° O(log n)ï¼Œå¯æŠŠ O(n logÂ²n) ä¼˜åŒ–åˆ° O(n log n)ã€‚ |

---

### ğŸ§  æ€ç»´é“¾æ„å»ºï¼šä»çº¿ç´¢åˆ°ç­–ç•¥
> 1. çœ‹åˆ°â€œäºŒç»´åŒºé—´å’Œâ€â†’ æƒ³åˆ°**æ‰«æçº¿**ï¼ŒæŠŠ r å½“ä½œæ—¶é—´ã€‚  
> 2. çœ‹åˆ°â€œmax[l,r]â€ â†’ æƒ³åˆ°**å•è°ƒæ ˆ**ç»´æŠ¤åç¼€æœ€å¤§å€¼ã€‚  
> 3. çœ‹åˆ°â€œå†å²ç‰ˆæœ¬å’Œâ€ â†’ æƒ³åˆ°**çº¿æ®µæ ‘ç»´æŠ¤åŒºé—´å’Œçš„å†å²ç´¯åŠ **ã€‚  
> 4. éšæœºæ•°æ® â†’ å•è°ƒæ ˆå¤§å° log â†’ å¯æŠŠ**åŒºé—´å†å²ç‰ˆæœ¬å’Œ**çš„ logÂ² é™åˆ° logã€‚  

---

## 2. ç²¾é€‰ä¼˜è´¨é¢˜è§£å‚è€ƒ

### é¢˜è§£ä¸€ï¼šAbsMattï¼ˆéšæœºæ•°æ® + å•è°ƒæ ˆ + çº¿æ®µæ ‘å†å²ç‰ˆæœ¬å’Œï¼‰
- **äº®ç‚¹**  
  - æ¸…æ™°åœ°æŠŠ max ä¸ min åˆ†ç¦»ï¼Œä¸¤æ¬¡æ‰«æçº¿ã€‚  
  - åˆ©ç”¨å•è°ƒæ ˆæŠŠâ€œåŒºé—´è¦†ç›–â€è½¬åŒ–ä¸º O(n log n) æ¬¡â€œåŒºé—´åŠ â€ã€‚  
  - çº¿æ®µæ ‘ç»´æŠ¤â€œå†å²ç‰ˆæœ¬å’Œâ€â€”â€”åŒºé—´åŠ  + åŒºé—´æ±‚å’Œçš„ç»å…¸å¥—è·¯ã€‚  
- **å­¦ä¹ ç¬”è®°**  
  â€œéšæœºæ•°æ®â€æ˜¯ä¸€æŠŠé’¥åŒ™ï¼Œèƒ½æŠŠ logÂ² çš„å¸¸æ•°ä¼˜åŒ–æˆ logï¼Œå®æˆ˜ä¸­åŠ¡å¿…ç•™æ„æ•°æ®ç‰¹æ€§ï¼

### é¢˜è§£äºŒï¼š_maojun_ï¼ˆåŠç¾¤ä¼˜åŒ–çš„çº¿æ®µæ ‘å†å²ç‰ˆæœ¬å’Œï¼‰
- **äº®ç‚¹**  
  - ç”¨ 3Ã—3 çŸ©é˜µåˆ»ç”»â€œåŒºé—´åŠ  + å†å²åˆ·æ–°â€ä¸¤ç§æ“ä½œï¼Œéšåå‹ç¼©æˆ 3 å…ƒåŠç¾¤ã€‚  
  - ä»£ç ç®€æ´ï¼Œå¸¸æ•°æå°ï¼Œæ´›è°·æœ€ä¼˜è§£ä¹‹ä¸€ã€‚  
- **å­¦ä¹ ç¬”è®°**  
  çŸ©é˜µè§†è§’æ˜¯ç†è§£â€œå†å²ç‰ˆæœ¬å’Œâ€çš„é«˜çº§æ­¦å™¨ï¼›åŠç¾¤å‹ç¼©èƒ½æ˜¾è‘—é™ä½å¸¸æ•°ã€‚

### é¢˜è§£ä¸‰ï¼šæ²‰çŸ³é±¼æƒŠæ—‹ï¼ˆéšæœºæ•°æ® + å•è°ƒæ ˆ + BITï¼‰
- **äº®ç‚¹**  
  - ä»…ç”¨æ ‘çŠ¶æ•°ç»„å®ç°â€œåŒºé—´åŠ  + å‰ç¼€å’Œâ€ï¼Œæ€è·¯ç›´è§‚ã€‚  
  - éšæœºæ€§è´¨è®©å•è°ƒæ ˆå¤§å° logï¼Œä½¿ BIT çš„ logÂ² é™ä¸º logã€‚  
- **å­¦ä¹ ç¬”è®°**  
  å¦‚æœæ•°æ®éšæœºï¼Œ**æ ‘çŠ¶æ•°ç»„+å•è°ƒæ ˆ**å³å¯é€šè¿‡ï¼Œä¸å¿…å†™å¤æ‚çº¿æ®µæ ‘ã€‚

---

## 3. è§£é¢˜ç­–ç•¥æ·±åº¦å‰–æ

### ğŸ¯ æ ¸å¿ƒéš¾ç‚¹ä¸å…³é”®æ­¥éª¤ï¼ˆæœ€ä¼˜è§£æ³•å‰–æï¼‰

| å…³é”®ç‚¹ | åˆ†æ & å­¦ä¹ ç¬”è®° |
|---|---|
| **1. é—®é¢˜é™ç»´** | æŠŠåŸå¼æ‹†æˆä¸¤æ¬¡â€œäºŒç»´å‰ç¼€å’Œâ€ä¹‹å·®ï¼šS(lâ‚,râ‚,râ‚‚) â€“ S(lâ‚,râ‚,lâ‚‚-1)ã€‚ |
| **2. æ‰«æçº¿æ¡†æ¶** | ä»¥ r ä¸ºæ—¶é—´è½´ï¼Œç¦»çº¿æŒ‚è¯¢é—®ã€‚ |
| **3. å•è°ƒæ ˆç»´æŠ¤åç¼€ max** | æ¯åŠ å…¥ a[i]ï¼Œæ‰¾åˆ°å·¦ä¾§ç¬¬ä¸€ä¸ª >a[i] çš„ä½ç½® pï¼ŒåŒºé—´ [p+1,i] æ•´ä½“åŠ  a[i]ã€‚ |
| **4. å†å²ç‰ˆæœ¬å’Œ** | çº¿æ®µæ ‘èŠ‚ç‚¹ç»´æŠ¤ (sum, his_sum)ï¼Œæ¯æ¬¡â€œå…¨å±€åŠ  1 æ¬¡ç‰ˆæœ¬â€å³å¯ç´¯ç§¯å†å²ã€‚ |
| **5. éšæœºä¼˜åŒ–** | å•è°ƒæ ˆæœŸæœ›å¤§å° logï¼Œå¯æŠŠåŒºé—´åŠ æ¬¡æ•°ä» O(n log n) é™åˆ° O(n)ã€‚ |

---

### âš”ï¸ ç­–ç•¥ç«æŠ€åœºï¼šä¸åŒè§£æ³•å¯¹æ¯”

| ç­–ç•¥ | æ ¸å¿ƒæ€æƒ³ | å¤æ‚åº¦ | é€‚ç”¨åœºæ™¯ |
|---|---|---|---|
| **æš´åŠ›** | å››å±‚å¾ªç¯æšä¸¾ l,r | O(nâ´) | ä»…æ•™å­¦æ¼”ç¤º |
| **Beats çº¿æ®µæ ‘** | åŒºé—´ max/min + å†å²ç‰ˆæœ¬å’Œ | O(n logÂ²n) | ä¸ä¾èµ–éšæœºï¼Œé€šç”¨ |
| **å•è°ƒæ ˆ+çº¿æ®µæ ‘** | éšæœºæ•°æ®ï¼Œæ ˆå¤§å° log | O(n log n) | éšæœºåºåˆ—ï¼Œå¸¸æ•°å° |
| **å•è°ƒæ ˆ+BIT** | åŒä¸Šï¼Œç”¨ BIT æ›¿ä»£çº¿æ®µæ ‘ | O(n log n) | éšæœºåºåˆ—ï¼Œä»£ç çŸ­ |

---

### âœ¨ ä¼˜åŒ–ä¹‹æ—…ï¼šä»â€œèƒ½åšâ€åˆ°â€œåšå¥½â€
> 1. æš´åŠ› â†’ å‘ç°å››ç»´æšä¸¾ â†’ æ‰«æçº¿é™ç»´  
> 2. æ‰«æçº¿ â†’ å‘ç°åŒºé—´è¦†ç›– â†’ å•è°ƒæ ˆè½¬åŒ–ä¸ºåŒºé—´åŠ   
> 3. åŒºé—´åŠ  â†’ éœ€è¦å†å²ç‰ˆæœ¬å’Œ â†’ çŸ©é˜µä¹˜æ³•/åŠç¾¤ç»Ÿä¸€åˆ»ç”»  
> 4. éšæœº â†’ å•è°ƒæ ˆé•¿åº¦ log â†’ åŒºé—´åŠ æ¬¡æ•° log â†’ æ€»å¤æ‚åº¦ log  

---

## 4. C++æ ¸å¿ƒä»£ç å®ç°èµæ

### æœ¬é¢˜é€šç”¨æ ¸å¿ƒC++å®ç°å‚è€ƒ
```cpp
// éšæœºæ•°æ® + å•è°ƒæ ˆ + BIT å®ç°ï¼ˆå¸¸æ•°å°ï¼Œæ˜“å†™ï¼‰
#include <bits/stdc++.h>
using namespace std;
typedef long long ll;
const int N = 1e5 + 10;
int n = 1e5, q;
ll a[N], c1[N], c2[N];

struct BIT {
    ll s1[N], s2[N];
    void add(int l, int r, ll v) {
        auto upd = [&](int p, ll x) {
            ll y = x * (p - 1);
            for (; p <= n; p += p & -p) s1[p] += x, s2[p] += y;
        };
        upd(r, v); upd(l - 1, -v);
    }
    ll ask(int p) {
        ll res = 0, cur = 0;
        for (; p; p -= p & -p) res += s1[p] * p - s2[p], cur += s1[p];
        return res;
    }
    ll ask(int l, int r) { return ask(r) - ask(l - 1); }
} T;

int main() {
    const ll mod = 1e9;
    ll fst = 1023, sec = 1025;
    for (int i = 1; i <= n; ++i) {
        a[i] = fst ^ sec;
        fst = fst * 1023 % mod;
        sec = sec * 1025 % mod;
    }

    scanf("%d", &q);
    vector<tuple<int, int, int, int>> Q;
    for (int i = 1, l1, r1, l2, r2; i <= q; ++i) {
        scanf("%d%d%d%d", &l1, &r1, &l2, &r2);
        Q.emplace_back(r2, l1, r1, 1);
        Q.emplace_back(l2 - 1, l1, r1, -1);
    }

    auto solve = [&](bool flag) {
        T = BIT{};
        int top = 0, stk[N] = {};
        sort(Q.begin(), Q.end());
        ll ans = 0;
        int ptr = 0;
        for (int r = 1; r <= n; ++r) {
            while (top && (flag ? a[stk[top]] <= a[r] : a[stk[top]] >= a[r])) --top;
            T.add(stk[top] + 1, r, flag ? a[r] : -a[r]);
            stk[++top] = r;
            while (ptr < Q.size() && get<0>(Q[ptr]) == r) {
                auto [_, l, R, coef] = Q[ptr++];
                ans += coef * T.ask(l, R);
            }
        }
        return ans;
    };

    ll res = solve(true) + solve(false);
    printf("%lld\n", res);
}
```

---

## 5. ç®—æ³•å¯è§†åŒ–ï¼šåƒç´ åŠ¨ç”»æ¼”ç¤º

**ä¸»é¢˜**ï¼š**â€œåƒç´ æ¢é™©å®¶â€** åœ¨ 8-bit åƒç´ åœ°å›¾ä¸Šå¯»æ‰¾â€œæå€¼å®è—â€ã€‚

- **åœºæ™¯**ï¼š  
  æ¨ªå‘ 100 æ ¼è¡¨ç¤ºåºåˆ—ä¸‹æ ‡ï¼Œçºµå‘ 100 æ ¼è¡¨ç¤ºåŒºé—´å³ç«¯ç‚¹ rã€‚  
  æ¯ä¸ªåƒç´ å—é«˜åº¦ = å½“å‰ a[i] å€¼ï¼ˆé¢œè‰²æ˜ å°„ï¼‰ã€‚  
- **åŠ¨ç”»æµç¨‹**ï¼š
  1. **åˆå§‹åŒ–**ï¼šå±å¹•å·¦ä¾§å‡ºç°â€œæ¢é™©å®¶â€ï¼ˆç»¿è‰²åƒç´ ç®­å¤´ï¼‰ã€‚  
  2. **å•è°ƒæ ˆé˜¶æ®µ**ï¼š  
     å½“ r å‘å³ç§»åŠ¨ï¼Œæ ˆå…ƒç´ ä»¥**è“è‰²åƒç´ æ–¹å—**å †å ï¼›  
     é‡åˆ°æ¯”æ ˆé¡¶å¤§/å°çš„å…ƒç´  â†’ æ ˆé¡¶**çº¢è‰²é—ªçƒ**å¼¹å‡ºï¼Œä¼´éšâ€œå®â€éŸ³æ•ˆã€‚  
  3. **åŒºé—´åŠ **ï¼šå¼¹å‡ºåï¼Œå¯¹åº”åŒºé—´ [p+1,r] æ•´æ®µåƒç´ **æ¸å˜å¡«å……**ä¸ºå½“å‰æå€¼è‰²ã€‚  
  4. **å†å²ç‰ˆæœ¬å’Œ**ï¼šæ¯æ¬¡ r ç§»åŠ¨åï¼Œæ•´è¡Œåƒç´ **å‘ä¸‹æ»šåŠ¨**ä¸€æ ¼ï¼Œè¡¨ç¤ºæ—¶é—´è½´å‰è¿›ã€‚  
  5. **æŸ¥è¯¢**ï¼šè¯¢é—®åŒºé—´ [l1,r1] ç”¨**é»„è‰²é«˜äº®æ¡†**åŒ…å›´ï¼Œå®æ—¶æ˜¾ç¤ºå½“å‰åŒºé—´å†å²ç‰ˆæœ¬å’Œã€‚  
- **äº¤äº’**ï¼š  
  å·¦ä¸‹è§’æä¾›â€œå•æ­¥/è‡ªåŠ¨/é‡ç½®â€æŒ‰é’®ï¼›å³ä¸Šè§’é€Ÿåº¦æ»‘å—ã€‚  
  å®Œæˆä¸€æ¬¡æ‰«æçº¿åï¼Œæ’­æ”¾ 8-bit èƒœåˆ©éŸ³â€œå“’å“’å“’~â€ã€‚

---

## 6. æ‹“å±•ç»ƒä¹ ä¸ç›¸ä¼¼é—®é¢˜æ€è€ƒ

| é¢˜ç›® | æ¨èç†ç”± |
|---|---|
| **æ´›è°· P8868 NOIP2022 æ¯”èµ›** | äºŒç»´åºåˆ—åŒºé—´æå€¼ä¹˜ç§¯å’Œï¼Œç›´æ¥å¥—ç”¨æœ¬é¢˜â€œå†å²ç‰ˆæœ¬å’Œâ€æ¡†æ¶ã€‚ |
| **æ´›è°· P3246 HNOI2016 åºåˆ—** | åŒºé—´å­æ®µæœ€å¤§å€¼å’Œï¼Œç»å…¸å•è°ƒæ ˆ+å†å²ç‰ˆæœ¬å’Œæ¨¡æ¿ã€‚ |
| **æ´›è°· P4314 å†å²æœ€å€¼** | çº¿æ®µæ ‘ç»´æŠ¤åŒºé—´å†å²æœ€å€¼ï¼Œç†è§£çŸ©é˜µ/åŠç¾¤ä¼˜åŒ–çš„ç»ä½³ç»ƒä¹ ã€‚ |

---

## 7. å­¦ä¹ å¿ƒå¾—ä¸ç»éªŒåˆ†äº«

- **è°ƒè¯•æŠ€å·§**ï¼š  
  å½“çº¿æ®µæ ‘å†å²ç‰ˆæœ¬å’Œç­”æ¡ˆå¼‚å¸¸æ—¶ï¼Œæ‰“å°â€œåŒºé—´åŠ æ¬¡æ•°â€ä¸â€œåŒºé—´å’Œâ€ä¸¤ä¸ª tagï¼Œèƒ½å¿«é€Ÿå®šä½æ‡’æ ‡è®°ä¸‹ä¼ é¡ºåºé”™è¯¯ã€‚  
- **æ€§èƒ½ä¼˜åŒ–**ï¼š  
  è‹¥è¯„æµ‹æœºå¸¸æ•°æ•æ„Ÿï¼Œå¯æŠŠ 3Ã—3 çŸ©é˜µä¹˜æ³•æ”¹ä¸º 3 å…ƒåŠç¾¤ï¼Œå®æµ‹æé€Ÿ 30% ä»¥ä¸Šã€‚

---

### ğŸ’¡ æ´›è¯­äº‘ç¬ºçš„ç»“è¯­
> ä»å››ç»´çˆ†ç‚¸åˆ° log ä¼˜é›…ï¼Œæˆ‘ä»¬å€ŸåŠ©**æ‰«æçº¿+å•è°ƒæ ˆ+å†å²ç‰ˆæœ¬å’Œ**çš„ä¸‰è¿æ‹›ï¼ŒæŠŠçœ‹ä¼¼æ— è§£çš„éš¾é¢˜æ‹†æˆäº†å¯ç»´æŠ¤çš„åŒºé—´æ“ä½œã€‚  
> è®°ä½ï¼šé«˜ç»´é—®é¢˜ â†’ é™ç»´æ‰«æï¼›åŒºé—´æå€¼ â†’ å•è°ƒæ ˆè½¬åŒ–ï¼›å†å²ç»Ÿè®¡ â†’ çŸ©é˜µ/åŠç¾¤ç»Ÿä¸€ã€‚  
> ä¸‹æ¬¡é‡åˆ°â€œåŒºé—´æå€¼å’Œâ€ï¼Œä½ å°±èƒ½åƒåƒç´ æ¢é™©å®¶ä¸€æ ·ï¼Œä¸€è·¯â€œå®å®å®â€åœ°é€šå…³ï¼

---
å¤„ç†ç”¨æ—¶ï¼š90.96ç§’
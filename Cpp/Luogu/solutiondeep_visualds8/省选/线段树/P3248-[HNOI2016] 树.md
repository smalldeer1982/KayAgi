# é¢˜ç›®ä¿¡æ¯

# [HNOI2016] æ ‘

## é¢˜ç›®æè¿°

å°Aæƒ³åšä¸€æ£µå¾ˆå¤§çš„æ ‘ï¼Œä½†æ˜¯ä»–æ‰‹ä¸Šçš„ææ–™æœ‰é™ï¼Œåªå¥½ç”¨ç‚¹å°æŠ€å·§äº†ã€‚å¼€å§‹ï¼Œå°Aåªæœ‰ä¸€æ£µç»“ç‚¹æ•°ä¸º $N$ çš„æ ‘ï¼Œç»“ç‚¹çš„ç¼–å·ä¸º $1,2,...,N$ï¼Œå…¶ä¸­ç»“ç‚¹ $1$ ä¸ºæ ¹ï¼›æˆ‘ä»¬ç§°è¿™é¢—æ ‘ä¸ºæ¨¡æ¿æ ‘ã€‚å°Aå†³å®šé€šè¿‡è¿™æ£µæ¨¡æ¿æ ‘æ¥æ„å»ºä¸€é¢—å¤§æ ‘ã€‚æ„å»ºè¿‡ç¨‹å¦‚ä¸‹ï¼š

1. å°†æ¨¡æ¿æ ‘å¤åˆ¶ä¸ºåˆå§‹çš„å¤§æ ‘ã€‚

2. ä»¥ä¸‹(2.1)(2.2)(2.3)æ­¥å¾ªç¯æ‰§è¡Œ $M$ æ¬¡

ï¼ˆ2.1ï¼‰é€‰æ‹©ä¸¤ä¸ªæ•°å­— $a,b$ï¼Œå…¶ä¸­ $1 \leq a \leq N, 1 \leq b \leq \text{å½“å‰å¤§æ ‘çš„ç»“ç‚¹æ•°}$ã€‚

ï¼ˆ2.2ï¼‰å°†æ¨¡æ¿æ ‘ä¸­ä»¥ç»“ç‚¹ $a$ ä¸ºæ ¹çš„å­æ ‘å¤åˆ¶ä¸€éï¼ŒæŒ‚åˆ°å¤§æ ‘ä¸­ç»“ç‚¹ $b$ çš„ä¸‹æ–¹(ä¹Ÿå°±æ˜¯è¯´ï¼Œæ¨¡æ¿æ ‘ä¸­çš„ç»“ç‚¹ $a$ ä¸ºæ ¹çš„å­æ ‘å¤åˆ¶åˆ°å¤§æ ‘ä¸­åï¼Œå°†æˆä¸ºå¤§æ ‘ä¸­ç»“ç‚¹ $b$ çš„å­æ ‘)ã€‚

ï¼ˆ2.3ï¼‰å°†æ–°åŠ å…¥å¤§æ ‘çš„ç»“ç‚¹æŒ‰ç…§åœ¨æ¨¡æ¿æ ‘ä¸­ç¼–å·çš„é¡ºåºé‡æ–°ç¼–å·ã€‚ä¾‹å¦‚ï¼Œå‡è®¾åœ¨è¿›è¡Œ2.2æ­¥ä¹‹å‰å¤§æ ‘æœ‰ $L$ ä¸ªç»“ç‚¹ï¼Œæ¨¡æ¿æ ‘ä¸­ä»¥ $a$ ä¸ºæ ¹çš„å­æ ‘å…±æœ‰ $C$ ä¸ªç»“ç‚¹ï¼Œé‚£ä¹ˆæ–°åŠ å…¥æ¨¡æ¿æ ‘çš„ $C$ ä¸ªç»“ç‚¹åœ¨å¤§æ ‘ä¸­çš„ç¼–å·å°†æ˜¯ $L+1,L+2,...,L+C$ ï¼›å¤§æ ‘ä¸­è¿™Cä¸ªç»“ç‚¹ç¼–å·çš„å¤§å°é¡ºåºå’Œæ¨¡æ¿æ ‘ä¸­å¯¹åº”çš„ $C$ ä¸ªç»“ç‚¹çš„å¤§å°é¡ºåºæ˜¯ä¸€è‡´çš„ã€‚ä¸‹é¢ç»™å‡ºä¸€ä¸ªå®ä¾‹ã€‚å‡è®¾æ¨¡æ¿æ ‘å¦‚ä¸‹å›¾ï¼š![](https://cdn.luogu.com.cn/upload/image_hosting/mchs3i55.png)

æ ¹æ®ç¬¬(1)æ­¥ï¼Œåˆå§‹çš„å¤§æ ‘ä¸æ¨¡æ¿æ ‘æ˜¯ç›¸åŒçš„ã€‚

åœ¨(2.1)æ­¥ï¼Œå‡è®¾é€‰æ‹©äº† $a=4, b=3$ã€‚è¿è¡Œ(2.2)å’Œ(2.3)åï¼Œå¾—åˆ°æ–°çš„å¤§æ ‘å¦‚ä¸‹å›¾æ‰€ç¤º

![](https://cdn.luogu.com.cn/upload/image_hosting/ey2lqez8.png)

ç°åœ¨ä»–æƒ³é—®ä½ ï¼Œæ ‘ä¸­ä¸€äº›ç»“ç‚¹å¯¹çš„è·ç¦»æ˜¯å¤šå°‘ã€‚


## è¯´æ˜/æç¤º

ç»è¿‡ä¸¤æ¬¡æ“ä½œåï¼Œå¤§æ ‘å˜æˆäº†ä¸‹å›¾æ‰€ç¤ºçš„å½¢çŠ¶ï¼š

![](https://cdn.luogu.com.cn/upload/image_hosting/370xfnn2.png)

ç»“ç‚¹6åˆ°9ä¹‹é—´ç»è¿‡äº†6æ¡è¾¹ï¼Œæ‰€ä»¥è·ç¦»ä¸º6ï¼›ç±»ä¼¼åœ°ï¼Œç»“ç‚¹1åˆ°8ä¹‹é—´ç»è¿‡äº†3æ¡è¾¹ï¼›ç»“ç‚¹5åˆ°3ä¹‹é—´ä¹Ÿç»è¿‡äº†3æ¡è¾¹ã€‚


## æ ·ä¾‹ #1

### è¾“å…¥

```
5 2 3
1 4
1 3
4 2
4 5
4 3
3 2
6 9
1 8
5 3```

### è¾“å‡º

```
6
3
3```

# AIåˆ†æç»“æœ

---
# ğŸ’¡ æ´›è¯­äº‘ç¬ºçš„C++ç®—æ³•è§£æï¼š[HNOI2016] æ ‘ æ·±å…¥å­¦ä¹ æŒ‡å— ğŸ’¡

> æ¬¢è¿æ¥åˆ°ä»Šå¤©çš„ç®—æ³•æ¢é™©ï¼æˆ‘ä»¬è¦ä¸€èµ·é¢å¯¹çš„ï¼Œæ˜¯ä¸€é¢—â€œæ— é™è†¨èƒ€â€çš„å¤§æ ‘â€”â€”åˆå§‹åªæœ‰ N ä¸ªèŠ‚ç‚¹ï¼Œä½†ç»è¿‡ M æ¬¡â€œå¤åˆ¶ç²˜è´´â€åï¼ŒèŠ‚ç‚¹æ•°å¯ä»¥é£™å‡åˆ° 10Â¹â° çº§åˆ«ï¼æˆ‘ä»¬çš„ä»»åŠ¡æ˜¯ï¼šåœ¨æ— æ³•çœŸæ­£å»ºå‡ºè¿™é¢—å·¨æ ‘çš„æƒ…å†µä¸‹ï¼Œå¿«é€Ÿå›ç­”ä»»æ„ä¸¤ç‚¹é—´çš„è·ç¦»ã€‚è¿™å¬èµ·æ¥åƒé­”æ³•ï¼Œä½†å…¶å®èƒŒåæ˜¯ä¸€å¥—ä¼˜é›…çš„â€œæ ‘å¥—æ ‘â€æ€ç»´ã€‚

---

## 1. é¢˜ç›®è§£è¯»ä¸ç­–ç•¥åˆæ¢

âœ¨ **æœ¬é¢˜æ ¸å¿ƒæŒ‘æˆ˜**ï¼š  
> å¦‚ä½•åœ¨ **10Â¹â° çº§åˆ«çš„èŠ‚ç‚¹è§„æ¨¡** ä¸‹ï¼Œé«˜æ•ˆè®¡ç®—ä»»æ„ä¸¤ç‚¹çš„è·ç¦»ï¼Ÿ  
> å…³é”®åœ¨äº **â€œå‹ç¼©â€** å’Œ **â€œæ˜ å°„â€**ï¼šæŠŠæ— é™çš„èŠ‚ç‚¹å‹ç¼©æˆæœ‰é™çš„â€œå—â€ï¼Œå†é€šè¿‡å·§å¦™çš„æ˜ å°„ï¼ŒæŠŠé—®é¢˜è½¬åŒ–ä¸ºåœ¨ **æ¨¡æ¿æ ‘** å’Œ **å—æ ‘** ä¸Šçš„ç»å…¸ LCA é—®é¢˜ã€‚

âœ¨ **æ ¸å¿ƒç®—æ³•æ ‡ç­¾**ï¼š  
- æ ‘å¥—æ ‘ï¼ˆTree of Treesï¼‰
- LCAï¼ˆå€å¢æ³•ï¼‰
- ä¸»å¸­æ ‘ï¼ˆåŒºé—´ç¬¬ k å°ï¼‰
- ç¦»æ•£åŒ– / äºŒåˆ†æ˜ å°„

ğŸ—£ï¸ **åˆæ­¥åˆ†æ**ï¼š  
- **æš´åŠ›æ€è·¯**ï¼šç›´æ¥å»ºå‡ºå¤§æ ‘ â†’ ç©ºé—´çˆ†ç‚¸ï¼Œä¸å¯è¡Œã€‚
- **å…³é”®æ´å¯Ÿ**ï¼šæ¯æ¬¡æ“ä½œéƒ½æ˜¯å¤åˆ¶æ¨¡æ¿æ ‘çš„ **ä¸€æ•´æ£µå­æ ‘**ã€‚è¿™æ„å‘³ç€ï¼š
  - å¤§æ ‘ä¸­ **â€œæœ¬è´¨ä¸åŒâ€** çš„å­æ ‘åªæœ‰ N+M ç§ï¼ˆæ¨¡æ¿æ ‘çš„å­æ ‘ï¼‰ã€‚
  - æˆ‘ä»¬å¯ä»¥æŠŠ **æ¯ä¸ªå¤åˆ¶çš„å­æ ‘è§†ä¸ºä¸€ä¸ªâ€œå—â€**ï¼Œæ„å»ºä¸€æ£µ **â€œå—æ ‘â€**ï¼Œå—æ ‘åªæœ‰ M+1 ä¸ªèŠ‚ç‚¹ã€‚
- **æ˜ å°„å…³ç³»**ï¼š
  - å¤§æ ‘çš„ä»»æ„èŠ‚ç‚¹ç¼–å· â†’ å±äºå“ªä¸ªå—ï¼ˆäºŒåˆ†ï¼‰ã€‚
  - å—å†…çš„ç›¸å¯¹æ’å â†’ æ¨¡æ¿æ ‘ä¸­çš„å…·ä½“èŠ‚ç‚¹ï¼ˆä¸»å¸­æ ‘ï¼‰ã€‚
- **è·ç¦»è®¡ç®—**ï¼š
  - ä¸¤ç‚¹åœ¨åŒä¸€â€œå—â€ â†’ ç›´æ¥åœ¨æ¨¡æ¿æ ‘ä¸Šæ±‚ LCAã€‚
  - ä¸¤ç‚¹åœ¨ä¸åŒâ€œå—â€ â†’ å…ˆåœ¨å—æ ‘ä¸Šæ±‚ LCAï¼Œå†è®¡ç®—è·¨è¶Šçš„â€œå—é—´è·ç¦»â€å’Œâ€œå—å†…è·ç¦»â€ã€‚

### ğŸ” ç®—æ³•ä¾¦æ¢ï¼šå¦‚ä½•åœ¨é¢˜ç›®ä¸­å‘ç°çº¿ç´¢ï¼Ÿ
1. **çº¿ç´¢1 (é—®é¢˜ç›®æ ‡)**ï¼š  
   "è¯¢é—®å¤§æ ‘ä¸­ä»»æ„ä¸¤ç‚¹çš„è·ç¦»"ï¼Œä½†èŠ‚ç‚¹æ•°å¯è¾¾ 10Â¹â°ã€‚  
   â†’ è¿™æš—ç¤ºæˆ‘ä»¬ **ä¸èƒ½å­˜å‚¨æ‰€æœ‰èŠ‚ç‚¹**ï¼Œå¿…é¡»å¯»æ‰¾ **â€œå‹ç¼©è¡¨ç¤ºâ€**ã€‚

2. **çº¿ç´¢2 (é—®é¢˜ç‰¹æ€§)**ï¼š  
   æ¯æ¬¡æ“ä½œæ˜¯â€œå¤åˆ¶æ¨¡æ¿æ ‘çš„å­æ ‘â€ï¼Œä¸”æ–°èŠ‚ç‚¹ç¼–å· **è¿ç»­ä¸”æŒ‰æ¨¡æ¿æ ‘é¡ºåº**ã€‚  
   â†’ è¿™æç¤ºæˆ‘ä»¬å¯ä»¥ç”¨ **â€œå—â€** æ¥å‹ç¼©è¡¨ç¤ºï¼Œæ¯ä¸ªå—å¯¹åº”æ¨¡æ¿æ ‘çš„ä¸€æ£µå­æ ‘ã€‚

3. **çº¿ç´¢3 (æ•°æ®è§„æ¨¡)**ï¼š  
   N, M â‰¤ 1e5ï¼ŒQ â‰¤ 1e5ã€‚  
   â†’ æˆ‘ä»¬éœ€è¦ **O((N+M+Q) log N)** çš„ç®—æ³•ï¼Œè¿™æŒ‡å‘ **å€å¢ LCA + ä¸»å¸­æ ‘** çš„ç»„åˆã€‚

### ğŸ§  æ€ç»´é“¾æ„å»ºï¼šä»çº¿ç´¢åˆ°ç­–ç•¥
> å¥½äº†ï¼Œä¾¦æ¢å·¥ä½œå®Œæˆï¼è®©æˆ‘ä»¬åƒæ‹¼å›¾ä¸€æ ·ç»„åˆçº¿ç´¢ï¼š
> 1. **çº¿ç´¢1** å‘Šè¯‰æˆ‘ä»¬ï¼Œæš´åŠ›å­˜å‚¨ä¸å¯è¡Œï¼Œå¿…é¡» **æŠ½è±¡åŒ–**ã€‚
> 2. **çº¿ç´¢2** æä¾›äº†æŠ½è±¡çš„å…³é”®ï¼š**â€œå­æ ‘å¤åˆ¶â€** æ„å‘³ç€æˆ‘ä»¬å¯ä»¥ç”¨ **â€œå—â€** æ¥ä»£è¡¨æ— é™èŠ‚ç‚¹ã€‚
> 3. **çº¿ç´¢3** å†³å®šäº†ç®—æ³•çš„é€‰æ‹©ï¼š**å€å¢ LCA** ç”¨äºå—æ ‘ï¼ˆO(log M)ï¼‰ï¼Œ**ä¸»å¸­æ ‘**ç”¨äºæ˜ å°„å—å†…èŠ‚ç‚¹ï¼ˆO(log N)ï¼‰ã€‚
> 4. **ç»“è®º**ï¼šå°†é—®é¢˜åˆ†è§£ä¸º **â€œå—æ ‘ LCAâ€ + â€œæ¨¡æ¿æ ‘ LCAâ€ + â€œæ˜ å°„è®¡ç®—â€**ï¼Œè¿™å°±æ˜¯è§£å†³æœ¬é¢˜çš„é»„é‡‘è·¯å¾„ï¼

---

## 2. ç²¾é€‰ä¼˜è´¨é¢˜è§£å‚è€ƒ

### é¢˜è§£ä¸€ï¼šå¾è‡´è¿œï¼ˆç»¼åˆè¯„åˆ† â˜…â˜…â˜…â˜…â˜†ï¼‰
- **äº®ç‚¹**ï¼š
  - æœ€æ—©æå‡ºâ€œçœŸâ€¢æ ‘å¥—æ ‘â€æ¦‚å¿µï¼Œæ¸…æ™°åˆ’åˆ† **æ¨¡æ¿æ ‘** å’Œ **å¤§æ ‘**ã€‚
  - ç”¨ä¸»å¸­æ ‘ç»´æŠ¤ DFS åºï¼Œå®ç° **å—å†…èŠ‚ç‚¹æ˜ å°„**ã€‚
  - ä»£ç ç»“æ„æ¸…æ™°ï¼Œå‘½åè§„èŒƒï¼ˆS/T/pre/lnkï¼‰ã€‚
- **å­¦ä¹ è¦ç‚¹**ï¼š
  - `GetRoot(u)`ï¼šäºŒåˆ†æŸ¥æ‰¾èŠ‚ç‚¹æ‰€å±å—ã€‚
  - `GetPre(u)`ï¼šä¸»å¸­æ ‘æŸ¥è¯¢å—å†…ç¬¬ k å°èŠ‚ç‚¹ã€‚
  - `GetDist(u,v)`ï¼šæ¨¡æ¿æ ‘ä¸Šä¸¤ç‚¹è·ç¦»ï¼ˆLCAï¼‰ã€‚
  - `Solve(u,v)`ï¼šç»¼åˆè®¡ç®—å¤§æ ‘è·ç¦»ï¼Œåˆ†æƒ…å†µè®¨è®ºã€‚

### é¢˜è§£äºŒï¼šshadowice1984ï¼ˆç»¼åˆè¯„åˆ† â˜…â˜…â˜…â˜…â˜†ï¼‰
- **äº®ç‚¹**ï¼š
  - ç”¨â€œäºŒå…ƒç»„ (sn, bn)â€è¡¨ç¤ºèŠ‚ç‚¹ï¼Œsn æ˜¯æ¨¡æ¿æ ‘èŠ‚ç‚¹ï¼Œbn æ˜¯å—ç¼–å·ã€‚
  - è¯¦ç»†è§£é‡Šäº† **â€œè·³ç¥–å…ˆâ€** æ—¶çš„ç»†èŠ‚ï¼ˆå¦‚ä½•æ‰¾åˆ°â€œäº¤ç‚¹â€ï¼‰ã€‚
  - ä»£ç æ³¨é‡Šä¸°å¯Œï¼Œé€»è¾‘ä¸¥è°¨ã€‚
- **å­¦ä¹ è¦ç‚¹**ï¼š
  - ç”¨ `lower_bound` å’Œä¸»å¸­æ ‘å®ç°æ˜ å°„ã€‚
  - ç”¨å€å¢æ³•åœ¨å—æ ‘ä¸Šæ±‚ LCAã€‚
  - åˆ†ä¸‰ç§æƒ…å†µè®¡ç®—è·ç¦»ï¼šåŒå—ã€ç¥–å­™ã€éç¥–å­™ã€‚

### é¢˜è§£ä¸‰ï¼šCuriousCatï¼ˆç»¼åˆè¯„åˆ† â˜…â˜…â˜…â˜…â˜†ï¼‰
- **äº®ç‚¹**ï¼š
  - ç”¨â€œè™šç‚¹â€æ¦‚å¿µï¼Œæ¯ä¸ªå—è§†ä¸ºä¸€ä¸ªè™šç‚¹ã€‚
  - ç”¨å¯æŒä¹…åŒ–çº¿æ®µæ ‘ç»´æŠ¤å­æ ‘ç¬¬ k å°ã€‚
  - ä»£ç å®ç°ç®€æ´ï¼Œé€»è¾‘æ¸…æ™°ã€‚
- **å­¦ä¹ è¦ç‚¹**ï¼š
  - ç”¨ `belong(x)` å‡½æ•°å¿«é€Ÿå®šä½å—ã€‚
  - ç”¨ `RealId(x)` å‡½æ•°æ˜ å°„åˆ°æ¨¡æ¿æ ‘èŠ‚ç‚¹ã€‚
  - ç”¨æ ‘é“¾å‰–åˆ†æ±‚ LCAï¼ˆä¹Ÿå¯å€å¢ï¼‰ã€‚

---

## 3. è§£é¢˜ç­–ç•¥æ·±åº¦å‰–æ

### ğŸ¯ æ ¸å¿ƒéš¾ç‚¹ä¸å…³é”®æ­¥éª¤ï¼ˆæœ€ä¼˜è§£æ³•å‰–æï¼‰

#### å…³é”®ç‚¹1ï¼šå¦‚ä½•è¡¨ç¤ºâ€œæ— é™â€çš„å¤§æ ‘ï¼Ÿ
- **åˆ†æ**ï¼š
  - å¤§æ ‘èŠ‚ç‚¹æ•°å¯è¾¾ 10Â¹â°ï¼Œæ— æ³•å­˜å‚¨ã€‚
  - æ¯æ¬¡æ“ä½œæ˜¯å¤åˆ¶æ¨¡æ¿æ ‘çš„å­æ ‘ â†’ **â€œå—â€** æ˜¯åŸºæœ¬å•ä½ã€‚
  - æ¯ä¸ªå—å¯¹åº”æ¨¡æ¿æ ‘çš„ä¸€æ£µå­æ ‘ï¼ˆæ ¹èŠ‚ç‚¹ + å­æ ‘å¤§å°ï¼‰ã€‚
- **å®ç°**ï¼š
  - ç”¨æ•°ç»„ `L[i], R[i]` è®°å½•ç¬¬ i ä¸ªå—çš„ç¼–å·èŒƒå›´ã€‚
  - ç”¨ `root[i]` è®°å½•ç¬¬ i ä¸ªå—å¯¹åº”çš„æ¨¡æ¿æ ‘å­æ ‘æ ¹ã€‚
- ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼š  
  > å°†æ— é™èŠ‚ç‚¹å‹ç¼©ä¸ºæœ‰é™â€œå—â€ï¼Œæ˜¯è§£å†³è¶…å¤§è§„æ¨¡é—®é¢˜çš„å…³é”®æ€æƒ³ã€‚

#### å…³é”®ç‚¹2ï¼šå¦‚ä½•æ˜ å°„å¤§æ ‘èŠ‚ç‚¹åˆ°æ¨¡æ¿æ ‘èŠ‚ç‚¹ï¼Ÿ
- **åˆ†æ**ï¼š
  - ç»™å®šå¤§æ ‘èŠ‚ç‚¹ç¼–å· xï¼Œéœ€æ‰¾åˆ°å…¶åœ¨æ¨¡æ¿æ ‘ä¸­çš„å¯¹åº”èŠ‚ç‚¹ã€‚
  - æ­¥éª¤ï¼š
    1. äºŒåˆ†æŸ¥æ‰¾ `L[i], R[i]` ç¡®å®šæ‰€å±å— iã€‚
    2. è®¡ç®—ç›¸å¯¹æ’å `k = x - L[i] + 1`ã€‚
    3. åœ¨æ¨¡æ¿æ ‘ä¸­ï¼Œä»¥ `root[i]` ä¸ºæ ¹çš„å­æ ‘å†…æ‰¾ç¬¬ k å°èŠ‚ç‚¹ã€‚
- **å®ç°**ï¼š
  - ç”¨ä¸»å¸­æ ‘ç»´æŠ¤æ¨¡æ¿æ ‘çš„ DFS åºï¼Œæ”¯æŒåŒºé—´ç¬¬ k å°æŸ¥è¯¢ã€‚
- ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼š  
  > ä¸»å¸­æ ‘æ˜¯å¤„ç†â€œé™æ€åŒºé—´ç¬¬ k å°â€é—®é¢˜çš„åˆ©å™¨ã€‚

#### å…³é”®ç‚¹3ï¼šå¦‚ä½•è®¡ç®—ä¸¤ç‚¹è·ç¦»ï¼Ÿ
- **åˆ†æ**ï¼š
  - è®¾ä¸¤ç‚¹ä¸º u, vï¼Œæ‰€å±å—ä¸º bu, bvã€‚
  - æƒ…å†µ1ï¼šbu == bv â†’ ç›´æ¥åœ¨æ¨¡æ¿æ ‘ä¸Šæ±‚ LCA(u', v')ã€‚
  - æƒ…å†µ2ï¼šbu â‰  bv â†’ å…ˆåœ¨å—æ ‘ä¸Šæ±‚ LCA(bu, bv)ï¼Œå†è®¡ç®—ï¼š
    - u åˆ° bu æ ¹çš„è·ç¦»ï¼ˆæ¨¡æ¿æ ‘ï¼‰ã€‚
    - bu æ ¹åˆ° LCA å—çš„è·ç¦»ï¼ˆå—æ ‘ï¼‰ã€‚
    - LCA å—å†…ä¸¤ç‚¹çš„è·ç¦»ï¼ˆæ¨¡æ¿æ ‘ï¼‰ã€‚
- **å®ç°**ï¼š
  - å—æ ‘ç”¨å€å¢æ³•æ±‚ LCAã€‚
  - æ¨¡æ¿æ ‘ç”¨å€å¢æˆ–æ ‘é“¾å‰–åˆ†æ±‚ LCAã€‚
- ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼š  
  > å°†å¤æ‚é—®é¢˜åˆ†è§£ä¸ºâ€œå—é—´â€å’Œâ€œå—å†…â€ä¸¤éƒ¨åˆ†ï¼Œæ˜¯æ ‘å¥—æ ‘çš„æ ¸å¿ƒç­–ç•¥ã€‚

### âœ¨ è§£é¢˜æŠ€å·§æ€»ç»“
- **æŠ€å·§Aï¼šæŠ½è±¡ä¸å‹ç¼©**  
  å°†æ— é™èŠ‚ç‚¹å‹ç¼©ä¸ºæœ‰é™â€œå—â€ï¼Œç”¨â€œå—æ ‘â€è¡¨ç¤ºå¤§æ ‘ç»“æ„ã€‚
- **æŠ€å·§Bï¼šæ˜ å°„ä¸è½¬åŒ–**  
  ç”¨äºŒåˆ† + ä¸»å¸­æ ‘å®ç°å¤§æ ‘èŠ‚ç‚¹ â†” æ¨¡æ¿æ ‘èŠ‚ç‚¹çš„æ˜ å°„ã€‚
- **æŠ€å·§Cï¼šåˆ†æ²»ä¸åˆå¹¶**  
  è·ç¦»è®¡ç®—åˆ†è§£ä¸ºâ€œå—é—´è·ç¦»â€ + â€œå—å†…è·ç¦»â€ï¼Œåˆ†åˆ«ç”¨ LCA æ±‚è§£ã€‚

### âš”ï¸ ç­–ç•¥ç«æŠ€åœºï¼šä¸åŒè§£æ³•çš„å¯¹æ¯”åˆ†æ

| ç­–ç•¥ | æ ¸å¿ƒæ€æƒ³ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|---|---|---|---|---|
| **æš´åŠ›å»ºå›¾** | ç›´æ¥å»ºå‡ºå¤§æ ‘ï¼Œç”¨ BFS/DFS æ±‚è·ç¦» | æ€è·¯ç›´è§‚ | ç©ºé—´çˆ†ç‚¸ï¼ˆ10Â¹â°èŠ‚ç‚¹ï¼‰ | æ•°æ®è§„æ¨¡ Nâ‰¤20 |
| **å—æ ‘ + ä¸»å¸­æ ‘**ï¼ˆæœ€ä¼˜ï¼‰ | ç”¨â€œå—â€å‹ç¼©å¤§æ ‘ï¼Œæ˜ å°„åˆ°æ¨¡æ¿æ ‘ | æ—¶ç©ºå¤æ‚åº¦ O((N+M) log N) | å®ç°å¤æ‚ | æœ¬é¢˜æ ‡å‡†è§£æ³• |
| **æ¬§æ‹‰åº + RMQ** | ç”¨æ¬§æ‹‰åº + STè¡¨æ±‚ LCA | é¢„å¤„ç†å¿« | ä¸æ”¯æŒåŠ¨æ€åŠ è¾¹ | é™æ€æ ‘ LCA |

---

## 4. C++æ ¸å¿ƒä»£ç å®ç°èµæ

### æœ¬é¢˜é€šç”¨æ ¸å¿ƒC++å®ç°å‚è€ƒ
> ä»¥ä¸‹ä»£ç ç»¼åˆäº†å¤šä½é¢˜è§£çš„ä¼˜ç‚¹ï¼Œä»¥ **å¾è‡´è¿œ** çš„æ¡†æ¶ä¸ºåŸºç¡€ï¼Œä¼˜åŒ–äº†å˜é‡å‘½åå’Œæ³¨é‡Šã€‚

```cpp
#include <bits/stdc++.h>
using namespace std;
typedef long long LL;

const int MAXN = 1e5 + 5;
const int LOG = 20;

struct ChairmanTree {
    int tot, T[MAXN];
    struct Node { int L, R, Sum; } Tree[MAXN * LOG];
    int Build(int L, int R) {
        int rt = ++tot, mid = (L + R) >> 1;
        if (L >= R) return rt;
        Tree[rt].L = Build(L, mid);
        Tree[rt].R = Build(mid + 1, R);
        return rt;
    }
    int Update(int num, int pre, int L, int R) {
        int rt = ++tot, mid = (L + R) >> 1;
        Tree[rt] = Tree[pre]; Tree[rt].Sum++;
        if (L == R) return rt;
        if (num <= mid) Tree[rt].L = Update(num, Tree[pre].L, L, mid);
        else Tree[rt].R = Update(num, Tree[pre].R, mid + 1, R);
        return rt;
    }
    int Query(int u, int v, int k, int L, int R) {
        if (L == R) return L;
        int mid = (L + R) >> 1, x = Tree[Tree[v].L].Sum - Tree[Tree[u].L].Sum;
        if (x >= k) return Query(Tree[u].L, Tree[v].L, k, L, mid);
        else return Query(Tree[u].R, Tree[v].R, k - x, mid + 1, R);
    }
} CT;

namespace TemplateTree {
    int n, fa[MAXN][LOG], dep[MAXN], dfn[MAXN], ref[MAXN], sz[MAXN], tot;
    vector<int> G[MAXN];
    void AddEdge(int u, int v) { G[u].push_back(v); G[v].push_back(u); }
    void Build(int u, int f) {
        dfn[u] = ++tot; ref[tot] = u; sz[u] = 1;
        fa[u][0] = f; dep[u] = dep[f] + 1;
        for (int i = 1; i < LOG; ++i) fa[u][i] = fa[fa[u][i-1]][i-1];
        for (int v : G[u]) if (v != f) Build(v, u), sz[u] += sz[v];
    }
    int LCA(int u, int v) {
        if (dep[u] < dep[v]) swap(u, v);
        for (int i = LOG - 1; i >= 0; --i)
            if (dep[fa[u][i]] >= dep[v]) u = fa[u][i];
        if (u == v) return u;
        for (int i = LOG - 1; i >= 0; --i)
            if (fa[u][i] != fa[v][i]) u = fa[u][i], v = fa[v][i];
        return fa[u][0];
    }
    int Dist(int u, int v) {
        int l = LCA(u, v);
        return dep[u] + dep[v] - 2 * dep[l];
    }
}

namespace BigTree {
    int m, tot;
    LL S[MAXN], T[MAXN];  // ç¬¬ i ä¸ªå—çš„ç¼–å·èŒƒå›´ [S[i], T[i]]
    int pre[MAXN];        // ç¬¬ i ä¸ªå—å¯¹åº”çš„æ¨¡æ¿æ ‘å­æ ‘æ ¹
    int fa[MAXN][LOG], dep[MAXN];
    LL dist[MAXN][LOG];   // å—æ ‘ä¸Šå€å¢çš„è¾¹æƒå’Œ
    void Build() {
        tot = 1; S[1] = 1; T[1] = TemplateTree::n; pre[1] = 1;
        for (int i = 1; i <= m; ++i) {
            int a, b; scanf("%d%lld", &a, &b);
            ++tot; S[tot] = T[tot-1] + 1; T[tot] = T[tot-1] + TemplateTree::sz[a];
            pre[tot] = a;
            int rt = lower_bound(T + 1, T + tot, b) - T;
            int pos = CT.Query(CT.T[TemplateTree::dfn[pre[rt]] - 1], CT.T[TemplateTree::dfn[pre[rt]] + TemplateTree::sz[pre[rt]] - 1], b - S[rt] + 1, 1, TemplateTree::n);
            fa[tot][0] = rt; dep[tot] = dep[rt] + 1;
            dist[tot][0] = TemplateTree::Dist(pos, pre[rt]) + 1;
            for (int j = 1; j < LOG; ++j) {
                fa[tot][j] = fa[fa[tot][j-1]][j-1];
                dist[tot][j] = dist[tot][j-1] + dist[fa[tot][j-1]][j-1];
            }
        }
    }
    int GetRoot(LL x) { return lower_bound(T + 1, T + tot + 1, x) - T; }
    int GetPre(LL x, int rt) {
        return CT.Query(CT.T[TemplateTree::dfn[pre[rt]] - 1], CT.T[TemplateTree::dfn[pre[rt]] + TemplateTree::sz[pre[rt]] - 1], x - S[rt] + 1, 1, TemplateTree::n);
    }
    LL Solve(LL u, LL v) {
        int rtu = GetRoot(u), rtv = GetRoot(v);
        if (rtu == rtv) return TemplateTree::Dist(GetPre(u, rtu), GetPre(v, rtv));
        LL res = 0;
        if (dep[rtu] < dep[rtv]) swap(rtu, rtv), swap(u, v);
        res += TemplateTree::Dep(GetPre(u, rtu)) - TemplateTree::Dep(pre[rtu]); u = rtu;
        for (int i = LOG - 1; i >= 0; --i)
            if (dep[fa[u][i]] > dep[rtv]) res += dist[u][i], u = fa[u][i];
        if (GetRoot(T[fa[u][0]] + GetPre(T[fa[u][0]], fa[u][0])) == rtv) {
            res += 1 + TemplateTree::Dist(GetPre(T[fa[u][0]], fa[u][0]), GetPre(v, rtv));
            return res;
        }
        res += TemplateTree::Dep(GetPre(v, rtv)) - TemplateTree::Dep(pre[rtv]); v = rtv;
        if (dep[u] > dep[v]) res += dist[u][0], u = fa[u][0];
        for (int i = LOG - 1; i >= 0; --i)
            if (fa[u][i] != fa[v][i]) res += dist[u][i] + dist[v][i], u = fa[u][i], v = fa[v][i];
        u = T[fa[u][0]]; v = T[fa[v][0]]; res += 2;
        return res + TemplateTree::Dist(GetPre(u, GetRoot(u)), GetPre(v, GetRoot(v)));
    }
}

int main() {
    scanf("%d%d%d", &TemplateTree::n, &BigTree::m, &TemplateTree::q);
    for (int i = 1, u, v; i < TemplateTree::n; ++i) {
        scanf("%d%d", &u, &v);
        TemplateTree::AddEdge(u, v);
    }
    TemplateTree::Build(1, 0);
    CT.Build(1, TemplateTree::n);
    for (int i = 1; i <= TemplateTree::n; ++i) {
        CT.T[i] = CT.Update(TemplateTree::ref[i], CT.T[i-1], 1, TemplateTree::n);
    }
    BigTree::Build();
    while (TemplateTree::q--) {
        LL u, v; scanf("%lld%lld", &u, &v);
        printf("%lld\n", BigTree::Solve(u, v));
    }
    return 0;
}
```

---

## 5. ç®—æ³•å¯è§†åŒ–ï¼šåƒç´ åŠ¨ç”»æ¼”ç¤º

> è®©æˆ‘ä»¬ç”¨ 8-bit åƒç´ é£ï¼Œæ¨¡æ‹Ÿä¸€æ¬¡â€œæ ‘å¥—æ ‘â€çš„æŸ¥è¯¢è¿‡ç¨‹ï¼

### ğŸ® åŠ¨ç”»ä¸»é¢˜ï¼š**â€œåƒç´ æ¢é™©å®¶ï¼šè·¨è¶Šå—æ ‘çš„æ—…ç¨‹â€**

#### ğŸ¯ åœºæ™¯è®¾å®š
- **å±å¹•**ï¼š16x16 åƒç´ ç½‘æ ¼ï¼Œå·¦ä¾§ä¸ºâ€œå—æ ‘â€ï¼Œå³ä¾§ä¸ºâ€œæ¨¡æ¿æ ‘â€ã€‚
- **è§’è‰²**ï¼š
  - çº¢è‰²åƒç´ æ–¹å—ï¼šå½“å‰æŸ¥è¯¢èŠ‚ç‚¹ã€‚
  - ç»¿è‰²åƒç´ æ–¹å—ï¼šå½“å‰å—æ ¹ã€‚
  - è“è‰²åƒç´ æ–¹å—ï¼šLCA èŠ‚ç‚¹ã€‚

#### ğŸ¬ åŠ¨ç”»æ­¥éª¤
1. **åˆå§‹åŒ–**ï¼š
   - å—æ ‘æ˜¾ç¤ºä¸º 5 ä¸ªåƒç´ å—ï¼ˆç¼–å· 1-5ï¼‰ï¼Œæ¨¡æ¿æ ‘æ˜¾ç¤ºä¸º 7 ä¸ªèŠ‚ç‚¹ã€‚
   - éŸ³æ•ˆï¼šâ€œå®ï¼â€ï¼ˆåˆå§‹åŒ–å®Œæˆï¼‰ã€‚

2. **è¾“å…¥æŸ¥è¯¢**ï¼š
   - ç”¨æˆ·è¾“å…¥ `u=12, v=45`ã€‚
   - åŠ¨ç”»ï¼šçº¢è‰²æ–¹å—é—ªçƒï¼Œæ˜¾ç¤ºâ€œæ­£åœ¨å®šä½å—...â€ã€‚

3. **å®šä½å—**ï¼š
   - äºŒåˆ†æŸ¥æ‰¾ `L[i], R[i]` â†’ æ‰¾åˆ° `u` å±äºå— 3ï¼Œ`v` å±äºå— 5ã€‚
   - åŠ¨ç”»ï¼šå— 3 å’Œ 5 é«˜äº®ï¼ŒéŸ³æ•ˆâ€œå—–ï¼â€ã€‚

4. **å—æ ‘ LCA**ï¼š
   - å€å¢æ³•åœ¨å—æ ‘ä¸Šè·³ç¥–å…ˆ â†’ æ‰¾åˆ° LCA ä¸ºå— 2ã€‚
   - åŠ¨ç”»ï¼šç»¿è‰²æ–¹å—ä» 3â†’2ï¼Œ5â†’2ï¼Œè·¯å¾„é—ªçƒã€‚

5. **æ˜ å°„åˆ°æ¨¡æ¿æ ‘**ï¼š
   - ç”¨ä¸»å¸­æ ‘æŸ¥è¯¢ `u` åœ¨æ¨¡æ¿æ ‘ä¸­çš„å¯¹åº”èŠ‚ç‚¹ `u'`ã€‚
   - åŠ¨ç”»ï¼šå³ä¾§æ¨¡æ¿æ ‘ä¸­ `u'` é—ªçƒã€‚

6. **è®¡ç®—è·ç¦»**ï¼š
   - åˆ†ä¸‰éƒ¨åˆ†è®¡ç®—ï¼š
     - `u` åˆ°å— 3 æ ¹çš„è·ç¦»ï¼ˆæ¨¡æ¿æ ‘ LCAï¼‰ã€‚
     - å— 3 æ ¹åˆ°å— 2 æ ¹çš„è·ç¦»ï¼ˆå—æ ‘è¾¹æƒå’Œï¼‰ã€‚
     - å— 2 æ ¹åˆ° `v` çš„è·ç¦»ï¼ˆæ¨¡æ¿æ ‘ LCAï¼‰ã€‚
   - åŠ¨ç”»ï¼šä¸‰éƒ¨åˆ†è·ç¦»ä¾æ¬¡ç´¯åŠ ï¼Œæœ€ç»ˆæ˜¾ç¤ºç­”æ¡ˆ `7`ã€‚

#### ğŸ® äº¤äº’è®¾è®¡
- **æ§åˆ¶é¢æ¿**ï¼š
  - â€œå•æ­¥â€ï¼šé€å¸§æ’­æ”¾ã€‚
  - â€œè‡ªåŠ¨â€ï¼šå¯è°ƒé€Ÿæ»‘å—ï¼ˆ1x-4xï¼‰ã€‚
  - â€œé‡ç½®â€ï¼šå›åˆ°åˆå§‹çŠ¶æ€ã€‚
- **éŸ³æ•ˆ**ï¼š
  - å…³é”®æ“ä½œï¼šâ€œå®ï¼â€ï¼ˆå®šä½æˆåŠŸï¼‰ã€‚
  - è·¯å¾„é—ªçƒï¼šâ€œæ»´ç­”æ»´ç­”â€ã€‚
  - ç»“æœå±•ç¤ºï¼šâ€œèƒœåˆ©éŸ³è°ƒâ€ã€‚

---

## 6. æ‹“å±•ç»ƒä¹ ä¸ç›¸ä¼¼é—®é¢˜æ€è€ƒ

### é€šç”¨æ€è·¯è¿ç§»
- **â€œå—å‹ç¼© + æ˜ å°„â€** æ€æƒ³é€‚ç”¨äºï¼š
  1. **åŠ¨æ€æ ‘ç»“æ„**ï¼šå¦‚ Link-Cut Tree ä¸­çš„â€œè™šæ ‘â€ã€‚
  2. **åŒºé—´æŸ¥è¯¢é—®é¢˜**ï¼šå¦‚â€œåŒºé—´ç¬¬ k å°â€çš„åŠ¨æ€ç»´æŠ¤ã€‚
  3. **åˆ†å±‚å›¾é—®é¢˜**ï¼šå¦‚â€œåœ°é“çº¿è·¯å›¾â€ä¸­çš„æ¢ä¹˜è·ç¦»è®¡ç®—ã€‚

### æ´›è°·æ¨èç»ƒä¹ 
1. **P3379 ã€æ¨¡æ¿ã€‘æœ€è¿‘å…¬å…±ç¥–å…ˆï¼ˆLCAï¼‰**  
   ğŸ—£ï¸ æ¨èç†ç”±ï¼šå·©å›ºå€å¢æ³•æ±‚ LCA çš„æ¨¡æ¿å®ç°ã€‚
2. **P3834 ã€æ¨¡æ¿ã€‘å¯æŒä¹…åŒ–çº¿æ®µæ ‘ 1ï¼ˆä¸»å¸­æ ‘ï¼‰**  
   ğŸ—£ï¸ æ¨èç†ç”±ï¼šæŒæ¡ä¸»å¸­æ ‘ç»´æŠ¤åŒºé—´ç¬¬ k å°çš„æ ¸å¿ƒæŠ€å·§ã€‚
3. **P4211 [HNOI2015] èœè‚´é€‰æ‹©**  
   ğŸ—£ï¸ æ¨èç†ç”±ï¼šç»ƒä¹ â€œåˆ†ç»„ + ä¾èµ–â€é—®é¢˜çš„å»ºæ¨¡ï¼Œä¸æœ¬é¢˜çš„â€œå—æ ‘â€æ€æƒ³ç±»ä¼¼ã€‚
4. **P5021 [NOIP2018 æé«˜ç»„] èµ›é“ä¿®å»º**  
   ğŸ—£ï¸ æ¨èç†ç”±ï¼šæ ‘å½¢ DP ä¸ LCA çš„ç»¼åˆåº”ç”¨ï¼Œæå‡æ ‘ä¸Šé—®é¢˜åˆ†æèƒ½åŠ›ã€‚

---

## 7. å­¦ä¹ å¿ƒå¾—ä¸ç»éªŒåˆ†äº«

> **æ¥è‡ªé¢˜è§£ä½œè€…çš„ç»éªŒ**ï¼š
> - **å¾è‡´è¿œ**ï¼š  
>   â€œè¿™é“é¢˜å‰åäº¤äº† 4 æ¬¡æ‰ ACï¼Œå…³é”®åœ¨äº **è¾¹ç•Œæ¡ä»¶çš„å¤„ç†**ï¼Œæ¯”å¦‚å½“ä¸¤ä¸ªå—æ˜¯ç¥–å­™å…³ç³»æ—¶ï¼Œä¸èƒ½ç›´æ¥è·³åˆ° LCAï¼Œè¦å…ˆè·³åˆ° LCA çš„å„¿å­ã€‚â€
> - **shadowice1984**ï¼š  
>   â€œå†™è¿™ç±»é¢˜ä¸€å®šè¦ **å°è£…å¥½æ¯ä¸ªæ¨¡å—**ï¼Œæ¯”å¦‚â€˜æ˜ å°„å‡½æ•°â€™ã€â€˜LCA å‡½æ•°â€™ï¼Œå¦åˆ™å¾ˆå®¹æ˜“æŠŠè‡ªå·±ç æ™•ã€‚â€

> **æ´›è¯­äº‘ç¬ºç‚¹è¯„**ï¼š  
> è¿™äº›ç»éªŒæé†’æˆ‘ä»¬ï¼Œ**æ¸…æ™°çš„æ¨¡å—åŒ–å’Œè¾¹ç•Œå¤„ç†** æ˜¯å¤æ‚ä»£ç çš„ç”Ÿå‘½çº¿ã€‚åŠ¨æ‰‹å‰ç”»å¥½â€œæ€ç»´å¯¼å›¾â€ï¼Œèƒ½å¤§å¹…é™ä½è°ƒè¯•éš¾åº¦ï¼

---

<conclusion>
ä»Šå¤©çš„æ¢é™©åˆ°æ­¤ç»“æŸï¼æˆ‘ä»¬ä»â€œæ— é™è†¨èƒ€â€çš„å¤§æ ‘ä¸­ï¼Œæç‚¼å‡ºäº† **â€œå‹ç¼©-æ˜ å°„-åˆ†æ²»â€** çš„é€šç”¨ç­–ç•¥ã€‚è®°ä½ï¼Œé¢å¯¹è¶…å¤§è§„æ¨¡é—®é¢˜ï¼Œ**æŠ½è±¡å’Œè½¬åŒ–** æ°¸è¿œæ˜¯æœ€é”‹åˆ©çš„æ­¦å™¨ã€‚ä¸‹æ¬¡å†è§ï¼
</conclusion>

---

---
å¤„ç†ç”¨æ—¶ï¼š186.53ç§’
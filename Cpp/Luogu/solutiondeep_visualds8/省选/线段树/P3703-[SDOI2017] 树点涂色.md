# é¢˜ç›®ä¿¡æ¯

# [SDOI2017] æ ‘ç‚¹æ¶‚è‰²

## é¢˜ç›®æè¿°

Bob æœ‰ä¸€æ£µ $n$ ä¸ªç‚¹çš„æœ‰æ ¹æ ‘ï¼Œå…¶ä¸­ $1$ å·ç‚¹æ˜¯æ ¹èŠ‚ç‚¹ã€‚Bob åœ¨æ¯ä¸ªç‚¹ä¸Šæ¶‚äº†é¢œè‰²ï¼Œå¹¶ä¸”æ¯ä¸ªç‚¹ä¸Šçš„é¢œè‰²ä¸åŒã€‚

å®šä¹‰ä¸€æ¡è·¯å¾„çš„æƒå€¼æ˜¯ï¼šè¿™æ¡è·¯å¾„ä¸Šçš„ç‚¹ï¼ˆåŒ…æ‹¬èµ·ç‚¹å’Œç»ˆç‚¹ï¼‰å…±æœ‰å¤šå°‘ç§ä¸åŒçš„é¢œè‰²ã€‚

Bobå¯èƒ½ä¼šè¿›è¡Œè¿™å‡ ç§æ“ä½œï¼š

- `1 x` è¡¨ç¤ºæŠŠç‚¹ $x$ åˆ°æ ¹èŠ‚ç‚¹çš„è·¯å¾„ä¸Šæ‰€æœ‰çš„ç‚¹æŸ“ä¸Šä¸€ç§æ²¡æœ‰ç”¨è¿‡çš„æ–°é¢œè‰²ã€‚


- `2 x y` æ±‚ $x$ åˆ° $y$ çš„è·¯å¾„çš„æƒå€¼ã€‚

- `3 x` åœ¨ä»¥ $x$ ä¸ºæ ¹çš„å­æ ‘ä¸­é€‰æ‹©ä¸€ä¸ªç‚¹ï¼Œä½¿å¾—è¿™ä¸ªç‚¹åˆ°æ ¹èŠ‚ç‚¹çš„è·¯å¾„æƒå€¼æœ€å¤§ï¼Œæ±‚æœ€å¤§æƒå€¼ã€‚


Bobä¸€å…±ä¼šè¿›è¡Œ $m$ æ¬¡æ“ä½œ


## è¯´æ˜/æç¤º

å…± $10$ ä¸ªæµ‹è¯•ç‚¹ã€‚

æµ‹è¯•ç‚¹ $1$ï¼Œ$1\leq n,m\leq1000$ï¼›

æµ‹è¯•ç‚¹ $2,3$ï¼Œæ²¡æœ‰ $2$ æ“ä½œï¼›

æµ‹è¯•ç‚¹ $4,5$ï¼Œæ²¡æœ‰ $3$ æ“ä½œï¼›

æµ‹è¯•ç‚¹ $6$ï¼Œæ ‘çš„ç”Ÿæˆæ–¹å¼æ˜¯ï¼Œå¯¹äº $i(2\leq i \leq n)$ï¼Œåœ¨ $1 \sim i-1$ ä¸­éšæœºé€‰ä¸€ä¸ªç‚¹ä½œä¸º $i$ çš„çˆ¶èŠ‚ç‚¹ï¼›

æµ‹è¯•ç‚¹ $7$ï¼Œ$1\leq n,m\leq 5\times 10^4$ï¼›

æµ‹è¯•ç‚¹ $8$ï¼Œ$1\leq n \leq 5 \times 10^4$ï¼›

æµ‹è¯•ç‚¹9,10ï¼Œæ— ç‰¹æ®Šé™åˆ¶

å¯¹æ‰€æœ‰æ•°æ®ï¼Œ$1\leq n \leq 10^5$ï¼Œ$1\leq m \leq 10^5$ã€‚


## æ ·ä¾‹ #1

### è¾“å…¥

```
5 6
1 2
2 3
3 4
3 5
2 4 5
3 3
1 4
2 4 5
1 5
2 4 5```

### è¾“å‡º

```
3
4
2
2```

# AIåˆ†æç»“æœ

---
# ğŸ’¡ æ´›è¯­äº‘ç¬ºçš„C++ç®—æ³•è§£æï¼š[SDOI2017] æ ‘ç‚¹æ¶‚è‰² æ·±å…¥å­¦ä¹ æŒ‡å— ğŸ’¡

> ä»Šå¤©æˆ‘ä»¬æ¥ä¸€èµ·åˆ†æâ€œ[SDOI2017] æ ‘ç‚¹æ¶‚è‰²â€è¿™é“C++ç¼–ç¨‹é¢˜ã€‚è¿™ä¸ä»…ä»…æ˜¯ä¸€æ¬¡è§£é¢˜ï¼Œæ›´æ˜¯ä¸€åœºæ€ç»´çš„æ¢é™©ã€‚æˆ‘ä»¬å°†å­¦ä¹ å¦‚ä½•åƒä¾¦æ¢ä¸€æ ·ä»é¢˜ç›®ä¸­å¯»æ‰¾çº¿ç´¢ï¼Œå¹¶åœ¨ä¸åŒçš„è§£é¢˜é“è·¯ä¸­æƒè¡¡é€‰æ‹©ï¼Œæœ€ç»ˆæ‰¾åˆ°æœ€ä¼˜çš„ç­–ç•¥ã€‚

---

## 1. é¢˜ç›®è§£è¯»ä¸ç­–ç•¥åˆæ¢

âœ¨ **æœ¬é¢˜æ ¸å¿ƒæŒ‘æˆ˜**ï¼šç»´æŠ¤ä¸€æ£µæœ‰æ ¹æ ‘ï¼Œæ”¯æŒä¸‰ç§æ“ä½œï¼šé“¾ä¸ŠæŸ“è‰²ã€è·¯å¾„é¢œè‰²è®¡æ•°ã€å­æ ‘å†…æœ€å¤§é¢œè‰²æ•°ã€‚å…³é”®åœ¨äºå¦‚ä½•é«˜æ•ˆå¤„ç†â€œé“¾æŸ“è‰²â€å¯¹åç»­æŸ¥è¯¢çš„å½±å“ã€‚

âœ¨ **æ ¸å¿ƒç®—æ³•æ ‡ç­¾**ï¼šLink-Cut-Tree (LCT), æ ‘é“¾å‰–åˆ†(Heavy-Light Decomposition), çº¿æ®µæ ‘(Segment Tree), æ ‘ä¸Šå·®åˆ†(Tree Difference)

ğŸ—£ï¸ **åˆæ­¥åˆ†æ**ï¼š
> é¢å¯¹è¿™é“é¢˜ï¼Œæˆ‘ä»¬çš„ç›´è§‰å¯èƒ½æ˜¯ç”¨æ ‘é“¾å‰–åˆ†ã€‚ä½†é“¾æŸ“è‰²æ“ä½œä¼šåŠ¨æ€æ”¹å˜æ ‘çš„ç»“æ„ï¼Œæ ‘å‰–éš¾ä»¥ç›´æ¥ç»´æŠ¤ã€‚è¿™æ—¶ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ç§æ›´çµæ´»çš„æ•°æ®ç»“æ„â€”â€”**Link-Cut-Tree (LCT)**ã€‚
>
> LCTçš„`access`æ“ä½œå¤©ç„¶åœ°å¯¹åº”äº†é¢˜ç›®ä¸­çš„â€œé“¾æŸ“è‰²â€æ“ä½œã€‚é€šè¿‡LCTï¼Œæˆ‘ä»¬å¯ä»¥å°†åŒä¸€é¢œè‰²çš„ç‚¹ç»„ç»‡æˆä¸€æ£µSplayæ ‘ï¼Œä»è€Œå°†å¤æ‚çš„é“¾æ“ä½œè½¬åŒ–ä¸ºå¯¹Splayæ ‘çš„ç®€å•æ“ä½œã€‚

### ğŸ” ç®—æ³•ä¾¦æ¢ï¼šå¦‚ä½•åœ¨é¢˜ç›®ä¸­å‘ç°çº¿ç´¢ï¼Ÿ

1.  **çº¿ç´¢1 (æ“ä½œ1çš„â€œé“¾â€ç‰¹æ€§)**ï¼šæ“ä½œ1æ˜¯å°†`x`åˆ°æ ¹çš„è·¯å¾„æŸ“æˆä¸€ç§æ–°é¢œè‰²ã€‚è¿™ç§â€œé“¾â€æ“ä½œæ˜¯LCTçš„`access`æ“ä½œçš„å…¸å‹åº”ç”¨åœºæ™¯ã€‚
2.  **çº¿ç´¢2 (é¢œè‰²è®¡æ•°çš„â€œå¯å‡æ€§â€)**ï¼šè·¯å¾„`u-v`ä¸Šçš„é¢œè‰²æ•°ï¼Œå¯ä»¥è¡¨ç¤ºä¸º`color[u] + color[v] - 2 * color[lca(u,v)] + 1`ã€‚è¿™æç¤ºæˆ‘ä»¬ä½¿ç”¨**æ ‘ä¸Šå·®åˆ†**ã€‚
3.  **çº¿ç´¢3 (å­æ ‘æŸ¥è¯¢çš„â€œè¿ç»­æ€§â€)**ï¼šå­æ ‘å†…çš„èŠ‚ç‚¹åœ¨DFSåºä¸Šæ˜¯è¿ç»­çš„ã€‚è¿™ä½¿å¾—æˆ‘ä»¬å¯ä»¥ç”¨**çº¿æ®µæ ‘**æ¥ç»´æŠ¤å­æ ‘ä¿¡æ¯ã€‚

### ğŸ§  æ€ç»´é“¾æ„å»ºï¼šä»çº¿ç´¢åˆ°ç­–ç•¥

> 1.  **çº¿ç´¢1**æç¤ºæˆ‘ä»¬ä½¿ç”¨LCTæ¥ç»´æŠ¤åŠ¨æ€æ ‘ç»“æ„ã€‚
> 2.  **çº¿ç´¢2**å‘Šè¯‰æˆ‘ä»¬ï¼Œåªè¦ç»´æŠ¤æ¯ä¸ªç‚¹åˆ°æ ¹çš„è·¯å¾„ä¸Šçš„é¢œè‰²æ•°ï¼Œå°±èƒ½å›ç­”è·¯å¾„æŸ¥è¯¢ã€‚
> 3.  **çº¿ç´¢3**æŒ‡å‡ºï¼Œå­æ ‘æŸ¥è¯¢å¯ä»¥é€šè¿‡DFSåºå’Œçº¿æ®µæ ‘é«˜æ•ˆå®Œæˆã€‚
>
> ç»“åˆè¿™äº›çº¿ç´¢ï¼Œæˆ‘ä»¬å½¢æˆäº†ä¸€ä¸ªç»Ÿä¸€çš„ç­–ç•¥ï¼š**ç”¨LCTå¤„ç†é“¾æŸ“è‰²ï¼Œç”¨çº¿æ®µæ ‘ç»´æŠ¤å­æ ‘ä¿¡æ¯ï¼Œç”¨æ ‘ä¸Šå·®åˆ†å¤„ç†è·¯å¾„æŸ¥è¯¢**ã€‚

---

## 2. ç²¾é€‰ä¼˜è´¨é¢˜è§£å‚è€ƒ

> ä¸ºäº†æ›´å¥½åœ°ç†è§£è§£é¢˜è¿‡ç¨‹ï¼Œæˆ‘ä»æ€è·¯æ¸…æ™°åº¦ã€ä»£ç å¯è¯»æ€§ã€ç®—æ³•æœ‰æ•ˆæ€§ä¸ä¼˜åŒ–ç¨‹åº¦ã€å®è·µä»·å€¼ç­‰å‡ ä¸ªæ–¹é¢ï¼Œä¸ºå¤§å®¶ç­›é€‰äº†ä»¥ä¸‹è¯„åˆ†è¾ƒé«˜ï¼ˆâ‰¥4æ˜Ÿï¼‰çš„é¢˜è§£ã€‚

### é¢˜è§£ä¸€ï¼šCaiiçš„æ ‘å‰–è§£æ³• (èµï¼š91)

* **ç‚¹è¯„**ï¼šè¿™ä»½é¢˜è§£å¦è¾Ÿè¹Šå¾„ï¼Œç”¨**æ ‘é“¾å‰–åˆ†**è€ŒéLCTï¼Œå±•ç°äº†æ ‘å‰–çš„å¼ºå¤§ä¹‹å¤„ã€‚ä½œè€…å·§å¦™åœ°åˆ©ç”¨â€œåŒè‰²é“¾â€æ¦‚å¿µï¼Œå°†é“¾æŸ“è‰²æ“ä½œè½¬åŒ–ä¸ºåŒºé—´ä¿®æ”¹ï¼Œå¹¶ç”¨çº¿æ®µæ ‘ç»´æŠ¤é¢œè‰²ä¿¡æ¯ã€‚ä»£ç å®ç°ç®€æ´ï¼Œæ€è·¯æ¸…æ™°ï¼Œå€¼å¾—å­¦ä¹ ã€‚

### é¢˜è§£äºŒï¼šSoulistçš„LCT+æ ‘å‰–è§£æ³• (èµï¼š62)

* **ç‚¹è¯„**ï¼šè¿™ä»½é¢˜è§£æ˜¯LCTä¸æ ‘å‰–çš„ç»å…¸ç»“åˆã€‚ä½œè€…ç”¨LCTçš„`access`æ“ä½œå¤„ç†é“¾æŸ“è‰²ï¼Œç”¨æ ‘å‰–çš„DFSåºå’Œçº¿æ®µæ ‘ç»´æŠ¤å­æ ‘ä¿¡æ¯ã€‚ä»£ç æ³¨é‡Šè¯¦å°½ï¼Œé€»è¾‘ä¸¥è°¨ï¼Œæ˜¯å­¦ä¹ LCTåº”ç”¨çš„ä¼˜ç§€èŒƒä¾‹ã€‚

### é¢˜è§£ä¸‰ï¼šFlashHuçš„LCT+å€å¢LCAè§£æ³• (èµï¼š28)

* **ç‚¹è¯„**ï¼šè¿™ä»½é¢˜è§£ç”¨LCTå¤„ç†é“¾æŸ“è‰²ï¼Œç”¨**å€å¢æ³•æ±‚LCA**æ¥æ”¯æŒæ ‘ä¸Šå·®åˆ†ã€‚ä½œè€…è¯¦ç»†è§£é‡Šäº†LCTçš„`access`æ“ä½œå¦‚ä½•å½±å“å­æ ‘ä¿¡æ¯ï¼Œå¹¶ç”¨çº¿æ®µæ ‘ç»´æŠ¤è¿™äº›ä¿¡æ¯ã€‚ä»£ç é£æ ¼ç°ä»£ï¼Œå¯è¯»æ€§å¼ºã€‚

---

## 3. è§£é¢˜ç­–ç•¥æ·±åº¦å‰–æ

### ğŸ¯ æ ¸å¿ƒéš¾ç‚¹ä¸å…³é”®æ­¥éª¤ (æœ€ä¼˜è§£æ³•å‰–æ)

1.  **å…³é”®ç‚¹1ï¼šLCTçš„`access`æ“ä½œä¸é“¾æŸ“è‰²**
    * **åˆ†æ**ï¼šLCTçš„`access(u)`æ“ä½œå°†`u`åˆ°æ ¹çš„è·¯å¾„å˜ä¸ºä¸€æ¡å®é“¾ã€‚åœ¨æœ¬é¢˜ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å°†åŒä¸€é¢œè‰²çš„ç‚¹ç»„ç»‡æˆä¸€æ£µSplayæ ‘ï¼Œè¿™æ ·`access(u)`å°±ç›¸å½“äºå°†`u`åˆ°æ ¹çš„è·¯å¾„æŸ“æˆä¸€ç§æ–°é¢œè‰²ã€‚
    * ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼š`access`æ“ä½œæ˜¯LCTçš„æ ¸å¿ƒï¼Œå®ƒå…è®¸æˆ‘ä»¬é«˜æ•ˆåœ°å¤„ç†æ ‘ä¸Šçš„é“¾æ“ä½œã€‚

2.  **å…³é”®ç‚¹2ï¼šç»´æŠ¤å­æ ‘ä¿¡æ¯**
    * **åˆ†æ**ï¼šæˆ‘ä»¬éœ€è¦ç»´æŠ¤æ¯ä¸ªç‚¹åˆ°æ ¹çš„è·¯å¾„ä¸Šçš„é¢œè‰²æ•°ã€‚è¿™å¯ä»¥é€šè¿‡DFSåºå’Œçº¿æ®µæ ‘æ¥å®ç°ã€‚å…·ä½“æ¥è¯´ï¼Œæˆ‘ä»¬ç»´æŠ¤ä¸€ä¸ªçº¿æ®µæ ‘ï¼Œå…¶ä¸­æ¯ä¸ªå¶èŠ‚ç‚¹å­˜å‚¨å¯¹åº”èŠ‚ç‚¹çš„é¢œè‰²æ•°ã€‚
    * ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šDFSåºå°†å­æ ‘è½¬åŒ–ä¸ºåŒºé—´ï¼Œä½¿å¾—æˆ‘ä»¬å¯ä»¥ç”¨çº¿æ®µæ ‘é«˜æ•ˆåœ°ç»´æŠ¤å­æ ‘ä¿¡æ¯ã€‚

3.  **å…³é”®ç‚¹3ï¼šè·¯å¾„æŸ¥è¯¢çš„æ ‘ä¸Šå·®åˆ†**
    * **åˆ†æ**ï¼šè·¯å¾„`u-v`ä¸Šçš„é¢œè‰²æ•°å¯ä»¥è¡¨ç¤ºä¸º`color[u] + color[v] - 2 * color[lca(u,v)] + 1`ã€‚è¿™å…è®¸æˆ‘ä»¬ç”¨æ ‘ä¸Šå·®åˆ†æ¥é«˜æ•ˆåœ°å›ç­”è·¯å¾„æŸ¥è¯¢ã€‚
    * ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šæ ‘ä¸Šå·®åˆ†æ˜¯ä¸€ç§å¼ºå¤§çš„æŠ€å·§ï¼Œå¯ä»¥å°†è·¯å¾„æŸ¥è¯¢è½¬åŒ–ä¸ºç‚¹æŸ¥è¯¢ã€‚

### âœ¨ è§£é¢˜æŠ€å·§æ€»ç»“

- **æŠ€å·§A (LCTçš„å¦™ç”¨)**ï¼šå°†å¤æ‚çš„é“¾æŸ“è‰²æ“ä½œè½¬åŒ–ä¸ºLCTçš„`access`æ“ä½œï¼Œç®€åŒ–äº†é—®é¢˜çš„å¤„ç†ã€‚
- **æŠ€å·§B (DFSåºçš„åº”ç”¨)**ï¼šåˆ©ç”¨DFSåºå°†å­æ ‘ä¿¡æ¯è½¬åŒ–ä¸ºåŒºé—´ä¿¡æ¯ï¼Œä½¿å¾—çº¿æ®µæ ‘å¯ä»¥é«˜æ•ˆç»´æŠ¤ã€‚
- **æŠ€å·§C (æ ‘ä¸Šå·®åˆ†)**ï¼šé€šè¿‡æ ‘ä¸Šå·®åˆ†ï¼Œå°†è·¯å¾„æŸ¥è¯¢è½¬åŒ–ä¸ºç‚¹æŸ¥è¯¢ï¼Œé™ä½äº†é—®é¢˜çš„å¤æ‚åº¦ã€‚

### âš”ï¸ ç­–ç•¥ç«æŠ€åœºï¼šä¸åŒè§£æ³•çš„å¯¹æ¯”åˆ†æ

| ç­–ç•¥ | æ ¸å¿ƒæ€æƒ³ | ä¼˜ç‚¹ | ç¼ºç‚¹ä¸åˆ†æ | é€‚ç”¨åœºæ™¯ / å¾—åˆ†é¢„æœŸ |
| :--- | :--- | :--- | :--- |:--- |
| **æš´åŠ›æŸ“è‰²** | æ¯æ¬¡é“¾æŸ“è‰²åæš´åŠ›ç»Ÿè®¡é¢œè‰²æ•° | æ€è·¯ç›´è§‚ï¼Œæ˜“äºå®ç° | **æ—¶é—´å¤æ‚åº¦**: O(N^2)ï¼Œå®Œå…¨ä¸å¯è¡Œ | æ•°æ®è§„æ¨¡ N â‰¤ 1000ï¼Œå¯å¾—30%åˆ†æ•° |
| **æ ‘é“¾å‰–åˆ†** | ç”¨æ ‘é“¾å‰–åˆ†ç»´æŠ¤é“¾æŸ“è‰²å’Œå­æ ‘ä¿¡æ¯ | ä»£ç å®ç°ç›¸å¯¹ç®€å• | **æ—¶é—´å¤æ‚åº¦**: O(N log^2 N)ï¼Œå¸¸æ•°è¾ƒå¤§ | é€‚ç”¨äºå¯¹LCTä¸ç†Ÿæ‚‰çš„é€‰æ‰‹ï¼Œå¯å¾—100%åˆ†æ•° |
| **LCT+æ ‘å‰–** | ç”¨LCTå¤„ç†é“¾æŸ“è‰²ï¼Œç”¨æ ‘å‰–ç»´æŠ¤å­æ ‘ä¿¡æ¯ | **æ—¶é—´å¤æ‚åº¦**: O(N log N)å‡æ‘Šï¼Œæ•ˆç‡æé«˜ | å®ç°å¤æ‚ï¼Œéœ€è¦ç†Ÿç»ƒæŒæ¡LCT | æœ€ä¼˜è§£æ³•ï¼Œå¯å¾—100%åˆ†æ•° |

### âœ¨ ä¼˜åŒ–ä¹‹æ—…ï¼šä»â€œèƒ½åšâ€åˆ°â€œåšå¥½â€

> 1.  **èµ·ç‚¹ï¼šæš´åŠ›æŸ“è‰²çš„å›°å¢ƒ**  
>   æš´åŠ›æŸ“è‰²çš„æ—¶é—´å¤æ‚åº¦ä¸ºO(N^2)ï¼Œå½“N=1e5æ—¶ï¼Œè®¡ç®—é‡é«˜è¾¾1e10ï¼Œæ ¹æœ¬æ— æ³•é€šè¿‡ã€‚
>
> 2.  **å‘ç°ç“¶é¢ˆï¼šé“¾æŸ“è‰²çš„ä½æ•ˆ**  
>   æ¯æ¬¡é“¾æŸ“è‰²åæš´åŠ›ç»Ÿè®¡é¢œè‰²æ•°ï¼Œå¯¼è‡´äº†å¤§é‡é‡å¤è®¡ç®—ã€‚
>
> 3.  **ä¼˜åŒ–çš„é’¥åŒ™ï¼šLCTçš„`access`**  
>   LCTçš„`access`æ“ä½œå…è®¸æˆ‘ä»¬åœ¨O(log N)æ—¶é—´å†…å®Œæˆé“¾æŸ“è‰²ï¼Œè¿™æ˜¯çªç ´ç“¶é¢ˆçš„å…³é”®ã€‚
>
> 4.  **æ¨¡å‹çš„å‡åï¼šç»Ÿä¸€ç»´æŠ¤**  
>   é€šè¿‡LCTå’Œæ ‘å‰–çš„ç»“åˆï¼Œæˆ‘ä»¬å°†é“¾æŸ“è‰²ã€å­æ ‘æŸ¥è¯¢ã€è·¯å¾„æŸ¥è¯¢ç»Ÿä¸€åˆ°ä¸€ä¸ªæ¡†æ¶ä¸‹ï¼Œå®ç°äº†é«˜æ•ˆå¤„ç†ã€‚

---

## 4. C++æ ¸å¿ƒä»£ç å®ç°èµæ

### æœ¬é¢˜é€šç”¨æ ¸å¿ƒC++å®ç°å‚è€ƒ (åŸºäºLCT+æ ‘å‰–)

* **è¯´æ˜**ï¼šä»¥ä¸‹ä»£ç ç»¼åˆäº†å¤šä¸ªä¼˜è´¨é¢˜è§£çš„æ€è·¯ï¼Œæ—¨åœ¨æä¾›ä¸€ä¸ªæ¸…æ™°ä¸”å®Œæ•´çš„æ ¸å¿ƒå®ç°ã€‚

```cpp
#include <bits/stdc++.h>
using namespace std;

const int MAXN = 1e5 + 10;

// LCTéƒ¨åˆ†
struct LCT {
    int ch[MAXN][2], fa[MAXN], val[MAXN];
    bool isroot(int x) { return ch[fa[x]][0] != x && ch[fa[x]][1] != x; }
    bool get(int x) { return ch[fa[x]][1] == x; }
    void rotate(int x) {
        int y = fa[x], z = fa[y], k = get(x);
        if (!isroot(y)) ch[z][get(y)] = x;
        ch[y][k] = ch[x][k ^ 1]; fa[ch[x][k ^ 1]] = y;
        ch[x][k ^ 1] = y; fa[y] = x; fa[x] = z;
    }
    void splay(int x) {
        while (!isroot(x)) {
            int y = fa[x];
            if (!isroot(y)) rotate(get(x) == get(y) ? y : x);
            rotate(x);
        }
    }
    int findrt(int x) {
        while (ch[x][0]) x = ch[x][0];
        return x;
    }
} lct;

// æ ‘é“¾å‰–åˆ†éƒ¨åˆ†
int dfn[MAXN], siz[MAXN], dep[MAXN], fa[MAXN], son[MAXN], top[MAXN], cnt;
vector<int> g[MAXN];

void dfs1(int u, int f) {
    siz[u] = 1; fa[u] = f; dep[u] = dep[f] + 1;
    for (int v : g[u]) {
        if (v == f) continue;
        dfs1(v, u);
        siz[u] += siz[v];
        if (siz[v] > siz[son[u]]) son[u] = v;
    }
}

void dfs2(int u, int t) {
    dfn[u] = ++cnt; top[u] = t;
    if (son[u]) dfs2(son[u], t);
    for (int v : g[u]) {
        if (v == fa[u] || v == son[u]) continue;
        dfs2(v, v);
    }
}

int lca(int x, int y) {
    while (top[x] != top[y]) {
        if (dep[top[x]] < dep[top[y]]) swap(x, y);
        x = fa[top[x]];
    }
    return dep[x] < dep[y] ? x : y;
}

// çº¿æ®µæ ‘éƒ¨åˆ†
int mx[MAXN << 2], tag[MAXN << 2];
void pushdown(int p) {
    if (!tag[p]) return;
    tag[p << 1] += tag[p]; mx[p << 1] += tag[p];
    tag[p << 1 | 1] += tag[p]; mx[p << 1 | 1] += tag[p];
    tag[p] = 0;
}
void build(int p, int l, int r) {
    if (l == r) { mx[p] = dep[l]; return; }
    int mid = (l + r) >> 1;
    build(p << 1, l, mid); build(p << 1 | 1, mid + 1, r);
    mx[p] = max(mx[p << 1], mx[p << 1 | 1]);
}
void update(int p, int l, int r, int ql, int qr, int v) {
    if (ql <= l && r <= qr) { tag[p] += v; mx[p] += v; return; }
    pushdown(p);
    int mid = (l + r) >> 1;
    if (ql <= mid) update(p << 1, l, mid, ql, qr, v);
    if (qr > mid) update(p << 1 | 1, mid + 1, r, ql, qr, v);
    mx[p] = max(mx[p << 1], mx[p << 1 | 1]);
}
int query(int p, int l, int r, int ql, int qr) {
    if (ql <= l && r <= qr) return mx[p];
    pushdown(p);
    int mid = (l + r) >> 1, res = 0;
    if (ql <= mid) res = max(res, query(p << 1, l, mid, ql, qr));
    if (qr > mid) res = max(res, query(p << 1 | 1, mid + 1, r, ql, qr));
    return res;
}

int main() {
    int n, m;
    scanf("%d%d", &n, &m);
    for (int i = 1; i < n; ++i) {
        int u, v;
        scanf("%d%d", &u, &v);
        g[u].push_back(v);
        g[v].push_back(u);
    }
    dfs1(1, 0); dfs2(1, 1);
    build(1, 1, n);
    for (int i = 1; i <= n; ++i) lct.fa[i] = fa[i];

    while (m--) {
        int op, x, y;
        scanf("%d%d", &op, &x);
        if (op == 1) {
            // LCT accessæ“ä½œï¼ŒåŒæ—¶æ›´æ–°çº¿æ®µæ ‘
            for (int y = 0; x; y = x, x = lct.fa[x]) {
                lct.splay(x);
                if (lct.ch[x][1]) {
                    int rt = lct.findrt(lct.ch[x][1]);
                    update(1, 1, n, dfn[rt], dfn[rt] + siz[rt] - 1, 1);
                }
                if (y) {
                    int rt = lct.findrt(y);
                    update(1, 1, n, dfn[rt], dfn[rt] + siz[rt] - 1, -1);
                }
                lct.ch[x][1] = y;
            }
        } else if (op == 2) {
            scanf("%d", &y);
            int anc = lca(x, y);
            int ans = query(1, 1, n, dfn[x], dfn[x]) + query(1, 1, n, dfn[y], dfn[y])
                      - 2 * query(1, 1, n, dfn[anc], dfn[anc]) + 1;
            printf("%d\n", ans);
        } else {
            printf("%d\n", query(1, 1, n, dfn[x], dfn[x] + siz[x] - 1));
        }
    }
    return 0;
}
```

---

## 5. ç®—æ³•å¯è§†åŒ–ï¼šåƒç´ åŠ¨ç”»æ¼”ç¤º

### ğŸ® åŠ¨ç”»æ¼”ç¤ºä¸»é¢˜ï¼š**"åƒç´ æ¢é™©å®¶ï¼šLCTçš„æŸ“è‰²ä¹‹æ—…"**

> ä¸ºäº†æ›´ç›´è§‚åœ°ç†è§£LCTå¦‚ä½•å®Œæˆé“¾æŸ“è‰²ï¼Œæˆ‘è®¾è®¡äº†ä¸€ä¸ª8ä½åƒç´ é£æ ¼çš„åŠ¨ç”»æ¼”ç¤ºã€‚

### ğŸ¯ æ ¸å¿ƒæ¼”ç¤ºå†…å®¹
å±•ç¤ºLCTçš„`access`æ“ä½œå¦‚ä½•ä¸€æ­¥æ­¥å°†è·¯å¾„æŸ“æˆæ–°é¢œè‰²ï¼Œå¹¶åŒæ­¥æ›´æ–°çº¿æ®µæ ‘ä¸­çš„å­æ ‘ä¿¡æ¯ã€‚

### ğŸ¨ è®¾è®¡æ€è·¯
- **åƒç´ é£æ ¼**ï¼šä»¿ç…§FCçº¢ç™½æœºç•Œé¢ï¼Œç”¨8x8åƒç´ å—è¡¨ç¤ºæ ‘èŠ‚ç‚¹ã€‚
- **é¢œè‰²ç¼–ç **ï¼šä¸åŒé¢œè‰²ä»£è¡¨ä¸åŒé¢œè‰²æ®µï¼Œé«˜äº®æ˜¾ç¤ºå½“å‰æ“ä½œè·¯å¾„ã€‚
- **éŸ³æ•ˆæç¤º**ï¼šæ¯æ¬¡`access`æ“ä½œä¼´éš"å®"çš„éŸ³æ•ˆï¼Œå­æ ‘æ›´æ–°æ—¶æœ‰"å“”"çš„æç¤ºéŸ³ã€‚

### ğŸ“º åŠ¨ç”»æ­¥éª¤
1. **åˆå§‹åŒ–**ï¼šå±•ç¤ºä¸€æ£µåƒç´ åŒ–çš„æ ‘ï¼Œæ¯ä¸ªèŠ‚ç‚¹åˆå§‹ä¸ºä¸åŒé¢œè‰²ã€‚
2. **Accessæ“ä½œ**ï¼šç”¨æˆ·ç‚¹å‡»èŠ‚ç‚¹åï¼ŒåŠ¨ç”»å±•ç¤ºä»è¯¥èŠ‚ç‚¹åˆ°æ ¹çš„è·¯å¾„å¦‚ä½•è¢«"æ‹‰ç›´"æˆä¸€æ¡æ–°é¢œè‰²çš„é“¾ã€‚
3. **å­æ ‘æ›´æ–°**ï¼šè·¯å¾„ä¸Šçš„å­æ ‘èŠ‚ç‚¹é¢œè‰²æ•°åŒæ­¥æ›´æ–°ï¼Œçº¿æ®µæ ‘åŒºé—´é«˜äº®é—ªçƒã€‚
4. **æŸ¥è¯¢æ¼”ç¤º**ï¼šå±•ç¤ºè·¯å¾„æŸ¥è¯¢å’Œå­æ ‘æŸ¥è¯¢å¦‚ä½•é€šè¿‡å·®åˆ†å’Œçº¿æ®µæ ‘é«˜æ•ˆå®Œæˆã€‚

---

## 6. æ‹“å±•ç»ƒä¹ ä¸ç›¸ä¼¼é—®é¢˜æ€è€ƒ

### ğŸŒ± é€šç”¨æ€è·¯è¿ç§»
æœ¬é¢˜çš„LCT+æ ‘å‰–æ¡†æ¶å¯å¹¿æ³›åº”ç”¨äºï¼š
1. **åŠ¨æ€æ ‘ç»´æŠ¤**ï¼šå¦‚åŠ¨æ€åŠ è¾¹åˆ è¾¹ã€æŸ¥è¯¢è¿é€šæ€§ã€‚
2. **è·¯å¾„ä¿¡æ¯æŸ¥è¯¢**ï¼šå¦‚åŠ¨æ€ç»´æŠ¤æ ‘ä¸Šè·¯å¾„çš„æœ€å¤§/æœ€å°å€¼ã€‚
3. **å­æ ‘ä¿¡æ¯ç»´æŠ¤**ï¼šå¦‚åŠ¨æ€ç»Ÿè®¡å­æ ‘å’Œã€å­æ ‘å¤§å°ç­‰ã€‚

### ğŸ“š æ´›è°·æ¨èç»ƒä¹ 
1. **P3384 ã€æ¨¡æ¿ã€‘æ ‘é“¾å‰–åˆ†**  
   ğŸ—£ï¸ æ¨èç†ç”±ï¼šå·©å›ºæ ‘é“¾å‰–åˆ†åŸºç¡€ï¼Œç†è§£å¦‚ä½•å°†æ ‘ç»“æ„è½¬åŒ–ä¸ºçº¿æ€§ç»“æ„å¤„ç†ã€‚
2. **P3690 ã€æ¨¡æ¿ã€‘Link Cut Tree**  
   ğŸ—£ï¸ æ¨èç†ç”±ï¼šæŒæ¡LCTçš„æ ¸å¿ƒæ“ä½œï¼Œä¸ºå¤„ç†åŠ¨æ€æ ‘é—®é¢˜æ‰“ä¸‹åšå®åŸºç¡€ã€‚
3. **P2486 [SDOI2011] æŸ“è‰²**  
   ğŸ—£ï¸ æ¨èç†ç”±ï¼šåŒæ ·æ˜¯æ ‘ä¸ŠæŸ“è‰²é—®é¢˜ï¼Œä½†æ“ä½œæ›´å¤æ‚ï¼Œè€ƒéªŒå¯¹LCTçš„æ·±å…¥ç†è§£ã€‚
4. **P4211 [LNOI2014] LCA**  
   ğŸ—£ï¸ æ¨èç†ç”±ï¼šç»ƒä¹ å¦‚ä½•ç”¨LCTç»´æŠ¤LCAä¿¡æ¯ï¼Œè¿›ä¸€æ­¥ç†Ÿæ‚‰æ ‘ä¸Šå·®åˆ†æŠ€å·§ã€‚

---

## 7. å­¦ä¹ å¿ƒå¾—ä¸ç»éªŒåˆ†äº«

> å¤šä½ä½œè€…åˆ†äº«äº†è°ƒè¯•å¿ƒå¾—ï¼š
>
> **"è°ƒè¯•LCTæ—¶ï¼Œå»ºè®®å°†`access`æ“ä½œæ‹†è§£ä¸ºå°æ­¥éª¤ï¼Œæ¯æ­¥éªŒè¯å­æ ‘æ›´æ–°æ˜¯å¦æ­£ç¡®ã€‚"**  
> **"æ ‘å‰–çš„DFSåºå’Œçº¿æ®µæ ‘çš„åŒºé—´æ“ä½œæ˜¯å…³é”®ï¼ŒåŠ¡å¿…ç¡®ä¿åŒºé—´è¾¹ç•Œæ­£ç¡®ã€‚"**

---

<conclusion>
æœ¬æ¬¡å…³äºâ€œ[SDOI2017] æ ‘ç‚¹æ¶‚è‰²â€çš„C++è§£é¢˜åˆ†æå°±åˆ°è¿™é‡Œã€‚å¸Œæœ›è¿™ä»½å­¦ä¹ æŒ‡å—èƒ½å¸®åŠ©å¤§å®¶æ›´å¥½åœ°ç†è§£LCTã€æ ‘å‰–å’Œçº¿æ®µæ ‘çš„ç»¼åˆåº”ç”¨ã€‚è®°ä½ï¼Œç¼–ç¨‹èƒ½åŠ›çš„æå‡åœ¨äºæŒç»­å­¦ä¹ ã€å‹¤äºæ€è€ƒå’Œå‹‡äºå®è·µã€‚ä¸‹æ¬¡æˆ‘ä»¬å†ä¸€èµ·æ¢ç´¢æ–°çš„ç¼–ç¨‹æŒ‘æˆ˜ï¼ğŸ’ª
</conclusion>

---
å¤„ç†ç”¨æ—¶ï¼š108.60ç§’
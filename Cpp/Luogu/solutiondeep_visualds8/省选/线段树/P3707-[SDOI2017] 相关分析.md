# é¢˜ç›®ä¿¡æ¯

# [SDOI2017] ç›¸å…³åˆ†æ

## é¢˜ç›®æè¿°

Frank å¯¹å¤©æ–‡å­¦éå¸¸æ„Ÿå…´è¶£ï¼Œä»–ç»å¸¸ç”¨æœ›è¿œé•œçœ‹æ˜Ÿæ˜Ÿï¼ŒåŒæ—¶è®°å½•ä¸‹å®ƒä»¬çš„ä¿¡æ¯ï¼Œæ¯”å¦‚äº®åº¦ã€é¢œè‰²ç­‰ç­‰ï¼Œè¿›è€Œä¼°ç®—å‡ºæ˜Ÿæ˜Ÿçš„è·ç¦»ï¼ŒåŠå¾„ç­‰ç­‰ã€‚

Frank ä¸ä»…å–œæ¬¢è§‚æµ‹ï¼Œè¿˜å–œæ¬¢åˆ†æè§‚æµ‹åˆ°çš„æ•°æ®ã€‚ä»–ç»å¸¸åˆ†æä¸¤ä¸ªå‚æ•°ä¹‹é—´ï¼ˆæ¯”å¦‚äº®åº¦å’ŒåŠå¾„ï¼‰æ˜¯å¦å­˜åœ¨æŸç§å…³ç³»ã€‚

ç°åœ¨ Frank è¦åˆ†æå‚æ•° $X$ ä¸ $Y$ ä¹‹é—´çš„å…³ç³»ã€‚ä»–æœ‰ $n$ ç»„è§‚æµ‹æ•°æ®ï¼Œç¬¬ $i$ ç»„è§‚æµ‹æ•°æ®è®°å½•äº† $x_i$ å’Œ $y_i$ã€‚ä»–éœ€è¦ä¸€ä¸‹å‡ ç§æ“ä½œã€‚

###  $\verb!1 L R!$

ç”¨ç›´çº¿æ‹Ÿåˆç¬¬ $L$ ç»„åˆ°ç¬¬ $R$ ç»„è§‚æµ‹æ•°æ®ã€‚ç”¨ $\overline{x}$ è¡¨ç¤ºè¿™äº›è§‚æµ‹æ•°æ®ä¸­ $x$ çš„å¹³å‡æ•°ï¼Œç”¨ $\overline{y}$ è¡¨ç¤ºè¿™äº›è§‚æµ‹æ•°æ®ä¸­ $y$ çš„å¹³å‡æ•°ï¼Œå³
 
$$\begin{aligned}\overline{x}&={1 \over R-L+1} \sum _{i=L} ^R x_i \\\overline{y}&={1 \over R-L+1} \sum _{i=L} ^R y_i\end{aligned}$$

å¦‚æœç›´çº¿æ–¹ç¨‹æ˜¯ $y=ax+b$ï¼Œé‚£ä¹ˆ $a$ åº”å½“è¿™æ ·è®¡ç®—ï¼š

$$a={\displaystyle\sum_{i=L} ^R (x_i-\overline{x})(y_i-\overline{y}) \over \displaystyle\sum _{i=L} ^R (x_i -\overline{x})^2}$$

 
ä½ éœ€è¦å¸®åŠ© Frank è®¡ç®— $a$ã€‚

 
###  $\verb!2 L R S T!$

Frank å‘ç°æµ‹é‡æ•°æ®ç¬¬ $L$ ç»„åˆ°ç¬¬ $R$ ç»„æ•°æ®æœ‰è¯¯å·®ï¼Œå¯¹æ¯ä¸ª $i$ æ»¡è¶³ $L \leq i \leq R$ï¼Œ$x_i$ éœ€è¦åŠ ä¸Š $S$ï¼Œ$y_i$ éœ€è¦åŠ ä¸Š $T$ã€‚
 
###  $\verb!3 L R S T!$

Frank å‘ç°ç¬¬ $L$ ç»„åˆ°ç¬¬ $R$ ç»„æ•°æ®éœ€è¦ä¿®æ”¹ï¼Œå¯¹äºæ¯ä¸ª $i$ æ»¡è¶³ $L \leq i \leq R$ï¼Œ$x_i$ éœ€è¦ä¿®æ”¹ä¸º $(S+i)$ï¼Œ$y_i$ éœ€è¦ä¿®æ”¹ä¸º $(T+i)$ã€‚


## è¯´æ˜/æç¤º

### æ•°æ®èŒƒå›´åŠçº¦å®š

- å¯¹äº $20\%$ çš„æ•°æ® $1 \leq n,m \leq 1000$ï¼›
- å¦æœ‰ $20\%$ çš„æ•°æ®ï¼Œæ²¡æœ‰ $3$ æ“ä½œï¼Œä¸” $2$ æ“ä½œä¸­ $S=0$ï¼›
- å¦æœ‰ $30\%$ çš„æ•°æ®ï¼Œæ²¡æœ‰ $3$ æ“ä½œã€‚

å¯¹äº $100\%$ çš„æ•°æ®ï¼Œ$1 \leq n,m \leq 10^5$ï¼Œ$0 \leq |S|,|T| \leq 10^5$ï¼Œ$0 \leq |x_i|,|y_i| \leq 10^5$ã€‚

ä¿è¯ $1$ æ“ä½œä¸ä¼šå‡ºç°åˆ†æ¯ä¸º $0$ çš„æƒ…å†µã€‚


## æ ·ä¾‹ #1

### è¾“å…¥

```
3 5
1 2 3
1 2 3
1 1 3
2 2 3 -3 2
1 1 2
3 1 2 2 1
1 1 3
```

### è¾“å‡º

```
1.0000000000
-1.5000000000
-0.6153846154
```

# AIåˆ†æç»“æœ

---
# ğŸ’¡ æ´›è¯­äº‘ç¬ºçš„C++ç®—æ³•è§£æï¼š[SDOI2017] ç›¸å…³åˆ†æ æ·±å…¥å­¦ä¹ æŒ‡å— ğŸ’¡

ä»Šå¤©æˆ‘ä»¬æ¥ä¸€èµ·åˆ†æâ€œ[SDOI2017] ç›¸å…³åˆ†æâ€è¿™é“C++ç¼–ç¨‹é¢˜ã€‚è¿™ä¸ä»…ä»…æ˜¯ä¸€æ¬¡è§£é¢˜ï¼Œæ›´æ˜¯ä¸€åœºæ€ç»´çš„æ¢é™©ã€‚æˆ‘ä»¬å°†å­¦ä¹ å¦‚ä½•åƒä¾¦æ¢ä¸€æ ·ä»é¢˜ç›®ä¸­å¯»æ‰¾çº¿ç´¢ï¼Œå¹¶åœ¨ä¸åŒçš„è§£é¢˜é“è·¯ä¸­æƒè¡¡é€‰æ‹©ï¼Œæœ€ç»ˆæ‰¾åˆ°æœ€ä¼˜çš„ç­–ç•¥ã€‚

## 1. é¢˜ç›®è§£è¯»ä¸ç­–ç•¥åˆæ¢

âœ¨ **æœ¬é¢˜æ ¸å¿ƒæŒ‘æˆ˜**ï¼š  
â€œè¿™é“é¢˜çš„æ ¸å¿ƒæŒ‘æˆ˜åœ¨äº**æŠŠçœ‹ä¼¼å¤æ‚çš„çº¿æ€§å›å½’å…¬å¼**æ‹†æˆ**å››ä¸ªå¯åŒºé—´ç»´æŠ¤çš„ç®€å•ç»Ÿè®¡é‡**ï¼Œå¹¶ç”¨**çº¿æ®µæ ‘/åˆ†å—**é«˜æ•ˆåœ°æ”¯æŒåŒºé—´åŠ ã€åŒºé—´è¦†ç›–ä¸åŒºé—´æŸ¥è¯¢ã€‚â€

âœ¨ **æ ¸å¿ƒç®—æ³•æ ‡ç­¾**ï¼š  
åŒºé—´ç»´æŠ¤ã€æ•°å­¦æ¨å¯¼ã€çº¿æ®µæ ‘ï¼ˆSegment Treeï¼‰ã€åˆ†å—ï¼ˆBlockingï¼‰ã€Lazy ä¼ æ’­ã€‚

ğŸ—£ï¸ **åˆæ­¥åˆ†æ**ï¼š  
- é¢˜ç›®ç»™å‡ºäº†ä¸€ä¸ªçº¿æ€§å›å½’æ–œç‡å…¬å¼ï¼Œè¦æ±‚æ”¯æŒä¸‰ç§æ“ä½œï¼š  
  1. æŸ¥è¯¢åŒºé—´ [L, R] çš„æ–œç‡ aã€‚  
  2. åŒºé—´ [L, R] å†… x_i åŠ  Sï¼Œy_i åŠ  Tã€‚  
  3. åŒºé—´ [L, R] å†… x_i æ”¹ä¸º S+iï¼Œy_i æ”¹ä¸º T+iã€‚  

- ç›´æ¥æš´åŠ›è®¡ç®—æ˜¾ç„¶ä¼šè¶…æ—¶ï¼ˆO(n) æŸ¥è¯¢ Ã— 1e5 æ¬¡ = 1e10ï¼‰ã€‚  
- å…³é”®åœ¨äº**æ•°å­¦åŒ–ç®€** + **æ•°æ®ç»“æ„**ï¼ˆçº¿æ®µæ ‘/åˆ†å—ï¼‰æ”¯æŒåŒºé—´æ“ä½œã€‚

### ğŸ” ç®—æ³•ä¾¦æ¢ï¼šå¦‚ä½•åœ¨é¢˜ç›®ä¸­å‘ç°çº¿ç´¢ï¼Ÿ

1. **çº¿ç´¢1 (é—®é¢˜ç›®æ ‡)**ï¼š  
   â€œé¢˜ç›®è¦æ±‚æˆ‘ä»¬åœ¨ç»™å®šåŒºé—´å†…**æ±‚ä¸€ä¸ªæœ€ä¼˜åŒ–ç»Ÿè®¡é‡**ï¼ˆæ–œç‡ aï¼‰ï¼Œè¿™æš—ç¤ºæˆ‘ä»¬éœ€è¦**ç»´æŠ¤å¤šä¸ªå¯åŠ æ€§ç»Ÿè®¡é‡**ã€‚â€

2. **çº¿ç´¢2 (é—®é¢˜çº¦æŸ/ç‰¹æ€§)**ï¼š  
   â€œæ“ä½œ2å’Œæ“ä½œ3éƒ½æ˜¯**åŒºé—´ä¿®æ”¹**ï¼Œä¸”æ“ä½œ3æ˜¯**è¦†ç›–å¼ä¿®æ”¹**ï¼Œè¿™å¼ºçƒˆæŒ‡å‘**çº¿æ®µæ ‘æˆ–åˆ†å—**çš„ Lazy æ ‡è®°æŠ€å·§ã€‚â€

3. **çº¿ç´¢3 (æ•°æ®è§„æ¨¡)**ï¼š  
   â€œn, m â‰¤ 1e5ï¼Œæ„å‘³ç€æˆ‘ä»¬éœ€è¦**O(log n) æˆ– O(âˆšn)** çš„æ¯æ¬¡æ“ä½œå¤æ‚åº¦ã€‚â€

### ğŸ§  æ€ç»´é“¾æ„å»ºï¼šä»çº¿ç´¢åˆ°ç­–ç•¥

> â€œå¥½äº†ï¼Œä¾¦æ¢å·¥ä½œå®Œæˆï¼Œæˆ‘ä»¬æ”¶é›†åˆ°äº†å‡ æ¡å…³é”®çº¿ç´¢ã€‚ç°åœ¨ï¼Œè®©æˆ‘ä»¬åƒæ‹¼å›¾ä¸€æ ·æŠŠå®ƒä»¬ç»„åˆèµ·æ¥ï¼š  
> 1. é¦–å…ˆï¼Œã€çº¿ç´¢1ï¼šé—®é¢˜ç›®æ ‡ã€‘å‘Šè¯‰æˆ‘ä»¬éœ€è¦ç»´æŠ¤å››ä¸ªå¯åŠ æ€§ç»Ÿè®¡é‡ï¼šÎ£x, Î£y, Î£xÂ², Î£xyã€‚  
> 2. æ¥ç€ï¼Œã€çº¿ç´¢2ï¼šé—®é¢˜ç‰¹æ€§ã€‘æç¤ºæˆ‘ä»¬ä½¿ç”¨çº¿æ®µæ ‘æˆ–åˆ†å—æ¥æ”¯æŒåŒºé—´åŠ å’ŒåŒºé—´è¦†ç›–ã€‚  
> 3. æœ€åï¼Œã€çº¿ç´¢3ï¼šæ•°æ®è§„æ¨¡ã€‘ç»™äº†æˆ‘ä»¬æœ€ç»ˆåˆ¤å†³â€”â€”çº¿æ®µæ ‘æˆ–åˆ†å—éƒ½èƒ½åœ¨ O(log n) æˆ– O(âˆšn) æ—¶é—´å†…å®Œæˆæ“ä½œã€‚  
> **ç»“è®º**ï¼šç»¼åˆä»¥ä¸Šï¼Œæˆ‘ä»¬éœ€è¦**å…ˆåŒ–ç®€å…¬å¼**ï¼Œå†ç”¨**çº¿æ®µæ ‘æˆ–åˆ†å—**ç»´æŠ¤å››ä¸ªç»Ÿè®¡é‡ã€‚è¿™å°±æ˜¯æˆ‘ä»¬æ¥ä¸‹æ¥è¦æ·±å…¥ç ”ç©¶çš„ä¸»æ”»æ–¹å‘ï¼â€

---

## 2. ç²¾é€‰ä¼˜è´¨é¢˜è§£å‚è€ƒ

æˆ‘ç»¼åˆäº† 8 ç¯‡é«˜èµé¢˜è§£ï¼Œä»æ€è·¯æ¸…æ™°åº¦ã€ä»£ç è§„èŒƒæ€§ã€ç®—æ³•æœ‰æ•ˆæ€§ç­‰ç»´åº¦ï¼Œä¸ºå¤§å®¶ç²¾é€‰äº†ä»¥ä¸‹ 3 ç¯‡æœ€å…·ä»£è¡¨æ€§çš„é¢˜è§£ï¼š

### é¢˜è§£ä¸€ï¼šliangbowenï¼ˆèµï¼š26ï¼‰  
- **ç‚¹è¯„**ï¼š  
  è¿™ç¯‡é¢˜è§£çš„æœ€å¤§äº®ç‚¹æ˜¯**æ•°å­¦æ¨å¯¼æå…¶ä¸¥è°¨**ã€‚ä½œè€…ç”¨ä¸€æ­¥æ­¥å±•å¼€çš„æ–¹å¼ï¼Œå°†åŸæœ¬å¤æ‚çš„çº¿æ€§å›å½’å…¬å¼åŒ–ç®€ä¸ºä»…éœ€ç»´æŠ¤ Î£x, Î£y, Î£xÂ², Î£xy çš„å½¢å¼ï¼Œå¤§å¤§é™ä½äº†æ€ç»´éš¾åº¦ã€‚  
  ä»£ç ä¸Šï¼Œä½œè€…ç”¨ç»“æ„ä½“å°è£…çº¿æ®µæ ‘èŠ‚ç‚¹ï¼Œé‡è½½è¿ç®—ç¬¦ï¼Œä½¿å¾—ä»£ç ç®€æ´æ˜“æ‡‚ã€‚Lazy æ ‡è®°çš„å¤„ç†é€»è¾‘æ¸…æ™°ï¼Œå°¤å…¶æ˜¯ rebuild å’Œ lazy å‡½æ•°çš„åˆ†ç¦»ï¼Œä½“ç°äº†è‰¯å¥½çš„æ¨¡å—åŒ–è®¾è®¡ã€‚

### é¢˜è§£äºŒï¼šCapellaï¼ˆèµï¼š14ï¼‰  
- **ç‚¹è¯„**ï¼š  
  Capella çš„é¢˜è§£åœ¨**æ ‡è®°ä¸‹ä¼ é¡ºåº**ä¸Šæœ‰ç‹¬åˆ°è§è§£ã€‚ä½œè€…æŒ‡å‡ºï¼šå½“â€œåŒºé—´è¦†ç›–â€å’Œâ€œåŒºé—´åŠ â€åŒæ—¶å­˜åœ¨æ—¶ï¼Œå¿…é¡»å…ˆå¤„ç†è¦†ç›–ï¼Œå†å¤„ç†åŠ æ³•ã€‚è¿™ä¸€ç‚¹åœ¨å®ç°ä¸­éå¸¸å…³é”®ï¼Œé¿å…äº†å¾ˆå¤šæ½œåœ¨çš„é”™è¯¯ã€‚  
  ä»£ç é£æ ¼ä¸Šï¼Œä½œè€…å°†çº¿æ®µæ ‘å°è£…æˆç±»ï¼Œç§æœ‰å‡½æ•°å’Œå…¬æœ‰å‡½æ•°åˆ†ç¦»ï¼Œä½“ç°äº†è‰¯å¥½çš„é¢å‘å¯¹è±¡è®¾è®¡æ€æƒ³ã€‚

### é¢˜è§£ä¸‰ï¼šRainybunnyï¼ˆèµï¼š8ï¼‰  
- **ç‚¹è¯„**ï¼š  
  Rainybunny çš„é¢˜è§£ç”¨**åˆ†å—**è€Œéçº¿æ®µæ ‘ï¼Œå±•ç¤ºäº†å¦ä¸€ç§æ€è·¯ã€‚åˆ†å—åœ¨å¤„ç†åŒºé—´è¦†ç›–æ—¶æ›´ä¸ºç›´è§‚ï¼Œä¸”å¸¸æ•°è¾ƒå°ã€‚ä½œè€…åœ¨ç»´æŠ¤å››ä¸ªç»Ÿè®¡é‡æ—¶ï¼Œä½¿ç”¨äº†å¹³æ–¹å’Œå…¬å¼å’Œç­‰å·®æ•°åˆ—æ±‚å’Œå…¬å¼ï¼Œä½“ç°äº†æ•°å­¦ä¸ç®—æ³•çš„å®Œç¾ç»“åˆã€‚  
  ä»£ç ä¸Šï¼Œä½œè€…ç”¨ clear å‡½æ•°ç»Ÿä¸€å¤„ç†ç¢å—ï¼Œé€»è¾‘æ¸…æ™°ï¼Œæ˜“äºç†è§£ã€‚

---

## 3. è§£é¢˜ç­–ç•¥æ·±åº¦å‰–æ

### ğŸ¯ æ ¸å¿ƒéš¾ç‚¹ä¸å…³é”®æ­¥éª¤ï¼ˆæœ€ä¼˜è§£æ³•å‰–æï¼‰

1. **å…³é”®ç‚¹1ï¼šæ•°å­¦åŒ–ç®€**  
   - **åˆ†æ**ï¼š  
     å°†æ–œç‡å…¬å¼å±•å¼€ï¼š  
     a = [Î£(xy) - Î£xÂ·Î£y / len] / [Î£(xÂ²) - (Î£x)Â² / len]  
     è¿™æ ·åªéœ€ç»´æŠ¤ Î£x, Î£y, Î£xÂ², Î£xy å››ä¸ªé‡ã€‚  
   - ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼š  
     å¤æ‚çš„ç»Ÿè®¡é‡å¾€å¾€å¯ä»¥æ‹†æˆå¤šä¸ªç®€å•çš„å¯åŠ æ€§é‡ã€‚

2. **å…³é”®ç‚¹2ï¼šçº¿æ®µæ ‘èŠ‚ç‚¹è®¾è®¡**  
   - **åˆ†æ**ï¼š  
     æ¯ä¸ªèŠ‚ç‚¹å­˜å‚¨å››ä¸ªç»Ÿè®¡é‡ï¼Œä»¥åŠä¸¤ä¸ª Lazy æ ‡è®°ï¼š  
     - addX, addYï¼šåŒºé—´åŠ æ ‡è®°ã€‚  
     - setX, setYï¼šåŒºé—´è¦†ç›–æ ‡è®°ã€‚  
   - ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼š  
     è¦†ç›–æ ‡è®°ä¼˜å…ˆçº§é«˜äºåŠ æ³•æ ‡è®°ï¼Œä¸‹ä¼ æ—¶éœ€å…ˆå¤„ç†è¦†ç›–ã€‚

3. **å…³é”®ç‚¹3ï¼šæ ‡è®°ä¸‹ä¼ é¡ºåº**  
   - **åˆ†æ**ï¼š  
     è‹¥å½“å‰èŠ‚ç‚¹æœ‰è¦†ç›–æ ‡è®°ï¼Œå…ˆæ¸…ç©ºåŠ æ³•æ ‡è®°ï¼Œå†ä¸‹ä¼ è¦†ç›–ï¼›  
     ç„¶åä¸‹ä¼ åŠ æ³•æ ‡è®°ã€‚  
   - ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼š  
     æ ‡è®°çš„ä¼˜å…ˆçº§å’Œä¸‹ä¼ é¡ºåºæ˜¯çº¿æ®µæ ‘å®ç°çš„å…³é”®ã€‚

### âœ¨ è§£é¢˜æŠ€å·§æ€»ç»“

- **æŠ€å·§Aï¼šæ•°å­¦åŒ–ç®€**  
  å°†å¤æ‚å…¬å¼æ‹†æˆå¯åŠ æ€§ç»Ÿè®¡é‡ï¼Œæ˜¯åŒºé—´é—®é¢˜çš„é€šç”¨æŠ€å·§ã€‚

- **æŠ€å·§Bï¼šLazy æ ‡è®°è®¾è®¡**  
  ä¸ºæ¯ç§æ“ä½œè®¾è®¡ç‹¬ç«‹çš„ Lazy æ ‡è®°ï¼Œå¹¶æ˜ç¡®ä¼˜å…ˆçº§ã€‚

- **æŠ€å·§Cï¼šç²¾åº¦å¤„ç†**  
  ä½¿ç”¨ double æˆ– long double é¿å…ç²¾åº¦è¯¯å·®ã€‚

### âš”ï¸ ç­–ç•¥ç«æŠ€åœºï¼šä¸åŒè§£æ³•çš„å¯¹æ¯”åˆ†æ

| ç­–ç•¥ | æ ¸å¿ƒæ€æƒ³ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
| :--- | :--- | :--- | :--- | :--- |
| **æš´åŠ›** | O(n) æ¯æ¬¡æ“ä½œ | å®ç°ç®€å• | è¶…æ—¶ | n â‰¤ 1000 |
| **çº¿æ®µæ ‘** | O(log n) æ¯æ¬¡æ“ä½œ | é«˜æ•ˆã€é€šç”¨ | ä»£ç è¾ƒé•¿ | n â‰¤ 1e5 |
| **åˆ†å—** | O(âˆšn) æ¯æ¬¡æ“ä½œ | å®ç°ç›´è§‚ã€å¸¸æ•°å° | å¤æ‚åº¦ç•¥é«˜ | n â‰¤ 1e5 |

### âœ¨ ä¼˜åŒ–ä¹‹æ—…ï¼šä»â€œèƒ½åšâ€åˆ°â€œåšå¥½â€

> â€œä»æš´åŠ›åˆ°çº¿æ®µæ ‘ï¼Œæˆ‘ä»¬ç»å†äº†æ•°å­¦åŒ–ç®€ä¸æ•°æ®ç»“æ„çš„åŒé‡ä¼˜åŒ–ã€‚  
> æ•°å­¦åŒ–ç®€è®©æˆ‘ä»¬æŠŠä¸å¯ç»´æŠ¤çš„é—®é¢˜è½¬åŒ–ä¸ºå¯ç»´æŠ¤çš„ç»Ÿè®¡é‡ï¼›  
> çº¿æ®µæ ‘è®©æˆ‘ä»¬æŠŠ O(n) ä¼˜åŒ–åˆ° O(log n)ã€‚  
> è¿™å°±æ˜¯ç®—æ³•ä¹‹ç¾ï¼â€

---

## 4. C++æ ¸å¿ƒä»£ç å®ç°èµæ

### æœ¬é¢˜é€šç”¨æ ¸å¿ƒC++å®ç°å‚è€ƒ

**è¯´æ˜**ï¼š  
ç»¼åˆ liangbowen ä¸ Capella çš„ä»£ç ï¼Œæç‚¼å‡ºä¸€ä»½**ç®€æ´ã€å®Œæ•´ã€æ˜“è¯»**çš„çº¿æ®µæ ‘å®ç°ã€‚

**å®Œæ•´æ ¸å¿ƒä»£ç **ï¼š
```cpp
#include <bits/stdc++.h>
using namespace std;
typedef double db;
const int N = 1e5 + 10;
struct Node {
    db x, y, x2, xy;
    db addX = 0, addY = 0;
    bool cov = 0;
    Node() { x = y = x2 = xy = addX = addY = cov = 0; }
};
Node tr[N << 2];
db kx[N], ky[N];
int n, m;

Node operator+(Node a, Node b) {
    Node c;
    c.x = a.x + b.x;
    c.y = a.y + b.y;
    c.x2 = a.x2 + b.x2;
    c.xy = a.xy + b.xy;
    return c;
}

void build(int l, int r, int p) {
    if (l == r) {
        tr[p].x = kx[l];
        tr[p].y = ky[l];
        tr[p].x2 = kx[l] * kx[l];
        tr[p].xy = kx[l] * ky[l];
        return;
    }
    int mid = (l + r) >> 1;
    build(l, mid, p << 1);
    build(mid + 1, r, p << 1 | 1);
    tr[p] = tr[p << 1] + tr[p << 1 | 1];
}

void push_add(int l, int r, int p, db S, db T) {
    int len = r - l + 1;
    tr[p].xy += T * tr[p].x + S * tr[p].y + S * T * len;
    tr[p].x2 += 2 * S * tr[p].x + S * S * len;
    tr[p].x += S * len;
    tr[p].y += T * len;
    tr[p].addX += S;
    tr[p].addY += T;
}

void push_cov(int l, int r, int p, db S, db T) {
    int len = r - l + 1;
    db sum_i = 1.0 * (l + r) * len / 2;
    db sum_i2 = 1.0 * r * (r + 1) * (2 * r + 1) / 6 - 1.0 * (l - 1) * l * (2 * l - 1) / 6;
    tr[p].x = S * len + sum_i;
    tr[p].y = T * len + sum_i;
    tr[p].x2 = S * S * len + S * (l + r) * len + sum_i2;
    tr[p].xy = S * T * len + (S + T) * sum_i + sum_i2;
    tr[p].addX = tr[p].addY = 0;
    tr[p].cov = 1;
}

void push_down(int l, int r, int p) {
    int mid = (l + r) >> 1;
    if (tr[p].cov) {
        push_cov(l, mid, p << 1, 0, 0);
        push_cov(mid + 1, r, p << 1 | 1, 0, 0);
        tr[p].cov = 0;
    }
    push_add(l, mid, p << 1, tr[p].addX, tr[p].addY);
    push_add(mid + 1, r, p << 1 | 1, tr[p].addX, tr[p].addY);
    tr[p].addX = tr[p].addY = 0;
}

void update_add(int l, int r, int p, int L, int R, db S, db T) {
    if (L <= l && r <= R) return push_add(l, r, p, S, T);
    push_down(l, r, p);
    int mid = (l + r) >> 1;
    if (L <= mid) update_add(l, mid, p << 1, L, R, S, T);
    if (R > mid) update_add(mid + 1, r, p << 1 | 1, L, R, S, T);
    tr[p] = tr[p << 1] + tr[p << 1 | 1];
}

void update_cov(int l, int r, int p, int L, int R, db S, db T) {
    if (L <= l && r <= R) {
        push_cov(l, r, p, S, T);
        return;
    }
    push_down(l, r, p);
    int mid = (l + r) >> 1;
    if (L <= mid) update_cov(l, mid, p << 1, L, R, S, T);
    if (R > mid) update_cov(mid + 1, r, p << 1 | 1, L, R, S, T);
    tr[p] = tr[p << 1] + tr[p << 1 | 1];
}

Node query(int l, int r, int p, int L, int R) {
    if (L <= l && r <= R) return tr[p];
    push_down(l, r, p);
    int mid = (l + r) >> 1;
    Node res;
    if (L <= mid) res = res + query(l, mid, p << 1, L, R);
    if (R > mid) res = res + query(mid + 1, r, p << 1 | 1, L, R);
    return res;
}

int main() {
    scanf("%d%d", &n, &m);
    for (int i = 1; i <= n; i++) scanf("%lf", &kx[i]);
    for (int i = 1; i <= n; i++) scanf("%lf", &ky[i]);
    build(1, n, 1);
    while (m--) {
        int op, l, r;
        db S, T;
        scanf("%d%d%d", &op, &l, &r);
        if (op == 1) {
            Node res = query(1, n, 1, l, r);
            db len = r - l + 1;
            db fz = res.xy - res.x * res.y / len;
            db fm = res.x2 - res.x * res.x / len;
            printf("%.10lf\n", fz / fm);
        } else {
            scanf("%lf%lf", &S, &T);
            if (op == 2) update_add(1, n, 1, l, r, S, T);
            else update_cov(1, n, 1, l, r, S, T);
        }
    }
    return 0;
}
```

**ä»£ç è§£è¯»æ¦‚è¦**ï¼š  
- ç”¨ç»“æ„ä½“ Node å­˜å‚¨å››ä¸ªç»Ÿè®¡é‡å’Œ Lazy æ ‡è®°ã€‚  
- push_add å’Œ push_cov åˆ†åˆ«å¤„ç†åŒºé—´åŠ å’ŒåŒºé—´è¦†ç›–ã€‚  
- push_down ç¡®ä¿æ ‡è®°æ­£ç¡®ä¸‹ä¼ ï¼Œä¼˜å…ˆçº§ï¼šè¦†ç›– > åŠ æ³•ã€‚  
- æŸ¥è¯¢æ—¶ç›´æ¥ä»£å…¥åŒ–ç®€åçš„å…¬å¼è®¡ç®—æ–œç‡ã€‚

---

## 5. ç®—æ³•å¯è§†åŒ–ï¼šåƒç´ åŠ¨ç”»æ¼”ç¤º

**åŠ¨ç”»æ¼”ç¤ºä¸»é¢˜**ï¼šâ€œåƒç´ ç»Ÿè®¡å¸ˆâ€  
ç”¨ 8 ä½åƒç´ é£æ ¼å±•ç¤ºçº¿æ®µæ ‘å¦‚ä½•ç»´æŠ¤ Î£x, Î£y, Î£xÂ², Î£xyï¼Œå¹¶åœ¨æ¯æ¬¡æ“ä½œåæ›´æ–°åŒºé—´å€¼ã€‚

**æ ¸å¿ƒæ¼”ç¤ºå†…å®¹**ï¼š
1. åˆå§‹åŒ–ï¼šåƒç´ åŒ–æ•°ç»„å±•ç¤ºåˆå§‹ x, y å€¼ã€‚  
2. æ“ä½œ2ï¼ˆåŒºé—´åŠ ï¼‰ï¼šåƒç´ å—é—ªçƒè¡¨ç¤ºåŠ  S å’Œ Tï¼Œç»Ÿè®¡é‡å®æ—¶æ›´æ–°ã€‚  
3. æ“ä½œ3ï¼ˆåŒºé—´è¦†ç›–ï¼‰ï¼šåƒç´ å—é‡ç½®ä¸º S+i, T+iï¼Œç»Ÿè®¡é‡é‡æ–°è®¡ç®—ã€‚  
4. æŸ¥è¯¢ï¼šé«˜äº®åŒºé—´ï¼Œè®¡ç®—å¹¶å±•ç¤ºæ–œç‡ aã€‚

**è®¾è®¡æ€è·¯ç®€è¿°**ï¼š  
- 8 ä½åƒç´ é£è¥é€ å¤å¤å­¦ä¹ æ°›å›´ã€‚  
- é¢œè‰²ç¼–ç ï¼šç»¿è‰²è¡¨ç¤º Î£xï¼Œè“è‰²è¡¨ç¤º Î£yï¼Œçº¢è‰²è¡¨ç¤º Î£xÂ²ï¼Œé»„è‰²è¡¨ç¤º Î£xyã€‚  
- éŸ³æ•ˆï¼šæ¯æ¬¡æ›´æ–°æ’­æ”¾â€œå®â€å£°ï¼ŒæŸ¥è¯¢å®Œæˆæ’­æ”¾èƒœåˆ©éŸ³æ•ˆã€‚

---

## 6. æ‹“å±•ç»ƒä¹ ä¸ç›¸ä¼¼é—®é¢˜æ€è€ƒ

**é€šç”¨æ€è·¯è¿ç§»**ï¼š
1. ä»»æ„åŒºé—´ç»Ÿè®¡é‡é—®é¢˜ï¼ˆå¦‚æ–¹å·®ã€åæ–¹å·®ï¼‰éƒ½å¯æ‹†æˆå¯åŠ æ€§é‡ã€‚  
2. åŒºé—´è¦†ç›– + åŒºé—´åŠ çš„ç»„åˆæ“ä½œï¼Œå¯æ¨å¹¿åˆ°é¢œè‰²æ®µå‡æ‘Šé—®é¢˜ã€‚  
3. çº¿æ€§å›å½’æ€æƒ³å¯ç”¨äºæœºå™¨å­¦ä¹ ä¸­çš„ç‰¹å¾å·¥ç¨‹ã€‚

**æ´›è°·æ¨è**ï¼š
1. **P3372** - çº¿æ®µæ ‘æ¨¡æ¿1ï¼šå·©å›ºåŒºé—´åŠ ä¸åŒºé—´æ±‚å’Œã€‚  
2. **P3373** - çº¿æ®µæ ‘æ¨¡æ¿2ï¼šåŒºé—´ä¹˜ + åŒºé—´åŠ ï¼Œæ ‡è®°ä¼˜å…ˆçº§ç»ƒä¹ ã€‚  
3. **P1471** - æ–¹å·®ï¼šåŒæ ·æ˜¯åŒºé—´ç»Ÿè®¡é‡ç»´æŠ¤ï¼Œéœ€ç»´æŠ¤ Î£x å’Œ Î£xÂ²ã€‚

---

## 7. å­¦ä¹ å¿ƒå¾—ä¸ç»éªŒåˆ†äº«

> **æ¥è‡ª liangbowen çš„è°ƒè¯•å¿ƒå¾—**ï¼š  
> â€œæˆ‘åœ¨å†™ push_down æ—¶ï¼Œæ›¾å› å¿˜è®°æ¸…ç©º add æ ‡è®°å¯¼è‡´ WAã€‚åæ¥é€šè¿‡æ‰“å°æ¯ä¸ªèŠ‚ç‚¹çš„æ ‡è®°å€¼ï¼Œå‘ç°è¦†ç›–æ“ä½œå add æ ‡è®°ä»æ®‹ç•™ã€‚æé†’å¤§å®¶åœ¨å®ç°çº¿æ®µæ ‘æ—¶ï¼Œ**æ ‡è®°çš„ä¼˜å…ˆçº§å’Œä¸‹ä¼ é¡ºåº**ä¸€å®šè¦æ¸…æ™°ï¼â€

---

> â€œæœ¬æ¬¡å…³äºâ€˜[SDOI2017] ç›¸å…³åˆ†æâ€™çš„C++è§£é¢˜åˆ†æå°±åˆ°è¿™é‡Œã€‚  
> è®°ä½ï¼šæ•°å­¦åŒ–ç®€ + æ•°æ®ç»“æ„ = è§£å†³åŒºé—´é—®é¢˜çš„ä¸‡èƒ½é’¥åŒ™ï¼  
> ä¸‹æ¬¡æˆ‘ä»¬å†ä¸€èµ·æ¢ç´¢æ–°çš„ç¼–ç¨‹æŒ‘æˆ˜ï¼ğŸ’ªâ€

---
å¤„ç†ç”¨æ—¶ï¼š155.22ç§’
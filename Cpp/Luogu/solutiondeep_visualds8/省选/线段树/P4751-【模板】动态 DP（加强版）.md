# é¢˜ç›®ä¿¡æ¯

# ã€æ¨¡æ¿ã€‘åŠ¨æ€ DPï¼ˆåŠ å¼ºç‰ˆï¼‰

## é¢˜ç›®èƒŒæ™¯

æ ‘å‰–å¸¸æ•°å°ï¼è·‘ä¸æ»¡ï¼

shadowice1984 ä¸ºäº†å‘ä½ è¯æ˜ä»–èƒ½å¡æ ‘å‰–å¹¶ä¸”ä¼šå¡æ ‘å‰–ä»è€Œå‡ºäº†è¿™é“æ¯’ç˜¤é¢˜ã€‚

ä¿è¯ç­”æ¡ˆå‡åœ¨ `int` èŒƒå›´å†…ã€‚

ç„¶åå°±è¢«ç¦»çº¿ç®—æ³•é’ˆå¯¹äº†â€¦â€¦

å› æ­¤è¿™é“é¢˜å˜æˆäº†å¼ºåˆ¶åœ¨çº¿ã€‚


## é¢˜ç›®æè¿°

åŒ [P4719](https://www.luogu.com.cn/problem/P4719)ã€‚

ç»™å®šä¸€ä¸ª $n$ ä¸ªç‚¹çš„å¸¦ç‚¹æƒæ ‘ï¼Œè¿›è¡Œ $m$ æ¬¡ä¿®æ”¹ç‚¹æƒçš„æ“ä½œã€‚

ä½ éœ€è¦åœ¨æ¯æ¬¡ä¿®æ”¹ä¹‹åè¾“å‡ºæ ‘ä¸Šæœ€å¤§å¸¦æƒç‹¬ç«‹é›†çš„æƒå€¼ä¹‹å’Œã€‚

## è¯´æ˜/æç¤º

æ•°æ®èŒƒå›´ $n \leq 1 \times 10^6$ï¼Œ$m \leq 3 \times 10^6$ã€‚ä¿è¯ä»»æ„æ—¶åˆ»å„ç‚¹ç‚¹æƒçš„ç»å¯¹å€¼ $\leq 100$ã€‚

æ—¶é™ä¸ºæ ‡ç¨‹çš„äºŒå€ï¼Œå¦‚æœå¡å¸¸æ•°çš„è¯è¯·ä½¿ç”¨ `int` ç±»å‹ã€‚

## æ ·ä¾‹ #1

### è¾“å…¥

```
10 10
-11 80 -99 -76 56 38 92 -51 -34 47
2 1
3 1
4 3
5 2
6 2
7 1
8 2
9 4
10 7
9 -44
184 -17
184 98
185 -58
153 48
190 99
296 -61
253 76
329 14
264 93
```

### è¾“å‡º

```
186
186
190
145
189
288
244
320
258
304```

# AIåˆ†æç»“æœ

# ğŸ’¡ æ´›è¯­äº‘ç¬ºçš„ C++ ç®—æ³•è§£æï¼šã€ŒåŠ¨æ€ DPï¼ˆåŠ å¼ºç‰ˆï¼‰ã€æ·±å…¥å­¦ä¹ æŒ‡å— ğŸ’¡

> å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯ä½ ä»¬çš„ç®—æ³•å¯¼å¸ˆâ€”â€”æ´›è¯­äº‘ç¬ºã€‚ä»Šå¤©æˆ‘ä»¬è¦æŒ‘æˆ˜çš„æ˜¯ä¸€é“**é«˜é˜¶æ•°æ®ç»“æ„**ç»¼åˆé¢˜ï¼šåœ¨**ç™¾ä¸‡èŠ‚ç‚¹**çš„æ ‘ä¸Šï¼Œè¿›è¡Œ**ç™¾ä¸‡æ¬¡**ç‚¹æƒä¿®æ”¹ï¼Œå¹¶å®æ—¶æ±‚å‡º**æœ€å¤§æƒç‹¬ç«‹é›†**ï¼è¿™ä¸ä»…è€ƒéªŒæˆ‘ä»¬å¯¹æ ‘å½¢ DP çš„æ·±åˆ»ç†è§£ï¼Œæ›´æ˜¯ä¸€æ¬¡å¯¹**åŠ¨æ€æ•°æ®ç»“æ„**æé™æ€§èƒ½çš„æ¢ç´¢ã€‚å‡†å¤‡å¥½äº†å—ï¼Ÿè®©æˆ‘ä»¬å¼€å§‹è¿™åœºæ€ç»´ä¸ä»£ç çš„ç››å®´ï¼

---

## 1. é¢˜ç›®è§£è¯»ä¸ç­–ç•¥åˆæ¢

### âœ¨ æœ¬é¢˜æ ¸å¿ƒæŒ‘æˆ˜
åœ¨ä¸€å¼ **ç™¾ä¸‡èŠ‚ç‚¹**çš„æ ‘ä¸Šï¼Œæ¯æ¬¡**åœ¨çº¿**ä¿®æ”¹ä¸€ä¸ªç‚¹çš„æƒå€¼åï¼Œç«‹å³è¾“å‡º**æ•´æ£µæ ‘çš„æœ€å¤§æƒç‹¬ç«‹é›†**çš„æƒå€¼å’Œã€‚

- **æœ€å¤§æƒç‹¬ç«‹é›†**ï¼šé€‰å‡ºä¸€ç»„ç‚¹ï¼Œä½¿å¾—ä»»æ„ä¸¤ç‚¹ä¹‹é—´æ²¡æœ‰è¾¹ç›¸è¿ï¼Œä¸”å®ƒä»¬çš„æƒå€¼å’Œæœ€å¤§ã€‚
- **åœ¨çº¿ä¿®æ”¹**ï¼šæ¯æ¬¡ä¿®æ”¹çš„èŠ‚ç‚¹ç¼–å·éœ€è¦**å¼‚æˆ–ä¸Šä¸€æ¬¡ç­”æ¡ˆ**ï¼ˆå¼ºåˆ¶åœ¨çº¿ï¼‰ã€‚

### âœ¨ æ ¸å¿ƒç®—æ³•æ ‡ç­¾
- **åŠ¨æ€ DP**ï¼ˆDynamic DPï¼‰
- **æ ‘é“¾å‰–åˆ†**ï¼ˆHeavy-Light Decomposition, HLDï¼‰
- **å…¨å±€å¹³è¡¡äºŒå‰æ ‘**ï¼ˆGlobal Balanced Binary Tree, GBBTï¼‰
- **çŸ©é˜µä¹˜æ³•ä¼˜åŒ–è½¬ç§»**ï¼ˆå¹¿ä¹‰çŸ©é˜µä¹˜æ³•ï¼‰

### ğŸ—£ï¸ åˆæ­¥åˆ†æ
è¿™é“é¢˜çš„æ ¸å¿ƒåœ¨äº**å¦‚ä½•åœ¨æ ‘ä¸Šé«˜æ•ˆç»´æŠ¤åŠ¨æ€ DP**ã€‚æœ´ç´ çš„æ ‘å½¢ DP æ¯æ¬¡ä¿®æ”¹åéœ€è¦é‡æ–°è®¡ç®—æ•´æ£µæ ‘ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º \(O(n)\)ï¼Œæ˜¾ç„¶æ— æ³•é€šè¿‡ç™¾ä¸‡çº§åˆ«çš„æ•°æ®ã€‚

æˆ‘ä»¬éœ€è¦ä¸€ç§**èƒ½å°†æ ‘å½¢ç»“æ„è½¬åŒ–ä¸ºçº¿æ€§ç»“æ„**çš„æ–¹æ³•ï¼Œä½¿å¾—æ¯æ¬¡ä¿®æ”¹åªéœ€è¦**å±€éƒ¨æ›´æ–°**ï¼Œå¹¶ä¸”èƒ½å¿«é€Ÿ**åˆå¹¶ä¿¡æ¯**ã€‚è¿™æ­£æ˜¯**åŠ¨æ€ DP**çš„ç”¨æ­¦ä¹‹åœ°ã€‚

### ğŸ” ç®—æ³•ä¾¦æ¢ï¼šå¦‚ä½•åœ¨é¢˜ç›®ä¸­å‘ç°çº¿ç´¢ï¼Ÿ

1. **çº¿ç´¢1ï¼ˆé—®é¢˜ç›®æ ‡ï¼‰**ï¼š  
   â€œæœ€å¤§æƒç‹¬ç«‹é›†â€æ˜¯ç»å…¸çš„æ ‘å½¢ DP é—®é¢˜ï¼Œä½†åŠ ä¸Šâ€œåŠ¨æ€ä¿®æ”¹â€åï¼Œç›´æ¥æš´åŠ› DP æ— æ³•æ‰¿å—ã€‚

2. **çº¿ç´¢2ï¼ˆé—®é¢˜ç‰¹æ€§ï¼‰**ï¼š  
   æ ‘çš„ç»“æ„æ˜¯**é™æ€çš„**ï¼ˆå½¢æ€ä¸å˜ï¼‰ï¼Œä½†ç‚¹æƒæ˜¯**åŠ¨æ€å˜åŒ–çš„**ã€‚è¿™æç¤ºæˆ‘ä»¬å¯ä»¥**é¢„å¤„ç†æ ‘çš„ç»“æ„**ï¼Œç„¶ååˆ©ç”¨**é«˜æ•ˆçš„æ•°æ®ç»“æ„**æ¥ç»´æŠ¤åŠ¨æ€ä¿¡æ¯ã€‚

3. **çº¿ç´¢3ï¼ˆæ•°æ®è§„æ¨¡ï¼‰**ï¼š  
   \(n \leq 10^6, m \leq 3 \times 10^6\)  
   è¿™è¦æ±‚æˆ‘ä»¬çš„ç®—æ³•å¿…é¡»æ˜¯**å•å¯¹æ•°çº§åˆ«**çš„ï¼ˆ\(O(\log n)\) æ¯æ¬¡ä¿®æ”¹ï¼‰ï¼Œå¦åˆ™ä¼šè¶…æ—¶ã€‚

### ğŸ§  æ€ç»´é“¾æ„å»ºï¼šä»çº¿ç´¢åˆ°ç­–ç•¥
> â€œå¥½äº†ï¼Œä¾¦æ¢å·¥ä½œå®Œæˆï¼ç°åœ¨è®©æˆ‘ä»¬åƒæ‹¼å›¾ä¸€æ ·ç»„åˆçº¿ç´¢ï¼š
> 1. **çº¿ç´¢1**å‘Šè¯‰æˆ‘ä»¬è¿™æ˜¯ä¸€ä¸ª**æ ‘å½¢ DP**é—®é¢˜ï¼Œä½†æš´åŠ› DP æ— æ³•é€šè¿‡ã€‚
> 2. **çº¿ç´¢2**æç¤ºæˆ‘ä»¬å¯ä»¥**é¢„å¤„ç†æ ‘çš„ç»“æ„**ï¼Œç„¶åç”¨**æ•°æ®ç»“æ„**ç»´æŠ¤åŠ¨æ€ä¿¡æ¯ã€‚
> 3. **çº¿ç´¢3**è¦æ±‚æˆ‘ä»¬çš„ç®—æ³•å¿…é¡»æ˜¯**\(O(\log n)\)**çš„ï¼Œè¿™æ’é™¤äº†**æ ‘å‰–+çº¿æ®µæ ‘**çš„\(O(\log^2 n)\)è§£æ³•ï¼ŒæŒ‡å‘äº†æ›´é«˜æ•ˆçš„**å…¨å±€å¹³è¡¡äºŒå‰æ ‘**æˆ–**LCT**ã€‚

---

## 2. ç²¾é€‰ä¼˜è´¨é¢˜è§£å‚è€ƒ

### ğŸŒŸ é¢˜è§£ä¸€ï¼šWuyanru çš„æ ‘å‰–å¡å¸¸ï¼ˆèµï¼š65ï¼‰
**æ ¸å¿ƒæ€æƒ³**ï¼š  
- ä½¿ç”¨**æ ‘é“¾å‰–åˆ†+çº¿æ®µæ ‘**ç»´æŠ¤çŸ©é˜µä¹˜ç§¯ï¼Œå°†å¤æ‚åº¦ä¼˜åŒ–åˆ°\(O(\log^2 n)\)ã€‚
- é€šè¿‡**å¡å¸¸æŠ€å·§**ï¼ˆå¿«è¯»ã€çŸ©é˜µå±•å¼€ã€é“¾å¼å‰å‘æ˜Ÿï¼‰å‹‰å¼ºé€šè¿‡ã€‚

**ç‚¹è¯„**ï¼š  
> è¿™ä»½é¢˜è§£å±•ç°äº†**æé™å¡å¸¸**çš„è‰ºæœ¯ï¼ä½œè€…é€šè¿‡**çŸ©é˜µä¹˜æ³•å±•å¼€**ã€**é“¾å¼å‰å‘æ˜Ÿ**ã€**å¿«è¯»å¿«å†™**ç­‰æŠ€å·§ï¼Œå°†\(O(\log^2 n)\)çš„è§£æ³•ä¼˜åŒ–åˆ°å¯æ¥å—èŒƒå›´ã€‚è™½ç„¶ç†è®ºå¤æ‚åº¦ä¸æ˜¯æœ€ä¼˜ï¼Œä½†å®æˆ˜ä»·å€¼æé«˜ï¼

### ğŸŒŸ é¢˜è§£äºŒï¼šGreat_Influence çš„ LCTï¼ˆèµï¼š28ï¼‰
**æ ¸å¿ƒæ€æƒ³**ï¼š  
- ä½¿ç”¨**Link-Cut Tree (LCT)**ç»´æŠ¤åŠ¨æ€ DPï¼Œå°†å¤æ‚åº¦ä¼˜åŒ–åˆ°\(O(\log n)\)ã€‚
- é€šè¿‡**Splay Tree**ç»´æŠ¤å®é“¾ï¼Œå®ç°é«˜æ•ˆçš„åŠ¨æ€ä¿®æ”¹ã€‚

**ç‚¹è¯„**ï¼š  
> LCT çš„ä¼˜é›…ä¹‹å¤„åœ¨äº**å°†æ ‘ç»“æ„åŠ¨æ€åŒ–**ï¼é€šè¿‡**è™šå®é“¾åˆ‡æ¢**ï¼Œæ¯æ¬¡ä¿®æ”¹åªéœ€è°ƒæ•´å±€éƒ¨ç»“æ„ï¼Œå¤æ‚åº¦ä¸¥æ ¼\(O(\log n)\)ã€‚è™½ç„¶å¸¸æ•°è¾ƒå¤§ï¼Œä½†æ€è·¯æ¸…æ™°ï¼Œä»£ç è§„èŒƒã€‚

### ğŸŒŸ é¢˜è§£ä¸‰ï¼šlingfunny çš„å…¨å±€å¹³è¡¡äºŒå‰æ ‘ï¼ˆèµï¼š19ï¼‰
**æ ¸å¿ƒæ€æƒ³**ï¼š  
- ä½¿ç”¨**å…¨å±€å¹³è¡¡äºŒå‰æ ‘ (GBBT)**ï¼Œå°†æ¯æ¡é‡é“¾æ„å»ºä¸º**å¸¦æƒå¹³è¡¡æ ‘**ï¼Œå®ç°\(O(\log n)\)çš„ä¸¥æ ¼å¤æ‚åº¦ã€‚
- é€šè¿‡**å¸¦æƒä¸­ç‚¹**åˆ†æ²»ï¼Œä¿è¯æ ‘é«˜ä¸º\(O(\log n)\)ã€‚

**ç‚¹è¯„**ï¼š  
> GBBT æ˜¯**æ ‘å‰–çš„ç»ˆæä¼˜åŒ–**ï¼å®ƒå·§å¦™åœ°ç»“åˆäº†**æ ‘é“¾å‰–åˆ†**å’Œ**å¹³è¡¡æ ‘**çš„æ€æƒ³ï¼Œæ—¢ä¿ç•™äº†æ ‘å‰–çš„ç›´è§‚æ€§ï¼Œåˆå®ç°äº†ä¸¥æ ¼çš„\(O(\log n)\)å¤æ‚åº¦ã€‚ä»£ç å®ç°ä¼˜é›…ï¼Œå€¼å¾—æ·±å…¥å­¦ä¹ ï¼

---

## 3. è§£é¢˜ç­–ç•¥æ·±åº¦å‰–æ

### ğŸ¯ æ ¸å¿ƒéš¾ç‚¹ä¸å…³é”®æ­¥éª¤ï¼ˆæœ€ä¼˜è§£æ³•ï¼šGBBTï¼‰

#### 1. **å…³é”®ç‚¹1ï¼šå¦‚ä½•å®šä¹‰åŠ¨æ€ DP çš„çŸ©é˜µè½¬ç§»ï¼Ÿ**
- **åˆ†æ**ï¼š  
  å°†æ ‘å½¢ DP è½¬åŒ–ä¸º**çŸ©é˜µä¹˜æ³•**ï¼š
  \[
  \begin{bmatrix}
  f_{u,0} \\ f_{u,1}
  \end{bmatrix}
  =
  \begin{bmatrix}
  g_{u,0} & g_{u,0} \\
  g_{u,1} & -\infty
  \end{bmatrix}
  \times
  \begin{bmatrix}
  f_{son,0} \\ f_{son,1}
  \end{bmatrix}
  \]
  å…¶ä¸­\(g_{u,0/1}\)ä¸º**è½»å„¿å­çš„è´¡çŒ®**ã€‚

- ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼š  
  çŸ©é˜µä¹˜æ³•çš„**å¹¿ä¹‰å®šä¹‰**ï¼ˆ\(\max\)å’Œ\(+\)ï¼‰æ˜¯åŠ¨æ€ DP çš„æ ¸å¿ƒï¼

#### 2. **å…³é”®ç‚¹2ï¼šå¦‚ä½•é«˜æ•ˆç»´æŠ¤çŸ©é˜µä¹˜ç§¯ï¼Ÿ**
- **åˆ†æ**ï¼š  
  å¯¹æ¯æ¡é‡é“¾æ„å»º**å…¨å±€å¹³è¡¡äºŒå‰æ ‘**ï¼Œé€šè¿‡**å¸¦æƒä¸­ç‚¹**åˆ†æ²»ä¿è¯æ ‘é«˜\(O(\log n)\)ã€‚

- ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼š  
  å¸¦æƒä¸­ç‚¹åˆ†æ²»æ˜¯ GBBT çš„ç²¾é«“ï¼Œç¡®ä¿æ¯æ¬¡ä¿®æ”¹åªéœ€è°ƒæ•´\(O(\log n)\)ä¸ªèŠ‚ç‚¹ï¼

#### 3. **å…³é”®ç‚¹3ï¼šå¦‚ä½•å¤„ç†å¼ºåˆ¶åœ¨çº¿ï¼Ÿ**
- **åˆ†æ**ï¼š  
  æ¯æ¬¡ä¿®æ”¹èŠ‚ç‚¹ç¼–å·éœ€**å¼‚æˆ–ä¸Šä¸€æ¬¡ç­”æ¡ˆ**ï¼Œéœ€ä½¿ç”¨**å¿«è¯»å¿«å†™**ä¼˜åŒ– IOã€‚

- ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼š  
  å¼ºåˆ¶åœ¨çº¿çš„é¢˜ç›®ï¼Œ**IOä¼˜åŒ–**å¾€å¾€æ˜¯å…³é”®ï¼

### âš”ï¸ ç­–ç•¥ç«æŠ€åœºï¼šä¸åŒè§£æ³•çš„å¯¹æ¯”åˆ†æ

| ç­–ç•¥ | æ ¸å¿ƒæ€æƒ³ | ä¼˜ç‚¹ | ç¼ºç‚¹ä¸åˆ†æ | é€‚ç”¨åœºæ™¯ |
| :--- | :--- | :--- | :--- | :--- |
| **æš´åŠ› DP** | æ¯æ¬¡ä¿®æ”¹åé‡æ–°è®¡ç®—æ•´æ£µæ ‘ | æ€è·¯ç›´è§‚ | **æ—¶é—´å¤æ‚åº¦\(O(nm)\)**ï¼Œæ— æ³•é€šè¿‡ | æ•°æ®è§„æ¨¡\(n \leq 10^3\) |
| **æ ‘å‰–+çº¿æ®µæ ‘** | æ ‘é“¾å‰–åˆ†+çº¿æ®µæ ‘ç»´æŠ¤çŸ©é˜µ | æ€è·¯æ¸…æ™°ï¼Œä»£ç è§„èŒƒ | **\(O(\log^2 n)\)**ï¼Œå¯èƒ½è¢«å¡å¸¸ | æ•°æ®è§„æ¨¡\(n \leq 10^5\) |
| **LCT** | Link-Cut Treeç»´æŠ¤åŠ¨æ€ DP | **ä¸¥æ ¼\(O(\log n)\)** | å¸¸æ•°è¾ƒå¤§ï¼Œä»£ç å¤æ‚ | æ•°æ®è§„æ¨¡\(n \leq 10^6\) |
| **GBBT** | å…¨å±€å¹³è¡¡äºŒå‰æ ‘ | **ä¸¥æ ¼\(O(\log n)\)**ï¼Œå¸¸æ•°è¾ƒå° | å®ç°å¤æ‚ | æ•°æ®è§„æ¨¡\(n \leq 10^6\) |

### âœ¨ ä¼˜åŒ–ä¹‹æ—…ï¼šä»â€œèƒ½åšâ€åˆ°â€œåšå¥½â€
> â€œä»æš´åŠ› DP åˆ° GBBTï¼Œæˆ‘ä»¬ç»å†äº†**ä¸‰æ¬¡é£è·ƒ**ï¼š
> 1. **ç¬¬ä¸€æ¬¡é£è·ƒ**ï¼šå°†æ ‘å½¢ DP è½¬åŒ–ä¸º**çŸ©é˜µä¹˜æ³•**ï¼Œåˆ©ç”¨**çº¿æ®µæ ‘**ç»´æŠ¤ï¼Œä»\(O(n)\)åˆ°\(O(\log^2 n)\)ã€‚
> 2. **ç¬¬äºŒæ¬¡é£è·ƒ**ï¼šå¼•å…¥**æ ‘é“¾å‰–åˆ†**ï¼Œå°†æ ‘ç»“æ„çº¿æ€§åŒ–ï¼Œè¿›ä¸€æ­¥ä¼˜åŒ–åˆ°\(O(\log^2 n)\)ã€‚
> 3. **ç¬¬ä¸‰æ¬¡é£è·ƒ**ï¼šä½¿ç”¨**å…¨å±€å¹³è¡¡äºŒå‰æ ‘**ï¼Œå°†å¤æ‚åº¦ä¸¥æ ¼ä¼˜åŒ–åˆ°\(O(\log n)\)ï¼Œå®ç°è´¨çš„é£è·ƒï¼â€

---

## 4. C++æ ¸å¿ƒä»£ç å®ç°èµæ

### ğŸŒŸ æœ¬é¢˜é€šç”¨æ ¸å¿ƒC++å®ç°ï¼ˆGBBTç‰ˆï¼‰

```cpp
#include <bits/stdc++.h>
using namespace std;
const int N = 1e6 + 10, INF = 1e9;

struct Matrix {
    int a[2][2];
    Matrix() { memset(a, -0x3f, sizeof a); }
    Matrix operator*(const Matrix& b) const {
        Matrix c;
        for (int i = 0; i < 2; ++i)
            for (int k = 0; k < 2; ++k) if (a[i][k] != -INF)
                for (int j = 0; j < 2; ++j) if (b.a[k][j] != -INF)
                    c.a[i][j] = max(c.a[i][j], a[i][k] + b.a[k][j]);
        return c;
    }
};

int n, m, a[N], fa[N], sz[N], son[N], top[N], dfn[N], idx[N], lsiz[N];
int g[2][N], f[2][N], root;
vector<int> G[N];

void dfs1(int u) {
    sz[u] = 1;
    for (int v : G[u]) if (v != fa[u]) {
        fa[v] = u;
        dfs1(v);
        sz[u] += sz[v];
        if (sz[v] > sz[son[u]]) son[u] = v;
    }
}

void dfs2(int u) {
    g[0][u] = 0, g[1][u] = a[u];
    for (int v : G[u]) if (v != fa[u] && v != son[u]) {
        dfs2(v);
        g[0][u] += max(f[0][v], f[1][v]);
        g[1][u] += f[0][v];
    }
    f[0][u] = g[0][u] + (son[u] ? max(f[0][son[u]], f[1][son[u]]) : 0);
    f[1][u] = g[1][u] + (son[u] ? f[0][son[u]] : 0);
}

struct Node {
    int ls, rs, fa;
    Matrix mat, sum;
} tr[N];

int build(int l, int r) {
    if (l > r) return 0;
    int mid = lower_bound(lsiz + l, lsiz + r + 1, (lsiz[l - 1] + lsiz[r]) / 2) - lsiz;
    int u = idx[mid];
    tr[u].ls = build(l, mid - 1);
    tr[u].rs = build(mid + 1, r);
    if (tr[u].ls) tr[tr[u].ls].fa = u;
    if (tr[u].rs) tr[tr[u].rs].fa = u;
    tr[u].mat = { {g[0][u], g[0][u]}, {g[1][u], -INF} };
    tr[u].sum = tr[tr[u].rs].sum * tr[u].mat * tr[tr[u].ls].sum;
    return u;
}

int main() {
    ios::sync_with_stdio(false);
    cin.tie(nullptr);
    cin >> n >> m;
    for (int i = 1; i <= n; ++i) cin >> a[i];
    for (int i = 1, u, v; i < n; ++i) {
        cin >> u >> v;
        G[u].push_back(v);
        G[v].push_back(u);
    }
    dfs1(1);
    dfs2(1);
    for (int u = 1, cur = 0; u <= n; ++u) if (top[u] == u) {
        for (int v = u; v; v = son[v]) {
            dfn[v] = ++cur;
            idx[cur] = v;
            lsiz[cur] = lsiz[cur - 1] + sz[v] - sz[son[v]];
        }
        root = build(dfn[u], dfn[bot[u]]);
        tr[root].fa = fa[u];
    }
    int lst = 0;
    while (m--) {
        int x, y;
        cin >> x >> y;
        x ^= lst;
        g[1][x] += y - a[x];
        a[x] = y;
        for (int u = x; u; u = tr[root].fa) {
            Matrix old = tr[root].sum;
            tr[u].mat = { {g[0][u], g[0][u]}, {g[1][u], -INF} };
            for (int v = u; v; v = tr[v].fa) {
                tr[v].sum = tr[tr[v].rs].sum * tr[v].mat * tr[tr[v].ls].sum;
                if (tr[v].fa && tr[tr[v].fa].ls != v && tr[tr[v].fa].rs != v) {
                    int p = tr[v].fa;
                    g[0][p] += max(tr[v].sum.a[0][0], tr[v].sum.a[1][0]) - max(old.a[0][0], old.a[1][0]);
                    g[1][p] += tr[v].sum.a[0][0] - old.a[0][0];
                    break;
                }
            }
        }
        cout << (lst = max(tr[root].sum.a[0][0], tr[root].sum.a[1][0])) << '\n';
    }
    return 0;
}
```

---

## 5. ç®—æ³•å¯è§†åŒ–ï¼šåƒç´ åŠ¨ç”»æ¼”ç¤º

### ğŸ® åŠ¨ç”»ä¸»é¢˜ï¼šåƒç´ æ¢é™©å®¶çš„åŠ¨æ€DPä¹‹æ—…
> æˆ‘ä»¬å°†ç”¨**8ä½åƒç´ é£**å±•ç¤ºGBBTçš„æ„å»ºä¸ä¿®æ”¹è¿‡ç¨‹ï¼

#### ğŸ¯ æ ¸å¿ƒæ¼”ç¤ºå†…å®¹
- **æ ‘çš„æ„å»º**ï¼šå±•ç¤ºå¦‚ä½•ä»æ ‘é“¾å‰–åˆ†åˆ°å¸¦æƒå¹³è¡¡äºŒå‰æ ‘çš„æ„å»ºã€‚
- **åŠ¨æ€ä¿®æ”¹**ï¼šæ¨¡æ‹ŸèŠ‚ç‚¹æƒå€¼å˜åŒ–åï¼Œå¦‚ä½•**å±€éƒ¨æ›´æ–°**å¹¶**å‘ä¸Šä¼ é€’**ä¿¡æ¯ã€‚

#### ğŸ¨ è®¾è®¡æ€è·¯
- **åƒç´ é£æ ¼**ï¼šä½¿ç”¨ç»å…¸FCçº¢ç™½æœºçš„**8è‰²è°ƒè‰²æ¿**ï¼ˆçº¢ã€ç»¿ã€è“ã€é»„ã€ç´«ã€é’ã€æ©™ã€é»‘ï¼‰ã€‚
- **æ•°æ®ç»“æ„å¯è§†åŒ–**ï¼š
  - **æ ‘èŠ‚ç‚¹**ï¼šç”¨åƒç´ æ–¹å—è¡¨ç¤ºï¼Œé¢œè‰²è¡¨ç¤ºèŠ‚ç‚¹çŠ¶æ€ï¼ˆé€‰/ä¸é€‰ï¼‰ã€‚
  - **çŸ©é˜µ**ï¼šç”¨2x2åƒç´ çŸ©é˜µå±•ç¤ºè½¬ç§»çŸ©é˜µçš„å€¼ã€‚
- **äº¤äº’è®¾è®¡**ï¼š
  - **æ­¥è¿›æ§åˆ¶**ï¼šå•æ­¥æ‰§è¡Œæˆ–è‡ªåŠ¨æ’­æ”¾ã€‚
  - **éŸ³æ•ˆæç¤º**ï¼šæ¯æ¬¡çŸ©é˜µä¹˜æ³•æ’­æ”¾â€œå®â€å£°ï¼Œä¿®æ”¹å®Œæˆæ’­æ”¾â€œèƒœåˆ©â€éŸ³æ•ˆã€‚

#### ğŸ•¹ï¸ åŠ¨ç”»æ­¥éª¤
1. **åˆå§‹åŒ–**ï¼šå±•ç¤ºæ ‘çš„åŸå§‹ç»“æ„ï¼Œæ ‡è®°é‡é“¾ã€‚
2. **æ„å»ºGBBT**ï¼šé€’å½’æ„å»ºå¸¦æƒå¹³è¡¡äºŒå‰æ ‘ï¼Œé«˜äº®å¸¦æƒä¸­ç‚¹ã€‚
3. **åŠ¨æ€ä¿®æ”¹**ï¼š
   - ä¿®æ”¹èŠ‚ç‚¹æƒå€¼ï¼Œæ›´æ–°å±€éƒ¨çŸ©é˜µã€‚
   - å‘ä¸Šä¼ é€’ä¿¡æ¯ï¼Œæ›´æ–°çˆ¶èŠ‚ç‚¹çŸ©é˜µã€‚
4. **æŸ¥è¯¢ç»“æœ**ï¼šå±•ç¤ºæ ¹èŠ‚ç‚¹çš„æœ€ç»ˆçŸ©é˜µï¼Œè¾“å‡ºæœ€å¤§ç‹¬ç«‹é›†å€¼ã€‚

---

## 6. æ‹“å±•ç»ƒä¹ ä¸ç›¸ä¼¼é—®é¢˜æ€è€ƒ

### ğŸ” é€šç”¨æ€è·¯è¿ç§»
åŠ¨æ€DPçš„æ ¸å¿ƒæ€æƒ³â€”â€”**å°†æ ‘å½¢DPè½¬åŒ–ä¸ºçŸ©é˜µä¹˜æ³•**ï¼Œé€‚ç”¨äºï¼š
1. **åŠ¨æ€ä¿®æ”¹è¾¹æƒ**ï¼šå¦‚ç»´æŠ¤æ ‘çš„ç›´å¾„ã€‚
2. **åŠ¨æ€ä¿®æ”¹å­æ ‘ä¿¡æ¯**ï¼šå¦‚ç»´æŠ¤å­æ ‘å’Œæˆ–æœ€å¤§å€¼ã€‚
3. **åŠ¨æ€ä¿®æ”¹è·¯å¾„ä¿¡æ¯**ï¼šå¦‚ç»´æŠ¤è·¯å¾„æœ€å¤§å€¼æˆ–å’Œã€‚

### ğŸ“š æ´›è°·æ¨èç»ƒä¹ 
1. **P4719** - ã€ŒåŠ¨æ€DPã€æ¨¡æ¿é¢˜  
   *æ¨èç†ç”±*ï¼šå·©å›ºæ ‘é“¾å‰–åˆ†+çº¿æ®µæ ‘çš„ç»å…¸å†™æ³•ã€‚
2. **P4751** - ã€ŒåŠ¨æ€DPã€åŠ å¼ºç‰ˆ  
   *æ¨èç†ç”±*ï¼šæŒ‘æˆ˜GBBTæˆ–LCTçš„ä¸¥æ ¼\(O(\log n)\)å®ç°ã€‚
3. **P3781** - ã€Œåˆ‡æ ‘æ¸¸æˆã€  
   *æ¨èç†ç”±*ï¼šTop Treeçš„åŠ¨æ€DPåº”ç”¨ï¼Œæ‹“å±•åˆ°æ›´å¤æ‚çš„æ ‘ç»“æ„ã€‚

---

## 7. å­¦ä¹ å¿ƒå¾—ä¸ç»éªŒåˆ†äº«

> **æ¥è‡ªWuyanruçš„è°ƒè¯•å¿ƒå¾—**ï¼š  
> â€œæˆ‘åœ¨å¡å¸¸è¿‡ç¨‹ä¸­å‘ç°ï¼Œ**çŸ©é˜µå±•å¼€çš„å¾ªç¯ä¼˜åŒ–**å’Œ**å¿«è¯»å¿«å†™**æ˜¯å…³é”®ï¼ç‰¹åˆ«æ˜¯`getchar`å’Œ`putchar`çš„ç»„åˆï¼Œæ¯”`cin`/`cout`å¿«å¾—å¤šã€‚â€

> **æ¥è‡ªlingfunnyçš„GBBTå¿ƒå¾—**ï¼š  
> â€œGBBTçš„ç²¾é«“åœ¨äº**å¸¦æƒä¸­ç‚¹åˆ†æ²»**ï¼Œæ¯æ¬¡é€’å½’éƒ½èƒ½ä¿è¯å­æ ‘å¤§å°å‡åŠï¼Œä»è€Œä¸¥æ ¼ä¿è¯\(O(\log n)\)çš„æ ‘é«˜ã€‚â€

---

## ç»“è¯­
> â€œä»æš´åŠ›DPåˆ°GBBTï¼Œæˆ‘ä»¬è§è¯äº†**ç®—æ³•ä¼˜åŒ–çš„æè‡´ä¹‹ç¾**ï¼å¸Œæœ›è¿™æ¬¡å­¦ä¹ èƒ½è®©ä½ æ·±åˆ»ç†è§£**åŠ¨æ€æ•°æ®ç»“æ„**çš„å¼ºå¤§ï¼Œå¹¶åœ¨æœªæ¥çš„æŒ‘æˆ˜ä¸­çµæ´»è¿ç”¨ï¼â€

---

---
å¤„ç†ç”¨æ—¶ï¼š172.49ç§’
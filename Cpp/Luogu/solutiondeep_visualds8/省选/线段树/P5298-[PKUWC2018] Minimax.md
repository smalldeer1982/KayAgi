# é¢˜ç›®ä¿¡æ¯

# [PKUWC2018] Minimax

## é¢˜ç›®æè¿°

å° $C$ æœ‰ä¸€æ£µ $n$ ä¸ªç»“ç‚¹çš„æœ‰æ ¹æ ‘ï¼Œæ ¹æ˜¯ $1$ å·ç»“ç‚¹ï¼Œä¸”æ¯ä¸ªç»“ç‚¹æœ€å¤šæœ‰ä¸¤ä¸ªå­ç»“ç‚¹ã€‚

å®šä¹‰ç»“ç‚¹ $x$ çš„æƒå€¼ä¸ºï¼š

1.è‹¥ $x$ æ²¡æœ‰å­ç»“ç‚¹ï¼Œé‚£ä¹ˆå®ƒçš„æƒå€¼ä¼šåœ¨è¾“å…¥é‡Œç»™å‡ºï¼Œ**ä¿è¯è¿™ç±»ç‚¹ä¸­æ¯ä¸ªç»“ç‚¹çš„æƒå€¼äº’ä¸ç›¸åŒ**ã€‚

2.è‹¥ $x$ æœ‰å­ç»“ç‚¹ï¼Œé‚£ä¹ˆå®ƒçš„æƒå€¼æœ‰ $p_x$ çš„æ¦‚ç‡æ˜¯å®ƒçš„å­ç»“ç‚¹çš„æƒå€¼çš„æœ€å¤§å€¼ï¼Œæœ‰ $1-p_x$ çš„æ¦‚ç‡æ˜¯å®ƒçš„å­ç»“ç‚¹çš„æƒå€¼çš„æœ€å°å€¼ã€‚

ç°åœ¨å° $C$ æƒ³çŸ¥é“ï¼Œå‡è®¾ $1$ å·ç»“ç‚¹çš„æƒå€¼æœ‰ $m$ ç§å¯èƒ½æ€§ï¼Œ**æƒå€¼ç¬¬ $i$ å°**çš„å¯èƒ½æ€§çš„æƒå€¼æ˜¯ $V_i$ï¼Œå®ƒçš„æ¦‚ç‡ä¸º $D_i(D_i>0)$ï¼Œæ±‚ï¼š

$$\sum_{i=1}^{m}i\cdot V_i\cdot D_i^2$$

ä½ éœ€è¦è¾“å‡ºç­”æ¡ˆå¯¹ $998244353$ å–æ¨¡çš„å€¼ã€‚


## è¯´æ˜/æç¤º


#### æ ·ä¾‹è§£é‡Š
1å·ç»“ç‚¹çš„æƒå€¼æœ‰ $\frac{1}{2}$ çš„æ¦‚ç‡æ˜¯ $1$ï¼Œæœ‰ $\frac{1}{2}$ çš„æ¦‚ç‡æ˜¯ $2$ï¼Œæ‰€ä»¥ç­”æ¡ˆæ˜¯ $\frac{5}{4}$ã€‚

#### æ•°æ®èŒƒå›´

- å¯¹äº $10\%$ çš„æ•°æ®ï¼Œæœ‰ $1\leq n\leq 20$ï¼›  
- å¯¹äº $20\%$ çš„æ•°æ®ï¼Œæœ‰ $1\leq n\leq 400$ï¼›  
- å¯¹äº $40\%$ çš„æ•°æ®ï¼Œæœ‰ $1\leq n\leq 5000$ï¼›  
- å¯¹äº $60\%$ çš„æ•°æ®ï¼Œæœ‰ $1\leq n\leq 10^5$ï¼›  
- å¦æœ‰ $10\%$ çš„æ•°æ®ä¿è¯æ ‘çš„å½¢æ€éšæœºï¼›  
- å¯¹äº $100\%$ çš„æ•°æ®ï¼Œæœ‰ $1\leq n\leq 3\times 10^5$ï¼Œ$1\leq w_i\leq 10^9$ã€‚

å¯¹äºæ‰€æœ‰æ•°æ®ï¼Œæ»¡è¶³ $0 < p_i \cdot 10000 < 10000$ï¼Œæ‰€ä»¥æ˜“è¯æ˜æ‰€æœ‰å¶å­çš„æƒå€¼éƒ½æœ‰æ¦‚ç‡è¢«æ ¹å–åˆ°ã€‚


## æ ·ä¾‹ #1

### è¾“å…¥

```
3
0 1 1
5000 1 2```

### è¾“å‡º

```
748683266```

# AIåˆ†æç»“æœ

---
# ğŸ’¡ æ´›è¯­äº‘ç¬ºçš„C++ç®—æ³•è§£æï¼š[PKUWC2018] Minimax æ·±å…¥å­¦ä¹ æŒ‡å— ğŸ’¡

ä»Šå¤©æˆ‘ä»¬æ¥ä¸€èµ·åˆ†æ **â€œMinimaxâ€** è¿™é“C++ç¼–ç¨‹é¢˜ã€‚è¿™ä¸ä»…ä»…æ˜¯ä¸€æ¬¡è§£é¢˜ï¼Œæ›´æ˜¯ä¸€åœºæ€ç»´çš„æ¢é™©ã€‚æˆ‘ä»¬å°†å­¦ä¹ å¦‚ä½•åƒä¾¦æ¢ä¸€æ ·ä»é¢˜ç›®ä¸­å¯»æ‰¾çº¿ç´¢ï¼Œå¹¶åœ¨ä¸åŒçš„è§£é¢˜é“è·¯ä¸­æƒè¡¡é€‰æ‹©ï¼Œæœ€ç»ˆæ‰¾åˆ°æœ€ä¼˜çš„ç­–ç•¥ã€‚

## 1. é¢˜ç›®è§£è¯»ä¸ç­–ç•¥åˆæ¢

âœ¨ **æœ¬é¢˜æ ¸å¿ƒæŒ‘æˆ˜**ï¼š  
> åœ¨ **ä¸€æ£µäºŒå‰æ ‘** ä¸­ï¼Œæ¯ä¸ªå¶å­èŠ‚ç‚¹æœ‰ä¸€ä¸ªå”¯ä¸€çš„æƒå€¼ï¼Œéå¶å­èŠ‚ç‚¹çš„æƒå€¼ç”±å…¶å­èŠ‚ç‚¹æƒå€¼ **ä»¥ä¸€å®šæ¦‚ç‡å–æœ€å¤§å€¼æˆ–æœ€å°å€¼** å†³å®šã€‚æˆ‘ä»¬éœ€è¦è®¡ç®—æ ¹èŠ‚ç‚¹æƒå€¼çš„æ‰€æœ‰å¯èƒ½å–å€¼åŠå…¶æ¦‚ç‡ï¼Œå¹¶æ±‚å‡ºä¸€ä¸ªç‰¹å®šçš„åŠ æƒå’Œã€‚

âœ¨ **æ ¸å¿ƒç®—æ³•æ ‡ç­¾**ï¼šæ ‘å½¢DPã€çº¿æ®µæ ‘åˆå¹¶ã€ç¦»æ•£åŒ–ã€æ¦‚ç‡DP

ğŸ—£ï¸ **åˆæ­¥åˆ†æ**ï¼š  
- æ ‘å½¢ç»“æ„ï¼Œæ¯ä¸ªèŠ‚ç‚¹æœ€å¤šä¸¤ä¸ªå­èŠ‚ç‚¹ã€‚
- éå¶å­èŠ‚ç‚¹çš„æƒå€¼ç”±å­èŠ‚ç‚¹å†³å®šï¼Œæ¦‚ç‡æ€§å–æœ€å¤§æˆ–æœ€å°å€¼ã€‚
- å¶å­èŠ‚ç‚¹çš„æƒå€¼äº’ä¸ç›¸åŒï¼Œéœ€è¦ç¦»æ•£åŒ–ã€‚
- æœ€ç»ˆç›®æ ‡æ˜¯è®¡ç®—æ ¹èŠ‚ç‚¹æƒå€¼çš„æ¦‚ç‡åˆ†å¸ƒï¼Œå¹¶æ±‚å‡ºç‰¹å®šåŠ æƒå’Œã€‚

### ğŸ” ç®—æ³•ä¾¦æ¢ï¼šå¦‚ä½•åœ¨é¢˜ç›®ä¸­å‘ç°çº¿ç´¢ï¼Ÿ
1. **çº¿ç´¢1 (é—®é¢˜ç›®æ ‡)**ï¼š  
   é¢˜ç›®è¦æ±‚è®¡ç®— **æ ¹èŠ‚ç‚¹æƒå€¼çš„æ¦‚ç‡åˆ†å¸ƒ**ï¼Œå¹¶æ±‚å‡ºåŠ æƒå’Œã€‚è¿™ç§ **æ¦‚ç‡åˆ†å¸ƒè®¡ç®—** é—®é¢˜ï¼Œé€šå¸¸éœ€è¦ **åŠ¨æ€è§„åˆ’** æˆ– **æ ‘å½¢DP** æ¥è§£å†³ã€‚

2. **çº¿ç´¢2 (é—®é¢˜çº¦æŸ/ç‰¹æ€§)**ï¼š  
   - **äºŒå‰æ ‘**ï¼šæ¯ä¸ªèŠ‚ç‚¹æœ€å¤šä¸¤ä¸ªå­èŠ‚ç‚¹ï¼Œç®€åŒ–äº†çŠ¶æ€è½¬ç§»ã€‚
   - **æƒå€¼å”¯ä¸€**ï¼šå¶å­èŠ‚ç‚¹æƒå€¼äº’ä¸ç›¸åŒï¼Œä¾¿äºç¦»æ•£åŒ–å’Œæ¦‚ç‡è®¡ç®—ã€‚
   - **æ¦‚ç‡æ€§è½¬ç§»**ï¼šéå¶å­èŠ‚ç‚¹çš„æƒå€¼ç”±å­èŠ‚ç‚¹æ¦‚ç‡æ€§å†³å®šï¼Œéœ€è¦ç»´æŠ¤æ¦‚ç‡åˆ†å¸ƒã€‚

3. **çº¿ç´¢3 (æ•°æ®è§„æ¨¡)**ï¼š  
   - \( n \leq 3 \times 10^5 \)ï¼Œéœ€è¦ \( O(n \log n) \) æˆ–æ›´ä¼˜çš„ç®—æ³•ã€‚
   - **çº¿æ®µæ ‘åˆå¹¶** æ˜¯å¤„ç†æ ‘å½¢DPä¸­æ¦‚ç‡åˆ†å¸ƒçš„é«˜æ•ˆæ–¹æ³•ã€‚

### ğŸ§  æ€ç»´é“¾æ„å»ºï¼šä»çº¿ç´¢åˆ°ç­–ç•¥
> å¥½äº†ï¼Œä¾¦æ¢å·¥ä½œå®Œæˆï¼Œæˆ‘ä»¬æ”¶é›†åˆ°äº†å‡ æ¡å…³é”®çº¿ç´¢ã€‚ç°åœ¨ï¼Œè®©æˆ‘ä»¬åƒæ‹¼å›¾ä¸€æ ·æŠŠå®ƒä»¬ç»„åˆèµ·æ¥ï¼š
> 1. é¦–å…ˆï¼Œ**çº¿ç´¢1** å‘Šè¯‰æˆ‘ä»¬è¿™æ˜¯ä¸€ä¸ª **æ¦‚ç‡åˆ†å¸ƒè®¡ç®—** é—®é¢˜ï¼Œéœ€è¦ **æ ‘å½¢DP**ã€‚
> 2. æ¥ç€ï¼Œ**çº¿ç´¢2** ä¸­çš„ **äºŒå‰æ ‘** å’Œ **æƒå€¼å”¯ä¸€** æç¤ºæˆ‘ä»¬å¯ä»¥ **ç¦»æ•£åŒ–æƒå€¼**ï¼Œå¹¶åˆ©ç”¨ **çº¿æ®µæ ‘** ç»´æŠ¤æ¦‚ç‡åˆ†å¸ƒã€‚
> 3. æœ€åï¼Œ**çº¿ç´¢3** çš„æ•°æ®è§„æ¨¡è¦æ±‚æˆ‘ä»¬å¿…é¡»ä½¿ç”¨ **çº¿æ®µæ ‘åˆå¹¶** æ¥é«˜æ•ˆå¤„ç†å­æ ‘åˆå¹¶ã€‚
> 4. **ç»“è®º**ï¼šç»¼åˆä»¥ä¸Šï¼Œ**çº¿æ®µæ ‘åˆå¹¶ä¼˜åŒ–çš„æ ‘å½¢DP** æ˜¯è§£å†³æœ¬é¢˜çš„æœ€ä½³ç­–ç•¥ã€‚

---

## 2. ç²¾é€‰ä¼˜è´¨é¢˜è§£å‚è€ƒ

ç»è¿‡ç»¼åˆè¯„ä¼°ï¼Œä»¥ä¸‹é¢˜è§£åœ¨æ€è·¯æ¸…æ™°åº¦ã€ä»£ç è§„èŒƒæ€§ã€ç®—æ³•æœ‰æ•ˆæ€§ä¸å¯å‘æ€§æ–¹é¢è¡¨ç°ä¼˜å¼‚ï¼Œç‰¹ç²¾é€‰å¦‚ä¸‹ï¼š

### ğŸ† é¢˜è§£ä¸€ï¼š1saunoyaï¼ˆèµï¼š55ï¼‰
**ç‚¹è¯„**ï¼š  
è¿™ä»½é¢˜è§£åœ¨æ€è·¯ä¸Šéå¸¸æ¸…æ™°ï¼Œå‡†ç¡®åœ°æŠ“ä½äº†é—®é¢˜çš„æ ¸å¿ƒâ€”â€”**çº¿æ®µæ ‘åˆå¹¶ä¼˜åŒ–æ ‘å½¢DP**ã€‚ä½œè€…é€šè¿‡å®šä¹‰ \( f_{i,j} \) ä¸ºèŠ‚ç‚¹ \( i \) æƒå€¼ä¸º \( j \) çš„æ¦‚ç‡ï¼Œå·§å¦™åœ°åˆ©ç”¨ **å‰ç¼€å’Œå’Œåç¼€å’Œ** ä¼˜åŒ–äº†è½¬ç§»æ–¹ç¨‹ã€‚ä»£ç å®ç°ä¸Šï¼ŒåŠ¨æ€å¼€ç‚¹çº¿æ®µæ ‘å’Œä¹˜æ³•æ ‡è®°çš„è¿ç”¨éå¸¸é«˜æ•ˆï¼Œå±•ç°äº†è‰¯å¥½çš„ç¼–ç¨‹ç´ å…»ã€‚ç‰¹åˆ«æ˜¯ **çº¿æ®µæ ‘åˆå¹¶** çš„å®ç°ï¼Œé€»è¾‘ä¸¥è°¨ï¼Œå€¼å¾—æ·±å…¥å­¦ä¹ ã€‚

### ğŸ† é¢˜è§£äºŒï¼šcommand_blockï¼ˆèµï¼š46ï¼‰
**ç‚¹è¯„**ï¼š  
è¿™ä»½é¢˜è§£åœ¨æ€è·¯æ¨å¯¼ä¸Šéå¸¸è¯¦ç»†ï¼Œç‰¹åˆ«æ˜¯å¯¹ **è½¬ç§»æ–¹ç¨‹** çš„æ¨å¯¼å’Œ **çº¿æ®µæ ‘åˆå¹¶** çš„å®ç°è®²è§£å¾—éå¸¸é€å½»ã€‚ä½œè€…é€šè¿‡ **ç¦»æ•£åŒ–** å’Œ **åŠ¨æ€å¼€ç‚¹çº¿æ®µæ ‘** çš„ç»“åˆï¼Œé«˜æ•ˆåœ°å¤„ç†äº†æ¦‚ç‡åˆ†å¸ƒçš„ç»´æŠ¤ã€‚ä»£ç é£æ ¼è§„èŒƒï¼Œå˜é‡å‘½åæ¸…æ™°ï¼Œç‰¹åˆ«æ˜¯ **ä¹˜æ³•æ ‡è®°** çš„ä¸‹ä¼ å’Œåˆå¹¶é€»è¾‘ï¼Œä½“ç°äº†å¯¹çº¿æ®µæ ‘æ“ä½œçš„æ·±å…¥ç†è§£ã€‚

### ğŸ† é¢˜è§£ä¸‰ï¼šTheLostWeakï¼ˆèµï¼š17ï¼‰
**ç‚¹è¯„**ï¼š  
è¿™ä»½é¢˜è§£åœ¨ **é—®é¢˜è½¬åŒ–** å’Œ **ç®—æ³•é€‰æ‹©** ä¸Šéå¸¸å‡ºè‰²ã€‚ä½œè€…å°†é—®é¢˜è½¬åŒ–ä¸º **çº¿æ®µæ ‘åˆå¹¶ä¼˜åŒ–æ ‘å½¢DP**ï¼Œå¹¶é€šè¿‡ **åŠ¨æ€å¼€ç‚¹çº¿æ®µæ ‘** é«˜æ•ˆå®ç°ã€‚ä»£ç ä¸­ **çŸ©é˜µå¿«é€Ÿå¹‚** çš„å¼•å…¥ï¼ˆè™½ç„¶æœ¬é¢˜æœªç›´æ¥ä½¿ç”¨ï¼‰å’Œ **å…¨å±€å¹³è¡¡äºŒå‰æ ‘** çš„æåŠï¼Œå±•ç¤ºäº†ä½œè€…å¯¹é«˜çº§æ•°æ®ç»“æ„çš„æŒæ¡ã€‚ç‰¹åˆ«æ˜¯å¯¹ **è¾¹ç•Œæ¡ä»¶** çš„å¤„ç†ï¼Œä½“ç°äº†ä¸¥è°¨çš„ç¼–ç¨‹æ€åº¦ã€‚

---

## 3. è§£é¢˜ç­–ç•¥æ·±åº¦å‰–æ

### ğŸ¯ æ ¸å¿ƒéš¾ç‚¹ä¸å…³é”®æ­¥éª¤ï¼ˆæœ€ä¼˜è§£æ³•å‰–æï¼‰

#### å…³é”®ç‚¹1ï¼šå¦‚ä½•å®šä¹‰çŠ¶æ€å’Œè½¬ç§»æ–¹ç¨‹ï¼Ÿ
- **çŠ¶æ€å®šä¹‰**ï¼šè®¾ \( f_{x,i} \) è¡¨ç¤ºèŠ‚ç‚¹ \( x \) æƒå€¼ä¸ºç¦»æ•£åŒ–åçš„ç¬¬ \( i \) å°æƒå€¼çš„æ¦‚ç‡ã€‚
- **è½¬ç§»æ–¹ç¨‹**ï¼š
  - è‹¥ \( x \) ä¸ºå¶å­èŠ‚ç‚¹ï¼š\( f_{x,i} = 1 \) å½“ä¸”ä»…å½“ \( i \) å¯¹åº”å…¶æƒå€¼ï¼Œå¦åˆ™ä¸º0ã€‚
  - è‹¥ \( x \) æœ‰ä¸€ä¸ªå­èŠ‚ç‚¹ï¼šç›´æ¥ç»§æ‰¿å­èŠ‚ç‚¹çš„æ¦‚ç‡åˆ†å¸ƒã€‚
  - è‹¥ \( x \) æœ‰ä¸¤ä¸ªå­èŠ‚ç‚¹ \( l \) å’Œ \( r \)ï¼š
    \[
    f_{x,i} = f_{l,i} \cdot \left(p_x \sum_{k=1}^{i-1} f_{r,k} + (1-p_x) \sum_{k=i+1}^{m} f_{r,k}\right) + f_{r,i} \cdot \left(p_x \sum_{k=1}^{i-1} f_{l,k} + (1-p_x) \sum_{k=i+1}^{m} f_{l,k}\right)
    \]

#### å…³é”®ç‚¹2ï¼šå¦‚ä½•é«˜æ•ˆç»´æŠ¤æ¦‚ç‡åˆ†å¸ƒï¼Ÿ
- **çº¿æ®µæ ‘åˆå¹¶**ï¼šåˆ©ç”¨åŠ¨æ€å¼€ç‚¹çº¿æ®µæ ‘ç»´æŠ¤æ¯ä¸ªèŠ‚ç‚¹çš„æ¦‚ç‡åˆ†å¸ƒï¼Œæ”¯æŒåŒºé—´ä¹˜æ³•å’Œåˆå¹¶æ“ä½œã€‚
- **å‰ç¼€å’Œåç¼€å’Œ**ï¼šåœ¨åˆå¹¶è¿‡ç¨‹ä¸­å®æ—¶è®¡ç®—å·¦å³å­æ ‘çš„å‰ç¼€å’Œåç¼€å’Œï¼Œé¿å…é‡å¤è®¡ç®—ã€‚

#### å…³é”®ç‚¹3ï¼šå¦‚ä½•å¤„ç†ç¦»æ•£åŒ–ï¼Ÿ
- **ç¦»æ•£åŒ–**ï¼šå°†å¶å­èŠ‚ç‚¹çš„æƒå€¼æ’åºåç¦»æ•£åŒ–ä¸ºè¿ç»­çš„æ•´æ•°ï¼Œé™ä½å€¼åŸŸèŒƒå›´ã€‚
- **æ˜ å°„**ï¼šä½¿ç”¨ `std::lower_bound` å°†åŸå§‹æƒå€¼æ˜ å°„åˆ°ç¦»æ•£åŒ–åçš„ç´¢å¼•ã€‚

### âœ¨ è§£é¢˜æŠ€å·§æ€»ç»“
- **æŠ€å·§Aï¼ˆé—®é¢˜è½¬åŒ–ï¼‰**ï¼šå°†æ¦‚ç‡åˆ†å¸ƒè®¡ç®—é—®é¢˜è½¬åŒ–ä¸ºçº¿æ®µæ ‘åˆå¹¶ä¼˜åŒ–æ ‘å½¢DPã€‚
- **æŠ€å·§Bï¼ˆæ•°æ®ç»“æ„é€‰æ‹©ï¼‰**ï¼šåŠ¨æ€å¼€ç‚¹çº¿æ®µæ ‘é€‚åˆå¤„ç†ç¨€ç–æ¦‚ç‡åˆ†å¸ƒï¼Œé¿å…ç©ºé—´æµªè´¹ã€‚
- **æŠ€å·§Cï¼ˆè¾¹ç•Œå¤„ç†ï¼‰**ï¼šç‰¹åˆ«æ³¨æ„å¶å­èŠ‚ç‚¹å’Œéå¶å­èŠ‚ç‚¹çš„ä¸åŒå¤„ç†æ–¹å¼ã€‚

### âš”ï¸ ç­–ç•¥ç«æŠ€åœºï¼šä¸åŒè§£æ³•çš„å¯¹æ¯”åˆ†æ

| ç­–ç•¥ | æ ¸å¿ƒæ€æƒ³ | ä¼˜ç‚¹ | ç¼ºç‚¹ä¸åˆ†æ | é€‚ç”¨åœºæ™¯ / å¾—åˆ†é¢„æœŸ |
| :--- | :--- | :--- | :--- | :--- |
| **æš´åŠ›DP** | ç›´æ¥è®¡ç®—æ¯ä¸ªèŠ‚ç‚¹çš„æ¦‚ç‡åˆ†å¸ƒ | æ€è·¯ç›´è§‚ | æ—¶é—´å¤æ‚åº¦ \( O(n^2) \)ï¼Œæ— æ³•é€šè¿‡å¤§æ•°æ® | æ•°æ®è§„æ¨¡ \( n \leq 5000 \) |
| **çº¿æ®µæ ‘åˆå¹¶ä¼˜åŒ–DP** | åˆ©ç”¨çº¿æ®µæ ‘åˆå¹¶ç»´æŠ¤æ¦‚ç‡åˆ†å¸ƒ | æ—¶é—´å¤æ‚åº¦ \( O(n \log n) \)ï¼Œé«˜æ•ˆ | å®ç°å¤æ‚ï¼Œéœ€è¦æŒæ¡çº¿æ®µæ ‘åˆå¹¶ | æœ¬é¢˜æœ€ä½³å®è·µï¼Œå¯å¾— **100%** åˆ†æ•° |
| **åŠ¨æ€DP** | ä½¿ç”¨å…¨å±€å¹³è¡¡äºŒå‰æ ‘ç»´æŠ¤è½¬ç§» | ç†è®ºå¯è¡Œ | å®ç°å¤æ‚ï¼Œæ€§ä»·æ¯”ä¸é«˜ | é€‚ç”¨äºæ›´å¤æ‚çš„æ ‘å½¢DPé—®é¢˜ |

### âœ¨ ä¼˜åŒ–ä¹‹æ—…ï¼šä»â€œèƒ½åšâ€åˆ°â€œåšå¥½â€
> ä»æœ´ç´ çš„ \( O(n^2) \) æš´åŠ›DPå‡ºå‘ï¼Œæˆ‘ä»¬å‘ç°ç“¶é¢ˆåœ¨äºçŠ¶æ€æ•°çš„çˆ†ç‚¸ã€‚é€šè¿‡ **ç¦»æ•£åŒ–** å’Œ **çº¿æ®µæ ‘åˆå¹¶**ï¼Œæˆ‘ä»¬å°†çŠ¶æ€æ•°å‹ç¼©åˆ° \( O(n \log n) \)ï¼Œå®ç°äº†è´¨çš„é£è·ƒã€‚

---

## 4. C++æ ¸å¿ƒä»£ç å®ç°èµæ

### æœ¬é¢˜é€šç”¨æ ¸å¿ƒC++å®ç°å‚è€ƒ

**è¯´æ˜**ï¼šæœ¬ä»£ç ç»¼åˆäº†å¤šä¸ªä¼˜è´¨é¢˜è§£çš„æ€è·¯ï¼Œæ—¨åœ¨æä¾›ä¸€ä¸ªæ¸…æ™°ä¸”å®Œæ•´çš„æ ¸å¿ƒå®ç°ã€‚

```cpp
#include <bits/stdc++.h>
using namespace std;

const int MAXN = 3e5 + 10;
const int MOD = 998244353;
const int INV = 796898467; // 1e4^{-1} mod MOD

int n, tot, cnt;
int ch[MAXN][2], val[MAXN], rt[MAXN];
int ls[MAXN * 40], rs[MAXN * 40], sum[MAXN * 40], tag[MAX_N * 40];
vector<int> leaves;

inline int qpow(int a, int b) {
    int res = 1;
    while (b) {
        if (b & 1) res = 1LL * res * a % MOD;
        a = 1LL * a * a % MOD;
        b >>= 1;
    }
    return res;
}

inline void pushdown(int p) {
    if (tag[p] != 1) {
        if (ls[p]) {
            sum[ls[p]] = 1LL * sum[ls[p]] * tag[p] % MOD;
            tag[ls[p]] = 1LL * tag[ls[p]] * tag[p] % MOD;
        }
        if (rs[p]) {
            sum[rs[p]] = 1LL * sum[rs[p]] * tag[p] % MOD;
            tag[rs[p]] = 1LL * tag[rs[p]] * tag[p] % MOD;
        }
        tag[p] = 1;
    }
}

void insert(int &p, int l, int r, int pos) {
    if (!p) {
        p = ++tot;
        tag[p] = 1;
    }
    if (l == r) {
        sum[p] = 1;
        return;
    }
    pushdown(p);
    int mid = (l + r) >> 1;
    if (pos <= mid) insert(ls[p], l, mid, pos);
    else insert(rs[p], mid + 1, r, pos);
    sum[p] = (sum[ls[p]] + sum[rs[p]]) % MOD;
}

int merge(int x, int y, int l, int r, int lx, int rx, int ly, int ry, int p) {
    if (!x && !y) return 0;
    if (!x) {
        int mul = (1LL * p * lx + 1LL * (MOD + 1 - p) * rx) % MOD;
        sum[y] = 1LL * sum[y] * mul % MOD;
        tag[y] = 1LL * tag[y] * mul % MOD;
        return y;
    }
    if (!y) {
        int mul = (1LL * p * ly + 1LL * (MOD + 1 - p) * ry) % MOD;
        sum[x] = 1LL * sum[x] * mul % MOD;
        tag[x] = 1LL * tag[x] * mul % MOD;
        return x;
    }
    pushdown(x);
    pushdown(y);
    int mid = (l + r) >> 1;
    ls[x] = merge(ls[x], ls[y], l, mid, lx, (rx + sum[rs[x]]) % MOD, ly, (ry + sum[rs[y]]) % MOD, p);
    rs[x] = merge(rs[x], rs[y], mid + 1, r, (lx + sum[ls[x]]) % MOD, rx, (ly + sum[ls[y]]) % MOD, ry, p);
    sum[x] = (sum[ls[x]] + sum[rs[x]]) % MOD;
    return x;
}

void dfs(int u) {
    if (!ch[u][0]) {
        int pos = lower_bound(leaves.begin(), leaves.end(), val[u]) - leaves.begin() + 1;
        insert(rt[u], 1, cnt, pos);
        return;
    }
    if (!ch[u][1]) {
        dfs(ch[u][0]);
        rt[u] = rt[ch[u][0]];
        return;
    }
    dfs(ch[u][0]);
    dfs(ch[u][1]);
    rt[u] = merge(rt[ch[u][0]], rt[ch[u][1]], 1, cnt, 0, 0, 0, 0, val[u]);
}

int main() {
    scanf("%d", &n);
    for (int i = 1, fa; i <= n; ++i) {
        scanf("%d", &fa);
        if (fa) {
            if (ch[fa][0]) ch[fa][1] = i;
            else ch[fa][0] = i;
        }
    }
    for (int i = 1; i <= n; ++i) {
        scanf("%d", &val[i]);
        if (!ch[i][0]) leaves.push_back(val[i]);
        else val[i] = 1LL * val[i] * INV % MOD;
    }
    sort(leaves.begin(), leaves.end());
    leaves.erase(unique(leaves.begin(), leaves.end()), leaves.end());
    cnt = leaves.size();
    dfs(1);
    int ans = 0;
    for (int i = 1; i <= cnt; ++i) {
        int prob = sum[rt[1]];
        ans = (ans + 1LL * i * leaves[i - 1] % MOD * prob % MOD * prob) % MOD;
    }
    printf("%d\n", ans);
    return 0;
}
```

**ä»£ç è§£è¯»æ¦‚è¦**ï¼š  
è¯¥ä»£ç å®ç°äº† **çº¿æ®µæ ‘åˆå¹¶ä¼˜åŒ–çš„æ ‘å½¢DP**ã€‚  
- **ç¦»æ•£åŒ–**ï¼šå°†å¶å­æƒå€¼ç¦»æ•£åŒ–ä¸ºè¿ç»­ç´¢å¼•ã€‚  
- **çº¿æ®µæ ‘åˆå¹¶**ï¼šåœ¨DFSè¿‡ç¨‹ä¸­ï¼Œå¯¹æ¯ä¸ªèŠ‚ç‚¹ç»´æŠ¤æƒå€¼çš„æ¦‚ç‡åˆ†å¸ƒã€‚  
- **æ¦‚ç‡è½¬ç§»**ï¼šæ ¹æ®å­èŠ‚ç‚¹çš„æ¦‚ç‡åˆ†å¸ƒå’Œå½“å‰èŠ‚ç‚¹çš„æ¦‚ç‡å‚æ•°ï¼Œåˆå¹¶å¹¶æ›´æ–°æ¦‚ç‡ã€‚  

---

## 5. ç®—æ³•å¯è§†åŒ–ï¼šåƒç´ åŠ¨ç”»æ¼”ç¤º

### åŠ¨ç”»æ¼”ç¤ºä¸»é¢˜  
**â€œåƒç´ æ¢é™©å®¶â€åœ¨äºŒå‰æ ‘è¿·å®«ä¸­å¯»æ‰¾å®è—ï¼ˆæ¦‚ç‡åˆ†å¸ƒï¼‰**  
- **åœºæ™¯**ï¼š8ä½åƒç´ é£æ ¼çš„äºŒå‰æ ‘ï¼Œæ¯ä¸ªèŠ‚ç‚¹æ˜¯ä¸€ä¸ªåƒç´ æ–¹å—ã€‚  
- **è¿‡ç¨‹**ï¼š  
  1. **åˆå§‹åŒ–**ï¼šå¶å­èŠ‚ç‚¹äº®èµ·å¯¹åº”æƒå€¼çš„åƒç´ ã€‚  
  2. **åˆå¹¶åŠ¨ç”»**ï¼šçˆ¶èŠ‚ç‚¹æ¥æ”¶å­èŠ‚ç‚¹çš„æ¦‚ç‡åˆ†å¸ƒï¼Œåƒç´ æ–¹å—é—ªçƒè¡¨ç¤ºæ¦‚ç‡æ›´æ–°ã€‚  
  3. **éŸ³æ•ˆ**ï¼šæ¯æ¬¡åˆå¹¶æ’­æ”¾â€œå®â€å£°ï¼Œå®Œæˆæ—¶æ’­æ”¾èƒœåˆ©éŸ³æ•ˆã€‚  
- **äº¤äº’**ï¼šæ­¥è¿›/è‡ªåŠ¨æ’­æ”¾æŒ‰é’®ï¼Œé€Ÿåº¦æ»‘å—æ§åˆ¶åˆå¹¶é€Ÿåº¦ã€‚  

### è®¾è®¡æ€è·¯  
- **åƒç´ åŒ–**ï¼šç”¨8x8åƒç´ æ–¹å—è¡¨ç¤ºèŠ‚ç‚¹å’Œæƒå€¼ã€‚  
- **æ¸¸æˆåŒ–**ï¼šåˆå¹¶è¿‡ç¨‹è§†ä¸ºâ€œå°å…³å¡â€ï¼Œå®Œæˆæ—¶å¥–åŠ±åƒç´ æ˜Ÿæ˜Ÿã€‚  
- **å¯è§†åŒ–**ï¼šçº¿æ®µæ ‘åˆå¹¶çš„æ¯ä¸€æ­¥ç”¨é¢œè‰²å˜åŒ–è¡¨ç¤ºæ¦‚ç‡æ›´æ–°ã€‚  

---

## 6. æ‹“å±•ç»ƒä¹ ä¸ç›¸ä¼¼é—®é¢˜æ€è€ƒ

### é€šç”¨æ€è·¯è¿ç§»  
- **çº¿æ®µæ ‘åˆå¹¶ä¼˜åŒ–æ ‘å½¢DP**ï¼šé€‚ç”¨äºéœ€è¦ç»´æŠ¤å­æ ‘çŠ¶æ€çš„é—®é¢˜ï¼Œå¦‚ï¼š  
  1. **å­æ ‘æƒå€¼ç»Ÿè®¡**ï¼šå¦‚å­æ ‘ä¸­ä¸åŒæƒå€¼çš„æ•°é‡ã€‚  
  2. **æ¦‚ç‡è·¯å¾„é—®é¢˜**ï¼šå¦‚éšæœºæ¸¸èµ°ä¸­åˆ°è¾¾æŸèŠ‚ç‚¹çš„æ¦‚ç‡ã€‚  
  3. **åŠ¨æ€ç»´æŠ¤å­æ ‘ä¿¡æ¯**ï¼šå¦‚å­æ ‘å’Œã€æœ€å¤§å€¼ç­‰ã€‚

### æ´›è°·æ¨èç»ƒä¹ 
1. **P4719** - åŠ¨æ€DPæ¨¡æ¿  
   ğŸ—£ï¸ æ¨èç†ç”±ï¼šå·©å›ºåŠ¨æ€DPå’Œçº¿æ®µæ ‘åˆå¹¶çš„ç»“åˆåº”ç”¨ã€‚  
2. **P4751** - åŠ¨æ€DPåŠ å¼ºç‰ˆ  
   ğŸ—£ï¸ æ¨èç†ç”±ï¼šæŒ‘æˆ˜æ›´å¤æ‚çš„æ ‘å½¢DPé—®é¢˜ã€‚  
3. **P5298** - æœ¬é¢˜åŸé¢˜  
   ğŸ—£ï¸ æ¨èç†ç”±ï¼šåå¤ç»ƒä¹ çº¿æ®µæ ‘åˆå¹¶ä¼˜åŒ–æ ‘å½¢DPã€‚

---

## 7. å­¦ä¹ å¿ƒå¾—ä¸ç»éªŒåˆ†äº«

> **æ¥è‡ª1saunoyaçš„ç»éªŒ**ï¼š  
> â€œçº¿æ®µæ ‘åˆå¹¶çš„å…³é”®åœ¨äº **ç»´æŠ¤å‰ç¼€å’Œåç¼€å’Œ**ï¼Œå¹¶åœ¨åˆå¹¶æ—¶æ­£ç¡®ä¸‹ä¼ æ ‡è®°ã€‚è°ƒè¯•æ—¶æ‰“å°ä¸­é—´çŠ¶æ€éå¸¸æœ‰å¸®åŠ©ã€‚â€  

**ç‚¹è¯„**ï¼š  
- å¼ºè°ƒäº†çº¿æ®µæ ‘åˆå¹¶çš„æ ¸å¿ƒæŠ€å·§ã€‚  
- å»ºè®®è°ƒè¯•æ—¶æ‰“å°ä¸­é—´çŠ¶æ€ï¼Œå¸®åŠ©å®šä½é”™è¯¯ã€‚

---

<conclusion>
æœ¬æ¬¡å…³äº **â€œMinimaxâ€** çš„C++è§£é¢˜åˆ†æå°±åˆ°è¿™é‡Œã€‚å¸Œæœ›è¿™ä»½å­¦ä¹ æŒ‡å—èƒ½å¸®åŠ©å¤§å®¶æ›´å¥½åœ°ç†è§£ **çº¿æ®µæ ‘åˆå¹¶ä¼˜åŒ–æ ‘å½¢DP** çš„ç²¾é«“ã€‚è®°ä½ï¼Œç¼–ç¨‹èƒ½åŠ›çš„æå‡åœ¨äºæŒç»­å­¦ä¹ ã€å‹¤äºæ€è€ƒå’Œå‹‡äºå®è·µã€‚ä¸‹æ¬¡æˆ‘ä»¬å†ä¸€èµ·æ¢ç´¢æ–°çš„ç¼–ç¨‹æŒ‘æˆ˜ï¼ğŸ’ª
</conclusion>

---
å¤„ç†ç”¨æ—¶ï¼š124.13ç§’
# é¢˜ç›®ä¿¡æ¯

# ã€MdOI R1ã€Treequery

## é¢˜ç›®æè¿°

ç»™å®šä¸€æ£µ $n$ ä¸ªç‚¹çš„æ— æ ¹æ ‘ï¼Œè¾¹æœ‰è¾¹æƒã€‚

ä»¤ $E(x,y)$ è¡¨ç¤ºæ ‘ä¸Š $x,y$ ä¹‹é—´çš„ç®€å•è·¯å¾„ä¸Šçš„æ‰€æœ‰è¾¹çš„é›†åˆï¼Œç‰¹åˆ«åœ°ï¼Œå½“ $x=y$ æ—¶ï¼Œ$E(x,y) = \varnothing$ã€‚

ä½ éœ€è¦ **å®æ—¶** å›ç­” $q$ ä¸ªè¯¢é—®ï¼Œæ¯ä¸ªè¯¢é—®ç»™å®š $p,l,r$ï¼Œè¯·ä½ æ±‚å‡ºé›†åˆ $\bigcap_{i=l}^r E(p,i)$ ä¸­æ‰€æœ‰è¾¹çš„è¾¹æƒå’Œï¼Œå³ $E(p, l\dots r)$ çš„äº¤æ‰€åŒ…å«çš„è¾¹çš„è¾¹æƒå’Œã€‚

é€šä¿—çš„è®²ï¼Œä½ éœ€è¦æ±‚å‡º $p$ åˆ° $[l,r]$ å†…æ¯ä¸€ä¸ªç‚¹çš„ç®€å•è·¯å¾„çš„å…¬å…±éƒ¨åˆ†é•¿åº¦ã€‚



## è¯´æ˜/æç¤º

ã€æ ·ä¾‹ 1 è¯´æ˜ã€‘

æ ·ä¾‹ä¸­çš„æ ‘å¦‚å›¾æ‰€ç¤ºï¼š

![](https://cdn.luogu.com.cn/upload/image_hosting/g6l15zpv.png)

ä¸‹é¢è§£é‡Šä¸­çš„è¯¢é—®å‚æ•°å‡ä¸ºå¼‚æˆ– $lastans$ ä¹‹åå¾—åˆ°çš„çœŸå®å€¼ã€‚

å¯¹äºç¬¬ä¸€ä¸ªè¯¢é—®ï¼Œ$p=2$ï¼Œ$l=3$ï¼Œ$r=5$ï¼Œ$\bigcap_{i=3}^5 E(2,i)$ ä¸ºè¾¹ $(2,3)$ï¼Œé•¿åº¦ä¸º $3$ã€‚

å¯¹äºç¬¬äºŒä¸ªè¯¢é—®ï¼Œ$p=1$ï¼Œ$l=2$ï¼Œ$r=4$ï¼Œ$\bigcap_{i=2}^4 E(1,i)$ ä¸ºè¾¹ $(1,3)$ï¼Œé•¿åº¦ä¸º $2$ï¼›

å¯¹äºç¬¬ä¸‰ä¸ªè¯¢é—®ï¼Œ$p=2$ï¼Œ$l=5$ï¼Œ$r=5$ï¼Œ$\bigcap_{i=5}^5 E(2,i)$ ä¸ºè¾¹é›† $\{(2,3),(3,1),(1,5)\}$ï¼Œé•¿åº¦ä¸º $6$ï¼›

å¯¹äºç¬¬å››ä¸ªè¯¢é—®ï¼Œ$p=3$ï¼Œ$l=3$ï¼Œ$r=4$ï¼Œ$\bigcap_{i=3}^4 E(3,i)=\varnothing$ï¼Œé•¿åº¦ä¸º $0$ã€‚


---

ã€æ•°æ®èŒƒå›´ã€‘

**æœ¬é¢˜é‡‡ç”¨æ†ç»‘æµ‹è¯•ã€‚**

| å­ä»»åŠ¡ç¼–å· |   $n,q\leq$    | ç‰¹æ®Šæ€§è´¨ | åˆ†å€¼ |
| :--------: | :------------: | :------: | :--: |
|     1      |     $10^5$     |  $l=r$   |  8   |
|     2      |     $10^5$     |  $p=1$   |  20  |
|     3      |     $10^3$     |    æ—     |  20  |
|     4      |     $10^5$     |    æ—     |  26  |
|     5      | $2\times 10^5$ |    æ—     |  26  |

å¯¹äº $100\%$ çš„æ•°æ®ï¼Œ$1\leq n,q\leq 2\times 10^5$ï¼Œ$1\leq x,y,p\leq n$ï¼Œ$1\leq l\leq r\leq n$ï¼Œ$1\leq w\leq 10^4$ã€‚

## æ ·ä¾‹ #1

### è¾“å…¥

```
5 4
3 1 2
1 5 1
2 3 3
3 4 4
2 3 5
2 1 7
0 7 7
5 5 2```

### è¾“å‡º

```
3
2
6
0```

## æ ·ä¾‹ #2

### è¾“å…¥

```
10 10
2 1 9907
3 2 8329
4 2 8402
5 4 3636
6 4 8747
7 4 3080
8 6 780
9 6 5414
10 9 3545
2 10 10
26107 26106 26101
4 9 10
14171 14166 14169
8958 8949 8949
36008 36014 36013
11485 11485 11472
3 9 9
30888 30894 30895
8404 8404 8411
```

### è¾“å‡º

```
26108
0
14161
8959
36015
11482
0
30892
8402
0
```

# AIåˆ†æç»“æœ

---
# ğŸ’¡ æ´›è¯­äº‘ç¬ºçš„C++ç®—æ³•è§£æï¼šã€MdOI R1ã€Treequery æ·±å…¥å­¦ä¹ æŒ‡å— ğŸ’¡

> ä»Šå¤©æˆ‘ä»¬æ¥ä¸€èµ·åˆ†æâ€œTreequeryâ€è¿™é“ C++ æ ‘ä¸Šè·¯å¾„é¢˜ã€‚å®ƒè¦æ±‚æˆ‘ä»¬**å®æ—¶**å›ç­”ï¼šç»™å®šä¸€ä¸ªç‚¹ `p` ä¸ä¸€æ®µç¼–å·åŒºé—´ `[l,r]`ï¼Œæ±‚ **p åˆ°åŒºé—´å†…æ‰€æœ‰ç‚¹çš„è·¯å¾„çš„å…¬å…±éƒ¨åˆ†** çš„è¾¹æƒå’Œã€‚  
> çœ‹ä¼¼å¤æ‚ï¼Œä½†åªè¦æˆ‘ä»¬åƒä¾¦æ¢ä¸€æ ·æ‹†è§£é¢˜æ„ã€å‘ç°çº¿ç´¢ï¼Œå°±èƒ½æ‰¾åˆ°ä¼˜é›…çš„è§£æ³•ï¼

---

## 1. é¢˜ç›®è§£è¯»ä¸ç­–ç•¥åˆæ¢

### âœ¨ æ ¸å¿ƒæŒ‘æˆ˜
**æŠŠâ€œè·¯å¾„äº¤é›†â€è¿™ä¸ªæŠ½è±¡æ¦‚å¿µï¼Œè½¬åŒ–ä¸ºå¯è®¡ç®—çš„å‡ ä½•/ä»£æ•°é—®é¢˜**â€”â€”å³æ‰¾åˆ°æ‰€æœ‰è·¯å¾„éƒ½ç»è¿‡çš„é‚£ä¸€æ®µæ ‘è¾¹ï¼Œå¹¶æ±‚å®ƒä»¬çš„æƒå€¼å’Œã€‚

### âœ¨ æ ¸å¿ƒç®—æ³•æ ‡ç­¾
- LCAï¼ˆæœ€è¿‘å…¬å…±ç¥–å…ˆï¼‰
- DFS åº + ä¸»å¸­æ ‘ï¼ˆåŒºé—´ç‚¹è®¡æ•°ï¼‰
- å€å¢ / ST è¡¨
- åˆ†ç±»è®¨è®ºï¼ˆCase Workï¼‰

---

### ğŸ” ç®—æ³•ä¾¦æ¢ï¼šå¦‚ä½•åœ¨é¢˜ç›®ä¸­å‘ç°çº¿ç´¢ï¼Ÿ

| çº¿ç´¢ç¼–å· | å‘ç°å†…å®¹ | ç®—æ³•æç¤º |
|---|---|---|
| **çº¿ç´¢1ï¼šäº¤é›†çš„ç­‰ä»·åˆ»ç”»** | æ‰€æœ‰è·¯å¾„çš„å…¬å…±éƒ¨åˆ†ï¼Œä¸€å®šæ˜¯**ä» p å‡ºå‘çš„æŸæ¡ç¥–å…ˆé“¾**æˆ–**ç©ºé›†**ã€‚ | å¯ä»¥æŠŠé—®é¢˜è½¬åŒ–ä¸ºâ€œæ‰¾åˆ†ç•Œç‚¹â€ã€‚ |
| **çº¿ç´¢2ï¼šåŒºé—´æŸ¥è¯¢** | éœ€è¦å¿«é€Ÿåˆ¤æ–­ `[l,r]` å†…æœ‰å¤šå°‘ç‚¹åœ¨ p çš„æŸæ£µå­æ ‘é‡Œã€‚ | DFS åº + ä¸»å¸­æ ‘ = åŒºé—´ç‚¹è®¡æ•°åˆ©å™¨ã€‚ |
| **çº¿ç´¢3ï¼šæ•°æ®è§„æ¨¡** | n,q â‰¤ 2Ã—10âµï¼Œè¦æ±‚ O(n log n) æˆ– O(n logÂ² n)ã€‚ | å€å¢ LCA + ä¸»å¸­æ ‘åˆšå¥½æ»¡è¶³ã€‚ |

---

### ğŸ§  æ€ç»´é“¾æ„å»ºï¼šä»çº¿ç´¢åˆ°ç­–ç•¥
> ä¾¦æ¢å·¥ä½œå®Œæˆï¼Œæˆ‘ä»¬æ”¶é›†åˆ°äº†å…³é”®çº¿ç´¢ã€‚ç°åœ¨æŠŠå®ƒä»¬æ‹¼èµ·æ¥ï¼š
> 1. **äº¤é›†ç­‰ä»·äºä¸€æ¡é“¾**ï¼šp åˆ° `[l,r]` çš„å…¬å…±è·¯å¾„ï¼Œä¸€å®šæ˜¯ä¸€æ¡â€œä» p å‘ä¸Šæˆ–å‘ä¸‹å»¶ä¼¸â€çš„é“¾ï¼Œæˆ–è€…ä¸ºç©ºã€‚  
> 2. **å­æ ‘åˆ’åˆ†**ï¼šä»¥ p ä¸ºæ ¹ï¼Œæ•´æ£µæ ‘è¢«åˆ†æˆè‹¥å¹²å­æ ‘ã€‚  
>    - è‹¥ `[l,r]` å…¨éƒ¨åœ¨æŸä¸€å­æ ‘ â†’ äº¤é›†å°±æ˜¯ p åˆ°å®ƒä»¬çš„ LCAã€‚  
>    - è‹¥åˆ†å¸ƒåœ¨ â‰¥2 å­æ ‘ â†’ äº¤é›†ä¸ºç©ºã€‚  
> 3. **é«˜æ•ˆåˆ¤å®šå­æ ‘**ï¼šDFS åºæŠŠå­æ ‘å˜æˆè¿ç»­åŒºé—´ï¼Œä¸»å¸­æ ‘å¯åœ¨ O(log n) å†…å®ŒæˆåŒºé—´ç‚¹è®¡æ•°ã€‚  
> 4. **ç»“è®º**ï¼šç”¨ **ä¸»å¸­æ ‘** åˆ¤æ–­å­æ ‘åˆ†å¸ƒï¼Œç”¨ **LCA** æ±‚é“¾é•¿åº¦ï¼Œå³å¯åœ¨ O(log n) å•æ¬¡å›ç­”ã€‚

---

## 2. ç²¾é€‰ä¼˜è´¨é¢˜è§£å‚è€ƒ

ä»¥ä¸‹é¢˜è§£å‡ â‰¥4 æ˜Ÿï¼Œæ€è·¯æ¸…æ™°ã€å®ç°è§„èŒƒï¼Œå€¼å¾—å­¦ä¹ ã€‚

### âœ… é¢˜è§£ä¸€ï¼šOwen_codeiskingï¼ˆä¸»å¸­æ ‘ + DFS åºï¼ŒO(n log n)ï¼‰
**äº®ç‚¹æç‚¼**  
- ä»¥ 1 ä¸ºæ ¹é¢„å¤„ç† DFS åºã€disã€LCAã€‚  
- å°†â€œp ä¸ºæ ¹â€çš„ DFS åºè½¬åŒ–ä¸º `[id_p,n]âˆª[1,id_p-1]`ï¼Œç”¨ä¸»å¸­æ ‘äºŒåˆ†æ‰¾åŒºé—´å†…æœ€å°/æœ€å¤§èŠ‚ç‚¹ã€‚  
- **äº”ç§æƒ…å†µ**ä¸€æ¬¡åˆ¤æ¸…ï¼Œä»£ç ç®€æ´ã€‚

**å­¦ä¹ ç¬”è®°**  
> ä¸»å¸­æ ‘ä¸ä»…èƒ½â€œæ•°ç‚¹â€ï¼Œè¿˜èƒ½â€œæ‰¾æå€¼â€ã€‚æŠŠåŒºé—´æå€¼é—®é¢˜è½¬æˆ DFS åºä¸Šçš„åŒºé—´æŸ¥è¯¢ï¼Œæ˜¯æ ‘ä¸Šé—®é¢˜çš„ç»å…¸å¥—è·¯ã€‚

---

### âœ… é¢˜è§£äºŒï¼šThinkingï¼ˆæ ‘é“¾å‰–åˆ† + ä¸»å¸­æ ‘ï¼ŒO(n logÂ² n)ï¼‰
**äº®ç‚¹æç‚¼**  
- ç”¨**å½©è‰²å›¾ç¤º**ç›´è§‚å±•ç¤ºä¸‰ç§ä½ç½®å…³ç³»ï¼Œå¸®åŠ©ç†è§£ã€‚  
- ç”¨çº¿æ®µæ ‘åˆå¹¶ + å¯æŒä¹…åŒ–ç»´æŠ¤å­æ ‘å†…ç‚¹å‡ºç°æƒ…å†µï¼Œå®ç°ä¼˜é›…ã€‚  
- é‡é“¾å‰–åˆ† + äºŒåˆ†æ‰¾â€œæœ€ä½åŒ…å«å­æ ‘â€ï¼Œæ€è·¯æ¸…æ™°ã€‚

**å­¦ä¹ ç¬”è®°**  
> æ ‘é“¾å‰–åˆ†æŠŠâ€œå‘ä¸Šè·³â€å˜æˆâ€œè·³é“¾â€ï¼Œé…åˆä¸»å¸­æ ‘å®ç°å­æ ‘æŸ¥è¯¢ï¼Œæ˜¯å¤„ç†â€œç¥–å…ˆé“¾â€é—®é¢˜çš„åˆ©å™¨ã€‚

---

### âœ… é¢˜è§£ä¸‰ï¼šstrcmpï¼ˆç®€æ´å€å¢ + ST è¡¨ï¼ŒO(n logÂ² n)ï¼‰
**äº®ç‚¹æç‚¼**  
- æŠŠåŒºé—´ LCA è½¬åŒ–ä¸º ST è¡¨ä¸Š RMQï¼ŒO(1) æŸ¥è¯¢ã€‚  
- å€å¢æ‰¾â€œæœ€æ·±çš„ä¸å« [l,r] ç‚¹çš„ç¥–å…ˆâ€ï¼Œæ€è·¯ç›´æ¥ã€‚  
- ä»£ç çŸ­å°ç²¾æ‚ï¼Œ1A1Cï¼Œé€‚åˆå¿«é€Ÿå¤ç°ã€‚

**å­¦ä¹ ç¬”è®°**  
> ST è¡¨ç»´æŠ¤åŒºé—´ LCA æ˜¯æ¨¡æ¿æŠ€å·§ï¼Œå€å¢ + ä¸»å¸­æ ‘ç»„åˆä½¿ç”¨ï¼Œå¯ä»¥è¦†ç›–ç»å¤§å¤šæ•°æ ‘ä¸Šè·¯å¾„äº¤é›†é—®é¢˜ã€‚

---

## 3. è§£é¢˜ç­–ç•¥æ·±åº¦å‰–æ

### ğŸ¯ æ ¸å¿ƒéš¾ç‚¹ä¸å…³é”®æ­¥éª¤ï¼ˆæœ€ä¼˜è§£æ³•ï¼‰

| å…³é”®ç‚¹ | åˆ†æ | å­¦ä¹ ç¬”è®° |
|---|---|---|
| **1. DFS åºè½¬åŒ–å­æ ‘ä¸ºåŒºé—´** | ä»¥ä»»æ„æ ¹ DFSï¼Œå­æ ‘å¯¹åº”è¿ç»­åŒºé—´ `[dfn[u], dfn[u]+siz[u]-1]` | æŠŠâ€œæ ‘ä¸Šå­æ ‘â€å˜æˆâ€œæ•°ç»„åŒºé—´â€ï¼Œæ˜¯æ ‘ä¸Šé—®é¢˜çš„é€šç”¨é™ç»´æ‰“å‡»ã€‚ |
| **2. ä¸»å¸­æ ‘åŒºé—´ç‚¹è®¡æ•°** | åœ¨ DFS åºä¸Šå»ºç«‹ä¸»å¸­æ ‘ï¼ŒæŸ¥è¯¢ `[l,r]` å†…è½åœ¨æŸå­æ ‘çš„ç‚¹æ•° | ä¸»å¸­æ ‘â€œå‰ç¼€å¯å‡æ€§â€å¤©ç„¶é€‚åˆåŒºé—´ç‚¹è®¡æ•°ã€‚ |
| **3. åŒºé—´ LCA è®¡ç®—** | å– `[l,r]` å†… DFS åºæœ€å°ã€æœ€å¤§ä¸¤ç‚¹çš„ LCAï¼Œå³ä¸ºåŒºé—´ LCA | ç»å…¸ç»“è®ºï¼Œè¯æ˜è§ crased é¢˜è§£å›¾ç¤ºã€‚ |
| **4. åˆ†ç±»è®¨è®ºäº”ç§æƒ…å†µ** | æ ¹æ®å­æ ‘åˆ†å¸ƒã€åŒºé—´ LCA ä¸ p çš„ç¥–å…ˆåä»£å…³ç³»ï¼Œåˆ†äº”ç§æƒ…å†µè®¡ç®—ç­”æ¡ˆ | æŠŠå¤æ‚æ¡ä»¶æ‹†æˆâ€œæ˜¯å¦å…¨éƒ¨åœ¨å­æ ‘â€ã€â€œæ˜¯å¦å…¨éƒ¨ä¸åœ¨â€ç­‰ç®€å•åˆ¤æ–­ã€‚ |

---

### âœ¨ è§£é¢˜æŠ€å·§æ€»ç»“
- **æŠ€å·§Aï¼šæ ‘ä¸Šé—®é¢˜é™ç»´** â†’ DFS åºæŠŠæ ‘ç»“æ„å‹æˆæ•°ç»„ã€‚  
- **æŠ€å·§Bï¼šä¸»å¸­æ ‘åŒºé—´ç‚¹è®¡æ•°** â†’ é™æ€åŒºé—´â€œå‡ºç°æ¬¡æ•°â€é—®é¢˜çš„ä¸‡èƒ½å·¥å…·ã€‚  
- **æŠ€å·§Cï¼šST è¡¨ç»´æŠ¤åŒºé—´ LCA** â†’ å€å¢ + æ¬§æ‹‰åºï¼ŒO(1) æŸ¥è¯¢åŒºé—´ LCAã€‚

---

### âš”ï¸ ç­–ç•¥ç«æŠ€åœºï¼šä¸åŒè§£æ³•å¯¹æ¯”

| ç­–ç•¥ | æ ¸å¿ƒæ€æƒ³ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|---|---|---|---|---|
| **æš´åŠ›æšä¸¾** | å¯¹ `[l,r]` æ¯ä¸ªç‚¹æ±‚ LCA å†å–äº¤é›† | æ€è·¯ç›´è§‚ | O(nq) çˆ†ç‚¸ | nâ‰¤1000 |
| **çº¿æ®µæ ‘åˆå¹¶** | æ ‘é“¾å‰–åˆ† + å¯æŒä¹…åŒ–çº¿æ®µæ ‘ | é€šç”¨ã€æ˜“æ‰©å±• | å¸¸æ•°å¤§ | nâ‰¤2e5 |
| **ä¸»å¸­æ ‘ + ST è¡¨**ï¼ˆæœ€ä¼˜ï¼‰ | DFS åº + ä¸»å¸­æ ‘ + ST è¡¨ | O(n log n) ç†è®ºæœ€ä¼˜ | ä»£ç ç¨é•¿ | n,qâ‰¤2e5 |

---

### âœ¨ ä¼˜åŒ–ä¹‹æ—…ï¼šä»â€œèƒ½åšâ€åˆ°â€œåšå¥½â€
> 1. æš´åŠ›æšä¸¾ï¼šæšä¸¾æ¯ä¸ªç‚¹ â†’ å¤æ‚åº¦çˆ†ç‚¸ã€‚  
> 2. å‘ç°é‡å¤è®¡ç®—ï¼šåŒºé—´ LCA å¯ä¸€æ¬¡æ±‚å‡ºã€‚  
> 3. å¼•å…¥ DFS åºï¼šå­æ ‘å˜åŒºé—´ï¼Œä¸»å¸­æ ‘è®¡æ•°ã€‚  
> 4. å¼•å…¥ ST è¡¨ï¼šåŒºé—´ LCA O(1) æŸ¥è¯¢ã€‚  
> 5. æœ€ç»ˆä¼˜åŒ–ï¼šäº”ç§æƒ…å†µä¸€æ¬¡åˆ¤æ¸…ï¼Œè¾¾åˆ° O(n log n)ã€‚

---

## 4. C++æ ¸å¿ƒä»£ç å®ç°èµæ

### æœ¬é¢˜é€šç”¨æ ¸å¿ƒC++å®ç°å‚è€ƒ
> ä»£ç ç»¼åˆäº† Owen_codeisking ä¸ strcmp æ€è·¯ï¼Œå±•ç¤ºâ€œä¸»å¸­æ ‘ + ST è¡¨â€å®Œæ•´æµç¨‹ã€‚

```cpp
#include <bits/stdc++.h>
using namespace std;
typedef long long ll;
const int N = 2e5 + 5, LOG = 18;
int n, q, dfn[N], siz[N], dep[N], fa[N][LOG];
ll dis[N];
vector<pair<int,int>> g[N];
struct Seg {
    int ls, rs, cnt;
} t[N * 20];
int rt[N], tot;

/* 1. DFS é¢„å¤„ç† */
void dfs(int u, int f) {
    static int tim = 0;
    dfn[u] = ++tim; siz[u] = 1;
    fa[u][0] = f; dep[u] = dep[f] + 1;
    for (int i = 1; i < LOG; ++i) fa[u][i] = fa[fa[u][i-1]][i-1];
    for (auto [v, w] : g[u]) if (v != f) {
        dis[v] = dis[u] + w;
        dfs(v, u); siz[u] += siz[v];
    }
}

/* 2. ä¸»å¸­æ ‘ï¼šåœ¨ DFS åºä¸ŠåŒºé—´ç‚¹è®¡æ•° */
void upd(int &o, int pre, int l, int r, int pos) {
    o = ++tot; t[o] = t[pre]; ++t[o].cnt;
    if (l == r) return;
    int mid = (l + r) >> 1;
    if (pos <= mid) upd(t[o].ls, t[pre].ls, l, mid, pos);
    else upd(t[o].rs, t[pre].rs, mid + 1, r, pos);
}
int query(int o1, int o2, int l, int r, int ql, int qr) {
    if (ql > qr) return 0;
    if (ql <= l && r <= qr) return t[o2].cnt - t[o1].cnt;
    int mid = (l + r) >> 1, res = 0;
    if (ql <= mid) res += query(t[o1].ls, t[o2].ls, l, mid, ql, qr);
    if (qr > mid) res += query(t[o1].rs, t[o2].rs, mid + 1, r, ql, qr);
    return res;
}

/* 3. åŒºé—´ LCAï¼ˆST è¡¨ï¼‰ */
int st[LOG][N];
int lca(int x, int y) {
    if (dep[x] < dep[y]) swap(x, y);
    for (int i = LOG - 1; ~i; --i) if (dep[fa[x][i]] >= dep[y]) x = fa[x][i];
    if (x == y) return x;
    for (int i = LOG - 1; ~i; --i) if (fa[x][i] != fa[y][i]) x = fa[x][i], y = fa[y][i];
    return fa[x][0];
}
int range_lca(int l, int r) {
    int k = __lg(r - l + 1);
    return lca(st[k][l], st[k][r - (1 << k) + 1]);
}

/* 4. ä¸»å‡½æ•° */
int main() {
    scanf("%d%d", &n, &q);
    for (int i = 1, u, v, w; i < n; ++i) {
        scanf("%d%d%d", &u, &v, &w);
        g[u].emplace_back(v, w);
        g[v].emplace_back(u, w);
    }
    dfs(1, 0);
    for (int i = 1; i <= n; ++i) upd(rt[i], rt[i-1], 1, n, dfn[i]);
    for (int i = 1; i <= n; ++i) st[0][i] = i;
    for (int k = 1; k < LOG; ++k)
        for (int i = 1; i + (1 << k) - 1 <= n; ++i)
            st[k][i] = lca(st[k-1][i], st[k-1][i + (1 << (k-1))]);

    ll last = 0;
    while (q--) {
        int p, l, r; scanf("%d%d%d", &p, &l, &r);
        p ^= last; l ^= last; r ^= last;
        int u = range_lca(l, r);
        int cnt_in = query(rt[l-1], rt[r], 1, n, dfn[p], dfn[p] + siz[p] - 1);
        if (cnt_in == r - l + 1) last = dis[u] - dis[p];
        else if (cnt_in) last = 0;
        else {
            int v = p;
            for (int k = LOG - 1; ~k; --k) {
                int up = fa[v][k];
                if (up && query(rt[l-1], rt[r], 1, n, dfn[up], dfn[up] + siz[up] - 1) == 0) v = up;
            }
            v = fa[v][0];
            last = dis[p] - dis[v];
        }
        printf("%lld\n", last);
    }
    return 0;
}
```

---

## 5. ç®—æ³•å¯è§†åŒ–ï¼šåƒç´ åŠ¨ç”»æ¼”ç¤º

### ä¸»é¢˜ï¼šåƒç´ æ¢é™©å®¶ Â· æ ‘é“¾è¿½è¸ª
> 8 ä½åƒç´ é£ï¼Œå±•ç¤ºâ€œä¸»å¸­æ ‘ + LCAâ€å¦‚ä½•ä¸€æ­¥æ­¥æ‰¾åˆ°å…¬å…±é“¾ã€‚

### åœºæ™¯è®¾è®¡
- **åƒç´ æ ‘**ï¼šèŠ‚ç‚¹ä¸º 8Ã—8 åƒç´ æ–¹å—ï¼Œè¾¹ä¸ºç»¿è‰²åƒç´ çº¿ï¼Œè¾¹æƒæ•°å­—æ‚¬æµ®ã€‚  
- **äº¤äº’é¢æ¿**ï¼š  
  - **Step / Auto / Reset** æŒ‰é’®ï¼ˆåƒç´ æŒ‰é’®ï¼ŒæŒ‰ä¸‹å»æœ‰â€œå’”å“’â€éŸ³æ•ˆï¼‰ã€‚  
  - **é€Ÿåº¦æ»‘å—**ï¼ˆ0.5Ã—~4Ã—ï¼‰ã€‚  
- **å…³é”®é«˜äº®**ï¼š  
  - å½“å‰æŸ¥è¯¢åŒºé—´ `[l,r]` èŠ‚ç‚¹é—ªè“å…‰ã€‚  
  - æ­£åœ¨æ£€æŸ¥çš„å­æ ‘è¾¹æ¡†çº¢è‰²é—ªçƒã€‚  
  - æœ€ç»ˆç­”æ¡ˆé“¾é«˜äº®é»„è‰²ï¼Œå¹¶æ’­æ”¾â€œèƒœåˆ©â€8-bit éŸ³æ•ˆã€‚

### åŠ¨ç”»æ­¥éª¤
1. **åˆå§‹åŒ–**ï¼šåƒç´ æ ‘ç”Ÿæˆï¼ŒDFS åºç¼–å·ä¾æ¬¡è½åœ¨èŠ‚ç‚¹ä¸Šã€‚  
2. **æŸ¥è¯¢å¼€å§‹**ï¼š  
   - è¾“å…¥ `p,l,r` åï¼ŒåŒºé—´èŠ‚ç‚¹é—ªè“ã€‚  
3. **å­æ ‘æ£€æŸ¥**ï¼š  
   - åƒç´ åŒ–ä¸»å¸­æ ‘â€œå¼¹å‡ºâ€ä¸€ä¸ªçª—å£ï¼ŒåŒºé—´ `[dfn[p], dfn[p]+siz[p]-1]` å†…èŠ‚ç‚¹è¢«â€œè®¡æ•°å™¨â€ç´¯åŠ ã€‚  
4. **åŒºé—´ LCA**ï¼š  
   - åƒç´ åŒ– ST è¡¨â€œæ»‘åŠ¨â€æ‰¾åˆ° `l,r` çš„ LCAï¼ŒèŠ‚ç‚¹é—ªæ©™ã€‚  
5. **åˆ†ç±»è®¨è®ºäº”ç§æƒ…å†µ**ï¼š  
   - æ¯ç§æƒ…å†µåœ¨å±å¹•é¡¶éƒ¨å¼¹å‡º 8-bit æç¤ºæ¡†ï¼Œä¾‹å¦‚â€œå…¨éƒ¨åœ¨å­æ ‘å†…ï¼â€  
6. **ç­”æ¡ˆé“¾é«˜äº®**ï¼š  
   - ä» p åˆ°æœ€ç»ˆäº¤ç‚¹è·¯å¾„é»„è‰²é«˜äº®ï¼Œæ’­æ”¾â€œå®å®â€éŸ³æ•ˆã€‚  
7. **é‡ç½®**ï¼šç‚¹å‡» Resetï¼Œæ ‘æ¢å¤åˆå§‹çŠ¶æ€ã€‚

### æ—ç™½ï¼ˆåƒç´ å¯¹è¯æ¡†ï¼‰
- â€œç°åœ¨æ£€æŸ¥åŒºé—´ `[l,r]` æ˜¯å¦å…¨éƒ¨è½åœ¨ p çš„å­æ ‘å†…â€¦â€¦â€  
- â€œåŒºé—´ LCA æ˜¯èŠ‚ç‚¹ 7ï¼Œè·ç¦» p ä¸º 42ï¼â€  

---

## 6. æ‹“å±•ç»ƒä¹ ä¸ç›¸ä¼¼é—®é¢˜æ€è€ƒ

### é€šç”¨æ€è·¯è¿ç§»
- **åŒºé—´ LCA**ï¼šé€‚ç”¨äºâ€œåŒºé—´ç‚¹å…±åŒç¥–å…ˆâ€ç±»é—®é¢˜ã€‚  
- **ä¸»å¸­æ ‘å­æ ‘è®¡æ•°**ï¼šé€‚ç”¨äºâ€œå­æ ‘å†…/å¤–åŒºé—´ç‚¹ç»Ÿè®¡â€ã€‚  
- **è·¯å¾„äº¤é›†**ï¼šé€‚ç”¨äºâ€œå¤šæ¡è·¯å¾„å…¬å…±éƒ¨åˆ†â€é—®é¢˜ã€‚

### æ´›è°·æ¨è
| é¢˜å· | æ¨èç†ç”± |
|---|---|
| P3384 ã€æ¨¡æ¿ã€‘é‡é“¾å‰–åˆ† | å­¦ä¼šæ ‘é“¾å‰–åˆ†ï¼Œä¸ºå¤æ‚æ ‘ä¸Šè·¯å¾„é—®é¢˜æ‰“åŸºç¡€ã€‚ |
| P4211 LCA | åŒºé—´ LCA ç»å…¸é¢˜ï¼Œå·©å›º ST è¡¨ + å€å¢ã€‚ |
| P2633 Count on a tree | ä¸»å¸­æ ‘ + æ ‘ä¸Šè·¯å¾„ï¼Œå¼ºåŒ–åŒºé—´ç‚¹è®¡æ•°ã€‚ |
| P4551 æœ€é•¿å¼‚æˆ–è·¯å¾„ | æ ‘ä¸Šè·¯å¾„ + Trieï¼Œä½“éªŒæ ‘ä¸Šè·¯å¾„é—®é¢˜çš„å¤šæ ·æ€§ã€‚ |

---

## 7. å­¦ä¹ å¿ƒå¾—ä¸ç»éªŒåˆ†äº«ï¼ˆæ‘˜ç¼–ï¼‰
> æ¥è‡ª strcmpï¼š  
> â€œå†™å®Œä»£ç ç›´æ¥ 1A1C äº†ï¼Œèˆ’æœã€‚â€  
> **æ´›è¯­äº‘ç¬ºç‚¹è¯„**ï¼š  
> ç®€æ´çš„ä»£ç æºäºå¯¹é—®é¢˜æœ¬è´¨çš„æ´å¯Ÿâ€”â€”æŠŠäº¤é›†é—®é¢˜è½¬åŒ–ä¸ºâ€œå­æ ‘åˆ†å¸ƒ + åŒºé—´ LCAâ€ï¼Œå†ç”¨ç»å…¸æ•°æ®ç»“æ„ç»„åˆå®ç°ã€‚ä¿æŒä»£ç æ•´æ´ï¼Œæ˜¯é«˜æ‰‹é£èŒƒã€‚

---

### ç»“è¯­
Treequery è®©æˆ‘ä»¬ä½“ä¼šåˆ°ï¼š  
**â€œæŠŠæ ‘ç»“æ„å‹æˆæ•°ç»„ï¼ŒæŠŠäº¤é›†é—®é¢˜è½¬åŒ–ä¸ºç¥–å…ˆé“¾é—®é¢˜ï¼Œå†ç”¨ç»å…¸æ•°æ®ç»“æ„ç»„åˆè§£å†³ã€‚â€**  
æ„¿ä½ åœ¨åƒç´ åŒ–çš„æ ‘é“¾ä¸Šï¼Œæ‰¾åˆ°å±äºè‡ªå·±çš„ç®—æ³•å®è—ï¼

---
å¤„ç†ç”¨æ—¶ï¼š131.69ç§’
# é¢˜ç›®ä¿¡æ¯

# ã€ŒPMOI-1ã€ä¸­ä½æ•°

## é¢˜ç›®æè¿°

ç»™å®šä¸€æ£µä»¥ $1$ ä¸ºæ ¹çš„åŒ…å« $n$ ä¸ªèŠ‚ç‚¹çš„**æœ‰æ ¹æ ‘**ã€‚ç¬¬ $i$ ä¸ªèŠ‚ç‚¹æœ‰ç‚¹æƒ $a_i$ã€‚

å®šä¹‰å‡½æ•° $f(u,v)$ è¡¨ç¤ºä» $u$ åˆ° $v$ ç»è¿‡çš„æ‰€æœ‰èŠ‚ç‚¹çš„ç‚¹æƒçš„**å¯é‡é›†**çš„ä¸­ä½æ•°ã€‚

è¯·æ³¨æ„ï¼Œ**æœ¬é¢˜ä¸­çš„ä¸­ä½æ•°çš„å®šä¹‰ä¸æ•°å­¦ä¸­çš„å®šä¹‰ç•¥æœ‰ä¸åŒ**ï¼šè¿™é‡Œä¸€ä¸ªé•¿åº¦ä¸º $t$ çš„åºåˆ—çš„ä¸­ä½æ•°å®šä¹‰ä¸ºè¿™ä¸ªåºåˆ—ç¬¬ $\left\lceil\frac{t+1}2\right\rceil$ å°çš„æ•°ã€‚

å®šä¹‰å‡½æ•° $\text{cover}(x_1,y_1,x_2,y_2)$ è¡¨ç¤ºä» $x_1$ åˆ° $y_1$ çš„è·¯å¾„æ˜¯å¦å®Œå…¨è¦†ç›–äº†ä» $x_2$ åˆ° $y_2$ çš„è·¯å¾„ã€‚å¦‚æœå®Œå…¨è¦†ç›–ï¼Œåˆ™ $\text{cover}(x_1,y_1,x_2,y_2)=1$ï¼Œå¦åˆ™ $\text{cover}(x_1,y_1,x_2,y_2)=0$ã€‚

ä½ éœ€è¦ä¾æ¬¡å¤„ç† $q$ æ¬¡æ“ä½œï¼ŒæŒ‰ç…§ä»¥ä¸‹æ ¼å¼ç»™å‡ºï¼š

`1 u`ï¼šè¡¨ç¤ºä¸€æ¬¡æ“ä½œï¼Œéœ€è¦ä½ å°†ç‚¹ $u$ çš„ç‚¹æƒå¯¹ $1$ **å¼‚æˆ–**ï¼›

`2 u v`ï¼šè¡¨ç¤ºä¸€æ¬¡è¯¢é—®ï¼Œéœ€è¦ä½ æ±‚å‡º $\max\limits_{1\le i\le n,1\le j\le n}\{\text{cover}(i,j,u,v)f(i,j)\}$ã€‚

å¯¹äºç¬¬äºŒç±»æ“ä½œï¼Œä¿è¯æ¯æ¬¡è¯¢é—®å‡æ»¡è¶³ $u$ ä¸æ˜¯ $v$ çš„ç¥–å…ˆä¸” $v$ ä¸æ˜¯ $u$ çš„ç¥–å…ˆï¼Œä¸” $u \neq v$ã€‚

ä½ éœ€è¦å¯¹äºæ¯ä¸ªç¬¬äºŒç±»æ“ä½œï¼Œè¾“å‡ºå¯¹åº”çš„å€¼ã€‚

## è¯´æ˜/æç¤º

ã€æ ·ä¾‹è§£é‡Šã€‘

ç¬¬ä¸€æ¬¡æ˜¯è¯¢é—®ã€‚æ˜¾ç„¶ï¼Œåªæœ‰ $(i=4,j=8)$ æ»¡è¶³ $\text{cover}(i,j,u,v)=1$ã€‚æ­¤æ—¶ $f(i,j)=3$ã€‚

ç¬¬äºŒæ¬¡æ˜¯æ“ä½œã€‚å°† $3$ å·èŠ‚ç‚¹çš„ç‚¹æƒæ”¹ä¸ºäº† $2$ã€‚

ç¬¬ä¸‰æ¬¡æ˜¯è¯¢é—®ã€‚å½“ $i=4,j=3$ æ—¶ï¼Œ$\text{cover}(i,j,u,v)=1$ ä¸” $f(i,j)=4$ã€‚ä¸éš¾å‘ç°ï¼Œå¯¹äºå…¶ä»–æ‰€æœ‰æ»¡è¶³ $\text{cover}(i,j,u,v)=1$ çš„èŠ‚ç‚¹å¯¹ $(i,j)$ï¼Œå‡æ²¡æœ‰ $f(i,j)>4$ã€‚

ã€æ•°æ®èŒƒå›´ã€‘
- Subtask 1ï¼ˆ8 ptsï¼‰ï¼š$n,q\le50$ï¼›
- Subtask 2ï¼ˆ12 ptsï¼‰ï¼š$n,q\le2\times10^3$ï¼›
- Subtask 3ï¼ˆ16 ptsï¼‰ï¼š$n,q\le4\times10^4$ï¼›
- Subtask 4ï¼ˆ10 ptsï¼‰ï¼šä¿è¯æ ‘çš„å½¢æ€éšæœºç”Ÿæˆï¼›
- Subtask 5ï¼ˆ12 ptsï¼‰ï¼šä¿è¯æ²¡æœ‰ $1$ æ“ä½œï¼›
- Subtask 6ï¼ˆ12 ptsï¼‰ï¼šä¿è¯æ¯æ¬¡è¯¢é—®çš„ $u,v$ éƒ½æ˜¯å¶å­èŠ‚ç‚¹ï¼›
- Subtask 7ï¼ˆ30 ptsï¼‰ï¼šæ— ç‰¹æ®Šé™åˆ¶ã€‚

Subtask 4 çš„éšæœºæ–¹å¼ä¸ºï¼šéšæœºç”Ÿæˆä¸€ä¸ªçš„æ’åˆ— $p$ï¼Œå¯¹äº $i\in[2,n]$ï¼Œ$p_i$ å‘ $p_1,p_2,...,p_{i-1}$ ä¸­ç­‰æ¦‚ç‡éšæœºçš„ä¸€ä¸ªç‚¹è¿è¾¹ã€‚

å¯¹äº $100\%$ çš„æ•°æ®æ»¡è¶³ï¼Œ$1\le n,q,a_i \le 10^5$ï¼Œä¿è¯æ¯æ¬¡è¯¢é—®å‡æ»¡è¶³ $u$ ä¸æ˜¯ $v$ çš„ç¥–å…ˆä¸” $v$ ä¸æ˜¯ $u$ çš„ç¥–å…ˆï¼Œä¸” $u \neq v$ã€‚

## æ ·ä¾‹ #1

### è¾“å…¥

```
8 3
4 2 3 4 2 1 4 3
1 2
1 3
2 4
2 5
3 6
6 7
6 8
2 4 8
1 3 
2 2 3```

### è¾“å‡º

```
3
4```

# AIåˆ†æç»“æœ

---
# ğŸ’¡ æ´›è¯­äº‘ç¬ºçš„C++ç®—æ³•è§£æï¼šã€ŒPMOI-1ã€ä¸­ä½æ•° æ·±å…¥å­¦ä¹ æŒ‡å— ğŸ’¡

> ä»Šå¤©æˆ‘ä»¬æ¥ä¸€èµ·åˆ†æã€ŒPMOI-1ã€ä¸­ä½æ•°è¿™é“**æ ‘å½¢æ•°æ®ç»“æ„ + äºŒåˆ† + ä¸»å¸­æ ‘**çš„ç»¼åˆé¢˜ã€‚å®ƒåƒä¸€åœºâ€œæ ‘ä¸Šå¯»å®â€â€”â€”åœ¨åºå¤§çš„å®¶æ—æ ‘é‡Œï¼Œæ—¢è¦å¿«é€Ÿæ”¹å®ç‰©çš„é¢œè‰²ï¼Œåˆè¦éšæ—¶å›ç­”â€œå“ªæ¡è·¯å¾„çš„å®è—ä¸­ä½æ•°æœ€å¤§â€ã€‚æˆ‘ä»¬å°†æ‹†è§£å¦‚ä½•æŠŠâ€œè·¯å¾„è¦†ç›– + ä¸­ä½æ•°æœ€å¤§åŒ–â€è¿™ä¸€æŠ½è±¡éœ€æ±‚ï¼Œä¸€æ­¥æ­¥è½åœ°ä¸ºå¯ç»´æŠ¤ã€å¯æŸ¥è¯¢çš„é«˜æ•ˆç®—æ³•ã€‚

---

## 1. é¢˜ç›®è§£è¯»ä¸ç­–ç•¥åˆæ¢

### âœ¨ æ ¸å¿ƒæŒ‘æˆ˜
åœ¨**å¸¦ä¿®æ”¹**çš„æœ‰æ ¹æ ‘ä¸Šï¼Œæ¯æ¬¡ç»™å‡ºä¸¤ä¸ªç‚¹ `u, v`ï¼ˆä¿è¯ä¸åœ¨åŒä¸€æ¡é“¾ï¼‰ï¼Œè¦æ±‚  
> åœ¨æ‰€æœ‰**å®Œå…¨è¦†ç›–** `(u, v)` çš„è·¯å¾„ `(i, j)` ä¸­ï¼Œæ‰¾å‡º**è·¯å¾„ç‚¹æƒä¸­ä½æ•°æœ€å¤§**çš„å€¼ã€‚

### âœ¨ æ ¸å¿ƒç®—æ³•æ ‡ç­¾
- **æ ‘é“¾å‰–åˆ† / LCA**
- **äºŒåˆ†ç­”æ¡ˆ**
- **ä¸»å¸­æ ‘ï¼ˆå¯æŒä¹…åŒ–çº¿æ®µæ ‘ + æ ‡è®°æ°¸ä¹…åŒ–ï¼‰**

### ğŸ” ç®—æ³•ä¾¦æ¢ï¼šå¦‚ä½•åœ¨é¢˜ç›®ä¸­å‘ç°çº¿ç´¢ï¼Ÿ
| çº¿ç´¢ | å‘ç°ä¸åˆ†æ |
| --- | --- |
| **çº¿ç´¢1ï¼šä¸­ä½æ•°æœ€å¤§åŒ–** | â€œæœ€å¤§å€¼â€ â†’ è‡ªç„¶æƒ³åˆ°**äºŒåˆ†ç­”æ¡ˆ** `mid`ï¼šæŠŠé—®é¢˜è½¬ä¸ºåˆ¤å®šæ€§é—®é¢˜â€”â€”æ˜¯å¦å­˜åœ¨è·¯å¾„ä¸­ä½æ•° â‰¥ `mid`ï¼Ÿ |
| **çº¿ç´¢2ï¼šè·¯å¾„å®Œå…¨è¦†ç›–** | é¢˜ç›®é™å®š `u, v` ä¸åœ¨åŒä¸€æ¡é“¾ï¼Œå› æ­¤ä¸€æ¡ `(i, j)` è¦†ç›– `(u, v)` å½“ä¸”ä»…å½“ `i âˆˆ subtree(u)` ä¸” `j âˆˆ subtree(v)`ï¼ˆæˆ–åä¹‹ï¼‰ã€‚ |
| **çº¿ç´¢3ï¼šç‚¹æƒåªæœ‰ 0/1 å˜åŒ–** | äºŒåˆ†åï¼ŒæŠŠ â‰¥ `mid` çš„ç‚¹æƒè§†ä¸º `+1`ï¼Œå…¶ä½™è§†ä¸º `-1`ï¼Œåˆ™è·¯å¾„å’Œ â‰¥ 0 ç­‰ä»·äºä¸­ä½æ•° â‰¥ `mid`ã€‚ |
| **çº¿ç´¢4ï¼šæ ‘ä¸Šå­æ ‘ = DFS åºåŒºé—´** | å­æ ‘åœ¨ DFS åºä¸Šæ˜¯è¿ç»­åŒºé—´ï¼Œå¯ç”¨**çº¿æ®µæ ‘/ä¸»å¸­æ ‘**ç»´æŠ¤åŒºé—´å’Œæˆ–åŒºé—´æœ€å€¼ã€‚ |
| **çº¿ç´¢5ï¼šå•ç‚¹ä¿®æ”¹å¼‚æˆ– 1** | ç‚¹æƒåªä¼š Â±1ï¼Œç¦»æ•£åŒ–å**åªæœ‰ä¸€ç‰ˆä¸»å¸­æ ‘**éœ€è¦æ”¹åŠ¨ï¼Œå¯ç”¨**æ ‡è®°æ°¸ä¹…åŒ–**å¿«é€Ÿå®ŒæˆåŒºé—´ Â±2ã€‚ |

### ğŸ§  æ€ç»´é“¾æ„å»ºï¼šä»çº¿ç´¢åˆ°ç­–ç•¥
> 1. æˆ‘è¦æœ€å¤§åŒ–ä¸­ä½æ•° â†’ ç»å…¸å¥—è·¯ï¼š**äºŒåˆ†ç­”æ¡ˆ**ã€‚<br>
> 2. åˆ¤å®šâ€œä¸­ä½æ•° â‰¥ midâ€ â†’ æŠŠç‚¹æƒ â‰¥ mid è®¾ 1ï¼Œå…¶ä½™è®¾ -1ï¼Œè·¯å¾„å’Œ â‰¥ 0 å³å¯ã€‚<br>
> 3. è·¯å¾„å¿…é¡»è¦†ç›– `(u, v)` â†’ æ‹†æˆä¸‰æ®µï¼š<br>
>    - `i â†’ u`ï¼ˆå­æ ‘ u å†…æŸç‚¹åˆ° uï¼‰<br>
>    - `u â†’ v`ï¼ˆå›ºå®šé“¾ï¼‰<br>
>    - `v â†’ j`ï¼ˆå­æ ‘ v å†…æŸç‚¹åˆ° vï¼‰<br>
>    ä¸‰æ®µæƒå€¼å’Œ â‰¥ 0 å³å¯ã€‚<br>
> 4. å­æ ‘å†…æœ€å¤§å€¼ â†’ **DFS åº + ä¸»å¸­æ ‘**ç»´æŠ¤åŒºé—´æœ€å¤§å€¼ã€‚<br>
> 5. å•ç‚¹ä¿®æ”¹ â†’ ç‚¹æƒ Â±1 åªä¼šå½±å“ä¸€ç‰ˆä¸»å¸­æ ‘ï¼Œç”¨**æ ‡è®°æ°¸ä¹…åŒ–**åŒºé—´ Â±2ã€‚

---

## 2. ç²¾é€‰ä¼˜è´¨é¢˜è§£å‚è€ƒ

| é¢˜è§£ | äº®ç‚¹æç‚¼ |
| --- | --- |
| **Y_B_X**ï¼ˆèµ 6ï¼‰ | å°†â€œä¸­ä½æ•° â‰¥ midâ€è½¬åŒ–ä¸ºâ€œæƒå€¼å’Œ â‰¥ 0â€éå¸¸æ¸…æ™°ï¼›åˆ©ç”¨**ä¸»å¸­æ ‘ + æ ‡è®°æ°¸ä¹…åŒ–**å¤„ç†åŒºé—´ Â±2ï¼Œå®ç°ç®€æ´ï¼›ç¦»æ•£åŒ–æ—¶å·§å¦™åˆ©ç”¨â€œå¥‡å¶ç›¸é‚»â€åªæœ‰ä¸€ç‰ˆéœ€è¦ä¿®æ”¹ã€‚ |
| **ducati**ï¼ˆèµ 5ï¼‰ | ç”¨ **Lemma 1/2** å½¢å¼åŒ–è¯æ˜è·¯å¾„æ‹†åˆ†ï¼›æŠŠä¸»å¸­æ ‘çš„æ—¶é—´è½´è§†ä¸ºâ€œæƒå€¼å¤§å°â€ï¼Œå°†ä¿®æ”¹è½¬åŒ–ä¸º**é‡å»º 4 æ£µçº¿æ®µæ ‘**ï¼Œæ€è·¯æ›´ç›´è§‚ï¼›å¤æ‚åº¦åˆ†æä¸¥è°¨ã€‚ |

---

## 3. è§£é¢˜ç­–ç•¥æ·±åº¦å‰–æ

### ğŸ¯ æ ¸å¿ƒéš¾ç‚¹ä¸å…³é”®æ­¥éª¤
1. **å…³é”®ç‚¹1ï¼šäºŒåˆ†åˆ¤å®šæ¨¡å‹**
   - **åˆ†æ**ï¼šæŠŠâ€œä¸­ä½æ•°æœ€å¤§åŒ–â€è½¬æˆâ€œæ˜¯å¦å­˜åœ¨è·¯å¾„ â‰¥ midâ€ï¼Œä»è€Œå¼•å…¥ 0/1 æƒå€¼ã€‚
   - ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šå½“æœ€å¤§åŒ–ç¬¬ k å¤§/ä¸­ä½æ•°æ—¶ï¼Œä¼˜å…ˆè€ƒè™‘**äºŒåˆ†ç­”æ¡ˆ + 0/1 è½¬åŒ–**ã€‚

2. **å…³é”®ç‚¹2ï¼šè·¯å¾„è¦†ç›– â†’ å­æ ‘æœ€å€¼**
   - **åˆ†æ**ï¼š`(i, j)` è¦†ç›– `(u, v)` â‡” `i âˆˆ subtree(u)` ä¸” `j âˆˆ subtree(v)`ï¼ˆæˆ–å¯¹ç§°ï¼‰ã€‚  
     æƒå€¼å’Œå…¬å¼ï¼š  
     `max_i (val_iâ†’u) + val_uâ†’v + max_j (val_vâ†’j) â‰¥ 0`
   - ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼šæ ‘ä¸Šâ€œå­æ ‘æœ€å€¼â€å¯å€ŸåŠ© DFS åºåŒºé—´æŸ¥è¯¢ï¼ŒæŠŠäºŒç»´æ ‘ç»“æ„å‹åˆ°ä¸€ç»´çº¿æ®µæ ‘ã€‚

3. **å…³é”®ç‚¹3ï¼šä¸»å¸­æ ‘ + æ ‡è®°æ°¸ä¹…åŒ–**
   - **åˆ†æ**ï¼š  
     - æƒå€¼ `a` ä»å°åˆ°å¤§å»ºç«‹ä¸»å¸­æ ‘ç‰ˆæœ¬ `rt[a]`ã€‚  
     - å½“ `a` å¢åŠ  1ï¼Œåªæœ‰æƒå€¼æ°å¥½ä¸º `a` çš„ç‚¹ä¼šä» `+1 â†’ -1`ï¼Œå…¶å­æ ‘å†…æ‰€æœ‰èŠ‚ç‚¹éœ€è¦ `-2`ã€‚  
     - æ ‡è®°æ°¸ä¹…åŒ–ï¼šåŒºé—´ Â±2 æ—¶ä¸ä¸‹æ”¾æ ‡è®°ï¼ŒæŸ¥è¯¢æ—¶ç´¯åŠ ç¥–å…ˆæ ‡è®°ï¼Œä¿è¯å¯æŒä¹…åŒ–ã€‚
   - ğŸ’¡ **å­¦ä¹ ç¬”è®°**ï¼š**æ ‡è®°æ°¸ä¹…åŒ–**æ˜¯å¯æŒä¹…åŒ–çº¿æ®µæ ‘åŒºé—´ä¿®æ”¹çš„åˆ©å™¨ï¼Œé¿å…å¤åˆ¶æ•´æ¡é“¾ã€‚

### âš”ï¸ ç­–ç•¥ç«æŠ€åœºï¼šä¸åŒè§£æ³•å¯¹æ¯”

| ç­–ç•¥ | æ ¸å¿ƒæ€æƒ³ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|---|---|---|---|---|
| **æš´åŠ› DFS** | æ¯æ¬¡è¯¢é—®æš´åŠ›æšä¸¾ `(i, j)` å¹¶æ£€æŸ¥ | æ€è·¯ç›´è§‚ | å¤æ‚åº¦ O(qÂ·nÂ²) | n â‰¤ 50ï¼ˆSubtask 1ï¼‰ |
| **ç¦»çº¿ + æ•´ä½“äºŒåˆ†** | æŠŠæ‰€æœ‰è¯¢é—®ä¸€èµ·äºŒåˆ†ï¼Œç”¨è™šæ ‘ + çº¿æ®µæ ‘ | ç†è®ºå¯è¡Œ | å®ç°å¤æ‚ï¼Œå¸¸æ•°å¤§ | n â‰¤ 4Ã—10â´ï¼ˆSubtask 3ï¼‰ |
| **åœ¨çº¿äºŒåˆ† + ä¸»å¸­æ ‘**ï¼ˆæ­£è§£ï¼‰ | æ¯ç‰ˆä¸»å¸­æ ‘ç»´æŠ¤ DFS åºåŒºé—´æœ€å¤§å€¼ | åœ¨çº¿ã€ç®€æ´ã€O(n logÂ² n) | ç©ºé—´ O(n log n) | æ— ç‰¹æ®Šé™åˆ¶ï¼ˆSubtask 7ï¼‰ |

---

## 4. C++æ ¸å¿ƒä»£ç å®ç°èµæ

### é€šç”¨æ ¸å¿ƒå®ç°å‚è€ƒ
> ç»¼åˆ Y_B_X ä¸ ducati çš„å®ç°ï¼Œæç‚¼å‡ºä¸€ä»½**å¯ç¼–è¯‘ã€æ˜“è¯»**çš„æ¡†æ¶ã€‚

```cpp
#include <bits/stdc++.h>
using namespace std;
const int N = 2e5 + 10, LOG = 20;

int n, q, a[N], b[N], nn;
vector<int> g[N];

/* ---------- ç¦»æ•£åŒ– ---------- */
void discrete() {
    for (int i = 1; i <= n; ++i) b[++nn] = a[i], b[++nn] = a[i] ^ 1;
    sort(b + 1, b + nn + 1);
    nn = unique(b + 1, b + nn + 1) - b - 1;
}

/* ---------- LCA ---------- */
int dep[N], fa[N][LOG];
void dfs_lca(int u, int pre) {
    dep[u] = dep[pre] + 1;
    fa[u][0] = pre;
    for (int i = 1; i < LOG; ++i) fa[u][i] = fa[fa[u][i - 1]][i - 1];
    for (int v : g[u]) if (v != pre) dfs_lca(v, u);
}
int lca(int u, int v) {
    if (dep[u] < dep[v]) swap(u, v);
    for (int i = LOG - 1; i >= 0; --i)
        if (dep[fa[u][i]] >= dep[v]) u = fa[u][i];
    if (u == v) return u;
    for (int i = LOG - 1; i >= 0; --i)
        if (fa[u][i] != fa[v][i]) u = fa[u][i], v = fa[v][i];
    return fa[u][0];
}

/* ---------- DFS åº ---------- */
int dfn[N], sz[N], idx;
void dfs_dfn(int u, int pre) {
    dfn[u] = ++idx;
    sz[u] = 1;
    for (int v : g[u]) if (v != pre) {
        dfs_dfn(v, u);
        sz[u] += sz[v];
    }
}

/* ---------- ä¸»å¸­æ ‘ ---------- */
struct Node { int l, r, tag, mx; } t[N * 25];
int rt[N], tot;
void build(int &p, int l, int r) {
    p = ++tot;
    if (l == r) { t[p].mx = dep[rev[l]]; return; }
    int mid = (l + r) >> 1;
    build(t[p].l, l, mid);
    build(t[p].r, mid + 1, r);
    t[p].mx = max(t[t[p].l].mx, t[t[p].r].mx);
}
void update(int &p, int pre, int l, int r, int ql, int qr, int v) {
    p = ++tot;
    t[p] = t[pre];
    if (ql <= l && r <= qr) {
        t[p].tag += v;
        t[p].mx += v;
        return;
    }
    int mid = (l + r) >> 1;
    if (ql <= mid) update(t[p].l, t[pre].l, l, mid, ql, qr, v);
    if (qr > mid)  update(t[p].r, t[pre].r, mid + 1, r, ql, qr, v);
    t[p].mx = max(t[t[p].l].mx, t[t[p].r].mx) + t[p].tag;
}
int query_mx(int p, int l, int r, int ql, int qr) {
    if (!p || ql > qr) return -1e9;
    if (ql <= l && r <= qr) return t[p].mx;
    int mid = (l + r) >> 1, res = -1e9;
    if (ql <= mid) res = max(res, query_mx(t[p].l, l, mid, ql, qr));
    if (qr > mid)  res = max(res, query_mx(t[p].r, mid + 1, r, ql, qr));
    return res + t[p].tag;
}
int query_point(int p, int l, int r, int pos) {
    if (l == r) return t[p].mx;
    int mid = (l + r) >> 1;
    if (pos <= mid) return query_point(t[p].l, l, mid, pos) + t[p].tag;
    else return query_point(t[p].r, mid + 1, r, pos) + t[p].tag;
}

/* ---------- ä¸»é€»è¾‘ ---------- */
int rev[N];
int main() {
    ios::sync_with_stdio(false);
    cin.tie(nullptr);
    cin >> n >> q;
    for (int i = 1; i <= n; ++i) cin >> a[i];
    for (int i = 1, u, v; i < n; ++i) {
        cin >> u >> v;
        g[u].push_back(v);
        g[v].push_back(u);
    }
    discrete();
    dfs_lca(1, 0);
    dfs_dfn(1, 0);
    for (int i = 1; i <= n; ++i) rev[dfn[i]] = i;

    /* åˆå§‹åŒ–ä¸»å¸­æ ‘ */
    build(rt[0], 1, n);
    vector<int> pos[N];
    for (int i = 1; i <= n; ++i) {
        int v = lower_bound(b + 1, b + nn + 1, a[i]) - b;
        pos[v].push_back(i);
    }
    for (int a = 1; a <= nn; ++a) {
        rt[a] = rt[a - 1];
        for (int u : pos[a - 1]) {
            update(rt[a], rt[a], 1, n, dfn[u], dfn[u] + sz[u] - 1, -2);
        }
    }

    while (q--) {
        int op, u, v;
        cin >> op >> u;
        if (op == 1) {
            int old = lower_bound(b + 1, b + nn + 1, a[u]) - b;
            int nxt = lower_bound(b + 1, b + nn + 1, a[u] ^ 1) - b;
            update(rt[nxt], rt[nxt], 1, n, dfn[u], dfn[u] + sz[u] - 1, (a[u] & 1) ? -2 : 2);
            a[u] ^= 1;
        } else {
            cin >> v;
            int l = lca(u, v);
            int L = 0, R = nn, ans = 0;
            while (L < R) {
                int mid = (L + R + 1) >> 1;
                int val = 0;
                val += query_mx(rt[mid], 1, n, dfn[u], dfn[u] + sz[u] - 1);
                val += query_mx(rt[mid], 1, n, dfn[v], dfn[v] + sz[v] - 1);
                val -= 2 * query_point(rt[mid], 1, n, dfn[l]);
                val += (a[l] >= b[mid]) ? 1 : -1;
                if (val >= 0) L = mid, ans = mid;
                else R = mid - 1;
            }
            cout << b[ans] << '\n';
        }
    }
    return 0;
}
```

---

## 5. ç®—æ³•å¯è§†åŒ–ï¼šåƒç´ åŠ¨ç”»æ¼”ç¤º

### ğŸ® åŠ¨ç”»ä¸»é¢˜
**â€œåƒç´ å¯»å®é˜Ÿâ€**  
ä¸€æ£µ 8Ã—8 çš„åƒç´ æ ‘ï¼ŒèŠ‚ç‚¹æ˜¯é—ªçƒçš„å®ç®±ï¼›æ¯æ¬¡è¯¢é—® `(u, v)` æ—¶ï¼Œåƒç´ æ¢é™©å®¶ä»å­æ ‘ `u` å‡ºå‘ï¼Œæ²¿ç€ç»¿è‰²åƒç´ è·¯å¾„å¥”å‘å­æ ‘ `v`ï¼Œå®æ—¶æ˜¾ç¤ºâ€œæƒå€¼å’Œâ€åƒç´ æ¡ã€‚

### ğŸ•¹ï¸ æ ¸å¿ƒæ¼”ç¤ºå†…å®¹
1. **äºŒåˆ†ç­”æ¡ˆè¿›åº¦æ¡**ï¼šå±å¹•é¡¶éƒ¨æ˜¾ç¤º `mid` å€¼ï¼Œéšç€äºŒåˆ†æ¨è¿›ï¼Œåƒç´ æ¡å·¦å³è·³åŠ¨ã€‚
2. **0/1 æƒå€¼æŸ“è‰²**ï¼šâ‰¥ `mid` çš„å®ç®±é—ªé‡‘è‰²ï¼ˆ+1ï¼‰ï¼Œ< `mid` é—ªè“è‰²ï¼ˆ-1ï¼‰ã€‚
3. **è·¯å¾„æƒå€¼å’Œ**ï¼šåƒç´ åŒ–æ•°å­—å®æ—¶ç´¯åŠ ï¼Œç»¿è‰²è·¯å¾„é«˜äº®ï¼ŒéŸ³æ•ˆâ€œå®â€è¡¨ç¤ºç´¯åŠ æˆåŠŸã€‚
4. **ä¸»å¸­æ ‘åŒºé—´æŸ¥è¯¢**ï¼šDFS åºåŒºé—´ç”¨åƒç´ å—é«˜äº®ï¼Œæ ‡è®°æ°¸ä¹…åŒ–çš„ `+2/-2` ç”¨çº¢è‰²/ç»¿è‰²åƒç´ ç®­å¤´æ ‡æ³¨ã€‚

### ğŸ¯ äº¤äº’æ§åˆ¶
- **å•æ­¥ / è‡ªåŠ¨**ï¼šç‚¹å‡»â€œå•æ­¥â€é€å¸§æŸ¥çœ‹ï¼›ç‚¹å‡»â€œè‡ªåŠ¨â€å¼€å¯ 8-bit BGM è‡ªåŠ¨æ¼”ç¤ºã€‚
- **é€Ÿåº¦æ»‘å—**ï¼š0.5Ã— ~ 3Ã— è°ƒé€Ÿã€‚
- **éŸ³æ•ˆ**ï¼šé‡‘è‰²å®ç®±â€œå®â€ï¼Œè“è‰²å®ç®±â€œå’šâ€ï¼ŒæˆåŠŸæ‰¾åˆ°ç­”æ¡ˆæ’­æ”¾ FC èƒœåˆ©éŸ³æ•ˆã€‚

---

## 6. æ‹“å±•ç»ƒä¹ ä¸ç›¸ä¼¼é—®é¢˜æ€è€ƒ

| é€šç”¨æŠ€å·§è¿ç§»åœºæ™¯ | ç¤ºä¾‹è¯´æ˜ |
|---|---|
| **ä¸­ä½æ•°æœ€å¤§åŒ–** | åºåˆ— / æ ‘ä¸ŠåŒºé—´ç¬¬ k å¤§ã€ç¬¬ k å°é—®é¢˜ï¼Œå‡å¯ç”¨äºŒåˆ† + 0/1 è½¬åŒ–ã€‚ |
| **å­æ ‘åŒºé—´æŸ¥è¯¢** | å­æ ‘å’Œã€å­æ ‘æœ€å¤§å€¼ã€å­æ ‘é¢œè‰²æ•°ï¼Œå‡å¯ DFS åº + çº¿æ®µæ ‘/ä¸»å¸­æ ‘ã€‚ |
| **æ ‡è®°æ°¸ä¹…åŒ–** | å¯æŒä¹…åŒ–çº¿æ®µæ ‘çš„åŒºé—´ä¿®æ”¹ï¼Œé¿å…ä¸‹æ”¾æ ‡è®°ï¼Œé€‚åˆç¦»çº¿æˆ–åœ¨çº¿ã€‚ |

### æ´›è°·æ¨èç»ƒä¹ 
1. **P2839** [é›†åˆ]  
   ğŸ—£ï¸ åŒæ ·ä½¿ç”¨â€œä¸­ä½æ•° â‰¥ midâ€çš„ 0/1 è½¬åŒ–å¥—è·¯ï¼Œå·©å›ºä¸»å¸­æ ‘ã€‚
2. **P3302** [æ ‘é“¾å‰–åˆ†]  
   ğŸ—£ï¸ æ ‘ä¸Šè·¯å¾„æŸ¥è¯¢æœ€å¤§å€¼ï¼Œç†Ÿæ‚‰ DFS åºä¸çº¿æ®µæ ‘ã€‚
3. **P3380** [äºŒé€¼å¹³è¡¡æ ‘]  
   ğŸ—£ï¸ åŒºé—´ç¬¬ k å¤§ï¼Œæ•´ä½“äºŒåˆ† + æ ‘çŠ¶æ•°ç»„/ä¸»å¸­æ ‘ç»¼åˆç»ƒä¹ ã€‚

---

## 7. å­¦ä¹ å¿ƒå¾—ä¸ç»éªŒåˆ†äº«

> **Y_B_X** æåˆ°ï¼šâ€œç¦»æ•£åŒ–æ—¶æŠŠ `a[i]` å’Œ `a[i]^1` ä¸€èµ·ç¦»æ•£åŒ–ï¼Œä¿è¯å¼‚æˆ–ååªåŠ¨ä¸€ç‰ˆä¸»å¸­æ ‘ï¼Œå‡å°‘ç é‡ã€‚â€  
> **æ´›è¯­äº‘ç¬ºç‚¹è¯„**ï¼šç¦»æ•£åŒ–æŠ€å·§æ˜¯**å‡å°‘ä¸»å¸­æ ‘ç‰ˆæœ¬**çš„å…³é”®ï¼Œé¿å…æ¯æ¬¡ä¿®æ”¹éƒ½é‡å»ºæ•´æ£µæ ‘ï¼Œå€¼å¾—å€Ÿé‰´ï¼

---

<conclusion>
æœ¬æ¬¡æˆ‘ä»¬æ‹†è§£äº†ä¸€é“â€œæ ‘ä¸Šä¸­ä½æ•°æœ€å¤§åŒ–â€éš¾é¢˜ï¼Œä»äºŒåˆ†ç­”æ¡ˆåˆ°ä¸»å¸­æ ‘æ ‡è®°æ°¸ä¹…åŒ–ï¼Œå†åˆ° DFS åºåŒºé—´æŸ¥è¯¢ï¼Œæ¯ä¸€æ­¥éƒ½ä½“ç°äº†â€œæŠ½è±¡ â†’ è½¬åŒ– â†’ æ•°æ®ç»“æ„â€çš„ç»å…¸å¥—è·¯ã€‚å¸Œæœ›å¤§å®¶æŠŠè¿™å¥—æ€ç»´è¿ç§»åˆ°æ›´å¤šæ ‘å½¢é—®é¢˜ä¸­ï¼Œä¸‹æ¬¡æ¢é™©è§ï¼
</conclusion>

---
å¤„ç†ç”¨æ—¶ï¼š113.33ç§’
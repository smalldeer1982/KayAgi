---
title: "【MX-X1-T6】「KDOI-05」简单的图上问题"
layout: "post"
diff: NOI/NOI+/CTSC
pid: P10718
tag: ['图论', '计算几何', '平衡树', 'O2优化', '平面图', '平面图欧拉公式', '梦熊比赛']
---
# 【MX-X1-T6】「KDOI-05」简单的图上问题
## 题目背景

原题链接：<https://oier.team/problems/X1F>。
## 题目描述

给你一个 $n$ 个点 $m$ 条边的边双连通图，并且给定了每个点的坐标，保证每条边不相交或者只在端点处重合。

给定 $k$ 个图上的简单环 $C_1,C_2,\dots,C_k$，定义 $G_i$ 为只考虑 $C_i$ 内部的点和边所组成的图。

对 $S\subseteq\{1,2,\dots,k\},S=\{s_1,s_2,\dots,s_t\}$，定义 $f(S)$ 表示所有 $G_{s_i}$ 交的连通块数量。

有 $q$ 个询问，每次给出一个 $z$，输出 $\sum_{S\subseteq\{1,2,\dots,k\},|S|=z}f(S)$。对 $998244353$ 取模。
## 输入格式

第一行三个正整数表示 $n,m,k$。

接下来 $n$ 行，每行两个整数 $(x_i,y_i)$ 表示第 $i$ 个点的坐标。保证所有 $1\leq i<j\leq n$，都有 $x_i\neq x_j,y_i\neq y_j$。

接下来 $m$ 行，每行两个正整数 $u_i,v_i$，表示一条连接 $(u_i,v_i)$ 的无向边。

接下来 $k$ 行，每行第一个正整数 $l_i$ 表示环的大小，接下来 $l_i$ 个正整数 $C_{i,1},C_{i,2},\dots,C_{i,l_i}$ 表示一个原图的简单环，保证 $C_{i,j}$ 按顺序连接可以得到原图上的一个环。

接着一行一个正整数表示 $q$。

最后 $q$ 行，每行一个正整数表示询问的 $z_i$。
## 输出格式

输出 $q$ 行，每行一个整数表示 $\sum_{S\subseteq\{1,2,\dots,k\},|S|=z}f(S)$ 对 $998244353$ 取模后的值。
## 样例

### 样例输入 #1
```
4 5 3
1 1
3 2
2 3
4 4
1 2
1 3
1 4
2 4
3 4
3 1 2 4
3 1 3 4
4 1 2 4 3
3
1
2
3

```
### 样例输出 #1
```
3
3
1
```
### 样例输入 #2
```
8 15 5
4 4
5 8
2 7
10 9
1 10
3 5
8 2
7 6
2 1
3 1
3 2
4 1
4 2
5 2
5 3
5 4
6 1
6 3
7 1
7 4
8 1
8 4
8 7
3 1 8 4 
3 1 6 3 
3 7 8 4 
4 8 1 7 4 
3 1 2 3 
5
1
2
3
4
5
```
### 样例输出 #2
```
5
8
5
1
0
```
## 提示

**【样例解释 \#1】**

样例 $1$ 的数据如图：

![](https://cdn.luogu.com.cn/upload/image_hosting/7v424onc.png)

**【数据范围】**

**本题采用捆绑测试。**

| 子任务编号 | 分值 | $n\leq$ | 特殊性质 |
|:--:|:--:|:--:|:--:|
| $1$ | $15$ | $10$ | 无 |
| $2$ | $30$ | $1000$ | 无 |
| $3$ | $30$ | $4\times10^4$ | 保证平面图是一个凸包的三角剖分 |
| $4$ | $15$ | $4\times10^4$ | 无 |
| $5$ | $10$ | $10^5$ | 无 |

对于 $100\%$ 的数据：$1\leq n,\sum l_i\leq10^5$，$1\leq m\leq 3n-6$，$3\leq l_i$，$0\leq |x_i|,|y_i|\leq 10^9$，$1\leq q\leq 20$，$1\leq u_i,v_i\leq n$，$u_i\neq v_i$，$1\leq z_i\leq k$。保证所有 $1\leq i<j\leq n$，都有 $x_i\neq x_j,y_i\neq y_j$。保证每条边不相交或者只在端点处重合，保证图是一个边双连通分量。


---

---
title: "【MX-X3-T7】「RiOI-4」Re：End of a Dream"
layout: "post"
diff: NOI/NOI+/CTSC
pid: P11040
tag: ['线段树', '平衡树', 'O2优化', '组合数学', '梦熊比赛']
---
# 【MX-X3-T7】「RiOI-4」Re：End of a Dream
## 题目背景

原题链接：<https://oier.team/problems/X3H>。

---

![](https://cdn.luogu.com.cn/upload/image_hosting/dwohziu8.png)

（图片来自 phigros 曲绘，侵删。）

还是来谈点现实的吧。

身边的同学 NOI 拿了 Ag，APIO 捧了杯，省选啥的也比小 $\iiint$ 好。小 $\iiint$ 说，他的时间花在游戏上了。可看看隔壁提前招进高中的，florr 号里都有 Super Ant Egg 了。小 $\iiint$ 说，他网不好，实力发挥不出来。可再看隔壁 i wanna 大神，都开始速通 i wanna be the guy 了。小 $\iiint$ 争道，他也没打多久游戏，只是在专心文化课。但是成绩一拉出来，成了信竞班垫底。小 $\iiint$ 又说，可能是时间花在社交上了吧。大家都觉得他很幽默，因为他在班里一个朋友都没有。

小 $\iiint$ 不明白为什么会这样。

今年对于小 $\iiint$ 来说，可能就是他 OI 生涯的最后一年了。一年太短，能补救多少？能挽回多少？当年他刚学 OI 时，就暗暗地下定决心，要成为大家口中的“神犇”。三年过去，前途仍是一片昏暗。

这或许就是，$\color{#CD0000}\overset{\text{End of a Dream}}{\text{梦\ 的\ 终\ 结}}$。

也许，**梦是反着的吧。**

……

但是这里是梦熊周赛题目，不是出题人拿来写批话的地方，所以小 $\iiint$ 需要你做一道计数题。
## 题目描述

给定 $n,q$。现有一个初始为 $0$ 的整数 $m$。你需要支持以下操作：

- `0 x`：将 $m$ 加上 $2^x$。
- `1 x`：将 $m$ 减去 $2^x$。若 $m<2^x$，则忽略此操作。
- `2`：查询有多少长度为 $n$、每个数都在 $1\sim m$ 中的严格递增正整数序列，使得其前缀异或和与后缀异或和均严格递增。答案对 $998\,244\,353$ 取模。

其中，一个序列 $a_1,a_2,\cdots,a_n$ 的**前缀异或和**是指序列 $s_1,s_2,\cdots,s_n$，满足 $s_i=\begin{cases}a_1&i=1\\a_{i}\oplus s_{i-1}&i\ge2\end{cases}$，而其**后缀异或和**是指序列 $t_1,t_2,\cdots,t_n$，满足 $t_i=\begin{cases}a_n&i=1\\a_{n-i+1}\oplus t_{i-1}&i\ge2\end{cases}$，其中 $x\oplus y$ 表示 $x$ 与 $y$ 的按位异或。
## 输入格式

第一行两个正整数，表示 $n,q$。

接下来 $q$ 行，每行表示一个操作。
## 输出格式

对于每个 `2` 操作，输出对应的答案对 $998\,244\,353$ 取模的值。
## 样例

### 样例输入 #1
```
3 4
0 0
0 1
0 2
2
```
### 样例输出 #1
```
2
```
### 样例输入 #2
```
20 15
0 1
0 2
0 21
0 5
2
0 15
1 18
0 7
0 8
0 25
2
1 22
0 12
0 13
2
```
### 样例输出 #2
```
313288290
39181640
134388812
```
## 提示

**【样例解释 #1】**

查询时 $m=7$，满足要求的序列为 $\{1,2,4\}$ 和 $\{1,3,5\}$，可以证明不存在其他解。

注意，序列 $\{1,3,1\}$ 是不满足要求的，尽管其前、后缀异或和均为严格递增数列 $\{1,2,3\}$，该序列本身并不满足严格递增的限制。

**【数据范围】**

**本题开启捆绑测试。**

|子任务|分数|$n\le$|$q\le$|$x\le$|特殊性质|
|:-:|:-:|:-:|:-:|:-:|:-:|
|$1$|$5$|$5$|$10$|$10$||
|$2$|$10$|$10^3$|$10^3$|$10^3$||
|$3$|$11$|$10^3$|$2\times10^5$|$10^5$|AB|
|$4$|$14$|$10^5$|$2\times10^5$|$10^5$|AB|
|$5$|$16$|$10^7$|$10^2$|$10^7$|B|
|$6$|$19$|$10^7$|$2\times10^5$|$10^7$|B|
|$7$|$25$|$10^7$|$2\times10^5$|$10^7$||

特殊性质 A：仅有最后一次操作为 `2` 操作。  
特殊性质 B：不包含 `1` 操作。

对于 $100\%$ 的数据，$3\le n\le 10^7$，$1\le q\le 2\times10^5$，$0\le x\le 10^7$。


---

---
title: "三角形面积并 加强版"
layout: "post"
diff: NOI/NOI+/CTSC
pid: P13338
tag: ['计算几何', '平衡树', 'Special Judge', '微积分']
---
# 三角形面积并 加强版
## 题目背景

[原题链接](https://www.luogu.com.cn/problem/P4406)
## 题目描述

给定 $n$ 个非退化三角形 $\triangle A_i B_i C_i\ (1 \leq i \leq n)$，你的任务是计算这些三角形的并集面积。

一个三角形是**非退化**的，当且仅当它具有非零面积，即三角形的三个顶点 $A_i,B_i,C_i$ 是不同的且不共线。换句话说，点 $A_i,B_i,C_i$ 不在同一条直线上，由这三点构成的三角形不是退化的。

三角形的**并集面积**是至少被其中一个三角形覆盖的总面积。形式化地，三角形的并集面积是由这些三角形所占区域的并集所形成的区域的面积：
$$
\text{Area}\left(\bigcup_{i=1}^n S_i\right)
$$
其中 $S_i$ 表示三角形 $\triangle A_i B_i C_i$ 所占的几何区域，$\text{Area}(S_i)$ 是该区域的面积。$\bigcup_{i=1}^n S_i$ 表示至少被其中一个三角形覆盖的区域。

## 输入格式

每个测试文件中仅包含一个测试用例。

第一行包含一个整数 $n\ (1 \leq n \leq 10^3)$，表示三角形的数量。

接下来的 $n$ 行，每行包含六个整数 $x_1\ y_1\ x_2\ y_2\ x_3\ y_3\ (0 \leq |x|, |y| \leq 10^6)$，表示三角形 $\triangle A_i B_i C_i$ 的三个顶点的坐标。

## 输出格式

输出一个实数，表示这些三角形的并集面积。你的答案的绝对误差或相对误差应小于 $10^{-6}$。当你的答案为 $a$，评测机的答案为 $b$，则当 $\frac{|a-b|}{\max(1,|b|)} \leq 10^{-6}$ 时答案被接受。
## 样例

### 样例输入 #1
```
2
1 1 2 7 8 8
1 1 2 7 8 8
```
### 样例输出 #1
```
17.50000000000000000000
```
### 样例输入 #2
```
4
2 1 7 4 4 10
4 6 3 3 5 3
9 6 7 12 11 8
9 2 1 6 11 10
```
### 样例输出 #2
```
48.75833209115131640239
```
## 提示

样例 2 图示：

![样例 2](https://cdn.luogu.com.cn/upload/image_hosting/vwry2al7.png)

对于子任务 1，输入数据满足 $1 \leq n \leq 100$，且 $0 \leq |x|, |y| \leq 10^3$。该子任务可用于测试算法的正确性。完成子任务 1 将获得总分的 $50\%$。

对于子任务 2，输入数据满足 $1 \leq n \leq 10^3$，且 $0 \leq |x|, |y| \leq 10^6$。完成子任务 2 将获得剩余 $50\%$ 的分数。

提示：求解三角形的并集面积是一个经典的 3SUM-hard 问题。你需要实现一个时间复杂度为 $\mathcal{O}(V^2 \log V)$ 的算法，其中 $V$ 为顶点总数。


---

---
title: "[HNOI2014] 道路堵塞"
layout: "post"
diff: NOI/NOI+/CTSC
pid: P3238
tag: ['2014', '各省省选', '平衡树', '湖南', '最短路']
---
# [HNOI2014] 道路堵塞
## 题目背景

### 本题可能不存在正确解法，题解均已被 hack。
## 题目描述

A 国有 $N$ 座城市，依次标为 $1$ 到 $N$。同时，在这 $N$ 座城市间有 $M$ 条单向道路，每条道路的长度是一个正整数。现在，A 国交通部指定了一条从城市 $1$ 到城市 $N$ 的路径，并且保证这条路径的长度是所有从城市 $1$ 到城市 $N$ 的路径中最短的。不幸的是，因为从城市 $1$ 到城市 $N$ 旅行的人越来越多，这条由交通部指定的路径经常发生堵塞。现在 A 国想知道，这条路径中的任意一条道路无法通行时，由城市 $1$ 到 $N$ 的最短路径长度是多少。
## 输入格式

输入文件第一行是三个用空格分开的正整数 $N$、$M$ 和 $L$，分别表示城市数目、单向道路数目和交通部指定的最短路径包含多少条道路。按下来 $M$ 行，每行三个用空格分开的整数 $a$、$b$ 和 $c$，表示存在一条由城市 $a$ 到城市 $b$ 的长度为 $c$ 的单向道路。这 $M$ 行的行号也是对应道路的编号，即其中第 $1$ 行对应的道路编号为 $1$，第 $2$ 行对应的道路编号为 $2$，......，第 $M$ 行对应的道路编号为 $M$。最后一行为 $L$ 个用空格分开的整数 $\operatorname{sp}(1),\ldots,\operatorname{sp}(L)$，依次表示从城市 $1$ 到城市 $N$ 的由交通部指定的最短路径上的道路的编号。
## 输出格式

输出文件包含 $L$ 行，每行为一个整数，第 $i$ 行（$i = 1,2,\ldots,L$）的整数表示删去编号为 $\operatorname{sp}(i)$ 的道路后从城市 $1$ 到城市 $N$ 的最短路径长度。如果去掉后没有从城市 $1$ 到城市 $N$ 的路径，则输出 $-1$。
## 样例

### 样例输入 #1
```
4 5 2
1 2 2
1 3 2
3 4 4
3 2 1
2 4 3
1 5
```
### 样例输出 #1
```
6

6
```
## 提示

$100\%$ 的数据满足 $2 < N < 100000$，$1 < M < 200000$，$c \in [0, 10000] \cap \mathbb{Z}$。

数据已加强 By Vfleaking。

2023.4.8 添加两组 hack 数据。


---

---
title: "[WC2014] 紫荆花之恋"
layout: "post"
diff: NOI/NOI+/CTSC
pid: P3920
tag: ['2014', '点分治', '平衡树', '分治', 'WC']
---
# [WC2014] 紫荆花之恋
## 题目描述

强强和萌萌是一对好朋友。有一天他们在外面闲逛，突然看到前方有一棵紫荆树。这已经是紫荆花飞舞的季节了，无数的花瓣以肉眼可见的速度从紫荆树上长了出来。

仔细看看的话，这个大树实际上是一个带权树。每个时刻它会长出一个新的叶子节点，每个节点上有一个可爱的小精灵，新长出的节点上也会同时出现一个新的小精灵。小精灵是很萌但是也很脆弱的生物，每个小精灵 $i$ 都有一个感受能力值 $r_i$，小精灵 $i,j$ 成为朋友当且仅当在树上 $i$ 和 $j$ 的距离 $dist(i,j) \leq r_i+r_j$，其中 $dist(i,j)$ 表示在这个树上从 $i$ 到 $j$ 的唯一路径上所有边的边权和。

强强和萌萌很好奇每次新长出一个叶子节点之后，这个树上总共有几对朋友。


我们假定这个树一开始为空，节点按照加入的顺序从 1 开始编号。由于强强非常好奇，你必须在他每次出现新结点后马上给出总共的朋友对数，不能拖延哦。
## 输入格式

第一行包含一个整数，表示测试点编号。

第二行包含一个正整数 $n$，表示总共要加入的节点数。

我们令加入节点前的总共朋友对数是 $last\_ans$，在一开始时它的值为 0。

接下来 $n$ 行中第 $i$ 行有三个非负整数 $a_i,c_i,r_i$，表示结点 i 的父节点的编号为 $ai \; \oplus \; (last\_ans \; \bmod \; 10^9)$（其中 $\oplus$ 表示异或，数据保证这样操作后得到的结果介于 1 到 $i−1$ 之间），与父结点之间的边权为 $c_i$，节点 $i$ 上小精灵的感受能力值为 $r_i$。

注意 $a_1=c_1=0$，表示 1 号节点是根结点，对于 $i>1$，父节点的编号至少为 1。
## 输出格式

包含 $n$ 行，每行输出 1 个整数，表示加入第 $i$ 个点之后，树上有几对 friends。
## 样例

### 样例输入 #1
```
0
5
0 0 6
1 2 4
0 9 4
0 5 5
0 2 4

```
### 样例输出 #1
```
0
1
2
4
7

```
## 提示

所有数据均满足 $1 \leq c_i \leq 10^4$，$a_i \leq 2\times 10^9$，$r_i \leq 10^9$。

| 测试点编号       | 约定                                                         |
| :----------------: | :------------------------------------------------------------: |
| $1,2$            | $n \leq 100$                                                 |
| $3,4$            | $n \leq 1000$                                                |
| $5,6,7,8$        | $n \leq 10^5$，节点 1 最多有两个子节点，其他节点最多有一个子节点 |
| $9,10$           | $n \leq 10^5$，$r_i \leq 10$                                 |
| $11,12$          | $n \leq 10^5$，树是随机生成的                                |
| $13,14,15$       | $n \leq 7\times 10^4$                                        |
| $16,17,18,19,20$ | $n \leq 10^5$                                                |


---

---
title: "[WC2013] 平面图"
layout: "post"
diff: NOI/NOI+/CTSC
pid: P4073
tag: ['图论', '计算几何', '2013', '倍增', '平衡树', '枚举', '生成树', 'WC']
---
# [WC2013] 平面图
## 题目描述

在一个平面中有 $n$ 个顶点和 $m$ 条直线段，第 $i$ 个顶点的坐标为 $(x_i, y_i)$， 第 $j$ 条直线段连接顶点 $u_j$ 和顶点 $v_j$，权值为 $h_j$， 除顶点 $u_j$ 和 $v_j$ 外直线段 $j$ 不经过其他的顶点。任意两条直线段如果存在公共点，则该公共点一定是一个顶点，此时这两条直线段都会连接这个顶点。对于任意的两个顶点 $x$ 和 $y$，总是可以找到一顶点序列 $a_1,a_2,\cdots,a_k$ 使得 $a_1=x$，$a_k=y$ 且对于任意 $1\le i< k$ 满足 $a_i$ 和 $a_{i+1}$ 被一条直线段直接连接。

这 $m$ 条直线段将整个平面分成了若干个区域，其中只有一个区域是无穷大的，其余均是有界的，我们称无穷大的区域为禁区。

现在给出 $q$ 次询问，每次给定平面中的任意两个不是顶点且分别不在任意一条直线段上的点 $A$ 和 $B$，请画一条曲线连接 $A$ 和 $B$，要求曲线不能经过禁区以及任何顶点，并使得穿过的直线段中权值最大的尽可能小。你需要对每次询问回答这个值最小为多少。

## 输入格式

第一行有两个正整数 $n,m$，分别表示顶点数和直线段数。

接下来 $n$ 行，每行两个整数，这部分中第 $i$ 行（总第 $i+1$ 行）的两个整数 $x_i,y_i$ 为顶点 $i$ 的坐标。

接下来 $m$ 行，每行三个正整数 $u,v,h$，表示有一条直线段连接顶点 $u$ 和顶点 $v$，权值为 $h$。其中 $u\neq v$。

接下来的一行，有一个正整数 $q$，表示询问数量。

接下来 $q$ 行，每行四个实数 $A_x,A_y,B_x,B_y$， 表示一组两个点的坐标分别为 $(A_x, A_y)$ 和 $(B_x, B_y)$ 的询问。

## 输出格式

输出 $q$ 行，每行一个正整数，依次表示每个询问的答案。特别的，若不需要跨过任何一条边即可到达，请输出 $0$；若不存在合法的曲线，请输出 $-1$。

## 样例

### 样例输入 #1
```
9 12
1 1
1 2
1 3
2 1
2 2
2 3
3 1
3 2
3 3
1 2 10
2 3 10
3 6 10
6 9 10
9 8 10
8 7 10
7 4 10
4 1 10
2 5 3
5 8 2
5 6 4
4 5 1
3
1.5 1.5 2.5 2.5
1.5 2.5 2.5 1.5
0.5 0.5 1.5 1.5
```
### 样例输出 #1
```
2
3
-1
```
## 提示

【样例说明】

![QQ20180112214336.png](https://cdn.luogu.com.cn/upload/image_hosting/228djzaq.png)

【数据规模与约定】

本题共设有 $10$ 个测试点，每个测试点的规模与特征如下：

![](https://cdn.luogu.com.cn/upload/image_hosting/2l8u3hkb.png)

对于全部数据，均满足 $5$ ≤ $n$, $m$, $q$ ≤ $100,000$，所有直线段的权值不会超过 $10^9$。所有询问坐标均为不超过 $10^7$ 的实数，且保证是 $0.5$ 的整数倍。



---

---
title: "[SDOI2018] 物理实验"
layout: "post"
diff: NOI/NOI+/CTSC
pid: P4605
tag: ['2018', '各省省选', '平衡树', '山东', 'Special Judge', 'O2优化', '前缀和', '向量']
---
# [SDOI2018] 物理实验
## 题目描述

小 T 这学期有物理实验课，为了顺利完成下一节课的实验，他打算在课前对实验内容进行预习。

这次实验在一个二维平面上进行，平面上放置了一条无限长的直线导轨，导轨上放置了一个长为$L$的激光发射器，激光发射器会向导轨两侧沿导轨垂直方向发射宽度为$L$的激光束。

平面上还放置了 $n$ 个挡板，每个挡板可以看作是一条线段，现在每个挡板都不和直线导轨接触，且
和直线导轨的夹角不超过 $85	\degree$，任意两个挡板也不会相互接触，激光束不能穿透这些挡板，并且会被挡板吸收掉，不会被挡板反射出去。

小 T 想确定一个激光发射器的位置使得被激光束照射到的挡板长度之和最大，你需要帮小 T 算出这
个最大值。
## 输入格式

第一行包含一个正整数 T，表示测试数据的组数。

对于每组测试数据，第一行是一个整数 $n$，表示挡板个数；  
接下来 n 行，每行包含四个整数 $x1, y1, x2, y2$，表示挡板的两端点分别是 $(x1, y1)$ 和 $(x2, y2)$，保证$(x1, y1){=}\mathllap{/\,}(x2, y2)$。  
第 $n + 2$ 行是五个整数 $x1, y1, x2, y2, L$，表示直线导轨经过了点 $(x1, y1)$ 和 $(x2, y2)$，且激光发射器的长度为 $L$，同样保证 $(x1, y1)\mathrlap{\,/}{=}(x2, y2)$。
## 输出格式

对于每组测试数据，输出一行，包含一个实数，表示激光束能照射到的挡板长度之和的最大值，要求相对误差不超过 $10^{-6}$，也就是说，令输出结果为 $a$，标准答案为 $b$，若满足 $\dfrac{|a-b|}{max(1,b)}$ $≤$ $10^{-6}$，则输出结果会被认为是正确答案。
## 样例

### 样例输入 #1
```
3
4
-3 2 -1 2
-1 -1 1 -1
0 1 2 1
2 -2 4 -2
0 0 1 0 2
4
1 1 3 3
2 1 4 2
3 1 5 1
3 -1 4 -1
0 0 -1 0 2
4
-2 0 1 2
1 3 -3 2
1 -3 5 -1
2 -1 4 3
0 0 1 1 2

```
### 样例输出 #1
```
3.000000000000000
3.118033988749895
4.251303782246768

```
## 提示

- $T ≤ 100$
- $1 ≤ n ≤ 10^4$，
- $1 ≤ L ≤ 2 × 10^9$，
- 所有坐标的绝对值不超过 $10^9$。

## SubTasks

- 子任务 1 (40 分)：满足 $1 ≤ n ≤ 100$ 且所有坐标的绝对值不超过 $10^4$。
- 子任务 2 (40 分)：所有坐标的绝对值不超过 $10^6$。
- 子任务 3 (20 分)：没有任何附加的限制。



---

---
title: "Sone1"
layout: "post"
diff: NOI/NOI+/CTSC
pid: P5649
tag: ['平衡树', '动态树 LCT']
---
# Sone1
## 题目描述

给你一棵 $n$ 个节点的有根树，点带权，有 $q$ 次操作，分为十二种：  

- `0 x y` 表示将 $x$ 的子树中所有点权都改为 $y$；  
- `1 x` 表示把树根换为 $x$ 节点；  
- `2 x y z` 表示把 $x$ 到 $y$ 简单路径上所有点权改为 $z$；  
- `3 x` 表示询问 $x$ 的子树中最小权值；   
- `4 x` 表示询问 $x$ 的子树中最大权值；   
- `5 x y` 表示将 $x$ 的子树中所有点权都增加 $y$；  
- `6 x y z` 表示将  $x$ 到 $y$ 简单路径上所有点权加上 $z$；  
- `7 x y` 表示询问 $x$ 到 $y$ 简单路径上的最小权值；   
- `8 x y` 表示询问 $x$ 到 $y$ 简单路径上的最大权值；  
- `9 x y` 表示把 $x$ 的父亲换为 $y$，若 $y$ 在 $x$ 的子树里则忽略此操作；  
- `10 x y` 表示询问 $x$ 到 $y$ 简单路径上的点权和；  
- `11 x` 表示询问 $x$ 的子树中点权和。    
## 输入格式

第一行两个正整数 $n,q$，表示节点数与操作数。  
接下来 $n-1$ 行，每行两个正整数 $u,v$，表示 $u$ 和 $v$ 之间有一条边。  
然后 $n$ 行，每行一个整数表示点权。  
后面一行一个正整数表示初始的根。  
最后 $q$ 行，每行若干个正整数，表示一次操作。
## 输出格式

对于每个 $3,4,7,8,10,11$ 操作，输出一行一个整数表示答案。
## 样例

### 样例输入 #1
```
5 5
2 1
3 1
4 1
5 2
4
1
4
1
2
1
10 2 3
3 1
7 3 4
6 3 3 2
9 5 1
```
### 样例输出 #1
```
9
1
1
```
### 样例输入 #2
```
10 12
2 1
3 2
4 2
5 3
6 4
7 5
8 2
9 4
10 9
791
868
505
658
860
623
393
717
410
173
4
0 8 800
1 4
2 8 2 103
3 9
4 4
5 7 304
6 8 8 410
7 10 8
8 1 8
9 6 9
10 2 3
11 5
```
### 样例输出 #2
```
173
860
103
791
608
1557
```
## 提示

来源：BZOJ 3153

【数据范围】  

对于 $100\%$ 的数据，$1\le n,m \le 10^5$，中间计算的所有值在 $[-2^{31},2^{31})$ 范围内。   
由于本题过于难写，可以点击 [这里](https://darkbzoj.cc/data/3153.zip) 下载测试数据，本地通过后再提交。


---

---
title: "晚秋绝诗"
layout: "post"
diff: NOI/NOI+/CTSC
pid: P7110
tag: ['平衡树', '洛谷原创', 'O2优化', '洛谷月赛']
---
# 晚秋绝诗
## 题目描述

在晚秋时分观赏 L 国举世闻名的佳景——藏雾山，无不是一件惬意之事。

藏雾山共有 $n$ 座山峰，从 $1$ 到 $n$ 编号。起初，$n$ 座山峰的山顶均被秋雾遮盖，因而无法辨别其高度。

同时，称第 $i$ 座山峰为**间峰**，当且仅当其高度恰好是第 $i-1$ 座与第 $i + 1$ 座高度的平均值（特别地，第 $1$ 座与第 $n$ 座**不算**间峰）。藏雾山一带向来会在**部分间峰**的山底悬挂旗帜，起初所有山峰的山底均无旗帜。

现有 $m$ 天，每天会发生以下之一的事件：

- 雾去/雾回：第 $x$ 座山峰山顶的秋雾散去，或重新聚集。
- 旗升/旗落：第 $x$ 座山峰山底的旗帜挂起，或被人卸下。
- 来客：一位登山爱好者造访藏雾山欲攀登第 $x$ 座山峰，他希望能当天知晓该山峰的海拔高度。

登山爱好者们将以两种方式知晓：直接观测出**未被秋雾遮盖**山峰的海拔高度，或是利用当天各山底旗帜给出的间峰信息，**尽可能地推算出其余**山峰的高度。除此之外，他们无法使用其他方式，包括但不限于与过往的来客交流分享信息等。

你能求出每位登山爱好者能否知晓目标山峰的高度吗？
## 输入格式

第一行包含两个正整数 $n$ 和 $m$，分别为藏雾山的山峰个数和事件持续的天数。

接下来 $m$ 行，每行包含两个正整数 $op, x$，其中 $op \in \{1,2,3\}$，具体地：

- 对于 $op=1$，保证 $1 \le x \le n$，表示若第 $x$ 座山峰的山顶有雾，则变为无雾状态；若第 $x$ 座山峰的山顶无雾，则变为有雾状态。
- 对于 $op=2$，保证 $2 \le x < n$，表示若第 $x$ 座山峰的山底无旗，则变为有旗状态；若第 $x$ 座山峰的山底有旗，则变为无旗状态。
- 对于 $op=3$，保证 $1 \le x \le n$，表示一位欲攀登第 $x$ 座山峰的登山爱好者造访。
## 输出格式

输出若干行，每行一个布尔值依次表示每位登山爱好者能否知晓高度，$1$ 则能，$0$ 则不能。
## 样例

### 样例输入 #1
```
3 5
1 1
1 3
3 2
2 2
3 2
```
### 样例输出 #1
```
0
1

```
### 样例输入 #2
```
5 6
1 1
1 3
2 2
2 3
2 4
3 5
```
### 样例输出 #2
```
1
```
## 提示

**【样例解释 #1】**

在没有任何间峰信息的情况下，第一个登山爱好者不可能知晓被秋雾遮盖山峰的高度。

第二个登山爱好者造访时已知山峰 $1$ 的高度、山峰 $3$ 的高度以及山峰 $2$ 为间峰，因此山峰 $2$ 的高度能通过平均值计算得到。

----

**【数据规模与约定】**

**本题采用捆绑测试**。你必须通过 Subtask 中所有的测试点才能获得该 Subtask 的分数。

- Subtask #1 (7 points)：$n \le 5$，$m \le 10$。
- Subtask #2 (13 points)：$n,m \le 100$。
- Subtask #3 (15 points)：$n,m \le 2000$。
- Subtask #4 (20 points)：$n,m \le 10^5$。
- Subtask #5 (20 points)：所有 $op = 1$ 事件在所有 $op = 2$ 事件后。
- Subtask #6 (25 points)：无特殊限制。

对于所有的数据，保证 $3 \le n \le 5 \cdot 10^5$，$1 \le m \le 5 \cdot 10^5$。


---

---
title: "[JOISC 2020] 掃除"
layout: "post"
diff: NOI/NOI+/CTSC
pid: P7220
tag: ['2020', '线段树', '平衡树', 'JOI（日本）', '线段树分治']
---
# [JOISC 2020] 掃除
## 题目背景

JOISC2020 Day 1 T3

由于数据点较多，本题只评测其中的部分数据。

希望获得完整数据的可以到[这里](https://www.ioi-jp.org/camp/2020/2020-sp-tasks/day1/sweeping-data.zip)自行下载。
## 题目描述

由于 Bitaro AK 了 IOI，所以 IOI 主办方送了他一套房子，为一个边长为 $N$ 的等腰直角三角形。房间内一点用坐标 $(x,y)$ 表示，其中 $0\leq x+y\leq N$。直角顶点为原点，三角形两腰分别为 $x$ 轴与 $y$ 轴。

![](https://cdn.luogu.com.cn/upload/image_hosting/3m2wdn4u.png)

一天，Bitaro 发现自己已经 AK 了 1919810 届 IOI 闲的没事做准备打扫房间里的灰尘。这些灰尘一开始一共有 $M$ 堆，其中第 $i$ 堆位于 $(X_i,Y_i)$。同时，可能存在多堆灰尘位于同一个位置上的情况。

现在 Bitaro 准备用扫帚打扫房间。我们认为扫帚是放置在房间里的一条线段，并且将这条线段的长度称为扫帚的宽度。由于 Bitaro 很有条理，所以他只会用以下的两种方式打扫房间：

- Bitaro 将扫帚平行于 $y$ 轴放置，一端位于原点。然后他会垂直向右移动扫帚，直到不能移动为止。如果扫帚的宽度为 $l$，那么原来一堆满足 $x<N-l,y\leq l$ 的灰尘 $(x,y)$ 将会被移动到 $(N-l,y)$。（这个位置可能会存在多堆灰尘）我们称这个过程为过程 H。

- Bitaro 将扫帚平行于 $x$ 轴放置，一端位于原点。然后他会水平向上移动扫帚，直到不能移动为止。如果扫帚的宽度为 $l$，那么原来一堆满足 $x\leq l,y<N-l$ 的灰尘 $(x,y)$ 将会被移动到 $(x,N-l)$。（这个位置可能会存在多堆灰尘）我们称这个过程为过程 V。

在 Bitaro 的房间里，依次会发生 $Q$ 个事件。第 $i$ 个事件形如以下 $4$ 种：

- Bitaro 想要计算第 $P_i$ 堆灰尘的位置坐标；

- Bitaro 使用宽度为 $L_i$ 的扫帚，进行了过程 H；

- Bitaro 使用宽度为 $L_i$ 的扫帚，进行了过程 V；

- 有一堆新的灰尘出现在点 $(A_i,B_i)$ 处。如果在这个事件之前一共有 $c$ 堆灰尘，那么这堆灰尘就是房间中的第 $c+1$ 堆灰尘。

由于 Bitaro 已经 AK 了 IOI，啥都不想干，所以你需要写一个程序，给出房间的腰长，每一堆灰尘的位置坐标和每个事件的细节，求出要求的某堆灰尘的位置坐标。
## 输入格式

第一行三个整数，分别为 $N,M,Q$。

接下来 $m$ 行，每行两个整数 $X_i,Y_i$，表示第 $i$ 堆灰尘一开始的位置。

接下来 $Q$ 行，每行两到三个整数，表示一个事件。设 $T_i$ 为第一个整数，每行含义如下：

- 如果 $T_i=1$，则这行有两个整数 $T_i,P_i$，表示 Bitaro 要计算第 $P_i$ 堆灰尘的坐标；

- 如果 $T_i=2$，则这行有两个整数 $T_i,L_i$，表示 Bitaro 用宽度为 $L_i$ 的扫帚进行了过程 H；

- 如果 $T_i=3$，则这行有两个整数 $T_i,L_i$，表示 Bitaro 用宽度为 $L_i$ 的扫帚进行了过程 V；

- 如果 $T_i=4$，则这行有三个整数 $T_i,A_i,B_i$，表示一堆新的灰尘出现在 $(A_i,B_i)$ 位置。
## 输出格式

对于每个 $T_i=1$ 的事件，输出一行两个整数，表示事件 $i$ 发生时第 $P_i$ 堆灰尘的位置坐标。
## 样例

### 样例输入 #1
```
6 2 10
1 1
4 0
4 2 3
3 3
1 1
4 1 2
2 3
2 0
1 4
3 2
1 3
1 2
```
### 样例输出 #1
```
1 3
3 2
3 3
6 0
```
### 样例输入 #2
```
9 4 8
2 3
3 1
1 6
4 3
2 6
1 3
2 2
1 4
2 3
1 2
2 4
1 1
```
### 样例输出 #2
```
3 6
4 3
7 1
6 3
```
### 样例输入 #3
```
8 1 8
1 5
4 4 1
2 6
1 2
2 3
4 2 2
2 5
1 1
1 3
```
### 样例输出 #3
```
4 1
3 5
3 2
```
### 样例输入 #4
```
7 4 9
1 5
2 2
4 2
5 0
2 6
2 3
1 2
3 6
1 4
3 1
1 1
2 2
1 3
```
### 样例输出 #4
```
4 2
5 1
1 6
5 2
```
### 样例输入 #5
```
20 5 25
10 6
0 4
2 1
1 0
2 3
2 18
3 9
4 1 5
4 0 2
3 10
4 3 3
3 3
2 9
4 9 1
3 12
1 4
3 19
1 3
1 9
2 1
1 7
1 6
4 3 3
1 10
1 1
1 5
2 0
1 2
2 2
1 7
```
### 样例输出 #5
```
2 17
2 17
9 8
0 17
1 17
3 3
10 10
2 17
2 17
0 17
```
## 提示

### 样例 1 解释

一开始第一堆灰尘位于 $(1,1)$，第二堆灰尘位于 $(4,0)$。图一描述了房间现在的情况。

![](https://cdn.luogu.com.cn/upload/image_hosting/8e305ll6.png)

在第一个事件中，添加了 $(2,3)$ 位置上的第三堆灰尘。图二描述了房间现在的情况。

![](https://cdn.luogu.com.cn/upload/image_hosting/wili6lmg.png)

在第二个事件中，Bitaro 用宽度为 $3$ 的扫帚进行了过程 V。之后，第一堆灰尘移动到了 $(1,3)$，图三描述了房间现在的情况。

![](https://cdn.luogu.com.cn/upload/image_hosting/x5x5nsvb.png)

在第三个事件中，Bitaro 计算了第一堆灰尘的坐标 $(1,3)$。

在第四个事件中，添加 $(1,2)$ 位置上的第四堆灰尘。图四描述了房间现在的情况。

![](https://cdn.luogu.com.cn/upload/image_hosting/sxqf521x.png)

在第五个事件中，Bitaro 用宽度为 $3$ 的扫帚进行了过程 H，第一堆灰尘移到了 $(3,3)$，第三堆灰尘移到了 $(3,3)$，第四堆灰尘移到了 $(3,2)$。图五描述了房间现在的情况。

![](https://cdn.luogu.com.cn/upload/image_hosting/0lt0inff.png)

在第六个事件中，Bitaro 用宽度为 $0$ 的扫帚进行了过程 H，第二堆灰尘移到了 $(6,0)$。图六描述了房间现在的情况。

![](https://cdn.luogu.com.cn/upload/image_hosting/wnv1lqz7.png)

在第七个事件中，Bitaro 计算了第四堆灰尘的坐标 $(3,2)$。

在第八个事件中，Bitaro 用宽度为 $2$ 的扫帚进行了过程 V，然而什么都没有发生。图七描述了房间现在的情况。

![](https://cdn.luogu.com.cn/upload/image_hosting/s4rebol9.png)

在第九个事件中，Bitaro 计算了第三堆灰尘的坐标 $(3,3)$。

在第十个事件中，Bitaro 计算了第二堆灰尘的坐标 $(6,0)$。

这组样例满足子任务 1 和子任务 5 的限制。

#### 样例 2~5 解释

第二组样例满足子任务 1,2,4,5 的限制。

第三组样例满足子任务 1,2,5 的限制。

第四组样例满足子任务 1,3,4,5 的限制。

第五组样例满足子任务 1,5 的限制。

#### 子任务

| 子任务编号 | 特殊性质 | 分值 |
| :----------: | :----------: | :----------: |
| Subtask 1 | $m\leq 2\times 10^3,Q\leq 5\times 10^3$ | $1$ |
| Subtask 2 | $T\in\{1,2,4\}$ | $10$ |
| Subtask 3 | $T\in\{1,2,3\},X_i\leq X_{i+1},Y_i\geq Y_{i+1}(1\leq i\leq m-1)$ | $11$ |
| Subtask 4 | $T\in\{1,2,3\}$ | $53$ |
| Subtask 5 | 无 | $25$ | 

对于 $100\%$ 的数据，$1\leq n\leq 10^9,1\leq m\leq 5\times 10^5,1\leq Q\leq 10^6$。保证：

- $0\leq X_i,Y_i\leq N,X_i+Y_i\leq N(1\leq i\leq m)$；

- $1\leq P_i\leq M^\prime(1\leq i\leq Q)$，其中 $M^\prime$ 表示事件 $i$ 发生时灰尘的堆数；

- $0\leq L_i\leq n-1(1\leq i\leq Q)$；

- $0\leq A_i,B_i\leq n,A_i+B_i\leq n(1\leq i\leq Q)$；

- 至少存在一个 $T_i=1$ 的事件。



---

---
title: "[NOI2021] 密码箱"
layout: "post"
diff: NOI/NOI+/CTSC
pid: P7739
tag: ['平衡树', '2021', 'NOI', 'O2优化', '矩阵乘法']
---
# [NOI2021] 密码箱
## 题目描述

Yelekastee 是 U 国著名的考古学家。在最近的一次考古行动中，他发掘出了一个远古时期的密码箱。经过周密而严谨的考证，Yelekastee 得知密码箱的密码和某一个数列 $\{ a_n \}$ 相关。数列 $\{ a_n \}$ 可以用如下方式构造出来：

1. 初始时数列长度为 $2$ 且有 $a_0 = 0, a_1 = 1$；
2. 对数列依次进行若干次操作，其中每次操作是以下两种类型之一：
  - `W` 类型：给数列的**最后一项**加 $1$。
  - `E` 类型：若数列的**最后一项**为 $1$，则给倒数第二项加 $1$；否则先给数列的**最后一项**减 $1$，接着在数列尾再加两项，两项的值都是 $1$。

受到技术限制，密码箱并没有办法完整检查整个数列，因此密码箱的密码设定为数列 $\{ a_n \}$ 经过函数 $f$ 作用后的值，其中 $f$ 的定义如下：

$$ f(a_0, \ldots , a_{k - 1}, a_k) = \begin{cases} a_0, & k = 0 \\ f \! \left( a_0, a_1, \ldots , a_{k - 2}, a_{k - 1} + \frac{1}{a_k} \right) \! , & k \ge 1 \end{cases} $$

Yelekastee 并不擅长运算，因此他找到了你，希望你能根据他提供的操作序列计算出密码箱的密码。不幸的是，他的记性并不是很好，因此他会随时对提供的操作序列做出一些修改，这些修改包括以下三种：

- `APPEND c`，在现有操作序列后追加一次 `c` 类型操作，其中 `c` 为字符 `W` 或 `E`。
- `FLIP l r`，反转现有操作序列中第 $l$ 个至第 $r$ 个（下标从 $1$ 开始，修改包含端点 $l$ 和 $r$，下同）操作，即所有 `W` 变为 `E`，所有 `E` 变为 `W`。
- `REVERSE l r`，翻转现有操作序列中第 $l$ 个至第 $r$ 个操作，也就是将这个区间中的操作逆序。
## 输入格式

输入第一行包含两个正整数 $n, q$，分别表示初始的操作序列长度和修改的次数。

第二行包含一个长为 $n$ 且仅包含大写字母 `W` 和 `E` 的字符串，表示初始操作序列。

接下来 $q$ 行，每行表示一次修改。每种修改的格式如【题目描述】所述。
## 输出格式

输出共 $q + 1$ 行，每行两个整数，其中第一行表示初始操作序列对应的密码，接下来 $q$ 行则分别输出每次修改之后的操作序列对应的密码。

容易发现密码一定是正有理数。若真实的密码为 $\frac{a}{b}$，其中 $a, b > 0$ 且 $\gcd(a, b) = 1$，则你需要在对应的行内顺次输出 $a$ 和 $b$ 模 $998244353$ 后的余数。
## 样例

### 样例输入 #1
```
2 3
WE
APPEND E
FLIP 1 2
REVERSE 2 3

```
### 样例输出 #1
```
2 3
3 4
5 3
5 2

```
## 提示

**【样例解释 #1】**

| | 操作序列 | 数列 $\{ a_n \}$ | 密码 |
|:-:|:-:|:-:|:-:|
| 初始 | `WE` | $(0, 1, 1, 1)$ | $\frac{2}{3}$ |
| 第一次修改后 | `WEE` | $(0, 1, 2, 1)$ | $\frac{3}{4}$ |
| 第二次修改后 | `EWE` | $(1, 1, 1, 1)$ | $\frac{5}{3}$ |
| 第三次修改后 | `EEW` | $(2, 2)$ | $\frac{5}{2}$ |

**【样例 #2】**

见附件 `code/code2.in` 与 `code/code2.ans`。

该样例与测试数据 $1 \sim 4$ 满足同样的约束条件。

**【样例 #3】**

见附件 `code/code3.in` 与 `code/code3.ans`。

该样例与测试数据 $5 \sim 7$ 满足同样的约束条件。

**【样例 #4】**

见附件 `code/code4.in` 与 `code/code4.ans`。

该样例与测试数据 $8 \sim 10$ 满足同样的约束条件。

**【样例 #5】**

见附件 `code/code5.in` 与 `code/code5.ans`。

该样例与测试数据 $15 \sim 20$ 满足同样的约束条件。

**【数据范围】**

对于所有测试点：$1 \le n \le {10}^5$，$1 \le q \le {10}^5$。

对于 `APPEND` 修改，保证给出的 `c` 为大写英文字母 `W` 或 `E`。

对于 `FLIP` 和 `REVERSE` 修改，保证 $1 \le l \le r \le L$，其中 $L$ 是当前操作序列的长度。

请注意由于有 `APPEND` 操作，操作序列的长度最大可能有 $2 \times {10}^5$。

| 测试点编号 | $n, q \le$ | 特殊限制 |
|:-:|:-:|:-:|
| $1 \sim 4$ | $2000$ | 无 |
| $5 \sim 7$ | ${10}^5$ | A |
| $8 \sim 10$ | ${10}^5$ | B，C |
| $11 \sim 14$ | ${10}^5$ | C |
| $15 \sim 20$ | ${10}^5$ | 无 |

特殊限制 A：保证在任意时刻操作序列中不会出现连续相同的两个字符。

特殊限制 B：保证没有 `FLIP` 修改。

特殊限制 C：保证没有 `REVERSE` 修改。


---

---
title: "[集训队互测 2018] 蜀道难"
layout: "post"
diff: NOI/NOI+/CTSC
pid: P9250
tag: ['贪心', '2018', '平衡树', '集训队互测', '树链剖分', '动态树 LCT']
---
# [集训队互测 2018] 蜀道难
## 题目描述

「蜀道之难，难于上青天……」

一边背着新学的语文课文，A 与 B 走出北校门口。现在距离七点的放学时间已过很久，与十点四十五分晚自习后的人潮却还有些距离，巷里的行人稀稀落落的。

「明天早上就考试了呀。」A 小声而僵硬地说道。

「嗯……背这样的课文，还真有种文人墨客的潇洒豪气。」B 回应着。

「嗨，得了，我们学了什么『文』么？天天坐机房敲代码刷题，触景生情时也就靠语文课学的两三句诗过活了。」

「人艰不拆……你说，三千年前的古蜀国人真要凭『天梯石栈相勾连』往来吗？」

「人家住在四川盆地、天府之土好吗。住山里的，那是苗蛮，部落山野之人，怎么会天天翻山越岭走栈道呢？栈道那是几百年后，秦国经略蜀地才大规模修筑的。」

「那这前边的人，就跟黄土高原一样，说话靠吼么。」

「兴许他们是鸡犬之声相闻，老死不相往来，根本不用如此交流吧。」

「比起如此，我到更希望他们真有『地崩山摧壮士死』的英雄。」

「几千年前的事，谁又说得准呐。」

「不能这么说……我宁愿相信信息是守恒的，历史的一切都会留下痕迹。」

「那您考古嘞。」

「可你知道混沌吧。」

一时语塞的 A 带着两人在那棵槐树下停止了脚步。

突然他字正腔圆，有板有眼地念着：

「上有六龙回日之高标——下有冲波逆折之回川。黄鹤之飞——尚不得过，猿猱欲度，愁攀援。」

「青泥何盘盘，百步九折萦岩峦。扪参历井仰胁息，以手抚膺坐长叹。」正望着树干出神的 B 也轻声应和。

然后，一如往日，那名女孩也从树干背后现身了，仍是一袭白衣，头戴花冠，浅笑嫣然，缄口不言。A 仍是微微低头把玩衣角，B 也照常微笑。

她抚摸着他们的头，A 和 B 也没有再拨打 110 报警。倏忽间闪过恍惚。

面对眼前的高峰幽谷、连山绝壑，A 不禁想起了初中所学郦道元的「重岩叠嶂，隐天蔽日，自非亭午夜分，不见曦月。」刚刚讽刺 B 的，书到用时方恨少的发言，反而沁入自己的心脾了。远处的水滨石室隐约可见，似有人烟；山顶处则现出房屋的剪影。

突然手被 B 握住。陶醉在猿啼鸟鸣中的 A 这才惊觉，自己身处 LCR 带来的梦境。

「这好像是我们刚刚所讨论《蜀道难》的内容啊。」

A 也想到了，但他并未看到栈道的影子，看来这是比秦王更早的「苗蛮」了。

「那我们实际观察一下刚刚的问题吧。没有栈道的人如何交流。」

最直接的方法，当属攀藤附葛，翻山越岭而至，这也是靠山吃山的先民们固有的技能——但技艺的熟练并不能抵消山中蛇虫和失足的危险。如此传递信息，未免得不偿失。B 相信存在更专业的手段。

山谷渐渐明亮起来，眼尖的 A 注意到树木遮掩的山壁有些不寻常。二人攀援而至，多亏是梦境，他们并未费力。原来，山间绵延着一根被劈开的，用细小竹片固定的，宽约尺余的竹筒。泉水从中流过，大概是山民们引水的设施。

「不对啊。山下的人有峪中河水可取。何况要输送水流，应该用完整而不是劈开的管道才对。」

接着，一支系绳的小竹筒从他们面前流着泉水的槽中滑过。

「这是……」

「是了！这小筒是山上山下交流少量物品——包括信息载体——的工具。流水是为了清除淤尘。劈开而非封闭的竹筒也是为了防止卡住。」

「可是，小筒不是很容易从仅仅一半的槽中滑落吗？」

「仔细观察，小筒是两节的结构，这样就能在存贮信息的时候接受水。泉水同样起了引流的作用。并且上面的绳子也能回收——这意味着交流是双向的，尽管发起者总在高处，但只需等待便可解决相反方向的问题。」

「大概如此，不过这是 LCR 带来的世界，不知我们的先辈是否真的在秦巴山区中如此做过。」

「若有一泓稳定的清泉，这应该可行。」

「这样的创意，」B 说，「表明先民们懂得技术胜过科学。」

接着他突然沉默了。「真的是这样吗？」

接着二人飘飞了起来——提醒着他们身处梦境的现实。

A 注意到，在这座山附近，这样流水传物的「信道」有许多，它们构成了一张树状的大网。

「他们不仅发明了这样的方法，还做了符合科学原理的，充满智慧的规划。」

「瞧瞧吧。他们用最少段数的路线连接了所有的聚落，他们的所有聚落的高度排序后恰好等差，他们的任意两个聚落之间只需经不超过一个聚落的转达即可互相通信，他们的管道高差最为节省。」

不知是谁在说呢。

……

A 思考了一会，说道：

「也就是说，尽管聚落的位置受自然条件限制是无法转移的，但他们在管道连接方案上做出了最明智的选择。」

B 答道：

「是啊。刚刚 LCR 的意思，以我们学的 OI 来描述大概是这样的：管道可以看作两个聚落之间的边。

1. 它们以最小代价联通聚落，即构成一棵树；
2. 同一个聚落处的管道是互联的且有人管理，也即两个聚落只要满足其间的管道的高度方向是单调的——聚落高度一直递增或一直递减——就可以直接通信。
3. 任意两个聚落通信至多需要转发一次；
4. 所有聚落的高度排序后恰是等差数列；
5. 管道的代价正比与两端聚落的高差，而高差形成的代价和恰巧是所有聚落高度排列方式中最小的；」

「但聚落的高度并不是人决定的。」

「所以，这一点是数学的美，是大自然的巧合和人的智慧共同的结晶。没有什么比这更浪漫了。」

「很好……但如果新加入一个聚落的话，事情就被破坏了。」

「幸运的是，这是梦境世界。我们也许可以做做救世主，改变一下聚落的高度。」

「那该怎么做呢？」

**「首先是抽象。我们把聚落看成一棵 $n$ 个点的树，树的点被标号为 $1$ 到 $n$，一条边的边权为两端点标号的差的绝对值。整棵树的权值为所有边权和。另外树必须满足一个条件：任意两点，要么它们之间（包括端点）的路径的标号是单调（递增或递减）的，要么存在第三点分别与这两点满足此条件。**

**那么我们的任务是对于给定形态的树求出，在这些前提下通过改变点标号方法能得到的整棵树最小的权值。**

**并且，还需要在加入新的叶子后维护这一点。」**

……

十一点钟声即将敲响，学生们陆续经过那棵槐树。没有人能注意到，两小时前两名同学在树下酣眠的梦游。

请你完成 B 的设想。

---

#### 题意

对于一棵有标号有根树 $T=(V,E)$，标号 $p:v\rightarrow p(v),v\in V,p(v)\in [1,|V|]\cap \mathbb{Z}$ 是一个一一映射。令一条边 $e = (u,v),e\in E$ 的边权为：$w:e\rightarrow w(e) = \lvert p(u)-p(v) \rvert,e\in E,w(e)\in \mathbb{Z}$。令整棵树的权为：$W:T=(V,E)\rightarrow W(T)=\sum_{e\in E}w(e)$。

另外定义一个图 $G(T)=(V,E')$，其中 $(u,v)\in E'$ 当且仅当在 $T$ 中 $u$ 到 $v$ 路径上点的标号 $p_1,p_2,\cdots , p_l$，要么单调递增，要么单调递减。则 $p$ 必须使得 $G(T)$ 的直径不超过 $2$，即 $\mathop{\max}_{i,j\in V}SP(i,j)\le 2$，其中 $SP(i,j)$ 表示 $G(T)$ 中 $i,j$ 的最短路经过的边数。

现在给定 $T$，求 $M(T)=\mathop{\min}_{p}W(T)$。

并且有若干次操作：在 $T$ 中加入一个新的叶子 $v$（$V\gets V\cup \{v\}$，$E\gets E\cup \{(x,v)\}$，$x\in V_{old}$），每次操作后也要求 $M(T)$。这些操作是一脉相承的。

## 输入格式

第一行一个正整数 $n$ 表示初始的 $\lvert V\rvert$，这些点在接下来的格式中将以 $1$ 到 $n$ 的整数表示，请不要将其与待定的标号 $p$ 混淆；  
接下来 $n-1$ 行中，第 $i$ 行两个正整数 $u_i,v_i$，表示初始的 $E=\{(u_i,v_i):i=1,2,\dots ,n-1\}$，保证 $u_i < v_i = i+1$；  
接下来一行一个非负整数 $q$ 表示修改次数；  
接下来 $q$ 行中，第 $i$ 行一个正整数 $f_i$，表示添加一个点（用 $n+i$ 表示）和一条新边 $(f_i,n+i)$。
## 输出格式

共 $q+1$ 行，每行一个非负整数，依次表示初始和每次修改之后的 $M(T)$。

## 样例

### 样例输入 #1
```
1
2
1
1
```
### 样例输出 #1
```
0
1
2
```
### 样例输入 #2
```
5
1 2
2 3
3 4
4 5
5
4
6
1
1
7
```
### 样例输出 #2
```
4
6
7
8
10
11
```
### 样例输入 #3
```
14
1 2
1 3
2 4
1 5
2 6
1 7
1 8
2 9
2 10
2 11
2 12
2 13
1 14
12
1
1
2
2
2
2
2
2
2
2
1
2
```
### 样例输出 #3
```
35
41
48
53
58
64
70
77
84
92
100
108
117
```
## 提示

### 样例解释 $\mathbf{1}$

这棵树每次都是一条链（`1`、`1-2`、`3-1-2`），令 $p(i)$ 等于 $i$ 到链输入时间较晚的一端的点数即可。

### 数据范围

对于所有数据，$1\le n\le 10^5$，$0\le q\le 10^5$，$1\le n+q\le 10^5$。

每个子任务详细的数据限制及约定如下（留空表示和上述所有数据的约定相同）：

|子任务编号|分数|$n$|$q$|性质|
|:-:|:-:|:-:|:-:|:-:|
|$1$|$5$|$\le 10$|$\le 10$|-|
|$2$|$10$|$\le 18$|$\le 18$|-|
|$3$|$10$|$\le 100$|$=0$|-|
|$4$|$10$|$\le 2000$|$=0$|-|
|$5$|$10$| |$=0$|-|
|$6$|$10$| | |一|
|$7$|$10$| | |二|
|$8$|$15$| | |三|
|$9$|$20$| | |-|

性质一：$\forall i,u_i,f_i\le 2$。

性质二：$\forall i,u_i,f_i\le 20$。

性质三：$\forall i,u_i$ 在 $1,2, \dots ,i-1$ 中均匀随机；$\forall i,f_i$ 在 $1,2, \dots ,n+i-1$ 中均匀随机。

**注：本题 Subtask #10 为 $\mathbf{0}$ 分的 hack 数据，不计入总分，但如果错误则不予通过。**


---

---
title: "[POI 2020/2021 R3] Surowa zima"
layout: "post"
diff: NOI/NOI+/CTSC
pid: P9404
tag: ['模拟', '贪心', '2020', '平衡树', 'POI（波兰）', '构造', '分类讨论']
---
# [POI 2020/2021 R3] Surowa zima
## 题目背景

译自 [XXVIII Olimpiada Informatyczna - III etap](https://sio2.mimuw.edu.pl/c/oi28-3/dashboard/) [Surowa zima](https://szkopul.edu.pl/problemset/problem/QCCQf92wAoWAOoJ3tHoypvp3/statement/)。

d1t3。
## 题目描述

有一条长 $l$ 米的道路（数轴）。路上有 $n$ 个充电站。每天整条路上（坐标 $[0,l]$）都会落满雪。

有一台机器能扫雪。充一次电可以扫至多 $k$ 米的雪。扫雪是和移动同时进行的，详见样例解释。机器一秒能移动一米，充电不消耗时间。

简单来说，**移动不扫雪不消耗电，需要一秒；移动并扫雪消耗最大电量的 $\bold{\frac1k}$，需要一秒；扫雪必须移动。**

给出每天机器的初始位置，机器初始没电，问每天清除所有雪的最少时间。终点任意。

带修，即充电站可能损坏或修好（第一天之前都是好的），但保证每天都至少有一个好的充电站（所以不会无解）。
## 输入格式

第一行四个整数 $n,l,k,d$。

第二行 $n$ 个整数 $x_1,x_2,\dots,x_n$，表示充电站的位置，保证 $0\leq x_1<x_2<\dots<x_n\leq l$。

接下来 $3d$ 行，描述 $d$ 天的事件：

- 第一行三个整数 $z,u,p$，分别表示昨晚修好的充电站数量，损坏的数量，和机器的初始位置。
- 第二行 $z$ 个整数，表示被修好的充电站编号。
- 第三行 $u$ 个整数，表示损坏的充电站编号。
## 输出格式

$d$ 行，每行一个整数，表示每天的答案。
## 样例

### 样例输入 #1
```
3 5 2 1
2 3 5
0 1 3

2

```
### 样例输出 #1
```
9

```
### 样例输入 #2
```
5 12 1 5
1 3 6 9 11
0 1 1

1
1 1 3
1
2
1 1 6
2
3
1 1 9
3
4
1 1 11
4
5

```
### 样例输出 #2
```
33
33
36
33
33

```
### 样例输入 #3
```
11 100 1 26
0 10 20 30 40 50 60 70 80 90 100
0 5 0

2 4 6 8 10
5 6 4
2 4 6 8 10
1 3 5 7 9 11
6 5 8
1 3 5 7 9 11
2 4 6 8 10
5 6 12
2 4 6 8 10
1 3 5 7 9 11
6 5 16
1 3 5 7 9 11
2 4 6 8 10
5 6 20
2 4 6 8 10
1 3 5 7 9 11
6 5 24
1 3 5 7 9 11
2 4 6 8 10
5 6 28
2 4 6 8 10
1 3 5 7 9 11
6 5 32
1 3 5 7 9 11
2 4 6 8 10
5 6 36
2 4 6 8 10
1 3 5 7 9 11
6 5 40
1 3 5 7 9 11
2 4 6 8 10
5 6 44
2 4 6 8 10
1 3 5 7 9 11
6 5 48
1 3 5 7 9 11
2 4 6 8 10
5 6 52
2 4 6 8 10
1 3 5 7 9 11
6 5 56
1 3 5 7 9 11
2 4 6 8 10
5 6 60
2 4 6 8 10
1 3 5 7 9 11
6 5 64
1 3 5 7 9 11
2 4 6 8 10
5 6 68
2 4 6 8 10
1 3 5 7 9 11
6 5 72
1 3 5 7 9 11
2 4 6 8 10
5 6 76
2 4 6 8 10
1 3 5 7 9 11
6 5 80
1 3 5 7 9 11
2 4 6 8 10
5 6 84
2 4 6 8 10
1 3 5 7 9 11
6 5 88
1 3 5 7 9 11
2 4 6 8 10
5 6 92
2 4 6 8 10
1 3 5 7 9 11
6 5 96
1 3 5 7 9 11
2 4 6 8 10
5 6 100
2 4 6 8 10
1 3 5 7 9 11

```
### 样例输出 #3
```
1090
1096
1098
1092
1094
1100
1094
1092
1098
1096
1090
1096
1098
1092
1094
1100
1094
1092
1098
1096
1090
1096
1098
1092
1094
1100

```
### 样例输入 #4
```
见附件
```
### 样例输出 #4
```
见附件
```
### 样例输入 #5
```
见附件
```
### 样例输出 #5
```
1000000000000000000
2001007996000

```
## 提示

样例解释：$3\rightarrow2_{充电}\Rightarrow0\rightarrow2_{充电}\Rightarrow4\rightarrow5_{充电}\Rightarrow4$。$\rightarrow$ 表示移动，$\Rightarrow$ 表示移动并扫雪。

对于所有数据，$1\leq n\leq 250000$，$1\leq l\leq 10^9$，$1\leq k\leq l$，$1\leq d\leq 250000$，$\sum z,\sum u\leq 500000$。

| 子任务编号 | 附加限制 | 分数 |
| :----------: | :----------: | :----------: |
| 1 | $l\leq 12$，$d\leq 50$ | 10 |
| 2 | $l\leq 500$，$d\leq 50$，$k=1$ | 12 |
| 3 | $l\leq 5000000$，$d\leq 20$ | 8 |
| 4 | $z=u=0$ | 8 |
| 5 | $z,u\leq 100$，$k\leq 50$ | 20 |
| 6 | $k=1$ | 18 |
| 7 |  | 24 |



---


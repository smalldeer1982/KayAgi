---
title: "[NOISG 2022 Qualification] Tree Cutting"
layout: "post"
diff: 提高+/省选-
pid: P11294
tag: ['树形数据结构', '2022', '深度优先搜索 DFS', '树形 DP', 'NOISG（新加坡）']
---
# [NOISG 2022 Qualification] Tree Cutting
## 题目背景

一个国家有 $N$ 个城市，编号为 $1$ 到 $N$，以及 $N-1$ 条双向公路。通过这些公路，可以从任意一个城市到达另一个城市。

城市 $x$ 和城市 $y$ 之间的距离定义为连接两城市所需经过的公路数。

州长决定拆除一条公路，并新建另一条公路，使得任意两城市之间的最远距离最大化。
## 题目描述

请计算新建公路后，任意两城市之间的最大距离。
## 输入格式

- 第一行包含一个整数 $N$，表示城市的数量。
- 接下来的 $N-1$ 行，每行包含两个整数 $u$ 和 $v$，表示城市 $u$ 和 $v$ 之间有一条双向公路。
## 输出格式

输出一个整数，表示新建公路后任意两城市之间的最大距离。
## 样例

### 样例输入 #1
```
4
1 2
1 3
3 4
```
### 样例输出 #1
```
3
```
### 样例输入 #2
```
6
1 2
2 3
2 5
4 5
5 6
```
### 样例输出 #2
```
5
```
## 提示

【样例解释】

对于样例 $1$，最远距离无法增加，仍然为 $3$。  

对于样例 $2$，可以拆除公路 $2-5$，新建公路 $3-4$，最远路径为 $1-2-3-4-5-6$，其长度为 $5$。

【数据范围】

- $2 \leq N \leq 300,000$
- $1 \leq u, v \leq N$

| 子任务编号 | 分值 | 额外限制条件                             |
| :--------: | :--: | :--------------------------------------: |
| $1$        | $5$  | $N \leq 10$                              |
| $2$        | $10$ | $N \leq 100$                             |
| $3$        | $15$ | $N \leq 3000$                            |
| $4$        | $15$ | $N \leq 300,000$，至多一个城市连接至少 $3$ 条公路 |
| $5$        | $55$ | 无额外限制                              |


---

---
title: "「FAOI-R4」蒲公英的约定"
layout: "post"
diff: 提高+/省选-
pid: P11787
tag: ['模拟', '树形数据结构', '线性数据结构', '2025', '洛谷原创', 'O2优化', '洛谷月赛']
---
# 「FAOI-R4」蒲公英的约定
## 题目背景

**[背景部分或许更好的阅读体验](https://www.luogu.com.cn/article/bz5b7xlo)**

**提示：题目背景与题意并无显著关联。**

$$ 1 $$

“怎么又来了一个，还是个女生，不知道好不好看。”曹玉明还没盖上水杯，就有些迫不及待地对着自己的“小弟”戏谑道，丝毫不管台上还在说话的王老师，“还是从八班转过来的，必须好好教育一下。”

“大哥说的对，这帮实验班的不是什么好东西。”旁边的小个子男生附和着，“必须先挫掉她的锐气。”

说话间，一位穿着花白裙子的女生走了进来，一阵春风吹过还未关紧的窗户，把她的裙子掀的飘了起来，曹玉明的身边划过一丝清香，还未来得及去思索这气息的来源，只听得一声铁器撞在桌面的声音，他的腿上也感到一阵水流带来的寒意。

“你长眼睛了吗？”曹玉明扶起水杯，便大声喊着。那女生连忙弯下腰道歉。她衣兜一朵小小的蒲公英差点掉了出来，散发着一种若隐若现的馨香。他这才注意到那女生的容貌，乌黑的头发宛如瀑布一样自然地垂下来，白皙的脸上闪着明朗的春日晨曦，澄澈的眼眸犹如潭水......他还没来得及说“没事”，台上猛然传来一声王老师的河东狮吼“怎么第一天就迟到了”，那女生赶忙坐在空位上。

他还没回过神，眼神朝向那个残留着一点香气的方向，呆呆地望着。旁边一阵“咯咯”声传来，虽然细微却也惊醒了他，“笑什么笑，再给你上一课。”他抬起手，小个子男生的脸上随着一声清脆的响声多了个有些猩红的巴掌印，顿时不敢出声，曹玉明也听清楚了老师说的话，那个女生好像叫什么“张艳奇”。“好土的名字。”他嘟囔着，也没注意到小个子又要倾泻而出的笑意。

$$ 2 $$

“我服了，怎么又到这天杀的化学课了，又要看到王头那张老不死的臭脸了，还是实验课，我说白了小林你去给我说一下那个挨千刀的什么硫酸铜实验怎么做，要我被骂了第一个干的就是你！”小个子男生有些颤抖，“我也不知道啊，大哥。”他那小小的脸上又多了一个更加鲜红的巴掌印。

此时老师进来了，毕竟是对校规还有些残存的敬畏，即使是作为南城三中的一霸曹玉明也不再造次，王老师进到班里，在讲台上放了一份名单，“因为新同学的转入，大家以后分组实验的搭档可能改变，你们去看一下！”王老师把一张表格挂在黑板上，“今天金属活动性置换反应实验还是按照学号两两分组。”

曹玉明率先挤到了人群中，惊呼一声，学号表上自己前面竟然有个不认识的女生，好像叫什么“张嫣琪”，学号是“425”，而曹玉明是“426”。他在脑海里搜索了自己可怜的知识库，终于想起第二个字的读音，“原来是你啊！”他感叹于神奇的姓名机缘，也有些莫名其妙的兴奋。

实验桌前，看着试剂瓶中的蓝色溶液，还有面前的一小点铁粉，曹玉明抓耳挠腮，而张嫣琪已经熟练的用镊子夹起了铁块，放进了装了一点蓝色溶液的烧杯中。瞬时间铁粉变红，曹玉明的脸上也红了，张嫣琪拂了一下他的额头，“帅哥，别呆坐着了，实验做完了。”看着曹玉明不解的眼神，张嫣琪有一点惊讶，“硫酸铜中铜金属活动性没有铁强”，她没有一丝烦躁和嫌弃，“铁就把铜置换出来了。”

“置换”“活动性”这些词在曹玉明的脑海里宛如天书，他竟不知道怎么接上，脑海里只剩下张嫣琪的那句“帅哥”。张嫣琪见他的呆滞而有些无奈，决定先缓解一下气氛，“你不好奇我是怎么来到这里的吗？”挣扎在化学知识漩涡中的曹玉明赶忙问道，“好奇”，曹玉明急忙喊出来，掩饰自己的尴尬。他听到这世界上除了好好学习走高考和像他一样混社会，居然还可以学艺术、练体育，也能考上好大学，而在他面前的就是一位，舞蹈生，她已经拿到了一所本地高中艺术班的签约，并不想在实验班的频繁刷题中浪费时间了，就准备来到轻松一点的环境。

他有些无地自容，原先还以为面前的人是因为犯了什么事才被“发配”来这四班的，而他在这里都是居于平均以下的位置。在长久地沉默中，她好像觉察出来了什么，在他头上敲了三下。他也心领神会，“那就中午吧”，他有些小声，似是为了盖掩自己的羞愧。

$$ 3 $$

“今天还去网……”姓林的小个子男生脸上又多了一抹淡淡的红色，悻悻走开了。而 90 分钟的时间对于曹玉明来说宛如一个世纪，他终于知道了什么是反应，什么是化合，什么是置换。他用了一个自己脑海边缘的一个词，“我还任重道远啊。”而张嫣琪把衣兜里的蒲公英拿了出来，双手递给他，“这是我和你的约定。”他拿出一张纸，是南城一中的宣传报，“我相信你！”

从那以后，曹玉明的身边，那位小个子男生出现的越来越少，每个 90 分钟的午休，网吧里少了一个高大帅气的身影，四班教室的空荡又多了一分。那根蒲公英静静地水培在曹玉明的书桌前，曹玉明看着蒲公英的生长，成绩单上的排名数字却不断的变小。

2010 年 6 月 21 日，学校放了三天的假，小林和其他的帮派成员依然无所事事，反正这只是一段枷锁的开解而已；曹玉明又一次看着自己二模区排的数字，213，而目光停留在一本《2010 年南城区中考中招说明》，书上南城一中的“统招”一行赫然写着“262 人”，他又撸起袖子，翻开一本数学模拟卷，飞转的笔在前 23 个数字号码上矫若游龙，“119 分钟”，他有些沮丧，“在函数题上卡了好久啊，不过至少差不多做完了”。

$$ 4 $$

6 月 25 日，下午 14 点 40，这次的题目有些难，他这时才开始做函数题，以往都能给函数题和压轴题留上一整个小时的。他有些急切，所以飞速地读完了题目要求，“怎么这是个分数啊，第一问就来这个？”他差点叫出声，笔有些颤抖，验算了好几遍，确认这个数又浪费了好久。第二问问得有些新颖，他有些胆怯不敢下笔，没想出什么妙法后只得开始繁琐的分类讨论，草稿纸上一整面近乎满了，丝毫没有注意到考试快要结束了的他还在算着，写上四个答案区间后，他小心翼翼地又看了一遍区间有没有重叠。

“考试即将结束，收卷时请注意答题卡朝上。”“什么”他惊叫出来，“请注意考试纪律，再违反将以考试违纪处理！”他不敢再说话，看着离考试结束只剩下 2 分钟，和空白一整页的压轴大题，他早已忘记当时干了什么。他只记得，交卷时自己压轴题上第一问涂涂改改，第二问根本空白；他只记得，同学们欢呼着“这次函数题真简洁”，而好像他们口中的题目与他做的都不太像同一道；他只记得，那一晚他的书桌上是湿的，“我要考上南城一中”的白色贴纸仍然孤傲的悬挂，却有如败局已定的军队即将失守的一座堡垒……

“你真是我们的奇迹！”班级的毕业聚会在 7 月举行，“你知道你由那个混混变成了什么吗？你已经高出南城二中录取线了，你考上了一所区重点！”曹玉明低着头，一阵夏日的微风拂过，蒲公英的毛絮掉了大半，他赶忙收起衣兜，但又掉了几根毛絮。

$$ 5 $$

搬迁自然是远学的结局，曹玉明亦不例外。一根手指的长度，他在地图上一次次地算着，“五十三公里，”一声哀嚎声传来，“那就是高速开车也得一个小时，比从这里到机场都远。”他丝毫没有听到父母对一个“不良少年”考上普高——还是重点中学——的嘉许和电话里和房东的讨价声。

搬迁来得很急，甚至没来得及送走太阳辐射在这个内地小城最后的疯狂。最后一次打开这座房子的窗户，无形的波浪向着曹玉明探出窗户的身体扑来，直到额头上沁下的汗珠落在一根软绵绵的白絮上，他赶忙把手心的那串珍宝向里拉回，所剩不多的白絮还是掉了几根。

三伏的热气让把蒲公英插回花瓶里时的手抖了抖，一滴水浸到了白色的单纸，他顺着“南城二中”四个字晕开的痕迹看了下去，越看却对这张灾难的告知书越来越入迷。

还没来得及擦干手，笔触已经落到书桌前的那张贴纸，“一”下面多了一横，“前 3 名”有些突兀地写了上去。他的嘴角从那个下午开始，第一次有了一点上扬。

$$ 6 $$

“信不信我处分你啊！”南城一中里，一位穿着西服领导模样的人物，叫骂着。“我给你这次跨校交流的机会，雇大巴车跨越几十公里不是为了让你作为优秀学生代表带头旷课的！”但是他跑出了曾经梦寐以求的校门。在那个校园安保并不完善的年代，他轻而易举地拦下一辆出租车，坐了上去。

“南城机场！”他气喘吁吁。30 分钟的车程说长也不长，他想了很多。他想起，如果学校能早一天来安排这次参观，如果那个为期六年的海外培养计划能晚一天开始，如果当年自己没有看错那个正负符号，如果自己多刷一套数学题……如果硫酸铜置换实验那天有个女生没来学校，如果那个水杯没有放在桌角，如果……

航站楼里，一个穿着南城二中校服的少年看着一架飞机，丝毫不注意领带已经快要脱落了。那飞机上的白色舱体，是否有一片是那天她裙子的颜色呢？少年手里一条快要光秃秃的的蒲公英被飞机启动的气流吹过，最后几根絮毛向前方飞去，少年不再能追上它们，他停下脚步，看着絮毛随着风飞得很远很远……
## 题目描述

随着 B 市中考招生方式的多元化，中考统招的名额数量日益减少，在本题目中，你需要根据平行志愿的招生原则（我们会给出详细的解释），高效模拟这一过程。

小 $ \zeta $ 为了更好的填报志愿，找到了某年的中考志愿填报和录取的情况。

具体地，$ n $ 位学生第 $ i $ 个人会填报 $ l_i $ 个志愿，即 $l_i$ 所学校。第 $ i $ 个人的第 $ j $ 志愿为学校 $ a_{i,j} $。总共有 $ m $ 所参与招生的学校，第 $ i $ 所提供了 $ t_i $ 个名额。

按照以下流程确认每个人的录取情况，记 $ b_i $ 为学校 $ i $ 已经招生人数：

* 找到**所有**目前未确定录取结果的**最高分学生**；
* 设**未招满**学校集合 $ S=\{i \mid i \in [1,m] \land t_i > b_i\} $；
* 对于每个当前的最高分学生 $x$，从第一志愿到最后志愿枚举学校 $i=a_{x,1},a_{x,2},\cdots,a_{x,l_x}$：
	* 如果 $i\in S$，则学生 $x$ 被学校 $i$ 录取，令 $b_i\gets b_i+1$，结束；否则，继续枚举下一个。
    * 若枚举所有 $i$ 后没有结束，则学生 $x$ 不被任何学校录取。
* 在上一步中 $ b_i $ 改变不会改变 $ S $，也就是说可能会出现一些学校 $b_i>t_i$。无论这些学生有没有被录取，他们的录取结果都确定了。
* 反复执行该过程直至所有学生录取结果都确定。

对于一次询问，格式如下：

* `x v`：永久性改变 $ t_x \leftarrow t_x-v $，输出录取结果变化的学生个数。
## 输入格式

第一行三个整数 $ n,m,q $，代表学生人数、学校个数和询问次数。

接下来一行，$ m $ 个整数，第 $ i $ 个整数 $ t_i $ 代表高中校 $ i $ 的招生名额数。

接下来 $ n $ 行，第 $ i $ 行第一个整数 $ l_i $ 代表学生 $ i $ 的志愿填报个数，接下来 $ l_i $ 个整数依次代表这位学生的第一至最后志愿高中校，最后一个整数 $ o_i $ 表示学生 $ i $ 的中考分数。

接下来 $ q $ 行，每行均为 `x v` 格式，代表一次询问，含义详见题目描述。
## 输出格式

$ q $ 行，每行一个整数代表录取结果改变的学生数量。
## 样例

### 样例输入 #1
```
5 3 5
1 2 5
3 1 2 3 3
3 1 2 3 2
3 3 2 1 5
2 3 2 4
1 3 4
3 1
3 2
3 1
3 1
2 2
```
### 样例输出 #1
```
0
0
2
2
3
```
## 提示

#### 【样例解释 \#1】

初始时，录取结果分别为（$ 0 $ 表示未被任何学校录取）$ \{1,2,3,3,3\} $。

前两次操作后，录取结果不变。

第三次操作后，录取结果分别为 $ \{1,2,3,2,0\} $。

第四次操作后，录取结果分别为 $ \{1,0,2,2,0\} $。

第五次操作后，录取结果分别为 $ \{0,0,1,0,0\} $。

#### 【数据规模与约定】

对于 $ 100\% $ 的数据：

* $ 1 \le n,m,q \le 3 \times 10^5 $；
* $ 0 \le t_i \le 10^6 $，$ 0 \le l_i \le m $，$ \sum l_i \le 10^6 $，$ 1 \le a_{i,j} \le m $，$ 0 \le o_i \le 10^6 $；
* 对于同一个 $ i $ **不保证** $ a_{i,j} $ 互不相同；
* 对于每次操作有 $ 1 \le x \le m $ 和 $ 0 \le v \le 10^6 $，操作后保证 $ t_i \ge 0 $。

**提示：本题开启捆绑测试。**

* Subtask 1（15 pts）：$ n,m,q \le 500 $，$ \sum l_i \le 5000 $。
* Subtask 2（20 pts）：$ o_i $ 只有两种取值。
* Subtask 3（35 pts）：所有的 $ o_i $ 互异。
* Subtask 4（30 pts）：无特殊限制。


---

---
title: "排序二叉树"
layout: "post"
diff: 提高+/省选-
pid: P1267
tag: ['树形数据结构']
---
# 排序二叉树
## 题目描述

一个边长为 $n$ 的正三角形可以被划分成 $n^2$ 个小的边长为 $1$ 的正三角形，称为单位三角形。边长为 $3$ 的正三角形被分成三层共 $9$ 个小的正三角形，我们把它们从顶到底，从左到右以 $1\sim 9$ 编号，见下图。

![](https://cdn.luogu.com.cn/upload/image_hosting/mzls92cx.png)

四个这样的边长为 $n$ 的正三角形可以组成一个三棱锥。我们将正三棱锥的三个侧面依顺时针次序（从顶向底视角）编号为 $A,B,C$，底面编号为 $D$。侧面的 $A,B,C$ 号三角形以三棱锥的顶点为顶，底面的 $D$ 号三角形以它与 $A,B$ 三角形的交点为顶。

![](https://cdn.luogu.com.cn/upload/image_hosting/yyqpdocn.png)

其中 $\tt .$ 表示这个三角形面的 $1$ 号三角形位置，并依次编号下去。

上图为三棱锥展开后的平面图，每个面上标有圆点的是该面的顶，该图中侧面 $A,B,C$ 分别向纸内方向折叠即可还原成三棱锥。我们把这 $A,B,C,D$ 四个面各自划分成 $n^2$ 个单位三角形。

对于任意两个单位三角形，如有一条边相邻，则称它们为相邻的单位三角形。显然，每个单位三角形有三个相邻的单位三角形。现在，把 $1\sim 4n^2$ 里的所有整数分别随机填入四个面总共 $4n^2$ 个单位三角形中。

现在要求你编程求由单位三角形组成的最大二叉搜索树。所谓最大二叉搜索树，是指在所有由单位三角形组成的二叉搜索树中节点最多的一棵树。要求当 $i$ 作为二叉搜索树的一个节点时，$i$ 的儿子（如果有的话）和 $i$ 的父亲（如果有的话）必须与 $i$ 有邻边（三棱锥状态下的邻边，而非展开图的邻边）。

一棵二叉搜索树满足这个节点的左子树得每个值全部小于这个节点，这个节点的右子树的每个值全部大于这个节点。
## 输入格式

输入的第一行为一个整数 $n$，表示展开图中每个面的三角形边长，也就是这个面有 $n^2$ 个单位三角形。

接下来每行 $n^2$ 个整数，一共四行，第一行表示 $A$ 面的单位三角形中填入的数，第二行表示 $B$ 面，以此类推。
## 输出格式

输出仅一行一个整数，表示最大二叉搜索树的节点个数。
## 样例

### 样例输入 #1
```
3 
19 33 32 31 29 3 5 4 30 
22 25 20 21 12 24 23 34 35 
14 13 15 26 18 17 8 16 27 
11 10 9 1 28 7 2 6 36
```
### 样例输出 #1
```
17


```
## 提示

### 样例解释

以下以 $A$ 面为例。记 $f(A,x)$ 表示 $A$ 面的第 $x$ 个单位三角形，以此类推。

$f(A,9)$ 与 $f(D,1)$ 有邻边，$f(A,7)$ 与 $f(D,2)$ 有邻边，$f(A,5)$ 与 $f(D,5)$ 有邻边。

$f(A,1)$ 与 $f(B,1)$ 有邻边，$f(A,4)$ 与 $f(B,2)$ 有邻边，$f(A,9)$ 与 $f(B,5)$ 有邻边。

$f(A,1)$ 与 $f(C,1)$ 有邻边，$f(A,2)$ 与 $f(C,4)$ 有邻边，$f(A,5)$ 与 $f(C,9)$ 有邻边。

以数字 $1$ 为二叉搜索树的根，可以得到节点最多的二叉搜索树为：

![](https://cdn.luogu.com.cn/upload/image_hosting/2y8i07id.png)

### 数据范围

对于 $100\%$ 的数据，$1\leqslant n\leqslant 18$，保证四个面所有单位三角形上填入的数互不相同且都取自 $[1,4n^2]$。


---

---
title: "信号放大器"
layout: "post"
diff: 提高+/省选-
pid: P1269
tag: ['动态规划 DP', '贪心', '树形数据结构', '树形 DP']
---
# 信号放大器
## 题目描述

树型网络是最节省材料的网络。所谓树型网络，是指一个无环的连通网络，网络中任意两个结点间有且仅有一条通信道路。

网络中有一个结点是服务器，负责将信号直接或间接地发送到各终端机。如图上方，server 结点发出一个信号给结点 $a$ 和 $c$，$a$ 再转发给 $b$。如此，整个网络都收到这个信号了。

![](https://cdn.luogu.com.cn/upload/image_hosting/e4vb2e7t.png)

但是，实际操作中，信号从一个结点发到另一个结点，会出现信号强度的衰减。衰减量一般由线路长度决定。

如图下方，边上所标的数字为边的衰减量。假设从 server 出发一个强度为 $4$ 个单位的信号，发到结点 $a$ 后强度衰减为 $4-3=1$ 个单位。结点 $a$ 再将其转发给结点 $b$。由于信号强度为 $1$，衰减量为 $2$，因此信号无法发送到 $b$。

一个解决这一问题的方法是，安装信号放大器。信号放大器的作用是将强度大于零的信号还原成初始强度（从服务器出发时的强度）。

上图中，若在结点 $a$ 处安装一个信号放大器，则强度为 $4$ 的信号发到 $a$ 处，即被放大至 $4$。这样，信号就可以被发送的网络中的任意一个节点了。为了简化问题，我们假定每个结点只处理一次信号，当它第二次收到某个信号时，就忽略此信号。

你的任务是根据给出的树型网络，计算出最少需要安装的信号放大器数量。
## 输入格式

第一行一个整数 $n$，表示网络中结点的数量。（$n \le 20000$）

第 $2 \sim n+1$ 行，每行描述一个节点的连接关系。其中第 $i+1$ 行，描述的是结点 $i$ 的连接关系：首先一个整数 $k$，表示与结点 $i$ 相连的结点的数量。此后 $2k$ 个数，每两个描述一个与结点 $i$ 相连的结点，分别表示结点的编号（编号在 $1 \sim n$ 之间）和该结点与结点 $i$ 之间的边的信号衰减量。结点 $1$ 表示服务器。

最后一行，一个整数，表示从服务器上出发信号的强度。
## 输出格式

一个整数，表示要使信号能够传遍整个网络，需要安装的最少的信号放大器数量。

如果不论如何安装信号放大器，都无法使信号传遍整个网络，则输出 `No solution.`。

## 样例

### 样例输入 #1
```
4
2 2 3 3 1
2 1 3 4 2
1 1 1
1 2 2
4
```
### 样例输出 #1
```
1

```


---

---
title: "“访问”美术馆"
layout: "post"
diff: 提高+/省选-
pid: P1270
tag: ['动态规划 DP', '搜索', '树形数据结构', '树形 DP']
---
# “访问”美术馆
## 题目描述

经过数月的精心准备，Peer Brelstet，一个出了名的盗画者，准备开始他的下一个行动。艺术馆的结构，每条走廊要么分叉为两条走廊，要么通向一个展览室。Peer 知道每个展室里藏画的数量，并且他精确测量了通过每条走廊的时间。由于经验老到，他拿下一幅画需要 $5$ 秒的时间。你的任务是编一个程序，计算在警察赶来之前，他最多能偷到多少幅画。假定他回到起点后还需要留至少 $1$ 秒逃跑。

![](https://cdn.luogu.com.cn/upload/image_hosting/7kbyjwgy.png)

## 输入格式

第一行是警察赶到的时间，以秒为单位。第 $2$ 行描述了艺术馆的结构，是一串非负整数，成对地出现：每一对的第一个数是走过一条走廊的时间，第 $2$ 个数是它末端的藏画数量；如果第 $2$ 个数是 $0$，那么说明这条走廊分叉为两条另外的走廊。数据按照深度优先的次序给出，请看样例。

一个展室最多有 $20$ 幅画。通过每个走廊的时间不超过 $20$ 秒。艺术馆最多有 $100$ 个展室。警察赶到的时间在 $6000$ 秒以内。
## 输出格式

输出最多能偷到的画的数量。

## 样例

### 样例输入 #1
```
60
7 0 8 0 3 1 14 2 10 0 12 4 6 2

```
### 样例输出 #1
```
2

```


---

---
title: "[USACO2.3] 奶牛家谱 Cow Pedigrees"
layout: "post"
diff: 提高+/省选-
pid: P1472
tag: ['动态规划 DP', '树形数据结构', 'USACO', '前缀和', '构造']
---
# [USACO2.3] 奶牛家谱 Cow Pedigrees
## 题目描述

一个有 $n$ 个节点，深度为 $k$ 的无标号完满二叉树（即每个节点的儿子数为 $0$ 或 $2$）有多少种结构？定义根节点深度为 $1$。

答案对 $9901$ 取模。
## 输入格式

两个空格分开的整数 $n,k$。
## 输出格式

输出一行一个整数表示答案。
## 样例

### 样例输入 #1
```
5 3

```
### 样例输出 #1
```
2

```
## 提示

【数据范围】  
对于 $100\%$ 的数据，$3\le n < 200$，$2 \le k < 100$。

USACO 2.3



---

---
title: "数位平方和"
layout: "post"
diff: 提高+/省选-
pid: P1660
tag: ['搜索', '树形数据结构', '递归']
---
# 数位平方和
## 题目描述

定义 $S(n)$ 表示 $n$ 的各个数位的 $k$ 次方的和。

定义 $H(n)$ 为满足 $H(n) \le \min\{n, H(S(n))\}$ 的最大值。

求$\sum_{i=A}^{B} H(i) \bmod (10^7 + 7)$。
## 输入格式

一行三个数 $k, A, B$。
## 输出格式

一个数，表示 $\sum_{i=A}^{B} H(i) \bmod (10^7 + 7)$。
## 样例

### 样例输入 #1
```
2 1 5
```
### 样例输出 #1
```
14
```
## 提示

对于 $20\%$ 的数据，$A, B \le 50$。  
对于 $100\%$ 的数据，$1 \le A, B \le {10}^6$，$1 \le k \le 6$。


---

---
title: "彩球树"
layout: "post"
diff: 提高+/省选-
pid: P2131
tag: ['字符串', '树形数据结构']
---
# 彩球树
## 题目描述

小Z是一个聪明的小学生，他用塑料管和橡皮泥搭成了一棵树，每个橡皮泥上都连接着一个向下的塑料管，有的连接着两根向上的塑料管，有的则连接着一些彩球。

然而，这个工艺品很快因为不平衡倒了下来。于是，小Z请教了和他在同一个班上的妹子小C。在百科全书上看到天平平衡原理的小C知道，如果任何一块橡皮泥向上连接的两根管子的载重量之差超过一个彩球的重量，工艺品就会不平衡倒下来。由于彩球比较重，橡皮泥和塑料管的重量可以忽略不计。

由于移动彩球需要花时间拆卸和固定，小C希望移动最少次数彩球让这个工艺品平衡起来。你能帮助她吗？

## 输入格式

一行，以中序遍历的方式描述了这棵树，B 表示彩球。

## 输出格式

输出一个数字，表示最少移动多少个彩球就能使它平衡，或输出”impossible”，表示如何移动多少个都无法平衡。

## 样例

### 样例输入 #1
```
((B)())
```
### 样例输出 #1
```
0
```
### 样例输入 #2
```
((((B)(B))((B)()))(B))
```
### 样例输出 #2
```
impossible
```
### 样例输入 #3
```
(()(((B)(B))(B)))
```
### 样例输出 #3
```
1
```
## 提示

【图解】

[PIC=1259]

【数据规模】

对于 15% 的数据，保证输入文件不超过 25 字节。

对于 50% 的数据，保证输入文件不超过 250 字节。

对于 100% 的数据，保证输入文件不超过 5000 字节。

（PS：1字节≈1字符）

【时空限制】

0.1s/128M



---

---
title: "[NOI2015] 软件包管理器"
layout: "post"
diff: 提高+/省选-
pid: P2146
tag: ['树形数据结构', '2015', '线段树', 'NOI', '深度优先搜索 DFS', '树链剖分']
---
# [NOI2015] 软件包管理器
## 题目背景

Linux 用户和 OSX 用户一定对软件包管理器不会陌生。通过软件包管理器，你可以通过一行命令安装某一个软件包，然后软件包管理器会帮助你从软件源下载软件包，同时自动解决所有的依赖（即下载安装这个软件包的安装所依赖的其它软件包），完成所有的配置。Debian/Ubuntu 使用的 apt-get，Fedora/CentOS 使用的 yum，以及 OSX 下可用的 homebrew 都是优秀的软件包管理器。  

## 题目描述

你决定设计你自己的软件包管理器。不可避免地，你要解决软件包之间的依赖问题。如果软件包 $a$ 依赖软件包 $b$，那么安装软件包 $a$ 以前，必须先安装软件包 $b$。同时，如果想要卸载软件包 $b$，则必须卸载软件包 $a$。

现在你已经获得了所有的软件包之间的依赖关系。而且，由于你之前的工作，除 $0$ 号软件包以外，在你的管理器当中的软件包都会依赖一个且仅一个软件包，而 $0$ 号软件包不依赖任何一个软件包。且依赖关系不存在环（即不会存在 $m$ 个软件包 $a_1,a_2, \dots , a_m$，对于 $i<m$，$a_i$ 依赖 $a_{i+1}$，而 $a_m$ 依赖 $a_1$ 的情况）。

现在你要为你的软件包管理器写一个依赖解决程序。根据反馈，用户希望在安装和卸载某个软件包时，快速地知道这个操作实际上会改变多少个软件包的安装状态（即安装操作会安装多少个未安装的软件包，或卸载操作会卸载多少个已安装的软件包），你的任务就是实现这个部分。

注意，安装一个已安装的软件包，或卸载一个未安装的软件包，都不会改变任何软件包的安装状态，即在此情况下，改变安装状态的软件包数为 $0$。

## 输入格式

第一行一个正整数 $n$，表示软件包个数，从 $0$ 开始编号。  
第二行有 $n-1$ 个整数，第 $i$ 个表示 $i$ 号软件包依赖的软件包编号。  
然后一行一个正整数 $q$，表示操作个数，格式如下：  

- `install x` 表示安装 $x$ 号软件包
- `uninstall x` 表示卸载 $x$ 号软件包

一开始所有软件包都是未安装的。  

对于每个操作，你需要输出这步操作会改变多少个软件包的安装状态，随后应用这个操作（即改变你维护的安装状态）。
## 输出格式

输出 $q$ 行，每行一个整数，表示每次询问的答案。
## 样例

### 样例输入 #1
```
7
0 0 0 1 1 5
5
install 5
install 6
uninstall 1
install 4
uninstall 0
```
### 样例输出 #1
```
3
1
3
2
3
```
### 样例输入 #2
```
10
0 1 2 1 3 0 0 3 2
10
install 0
install 3
uninstall 2
install 7
install 5
install 9
uninstall 9
install 4
install 1
install 9
```
### 样例输出 #2
```
1
3
2
1
3
1
1
1
0
1
```
## 提示

![](https://cdn.luogu.com.cn/upload/pic/1504.png)  
一开始所有软件包都处于未安装状态。

安装 $5$ 号软件包，需要安装 $0,1,5$ 三个软件包。

之后安装 $6$ 号软件包，只需要安装 $6$ 号软件包。此时安装了 $0,1,5,6$ 四个软件包。

卸载 $1$ 号软件包需要卸载 $1,5,6$ 三个软件包。此时只有 $0$ 号软件包还处于安装状态。

之后安装 $4$ 号软件包，需要安装 $1,4$ 两个软件包。此时 $0,1,4$ 处在安装状态。最后，卸载 $0$ 号软件包会卸载所有的软件包。

【数据范围】  
![](https://cdn.luogu.com.cn/upload/pic/1505.png)


---

---
title: "loidc，跑起来"
layout: "post"
diff: 提高+/省选-
pid: P2302
tag: ['树形数据结构']
---
# loidc，跑起来
## 题目背景

loidc 在路上诱拐了一个幼女。（他不是哲学家么！？）

## 题目描述

现在他已经被 cony 追杀。loidc 逃到一个迷宫中，cony 也追到了这儿。迷宫由编号由 $1$ 到 $n$ 的方块组成。每两个不同的方块将被得知它们是否与另一个相邻。现在已知 loidc 和 cony 所处迷宫的位置。在迷宫中的人可以选择留在原地不动，还是移到相邻的方格中。

迷宫具有如下性质：

它不包括三角形，也就是没有任意三个不同的方块，它们两两相邻，

每一个人到达都能到达任意一个方块。

一次追杀由许多回合组成。在一个回合内，每一个人移一步。每一个回合由 loidc 开始。如果 loidc 与 cony 在同一个方格中相遇，那么我们就可能永远见不到 loidc 了。

loidc 非常害怕，他请求你告诉他是否会被 cony 抓住，多少回合 cony 赶上他。(假设两个人都足够聪明)

## 输入格式

第一行有 $4$ 个整数 $n,m,a,b$，它们用单个空格分隔，（$2 \leq n \leq 3000, n-1 \leq m \leq 15000,1 \leq a,b \leq n,a < b$）。它们分别表示迷宫中的方块数目，相邻的一对方块（双向）数目，相邻两个方格中有且仅有一条边，loidc，cony所处的位置。下面 $m$ 行，一行包含两个用一个空格分开的整数，表示每一对相邻的方块编号。

## 输出格式

一个单词 `NO`，如果 cony 不能赶上 loidc；或者一个整数，如果 cony 能赶上 loidc 的最少游戏轮数。
## 样例

### 样例输入 #1
```
9 11 9 4
1 2
3 2
1 4
4 7
7 5
5 1
6 9
8 5
9 8
5 3
4 8

```
### 样例输出 #1
```
3
```


---

---
title: "爆弹虐场 "
layout: "post"
diff: 提高+/省选-
pid: P2798
tag: ['树形数据结构', '二分']
---
# 爆弹虐场 
## 题目描述

某年某月某日，Kiana 结识了一名爆弹虐场的少年。

Kiana 仗着自己多学了几年OI，所以还可以勉勉强强给这位少年 讲一些自己擅长的题。具体来说，Kiana 先给这位少年灌输了n 个毫不相干的知识点，然后再通过自己的[数据删除]技术把这些知识点强行联系在一起。


由于这位少年有着爆弹虐场的实力，所以对于每个Kiana 准备强行构造的联系，他都能够自己想出来，不过会花费更多的时间。具体来说，Kiana 一共有m 个联系，每个联系可以把两个不相干的知识点连在一起，如果由Kiana 直接来讲第i 个联系，需要花费ti 的时间， 而如果由少年自己想出来，则需要花费Ti 的时间。


为了偷懒，Kiana 只需要自己讲的或少年想出来的联系能刚好把知识点全部直接或间接串在一起就可以了。但为了保证教学质量， Kiana 觉得至少有k 个联系需要少年自己想出来。由于Kiana 耐心有限，她希望无论是自己讲或是少年自己想，构造的联系中花费时间最长的一个用时最短。


现在Kiana 想知道，满足这些条件的情况下，构造的联系中耗时最长的一个的最短用时是多少。由于她不会算，所以希望由你告诉她。

## 输入格式

输入文件包括m+1 行。


第一行包含三个正整数n,k 和m，分别表示知识点的数量，Kiana 希望少年自己想出来的联系的数量和联系的总数量。


接下来m 行，每行包含四个正整数a,b,Ti 和ti，表示在知识点a 和b 之间可以构造出一个联系，这个联系由少年自己想出来需要花费 Ti 的时间，而Kiana 直接讲出来需要花费ti 的时间。

## 输出格式

输出文件包括一行。


第一行包含一个正整数，表示构造的联系中耗时最长的一个的最短用时。

## 样例

### 样例输入 #1
```
4 2 5 
1 2 6 5 
1 3 3 1 
2 3 9 4 
2 4 6 1 
3 4 4 2 

```
### 样例输出 #1
```
4
```
## 提示

对于30%的数据，1<=n<=10，n-1<=m<=15，

对于60%的数据，1<=n<=500，n-1<=m<=1000，

对于100%的数据，1<=k<n<=10000，n-1<=m<=20000，


1<=ti<Ti<=10^6。 

数据保证一定存在可行解。



---

---
title: "树枝修剪"
layout: "post"
diff: 提高+/省选-
pid: P5140
tag: ['贪心', '高精度', '树形数据结构']
---
# 树枝修剪
## 题目背景

$Daleva$ $Geoge$是一个热爱生活的园艺工。
## 题目描述

$Daleva$ $Geoge$的花园里有一颗常年没有修剪的树，这一天，$Daleva$ $Geoge$家里来了客人，为了给客人一个好印象，他需要整理这个花园，但是那一颗树显得太碍眼了，他必须要给他好好地修剪一下。

这是一颗以$root$为根的有根树，有$n$个节点。$Daleva$ $Geoge$在根节点，$Daleva$ $Geoge$对某些叶子的形态感到不满，需要剪去多余的枝条。

有$S$个需要修剪的叶子节点,这些叶子节点有一些多余的枝条，这些叶子节点有着自己的权值$a_{i}$,表示这个节点上有多少个$Daleva$ $Geoge$不需要的枝条。同时，因为花园里没法容下这些枝条（否则就变得不和谐了），$Daleva$ $Geoge$需要把这些枝条安装到某些节点上。

$Daleva$ $Geoge$有一个神奇的胶水和一把神奇的剪刀，因此你不需考虑每个树枝的固定形态，根据$Daleva$ $Geoge$的推测，一共有$T$个叶子节点需要安装这些枝条，这些节点有各自的权值$b_{i}$，表示需要$b_{i}$个枝条才能把这棵树变得很好看。

为了修剪好这棵树，$Daleva$ $Geoge$不得不在树上跑边，把每个叶子节点中多余的枝条剪下，并用胶水粘在其他的有需要的叶子节点上。每条边都有不同的长度，现在，由于树太过庞大，$Daleva$ $Geoge$需要知道，他最少需要跑多远的路才能使这棵树被修剪好，$Daleva$ $Geoge$也要回到树根上下来。

虽然$Daleva$ $Geoge$有这些神奇的工具，但他的口袋是有限的，容量为$G$,$Daleva$ $Geoge$不能一次带太多枝条，即不能超过$G$,这更使他懒于考虑这些繁琐的问题。$Daleva$ $Geoge$当然会算啦，他那么巨，但他为了养足精力去剪枝条，这一艰巨的任务就落在你身上了。

$Daleva$ $Geoge$已经把心中树的形状告诉你了，他要躺在椅子上看你怎么算这些问题。
## 输入格式

输入的第一行$3$个整数：$n,G,root$.

接下来$n-1$行描述每个树边，每行$3$个整数：$u,v,w$表示$u$与$v$有一条长度为$w$的边。

接下来一行$2$个整数：$S,T$;

接下来$S$行，每行两个整数：$x,a_{i}$,表示在第$x$个节点有$a_{i}$个多余枝条，数据保证$x$为叶子节点。

接下来$T$行，每行两个整数：$x,b_{i}$,表示在第$x$个节点需要$b_{i}$个枝条，数据保证$x$为叶子节点。

数据保证$\sum_{i=1}^{S}a_{i}=\sum_{i=1}^{T}b_{i}$
## 输出格式

一行，一个整数，表示$Daleva$ $Geoge$最少需要跑多长的路才能把树修剪好并回到树根爬下树。
## 样例

### 样例输入 #1
```
4 2 1
2 1 4
4 1 2
3 1 2
1 2
2 6
3 3
4 3
```
### 样例输出 #1
```
40
```
### 样例输入 #2
```
5 1 1
1 2 2
3 2 2
4 1 2
5 4 2
1 1
3 1
5 1

```
### 样例输出 #2
```
16
```
### 样例输入 #3
```
20 10 18
1 17 86406
17 16 94583
19 10 28177
16 18 31981
10 14 36241
1 7 28919
2 1 94673
5 6 2801
7 11 81927
11 13 7779
17 5 71948
19 7 20264
1 8 17736
13 20 97181
17 9 16807
11 15 93705
17 3 29601
1 12 43829
13 4 27537
1 6
20 23585
9 8376
12 3128
15 5417
8 4011
3 1156
6 1497

```
### 样例输出 #3
```
1289613990
```
## 提示

样例1解释：

![](https://cdn.luogu.com.cn/upload/pic/37354.png)

蓝色数字表示有多少多余枝条，黄色数字表示需要的枝条数。

则最优方案为：$1→2→1→3→1→2→1→3→1→4→1→2→1→4→1$，答案为$40$;

对于$5\%$的数据，为样例1。

对于$40\%$的数据，$n\leq 10,G\leq 10;w \leq 1000$

对于$100\%$的数据，$n\leq 40,0000,G\leq 1000;S+T\leq n;a_{i},b_{i}\leq 10^{9};w\leq 10^{9}$

数据保证不会有任意一个叶子节点既需要枝条又有多余枝条。


---

---
title: "小猪佩奇爬树"
layout: "post"
diff: 提高+/省选-
pid: P5588
tag: ['树形数据结构', '洛谷月赛']
---
# 小猪佩奇爬树
## 题目描述

佩奇和乔治在爬♂树。


给定 $n$ 个节点的树 $T(V,E)$，第 $i$ 个节点的颜色为 $w_i$，保证有$1 \leq w_i \leq n$。

对于$1 \leq i \leq n$，分别输出有多少对点对 $(u,v)$，满足 $u<v$，且恰好经过**所有**颜色为 $i$ 的节点，对于节点颜色不为 $i$ 的其他节点，经过或不经过均可。

树上路径 $(u,v)$ 定义为序列 $\{f\}$，满足 $f_1=u,f_{|f|}=v$，且 $\forall 1 \leq i < |f|$，$T$ 中均存在边 $(f_i,f_{i+1})$，且 $\{f\}$ 中无重复元素，能够证明对于任意点对 $(u,v)$，其树上路径唯一。
## 输入格式

第一行 $1$ 个正整数，表示 $n$ 。

第二行 $n$ 个正整数，第 $i$ 个正整数表示 $w_i$。

之后 $n-1$ 行，每行 $2$ 个正整数 $u,v$，表示 $T$ 中存在边 $(u,v)$。

## 输出格式

共 $n$ 行，每行 $1$ 个正整数，第 $i$ 行输出包含所有颜色为 $i$ 的节点的路径个数。
## 样例

### 样例输入 #1
```
4
1 2 2 3
1 2
2 3
3 4
```
### 样例输出 #1
```
3
4
3
6
```
### 样例输入 #2
```
10
9 7 4 2 3 4 4 5 8 5
2 1
3 2
4 2
5 2
6 4
7 4
8 1
9 4
10 4
```
### 样例输出 #2
```
45
35
9
0
1
45
34
9
17
45
```
## 提示

![](https://i.loli.net/2019/10/06/H9LuWl7GSXfs4M6.png)

对于第一组样例而言。

对于颜色 $1$，点对 $(1,2),(1,3),(1,4)$ 满足条件。

对于颜色 $2$，点对 $(1,3),(1,4),(2,3),(2,4)$ 满足条件。

对于颜色 $3$，点对 $(1,4),(2,4),(3,4)$ 满足条件。

对于颜色 $4$，由于图中没有颜色为 $4$ 的节点，所以所有点对均满足条件。
### 数据范围

对于 $40\%$ 的数据, $n \leq 10^2$

对于 $60\%$ 的数据, $n \leq 10^3$

对于 $100\%$ 的数据, $n \leq 10^6$


---

---
title: "【模板】失配树"
layout: "post"
diff: 提高+/省选-
pid: P5829
tag: ['字符串', '树形数据结构', 'KMP 算法']
---
# 【模板】失配树
## 题目描述

给定一个字符串 $s$，定义它的 **$k$ 前缀** $\mathit{pre}_k$ 为字符串 $s_{1\dots k}$，**$k$ 后缀** $\mathit{suf}_k$ 为字符串 $s_{|s|-k+1\dots |s|}$，其中 $1 \le k \le |s|$。

定义 $\bold{Border}(s)$ 为**对于 $i \in [1, |s|)$，满足 $\mathit{pre}_i = \mathit{suf}_i$** 的字符串 $\mathit{pre}_i$ 的集合。$\bold{Border}(s)$ 中的每个元素都称之为字符串 $s$ 的 $\operatorname{border}$。

有 $m$ 组询问，每组询问给定 $p,q$，求 $s$ 的 **$\boldsymbol{p}$ 前缀** 和 **$\boldsymbol{q}$ 前缀** 的 **最长公共 $\operatorname{border}$**  的长度。
## 输入格式

第一行一个字符串 $s$。

第二行一个整数 $m$。

接下来 $m$ 行，每行两个整数 $p,q$。
## 输出格式

对于每组询问，一行一个整数，表示答案。若不存在公共 $\operatorname{border}$，请输出 $0$。
## 样例

### 样例输入 #1
```
aaaabbabbaa
5
2 4
7 10
3 4
1 2
4 11

```
### 样例输出 #1
```
1
1
2
0
2

```
### 样例输入 #2
```
zzaaccaazzccaacczz
3
2 18
10 18
3 5

```
### 样例输出 #2
```
1
2
0

```
## 提示

样例 $2$ 说明：

对于第一个询问，$2$ 前缀和 $18$ 前缀分别是 ``zz`` 和 ``zzaaccaazzccaacczz``，由于 ``zz`` 只有一个 $\operatorname{border}$，即 ``z``，故最长公共 $\operatorname{border}$ 长度为 $1$。

---

对于 $16\%$ 的数据，$s$ 中的字符全部相等。

对于 $100\%$ 的数据，$1\leq p,q \le |s|\leq 10^6$，$1 \leq m \leq 10^5$，$s_i \in [\texttt{a}, \texttt{z}]$。


---

---
title: "[USACO19DEC] Bessie's Snow Cow P"
layout: "post"
diff: 提高+/省选-
pid: P5852
tag: ['树形数据结构', '2019', 'USACO', '树状数组']
---
# [USACO19DEC] Bessie's Snow Cow P
## 题目背景

Snow has arrived on the farm, and as she does at the beginning of every winter,
Bessie is building a snow-cow! Most of the time, Bessie strives to make her
sculpture look as much like a real cow as possible.  However, feeling
artistically inspired, this year she decides to pursue a more abstract route and
build a sculpture in the shape of a tree, consisting of $N$ snowballs
$(1\le N\le 10^5)$ connected by  $N-1$ branches, each connecting a pair of
snowballs such that there is a  unique path between every pair of snowballs. 

Bessie has added a nose to one of the snowballs, so it represents the head of
the abstract snow cow.  She designates it as snowball number 1.  To add more
visual interest, she plans to dye some of the snowballs different colors in an
artistic fashion by filling old milk pails with colored dye and splashing them
onto the sculpture.  Colors are identified by integers in the range
$1 \ldots 10^5$, and  Bessie has an unlimited supply of buckets filled with dyes
of every possible color.

When Bessie splashes a snowball with a bucket of dye, all the snowballs in its 
subtree are also splashed with the same dye (snowball $y$ is in the subtree of
snowball $x$ if $x$ lies on the path from $y$ to the head snowball). By
splashing each color with great care, Bessie makes sure that all colors a 
snowball has been splashed with will remain visible. For example, if a snowball
had colors $[1,2,3]$ and Bessie splashes it with color $4$, the snowball will
then have colors $[1,2,3,4]$. 

After splashing the snowballs some number of times, Bessie may also want to know
how colorful a part of her snow-cow is.  The "colorfulness" of a snowball $x$ is
equal to the number of distinct colors $c$ such that snowball $x$ is colored
$c$. If Bessie asks you about snowball $x$, you should reply with the sum of the
colorfulness values of all snowballs in the subtree of $x.$

Please help Bessie find the colorfulness of her snow-cow at certain points in
time.
## 题目描述

农场下雪啦！Bessie 和往年开冬一样在堆雪牛。她之前是个写实派，总是想把她的雪牛堆得和个真牛一样。但今年不一样，受到来自东方的神秘力量的影响，她想来点抽象艺术，因此她想堆成一棵树的样子。这棵树由 $N$ 个雪球，$N-1$ 根树枝构成，每根树枝连接两个雪球，并且每两个雪球之间路径唯一。

Bessie 要给她的雪牛来点细节。因此她给其中一个雪球加了个鼻子，来表示这是他那抽象的牛的头，并且把它称作雪球 $1$。为了让雪牛更好看，她还要给某些雪球来点不同的颜色。于是，她用旧牛奶桶装满了颜料泼到雪牛上。这些颜料分别被编号为 $1,2,\dots 10^5$，且每种颜色都无限量供应。

当 Bessie 把一桶颜料泼到一个雪球上时，这个雪球子树上的所有雪球也会被染色（我们称雪球 $y$ 在雪球 $x$ 的子树里当且仅当雪球 $x$ 处在雪球 $y$ 到雪球 $1$ 的路径上）。Bessie 有着精确的泼颜料技术，因此在泼完一种颜料后，一个雪球上之前被染过的所有颜色依然清晰可见。例如，一个雪球之前显现出来颜色 $\left[ 1,2,3 \right]$，然后 Bessie 把装有 $4$ 号颜色的牛奶桶泼上去，那么这个雪球将显现出来颜色 $\left[ 1,2,3,4 \right]$。 在泼了几桶颜料以后，Bessie 可能想要了解她的雪牛有多五彩斑斓。令雪球 $x$ 的『颜色丰富度』为这个雪球被染上的不同颜色总数 ，当 Bessie 想了解雪球 $x$ 的相关信息时，你应该回答她雪球 $x$ 的子树中所有的雪球的颜色丰富度之和。

救救孩子吧！
## 输入格式

第一行，$N$ 和询问数 $Q$。

接下来 $N-1$ 行每行两个用空格隔开的数 $a$ 和 $b$，表示雪球 $a$ 和 $b$ 中间有一根树枝相连。

最后 $Q$ 行每行一个请求，格式及对应含义如下：

 - `1 x c`（修改）：表示 Bessie 把一桶装有颜色 $c$ 的颜料泼到雪球 $x$ ，使得其子树上所有雪球被染色。
 - `2 x`（询问）：询问雪球 $x$ 的子树的颜色丰富度之和。
## 输出格式

对于每个询问，输出所询问子树的颜色丰富度之和。**为了防止溢出，你需要使用 64 位整数。**
## 样例

### 样例输入 #1
```
5 18
1 2
1 3
3 4
3 5
1 4 1
2 1
2 2
2 3
2 4
2 5
1 5 1
2 1
2 2
2 3
2 4
2 5
1 1 1
2 1
2 2
2 3
2 4
2 5

```
### 样例输出 #1
```
1
0
1
1
0
2
0
2
1
1
5
1
3
1
1

```
## 提示

#### 样例解释
执行完第一个修改后雪球 $4$ 被染上了颜色 $1$。

执行完第二个修改后雪球 $4$ 和雪球 $5$ 被染上了颜色 $2$。

执行完第三个修改后所有雪球都被染上了颜色 $1$。
#### 数据范围
对于测试点 $2,3$，$1\le N\le 10^2,1\le Q\le 2\times 10^2$；

对于测试点 $4-6$，$1\le N\le 10^3,1\le Q\le 2\times 10^3$；

对于 $100\%$ 的数据，$1\le N,\ Q,\ c \le 10^5, 1\le a,\ b,\ x \le N$。

USACO 2019 December 铂金组T2


---

---
title: "集合"
layout: "post"
diff: 提高+/省选-
pid: P6301
tag: ['树形数据结构', '2020', 'O2优化']
---
# 集合
## 题目描述

你需要**在线**维护一个自然数的排序集 $S$ 并支持以下操作：

1. 给一个数 $x$，若 $x$ 不在集合 $S$ 中则将 $x$ 添加到集合 $S$ 中；
2. 给一个数 $x$，若 $x$ 已在集合 $S$ 中则将 $x$ 从集合 $S$ 中删除。

为了证明你维护了 $S$，你需要在操作过程中回答以下询问：

3. 求集合 $S$ 中最小元素的值，若 $S=\varnothing$ 则返回 `-1`；
4. 求集合 $S$ 中最大元素的值，若 $S=\varnothing$ 则返回 `-1`；
5. 求集合 $S$ 中元素的数量；
6. 给一个数 $x$，判断 $x$ 是否在集合内，若在则返回 `1` ，若不在则返回 `0` ；
7. 给一个数 $x$，求集合 $T=S\cap[0^-,x)$ 中最大元素的值，若 $T=\varnothing$ 则返回 `-1`；
8. 给一个数 $x$，求集合 $T=S\cap[x,n)$ 中最小元素的值，若 $T=\varnothing$ 则返回 `-1`。

为了证明你**在线地**维护了 $S$，对于所有在第一次询问后的操作 $1,2$ 与询问 $6,7,8$，实际操作和询问的参数 $x$ 为输入中给出的操作和询问的参数 $x'$ 与上一次询问的返回结果 $\text{last}$ 之和。即 $x=x'+\text{last}$。

保证 $0\le x<n$ 。

初始时 $S=\varnothing$。
## 输入格式

输入共 $(m+1)$ 行，其中 $m$ 的意义见下。

第一行两个正整数 $n,m$，其中 $n$ 表示操作与询问的参数 $x$ 的上界，$m$ 表示操作与询问个数的总和。  
接下来 $m$ 行，每行一个或两个自然数，表示一次操作或者询问。保证每一行为如下八种形式之一：
1. `1 x'`，表示执行操作 $1$；
2. `2 x'`，表示执行操作 $2$；
3. `3`，表示回答询问 $3$；
4. `4`，表示回答询问 $4$；
5. `5`，表示回答询问 $5$；
6. `6 x'`，表示回答询问 $6$；
7. `7 x'`，表示回答询问 $7$；
8. `8 x'`，表示回答询问 $8$。
## 输出格式

为避免输出过多，你只需要输出一行一个整数，表示所有询问的返回结果之和。
## 样例

### 样例输入 #1
```
4 13
1 0
1 1
1 3
1 3
3
7 0
7 2
8 3
4
2 0
4
6 2
5

```
### 样例输出 #1
```
8

```
## 提示

### 样例解释

实际上执行的操作与回答的询问如下：

```plain
1 0
1 1
1 3
1 3
3		->  0
7 0		-> -1
7 1		->  0
8 3		->  3
4		->  3
2 3
4		->  1
6 3		->  0
5		->  2
```

因此输出为 $0+(-1)+0+3+3+1+0+2=8$。

### 数据范围

| 测试点编号 |    $n=$     |    $m=$   | 分值  |
|:--------------:|:------------:|:-----------:|:-------:|
|      $1$       | $2^{20}$ | $2^{14}$ |  $5$  |
|      $2$       | $2^{25}$ | $2^{17}$ |  $5$  |
|      $3$       | $2^{30}$ | $2^{20}$ | $10$ |
|      $4$       | $2^{30}$ | $2^{22}$ | $15$ |
|      $5$       | $2^{30}$ | $2^{22}$ | $15$ |
|      $6$       | $2^{30}$ | $2^{23}$ | $25$ |
|      $7$       | $2^{30}$ | $2^{23}$ | $25$ |

对于 $100\%$ 的数据，满足 $2^{20}\le n\le2^{30},2^{14}\le m\le 2^{23},0\le x<n$。

### 提示

**本题输入量较大，建议使用较快的读入方式。**

$0^-$ 表示略小于 $0$ 的一个值，$[0^-,x)$ 可以保证第 $7$ 个操作的 $T$ 恒有意义。


---

---
title: "「EZEC-7」加边"
layout: "post"
diff: 提高+/省选-
pid: P7443
tag: ['树形数据结构', '博弈论', 'O2优化', '洛谷月赛']
---
# 「EZEC-7」加边
## 题目背景

> 暴力怎么做？暴力是不是，加边！加边！加边！然后，并查集查询！

Alice 不喜欢并查集，但是她喜欢加边。
## 题目描述

给定一棵 $n$ 个节点的树，节点从 $1$ 开始编号，$1$ 号节点是根节点，每条边的方向是从父亲到儿子。每个点有一个点权 $a_i$。Alice 和 Bob 在玩游戏，他们在根节点上放了一个棋子，Alice 和 Bob 轮流将棋子沿边移动，谁不能移动谁输。

已知 Alice 是先手或是后手。在游戏开始前，Alice 可以在树上添加一条有向边 $u\to v$（$1\le u,v\le n$），然后和 Bob 在形成的图上玩这个游戏，她希望自己存在必胜策略。**她也可以选择不加边。如果无法决出胜负则不算胜利。**

给定正整数 $A,B$，Alice 添加边 $u\to v$ 的代价是 $A\times a_u+B\times  a_v$。选择不加边的代价为 $0$。

Alice 要最小化她的代价。如果她怎么加边都不满足要求，输出 $-1$。

Alice 会做出 $T$ 次询问，你需要对每个询问输出答案。
## 输入格式

**本题有多组数据。**

第一行输入一个正整数 $T$，表示询问次数。

对于每组询问，第一行输入四个正整数 $n,t,A,B$，其中 $n$ 表示树的节点数，$t$ 表示操作顺序，$t=0$ 表示 Alice 先手，$t=1$ 表示 Alice 后手。

接下来一行 $n-1$ 个正整数，第 $i$ 个数表示节点 $i+1$ 的父亲编号 $f_{i+1}$。

接下来一行 $n$ 个正整数，第 $i$ 个表示 $a_i$ 的值。
## 输出格式

对于每个询问，输出一行一个整数，表示 Alice 的最小代价。如果她怎么加边都不满足要求，输出 $-1$。
## 样例

### 样例输入 #1
```
4
3 1 2 7
1 1
4 3 2
3 1 2 7
1 2
4 3 2
3 0 2 7
1 2
4 3 2
9 1 523 182
1 1 2 2 2 3 3 1
3 23 18 293 162 483 574 384 109
```
### 样例输出 #1
```
-1
0
22
86491
```
## 提示

**【样例解释】**

在第 $1$ 组询问中，Alice 是后手，她无论怎么添加边都无法拥有必胜策略，所以输出 $-1$。  
在第 $2$ 组询问中，Alice 是后手，她不需要添加边就拥有必胜策略，所以代价为 $0$。  
在第 $3$ 组询问中，Alice 是先手，她只能添加一条 $1\to 3$ 的边使自己必胜，此时代价为 $2\times 4+7\times 2=22$。  
在第 $4$ 组询问中，Alice 是后手，她可以添加一条 $9\to 5$ 的边使自己必胜，此时代价为 $523\times 109+182\times 162=86491$。她还有其他使自己必胜的方法，但是可以发现 $86491$ 是最小代价。  

------------


**【数据范围】**

**本题采用捆绑测试。**


- Subtask 1（10 points）：$n\le 10$，$T=1$；
- Subtask 2（15 points）：$\sum n\le 200$；
- Subtask 3（15 points）：$\sum n\le 2000$；
- Subtask 4（10 points）：$f_i=i-1$；
- Subtask 5（10 points）：$f_i=1$；
- Subtask 6（20 points）：$\sum n\le 5\times 10^5$；
- Subtask 7（20 points）：无特殊限制。

对于 $100\%$ 的数据，满足 $1\le T\le 2\times10^3$，$2\le n\le2\times 10^5$，$\sum n\le 5\times 10^6$，$1\le a_i,A,B\le 10^9$，$f_i<i$，$t\in\{0,1\}$。


------------
**【提示】**

请使用较快的输入方式。


---

---
title: "「EVOI-RD2」童年"
layout: "post"
diff: 提高+/省选-
pid: P7925
tag: ['树形数据结构', '2021', 'O2优化', '树形 DP']
---
# 「EVOI-RD2」童年
## 题目背景

池塘边的榕树上 知了在声声地叫着夏天  
操场边的秋千上 只有蝴蝶儿停在上面  
黑板上老师的粉笔还在拼命叽叽喳喳写个不停  
等待着下课 等待着放学  
等待游戏的童年


## 题目描述

Charlie 童年时代很喜欢爬树。

有一天，Charlie 准备向一棵高大的苹果树发起挑战。这棵苹果树有 $n$ 个结点，其中结点 $1$ 为树根。

每个结点会有若干个苹果或一个鸟巢。若这个结点上是若干个苹果，则 Charlie 会摘下所有的苹果装入自己的口袋中；若这个结点是鸟巢**且 Charlie 是第一次访问它**，则 Charlie 会给这个鸟巢中的每只鸟儿一个苹果~~不要问鸟儿为什么喜欢苹果~~。

特别地，如果 Charlie 当前口袋中的苹果不足以给该结点的每只鸟儿一个，则他就不会走向这个结点。注意 Charlie 重复经过一个结点时，不会重复采摘苹果，也不会重复给出苹果。

一开始，Charlie 口袋中有 $s$ 个苹果。Charlie 将从树根开始爬树，每次经过一条边到达一个结点，并执行对应的操作（摘苹果或给苹果，根结点的操作也要执行）。Charlie 希望最终拥有的苹果数最多。由于 Charlie 还在忙着爬其他的树，他想请你写个程序帮帮他。
## 输入格式

第一行两个整数 $n,s$，含义如上所示。

接下来一行 $n-1$ 个整数，第 $i$ 个整数代表第 $i+1$ 号结点的父亲 $p_i$。

再接下来一行 $n$ 个整数，第 $i$ 个数为 $a_i$。若 $a_i>0$，则代表这个结点有 $a_i$ 个苹果；若 $a_i<0$，则代表这个结点有一个 $|a_i|$ 只鸟儿的鸟巢；若 $a_i=0$，则说明这个结点什么也没有。
## 输出格式

一行一个整数，代表 Charlie 最终拥有的最多苹果数。
## 样例

### 样例输入 #1
```
5 0
1 1 2 2
1 1 1 1 1
```
### 样例输出 #1
```
5
```
### 样例输入 #2
```
5 0
1 1 2 2
1 -3 1 2 2
```
### 样例输出 #2
```
2
```
### 样例输入 #3
```
8 5
1 1 2 2 3 3 4
-2 -6 1 -7 8 1 1 6
```
### 样例输出 #3
```
8
```
## 提示

**样例 1 解释：**

可以摘走所有苹果。

**样例 2 解释：**

只能摘走结点 $1,3$ 的苹果，结点 $2$ 因为鸟儿太多无法访问。

**样例 3 解释：**  

![样例3解释](https://cdn.luogu.com.cn/upload/image_hosting/hj7eoes3.png)

结点 $1$ 给掉 $2$ 个苹果，先摘完结点 $3,6,7$ 的苹果，此时口袋中有 $6$ 个苹果。再闯过结点 $2$，然后拿走结点 $5$ 的苹果，结点 $4$ 由于鸟儿太多没必要走。

一种最优的具体路径：$1 \rightarrow 3 \rightarrow 6 \rightarrow 3 \rightarrow 7  \rightarrow 3 \rightarrow 1 \rightarrow 2 \rightarrow 5 \rightarrow 2 \rightarrow 1$。

**数据规模与约定**

**本题采用捆绑测试。**

+ Subtask 1 (10 pts)：$\, n \leq 10$。   
+ Subtask 2 (20 pts)：$\, n \leq 100$ 。  
+ Subtask 3 (10 pts)：$\, p_i=1$。  
+ Subtask 4 (30 pts)：$\, p_i=i-1$。  
+ Subtask 5 (30 pts)：无特殊限制。

对于 $100\%$ 的数据，$1 \leq n \leq 6000, 1 \leq p_i \lt i, |a_i| \leq 10^9,0 \leq s \leq 10^9$。

---

“记得门前，有两株树，一株是苹果树，还有一株……也是苹果树。”


---

---
title: "[传智杯 #4 决赛] [yLOI2021] 生活在树上（hard version）"
layout: "post"
diff: 提高+/省选-
pid: P8201
tag: ['树形数据结构', 'Special Judge', 'O2优化', '最近公共祖先 LCA', '前缀和', '差分', '传智杯']
---
# [传智杯 #4 决赛] [yLOI2021] 生活在树上（hard version）
## 题目背景

**本题是 P8200 的较难版本，两道题目的解法略有不同。本题和 P8200 在题意上的区别在于本题给定树上的点权，而不是边权。**

小智生活在「传智国」，这是一个有 $n$ 个城市的国家，各个城市由 $n-1$ 条道路相连。

每个城市都有一个财富指数 $w_i$ ，我们定义，小智从城市 $a$ 走到城市 $b$ 的代价是 $\mathrm{dis}_{a, b} = \bigoplus \limits_{u \in \mathrm{path}\left(a, b\right)} w_u$，其中 $\bigoplus$ 表示**按位异或**（如果你不知道什么是**按位异或**，请参见题目下方的提示/说明），$\mathrm{path}\left(a,b\right)$ 表示 $a$ 到 $b$ 的简单路径上的点集（包括 $a$ 和 $b$）。也即 $\mathrm{dis}_{a, b}$ 表示将 $a$ 与 $b$ 的简单路径上所有点写作 $u_1, u_2, u_3, \dots$ 后，求 $w_{u_1} \bigoplus w_{u_2}\bigoplus w_{u_3} \dots$ 的结果。

有一天，小智获得了去参加传智杯的机会，他在前往比赛地的路上想到了一个问题，但他好像不会做，于是他把这个题告诉了你。聪明的同学，你可以帮帮他吗？
## 题目描述

小智说：「由于我们的国家只有 $n$ 个城市和 $n-1$ 条道路，那么我们的国家就相当于是一棵树。我在想，在我们的国家中，是否存在城市满足『到城市 $a$ 的代价和到城市 $b$ 的代价的异或等于 $k$』。好难哦，我想不出来，你能帮帮我吗？」

也就是说，给定城市 $a, b$ 和整数 $k$，请你计算是否存在城市 $t$ 满足 $\mathrm{dis}_{t, a} \bigoplus \mathrm{dis}_{t, b} = k$。
## 输入格式

第一行有两个整数 $n$，$m$，表示国家的城市数和询问的个数。

第二行有 $n$ 个整数 $w_i$，表示 $i$ 号城市的财富指数。

接下来 $n-1$ 行，每行有两个整数 $x, y$，表示城市 $x$ 与城市 $y$ 有一条边相连。

接下来 $m$ 行，每行有三个整数 $a, b, k$，表示小智从城市 $a$ 走到城市 $b$，$k$ 的含义与题目描述一致。
## 输出格式

输出共 $m$ 行。

对于第 $i$ 个询问，如果存在至少一个城市 $t$ 满足要求，则输出 `Yes`。

如果不存在任何一个城市满足条件，则输出 `No`。

输出字符串大小写不敏感，例如，`Yes`、`yES`、`YES`、`yes` 等都算作 `Yes`。
## 样例

### 样例输入 #1
```
5 3
2 6 8 1 5
1 2
1 3
2 4
2 5
1 2 4
2 3 12
2 3 10
```
### 样例输出 #1
```
nO
No
YeS
```
### 样例输入 #2
```
5 10
93 97 100 93 93
2 1
3 2
4 3
5 1
5 2 93
4 1 93
3 2 100
3 2 100
2 3 9999998
1 2 93
2 3 97
1 2 93
2 3 97
4 3 93
```
### 样例输出 #2
```
no
nO
yEs
yEs
No
yEs
yeS
YES
yES
yes
```
## 提示

### 相关概念解释
「树」：树是一个有 $n$ 个结点和 $n-1$ 条边的无向简单连通图。

「按位异或」：按位异或是一个二元运算，步骤是将两个数的二进制位按位比较，相同为 $0$，不同为 $1$ 。例如：$3 \bigoplus 5 = (011)_2 \bigoplus (101)_2 = (110)_2 = 6$。
### 样例 1 解释
下图为传智国的地图。

$\forall t \in \{1, 2, 3, 4, 5\}$，都不可能有 $\mathrm{dis} _{t,1} \bigoplus \mathrm{dis}_{t, 2} = 4$，$\mathrm{dis}_{t, 2} \bigoplus \mathrm{dis}_{t, 3} = 12$，于是输出 `No`；

而取 $t=4$，有 $\mathrm{dis}_{t, 2} \bigoplus \mathrm{dis}_{t, 3} = 10$，于是输出 `Yes`。

![](https://cdn.luogu.com.cn/upload/image_hosting/d3phj9di.png)
### 数据规模与约定
对于所有测试点，保证 $1 < n \leq 5 \times 10^5$，$1 \leq m \leq 5 \times 10^5$，$0 \leq w_i \leq 1\times 10^7$。

对于每次询问，保证 $1 \leq a,b \leq n$ 且 $a \neq b$，$0 \leq k \leq 1\times 10^7$。
### 提示
- 请注意常数因子对程序效率造成的影响。
- 对于两个 $x, y \leq 10^7$，$x \bigoplus y$ 可能大于 $10^7$，请特别注意这一点。


---

---
title: "「DROI」Round 1 距离"
layout: "post"
diff: 提高+/省选-
pid: P8981
tag: ['树形数据结构', '洛谷原创', 'O2优化', '树形 DP', '树的直径']
---
# 「DROI」Round 1 距离
## 题目背景

没有什么距离是无法跨越的。
## 题目描述

定义一棵树 $G$ 上两点 $u,v$ 之间的距离 $\operatorname{dis}(u,v)$ 为两点之间点的数量。

若对于树上两点 $u,v$，满足 $\forall x \in G,\operatorname{dis}(u,x) \leq \operatorname{dis}(u,v)$ **且** $\operatorname{dis}(v,x) \leq \operatorname{dis}(u,v)$，那么我们称无序点对 $(u,v)$ 为**极远点对**。

同时，树 $G$ 上一点 $x$ 的权值 $v_x$ 定义为：满足两点间最短路径经过 $x$ 的极远点对的数量。

现给定树 $G$，求 $\sum\limits_{x \in G}{v_x^k}$ 对 $998244353$ 取模的值，其中 $k$ 是给定的常数，且 $k \in [1,2]$。
## 输入格式

第一行两个数 $n,k$，分别表示树 $G$ 的点数以及给定的常数。

接下来 $n-1$ 行每行两个整数 $u,v$，表示点 $u$ 和点 $v$ 之间有一条边。
## 输出格式

输出一行一个整数，表示答案。
## 样例

### 样例输入 #1
```
2 1
1 2

```
### 样例输出 #1
```
2
```
### 样例输入 #2
```
5 2
1 2
1 3
4 1
5 1

```
### 样例输出 #2
```
72
```
## 提示

#### 样例解释 #1

$(1,2)$ 为极远点对，所以 $1$ 号和 $2$ 号点点权均为 $1$，$1^1 + 1^1 =2$。

------------

#### 样例解释 #2

极远点对有 $(2,3),(2,4),(2,5),(3,4),(3,5),(4,5)$，故答案为 $4 \times 3^2 + 6^2 = 72$。

------------

#### 数据范围

| 测试点编号 | $1$ | $2$ | $3$ | $4 \sim 5$ | $6$ | $7$ | $8 \sim 9$ | $10$ |
| :----: | :----: | :----: | :----: | :----: | :----: | :----: | :----: | :----: |
| $n$ | $300$ | $300$ | $2000$ | $2000$ | $10^5$ | $5 \times 10^6$ | $10^5$ |  $5 \times 10^6$|
| $k$ | $1$ | $2$ | $1$ | $2$ | $1$ | $1$ | $2$ | $2$ |

对于 $100\%$ 的数据，满足 $n \leq 5 \times 10^6$，$1 \leq  k \leq 2$。

**本题输入量较大，请用较快的输入方法。**





---


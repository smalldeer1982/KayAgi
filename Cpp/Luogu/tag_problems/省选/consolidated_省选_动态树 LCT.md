---
title: "[JOI Open 2024] 考试 2"
layout: "post"
diff: 省选/NOI-
pid: P10626
tag: ['动态规划 DP', '线段树', '树上启发式合并', '2024', '树链剖分', '动态树 LCT', 'JOI（日本）']
---
# [JOI Open 2024] 考试 2
## 题目描述

JOI 君在 IOI 高中上学，期末考试即将来临。考试的内容是计算 **IOI 函数**。IOI 函数是将 $[1,10^9]$ 之间的整数映射到布尔值（即 $\texttt{True}/\texttt{False}$）的函数。IOI 函数可以从以下六条 IOI 高中规定的规则中构造：

1. 设 $a$ 为 $[1,10^9]$ 之间的整数，则 $\texttt{[a]}$ 是一个 IOI 函数。它将不小于 $a$ 的整数映射成 $\texttt{True}$，将小于 $a$ 的整数映射成 $\texttt{False}$。

2. 记 $\texttt{f}$ 为 IOI 函数，则 $\texttt{(f)}$ 是一个 IOI 函数，它的映射规则与 $\texttt{f}$ 的映射规则相同。

3. 记 $\texttt{f}$ 为 IOI 函数，则 $\texttt{!f}$ 是一个 IOI 函数。设 $x$ 为整数，若 $\texttt{f}$ 将 $x$ 映射为 $\texttt{True}$，则 $\texttt{!f}$ 将 $x$ 映射为 $\texttt{False}$；否则 $\texttt{!f}$ 将 $x$ 映射为 $\texttt{True}$。

4. 记 $\texttt{f},\texttt{g}$ 为 IOI 函数，则 $\texttt{f\&g}$ 也是一个 IOI 函数。设 $x$ 为整数，则 $\texttt{f\&g}$ 将 $x$ 映射为 $\texttt{True}$，当且仅当 $\texttt{f},\texttt{g}$ 都将 $x$ 映射为 $\texttt{True}$。

5. 记 $\texttt{f},\texttt{g}$ 为 IOI 函数，则 $\texttt{f\^ g}$ 也是一个 IOI 函数。设 $x$ 为整数，则 $\texttt{f\^ g}$ 将 $x$ 映射为 $\texttt{True}$，当且仅当 $\texttt{f},\texttt{g}$ 中恰好有一个将 $x$ 映射为 $\texttt{True}$。

6. 记 $\texttt{f},\texttt{g}$ 为 IOI 函数，则 $\texttt{f|g}$ 也是一个 IOI 函数。设 $x$ 为整数，则 $\texttt{f|g}$ 将 $x$ 映射为 $\texttt{True}$，当且仅当 $\texttt{f},\texttt{g}$ 中至少有一个将 $x$ 映射为 $\texttt{True}$。

如果某个 IOI 函数用多条规则构造出，数字更大的规则将决定函数值。例如，对于 $\texttt{[1]\&[2]|[3]}$ 应当应用规则 6，其中 $\texttt{f} = \texttt{[1]\&[2]},\texttt{g} = \texttt{[3]}$（而非应用规则 4，其中 $\texttt{f} = \texttt{[1]},\texttt{g} = \texttt{[2]|[3]}$）。额外地，对于规则 4，5，6，应当最大化 $\texttt{f}$ 的长度。例如，对于 $\texttt{[4]ˆ[5]ˆ[6]}$，应当在 $\texttt{f} = \texttt{[4]ˆ[5]},\texttt{g} = \texttt{[6]}$ 上应用规则 5（而非 $\texttt{f} = \texttt{[4]},\texttt{g} = \texttt{[5]ˆ[6]}$）。

为备战期末考试，JOI 君准备好了一个长度为 $N$ 的 IOI 函数 $S$。他打算用 $Q$ 个整数 $X_1,X_2,\cdots,X_Q$ 来练习他的计算技能。于是他找来了你——能够熟练处理 IOI 函数的人，来解决这个问题。

你需要写一个程序。给定 $N,Q,S$ 以及 $X_1,X_2,\cdots,X_Q$，对于 $i=1,2=\cdots,Q$，回答 IOI 函数 $S$ 会将 $X_i$ 映射成 $\texttt{True}$ 还是 $\texttt{False}$。

## 输入格式

输入格式如下所示：

> $N$ $Q$\
> $S$\
> $X_1$\
> $X_2$\
> $\vdots$\
> $X_Q$
## 输出格式

输出 $Q$ 行，第 $i$ 行为 $\texttt{True}$ 或者 $\texttt{False}$，即 $X_i$ 被 $S$ 映射成的值。
## 样例

### 样例输入 #1
```
15 5
(![2]|[3])&![4]
1
2
3
4
5
```
### 样例输出 #1
```
True
False
True
False
False
```
### 样例输入 #2
```
20 4
(!![23])^((([116])))
54
1
200
89
```
### 样例输出 #2
```
True
False
False
True
```
### 样例输入 #3
```
32 4
[2]|[5]&[1]|(([1000000000])|[7])
4
10
6
1
```
### 样例输出 #3
```
True
True
True
False
```
## 提示


### 样例解释

样例 $1$ 解释如下：

| $X_i$ | $\texttt{![2]}$ | $\texttt{[3]}$ | $\texttt{![2]\|[3]}$ | $\texttt{![4]}$ | $\texttt{(![2]\|[3])\&![4]}$ |
| :--: | :--: | :--: | :--: | :--: | :--: |
| $1$ | $\texttt{True}$ | $\texttt{False}$ | $\texttt{True}$ | $\texttt{True}$ | $\texttt{True}$ |
| $2$ | $\texttt{False}$ | $\texttt{False}$ | $\texttt{False}$ | $\texttt{True}$ | $\texttt{False}$ |
| $3$ |  $\texttt{False}$ | $\texttt{True}$ | $\texttt{True}$ | $\texttt{True}$ | $\texttt{True}$ |
| $4$ | $\texttt{False}$ | $\texttt{True}$ | $\texttt{True}$ | $\texttt{False}$ | $\texttt{False}$ |
| $5$ |  $\texttt{False}$ | $\texttt{True}$ | $\texttt{True}$ | $\texttt{False}$ | $\texttt{False}$ |

样例 $1$ 满足子任务 $3,6,7$ 的条件。

样例 $2$ 满足子任务 $1,3,5\sim 7$ 的条件。

样例 $3$ 满足子任务 $3,4,6,7$ 的条件。	

### 数据范围

- $1 \le N \le 1\,000\,000$；
- $1 \le Q \le 200\,000$；
- $S$ 为长度为 $N$ 的 IOI 函数；
- $1 \le X_i \le 10^9$（$1 \le i \le Q$）；
- $N, Q, X_i$（$1 \le i \le Q$）均为整数。

### 子任务

1. （$5$ points）$S$ 中不含 $\texttt{\&}$ 和 $\texttt{|}$；
2. （$20$ points）$Q = 1$；
3. （$10$ points）$N \le 10\,000$；
4. （$6$ points）$S$ 中不含 $\texttt{!}$ 和 $\texttt{ˆ}$；
5. （$12$ points）当应用规则 4 或 6 来构造 $S$ 时，$\texttt{f}$ 和 $\texttt{g}$ 中至少有一个是用规则 1 得到的；
6. （$20$ points）$N \le 400\, 000$；
7. （$27$ points）无额外约束。

*赛时公告：如果你复制题面中的 LaTeX，可能会得到 `ˆ`，但实际上是 `^`。请特别注意。

由 Starrykiller 根据英文题面翻译。


---

---
title: "BZOJ4998 星球联盟"
layout: "post"
diff: 省选/NOI-
pid: P10657
tag: ['O2优化', '动态树 LCT']
---
# BZOJ4998 星球联盟
## 题目描述

在遥远的 S 星系中一共有 $n$ 个星球，编号为 $1\sim n$。其中的一些星球决定组成联盟，以方便相互间的交流。但是，组成联盟的首要条件就是交通条件。

初始时，在这 $n$ 个星球间有 $m$ 条太空隧道。每条太空隧道连接两个星球，使得它们能够相互到达。若两个星球属于同一个联盟，则必须存在一条环形线路经过这两个星球，即两个星球间存在两条没有公共隧道的路径。为了壮大联盟的队伍，这些星球将建设 $p$ 条新的太空隧道。这 $p$ 条新隧道将按顺序依次建成。一条新轨道建成后，可能会使一些星球属于同一个联盟。

你的任务是计算出，在一条新隧道建设完毕后，判断这条新轨道连接的两个星球是否属于同一个联盟，如果属于同一个联盟就计算出这个联盟中有多少个星球。
## 输入格式

第一行三个整数 $n,m,q$，分别表示总星球数，初始时太空隧道的数目和即将建设的轨道数目。

第 $2\sim m+1$ 行，每行两个整数，表示初始时的每条太空隧道连接的两个星球编号。

第 $m+2$ 行到第 $m+p+1$ 行，每行两个整数，表示新建的太空隧道连接的两个星球编号。

这些太空隧道按照输入的顺序依次建成。
## 输出格式

输出共 $p$ 行：

- 如果这条新的太空隧道连接的两个星球属于同一个联盟，就输出一个整数，表示这两个星球所在联盟的星球数。
- 如果这条新的太空隧道连接的两个星球不属于同一个联盟，就输出 No。
## 样例

### 样例输入 #1
```
5 3 4
1 2
4 3
4 5
2 3
1 3
4 5
2 4
```
### 样例输出 #1
```
No
3
2
5
```
## 提示

![](https://cdn.luogu.com.cn/upload/image_hosting/qo7hp42y.png)

数据保证，$1\leq n,m,p \leq 2\times 10^5$。


---

---
title: "BZOJ2959 长跑"
layout: "post"
diff: 省选/NOI-
pid: P10658
tag: ['O2优化', '动态树 LCT']
---
# BZOJ2959 长跑
## 题目背景

某校开展了同学们喜闻乐见的阳光长跑活动。为了能“为祖国健康工作五十年”，同学们纷纷离开寝室，离开教室，离开实验室，到操场参加 $3000$ 米长跑运动。一时间操场上熙熙攘攘，摩肩接踵，盛况空前。
## 题目描述

为了让同学们更好地监督自己，学校推行了刷卡机制。学校中有 $n$ 个地点，用 $1\sim n$ 的整数表示，每个地点设有若干个刷卡机。

有以下三类事件：
1. 修建了一条连接 $A$ 地点和 $B$ 地点的跑道；
2. $A$ 地点的刷卡机台数变为了 $B$；
3. 进行了一次长跑。问一个同学从 $A$ 地点出发，最后到达 $B$ 地点最多可以刷卡多少次。具体的要求如下：
   - 当同学到达一个地点时，他可以在这里的每一台刷卡机上都刷卡。但每台刷卡机只能刷卡一次，即使多次到达同一地点也不能多次刷卡。为了安全起见，每条跑道都需要设定一个方向，这条跑道只能按照这个方向单向通行。最多的刷卡次数即为在任意设定跑道方向，按照任意路径从 $A$ 地点到 $B$ 地点能刷卡的最多次数。
## 输入格式

第一行输入两个正整数 $n,m$；

第二行输入 $n$ 个正整数，第 $i$ 个正整数为第 $i$ 个地点的刷卡机个数。

接下来 $m$ 行，每行包含三个非负整数 $P,A,B$ 代表一个事件，$P$ 为事件类型，$A,B$ 为事件的两个参数。
## 输出格式

对于每个 $P=3$ 的事件输出一行，包含一个整数，为按照任意路径从 $A$ 地点到 $B$ 地点能刷卡的最多次数。如果不能到达，输出 $-1$。
## 样例

### 样例输入 #1
```
9 31
10 20 30 40 50 60 70 80 90
3 1 2
1 1 3
1 1 2
1 8 9
1 2 4
1 2 5
1 4 6
1 4 7
3 1 8
3 8 8
1 8 9
3 8 8
3 7 5
3 7 3
1 4 1
3 7 5
3 7 3
1 5 7
3 6 5
3 3 6
1 2 4
1 5 5
3 3 6
2 8 180
3 8 8
2 9 190
3 9 9
2 5 150
3 3 6
2 1 210
3 3 6
```
### 样例输出 #1
```
-1
-1
80
170
180
170
190
170
250
280
280
270
370
380
580
```
## 提示

对于所有数据，$1\leq m\leq 5n$，$1\leq n\leq 1.5\times 10^5$。

保证最初所有地点之间都没有跑道。

每行相邻的两个数之间均用一个空格隔开。

表示地点编号的数均在 $1$ 到 $n$ 之间，每个地点的刷卡机台数始终不超过 $10^4$，$P \in \{1,2,3\}$。


---

---
title: "BZOJ3159 决战"
layout: "post"
diff: 省选/NOI-
pid: P10659
tag: ['O2优化', '动态树 LCT']
---
# BZOJ3159 决战
## 题目描述

Katharon 国有 $n$ 个城市，编号为 $1\sim n$。出于勤俭节约，不铺张浪费的考虑，城市间只连有 $n-1$ 条道路，使得可以从一个城市出发沿着道路走到另一座城市。

现在 X 国的飞船降落在了某个城市，并把它改造成了自己的据点。X 国占领其他国家的一贯做法是，在据点里造一堆工厂生产战斗机器人，然后沿着被侵略国的道路运送到其他城市。X 国的司令向来不走回头路，而且崇尚团结与绝对的公平，因此运送战斗机器人时，会先选择一个终点，再在从据点到终点的路径上选择一个起点，然后把机器人均匀分配到起点到终点路径上的每个城市。同时，为了重新分配机器人，X 国的司令还会下令，按照与运送机器人相同的方法选择起点和终点，然后翻转这条路径上城市的机器人的数量。比如，选定的路径上的城市的机器人数依次为 $1,2,3,4,5$，翻转之后就变成了 $5,4,3,2,1$。

Kanari 国王手中的圆盘上浮现出了 Katharon 国的地图。不仅如此,上面还标出了 X 国据点在 $r$ 号城市，并显示出了 X 国司令刚刚下达的指令。“太好了！”国王欢呼，“我们能第一时间掌握敌人的布局，就一定能击退 X 国的侵略者！”

但是还有一个问题没有解决。圆盘上只显示了指令，却没有标出每个城市的机器人数量，这让国王很是头疼。于是他找到了你，想让你帮忙设计一个程序来回答国王的询问。国王只关心某两个点之间路径上的城市的机器人和、最大值以及最小值，以便确定兵力部署、攻击要点和敌方的薄弱点。

X 国司令的指令和 Kanari 国王的询问如下：

1. `Increase x y w` 运送一批机器人到从 $x$ 到 $y$ 的路径上的城市，并分配给每个城市 $w$ 个机器人；
2. `Sum x y` 询问从 $x$ 到 $y$ 的路径上的城市的机器人数量之和。
3. `Major x y` 询问从 $x$ 到 $y$ 的路径上的城市的机器人数量的最大值。
4. `Minor x y` 询问从 $x$ 到 $y$ 的路径上的城市的机器人数量的最小值。
5. `Invert x y` 翻转从 $x$ 到 $y$ 的路径上的城市的机器人数量。

对于 X 国司令的指令，保证给定的 $x,y$ 满足上文所述的要求。对于 Kanari 国王的询问，**不**保证给定的 $x,y$ 满足上述要求。
## 输入格式

第一行有三个整数 $n,m,r$，分别表示树的节点数、指令和询问总数，以及 X 国的据点。

接下来 $n-1$ 行，每行两个整数 $x$ 和 $y$，表示 Katharon 国的一条道路。

接下来 $m$ 行，每行描述一个指令或询问，格式见题目描述。
## 输出格式

对于每个询问操作，输出所求的值。
## 样例

### 样例输入 #1
```
5 8 1
1 2
2 3
3 4
4 5
Sum 2 4
Increase 3 5 3
Minor 1 4
Sum 4 5
Invert 1 3
Major 1 2
Increase 1 5 2
Sum 1 5
```
### 样例输出 #1
```
0
0
6
3
19
```
## 提示

数据保证，$1\leq n,m\leq 5\times 10^4$，且对于运送操作 $1\leq w\leq 10^3$。


---

---
title: "BZOJ2759 一个动态树好题"
layout: "post"
diff: 省选/NOI-
pid: P10660
tag: ['O2优化', '动态树 LCT', '扩展欧几里德算法']
---
# BZOJ2759 一个动态树好题
## 题目描述

有 $n$ 个未知数 $x_1,x_2,\dots,x_n$ 和 $n$ 个等式组成的同余方程组：$x_i\equiv k_i\times x_{p_i} + b_i \pmod {10007}$。

你需要进行 $q$ 次操作，每次操作为下列两种情况之一：
- `A a`，询问当前 $x_a$ 的解，无解输出 `-1`，多解输出 `-2` 否则输出 $x_a$。
- `C a x y z`，修改一个等式 $k_a \gets x,p_a \gets y,b_a \gets z$。
## 输入格式

第一行一个整数 $n$。

接下来 $n$ 行，每行三个整数 $k_i,p_i,b_i$。

接下来一行一个整数 $q$。

再接下来 $q$ 行，每行一个操作，见题意所述。
## 输出格式

对每个询问，输出一行一个整数。
## 样例

### 样例输入 #1
```
5
2 2 1
2 3 2
2 4 3
2 5 4
2 3 5
5
A 1
A 2
C 5 3 1 1
A 4
A 5
```
### 样例输出 #1
```
4276
7141
4256
2126
```
## 提示

对于所有数据，$k_i,b_i,x_i \in [0,10007) \cap \Z$。$1\leq n\leq 3\times 10^4$，$0\leq q\leq 10^5$，其中询问操作占总操作数的约 $80\%$。


---

---
title: "BZOJ3779 重组病毒"
layout: "post"
diff: 省选/NOI-
pid: P10661
tag: ['Special Judge', 'O2优化', '动态树 LCT']
---
# BZOJ3779 重组病毒
## 题目背景

黑客们通过对已有的病毒反编译，将许多不同的病毒重组，并重新编译出了新型的重组病毒。这种病毒的繁殖和变异能力极强。为了阻止这种病毒传播，某安全机构策划了一次实验，来研究这种病毒。
## 题目描述

实验在一个封闭的局域网内进行。局域网内有 $n$ 台计算机，编号为 $1\sim n$。一些计算机之间通过网线直接相连，形成树形的结构。局域网中有一台特殊的计算机，称之为核心计算机。根据一些初步的研究，研究员们拟定了一个一共 $m$ 步的实验。实验开始之前，核心计算机的编号为 $1$，每台计算机中都有病毒的一个变种，而且每台计算机中的变种都不相同。实验中的每一步会是下面中的一种操作：

- `RELEASE x`。在编号为 $x$ 的计算机中植入病毒的一个新变种。这个变种在植入之前不存在于局域网中。
- `RECENTER x`。将核心计算机改为编号为 $x$ 的计算机。但是这个操作会导致原来核心计算机中的病毒产生新变种，并感染过来。换言之，假设操作前的核心计算机编号为 $y$，相当于在操作后附加了一次 `RELEASE y` 的操作。

根据研究的结论，在植入一个新变种时，病毒会在局域网中搜索核心计算机的位置，并沿着网络中最短的路径感染过去。

而第一轮实验揭露了一个惊人的真相：病毒的不同变种是互斥的。新变种在感染一台已经被旧变种感染的电脑时，会把旧变种完全销毁之后再感染。但研究员发现了实现过程中的漏洞。如果新变种在感染过程中尚未销毁过这类旧变种，需要先花费 $1$ 单位时间分析旧变种，才能销毁。如果之前销毁过这类旧变种，就可以认为销毁不花费时间。病毒在两台计算机之间的传播亦可认为不花费时间。

研究员对整个感染过程的耗时特别感兴趣，因为这是消灭病毒的最好时机。于是在 $m$ 步步实验之中，研究员有时还会做出如下的询问：

- `REQUEST x`。询问如果在编号为 $x$ 的计算机的关键集合中的计算机中植入一个新变种，平均感染时间为多长。编号为 $y$ 的计算机在编号为 $x$ 的计算机的关键集合中，当且仅当从 $y$ 沿网络中的最短路径感染到核心计算机必须经过 $x$。由于有 `RECENTER` 操作的存在，这个集合并不一定是始终不变的。

至此，安全机构认为已经不需要实际的实验了，于是他们拜托你编写一个程序，模拟实验的结果，并回答所有的询问。
## 输入格式

输入的第一行包含两个整数 $n$ 和 $m$，分别代表局域网中计算机的数量，以及操作和询问的总数。

接下来 $n-1$ 行，每行包含两个整数 $x$ 和 $y$，表示局域网中编号为 $x$ 和 $y$ 的计算机之间有网线直接相连。

接下来 $m$ 行，每行包含一个操作或者询问，格式如问题描述中所述。
## 输出格式

对于每个询问，输出一个实数，代表平均感染时间。输出与答案的绝对误差不超过 $10^{-6}$ 时才会被视为正确。
## 样例

### 样例输入 #1
```
8 6
1 2
1 3
2 8
3 4
3 5
3 6
4 7
REQUEST 7
RELEASE 3
REQUEST 3
RECENTER 5
RELEASE 2
REQUEST 1
```
### 样例输出 #1
```
4.0000000000
2.0000000000
1.3333333333
```
## 提示

对于 $100\%$ 的数据，$1\leq n\leq 10^5$，$1\leq m\leq 10^5$。


---

---
title: "BZOJ4202 石子游戏"
layout: "post"
diff: 省选/NOI-
pid: P10662
tag: ['O2优化', '动态树 LCT']
---
# BZOJ4202 石子游戏
## 题目描述

石子游戏是大家都很喜欢玩的一类游戏，这类游戏通常与石子的移动和取舍有关，往往可以让人在游戏中获得不少的乐趣。

有一类树上石子游戏的规则是这样的：在一棵有根树上，每个结点都有着一定数目的石子，两个玩家轮流进行游戏。每次，每个玩家可以把不超过 $m$ 个的石子移动到它的父亲上，一次只能移动一个结点上的石子。显然，根结点没有父亲，故每个石子一旦移动到根结点便无法再次移动。问题是以某个结点为根的子树进行这样的游戏，是否存在先手必胜策略。

为了增加这个游戏的难度，我们对这个游戏进行一些小小的修改。现在，我们的这棵树可能会长出新的结点。同时，每个结点上的石子数目可能会变化。请问，以某个节点为根的子树进行这样的石子游戏，是否存在先手必胜策略。本题要求强制在线。
## 输入格式

第一行包含两个整数 $n,m$，表示初始时有 $n$ 个结点，每次移动不能超过 $m$ 个石子。

第二行 $n$ 个正整数 $a_1,a_2,\dots,a_n$，表示初始时候的石子数量，其中 $1$ 号结点为根结点。

接下来 $n-1$ 行，每行两个整数 $u,v$，表示有一条从 $u$ 到 $v$ 的边。

接下来一行一个正整数 $t$，表示操作的数目。

接下来 $t$ 行，每行代表一个操作，每行的第一个数字代表操作类型，其中：

- 若为 $1$，后跟一个整数 $v$，表示询问在 $v$ 的子树中做游戏先手是否必胜。
- 若为 $2$，后跟两个整数 $x,y$，表示将结点 $x$ 的石子数修改为 $y$。
- 若为 $3$，后跟三个整数 $u,v,x$，表示为 $u$ 结点添加一个儿子 $v$，其初始石子数为 $x$。
## 输出格式

对于每一个询问，若先手必胜输出 `Yes`，否则输出 `No`。

注：数据进行了强制在线处理，对于每一个操作，除类型名外，都需要异或之前回答为 `Yes` 的数目。
## 样例

### 样例输入 #1
```
2 1000
0 0
1 2
1
1 1
```
### 样例输出 #1
```
No
```
## 提示

对于 $100\%$ 的数据，$1\leq n,t\leq 5\times 10^4$，同时，保证任何时刻树中节点数目和编号都不会超过 $10^5$。其余数据的范围皆在 int 范围内。


---

---
title: "[CERC 2020] Screamers"
layout: "post"
diff: 省选/NOI-
pid: P13661
tag: ['2020', '动态树 LCT', 'ICPC', 'CERC']
---
# [CERC 2020] Screamers
## 题目描述

The police is preparing a huge sting in which they hope to jail most of the prominent criminal figures in the city. The flow of information on the side of the police has to be as tight as possible to prevent any leaks. Each detective officer (DO) taking part in the sting is under a strict regulation.

The information shared among DOs is in the form of so-called drops. A drop is always spoken, it must not be recorded on any medium, electronics, paper, etc. Any DO can share a drop only with selected DOs with which he shares a bidirectional connection. Each DO is obliged to pass the drop, as soon as possible and without any change, to all his buddies with which he shares a connection, except for the DO from which he received the drop.

The Chieft Inspector (CI) has to choose which pairs of DOs will share a connection. This final set of connections is called the final group. In this final group (FG) an additional FG-rule holds: A situation when a drop returns to a DO who passed it to his buddies some time ago must not happen. It would mean there are too many unnecessary connections in the FG network.

There is a stack of folders, each folder describing one connection between a particular pair of DOs. The selection of FG is done in two steps. First, CI chooses two integer values $S$ and $T$, which may be sometimes the same, and removes from the stack all folders above the $S$-th folder and all folders below the $T$-th folder.

Next, with the reduced folders, CI repeats the operation. He chooses two integer values $U$ and $V$, which may be sometimes the same, and removes from the reduced stack all folders above the $U$-th folder and all folders below the $V$-th folder.

CI wants to use all the connections in the remaining folders in the FG. However, it is not guaranteed that connections can form FG, due to the additional FG-rule. CI tends to forget this rule quite often.

One cannot change the professional habits of CI. His assistant tries to address the issue diplomatically by employing a programmer who would gradually computerize the process. His first task is to compute the number of different FGs that may be selected by CI after he has chosen the first two values $S$ and $T$. This computation must be efficient for many different values of $S$ and $T$.
## 输入格式

The first input line contains two numbers, $N$ and $M$ ($1 \leq N, M \leq 10^5$), the number of DOs and the number of folders in the CI’s stack respectively. The DOs are identified by integers $1 \ldots N$. Next, there are $M$ lines, each represents one folder and it contains two integers $A$ and $B$ ($1 \leq A < B \leq N$), pair of DOs whose connection is described in the folder. The order of lines corresponds to the order of folders in the stack from top to bottom.

The next line contains one number $Q$ ($1 \leq Q \leq 10^5$), the number of queries. Next, there are $Q$ lines, each represents one query and it contains two positive integers $S$ and $T$ ($1 \leq S \leq T \leq M$), the numbers chosen by CI in the first step of FG selection.

## 输出格式

For each of the $Q$ query input lines print the number of different FGs which can be formed in the second step of the selection process.
## 样例

### 样例输入 #1
```
4 6
1 2
2 3
1 3
1 4
3 4
2 4
4
1 1
1 3
2 4
1 6
```
### 样例输出 #1
```
1
5
6
13
```


---

---
title: "[国家集训队] Tree II"
layout: "post"
diff: 省选/NOI-
pid: P1501
tag: ['集训队互测', '动态树 LCT']
---
# [国家集训队] Tree II
## 题目描述

一棵 $n$ 个点的树，每个点的初始权值为 $1$。  
对于这棵树有 $q$ 个操作，每个操作为以下四种操作之一：

- `+ u v c`：将 $u$ 到 $v$ 的路径上的点的权值都加上自然数 $c$；
- `- u1 v1 u2 v2`：将树中原有的边 $(u_1,v_1)$ 删除，加入一条新边 $(u_2,v_2)$，保证操作完之后仍然是一棵树；
- `* u v c`：将 $u$ 到 $v$ 的路径上的点的权值都乘上自然数 $c$；
- `/ u v`：询问 $u$ 到 $v$ 的路径上的点的权值和，将答案对 $51061$ 取模。

## 输入格式

第一行两个整数 $n,q$。

接下来 $n-1$ 行每行两个正整数 $u,v$，描述这棵树的每条边。

接下来 $q$ 行，每行描述一个操作。

## 输出格式

对于每个询问操作，输出一行一个整数表示答案。

## 样例

### 样例输入 #1
```
3 2
1 2
2 3
* 1 3 4
/ 1 1
```
### 样例输出 #1
```
4

```
## 提示

【数据范围】   
对于 $10\%$ 的数据，$1\le n,q \le 2000$；   
另有 $15\%$ 的数据，$1 \le n,q \le 5\times 10^4$，没有 `-` 操作，并且初始树为一条链；    
另有 $35\%$ 的数据，$1 \le n,q \le 5\times 10^4$，没有 `-` 操作；  
对于 $100\%$ 的数据，$1\le n,q \le 10^5$，$0\le c \le 10^4$。

By (伍一鸣)



---

---
title: "[NOIP 2016 提高组] 天天爱跑步"
layout: "post"
diff: 省选/NOI-
pid: P1600
tag: ['2016', '线段树', 'NOIP 提高组', '最近公共祖先 LCA', '树链剖分', '动态树 LCT', '差分']
---
# [NOIP 2016 提高组] 天天爱跑步
## 题目背景

NOIP2016 提高组 D1T2
## 题目描述

小 C 同学认为跑步非常有趣，于是决定制作一款叫做《天天爱跑步》的游戏。《天天爱跑步》是一个养成类游戏，需要玩家每天按时上线，完成打卡任务。

这个游戏的地图可以看作一棵包含 $n$ 个结点和 $n-1$ 条边的树，每条边连接两个结点，且任意两个结点存在一条路径互相可达。树上结点编号为从 $1$ 到 $n$ 的连续正整数。

现在有 $m$ 个玩家，第 $i$ 个玩家的起点为 $s_i$，终点为 $t_i$。每天打卡任务开始时，所有玩家在第 $0$ 秒同时从自己的起点出发，以每秒跑一条边的速度，不间断地沿着最短路径向着自己的终点跑去，跑到终点后该玩家就算完成了打卡任务。（由于地图是一棵树，所以每个人的路径是唯一的）

小 C 想知道游戏的活跃度，所以在每个结点上都放置了一个观察员。在结点 $j$ 的观察员会选择在第 $w_j$ 秒观察玩家，一个玩家能被这个观察员观察到当且仅当该玩家在第 $w_j$ 秒也正好到达了结点 $j$。小 C 想知道每个观察员会观察到多少人?

注意：我们认为一个玩家到达自己的终点后该玩家就会结束游戏，他不能等待一 段时间后再被观察员观察到。 即对于把结点 $j$ 作为终点的玩家：若他在第 $w_j$ 秒前到达终点，则在结点 $j$ 的观察员不能观察到该玩家；若他正好在第 $w_j$ 秒到达终点，则在结点 $j$ 的观察员可以观察到这个玩家。

## 输入格式

第一行有两个整数 $n$ 和 $m$。其中 $n$ 代表树的结点数量, 同时也是观察员的数量, $m$ 代表玩家的数量。

接下来 $n-1$ 行每行两个整数 $u$ 和 $v$，表示结点 $u$ 到结点 $v$ 有一条边。

接下来一行 $n$ 个整数，其中第 $j$ 个整数为 $w_j$ , 表示结点 $j$ 出现观察员的时间。

接下来 $m$ 行，每行两个整数 $s_i$，和 $t_i$，表示一个玩家的起点和终点。

对于所有的数据，保证 $1\leq s_i,t_i\leq n, 0\leq w_j\leq n$。

## 输出格式

输出 $1$ 行 $n$ 个整数，第 $j$ 个整数表示结点 $j$ 的观察员可以观察到多少人。

## 样例

### 样例输入 #1
```
6 3
2 3
1 2 
1 4 
4 5 
4 6 
0 2 5 1 2 3 
1 5 
1 3 
2 6 
```
### 样例输出 #1
```
2 0 0 1 1 1 
```
### 样例输入 #2
```
5 3 
1 2 
2 3 
2 4 
1 5 
0 1 0 3 0 
3 1 
1 4
5 5 
```
### 样例输出 #2
```
1 2 1 0 1 
```
## 提示

**样例 1 说明**

对于 $1$ 号点，$w_i=0$，故只有起点为 $1$ 号点的玩家才会被观察到，所以玩家 $1$ 和玩家 $2$ 被观察到，共有 $2$ 人被观察到。

对于 $2$ 号点，没有玩家在第 $2$ 秒时在此结点，共 $0$ 人被观察到。

对于 $3$ 号点，没有玩家在第 $5$ 秒时在此结点，共 $0$ 人被观察到。

对于 $4$ 号点，玩家 $1$ 被观察到，共 $1$ 人被观察到。

对于 $5$ 号点，玩家 $1$ 被观察到，共 $1$ 人被观察到。

对于 $6$ 号点，玩家 $3$ 被观察到，共 $1$ 人被观察到。

**子任务**

每个测试点的数据规模及特点如下表所示。 

提示：数据范围的个位上的数字可以帮助判断是哪一种数据类型。

| 测试点编号 | $n=$ | $m=$ | 约定 |
| :--------: | :----: | :----: | :----: |
|     $1\sim 2$      |  $991$   |  $991$   | 所有人的起点等于自己的终点，即 $\forall i,\ s_i=t_i$  |
|     $3\sim 4$      |  $992$   |  $992$   | 所有 $w_j=0$  |
|     $5$      |  $993$   |  $993$   | 无  |
|     $6\sim 8$      |  $99994$   |  $99994$   | $\forall i\in[1,n-1]$，$i$ 与 $i+1$ 有边。即树退化成 $1,2,\dots,n$ 按顺序连接的链  |
|     $9\sim 12$      |  $99995$   |  $99995$   | 所有 $s_i=1$  |
|     $13\sim 16$      |  $99996$   |  $99996$   | 所有 $t_i=1$  |
|     $17\sim 19$      |  $99997$   |  $99997$   | 无  |
|     $20$      |  $299998$   |  $299998$   | 无  |



**提示**

（提示：由于原提示年代久远，不一定能完全反映现在的情况，现在已经对该提示做出了一定的修改，提示的原文可以在[该剪贴板](https://www.luogu.com.cn/paste/3fneb8m6)查看）

在最终评测时，调用栈占用的空间大小不会有单独的限制，但在我们的工作环境中默认会有 $1 \text{MiB}$ 的限制。 这可能会引起**函数调用层数较多时，程序发生栈溢出崩溃**，程序中**较深层数的递归**往往会导致这个问题。如果你的程序需要用到较大的栈空间，请务必注意该问题。

我们可以使用一些方法修改调用栈的大小限制。

- Linux

我们可以在终端中输入下列命令：`ulimit -s 1048576`。此命令的意义是，将调用栈的大小限制修改为 $1048576\text{KiB}=1 \text{GiB}$。

例如，对于如下程序 `sample.cpp`：

```cpp
#include <bits/stdc++.h>
using namespace std;
int f[1000005];
void dfs(int a){
	if(a == 0){
		f[a] = 0;
		return;
	}
	dfs(a - 1);
	f[a] = f[a - 1] + 1;
}
int main(){
	dfs(1000000);
	return 0;
}
```

将上述源代码用命令 `g++ sample.cpp -o sample` 编译为可执行文件 `sample` 后，使用 `./sample` 执行程序。

如果在没有使用命令 `ulimit -s 1048576` 的情况下运行该程序，`sample` 会因为栈溢出而崩溃；如果使用了上述命令后运行该程序，该程序则不会崩溃。

特别地，当你打开多个终端时，它们并不会共享该命令，你需要分别对它们运行该命令。

请注意，调用栈占用的空间会计入总空间占用中，和程序其他部分占用的内存共同受到内存限制。

- Windows

如果你使用 Windows 下的 Dev-C++，请选择 `工具-编译选项` 并在如下区域填入以下命令 `-Wl,--stack=1073741824`，填入后注意确认“编译时加入以下命令的”的框是**已勾选**状态。

此处 `1073741824` 的单位是 $\text{B/Bytes}$。

![](https://cdn.luogu.com.cn/upload/image_hosting/z6mbzfqo.png)  ![](https://cdn.luogu.com.cn/upload/image_hosting/zvrzkyq5.png)


---

---
title: "[SDOI2008] 洞穴勘测"
layout: "post"
diff: 省选/NOI-
pid: P2147
tag: ['2008', '各省省选', '平衡树', '山东', '动态树 LCT']
---
# [SDOI2008] 洞穴勘测
## 题目描述

辉辉热衷于洞穴勘测。

某天，他按照地图来到了一片被标记为JSZX的洞穴群地区。经过初步勘测，辉辉发现这片区域由n个洞穴（分别编号为1到n）以及若干通道组成，并且每条通道连接了恰好两个洞穴。假如两个洞穴可以通过一条或者多条通道按一定顺序连接起来，那么这两个洞穴就是连通的，按顺序连接在一起的这些通道则被称之为这两个洞穴之间的一条路径。 洞穴都十分坚固无法破坏，然而通道不太稳定，时常因为外界影响而发生改变，比如，根据有关仪器的监测结果，123号洞穴和127号洞穴之间有时会出现一条通道，有时这条通道又会因为某种稀奇古怪的原因被毁。

辉辉有一台监测仪器可以实时将通道的每一次改变状况在辉辉手边的终端机上显示：

如果监测到洞穴u和洞穴v之间出现了一条通道，终端机上会显示一条指令 `Connect u v`

如果监测到洞穴u和洞穴v之间的通道被毁，终端机上会显示一条指令 `Destroy u v`

经过长期的艰苦卓绝的手工推算，辉辉发现一个奇怪的现象：无论通道怎么改变，任意时刻任意两个洞穴之间至多只有一条路径。

因而，辉辉坚信这是由于某种本质规律的支配导致的。因而，辉辉更加夜以继日地坚守在终端机之前，试图通过通道的改变情况来研究这条本质规律。 然而，终于有一天，辉辉在堆积成山的演算纸中崩溃了……他把终端机往地面一砸（终端机也足够坚固无法破坏），转而求助于你，说道：“你老兄把这程序写写吧”。

辉辉希望能随时通过终端机发出指令 `Query u v`，向监测仪询问此时洞穴u和洞穴v是否连通。现在你要为他编写程序回答每一次询问。 已知在第一条指令显示之前，JSZX洞穴群中没有任何通道存在。

## 输入格式

第一行为两个正整数n和m，分别表示洞穴的个数和终端机上出现过的指令的个数。 以下m行，依次表示终端机上出现的各条指令。每行开头是一个表示指令种类的字符串s（"Connect”、”Destroy”或者”Query”，区分大小写），之后有两个整数u和v (1≤u, v≤n) 分别表示两个洞穴的编号。

## 输出格式

对每个Query指令，输出洞穴u和洞穴v是否互相连通：是输出”Yes”，否则输出”No”。（不含双引号）

## 样例

### 样例输入 #1
```
200 5
Query 123 127
Connect 123 127
Query 123 127
Destroy 127 123
Query 123 127
```
### 样例输出 #1
```
No
Yes
No

```
### 样例输入 #2
```
3 5
Connect 1 2
Connect 3 1
Query 2 3
Destroy 1 3
Query 2 3
```
### 样例输出 #2
```
Yes
No
```
## 提示

数据说明


10%的数据满足n≤1000, m≤20000

20%的数据满足n≤2000, m≤40000

30%的数据满足n≤3000, m≤60000

40%的数据满足n≤4000, m≤80000

50%的数据满足n≤5000, m≤100000

60%的数据满足n≤6000, m≤120000

70%的数据满足n≤7000, m≤140000

80%的数据满足n≤8000, m≤160000

90%的数据满足n≤9000, m≤180000

100%的数据满足n≤10000, m≤200000


保证所有Destroy指令将摧毁的是一条存在的通道

本题输入、输出规模比较大，建议c\c++选手使用scanf和printf进行I\O操作以免超时

---

@namespace_std 于 2019.12.1 添加一组 Hack 数据


---

---
title: "[ZJOI2012] 网络"
layout: "post"
diff: 省选/NOI-
pid: P2173
tag: ['2012', '各省省选', '平衡树', '浙江', '动态树 LCT']
---
# [ZJOI2012] 网络
## 题目描述

有一个无向图 $G$，每个点有个权值，每条边有一个颜色。这个无向图满足以下两个条件：

1、 对于任意节点连出去的边中，相同颜色的边不超过两条。

2、图中不存在同色的环，同色的环指相同颜色的边构成的环。

在这个图上，你要支持以下三种操作：

- `0 x y` 表示把节点 $x$ 的权值改为 $y$

- `1 u v w` 表示将边 $(u,v)$ 的颜色改为 $w$。  

- `2 c u v` 表示查询由颜色 $c$ 的边构成的图中，所有可能在 $u \to v$ 之间的简单路径上的节点的权值的最大值。

## 输入格式

第一行四个正整数 $n,m,C,k$，分别表示节点数、边数、颜色数和操作数。

接下来 $n$ 行，每行一个正整数 $v_i$，为节点 $i$ 的权值。

之后 $m$ 行，每行三个正整数 $u,v,w$，为一条连接 $u,v$ 节点的边，颜色为$w$。

最后 $k$ 行，每行若干个正整数，表示一次操作。
## 输出格式

输出若干行，每行输出一个对应的信息。

1、 对于修改节点权值操作，不需要输出信息。

2、对于修改边的颜色操作，按以下几类输出：

- 若不存在连接节点 $u$ 和节点 $v$ 的边，输出 `No such edge.`。

- 若修改后不满足条件 $1$，不修改边的颜色，并输出 `Error 1.`。

- 若修改后不满足条件 $2$，不修改边的颜色，并输出 `Error 2.`。

- 其他情况，成功修改边的颜色，并输出 `Success.`。

输出满足条件的第一条信息即可，即若同时不满足条件 $1,2$ ，则只需要输出`Error 1.`。

3、 对于查询操作，输出一个整数表示答案。若 $u,v$ 之间没有颜色 $c$ 构成的路径，则输出 $-1$。

## 样例

### 样例输入 #1
```
4 5 2 7
1
2
3
4
1 2 0
1 3 1
2 3 0
2 4 1
3 4 0
2 0 1 4
1 1 2 1
1 4 3 1
2 0 1 4
1 2 3 1
0 2 5
2 1 1 4
```
### 样例输出 #1
```
4
Success.
Error 2.
-1
Error 1.
5
```
## 提示

 ![](https://cdn.luogu.com.cn/upload/pic/1714.png) 

颜色 $0$ 为实线的边，颜色 $1$ 为虚线的边，

由颜色 $0$ 构成的从节点 $1$ 到节点 $4$ 的路径有 $1 \to 2 \to 4$，故$\max\{v_1, v_2, v_4\} = \max\{ 1, 2, 4 \} = 4$。

将连接节点 $1$ 和节点 $2$ 的边修改为颜色 $1$，修改成功，输出 `Success.`

将连接节点 $4$ 和节点 $3$ 的边修改为颜色 $1$，由于修改后会使得存在由颜色 $1$ 构成的环( $1 – 2 – 4 – 3 – 1$ )，不满足条件 $2$，故不修改，并输`Error 2`。

不存在颜色 $0$ 构成的从节点 $1$ 到节点 $4$ 的边，输出 `-1`。

将连接节点 $2$ 和节点 $3$ 的边修改为颜色 $1$，由于修改后节点 $2$ 的连出去的颜色为 $1$ 的边有 $3$ 条，故不满足条件 $1$，故不修改，并输出`Error 1.` 。

将节点 $2$ 的权值修改为 $5$。

由颜色 $1$ 构成的从节点 $1$ 到节点 $4$ 的路径有 $1 \to 2 \to 4$，故$\max\{v_1, v_2, v_4\} = \max\{ 1, 5, 4 \} = 5$。

【数据范围】

对于 $30\%$ 的数据：$n ≤ 1000$，$m ≤ 10^4$，$k ≤ 1000$；   
另有 $20\%$ 的数据：$n ≤ 10^4$，$m ≤ 10^5$，$C = 1$，$k ≤ 10^5$；   
对于 $100\%$ 的数据：$n ≤ 10^4$，$m ≤ 10^5$，$C ≤ 10$，$k ≤ 10^5$。  

$1\le u,v,x \le n$，$0 \le c < C$，保证图中没有重边和自环。



---

---
title: "[NOI2014] 魔法森林"
layout: "post"
diff: 省选/NOI-
pid: P2387
tag: ['2014', 'NOI', '生成树', '动态树 LCT']
---
# [NOI2014] 魔法森林
## 题目背景

[hack数据的提交link](https://www.luogu.com.cn/problem/U163126)
## 题目描述

为了得到书法大家的真传，小 E 同学下定决心去拜访住在魔法森林中的隐士。魔法森林可以被看成一个包含 $n$ 个节点 $m$ 条边的无向图，节点标号为 $1,2,3,…,n$，边标号为 $1,2,3,…,m$。初始时小 E 同学在 $1$ 号节点，隐士则住在 $n$ 号节点。小 E 需要通过这一片魔法森林，才能够拜访到隐士。

魔法森林中居住了一些妖怪。每当有人经过一条边的时候，这条边上的妖怪 就会对其发起攻击。幸运的是，在 $1$ 号节点住着两种守护精灵：A 型守护精灵与 B 型守护精灵。小 E 可以借助它们的力量，达到自己的目的。

只要小 E 带上足够多的守护精灵，妖怪们就不会发起攻击了。具体来说，无向图中的每一条边 $e_i$ 包含两个权值 $a_i$ 与 $b_i$ 。若身上携带的 A 型守护精灵个数不少于 $a_i$ ，且 B 型守护精灵个数不少于 $b_i$ ，这条边上的妖怪就不会对通过这条边的人发起攻击。当且仅当通过这片魔法森林的过程中没有任意一条边的妖怪向 小 E 发起攻击，他才能成功找到隐士。

由于携带守护精灵是一件非常麻烦的事，小 E 想要知道，要能够成功拜访到 隐士，最少需要携带守护精灵的总个数。守护精灵的总个数为 A 型守护精灵的个数与 B 型守护精灵的个数之和。

## 输入格式

输入文件的第 $1$ 行包含两个整数 $n,m$，表示无向图共有 $n$ 个节点，$m$ 条边。 接下来 $m$ 行，第 $i+1$ 行包含 $4$ 个正整数 $X_i,Y_i,a_i,b_i$，描述第 $i$ 条无向边。 其中 $X_i$ 与 $Y_i$ 为该边两个端点的标号，$a_i$ 与 $b_i$ 的含义如题所述。 注意数据中可能包含重边与自环。

## 输出格式

输出一行一个整数：如果小 E 可以成功拜访到隐士，输出小 E 最少需要携 带的守护精灵的总个数；如果无论如何小 E 都无法拜访到隐士，输出 `-1`。

## 样例

### 样例输入 #1
```
4 5 
1 2 19 1 
2 3 8 12 
2 4 12 15 
1 3 17 8 
3 4 1 17 
```
### 样例输出 #1
```
32

```
### 样例输入 #2
```
3 1 
1 2 1 1 
```
### 样例输出 #2
```
-1
```
## 提示

\* 解释1

如果小 E 走路径 $1\to 2\to 4$，需要携带 $19+15=34$ 个守护精灵； 如果小 E 走路径 $1\to 3\to 4$，需要携带 $17+17=34$ 个守护精灵； 如果小 E 走路径 $1\to 2\to 3\to 4$，需要携带 $19+17=36$ 个守护精灵； 如果小 E 走路径  $1\to 3\to 2\to 4$，需要携带 $17+15=32$ 个守护精灵。 综上所述，小 E 最少需要携带 $32$ 个守护精灵。

\* 解释2

小 E 无法从 $1$ 号节点到达 $3$ 号节点，故输出 `-1`。

![](https://cdn.luogu.com.cn/upload/pic/2593.png)



---

---
title: "[SDOI2011] 染色"
layout: "post"
diff: 省选/NOI-
pid: P2486
tag: ['2011', '线段树', '各省省选', '山东', '树链剖分', '动态树 LCT']
---
# [SDOI2011] 染色
## 题目描述

给定一棵 $n$ 个节点的无根树，共有 $m$  个操作，操作分为两种：

1. 将节点 $a$ 到节点 $b$ 的路径上的所有点（包括 $a$ 和 $b$）都染成颜色 $c$。
2. 询问节点 $a$ 到节点 $b$ 的路径上的颜色段数量。

颜色段的定义是极长的连续相同颜色被认为是一段。例如 `112221` 由三段组成：`11`、`222`、`1`。
## 输入格式

输入的第一行是用空格隔开的两个整数，分别代表树的节点个数 $n$ 和操作个数 $m$。

第二行有 $n$ 个用空格隔开的整数，第 $i$ 个整数 $w_i$ 代表结点 $i$ 的初始颜色。

第 $3$ 到第 $(n + 1)$ 行，每行两个用空格隔开的整数 $u, v$，代表树上存在一条连结节点 $u$ 和节点 $v$ 的边。

第 $(n + 2)$ 到第 $(n + m + 1)$ 行，每行描述一个操作，其格式为：

每行首先有一个字符 $op$，代表本次操作的类型。

- 若 $op$ 为 `C`，则代表本次操作是一次染色操作，在一个空格后有三个用空格隔开的整数 $a, b, c$，代表将 $a$ 到 $b$ 的路径上所有点都染成颜色 $c$。
- 若 $op$ 为 `Q`，则代表本次操作是一次查询操作，在一个空格后有两个用空格隔开的整数 $a, b$，表示查询 $a$ 到 $b$ 路径上的颜色段数量。
## 输出格式

对于每次查询操作，输出一行一个整数代表答案。
## 样例

### 样例输入 #1
```
6 5
2 2 1 2 1 1
1 2
1 3
2 4
2 5
2 6
Q 3 5
C 2 1 1
Q 3 5
C 5 1 2
Q 3 5

```
### 样例输出 #1
```
3
1
2

```
## 提示

#### 数据规模与约定

对于 $100\%$ 的数据，$1 \leq n, m \leq 10^5$，$1 \leq w_i, c \leq 10^9$，$1 \leq a, b, u, v \leq n$，$op$ 一定为 `C` 或 `Q`，保证给出的图是一棵树。

除原数据外，还存在一组不计分的 hack 数据。



---

---
title: "[HNOI2010] 弹飞绵羊"
layout: "post"
diff: 省选/NOI-
pid: P3203
tag: ['2010', '各省省选', '湖南', '动态树 LCT', '分块']
---
# [HNOI2010] 弹飞绵羊
## 题目描述

某天，Lostmonkey 发明了一种超级弹力装置，为了在他的绵羊朋友面前显摆，他邀请小绵羊一起玩个游戏。  

游戏一开始，Lostmonkey 在地上沿着一条直线摆上 $n$ 个装置，每个装置设定初始弹力系数 $k_i$，当绵羊达到第 $i$ 个装置时，它会往后弹 $k_i$ 步，达到第 $i+k_i$ 个装置，若不存在第 $i+k_i$ 个装置，则绵羊被弹飞。  

绵羊想知道当它从第 $i$ 个装置起步时，被弹几次后会被弹飞。为了使得游戏更有趣，Lostmonkey 可以修改某个弹力装置的弹力系数，任何时候弹力系数均为正整数。

## 输入格式

第一行包含一个整数 $n$，表示地上有 $n$ 个装置，装置的编号从 $0 \sim n-1$。

接下来一行有 $n$ 个正整数，依次为那 $n$ 个装置的初始弹力系数。

第三行有一个正整数 $m$，表示操作次数。接下来 $m$ 行每行至少有两个数 $i,j$。  

- 若 $i=1$，你要输出从编号为 $j$ 的装置出发被弹几次后被弹飞  

- 若 $i=2$，则还会再输入一个正整数 $k$，表示编号为 $j$ 的弹力装置的系数被修改成 $k$。
## 输出格式

对于每个 $i=1$ 的操作，输出一行一个整数表示答案。

## 样例

### 样例输入 #1
```
4
1 2 1 1
3
1 1
2 1 1
1 1
```
### 样例输出 #1
```
2
3
```
## 提示

【数据范围】   
对于 $20\%$ 的数据，$1 \le n,m \le 10^4$；   
对于 $100\%$ 的数据，$1\le n \le 2\times 10^5$，$1\le m \le 10^5$。



---

---
title: "[HNOI2010] 城市建设"
layout: "post"
diff: 省选/NOI-
pid: P3206
tag: ['2010', '湖南', '分治', '生成树', '动态树 LCT']
---
# [HNOI2010] 城市建设
## 题目描述

PS 国是一个拥有诸多城市的大国。国王 Louis 为城市的交通建设可谓绞尽脑汁。Louis 可以在某些城市之间修建道路，在不同的城市之间修建道路需要不同的花费。

Louis 希望建造最少的道路使得国内所有的城市连通。但是由于某些因素，城市之间修建道路需要的花费会随着时间而改变。Louis 会不断得到某道路的修建代价改变的消息。他希望每得到一条消息后能立即知道使城市连通的最小花费总和。Louis 决定求助于你来完成这个任务。

## 输入格式

第一行包含三个整数 $n,m,q$，分别表示城市的数目，可以修建的道路个数，及收到的消息个数。

接下来 $m$ 行，第 $i+1$ 行有三个用空格隔开的整数 $x_i,y_i,z_i$，表示在城市 $x_i$ 与城市 $y_i$ 之间修建道路的代价为 $z_i$。接下来 $q$ 行，每行包含两个数 $k,d$，表示输入的第 $k$ 个道路的修建代价修改为 $d$（即将 $z_k$ 修改为 $d$）。
## 输出格式

输出包含 $q$ 行，第 $i$ 行输出得知前 $i$ 条消息后使城市连通的最小花费总和。
## 样例

### 样例输入 #1
```
5 5 3
1 2 1
2 3 2
3 4 3
4 5 4
5 1 5
1 6
1 1
5 3
```
### 样例输出 #1
```
14
10
9
```
## 提示

### 数据规模与约定
- 对于 $20\%$ 的数据，$n\le 10^3$，$m,q\le 6\times 10^3$。
- 对于另外 $20\%$ 的数据，$n\le 10^3$，$m\le 5\times 10^4$，$q\le 8\times 10^3$。修改后的代价不会比之前的代价低。
- 对于 $100\%$ 的数据，$1\le n\le 2\times 10^4$，$1\le m,q\le 5\times 10^4$，$1\le x_i,y_i\le n$，$0\le z_i\le 5\times 10^7$。


---

---
title: "[HNOI2015] 开店"
layout: "post"
diff: 省选/NOI-
pid: P3241
tag: ['2015', '湖南', '分治', '最近公共祖先 LCA', '动态树 LCT']
---
# [HNOI2015] 开店
## 题目描述

风见幽香有一个好朋友叫八云紫，她们经常一起看星星看月亮从诗词歌赋谈到人生哲学。最近她们灵机一动，打算在幻想乡开一家小店来做生意赚点钱。

这样的想法当然非常好啦，但是她们也发现她们面临着一个问题，那就是店开在哪里，面向什么样的人群。很神奇的是，幻想乡的地图是一个树形结构，幻想乡一共有 $n$ 个地方，编号为 $1$ 到 $n$，被 $n-1$ 条带权的边连接起来。每个地方都住着一个妖怪，其中第 $i$ 个地方的妖怪年龄是 $x_i$。

妖怪都是些比较喜欢安静的家伙，所以它们并不希望和很多妖怪相邻。所以这个树所有顶点的度数都小于或等于 $3$。妖怪和人一样，兴趣点随着年龄的变化自然就会变化，比如我们的 $18$ 岁少女幽香和八云紫就比较喜欢可爱的东西。幽香通过研究发现，基本上妖怪的兴趣只跟年龄有关，所以幽香打算选择一个地方 $u$（$u$ 为编号），然后在 $u$ 开一家面向年龄在 $L$ 到 $R$ 之间（即年龄大于等于 $L$ 小于等于 $R$）的妖怪的店。

也有可能 $u$ 这个地方离这些妖怪比较远，于是幽香就想要知道所有年龄在 $L$ 到 $R$ 之间的妖怪，到点 $u$ 的距离的和是多少（妖怪到 $u$ 的距离是该妖怪所在地方到 $u$ 的路径上的边的权之和），幽香把这个称为这个开店方案的方便值。

幽香她们还没有决定要把店开在哪里，八云紫倒是准备了很多方案，于是幽香想要知道，对于每个方案，方便值是多少呢。

## 输入格式

第一行三个用空格分开的数 $n,Q$ 和 $A$，表示树的大小、开店的方案个数和妖怪的年龄上限。

第二行 $n$ 个用空格分开的数 $x_1,x_2,\ldots,x_n$；$x_i$ 表示第 $i$ 个地点妖怪的年龄，满足 $0\le x_i\lt A$。(年龄是可以为 $0$ 的，例如刚出生的妖怪的年龄为 $0$。) 

接下来 $n-1$  行，每行三个用空格分开的数 $a$、$b$、$c$，表示树上的顶点 $a$ 和 $b$ 之间有一条权为 $c(1\le c\le1000)$ 的边，$a$ 和 $b$ 是顶点编号。 

接下来 $Q$ 行，每行三个用空格分开的数 $u,a,b$。

对于这 $Q$ 行的每一行，用 $a,b,A$ 计算出 $L$ 和 $R$，表示询问”在地方 $u$ 开店，面向妖怪的年龄区间为 $[L,R]$ 的方案的方便值是多少“。

对于其中第 $1$ 行，$L$ 和 $R$ 的计算方法为：$L=\min(a\bmod A,b\bmod A),R=\max(a\bmod A,b\bmod A)$ 。

对于第 $2$ 到第 $Q$ 行，假设前一行得到的方便值为 $ans$，那么当前行的 $L$ 和 $R$ 计算方法为： $L=\min((a+ans)\bmod A,(b+ans)\bmod A), R=\max((a+ans)\bmod A,(b+ans)\bmod A)$ 。
## 输出格式

对于每个方案，输出一行表示方便值。

## 样例

### 样例输入 #1
```
10 10 10
0 0 7 2 1 4 7 7 7 9
1 2 270
2 3 217
1 4 326
2 5 361
4 6 116
3 7 38
1 8 800
6 9 210
7 10 278
8 9 8
2 8 0
9 3 1
8 0 8
4 2 7
9 7 3
4 7 0
2 2 7
3 2 1
2 3 4
```
### 样例输出 #1
```
1603 
957 
7161 
9466 
3232 
5223 
1879 
1669 
1282 
0
```
## 提示

满足 $n\le1.5 \times 10^5,Q\le2 \times 10^5$。对于所有数据，满足 $A\le 10^9$。 


---

---
title: "小清新数据结构题"
layout: "post"
diff: 省选/NOI-
pid: P3676
tag: ['点分治', '洛谷原创', 'O2优化', '树链剖分', '动态树 LCT', '洛谷月赛']
---
# 小清新数据结构题
## 题目背景

**本题时限2s，内存限制256M**

## 题目描述

在很久很久以前，有一棵n个点的树，每个点有一个点权。

现在有q次操作，每次操作是修改一个点的点权或指定一个点，询问以这个点为根时每棵子树点权和的平方和。

（题目不是很好懂，没看太懂的可以看看样例解释）

## 输入格式

第一行两个整数n、q。

接下来n-1行每行两个整数a和b，表示树中a与b之间有一条边，保证给出的边不会重复。

接下来一行n个整数，第i个整数表示第i个点的点权。

接下来q行每行两或三个数，如果第一个数为1，那么接下来有两个数x和y，表示将第x个点的点权修改为y，如果第一个数为2，那么接下来有一个数x，表示询问以x为根时每棵子树点权和的平方和。

## 输出格式

对于每个询问输出答案。

## 样例

### 样例输入 #1
```
4 5
1 2
2 3
2 4
4 3 2 1
2 2
1 1 3
2 3
1 2 4
2 4
```
### 样例输出 #1
```
121
140
194
```
## 提示

##### 样例解释

这是一个菊花图，2与1、3、4间有边。

一开始每个点点权分别为4、3、2、1。

第一个询问以2为根，1、3、4子树中都只有本身一个点，2子树中有所有点，那么1、3、4子树中的点权和就分别是自己的点权4、2、1，2子树中的点权和就是4+3+2+1=10，$4^2+2^2+1^1+10^2=121$。

接下来将第一个点点权修改为3，每个点点权分别为3、3、2、1。

第二个询问以3为根，1、4子树中只有自己，2子树中有1、2、4，3子树中有所有点，1、4子树点权和就是自己的点权3、1，2子树点权和就是3+3+1=7，3子树点权和为3+3+2+1=9，$3^2+1^2+7^2+9^2=140$。

接下来把第二个点点权修改为4，每个点点权分别为3、4、2、1。

第三个询问以4为根，1、3子树点权和就是3和2，2子树点权和就是3+4+2=9，4子树点权和为3+4+2+1=10，$3^2+2^2+9^2+10^2=194$。

##### 数据范围

对于10%的数据，$n,q \leq 2000$。

对于40%的数据，$n,q \leq 60000$。

对于另外30%的数据，保证每次询问的根都为1。

对于100%的数据，$1 \leq n,q \leq 200000$，$-10 \leq$输入的每个点权$\leq 10$。

建议使用输入优化~~，虽然标程没加读入优化也能过~~



---

---
title: "【模板】动态树（LCT）"
layout: "post"
diff: 省选/NOI-
pid: P3690
tag: ['O2优化', '树链剖分', '动态树 LCT']
---
# 【模板】动态树（LCT）
## 题目描述

给定 $n$ 个点以及每个点的权值，要你处理接下来的 $m$ 个操作。  
操作有四种，操作从 $0$ 到 $3$ 编号。点从 $1$ 到 $n$ 编号。


- `0 x y` 代表询问从 $x$ 到 $y$ 的路径上的点的权值的 $\text{xor}$ 和。保证 $x$ 到 $y$ 是联通的。
- `1 x y` 代表连接 $x$ 到 $y$，若 $x$ 到 $y$ 已经联通则无需连接。
- `2 x y` 代表删除边 $(x,y)$，不保证边 $(x,y)$ 存在。
- `3 x y` 代表将点 $x$ 上的权值变成 $y$。

## 输入格式

第一行两个整数，分别为 $n$ 和 $m$，代表点数和操作数。

接下来 $n$ 行，每行一个整数，第 $(i + 1)$ 行的整数 $a_i$ 表示节点 $i$ 的权值。

接下来 $m$ 行，每行三个整数，分别代表操作类型和操作所需的量。

## 输出格式

对于每一个 $0$ 号操作，你须输出一行一个整数，表示 $x$ 到 $y$ 的路径上点权的 $\text{xor}$ 和。

## 样例

### 样例输入 #1
```
3 3 
1
2
3
1 1 2
0 1 2 
0 1 1
```
### 样例输出 #1
```
3
1

```
### 样例输入 #2
```
5 14
114
514
19
19
810
1 1 2
0 1 2
2 1 2
1 1 2
1 2 3
2 1 3
1 1 3
1 4 5
1 2 5
0 3 5
0 3 4
3 5 233333
0 1 5
0 2 5

```
### 样例输出 #2
```
624
315
296
232709
232823

```
## 提示

#### 数据规模与约定

对于全部的测试点，保证：
- $1 \leq n \leq 10^5$，$1 \leq m \leq 3 \times 10^5$，$1 \leq a_i \leq 10^9$。
- 对于操作 $0, 1, 2$，保证 $1 \leq x, y \leq n$。
- 对于操作 $3$，保证 $1 \leq x \leq n$，$1 \leq y \leq 10^9$。



---

---
title: "[SDOI2017] 树点涂色"
layout: "post"
diff: 省选/NOI-
pid: P3703
tag: ['2017', '线段树', '各省省选', '山东', '树链剖分', '动态树 LCT']
---
# [SDOI2017] 树点涂色
## 题目描述

Bob 有一棵 $n$ 个点的有根树，其中 $1$ 号点是根节点。Bob 在每个点上涂了颜色，并且每个点上的颜色不同。

定义一条路径的权值是：这条路径上的点（包括起点和终点）共有多少种不同的颜色。

Bob可能会进行这几种操作：

- `1 x` 表示把点 $x$ 到根节点的路径上所有的点染上一种没有用过的新颜色。


- `2 x y` 求 $x$ 到 $y$ 的路径的权值。

- `3 x` 在以 $x$ 为根的子树中选择一个点，使得这个点到根节点的路径权值最大，求最大权值。


Bob一共会进行 $m$ 次操作

## 输入格式

第一行两个数 $n,m$。

接下来 $n-1$ 行，每行两个数 $a,b$，表示 $a$ 与 $b$ 之间有一条边。

接下来 $m$ 行，表示操作，格式见题目描述
## 输出格式

每当出现 $2,3$ 操作，输出一行。

如果是 $2$ 操作，输出一个数表示路径的权值

如果是 $3$ 操作，输出一个数表示权值的最大值

## 样例

### 样例输入 #1
```
5 6
1 2
2 3
3 4
3 5
2 4 5
3 3
1 4
2 4 5
1 5
2 4 5
```
### 样例输出 #1
```
3
4
2
2
```
## 提示

共 $10$ 个测试点。

测试点 $1$，$1\leq n,m\leq1000$；

测试点 $2,3$，没有 $2$ 操作；

测试点 $4,5$，没有 $3$ 操作；

测试点 $6$，树的生成方式是，对于 $i(2\leq i \leq n)$，在 $1 \sim i-1$ 中随机选一个点作为 $i$ 的父节点；

测试点 $7$，$1\leq n,m\leq 5\times 10^4$；

测试点 $8$，$1\leq n \leq 5 \times 10^4$；

测试点9,10，无特殊限制

对所有数据，$1\leq n \leq 10^5$，$1\leq m \leq 10^5$。



---

---
title: "[AH2017/HNOI2017] 单旋"
layout: "post"
diff: 省选/NOI-
pid: P3721
tag: ['模拟', '2017', '线段树', '各省省选', '离散化', '湖南', '动态树 LCT']
---
# [AH2017/HNOI2017] 单旋
## 题目描述

H国是一个热爱写代码的国家，那里的人们很小去学校学习写各种各样的数据结构。伸展树（splay）是一种数据结构，因为代码好写，功能多，效率高，掌握这种数据结构成为了H国的必修技能。有一天，邪恶的“卡”带着他的邪恶的“常数”来企图毁灭H国。“卡”给H国的人洗脑说，splay如果写成单旋的，将会更快。“卡”称“单旋splay”为“spaly”。虽说他说的很没道理，但还是有H国的人相信了，小H就是其中之一，spaly马上成为他的信仰。而H国的国王，自然不允许这样的风气蔓延，国王构造了一组数据，数据由m（不超过10^5）个操作构成，他知道这样的数据肯定打垮spaly，但是国王还有很多很多其他的事情要做，所以统计每个操作

所需要的实际代价的任务就交给你啦。数据中的操作分为5种：

1. 插入操作：向当前非空spaly中插入一个关键码为key的新孤立节点。插入方法为，先让key和根比较，如果key比根小，则往左子树走，否则往右子树走，如此反复，直到某个时刻，key比当前子树根x小，而x的左子树为空，那就让key成为x的左孩子；或者key比当前子树根x大，而x的右子树为空，那就让key成为x的右孩子。该操作的代价为：插入后，key的深度。特别地，若树为空，则直接让新节点成为一个单个节点的树。（各节点关键码互不相等。对于“深度”的解释见末尾对spaly的描述。）

2. 单旋最小值:将spaly中关键码最小的元素xmin单旋到根。操作代价为：单旋前xmin的深度。（对于单旋操作的解释见末尾对spaly的描述。）

3. 单旋最大值:将spaly中关键码最大的元素xmax单旋到根。操作代价为：单旋前xmax的深度。

4. 单旋删除最小值：先执行2号操作，然后把根删除。由于2号操作之后，根没有左子树，所以直接切断根和右子树的联系即可。（具体见样例解释）。操作代价同2号操作。

5. 单旋删除最大值：先执行3号操作，然后把根删除。操作代价同3号操作。

 ![](https://cdn.luogu.com.cn/upload/pic/5106.png) 

对于不是H国的人，你可能需要了解一些spaly的知识，才能完成国王的任务：

1. spaly是一棵二叉树，满足对于任意一个节点x，它如果有左孩子lx，那么lx的关键码小于x的关键码。如果有右孩子rx，那么rx的关键码大于x的关键码。

2. 一个节点在spaly的深度定义为：从根节点到该节点的路径上一共有多少个节点（包括自己）。

3. 单旋操作是对于一棵树上的节点x来说的。一开始，设f为x在树上的父亲。如果x为f的左孩子，那么执行zig(x)操作（如上图中，左边的树经过zig(x)变为了右边的树）,否则执行zag(x)操作（在上图中，将右边的树经过zag(f)就变成了左边的树）。每当执行一次zig(x)或者zag(x),x的深度减小1，如此反复，直到x为根。总之，单旋x就是通过反复执行zig和zag将x变为根。

## 输入格式

输入文件名为 splay.in。

第一行单独一个正整数 m (1 <= m <= 10^5)。

接下来 m 行，每行描述一个操作：首先是一个操作编号 c（ 1<=c<=5），既问题描述中给出的 5 种操作中的编号，若 c= 1，则再输入一个非负整数 key，表示新插入节点的关键码。

## 输出格式

输出文件名为 splay.out。

输出共 m 行，每行一个整数，第 i 行对应第 i 个输入的操作的代价。

## 样例

### 样例输入 #1
```
5
1 2
1 1
1 3
4 
5
```
### 样例输出 #1
```
1 
2 
2
2 
2
```
## 提示

20%的数据满足： 1 <= m <= 1000。

另外 30%的数据满足： 不存在 4,5 操作。

100%的数据满足： 1<=m<=10^5； 1<=key<=10^9。 所有出现的关键码互不相同。 任何一个非插入操作，一定保证树非空。 在未执行任何操作之前，树为空。



---

---
title: "[TJOI2015] 旅游"
layout: "post"
diff: 省选/NOI-
pid: P3976
tag: ['2015', '线段树', '各省省选', '树链剖分', '动态树 LCT', '天津']
---
# [TJOI2015] 旅游
## 题目描述

为了提高智商，ZJY 准备去往一个新世界去旅游。这个世界的城市布局像一棵树，每两座城市之间只有一条路径可以互达。  

每座城市都有一种宝石,有一定的价格。ZJY 为了赚取最高利益,她会选择从 A 城市买入再转手卖到 B 城市。  

由于ZJY买宝石时经常卖萌，因而凡是 ZJY 路过的城市，这座城市的宝石价格会上涨。让我们来算算 ZJY 旅游完之后能够赚取的最大利润。(如 A 城市宝石价格为 $v$，则ZJY出售价格也为 $v$)

## 输入格式

第一行输入一个正整数 $n$ 表示城市个数

接下来一行输入 $n$ 个正整数表示每座城市宝石的最初价格 $p$,每个宝石的初始价格不超过 $100$。

第三行开始连续输入 $n-1$ 行,每行有两个数字 $x$ 和 $y$。表示 $x$ 城市和 $y$ 城市有一条路径。城市编号从$1$开始。  

下一行输入一个正整数 $q$ 表示询问次数。

接下来 $q$ 行每行输入三个正整数 $a,b,v$，表示 ZJY 从 $a$ 旅游到 $b$，城市宝石上涨 $v$。

## 输出格式

对于每次询问，输出 ZJY 可能获得的最大利润，如果亏本了则输出 $0$。

## 样例

### 样例输入 #1
```
3
1 2 3
1 2
2 3
2
1 2 100
1 3 100
```
### 样例输出 #1
```
1
1
```
### 样例输入 #2
```
5
1 2 3 4 5
1 2
1 3
2 4
4 5
6
1 5 50
2 4 500
3 4 5000
3 5 50000
1 3 500000
2 3 5000000

```
### 样例输出 #2
```
4
2
551
551
0
499499
```
## 提示

#### 数据规模与约定

- 对于 $30\%$ 的数据，保证 $n \le 100$，$q \le 10^4$。
- 对于 $100\%$ 的数据，保证 $1\le n,q \le 5\times 10^4$，在任何时刻任何城市的宝石价格都不超过 $10^9$。



---

---
title: "[WC2005] 双面棋盘"
layout: "post"
diff: 省选/NOI-
pid: P4121
tag: ['2005', '线段树', '并查集', '生成树', '动态树 LCT', 'WC']
---
# [WC2005] 双面棋盘
## 题目描述

佳佳有一个 $n$ 行 $n$ 列的黑白棋盘，每个格子都有两面，一面白色，一面黑色。佳佳把棋盘平放在桌子上，因此每个格子恰好一面朝上，如下图所示：

![](https://cdn.luogu.com.cn/upload/image_hosting/rcejbuct.png)

我们把每行从上到下编号为 $1$，$2$，$3$，……，$n$，各列从左到右编号为 $1$，$2$，$3$，……，$n$，则每个格子可以用棋盘坐标$(x, y)$表示。在上图中，有 $8$ 个格子黑色朝上，另外 $17$ 个格子白色朝上。

如果两个同色格子有一条公共边，我们称这两个同色格子属于同一个连通块。上图共有 $5$ 个黑色连通块和 $3$ 个白色连通块。

佳佳可以每分钟将一个格子翻转（即白色变成黑色，黑色变成白色），然后计算当前有多少个黑色连通块和白色连通块，你能算得更快吗？

## 输入格式

输入文件的第一行包含一个正整数 $n$，为格子的边长。以下 $n$ 行每行 $n$ 个整数，非 $0$ 即 $1$，表示初始状态。$0$ 表示白色，$1$ 表示黑色。  

下一行包含一个整数 $m$，表示操作的数目。以下 $m$ 行每行两个整数 $x$, $y$ ( $1 \le x,y \le n$ )，表示把坐标为 $(x, y)$ 的格子翻转。

## 输出格式

输出文件包含 $m$ 行，每行对应一个操作。该行包括两个整数 $b$, $w$，表示黑色区域和白色区域数目。

## 样例

### 样例输入 #1
```
5
0 1 0 0 0
0 1 1 1 0
1 0 0 0 1
0 0 1 0 0
1 0 0 0 0
2
3 2
2 3
```
### 样例输出 #1
```
4 3
5 2
```
## 提示

【样例说明】

翻转 $(3, 2)$ 之后，棋盘变为：

![](https://cdn.luogu.com.cn/upload/image_hosting/9oqt0zsv.png)

有 $4$ 个黑色区域和 $3$ 个白色区域

翻转 $(2, 3)$ 之后，棋盘变为：

![](https://cdn.luogu.com.cn/upload/image_hosting/f335hulm.png)

有 $5$ 个黑色区域和 $2$ 个白色区域

【数据范围】   
对于 $100\%$ 的数据，$1\le n \le 200$，$1\le m \le 10^4$。



---

---
title: "[WC2006] 水管局长"
layout: "post"
diff: 省选/NOI-
pid: P4172
tag: ['图论', '2006', '平衡树', 'O2优化', '生成树', '最近公共祖先 LCA', '动态树 LCT', 'WC']
---
# [WC2006] 水管局长
## 题目背景

SC 省 MY 市有着庞大的地下水管网络，嘟嘟是 MY 市的水管局长（就是管水管的啦）。
## 题目描述

每天供水公司可能要将一定量的水从 $u$ 处送往 $v$ 处，嘟嘟需要为供水公司找到一条从 $u$ 至 $v$ 的水管的路径，接着通过信息化的控制中心通知路径上的水管进入准备送水状态，等到路径上每一条水管都准备好了，供水公司就可以开始送水了。嘟嘟一次只能处理一项送水任务，等到当前的送水任务完成了，才能处理下一项。

在处理每项送水任务之前，路径上的水管都要进行一系列的准备操作，如清洗、消毒等等。嘟嘟在控制中心一声令下，这些水管的准备操作同时开始，但由于各条管道的长度、内径不同，进行准备操作需要的时间可能不同。

供水公司总是希望嘟嘟能找到这样一条送水路径，路径上的所有管道全都准备就绪所需要的时间尽量短。嘟嘟希望你能帮助他完成这样的一个选择路径的系统，以满足供水公司的要求。另外，由于 MY 市的水管年代久远，一些水管会不时出现故障导致不能使用，你的程序必须考虑到这一点。

不妨将 MY 市的水管网络看作一幅简单无向图（即没有自环或重边）：水管是图中的边，水管的连接处为图中的结点。整张图共有 $n$ 个节点和 $m$ 条边，节点从 $1$ 至 $n$ 编号。

## 输入格式

第一行有三个整数，分别表示管道连接处（结点）的数目 $n$，目前水管（无向边）的数目 $m$，以及你的程序需要处理的任务数目（包括寻找一条满足要求的路径和接受某条水管坏掉的事实）$q$。

以下 $m$ 行，每行三个整数 $u, v, t$，表示存在一条连接 $(u, v)$ 的水管，准备时间为 $t$。

以下 $q$ 行，每行三个整数 $k, u, v$，描述一项任务。其中 $k$ 表示任务类型：

- 若 $k = 1$，则表示你需要为供水公司寻找一条满足要求的从 $u$ 到 $v$ 的水管路径，满足准备时间最短；
- 若 $k = 2$，则表示直接连接 $u$ 和 $v$ 的水管宣布报废。

## 输出格式

对于每个 $k = 1$ 的任务，输出一行一个整数表示答案。
## 样例

### 样例输入 #1
```
4 4 3
1 2 2
2 3 3
3 4 2
1 4 2
1 1 4
2 1 4
1 1 4

```
### 样例输出 #1
```
2
3
```
## 提示

#### 数据规模与约定

对于全部的测试点，保证：

- $1 \leq n \leq 10^3$，$1 \leq m, q \leq 10^5$。
- $1 \leq k \leq 2$，$1 \leq u, v \leq n$，$1 \leq t \leq 10^9$。
- 给出的图无重边无自环，保证在宣布一条水管报废之前，该水管一定存在于图上且没有报废，
- 宣布报废的水管不超过 $5 \times 10^3$ 条，且在任意时刻，图一定是联通的。





---

---
title: "[BJOI2014] 大融合"
layout: "post"
diff: 省选/NOI-
pid: P4219
tag: ['2014', '树链剖分', '动态树 LCT', '线段树分治']
---
# [BJOI2014] 大融合
## 题目描述

小强要在 $N$ 个孤立的星球上建立起一套通信系统。这套通信系统就是连接 $N$ 个点的一个树。

这个树的边是一条一条添加上去的。

在某个时刻，一条边的负载就是它所在的当前能够联通的树上路过它的简单路径的数量。

![](https://cdn.luogu.com.cn/upload/pic/13969.png)

例如，在上图中，现在一共有了 $5$ 条边。其中，$(3,8)$ 这条边的负载是 $6$，因为有六条简单路径 $2-3-8$,$2-3-8-7$,$3-8,3-8-7$,$4-3-8$,$4-3-8-7$ 路过了 $(3,8)$。

现在，你的任务就是随着边的添加，动态的回答小强对于某些边的负载的询问。
## 输入格式

第一行包含两个整数  $N, Q$,表示星球的数量和操作的数量。星球从 $1$ 开始编号。

接下来的 $Q$  行，每行是如下两种格式之一：

 - ```A x y``` 表示在 $x$ 和 $y$ 之间连一条边。保证之前 $x$ 和 $y$ 是不联通的。
 - ```Q x y```表示询问 $(x,y)$ 这条边上的负载。保证 $x$ 和 $y$ 之间有一条边。
## 输出格式

对每个查询操作，输出被查询的边的负载。
## 样例

### 样例输入 #1
```
8 6
A 2 3
A 3 4
A 3 8
A 8 7
A 6 5
Q 3 8
```
### 样例输出 #1
```
6
```
## 提示

对于所有数据，$1≤N,Q≤10^5$


---

---
title: "连环病原体"
layout: "post"
diff: 省选/NOI-
pid: P4230
tag: ['深度优先搜索 DFS', '动态树 LCT', '期望', '差分']
---
# 连环病原体
## 题目背景

###（一）洞穴

顺着狭窄倾斜的溶洞向下走，这里，真有一番地心探险的感觉呢。

告诉你啊，地底有一片广阔的大世界，叫做旧地狱。

那里居住着被地面上的人厌恶的妖怪们。

虽然听着比较吓人，但实际上在地狱废弃后，一切都是井井有条的。

前方有一片开阔的空间啊，好像有人。

"地面上的来客吗,你好啊"

终于遇到地底的居民了。

眼前的两只妖怪是黑谷山女和琪斯美。

琪斯美呆在一个小桶里，悬挂在空中，和山女讨论着什么。

"哇，你们在讨论什么啊"

"嗯，有关病毒的问题，你们不懂的"

忘记说了，山女可以操纵疾病，所以谈论这样的话题自然也就很平常了。

不过好奇心很难抵挡啊，那就假装自己能帮上忙，然后接着问下去吧。

"好吧，你们要是能帮上忙的话就再好不过了"

"嗯，主要是，想知道病原体之间的相互作用，会对疾病产生什么影响呢。你看啊，把不同种的病原体看做点，相互作用看成连接这些点的线，如果产生了环，那么病毒的威力就会大幅加强，我把它叫做加强环。"

"病原体之间的相互作用也有很多种呢，我想研究的是，每种相互作用在产生加强环的过程中有多么重要。"

啊，听起来好复杂，不过如果帮了她的忙，地底的妖怪们大概会对我们友善一些吧。

而且，点，边，环？这些名词似乎见过呢，说不定我真的能帮上忙？

那么，继续详细地询问吧。

嗯，问出来的信息已经记录在这张纸上了。

## 题目描述

问题摘要:

有n 种病原体，它们之间会产生$m$种无方向性的影响，第$i$种影响发生在$u_i$,$v_i$ **两种**病原体之间。

我们把所有的**影响**按编号顺序排成一个序列，如果某一个区间包含有环，那么这个区间被称作加强区间。

求每种影响分别在多少个加强区间中出现过。

那么，到底怎样做才能高效的得出结果呢？

(后续剧情见本题题解，接下来请看T2)
## 输入格式

第一行一个数$m$
接下来$m$行每行两个数$u_i$,$v_i$，用空格分隔
## 输出格式

一行$m$个数字，第$i$个数字代表第$i$种影响在多少个加强区间内出现过，数字之间用空格分隔
## 样例

### 样例输入 #1
```
5
1 2
2 3
3 4
1 4
4 2

```
### 样例输出 #1
```
2 3 3 3 2
```
## 提示

###样例解释：

第一种影响在[1,4]和[1,5]两个加强区间内出现

第二种影响在[1,4]、[1,5]和[2,5]三个加强区间内出现

第三种影响在[1,5]、[1,4]和[2,5]三个加强区间内出现

第四种影响在[1,4]、[2,5]和[1,5]三个加强区间内出现

第五种影响在[2,5]和[1,5]两个加强区间内出现

注意：加强区间是由“影响”构成的，而不是由“病原体”构成的

$n\leqslant2m\leqslant400000$

测试点1~2总分10分，$m\leqslant5$

测试点3~6总分20分，$m\leqslant200$

测试点7~12总分30分，$m\leqslant5000$

测试点13~15总分15分，$m\leqslant50000$

测试点16~18总分15分，$m\leqslant50000$，捆绑测试

测试点19~22总分10分，$m\leqslant200000$，捆绑测试

by oscar


---

---
title: "最小差值生成树"
layout: "post"
diff: 省选/NOI-
pid: P4234
tag: ['图论', 'O2优化', '枚举', '深度优先搜索 DFS', '生成树', '动态树 LCT']
---
# 最小差值生成树
## 题目描述

给定一个点标号从 $1$ 到 $n$ 的、有 $m$ 条边的无向图，求边权最大值与最小值的差值最小的生成树。图可能存在自环。
## 输入格式

第一行有两个整数，表示图的点数 $n$ 和边数 $m$。

接下来 $m$ 行，每行三个整数 $u, v, w$，表示存在一条连接 $u, v$ 长度为 $w$ 的边。
## 输出格式

输出一行一个整数，表示答案。

## 样例

### 样例输入 #1
```
4 6 
1 2 10 
1 3 100 
1 4 90 
2 3 20 
2 4 80 
3 4 40 

```
### 样例输出 #1
```
20
```
## 提示

#### 数据规模与约定

- 对于 $30\%$ 的数据，保证 $n \leq 100$，$m \leq 10^3$。
- 对于 $97\%$ 的数据，保证 $n \leq 500$，$m \leq 10^5$。
- 对于 $100\%$ 的数据，保证 $1 \leq n \leq 5 \times 10^4$，$1 \leq m \leq 2 \times 10^5$，$1 \leq u, v \leq n$，$1 \leq w \leq 10^4$。


---

---
title: "[USACO18FEB] New Barns P"
layout: "post"
diff: 省选/NOI-
pid: P4271
tag: ['2018', 'USACO', '并查集', '连通块', '最近公共祖先 LCA', '树的直径', '动态树 LCT']
---
# [USACO18FEB] New Barns P
## 题目描述

给你一棵树，初始没有节点。你需要支持两种操作：  

- `B p` 表示新建一个节点，将它与 $p$  节点连接；若 $p=-1$，则表示不与其它节点相连  

- `Q k` 表示查询在 $k$ 节点所在的连通块中，距它最远的点的距离。这里距离的定义是两点间经过的边数。
## 输入格式

第一行一个正整数 $q$，表示操作个数。  
接下来 $q$ 行，每行表示一个操作。
## 输出格式

对于每个询问操作，输出一行一个整数表示答案。
## 样例

### 样例输入 #1
```
7
B -1
Q 1
B 1
B 2
Q 3
B 2
Q 2
```
### 样例输出 #1
```
0
2
1

```
## 提示

【数据范围】  

对于 $100%$ 的数据，$1 \le q \le 10^5$。  
保证操作合法。

The example input corresponds to this network of barns:
```
  (1) 
    \   
     (2)---(4)
    /
  (3)
```
In query 1, we build barn number 1. In query 2, we ask for the distance of 1 to the farthest connected barn. Since barn 1 is connected to no other barns, the answer is 0. In query 3, we build barn number 2 and connect it to barn 1. In query 4, we build barn number 3 and connect it to barn 2. In query 5, we ask for the distance of 3 to the farthest connected barn. In this case, the farthest is barn 1, which is 2 units away. In query 6, we build barn number 4 and connect it to barn 2. In query 7, we ask for the distance of 2 to the farthest connected barn. All three barns 1, 3, 4 are the same distance away, which is 1, so this is our answer.

Problem credits: Anson Hu


---

---
title: "首都"
layout: "post"
diff: 省选/NOI-
pid: P4299
tag: ['搜索', '并查集', '剪枝', '动态树 LCT']
---
# 首都
## 题目描述

在 X 星球上有 $n$ 个国家，每个国家占据着 X 星球的一座城市，城市从 $1$ 至 $n$ 编号。由于国家之间是敌对关系，所以不同国家的两个城市是不会有公路相连的。

X 星球上战乱频发，如果 A 国打败了 B 国，那么 B 国将永远从这个星球消失，而 B 国的国土也将归 A 国管辖。A 国国王为了加强统治，会在 A 国和 B 国之间修建一条公路，即选择原 A 国的某个城市和 B 国某个城市，修建一条连接这两座城市的公路。

同样为了便于统治自己的国家，国家的首都会选在某个使得其他城市到它距离之和最小的城市，这里的距离是指需要经过公路的条数，如果有多个这样的城市，编号最小的将成为首都。

现在告诉你发生在 X 星球的战事，需要你处理一些关于国家首都的信息，具体地，有如下3种信息需要处理：

- `A x y`：表示某两个国家发生战乱，战胜国选择了 $x$ 城市和 $y$ 城市，在它们之间修建公路（保证其中城市一个在战胜国另一个在战败国）。
- `Q x`：询问当前编号为 $x$ 的城市所在国家的首都。
- `Xor`：询问当前所有国家首都编号的异或和。

## 输入格式

输入的第一行有两个整数，分别表示城市数 $n$ 和需要处理的信息数 $m$。

接下来 $m$ 行，每行首先有一个字符串 $op$，表示信息类型，后有若干个整数，其格式如【题目描述】所示。
## 输出格式

对于每个 `Q` 操作和 `Xor` 操作，输出一行一个整数表示答案。
## 样例

### 样例输入 #1
```
10 10 
Xor 
Q 1 
A 10 1 
A 1 4 
Q 4 
Q 10 
A 7 6 
Xor 
Q 7 
Xor
```
### 样例输出 #1
```
11 
1 
1 
1 
2 
6 
2 

```
## 提示

#### 数据规模与约定

对于全部的测试点，保证 $1 \leq n \leq 10^5$，$1 \leq m \leq 2 \times 10^5$，$1 \leq x, y \leq n$。


---

---
title: "变化的道路"
layout: "post"
diff: 省选/NOI-
pid: P4319
tag: ['线段树', 'O2优化', '生成树', '动态树 LCT', '可持久化']
---
# 变化的道路
## 题目描述

小 w 和小 c 在 H 国，近年来，随着 H 国的发展，H 国的道路也在不断变化着

根据 H 国的道路法，H 国道路都有一个值 $w$，表示如果小 w 和小 c 通过这条道路，那么他们的 L 值会减少 $w$，但是如果小 w 和
小 c 在之前已经经过了这条路，那么他们的 L 值不会减少

H 国有 $N$ 个国家，最开始 H 国有 $N-1$ 条道路，这 $N-1$ 条道路刚好构成一棵树

小 w 将和小 c 从 H 国的城市 1 出发，游览 H 国的所有城市，总共游览 32766 天，对于每一天，他们都希望游览结束后 L 值还是一个正数，
那么他们出发时 L 值至少为多少

H 国的所有边都是无向边，没有一条道路连接相同的一个城市
## 输入格式

输入第 1 行，一个整数$N$

输入第 2 至第 $N$ 行，每行三个正整数$u, v, w$，表示城市 $u$ 与城市 $v$ 有一条值为 $w$ 道路
	
输入第 $N+1$ 行，一个整数 $M$，表示 H 国有 $M$ 条正在变化的道路

输入第 $N+2$ 行到第 $N+M+1$ 行，每行 5 个整数 $u, v, w, l, r$，表示城市 $u$ 到城市 $v$ 有一条值为 $w$ 的道路，
这条道路存在于第 $l$ 天到第 $r$ 天
## 输出格式

输出共 32766 行，第 $i$ 行表示第 $i$ 天游览的 L 值至少为多少
## 样例

### 样例输入 #1
```
4
1 3 3
3 4 4
2 4 5
3
1 2 1 1 2
2 3 8 2 3
3 4 2 1 1
```
### 样例输出 #1
```
7
9
13
由于版面原因，仅显示三行，接下来32763行都是13
```
## 提示

第一天，选择 1 -(1)> 2 -(0)> 1 -(3)> 3 -(2)> 4，L 值总共减少了 6，所以 L 值至少为 7

第二天，选择 1 -(1)> 2 -(0)> 1 -(3)> 3 -(4)> 4，L 值总共减少了 8，所以 L 值至少为 9

第三天及之后，选择 1 -(3)> 3 -(4)> 4 -(5)> 2，L 值总共减少了 12，所以 L 值至少为 13

subtask1 : 15分，$N = 100, rm = 233$

subtask2 : 15分，$N = 1000, rm = 2333$

subtask3 : 20分，$N = 49998, rm = 32766, l = r$

subtask4：20分，$N = 49999, rm = 32766, r = rm$

subtask5：30分，$N = 50000, rm = 32766$

对于subtask3 : $M = rm$，对于其他subtask：$M=3\times rm$

对于所有数据 : $1\leq N\leq 50000, 1\leq l\leq r\leq rm\leq 32766, 1\leq w\leq 10^9$


---

---
title: "[SHOI2014] 三叉神经树"
layout: "post"
diff: 省选/NOI-
pid: P4332
tag: ['模拟', '2014', '线段树', '各省省选', '上海', 'O2优化', '分治', '树链剖分', '动态树 LCT']
---
# [SHOI2014] 三叉神经树
## 题目描述

计算神经学作为新兴的交叉学科近些年来一直是学术界的热点。一种叫做 SHOI 的神经组织因为其和近日发现的化合物 SHTSC 的密切联系引起了人们的极大关注。

SHOI 组织由若干个 SHOI 细胞构成，SHOI 细胞之间形成严密的树形结构。每个 SHOI 细胞都有且只有一个输出端,被称为轴突,除了一个特殊的、被称为根细胞的 SHOI 细胞的输出作为整个组织的输出以外,其余细胞的轴突均连向其上级 SHOI 细胞；并且有且只有三个接收端,被称为树突,从其下级细胞或者其它神经组织那里接收信息。SHOI 细胞的信号机制较为简单,仅有 $0$和 $1$ 两种。每个 SHOI 细胞根据三个输入端中 $0$和 $1$ 信号的多寡输出较多的那一种。

现在给出了一段 SHOI 组织的信息，以及外部神经组织的输入变化情况。请你模拟 SHOI 组织的输出结果。
## 输入格式

输入的第一行包含一个整数 $n$。表示 SHOI 组织的总细胞个数。SHOI 细胞由 $1\sim n$ 编号,编号为 $1$ 的是根细胞。

从第二行开始的 $n$ 行,每行三个整数 $x_1, x_2, x_3$，分别表示编号为 $1\sim n$ 的 SHOI 细胞的树突连接。$1 < x_i \leq n$ 表示连向编号为 $x_i$ 的细胞的轴突, $n < x_i \leq 3n+1$ 表示连向编号为 $x_i$ 的外界输入。输入数据保证给出的 SHOI 组织是合法的，且所有的 $x_i$ 两两不同。

接下来一行包含 $2n+1$ 个整数（$0$ 或者 $1$），表示初始时的外界输入。

第 $n+3$ 行有一个整数 $q$，表示总操作数。

之后 $q$ 行，每行一个整数 $x$，表示编号为 $x$ 的外界输入发生了变化。
## 输出格式

输出共 $q$ 行，每行一个整数，对应第 $i$ 次外界输入变化后的根细胞的输出。
## 样例

### 样例输入 #1
```
3
2 3 4
5 6 7
8 9 10
0 0 0 0 1 1 1
5
4
4
5
6
8

```
### 样例输出 #1
```
1
0
0
1
1

```
## 提示

- 对于 $10 \%$ 的数据，满足 $1\le n \leq 10^3$，$ 1\le q \leq 10^3$。
- 对于 $30 \%$ 的数据，满足 $1\le n \leq 10^5$，$ 1\le q \leq 10^5$。
- 对于 $100 \%$ 的数据，满足 $1\le n \leq 5\times 10^5$，$ 1\le q \leq 5\times 10^5$。


---

---
title: "【模板】动态 DP（加强版）"
layout: "post"
diff: 省选/NOI-
pid: P4751
tag: ['动态规划 DP', '线段树', 'O2优化', '树链剖分', '动态树 LCT', '动态 DP', '全局平衡二叉树']
---
# 【模板】动态 DP（加强版）
## 题目背景

树剖常数小！跑不满！

shadowice1984 为了向你证明他能卡树剖并且会卡树剖从而出了这道毒瘤题。

保证答案均在 `int` 范围内。

然后就被离线算法针对了……

因此这道题变成了强制在线。

## 题目描述

同 [P4719](https://www.luogu.com.cn/problem/P4719)。

给定一个 $n$ 个点的带点权树，进行 $m$ 次修改点权的操作。

你需要在每次修改之后输出树上最大带权独立集的权值之和。
## 输入格式

同 [P4719](https://www.luogu.com.cn/problem/P4719)。

第一行两个正整数 $n$，$m$ 表示树的点数和总操作个数

第二行 $n$ 个整数 $V_1,\dots,V_n$ 表示每个点的点权。

接下来 $(n - 1)$ 行，每行两个整数 $u, v$，表示存在一条连接 $u$ 与 $v$ 的边。

接下来 $m$ 行每行两个整数 $x$，$y$ 表示将 $x$ 的点权修改为 $y$。

对于第 $1$ 行，$x$ 即为被操作的点的编号。

对于第 $2$ 到 $m$ 行，被操作的点的编号 $=x\oplus lastans$。

其中 $lastans$ 是上一次操作后输出的答案，$\oplus$ 表示按位异或操作。
## 输出格式

输出 $m$ 行，第 $i$ 行表示表示第 $i$ 次操作之后树上最大带权独立集的权值和。
## 样例

### 样例输入 #1
```
10 10
-11 80 -99 -76 56 38 92 -51 -34 47
2 1
3 1
4 3
5 2
6 2
7 1
8 2
9 4
10 7
9 -44
184 -17
184 98
185 -58
153 48
190 99
296 -61
253 76
329 14
264 93

```
### 样例输出 #1
```
186
186
190
145
189
288
244
320
258
304
```
## 提示

数据范围 $n \leq 1 \times 10^6$，$m \leq 3 \times 10^6$。保证任意时刻各点点权的绝对值 $\leq 100$。

时限为标程的二倍，如果卡常数的话请使用 `int` 类型。


---

---
title: "银河英雄传说V2"
layout: "post"
diff: 省选/NOI-
pid: P4847
tag: ['平衡树', '动态树 LCT']
---
# 银河英雄传说V2
## 题目背景

小H昨天看到了luogu P1196这一题，触发了他内心中对英雄的感慨/雾。可是无奈他不会这一题，只好去请教小W。在讲完那一题之后，小W灵机一动——不如改一下这道题吧。

于是，一个很水的签到题出现了。
## 题目描述

某dalao：把题目说简单一点，方便让我一分钟A掉！

于是小W只好把题意简化一下：

给定n个长度为1的序列，第i个序列中有一个元素，值为ai，接下来有三种操作：

1. `M x y`，表示把x所在的序列放到y所在的序列之后。如果x,y已经在同一个序列，则不进行操作。
2. `D x`，表示把x所在的序列中从x处断开，也就是把x及x之后的元素单独取出来作为一个序列。
3. `Q x y`，表示查询x到y之间（包括x和y）所有元素的值之和。如果x和y不在同一个序列之中，输出-1.
## 输入格式

第一行为两个数n,m，分别代表元素个数和操作次数。第二行有n个数，为ai。
接下来m行，每行包括三种情况：M x y，D x或Q x y，与题目描述对应。
## 输出格式

对于每一个Q x y，输出一个数，表示所有元素的值之和。
## 样例

### 样例输入 #1
```
5 10
57770 55352 18768 21847 79100 
M 1 4
M 3 2
Q 5 2
M 3 4
M 3 5
M 4 4
M 3 1
D 1
Q 2 2
Q 2 1

```
### 样例输出 #1
```
-1
55352
113122

```
### 样例输入 #2
```
30 100
2193 75245 24438 95450 96514 84854 15292 9488 37488 940 52991 15190 64052 17398 80379 77861 88717 34751 16783 88345 27612 21748 79776 43058 35590 49064 45012 37206 70870 30643 
M 18 26
M 28 27
M 25 4
M 12 22
M 26 15
M 3 1
M 20 20
M 7 21
M 18 29
M 21 26
M 29 10
M 27 23
M 30 28
M 22 10
M 13 21
M 1 23
M 25 9
M 29 27
M 23 25
M 11 12
M 1 4
M 26 14
M 26 9
D 4
M 16 8
M 16 20
M 4 27
M 9 20
M 11 1
M 19 8
Q 12 7
M 5 10
D 20
Q 29 2
Q 9 15
M 29 21
D 5
M 23 8
M 6 6
D 23
D 6
Q 4 8
D 21
Q 29 23
Q 19 4
M 21 21
M 20 25
M 27 29
D 2
Q 7 2
M 7 15
Q 11 18
D 26
Q 21 18
M 22 11
M 12 12
M 20 15
M 22 4
D 20
M 4 5
M 12 2
Q 27 20
M 30 2
M 28 9
M 20 11
M 10 21
M 12 24
Q 14 14
M 6 29
Q 13 18
Q 10 3
Q 23 3
D 4
M 27 13
M 6 23
M 7 14
Q 12 17
M 18 25
Q 2 19
D 3
D 9
Q 2 16
Q 3 8
Q 4 10
D 24
M 21 4
Q 17 15
Q 19 7
Q 1 24
Q 9 18
D 12
M 4 16
M 27 21
D 26
M 5 14
M 15 19
M 21 26
M 18 27
Q 21 8
Q 18 13

```
### 样例输出 #2
```
52230
-1
-1
254468
291078
112233
-1
231636
62363
-1
17398
178645
25378
219268
-1
419122
347453
-1
-1
-1
274542
-1
269126
-1
178645

```
## 提示

（出题人非常良心地给了一个大一点的样例！）

样例1解释：

首先有5个序列（一个横排为一个序列），排列如下：
```
1
2
3
4
5
```

第一个操作将1放到4的后面，变成
```
2
3
4,1
5
```

第二个操作将3放到2后面，变成
```
2,3
4,1
5
````

然后查询第5个元素到第2个元素之间的和，由于不存在，输出-1；

将3所在的序列加到4所在的序列后面，变成
```
4,1,2,3
5
```

接下来变成了5,4,1,2,3，也就是所有元素都在1个序列了，因此接下来的两个合
并操作没有用了，然后把1之后的数字删除，变成：

```
1,2,3
5,4
```

查询2到2，输出2的值，也就是55352；

查询2到1，输出2+1的值，也就是113122.


![Luogu](https://cdn.luogu.com.cn/upload/pic/30577.png)

~~为了避免某些乱搞（可能避免不了）~~，**前5个点按照传统方式计分，每个测试点10分；后五个点为subtask，必须全部通过才能得分，否则不得分。**

对于所有数据，1<=x,y<=n，1<=ai<=10^9


---

---
title: "SubString"
layout: "post"
diff: 省选/NOI-
pid: P5212
tag: ['平衡树', '后缀自动机 SAM', 'O2优化', '动态树 LCT']
---
# SubString
## 题目描述

给定一个字符串 `init`，要求支持两个操作：

- 在当前字符串的后面插入一个字符串。

- 询问字符串 $s$ 在当前字符串中出现了几次。(作为连续子串)

强制在线。
## 输入格式

第一行一个整数 $Q$ 表示操作个数。

第二行一个字符串表示初始字符串 `init`。

接下来 $Q$ 行，每行 $2$ 个字符串 `Type`,`Str`。

- `Type` 是 `ADD`，表示在后面插入字符串。

- `Type` 是 `QUERY`，表示询问某字符串在当前字符串中出现了几次。

为了体现在线操作，你需要维护一个变量 `mask`，初始值为 $0$。

```cpp
String decodeWithMask(String s, int mask) {
	char[] chars = s.toCharArray();
	for (int j = 0; j < chars.length; j++) {
		mask = (mask * 131 + j) % chars.length;
		
		char t = chars[j];
		chars[j] = chars[mask];
		chars[mask] = t;
	}
	
	return new String(chars);
}
```

读入串 `Str` 之后，使用这个过程将之解码成真正询问的串 `TrueStr`。

询问的时候，对 `TrueStr` 询问后输出一行答案 `Result`。

然后 $mask=mask \bigoplus Result$。

插入的时候，将`TrueStr`插到当前字符串后面即可。

**注意：`ADD` 和 `QUERY` 操作的字符串都需要解压。**


## 输出格式

对于每一个 `QUERY` 操作，输出询问的字符串在当前字符串中出现了几次。
## 样例

### 样例输入 #1
```
2
A
QUERY B
ADD BBABBBBAAB
```
### 样例输出 #1
```
0
```
## 提示

$|\mathrm{init}| \leq 6 \times 10^5$，$Q \leq 6\times 10^5$，询问总长度 $\leq 3 \times 10^6$。

保证字符串中只会出现 `A` 和 `B`。

为防止评测过慢，对于测试点 $2,3,5,6,8,11$ 时限为 3s，其余为 1s。

原题：BZOJ 2555


---

---
title: "[AHOI2013] 连通图"
layout: "post"
diff: 省选/NOI-
pid: P5227
tag: ['2013', '线段树', '并查集', '各省省选', '安徽', 'O2优化', '动态树 LCT']
---
# [AHOI2013] 连通图
## 题目描述

给定一个无向连通图和若干个小集合，每个小集合包含一些边，对于每个集合，你需要确定将集合中的边删掉后改图是否保持联通。集合间的询问相互独立

定义一个图为联通的当且仅当对于任意的两个顶点，都存在一条路径连接它们
## 输入格式

第一行为两个整数 $n,m$，代表无向图的点数和边数

下面 $m$ 行，包含两个整数 $u,v$，代表该边连接点 $u,v$。第 $i + 1$ 行的边的编号为 $i$。保证不存在重边和自环

下面一行包含一个整数 $k$，表示集合个数

下面 $k$ 行每行描述一个集合，每行的第一个数为集合中边的个数 $c$，后面 $c$ 个数代表集合内的边
## 输出格式

对于每个集合，输出一行代表去掉该集合中的边后图是否联通，如果联通输出 ``Connected``，否则输出 ``Disconnected``
## 样例

### 样例输入 #1
```
4 5
1 2
2 3
3 4
4 1
2 4
3
1 5
2 2 3
2 1 2
```
### 样例输出 #1
```
Connected
Disconnected
Connected
```
## 提示

$1~\leq~n,k~\leq~10^5$

$1~\leq~m~\leq~2~\times~10^5$

$1~\leq~c~\leq~4$


---

---
title: "[Cnoi2019] 须臾幻境"
layout: "post"
diff: 省选/NOI-
pid: P5385
tag: ['2019', 'O2优化', '动态树 LCT', '可持久化线段树']
---
# [Cnoi2019] 须臾幻境
## 题目背景

这曾今有一个凄婉哀伤的故事，但是被出题人删档弄丢了。
## 题目描述

你有一个无向图 $G( V, E )$, $E$ 中每一个元素用一个二元组 $( u, v )$ 表示。

现在把 $E$ 中的元素排成一个长度为 $|E|$ 序列 $A$。

然后给你 $q$ 个询问二元组 $( l, r )$,

表示询问 图 $ G'\big( V, \mathop{\bigcup}\limits_{ i \in [l, r] } \{A_i\} \big) $ 的联通块的个数。
## 输入格式

第一行， 四个整数, 表示 $|V|$, $|E|$, $q$, $t$, 其中 $t$ 表示强制在线参数.

以下$|E|$行， 每行一个二元组 $( u, v )$ , 表示 $A$ 序列.

再以下$q$行， 每行一个二元组 $( l' , r' )$ 表示一组加密后的询问.

解密方式:

```
GetQuery( &l, &r, t, last_ans, |E| )
    IF t > 0 THEN 
        l <- (l + t * last_ans) Mod |E| + 1
        r <- (r + t * last_ans) Mod |E| + 1
    IF l > r THEN Swap( l, r )
```
初始时 last_ans = 0.
## 输出格式

$q$ 行，表示每个询问的答案。
## 样例

### 样例输入 #1
```
80 100 100 0
25 73
4 10
9 27
19 26
52 55
4 18
19 31
25 29
14 72
10 13
17 23
13 63
25 46
9 11
40 64
32 48
1 2
19 34
7 39
9 14
57 59
6 47
8 36
40 66
15 67
66 76
21 49
15 38
13 25
4 61
6 32
52 58
1 12
26 44
12 68
1 37
2 45
5 22
47 77
21 60
7 28
29 69
10 78
39 43
11 50
5 6
76 79
5 7
64 70
27 33
1 51
15 75
19 24
46 56
1 3
30 42
23 35
28 57
21 41
11 53
61 65
13 15
28 30
20 49
6 8
1 5
18 40
1 9
34 62
7 16
46 54
56 74
1 17
16 20
11 71
7 19
3 4
13 21
2 80
28 52
29 7
55 27
6 71
46 27
2 68
50 75
37 41
17 13
62 57
72 51
1 54
49 33
1 14
58 29
11 53
1 38
17 46
78 33
1 47
61 5
76 91
99 29
64 67
65 32
85 8
77 57
62 19
42 37
51 41
57 71
79 63
9 17
21 16
87 43
1 77
53 37
38 37
25 69
1 1
97 72
27 31
1 95
66 29
29 63
27 74
18 63
73 11
63 81
33 46
85 19
91 78
15 66
36 89
61 63
21 9
59 23
5 61
41 59
97 79
21 41
81 51
33 57
49 27
37 71
1 9
59 73
16 6
53 41
61 37
3 88
43 43
11 3
41 27
43 30
67 5
1 33
67 15
26 35
21 45
7 65
1 41
25 82
51 4
70 60
15 1
87 77
21 83
63 51
46 43
1 41
99 28
41 17
11 44
45 56
8 31
81 43
37 71
69 6
79 75
1 46
6 75
29 34
21 21
61 39
90 26
76 88
77 41
71 53
25 71
71 43
99 88
5 41
15 51
41 61
37 86
14 47
70 35
81 3
98 4
25 1

```
### 样例输出 #1
```
64
15
76
46
5
59
36
74
69
65
63
71
74
35
3
63
78
35
79
54
75
1
42
45
32
34
17
61
66
13
66
28
28
77
67
43
23
61
61
59
49
55
57
45
71
65
69
67
55
2
79
71
65
66
17
47
27
70
55
21
39
22
32
69
65
69
17
67
76
39
15
55
46
68
56
41
45
16
75
34
10
74
79
57
18
67
43
61
33
51
68
43
43
59
30
46
44
2
2
55

```
## 提示

Subtask1( 15% ): $|V|, |E|, q \le 5000$

Subtask2( 25% ): $t = 0$

Subtask3( 22% ): $|V| \le 10^4, |E|, q \le 3*10^4$

Subtask4( 38% ): 无特殊限制.

对于 100% 的数据保证, $|V| \le 10^5, |E| \le 2*10^5, q \le 10^5, t \in \{0,1\}$


---

---
title: "EntropyIncreaser 与 动态图"
layout: "post"
diff: 省选/NOI-
pid: P5489
tag: ['洛谷原创', '树链剖分', '动态树 LCT']
---
# EntropyIncreaser 与 动态图
## 题目背景

话说 NaCly_Fish 在和  $\mathsf E \color{red}\mathsf{ntropyIncreaser}$ 吃饭时，问过她一个问题：“一个无向图，支持动态加边，求两点间割点数，怎么做？” 

$\mathsf E \color{red} \mathsf{ntropyIncreaser}$ 想了几秒，说：“这不是sb题吗，随便怎么做都行吧。”然后三两句道出了一个算法。

而 NaCly_Fish 还是不会，请你来教教她这题怎么做吧。
## 题目描述

有一个 $n$ 个点的图，初始没有边。  
有 $q$ 个操作，分为 $3$ 种，具体如下：  

- `1 u v` 表示在 $u,v$ 之间连一条无向边  
- `2 u v` 表示求 $u,v$ 间的割边数量   
- `3 u v` 表示求 $u,v$ 间的割点数量   

特别地，对于 $2$、$3$ 操作，若 $u,v$ 不连通，则输出 $-1$    
****
为了防止有歧义，这里给出对两点间割边和割点数量的定义：  
对于所有包含 $u,v$ 的路径的节点集合之交 $S$ ，定义 $S$ 中的元素数量为 $u,v$ 间的割点数。  
对于所有包含 $u,v$ 的路径的边集合之交 $T$ ，定义 $T$ 中的元素数量为 $u,v$ 间的割边数。  
****
**本题强制在线。**  
从第二行开始，每次的输入的 $u,v$ 都需要异或上 $\text{last}$ ，才是实际操作的 $u,v$。  
 $\text{last}$ 为最近一次**答案非 $-1$ 的**询问的答案，定义初始 $\text{last}=0$   
ps：如果您不知道异或是什么意思，可以看这里：[xor](https://www.baidu.com/link?url=bhG_De1gZYsqrIq7dkhgGj8vP87xSSyoIwk0-5p1fyKmf58cznvq0oYJg0XGoyKNpuGk7EsvjUnyvgJ19_ZA3PhoMJ3hIufHZ5GXh1OaIoS&wd=&eqid=ab26bc160004324d000000035d1ed64e)
## 输入格式

第一行两个正整数 $n,q$，表示节点数和操作次数。   
接下来 $q$ 行，每行三个整数，表示一次操作。   

## 输出格式

对于每个$2$、$3$ 操作，输出一行一个整数表示答案。 
## 样例

### 样例输入 #1
```
5 10
1 1 2
1 2 3
2 1 3
3 0 1
1 3 1
1 1 6
2 3 7
1 6 7
1 7 1
3 3 6
```
### 样例输出 #1
```
2
2
-1
3
```
## 提示

~~题目背景为真实事件~~

### 样例说明：  
实际操作为：  
```cpp
5 10
1 1 2
1 2 3
2 1 3
3 2 3
1 1 3
1 3 4
2 1 5
1 4 5
1 5 3
3 1 4
```

【数据范围】
  
对于 $20\%$ 的数据，$1\le n,q \le 2000$ ；   
对于另外 $30\%$ 的数据，所有 $2$、$3$ 操作均在 $1$ 操作之后；    
对于 $100\%$ 的数据，$1\le n \le 10^5$，$1\le q \le 3\times 10^5$。
    
对于 $1$ 操作，保证 $u\neq  v$。  

By：NaCly_Fish

****

欢迎加入 EI队长粉丝裙，群号：$747262201$   


---

---
title: "[DBOI2019] 巫女的职责"
layout: "post"
diff: 省选/NOI-
pid: P5622
tag: ['2019', '洛谷原创', '动态树 LCT']
---
# [DBOI2019] 巫女的职责
## 题目背景

作为八重村的巫女，樱承担着守卫村庄的责任，村子里受到了崩坏的威胁，八重樱，出击！

![bachongyingyingying](http://i0.hdslb.com/bfs/article/81e9465c02e29053f9fbe7c70d3c2644691abda2.png)
## 题目描述

八重古村有 $n$ 座房屋，一开始所有的房子之间都没有路，随着古村的发展，慢慢会出现连接两栋房屋的双向道路。

村民们原本过着无忧无虑的幸福生活，直到与文明作对——崩坏来了，慢慢地，某栋房屋也许会在遭受崩坏兽的侵袭，每只崩坏兽都有着一定的崩坏能，每户人家也许会存在着多只崩坏兽。

樱来了，她接受了驱魔委托，每个委托都是从驱逐某个房子到另一个房子的崩坏兽，樱只能走已有的路，由于这样的路径也许有很多条，聪明的樱只会选择在它们所有路径中都会走过的某些点，即必经点，每次委托樱会在两点间的所有必经点驱魔。
## 输入格式

第一行两个整数：$n,m$ 表示房屋数和事件数

接下来 $m$ 行，每行三个正整数：$opt,x,y$

$opt=1 $时，表示房子 $x$ 和房子 $y$ 间修了一条双向道路(保证没有重边，但不保证没有自环，如有请忽略。)

$opt=2$ 时，表示房子 $x$ 来了一只崩坏能为 $y$ 的崩坏兽

$opt=3$ 时，表示樱完成了一次从 $x$ 到 $y$ 的驱魔委托(不保证 $x$ 与 $y$ 连通，不连通输出 $0$ 即可)

强制在线：记上次$3$的答案为 $\text{lastans}$，初值为 $0$，实际上的$x,y$ 用函数解码：
```cpp
inline const void decode(int &x)
{
	x^=lastans%n;
	if (x>n)x%=n;
	if (!x)x=1;
}
```
## 输出格式

对于每个 $3$ 事件，输出一行一个数表示樱清除的崩坏能的值，答案保证在 $[0,2^{63})$
## 样例

### 样例输入 #1
```
4 7
1 1 2
1 1 3
1 3 4
2 1 1
2 1 2
3 1 4
3 3 4
```
### 样例输出 #1
```
3
0
```
### 样例输入 #2
```
4 8
2 1 629
3 3 1
2 4 923
1 4 2
2 4 542
2 1 918
1 2 3
3 4 3

```
### 样例输出 #2
```
0
5

```
## 提示

【样例 $1$ 说明】

第四个事件使 $1$ 号房屋有 $1$ 点的崩坏能。

第五个事件使 $1$ 号房屋增加了 $2$ 点的崩坏能，此时其崩坏能值为 $3$。

第六个事件显然答案为 $3$，更新 $\text{lastans}=3$ 。

第七个事件真实的 $x=1$，$y=3$，由于第六个事件已经在 $1$ 驱魔，所以没有崩坏能。

$Subtask$ #$1$（$20$ 分）： 

$1\leq n,m\leq 100000$。

$Subtask$ #$2$（$70$ 分）： 

$1\leq n,m\leq 200000$。

$Subtask$ #$3$（$10$ 分）： 

$1\leq n,m\leq 500000$。

所有测试点的时间限制统一为 $1.5 \text s$，内存限制统一为 $125 \text{MiB}$。

### 题目提供者：[$\color{red}{zhengrunzhe}$](https://www.luogu.org/space/show?uid=14374)


---

---
title: "最小mex生成树"
layout: "post"
diff: 省选/NOI-
pid: P5631
tag: ['线段树', '并查集', 'O2优化', '分治', '动态树 LCT']
---
# 最小mex生成树
## 题目背景

这是一道经典题。
## 题目描述

给定 $n$ 个点 $m$ 条边的无向连通图，边有边权。  

设一个自然数集合 $S$ 的 $\text{mex}$ 为：最小的、没有出现在 $S$ 中的自然数。  

现在你要求出一个这个图的生成树，使得其边权集合的 $\text{mex}$ 尽可能小。
## 输入格式

第一行输入两个正整数 $n,m$。

接下来 $m$ 行，每行 $3$ 个非负整数 $u,v,w$，表示 $u,v$ 之间有一条权值为 $w$ 的边。

## 输出格式

输出一行一个自然数，表示最小的 $\text{mex}$ 值。
## 样例

### 样例输入 #1
```
3 3
1 2 0
2 3 1
3 2 2

```
### 样例输出 #1
```
1
```
## 提示

【数据范围】   
- 对于 $20\%$ 的数据，$1\le n \le 100$，$1\le m \le 200$。
- 对于 $50\%$ 的数据，$1\le n \le 2000$，$1\le m \le 3000$。
- 对于 $80\%$ 的数据，$1\le n \le 10^5$，$1\le m \le 2\times 10^5$。
- 对于 $100\%$ 的数据，$1\le n \le 10^6$，$1\le m \le 2\times 10^6,0\le w \le 10^5$。

输入数据规模较大，建议使用高效的读入方式。


---

---
title: "[ICPC 2022 Xi'an R] Bridge"
layout: "post"
diff: 省选/NOI-
pid: P9358
tag: ['平衡树', '2022', 'O2优化', '动态树 LCT', 'ICPC']
---
# [ICPC 2022 Xi'an R] Bridge
## 题目描述

There are $n$ countries numbered from $1$ to $n$ in Erathia. Each country can be regarded as a chain with $m+1$ nodes numbered from $1$ to $m+1$. Initially, node $(a, b)$ is connected with node $(a, b + 1)$ by a street where node $(a, b)$ denotes the $b$-th node of the $a$-th country. There are no bridges between any two countries at first. 

You need to process $q$ queries of the following two types.

- $1\ a\ b$ ($1\leq a < n, 1\leq b\leq m$). Build a bridge between node $(a, b)$ and node $(a + 1, b)$. It is guranteed that at any time, **each node is connected with at most one bridge**.
- $2\ a$ ($1\leq a\leq n$). A hero will walk through Erathia. This hero starts from $(a, 1)$. If the hero is at $(x, y)$ and there is a unvisited bridge connected to him, he passes it, or he goes to $(x, y + 1)$. Once he arrived the $(m+1)$-th node of any conutry, he stops. Please note that 'unvisited bridge' is **independently** judged for each query. 

Your task is to print which country the hero is in at last for the second kind of query. It can be proved that the hero's route is always unique under these constraints.

## 输入格式

The first line contains three integers $n$, $m$ and $q$ ($1 \leq n, m, q \leq 10 ^ 5$).

Each of the following $q$ lines represents a query with format described above.
## 输出格式

For each query of type $2$, output a line with an integer representing the answer.

## 样例

### 样例输入 #1
```
3 4 13
2 2
1 1 3
2 1
2 2
2 3
1 2 4
2 1
2 2
2 3
1 2 1
2 1
2 2
2 3

```
### 样例输出 #1
```
2
2
1
3
3
1
2
3
2
1

```
## 提示

**Source**: The 2022 ICPC Asia Xi'an Regional Contest Problem A.

**Author**: MonkeyKing.
## 题目翻译

### 题目描述

Erathia 大陆上有 $n$ 个国家，从 $1$ 到 $n$ 编号。每个国家可以看成由 $m + 1$ 个结点组成的链，结点从 $1$ 到 $m + 1$ 编号。结点 $(a, b)$ 和 $(a, b + 1)$ 由一条街道连接，其中 $(a, b)$ 表示国家 $a$ 的第 $b$ 个结点。一开始，国家之间没有桥。

你需要处理 $q$ 个操作：

- $1\ a\ b$（$1\leq a < n$，$1\leq b\leq m$）：在 $(a, b)$ 和 $(a + 1, b)$ 之间建造一座桥。**保证每个结点最多和一座桥相连**。
- $2\ a$（$1\leq a\leq n$）：一名英雄走过 Erathia 大陆。他从 $(a, 1)$ 出发。如果这名英雄当前在结点 $(x, y)$ 且有一座未被访问过的桥与之连接，那么他会走过这个桥到达桥的另一端，否则他会走到 $(x, y + 1)$。一旦他到达某个国家的第 $m + 1$ 个结点，他就会停下来。注意两个询问之间的 “未被访问过的桥” 是独立的。

你的任务是对每个操作 $2$ 求出英雄最终所在的国家。

$1\leq n, m, q\leq 10 ^ 5$。

### 输入格式

第一行三个整数 $n, m, q$。

接下来 $q$ 行，每行若干个整数表示一组询问。格式见题目描述。

### 输出格式

对于每个操作 $2$，输出一行一个整数表示答案。




---

---
title: "[NFLSPC #6] 挑战停机问题"
layout: "post"
diff: 省选/NOI-
pid: P9931
tag: ['O2优化', '动态树 LCT']
---
# [NFLSPC #6] 挑战停机问题
## 题目背景

作为新时代的 OIer/XCPCer，你已经不满足于挑战 NPC 问题了。你想挑战数学的不可判定性——图灵停机问题。
## 题目描述

图灵给了你一个程序。程序开始运行之初，有且仅有一个变量 $A$，初始值为 $0$。程序共有 $n$ 行，行号为 $1 \sim n$，每行是如下几种形式之一：

- `A a`：令 $A \gets A + a$，然后执行下一行。
- `G x`：执行第 $x$ 行。
- `I l r x y`：如果 $A \in [l, r]$ 则执行第 $x$ 行，否则执行第 $y$ 行。
- `E`：直接结束程序。

保证最后一行是 `E`。

图灵希望你判断这个程序从第一行开始执行会不会结束。为了进一步检验你到底是不是真的会判定停机问题（还是装的？），图灵还要求你给出 $A$ 最终的值，如果程序不会结束且不存在一个时刻使得在其以后 $A$ 不再变化，则输出 `@Turing ?`。
## 输入格式

本题多测。第一行一个正整数 $T$ 表示数据组数，对于每组数据：

- 第一行一个整数 $n$，表示程序的行数。
- 接下来 $n$ 行，描述程序。
## 输出格式

对于每个询问，输出两行：

- 第一行一个字符串 `Yes` 或 `No`，表示程序是否会结束。
- 第二行一个整数 $A_{0}$ 或字符串 `@Turing ?`，表示 $A$ 最终的值。
## 样例

### 样例输入 #1
```
3
5
I 1 7 1 3
G 4
A 2
G 2
E
6
A 2
I 2 3 5 1
E
G 4
A 1
E
4
A 1
G 1
E
E

```
### 样例输出 #1
```
No
2
Yes
3
No
@Turing ?

```
## 提示

对于所有数据，$1 \leq T \leq 1000$，$1 \leq n, \sum n \leq 10^5$，$1 \leq a \leq 10^9$，$0 \leq l \leq r \leq 10^9$，$1 \leq x, y \leq n$。保证输入涉及到的所有数字都是整数。

- 子任务 1（15 分）：不存在 `I` 类语句。
- 子任务 2（20 分）：$r \leq 100$。
- 子任务 3（40 分）：$\sum \max r \leq 10^5$。
- 子任务 4（25 分）：无特殊限制。

Source：NFLSPC #6 G by chenxia25


---


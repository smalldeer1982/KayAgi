---
title: "[JOI Open 2025] 冒泡排序机 / Bubble Sort Machine"
layout: "post"
diff: 省选/NOI-
pid: P12865
tag: ['树状数组', '2025', '排序', '可持久化线段树', 'JOI（日本）']
---
# [JOI Open 2025] 冒泡排序机 / Bubble Sort Machine
## 题目背景

译自 [JOI Open 2025](https://contests.ioi-jp.org/open-2025/index.html) T1「[Bubble Sort Machine](https://www.luogu.com.cn/fe/api/problem/downloadAttachment/cm7aghex)」/ 「[バブルソート機](https://www.luogu.com.cn/fe/api/problem/downloadAttachment/gkrcwais)」。

## 题目描述


JOI 君——一名算法工程师，开发了冒泡排序机。

冒泡排序机操作长为 $N$ 的整数序列 $a=(a_1,a_2,\ldots,a_N)$。为了让机器能工作，给定 $A_i$ 作为 $a_i$（$1\le i\le N$）的初值。每当机器上的**按钮壹**被按下时，机器会按照如下方式修改序列 $a$：

> 对于 $i=1,2,\ldots,N-1$（按此顺序），若 $a_i\gt a_{i+1}$，交换 $a_i,a_{i+1}$ 的值。

为了使冒泡排序机更博人眼球，JOI 君决定加入以下功能：

> 当**按钮贰**被按下时，给定整数 $l,r$ 作为输入（须满足 $1\le l\le r\le N$），机器会输出 $a_{l}+a_{l+1}+\cdots+a_r$ 的值。

给定整数序列的初值和冒泡排序机的操作序列，编程计算按钮贰的输出值。

## 输入格式


输入格式如下所示：

> $N$ \
> $A_1$ $A_2$ $\cdots$ $A_N$ \
> $Q$ \
> $(\text{Query }1)$ \
> $(\text{Query }2)$ \
> $\vdots$ \
> $(\text{Query }Q)$

这里，$Q$ 指的是冒泡排序机的操作数。每个 $(\text{Query }j)$（$1\le j\le Q$）由若干个空格分隔的数字组成。令 $T_j$ 为 $(\text{Query }j)$ 的首个数字。这行的内容为以下二者之一：

- 若 $T_j=1$，这行再没有其他整数了。这意味着冒泡排序机的第 $j$ 次操作按下了按钮壹。
- 若 $T_j=2$，接下来还有两个整数，依次是 $L_j,R_j$。这意味着冒泡排序机的第 $j$ 次操作按下了按钮贰，给定的输入为 $L_j,R_j$。
## 输出格式


对每个按下按钮贰的操作［意思是，对每个满足 $T_j=2$ 的 $j$（$1\le j\le Q$）］，输出一行一个整数，表示冒泡排序机的输出。你的输出应与询问的顺序相符。
## 样例

### 样例输入 #1
```
4
5 3 5 2
6
2 1 3
1
2 1 1
2 2 4
1
2 1 2
```
### 样例输出 #1
```
13
3
12
5
```
### 样例输入 #2
```
5
1 1 2 1 2
5
2 2 3
1
2 2 4
1
2 2 4
```
### 样例输出 #2
```
3
4
4
```
## 提示


### 样例解释

#### 样例 $1$ 解释

初值为 $a_1=5,a_2=3,a_3=5,a_4=2$，$a=(5,3,5,2)$。接下来在冒泡排序机上操作：

1. 按下按钮贰，输入 $l=1,r=3$。机器输出 $a_1+a_2+a_3=13$。
2. 按下按钮壹。对 $i=1,2,3$，按此顺序进行如下操作：
    - $i=1$：由于 $a_1\gt a_2$，交换二者的值，操作后 $a=(3,5,5,2)$。
    - $i=2$：由于并没有 $a_2\gt a_3$，不操作 $a$。
    - $i=3$：由于 $a_3\gt a_4$，交换二者的值，操作后 $a=(3,5,2,5)$。
3. 按下按钮贰，输入 $l=1,r=1$。机器输出 $a_1=3$。
3. 按下按钮贰，输入 $l=2,r=4$。机器输出 $a_2+a_3+a_4=12$。
5. 按下按钮壹。对 $i=1,2,3$，按此顺序进行如下操作：
    - $i=1$：由于并没有 $a_1\gt a_2$，不操作 $a$。
    - $i=2$：由于 $a_2\gt a_3$，交换二者的值，操作后 $a=(3,2,5,5)$。
    - $i=3$：由于并没有 $a_3\gt a_4$，不操作 $a$。
6. 按下按钮贰，输入 $l=1,r=2$。机器输出 $a_1+a_2=5$。

样例 $1$ 满足子任务 $1,5,6$ 的限制。

#### 样例 $2$ 解释

样例 $2$ 满足子任务 $1,3,5,6$ 的限制。


### 数据范围

- $2\le N\le 500\, 000$；
- $1\le A_i\le 10^9\, (1\le i\le N)$；
- $1\le Q\le 500\, 000$；
- $T_j\in \{1,2\}\, (1\le j\le Q)$；
- 若 $T_j=2$，有 $1\le L_j\le R_j\le N\, (1\le j\le Q)$；
- 输入的值都是整数。

### 子任务

- $\text{Subtask 1 (5 pts)}$：满足 $T_j=1$ 的 $j\,(1\le j\le Q)$ 至多有 $10$ 个；
- $\text{Subtask 2 (11 pts)}$：$N,Q\le 150\, 000$，当 $T_j=2$ 时 $L_j=R_j=1\, (1\le j\le Q)$；
- $\text{Subtask 3 (15 pts)}$：$N,Q\le 150\, 000$，$1\le A_i\le 2\, (1\le i\le N)$；
- $\text{Subtask 4 (23 pts)}$：$N,Q\le 150\, 000$，当 $T_j=2$ 时 $L_j=R_j\, (1\le j\le Q)$；
- $\text{Subtask 5 (29 pts)}$：$N,Q\le 150\, 000$；
- $\text{Subtask 6 (17 pts)}$：无额外限制。




---

---
title: "[ICPC 2025 APC] Tree Quiz"
layout: "post"
diff: 省选/NOI-
pid: P13625
tag: ['线段树', '2024', '可持久化线段树', 'ICPC']
---
# [ICPC 2025 APC] Tree Quiz
## 题目描述

你的朋友想考考你。给你一棵有 $n$ 个节点的有根树，节点编号从 $1$ 到 $n$。对于每个节点 $i$，它的父节点是 $p_i$，除了根节点（没有父节点的节点）的 $p_i=0$。如果节点 $u=v$，或者节点 $u$ 是节点 $v$ 的父节点（如果存在）的祖先，那么我们说节点 $u$ 是节点 $v$ 的一个祖先。

如果节点 $z$ 同时是节点 $x$ 和节点 $y$ 的祖先，我们称节点 $z$ 是节点 $x$ 和 $y$ 的一个共同祖先。如果节点 $z$ 是节点 $x$ 和 $y$ 的一个共同祖先，并且节点 $x$ 和 $y$ 的任何一个共同祖先也都是节点 $z$ 的祖先，那么我们称节点 $z$ 是节点 $x$ 和 $y$ 的最近共同祖先。我们将节点 $x$ 和 $y$ 的最近共同祖先表示为 $\operatorname{LCA}(x,y)$。特别地，$\operatorname{LCA}(x,x)=x$。

你的朋友想要运行以下伪代码：

```
let L be an empty array
for x = 1 to n
  for y = 1 to n
    append ((x-1)*n*n + (LCA(x,y)-1)*n + (y-1)) to L
sort L in non-decreasing order
```

你的朋友有 $q$ 个问题，编号从 $1$ 到 $q$。在第 $j$ 个问题中，会给你一个整数 $k_j$，并要求你找出数组 $L$ 中的第 $k_j$ 个元素。请注意，$L$ 是以 $1$ 为起始下标的，所以其下标范围从 $1$ 到 $n^2$。为了通过测试，你必须回答所有问题。
## 输入格式

输入的第一行包含两个整数 $n$ 和 $q$（$1 \le n \le 100,000$；$1 \le q \le 100,000$）。第二行包含 $n$ 个整数 $p_1, p_2, \dots, p_n$（对于所有的 $i$，$0 \le p_i \le n$）。保证给定的值代表一棵有根树。接下来的 $q$ 行每行包含一个整数。第 $j$ 行包含 $k_j$（$1 \le k_j \le n^2$）。
## 输出格式

对于每个问题，按顺序输出一个整数作为问题的答案。
## 样例

### 样例输入 #1
```
5 3
3 0 2 2 3
1
18
25
```
### 样例输出 #1
```
0
82
124
```
## 提示

输入中的树如图 K.1 所示。

![](https://cdn.luogu.com.cn/upload/image_hosting/3xe1w5tx.png)

$L$ 的元素为 $(0, 6, 8, 12, 14, 30, 31, 32, 33, 34, 56, 58, 60, 62, 64, 80, 81, 82, 84, 93, 106, 108, 110, 112, 124)$。


---

---
title: "[SDOI2010] 粟粟的书架"
layout: "post"
diff: 省选/NOI-
pid: P2468
tag: ['2010', '二分', '各省省选', '山东', '枚举', '可持久化线段树']
---
# [SDOI2010] 粟粟的书架
## 题目描述

幸福幼儿园 B29 班的粟粟是一个聪明机灵、乖巧可爱的小朋友，她的爱好是画画和读书，尤其喜欢 Thomas H. Cormen 的文章。粟粟家中有一个 $R$ 行 $C$ 列的巨型书架，书架的每一个位置都摆有一本书，上数第 $i$ 行、左数第 $j$ 列摆放的书有 $P_{i,j}$ 页厚。

粟粟每天除了读书之外，还有一件必不可少的工作就是摘苹果，她每天必须摘取一个指定的苹果。粟粟家果树上的苹果有的高、有的低，但无论如何凭粟粟自己的个头都难以摘到。不过她发现，如果在脚下放上几本书，就可以够着苹果；她同时注意到，对于第 $i$ 天指定的那个苹果，只要她脚下放置书的总页数之和不低于 $H_i$，就一定能够摘到。

由于书架内的书过多，父母担心粟粟一天内就把所有书看完而耽误了上幼儿园，于是每天只允许粟粟在一个特定区域内拿书。这个区域是一个矩形，第 $i$ 天给定区域的左上角是上数第$x1_i$ 行的左数第 $y1_i$ 本书，右下角是上数第 $x2_i$ 行的左数第 $y2_i$ 本书。换句话说，粟粟在这一天，只能在这 $(x2_i－x1_i＋1)\times(y2_i－y1_i＋1)$ 本书中挑选若干本垫在脚下，摘取苹果。

粟粟每次取书时都能及时放回原位，并且她的书架不会再撤下书目或换上新书，摘苹果的任务会一直持续 $M$ 天。给出每本书籍的页数和每天的区域限制及采摘要求，请你告诉粟粟，她每天至少拿取多少本书，就可以摘到当天指定的苹果。

## 输入格式

第一行是三个正整数 $R, C, M$。

接下来是一个 $R$ 行 $C$ 列的矩阵，从上到下、从左向右依次给出了每本书的页数 $P_{i,j}$。

接下来 $M$ 行，第 $i$ 行给出正整数 $x1_i, y1_i, x2_i, y2_i, H_i$，表示第 $i$ 天的指定区域是 $(x1_i, y1_i)$ 与 $(x2_i, y2_i)$ 间的矩形，总页数之和要求不低于Hi。

保证 $1\le x1_i\le x2_i\le R$，$1\le y1_i\le y2_i\le C$。

## 输出格式

输出共 $M$ 行，第 $i$ 行回答粟粟在第 $i$ 天时为摘到苹果至少需要拿取多少本书。如果即使取走所有书都无法摘到苹果，则在该行输出 `Poor QLW`。

## 样例

### 样例输入 #1
```
5 5 7
14 15 9 26 53
58 9 7 9 32
38 46 26 43 38
32 7 9 50 28
8 41 9 7 17
1 2 5 3 139
3 1 5 5 399
3 3 4 5 91
4 1 4 1 33
1 3 5 4 185
3 3 4 3 23
3 1 3 3 108
```
### 样例输出 #1
```
6
15
2
Poor QLW
9
1
3
```
### 样例输入 #2
```
1 10 7
14 15 9 26 53 58 9 7 9 32
1 2 1 9 170
1 2 1 9 171
1 5 1 7 115
1 1 1 10 228
1 4 1 4 45704571
1 1 1 1 1
1 7 1 8 16
```
### 样例输出 #2
```
6
7
3
10
Poor QLW
1
2
```
## 提示

对于 $10\%$ 的数据，满足 $R, C\le10$。

对于 $20\%$ 的数据，满足 $R, C\le 40$。

对于 $50\%$ 的数据，满足 $R, C\le 200$，$M\le 2\times 10^5$。

另有 $50\%$ 的数据，满足 $R＝1$，$C\le 5\times 10^5$，$M\le 2\times 10^4$。

对于 $100\%$ 的数据，满足 $1\le P_{i,j}\le 1000$，$1\le H_i\le 2\times 10^9$。



---

---
title: "Dynamic Rankings"
layout: "post"
diff: 省选/NOI-
pid: P2617
tag: ['O2优化', '树套树', '可持久化线段树']
---
# Dynamic Rankings
## 题目描述

给定一个含有 $n$ 个数的序列 $a_1,a_2 \dots a_n$，需要支持两种操作：  

- `Q l r k` 表示查询下标在区间 $[l,r]$ 中的第 $k$ 小的数  
- `C x y` 表示将 $a_x$ 改为 $y$ 

## 输入格式

第一行两个正整数 $n,m$，表示序列长度与操作个数。  
第二行 $n$ 个整数，表示 $a_1,a_2 \dots a_n$。  
接下来 $m$ 行，每行表示一个操作，都为上述两种中的一个。
## 输出格式

对于每一次询问，输出一行一个整数表示答案。

## 样例

### 样例输入 #1
```
5 3
3 2 1 4 7
Q 1 4 3
C 2 6
Q 2 5 3
```
### 样例输出 #1
```
3
6

```
## 提示

【数据范围】  

对于 $10\%$ 的数据，$1\le n,m \le 100$；  
对于 $20\%$ 的数据，$1\le n,m \le 1000$；  
对于 $50\%$ 的数据，$1\le n,m \le 10^4$；     
对于 $100\%$ 的数据，$1\le n,m \le 10^5$，$1 \le l \le r \le n$，$1 \le k \le r-l+1$，$1\le x \le n$，$0 \le a_i,y \le 10^9$。

请注意常数优化，但写法正常的整体二分和树套树都可以以大约 $1000\text{ms}$ 每个点的时间通过。

来源：bzoj1901

本题数据为洛谷自造数据，使用[CYaRon](https://github.com/luogu-dev/cyaron)耗时5分钟完成数据制作。



---

---
title: "Count on a tree"
layout: "post"
diff: 省选/NOI-
pid: P2633
tag: ['线段树', '最近公共祖先 LCA', '可持久化线段树', '可持久化']
---
# Count on a tree
## 题目描述

给定一棵 $n$ 个节点的树，每个点有一个权值。有 $m$ 个询问，每次给你 $u,v,k$，你需要回答 $u \text{ xor last}$ 和 $v$ 这两个节点间第 $k$ 小的点权。  

其中 $\text{last}$ 是上一个询问的答案，定义其初始为 $0$，即第一个询问的 $u$ 是明文。

## 输入格式

第一行两个整数 $n,m$。

第二行有 $n$ 个整数，其中第 $i$ 个整数表示点 $i$ 的权值。

后面 $n-1$ 行每行两个整数 $x,y$，表示点 $x$ 到点 $y$ 有一条边。

最后 $m$ 行每行三个整数 $u,v,k$，表示一组询问。

## 输出格式

$m$ 行，每行一个正整数表示每个询问的答案。

## 样例

### 样例输入 #1
```
8 5
105 2 9 3 8 5 7 7
1 2
1 3
1 4
3 5
3 6
3 7
4 8
2 5 1
0 5 2
10 5 3
11 5 4
110 8 2
```
### 样例输出 #1
```
2
8
9
105
7
```
## 提示

【数据范围】  
对于 $100\%$ 的数据，$1\le n,m \le 10^5$，点权在 $[1, 2 ^ {31} - 1]$ 之间。

暴力自重。。。

来源：bzoj2588 Spoj10628.

本题数据为洛谷自造数据，使用 [CYaRon](https://github.com/luogu-dev/cyaron) 耗时 5 分钟完成数据制作。



---

---
title: "[国家集训队] middle"
layout: "post"
diff: 省选/NOI-
pid: P2839
tag: ['二分', '集训队互测', '可持久化线段树']
---
# [国家集训队] middle
## 题目描述

一个长度为 $n$ 的序列 $a$，设其排过序之后为 $b$，其中位数定义为 $b_{n/2}$，其中 $a,b$ 从 $0$ 开始标号，除法下取整。

给你一个长度为 $n$ 的序列 $s$。

回答 $Q$ 个这样的询问：$s$ 的左端点在 $[a,b]$ 之间，右端点在 $[c,d]$ 之间的子区间中，最大的中位数。

其中 $a<b<c<d$。

位置也从 $0$ 开始标号。

我会使用一些方式强制你在线。

## 输入格式

第一行序列长度 $n$。

接下来 $n$ 行按顺序给出 $a$ 中的数。

接下来一行 $Q$。

然后 $Q$ 行每行 $a,b,c,d$，我们令上个询问的答案是 $x$（如果这是第一个询问则 $x=0$）。

令数组 $q=\{(a+x)\bmod n,(b+x)\bmod n,(c+x)\bmod n,(d+x)\bmod n\}$。

将 $q$ 从小到大排序之后，令真正的要询问的 $a=q_0$，$b=q_1$，$c=q_2$，$d=q_3$。

输入保证满足条件。

## 输出格式

$Q$ 行依次给出询问的答案。

## 样例

### 样例输入 #1
```
5
170337785
271451044
22430280
969056313
206452321
3
3 1 0 2
2 3 1 4
3 1 4 0
```
### 样例输出 #1
```
271451044
271451044
969056313
```
## 提示

对于 $5\%$ 的数据，$n,Q \leq 100$；

对于另 $25\%$ 的数据，$n \leq 2000$；

对于 $100\%$ 的数据，$1\leq n \leq 20000$，$1\leq Q \leq 25000$，$1\leq a_i\leq 10 ^ 9$。


---

---
title: "[CQOI2011] 动态逆序对"
layout: "post"
diff: 省选/NOI-
pid: P3157
tag: ['2011', '重庆', '各省省选', '树状数组', 'cdq 分治', '可持久化线段树']
---
# [CQOI2011] 动态逆序对
## 题目描述

对于序列 $a$，它的逆序对数定义为集合  
$$\{(i,j)| i<j \wedge a_i > a_j \}$$
中的元素个数。  

现在给出 $1\sim n$ 的一个排列，按照某种顺序依次删除 $m$ 个元素，你的任务是在每次删除一个元素**之前**统计整个序列的逆序对数。

## 输入格式

第一行包含两个整数 $n$ 和 $m$，即初始元素的个数和删除的元素个数。  
以下 $n$ 行，每行包含一个 $1 \sim n$ 之间的正整数，即初始排列。  
接下来 $m$ 行，每行一个正整数，依次为每次删除的元素。

## 输出格式

输出包含 $m$ 行，依次为删除每个元素之前，逆序对的个数。

## 样例

### 样例输入 #1
```
5 4
1
5
3
4
2
5
1
4
2
```
### 样例输出 #1
```
5
2
2
1
```
## 提示

【数据范围】   
对于 $100\%$ 的数据，$1\le n \le 10^5$，$1\le m \le 50000$。

【样例解释】  
删除每个元素之前的序列依次为：  
$$1,5,3,4,2$$  
$$1,3,4,2$$  
$$3,4,2$$  
$$3,2$$  


---

---
title: "[CQOI2015] 任务查询系统"
layout: "post"
diff: 省选/NOI-
pid: P3168
tag: ['2015', '重庆', '线段树', '各省省选', '可持久化线段树', '可持久化']
---
# [CQOI2015] 任务查询系统
## 题目描述

最近实验室正在为其管理的超级计算机编制一套任务管理系统，而你被安排完成其中的查询部分。  

超级计算机中的任务用三元组 $(s_i, e_i, p_i)$ 描述，$(s_i, e_i, p_i)$ 表示任务从第 $s_i$ 秒开始，在第 $e_i$ 秒后结束（第 $s_i$ 秒和 $e_i$ 秒任务也在运行），其优先级为 $p_i$。同一时间可能有多个任务同时执行，它们的优先级可能相同，也可能不同。  

调度系统会经常向查询系统询问，第 $x_i$ 秒正在运行的任务中，优先级最小的 $k_i$ 个任务（即将任务按照优先级从小到大排序后取前 $k_i$ 个）的优先级之和是多少。  

特别的，如果 $k_i$ 大于第 $x_i$ 秒正在运行的任务总数，则直接回答第 $x_i$ 秒正在运行的任务优先级之和。上述所有参数均为整数，时间的范围在 $[1, n]$ 之间。

## 输入格式

输入文件第一行包含两个空格分开的正整数 $m$ 和 $n$，分别表示任务总数和时间范围。  

接下来 $m$ 行，每行包含三个空格分开的正整数 $s_i,e_i,p_i$（$s_i \le e_i$），描述一个任务。  

接下来 $n$ 行，每行包含四个空格分开的整数 $x_i,a_i,b_i,c_i$，描述一次查询。  

**本题强制在线**。查询的参数 $k_i$ 需要由公式 $k_i = 1 +(a_i \times \text{pre}+b_i) \bmod c_i$ 计算得到。其中 $\text{pre}$ 表示上一次查询的结果，定义初始 $\text{pre} = 1$ 。

## 输出格式

输出共 $n$ 行，每行一个整数，表示查询结果。

## 样例

### 样例输入 #1
```
4 3
1 2 6
2 3 3
1 3 2
3 3 4
3 1 3 2
1 1 3 4
2 2 4 3
```
### 样例输出 #1
```
2
8
11
```
## 提示

【样例解释】

$k_1 = (1\times 1 + 3)\bmod 2 + 1 = 1$；

$k_2 = (1\times 2+3)\bmod 4 + 1 = 2$；

$k_3 = (2 \times 8+4)\bmod 3+1 = 3$。

【数据范围】
 
对于 $100\%$ 的数据，$1\le m,n,c_i \le 10 ^ 5$，$0 \le a _ i, b _ i \le 10 ^ 5$，$1\leq s_i\leq e_i\leq n$，$1\le p_i \le 10^7$，$x_i$ 为 $1$ 到 $n$ 的一个排列。


注：2024-12-28 加入一个 hack 数据，[帖子链接](https://www.luogu.com.cn/discuss/1025247)。


---

---
title: "[HNOI2016] 树"
layout: "post"
diff: 省选/NOI-
pid: P3248
tag: ['2016', '各省省选', '湖南', '最近公共祖先 LCA', '树套树', '可持久化线段树']
---
# [HNOI2016] 树
## 题目描述

小A想做一棵很大的树，但是他手上的材料有限，只好用点小技巧了。开始，小A只有一棵结点数为 $N$ 的树，结点的编号为 $1,2,...,N$，其中结点 $1$ 为根；我们称这颗树为模板树。小A决定通过这棵模板树来构建一颗大树。构建过程如下：

1. 将模板树复制为初始的大树。

2. 以下(2.1)(2.2)(2.3)步循环执行 $M$ 次

（2.1）选择两个数字 $a,b$，其中 $1 \leq a \leq N, 1 \leq b \leq \text{当前大树的结点数}$。

（2.2）将模板树中以结点 $a$ 为根的子树复制一遍，挂到大树中结点 $b$ 的下方(也就是说，模板树中的结点 $a$ 为根的子树复制到大树中后，将成为大树中结点 $b$ 的子树)。

（2.3）将新加入大树的结点按照在模板树中编号的顺序重新编号。例如，假设在进行2.2步之前大树有 $L$ 个结点，模板树中以 $a$ 为根的子树共有 $C$ 个结点，那么新加入模板树的 $C$ 个结点在大树中的编号将是 $L+1,L+2,...,L+C$ ；大树中这C个结点编号的大小顺序和模板树中对应的 $C$ 个结点的大小顺序是一致的。下面给出一个实例。假设模板树如下图：![](https://cdn.luogu.com.cn/upload/image_hosting/mchs3i55.png)

根据第(1)步，初始的大树与模板树是相同的。

在(2.1)步，假设选择了 $a=4, b=3$。运行(2.2)和(2.3)后，得到新的大树如下图所示

![](https://cdn.luogu.com.cn/upload/image_hosting/ey2lqez8.png)

现在他想问你，树中一些结点对的距离是多少。

## 输入格式

第一行三个整数：$N,M,Q$，以空格隔开，$N$ 表示模板树结点数，$M$ 表示第(2)中的循环操作的次数，$Q$ 表示询问数量。

接下来 $N-1$ 行，每行两个整数 $fr,to$，表示模板树中的一条树边。

再接下来$M$行，每行两个整数$x,to$，表示将模板树中 $x$ 为根的子树复制到大树中成为结点 $to$ 的子树的一次操作。

再接下来 $Q$ 行，每行两个整数 $fr,to$，表示询问大树中结点 $fr$ 和 $to$ 之间的距离是多少。

$N,M,Q \leq 100000$

## 输出格式

输出 $Q$ 行，每行一个整数，第 $i$ 行是第 $i$ 个询问的答案。

## 样例

### 样例输入 #1
```
5 2 3
1 4
1 3
4 2
4 5
4 3
3 2
6 9
1 8
5 3
```
### 样例输出 #1
```
6
3
3
```
## 提示

经过两次操作后，大树变成了下图所示的形状：

![](https://cdn.luogu.com.cn/upload/image_hosting/370xfnn2.png)

结点6到9之间经过了6条边，所以距离为6；类似地，结点1到8之间经过了3条边；结点5到3之间也经过了3条边。



---

---
title: "[SCOI2016] 美味"
layout: "post"
diff: 省选/NOI-
pid: P3293
tag: ['贪心', '2016', '四川', '可持久化线段树', '可持久化']
---
# [SCOI2016] 美味
## 题目描述


一家餐厅有 $n$ 道菜，编号 $1, 2, \ldots, n$，大家对第 $i$ 道菜的评价值为 $a_i$。有 $m$ 位顾客，第 $i$ 位顾客的期望值为 $b_i$，而他的偏好值为 $x_i$。因此，第 $i$ 位顾客认为第 $j$ 道菜的美味度为 $b_i\oplus (a_j + x_i)$，$\oplus$ 表示异或运算。

第 $i$ 位顾客希望从这些菜中挑出他认为最美味的菜，即美味值最大的菜，但由于价格等因素，他只能从第 $l_i$ 道到第 $r_i$ 道中选择。请你帮助他们找出最美味的菜。
## 输入格式

第 $1$ 行两个整数 $n, m$，表示菜品数和顾客数。

第 $2$ 行 $n$ 个整数 $a_1, a_2, \ldots, a_n$，表示每道菜的评价值。

第 $3$ 至 $m + 2$ 行，每行四个整数 $b,x,l,r$，表示该位顾客的期望值，偏好值，和可以选择菜品区间。
## 输出格式

输出 $m$ 行，每行一个整数表示该位顾客选择的最美味的菜的美味值。
## 样例

### 样例输入 #1
```
4 4
1 2 3 4
1 4 1 4
2 3 2 3
3 2 3 3
4 1 2 4
```
### 样例输出 #1
```
9 
7 
6 
7
```
## 提示

对于 $100\%$ 的数据，满足 $1 \le n \le 2 \times 10^5$，$0 \le a_i,b_i,x_i < 10^5$，$1 \le l_i \le r_i \le n$（$1 \le i \le m$），$1 \le m \le 10^5$。


---

---
title: "[SDOI2013] 森林"
layout: "post"
diff: 省选/NOI-
pid: P3302
tag: ['2013', '线段树', '山东', '深度优先搜索 DFS', '可持久化线段树']
---
# [SDOI2013] 森林
## 题目描述

小 Z 有一片森林，含有 $N$ 个节点，每个节点上都有一个非负整数作为权值。初始的时候，森林中有 $M$ 条边。

小Z希望执行 $T$ 个操作，操作有两类：

 - `Q x y k` 查询点 $x$ 到点 $y$ 路径上所有的权值中，第 $k$ 小的权值是多少。此操作保证点 $x$ 和点 $y$ 连通，同时这两个节点的路径上至少有 $k$ 个点。
 - `L x y` 在点 $x$ 和点 $y$ 之间连接一条边。保证完成此操作后，仍然是一片森林。

为了体现程序的在线性，我们把输入数据进行了加密。设 $lastans$ 为程序上一次输出的结果，初始的时候 $lastans$ 为 $0$。

对于一个输入的操作 `Q x y k`，其真实操作为 `Q x^lastans y^lastans k^lastans`。

对于一个输入的操作 `L x y`，其真实操作为 `L x^lastans y^lastans`。其中 `^` 运算符表示异或，等价于 Pascal 中的 `xor` 运算符。

请写一个程序来帮助小 Z 完成这些操作。
## 输入格式

第一行包含一个正整数 $\mathrm{testcase}$，表示当前测试数据的测试点编号。

第二行包含三个整数 $N,M,T$，分别表示节点数、初始边数、操作数。

第三行包含 $N$ 个非负整数表示 $N$ 个节点上的权值。

接下来 $M$ 行，每行包含两个整数 $x$ 和 $y$，表示初始的时候，点 $x$ 和点 $y$ 之间有一条无向边。

接下来 $T$ 行，每行描述一个操作，格式为 `Q x y k` 或者 `L x y`，其含义见题目描述部分。
## 输出格式

对于每一个第一类操作，输出一个非负整数表示答案。
## 样例

### 样例输入 #1
```
1
8 4 8
1 1 2 2 3 3 4 4
4 7
1 8
2 4
2 1
Q 8 7 3
Q 3 5 1
Q 10 0 0
L 5 4
L 3 2
L 0 7
Q 9 2 5
Q 6 1 6
```
### 样例输出 #1
```
2 
2
1
4
2
```
## 提示

**样例解释**

对于第一个操作 `Q 8 7 3`，此时 $lastans=0$，所以真实操作为 `Q 8^0 7^0 3^0`，也即 `Q 8 7 3`。点 $8$ 到点 $7$ 的路径上一共有 $5$ 个点，其权值为 $4\ 1\ 1\ 2\ 4$。这些权值中，第三小的为 $2$，输出 $2$，$lastans$ 变为 $2$。

对于第二个操作 `Q 3 5 1` ，此时 $lastans=2$，所以真实操作为 `Q 3^2 5^2 1^2`，也即 `Q 1 7 3`。点 $1$ 到点 $7$ 的路径上一共有 $4$ 个点，其权值为 $1\ 1\ 2\ 4$ 。这些权值中，第三小的为 $2$，输出 $2$，$lastans$ 变为 $2$。之后的操作类似。

-----
**数据范围**

| 测试点编号  | $N,M,T$ 的上界 |  `L` 操作   |  `Q` 操作  | 形态 |
| :---------: | :------------: | :---------: | :--------: | :--: |
|     $1$     |      $20$      |     N/A     |    N/A     | N/A  |
|     $2$     |     $200$      |     N/A     |    N/A     | N/A  |
|  $3\sim 4$  | $4\times 10^4$ | 无 `L` 操作 |    N/A     |  链  |
|  $5\sim 6$  | $8\times 10^4$ | 无 `L` 操作 |    N/A     |  链  |
|  $7\sim 9$  | $8\times 10^4$ | 无 `L` 操作 | 保证 $k=1$ | N/A  |
| $10\sim 11$ | $4\times 10^4$ |     N/A     | 保证 $k=1$ | N/A  |
| $12\sim 13$ | $8\times 10^4$ |     N/A     | 保证 $k=1$ | N/A  |
| $14\sim 15$ | $4\times 10^4$ | 无 `L` 操作 |    N/A     | N/A  |
| $16\sim 17$ | $8\times 10^4$ | 无 `L` 操作 |    N/A     | N/A  |
|    $18$     | $4\times 10^4$ |     N/A     |    N/A     | N/A  |
| $19\sim 20$ | $8\times 10^4$ |     N/A     |    N/A     | N/A  |

注：N/A 表示没有特殊性。

对于 $100\%$ 的测试数据，所有节点的编号在 $1\sim N$ 的范围内。节点上的权值 $\le 10^9$。$M<N$。


---

---
title: "[POI 2014] RAJ-Rally"
layout: "post"
diff: 省选/NOI-
pid: P3573
tag: ['2014', '线段树', 'POI（波兰）', 'Special Judge', '可持久化线段树']
---
# [POI 2014] RAJ-Rally
## 题目描述

  An annual bicycle rally will soon begin in Byteburg.

The bikers of Byteburg are natural long distance cyclists.

Local representatives of motorcyclists, long feuding the cyclists,  have decided to sabotage the event.

There are ![](http://main.edu.pl/images/OI21/raj-en-tex.1.png) intersections in Byteburg, connected with one way streets.

Strangely enough, there are no cycles in the street network - if one can ride from  intersection ![](http://main.edu.pl/images/OI21/raj-en-tex.2.png) to intersection ![](http://main.edu.pl/images/OI21/raj-en-tex.3.png), then it is definitely impossible to get from ![](http://main.edu.pl/images/OI21/raj-en-tex.4.png) to ![](http://main.edu.pl/images/OI21/raj-en-tex.5.png).

The rally's route will lead through Byteburg's streets.

The motorcyclists plan to ride their blazing machines in the early morning of the rally day  to one intersection and completely block it.

The cyclists' association will then of course determine an alternative route  but it could happen that this new route will be relatively short,  and the cyclists will thus be unable to exhibit their remarkable endurance.

Clearly, this is the motorcyclists' plan - they intend to block such an intersection  that the longest route that does not pass through it is as short as 

## 输入格式

In the first line of the standard input, there are two integers, N and M(2<=N<=500 000,1<=M<=1 000 000), separated by a single space, that specify the number of intersections and streets in Byteburg. The intersections are numbered from   to  . The   lines that follow describe the street network: in the  -th of these lines, there are two integers, Ai, Bi(1<=Ai,Bi<=N,Ai<>Bi), separated by a single space, that signify that there is a one way street from the intersection no. Ai to the one no. Bi

## 输出格式

The first and only line of the standard output should contain two integers separated by a single space.

The first of these should be the number of the intersection that the motorcyclists should block,  and the second - the maximum number of streets that the cyclists can then ride along in their rally.

If there are many solutions, your program can choose one of them arbitrarily.
## 样例

### 样例输入 #1
```
6 5
1 3
1 4
3 6
3 4
4 5

```
### 样例输出 #1
```
1 2

```
## 提示

感谢@zyh2015 提供spj

## 题目翻译

### 题目描述

给定一个 $n$ 个点 $m$ 条边的有向无环图，每条边长度都是 $1$。

请找到一个点，使得删掉这个点后剩余的图中的最长路径最短。

### 输入格式

第一行包含两个正整数 $n$，$m$（$2\le n\le5\times10^5$，$1\le m\le10^6$），表示点数、边数。

接下来 $m$ 行每行包含两个正整数 $a_i,b_i$（$1\le a_i,b_i\le n,a_i\ne b_i$），表示 $a_i$ 到 $b_i$ 有一条边。

### 输出格式

包含一行两个整数 $x$，$y$，用一个空格隔开，$x$ 为要删去的点，$y$ 为删除 $x$ 后图中的最长路径的长度，如果有多组解请输出任意一组。


---

---
title: "[CQOI2017] 老C的任务"
layout: "post"
diff: 省选/NOI-
pid: P3755
tag: ['2017', '重庆', '各省省选', '离散化', 'cdq 分治', '可持久化线段树']
---
# [CQOI2017] 老C的任务
## 题目描述

老 C 是个程序员。


最近老 C 从老板那里接到了一个任务——给城市中的手机基站写个管理系统。作为经验丰富的程序员，老 C 轻松地完成了系统的大部分功能，并把其中一个功能交给你来实现。

由于一个基站的面积相对于整个城市面积来说非常的小，因此每个的基站都可以看作坐标系中的一个点，其位置可以用坐标 $(x,y)$ 来表示。此外，每个基站还有很多属性，例如高度、功率等。运营商经常会划定一个区域，并查询区域中所有基站的信息。

现在你需要实现的功能就是，对于一个给定的矩形区域，回答该区域中（包括区域边界上的）所有基站的功率总和。如果区域中没有任何基站，则回答 $0$。

## 输入格式

第一行两个整数 $n,m$，表示一共有 $n$ 个基站和 $m$ 次查询。接下来一共有 $n$ 行，每行由 $x_i,y_i,p_i$ 三个空格隔开的整数构成，表示一个基站的坐标 $(x_i,y_i)$ 和功率 $p_i$。不会有两个基站位于同一坐标。

接下来一共有 $m$ 行，每行由 $x_1,y_1,x_2,y_2$ 四个空格隔开的整数构成，表示一次查询的矩形区域。该矩形对角坐标为 $(x_1,y_1)$ 和 $(x_2,y_2)$，且边与坐标轴平行。

## 输出格式

输出 $m$ 行，每行一个整数，对应每次查询的结果。

## 样例

### 样例输入 #1
```
4 2   
0 0 1 
0 1 2  
2 2 4  
1 0 8  
0 0 1 1 
1 1 5 6 
```
### 样例输出 #1
```
11
4
```
### 样例输入 #2
```
3 2
-100 0 16 
1 -10 32 
1000 100 64 
0 0 0 1 
-1000 -1000 10000 10000 
```
### 样例输出 #2
```
0
112
```
## 提示

对于第 $1\sim2$ 个测试点，$1≤n,m≤100$；

对于第 $3\sim5$ 个测试点，$1≤n≤50000,1≤m≤10000$；

对于第 $6\sim10$ 个测试点，$1≤n≤100000,1≤m≤100000$，数据有梯度；

对于所有测试点，$-2^{31}\le x_i,y_i,p_i,x_1,y_1,x_2,y_2<2^{31},x_1\le x_2,y_1\le y_2$。



---

---
title: "[湖南集训] 更为厉害"
layout: "post"
diff: 省选/NOI-
pid: P3899
tag: ['线段树', '湖南', '深度优先搜索 DFS', '可持久化线段树']
---
# [湖南集训] 更为厉害
## 题目描述

设 $\text T$ 为一棵有根树，我们做如下的定义：

- 设 $a$ 和 $b$ 为 $\text T$ 中的两个不同节点。如果 $a$ 是 $b$ 的祖先，那么称“$a$ 比 $b$ 更为厉害”。
- 设 $a$ 和 $b$ 为 $\text T$ 中的两个不同节点。如果 $a$ 与 $b$ 在树上的距离不超过某个给定常数 $x$，那么称“ $a$ 与 $b$ 彼此彼此”。

给定一棵 $n$ 个节点的有根树 $\text T$，节点的编号为 $1$ 到 $n$，根节点为 $1$ 号节点。
你需要回答 $q$ 个询问，询问给定两个整数 $p$ 和 $k$，问有多少个有序三元组 $(a,b,c)$ 满足：

1. $a,b,c$ 为 $\text T$ 中三个不同的点，且 $a$ 为 $p$ 号节点；
2. $a$ 和 $b$ 都比 $c$ 更为厉害；
3. $a$ 和 $b$ 彼此彼此。这里彼此彼此中的常数为给定的 $k$。

## 输入格式

输入文件的第一行含有两个正整数 $n$ 和 $q$，分别代表有根树的点数与询问的个数。

接下来 $n - 1$ 行，每行描述一条树上的边。每行含有两个整数 $u$ 和 $v$，代表在节点 $u$ 和 $v$ 之间有一条边。

接下来 $q$ 行，每行描述一个操作。第 $i$ 行含有两个整数，分别表示第 $i$ 个询问的 $p$ 和 $k$。

## 输出格式

输出 $q$ 行，每行对应一个询问，代表询问的答案。

## 样例

### 样例输入 #1
```
5 3
1 2
1 3
2 4
4 5
2 2
4 1
2 3
```
### 样例输出 #1
```
3
1
3
```
## 提示

样例中的树如下图所示：

 ![](https://cdn.luogu.com.cn/upload/pic/6858.png) 

对于第一个和第三个询问，合法的三元组有 $(2,1,4)$、 $(2,1,5)$ 和 $(2,4,5)$。

对于第二个询问，合法的三元组只有 $(4,2,5)$。


所有测试点的数据规模如下（注意，洛谷并不按照以下方式评测）：

 ![](https://cdn.luogu.com.cn/upload/pic/6859.png) 

对于全部测试数据的所有询问，$1\le p,k \le n$。

- 2023.9.15 添加一组 hack 数据。


---

---
title: "[SHOI2013] 发牌"
layout: "post"
diff: 省选/NOI-
pid: P3988
tag: ['模拟', '2013', '线段树', '各省省选', '平衡树', '树状数组', '上海', '可持久化线段树']
---
# [SHOI2013] 发牌
## 题目描述

在一些扑克游戏里，如德州扑克，发牌是有讲究的。一般称呼专业的发牌手为荷官。荷官在发牌前，先要销牌（burn card）。所谓销牌，就是把当前在牌库顶的那一张牌移动到牌库底，它用来防止玩家猜牌而影响游戏。

假设一开始，荷官拿出了一副新牌，这副牌有 $N$ 张不同的牌，编号依次为 $1$ 到 $N$。由于是新牌，所以牌是按照顺序排好的，从牌库顶开始，依次为 $1,2,\cdots,N$，$N$ 号牌在牌库底。为了发完所有的牌，荷官会进行 $N$ 次发牌操作，在第 $i$ 次发牌之前，他会连续进行 $R_i$ 次销牌操作，$R_i$ 由输入给定。请问最后玩家拿到这副牌的顺序是什么样的？

举个例子，假设 $N=4$，则一开始的时候，牌库中牌的构成顺序为 $1,2,3,4$。

- 假设 $R_1=2$，则荷官应该连销两次牌，将 $1$ 和 $2$ 放入牌库底，再将 $3$ 发给玩家。目前牌库中的牌顺序为 $4,1,2$。
- 假设 $R_2=0$，荷官不需要销牌，直接将 $4$ 发给玩家，目前牌库中的牌顺序为 $1,2$。
- 假设 $R_3=3$，则荷官依次销去了 $1,2,1$，再将 $2$ 发给了玩家。目前牌库仅剩下一张牌 $1$。
- 假设 $R_4=2$，荷官在重复销去两次 $1$ 之后，还是将 $1$ 发给了玩家，这是因为 $1$ 是牌库中唯一的一张牌。
## 输入格式

第一行，一个整数 $N$，表示牌的数量。

第二行到第 $N+1$ 行，在第 $i+1$ 行，有一个整数 $R_i$。

## 输出格式

共 $N$ 行，第 $i$ 行有一个整数，表示玩家收到的第 $i$ 张牌的编号。
## 样例

### 样例输入 #1
```
4
2
0
3
2
```
### 样例输出 #1
```
3
4
2
1
```
## 提示

#### 数据规模与约定

对于 $100 \%$ 的数据，$0 \le R_i < N$。  

| 测试点编号 | $N=$ | 测试点编号 | $N=$ |
| :----------: | :----------: | :----------: | :----------: |
| $1$ | $5\times 10^3$ | $6$ | $3\times 10^5$ |
| $2$ | $10^4$ |  $7$ | $4\times 10^5$ |
| $3$ | $5\times 10^4$ | $8$ | $5\times 10^5$ |
| $4$ | $10^5$ | $9$ | $6\times 10^5$ |
| $5$ | $2\times 10^5$ | $10$ | $7\times 10^5$ |


---

---
title: "[CTSC2008] 网络管理"
layout: "post"
diff: 省选/NOI-
pid: P4175
tag: ['2008', '线段树', '平衡树', '树状数组', '树链剖分', '可持久化线段树', 'CTSC/CTS']
---
# [CTSC2008] 网络管理
## 题目描述

M 公司是一个非常庞大的跨国公司，在许多国家都设有它的下属分支机构或部门。为了让分布在世界各地的 $n$ 个部门之间协同工作，公司搭建了一个连接整个公司的通信网络。  

该网络的结构由 $n$ 个路由器和 $n-1$ 条高速光缆组成。每个部门都有一个专属的路由器，部门局域网内的所有机器都联向这个路由器，然后再通过这个通信子网与其他部门进行通信联络。该网络结构保证网络中的任意两个路由器之间都存在一条直接或间接路径以进行通信。   

高速光缆的数据传输速度非常快，以至于利用光缆传输的延迟时间可以忽略。但是由于路由器老化，在这些路由器上进行数据交换会带来很大的延迟。而两个路由器之间的通信延迟时间则与这两个路由器通信路径上所有路由器中最大的交换延迟时间有关。  

作为 M 公司网络部门的一名实习员工，现在要求你编写一个简单的程序来监视公司的网络状况。该程序能够随时更新网络状况的变化信息（路由器数据交换延迟时间的变化），并且根据询问给出两个路由器通信路径上延迟第 $k$ 大的路由器的延迟时间。
****
【任务】   
你的程序从输入文件中读入 $n$ 个路由器和 $n-1$ 条光缆的连接信息，每个路由器初始的数据交换延迟时间 $t_i$，以及 $q$ 条询问（或状态改变）的信息。并依次处理这 $q$ 条询问信息，它们可能是：

1. 由于更新了设备，或者设备出现新的故障，使得某个路由器的数据交换延迟时间发生了变化。

2. 查询某两个路由器 $a$ 和 $v$ 之间的路径上延迟第 $k$ 大的路由器的延迟时间。

## 输入格式

第一行为两个整数 $n$ 和 $q$，分别表示路由器总数和询问的总数。

第二行有 $n$ 个整数，第 $i$ 个数表示编号为i的路由器初始的数据延迟时间 $t_i$。

紧接着 $n-1$ 行，每行包含两个整数 $x$ 和 $y$。表示有一条光缆连接路由器 $x$ 和路由器 $y$。

紧接着是 $q$ 行，每行三个整数 $k,a,b$。

如果 $k=0$，则表示路由器 $a$ 的状态发生了变化，它的数据交换延迟时间由 $t_a$ 变为 $b$。

如果 $k>0$，则表示询问 $a$ 到 $b$ 的路径上所经过的所有路由器（包括 $a$ 和 $b$）中延迟第 $k$ 大的路由器的延迟时间。注意 $a$ 可以等于 $b$，此时路径上只有一个路由器。

## 输出格式

对于每一个第二种询问（即 $k>0$ ），输出一行。  
包含一个整数为相应的延迟时间。如果路径上的路由器不足 $k$ 个，则输出信息 `invalid request!`。

## 样例

### 样例输入 #1
```
5 5
5 1 2 3 4
3 1
2 1
4 3
5 3
2 4 5
0 1 2
2 2 3
2 1 4
3 3 5
```
### 样例输出 #1
```
3
2
2
invalid request!
```
## 提示

【数据范围】  
对于 $100\%$ 的数据，$1\le n,q \le 80000$，$0 \le k \le n$，任意一个路由器在任何时刻都满足延迟时间小于 $10^8$。




---

---
title: "Peaks"
layout: "post"
diff: 省选/NOI-
pid: P4197
tag: ['倍增', '生成树', '可持久化线段树']
---
# Peaks
## 题目描述

在 Bytemountains 有 $n$ 座山峰，每座山峰有他的高度 $h_i$。有些山峰之间有双向道路相连，共 $m$ 条路径，每条路径有一个困难值，这个值越大表示越难走。  

现在有 $q$ 组询问，每组询问询问从点 $v$ 开始只经过困难值小于等于 $x$ 的路径所能到达的山峰中第 $k$ 高的山峰，如果无解输出 $-1$。
## 输入格式

第一行三个数 $n,m,q$。
第二行 $n$ 个数，第 $i$ 个数为 $h_i$。

接下来 $m$ 行，每行三个整数 $a,b,c$，表示从 $a \to b$ 有一条困难值为 $c$ 的双向路径。
接下来 $q$ 行，每行三个数 $v,x,k$，表示一组询问。
## 输出格式

对于每组询问，输出一个整数表示能到达的山峰中第 $k$ 高的山峰的高度。
## 样例

### 样例输入 #1
```
10 11 4
1 2 3 4 5 6 7 8 9 10
1 4 4
2 5 3
9 8 2
7 8 10
7 1 4
6 7 1
6 4 8
2 1 5
10 8 10
3 4 7
3 4 6
1 5 2
1 5 6
1 5 8
8 9 2
```
### 样例输出 #1
```
6
1
-1
8

```
## 提示

### 数据规模与约定
对于 $100\%$ 的数据，$n \le 10^5$，$0 \le m,q \le 5\times 10^5$，$h_i,c,x \le 10^9$。


---

---
title: "[SCOI2015] 情报传递"
layout: "post"
diff: 省选/NOI-
pid: P4216
tag: ['2015', '四川', '线段树', '各省省选', '平衡树', '树链剖分', '可持久化线段树']
---
# [SCOI2015] 情报传递
## 题目描述

奈特公司是一个巨大的情报公司，它有着庞大的情报网络。情报网络中共有 $n$ 名情报员。每名情报员可能有若干名 (可能没有) 下线，除 $1$ 名大头目外其余 $n-1$ 名情报员有且仅有 $1$ 名上线。奈特公司纪律森严，每名情报员只能与自己的上、下线联系，同时，情报网络中任意两名情报员一定能够通过情报网络传递情报。

奈特公司每天会派发以下两种任务中的一个任务：

1. 搜集情报：指派 $T$ 号情报员搜集情报；
2. 传递情报：将一条情报从 $X$ 号情报员传递给 $Y$ 号情报员。

情报员最初处于潜伏阶段，他们是相对安全的，我们认为此时所有情报员的危险值为 $0$；一旦某个情报员开始搜集情报，他的危险值就会持续增加，每天增加 $1$ 点危险值 (开始搜集情报的当天危险值仍为 $0$，第 $2$ 天危险值为 $1$，第 $3$ 天危险值为 $2$，以此类推)。传递情报并不会使情报员的危险值增加。

为了保证传递情报的过程相对安全，每条情报都有一个风险控制值 $C$。奈特公司认为，参与传递这条情报的所有情报员中，危险值大于 $C$ 的情报员将对该条情报构成威胁。现在，奈特公司希望知道，对于每个传递情报任务，参与传递的情报员有多少个，其中对该条情报构成威胁的情报员有多少个。
## 输入格式

第一行包含一个正整数 $n$，表示情报员个数。
笫二行包含 $n$ 个非负整数，其中第 $i$ 个整数 $P_i$ 表示 $i$ 号情报员上线的编号。特别地，若 $P_i=0$，表示 $i$ 号情报员是大头目。
第三行包含一个正整数 $q$，表示奈特公司将派发 $q$ 个任务 (每天一个)。

随后 $q$ 行，依次描述 $q$ 个任务。每行首先有一个正整数 $k$。

- 若 $k=1$，表示任务是传递情报，随后有三个正整数 $X_i$、$Y_i$、$C_i$，依次表示传递情报的起点、终点和风险控制值。
- 若 $k=2$，表示任务是搜集情报，随后有 $1$ 个正整数 $T_i$，表示搜集情报的情报员编号。
## 输出格式

对于每个传递情报任务输出一行，包含两个整数，分别是参与传递情报的情报员个数和对该条情报构成威胁的情报员个数。
## 样例

### 样例输入 #1
```
7
0 1 1 2 2 3 3 
6
1 4 7 0
2 1
2 4
2 7
1 4 7 1
1 4 7 3
```
### 样例输出 #1
```
5 0
5 2
5 1
```
## 提示

样例解释：

对于 $3$ 个传递情报任务，都是经过 $5$ 名情报员，分别是 $4$ 号、$2$ 号、$1$ 号、$3$ 号和 $7$ 号。

- 第 $1$ 个任务，所有情报员 (危险值为 $0$) 都不对情报构成威胁；
- 第 $2$ 个任务，有 $2$ 名情报员对情报构成威胁，分别是 $1$ 号情报员 (危险值为 $3$) 和 $4$ 号情报员 (危险值为 $2$)，$7$ 号情报员 (危险值为 $1$) 并不构成威胁；
- 第 $3$ 个任务，只有 $1$ 名情报员对情报构成威胁。

数据范围：

$n\leqslant 2\times 10^5,Q\leqslant 2\times 10^5,0<P_i,C_i\leqslant N,1\leqslant T_i,X_i,Y_i\leqslant n$。


---

---
title: "[JSOI2018] 列队"
layout: "post"
diff: 省选/NOI-
pid: P4559
tag: ['2018', '线段树', '各省省选', '递归', '江苏', '可持久化线段树']
---
# [JSOI2018] 列队
## 题目描述

作为一名大学生，九条可怜在去年参加了她人生中的最后一次军训。

军训中的一个重要项目是练习列队，为了训练学生，教官给每一个学生分配了一个休息位置。每次训练开始前，所有学生都在各自的休息位置休息，但是当教官发出集合命令后，被点到的学生必须要到指定位置集合。

为了简化问题，我们把休息位置和集合位置抽象成一根数轴。一共有 $n$ 个学生，第 $i$ 个学生的休息位置是 $a_i$。每一次命令，教官会指定一个区间 $[l,r]$ 和集合点 $K$ ，所有编号在 $[l,r]$ 内的学生都必须赶到集合点列队。在列队时，每一个学生需要选择 $[K,K+r-l]$ 中的一个整数坐标站定且不能有任何两个学生选择的坐标相同。学生从坐标 $x$ 跑到坐标 $y$ 需要耗费体力 $\vert y-x \vert$ 。

在一天的训练中，教官一共发布了 $m$ 条命令 $(l,r,K)$ ，现在你需要计算对于每一条命令，在所有可能的列队方案中，消耗的体力值总和最小是多少。

以下是对题意的一些补充：

1.    任何两条命令是无关的，即在一条集合命令结束后，所有学生都会回到自己的休息位置，然后教官才会发出下一条命令。
    
2.    在集合的时候，可能有编号不在 $[l,r]$ 内的学生处在区间 $[K,K+r-l]$ 中，这时他会自己跑开，且跑动的距离不记在消耗的体力值总和中。


## 输入格式

第一行输入两个整数 $n,m$。

第二行 $n$ 个整数 $a_i$ 表示学生的休息位置。保证学生休息的位置两两不同。

接下来 $m$ 行每行三个整数 $l,r,K$ 表示一条命令。

## 输出格式

对于每一条命令输出一行一个整数表示最小的体力值总和。
## 样例

### 样例输入 #1
```
5 5
1 5 7 6 2
1 5 2
1 5 3
1 3 9
2 4 2
3 5 5
```
### 样例输出 #1
```
5
4
17
9
3
```
## 提示

**样例 1 解释**


在第一条命令中，五名学生依次跑到 $[2,5,4,6,3]$，则总代价为 $|2-1|+|5-5|+|4-7|+|6-6|+|3-2|=5$。
    
在第二条命令中，五名学生依次跑到 $[4,5,7,6,3]$，则总代价为 $|4-1|+|5-5|+|7-7|+|6-6|+|3-2|=4$。
    
在第三条命令中，三名学生依次跑到 $[11,10,9]$，则总代价为 $|11-1|+|10-5|+|9-7|=17$。
    
在第四条命令中，三名学生依次跑到 $[4,2,3]$，则总代价为 $|4-5|+|2-7|+|3-6|=9$。
    
在第五条命令中，三名学生依次跑到 $[7,6,5]$，则总代价为 $|7-7|+|6-6|+|5-2|=3$。

**数据范围**

对于 $10\%$ 的数据，$n,m \leq 10$；

对于 $40\%$ 的数据，$n,m \leq 10^3$；

对于 $70\%$ 的数据，$n,m \leq 10^5$；

对于 $100\%$ 的数据，$n,m \leq 5 \times 10^5,1 \leq a_i,K \leq 10^6$。

对于 $100\%$ 的数据，学生休息的位置两两不同。



---

---
title: "[FJOI2016] 神秘数"
layout: "post"
diff: 省选/NOI-
pid: P4587
tag: ['2016', '各省省选', '福建', '可持久化线段树']
---
# [FJOI2016] 神秘数
## 题目描述

一个可重复数字集合 $S$ 的神秘数定义为最小的不能被 $S$ 的子集的和表示的正整数。例如 $S=\{1,1,1,4,13\}$，有：$1 = 1$，$2 = 1+1$，$3 = 1+1+1$，$4 = 4$，$5 = 4+1$，$6 = 4+1+1$，$7 = 4+1+1+1$。

$8$ 无法表示为集合 $S$ 的子集的和，故集合 $S$ 的神秘数为 $8$。

现给定长度为 $n$ 的**正整数**序列 $a$，$m$ 次询问，每次询问包含两个参数 $l,r$，你需要求出由 $a_l,a_{l+1},\cdots,a_r$ 所组成的可重集合的神秘数。
## 输入格式

第一行一个整数 $n$，表示数字个数。

第二行 $n$ 个正整数，从 $1$ 编号。

第三行一个整数 $m$，表示询问个数。
## 输出格式

对于每个询问，输出一行对应的答案。
## 样例

### 样例输入 #1
```
5
1 2 4 9 10
5
1 1
1 2
1 3
1 4
1 5
```
### 样例输出 #1
```
2
4
8
8
8
```
## 提示

对于 $100\%$ 的数据点，$1\le n,m\le {10}^5$，$\sum a\le {10}^9$。


---

---
title: "Beautiful Pair"
layout: "post"
diff: 省选/NOI-
pid: P4755
tag: ['O2优化', '枚举', '分治', '可持久化线段树', '洛谷月赛']
---
# Beautiful Pair
## 题目描述

小 D 有个数列 $\{a\}$，当一个数对 $(i,j)$（$i \le j$）满足 $a_i$ 和 $a_j$ 的积不大于 $a_i, a_{i+1}, \ldots, a_j$ 中的最大值时，小 D 认为这个数对是美丽的。请你求出美丽的数对的数量。
## 输入格式

第一行输入一个整数 $n$，表示元素个数。
第二行输入 $n$ 个整数 $a_1,a_2,a_3,\ldots,a_n$，为所给的数列。

## 输出格式

输出一个整数，为美丽的数字对数。
## 样例

### 样例输入 #1
```
4
1 3 9 3

```
### 样例输出 #1
```
5

```
### 样例输入 #2
```
5
1 1 2 1 1

```
### 样例输出 #2
```
14

```
## 提示

**【样例解释 #1】**

五种可行的数对为 $(1,1), (1,2), (1,3), (1,4), (2,4)$。

**【样例解释 #2】**

只有数对 $(3,3)$ 不可行。

**【数据范围】**

对于 $100 \%$ 的数据，$1\le n\le{10}^5$，$1\le a_i\le{10}^9$。


---

---
title: "[IOI 2018] werewolf 狼人"
layout: "post"
diff: 省选/NOI-
pid: P4899
tag: ['2018', '树状数组', 'IOI', 'O2优化', '深度优先搜索 DFS', '可持久化线段树']
---
# [IOI 2018] werewolf 狼人
## 题目背景

本题为交互题，但在此请提交**完整程序**。
## 题目描述

在日本的茨城县内共有 $N$ 个城市和 $M$ 条道路。这些城市是根据人口数量的升序排列的，依次编号为 $0$ 到 $N - 1$。每条道路连接两个不同的城市，并且可以双向通行。由这些道路，你能从任意一个城市到另外任意一个城市。

你计划了 $Q$ 个行程，这些行程分别编号为 $0$ 至 $Q - 1$。第 $i(0 \leq i \leq Q - 1)$ 个行程是从城市 $S_i$ 到城市 $E_i$。

你是一个狼人。你有两种形态：**人形**和**狼形**。在每个行程开始的时候，你是人形。在每个行程结束的时候，你必须是狼形。在行程中，你必须要变身（从人形变成狼形）恰好一次，而且只能在某个城市内（包括可能是在 $S_i$ 或 $E_i$ 内）变身。

狼人的生活并不容易。当你是人形时，你必须避开人少的城市，而当你是狼形时，你必须避开人多的城市。对于每一次行程 $i(0 \leq i \leq Q - 1)$，都有两个阈值 $L_i$ 和 $R_i(0 \leq L_i \leq R_i \leq N - 1)$，用以表示哪些城市必须要避开。准确地说，当你是人形时，你必须避开城市 $0, 1, \ldots , L_i - 1$ ；而当你是狼形时，则必须避开城市 $R_i + 1, R_i + 2, \ldots , N - 1$。这就是说，在行程 $i$ 中，你必须在城市 $L_i, L_i + 1, \ldots , R_i$ 中的其中一个城市内变身。

你的任务是，对每一次行程，判定是否有可能在满足上述限制的前提下，由城市 $S_i$ 走到城市 $E_i$。你的路线可以有任意长度。
## 输入格式

输入的第一行包含三个正整数 $N, M, Q$，其意义见题目描述。

接下来 $M$ 行，每行包含两个非负整数。在这 $M$ 行中，第 $j$ 行的两个非负整数分别表示 $X_{j - 1}, Y_{j - 1}$，即编号为 $j - 1$ 的道路连接的两个城市的编号。

接下来 $Q$ 行，每行包含四个非负整数。在这 $Q$ 行中，第 $i$ 行的四个非负整数分别表示 $S_{i - 1}, E_{i - 1}, L_{i - 1}, R_{i - 1}$，即编号为 $i - 1$ 的行程的起点城市编号、终点城市编号以及两个阈值。
## 输出格式

输出包含 $Q$ 行，每行包含一个非 $0$ 即 $1$ 的整数。第 $i$ 行的整数表示对于编号为 $i - 1$ 的行程，是否能从城市 $S_{i - 1}$ 走至城市 $E_{i - 1}$，若能够，那么输出整数为 $1$；若不能，那么输出整数为 $0$。
## 样例

### 样例输入 #1
```
6 6 3
5 1
1 2
1 3
3 4
3 0
5 2
4 2 1 2
4 2 2 2
5 4 3 4

```
### 样例输出 #1
```
1
0
0

```
### 样例输入 #2
```
10 9 10
6 7
1 5
8 0
2 9
9 4
2 7
8 5
6 0
3 4
4 9 0 9
8 1 8 9
1 8 1 8
8 3 5 5
8 9 3 9
0 1 0 2
9 0 6 6
1 7 1 8
9 4 5 6
9 5 0 9

```
### 样例输出 #2
```
1
1
1
0
1
1
0
1
0
1

```
## 提示

**限制条件**

- $2 \leq N \leq 200, 000$
- $N - 1 \leq M \leq 400, 000$
- $1 \leq Q \leq 200, 000$
- 对于每个 $0 \leq j \leq M - 1$
    - $0 \leq X_j \leq N - 1$
    - $0 \leq Y_j \leq N - 1$
    - $X_j \neq Y_j$
- 你可以通过道路由任意一个城市去另外任意一个城市。
- 每一对城市最多只由一条道路直接连起来。换言之，对于所有 $0 \leq j < k \leq M - 1$，都有 $(X_j, Y_j) \neq (X_k, Y_k)$ 和 $(Y_j, X_j) \neq (X_k, Y_k)$
- 对于每个 $0 \leq i \leq Q - 1$
    - $0 \leq L_i \leq S_i \leq N - 1$
    - $0 \leq E_i \leq R_i \leq N - 1$
    - $S_i \neq E_i$
    - $L_i \leq R_i$

**子任务**

- 1.（7 分）$N \leq 100$，$M \leq 200$，$Q \leq 100$。
- 2.（8 分）$N \leq 3, 000$，$M \leq 6, 000$，$Q \leq 3, 000$。
- 3.（34 分）$M = N - 1$ 且每个城市最多与两条路相连（所有城市是以一条直线的形式连起来）。
- 4.（51 分）没有附加限制。


---

---
title: "【XR-1】柯南家族"
layout: "post"
diff: 省选/NOI-
pid: P5346
tag: ['倍增', '离散化', 'O2优化', '可持久化线段树', '可持久化', '后缀数组 SA']
---
# 【XR-1】柯南家族
## 题目背景

xht37 最近沉迷于名侦探柯南。

在某集中，小兰又在怀疑柯南的真实身份了。为了让小兰不再怀疑，柯南编造出自己的家族背景来应对小兰的询问。
## 题目描述

这个家族一开始只有一个人，后来不断有人有了孩子，直到现在，这个家族有 $n$ 个人，第 $n$ 个人正是柯南。易知这个家族构成了一个 $n$ 个点的树形结构。

柯南为了使自己编造的家庭背景更加真实，他给家族中的每个人赋予了一个**智商值**。但是，一个人的**聪明程度**不仅仅只与他的**智商值**有关，还可能与他**祖先的聪明程度**及他**出生的时代**有关。

具体来说，在这个家族中，A 比 B 聪明**当且仅当** A 和 B 满足下面三种情况中的某一种：

1. A 的智商值比 B 的智商值高；
2. A 的智商值与 B 的智商值一样且 A 和 B 有不同的父亲，A 的父亲比 B 的父亲聪明；
3. A 的智商值与 B 的智商值一样且 A 和 B 的父亲是同一个人或某一个人没有父亲，A 比 B 后出生。

有一个很显然的结论是，这个家族中不会有两个人一样聪明。

柯南需要回答小兰的 $q$ 个询问。为了方便说明，假设第 $i$ 个出生的人编号为 $i$。

每个询问是下面三种情况中的某一种：

1. `1 x`：询问编号为 $x$ 的人在整个家族中聪明程度排第几。
2. `2 x k`：询问编号为 $x$ 的人及其祖先中第 $k$ 聪明的人的编号。
3. `3 x k`：询问编号为 $x$ 的人及其后代中第 $k$ 聪明的人的编号。

柯南还有许多案子要办，他不想在回答小兰的问题上浪费时间，他希望你能编程帮他回答小兰的所有询问。
## 输入格式

第 $1$ 行包含两个数 $n, q$，分别表示人数和询问次数。

第 $2$ 行包含 $n-1$ 个数 $f_{2 \dots n}$，其中 $f_i$ 表示 $i$ 的父亲。

第 $3$ 行包含 $n$ 个数 $a_{1 \dots n}$，其中 $a_i$ 表示 $i$ 的智商值。

接下来 $q$ 行每行两个或三个数表示一个合法询问，其中第一个数表示询问种类，后面一个或两个数为询问参数。
## 输出格式

输出 $q$ 行，每行一个数表示询问的答案。
## 样例

### 样例输入 #1
```
5 11
1 1 3 2
1 2 2 1 1
1 1
1 2
1 3
1 4
1 5
2 4 1
2 5 3
3 1 1
3 1 2
3 1 3
3 1 4
```
### 样例输出 #1
```
5
2
1
3
4
3
1
3
2
4
5
```
## 提示

【样例说明】

形成的树如下：

![](https://cdn.luogu.com.cn/upload/image_hosting/eie1mrxb.png)

首先比较编号为 $2,3$ 的两个人，由于** $3$ 号的智商值与 $2$ 号的智商值一样且他们的父亲是同一个人，$3$ 号比 $2$ 号后出生**满足第 $3$ 种情况，因此 $3$ 号比 $2$ 号聪明。

再比较编号为 $4,5$ 的两个人，由于** $4$ 号的智商值与 $5$ 号的智商值一样且他们有不同的父亲，$4$ 号的父亲 $3$ 号比 $5$ 号的父亲 $2$ 号聪明**满足第 $2$ 种情况，因此 $4$ 号比 $5$ 号聪明。

再比较编号为 $1,5$ 的两个人，由于** $5$ 号的智商值与 $1$ 号的智商值一样且 $1$ 号没有父亲，$5$ 号比 $1$ 号后出生**满足第 $3$ 种情况，因此 $5$ 号比 $1$ 号聪明。

再根据第 $1$ 种情况比较编号为 $2,4$ 的两个人，可对 $5$ 人的聪明程度排序：$3 > 2 > 4 > 5 > 1$。

【数据规模与约定】

一共 $10$ 个测试点。

对于前 $20\%$ 的数据，$1 \le n, q \le 10 ^ 3$，每个测试点 $7$ 分，时限 1s。

对于另 $20\%$ 的数据，保证一个人最多只有一个儿子，每个测试点 $9$ 分，时限 4s。

对于另 $20\%$ 的数据，$1 \le n, q \le 10 ^ 5$，每个测试点 $9$ 分，时限 1.5s。

对于另 $20\%$ 的数据，保证只有第一种询问，每个测试点 $12$ 分，时限 1.5s。

对于 $100\%$ 的数据，$1 \le n, q \le 5 \times 10 ^ 5$，$1 \le a_i \le 10 ^ 9$，每个测试点 $13$ 分，时限 2.5s。


---

---
title: "[Cnoi2019] 须臾幻境"
layout: "post"
diff: 省选/NOI-
pid: P5385
tag: ['2019', 'O2优化', '动态树 LCT', '可持久化线段树']
---
# [Cnoi2019] 须臾幻境
## 题目背景

这曾今有一个凄婉哀伤的故事，但是被出题人删档弄丢了。
## 题目描述

你有一个无向图 $G( V, E )$, $E$ 中每一个元素用一个二元组 $( u, v )$ 表示。

现在把 $E$ 中的元素排成一个长度为 $|E|$ 序列 $A$。

然后给你 $q$ 个询问二元组 $( l, r )$,

表示询问 图 $ G'\big( V, \mathop{\bigcup}\limits_{ i \in [l, r] } \{A_i\} \big) $ 的联通块的个数。
## 输入格式

第一行， 四个整数, 表示 $|V|$, $|E|$, $q$, $t$, 其中 $t$ 表示强制在线参数.

以下$|E|$行， 每行一个二元组 $( u, v )$ , 表示 $A$ 序列.

再以下$q$行， 每行一个二元组 $( l' , r' )$ 表示一组加密后的询问.

解密方式:

```
GetQuery( &l, &r, t, last_ans, |E| )
    IF t > 0 THEN 
        l <- (l + t * last_ans) Mod |E| + 1
        r <- (r + t * last_ans) Mod |E| + 1
    IF l > r THEN Swap( l, r )
```
初始时 last_ans = 0.
## 输出格式

$q$ 行，表示每个询问的答案。
## 样例

### 样例输入 #1
```
80 100 100 0
25 73
4 10
9 27
19 26
52 55
4 18
19 31
25 29
14 72
10 13
17 23
13 63
25 46
9 11
40 64
32 48
1 2
19 34
7 39
9 14
57 59
6 47
8 36
40 66
15 67
66 76
21 49
15 38
13 25
4 61
6 32
52 58
1 12
26 44
12 68
1 37
2 45
5 22
47 77
21 60
7 28
29 69
10 78
39 43
11 50
5 6
76 79
5 7
64 70
27 33
1 51
15 75
19 24
46 56
1 3
30 42
23 35
28 57
21 41
11 53
61 65
13 15
28 30
20 49
6 8
1 5
18 40
1 9
34 62
7 16
46 54
56 74
1 17
16 20
11 71
7 19
3 4
13 21
2 80
28 52
29 7
55 27
6 71
46 27
2 68
50 75
37 41
17 13
62 57
72 51
1 54
49 33
1 14
58 29
11 53
1 38
17 46
78 33
1 47
61 5
76 91
99 29
64 67
65 32
85 8
77 57
62 19
42 37
51 41
57 71
79 63
9 17
21 16
87 43
1 77
53 37
38 37
25 69
1 1
97 72
27 31
1 95
66 29
29 63
27 74
18 63
73 11
63 81
33 46
85 19
91 78
15 66
36 89
61 63
21 9
59 23
5 61
41 59
97 79
21 41
81 51
33 57
49 27
37 71
1 9
59 73
16 6
53 41
61 37
3 88
43 43
11 3
41 27
43 30
67 5
1 33
67 15
26 35
21 45
7 65
1 41
25 82
51 4
70 60
15 1
87 77
21 83
63 51
46 43
1 41
99 28
41 17
11 44
45 56
8 31
81 43
37 71
69 6
79 75
1 46
6 75
29 34
21 21
61 39
90 26
76 88
77 41
71 53
25 71
71 43
99 88
5 41
15 51
41 61
37 86
14 47
70 35
81 3
98 4
25 1

```
### 样例输出 #1
```
64
15
76
46
5
59
36
74
69
65
63
71
74
35
3
63
78
35
79
54
75
1
42
45
32
34
17
61
66
13
66
28
28
77
67
43
23
61
61
59
49
55
57
45
71
65
69
67
55
2
79
71
65
66
17
47
27
70
55
21
39
22
32
69
65
69
17
67
76
39
15
55
46
68
56
41
45
16
75
34
10
74
79
57
18
67
43
61
33
51
68
43
43
59
30
46
44
2
2
55

```
## 提示

Subtask1( 15% ): $|V|, |E|, q \le 5000$

Subtask2( 25% ): $t = 0$

Subtask3( 22% ): $|V| \le 10^4, |E|, q \le 3*10^4$

Subtask4( 38% ): 无特殊限制.

对于 100% 的数据保证, $|V| \le 10^5, |E| \le 2*10^5, q \le 10^5, t \in \{0,1\}$


---

---
title: "『MdOI R1』Treequery"
layout: "post"
diff: 省选/NOI-
pid: P6071
tag: ['最近公共祖先 LCA', '可持久化线段树']
---
# 『MdOI R1』Treequery
## 题目描述

给定一棵 $n$ 个点的无根树，边有边权。

令 $E(x,y)$ 表示树上 $x,y$ 之间的简单路径上的所有边的集合，特别地，当 $x=y$ 时，$E(x,y) = \varnothing$。

你需要 **实时** 回答 $q$ 个询问，每个询问给定 $p,l,r$，请你求出集合 $\bigcap_{i=l}^r E(p,i)$ 中所有边的边权和，即 $E(p, l\dots r)$ 的交所包含的边的边权和。

通俗的讲，你需要求出 $p$ 到 $[l,r]$ 内每一个点的简单路径的公共部分长度。


## 输入格式

第一行两个整数 $n,q$，表示树的结点数和询问数。

接下来 $n-1$ 行，每行三个整数 $x,y,w$，表示 $x$ 与 $y$ 之间有一条权值为 $w$ 的边。

接下来 $q$ 行，每行三个整数 $p_0,l_0,r_0$。第 $i$ 个询问的 $p,l,r$ 分别为 $p_0,l_0,r_0$ 异或上 $lastans$ 的值，其中 $lastans$ 是上次询问的答案，初始时为 $0$。
## 输出格式

对于每个询问，一行一个整数，表示答案。
## 样例

### 样例输入 #1
```
5 4
3 1 2
1 5 1
2 3 3
3 4 4
2 3 5
2 1 7
0 7 7
5 5 2
```
### 样例输出 #1
```
3
2
6
0
```
### 样例输入 #2
```
10 10
2 1 9907
3 2 8329
4 2 8402
5 4 3636
6 4 8747
7 4 3080
8 6 780
9 6 5414
10 9 3545
2 10 10
26107 26106 26101
4 9 10
14171 14166 14169
8958 8949 8949
36008 36014 36013
11485 11485 11472
3 9 9
30888 30894 30895
8404 8404 8411

```
### 样例输出 #2
```
26108
0
14161
8959
36015
11482
0
30892
8402
0

```
## 提示

【样例 1 说明】

样例中的树如图所示：

![](https://cdn.luogu.com.cn/upload/image_hosting/g6l15zpv.png)

下面解释中的询问参数均为异或 $lastans$ 之后得到的真实值。

对于第一个询问，$p=2$，$l=3$，$r=5$，$\bigcap_{i=3}^5 E(2,i)$ 为边 $(2,3)$，长度为 $3$。

对于第二个询问，$p=1$，$l=2$，$r=4$，$\bigcap_{i=2}^4 E(1,i)$ 为边 $(1,3)$，长度为 $2$；

对于第三个询问，$p=2$，$l=5$，$r=5$，$\bigcap_{i=5}^5 E(2,i)$ 为边集 $\{(2,3),(3,1),(1,5)\}$，长度为 $6$；

对于第四个询问，$p=3$，$l=3$，$r=4$，$\bigcap_{i=3}^4 E(3,i)=\varnothing$，长度为 $0$。


---

【数据范围】

**本题采用捆绑测试。**

| 子任务编号 |   $n,q\leq$    | 特殊性质 | 分值 |
| :--------: | :------------: | :------: | :--: |
|     1      |     $10^5$     |  $l=r$   |  8   |
|     2      |     $10^5$     |  $p=1$   |  20  |
|     3      |     $10^3$     |    无    |  20  |
|     4      |     $10^5$     |    无    |  26  |
|     5      | $2\times 10^5$ |    无    |  26  |

对于 $100\%$ 的数据，$1\leq n,q\leq 2\times 10^5$，$1\leq x,y,p\leq n$，$1\leq l\leq r\leq n$，$1\leq w\leq 10^4$。


---

---
title: "「JYLOI Round 1」常规"
layout: "post"
diff: 省选/NOI-
pid: P6638
tag: ['二分', '可持久化线段树']
---
# 「JYLOI Round 1」常规
## 题目描述

LS 制定了 $n$ 项常规，其中第 $i$ 项常规制定的时间是 $a_i$。

对于第 $i$ 项常规，从第 $i$ 项常规的制定时间 $a_i$ 后的每 $k$ 秒，他都要做一次第 $i$ 项常规，他做一次常规的时间可以忽略不计。

现在 LS 想给你 $m$ 个询问，每个询问用一个区间 $[l_i, r_i]$ 来表示，问你在第 $l_i$ 到 $r_i$ 秒，他一共做了多少次常规。
## 输入格式

输入的第一行是一个为 0 或 1 的整数 $type$，在接下来会用到。

对于 $type = 0$ 的情况，接下来有一行三个正整数 $n$、$m$、$k$，含义如题所述。

接下来有一行 $n$ 个正整数，这一行中的第 $i$ 个正整数表示的是 $a_i$，$a_i$ 的含义如题所述。

接下来有 $m$ 行，第 $i$ 行表示的是第 $i$ 个询问是一个区间 $[l_i, r_i]$，$l_i$ 和 $r_i$ 的含义如题所述。对于 $type = 0$ 的所有询问，我们都没有进行加密。

对于 $type=1$ 的情况，接下来有一行四个正整数 $n$、$m$、$k$ 和 $mod$，$n$、$m$、$k$ 的含义如题所述，其中 $mod$ 是一个会在下面用到的参数。

接下来有一行 $n$ 个正整数，这一行中的第 $i$ 个正整数表示的是 $a_i$，$a_i$ 的含义如题所述。

接下来有 $m$ 行，这 $m$ 行中的第 $i$ 行有两个正整数 $l_i$ 和 $r_i$，表示第 $i$ 个询问是一个区间 $[l_i, r_i]$，$l_i$ 和 $r_i$ 的含义如题所述。特别地，我们加密了第 2 至第 $m$ 个询问，对于第 $i(2 \leq i \leq m)$ 个询问，解密后的：
$$l_i = \min((l_i + \text{lastans} - 1) \;\text{mod}\; mod + 1, (r_i + \text{lastans} - 1) \;\text{mod}\; mod + 1)$$

$$r_i=\max((l_i + \text{lastans} - 1) \;\text{mod}\; mod + 1, (r_i + \text{lastans} - 1) \;\text{mod}\; mod + 1)$$

其中 $\text{lastans}$ 是第 $(i - 1)$ 个询问的答案，对于第 2 到第 $m$ 个询问，你的程序需要回答解密后的询问所对应的答案。

**特别地，第一个询问没有被加密。**
## 输出格式

输出共有 $m$ 行，对于每个解密后的询问输出一行，输出中的第 $i$ 行表示的是第 $i$ 个询问的答案。
## 样例

### 样例输入 #1
```
0
5 10 3
1 2 3 4 5
1 5
2 5
3 5
4 5
5 5
10 10
20 30
10 30
1 30
5 30
```
### 样例输出 #1
```
2
2
2
2
1
2
18
35
43
42
```
### 样例输入 #2
```
1
5 10 3 100
1 2 3 4 5
1 5
2 5
3 5
4 5
5 5
10 10
20 30
10 30
1 30
5 30
```
### 样例输出 #2
```
2
5
5
3
2
1
18
35
50
44
```
## 提示

### 样例 2 说明

解密后的询问分别为 [1, 5]、[4, 7]、[8, 10]、[9, 10]、[8, 8]、[12, 12]、[21, 31]、[28, 48]、[36, 65]、[55, 80]，因此可以得出答案。

____________

### 数据范围

对于 $100\%$ 的数据，满足 $type \in \{0, 1\}; 1 \leq n, m \leq 10^5; 0 \leq l_i \leq r_i \leq 10^9; 0 \leq a_i \leq 10^9; 1 \leq k, mod \leq 10^9$。

子任务 1（有 10 个测试点，每个测试点 1 分，共 10 分）：$type = 0; n, m, k \leq 10^3; r_i \leq 10^3$。

子任务 2（有 10 个测试点，每个测试点 1 分，共 10 分）：$type = 0; n, m \leq 10^3$。

子任务 3（有 2 个测试点，每个测试点 5 分，共 10 分）：$type = 0, r_i \leq 10^5,k = 1$。

子任务 4（共 20 分）：$type = 0, k \leq 10^5, r_i \leq 10^5$。

子任务 5（共 30 分）：$type = 0$。

子任务 6（共 20 分）：无特殊限制。

对于子任务 4、5、6，分别捆绑计分（即你需要通过一个子任务内的所有测试点才能够拿到这个子任务的分数），本题总共 50 个测试点、100 分。

## 题目来源

「JYLOI Round 1」 D

Idea / Solution / Data ：abcdeffa


---

---
title: "[COCI 2020/2021 #3] Specijacija"
layout: "post"
diff: 省选/NOI-
pid: P7172
tag: ['2020', '最近公共祖先 LCA', '可持久化线段树', 'COCI（克罗地亚）']
---
# [COCI 2020/2021 #3] Specijacija
## 题目描述

给定一个正整数 $n$ 个一个满足 $\frac{i(i-1)}{2} \lt a_i \le \frac{i(i+1)}{2}$ 的正整数序列 $a_1, a_2, \cdots, a_n$。

该序列是一棵包含 $\frac{(n+1)(n+2)}{2}$ 个节点的树参数化而来的，它包括 $n+1$ 层，每层分别包括 $1, 2, \cdots, n+1$ 个节点，如图所示：

![](https://cdn.luogu.com.cn/upload/image_hosting/bvug13ny.png)

它由 $a=(1,2,6)$ 参数化而来。

第 $i$ 层包含节点 $\frac{i(i-1)}{2}+1, \cdots, \frac{i(i+1)}{2}$。节点 $a_i$ 有两个孩子，而其他同层的节点都只有一个孩子。

请回答 $q$ 个询问，求 $x,y$ 的最大公共祖先，即既是 $x$ 的祖先，又是 $y$ 的祖先且权值最大的节点。
## 输入格式

第一行包含三个整数 $n,q,t$，分别表示参数的数量、询问次数和用来决定节点权值的参数。

第二行输入一个长度为 $n$ 的序列 $a$（其中对于每一个数 $a_i$ 有 $\frac{i(i-1)}{2} \lt a_i \le \frac{i(i+1)}{2}$）。

接下来的 $q$ 行中的第 $i$ 行包含两个整数 $\tilde x_i$ 和 $\tilde y_i$（$1 \le \tilde x_i, \tilde y_i \le \frac{(n+1)(n+2)}{2}$），用来决定询问时节点的权值。

设 $z_i$ 为第 $i$ 次询问的结果，规定 $z_0=0$。第 $i$ 次询问的权值为：

$$x_i=[(\tilde x_i-1+t \times z_{i-1}) \bmod \frac{(n+1)(n+2)}{2}]+1$$

$$x_i=[(\tilde y_i-1+t \times z_{i-1}) \bmod \frac{(n+1)(n+2)}{2}]+1$$

注：当参数 $t=0$ 时，满足 $x_i=\tilde x_i$，$y_i=\tilde y_i$。当 $t=1$ 时，权值应通过先前的答案来决定。
## 输出格式

输出共 $q$ 行，其中第 $i$ 行，输出 $x_i$ 和 $y_i$ 的最大公共祖先。
## 样例

### 样例输入 #1
```
3 5 0
1 2 6
7 10
8 5
6 2
9 10
2 3
```
### 样例输出 #1
```
1
5
1
6
1
```
### 样例输入 #2
```
3 5 1
1 2 6
7 10
8 5
6 2
9 10
2 3
```
### 样例输出 #2
```
1
6
2
1
1
```
## 提示

**【样例解释 #1 / #2】**

两个样例所表示的树的形状在题目描述的图中已经呈现。

第二个样例中各个节点的权值：

$x_1=7$，$y_1=10$；  
$x_2=9$，$y_2=6$；  
$x_3=2$，$y_3=8$；  
$x_4=1$，$y_4=2$；  
$x_5=3$，$y_5=4$。

**【数据范围】**

| Subtask | 分值 | 数据范围及约定 |
| :----------: | :----------: | :----------: |
| $1$ | $10$ | $q=1, t=0$ |
| $2$ | $10$ | $n \le 1000, t=0$ |
| $3$ | $30$ | $t=0$ |
| $4$ | $60$ | $t=1$ |

对于 $100\%$ 的数据，$1 \le n,q \le 2 \times 10^5$，$t \in \{0,1\}$。

**【说明】**

**本题分值按 COCI 原题设置，满分 $110$。**

**题目译自 [COCI2020-2021](https://hsin.hr/coci/) [CONTEST #4](https://hsin.hr/coci/contest3_tasks.pdf)  _T5 Specijacija_。**


---

---
title: "「PMOI-1」中位数"
layout: "post"
diff: 省选/NOI-
pid: P7357
tag: ['树形数据结构', '二分', 'O2优化', '可持久化线段树', '可持久化']
---
# 「PMOI-1」中位数
## 题目描述

给定一棵以 $1$ 为根的包含 $n$ 个节点的**有根树**。第 $i$ 个节点有点权 $a_i$。

定义函数 $f(u,v)$ 表示从 $u$ 到 $v$ 经过的所有节点的点权的**可重集**的中位数。

请注意，**本题中的中位数的定义与数学中的定义略有不同**：这里一个长度为 $t$ 的序列的中位数定义为这个序列第 $\left\lceil\frac{t+1}2\right\rceil$ 小的数。

定义函数 $\text{cover}(x_1,y_1,x_2,y_2)$ 表示从 $x_1$ 到 $y_1$ 的路径是否完全覆盖了从 $x_2$ 到 $y_2$ 的路径。如果完全覆盖，则 $\text{cover}(x_1,y_1,x_2,y_2)=1$，否则  $\text{cover}(x_1,y_1,x_2,y_2)=0$。

你需要依次处理 $q$ 次操作，按照以下格式给出：

`1 u`：表示一次操作，需要你将点 $u$ 的点权对 $1$ **异或**；

` 2 u v`：表示一次询问，需要你求出 $\max\limits_{1\le i\le n,1\le j\le n}\{\text{cover}(i,j,u,v)f(i,j)\}$。

对于第二类操作，保证每次询问均满足 $u$ 不是 $v$ 的祖先且 $v$ 不是 $u$ 的祖先，且 $u \neq v$。

你需要对于每个第二类操作，输出对应的值。
## 输入格式

第一行两个正数 $n$ 和 $q$ ，分别表示树的节点数与询问次数。

第二行 $n$ 个整数，第 $i$ 个数表示第 $i$ 个节点的点权 $a_i$。

下面 $n-1$ 行，每行两个整数 $x,y$ ，描述一条连接 $x$ 与 $y$ 的边。

下面 $q$ 行，每行先输入一个整数 $opt$ ，表示本次是是操作还是询问。 若 $opt=1$ ，则这是一次操作，且接下来会输入一个整数 $u$ ；若 $opt=2$ ，则这是一次询问，且接下来会输入两个整数 $u,v$ 。其具体意义见【题目描述】。
## 输出格式

对于每次询问输出一行，即对应询问的答案。
## 样例

### 样例输入 #1
```
8 3
4 2 3 4 2 1 4 3
1 2
1 3
2 4
2 5
3 6
6 7
6 8
2 4 8
1 3 
2 2 3
```
### 样例输出 #1
```
3
4
```
## 提示

【样例解释】

第一次是询问。显然，只有 $(i=4,j=8)$ 满足 $\text{cover}(i,j,u,v)=1$。此时 $f(i,j)=3$。

第二次是操作。将 $3$ 号节点的点权改为了 $2$。

第三次是询问。当 $i=4,j=3$ 时，$\text{cover}(i,j,u,v)=1$ 且 $f(i,j)=4$ 。不难发现，对于其他所有满足 $\text{cover}(i,j,u,v)=1$ 的节点对 $(i,j)$，均没有 $f(i,j) >4$。

【数据范围】
- Subtask1（8pts）：$n,q\le50$；
- Subtask2（12pts）：$n,q\le2\times10^3$；
- Subtask3（16pts）：$n,q\le4\times10^4$；
- Subtask4（10pts）：保证树的形态随机生成；
- Subtask5（12pts）：保证没有 $1$ 操作；
- Subtask6（12pts）：保证每次询问的 $u,v$ 都是叶子节点；
- Subtask7（30pts）：无特殊限制。

Subtask4 的随机方式为 ：随机生成一个的排列 $p$，对于 $i\in[2,n]$，$p_i$ 向 $p_1,p_2,...,p_{i-1}$ 中等概率随机的一个点连边。

对于 $100\%$ 的数据满足，$1\le n,q,a_i \le 10^5$，保证每次询问均满足 $u$ 不是 $v$ 的祖先且 $v$ 不是 $u$ 的祖先，且 $u \neq v$ 。


---

---
title: "[THUPC 2017] 天天爱射击"
layout: "post"
diff: 省选/NOI-
pid: P7424
tag: ['2017', '树状数组', '可持久化线段树', '可持久化', '分块', '整体二分', 'THUPC']
---
# [THUPC 2017] 天天爱射击
## 题目描述

小 C 爱上了一款名字叫做《天天爱射击》的游戏。如图所示，这个游戏有一些平行于 $x$ 轴的木板。现在有一些子弹，按顺序沿着 $y$ 轴方向向这些木板射去。第 $i$ 块木板被 $S_i$ 个子弹贯穿以后，就会碎掉消失。一个子弹可以贯穿其弹道上的全部木板，特别的，如果一个子弹触碰到木板的边缘，也视为贯穿木板。

小 C 现在知道了游戏中 $n$ 块木板位置，以及知道了 $m$ 个子弹射击位置。现在问你每个子弹射出去以后，有多少木板会碎掉？
## 输入格式

从标准输入读入数据。

第一行两个整数 $n$ 和 $m$，表示木板数量和子弹数量。其中 $1\le n,m\le 2\times 10^5$。

接下来 $n$ 行，每行三个整数 $x_1,x_2,s$，表示每块木板的左端点 $x$ 坐标、右端点 $x$ 坐标，以及贯穿多少次会碎掉。其中保证 $1\le x_1\le x_2\le2\times 10^5,1\le s\le 2\times 10^5$。

接下来 $m$ 行，每行一个整数 ，表示每个子弹的 $x$ 坐标。子弹按照发射顺序给出。其中保证 $1\le x\le2\times 10^5$。
## 输出格式

输出到标准输出。

$m$ 行，每行一个整数。表示每颗子弹射出去后，有多少木板碎掉。
## 样例

### 样例输入 #1
```
3 2
1 3 1
2 4 2
3 4 1
2
3
```
### 样例输出 #1
```
1
2
```
## 提示

![](https://cdn.luogu.com.cn/upload/image_hosting/ocqlbnl3.png)
#### 版权信息
来自 THUPC（THU Programming Contest，清华大学程序设计竞赛）2017。

$\text{upd}2021.7.6$：感谢 @[jiangbowen](https://www.luogu.com.cn/user/366807) 提供的一组 hack 数据，不计分，但若不通过 hack 数据则不算通过此题。


---

---
title: "「C.E.L.U-02」划分可重集"
layout: "post"
diff: 省选/NOI-
pid: P7477
tag: ['O2优化', '图论建模', '2-SAT', '可持久化线段树']
---
# 「C.E.L.U-02」划分可重集
## 题目描述

给你一个长度为 $n$ 的数列 $v$，请你将其划分成两个可重集 $a$ 和 $b$。你将从左至右开始划分，每个数必须至少被划分进一个可重集中。  
一个数 $v_i$ 可以被划分进 $a$ 当且仅当 $j<i \ and\ v_j\le v_i-k$ 的 $v_j$ 都没有被划分进当前的 $a$。一个数 $v_i$ 可以被划分进 $b$ 当且仅当 $j<i\ and\ v_j\ge v_i+k$ 的 $v_j$ 都没有被划分进当前的 $b$。  
同时给出了 $m$ 组关系，每组关系代表 $u$ 和 $v$ 不能划分进同一个可重集里。求能使划分成功的最小的 $k$。如果不存在合法划分，请输出 `-1`。
## 输入格式

第一行两个数 $n,m$，意义在题目描述中。 	   
接下来一行共 $n$ 个数，代表 $v$。   
下面 $m$ 行每行两个数，表示一组关系。
## 输出格式

仅一个数，答案。
## 样例

### 样例输入 #1
```
6 0
6 2 8 5 7 3
```
### 样例输出 #1
```
2
```
### 样例输入 #2
```
10 3
1 3 4 3 8 2 3 4 5 6
2 3
6 7
1 9

```
### 样例输出 #2
```
5
```
## 提示

### 样例解释

**样例解释一**

以下是一组合法的划分：  
|6|2|8|5|7|3|
|:---:|:---:|:---:|:---:|:---:|:---:|
|a|b|b|a|b|a|

**样例解释二**

以下是一组合法的划分：  
|1|3|4|3|8|2|3|4|5|6|
|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|
|b|b|a|b|a|b|a|a|a|b|

### 数据范围 
|数据编号|$n$|$m$|
|:---:|:---:|:---:|
|$1\sim2$|$\le10^3$|$0$|
|$3\sim4$|$\le10^3$|$\le10^3$|
|$5\sim6$|$\le2\times10^4$|$0$|
|$7\sim10$|$\le2\times10^4$|$\le2\times10^4$|

对于 $100\%$ 的数据，$n,m\le2\times10^4,v_i\le10^9$，保证 $u<v\le n$，没有一对相同的 $u,v$。


---

---
title: "[省选联考 2021 A/B 卷]  宝石"
layout: "post"
diff: 省选/NOI-
pid: P7518
tag: ['倍增', '二分', '各省省选', '2021', '数据结构', 'O2优化', '可持久化线段树']
---
# [省选联考 2021 A/B 卷]  宝石
## 题目背景

**链的部分分官方数据有误。这里已经修改，如仍有误请反馈。**
## 题目描述

欧艾大陆上有 $n$ 座城市，城市从 $1 \sim n$ 编号，所有城市经由 $n - 1$ 条无向道路互相连通，即 $n$ 座城市与 $n - 1$ 条道路构成了一棵树。

每座城市的集市上都会出售宝石，总共有 $m$ 种不同的宝石，用 $1 \sim m$ 编号。$i$ 号城市的集市出售的是第 $w_i$ 种宝石，一种宝石可能会在多座城市的集市出售。

K 神有一个宝石收集器。这个宝石收集器能按照顺序收集至多 $c$ 颗宝石，其收集宝石的顺序为：$P_1, P_2, \ldots , P_c$。更具体地，收集器需要先放入第 $P_1$ 种宝石，然后才能再放入第 $P_2$ 种宝石，之后再能放入第 $P_3$ 种宝石，以此类推。其中 $P_1, P_2, \ldots , P_c$ 互不相等。

K 神到达一个城市后，如果该城市的集市上出售的宝石种类和当前收集器中需要放入的种类相同，则他可以在该城市的集市上购买一颗宝石并放入宝石收集器中；否则他只会路过该城市什么都不做。

现在 K 神给了你 $q$ 次询问，每次给出起点 $s_i$ 与终点 $t_i$，他想知道如果从 $s_i$ 号城市出发，沿最短路线走到 $t_i$ 号城市后，他的收集器中最多能收集到几个宝石？（在每次询问中，收集器内初始时没有任何宝石。起点与终点城市集市上的宝石可以尝试被收集）
## 输入格式

第一行，包含三个正整数 $n, m, c$，分别表示城市数，宝石种类数，收集器的容量。  
第二行，包含 $c$ 个正整数 $P_i$。数据保证 $1 \le P_i \le m$ 且这些数互不相等。  
第三行，包含 $n$ 个正整数 $w_i$，表示每个城市集市上出售的宝石种类。  
接下来 $n - 1$ 行，每行两个正整数 $u_i, v_i$，表示一条连接 $u_i$ 和 $v_i$ 号城市的道路。  
接下来一行，包含一个正整数 $q$，表示询问次数。  
接下来 $q$ 行，每行两个正整数 $s_i, t_i$，表示该次询问的起点与终点。
## 输出格式

按输入顺序输出 $q$ 行，每行一个整数，表示询问的答案。
## 样例

### 样例输入 #1
```
7 3 3
2 3 1
2 1 3 3 2 1 3
1 2
2 3
1 4
4 5
4 6
6 7
5
3 5
1 3
7 3
5 7
7 5

```
### 样例输出 #1
```
2
2
2
3
1

```
### 样例输入 #2
```
见附件中的 gem/gem2.in
```
### 样例输出 #2
```
见附件中的 gem/gem2.ans
```
### 样例输入 #3
```
见附件中的 gem/gem3.in
```
### 样例输出 #3
```
见附件中的 gem/gem3.ans
```
## 提示

**【数据范围】**

对于所有测试数据：$1 \le n, q \le 2 \times {10}^5$，$1 \le c \le m \le 5 \times {10}^4$，$1 \le w_i \le m$。

每个测试点的具体限制见下表：

| 测试点编号 | $n, q \le$ | 特殊限制 |
|:-:|:-:|:-:|
| $1 \sim 2$ | $10$ | 无 |
| $3 \sim 5$ | $1000$ | 无 |
| $6 \sim 10$ | $2 \times {10}^5$ | $m \le 300$ |
| $11 \sim 14$ | $2 \times {10}^5$ | $u_i = i$，$v_i = i + 1$ |
| $15 \sim 20$ | $2 \times {10}^5$ | 无 |


---

---
title: "「PMOI-3」简单模拟题"
layout: "post"
diff: 省选/NOI-
pid: P7577
tag: ['二分', 'O2优化', '可持久化线段树']
---
# 「PMOI-3」简单模拟题
## 题目描述

给定一个长度为 $n$ 的序列 $s$。

$q$ 次询问，每个询问形如 `a b c d e f`，需要你求出下面式子的值：
$$\sum_{L=a}^{b}[e\le G(F(L,c),F(L,c+1),\cdots,F(L,d))\le f]$$
这里 $F(l,r)$ 表示 $s$ 序列区间 $[l,r]$ 中不同的数的个数，$G(x_1,x_2,\cdots,x_k)$ 表示 $x_1,x_2,\cdots,x_k$ 中不同的数的个数。
## 输入格式

第一行两个整数 $n,q$，表示序列长度与命令次数。

第二行输入 $n$ 个整数，第 $i$ 个数表示 $s_i$。

下面 $q$ 行，每行输入 $6$ 个数 $a',b',c',d',e,f$。令上一次询问的答案为 $\text{lastans}$（特别的，若这是第一次询问，则 $\text{lastans}=0$），则本次询问中

$a=(a'+\text{lastans})\bmod n+1\\$
$b=(b'+\text{lastans})\bmod n+1\\$
$c=(c'+\text{lastans})\bmod n+1\\$
$d=(d'+\text{lastans})\bmod n+1\\$

**注意，你需要将 $a,b,c,d$ 重新排序使得 $a\le b\le c\le d$。**
## 输出格式

对于每次询问，依次输出答案。
## 样例

### 样例输入 #1
```
3 1
2020 2021 2020
3 3 2 2 1 1
```
### 样例输出 #1
```
1
```
### 样例输入 #2
```
10 3
2 2 4 3 5 3 5 4 1 2
3 5 2 4 1 2
5 7 2 9 2 4
1 3 1 8 1 3
```
### 样例输出 #2
```
2
4
4
```
## 提示

【样例一解释】

第一次询问中，$a=1,b=1,c=3,d=3,e=1,f=1$。

不难得到 $G(F(1,3))=1$，且 $e\le G(F(1,3))\le f$，所以答案为 $1$。

【样例二解释】
| 询问编号 | $a$ | $b$ | $c$ | $d$ | $e$ | $f$ |
| :-----------: | :-----------: | :-----------: | :-----------: | :-----------: | :-----------: | :-----------: |
| ① | 3 | 4 | 5 | 6 | 1 | 2 |
| ② | 2 | 5 | 8 | 10 | 2 | 4 |
| ③ | 3 | 6 | 6 | 8 | 1 | 3 |

【数据范围】

**本题采用捆绑测试**。
- Subtask1（10pts）：$n,q\le500$，$1\le s_i\le10^6$；
- Subtask2（15pts）：$n,q\le3\times10^3$；
- Subtask3（20pts）：$b-a\le20$；
- Subtask4（25pts）：$n,q\le10^5$；
- Subtask5（30pts）：无特殊限制。

对于 $100\%$ 的数据满足，$1\le n,q\le3\times10^5$，$0\le|s_i|\le10^9$，对于所有询问，$1\le a,b,c,d\le n$，$0\le e\le f\le n$。

【提示】
1. 本题中，$[x \le y \le z]$ 表示 $y$ 是否 $\in[x,z]$。如果在该区间内，则值为 $1$；否则为 $0$。

2. 输入量较大，请采用较快的读入方式。


---

---
title: "[CCO 2021] Through Another Maze Darkly"
layout: "post"
diff: 省选/NOI-
pid: P7830
tag: ['2021', 'CCO（加拿大）', '深度优先搜索 DFS', '可持久化线段树']
---
# [CCO 2021] Through Another Maze Darkly
## 题目背景

**警告：滥用本题评测将被封号！**
## 题目描述

黑暗迷宫是一个树形结构，有 $n$ 个房间和 $n - 1$ 个走廊，房间编号 $1, 2, \cdots, n$。

黑暗迷宫里面漆黑一片，你看不见自己在哪里。为了辨别方向，每个房间有一个激光指示器，初始指向连接这个房间的某一个走廊。你重复执行如下策略行动：

- 将当前房间的激光指示器按顺时针方向旋转到下一个走廊
- 沿着激光指示器指向的走廊走到另一个房间

你打算从编号为 $1$ 的房间开始，将这个策略重复执行 $k$ 次，想知道自己会到达哪个房间。你觉得这个问题太简单了，于是进行了 $q$ 次询问。每次询问是相互独立的，即激光指示器每次都会回到初始状态。
## 输入格式

第一行，两个整数 $n, q$；

接下来 $n$ 行，第 $i$ 行描述第 $i$ 个房间。首先，一个整数 $k$ 表示房间 $i$ 连接的走廊数量，接下来 $k$ 个整数 $c_1, c_2, \cdots, c_k$，表示按顺时针顺序每个走廊另一头的房间编号。第 $i$ 个房间的激光指示器初始指向通往房间 $c_1$ 的走廊。

接下来 $q$ 行，每行一个正整数 $k$。
## 输出格式

对于每组询问，输出一行，表示所求的值。
## 样例

### 样例输入 #1
```
5 6
1 2
3 3 1 4
1 2
2 5 2
1 4
1
2
3
4
5
6
```
### 样例输出 #1
```
2
1
2
4
2
3
```
## 提示

#### 样例 #1 解释
初始激光指示器的指向如图：

![](https://cdn.luogu.com.cn/upload/image_hosting/2k48xyl0.png)
#### 数据范围
对于 $\frac{7}{45}$ 的数据，第 $i$ 个房间连接第 $i - 1$ 和第 $i + 1$ 个房间（如果这两个房间存在）；

对于另 $\frac{14}{45}$ 的数据，$2 \leq n \leq 2 \times 10^3$，$1 \leq q \leq 2 \times 10^3$；

对于另 $\frac{4}{15}$ 的数据，$q = 1$；

对于 $100\%$ 的数据，$2 \leq n \leq 8 \times 10^5$，$1 \leq q \leq 8 \times 10^5$，$1 \leq k \leq 10^{15}$，保证数据给出的是**一棵树**。
#### 题目来源
[CCO2021](https://cemc.math.uwaterloo.ca/contests/computing/2021/index.html) D1T3


---

---
title: "[ONTAK2010] Peaks 加强版"
layout: "post"
diff: 省选/NOI-
pid: P7834
tag: ['2010', '倍增', 'Kruskal 重构树', '深度优先搜索 DFS', '可持久化线段树']
---
# [ONTAK2010] Peaks 加强版
## 题目背景

原题链接：[P4197 Peaks](https://www.luogu.com.cn/problem/P4197)
## 题目描述

给定一张 $n$ 个点、$m$ 条边的无向图，第 $i$ 个点的权值为 $a_i$，边有边权。

有 $q$ 组询问，每组询问给定三个整数 $u, x, k$，求从 $u$ 开始只经过权值 $\leq x$ 的边所能到达的权值第 $k$ 大的点的权值，如果不存在输出 $-1$。

**本题强制在线。即：每次查询输入的是 $u', x', k'$，则 $u = (u' \operatorname{xor} \text{lastans}) \bmod n + 1$，$k$ 的解密方式与之相同，$x = x' \operatorname{xor} \text{lastans}$**。
## 输入格式

第一行，三个整数 $n, m, q$；

第二行，$n$ 个整数 $a_1, a_2, \cdots, a_n$；

接下来 $m$ 行，每行三个整数 $s, t, w$，表示一条边的两个端点和权值；

接下来 $q$ 行，每行三个整数 $u', x', k'$。

**注意：处理第一组数据和无解时的 $\text{lastans} = 0$。**
## 输出格式

对于每组询问，输出一行，一个整数，表示所求的值。
## 样例

### 样例输入 #1
```
10 11 3
1 2 3 4 5 6 7 8 9 10
1 4 4
2 5 3
9 8 2
7 8 10
7 1 4
6 7 1
6 4 8
2 1 5
10 8 10
3 4 7
3 4 6
0 5 5
1 6 8
7 8 1
```
### 样例输出 #1
```
1
-1
8
```
## 提示

对于 $100\%$ 的数据，$1 \leq n \leq 10^5$，$0 \leq m, q \leq 5 \times 10^5$，$1 \leq s, t \leq n$，$1 \leq a_i, w \leq 10^9$，$0 \leq u', x', k' < 2^{31}$。


---

---
title: "动态图连通性"
layout: "post"
diff: 省选/NOI-
pid: P8860
tag: ['贪心', '倍增', '洛谷原创', 'O2优化', '最短路', '可持久化线段树', '洛谷月赛']
---
# 动态图连通性
## 题目描述

给定一张 $n$ 点 $m$ 边的**有向图**，初始时存在一条从 $1$ 到 $n$ 的路径。  

你需要处理 $q$ 组询问，每组询问给定一个 $[1,m]$ 中的正整数 $x$，如果原图中的第 $x$ 条边仍存在且当前的图中删去原图中的第 $x$ 条边后仍有一条从 $1$ 到 $n$ 的路径，则删除原图中的第 $x$ 条边。  

你需要报告每组询问中是否删去了第 $x$ 条边。 

**请注意：一组询问中删除某条边后，这条边会被永远删除。也就是询问之间会相互影响。**
## 输入格式

输入第一行三个正整数 $n,m,q$，分别表示有向图的点数，边数以及询问个数。   

接下来 $m$ 行，第 $i$ 行两个正整数 $u_i,v_i$，表示第 $i$ 条边由 $u_i$ 连向 $v_i$。  

接下来 $q$ 行，每行一个正整数 $x$，具体含义同题目描述。
## 输出格式

输出共 $q$ 行，每行一个正整数 $0$ 或 $1$。 

如果在这组询问中删去了第 $x$ 条边，输出 $1$，否则输出 $0$。
## 样例

### 样例输入 #1
```
5 6 5
1 2
2 3
3 5
2 4
4 5
5 1
1
2
3
4
5
```
### 样例输出 #1
```
0
1
1
0
0

```
### 样例输入 #2
```
10 11 8
1 2
2 7
2 5
1 4
4 5
4 8
8 9
9 5
3 2
3 6
5 10
10
5
11
10
3
7
1
4

```
### 样例输出 #2
```
1
1
0
0
1
0
1
0
```
## 提示

#### 【样例解释】

在第一组样例中：

初始时，图中边集为 $\{ (1,2),(2,3),(3,5),(2,4),(4,5),(5,1) \}$。

若删去原图中的第 $1$ 条边 $(1,2)$，图中就没有 $1$ 到 $n$ 的路径，所以不能删除第 $1$ 条边。

若删去原图中的第 $2$ 条边 $(2,3)$，图中存在路径 $1 \to 2 \to 4 \to 5$，所以可以删去第 $2$ 条边，图中边集变为 $\{ (1,2),(3,5),(2,4),(4,5),(5,1) \}$。

若删去原图中的第 $3$ 条边 $(3,5)$，图中存在路径 $1 \to 2 \to 4 \to 5$，所以可以删去第 $3$ 条边，图中边集变为 $\{ (1,2),(2,4),(4,5),(5,1) \}$。

若删去原图中的第 $4$ 条边 $(2,4)$，图中就没有 $1$ 到 $n$ 的路径，所以不能删除第 $4$ 条边。

若删去原图中的第 $5$ 条边 $(4,5)$，图中就没有 $1$ 到 $n$ 的路径，所以不能删除第 $5$ 条边。

#### 【数据范围】

|  测试点编号  |    $n,m \leq$   |     $q \leq$    |            特殊限制           |
|:------------:|:---------------:|:---------------:|:-------------------------------:|
|  $1 \sim 2$  |      $1000$     |      $1000$     |                无               |
|  $3 \sim 6$  |      $5000$     | $2 \times 10^5$ |                无               |
|  $7 \sim 8$  | $2 \times 10^5$ | $2 \times 10^5$ | 保证所有询问中最多有 $1$ 条边没有被删除 |
| $9 \sim 12$ | $2 \times 10^5$ | $2 \times 10^5$ | 保证所有询问中最多有 $5$ 条边没有被删除 |
| $13 \sim 16$ | $2 \times 10^5$ | $2 \times 10^5$ |         将有向图视作无向图仍能得到正确答案        |
| $17 \sim 20$ | $2 \times 10^5$ | $2 \times 10^5$ |                无               |

对于所有数据，$1 \leq n,m,q \leq 2 \times 10^5$，给定的图无重边、自环，且存在一条 $1$ 到 $n$ 的路径。

**给出的两组大样例分别满足测试点 1 和测试点 13 的限制。**


---

---
title: "[COCI 2022/2023 #4] Mreža"
layout: "post"
diff: 省选/NOI-
pid: P9175
tag: ['2022', '可持久化线段树', 'COCI（克罗地亚）']
---
# [COCI 2022/2023 #4] Mreža
## 题目背景

### 卡评测封号。
## 题目描述

市长 Mirko 住在一个有 $n$ 个社区的城市里，这 $n$ 个社区用 $n-1$ 条双向道路连接，满足从任何社区出发都可以到达任意其他社区。

Mirko 想升级一些道路以疏导交通。对于每条路，我们知道目前在这条路上汽车的行驶速度 $v_i$，升级所需花费 $c_i$ 和升级后在这条路上汽车的行驶速度 $s_i$。

有 $q$ 个不满意的市民来见 Mirko。每个人都有他们自己的升级建议。第 $i$ 个市民的建议是：「我们应该在升级社区 $a_i$ 和 $b_i$ 之间的道路上投资 $e_i$ 欧元。」

对于每个建议，Mirko 感兴趣的是，如果他的目标是使社区 $a_i$ 和 $b_i$ 之间的最低驾驶速度最大化，那么他在升级道路上最多花费 $e_i$ 欧元的话这个最低驾驶速度是多少。

Mirko 瞬间意识到这个问题不简单，并且他雇佣你来帮助他！

## 输入格式

第一行包含一个整数 $n\ (2\le n\le 10^5)$，表示社区总数。

接下来 $n-1$ 行，每行五个整数 $x_i,y_i,v_i,c_i,s_i\ (1\le x_i,y_i\le n,1\le v_i<s_i\le 10^9,1\le c_i\le 10^9)$，表示社区 $x_i$ 和 $y_i$ 之间有一条路相连，目前在这条路上汽车的行驶速度为 $v_i$，升级所需花费为 $c_i$，升级后在这条路上汽车的行驶速度为 $s_i$。

接下来一行一个整数 $q\ (1\le q\le 10^5)$，表示不满意的市民总数。

接下来 $q$ 行，每行三个整数 $a_i,b_i,e_i\ (1\le a_i,b_i\le n,a_i\neq b_i,1\le e_i\le 10^{18})$，意义如题目描述。
## 输出格式

输出 $q$ 行，表示对每个市民建议的答案。
## 样例

### 样例输入 #1
```
6
1 2 5 7 10
1 3 4 8 9
3 4 7 1 15
3 5 6 3 11
3 6 5 6 8
3
2 4 15
6 4 5
3 5 10
```
### 样例输出 #1
```
7
5
11
```
### 样例输入 #2
```
4
1 2 5 5 8
2 3 4 6 9
3 4 6 10 7
4
1 4 16
2 4 16
1 4 10
3 4 10
```
### 样例输出 #2
```
6
7
5
7
```
## 提示

样例解释 $1$：下图展示了这个城市和社区。边上写的分别是目前汽车的行驶速度，升级花费和升级后的汽车行驶速度。

![](https://cdn.luogu.com.cn/upload/image_hosting/umum0365.png?x-oss-process=image/resize,m_lfit,h_1700,w_2250)

如果我们升级 $1$ 和 $2$，$1$ 和 $3$ 之间的道路，从 $2$ 到 $4$ 的行驶速度将变成 $10,9,7$。最小为 $7$。

如果我们升级 $4$ 和 $3$ 之间的道路，从 $6$ 到 $4$ 的行驶速度将变成 $5,15$。最小为 $5$。

如果我们升级 $3$ 和 $5$ 之间的道路，从 $5$ 到 $3$ 的行驶速度将变成 $11$。

|子任务编号|	附加限制|	分值|
|:-:|:-:|:-:|
| $0$ | 是样例 | $0$ |
| $1$ | $n,q\le 1000$ |	$19$ |
| $2$ |	每个社区最多与两个其他社区相连 | $26$ |
| $3$ |	无附加限制 | $55$ |


---

---
title: "「DROI」Round 2  进制与操作"
layout: "post"
diff: 省选/NOI-
pid: P9376
tag: ['莫队', '树状数组', 'O2优化', '可持久化线段树', '随机化']
---
# 「DROI」Round 2  进制与操作
## 题目背景

与其编写苍白无力的背景，不如出更有质量的题。
## 题目描述

定义数 $x$ 在 $B$ 进制下的一次操作为以下两种操作中的任意一种：

- 令 $x \rightarrow \lfloor \dfrac{x}{B} \rfloor$。

- 令 $x \rightarrow x \times B + t $。其中 $t \in [0,B-1]$。

现给定长度为 $n$ 的序列 $A$。$m$ 次询问，每次询问形如：

- `l r B` 表示询问将序列 $A$ 中下标在 $[l,r]$ 之内的数在 $B$ 进制下操作，至少多少次才能将所有数变为相同（注：每次操作是对**一个数**进行操作）。

**询问间相互独立，即操作不会真的进行。**


## 输入格式

第一个两个整数，分别表示 $n,m$。

第二行一行 $n$ 个数，表示序列 $A$。

接下来 $m$ 行，每行三个数，分别表示这次询问的 $l,r,B$。
## 输出格式

输出共 $m$ 行，其中第 $i$ 行表示第 $i$ 次询问的答案。
## 样例

### 样例输入 #1
```
5 5
7 6 5 8 9
1 3 2
2 5 2
4 4 6
3 5 4
1 5 3
```
### 样例输出 #1
```
5
8
0
5 
10
```
### 样例输入 #2
```
8 4
10 14 7 11 19 13 7 18 
1 7 4
3 8 2
1 4 4
1 4 2

```
### 样例输出 #2
```
15
18
8
11

```
## 提示

### 样例解释

对于样例一，五次询问分别将区间内所有数变为 $3$、$4$、$8$、$4$、$6$ 是一种最优操作。

------------

### 数据范围 

**「本题采用捆绑测试」**

- $\operatorname{Subtask} 1(10\%)$：$n,m \leq 1000$。

- $\operatorname{Subtask} 2(20\%)$：保证所有询问 $B=2$。

- $\operatorname{Subtask} 3(40\%)$：$n,m \leq 3 \times 10^4$。

- $\operatorname{Subtask} 4(30\%)$：无特殊限制。

对于 $100\%$ 的数据：$1 \leq n,m \leq 10^5$，$2 \leq A_i,B \leq 10^8$。



---


---
title: "『SpOI - R1』架子鼓可以站 C"
layout: "post"
diff: 省选/NOI-
pid: P10794
tag: ['O2优化', '树形 DP', '树的直径']
---
# 『SpOI - R1』架子鼓可以站 C
## 题目描述

现在有一棵 $n$ 个点的树，树根是节点 $1$。

可以对这棵树做任意次**站 C 操作**，每次**站 C 操作**为：选择树上的一个叶子结点 $x$，再选择根节点到 $x$ 路径上的一条边，删除它；然后添加一条连接 $x$ 和根节点的边。

你需要求出经过若干次**站 C 操作**后树的直径的最大值。

**注意：叶子结点的定义是不为根节点，且度数为 $1$ 的节点。**
## 输入格式

**本题包含多组测试。**

第一行一个整数 $T$，表示测试数据组数。

接下来 $T$ 组数据，每组第一行一个整数 $n$，第二行一个长为 $n-1$ 的序列 $f_i$，第 $i$ 项为 $i+1$ 号节点在树上的父亲。
## 输出格式

对于每组数据，一行一个整数表示答案。
## 样例

### 样例输入 #1
```
1
3
1 2
```
### 样例输出 #1
```
2
```
### 样例输入 #2
```
1
7
1 2 1 4 4 5
```
### 样例输出 #2
```
6
```
## 提示

### 样例 #1 解释

不做操作时，树的直径为 $2$。可以证明这是最大的直径。

### 样例 #2 解释

样例中的树如下：

![](https://cdn.luogu.com.cn/upload/image_hosting/23wosgfo.png)

只需要一次站 C 操作：选择叶子结点 $6$，断开 $1$ 到 $4$ 的边，再连接 $6$ 和 $1$。

这将会使树形成一条链，直径为 $6$。可以证明这是最大的直径。

### 数据范围

**请注意常数因子对程序效率的影响。**

**本题开启子任务捆绑与子任务依赖。**

对于所有数据，满足 $1\leq T\leq 10^4$，$2 \leq n \leq 2\times 10^5$，保证输入数据构成一棵树。

| Subtask | $T\leq$ | $n\leq$ | 特殊性质 | 得分 | 子任务依赖 |
| :----------: | :----------: | :----------: | :----------: | :----------: | :----------: |
| 1 | $10^4$ | $10$ | 无 | $15$ | 无 |
| 2 | $10^4$ | $20$ | 无 | $15$ | 1 |
| 3 | $10^4$ | $90$ | 无 | $20$ | 1,2 |
| 4 | $10^4$ | $2\times 10^5$ | $A$ | $15$ | 无 |
| 5 | $15$ | $2\times 10^5$ | 无 | $35$ | 1,2,3,4 |

**特别地，对于 Subtask 4，保证 $\sum n\leq 3\times 10^6$。**

特殊性质 $A$：不存在一对 $x\neq 1\land y\neq 1$ 的 $(x,y)$ 满足 $\text{LCA}(x,y)=1$。


---

---
title: "兰奇的卡牌游戏"
layout: "post"
diff: 省选/NOI-
pid: P11411
tag: ['贪心', '树的直径', '笛卡尔树']
---
# 兰奇的卡牌游戏
## 题目描述

作为制卡大师的兰奇，发明了一种自助型卡牌游戏。

给定 $n$ 张卡牌，第 $i$ 张卡牌编号为 $i$，其权值为 $a_i$，卡牌的权值互不相同。

这个卡牌游戏的规则需要自己生成。一开始，所有的牌都在备选区。从备选区中选取一张编号最小的卡牌放到手牌区，便可进入规则生成阶段。

规则生成阶段的步骤如下：

1. 将手牌区的任意一张牌弃置到废牌区之中。

1.  然后在备选区中选择一张编号和权值均大于当前弃牌的牌，加入手牌区。若存在这样的一张牌，则称这张牌与弃牌互为置换；若不存在这样的一张牌，则跳过当前步骤。

1. 继续从备选区中选择一张编号大于当前弃牌且权值小于当前弃牌的牌，加入手牌区。若存在这样的一张牌，则同样可称这张牌与弃牌互为置换；若不存在这样的一张牌，则跳过当前步骤。

1. 完成以上步骤后，若手牌区没有卡牌了，则规则生成阶段结束。若仍有卡牌，则继续重复上述步骤，直到手牌区没有卡牌。

为了保证生成置换的唯一性，兰奇规定规则生成阶段合法当且仅当规则生成结束后，所有的牌都在废牌区。并且在正式游戏阶段一张编号较大的牌经过一系列操作后得到一张编号较小的牌后，该编号较大的牌，均要满足能够有机会按照在手牌区出现过的该张编号较小的牌的弃牌后生成的置换相同的步骤在规则生成阶段成为编号较小的牌的置换；若手牌区未出现该张编号较小的牌的弃牌后生成的置换，则无需考虑。否则，生成的置换是无效的。

可以证明在规则生成阶段合法的情况下，每张卡牌可以与哪些卡牌互为置换的方案是唯一的。

正式游戏阶段的步骤如下：

1. 选择任意一张卡牌作为起始卡牌并加入手牌区，然后进入下一步骤。

1. 将前手牌区的卡牌弃入废牌堆，然后从备选区中选择一张该卡牌的置换加入手牌区。若当前弃置的卡牌在备选区没有置换，则正式游戏阶段结束；反之，则得分增加 $1$ 分，然后继续重复步骤 2。

游戏发售后，销量并不是很好。因为游戏规则太复杂了。玩家们希望删去一些卡牌，使得正式游戏阶段的最大得分不超过 $k$。

而兰奇为了保证游戏的不做太大的改动，他要求删去一些卡牌后，保留下来的任意一张卡牌重新生成的置换要与原来未删去卡牌情况下的置换相同。

删去后置换仍相同的定义是：设 $S$ 表示某一张卡牌，未删除任何一张卡牌时的置换集合；$T$ 表示该张卡牌，在删除了部分卡牌时的置换集合。此时，满足 $T \subseteq S$。则称删去部分卡牌后，该卡牌的置换与原来未删去卡牌情况下的置换相同。

兰奇想知道，在满足了玩家和自己的要求的前提下，他最少要删除几张卡片。

## 输入格式

第一行输入两个正整数 $n$ 和 $k$，分别表示卡牌的数量和正式游戏阶段的最大得分不能超过的值。

第二行输入 $n$ 个元素，第 $i$ 个元素 $a_i$，表示编号为 $i$ 的卡牌权值。
## 输出格式

输出一个正整数，表示在满足玩家和自己的要求的前提下，最少要删除几张卡片。
## 样例

### 样例输入 #1
```
3 2
1 2 3
```
### 样例输出 #1
```
0
```
### 样例输入 #2
```
6 2
3 2 7 99 10 15
```
### 样例输出 #2
```
3
```
## 提示

**【样例1解释】**

编号为 $1$ 的卡牌与编号为 $2$ 的卡牌互为置换，编号为 $2$ 的卡牌与编号为 $3$ 的卡牌互为置换。

所以，在不删去的情况下，获得最大得分的方案是：用编号为 $1$ 的卡牌作为起始卡牌置换出编号为 $2$ 的卡牌，然后再置换出编号为 $3$ 的卡牌。该方案的最大得分为 $2$，所以不需要删除任何一张卡牌。

**【数据范围】**

**本题采用捆绑测试**。

- Subtask 1（15 points）：$n \le 10$。
- Subtask 2（5 points）：$k = n$。
- Subtask 3（80 points）：无特殊限制。

对于所有测试数据，$1 \le n \le 2000$，$1 \le a_i \le 10^9$。


---

---
title: "「ZHQOI R1」树图"
layout: "post"
diff: 省选/NOI-
pid: P11956
tag: ['树状数组', 'O2优化', '树的直径', '树论', '洛谷比赛']
---
# 「ZHQOI R1」树图
## 题目背景

树的生成图的生成树的生成图的生成树的生成图的生成树的生成图的生成树的生成图的生成树……
## 题目描述

定义一棵树 $T$ 的生成图 $G$ 为一个无向完全图，其中点 $i$ 与点 $j$ 的边权为 $T$ 中 $i$ 和 $j$ 的距离。

定义一棵树 $T$ 的 $f(T)$ 为 $T$ 的生成图的最大生成树的边权和。

你有一棵以 $1$ 为根的树 $T$，边权全为 $1$，有 $q$ 次操作，每次加一个叶子。你需要在操作前及每次操作后求出 $f(T)$。
## 输入格式

第一行，两个整数 $n,q$。

后 $n-1$ 行，每行两个数 $u,v$，表示一条连接 $u,v$ 的边。

后 $q$ 行，其中第 $i$ 行一个整数 $x$，表示在编号为 $x$ 的点下挂一个编号为 $n+i$ 的点。
## 输出格式

输出 $q+1$ 行，表示操作前及每次操作后的 $f(T)$。
## 样例

### 样例输入 #1
```
6 5
1 2
1 3
1 4 
2 5
2 6
4
3
7
6
8
```
### 样例输出 #1
```
13
19
23
33
41
47
```
## 提示

**【数据范围】**

**本题采用捆绑测试。**

对于所有数据：$1\le n,q\le 2\times 10^5$，保证刚开始给的是一棵树。

| 子任务编号 | $n\le $ | $q\le $ | 特殊性质 | 分数 |
| :-: | :-: | :-: | :-: | :-: |
| 1          | $100$   | $100$   | 无       | $10$ |
| 2          | $2000$  | $2000$  | 无       | $10$ |
| 3          | $2\times 10^5$  | $5$     | 无       | $10$ |
| 4          | $2\times 10^5$  | $2\times 10^5$  | A        | $10$ |
| 5          | $2\times 10^5$  | $2\times 10^5$  | B        | $10$ |
| 6          | $2\times 10^5$  | $2\times 10^5$  | C        | $10$ |
| 7          | $10^5$  | $10^5$  | 无        | $10$ |
| 8          | $2\times 10^5$  | $2\times 10^5$  | 无       | $30$ |

特殊性质 A：保证树一直是一条链。

特殊性质 B：保证每次操作的叶子的父亲都是 $1$。

特殊性质 C：保证树均匀随机生成，每次加的点的父亲从已有的点中均匀随机生成。


---

---
title: "[APIO2010] 巡逻"
layout: "post"
diff: 省选/NOI-
pid: P3629
tag: ['2010', 'APIO', '深度优先搜索 DFS', '树的直径']
---
# [APIO2010] 巡逻
## 题目描述

在一个地区中有 $n$ 个村庄，编号为 $1, 2, \dots, n$。有 $n-1$ 条道路连接着这些村庄，每条道路刚好连接两个村庄，从任何一个村庄，都可以通过这些道路到达其他任何一个村庄。每条道路的长度均为 $1$ 个单位。为保证该地区的安全，巡警车每天要到所有的道路上巡逻。警察局设在编号为 $1$ 的村庄里，每天巡警车总是从警察局出发，最终又回到警察局。下图表示一个有 $8$ 个村庄的地区，其中村庄用圆表示（其中村庄 $1$ 用黑色的圆表示），道路是连接这些圆的线段。为了遍历所有的道路，巡警车需要走的距离为 $14$ 个单位，每条道路都需要经过两次。

![](https://cdn.luogu.com.cn/upload/pic/4401.png)

为了减少总的巡逻距离，该地区准备在这些村庄之间建立 $K$ 条新的道路，每条新道路可以连接任意两个村庄。两条新道路可以在同一个村庄会合或结束，如下面的图例 (c)。一条新道路甚至可以是一个环，即其两端连接到同一个村庄。由于资金有限，$K$ 只能是 $1$ 或 $2$。同时，为了不浪费资金，每天巡警车必须经过新建的道路正好一次。下图给出了一些建立新道路的例子：

![](https://cdn.luogu.com.cn/upload/pic/4402.png) 

在 (a) 中，新建了一条道路，总的距离是 $11$。在 (b) 中，新建了两条道路，总的巡逻距离是 $10$。在 (c) 中，新建了两条道路，但由于巡警车要经过每条新道路正好一次，总的距离变为了 $15$。试编写一个程序，读取村庄间道路的信息和需要新建的道路数，计算出最佳的新建道路的方案使得总的巡逻距离最小，并输出这个最小的巡逻距离。


## 输入格式

第一行包含两个整数 $n, K(1 ≤ K ≤ 2)$。接下来 $n-1$ 行，每行两个整数 $a,b$，表示村庄 $a$ 与 $b$ 之间有一条道路 $(1 ≤ a, b ≤ n)$。

## 输出格式

输出一个整数，表示新建了 $K$ 条道路后能达到的最小巡逻距离。

## 样例

### 样例输入 #1
```
8 1 
1 2 
3 1 
3 4 
5 3 
7 5 
8 5 
5 6 
```
### 样例输出 #1
```
11
```
### 样例输入 #2
```
8 2 
1 2 
3 1 
3 4 
5 3 
7 5 
8 5 
5 6 
```
### 样例输出 #2
```
10
```
### 样例输入 #3
```
5 2 
1 2 
2 3 
3 4 
4 5 
```
### 样例输出 #3
```
6
```
## 提示

- $10\%$ 的数据中，$1≤n≤1000,K=1$；
- $30\%$ 的数据中，$K=1$；
- $80\%$ 的数据中，每个村庄相邻的村庄数不超过 $25$；
- $90\%$ 的数据中，每个村庄相邻的村庄数不超过 $150$；
- $100\%$ 的数据中，$3≤n≤10^5,1≤K≤2$。



---

---
title: "[TJOI2017] 城市"
layout: "post"
diff: 省选/NOI-
pid: P3761
tag: ['2017', '各省省选', '枚举', '树的直径', '天津']
---
# [TJOI2017] 城市
## 题目描述

从加里敦大学城市规划专业毕业的小明来到了一个地区城市规划局工作。这个地区一共有 $n$ 座城市，$n-1$ 条高速公路，保证了任意两运城市之间都可以通过高速公路相互可达，但是通过一条高速公路需要收取一定的交通费用。小明对这个地区深入研究后，觉得这个地区的交通费用太贵。

小明想彻底改造这个地区，但是由于上司给他的资源有限，因而小明现在只能对一条高速公路进行改造，改造的方式就是去掉一条高速公路，并且重新修建一条一样的高速公路（即交通费用一样），使得这个地区的两个城市之间的最大交通费用最小（即使得交通费用最大的两座城市之间的交通费用最小），并且保证修建完之后任意两座城市相互可达。如果你是小明，你怎么解决这个问题？

## 输入格式

输入数据的第一行为一个整数 $n$，代表城市个数。

接下来的 $n - 1$ 行分别代表了最初的 $n-1$ 条公路情况。每一行都有三个整数 $u,v,d$。$u,v$ 代表这条公路的两端城市标号，$d$ 代表这条公路的交通费用。

$1 \leq u,v \leq n$，$1\leq d \leq 2000$。

## 输出格式

输出数据仅有一行，一个整数，表示进行了最优的改造之后，该地区两城市 之间最大交通费用。

## 样例

### 样例输入 #1
```
5
1 2 1
2 3 2
3 4 3
4 5 4
```
### 样例输出 #1
```
7
```
## 提示

对于 $30\%$ 的数据，$1\leq n\leq 500$。

对于 $100\%$ 的数据，$1\leq n\leq 5000$。



---

---
title: "[USACO18FEB] New Barns P"
layout: "post"
diff: 省选/NOI-
pid: P4271
tag: ['2018', 'USACO', '并查集', '连通块', '最近公共祖先 LCA', '树的直径', '动态树 LCT']
---
# [USACO18FEB] New Barns P
## 题目描述

给你一棵树，初始没有节点。你需要支持两种操作：  

- `B p` 表示新建一个节点，将它与 $p$  节点连接；若 $p=-1$，则表示不与其它节点相连  

- `Q k` 表示查询在 $k$ 节点所在的连通块中，距它最远的点的距离。这里距离的定义是两点间经过的边数。
## 输入格式

第一行一个正整数 $q$，表示操作个数。  
接下来 $q$ 行，每行表示一个操作。
## 输出格式

对于每个询问操作，输出一行一个整数表示答案。
## 样例

### 样例输入 #1
```
7
B -1
Q 1
B 1
B 2
Q 3
B 2
Q 2
```
### 样例输出 #1
```
0
2
1

```
## 提示

【数据范围】  

对于 $100%$ 的数据，$1 \le q \le 10^5$。  
保证操作合法。

The example input corresponds to this network of barns:
```
  (1) 
    \   
     (2)---(4)
    /
  (3)
```
In query 1, we build barn number 1. In query 2, we ask for the distance of 1 to the farthest connected barn. Since barn 1 is connected to no other barns, the answer is 0. In query 3, we build barn number 2 and connect it to barn 1. In query 4, we build barn number 3 and connect it to barn 2. In query 5, we ask for the distance of 3 to the farthest connected barn. In this case, the farthest is barn 1, which is 2 units away. In query 6, we build barn number 4 and connect it to barn 2. In query 7, we ask for the distance of 2 to the farthest connected barn. All three barns 1, 3, 4 are the same distance away, which is 1, so this is our answer.

Problem credits: Anson Hu


---

---
title: "[JOI 2019 Final] 珍しい都市"
layout: "post"
diff: 省选/NOI-
pid: P6118
tag: ['2019', '树的直径', '栈', 'JOI（日本）']
---
# [JOI 2019 Final] 珍しい都市
## 题目背景

JOI 2019 Final T5

由于数据点较多，本题只评测其中的部分数据。
## 题目描述

JOI 国有 $N$ 个城市，城市从 $1$ 到 $N$ 编号。这些城市被 $N-1$ 条双向道路连接，第 $i$ 条路连接两个城市 $A_i$ 和 $B_i$。从任何城市出发，可以到达所有城市。

JOI 国有些特产，每种特产的编号都在 $1$ 到 $M$ 之间（包括 $1$ 和 $M$），但是 $1$ 到 $M$ 的某些整数可能不代表 JOI 国的特产。JOI 国的每个城市都产一种特产。$j$ 城产的特产是 $C_j$。多个城市可能产相同的特产。

我们定义两个城市之间的距离为从一个城市到另一个城市需要经过的最少道路数，对于城市 $x$，我们定义城市 $y$（$y\neq x$）是**独特的城市**当且仅当对于任何一个城市 $z$（$z\neq x,z\neq y$），$x$ 与 $y$ 间的距离不等于 $x$ 与 $z$ 之间的距离。

JOI 国交通部部长 K 先生想知道对于城市 $j$ 的**独特的城市**一共能产多少种特产。

给出 JOI 国的道路信息与每个城市产的特产，写一个程序计算对于每个城市的**独特的城市**，一共能产多少种特产。
## 输入格式

第一行两个整数 $N,M$，意义如题目描述。

接下来 $N-1$ 行，每行两个整数 $A_i,B_i$，意义如题目描述。

最后一行 $N$ 个正整数，第 $i$ 个为 $C_i$，意义如题目描述。
## 输出格式

输出 $N$ 行，第 $i$ 行表示对于城市 $i$ 的独特的城市一共能产多少种特产。
## 样例

### 样例输入 #1
```
5 4
1 2
2 3
3 4
3 5
1 2 1 2 4
```
### 样例输出 #1
```
2
0
1
1
1
```
### 样例输入 #2
```
7 1
1 2
2 3
3 4
4 5
5 6
6 7
1 1 1 1 1 1 1
```
### 样例输出 #2
```
1
1
1
0
1
1
1
```
### 样例输入 #3
```
10 10
2 6
5 8
10 8
1 4
10 6
4 5
10 7
6 9
3 7
1 2 3 4 5 6 7 8 9 10
```
### 样例输出 #3
```
4
3
4
2
0
2
2
0
3
2
```
### 样例输入 #4
```
22 12
9 6
12 13
4 20
21 22
3 19
2 9
6 18
18 11
18 3
16 2
6 4
3 17
16 10
8 16
22 1
16 14
15 8
9 21
2 12
21 5
12 7
1 1 4 8 4 11 7 6 7 11 6 11 10 4 7 5 3 12 9 6 12 2
```
### 样例输出 #4
```
2
0
1
1
1
1
1
0
0
1
2
0
1
1
2
0
2
1
2
3
0
0
```
## 提示

样例解释 $1$：  

对于城市 $1$，它的独特城市是城市 $2,3$，城市 $2$ 产特产 $2$，城市 $3$ 产特产 $3$，一共产两种特产，因此答案是 $2$；  

对于城市 $2$，没有独特城市，因此输出 $0$；
  
对于城市 $3$，它的独特城市是城市 $1$，城市 $1$ 产特产 ，因此答案是 $1$；  

对于城市 $4$，它的独特城市是城市 $1,3$，城市 $1,3$ 均产特产 $1$，因此答案是 $1$；  

对于城市 $5$，它的独特城市是城市 $1,3$，城市 $1,3$ 均产特产 $1$，因此答案是 $1$。  

注意：没有城市产特产 $3$。  

对于 $4\%$ 的数据，$N\le 2000$。

另有 $32\%$ 的数据，$M=1$。

另有 $32\%$ 的数据，$M=N,C_j=j(1\le j \le N)$。

对于 $100\%$ 的数据，$1\le N \le 2\times 10^5,1\le M,A_i,B_i \le N,A_i \neq B_i,1\le C_j \le M$。


---

---
title: "[JRKSJ R7] TSM eerT"
layout: "post"
diff: 省选/NOI-
pid: P8934
tag: ['模拟', '2023', '洛谷原创', 'O2优化', '树的直径']
---
# [JRKSJ R7] TSM eerT
## 题目描述

对于一个 $n$ 个结点的带边权的树 $T$，定义 $dis(x,y)$ 为 $T$ 中 $x\to y$ 路径上的边权和。再定义一个 $n$ 个结点的无向完全图 $p(T)=G$，其中 $\forall x,y\in [1,n]$，$G$ 中边 $(x,y)$ 的边权为 $dis(x,y)$。

定义 $f(T)$ 为 $p(T)$ 的最大生成树。特别的，若 $p(T)$ 的最大生成树不唯一，请立刻判断出并报告。

给定树 $T_0$ 和整数 $k$，求 $f^k(T_0)$。其定义将在下文给出。
## 输入格式

第一行两个整数 $n,k$。\
下面第 $2\sim n$ 行，第 $i$ 行两个整数 $i-f_i,v_i$ 表示 $T_0$ 的一条边 $(i,f_i)$，边权为 $v_i$。**也就是说，这一行输入了两个整数 $f'_i,v_i$，真实的 $f_i=i-f'_i$。**
## 输出格式

输出仅有一个整数表示答案。

若 $\exists x\in[0,k-1]$ 使得 $p(f^x(T_0))$ 的最大生成树不唯一，输出 $-1$。否则，输出 $f^k(T_0)$ 的所有边权和对 $2^{32}$ 取模的结果。
## 样例

### 样例输入 #1
```
3 3
1 1
2 2
```
### 样例输出 #1
```
13
```
### 样例输入 #2
```
10 2
1 7
1 2
1 5
4 5
2 1
3 9
2 9
4 4
9 4
```
### 样例输出 #2
```
736
```
### 样例输入 #3
```
4 1
1 1
2 1
3 1
```
### 样例输出 #3
```
-1
```
## 提示

### 定义

$f^k(T)$ 的定义为：
$$f^k(T)=\begin{cases}T&k=0\\f(f^{k-1}(T))&k>0\end{cases}$$

### 样例 $1$ 解释


![](https://cdn.luogu.com.cn/upload/image_hosting/fpcq3bmt.png)

分别是 $T_0,f(T_0),f^2(T_0),f^3(T_0)$。

以计算 $f(T_0)$ 的过程为例，生成的 $p(T_0)=G$ 为

![](https://cdn.luogu.com.cn/upload/image_hosting/3st5aet7.png)

最大生成树上的边为 $(1,3),(2,3)$。

### 数据规模

本题采用捆绑测试。
| $\text{Subtask}$ | $n\le$ |  $k\le$ | $\text{Score}$ | 
| :----------: | :----------: | :----------: | :----------: | 
| $1$ | $10^3$ | $1$ | $10$ | 
| $2$ | $10^5$ | $1$ |$20$ |
| $3$ | $10^6$ | $1$ |$30$ |
| $4$ | $10^6$ | $10^7$ |$40$ |

对于 $100\%$ 的数据，$2\le n\le 10^6$，$1\le k\le 10^7$，$1\le f_i<i$，$1\le v_i\le10^9$。

### 特殊评分方式
本题开启子任务依赖，具体如下：
- 对于子任务 $i$，您需要答对所有 $j\in[1,i]$ 的子任务 $j$ 才能获得子任务 $i$ 的分数。


---

